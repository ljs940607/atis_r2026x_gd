var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebMaterials/VCXEMaterialCache",["require","exports","DS/VCXWebComponents/WebExtensionBaseExperience"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{constructor(){super(),this._hasDetails=!1,this._title="",this._pid="",this._image="",this._name="",this._whereApplied=new Set,this._whereAppliedDefault=new Set,this._isIndexed=!0}populate(e){this._title=e.title,this._name=e.name,this._pid=e.PID,this._image=e.image??"",this._hasDetails=!0}GetType(){return this.componentType}GetIndexingState(){return this._isIndexed}GetTitle(){return this._title}hasDetails(){return this._hasDetails}GetPID(){return this._pid}GetName(){return this._name}GetParent(){return null}GetID(){return this.GetObject().GetID()}GetObject(){let e=super.GetObject();if(!e)throw new Error("Illegal argument : object is null");return e}GetWhereApplied(){return Array.from(this._whereApplied)}async transformToExternal(){return this.GetObject()}GetWhereDefaultApplied(e){return e?Array.from(this._whereAppliedDefault).filter((t=>this._filterParent(e,t))):Array.from(this._whereAppliedDefault)}_filterParent(e,t){let r=this.GetObject()._experienceBase.ComponentsMap.GetComponentFromID(t);for(;r;){if(r.GetID()===e.GetID())return!0;r=r?.QueryInterface("VCXIModelNavigable")?.getParent()?.GetObject()}return!1}GetImage(){return this._image}SetImage(e){this._image=e}SetIndexingState(e){this._isIndexed=e}setInternalMaterial(e){}isMiac(){return!1}async exposeTweak(){throw new Error("Not implement")}removeComponentFromWhereApplied(e){this._whereApplied.delete(e)}addComponentFromWhereApplied(e,t=!1){this._whereApplied.add(e),t&&this._whereAppliedDefault.add(e)}addProductApplied(e){throw new Error("Not implemented")}getProductApplied(){throw new Error("Not implemented")}populateOtherMaterial(e,t){let r=e.QueryInterface("VCXIMaterialCache");r?.populate({PID:this.GetPID(),whereApplied:[],title:this.GetTitle(),name:this.GetName(),image:this.GetImage()}),t&&r?.setInternalMaterial(this.GetID())}_getMaterialVisuIfPresent(){return null}}return a}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebMaterials/VCXVolatileCXPCoveringMaterial_Spec",["require","exports","DS/VCXWebEWS/VCXVolatileConversionHelper","DS/VCXWebComponents/VCXWebComponentBaseExperience"],(function(e,t,r,a){"use strict";r=__importDefault(r),a=__importDefault(a);class i extends a.default{constructor(){super(...arguments),this._previousComponentID="",this._registeredToPersistent=!1}getPreviousComponentID(){return this._previousComponentID}async registerToPersistent(){return this._registeredToPersistent||(this._registeredToPersistent=!0,r.default.askForPersistency(this)),this.QueryInterface("VCXIReadiness")?.isReady("persistency")??Promise.resolve()}setPersistentComponent(e){this._previousComponentID=this.GetID(),e.getPreviousComponentID=()=>this._previousComponentID,r.default.transfertVolatileToPersitent(this._experienceBase,this,e,["VCXIMaterialCache"])}}return Object.defineProperty(i.prototype,"componentType",{enumerable:!0,get:function(){return"VCXVolatileCXPCoveringMaterial_Spec"}}),i}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebMaterials/CXPRenderingFeature_Spec",["require","exports","DS/VCXWebComponents/VCXWebComponentOccurrence"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{}return Object.defineProperty(a.prototype,"componentType",{enumerable:!0,get:function(){return"CXPRenderingFeature_Spec"}}),a}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebMaterials/VCXInternalMaterial_Spec",["require","exports","DS/WebComponentModeler/WebComponentBase"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{GetID(){let e=this.QueryInterface("VCXIMaterialCache");return"VCXInternalMaterial_Spec_"+e?.GetPID()}}return Object.defineProperty(a.prototype,"componentType",{enumerable:!0,get:function(){return"VCXInternalMaterial_Spec"}}),a}));var __decorate=this&&this.__decorate||function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var l=e.length-1;l>=0;l--)(i=e[l])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebMaterials/VCXEInternalMaterialCache",["require","exports","DS/VCXWebMaterials/VCXEMaterialCache","DS/VCXWebSystem/VCXMutex"],(function(e,t,r,a){"use strict";a=__importDefault(a);class i extends r{constructor(){super(),this._internalSourceMaterials=[],this.productsApplied=[],this.exposedTweak=[],this.mutex=new a.default}async transformToExternal(){let e=this.GetExternalFromSearch();if(e)return e;let t=this.GetObject()._experienceBase.getManager("VCXCAT3DXModelManager"),r=null;try{r=await t.InsertMaterial(this.GetName(),null,this.GetPID(),[],!0)}catch(e){throw e}return r}addProductApplied(e){this.productsApplied.push(e)}getProductApplied(){return this.productsApplied}GetExposedTweaking(){return this.exposedTweak}async exposeTweak(){for(let e of this.getProductApplied()){let t=this.GetObject()._experienceBase.ComponentsMap.GetComponentFromID(e);t&&this.exposedTweak.push(await this.GetObject()._experienceBase.getManager("VCXMaterialManager").createMIACOnComponentIfNeeded(this.GetObject(),t))}this.forceUpdateVisuMiac()}forceUpdateVisuMiac(){let e=this.GetExposedTweaking();for(let t of e)t.QueryInterface("VCXIMaterialCache")?.forceUpdateVisuMiac()}GetExternalFromSearch(){return this.GetObject()._experienceBase.getManager("VCXMaterialManager").getImportedMaterials(!1).find((e=>e.QueryInterface("VCXIMaterialCache")?.GetPID()===this.GetPID()))}GetWhereApplied(){let e=super.GetWhereApplied();if(this.GetObject()._experienceBase.getManager("VCXContextManager").isSupported("VCXMaterialPanel_Splitted"))return e;let t=this.GetExternalFromSearch(),r=t?.QueryInterface("VCXIMaterialCache")?.GetWhereApplied();return r&&(e=e.concat(r)),e}GetInternalMaterial(){return this.GetObject()}async getMaterialVisu(){return this._internalSourceMaterials.length>0?this._internalSourceMaterials[0]:null}async getInternalMaterialsSource(){return this._internalSourceMaterials}setInternalMaterialsSource(e){this._internalSourceMaterials=e}}return __decorate([a.default.RunExclusive],i.prototype,"transformToExternal",null),i})),define("DS/VCXWebMaterials/VCXECoveringMaterialCache",["require","exports","DS/CAT3DExpMaterialWeb/XCTMaterialHelper","DS/CAT3DExpModel/XCTJOPHelper","DS/VCXWebMaterials/VCXEMaterialCache"],(function(e,t,r,a,i){"use strict";return class extends i{constructor(){super(),this._wasActive=!1,this._delegation="",this._forceRefresh=!1}GetExternalFromSearch(){return this.GetObject()}GetExposedTweaking(){return[]}GetInternalMaterial(){return this.GetObject()._experienceBase.ComponentsMap.GetComponentFromID(this._internalMaterial)}setInternalMaterial(e){this._internalMaterial=e}isMiac(){let e=this.GetObject().QueryInterface("CATI3DExperienceObject"),t=e?.GetValueByName("appearance")?.QueryInterface("CATI3DExperienceObject");return t?.HasVariable("_varContextualMaterial")&&t?.GetValueByName("_varContextualMaterial")}forceUpdateVisuMiac(){this._forceRefresh=!0,this.GetObject().dirty=!0}async getMaterialVisu(e=!1){let t=this.GetObject().QueryInterface("VCXIModifiable").GetPropertyValue("ContextualMaterial.Delegation");if(t&&!e){let e=this.GetObject()._experienceBase.ComponentsMap.GetComponentFromID(t);if(e)return e?.QueryInterface("VCXIMaterialCache")?.getMaterialVisu()}return this.materialVisu?this.materialVisu:(this.materialVisuP||(this.materialVisuP=this._getMaterialVisu()),this.materialVisuP)}async _getMaterialVisu(){return this.materialVisu||(this.materialVisu=await this.GetObject().QueryInterface("CATI3DXMaterialAsset").getMaterial(),this.materialVisu.setAlphaTest(0)),this.materialVisu=this.materialVisu.clone(),this.updateMaterialVisu(),this.materialVisu}_getMaterialVisuIfPresent(){return this.materialVisu}updateMaterialVisu(){if(!this.materialVisu)return;const e=this.GetObject().QueryInterface("CATI3DExperienceObject").GetValueByName("appearance");let t=[],i=[],n=this.GetObject()._experienceBase.getManager("VCXContextManager").isSupported("TweakingMaterial");if(n)i=e.QueryInterface("CATI3DExpVCXObjectConvertor").getTab();else{const t=e.QueryInterface("CATI3DExperienceObject").ListVariables();let r=["_varName","linktomaterial","_varContextualMaterial"];t.forEach((e=>{r.includes(e)||i.push({variableName:e})}))}i.forEach((r=>{t.push({name:r.variableName,parameterID:r.variableName,type:a.getJOPVariableType(r.variableName,e),value:n?this._getMaterialVariableValue(r.propertyName,e):a.getJOPVariableValue(r.variableName,e)})}));let s=this.GetObject().QueryInterface("CATI3DXMaterialAsset").getMaterialParameters();console.log({material_appearance:{reference_material_parameters:t,applied_material_parameters:[]},version:2}),r.applyJop(this.materialVisu,{material_appearance:{reference_material_parameters:t,applied_material_parameters:[]},version:2},{reference_material_parameters:s,applied_material_parameters:void 0})}_getMaterialVariableValue(e,t){let r=t.QueryInterface("VCXIModifiable").GetProperty(e).GetPropertyValue();switch(r.GetType()){case"VCXPropertyValueFloat":case"VCXPropertyValueInt":case"VCXPropertyValueString":case"VCXPropertyValueBoolean":return r.GetValue();case"VCXPropertyValueColor":return r.GetValue().GetRGBA();case"VCXPropertyValuePoint":return r.GetValue().toArray()}}GetParent(){return this.GetObject().QueryInterface("VCXIModelNavigable")?.getParent()?.GetObject()??null}async updateMaterial(){if(!this.GetObject().dirty)return;this.GetObject().dirty=!1;let e=this.GetObject().QueryInterface("VCXIModifiable");if(this.isMiac()){let t=e?.GetPropertyValue("ContextualMaterial.Activation"),r=e?.GetPropertyValue("ContextualMaterial.Delegation");(t!==this._wasActive||r!==this._delegation||this._forceRefresh)&&(this._wasActive=t,this._delegation=r,this._forceRefresh=!1,await this._applyMiacChanges(t))}this.updateMaterialVisu()}async _applyMiacChanges(e){let t=this.GetParent();if(!t)return;let r=this.GetInternalMaterial();if(!r)return;let a=r.QueryInterface("VCXIMaterialCache");if(!a)return void console.warn("Error : no internal mat");let i=a.GetWhereDefaultApplied(t);for(let t of i){let r=this.GetObject()._experienceBase.ComponentsMap.GetComponentFromID(t);e?r?.addMiacReplacement(this.GetObject()):r?.removeMiacReplacement(this.GetObject())}}}}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebMaterials/VCXEVolatileCoveringMaterialCache",["require","exports","DS/VCXWebMaterials/VCXECoveringMaterialCache"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{isMiac(){return!0}async _getMaterialVisu(){return null}}return Object.defineProperty(a.prototype,"componentType",{enumerable:!0,get:function(){return"VCXEVolatileCoveringMaterialCache"}}),a}));