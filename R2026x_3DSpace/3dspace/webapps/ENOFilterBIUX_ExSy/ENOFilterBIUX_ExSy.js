define("DS/ENOFilterBIUX_ExSy/ExSy_FBIComponentProxy",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","DS/TagNavigatorProxy/TagNavigatorProxy","DS/ENOFilterBIUX/Abstract_FBIComponentProxy","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/ENOFilterBIUX/FBIProxyServices","DS/ENOFilterBIUX/NGFServices","UWA/Promise","DS/PlatformAPI/PlatformAPI","i18n!DS/ENOFilterBIUX/assets/nls/ENOFilterBIUX","DS/Utilities/Utils","DS/ENOFilterBIUX/ExpandV2FormatServices","DS/ENOFilterBIUX/NGFSessionStorage"],(function(e,t,s,i,r,a,o,l,n,g,h,d,c,p,y){"use strict";return r.extend({init:function(e){this._parent(e)},filterBIFilter:function(e,t){if(this._isProxyActive){var s=this,i=this._needsFiltering(e,this._tagData||{});if(!0===t||i){if(e.allfilters&&Object.keys(e.allfilters).length){for(var r in e.allfilters)if(e.allfilters[r].length)for(var a in e.allfilters[r])e.allfilters[r]&&Array.isArray(e.allfilters[r][a].object)&&e.allfilters[r][a].object.length?e.allfilters[r][a]&&e.allfilters[r][a].excluded?n.setUsageTracker(this._widgetId,"NGF-Tagger-FilteringEvent",{label:"Exclude Hierarchical Tag",value:r}):n.setUsageTracker(this._widgetId,"NGF-Tagger-FilteringEvent",{label:"Hierarchical Tag",value:r}):e.allfilters[r][a]&&e.allfilters[r][a].excluded?n.setUsageTracker(this._widgetId,"NGF-Tagger-FilteringEvent",{label:"Exclude Tag",value:r}):n.setUsageTracker(this._widgetId,"NGF-Tagger-FilteringEvent",{label:"Tag",value:r})}else n.setUsageTracker(this._widgetId,"NGF-Tagger-FilteringEvent","Trash");this._getAllRootsInSession()&&this._getAllRootsInSession().length||!this.myTagProxy||!this._proxyFeedsTagger||(this._setTagsWIWIOr3DD(null,[]),h.publish("NGFilter.SynchroBIOnFilter/"+this._NGFUXId,{widget:this._widgetId,empty:!0,emptyTags:e})),this._keepTagDataInSession(e);let t=[];this._mRootsDataInSession.forEach((function(e,i){e.rootAlias?t.push({specification:{type:"NGFilter_createFromTag",data:{rootID:i,rootAlias:e.rootAlias,tagData:s._tagData,dropOption:"createFromTag",serviceId:e.serviceId}},rootID:i,rootAlias:e.rootAlias,applyFilter:1,displayFilter:0}):console.log("ERROR: ExSy: missing rootAlias, should not")})),s.setFilterSpecifications(t)}else this._proxyFeedsTagger&&this._setTagsWithFilteredExpandSynthesis()}},setTagsWithExpandSynthesis:function(t,s){var i=this;t=a.getRootsInfos(t);var r=this._areRootsCompliantWithSession(t);r?(console.log("==> setTagsWithExpandSynthesis / Error: Roots are not compliant with the session"),console.log(r),this.dispatchEvent("NGFilter.Error_"+this._NGFUXId,{success:[],failure:[r]})):(e.merge(this.optionsToKeep,this._completeAppOptions(this.optionsToKeep)),this._proxyFeedsTagger=!0,this._applyNGFilterCount=0,s&&!this.getAppQueryParam()&&this.setAppQueryParam(s),t.length?(this._keepRootsInSession(t),this._keepRootsAliasInSession(t).then((function(){(i.myTagProxy&&i.myTagProxy.getCurrentFilter()&&i.myTagProxy.getCurrentFilter().allfilters&&Object.keys(i.myTagProxy.getCurrentFilter().allfilters).length&&i._keepTagDataInSession(i._tagsToSet?n._mergeTagData(i.myTagProxy.getCurrentFilter(),i._tagsToSet):i.myTagProxy.getCurrentFilter()),i._tagData&&i._tagData.allfilters&&Object.keys(i._tagData.allfilters).length)?i.filterBIFilter(i._tagData,!0):(t.forEach((e=>{var t=e.rootId||e,s={},r=i._mRootsDataInSession.has(t)?i._mRootsDataInSession.get(t).filterInfos:void 0;r&&!r.fakeFilter&&((s=r.objQuery).CVQueryV2=r.objQueryV2),s&&(s=Object.keys(s).length?s:void 0),i._updateFilteredRootsInSession(t,s)})),c.debounce((function(e){i._setTagsWithFilteredExpandSynthesis()}),300)())}))):i._setTags(null,[]))},_setTagsWithFilteredExpandSynthesis:function(e){var t=this,s=this._getAllFilteredRootsInSession();if(this._fromApply=!!e,s.length){this._aInProgress&&this._aInProgress.length<s.length&&(this._inputChanged=!0),this._aInProgress=s;var i={tenant:this._tenantId,widgetId:this._widgetId,securityContext:this._defaultSC},r=function(){t._aInProgress=void 0,t._inputChanged=!1,t._inProgress=!1},a=function(e,s,i,o,l){n.filteredExpandWithSynthesis(e,t._mRootsDataInSession,i,o,l,s).then((function(n){t._setTags(null,n,null),t._onRenameNGFilter(t._appliedFilterValue),t._inputChanged?(t._inputChanged=!1,a(e,s,i,o,l)):r()}),(function(e){r()}))};this._defaultSC?this._inProgress&&!this._fromApply||(this._inProgress=!0,a(i,s,t._queryFormat,t._proxySynthesisMode,t.getAppQueryParam())):(console.log(" ===> _setTagsWithFilteredExpandSynthesis() ** fall back on getAllSecurityContexts called for widget: "+this._widgetId),n.getAllSecurityContexts(n.getTenant(),this._defaultServiceId).then((function(e){var r=e.cspaces.findIndex((e=>e.isDefault));t._defaultSC=e.cspaces[-1===r?0:r].value,i.securityContext=t._defaultSC,t._inProgress&&!t._fromApply||(t._inProgress=!0,a(i,s,t._queryFormat,t._proxySynthesisMode,t.getAppQueryParam()))}),(e=>{console.log(" ===> _setTagsWithFilteredExpandSynthesis, call to getAllSecurityContexts() error can be IGNORED with ODT in case of ODT replay")})))}else t._setTags(null,[],null)},setSynthesisMode:function(e){if("occurrence"===e||"flat"===e){if(this._proxySynthesisMode!==e&&(this._proxySynthesisMode=e,this._proxyFeedsTagger)){var t=this._getAllRootsInSession();t&&this.setTagsWithExpandSynthesis(t,this.getAppQueryParam())}}else console.log("BIProxy, setSynthesisMode, non supported synthesisMode : "+e)},onApplyNGFilter:function(e){if(this._fromSynchro&&(this._fromSynchro=void 0),!e.empty||0!==this._getAllRootsInSession().length){this._proxyFeedsTagger&&this._applyNGFilterCount++;var t=!1;if(e.CVQueryV2){e.hideChildren=!!e.CVQueryV2.aggregation_processors;Object.keys(e.CVQueryV2.filter)[0];t=!t&&!p.isEmptyFilter(e.CVQueryV2.filter),e.CVQueryV2=a.getProgressiveQueryTemplate(e.filterRootIds[0],e.CVQueryV2.filter,e.CVQueryV2.aggregation_processors)}if((e=this.completeCVQueryWithAppParams(e,this._expandIterParam,this._expandWithSynthesis)).CVQuery&&(e.hideChildren=this._checkCutInfo(e.CVQuery),t=!(!t&&!n.getCombinationQuery(e.CVQuery))),e.CVQuery3D&&(t=!(!t&&!n.getCombinationQuery(e.CVQuery3D))),e.empty?this._updateFilteredRootsInSession(e.filterRootIds[0]):(this._updateFilteredRootsInSession(e.filterRootIds[0],e),this._shareFilterSpec&&this._keepShareSpec(e),e.filterId&&(this._keepFilterIdInSession(e.filterRootIds[0],e.filterId),delete e.filterId)),e.empty||t){this._tagsToSet=e.tagsInMdl&&(this.myTagProxy&&this._needsFiltering(e.tagsInMdl,this.myTagProxy.getCurrentFilter())||!this.myTagProxy)?e.tagsInMdl:void 0,this.cleanUselessDataForApps(e),console.log(e);var s=t?this._tagsToSet?"tag + NGF":"NGF only":"empty";if(n.setUsageTracker(this._widgetId,"NGF-Tagger-ApplyNGFilter",s),e.event){var i={results:"OK"};h.publish(e.event,i)}this.dispatchEvent("ApplyNGFilterAbstract",e);var r=n.computeUXId(this._NGFUXId,e.filterRootIds[0]);y.clear(),y.setItem("NGF_tagMgtRunning_"+r,!1),y.publish()}if(this._proxyFeedsTagger){var o=this._getAllRootsInSession()?this._getAllRootsInSession().length:0;(!this._tagsToSet&&!e.tagsInMdl||this._tagsToSet&&o===this._applyNGFilterCount||this._getNbRootsWithTags()===this._applyNGFilterCount||e.empty&&!o)&&(this._setTagsWithFilteredExpandSynthesis(!0),this._applyNGFilterCount=0)}}},filterBIColorize:function(e){var t=this._getAllRootsInSession()?this._getAllRootsInSession().length:0;if(this._isProxyActive&&t){if(e.tagColors&&e.tagColors.length)for(var s in e.tagColors.length>1&&n.setUsageTracker(this._widgetId,"NGF-Tagger-ColorizeEvent",{label:"Count",value:e.tagColors.length}),e.tagColors)Array.isArray(e.tagColors[s].object)?n.setUsageTracker(this._widgetId,"NGF-Tagger-ColorizeEvent",{label:"Hierarchical Tag",value:e.tagColors[s].predicate}):n.setUsageTracker(this._widgetId,"NGF-Tagger-ColorizeEvent",{label:"Tag",value:e.tagColors[s].predicate});if(e.tagColors&&e.tagColors.length>0){for(var i=0;i<e.tagColors.length;i++){Array.isArray(e.tagColors[i].object)&&e.tagColors[i].object.length&&(e.tagColors[i].object=e.tagColors[i].object.join("/"))}this.dispatchEvent("FilterBIColorizeEvent",e)}}},filterBIGrouping:function(e){if(this._isProxyActive){if(e.groups&&e.groups.length){for(var t in e.groups)e.groups[t].predLevel&&n.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingEvent",{label:"Predicate",value:e.groups[t]}),Array.isArray(e.groups[t].object)&&Array.isArray(e.groups[t].object[0].object)?n.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingEvent",{label:"Hierarchical Tag",value:e.groups[t].predicate}):n.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingEvent",{label:"Tag",value:e.groups[t]});n.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingPredicate",{label:"Predicate",value:e.groups[t].predicate})}else n.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingEvent-Predicate","Ungrouping");this.dispatchEvent("FilterBIGroupingEvent",e)}},filterBISelection:function(e){if(this._isProxyActive){if(e&&Object.keys(e).length)for(var t in e)for(var s in e[t])Array.isArray(e[t][s].object)?n.setUsageTracker(this._widgetId,"NGF-Tagger-SelectionEvent",{label:"Hierarchical Tag",value:t}):n.setUsageTracker(this._widgetId,"NGF-Tagger-SelectionEvent",{label:"Tag",value:t});this.dispatchEvent("FilterBISelectionAbstract",e)}},filterBIMoreTags:function(e){a.setOption("scc_preferredData",[]),this._setTagsWithFilteredExpandSynthesis()}})}));