define("DS/InstantMessaging/InstantMessagingManager",["DS/UWPClientCode/PublicAPI","DS/RTProxyDriver/RTLogger","DS/PlatformAPI/PlatformAPI","DS/RTProxyDriver/RTProxyDriver","DS/TopBarProxy/TopBarProxy","DS/TopBarProxy/MenuItem","DS/MessageBus/MessageBus","DS/RTVueUserPresenceAPI/RTVueUserPresenceAPI","i18n!DS/InstantMessaging/assets/nls/feed"],(function(e,t,n,i,s,a,r,o,c){"use strict";const d=new o;return class{constructor(){this.channelToServer="fromwidgetim.ds.com",this.channelToWidget="towidgetim.ds.com",this.channelFromWidget="im.ds.com",this.channelToSwym="toswym.im.ds.com",this.channelCoreview="collab.im.ds.com",this.channelToNotif="tonotif.im.ds.com",this.channelToWidgetTenant=function(e){return"towidget."+e+".im.ds.com"},this.channelToRTC="toRTC.im.ds.com",this.channelCallToRTC="callToRTC.im.ds.com",this.channelAiaiToRTC="aiaiToRTC.im.ds.com",this.listOfSysStatus={},this.isTopBarInited=!1,this.isWidgetLoaded=!1,this.coreview=!0,this.coreviewAccepted=!0,this.convSubscribed={},this.isConnected=!1}fromWidgetListener(e){var n=e.evenement,s=e.data,a=e.action;if("startX3DPhoto"===n)return t.Manager("todo");if("GETLOGINOKDATA"===n){if(this.isWidgetLoaded=!0,!this.loginOKData)return!0;if(this.publishToWidget("CONNECTED",this.loginOKData),this.loginOKData.rooms&&this.loginOKData.rooms.length)for(var r=0;r<this.loginOKData.rooms.length;r++)this.publishToWidget("ROOM",this.loginOKData.rooms[r]);return!0}return"logger"===n?t.Manager(e.data):"initCoreview"==a?this.initCoreview(e):"stopCollab"==a?this.stopCoreview(e):"getCallInfo"===n&&s&&this.convSubscribed[s.dmId]?this.dispatchCallInfo(s):"subConv"===n&&s&&this.convSubscribed[s.dmId]?this.dispatchConvInfo(s):("subConv"===n&&s&&this.publishToWidget("convInfo",s,this.channelToWidget),void("CONNECTED"==n||"publish"!==a&&!s||i.dispatch(n,[s])))}callInfo(e){if(!e||!e.dmId)return t.error("callInfo bad args");this.convSubscribed[e.dmId]=this.convSubscribed[e.dmId]||{},this.convSubscribed[e.dmId].callState=e,t.Manager("callInfo state:"+e.callState+"; dm:"+e.dmId),this.dispatchCallInfo(e)}callHistory(e){return t.Manager("callHistory:"+e),this.publishToWidget("CallHistory",e,channelToWidget)}dispatchCallInfo(e){return e&&e.dmId?this.convSubscribed[e.dmId]?this.publishToWidget("CallInfo",this.convSubscribed[e.dmId].callState,"towidgetim.dmId:"+e.dmId):t.error("dispatchCallInfo cant find conv "+e.dmId):t.error("dispatchCallInfo bad args")}convInfo(e){if(!e||!e.dmId)return t.error("convInfo bad args");this.convSubscribed[e.dmId]=this.convSubscribed[e.dmId]||{},this.convSubscribed[e.dmId].convInfo=e,t.Manager("convInfo :"+JSON.stringify(e)+"; dm:"+e.dmId),this.dispatchConvInfo(e)}dispatchConvInfo(e){return e&&e.dmId?this.convSubscribed[e.dmId]?this.publishToWidget("convInfo",this.convSubscribed[e.dmId].convInfo,"towidgetim.dmId:"+e.dmId):t.error("dispatchConvInfo cant find conv "+e.dmId):t.error("dispatchConvInfo bad args")}startCollab(e){t.Manager("startCollab on channel "+e.channel),this.initCoreview(e)}giveDataToWidget(e,t,n){this.publishToWidget(n||"dataCollabReceived",e,t||"collab.im.ds.com")}coreviewListnr(e){return this.coreview?e.init?(delete e.init,this.coreviewAccepted=!0,n.publish(e.channel||"collab.im.ds.com",Object.assign({action:"startCollab",isMaster:!0},e)),this.sendToServer("coreview",Object.assign({invitation:!0},e))):void(this.coreviewAccepted?(this.giveDataToWidget(e,e.channel||this.channelCoreview,e.action||e.data.action),"stopCollab"==e.action&&delete this.coreviewAccepted):!this.coreviewAccepted&&e.invitation?e.collabExperienceOrigin?document.IMCall&&document.IMCall.vmCall.$store.getters.is_accepted_room(e.room_id)?this.acceptCoreview(e,!0):t.Manager("received a collabExperience coreview on another device"):console.error("coreview invitation modale is deprecated"):t.Manager("Received coreview data but it has not been accepted (yet)")):t.Manager("Received coreview but the feature is not enabled.")}publishToSwym(e){t.Manager("Publishing "+e.action+" on "+this.channelToSwym),t.Manager(e),n.publish(this.channelToSwym,e)}sendToServer(e,n){if(!e||!n)return t.error("sendToServer misses args");t.Manager("Sending "+e+" to server"),t.Manager(n),i.dispatch(e,[n])}findCurrentTenant(){var n=window.sessionStorage.getItem("3DIMfavoriteTenant")||UWA.Utils.getQueryString(document.URL,"tenant3DIM")||this.platformId;if(n)return t.Manager("findCurrentTenant forced the tenant "+n),n;if(1==this.resources.length&&this.resources[0].platformid?(n=this.resources[0].platformid,t.Manager("findCurrentTenant selected the only tenant of instanciation params : "+n)):0===window.location.href.search(/https:\/\/([A-z0-9]+)-[A-z0-9]+-[A-z0-9]+-[A-z0-9]+/)?(n=window.location.href.split(/https:\/\//)[1].split("-")[0],t.Manager("findCurrentTenant selected the tenant from url : "+n)):(n=e.getApplicationConfiguration("app.mp.tenant"),t.Manager("findCurrentTenant selected the PublicAPI.app.mp.tenant "+n)),!n){try{var i,s=JSON.parse(e.user.properties.dashboards)}catch(e){t.error("unable to parse user dahboards")}for(i in s)if(s[i].platformId){n=s[i].platformId,t.Manager("findCurrentTenant selected the first PublicAPI.user.properties.dashboards tenant "+n);break}}return t.Manager("findCurrentTenant ends with "+n),n}getServicesInfos(e,i){this.passportUrl=(i?i.passportUrl:null)||n.getApplicationConfiguration("app.urls.passport"),this.registryUrl=(i?i.registryUrl:null)||n.getApplicationConfiguration("app.urls.registry");var s,a,r=[];if(i&&i.ressources)for(s in i.ressources.instantMessaging)a=i.ressources.instantMessaging[s],r.push({platformid:a.id.toLowerCase(),displayname:a.displayName,"3dmessaging":a.url,"3dswym":i.ressources.swym[s]?i.ressources.swym[s].url:null,"3dpassport":this.passportUrl});else r=i;t.Manager("instanciation resources : "),t.Manager(r),this.resources=r;var o=this.findCurrentTenant();if(this.devEnv)return e(Object.assign(i,{platformid:o,"3dswym":"none"}));this.registryUrl&&o&&!this.skipRegistry?require(["DS/i3DXCompassPlatformServices/i3DXCompassRegistryClient"],(n=>{n.getServices({platform:o,config:{url:this.registryUrl}}).then((n=>{try{n=JSON.parse(JSON.stringify(n).toLowerCase())}catch(e){for(var i=0;i<n.length;i++)for(var s in n[i])n[i].hasOwnProperty(s)&&(n[i][s.toLowerCase()]=n[i][s],delete n[i][s])}return t.Manager("i3DXCompassRegistryClient resources : "),t.Manager(n),o=o.toLowerCase(),Object.keys(n).forEach((e=>{n[e].url&&(n[e]=n[e].url)})),e(n)}),(n=>(t.Manager("failed with Registry, retry with legacy process"+n),this.skipRegistry=!0,this.getServicesInfos(e,i))))})):require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(n){n.getPlatformServices({onComplete:function(n){try{n=JSON.parse(JSON.stringify(n).toLowerCase())}catch(e){for(var i=0;i<n.length;i++)for(var s in n[i])n[i].hasOwnProperty(s)&&(n[i][s.toLowerCase()]=n[i][s],delete n[i][s])}if(t.Manager("i3DXCompassPlatformServices resources : "),t.table(n),o){o=o.toLowerCase();var a=n.concat(r);for(var i in t.Manager("all resources : "),t.table(a),a)if(a[i].platformid&&a[i].platformid.toLowerCase()===o)return t.Manager("getServicesInfos ends with resources of selected tenant : "),t.table(a[i]),e(a[i]);return t.error("getServicesInfos failed to find the tenant "+o+" in resources. Using the first one "+a[0].platformid),e(a[0])}if(e)return t.Manager("getServicesInfos ends with resources of first tenant : "),t.Manager(n[0]),e(n[0]);t.error("InstantMessagingManager no callback")}})}))}standaloneSetup(t){this.platformId=t.platformId,this.devEnv=t.devEnv;var i,s=(i=this,function(s){s.url=s["3dmessaging"]||t.url,s.passportUrl=i.passportUrl||s["3dpassport"],s.platformId=s.platformid||s.platformId||t.tenantId||t.platformId||require("DS/TopFrame/TopFrame")._tenantId,s.platformIdName=s.displayname,s.username=(e.user.firstName?e.user.firstName+" "+e.user.lastName:null)||t.userName||t.username,s.login=t.userId||t.login||s.login||e.user.login,s.swymUrl=s["3dswym"],s.topBarId=s.topBarId||t.topBarId,s.appName=t.appName||s.appName||n.getApplicationConfiguration("app.usage.service"),s.callContainer=t.callContainer,s.tenants=s.allOptions,s.devEnv=t.devEnv,s.bypassTopbarMenu=!1===e.getApplicationConfiguration("app.rtc.enable")||"false"===e.getApplicationConfiguration("app.rtc.enable"),i.setup(s),i.connectToServer()});this.getServicesInfos(s,t)}setup(e){var s;for(var a in this.options=e,this.url=e.url,this.passportUrl=e.passportUrl,this.platformId=e.platformId||e.tenantId,this.username=e.username,this.login=e.login,this.devEnv=e.devEnv,this.swymUrl=e.swymUrl,this.topBarId=e.topBarId,this.active3DIM=e.tenants,this.appName=e.appName,this.bypassTopbarMenu=e.bypassTopbarMenu,n.subscribe("fromx3dphoto.ds.com",(function(e){var t=e.evenement,n=e.data;"upload"===t&&i.dispatch("uploadMedia",[n])})),n.subscribe(this.channelToServer,(s=this,function(){s.fromWidgetListener(arguments[0])})),n.subscribe(this.channelFromWidget,function(e){return function(n){if(!n)return t.debug("[channelFromWidget] No data");switch(n.action){case"getStatus":i.dispatch("GETSTATUS",n);break;case"getAllStatus":i.dispatch(i.eventName.GETALLSTATUS,[n.users]);break;case"getBlockPopup":e.publishToNotif({action:"blockPopup",blockPopup:"DND"===e.myStatus});break;case"minimizeCollab":i.dispatch("minimizeCollab",n);break;default:t.debug(`[channelFromWidget] Unkown action: ${n.action}`)}}}(this)),i.addEvent(i.eventName.CONNECTED,function(e){return function(){e.connectedListnr(arguments[0])}}(this)),i.addEvent(i.eventName.ONPRESENCERECEIVED,function(e){return function(){e.presenceListnr(arguments[0])}}(this)),i.addEvent(i.eventName.ONMESSAGERECEIVED,function(e){return function(){e.messageListnr(arguments[0])}}(this)),i.addEvent("ROOM",function(e){return function(){e.roomListnr(arguments[0])}}(this)),i.addEvent("COREVIEW",function(e){return function(){e.coreviewListnr(arguments[0])}}(this)),i.addEvent("callInfo",function(e){return function(){e.callInfo(arguments[0])}}(this)),i.addEvent("call",function(e){return function(){const t=e.channelToWidget;return e.publishToWidget("call",arguments[0],t)}}(this)),i.addEvent("convInfo",function(e){return function(){e.convInfo(arguments[0])}}(this)),i.addEvent("DISCONNECTED",function(e){return function(){e.disconnectedListnr(arguments[0])}}(this)),this.eventsFromDriver=["DISCONNECTED","CONNECTED","ROOM","ONMESSAGERECEIVED","ONDATARECEIVED","ONPRESENCERECEIVED","COREVIEW","miscellaneous","onLeaveRoom","onJoinRoom"],this.eventsFromDriver)!function(e,t){i.addEvent(e,(function(n){t.publishToWidget(e,n)}))}(this.eventsFromDriver[a],this);n.subscribe(this.channelToRTC,(function(){i.dispatch("toRTC",arguments[0])})),function(e){i.addEvent("conversation",(function(n){if(n&&n.tenant){let i=n.tenant.toLowerCase();t.Manager("Event conversation - Received event "+n.action+" on "+i);const s=e.channelToWidgetTenant(i);e.publishToWidget("conversation",n,s)}else t.Manager("Event conversation - Received event "+n.action+" with no tenant"),e.publishToWidget("conversation",n,this.channelToWidget)}))}(this),n.subscribe(this.channelCallToRTC,(function(){i.dispatch("callToRTC",arguments[0])})),function(e){i.addEvent("call",(function(n){if(n&&n.tenant){let i=n.tenant.toLowerCase();t.Manager("Event call - Received event "+n.action+" on "+i);const s=e.channelToWidgetTenant(i);e.publishToWidget("call",n,s)}else t.Manager("Event call - Received event "+n.action+" with no tenant"),e.publishToWidget("call",n,this.channelToWidget)}))}(this),n.subscribe(this.channelAiaiToRTC,(function(){i.dispatch("aiaiToRTC",arguments[0])})),function(e){i.addEvent("rtcToAiai",(function(n){if(n&&n.tenant){let i=n.tenant.toLowerCase();t.Manager("Event rtcToAiai - Received event "+n.action+" on "+i);const s=e.channelToWidgetTenant(i);e.publishToWidget("rtcToAiai",n,s)}else t.Manager("Event rtcToAiai - Received event "+n.action+" with no tenant"),e.publishToWidget("rtcToAiai",n,this.channelToWidget)}))}(this),this.appName=this.appName||(window.location.origin.contains("-3dswym.")?"swymSA":null)}disconnectedListnr(e){delete this.convSubscribed,this.convSubscribed={},this.isConnected=!1}connectedListnr(e){e.userId||t.error("unable to retrieve user's login"),this.isConnected=!0,this.login=e.userId,this.username=e.username,t.Manager("Connected to RTC server "+this.login),this.loginOKData=e,this.loginOKData.options=this.options,this.loginOKData.appName=this.appName,this.publishToWidget("CONNECTED",e),this.selfPresenceListnr(e.status),this.devEnv||this.initTopBar(),this.isCollabLoaded||(this.isCollabLoaded=!0,require(["DS/InstantMessagingCall/InstantMessagingCall"],function(e){e.init({base_url:this.url,platformId:this.platformId,appName:this.appName,swymUrl:this.swymUrl,callContainer:this.callContainer})}.bind(this)))}roomListnr(e){this.loginOKData.rooms=this.loginOKData.rooms||[],this.loginOKData.rooms.push(e)}connectToServer(){if(!this.url)return t.error("no 3DMessaging url");t.Manager("connectToServer NodeJS "+this.url+" user "+this.login+" on tenant "+this.platformId+" and passportUrl "+this.passportUrl);var e={nameApp:"3DIM",driverName:"NODE",url:this.url,domaineName:this.platformId,passportUrl:this.passportUrl,username:this.username,devEnv:this.devEnv,credentials:{jid:this.login||UWA.Utils.getQueryString(document.URL,"login3DIM")||"noLogin",user:this.login,password:null}};i.dispatch(i.eventName.SETDRIVER,[e])}publishToWidget(e,t,i){n.publish(i||this.channelToWidget,{evenement:e,data:t})}publishToNotif(e){n.publish(this.channelToNotif,e)}selfPresenceListnr(e){t.Manager("Self presence received "+e),this.myStatus=e,this.updateSubMenu(e),this.publishToNotif({action:"blockPopup",blockPopup:"DND"===e})}presenceListnr(e){e.userId===this.login&&this.selfPresenceListnr(e.status)}initTopBar(){if(!this.topBarId)return t.Manager("initTopBar bypassed: no topBarId");if(!this.isConnected)return t.Manager("initTopBar bypassed: not connected");if(this.isTopBarInited)return t.Manager("initTopBar bypassed: already init");if(this.bypassTopbarMenu)return t.Manager("initTopBar bypassed: bypass forced");try{require("DS/TopFrame/TopFrame")}catch(e){return t.Manager("initTopBar bypassed: TopFrame not loaded yet")}t.Manager("initTopBar");var e=c.myStatus||"My Status",n=this;this.topBarProxy=new s({id:this.topBarId});var r=function(t){return function(s){t===e?console.log("  .--,-``-.                              \n /   /     '.      ,---,      .--.--.    \n/ ../        ;   .'  .' `\\   /  /    '.  \n\\ ``\\  .`-    ',---.'     \\ |  :  /`. /  \n \\___\\/   \\   :|   |  .`\\  |;  |  |--`   \n      \\   :   |:   : |  '  ||  :  ;_     \n      /  /   / |   ' '  ;  : \\  \\    `.  \n      \\  \\   \\ '   | ;  .  |  `----.   \\ \n  ___ /   :   ||   | :  |  '  __ \\  \\  | \n /   /\\   /   :'   : | /  ;  /  /`--'  / \n/ ,,/  ',-    .|   | '` ,/  '--'.     /  \n\\ ''\\        ; ;   :  .'      `--'---'   \n \\   \\     .'  |   ,.'                   \n  `--`-,,-'    '---'"):n.isConnected&&i.dispatch(i.eventName.SETSTATUS,{myStatus:t,statusMsg:t})}};const o=this.myStatus||"online";return this.subMenu=d.statusMenuList.map((e=>{let t=new a({label:e.nls,checked:e.key===o.toLowerCase(),onExecute:r(e.name),icon:{fonticon:e.icon,color:e.color}});return t.set("statusName",e.name),t})),this.topBarProxy.setContent({profile:[{label:e,submenu:this.subMenu,onExecute:r(e)}]}),i.addEvent(i.eventName.LOGOUT,(function(){n.subMenu.forEach((function(e){e.set("disabled",!0)})),n.isTopBarInited=!1})),this.isTopBarInited=!0,this.isTopBarInited}updateSubMenu(e){this.subMenu?this.subMenu.forEach((function(t){t.get("statusName")===e?t.set("checked",!0):t.set("checked",!1),t.set("disabled",!1)})):t.error("no subMenu")}stopCoreview(e){this.coreviewAccepted=!1,this.sendToServer("coreview",e)}initCoreview(e){if(!e)return t.error("initCoreview bad args");if(e.silentCoreview&&!e.room_id)return t.error("initCoreview - silentCoreview missing room_id");if(e.logins=e.logins||[],!e.users&&"object"==typeof e.login&&e.login.length&&(e.users=e.login),!e.logins.length&&e.users)for(var n in e.users)e.logins.push(e.users[n].login);e.init=!0,delete e.action,delete e.method,this.sendToServer("coreview",e)}acceptCoreview(e,t){if(!e||!e.room_id)return console.error("can not accept coreview without room_id");this.modal&&this.modal.destroy&&this.modal.destroy(),this.coreviewAccepted=!0,e.action="acceptCoreview",t?this.giveDataToWidget(e,e.channel||this.channelCoreview,"startCollab"):this.publishToSwym(e)}}})),define("DS/InstantMessaging/InstantMessaging",["DS/UWPClientCode/PublicAPI","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/InstantMessagingManager"],(function(e,t,n){"use strict";t.addLevel("Manager","maroon"),t.Manager("InstantMessagingManager init 12/12/2025"),t.Manager("InstantMessaging load");var i={isInitiableOutsideTopbar:!0,init:function(i){if(!0===e.getApplicationConfiguration("app.rtc.disable"))return t.Manager("InstantMessaging disabled by app.rtc.disable");if(document.RTCManager)return i.topBarId&&(document.RTCManager.topBarId=i.topBarId,document.RTCManager.initTopBar()),t.Manager("InstantMessaging already init");var s=new n;return document.RTCManager=s,s.standaloneSetup(i),s}};return i}));