define("DS/CollabComponents/CreateTaskConfig",["DS/Foundation/WidgetUwaUtils","DS/Foundation/WidgetAPIs","DS/RDFFoundation/SecurityContextUtils","DS/E6WCommonApps/ScheduleConstants","DS/E6WCommonApps/Views/RichTextEditorView","DS/E6WCommonApps/XTaskScope","DS/E6WCommonUI/PlatformManager","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS"],(function(e,t,s,a,i,o,l,n){"use strict";var r=function(e){return n.get(e)};function d(){let e=[];return l.getServiceUrl("3dplan",!0)&&e.push({actualValue:a.STANDALONE_TASK,displayValue:r("emxCollaborativeTasks.Label.StandaloneTask"),helperText:r("emxCollaborativeTasks.Label.StandaloneTaskHelperText"),icon:require.toUrl("DS/E6WCommonApps/assets/img/I_ProjectPlanningTask_22.png")}),e.push({actualValue:a.SIMPLE_TASK,displayValue:r("emxCollaborativeTasks.Label.SimpleTask"),helperText:r("emxCollaborativeTasks.Label.SimpleTaskHelperText"),icon:require.toUrl("DS/E6WCommonApps/assets/img/I_SimpleTask_22.png")}),e}return{getConfig:function(e,t){var n=[],c=0===s.getUsersContentRepositories().length;n.push({readWrite:!0,name:a.TITLE_ATTR,type:"text",label:r("emxCollaborativeTasks.Label.Title"),maxLength:128,required:!0,validate:!0,removeCarriageReturns:!0});var p=o.getObjectData(),T=!1;if(o.isAgileWorkContext()&&(T=o.isAgileWorkContext()&&!p.isSwym),e[a.TASK_TYPE]!==a.STANDALONE_TASK&&e[a.TASK_TYPE]!==a.SIMPLE_TASK||c||T||t&&t.taskType){let t=[],s={actualValue:e[a.TASK_TYPE],displayValue:r("emxCollaborativeTasks.Label.StandaloneTask"),icon:require.toUrl("DS/E6WCommonApps/assets/img/I_Project-Planning-Task_22.png")};s.actualValue===a.SIMPLE_TASK?(s.displayValue=r("emxCollaborativeTasks.Label.SimpleTask"),s.helperText=r("emxCollaborativeTasks.Label.SimpleTaskHelperText"),s.icon=require.toUrl("DS/E6WCommonApps/assets/img/I_Simple-Task_22.png")):s.actualValue===a.DPM_TASK?(s.displayValue=r("emxCollaborativeTasks.Label.SimpleTask"),s.helperText=r("emxCollaborativeTasks.Label.SimpleTaskHelperText"),s.icon=require.toUrl("DS/E6WCommonApps/assets/img/I_Project-Task_22.png")):s.actualValue===a.XPP_TASK&&(s.displayValue=r("emxCollaborativeTasks.Label.ProjectPlanningTask"),s.helperText=r("emxCollaborativeTasks.Label.StandaloneTaskHelperText"),s.icon=require.toUrl("DS/E6WCommonApps/assets/img/I_Project-Planning-Task_22.png")),t.push(s),n.push({readWrite:!1,name:a.TASK_TYPE,type:"select",values:t})}else{var h={name:a.TASK_TYPE,values:d()};l.getServiceUrl("3dplan",!0)?(h.readWrite=!0,h.type="toggle",h.toggleType="radio"):(h.readWrite=!1,h.type="select"),n.push(h)}return e[a.TASK_TYPE]!==a.STANDALONE_TASK&&e[a.TASK_TYPE]!==a.XPP_TASK&&(e[a.TASK_TYPE]===a.DPM_TASK||e.taskCollabSpace&&1===e.taskCollabSpace.length?n.push({readWrite:!1,name:a.COLLAB_SPACE_NAME,type:"text",label:r("emxCollaborativeTasks.Label.CollaborativeSpace")}):n.push({readWrite:!0,name:a.COLLAB_SPACE,type:"select",label:r("emxCollaborativeTasks.Label.CollaborativeSpace"),values:e.taskCollabSpace,required:!0,validate:!0})),e[a.TASK_TYPE]!==a.STANDALONE_TASK&&e[a.TASK_TYPE]!==a.XPP_TASK&&(e[a.TASK_TYPE]===a.DPM_TASK?n.push({readWrite:!1,name:a.TASK_ORGANIZATION,type:"text",label:r("emxCollaborativeTasks.Label.Organization")}):e.taskOrganization&&e.taskOrganization.length>1&&n.push({readWrite:!0,name:a.TASK_ORGANIZATION,type:"select",label:r("emxCollaborativeTasks.Label.Organization"),values:e.taskOrganization,required:!0,validate:!0})),e[a.TASK_TYPE]===a.SIMPLE_TASK||e[a.TASK_TYPE]===a.DPM_TASK?n.push({readWrite:!0,name:a.DESCRIPTION_ATTR,label:r("emxCollaborativeTasks.Label.Description"),type:"text"}):n.push({readWrite:!0,name:a.DESCRIPTION_ATTR,titleAttribute:a.TITLE_ATTR,richTextField:"dsplan:RichTextField",label:r("emxCollaborativeTasks.Label.Description"),type:"RichText",customView:i,numberOfDisplayLines:3,numberOfEditableLines:3}),n}}})),define("DS/CollabComponents/CreateTask",["UWA/Core","DS/Windows/Dialog","DS/Windows/ImmersiveFrame","DS/Controls/Button","DS/Handlebars/Handlebars4","DS/Foundation/WidgetAPIs","DS/Foundation/WidgetUwaUtils","DS/Foundation2/FoundationV2Data","DS/RDFFoundation/SecurityContextUtils","DS/RDFFoundation/Models/PersonRDFModel","DS/RDFFoundation/CustomExtensionUtils","DS/RDFFoundation/UserPreferences","DS/E6WCommonUI/PlatformManager","DS/E6WCommonUI/Views/DetailsDisplayView","DS/E6WCommonUI/Views/FoundationBaseView","DS/E6WCommonUI/UIHelper","DS/E6WCommonApps/Models/ScheduleElementPopupModel","DS/E6WCommonUI/Views/E6WHandlebarsHelpers","DS/E6WCommonApps/TaskUtils","DS/E6WCommonApps/XTaskScope","DS/E6WCommonApps/CSRFUtil","DS/E6WCommonApps/Collections/RDFTasksCollection","DS/E6WCommonApps/Views/CreateDialogTabMixin","DS/E6WCommonApps/ScheduleConstants","DS/CollabComponents/CreateTaskConfig","i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS","text!DS/E6WCommonApps/assets/templates/customAttributes.html.handlebars","css!DS/E6WCommonApps/E6WCommonApps"],(function(e,t,s,a,i,o,l,n,r,d,c,p,T,h,m,C,S,u,g,A,_,k,E,b,v,P,D,w){"use strict";var f=function(e){var t=n.getWidgetConstant.apply(this,arguments);return!t&&(t=e),t===e&&(t=P.get(e)),t===e&&(t=D.get(e)),t},V=i.compile(w),L=m.extend({_uwaClassName:"E6WCollabComponentsCreateTask",tagName:"div",name:"E6WCollabComponents.CreateTask",init:function(t){T.initPlatformServiceData(),this.listenToOnce(T,"serviceDataLoaded",(()=>this.onFieldValueChange()));let s=e.clone(t||{},!1);s.elementType=b.TASK,this.options=s,"undefined"!=typeof widget&&(widget.useUIKitSelect=!0),d.loadAndCreateModelForCurrentUser(),this.model=new S({model:new e.Class.Events,elementType:s.elementType});var i=A.getTSKTaskType();this.model[b.TASK_TYPE]=i,this._setTaskCollabSpaceAndOrganization(s),s.taskType&&(this.model[b.TASK_TYPE]=s.taskType),this.model[b.REPEAT_CREATE_TASK]=s[b.REPEAT_CREATE_TASK];let o=v.getConfig(this.model,s);return s.description&&(this.model[b.DESCRIPTION_ATTR]=s.description),this._detailsView=new h({model:this.model}),this.attachments=s.attachments,this.deliverables=s.deliverables,this.scopes=s.scopes,this.assignees=s.assignees,this.tenant=s.tenant,this.saveBtn=new a({label:f("emxCollaborativeTasks.PopUp.Create"),emphasize:"primary",class:"btn-create",onClick:this.createTaskAction.bind(this),role:WUXCustomButtonRoleEnum.Validate,disabled:!0}),this._detailsView.model.createButton=this.saveBtn.getContent(),this._detailsView.setConfig(o),this.listenTo(this._detailsView.model,"onChange:"+b.TASK_TYPE,(()=>{this._setTaskCollabSpaceAndOrganization(),this.onFieldValueChange()})),this.listenTo(this._detailsView.model,"onChange:"+b.TASK_COLLAB_SPACE,this.onFieldValueChange),this.stopListening(this._detailsView.model,"onChange:"+b.COLLAB_SPACE),this.listenTo(this._detailsView.model,"onChange:"+b.COLLAB_SPACE,(()=>{this._loopBreak||this._setTaskCollabSpaceAndOrganization()})),this.listenTo(this._detailsView.model,"onValidationFailure",(function(){this.saveBtn.disabled=!0})),this.listenTo(this._detailsView.model,"onValidationSuccess",(function(){this.saveBtn.disabled=!1})),this.model.set("type","Task"),s.title&&this.model.set("title",s.title,{validate:!0}),this._parent.apply(this,[s])},render:function(){var t=c.getExtensionsForTaxonomy("dsplan:Task")&&c.getExtensionsForTaxonomy("dsplan:Task").length>0;if(this._detailsView.model[b.TASK_TYPE]===b.XPP_TASK&&t){var s=u.i18n;u.i18n=f;var a=V();u.i18n=s,this.container=e.createElement("div",{id:"dialogContainer",html:a}),this._setupTabBar(),this._detailsView.render().inject(this._propertiesForm)}else this._detailsView.render().inject(this.container);return this.setProjectTypeIcon(),this._focusOnTitleFieldAndAddKeyPressEvent(),this},renderAsDialog:function(i){var o=e.clone(i||{},!1);let l=this.render();var n=this;this._detailsView.model.createButton.classList.add("btn-create");var r=new s({useBackgroundFlag:!0});r.inject(document.body),this.dialog=new t({immersiveFrame:r,title:f("emxCollaborativeTasks.Label.CreateNewTask"),content:l.getContent(),width:520,recId:"CreateTaskDialog",modalFlag:!0,buttons:{Save:this.saveBtn,Cancel:new a({onClick:function(e){n.dialog.close(),n.options.onCancelCallback&&n.options.onCancelCallback.apply(n,arguments)}})},checkboxInfos:o.enableRepeat?{label:f("emxCollaborativeTasks.Label.Repeat"),checkFlag:!1,checkFlag:this._detailsView.model[b.REPEAT_CREATE_TASK]}:void 0});var d=this.dialog.getAbsolutePosition();return d.y=90,this.dialog.setAbsolutePosition(d),this._detailsView.model&&!this._detailsView.model.get("title")&&this._detailsView.model.createButton&&this._detailsView.model.createButton.setAttribute("disabled",!0),this.dialog.addEventListener("close",(()=>{n.dialog&&(n.dialog&&n.dialog.destroy(),n.dialog&&delete n.dialog)})),this.container.getParent(".wux-windows-modalDialog")&&this.container.getParent(".wux-windows-modalDialog").classList.add("eno-dialog"),this.container.getParent(".wux-windows-dialog")&&this.container.getParent(".wux-windows-dialog").classList.add("ds-dialog"),T.hasLoadedRolesData()||(this.listenToOnce(T,"rolesDataLoaded",this.onFieldValueChange.bind(this)),T.fetchRolesData()),this},onFieldValueChange:function(){if(this&&this._detailsView){var e=v.getConfig(this._detailsView.model,this.options);if(this._detailsView.setConfig(e),this.render(),this.dialog){var t=this.dialog.getAbsolutePosition();t.y=90,this.dialog.setAbsolutePosition(t)}this._focusOnTitleFieldAndAddKeyPressEvent()}},createTaskAction:function(){this.dialog&&this.dialog.checkboxInfos&&this.dialog.checkboxInfos.checkFlag?this.processCreateTaskInput({close:!1}):(this.dialog&&this.dialog.close(),this.processCreateTaskInput({close:!0,selectTask:!0}))},_focusOnTitleFieldAndAddKeyPressEvent:function(){this._detailsView.getFieldViewByName("title").getElement(".content").focus()},_setTaskCollabSpaceAndOrganization:function(e){var t;if("undefined"!=typeof widget&&widget.getValue("appId")===b.APP_TSK)t=r.getPreferencesCredentials(window.enoviaServer.space),this.setupCredentials(t),this.onFieldValueChange();else{let s=this.options&&this.options.url_3DSpace;if(!s)try{s=require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()}catch(e){console.error("no 3dspace url found")}window.enoviaServer||l.setupEnoviaServer({getUrl:()=>s}),e&&(window.enoviaServer.space=e.space),window.isIFWE=!0,t=o.getSecurityContexts(this.retrieveCredentialsAndInitiate.bind(this)),!this._loopBreak&&(this._loopBreak=!0)}},retrieveCredentialsAndInitiate:function(e){r.processSecurityContextData(e),this.setupCredentials(r.createCredentialsDropDown(e)),this.onFieldValueChange()},setupCredentials:function(e){if(e&&(this.model[b.TASK_TYPE]===b.DPM_TASK||this.model[b.TASK_TYPE]===b.SIMPLE_TASK)){let t=e.collabspace;if(t&&(this.model[b.TASK_COLLAB_SPACE]=t),this._loopBreak=!0,t&&1===t.length)this.options&&this.options.showAlert?this.model.set(b.COLLAB_SPACE,this.options.scope.get("collabSpace")):this.model.set(b.COLLAB_SPACE,t[0]),this.model[b.COLLAB_SPACE_NAME]=t[0].displayValue;else{let e=t&&t[0];this.options&&this.options.scope&&(e=t&&t.find((e=>e.displayValue===this.options.scope.get("collabSpace")))),e&&this.model.set(b.COLLAB_SPACE,e)}this.model[b.TASK_TYPE]===b.DPM_TASK&&e.organization?this.model[b.TASK_ORGANIZATION]=e.organization[0].displayValue:e.organization&&this.model.set(b.TASK_ORGANIZATION,e.organization[0]),this._loopBreak=!1}},setProjectTypeIcon:function(){var t;[b.XPP_TASK,b.STANDALONE_TASK].includes(this.model[b.TASK_TYPE])?t=e.createElement("img",{src:require.toUrl("DS/E6WCommonApps/assets/img/I_ProjectPlanningTask_22.png")}):this.model[b.TASK_TYPE]===b.SIMPLE_TASK?t=e.createElement("img",{src:require.toUrl("DS/E6WCommonApps/assets/img/I_Simple-Task_22.png")}):this.model[b.TASK_TYPE]===b.DPM_TASK&&(t=e.createElement("img",{src:require.toUrl("DS/E6WCommonApps/assets/img/I_ProjectTask_22.png")}));var s=this._detailsView.getFieldViewByName("taskType");if(!s._config.readWrite){var a=s.getElement(".object-type");t&&t.inject(a,"top")}},processCreateTaskInput:function(t){var s,a=e.clone(t||{},!1),i=this,o=this._detailsView.model.get("title"),l=this._detailsView.model.get("subtitle"),n=this._detailsView.model.get("taskType");if("undefined"==typeof widget||widget.getValue("appId")!==b.APP_TSK||n!==b.SIMPLE_TASK&&n!==b.STANDALONE_TASK||p.setUserPreferences(this._detailsView.model),o)if(a.context=this,a.scope=this.options.scope,a.onCompleteCallback=function(){a.close&&i.dialog&&i.dialog.close(),i.options.onCompleteCallback&&i.options.onCompleteCallback.apply(i,arguments),C.trackPageEvent({eventCategory:"create",eventAction:"create task",eventLabel:"create task",eventValue:o})},i.options.onFailureCallback&&(a.onFailureCallback=function(){i.options.onFailureCallback.apply(i,[...arguments])}),a.attachments=this.attachments,a.deliverables=this.deliverables,a.scopes=this.scopes,a.assignees=this.assignees,this.options.tasksCollection&&(a.tasksCollection=this.options.tasksCollection),this.options.rdfTasksCollection&&(a.rdfTasksCollection=this.options.rdfTasksCollection),a.tasksCollection||a.rdfTasksCollection)s=g.createTask(o,l,n,a);else if(n===b.SIMPLE_TASK&&C.loadJSDependency("DS/CollaborativeTasks/Collections/TasksCollection").then((e=>{_.checkAndSetCSRF(a,(t=>{const s=this;let a=!1;!function t(i){const r=new e({data:[],csrf:i.csrf},{convertToInMemoryData:!0});i.tasksCollection=r,i.onFailureCallback=function(e){const o=e[e.length-1],l=o&&o.response;!a&&l&&403===l.statusCode&&l.csrf?(console.warn("CSRF token invalid. Retrying with new token..."),a=!0,_.setCSRF(l.csrf.value),i.csrf=l.csrf,t(i)):s.options.onFailureCallback&&s.options.onFailureCallback.apply(s,arguments)},g.createTask(o,l,n,i)&&s.postTaskCreation(i)}(t)}))})),n===b.STANDALONE_TASK){var r=new k(void 0,{"@href":"/invoke/dsxplan:getTasks","@mask":"dsplan:MVMask.Task.CollaborativeTask.Basic",detailsMask:"dsplan:MVMask.Task.Complex"});a.rdfTasksCollection=r,s=g.createTask(o,l,n,a)}return o||this.dialog&&this.dialog.close(),s&&this.postTaskCreation(a),s},postTaskCreation:function(e){this.dialog&&e.close?this.dialog&&this.dialog.close():(this.tenant&&(!T.getTenant()&&T.setTenant(this.tenant),widget.useUIKitSelect=!0),this._detailsView.model.set("title","",{validate:!0}),this._detailsView.model.set("subtitle",""),this.onFieldValueChange(),this._templateComboBox&&(this._templateComboBox.value=""),this.charEditor&&this.charEditor.destroy(),this.charEditor=void 0)},destroy:function(){this._detailsView.destroy(),delete this._detailsView,this.charEditor&&this.charEditor.destroy(),this.charEditor=void 0,this._parent()}});return L.implement(E),L}));