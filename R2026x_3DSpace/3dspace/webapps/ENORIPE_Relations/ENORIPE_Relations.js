/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_Relations/RelationsTabSettings",["UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","UWA/Class/Events","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","text!DS/SNNavigationMap/assets/SNNavigationMap.settings.json","DS/SNNavigationMap/utils/SNNavigationServices","DS/SNNavigationMap/utils/NlsManager","i18n!DS/ENORIPE_Relations/assets/nls/Relations","css!DS/ENORIPE_Relations/ENORIPE_Relations"],(function(e,t,i,n,s,o,r,a,l,c,d){"use strict";var p=e.singleton(i,s,{name:"relations_tab_settings",_localKey:null,init:function(){try{t.merge(d,c.getNls());var e=JSON.parse(a);this.setOptions(e),this.setOptions("user_granted_roles",""),this.setOption("isDraggable",!0),this.setOption("isProfilesVisible",!0),this._localKey="RelationsTab","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?this._localKey="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?this._localKey="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(this._localKey="/"+widget.getValue("appId")+"_"+widget.id))}catch(e){console.error(e)}},isAvailable:function(e,t){var i={},s=this;if(i.isAvailable=!1,i.roles=[],t&&t.addinmode&&this.setOption("addinmode",t.addinmode),t&&t.lockedApp&&this.setOption("lockedapp",t.lockedApp),t&&t.hasOwnProperty("isProfilesVisible")&&this.setOption("isProfilesVisible",t.isProfilesVisible),t&&t.hasOwnProperty("publicationsMode")&&this.setOption("publicationsMode",t.publicationsMode),t&&t.securityContext&&this.setOption("securityContextFromAppPreference",t.securityContext),t){if(t.appID){var o=t.appID;this.setOption("appID",o),"X3DSEAR_AP"===o&&this.setOption("automode",!0)}t.isExternal&&this.setOption("isExternal",t.isExternal),void 0!==t.noContextualMenu&&t.noContextualMenu&&this.setOption("noContextualMenu",t.noContextualMenu)}return this.getOption("userId")||this.setUser(e),this.getOption("myappsurl")||this.setMyAppsUrl(),new n((function(n,o){s.getOption("user_granted_roles")?(i=s.parseRoles(s.getOption("user_granted_roles"),e),n(i)):r.getGrantedRoles((function(r){if(r){s.setOption("user_granted_roles",r),i=s.parseRoles(r,e);var a=!0;t&&t.isDraggable&&(a=t.isDraggable),s.setOption("isDraggable",a),n(i)}else o()}))}))},setUser:function(e){var t=this,i=e&&e.getPlatformID?e.getPlatformID():"OnPremise";try{r.getUser({platformId:i,onComplete:function(e){e&&e.id&&t.setOption("userId",e.id)},onFailure:function(e){console.log(e)}})}catch(e){console.log(e)}},setMyAppsUrl:function(){var e=this;this.getOption("myappsurl")||window&&window.dscef&&window.dscef.getMyAppsURL&&window.dscef.getMyAppsURL().then((function(t){e.setOption("myappsurl",t)}))},getMyAppsUrl:function(){return this.getOption("myappsurl")?this.getOption("myappsurl"):""},getAppID:function(){var e=this.getOption("appID");return e||"undefined"==typeof widget||null===widget||(e=widget.getValue("x3dAppId")||widget.getValue("appId")),e||"defaultID"},parseRoles:function(e,i){var n,s=[],o={},r=!1,a=!1,l=i&&i.getPlatformID?i.getPlatformID():"OnPremise";if(o.roles=[],o.isAvailable=!1,e){if("string"!=typeof e||"{"!==e[0]&&"["!==e[0]||(e=JSON.parse(e)),t.is(e,"array"))for(var c=0;c<e.length;c++)if(void 0!==e[c].id&&null!==e[c].id)if("InternalDS"===e[c].id&&(r=!0,s.push(e[c].id)),i){if(e[c].platforms)for(var p=0;p<e[c].platforms.length;p++)if(l===e[c].platforms[p]){if(-1!==s.indexOf(e[c].id))break;s.push(e[c].id)}}else s.push(e[c].id);o.roles=s,n=i&&i.getServiceID&&i.getServiceID()||"3DSpace",(s.indexOf("CSV")>-1||s.indexOf("InternalDS")>-1)&&(r=!0),"3DSpace"===n&&(a=!0),r&&a&&(o.isAvailable=!0,o.facetInfo={supportMerge:!0,require:"DS/ENORIPE_Relations/views/RelationsTab",facet:{name:"relations",text:d.get("relations_tab"),icon:"object-related"},alwaysVisible:!1})}return o},getLang:function(){var e;if(widget&&widget.lang)return widget.lang;window&&window.dsLang?e=window.dsLang:e=(window&&window.clntlang?window.clntlang:navigator&&navigator.languages&&t.is(navigator.languages,"array")&&navigator.languages.length>0?navigator.languages[0]:navigator?navigator.language||navigator.systemLanguage:"en").toLowerCase().split("-")[0];return e},setInitProfile:function(e){this.saveValuesForProfile("LastUsedProfile",e),void 0===this.getOption("initProfile")&&this.setOption("initProfileDone",!0)},setProfile:function(e){var t=this;this.saveValuesForProfile("LastUsedProfile",e),void 0===this.getOption("initProfile")&&this.setOption("initProfileDone",!0),require(["DS/PlatformAPI/PlatformAPI"],(function(i){var n=t.getLocalKey()+"/setProfile",s={profile:e};i.publish(n,s)}))},updatePublicationsMode:function(e){var t=this;require(["DS/PlatformAPI/PlatformAPI"],(function(i){var n=t.getLocalKey()+"/updatePublicationsMode",s={publicationsMode:e};i.publish(n,s)}))},expandRelations:function(e){var t=this;this.setOption("expandRelations",e),require(["DS/PlatformAPI/PlatformAPI"],(function(i){var n=t.getLocalKey()+"/expandRelations",s={relationsNames:e};i.publish(n,s)}))},getLocalKey:function(){return this._localKey},getRoles:function(){var e=this.getOption("user_granted_roles"),i=[];if(e&&("string"!=typeof e||"{"!==e[0]&&"["!==e[0]||(e=JSON.parse(e)),t.is(e,"array")))for(var n=0;n<e.length;n++)i.push(e[n].id);return i},getUserID:function(){if(this.getOption("userId"))return this.getOption("userId");var e=o.getUser();return null!=e&&void 0!==e.login?o.getUser().login:""},saveValuesForProfile:function(e,t){e&&(e=e+"-"+this.getAppID()),e&&t&&(widget&&widget.setValue(e,t),localStorage.setItem(e,t))},getValuesForProfile:function(e){var t;if(e)return e=e+"-"+this.getAppID(),widget&&(t=widget.getValue(e)),!t&&l.isWebInWin()&&(t=localStorage.getItem(e)),t}});return p})),define("DS/ENORIPE_Relations/utils/CommonUtils",["UWA/Class","DS/WAFData/WAFData","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/ENORIPE_Common/utils/CommonUtilsServices"],(function(e,t,i,n){"use strict";return e.extend({_currentRequest:null,init:function(e){this._3dSpaceUrl=e._3dSpaceUrl,this._tenant=e.tenant,this._lang=e.lang,this._userID=e.userID,this._isWebInWin=e.isWebInWin,this._myappsurl=e.myappsurl},_createPromise:function(i){i.params.label="ENORIPE_Relations";var n=JSON.stringify(i.params);return new e.Promise((function(e,s){t.authenticatedRequest(i.url,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:n,timeout:6e3,onComplete:e,onFailure:function(e){console.log(e),s(e)},onTimeout:function(e){console.log(e),s(e)}})}))},fetchThumbNails:function(t){var i=this,n={ids:t,attrs:["preview_url"]};return new e.Promise((function(e,t){i._fetchCall(n).then((function(t){e(t)}),(function(){t()}))}))},fetchAttributes:function(t){var i=this,n=t.type;return void 0!==t.typeAttrs[n]?t.attributes=t.typeAttrs[n].attributes:t.attributes=t.typeAttrs.AllTypes.attributes,t.attrs=t.attributes.map((function(e){return e.uri})),new e.Promise((function(e,n){i._fetchCall(t).then(i._processData.bind(i,t)).then((function(t){e(t)}),(function(){n()}))}))},_fetchCall:function(e){return this._createPromise({url:this._3dSpaceUrl+"/cvservlet/fetch/v2?tenant="+this._tenant,params:{physicalid:e.ids,select_predicate:e.attrs,unescape_slashes_in_attribute_values:!0},timeout:6e4})},_processData:function(t,i){var n=this;if(i){i=JSON.parse(i);for(var s={},o=0;o<i.results.length;o++)for(var r=i.results[o].attributes,a=0;a<r.length;a++)(r[a].name.contains("ds6w")||r[a].name.contains("ds6wg"))&&(s[r[a].name]?-1===s[r[a].name].indexOf(r[a].value)&&s[r[a].name].push(r[a].value):s[r[a].name]=[r[a].value])}return new e.Promise((function(e,o){i&&i.results&&i.results.length>0?n._getNls(s).then((function(s){t=n._processFetchData(t,i),t=n._processNlsData(t,s),e(t)})):(console.log("no results in fetch service for tooltip"),e(t))}))},_getNls:function(t){var s=this;return new e.Promise((function(e,o){if(s._isWebInWin){var r={myAppsBaseUrl:s._myappsurl,userId:s._userID,lang:s._lang};n.setConfigForMyApps(r)}i.getNlsOfPropertiesValues(JSON.stringify(t),{tenantId:s._tenant,lang:s._lang,apiVersion:"R2019x",onComplete:function(t){e(t)},onFailure:function(t){console.log("Error in fetching NLS data from FedDictionaryAccessAPI.getNlsOfPropertiesValues, the response received is ::"+t),e()}})}))},_processFetchData:function(e,t){if(t)for(var i=t.results,n=null,s=e.attrs,o=0;o<i.length;o++)if(i[o].attributes&&i[o].attributes.length>0)for(var r=0;r<i[o].attributes.length;r++){var a=i[o].attributes[r];if("resourceid"===a.name){(n=this._getAttrForIds(a.value,i[o].attributes,s))&&(e.nlsObj||(e.nlsObj={}),e.nlsObj[a.value]=n);break}}return e},_getAttrForIds:function(e,t,i){if(e&&t){for(var n={},s=0;s<t.length;s++)-1!==i.indexOf(t[s].name)&&(n[t[s].name]=t[s].value);if(Object.keys(n).length>0)return n}return null},_processNlsData:function(e,t){if(t){var i=e.nlsObj;for(var n in i)if(i.hasOwnProperty(n)){var s=i[n];for(var o in s)if(s.hasOwnProperty(o)&&void 0!==t[o]){s[o];void 0!==t[o][s[o]]&&(e.nlsObj[n][o]=t[o][s[o]])}}}return e}})})),define("DS/ENORIPE_Relations/views/RelationsView",["UWA/Core","UWA/Class/View","UWA/Class","DS/WAFData/WAFData","DS/TransientWidget/TransientWidget","DS/SNNavigationMap/MapSettings","DS/SNNavigationMap/utils/CommonUtils","DS/SNNavigationMap/utils/ProbesUtils","DS/SNNavigationMap/utils/SearchUtils","DS/ENORIPE_Common/utils/CommonUtilsServices","DS/Utilities/DateUtils","DS/CollectionView/ResponsiveLargeTilesCollectionView","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/ComboBox","DS/Controls/TooltipModel","UWA/Class/Model","UWA/Utils/InterCom","DS/SNNavigationMap/utils/SNNavigationServices","DS/i3DXCompassPlatformServices/OpenWith","DS/i3DXCompassServices/i3DXCompassPubSub","DS/FedDictionaryAccess/FedDictionaryAccessAPI","i18n!DS/ENORIPE_Relations/assets/nls/Relations","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","DS/UIKIT/DropdownMenu","DS/UIKIT/Accordion","DS/UIKIT/Scroller","DS/Controls/Button"],(function(e,t,i,n,s,o,r,a,l,c,d,p,u,h,f,g,m,_,v,b,I,P,S,w,y,D,O,A,R,M){"use strict";return t.extend({name:"list-view",isInitialized:!1,_currentRequest:null,sourceModels:{},models:{},nodeModels:{},responsiveTiles:[],inAppSpecificSection:!1,_selectedModels:[],tiles:[],isSetTypesCallbackSubscribed:!1,_isWebInWin:v.isWebInWin(),_compassSocket:{},_platformId:"",_serviceName:"",_separator:"",_attributes:{},noContextualMenu:!1,_selectUuid:e.Utils.getUUID(),_accordionOpenedItem:[],_linkDirectionItemsMapping:{},_propertiesCommandRequire:"DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase",_propertiesComponentRequire:"DS/EditPropWidget/EditPropComponent",_propertiesConstantsRequire:"DS/EditPropWidget/constants/EditPropConstants",_propertiesModelRequire:"DS/EditPropWidget/models/EditPropModel",className:function(){return this.getClassNames("-container multisel-off")},setup:function(e){this._widgetId=e.widgetId||null,this.appId=e.appId,this._tenant=e.tenant||"OnPremise",this._3dSpaceUrl=e.serviceURL,this._url=e.serviceURL+"/resources/enorelnav/v2/navigate/getEcosystem?tenant="+this._tenant,this.isDraggable=e.isDraggable||!0,this.isProfilesVisible=!e.hasOwnProperty("isProfilesVisible")||e.isProfilesVisible,this.currentProfile=e.currentProfile,this._separator=e.separator,this._lang=e.lang,this._userID=e.userID,this._autoNavMode=e.autoNavMode||!1,this._addinMode=e.addinmode,this._lockedApp=e.lockedApp,this._showOpenWith=o.getOpenWithMode(),this._attributes=e.attrs,this._myappsurl=e.myappsurl,this.localKey=e.localKey,this.noContextualMenu=e.noContextualMenu,this.expandRelationsName=e.expandRelations;var t="com.ds."+this._widgetId;this._compassSocket=new _.Socket(t);this._compassSocket.subscribeServer("com.ds.compass",window.parent),this.isSetTypesCallbackSubscribed||(I.subscribe("setTypesCallback",this._setTypesCallback.bind(this)),this.isSetTypesCallbackSubscribed=!0),this._initializeView(e)},_initializeView:function(t){if(this.header=new e.createElement("div",{class:"relations-header"}).inject(this.container),this.isProfilesVisible){this._setUpComboBox(t);var i=e.createElement("div",{class:"comboBox-component"}).inject(this.header);this._profileCombobox.inject(i),this._isWebInWin||void 0!==window.dscef||this._setUpOpenRelationInNewWindow()}this.container.addEventListener("contextmenu",(function(e){return e.preventDefault(),!1})),this.relationBody=e.createElement("div",{class:"relations-body"}).inject(this.container),this.scroller=new R({element:this.relationBody}).inject(this.container)},setModel:function(e){this._currentRequest&&this._currentRequest.cancel(),this.sourceModels=this.sourceModels===e?this.sourceModels:e,this._platformId=e.get("platformId")||"OnPremise",this._serviceName=e.get("serviceName")||"3DSpace";let t=this.sourceModels.get("items");if(null!=t){const e=!0;this._getDetail(t,e)}else this._getDetail(this.sourceModels.get("id"))},_getDetail:function(e,t){var i=this,s={widgetId:this._widgetId,responseMode:"objectsByPatterns",label:o.getLabelAPI()};null!=t?s.items=e:Array.isArray(e)?s.ids=e:s.ids=[e],this._url&&(this._currentRequest=n.authenticatedRequest(i._url,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:o.getXPrefCredential()},method:"POST",data:JSON.stringify(s),timeout:2*o.getTimeout(),onComplete:function(e){i._currentRequest=null,e=JSON.parse(e),i._prepareURI(e).then((function(e){i._getNlsData(e).then((function(e){i.render(e)}))}))},onFailure:function(e){console.log(e);var t={};t.msg=S.get("generic"),i.dispatchEvent("ENORIPERelations_handleErrorMsgs",[t]),i.removeLoader(),i.hidePanel()},onTimeout:function(e){console.log(e);var t={};t.msg=S.get("timeout"),t.subtitle=S.get("verifyConnection"),i.dispatchEvent("ENORIPERelations_handleErrorMsgs",[t]),i.removeLoader(),i.hidePanel()}}))},fedSearch:function(e){var t,n=this,s={},a={attrs:[]};for(var c in s=o.getDefaultAttributes())a.attrs=[...a.attrs,...Array.from(new Set(s[c].attributes.map((function(e){return e.uri}))))];return a.attrs=[...a.attrs,...o.getFedSearchAttributes()],a.attrs=[...new Set(a.attrs)],t={label:l._getSearchLabel(),query:l._getQueryFromItems(e),select_predicate:a.attrs,tenant:o.getCurrentTenantName(),with_synthesis_attribute:!1,with_synthesis:!1},new i.Promise((function(e,i){n._fedSearchCall(t).then((function(t){r._processData(a,t).then((function(t){e(t)}),(function(){i()}))}))}))},_fedSearchCall:function(e){return new i.Promise((function(t,i){n.authenticatedRequest(o.get3DSearchUrl()+"/search",{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:o.getXPrefCredential()},method:"POST",data:JSON.stringify(e),timeout:o.getTimeout(),onComplete:function(e){t(e)},onFailure:function(e){console.log(e);var t={};t.msg=S.get("generic"),that.dispatchEvent("ENORIPERelations_handleErrorMsgs",[t]),that.removeLoader(),that.hidePanel()},onTimeout:function(e){console.log(e);var t={};t.msg=S.get("timeout"),t.subtitle=S.get("verifyConnection"),that.dispatchEvent("ENORIPERelations_handleErrorMsgs",[t]),that.removeLoader(),that.hidePanel()}})}))},_getNlsData:function(e){var t=this,n={};let s=e.objectsByPatterns?function(e){const t=new Map;for(const i of e)for(const e of i)t.has(e.id)||t.set(e.id,e);return Array.from(t.values())}(Object.values(e.objectsByPatterns)):[],o=r._prepareDataToNls(s);return new i.Promise((function(i,s){if(t._isWebInWin){var r={myAppsBaseUrl:t._myappsurl,userId:t._userID,lang:t._lang};c.setConfigForMyApps(r)}P.getNlsOfPropertiesValuesBySource(o,{tenantId:t._tenant,lang:t._lang,onComplete:function(s){n=t._convertToNls(e,s),i(n)},onFailure:function(t){console.log("Error in fetching NLS data from FedDictionaryAccessAPI.getNlsOfPropertiesValuesBySource, the error is :"+t),i(e)}})}))},_convertToNls:function(e,t){if(t){var i=null,n=null;for(var s in e)if(e.hasOwnProperty(s))for(var o in e[s])if(e[s].hasOwnProperty(o))for(var r=0;r<e[s][o].length;r++)for(var a in i=e[s][o][r])i.hasOwnProperty(a)&&a.contains("ds6w")&&t[a]&&t[a].hasOwnProperty(i[a])&&(n=t[a][i[a]],i[a]=n)}return e},_prepareURI:function(e){return new i.Promise(function(t,i){const n=e=>void 0===e.id&&e.serviceId&&"3DSpace"!=e.serviceId;let s=[];if(e.objectsByPatterns)for(let t in e.objectsByPatterns)s=s.concat(e.objectsByPatterns[t].filter(n));else s=e.objects.filter(n);s.length>0?this.fedSearch(s).then((function(i){Object.values(i.nlsObj).forEach((function(t){if(t["ds6w:i3dx"])if(e.objectsByPatterns)for(let i in e.objectsByPatterns)e.objectsByPatterns[i]=e.objectsByPatterns[i].map((function(e){return e["ds6w:i3dx"]&&e["ds6w:i3dx"]===t["ds6w:i3dx"]?(e.relations&&(t.relations=e.relations),t):e}));else e.objects=e.objects.map((function(e){return e["ds6w:i3dx"]&&e["ds6w:i3dx"]===t["ds6w:i3dx"]?t:e}))})),t(e)})):t(e)}.bind(this))},_setUpComboBox:function(e){this.profileArray=e.profileArray;var t,i,n=e.currentProfile,s=160,o=0,r=0,a=[],l=e.lang||null,c=!1;this.profileArray=this.profileArray.sort((function(e,t){return e.isAppSpecific===t.isAppSpecific?0:e.isAppSpecific?-1:1}));for(var d=0;d<this.profileArray.length;d++)"custom"===this.profileArray[d].type?(i=this.profileArray[d].nls||S.get(this.profileArray[d].name),S[this.profileArray[d].name]=i):i=S.get(this.profileArray[d].name),a[d]=i,t=l&&"ja"===l?14:7,s=s<a[d].length*t?a[d].length*t:s;null!==n&&""!==n&&void 0!==n&&(this._autoNavMode="AutoModeProfile"===n),this.profileTreeDocument=new u({shouldBeSelected:function(e){return"section"!==e.options.comboBoxSemantics}}),this.profileArray[0].isAppSpecific&&(this.profileTreeDocument.addRoot(new h({label:S.get("AppDedicatedRS"),comboBoxSemantics:"section"})),this.inAppSpecificSection=!0);for(var p=0;p<a.length;p++){c||this.profileArray[p].isAppSpecific||(c=!0,this.profileTreeDocument.addRoot(new h({label:S.get("AllRS"),comboBoxSemantics:"section"}))),null!==n&&""!==n&&void 0!==n&&this.profileArray[p].name===n&&(o=!this.inAppSpecificSection||this.inAppSpecificSection&&!c?p+1:p+2,r=p);var m={label:a[p],data:{name:this.profileArray[p].name}};this.profileArray[p].type&&(m.data.type=this.profileArray[p].type);var _=new h(m);this.profileTreeDocument.addRoot(_)}this.comboOptions={elementsTree:this.profileTreeDocument,nbDisplayedElements:a.length,enableSearchFlag:!1,actionOnClickFlag:!1,selectedIndex:o,touchMode:!0},this._profileCombobox=new f(this.comboOptions),this._profileCombobox.addEventListener("change",this._handleProfileChange.bind(this)),this.currentProfile=this.profileArray[r].name,this._profileCombobox.tooltipInfos=new g({shortHelp:S.get("Profiles")})},_setUpOpenRelationInNewWindow:function(){let e=this;var t={iconName:"open-in-a-new-window",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"2x"},i=new M({icon:t,displayStyle:"lite"});i.tooltipInfos=new g({shortHelp:S.get("relations_tab"),longHelp:S.get("openRelationInNewWindow"),mouseRelativePosition:!1}),i.addEventListener("click",(function(){let t=[],i=[],n=e.mapAccordion.getSelectedItems().map((t=>e.mapAccordion.getItem(t.id).name)),s=[];n.forEach((t=>{s.push(...e._linkDirectionItemsMapping[t].map((e=>e.id))),i.push(...e._linkDirectionItemsMapping[t])}));const o=e.sourceModels._attributes.items;if(Array.isArray(o)){const n=o.map((e=>e.id));s.push(...n),t.push(...n),i.push(e.sourceModels._attributes)}else Array.isArray(e.sourceModels.get("id"))?(s.push(...e.sourceModels.get("id")),t.push(...e.sourceModels.get("id")),i.push(...e.sourceModels._attributes)):(s.push(e.sourceModels.get("id")),t.push(e.sourceModels.get("id")),i.push(e.sourceModels._attributes));t.push(...e._selectedModels.map((e=>e.id)).filter((e=>s.includes(e))));const a=e.appId,l={source:a,widgetId:e._widgetId,serviceId:e._serviceName,profile:e.currentProfile,preSelectedObjectIds:t};let c=r.get3DXContent(i,l);I.publish("setX3DContent",c),e.trackPopOutCommandUsage(a),I.publish("launchApp",{appId:"ENORIPE_AP"})})),i.inject(this.header)},render:async function(t){if(this.clearPanel(),t&&t.status&&"KO"===t.status){var n={};return n.msg=S.get("generic"),this.dispatchEvent("ENORIPERelations_handleErrorMsgs",[n]),this.removeLoader(),this.hidePanel(),this}t.unindexedObjects&&t.unindexedObjects.length>0&&this.showMessageNotIndexed(t.unindexedObjects.length);var s,o,a,l,c=0,d=this,u=[],f=[],_=this._attributes.AllTypes.attributes,v={height:"inherit",displayTitleTooltip:!0,displayedOptionalCellProperties:["description","contextualMenu"],useDragAndDrop:this.isDraggable},I=[],P=[],w=!0;for(var O in this._addinMode&&this._lockedApp&&("catiav5"!==this._addinMode||"true"!==this._lockedApp&&!0!==this._lockedApp||(w=!1)),this.noContextualMenu&&(w=!1),this.responsiveTiles=[],this._selectedModels=[],this.mapAccordion=new A({className:"relations-accordion",items:[],exclusive:!1}),this.isDraggable&&(v.onDragStartCell=this._onDragStart.bind(this)),t)if(t.hasOwnProperty(O)){if(0===Object.keys(t[O]).length&&t[O].constructor===Object)return this.removeLoader(),this.renderError(),y.publish("ENORIPE_Relations_ViewReady",[]),this;for(var R in t[O]=Object.keys(t[O]).sort((function(e,t){return S.get(e).localeCompare(S.get(t))})).reduce((function(e,i){return e[i]=t[O][i],e}),{}),t[O])if((-1!==this.availableRelations.indexOf(R)||this._autoNavMode)&&t[O].hasOwnProperty(R)&&(c=t[O][R].length)>0){I=[],this._linkDirectionItemsMapping[S.get(R)]=t[O][R];for(var M=0;M<t[O][R].length;M++){s=t[O][R][M],o=new m({id:s.id,modelType:"node",columnID:0,focus:!1,isAnchor:!1,name:s.name,type:s.type,revision:s.revision});var E=(_=void 0!==this._attributes[s.type]?this._attributes[s.type].attributes:this._attributes.AllTypes.attributes).map((function(e){return e.uri}));this.models[s.id]={attrData:o,allAttr:s},f.push(o);var N=this._getLabels(s,E.slice(0,3)),C=this._getLabels(s,E.slice(3,6)),x=void 0;if("Person"===s.type){var U=s["ds6w:identifier"];U&&(x=r.getUser3DSwymPictureURL(U))}x?s.type_icon_url=x:x=s.preview_url?s.preview_url:D.getWebappsAssetUrl("SNNavigationMap","icons/thumbnailLargeDefault.png"),s.preview_url=x;var T={label:N,icons:[s.type_icon_url],subLabel:C,thumbnail:x,customTooltip:new g({shortHelp:N,longHelp:this._getLongHelp(s,_)}),data:{id:s.id,type:s.type,element:s,relName:R,uniqueId:R+"-id-"+s.id}};if(s.preview_url||P.push(s.id),w)if(this._isWebInWin)"ENORIPE_AP"===this.appId&&(T.contextualMenu="A");else if(("ENORIPE_AP"===this.appId||"X3DSEAR_AP"!=this.appId||s.type&&s.type.contains("Document"))&&(T.contextualMenu="A"),!this.ODT_MODE&&this._showOpenWith)try{var V=this._getContentForOpenWith(s),L=(new b).set3DXContent(V);let e=await new i.Promise((function(e,t){L.retrieveCompatibleApps((function(t){e(t)}),(function(e){t(e)}))}));e&&e.length>0&&(T.contextualMenu="A",T.openWithInstance=L)}catch(e){console.error("Error while retrieving compatible apps for OpenWith",e)}var j=0;s.relations&&(j="in"===s.relations[0].direction?1:s.relations.length),s.instances&&s.instances.length>0&&j>0&&(T.description=j+" ",T.description+=j>1?S.get("instances"):S.get("instance"),c+=j-1);var W=new h(T);I.push(W),this.nodeModels[s.id]=W}I.sort((function(e,t){return e.getAttributeValue("label").localeCompare(t.getAttributeValue("label"))})),(a=new p(v)).selectionBehavior={unselectAllOnEmptyArea:!0,toggle:!0,canMultiSelect:!0,canInteractiveMultiselectWithCheckboxClick:!0,enableShiftSelection:!0,enableFeedbackForActiveCell:!1},w&&(a.onContextualEvent={this:d,callback:function(e){d._handleMenuClick(e),e.data.event.stopPropagation()}}),a.model=I,l=e.createElement("div",{class:"list-tiles-container"});var F=80*a.model.length+30;l.setStyle("height",F),a.getContent().inject(l),this.responsiveTiles.push(a),u.push({title:S.get(R)+" ("+c+")",content:l,name:S.get(R)})}c=0,""}this.mapAccordion.addItem(u),this.mapAccordion.inject(this.scroller.getInnerElement()),this._accordionOpenedItem.forEach(function(e){this.mapAccordion.selectItem(e)}.bind(this)),0===f.length?this.renderError():this.showPanel(),this.responsiveTiles.length>0&&this.responsiveTiles.forEach(this._setUpEvents.bind(this)),P.length>0&&this.dispatchEvent("ENORIPE_UpdateThumbnail",[P]),this.removeLoader();var k={};return this.responsiveTiles.forEach((function(e){e.TreedocModel.getRoots().forEach((function(e){k[e._options.data.uniqueId]=e})),e.onReady(function(){e.getVisibleCellsInViewport();var t=e.getContent().getParent(),i=e.getContent().getElement(".wux-layouts-gridengine-poolcontainer-rel").getBoundingClientRect().height;t.setStyle("height",i+5)}.bind(this))})),this.expandRelationsName&&this.expandRelationsName.length>0&&this.expandRelations(this.expandRelationsName),this.dispatchEvent("ENORIPE_selectInfo",[k]),y.publish("ENORIPE_Relations_ViewReady",Object.keys(k)),this},expandRelations:function(e){if(e)for(var t=0;t<e.length;t++){this.mapAccordion.getItem(e[t])&&this.mapAccordion.selectItem(e[t])}},updateAttributes:function(e){var t,i,n,s,o=e.nlsObj;this._attributes=e.typeAttrs;var r=e.attrs;for(var a in o)o.hasOwnProperty(a)&&(t=o[a],(i=this.nodeModels[a])&&(n=this._getLabels(t,r.slice(0,3)),s=this._getLabels(t,r.slice(3,6)),i.setLabel(n),i._options.subLabel=s,i._options.customTooltip=new g({shortHelp:n,longHelp:this._getLongHelp(t,e.attributes)}),i.updateOptions()))},_updateThumbnails:function(e){if(e&&e.results){for(var t,i=this,n=[],s=0;s<e.results.length;s++){var o=e.results[s].attributes,r={};o.forEach((function(e){"resourceid"===e.name&&(r.id=e.value),"preview_url"===e.name&&(r.thumbnail=e.value)})),n.push(r)}n.forEach((function(e){(t=i.nodeModels[e.id])._options.thumbnail=e.thumbnail,t.updateOptions()}))}},_getLongHelp:function(e,t){var i="",n="";if(e)for(var s=0;s<t.length;s++)if(void 0!==(n=e[t[s].uri])){var o=t[s].label;"ds6w:modified"!==t[s].uri&&"ds6w:created"!==t[s].uri||""===n||(n=d.formatDateToString(new Date(n),{timePrecision:"sec"})),i=i+o+" : "+n+"\n"}return i},_getSelectedProfile:function(){var e=this.profileTreeDocument.getRoots()[this._profileCombobox.selectedIndex];if(e)return e},_handleProfileChange:function(){this.currentProfile=this._getSelectedProfile().options.data.name,"AutoModeProfile"===this.currentProfile?this._autoNav=!0:this._autoNav=!1,this.dispatchEvent("ENORIPE_updateRelations",[this.currentProfile])},changeComboboxProfile:function(e){var t=0;if(this._profileCombobox&&this.profileArray)for(var i=0;i<this.profileArray.length;i++)if(e===this.profileArray[i].name&&this._profileCombobox.selectedIndex!==i){t=!this.inAppSpecificSection||this.inAppSpecificSection&&this.profileArray[i].isAppSpecific?i+1:i+2,this._profileCombobox.selectedIndex=t,this._profileCombobox._applySelectedIndex();break}},_handleMenuClick:function(e){var t,i,n,s=this;i=this._getSelectedNodes(),e&&e.infos&&e.infos.target?t=e.infos.target:e&&e.data&&e.data.target&&(t=e.data.target);var o=null;if(e.cellInfos&&e.cellInfos.cellModel?(o=e.cellInfos.cellModel._options.data.element,n=e.cellInfos.cellModel.options.openWithInstance):e.context&&e.context.cellInfos&&e.context.cellInfos.cellModel&&(o=e.context.cellInfos.cellModel._options.data.element,n=e.context.cellInfos.cellModel.options.openWithInstance),o){var r,a="event"in window?event:window.event;if(a)a.clientX&&(r={x:a.clientX,y:a.clientY},t||(t=a.target));else if(e&&e.data&&e.data.windowPosition&&e.data.windowPosition.x&&e.data.windowPosition.y){var l=e.data.windowPosition;r={x:l.x,y:l.y}}var c={className:"relations-view-dropdownmenu",contextual:!0,target:t,items:[],events:{onClick:function(e){e.stopPropagation()},onHide:function(){s.dropDownMenu&&(this.destroy(),s.dropDownMenu=null)},onClickOutside:function(){s.dropDownMenu&&(this.destroy(),s.dropDownMenu=null)}}};this.dropDownMenu&&(this.dropDownMenu.destroy(),this.dropDownMenu=null),this.dropDownMenu=new O(c),this._isWebInWin?"ENORIPE_AP"===this.appId&&(this.dropDownMenu.addItem({text:S.get("AddInGraph"),name:"addInGraph",fonticon:"flow-branch-add",handler:function(){this.dispatchEvent("ENORIPERelations_addInGraph",[i])}.bind(this)}),o.type&&o.type.contains("Document")&&this.dropDownMenu.addItem({text:S.get("Download"),fonticon:"download",handler:function(){this.dispatchEvent("ENORIPE_DownloadDocument",[o.id,o.name])}.bind(this)})):("ENORIPE_AP"===this.appId&&this.dropDownMenu.addItem({text:S.get("AddInGraph"),name:"addInGraph",fonticon:"flow-branch-add",handler:function(){this.dispatchEvent("ENORIPERelations_addInGraph",[i])}.bind(this)}),"X3DSEAR_AP"!=this.appId&&this.dropDownMenu.addItem({text:S.get("Information"),name:"properties",fonticon:"info-open-in-a-new-window",handler:function(){this._manageEditProp([o])}.bind(this)}),o.type&&o.type.contains("Document")&&this.dropDownMenu.addItem({text:S.get("Download"),fonticon:"download",handler:function(){this.dispatchEvent("ENORIPE_DownloadDocument",[o.id,o.name])}.bind(this)}),!this.ODT_MODE&&this._showOpenWith&&s.dropDownMenu&&null!=n&&n.render(s.dropDownMenu));var d=void 0;r&&(d={pageX:r.x,pageY:r.y}),0!==this.dropDownMenu.items.length&&(d?this.dropDownMenu.show(!0,d):this.dropDownMenu.show())}},_getSelectedNodes:function(){var e=[];for(let t=0;t<this.responsiveTiles.length;t++)e=e.concat(this.responsiveTiles[t].TreedocModel.getSelectedNodes());return e=e.map((function(e){return e._options.data.element}))},_getContentForOpenWith:function(e){if(e){var t={data:{items:[{serviceId:this._serviceName,envId:this._platformId||"OnPremise",objectId:e.id,objectType:e.type}]}};if(e.relTypesTaxonomies&&e.relTypesTaxonomies.length>0){var i=this._getTaxonomies(e.relTypesTaxonomies);i&&i.length>0&&(t.data.items[0].objectTaxonomies=i)}else"3DShape"===e.type&&(t.data.items[0].objectTaxonomies=["PLMEntity","PLMReference","PLMCoreRepReference","LPAbstractRepReference","LPAbstract3DRepReference","PHYSICALAbstract3DRepReference","VPMRepReference","3DShape"]);return t}},_getTaxonomies:function(e){if(e&&e.length>0){for(var t=e.split(","),i=0;i<t.length;i++)if(t[i].contains("types")){t=t[i];break}var n=t.split("/");return n.length>1?(n.splice(0,1),n):[]}},_getLabels:function(e,t){if(t){for(var i="",n=0,s="",o=0;o<t.length&&(s="",e.hasOwnProperty(t[o])&&(s=e[t[o]],"ds6w:modified"!==t[o]&&"ds6w:created"!==t[o]||""===s||(s=d.formatDateToString(new Date(s),{timePrecision:"sec"}))),s&&s.length>0&&(i=i.length>0?i+this._separator+s:s,n++),3!==n);o++);return i}},updateHeader:function(){this.isProfilesVisible&&this.header.getChildren()[0].setHTML(S.get(this.currentProfile))},_onDragStart:function(e,t){const i=[t.cellModel._options.data.element];var n=r.get3DXContent(i,{action:"extract"});try{e.dataTransfer.setData("text/searchitems",JSON.stringify(n)),e.dataTransfer.setData("text",JSON.stringify(n))}catch(t){console.log(t),e.dataTransfer.setData("text",JSON.stringify(n))}s.closeWidget()},_setUpEvents:function(e){var t=e.TreedocModel.getXSO(),i=this;t.onPostAdd((function(e){e.forEach((function(e){let t=e._options.data.element;-1===i._selectedModels.indexOf(t)&&i._selectedModels.push(t)})),i._syncObjectToCompass()})),t.onPostRemove((function(e){e.forEach((function(e){let t=e._options.data.id,n=i._selectedModels.findIndex((e=>e.id===t));-1!==n&&i._selectedModels.splice(n,1)})),i._syncObjectToCompass()}))},renderError:function(){var t=this,i=this.isProfilesVisible?"link":"";this.errorDiv=new e.createElement("div",{class:"empty-relation-div"}),this.iconEmptyListP=new e.createElement("p",{class:"icon-empty-list",html:'<i class= "wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-object-related-cog" ></i>'}).inject(this.errorDiv),this.textEmptyRelationP=new e.createElement("p",{class:"empty-relation-para",html:S.get("NoResultFound")}).inject(this.errorDiv),this.errorSpan=new e.createElement("span",{class:"empty-relation-span "+i,html:S.get(t.currentProfile)}).inject(this.textEmptyRelationP),this.errorDiv.inject(this.scroller.getInnerElement()),this.isProfilesVisible&&t.errorSpan.addEvent("click",(function(){t._profileCombobox._showPopup()}))},_manageEditProp:function(e){var t=this;try{require([this._propertiesComponentRequire,this._propertiesCommandRequire,this._propertiesConstantsRequire,this._propertiesModelRequire],function(e,i,n,s){if(null===window.widget.id){let i=new e({typeOfDisplay:n.ALL,selectionType:n.ALL_SELECTION,displayType:n.POPUP,multiselection:!0,setCloseButton:!0,setEditButton:!0,readOnly:!1,extraNotif:!1,isTransient:!0});var r=[];t._selectedModels.forEach((function(e){var i=new s({metatype:"businessobject",tenant:t._tenant,objectId:e.id,source:e.serviceId});r.push(i)})),i.show(r)}else{let e=o.getXPrefCredential();var a={getSecurityContext:function(){return{SecurityContext:e,tenant:t._tenant}},getSelectedNodes:function(){var e=[];return t._selectedModels.forEach((function(i){var s={metatype:n.METATYPE_BUS,objectId:i.id,tenant:t._tenant,source:i.serviceId,type:i.type,getID:function(){return i.id}};"3DSpace"!=i.serviceId&&(s.indexModeParameter=!0),e.push(s)})),e}};(new i).launchProperties(a)}}.bind(this))}catch(e){console.error(e)}},_syncObjectToCompass:function(){var e=this._selectedModels;if(0===e.length)this.updateSelection(null),I.publish("resetTypes");else{var t={widgetId:this._widgetId};I.publish("setTypes",t)}1===e.length&&this.updateSelection(e[0]);var i=this._buildCompassData({widgetId:this._widgetId,envId:this._platformId,selectedModels:e});this._compassSocket.dispatchEvent("onSetX3DContent",i),widget.getValue("x3dAppId"),this._publishSelectionEvent(e)},_publishSelectionEvent:function(t){var i={metadata:{uid:e.Utils.getUUID(),originUid:this._selectUuid,timestamp:Date.now(),appid:"/no_private_channel",originWidgetId:widget.id,ignoreFromSameWidgetId:!0,origin:"ENORIPE_Relations"},data:{tenant:this._tenant,version:"1.1"}};"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?i.metadata.appid="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?i.metadata.appid="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(i.metadata.appid="/"+widget.getValue("appId")+"_"+widget.id)),i.data.paths=[],i.data.attrData=[];for(var n=0;n<t.length;n++)i.data.paths[n]=[t[n].id],i.data.attrData[n]=this.models[t[n].id].attrData;try{require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],(function(e){i.data.changeControl=e.get()}))}catch(e){console.warn("No Change")}y.publish("DS/PADUtils/PADCommandProxy/select",i);var s=this.localKey+"/ENORIPE_selection";y.publish(s,i)},updateSelection:function(e){if(null===e){var t={objectId:"",envId:this._platformId,contextId:"",serviceId:this._serviceName||"3DSpace"};return this._compassSocket.dispatchEvent("onSetObject",t),void this._compassSocket.dispatchEvent("onResetX3DContent",{})}var i={objectId:e.id,envId:this._platformId,contextId:"",serviceId:this._serviceName||"3DSpace"};if(this._compassSocket.dispatchEvent){this._compassSocket.dispatchEvent("onSetObject",i);var n={widgetId:this._widgetId};I.publish("setTypes",n)}},_buildCompassData:function(t){var i={};if(e.is(t)){const e={serviceId:this._serviceName,widgetId:t.widgetId,profile:this.currentProfile};i=r.get3DXContent(t.selectedModels,e)}return i},_setTypesCallback:function(e){if(e.widgetId===this._widgetId){var t={appId:e.appId,widgetId:e.widgetId};if(this._selectedModels.length>0){var i=this.buildSelectionForNativeApps();t.fileName="-file",t.fileContent=i}I.publish("launchApp",t)}},buildSelectionForNativeApps:function(){for(var e,t={version:"2.1",results:[],structures:[{structure:[]}]},i=0;i<this._selectedModels.length;i++)e=JSON.stringify(i+1),t.results.push({id:e,phid:this._selectedModels[i].id}),t.structures[0].structure.push({id:e,show:!0,select:!0,children:[]});return JSON.stringify(t)},getSelectedItems:function(e){var t=[],i=this,n=this._platformId,s=null;e.envId=n,t.push(e);for(var o=0;o<this.responsiveTiles.length;o++)(s=this.responsiveTiles[o].TreedocModel.getSelectedNodes())&&s.length>0&&s.forEach((function(s){s._options.data.id!==e.objectId&&t.push({envId:n,serviceId:i._serviceName,objectId:s._options.data.id,objectType:s._options.data.type,displayName:s._options.label})}));return t},hidePanel:function(){this.container.hide()},showPanel:function(){this.container.show()},trackPopOutCommandUsage:function(e){a.trackUsage("PopOut","SourceApp-"+e)},removeLoader:function(e){w.unmask(this.getOption("forMaskManagement"))},showMessageNotIndexed:function(e){var t=this,i=S.get("ObjectNotLoaded"),s={};e>1&&(i=S.replace(S.get("ObjectsNotLoaded"),{objectNbr:e})),s={level:"error",title:i,subtitle:S.get("ObjectNotIndexed")};let r=o.getXPrefCredential();n.authenticatedRequest(o.get3DSpaceUrl()+"/cvservlet/indexingdate?SecurityContext="+r,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:r},method:"POST",data:JSON.stringify({select_service:["FTS"]}),onComplete:function(e){if((e=JSON.parse(e)).FTS&&e.FTS.allvaultsacl){var i=new Date(1e3*e.FTS.allvaultsacl),n=d.formatDateToString(i,{datePrecision:"none",timePrecision:"sec"});s.msg=" "+S.get("LastIndexed")+" "+n}t.dispatchEvent("ENORIPERelations_handleErrorMsgs",[s])},onFailure:function(e){t.dispatchEvent("ENORIPERelations_handleErrorMsgs",[s])},onTimeout:function(e){t.dispatchEvent("ENORIPERelations_handleErrorMsgs",[s])}})},clearPanel:function(){if(this.mapAccordion){var e=this.mapAccordion.getUnselectedItems().map(function(e){return this.mapAccordion.getItem(e.id).name}.bind(this));this._accordionOpenedItem=this._accordionOpenedItem.filter((function(t){return e.indexOf(t)<0})),this.mapAccordion.getSelectedItems().forEach(function(e){this._accordionOpenedItem.indexOf(this.mapAccordion.getItem(e.id).name)<0&&this._accordionOpenedItem.push(this.mapAccordion.getItem(e.id).name)}.bind(this))}this.scroller.getInnerElement().empty(),this._selectedModels=[]},destroy:function(){this.clearPanel(),this._parent(),this.container=null}})})),define("DS/ENORIPE_Relations/views/RelationsTab",["UWA/Core","UWA/Class","UWA/Promise","DS/ENORIPE_Relations/RelationsTabSettings","DS/SNNavigationMap/MapSettings","DS/SNNavigationMap/utils/ProbesUtils","DS/ENORIPE_Relations/utils/CommonUtils","DS/ENORIPE_Common/utils/CommonAlert","DS/EditPropWidget/facets/Common/FacetsBase","UWA/Class/Model","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/UIKIT/Mask","DS/SNNavigationMap/utils/SNNavigationServices","i18n!DS/ENORIPE_Relations/assets/nls/Relations","DS/PlatformAPI/PlatformAPI"],(function(e,t,i,n,s,o,r,a,l,c,d,p,u,h,f,g){"use strict";var m,_,v=l.extend({_widgetID:(m=new Date,_=m.getDay()+m.getMonth()+m.getFullYear()+"-"+m.getHours()+":"+m.getMinutes()+":"+m.getSeconds(),"ENORIPE_Relations_Preview_"+Math.floor(1e4*Math.random())+"_"+_),_appID:n.getAppID(),_3dSpaceUrl:null,_availableRelations:[],_profileInfo:null,profilePopover:null,_toggles:[],_tenant:null,_subscriptions:[],_autoNavMode:n.getOption("automode"),_lastSecurityContextUsed:null,init:function(t){var i=this;this._parent.apply(this,arguments),this.elements.container||(this.elements.container=e.createElement("div",{class:"relationsFacet-container",styles:{height:"100%"}})),void 0===n.getOption("initProfileDone")&&t&&t.defaultProfile&&e.is(t.defaultProfile,"string")&&n.saveValuesForProfile("LastUsedProfile",t.defaultProfile);var s=n.getLocalKey()+"/setProfile",o=n.getLocalKey()+"/updateAttributes",r=n.getLocalKey()+"/updatePublicationsMode",a=n.getLocalKey()+"/expandRelations",l=g.subscribe(s,(function(e){i.setProfile(e.profile)}));g.subscribe(o,(function(e){i._setAttributes(e.attrs),i.updateAttributes()})),g.subscribe(r,(function(e){i.updatePublicationsMode(e.publicationsMode)})),a=g.subscribe(a,(function(e){i.expandRelations(e.relationsNames)}));this._subscriptions.push(l),!0!==n.getOption("isExternal")&&"true"!==n.getOption("isExternal")||(this.getModel=function(){return i._internalModel})},updateFacet:function(){var e=this,i=e.getModel();if(null!==i){var n="relationship"===i.get("metatype");i.isMergedModel()?i.getMergedModelIds():n?i.get("selReferenceID"):i.get("objectId");if(console.log(i.isMergedModel()?i.getMergingModels():"none"),!n||n&&void 0!==i.get("selReferenceID")){this._tenant=i.get("tenant"),this.setDefaultPredicates(),this.addLoader();var o=new t.Promise((function(t,n){null!==e._3dSpaceUrl&&t(),s.appInitializationPromised(null,e._tenant).then((function(){p.getServiceUrl({serviceName:"3DSpace",platformId:i.get("tenant")?i.get("tenant"):"OnPremise",onComplete:function(i){e._3dSpaceUrl=i,t()},onFailure:function(t){console.log(t),e.removeLoader(),n()}})}))}));return new t.Promise((function(t,i){o.then((()=>{e._getSecurityContext().then((i=>{e._lastSecurityContextUsed!==i?(e._lastSecurityContextUsed=i,s.setXPrefCredential(i),e._initAndRenderListView().then((function(){t()}))):void 0!==e.currentProfile&&e._setPreferences().then((function(){e._renderListView(),e.trackUsage("init"),t()}))}))}))}))}}},_getSecurityContext:function(e){var i=this;return new t.Promise((function(t,o){var r;r=e?n.getOption("securityContextFromAppPreference"):i.getOption("securityContextFromAppPreference"),console.log("[Relations] securityContext from App",r),null!=r?t(r):s._getListOfSecurityContextAndPreferredOne().then((function(e){var i=e.preferredSecurityContext;t(i)}))}))},updateFacetExternal:function(e){var i=this;if(null!==e){var n,o="relationship"===e.get("metatype");if(o?o&&void 0!==e.get("selReferenceID")&&(n=e.get("selReferenceID")):n=e.get("objectId"),void 0!==n){e.set("id",n),this.setModel(e),this._tenant=e.get("tenant"),this.setDefaultPredicates(),this.addLoader();var r=new t.Promise((function(t,n){null!==i._3dSpaceUrl&&t(),s.appInitializationPromised().then((function(){p.getServiceUrl({serviceName:"3DSpace",platformId:e.get("tenant")?e.get("tenant"):"OnPremise",onComplete:function(e){i._3dSpaceUrl=e,t()},onFailure:function(e){console.log(e),i.removeLoader(),n()}})}))}));return new t.Promise((function(e,t){r.then((()=>{i._getSecurityContext(!0).then((t=>{i._lastSecurityContextUsed!==t?(i._lastSecurityContextUsed=t,s.setXPrefCredential(t),i._initAndRenderListView().then((function(){e()}))):void 0!==i.currentProfile&&i._setPreferences().then((function(){i._renderListView(),i.trackUsage("init"),e()}))}))}))}))}}},updateFacetOptions:e=>new t.Promise((function(t,i){e&&(e.addinmode&&n.setOption("addinmode",e.addinmode),e.hasOwnProperty("isProfilesVisible")&&n.setOption("isProfilesVisible",e.isProfilesVisible),e.securityContext&&n.setOption("securityContextFromAppPreference",e.securityContext)),t()})),_initAndRenderListView:function(){var e=this;return new t.Promise((function(t,i){n.isAvailable().then(e._getSettingsAndRelSets.bind(e)).then(e._mergeSettings.bind(e)).then(e._parseRelations.bind(e)).then(e._setPreferences.bind(e)).then((function(){e._renderListView(),e.trackUsage("init"),t()}))}))},_getSettingsAndRelSets:function(e){var t=this._getRelSettings(),n=this._getProfiles(e);return i.all([t,n])},_getRelSettings:function(){var e=this;return{widgetId:e._widgetId},new i((function(t,i){var n=e._3dSpaceUrl+"/resources/enorelcc/cc_services/getrelsettings?tenant="+e._tenant;d.authenticatedRequest(n,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:s.getXPrefCredential()},method:"GET",timeout:s.getTimeout(),onComplete:function(i){e._parseSettings(JSON.parse(i)).then((function(){t()}))},onFailure:function(e){i(e),console.log(e)},onTimeout:function(e){i(e),console.log(e)}})}))},_parseSettings:function(e){var t=this;return new i((function(i,n){e.notexist||void 0===e.relation_apps?t._getResetRelApps().then((function(e){t._settings=e,i()})):(t._settings=e,i())}))},_getResetRelApps:function(){var e=this;return{widgetId:e._widgetId},new i((function(t,i){if(void 0===e._resetSettingsFromServer){var n=e._3dSpaceUrl+"/resources/enorelcc/cc_services/getrelappsinit?tenant="+e._tenant;d.authenticatedRequest(n,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:s.getXPrefCredential()},method:"GET",timeout:s.getTimeout(),onComplete:function(i){e._resetSettingsFromServer=JSON.parse(i),t(e._resetSettingsFromServer)},onFailure:function(e){i(e),console.log(e)},onTimeout:function(e){i(e),console.log(e)}})}else t(e._resetSettingsFromServer)}))},trackUsage:function(e){o.trackMultiUsage("relationsTabUsage",e,[this.currentProfile,this._appID])},_getSelectedItems:function(){let e=[];const t=this.getOccurrence();if(null!==t){const i=t.getSharedInformationForFacet();if(null!==i){const t=i.objectIdentifierFromApp;null!==t&&t.forEach((t=>{if(void 0!==t.identifier){let n;if("relationship"===t.metatype){if(void 0!==i.coupleInformation){const e=t.identifier,{referenceId:s}=i.coupleInformation.find((t=>t.connectionId===e))||{};void 0!==s&&(n={id:s,serviceId:model.get("source")||"3DSpace",instances:[{id:e}]})}}else n={id:t.identifier,serviceId:model.get("source")||"3DSpace",instances:[]};void 0!==n&&e.push(n)}}))}}return e},_renderListView:function(){var e,t=this,i=[],s=!1,o=!1;if(t.elements&&t.elements.container){var r=t.getModel();if(!r)return!1;const d=t._getSelectedItems();if(0!=d.length?o=!0:(e=!!r.isMergedModel&&r.isMergedModel(),"relationship"===r.get("metatype")&&void 0!==r.get("selReferenceID")&&(s=!0)),t.listView)if(t.listView.availableRelations=t._availableRelations,t.listView._attributes=n.getOption("typeattributes"),o)t.listView.setModel(new c({items:d,serviceName:r.get("source")||"3DSpace",platformId:r.get("tenant")||"OnPremise"}));else{var a=e?r.getMergedModelIds():s?r.get("selReferenceID"):r.get("objectId");t.listView.setModel(new c({id:a,serviceName:r.get("source")||"3DSpace",platformId:r.get("tenant")||"OnPremise"}))}else{for(var l=0;l<t._profileInfo.length;l++)t._profileInfo[l].type?i[l]={name:t._profileInfo[l].name,type:t._profileInfo[l].type}:i[l]={name:t._profileInfo[l].name},t._profileInfo[l].custom&&(i[l].type="custom"),t._profileInfo[l].applications&&t._profileInfo[l].applications.length>0&&(i[l].isAppSpecific=!0),t._profileInfo[l].nlsLabel&&(i[l].nls=t._profileInfo[l].nlsLabel);require(["DS/ENORIPE_Relations/views/RelationsView"],(function(a){if(t.listView=new a({fireEventOnSlide:!0,widgetId:t._widgetID,appId:t._appID,localKey:n.getLocalKey(),debugMode:!0,serviceURL:t._3dSpaceUrl,currentProfile:t.currentProfile,profileArray:i,tenant:t._tenant,separator:n.getOption("displayNameSeparator"),attrs:n.getOption("typeattributes"),lang:n.getLang(),userID:"",isDraggable:n.getOption("isDraggable"),isProfilesVisible:n.getOption("isProfilesVisible"),noContextualMenu:n.getOption("noContextualMenu"),autoNavMode:t._autoNavMode,forMaskManagement:t.elements.container,addinmode:n.getOption("addinmode"),lockedApp:n.getOption("lockedapp"),myappsurl:h.isWebInWin()?n.getMyAppsUrl():null,expandRelations:n.getOption("expandRelations")}),t.listView.inject(t.elements.container),t.listView.availableRelations=t._availableRelations,o)t.listView.setModel(new c({items:d,serviceName:r.get("source")||"3DSpace",platformId:r.get("tenant")||"OnPremise"}));else{var l=e?r.getMergedModelIds():s?r.get("selReferenceID"):r.get("objectId");t.listView.setModel(new c({id:l,serviceName:r.get("source")||"3DSpace",platformId:r.get("tenant")||"OnPremise"}))}t.listView.addEvent("ENORIPERelations_handleErrorMsgs",t._showNotif,t),t.listView.addEvent("ENORIPE_updateRelations",t._updateRelations,t),t.listView.addEvent("ENORIPERelations_addInGraph",(function(e){var t=n.getLocalKey()+"/addInGraph",i={models:e};g.publish(t,i)})),t.listView.addEvent("ENORIPE_DownloadDocument",(function(e,t){require(["DS/SNNavigationMap/utils/MapFileUtils"],(function(i){new i({}).handleDownload(e,t)}))})),t.listView.addEvent("ENORIPE_selectInfo",(function(e){t._selectInfo=e})),n.getOption("Fetch_Thumbnails")&&t.listView.addEvent("ENORIPE_UpdateThumbnail",t._updateThumbnails,t)}))}}},_updateRelations:function(e){if(e){this.addLoader(),this.setProfile(e)}},_updateThumbnails:function(e){var t=this;void 0===this._commonUtils&&(this._commonUtils=new r({_3dSpaceUrl:this._3dSpaceUrl,myappsurl:h.isWebInWin()?n.getMyAppsUrl():null,tenant:this._tenant,isWebInWin:h.isWebInWin(),lang:n.getLang(),userID:n.getUserID()}));try{this._commonUtils.fetchThumbNails(e).then((function(e){e&&t.listView._updateThumbnails(JSON.parse(e))}),(function(e){console.log(e)}))}catch(e){console.log("err while fetching tooltip")}},selectNodes:function(e){var t=this;e.forEach((function(e){t._selectInfo[e]&&t._selectInfo[e].select()}))},unselectNodes:function(e){var t=this;e.forEach((function(e){t._selectInfo[e]&&t._selectInfo[e].unselect()}))},updateAttributes:function(){void 0===this._commonUtils&&(this._commonUtils=new r({_3dSpaceUrl:this._3dSpaceUrl,myappsurl:h.isWebInWin()?n.getMyAppsUrl():null,tenant:this._tenant,isWebInWin:h.isWebInWin(),lang:n.getLang(),userID:n.getUserID()}));var e=Object.keys(this.listView.models);if(e&&e.length>0)for(var t=0;t<e.length;t++){var i=this.listView.models[e[t]].get("type");this._fetchAndSetAttributes(e[t],i)}},updatePublicationsMode:function(e){n.setOption("publicationsMode",e)},expandRelations:function(e){this.listView&&this.listView.expandRelations(e)},_fetchAndSetAttributes:function(e,t){var i=this,s={ids:[e],typeAttrs:n.getOption("typeattributes"),type:t};try{i._commonUtils.fetchAttributes(s).then((function(e){e&&e.nlsObj&&Object.keys(e.nlsObj).length>0&&i.listView.updateAttributes(e)}),(function(e){console.log(e)}))}catch(e){console.log("err while fetching tooltip")}},createPromise:function(e){var i=JSON.stringify(e.params),n=this;return new t.Promise((function(t,o){d.authenticatedRequest(e.url,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:s.getXPrefCredential()},method:"POST",data:i,timeout:s.getTimeout(),onComplete:t,onFailure:function(e){console.log(e),n._showNotif({message:f.get("generic")}),n.removeLoader(),o(e)},onTimeout:function(e){console.log(e),n._showNotif({message:f.get("timeout"),subtitle:f.get("verifyConnection")}),n.removeLoader(),o(e)}})}))},setModel:function(e){this._internalModel=e},_getProfiles:function(e){var t=this;return this.createPromise({url:t._3dSpaceUrl+"/resources/enorelnav/navigate/getProfiles?tenant="+t._tenant,params:{widgetId:t._widgetID,roles:e.roles,profileVersion:2}})},_mergeSettings:function(e){if(e&&e.length>0){var t=JSON.parse(e[1]),s=n.getRoles(),o=this,r=!1;return new i(function(e,i){o._settings.relation_sets||e(t),0===Object.keys(o._settings.relation_sets).length&&e(t);t.profiles.map((function(e){return e.name}));for(var n=0;n<o._settings.relation_sets.length;n++){for(var a=o._settings.relation_sets[n].roles,l=o._settings.relation_sets[n].userGroups,c=!1,d=0;d<a.length;d++)if(s.indexOf(a[d])>-1){c=!0;break}if(l.length>0&&!c){r=!0;break}}r?o._getGrantedUsrGrp().then((function(i){t=o._filterRelSets(t,i),e(t)})):(t=o._filterRelSets(t,[]),e(t))}.bind(this))}},_filterRelSets:function(e,t){var i=n.getRoles(),s=e.profiles.map((function(e){return e.name})),o=(t=t.map((function(e){return e.resourceid})),"In_App_Product_Relations");this._settings&&this._settings.relation_apps&&this._settings.relation_apps[this._appID]&&(o=this._settings.relation_apps[this._appID]);for(var r=0;r<this._settings.relation_sets.length;r++){var a=this._settings.relation_sets[r].roles,l=this._settings.relation_sets[r].userGroups,c=this._settings.relation_sets[r].name,d=(this._settings.relation_sets[r].applications,!1);a&&a.length>0&&(a=a.map((function(e){return e.name}))),l&&l.length>0&&(l=l.map((function(e){return e.name})));for(var p=0;p<a.length;p++)if(i.indexOf(a[p])>-1){d=!0;break}if(!d)for(c===o&&console.debug(`"${c}" profile not authorized (roles check)`,{profileRoles:a,userRoles:i}),p=0;p<l.length;p++)if(t.indexOf(l[p])>-1){d=!0;break}var u=s.indexOf(c);d?-1===u?e.profiles.push(this._settings.relation_sets[r]):e.profiles.splice(u,1,this._settings.relation_sets[r]):(c===o&&console.debug(`"${c}" profile not authorized (userGroups check)`,{profileUsrGrps:l,userUsrGrps:t}),-1!==u&&e.profiles.splice(u,1))}var h=[...e.profiles];for(r=0;r<h.length;r++)if(h[r].applications){let t=h[r].applications;if(t.length>0&&(t=t.map((function(e){return e.name})),t.indexOf(this._appID)<0)){let t=(s=e.profiles.map((function(e){return e.name}))).indexOf(h[r].name);e.profiles.splice(t,1)}}return e},_getGrantedUsrGrp:function(){var e=this;return new i((function(t,i){if(void 0===typeof s||!s)var s=e.getModel();n.getOption("user_granted_groups")?t(n.getOption("user_granted_groups")):p.getServiceUrl({serviceName:"3DSearch",platformId:s.get("tenant")?s.get("tenant"):"OnPremise",onComplete:function(i){var s={},o=i+"/search",r=n.getUserID();s.label="ENORIPE_"+r+"_"+Date.now(),s.select_predicate=["ds6w:label"],s.query="[ds6w:type]:GROUP AND "+r,s.tenant=e._tenant,s.nresults=100,s.with_synthesis_attribute=!1,s.with_synthesis=!1,s=JSON.stringify(s),d.authenticatedRequest(o,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:s,onComplete:function(i){var s=e._parseUserGroups(JSON.parse(i));n.setOption("user_granted_groups",s),t(s)},onFailure:function(e){console.log("failed in fetching granted usrgrps"+e),t([])},onTimeout:function(e){console.log("failed in fetching granted usrgrps"+e),t([])}})},onFailure:function(t){console.log(t),e.removeLoader(),i()}})}))},_parseUserGroups:function(e){var t=[];if(e.results)for(var i=0;i<e.results.length;i++){var n=e.results[i];if(n.attributes){for(var s={},o=0;o<n.attributes.length;o++)"resourceid"===n.attributes[o].name&&(s.resourceid=n.attributes[o].value),"ds6w:label"===n.attributes[o].name&&(s.label=n.attributes[o].value);void 0!==s.resourceid&&t.push(s)}}return t},_parseRelations:function(e){if(this._availableRelations=[],e){var t,s=this,o=e.profiles[0],r={name:"AutoModeProfile"},a=n.getValuesForProfile("LastUsedProfile");r.relations=[],e.profiles.unshift(r);var l=this._getRelationsSet();if(l)for(var c=0;c<l.length;c++)e.profiles.splice(c+1,0,l[c]);this._profileInfo=e.profiles,t=null!==a&&""!==a&&void 0!==a?a:"defaultID"===this._appID?e.profiles[0].name:this._settings.relation_apps[this._appID],this.currentProfile=e.profiles[0].name;for(var d=0;d<e.profiles.length;d++)if(t===e.profiles[d].name){o=e.profiles[d],this.currentProfile=e.profiles[d].name;break}"AutoModeProfile"===this.currentProfile?this._autoNavMode=!0:this._autoNavMode=!1;for(var p=0;p<this._profileInfo.length;p++);}return new i((function(e,t){if(o){for(var i=o.relations,n=0;n<i.length;n++)s._availableRelations.push(i[n].name);e()}else t()}))},_setPreferences:function(){var e,t=this,i=this._getAttrForTypes();return e=!!n.getOption("publicationsMode"),n.saveValuesForProfile("LastUsedProfile",this.currentProfile),console.log("[Relations] security context to render list view",s.getXPrefCredential()),this.createPromise({url:t._3dSpaceUrl+"/resources/enorelnav/v2/navigate/setPreferences?tenant="+t._tenant,params:{widgetId:t._widgetID,relations:t._autoNavMode?["use-auto-by-type-relations"]:t._availableRelations,allRelationsMode:t._autoNavMode,publicationsMode:e,computeWithInstances:!1,attributesForView:i,label:s.getLabelAPI(),lang:s.getLang()||"en",ghostMode:s.getGhostMode()}})},_getAttrForTypes:function(){var e=n.getOption("typeattributes"),t=[];for(var i in e){if(e.hasOwnProperty(i))e[i].attributes.map((function(e){return e.uri})).forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))}return t},setDefaultPredicates:function(){var e=n.getUserID()+"_ENORIPE_Type_Attrs",t=localStorage.getItem(e),i=[];if(t)t=JSON.parse(t);else{for(var s,o,r=n.getOption("attributes"),a=0;a<r.length;a++)o=-1!==(s=r[a]).indexOf(":")?f.get(s.substring(s.indexOf(":")+1)):f.get(s),i.push({uri:s,label:o});t={AllTypes:{name:"AllTypes",nlsLabel:f.get("AllTypes"),attributes:i}}}this._setAttributes(t)},_setAttributes:function(e){n.setOption("typeattributes"),n.setOption("typeattributes",e)},_getRelationsSet:function(){var e=localStorage.getItem(n.getUserID()+"_ENORIPE_CustomRelationsSet");if(e)return JSON.parse(e)},_showNotif:function(e){e.container=e.container||this.elements.container,e.isAlert=!0,a.showNotif(e,h.isWebInWin())},addLoader:function(){u.mask(this.elements.container)},removeLoader:function(e){u.unmask(this.elements.container)},getProfilesAndRelations:function(){return this._profileInfo},getCurrentProfile:function(){return this.currentProfile?this.currentProfile:n.getValuesForProfile("LastUsedProfile")},getProfiles:function(){var e=[];return this._profileInfo&&this._profileInfo.length>0&&this._profileInfo.forEach((function(t){e.push(t.name)})),e},setProfile:function(e){if(""!==e&&null!=e){for(var i=this,n=!1,s=0;s<this._profileInfo.length;s++)if(this._profileInfo[s].name===e&&this.currentProfile!==e){n=!0,this.currentProfile=this._profileInfo[s].name;var o=this._profileInfo[s].relations;this._availableRelations=[],"AutoModeProfile"===e?(this._autoNavMode=!0,this.listView._autoNavMode=!0):(this._autoNavMode=!1,this.listView._autoNavMode=!1);for(var r=0;r<o.length;r++)this._availableRelations.push(o[r].name);this.listView.availableRelations=this._availableRelations;break}return new t.Promise((function(t,s){n?(i.listView&&i.listView.changeComboboxProfile(e),i._setPreferences().then((function(){i._renderListView(),i.trackUsage("change"),t()}),(function(){s()}))):t()}))}console.log("Invalid profile name")},destroyComponent:function(){e.is(this.destroy,"function")&&this.destroy()}});return v}));