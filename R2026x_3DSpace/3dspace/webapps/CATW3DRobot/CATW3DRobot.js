define("DS/CATW3DRobot/CATC3DRobotSnapPanel",["UWA/Core","UWA/Class","DS/Windows/Panel","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Controls/LineEditor","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/CATW3DRobot/assets/nls/CATC3DRobotSnapPanel","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Controls/Button","DS/CATWebUXComponents/DMUCommandsManager","DS/CoreEvents/Events","css!DS/CATW3DRobot/CATW3DRobot"],(function(e,t,n,i,o,a,r,l,s,u,c,d){"use strict";return t.extend({init:function(t){let m=window.widget&&window.widget.lang?window.widget.lang:void 0;const p=new Intl.NumberFormat(m).format(1.1).replaceAll("1","");var g=t.immersiveFrame,v=Object.assign({},t.w3dRobot.getLengthUnit()),h=Object.assign({},t.w3dRobot.getAngleUnit()),b=r.Length[v.unit].ratio,f=r.Angle[h.unit].ratio,y=i.get(),M=y._viewer.getRobot(),x=y._viewer,w=s.giveMoveManager({context:y}),V=new e.Element("div"),P=new a({}),C=[];P.elements.inputField.setStyles({height:"0px",border:"0px"}),P.elements.container.setStyles({fontSize:"0px"}),P.inject(V);var D=new e.Element("div",{html:l.translation}).inject(V);C.push({type:"X",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Length",label:l.translationX}),C.push({type:"Y",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Length",label:l.translationY}),C.push({type:"Z",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Length",label:l.translationZ}),new e.Element("div",{html:l.rotation}).inject(D).setStyles({"padding-top":"10px"}),C.push({type:"U",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Angle",label:l.rotationU}),C.push({type:"V",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Angle",label:l.rotationV}),C.push({type:"W",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Angle",label:l.rotationW});var R=0;const E=new Map;E.set(0,0),E.set(1,0),E.set(2,0);var A=new o.Vector3,S=new o.Vector3,T=new o.Vector3,F=x.getMousePosition({x:i._context.getFrameWindow().getContextualUIManager()._mousePos.x,y:i._context.getFrameWindow().getContextualUIManager()._mousePos.y}),L=0;function N(e,t){return"string"==typeof e&&(e=parseFloat((e||"").replace(p,"."))),isNaN(e)?(e=t.mksVal,isNaN(e)&&(e=0)):e="Length"===t.magnitude?e/b:e/f,e}function W(e,t){"string"==typeof e&&(e=parseFloat(e)),isNaN(e)&&(e=t.mksVal),isNaN(e)&&(e=0),"Length"===t.magnitude?e*=b:((e%=2*Math.PI)<0&&(e+=2*Math.PI),e*=f);let n="Length"===t.magnitude?v.decimalPlaceRO:h.decimalPlaceRO;return e=Math.round(e*Math.pow(10,n))/Math.pow(10,n),e="Length"===t.magnitude?e.toString().replace(".",p)+" "+r.Length[v.unit].symbol:e.toString().replace(".",p)+" "+r.Angle[h.unit].symbol}function k(e,t){L=1,C[e].editDiv.value=W(t,C[e]),L=0}function O(e){L=1,C[e].editDiv._myInput.select(),C[e].editDiv._giveFocus(),L=0}for(let t=0;t<6;t++)new e.Element("span",{text:C[t].label}).inject(C[t].mainDiv),C[t].editDiv=new a({value:W(0,C[t]),selectAllOnFocus:!0}),C[t].editDiv.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),C[t].editDiv.inject(C[t].mainDiv);var B=new u({label:l.save,emphasize:"primary",disabled:!0,showLabelFlag:!0}).inject(D);B.elements.button.setStyles({margin:"8px"});var I=new u({label:l.cancel,emphasize:"secondary",showLabelFlag:!0}).inject(D),G=function(e,t,n){e._modelEvent.publish({event:"LineTranslationBegin",data:{eventChannel:"LineTranslationBegin",target:e.target,intersection:t,manipulator:n}})},_=function(e,t,n,i){e._modelEvent.publish({event:"LineTranslationEnd",data:{eventChannel:"LineTranslationEnd",target:e.target,intersection:t,manipulator:n,FromPanel:i}})},U=function(e,t,n,i){e._modelEvent.publish({event:"RotationBegin",data:{eventChannel:"RotationBegin",target:e.target,intersection:t,manipulator:n,angle:event&&event.dsModel&&event.dsModel.value?event.dsModel.value:0,axis:i}})},X=function(e,t){e._modelEvent.publish({event:"RotationEnd",data:{eventChannel:"RotationEnd",target:e.target,fromPanel:t}})},Y=function(e){let t,n,i;return M.getMatrix().extractBasis(A,S,T),"X"===e.type?(t=M.arrowX,n="arrowX",i=A):"Y"===e.type?(t=M.arrowY,n="arrowY",i=S):"Z"===e.type&&(t=M.arrowZ,n="arrowZ",i=T),t.manipulatedPaths=[],t.manipulatedPaths[0]={externalPath:[],internalPath:[]},t.manipulatedPaths[0].externalPath[0]={name:n},t.axis=i,t},j=function(e){let t,n;return M.getMatrix().extractBasis(A,S,T),"U"===e.type?(t=M.rotationArcYZ,n=A):"V"===e.type?(t=M.rotationArcXZ,n=S):"W"===e.type&&(t=M.rotationArcXY,n=T),{manip:t,axis:n}};[0,1,2].forEach((e=>{C[e].editDiv.addEventListener("focus",(function(t){if(!L){C[e].mksVal=N(t.dsModel.value,C[e]);var n=x.pick(F,"mesh",!0),i=Y(C[e]);M&&(G(M,n,i),_(M,n,i,!0))}})),C[e].editDiv.addEventListener("change",(function(t){if(!L){let l=N(t.dsModel.value,C[e]);var n=x.pick(F,"mesh",!0),i=Y(C[e]),a=(r=C[e],M.getMatrix().extractBasis(A,S,T),(new o.Vector3).copy("X"===r.type?A:"Y"===r.type?S:T)).setLength(1e3*(l-C[e].mksVal));C[e].mksVal=l,M&&(G(M,n,i),function(e,t,n,i,a){e._modelEvent.publish({event:"LineTranslationManipulation",data:{eventChannel:"LineTranslationManipulation",target:e.target,translationVector:t,intersection:n,manipulator:i,FromPanel:a}}),e.setMatrix((new o.Matrix4).copy(e.getMatrix()).setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()).add(t))),R=1}(M,a,n,i,!0),k(e,l),_(M,n,i,!0))}var r})),C[e].editDiv.addEventListener("blur",(function(e){e.stopPropagation()}))})),[3,4,5].forEach((e=>{C[e].editDiv.addEventListener("focus",(function(){if(!L){var t=x.pick(F,"mesh",!0),n=j(C[e]);M&&(U(M,t,n.manip,n.axis),X(M,!0))}})),C[e].editDiv.addEventListener("change",(function(t){if(!L){for(let t=3;t<6;t++)t!==e&&(k(t,0),E.set(t-3,0));let r=N(t.dsModel.value,C[e]);var n=x.pick(F,"mesh",!0),i=j(C[e]),a=r-E.get(e-3);E.set(e-3,r),M&&(U(M,n,i.manip,i.axis),function(e,t,n,i,a,r){e._modelEvent.publish({event:"RotationManipulation",data:{eventChannel:"RotationManipulation",target:e.target,intersection:t,manipulator:n,angle:a,axis:i,FromPanel:r}});var l=(new o.Matrix4).makeRotationAxis(i,a).multiply((new o.Matrix4).extractRotation(e.getMatrix()));M.setMatrix(l.setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()))),R=1}(M,n,i.manip,i.axis,a,!0),k(e,r),X(M,!0))}})),C[e].editDiv.addEventListener("blur",(function(e){e.stopPropagation()}))}));var Z=function(e,t){return e.x.toFixed(3)===t.x.toFixed(3)&&e.y.toFixed(3)===t.y.toFixed(3)&&e.z.toFixed(3)===t.z.toFixed(3)},H=function(e){return Z(e,M.arrowX.manipulator.axis)?0:Z(e,M.arrowY.manipulator.axis)?1:Z(e,M.arrowZ.manipulator.axis)?2:-1},q=function(e){return Z(e,M.rotationArcYZ.axis)?3:Z(e,M.rotationArcXZ.axis)?4:Z(e,M.rotationArcXY.axis)?5:-1};t.w3dRobot._rulerformed((function(e){if(null===e.cposition)return;L=1,M.getMatrix().extractBasis(A,S,T);let t=(new o.Vector3).subVectors(M.getMatrix().getPosition(),e.cposition);[{dirName:"arrowX",dirVect:A},{dirName:"arrowY",dirVect:S},{dirName:"arrowZ",dirVect:T}].forEach((function(n,i){if(e.direction===n.dirName){let e=t.x*n.dirVect.x+t.y*n.dirVect.y+t.z*n.dirVect.z;C[i].mksVal=e/1e3,k(i,C[i].mksVal),O(i)}})),L=0})),t.w3dRobot.rulerCB((function(e){if("RulerManipulate"===e.eventName){let t=H(e.direction);t>=0&&(C[t].mksVal=e.value/1e3,k(t,C[t].mksVal),O(t))}else if("AngularRulerManipulate"===e.eventName){let t=q(e.direction);if(t>=0){let n=e.diffAngle/180*Math.PI;k(t,n+E.get(t-3)),O(t),E.set(t-3,n+E.get(t-3));for(let e=3;e<6;e++)e!==t&&(k(e,0),E.set(e-3,0))}}else if("AngularRulerManipulateBegin"===e.eventName){let t=q(e.direction);if(t>=0){let n=e.value/180*Math.PI;k(t,n),E.set(t-3,n)}}})),t.w3dRobot.manipCB((function(e){switch(e.Rulerchannel){case"LineTranslationManipulation":if(!e.Rulersource){let t=H(e.Rulerdirection);t>=0&&(C[t].mksVal=e.Rulervalue/1e3,k(t,C[t].mksVal),O(t))}break;case"RotationBegin":break;case"RotationManipulation":if(!e.Rulersource){let t=q(e.Rulerdirection),n=e.Rulervalue/180*Math.PI;if(t>=0){k(t,n),O(t),E.set(t-3,n);for(let e=3;e<6;e++)e!==t&&(k(e,0),E.set(e-3,0))}}break;case"PlaneTranslationManipulation":var n,i,a=(new o.Vector3).getPositionFromMatrix(M.getMatrix()),r=(new o.Vector3).copy(M.arrowX.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(M.arrowX.manipulator.axis)),l=(new o.Vector3).copy(M.arrowY.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(M.arrowY.manipulator.axis)),s=(new o.Vector3).copy(M.arrowZ.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(M.arrowZ.manipulator.axis));n=(new o.Vector3).copy(a).add(r);var u=(new o.Vector3).copy(n).sub(a).dot(M.arrowX.manipulator.axis);i=n.distanceTo(a)*(u>0?-1:1),C[0].mksVal=i/1e3,k(0,C[0].mksVal),n=(new o.Vector3).copy(a).add(l),u=(new o.Vector3).copy(n).sub(a).dot(M.arrowY.manipulator.axis),i=n.distanceTo(a)*(u>0?-1:1),C[1].mksVal=i/1e3,k(1,C[1].mksVal),n=(new o.Vector3).copy(a).add(s),u=(new o.Vector3).copy(n).sub(a).dot(M.arrowZ.manipulator.axis),i=n.distanceTo(a)*(u>0?-1:1),C[2].mksVal=i/1e3,k(2,C[2].mksVal),0===e.vector.x?O(1):O(0)}}));var z=c.getCommand("CAT3DComposeMoveHdr",i.get()._context);z&&z.isRunning()&&(R=1);var K=this._panel=new n({immersiveFrame:g,content:V,icon:{iconName:"part-position wux-ui-3ds",fontIconFamily:window.WUXManagedFontIcons.Font3DS},visibleFlag:!0,minWidth:170,height:"auto",maxHeight:660,currentDockArea:8,allowedDockAreas:15,position:{my:"right",at:"right",of:g},collapsibleFlag:!1,verticallyStretchableFlag:!0,closeButtonFlag:!1,resizableFlag:!0,activeFlag:!1}),J=function(){C[0].mksVal=0,C[1].mksVal=0,C[2].mksVal=0,L=0,E.set(0,0),E.set(1,0),E.set(2,0)};M.subscribe("ScreenPlaneTranslationBegin",(function(){K.destroy(),J()})),M.subscribe("ScreenPlaneTranslationEnd",(function(){K.destroy(),J()})),w.subscribe("onCancelMove",(function(){K.destroy(),J()})),w.subscribe("onValidateMove",(function(){z&&z.cancel(),K.destroy(),J()})),w.subscribe("Move",(function(){R=1,B.disabled=!1})),B.addEventListener("buttonclick",(function(){w.terminateMove({save:!0}),y.getExecutionContext&&d.publish({event:"onCommandStart/BEGIN",data:{_id:y.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getDefaultCommand()}})})),I.addEventListener("buttonclick",(function(){if(R)w.terminateMove({save:!1}),(z=c.getCommand("CAT3DComposeMoveHdr",i.get()._context))&&z.cancel();else{var e=c.getCommand("CAT3DComposeRobotSnapMoveHdr",i.get()._context),t=c.getCommand("CAT3DComposeWidgetDefaultHdr",i.get()._context);e._isRunning?e.end():t.end(),K.destroy(),J()}y.getExecutionContext&&d.publish({event:"onCommandStart/BEGIN",data:{_id:y.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getDefaultCommand()}})}));let Q=function(e){let t=e.which||e.keyCode;27===t?K&&(K.destroy(),J(),document.body.removeEventListener("keydown",Q)):13===t?K&&R&&(K.destroy(),J(),document.body.removeEventListener("keydown",Q)):9!==t||K.activeFlag||(K.activeFlag=!0)};document.body.addEventListener("keydown",Q),this.resetTheRotation=function(){for(let n=3;n<6;n++){var e=x.pick(F,"mesh",!0),t=j(C[n]);M&&(U(M,e,t.manip,t.axis),k(3,0),k(4,0),k(5,0),X(M,!0))}},this.setLengthUnit=function(t){if(!e.equals(v,t)){v=Object.assign({},t),b=r.Length[v.unit].ratio;for(let e=0;e<3;e++)k(e,C[e].mksVal)}},this.setAngleUnit=function(t){if(!e.equals(h,t)){h=Object.assign({},t),f=r.Angle[h.unit].ratio;for(let e=3;e<6;e++)k(e,E.get(e-3))}}}})})),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATW3DRobot/CATW3DRobot",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CoreEvents/ModelEvents","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DUtils/CATW3DUtils","DS/CATW3DRobot/CATC3DRobotSnapPanel"],(function(e,t,n,i,o,a,r,l,s,u,c,d,m,p,g,v,h,b,f){"use strict";var y=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var n=e.externalPath[t];if(h.isPLMNode(n))break;if("AxisSystems"===n.name)return!0}return!1},M=function(e){var t=[];return o.get().forEach((function(n){var i=e.getMoveReferent(n.pathElement);i&&t.push({path:i})})),t},x=function(){o.get().forEach((function(e){i.isIn(e)||i.add(e)}))},w=function(){o.get().forEach((function(e){i.remove(e)}))},V=function(e,t){e.scalingNodeX.setVisibility(!1),e.scalingNodeY.setVisibility(!1),e.scalingNodeZ.setVisibility(!1);var n=!t||!t.hasOwnProperty("translate")||"boolean"!=typeof t.translate||t.translate;e.arrowX.setVisibility(n),e.arrowY.setVisibility(n),e.arrowZ.setVisibility(n),n=!t||!t.hasOwnProperty("rotate")||"boolean"!=typeof t.rotate||t.rotate,e.rotationArcXY.setVisibility(n),e.rotationArcXZ.setVisibility(n),e.rotationArcYZ.setVisibility(n),n=!t||!t.hasOwnProperty("translatePlane")||"boolean"!=typeof t.translatePlane||t.translatePlane,e.translationPlaneXY.setVisibility(n),e.translationPlaneXZ.setVisibility(n),e.translationPlaneYZ.setVisibility(n),n=!t||!t.hasOwnProperty("robotMove")||"boolean"!=typeof t.robotMove||t.robotMove,e.robotHandle.setVisibility(n)},P=e.extend({init:function(e){var P,C,D,R=e.context,E=R.getFrameWindow(),A=R.getViewer(),S=g.giveMoveManager({context:R}),T=p.getMoveReferentManager({context:R}),F=s.getConstraintsController({context:R}),L=E.getContextualUIManager(),N="",W=new m,k=this,O=0,B=new t.Vector3,I=function(e){var n={},i=null;if(e.translationVector)i=F.simulateMoveWithCst({translation:e.translationVector});else if(e.rotationMatrix){var o=[[e.rotationMatrix.elements[0],e.rotationMatrix.elements[4],e.rotationMatrix.elements[8]],[e.rotationMatrix.elements[1],e.rotationMatrix.elements[5],e.rotationMatrix.elements[9]],[e.rotationMatrix.elements[2],e.rotationMatrix.elements[6],e.rotationMatrix.elements[10]]];i=F.simulateMoveWithCst({rotation:o})}if(i&&i.matrix){var a=(new t.Matrix4).multiplyMatrices(i.matrix,e.objectMoved.path.getWorldMatrix());n.worldMatrix=a}return n},G=function(){var e=o.get();(e.length>1||F.count()>0&&1===e.length&&!F.isLevelConstrained(T.getMoveReferent(e[0].pathElement)))&&F.deleteAllCst()},_=!0,U={},X={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},Y={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3};if(E)if(R)if(S)if(T){A.setRobot(!0,{snapOnFace:!1,showOnlyManipulated:!1});var j=A.getRobot();V(j),j.setAddToCSO(!1),j.setAddToHSO(!1),j.setDisplayScalingNodes(!1),j.setMoveMode("CALLBACK_ONLY"),j.setCheckTarget(!1),j.CallBackEventHandlerViewPoint();var Z,H,q,z,K,J,Q,$,ee=[],te=[],ne=[],ie={},oe=null,ae=null,re=[],le=[],se={origin:new t.Vector3,initOrigin:new t.Vector3,direction:null,initValue:null,value:null},ue={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},ce=!1,de=null,me=function(){te.length||(te.push(S.subscribe("MoveBegin",(function(){K=j.getMatrix(),z=H?(new t.Matrix4).getInverse(H.getWorldMatrix()).multiply(K):null}))),te.push(S.subscribe("Move",function(e){if(z&&K){if(e.from===ie)return;if(Oe(),this.isVisible()&&this.setVisibility(!1),"Persistent"===e.moveMode){var t=H.getWorldMatrix().multiply(z);j.setMatrix(t)}}}.bind(this))),te.push(S.subscribe("MoveEnd",function(e){if(z&&K){if("Cancelled"===e.status&&j.setRobotMatrix(K),e.from===ie)return;if(this.setVisibility(!0),"Moved"===e.status){var t=H.getWorldMatrix().multiply(z);j.setRobotMatrix(t)}de={},z=K=void 0}}.bind(this))))}.bind(this),pe=function(){te.forEach((function(e){S.unsubscribe(e)})),te.length=0,$=null},ge=function(e){var t=null,n=R.getRootBagPath().getLastElement(!0);return e.some((function(e){return!!e.externalPath.some((function(e){return n===e}))&&(t=e,!0)})),t},ve=function(e,t){var n={pathElement:null},i=R.getRootBagPath().getLastElement(!0);if(i&&e&&e.externalPath&&e.externalPath.some((function(e){return i===e}))&&(n.pathElement=e),U.filterPath&&n.pathElement&&t&&t.event){var o=t.event.gesture?t.event.gesture.getEvents()[0]:t.event.from[0],a=A.pick(A.getMousePosition(o.getCurrentPosition(A.canvas)),"primHybrid",!0);(n=U.filterPath({pathElement:ge(a.path)}))&&(n.normal=a.normal)}if(n.pathElement&&!y(n.pathElement)&&!n.pathElement.internalPath.length)for(;!h.isPLMNode(n.pathElement.getLastElement(!0));)n.pathElement=n.pathElement.getParentPath();return n};j.setSnapFilterCallback((function(e){return ve(e).pathElement})),j.setSnapTranslationCallback((function(e){if(0!==M(T).length){if(J){var t=J.getSnappedTranslationVector(e);return 0!==t.returnCode?null:t.snappedTranslationVector}return e.translationVector}})),j.setSnapRotationCallback((function(e){if(0===M(T).length)return{};if(Q){var t=Q.getSnappedRotationValue(e);return 0!==t.returnCode?{value:void 0,axis:null}:{value:t.snappedRotationAngle,axis:t.axis}}var n=180*e.angle/Math.PI;return ue.direction.dot(e.axis)<0&&(n=360-n),{value:n,axis:e.axis}}));var he=function(){J&&(J.direction=null,J.origin=new t.Vector3,J.origin3DPos=null,J.setValue(0)),Q&&(Q.direction=null,Q.origin=null,Q.originVector=null,Q.setValue(0)),Oe()},be=new c("RobotLocalAxisSystem"),fe=new c("RobotPrevisuNode");fe.exludeFromBounding(!0),fe.setVisibilityFree(!0),fe.setVisibilityInTree(!1),fe.setPickable(l.PICKTHROUGH),fe.setNoZ(!0),A.addNode(fe),fe.updateDisplay=function(e,t,n){fe.removeChildren(),e&&e.equivalentGeometry&&e.equivalentGeometry.getPrevisuNode&&fe.addChild(e.equivalentGeometry.getPrevisuNode(t,n))};var ye=new r({headLength:10,arrowLength:50,arrowWidth:2,head:r.types.ARROW,colors:{colorX:new l.Color(1,0,0,0),colorY:new l.Color(0,1,0,0),colorZ:new l.Color(0,0,1,0)}});be.exludeFromBounding(!0),be.setVisibilityFree(!0),be.setVisibilityInTree(!1),be.setPickable(l.PICKTHROUGH),be.addChild(ye),be.updateDisplay=function(e){if(0===be.parents.length&&A.addNode(be),e.visibility&&e.pathElement&&0===e.pathElement.internalPath.length){if(U&&U.getFiltersState&&U.getFiltersState().surface){for(var t,n=e.pathElement.externalPath.length-1;n>=0&&!t;n--)h.isRepReference(e.pathElement.externalPath[n])&&(t=e.pathElement.externalPath[n]);if(t){var i=h.getNodeID(t);if(i&&!R.getController().hasMeshInRAM(i))return}}be.setMatrix(e.pathElement.getWorldMatrix()),be.setVisibility(!0)}e.visibility||be.setVisibility(!1)},be.updateDisplay({visibility:!1});var Me=null,xe=new n("RobotLocalAxisSystem",A,!1,!1);xe.exludeFromBounding(!0),xe.setVisibilityFree(!0),xe.setVisibilityInTree(!1),xe.setPickable(l.PICKTHROUGH),xe.setVisibility(!1),V(xe,{robotMove:!1,translate:!1}),xe.updateDisplay=function(e){var t,n,i,o;0===xe.parents.length&&A.addNode(xe),e.visibility&&e.pathElement&&(Me&&(clearInterval(Me),Me=null),xe.setMatrix(e.pathElement.getWorldMatrix()),t=xe.fixedSizeNode3D,n=Me,i=A,o=4,t.setRatio(o/10),n=setInterval((function(){if(11===o)return clearInterval(n),void(n=null);o++,t.setRatio(4*o/10),i.render()}),10),xe.setVisibility(!0),_&&j.setVisibility(!1)),e.visibility||(clearInterval(Me),Me=null,xe.setVisibility(!1),_&&j.setVisibility(!0))};var we,Ve,Pe,Ce,De,Re,Ee=function(){require(["DS/LevelSelector/LevelSelector"],(function(e){e.destroyView()})),L.hideContextualMenus()},Ae=function(){if(Ee(),H){let n=Boolean(R.getExecutionContext),i=[{name:"CATW3DRobotLevelSelectorStr",line:1,hdr_list:["CATW3DRobotLevelSelectorHdr"],type:"handler",identifier:"CATW3DRobotLevelSelectorHdr"}];if(M(T).some((function(e){var t=e.path.getMatrix();return 1!==t.elements[0]||1!==t.elements[5]||1!==t.elements[10]||1!==t.elements[15]||0!==t.elements[1]||0!==t.elements[2]||0!==t.elements[3]||0!==t.elements[4]||0!==t.elements[6]||0!==t.elements[7]||0!==t.elements[8]||0!==t.elements[9]||0!==t.elements[11]||0!==t.elements[12]||0!==t.elements[13]||0!==t.elements[14]}))&&i.push({name:"CATW3DSetIdentityPositionStr",line:1,hdr_list:["CATW3DSetIdentityPositionHdr"],type:"handler",identifier:"CATW3DSetIdentityPositionHdr"}),i.length>0)if(n)L._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:i}}},context:R.getCommandContext(),workbenchName:"CATW3DCommands",module:"CATW3DCommands",cmdPrefix:""}]});else{var e=A.currentViewpoint.project((new t.Vector3).getPositionFromMatrix(j.getMatrix()));L.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:i}},context:R.getCommandContext(),workbenchName:"CATW3DCommands",module:"CATW3DCommands",cmdPrefix:""}],x:e.x+45,y:e.y-45})}}},Se=function(){j.setToNonGhostState()},Te=function(e){var n,i,o;if(P&&P(e),"RulerManipulateBegin"===e.eventName||"AngularRulerManipulateBegin"===e.eventName){Ee(),w(),we=new t.Vector3,Ve=0;var a={objectsMoved:M(T),from:ie,moveMode:"Persistent"};"AngularRulerManipulateBegin"===e.eventName&&(de={},a.axis=(new t.Vector3).copy(e.direction),a.center=(new t.Vector3).getPositionFromMatrix(j.getMatrix())),S.onMoveBegin(a)}else if("RulerManipulate"===e.eventName){if(!(o=M(T)).length)return;G(),n={objectsMoved:o,from:ie},e.rulerDragged||x(),we.add(e.translationVector),j.setMatrix((new t.Matrix4).copy(K).setPosition((new t.Vector3).getPositionFromMatrix(K).add(we))),0===F.count()||0===n.objectsMoved.length?n.vector=we:(i=I({translationVector:e.translationVector,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),S.onMove(n),A.render()}else if("AngularRulerManipulate"===e.eventName){if(!(o=M(T)).length)return;G(),n={objectsMoved:o,from:ie},e.rulerDragged||x();var r=e.diffAngle*Math.PI/180;Ve+=r;var l=(new t.Matrix4).makeRotationAxis(e.direction,Ve).multiply((new t.Matrix4).extractRotation(K));j.setMatrix(l.setPosition((new t.Vector3).getPositionFromMatrix(K))),ue.value=Q.value;var s=(new t.Matrix4).makeRotationAxis(e.direction,r);0===F.count()||0===n.objectsMoved.length?n.angle=Ve:(i=I({rotationMatrix:s,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),S.onMove(n),A.render()}else if("RulerManipulateEnd"===e.eventName||"AngularRulerManipulateEnd"===e.eventName){x();var u={from:ie,status:"Moved"};"Cancelled"===e.status?u.status="Cancelled":j.setRobotMatrix(j.getMatrix()),S.onMoveEnd(u)}},Fe=function(e){if(W.publish({event:"onRobotMoveBegin"}),H){var n;A.setCursor("pointer"),Ee(),Oe(),O=0,B=new t.Vector3,N="",w(),n=e.manipulator,[j.arrowX,j.arrowY,j.arrowZ,j.translationPlaneYZ,j.translationPlaneXY,j.translationPlaneXZ,j.rotationArcYZ,j.rotationArcXZ,j.rotationArcXY].forEach((function(e){e&&e.manipulator&&e.manipulator!==n&&e.setToGhostState()})),j.robotHandle.setToGhostState();var i,o={objectsMoved:M(T),from:ie,moveMode:"Persistent"};if("LineTranslationBegin"===e.eventChannel){for(var a=0;a<e.manipulator.manipulatedPaths[0].externalPath.length;a++)if(e.manipulator.manipulatedPaths[0].externalPath[a].name.startsWith("arrow")){N=e.manipulator.manipulatedPaths[0].externalPath[a].name;break}i=(new t.Vector3).copy(e.manipulator.axis);var r=(new t.Vector3).getPositionFromMatrix(j.getMatrix()),l=(new t.Vector3).copy(i).multiplyScalar((new t.Vector3).copy(se.baseOrigin).sub(r).dot(i));se.initOrigin=(new t.Vector3).copy(r).add(l);var s=(new t.Vector3).copy(se.initOrigin),u=null;de&&"string"==typeof N&&(N.match("arrowX")&&de.X3Dpos?u=(new t.Vector3).copy(de.X3Dpos):N.match("arrowY")&&de.Y3Dpos?u=(new t.Vector3).copy(de.Y3Dpos):N.match("arrowZ")&&de.Z3Dpos&&(u=(new t.Vector3).copy(de.Z3Dpos)),u&&(s=new t.Line3(se.initOrigin,(new t.Vector3).copy(se.initOrigin).add(i)).closestPointToPoint(u,!1))),se.origin=s;var c=(new t.Vector3).copy(se.origin).sub(r).dot(i);se.direction=i,se.value=s.distanceTo(r)*(c>0?-1:1),se.initValue=se.value,J&&(J.origin=se.origin,J.origin3DPos=u,J.initOrigin=se.initOrigin,J.setValue(se.value),J.direction=se.direction,J.initValue=se.initValue,J.displayOrigin=!J.origin.equals(J.initOrigin),J.unit=X.unit,J.display(),J.beginManipulation())}else if("RotationBegin"===e.eventChannel){de={},o.center=(new t.Vector3).getPositionFromMatrix(j.getMatrix()),i=(new t.Vector3).copy(e.manipulator.axis);var d={Rulervalue:Q.value,Rulerdirection:i,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};if(C&&C(d),!ue.direction||0===Math.round(100*i.dot(ue.direction))||!function(){for(var e=new v(H.externalPath);e&&!h.isPLMNode(e.getLastElement(!0));)e=e.getParentPath();if(!ue.path)return ue.path=e,!0;var t=!!e&&e.isEqual(ue.path);return ue.path=e,t}()){var m=new t.Vector3,p=new t.Vector3,g=new t.Vector3;j.getMatrix().extractBasis(m,p,g),m.normalize(),p.normalize();var b=Math.round(100*m.dot(i)),f=Math.round(100*p.dot(i));0===b?ue.originVector=(new t.Vector3).copy(m):0===f&&(ue.originVector=(new t.Vector3).copy(p)),ue.value=0,ue.direction=i}o.axis=(new t.Vector3).copy(ue.direction),ue.origin=(new t.Vector3).getPositionFromMatrix(j.getMatrix()),ue.initValue=ue.value,Q&&(Q.originVector=ue.originVector,Q.setValue(ue.value),Q.origin=ue.origin,Q.direction=ue.direction,Q.initValue=ue.initValue,Q.unit=Y.unit,Q.display(),Q.beginManipulation())}S.onMoveBegin(o)}},Le=function(e){if(H){if(A.setCursor("pointer"),"LineTranslationManipulation"===e.eventChannel){if(se.value=se.initValue+e.translationVector.length()*(se.direction.dot(e.translationVector)>0?1:-1),J){var n={Rulervalue:se.value,Rulerdirection:se.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};C&&C(n),J.setValue(se.value)}}else if("RotationManipulation"===e.eventChannel){de={};var i=(new t.Vector3).copy(e.axis),o=ue.direction.dot(i)<0?2*Math.PI-e.angle:e.angle;if(ue.value=ue.initValue+180*o/Math.PI,Q.setValue(ue.value),Q){var a={Rulervalue:Q.value,Rulerdirection:ue.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};C&&C(a)}}G();var r,l={objectsMoved:M(T),from:ie};if(e.translationVector)0===F.count()||0===l.objectsMoved.length?l.vector=e.translationVector:(r=I({translationVector:(new t.Vector3).subVectors(e.translationVector,B),objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix),B=e.translationVector;else{if(0===F.count()||0===l.objectsMoved.length)l.angle=e.angle;else{var s=(new t.Matrix4).makeRotationAxis(e.axis,e.angle-O);(r=I({rotationMatrix:s,objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix)}O=e.angle}if("PlaneTranslationManipulation"===e.eventChannel){var u={vector:l.vector,Rulerchannel:"PlaneTranslationManipulation"};C&&C(u)}S.onMove(l),A.render()}},Ne=function(e){H&&(Ae(),x(),Se(),"LineTranslationEnd"===e.eventChannel?J&&(J.endManipulation(),J.display()):"RotationEnd"===e.eventChannel&&Q&&(Q.endManipulation(),Q.display()),S.onMoveEnd({from:ie,status:"Moved"}),W.publish({event:"onRobotMoveEnd"}))},We=!1,ke=function(e){_&&("@onViewpointBeginMove"===e.eventType?We=!0:"@onViewpointChange"===e.eventType?We&&(j.setVisibility(!1),A.render()):"@onViewpointEndMove"===e.eventType&&(j.setVisibility(!0),We=!1,A.render()))};require(["DS/CATWebUXComponents/DMUCommandsManager"],(function(e){e.onCommandStart((function(e){if(ee.length)if("CATW3DRobotLevelSelectorHdr"===e._id){if(L.hideContextualMenus(),q&&q.externalPath){(e.setRobotParams?e:e.cmdClass).setRobotParams({pathContext:q,pathCurrent:H,doNotModifyCSO:!0,selectCB:function(e){je({pathElement:e.pathElement})}})}}else"CATW3DSetIdentityPositionHdr"===e._id?(L.hideContextualMenus(),Be()):"CAT3DComposeWidgetDefaultHdr"===e._id||"CAT3DComposeMoveHdr"===e._id?(Z||(Z=u.subscribe({event:"/VISU/"},ke)),"CAT3DComposeWidgetDefaultHdr"===e._id&&Be()):"LevelSelectorHdr"===e._id||"HideShowHdr"===e._id||"CAT3DComposeMoveCmd"===e._id||("CAT3DComposeMoveHdr"===e._id&&R.getExecutionContext||"exclusive"===e._mode||R.getExecutionContext&&e._id.includes("measure"))&&Be()}),R.getCommandContext&&R.getCommandContext()?R.getCommandContext():void 0)})),this.setVisibility=function(e){if("boolean"==typeof e){e?(Z||(Z=u.subscribe({event:"/VISU/"},ke)),J&&J.setVisibleFlag(!0),Q&&Q.setVisibleFlag(!0)):Z&&(J&&J.setVisibleFlag(!1),Q&&Q.setVisibleFlag(!1),u.unsubscribe(Z),Z=void 0),_=e;var t=j.isVisible();return t&&e||!t&&!e||(j.setVisibility(e),A.render()),0}},this.isVisible=function(){return!!_&&j.isVisible()},this.setSelectionFilter=function(e){U=e&&e.filterPath?e:{}},this.setLengthUnit=function(e){X=Object.assign({},e),J&&J.getVisibleFlag()&&(J.unit=X.unit,J.display()),$&&$.setLengthUnit(X)},this.getLengthUnit=function(){return X},this.setAngleUnit=function(e){Y=Object.assign({},e),Q&&Q.getVisibleFlag()&&(Q.unit=Y.unit,Q.display()),$&&$.setAngleUnit(Y)},this.getAngleUnit=function(){return Y},this.rulerCB=function(e){P=e},this.manipCB=function(e){C=e},this._rulerformed=function(e){D=e},this.modifyTargetAndPosition=je,this.addCoordPanel=Ge,this.setValueToPanel=function(e){$&&(C&&C({vector:e,Rulerchannel:"PlaneTranslationManipulation"}),Q&&ue.direction&&(ue.direction=void 0,ue.value=0,Q.value=0,he(),$.resetTheRotation()))},this.hasTarget=function(){return Boolean(H)},this.subscribe=function(e,t){return"onRobotMoveBegin"===e||"onRobotMoveEnd"===e?W.subscribe({event:e},t):void 0},this.unsubscribe=function(e){return W.unsubscribe(e)},this.activate=function(){ee.length||(ee.push(j.subscribe("LineTranslationBegin",(function(e){Fe(e)}))),ee.push(j.subscribe("RotationBegin",(function(e){Fe(e)}))),ee.push(j.subscribe("ScalingBegin",(function(e){Fe(e)}))),ee.push(j.subscribe("PlaneTranslationBegin",(function(e){Fe(e)}))),ee.push(j.subscribe("LineTranslationManipulation",(function(e){Le(e)}))),ee.push(j.subscribe("RotationManipulation",(function(e){Le(e)}))),ee.push(j.subscribe("ScalingManipulation",(function(e){Le(e)}))),ee.push(j.subscribe("PlaneTranslationManipulation",(function(e){Le(e)}))),ee.push(j.subscribe("LineTranslationEnd",(function(e){Ne(e)}))),ee.push(j.subscribe("RotationEnd",(function(e){Ne(e)}))),ee.push(j.subscribe("ScalingEnd",(function(e){Ne(e)}))),ee.push(j.subscribe("PlaneTranslationEnd",(function(e){Ne(e)}))),ee.push(j.subscribe("ScreenPlaneTranslationBegin",(function(e){Xe()}))),ee.push(j.subscribe("ScreenPlaneTranslationManipulation",(function(e){Ye(e)}))),ee.push(j.subscribe("ScreenPlaneTranslationEnd",(function(e){!function(e){Re=!1,De&&De.cancel&&De.cancel(),De=null;var n=ve(e.target,e);if(H=n.pathElement,q=H,j.target=H,de={},Se(),Oe(),be.updateDisplay({visibility:!1}),xe.updateDisplay({visibility:!1}),H){var a=Ue(n,e.intersection.position);i.empty(),o.empty(),i.add(n),o.add({pathElement:n.pathElement,event:e.event,position:e&&e.intersection&&e.intersection.position,equivalentGeometry:n.equivalentGeometry}),se.origin=(new t.Vector3).getPositionFromMatrix(a),se.initOrigin=(new t.Vector3).getPositionFromMatrix(a),se.baseOrigin=(new t.Vector3).getPositionFromMatrix(a),J&&(J.initOrigin=se.initOrigin,J.origin=se.origin,de={})}he();let r=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),l=R.getController&&R.getController().hasAnyEffectiveFlexibleAssembly();require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration")&&r&&l||!H?(Q&&(ue={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),pe(),x(),e.target&&Be()):(me(),window.top.__C3D_ROBOTSNAP_PANELDISPLAY||("CATC3D_AP"===window.widget.data.appId||window.top.__C3D_ROBOTSNAP_PANELDISPLAYFORCE)&&Ge({immersiveFrame:E.getImmersiveFrame(),w3dRobot:k,robotP:e.intersection.position}),Ae()),fe.removeChildren(),W.publish({event:"onRobotMoveEnd"})}(e)})))),ne.length||(ne.push(R.subscribe({event:"onRootRemoved"},(function(e){Ie([e])}))),ne.push(R.subscribe({event:"onRootDetached"},(function(e){Ie([e])}))),ne.push(R.subscribe({event:"onHide"},(function(e){var t=[];e.paths.forEach((function(e){t.push({path:e})})),Ie(t)}))),ne.push(R.subscribe({event:"onBeginReparent"},(function(){Be()})))),Z=u.subscribe({event:"/VISU/"},ke)},this.deactivate=function(){ee.forEach((function(e){j.unsubscribe(e)})),ee.length=0,ne.forEach((function(e){R.unsubscribe(e)})),ne.length=0,pe(),u.unsubscribe(Z),Z=null},this.unreference=function(){this.deactivate(),A.setRobot(!1),A.removeNode(be),A.removeNode(xe),Oe(),re.forEach((function(e){J.unsubscribe(e)})),le.forEach((function(e){Q.unsubscribe(e)})),F&&F.unreference(),j=R=E=A=S=T=F=de=W=null,oe=ae=L=U=J=$=Q=be=xe=null}}else window.console.error("A move referent component must be defined");else window.console.error("A move manager component must be defined");else window.console.error("A context must be defined");else window.console.error("A frame window must be defined");function Oe(){J&&J.clear(),Q&&Q.clear()}function Be(){j.ScreenPlaneTranslationEndCB({intersection:{}})}function Ie(e){H&&Array.isArray(e)&&e.some((function(e){if(e.path&&e.path.externalPath.length>1&&e.path.isAParentOf(H)||e.id&&e.id===h.getNodeID(H.externalPath[1]))return Be(),!0}))}function Ge(e){$||(($=new f(e)).setLengthUnit(X),$.setAngleUnit(Y))}function _e(){J&&Q||ce||(ce=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],(function(e,n){E&&(J=new e(E,{displayOrigin:!1,offset:150,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1}),oe||(oe=J.subscribe("OriginManipulateBegin",(function(){Ce=null,Pe||(Pe=(new t.Vector3).copy(J.origin))})),re.push(oe)),ae||(ae=J.subscribe("OriginManipulateEnd",(function(){de||(de={}),N.match("arrowX")?de.X3Dpos=Ce?(new t.Vector3).copy(Ce):null:N.match("arrowY")?de.Y3Dpos=Ce?(new t.Vector3).copy(Ce):null:N.match("arrowZ")&&(de.Z3Dpos=Ce?(new t.Vector3).copy(Ce):null),D&&D({direction:N,cposition:Ce}),Ce=null,a.empty()})),re.push(ae)),J.onOriginManipulator=function(e){var n,i=null,o=Math.pow(10,6),r=A.pick(A.getMousePosition(e.event.from[0].getCurrentPosition(A.canvas)),U.filterPath?"primHybrid":"mesh",!1);if(0===r.path.length||!r.path[0])return J.displayOrigin=!1,Ce=null,Pe;if(n=U.filterPath?U.filterPath({pathElement:ge(r.path)}):{pathElement:ge(r.path)},a.empty(),!n||!n.pathElement)return h.isAModelPath(r.path[0])&&a.add({pathElement:r.path[0]}),J.displayOrigin=!1,Pe;if(void 0!==n&&n&&n.equivalentGeometry){var l=0;switch(n.equivalentGeometry.getType()){case d.GeometryType.POINT:i=n.equivalentGeometry.getPoint();break;case d.GeometryType.CYLINDER:case d.GeometryType.CONE:var s=n.equivalentGeometry.getEndPoints(),u=new t.Line3(s.beginPoint,s.endPoint);(l=Math.round(u.delta().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=u.center());break;case d.GeometryType.CIRCLE:(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=n.equivalentGeometry.getCenter());break;case d.GeometryType.PLANE:case d.GeometryType.REFPLANE:0!==(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)&&l!==Math.round(Math.PI*o)/o||(i=r.position);break;case d.GeometryType.SPHERE:i=n.equivalentGeometry.getCenter();break;case d.GeometryType.AXISSYSTEM:i=(new t.Vector3).getPositionFromMatrix(n.equivalentGeometry.getMatrix());break;default:i=null}}return i||(n.pathElement.internalPath.length=0,U.getFiltersState?U.getFiltersState().product&&(i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())):i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())),a.add(n),i?(J.displayOrigin=!0,Ce=(new t.Vector3).copy(i),i):(J.displayOrigin=!1,Ce=null,Pe)},J.setVisibilityFree(!0),re.push(J.subscribe("RulerManipulateBegin",(function(e){Te(e)}))),re.push(J.subscribe("RulerManipulate",(function(e){Te(e)}))),re.push(J.subscribe("RulerManipulateEnd",(function(e){Te(e)}))),(Q=new n(E,{radius:150,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0})).setVisibilityFree(!0),le.push(Q.subscribe("AngularRulerManipulateBegin",(function(e){Te(e)}))),le.push(Q.subscribe("AngularRulerManipulate",(function(e){Te(e)}))),le.push(Q.subscribe("AngularRulerManipulateEnd",(function(e){Te(e)}))))})))}function Ue(e,n){if(e&&e.pathElement){j.connect();var i=e.normal;delete e.normal;var o,a,r,l=e.pathElement.getWorldMatrix(),s=(new t.Vector3).copy(n);if(e.equivalentGeometry){var u,c=e.equivalentGeometry.getType();if(c===d.GeometryType.POINT)s=e.equivalentGeometry.getPoint();else if(c===d.GeometryType.LINE||c===d.GeometryType.CYLINDER||c===d.GeometryType.CONE){var m=e.equivalentGeometry.getEndPoints(),p=new t.Line3(m.beginPoint,m.endPoint);u=p.delta(),s=p.closestPointToPoint(s)}else c===d.GeometryType.CIRCLE?(u=e.equivalentGeometry.getNormal(),s=e.equivalentGeometry.getCenter()):c===d.GeometryType.PLANE||c===d.GeometryType.REFPLANE?u=e.equivalentGeometry.getNormal():c===d.GeometryType.SPHERE?s=e.equivalentGeometry.getCenter():c===d.GeometryType.SURFACE?u=i:c===d.GeometryType.AXISSYSTEM&&(s=null);u&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),u.normalize(),(new t.Vector3).crossVectors(o,u).length()<1e-9?(o.copy(a).projectOnPlane(u),o.normalize()):(o.projectOnPlane(u),o.normalize()),a.crossVectors(u,o),a.normalize(),l.makeBasis(o,a,u)),s&&l.setPosition(s),j.setRobotMatrix(l)}else U&&U.getFiltersState&&U.getFiltersState().surface?(i&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),i.normalize(),(new t.Vector3).crossVectors(o,i).length()<1e-9?(o.copy(a).projectOnPlane(i),o.normalize()):(o.projectOnPlane(i),o.normalize()),a.crossVectors(i,o),a.normalize(),l.makeBasis(o,a,i)),l.setPosition(s),j.setRobotMatrix(l)):j.setRobotMatrix(l.setPosition(s));return l}j.disconnect()}function Xe(){_e(),A.setCursor("pointer"),pe(),j.arrowX.mat.opacity=.2,j.arrowY.mat.opacity=.2,j.arrowZ.mat.opacity=.2,j.translationPlaneYZ.planeMat.opacity=.2,j.translationPlaneXY.planeMat.opacity=.2,j.translationPlaneXZ.planeMat.opacity=.2,j.rotationArcYZ.planeMat.opacity=.2,j.rotationArcXZ.planeMat.opacity=.2,j.rotationArcXY.privilegedPlaneMat.opacity=.2,Ee(),w()}function Ye(e){if(Re||(Re=!0,W.publish({event:"onRobotMoveBegin"})),De&&De.cancel&&De.cancel(),De=null,A.setCursor("pointer"),Oe(),e.intersection.path.length){var t=e.intersection.path[0],n=ve(t,e),i=n.pathElement;U.getFiltersState&&(De=b.switchToAV1withMesh({pathElement:t,pad3DViewer:R,selectionFilter:U.getFiltersState(),onComplete:function(){Ye(e),De=null},onFailure:function(){De=null}})),H&&i&&H.isEqual(i)||(H=i?i.clone():null,i?y(i)?(be.updateDisplay({visibility:!1}),xe.updateDisplay({pathElement:i,visibility:!0})):(be.updateDisplay({pathElement:i,visibility:!0}),xe.updateDisplay({visibility:!1})):(be.updateDisplay({visibility:!1}),xe.updateDisplay({visibility:!1}))),fe.updateDisplay(n,e.intersection.position,n.normal),Ue(n,e.intersection.position)}else Ue(),fe.updateDisplay(),be.updateDisplay({visibility:!1}),xe.updateDisplay({visibility:!1}),H=null}function je(e){H=ve(e.pathElement).pathElement,q||(q=H),_e(),H?j.connect():j.disconnect(),j.target=H;var n=j.getMatrix(),i=H.getWorldMatrix();i.setPosition(e.robotPosition||(new t.Vector3).getPositionFromMatrix(n)),se.origin=(new t.Vector3).getPositionFromMatrix(i),se.initOrigin=(new t.Vector3).getPositionFromMatrix(i),se.baseOrigin=(new t.Vector3).getPositionFromMatrix(i),J&&(J.initOrigin=se.initOrigin,J.origin=se.origin,de={}),Q&&(ue={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),j.setRobotMatrix(i),he(),me()}}}),C=[];return e.singleton({init:function(){},giveMove3DRobot:function(e){var t;return e&&e.context&&(t=null,C.some((function(n){return n.context===e.context&&(t=n.enveloppe)}))),t},getMove3DRobot:function(e){var t;if(e&&e.context&&(C.some((function(n){return n.context===e.context&&(t=n.enveloppe)})),!t)){var n=new P({context:e.context}),i=e.context.setRobotVisibility,o=e.context.isRobotVisible;n.activate();var a={unreference:function(){n&&(n.unreference(),n=null,C.some((function(e,t){if(e.enveloppe===a)return C.splice(t,1),e.context.setRobotVisibility=i,i=null,e.context.isRobotVisible=o,o=null,a=null,!0})))},setVisibility:function(e){return n?n.setVisibility(e):null},isVisible:function(){return n?n.isVisible():null},setSelectionFilter:function(e){return n?n.setSelectionFilter(e):null},setLengthUnit:function(e){return n?n.setLengthUnit(e):null},getLengthUnit:function(){return n?n.getLengthUnit():null},setAngleUnit:function(e){return n?n.setAngleUnit(e):null},getAngleUnit:function(){return n?n.getAngleUnit():null},hasTarget:function(e){return n?n.hasTarget(e):null},modifyTargetAndPosition:function(e){return n?n.modifyTargetAndPosition(e):null},addCoordPanel:function(e){return n?n.addCoordPanel(e):null},setValueToPanel:function(e){return n?n.setValueToPanel(e):null},subscribe:function(e,t){return n?n.subscribe(e,t):null},unsubscribe:function(e){return n?n.unsubscribe(e):null},rulerCB:function(e){return n?n.rulerCB(e):null},manipCB:function(e){return n?n.manipCB(e):null},_rulerformed:function(e){return n?n._rulerformed(e):null}};Object.freeze(a),e.context.setRobotVisibility=function(e){return a?a.setVisibility(e):null},e.context.isRobotVisible=function(){return a?a.isVisible():null},C.push({context:e.context,enveloppe:a}),t=a}return t}})}));