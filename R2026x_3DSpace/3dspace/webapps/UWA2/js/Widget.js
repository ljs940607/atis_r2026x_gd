define("UWA/Widget",["UWA/Core","UWA/String","UWA/Array","UWA/Class","UWA/Class/Options","UWA/Class/Timed","UWA/Class/Events","UWA/Class/Debug","UWA/Utils","UWA/Utils/Client","UWA/Data","UWA/Element"],(function(e,t,n,i,r,a,s,o,u,l,d,c){"use strict";function h(e){if(!Array.isArray(e))throw new Error(e+" should be an array");e.forEach((function(e){if("string"!=typeof e)throw new Error(e+" should be a string")}))}function f(e,t){if(e){if(e.multiple||"checklist"===e.type)try{t=function(e){if(!e)return[];var t;if(Array.isArray(e))t=e;else try{t=JSON.parse(e)}catch(t){throw new Error("While parsing JSON value `"+e+"`: "+t)}return h(t),t}(t)}catch(t){throw new Error("While decoding value for preference "+e.name+": "+t)}"boolean"===e.type&&"boolean"!=typeof t&&void 0!==t&&(t="false"!==t&&Boolean(t))}return t}var m,p,g=i.extend(r,a,s,o,{init:function(){var e=this,t=l.Locale;e.id=null,e.environment=null,e.launched=!1,e.title=null,e.icon=null,e.counter=0,e.counterType=null,e.metas={},e.preferences=[],e.defaultData=Object.create(null),e.data={},e.plugins=[],e.events={},e.menus=[],e.elements={},e.body=null,e.lang=t.lang,e.locale=t.locale,e.dir=t.dir,e.readOnly=!1,e.isEdit=!1},launch:function(e,t){var n=this;return n.launched=!1,void 0!==t&&(n.readOnly=Boolean(t)),n.initPreferences(),n.initPlugins(),n.setValues(e),n.dispatchEvent("onInitConfig",{metas:n.metas,plugins:n.plugins,preferences:n.getPreferences()}),n.dispatchEvent("beforeLoad"),n.addEventOnce("onLoad",(function(){n.launched=!0}),n,1),n.dispatchEvent("onLoad"),n.launched&&n.dispatchEvent("afterLoad"),n.launched},destroy:function(){var e,t=this,n=t.elements;for(e in t.clearDelayed(),t.clearPeriodical(),n)n.hasOwnProperty(e)&&n[e].destroy();t.removeEvent(),t.launched=!1},setOptions:function(n){var i,r,a=this;for(i in n)r="set"+t.capitalize(i),e.is(a[r],"function")&&a[r](n[i]);return a._parent(n)},setAutoRefresh:function(e){var t=this;(e=parseInt(e,10))&&e>0?t.setPeriodical("autoRefresh",t.dispatchEvent.bind(t,"onRefresh"),1e3*e*60):t.clearPeriodical("autoRefresh"),t.metas.autoRefresh=e},setCounter:function(t,n){var i=this;(i.counter!==t||e.is(n)&&i.counterType!==n)&&(i.counter=t,i.counterType=n,i.dispatchEvent("onUpdateCounter",[t,n]))},getTitle:function(){return e.is(this.title,"string")?t.stripTags(this.title):""},setTitle:function(t,n){var i=this;return(e.is(t,"string")||n&&i._titleUrl!==n)&&(i.title=t,i._titleUrl=n,i.dispatchEvent("onUpdateTitle",[t,n])),i.title},setIcon:function(t,n){var i=this;return t&&e.is(t,"string")&&(n&&(t=d.proxifyUrl(t,{proxy:"icon"})),i.icon!==t&&(i.icon=t,i.dispatchEvent("onUpdateIcon",[t]))),i.icon},setMenu:function(t){var n,i,r,a=this.environment,s=t.name.split("/"),o=s[0];if(s.length>2)throw new Error("Adding more than one submenu level is not supported by setMenu");(r=this.getMenu(t.name))?e.extend(r,t):(s.length>1?((n=this.getMenu(o))||(n={label:o},this.menus.push(n)),n.items||(n.items=[]),i=n.items):i=this.menus,i.push(t)),this.setDelayed("onUpdateMenu",(function(){a.dispatchEvent("onUpdateMenu",[this.menus])}),20)},getMenu:function(t){var i,r;return e.is(t,"string")&&(r=t.split("/"),(i=n.detect(this.menus,(function(e){return e.name===r[0]})))&&r.length>1&&(i=i.items&&n.detect(i.items,(function(e){return e.name===t})))),i},removeMenu:function(e){var t,n,i,r;for(r=function(t){return t.name!==e},t=0,n=this.menus.length;t<n;t++){if((i=this.menus[t]).name===e){this.menus.remove(i);break}i.items&&(i.items=i.items.filter(r))}},setDir:function(e){var t=this,n=t.dir,i=t.elements.wrapper;return e="rtl"===e?"rtl":"ltr",i&&n!==e&&(i.setAttribute("dir",e),i.addClassName(e),i.removeClassName(n)),t.dir=e,e},setMetas:function(t){var n=this;return e.extend(n.metas,t),e.is(t.debugMode)&&(n.setDebugMode(t.debugMode),n.environment&&n.environment.setDebugMode(t.debugMode)),e.is(t.autoRefresh)&&n.setAutoRefresh(t.autoRefresh),n.metas},setBody:function(e){if(!this.body)throw new Error("Widget.body is not yet available");this.body.setContent(e)},addBody:function(e){this.body.addContent(e)},getElements:function(e){return this.body.getElements(e)},getElement:function(e){return this.body.getElement(e)},createElement:function(t,n){return e.createElement(t,n)},setStyle:function(e){var t=this,n=t.id?"#m_"+t.id:".moduleWrapper";t.id&&t.elements.wrapper.setAttribute("id","m_"+t.id),u.setCss(!1,e,n,t.getUrl())},mutate:function(e,t){var n=this.environment;if(!e)throw new Error("Missing or empty first param on widget.mutate");if(!n||!n.mutate)throw new Error("Current Environment do not support widget.mutate");n.mutate(e,t)},getUrl:function(){var e=window.location.href;return this.uwaUrl?this.uwaUrl:u.getQueryString(e,"uwaUrl",e)},addStar:function(e){var t=this.environment;t&&t.addStar&&t.addStar(e)},getViewportDimensions:function(){var e,t,n=this.elements,i=n.body,r=c.getDimensions,a=c.isInjected,s=c.getComputedSize,o=l.getSize(),u=r.call(n.wrapper),d=r.call(i),h=o.height,f=u.width;["header","footer"].forEach((function(t){(e=n[t])&&a.call(e)&&(h-=r.call(e).outerHeight)})),e=i,t=n.wrapper.parentNode;do{e!==n.wrapper?f-=s.call(e,"innerWidth","outerWidth"):f-=s.call(e,"innerWidth"),h-=s.call(e,"innerHeight","outerHeight"),e=e.parentNode}while(e&&e!==t);return d.maxHeight>0&&h>d.maxHeight?h=d.maxHeight:d.minHeight>0&&h<d.minHeight&&(h=d.minHeight),{height:h<0?240+h:h,width:f<0?320+f:f}},setPlugins:function(e){this.plugins=e},initPlugins:function(){var t,n,i,r=e.clone(this.plugins);for(t=0,n=r.length;t<n;t++)i=r[t],e.Plugins[i.name]&&(i.instance=new e.Plugins[i.name](this,i.options))},initPreferences:function(){this.setPreferences(this.preferences)},hasPreferences:function(){var e=this.preferences;return!this.readOnly&&e.length>0&&e.some((function(e){return"hidden"!==e.type}))},_getRawPreference:function(e){return n.detect(this.preferences,(function(t){return t.name===e}))},getPreference:function(t){var n=this._getRawPreference(t);return n&&((n=e.clone(n)).value=this.getValue(t)),n},hasPreference:function(e){return this.preferences.some((function(t){return t.name===e}))},addPreference:(p=["hidden","text","list","checklist","range","password","boolean"],function(t){var n,i=-1,r=this,a=r.preferences;(function(e){return e.name&&e.type&&-1!==p.indexOf(e.type)})(t)&&(n=void 0!==(t=e.clone(t)).defaultValue,t.multiple&&"boolean"!=typeof t.multiple&&(t.multiple="true"===t.multiple),n&&(t.defaultValue=f(t,t.defaultValue)),a.forEach((function(e,n){t.name===e.name&&(i=n)})),t.label||(t.label=t.name),-1!==i?a[i]=t:a.push(t),r.defaultData[t.name]=t.defaultValue,r.launched&&r.dispatchEvent("onUpdatePreferences",[r.getPreferences()]))}),setPreferences:function(e){var t,n,i=this;for(i.preferences=[],i.defaultData={},i.launched&&0===e.length&&i.dispatchEvent("onUpdatePreferences",[i.getPreferences()]),t=0,n=e.length;t<n;t++)i.addPreference(e[t])},mergePreferences:function(e){var t,n;for(t=0,n=e.length;t<n;t++)this.hasPreference(e[t].name)||this.addPreference(e[t])},getPreferences:function(){var t,n,i,r,a,s,o=e.clone(this.preferences);for(t=0,n=o.length;t<n;t++)if((a=o[t]).value=this.getValue(a.name),a.label=e.i18n(a.label),e.is(a.options,"array"))for(i=0,r=a.options.length;i<r;i++)(s=a.options[i]).label=e.i18n(s.label);return o},getValue:function(t){var n=this,i=n.environment,r=n.data[t];return!e.is(r)&&i&&i.getData&&(r=f(n._getRawPreference(t),i.getData(t))),e.is(r)||(r=n.defaultData[t]),e.is(r)?n.data[t]=r:(r=void 0,delete n.data[t]),r},getInt:function(e){var t=this.getValue(e);return t="true"===t||!0===t?1:parseInt(t,10),isNaN(t)?0:t},getBool:(m=[1,"1","true",!0],function(e){return-1!==m.indexOf(this.getValue(e))}),setValue:function(t,n){var i=this,r=i.environment,a=i._getRawPreference(t),s=!0;return n=f(a,n),e.equals(i.data[t],n)||(e.is(n)?(n=e.clone(n),i.data[t]=n,r&&r.setData&&r.setData(t,function(e,t){return e&&(e.multiple||"checklist"===e.type)&&(h(t),t=JSON.stringify(t)),t}(a,n),!!a&&e.equals(a.defaultValue,n))):(i.data.hasOwnProperty(t)?delete i.data[t]:s=!1,r&&r.deleteData?r.deleteData(t):r&&r.setData&&r.setData(t,void 0)),s&&i.dispatchEvent("onUpdateValue",[t,n])),n},setValues:function(e){var t;for(t in e)e.hasOwnProperty(t)&&this.setValue(t,e[t])},deleteValue:function(e){return this.setValue(e)},toggleEdit:function(){this.dispatchEvent(this.isEdit?"endEdit":"onEdit")},dispatchEvent:function(e,t,n,i){var r=this,a=r.environment,s=!i&&a||"onLoad"===e||r.launched;return!i&&a?a.dispatchEvent(e,t,n):s&&r._parent(e,t,n),r},addEvent:function(e,t,n,i){var r=this,a="onLoad"===e&&r.launched;return r._parent(e,t,n,i),a&&(r.addEventOnce("_onLoadImmediate",t,n,i),this.setImmediate("_onLoadImmediate",(function(){r.dispatchEvent("_onLoadImmediate")}))),r},addEventOnce:function(e,t,n,i){var r=this;return"onLoad"===e&&r.launched?(r.addEventOnce("_onLoadImmediate",t,n,i),this.setImmediate("_onLoadImmediate",(function(){r.dispatchEvent("_onLoadImmediate")}))):r._parent(e,t,n,i),r},requestView:function(t){return e.is(t,"string")&&(t={type:t}),this.dispatchEvent("onViewRequest",[t]),this},getView:function(){return this._view||{type:"windowed"}},getAvailableViews:function(){var e=this.metas.availableViews||"";return n.invoke(e.split(";"),"trim").filter((function(e){return e})).map((function(e){var t,n=e.match(/\S*/)[0],i=e.slice(n.length).trim();if(i)try{t=JSON.parse(i)}catch(e){this.log("Failed to parse availableViews options")}return t||(t={}),t.type=n,t}),this)},onEdit:function(){this.isEdit=!0},endEdit:function(){this.isEdit=!1}});return e.namespace("Widget",g,e)}));