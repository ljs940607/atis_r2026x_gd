define("UWA/Class/Collection",["UWA/Core","UWA/Array","UWA/Utils","UWA/Class","UWA/Class/Debug","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Model"],(function(t,e,n,i,r,o,s,l){"use strict";var u,c,h,d;return u={add:!0,remove:!0,merge:!0},c={add:!0,remove:!1},h=function(e){return t.is(e,"function")?e:function(t){return t.get(e)}},d=i.extend(o,s,{init:function(e,n){t.is(n)||(n={}),n.url&&(this.url=n.url),n.model&&(this.model=n.model),void 0!==n.comparator&&(this.comparator=n.comparator),this._reset(),this._modelListener=function(t,e,n,i){return this._onModelEvent(t,e,n,i)},this.setup(e,n),e&&this.reset(e,t.extend({silent:!0},n))},clone:function(){return new this.constructor(this._models)},setup:function(){},sync:function(){return l.prototype.sync.apply(this,arguments)},parse:function(t){return t},model:l,add:function(e,n){return this.set(e,t.extend(t.extend({merge:!1},n),c))},push:function(e,n){return this.add(e,t.merge({at:this.length},n))},unshift:function(e,n){return this.add(e,t.merge({at:0},n))},remove:function(e,n){var i,r,o,s,l;for(t.is(n)||(n={}),o=0,s=(e=(l=!Array.isArray(e))?[e]:t.clone(e,!1)).length;o<s;o++)(r=e[o]=this.get(e[o]))&&(delete this._byId[r.id],delete this._byId[r.cid],i=this.indexOf(r),this._models.splice(i,1),this.length--,n.silent||(n.index=i,r.dispatchEvent("onRemove",[r,this,n])),this._removeReference(r));return l?e[0]:e},pop:function(t){var e;return e=this.at(this.length-1),this.remove(e,t),e},shift:function(t){var e;return e=this.at(0),this.remove(e,t),e},sort:function(e){if(t.is(e)||(e={}),!this.comparator)throw new Error("Cannot sort a collection without a comparator");return t.is(this.comparator,"string")||1===this.comparator.length?this._models=this.sortBy(this.comparator,this):this._models.sort(this.comparator.bind(this)),e.silent||this.dispatchEvent("onSort",[this,e]),this},set:function(e,n){var i,r,o,s,c,h,d,a,f,m,p,v,_,g,y,E,A,b,x,C,I,w,O=this;for((n=t.merge(t.merge({},n),u)).parse&&(e=O.parse(e,n)),e=(w=!Array.isArray(e))?e?[e]:[]:t.clone(e,!1),i=n.at,g=O.model,r=O.comparator&&!t.is(i)&&!1!==n.sort,o="string"===t.typeOf(O.comparator)?O.comparator:null,s=[],c=[],h={},d=n.add,a=n.merge,f=n.remove,m=!(r||!d||!f)&&[],p=0,v=e.length;p<v;p++){_=(E=e[p])instanceof l?y=E:E[g.prototype.idAttribute],(A=O.get(_))?(f&&(h[A.cid]=!0),a&&(E=E===y?y._attributes:E,n.parse&&(E=A.parse(E,n)),A.set(E,n),r&&!b&&A.hasChanged(o)&&(b=!0)),e[p]=A):d&&(y=e[p]=O._prepareModel(E,n))&&(e[p]=y,s.push(y),y.addEvent("onAnyEvent",O._modelListener,O),O._byId[y.cid]=y,t.is(y.id)&&(O._byId[y.id]=y));var U=A||y;if(m&&U){var W=m.indexOf(U);W>=0&&m.splice(W,1),m.push(A||y)}}if(f){for(p=0,v=O.length;p<v;++p)h[(y=O._models[p]).cid]||c.push(y);c.length&&O.remove(c,n)}if(s.length||m&&m.length)if(r&&(b=!0),O.length+=s.length,t.is(i))for(C=0,I=s.length;C<I;C++)O._models.splice(i+C,0,s[C]);else for(m&&(O._models.length=0),C=0,I=(x=m||s).length;C<I;C++)O._models.push(x[C]);if(b&&O.sort({silent:!0}),!n.silent){for(p=0,v=s.length;p<v;p++)(y=s[p]).dispatchEvent("onAdd",[y,O,n]);(b||m&&m.length)&&O.dispatchEvent("onSort",[O,n])}return w?e[0]:e},reset:function(e,n){var i,r,o,s;for(n=n?t.clone(n,!1):{},r=0,o=(s=this._models).length;r<o;r++)i=s[r],this._removeReference(i);return n.previousModels=this._models,this._reset(),e=this.add(e,t.extend({silent:!0},n)),n.silent||this.dispatchEvent("onReset",[this,n]),e},get:function(e){if(t.is(e))return this._byId[e.id]||this._byId[e.cid]||this._byId[e]},at:function(t){return this._models[t]},first:function(e,n){return t.is(e)&&!n?this._models.slice(0,e):this._models[0]},last:function(e,n){return t.is(e)&&!n?this._models.slice(Math.max(this._models.length-e,0)):this._models[this._models.length-1]},toArray:function(){return this.slice()},slice:function(t,e){return this._models.slice(t,e)},rest:function(e,n){return this._models.slice(!t.is(e)||n?1:e)},initial:function(e,n){return this._models.slice(0,this._models.length-(!t.is(e)||n?1:e))},without:function(){var t;return t=Array.prototype.concat.apply([],Array.prototype.slice.call(arguments)),this._models.filter((function(e){return-1===t.indexOf(e)}))},indexOf:function(t,e){return this._models.indexOf(t,e)},lastIndexOf:function(t,e){return this._models.lastIndexOf(t,e)},contains:function(t){return-1!==this.indexOf(t)},size:function(){return this._models.length},isEmpty:function(){return 0===this._models.length},toJSON:function(t){return this.map((function(e){return e.toJSON(t)}))},pluck:function(t){return this._models.map((function(e){return e.get(t)}))},shuffle:function(){var t,e;return e=[],this.forEach((function(i,r){t=n.random(r),e[r]=e[t],e[t]=i})),e},where:function(e,n){return t.is(e)?this[n?"find":"filter"]((function(t){var n;for(n in e)if(e[n]!==t.get(n))return!1;return!0})):n?void 0:[]},findWhere:function(t){return this.where(t,!0)},invoke:function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this._models),e.invoke.apply(null,t)},forEach:function(t,e){return this._models.forEach(t,e)},map:function(t,e){return this._models.map(t,e)},every:function(t,e){return this._models.every(t,e)},some:function(t,e){return this._models.some(t,e)},sortBy:function(t,e){var n,i;return n=h(t),(i=this._models.map((function(t,i,r){return{model:t,index:i,criteria:n.call(e,t,i,r)}}))).sort((function(t,e){var n,i;if((n=t.criteria)!==(i=e.criteria)){if(n>i||void 0===n)return 1;if(n<i||void 0===i)return-1}return t.index<e.index?-1:1})),i.map((function(t){return t.model}))},groupBy:function(e,n){var i,r,o=this._models;return i=h(e),r={},this.forEach((function(e,s){var l=i.call(n,e,s,o);t.owns(r,l)||(r[l]=[]),r[l].push(e)})),r},countBy:function(e,n){var i,r,o=this._models;return i=h(e),r={},this.forEach((function(e,s){var l=i.call(n,e,s,o);t.owns(r,l)||(r[l]=0),r[l]++})),r},find:function(t,e){var n;return this.some((function(i,r,o){if(t.call(e,i,r,o))return n=i,!0})),n},filter:function(t,e){return this._models.filter(t,e)},reject:function(t,e){return this.filter((function(e,n,i){return!t(e,n,i)}),e)},reduce:function(t,e,n){var i=t;return n&&(i=i.bind(n)),arguments.length>1?this._models.reduce(i,e):this._models.reduce(i)},reduceRight:function(t,e,n){var i=t;return n&&(i=i.bind(n)),arguments.length>1?this._models.reduceRight(i,e):this._models.reduceRight(i)},max:function(t,e){var n,i;if(t&&!this.isEmpty())return i=h(t),n={computed:-1/0,model:void 0},this.forEach((function(t,r,o){var s;if((s=i.call(e,t,r,o))>=n.computed)return n={model:t,computed:s}})),n.model},min:function(t,e){var n,i;if(t&&!this.isEmpty())return i=h(t),n={computed:1/0,model:void 0},this.forEach((function(t,r,o){var s;if((s=i.call(e,t,r,o))<n.computed)return n={model:t,computed:s}})),n.model},fetch:function(e){var n,i,r=this;return void 0===(e=e?t.clone(e,!1):{}).parse&&(e.parse=!0),n=e.onComplete,e.onComplete=function(t){var i;return i=e.reset?"reset":"set",r[i](t,e),n&&n(r,t,e),r.dispatchEvent("onSync",[r,t,e])},i=e.onFailure,e.onFailure=function(t){i&&i(r,t,e),r.dispatchEvent("onError",[r,t,e])},r.sync("read",r,e)},create:function(e,n){var i,r,o=this;return n=n?t.clone(n,!1):{},!!(i=o._prepareModel(e,n))&&(n.wait||o.add(i,n),r=n.onComplete,n.onComplete=function(t,e){if(n.wait&&o.add(t,n),r)return r(t,e,n)},i.save(null,n),i)},_reset:function(){return this.length=0,this._models=[],this._byId={},this._byId},_prepareModel:function(e,n){var i;return e instanceof l?(e.collection||(e.collection=this),e):((n=t.is(n)?t.clone(n,!1):{}).collection=this,(i=new this.model(e,n)).validationError?(this.dispatchEvent("onValidationFailure",[this,i.validationError,n]),!1):i)},_removeReference:function(t){return this===t.collection&&delete t.collection,t.removeEvent("onAnyEvent",this._modelListener,this)},_onModelEvent:function(e,n,i,r){if("onAdd"!==e&&"onRemove"!==e||i===this)return"onDestroy"===e&&this.remove(n,r),n&&e==="onChange:"+n.idAttribute&&(delete this._byId[n.previous(n.idAttribute)],t.is(n.id)&&(this._byId[n.id]=n)),this.dispatchEvent(e,[n,i,r])}}),t.namespace("Collection",d,i)}));