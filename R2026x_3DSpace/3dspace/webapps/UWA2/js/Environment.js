define("UWA/Environment",["UWA/Core","UWA/String","UWA/Array","UWA/Class","UWA/Class/Timed","UWA/Class/Events","UWA/Class/Debug","UWA/Class/Options","UWA/Utils","UWA/Element","UWA/Event","UWA/Json","UWA/Data","UWA/Internal/StringMap","UWA/Widget","UWA/Controls/Form","UWA/Controls/WidgetPopupMenu","UWA/Embedded","UWA/Promise","UWA/Utils/Client","UWA/Utils/Asset"],(function(e,t,n,i,o,s,r,a,c,l,d,u,h,f,p,v,m,g,w,E,y){"use strict";function b(t){var n=e.hosts.netvibes+"/subscribe.php",i={module:"UWA",moduleUrl:t.getUrl()};return t.getPreferences().forEach((function(e){i[e.name]=e.value})),n+"?"+c.toQueryString(i)}var W=Object.create(null),U=i.extend(o,s,r,a,{name:null,inited:!1,registered:!1,launched:!1,widget:null,html:null,features:{},views:{},menuClass:m,defaultOptions:{formOptions:{nativeInputs:!1},defaultView:{type:"windowed"},initialView:null},init:function(e){var t=this;t.setOptions(e),t.html={},t.view={},t.dispatchInit()},dispatchInit:function(){var e=this;e.setPeriodical("init",(function(){document.body&&!e.inited&&(e.clearPeriodical("init"),e.dispatchEvent("onInit"),e.inited=!0)}),100,!0)},hasFeature:function(t,n){var i,o=e.owns(this.features,t)&&this.features[t];if(!o)return!1;if(n)for(i in n)if(e.owns(n,i)&&(!e.owns(o,i)||n[i]!==o[i]))return!1;return!0},getWidget:function(){var e=this,t=e.widget||new p;return e.widget||e.registerWidget(t),t},registerWidget:function(t){var n=this;n.widget=t,n.setPeriodical("register",(function(){if(n.inited&&!n.registered){var i,o=n.html;for(i in n.clearPeriodical("register"),t.environment=n,o)o.hasOwnProperty(i)&&o[i]!==window&&(t.elements[i]=e.extendElement(o[i]));t.body=o.body,e.Widgets=e.Widgets||{},e.Widgets.instances=e.Widgets.instances||[],e.Widgets.instances.push(t),n.dispatchEvent("onRegisterWidget"),n.registerMenus(),n.registered=!0}}),100,!0)},launchWidget:function(e,t){var n=this;n.setPeriodical("launch",(function(){n.isDataReady()&&n.registered&&(n.clearPeriodical("launch"),n.getWidget().launch(e,t))}),100,!0)},destroy:function(){var t,n,i=this,o=i.html,s=i.widget;for(t in s&&(e.Widgets.instances.splice(e.Widgets.instances.indexOf(s),1),s.destroy(),i.widget=null),i.clearDelayed(),i.clearPeriodical(),o)o.hasOwnProperty(t)&&l.destroy.call(o[t]);for(n in i.view)i.view.hasOwnProperty(n)&&i.view[n]&&i.view[n].destroy();i.removeEvent(),i.registered=!1,i.launched=!1},onInit:function(){},onRegisterWidget:function(){var e=this,t=e.html,n=e.widget;e.data=new f,t.menus&&l.addEvent.call(t.menus,"click",(function(t){var n=d.getElement(t),i=e.widget.getMenu(n.getAttribute("data-name"));i&&(e.dispatchEvent("onMenuExecute",[i]),i.items&&(e.popupMenu||(e.popupMenu=new e.menuClass(e).inject(document.body)),e.popupMenu.setTarget(n).setItems(i.items).toggle()))})),t.editAction&&(l.show.call(t.editAction),l.addEvent.call(t.editAction,"click",(function(t){d.stop(t),e.dispatchEvent("toggleEdit")}))),t.refreshAction&&(l.show.call(t.refreshAction),l.addEvent.call(t.refreshAction,"click",(function(t){d.stop(t),e.dispatchEvent("onRefresh")}))),t.shareAction&&(t.shareAction.href=b(n),l.addEvent.call(t.shareAction,"click",(function(t){d.stop(t),e.dispatchEvent("onOpenURL",b(n))}))),t.wrapper&&l.handleExternalLinks.call(t.wrapper,(function(t,n){e.dispatchEvent("onOpenURL",[t,n])})),(t.viewport||t.wrapper)&&l.addEvent.call(t.viewport||t.wrapper,"resize",(function(){e.dispatchEvent("onResize")})),l.addEvent.call(document,"keydown",(function(t){var n=t.which||t.keyCode;e.dispatchEvent("onKeyboardAction",[n,t])})),t.body&&[E.Engine.name,E.Engine.name+E.Engine.version,E.Platform.name,E.Features.touchEvents?"touch":"no-touch",n.readOnly&&"readonly",e.name&&"environment-"+e.name].forEach((function(e){e&&l.addClassName.call(t.body,e)})),e.dispatchEvent("onResize"),e.dispatchEvent("onViewRequest",[e.options.initialView])},registerMenus:function(){var t=this.getWidget();t.setMenu({name:"options",icon:"options"}),t.readOnly||t.setMenu({name:"options/preferences",icon:"cogwheel",label:e.i18n("Settings"),onExecute:"toggleEdit"}),t.setMenu({name:"options/refresh",icon:"refresh",label:e.i18n("Refresh"),onExecute:"onRefresh"})},onUpdateMenu:function(n){var i=this.html;i.menus&&(n||(n=this.widget.menus),i.menus.empty(),n.forEach((function(n){var o;!1!==(e.is(n.visible,"function")?n.visible():!1!==n.visible)&&(o=e.createElement("span",{class:"uwa-widget-menu-button","data-name":n.name}),n.help&&(o.set("title",n.help),o.set("uwa-tooltip",t.escapeHTML(n.help))),n.icon&&o.addClassName("uwa-icon "+n.icon),n.className&&o.addClassName(n.className),o.inject(i.menus),i.header&&i.header.set("data-menus-items",i.menus.childNodes.length))})))},onMenuExecute:function(t){e.is(t.onExecute,"string")&&this.widget.dispatchEvent(t.onExecute,[t])},isDataReady:function(){return!e.Storage||e.Storage.allInstancesReady()},getAllData:function(){return this.data.getAll()},getData:function(e){return this.log("getData:"+e),this.data.get(e)},setData:function(e,t){return this.log("setData:"+e+","+t),this.data.set(e,t)},deleteData:function(e){return this.log("deleteData:"+e),this.data.remove(e)},dispatchEvent:function(e,t,n,i){this.log("environment.event:"+e);var o=this,s=o.widget;!i&&s&&o.addEventOnce(e,s.dispatchEvent.bind(s,e,t,n,!0)),o._parent(e,t,n)},loadWidget:function(t,n){return n=e.extend({onFailure:function(e){throw e},onTimeout:function(e){throw e},onComplete:function(){}},n),t=c.buildUrl(window.location.toString(),t),n.embedded?this.loadEmbeddedWidget(t,n):this.loadInlinedWidget(t,n),this},loadInlinedWidget:function(){var t,i={};function o(e,t,o){i[e]&&(n.invoke(i[e],t,o),delete i[e])}return t=function(t,s){var r=s.expositionError||s.error||s.errors;if(!r||e.is(r,"array")&&0===r.length){(s=this.convertSourceToJson(s)).className||(s.checksum||(s.checksum=c.getCRC32(t)),s.className="w-"+s.checksum),s.style&&(c.setCss(s.className,s.style,"."+s.className,t),delete s.style),"string"==typeof s.script&&(s.script=new Function("widget",s.script)),s.styles=this.filterExternalResources("style",s.styles||[]),s.scripts=this.filterExternalResources("script",s.scripts||[]);for(var a=[];s.styles.length;)a.push(y.css(c.buildUrl(t,s.styles.shift())));for(;s.scripts.length;)a.push(y.js(c.buildUrl(t,s.scripts.shift())));w.all(a).done((function(){var o=i[t];i[t]=s,e.is(o,"array")&&n.invoke(o,"onComplete",s)}),(function(e){o(t,"onFailure",e)}))}else o(t,"onFailure",r)},function(n,s){var r=i[n],a=s.fetcher||"XML",c=s.onComplete,l=this;return s.onComplete=function(e){var t=l.getWidget();t.uwaUrl=n,t.setTitle(e.title),t.setIcon(e.icon),t.setMetas(e.metas),t.setPreferences(e.preferences),t.setPlugins(e.plugins),t.setBody(e.body),l.html.wrapper.addClassName(e.className),e.script&&e.script(t),c(t,l)},e.is(r,"object")?s.onComplete(r):(e.is(r,"array")?r.push(s):i[n]=[s],s=e.merge({onComplete:t.bind(this,n),onTimeout:o.bind(this,n,"onTimeout"),onFailure:o.bind(this,n,"onFailure")},s),e.is(a,"function")?a.call(this,n,s):!e.is(a,"string")||a.length>4?s.onComplete(a):"JSON"===(a=a.toUpperCase())?this.fetchJsonWidget(n,s):this.fetchXmlWidget(n,s)),this}}(),loadEmbeddedWidget:function(t,n){var i,o,s=this,r=l.setStyle,a={cache:n.cache,container:s.html.body,displayHeader:!1,displayFooter:!1,displayEdit:!0,autoLaunch:!1};return e.is(n.embedded,"object")&&e.extend(a,n.embedded),i=new g(t,a),r.call(s.html.body,"padding",0),r.call(i.elements.body,"padding",0),s.addEvent("onRegisterWidget",(function(){var e={},t={onUpdateValue:!0,onRefresh:!0,onUpdateTitle:!0,onUpdateIcon:!0,onUpdateCounter:!0,onSearch:!0,onResetSearch:!0,onShowEdit:!0,onKeyboardAction:!0,onViewError:!0,onViewChange:!0,onEdit:!0,endEdit:!0,onLoad:function(){i.launch(s.getAllData(),s.getWidget().readOnly)}};Object.keys(t).forEach((function(n){var o=t[n];!0===o&&(o=i.sendRemote.bind(i,n)),e[n]=o})),s.addEvents(e)})),o=s.getWidget(),i.addEvent("onRegisterWidget",(function(){var t={},r={onRefresh:!0,onUpdateTitle:!0,onUpdateIcon:!0,onUpdateCounter:!0,onSearch:!0,onResetSearch:!0,onHideEdit:!0,onShowEdit:!0,onOpenURL:!0,onViewRequest:!0,onInitConfig:function(e){e.preferences&&o.setPreferences(e.preferences),e.plugins&&o.setPlugins(e.plugins),e.metas&&o.setMetas(e.metas)},onUpdatePreferences:function(e){o.setPreferences(e)},onUpdateValue:function(e,t){o.setValue(e,t)}};a.displayEdit||e.merge(r,{onEdit:!0,endEdit:!0}),Object.keys(r).forEach((function(e){var n=r[e];!0===n&&(n=function(){o.dispatchEvent(e,arguments)}),t[e]=n})),i.addEvents(t),n.onComplete(o,s)})),s.embedded=i,s},convertSourceToJson:function(){var t=["name","defaultValue","type","label","step","min","max"],n=["label","value"],i=/(java|ecma)script$/i;function o(e,t,n){var i,o,s,r=[].slice.call(e.childNodes);for(i=0,o=r.length;i<o;i++)s=r[i],n&&1!==s.nodeType||t(s,s.nodeValue)}function s(e,t){var n,i,o,s=e.attributes||[];for(n=0,i=s.length;n<i;n++)t((o=s[n]).name,o.value)}var r={"widget:preferences":function(e,i){o(i,(function(i){var r,a={};s(i,(function(e,n){-1!==t.indexOf(e)&&(a[e]=n)})),a.name&&("list"!==a.type&&"checklist"!==a.type||(r=[],o(i,(function(e){var t={};s(e,(function(e,i){-1!==n.indexOf(e)&&(t[e]=i)})),t.label&&r.push(t)}),!0),a.options=r),e.preferences.push(a))}),!0)},"widget:plugins":function(e,t){o(t,(function(n){var i={name:t.getAttribute("name"),options:{}};s(n,(function(e,t){i[e]=t})),o(n,(function(e){var t=e.getAttribute("name"),n=e.getAttribute("value");"widget:options"===e.tagName?(i.options[t]={},o(e,(function(e){var n=e.getAttribute("name"),o=e.getAttribute("value");n&&(i.options[t][n]=o)}),!0)):t&&(i.options[t]=n)}),!0),i.name&&e.plugins.push(i)}))},link:function(e,t,n){if(n.href){var i=n.rel;"icon"===i?e.icon=n.href:"stylesheet"!==i||n.href.contains("UWA/assets")||n.href.contains("standalone.css")||n.href.contains("uwa/style.css")||e.styles.push(n.href)}},meta:function(e,t,n){var i=n.content;i="false"!==i&&("true"===i||i),e.metas[n.name]=i},script:function(e,t,n){if(n.src||(n.language||n.type)&&!i.test(n.type)&&!n.language){if(!n.src||n.src.contains("Standalone")||n.src.contains("load.js.php"))return t;e.scripts.push(n.src)}else{var s="";o(t,(function(e,t){s+=t})),/UWA(\s+)?=/.test(s)||(e.script+=s)}},title:function(e,t){o(t,(function(t,n){e.title+=n}))},style:function(e,t){o(t,(function(t,n){e.style+=n}))},fallback:function(e,t,n,i){var r;return"body"===i?((r=document.createElement("div")).className=t.className,e.body=r):r=document.createElement(i),s(t,(function(e,t){r.setAttribute(e,t)})),o(t,(function(t,n){switch(t.nodeType){case 1:var i=a(t,e);i&&r.appendChild(i);break;case 4:case 3:r.appendChild(document.createTextNode(n))}})),r}};function a(e,t){9===e.nodeType&&(e=e.childNodes[0]);var n=e.nodeName.toLowerCase(),i={};return s(e,(function(e,t){i[e]=t})),r[r.hasOwnProperty(n)?n:"fallback"](t,e,i,n)}return function(t){if(e.is(t,"string"))try{t=c.loadXml(t)}catch(n){e.log("Invalid UWA XHTML source detected, fallback on HTML parsor."),t=c.loadHtml(t)}var n;return e.is(t,"object")?n=t:a(t,n={title:"",icon:"",preferences:[],plugins:[],metas:{},body:[],script:"",scripts:[],style:"",styles:[]}),n}}(),fetchJsonWidget:function(t,n){t in W||(W[t]=new w((function(i,o){var s,r={mode:"full",uwaUrl:t};e.debug&&(r.flush=1,r.mode="full_debug"),s=(n.server||e.hosts.exposition)+"/widget/json",u.request(s,{data:r,onComplete:i,onFailure:o,useJsonpRequest:!0,callback:t})}))),W[t].then(n.onComplete,n.onError)},fetchXmlWidget:function(e,t){h.request(e,{cache:t.cache,type:"text",onFailure:t.onFailure,onTimeout:t.onTimeout,onComplete:t.onComplete})},filterExternalResources:function(e,t){return t},onRefresh:function(){var e=this.getWidget();e.data={},e.hasEvent("onRefresh")||e.dispatchEvent("onLoad",void 0,void 0,!0)},onUpdateIcon:function(t){var n=this.html;function i(){n.iconLoader.destroy(),delete n.iconLoader}n.icon&&(n.iconLoader&&i(),n.iconLoader=e.createElement("img",{styles:{display:"none"},events:{load:function(){n.icon.getElement("img").setAttribute("src",t),i()},error:function(){i()}}}).inject(this.html.wrapper),n.iconLoader.setAttribute("src",t))},onUpdateTitle:function(e){var t=this.html.title;t&&t.setHTML(e)},onUpdateCounter:function(e){var t=this.html.counter;t&&t.setText(e?"("+(!0===e?"â—":e)+")":"")},onEdit:function(){var t=this,n=t.html,i=t.getWidget(),o=i.metas,s=i.getPreferences();if(n.edit){if(n.edit.empty(),i.hasPreferences()){if(n.preferences){var r=n.preferences.getFormValues();s.forEach((function(t){e.is(r[t.name])&&(t.value=r[t.name])}))}s.push({type:"submit",name:"endEdit",value:e.i18n("Done")}),n.preferences&&n.preferences.destroy(),n.preferences=new v({nativeInputs:this.options.formOptions.nativeInputs,darkBackground:this.options.formOptions.darkBackground,fields:s,events:{onChange:function(e,n,o){i.setValue(n,o),t.embedded?t.embedded.sendRemote("dispatchEvent",e,n,o):t.dispatchEvent(e,[n,o])},onSubmit:function(e,n){var o=!1;t.addEventOnce("onUpdateValue",(function(){o=!0})),Object.keys(n).forEach((function(e){i.setValue(e,n[e])})),t.dispatchEvent("endEdit"),o&&t.dispatchEvent("onRefresh")}}}).inject(n.edit)}o.author&&n.edit.addContent({tag:"div",class:"moduleInfos",html:[{tag:"p",html:[e.i18n("Widget by")+" ",{tag:"strong",html:o.website?{tag:"a",href:o.website,text:o.author}:{tag:"span",text:o.author}}]}]})}t.dispatchEvent("onShowEdit")},onShowEdit:function(){var e=this.html;e.wrapper&&e.wrapper.addClassName("onEdit")},endEdit:function(){this.dispatchEvent("onHideEdit")},onHideEdit:function(){var e=this.html;e.wrapper&&e.wrapper.removeClassName("onEdit")},onCloseEdit:function(){this.html.preferences.destroy(),this.html.preferences=null},onOpenURL:function(n){if(n=c.parseUrl(n),!window.open(n.source,"_blank"))return window.alert(t.format(e.i18n('Unable to open "{0}", Please turn off your popup blocker and try again.'),t.truncate(n.source,50))),!1},onViewRequest:function(){function t(e,t,n){n&&(t.error=n),e.dispatchEvent(n?"onViewError":"onViewChange",[t])}function n(e,t,n){e[t]&&e[t].destroy(),e[t]=n}function i(e,o){var s=e.views[o.type],r=s&&new s(e,o);return r&&r.addEvents({onEnter:function(){e.view.next===this&&(n(e.view,"current",this),this.isSingle()&&(U._currentSingleView=this),e.view.next=null,t(e,this.event))},onLeave:function(){e.view.current===this&&(U._currentSingleView===this&&(U._currentSingleView=null),e.view.next||(e.view.next=i(e,e.options.defaultView)),e.view.next.enter())},onError:function(i){e.view.next===this&&(n(e.view,"next"),e.view.current.enter()),t(e,this.event,i)}})}return function(o){var s,r=this;o||(o=r.options.defaultView),o=e.clone(o),r.view.current&&r.view.current.event&&(o.previous=e.clone(r.view.current.event),delete o.previous.previous),r.view.current&&r.view.current.matchEvent(o)?t(r,o,"This view is already active."):(s=i(r,o))?s.isSingle()&&U._currentSingleView&&U._currentSingleView!==r.view.current?(t(r,o,"An environment is already in single view."),s.destroy()):(n(r.view,"next",s),r.view.current?r.view.current.leave():r.view.next.enter()):t(r,o,'No implementation available for the view "'+o.type+'".')}}(),onViewChange:function(e){this.getWidget()._view=e},onViewError:function(e){this.log("View error: "+u.encode(e))}});return U.AbstractView=i.extend(s,{event:null,environment:null,init:function(e,t){this.environment=e,this.event=t},destroy:function(){this.removeEvents(),U._currentSingleView===this&&(U._currentSingleView=null)},enter:function(){this.dispatchEvent("onEnter")},leave:function(){this.dispatchEvent("onLeave")},isSingle:function(){return!1},matchEvent:function(e){return this.event.type===e.type},onEnter:function(){var e=this.environment.html;e.wrapper&&e.body&&n.invoke([e.wrapper,e.body],"addClassName",this.event.type+"-view")},onLeave:function(){var e=this.environment.html;e.wrapper&&e.body&&n.invoke([e.wrapper,e.body],"removeClassName",this.event.type+"-view")}}),U.prototype.views.windowed=U.AbstractView.extend({}),E.Features.fullscreen&&(U.prototype.views.fullscreen=U.AbstractView.extend({enter:function(){var e,t=this,n=t.getTarget();e={fullscreenchange:function(){document.fullscreenElement===n?t.dispatchEvent("onEnter"):(t.dispatchEvent("onLeave"),l.removeEvents.call(document,e))},fullscreenerror:function(){t.dispatchEvent("onError",["Error while trying to set the fullscreen"]),l.removeEvents.call(document,e)}},l.addEvents.call(document,e),n.requestFullscreen()},leave:function(){document.fullscreenElement===this.getTarget()?document.exitFullscreen():this.dispatchEvent("onLeave")},isSingle:function(){return!0},getTarget:function(){var e=this.environment.html;return e.content||e.body}})),e.namespace("Environment",U,e)}));