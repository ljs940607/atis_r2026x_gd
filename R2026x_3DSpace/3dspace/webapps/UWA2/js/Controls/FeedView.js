define("UWA/Controls/FeedView",["UWA/Core","UWA/Class","UWA/Event","UWA/String","UWA/Controls/Abstract","UWA/Controls/Ellipsis","UWA/Controls/Scroller","UWA/Controls/Pager"],(function(e,t,i,s,n,o,r,a){"use strict";var l=n.extend({defaultOptions:{nbItems:10,showDate:!0,messages:{noItem:"There is no news in this feed.",loadMore:"Load more news.",websiteLink:"Go to website",readMore:"Read more"},images:{loader:e.hosts.uwa+e.paths.css+"base/img/loader.gif",image:e.hosts.uwa+e.paths.css+"base/img/article.png"},scroller:{lockDirection:!0,momentum:!0,bounce:!0},pager:{type:0,showMoreLink:!0}},pagerPosition:"bottom",scrollPosition:"top",itemPerPage:0,init:function(e){this._parent(e),this.itemsEllipsis=[],this.itemsImages={loaded:[],loading:[],waiting:[],maxLoading:2},this.buildSkeleton()},buildSkeleton:function(){var t=this,i=t.pagerPosition;return t.container=e.createElement("div",{class:"uwa-feedview content uwa-feedview-"+t.viewName.replace(/ /g," uwa-feedview-"),events:{resize:this.dispatchAsEventListener("onResize"),mousedown:this.dispatchAsEventListener("onMouseDown")}}),this.buildItems(),t.buildScroller(),i&&(-1!==["top","both"].indexOf(i)&&t.buildPager("top"),-1!==["bottom","both"].indexOf(i)&&t.buildPager("bottom")),t.container},buildItems:function(){var t=this,i=t.options.messages,s=t.elements;return s.item=[],s.items=e.createElement("div",{class:"items"}),s.itemsActions=e.createElement("div",{class:"actions",html:[{tag:"div",class:"loadMore action",html:{tag:"a",href:"#",text:e.i18n(i.loadMore)},styles:{display:"none"}},{tag:"div",class:"noItem action",text:e.i18n(i.noItem),styles:{display:"none"}},{tag:"div",class:"websiteLink action",html:{tag:"a",href:"#",text:e.i18n(i.websiteLink)},styles:{display:"none"}}]}).inject(s.items),s.items.inject(t.container),s.items},buildScroller:function(){var t=this,i=t.elements,s=e.merge({events:{onRefresh:function(){t.refreshPager(),t.loadItemsImages()},onScrollEnd:function(){t.loadItemsImages()}}},t.options.scroller);i.scrollarea=e.createElement("div",{class:"scrollarea"}).grab(i.items).inject(t.container,"top"),t.scroller=new r(t.elements.items,s)},setScrollerHeight:function(e){this.pager&&(e-=this.pager.getContent().getDimensions().outerHeight),this.elements.top&&(e-=this.elements.top.getDimensions().outerHeight),this.elements.scrollarea?this.elements.scrollarea.setStyle("height",e+"px"):this.container.setStyle("height",e+"px"),this.refreshScroller()},refreshScroller:function(){var e=this.scroller;e&&e.dispatchEvent("onRefresh")},buildPager:function(t){var i=this,s=e.merge({_root:!1,events:{onOffsetChange:function(e){var t=i.options.source.getItems();i.showItem(t[e])}}},i.options.pager);i.pager=new a(s),i.pager.inject(i.container,t)},refreshPager:function(){var e,t,i,s=this,n=s.pager,o=s.options.source;n&&(e=o.getItems(),i=s.getItemsPerPage(),t=e.indexOf(s.currentItem),n.options.moreLink=o.getLink(),n.setLength(e.length),n.setLimit(i),n.setOffset(-1===t?0:t),n.dispatchEvent("onRefresh"))},getItemsPerPage:function(){var e,t,i=this,s=0,n=i.elements.item;for(e=0,t=n.length;e<t;e++)i.scroller.isInViewport(n[e])&&s++;return i.itemPerPage=s,i.itemPerPage},buildItem:function(t){var i,n=this.options,o=n.source.isItemRead(t),r=!(!n.showDate||!t.date)&&s.parseRelativeTime(t.date.toString());return i=e.createElement("div",{class:"item "+(o?"read":"unread"),html:{tag:"div",class:"content",html:{tag:"div",class:"infos",html:[{tag:"div",class:"title",html:[{tag:"a",class:"link ellipsis",href:t.link,html:s.stripTags(t.title)},{tag:"div",class:"separator"}]},r&&{tag:"div",class:"date",html:[{tag:"span",html:r},{tag:"div",class:"separator"}]}]}},events:{click:this.dispatchAsEventListener("onItemClick",t)}}),this.addEllipsis({reference:i.getElement(".content"),element:i.getElement(".ellipsis")}),i.setData("href",t.link),i.setData("item-index",t.index),i},getItem:function(e){var t=e.index,i=this.elements.item;return i[t]||(i[t]=this.buildItem(e)),i[t]},getItems:function(e){return e.map(this.getItem,this)},refreshItems:function(){var e=this.options.source.getItems();this.injectItems(e)},injectItems:function(e){var t=this,i=t.getItems(e),s=i.length,n=t.elements,o=t.options,r=o.source,a=r.getItems().length,l=r.hasMore(n.items.length);n.itemsActions.getElement(".loadMore").toggle(l),n.itemsActions.getElement(".noItem").toggle(!a),(i=i.splice(0,o.nbItems)).push(n.itemsActions),i.forEach((function(e,t){0===t?e.addClassName("first"):t===s-1&&e.addClassName("last"),e.addClassName(t%2==0?"odd":"even")})),n.items.addContent(i),!t.currentItem&&e[0]&&t.showItem(e[0])},showItem:function(e){var t=this,i=t.currentItem,s=t.options.source;i!==e&&(i&&t.getItem(i).removeClassName("active"),t.getItem(e).removeClassName("unread").addClassName("read").addClassName("active"),s.setItemRead(e),t.currentItem=e,t.scroller&&t.scroller.scrollToElement(t.getItem(e),t.scrollPosition))},loadMore:function(e){var t=this.options,i=t.source.getLoaded();e=e||t.nbItems,this.injectItems(i.splice(this.elements.items.length,e))},destroy:function(){this.container&&this.container.destroy()},addEllipsis:function(e){this.itemsEllipsis.push(e)},loadEllipsis:function(){var e,t,i,s=this.itemsEllipsis;for(e=0,t=s.length;e<t;e++)(i=s[e]).ellipsis||(i.ellipsis=new o(i.element,{_root:!1,reference:i.element.getParent()}));this.refreshEllipsis()},refreshEllipsis:function(){var e,t,i,s=this.itemsEllipsis;for(e=0,t=s.length;e<t;e++)(i=s[e]).ellipsis&&i.ellipsis.dispatchEvent("onRefresh")},resizeItemImage:function(e){var t,i,s,n,o,r=e&&e.getElement("img");(e=r&&r.getParent())&&e.offsetWidth>0&&e.isInjected()&&(t={width:"auto",height:"auto",marginTop:0,marginLeft:0},r.setStyles(t),i={width:r.offsetWidth,height:r.offsetHeight},o=(s={width:e.offsetWidth,height:e.offsetHeight}).width/s.height,n=i.width/i.height,this.options.images.loader===r.src&&(s.width>i.width||s.height>i.height)?(t.marginLeft=s.width/2-i.width/2+"px",t.marginTop=s.height/2-i.height/2+"px"):o<n?(t.height="100%",t.marginLeft=-(s.height*n-s.width)/2+"px"):(t.width="100%",t.marginTop=-(s.width/n-s.height)/2+"px"),r.setStyles(t))},buildItemImage:function(t,i){var n=this,o=n.options.images,r=o[i],a=t[i]||r,l=e.createElement("img"),m=e.createElement("div",{class:"image",html:{tag:"a",title:s.stripTags(t.title),href:t.link,html:l}}),h=n.resizeItemImage.bind(n,m);return this.addItemImage({item:t,container:m,src:a,onLoad:function(){l.setAttribute("src",a),h()},onError:function(){l.setAttribute("src",r),h()},onLoading:function(){l.setAttribute("src",o.loader),h()}}),m},addItemImage:function(e){this.itemsImages.waiting.push(e)},loadItemsImages:function(){var e,t,i,s=this,n=[],o=s.itemsImages;for(e=0,t=o.waiting.length;e<t;e++)((i=o.waiting[e]).item===s.currentItem||s.scroller.isInViewport(i.container,!0))&&n.push(i);for(e=0,t=n.length;e<t;e++)s.loadItemImage(n[e])},loadItemImage:function(t){var i,s=this,n=s.itemsImages,o=function(){var e,i,o,r,a=[];if(-1!==(o=n.loading.indexOf(t))&&n.loading.splice(o,1),-1===(o=n.loaded.indexOf(t))){for(n.loaded.push(t),e=0,i=n.waiting.length;e<i;e++)r=n.waiting[e],t.src===r.src&&(a.push(r),n.loaded.push(r));for(e=0,i=a.length;e<i;e++)s.loadItemImage(a[e])}};-1!==(i=n.waiting.indexOf(t))&&n.waiting.splice(i,1),-1!==n.loaded.indexOf(t)?(t.onLoad(),o()):(t.onLoading(),n.loading.push(t),e.createElement("img",{styles:{display:"none"},events:{load:function(){t.onLoad(),this.destroy(),o()},error:function(){t.onError(),this.destroy(),o()}}}).inject(document.body).setAttribute("src",t.src))},onPostInject:function(){this.refreshItems()},onResize:function(){this.itemPerPage=0,this.refreshScroller()},onItemClick:function(e,t){t&&this.showItem(t)&&i.stop(e),this.refreshPager()},onMouseDown:function(e){i.preventDefault(e)}});return l.Full=l.extend({buildItem:function(t){var i,n=this._parent(t),o=n.getElement(".content");return i=e.createElement("div",{class:"description ellipsis",html:{tag:"div",html:s.stripTags(t.content)}}).inject(o),this.addEllipsis({reference:i,element:i.getElement("div")}),this.buildItemImage(t,"image").inject(n,"top"),n}}),l.Presentable=l.Full.extend({presentedItem:null,buildSkeleton:function(){return this._parent().grab(this.buildItemTop(),"top")},buildItemTop:function(){return this.elements.top=e.createElement("div",{class:"top",html:{tag:"div",class:"actions",html:{tag:"div",class:"readMore action",html:{tag:"a",text:e.i18n(this.options.messages.readMore)}}}}),this.elements.top},showItem:function(e){var t,i=this.elements.top;if(this._parent(e),!this.presentedItem||this.presentedItem.getData("item-index")!==e.index)return this.presentedItem&&this.presentedItem.remove(),(t=this.buildItem(e)).inject(i,"top"),i.getElement(".readMore").getElement("a").setAttribute("href",e.link),this.presentedItem=t,this.loadItemsImages(),!0}}),l.Adapter={},l.Adapter.Abstract=t.extend({init:function(e){this.object=e},hasMore:function(){return!1},isItemRead:function(){return!1},setItemRead:function(){return!1},getItems:function(){return[]},getLink:function(){return null}}),l.Adapter.Feed=l.Adapter.Abstract.extend({getItems:function(){return this.object.getItems()},isItemRead:function(e){return this.object.isItemRead(e.index)},setItemRead:function(e){return this.object.setItemRead(e.index)},getLink:function(){return this.object.getLink()}}),e.namespace("Controls/FeedView",l,e,!0)}));