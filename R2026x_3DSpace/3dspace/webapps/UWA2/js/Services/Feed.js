define("UWA/Services/Feed",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils","UWA/Json","UWA/Data","UWA/Internal/StringMap"],(function(e,t,n,i,r,s,a){"use strict";var l,o=t.extend(n,{id:null,timeOffset:null,lastFetchedDate:null,error:null,defaultOptions:{id:0,timeOffset:0,readOnly:!0,bufferItemMaxLen:30,itemLinkFilters:[],itemEnclosureFilters:[(l=/feedads|icon|button|addthis|feed|feedburner/,function(e){return!l.test(e)})]},init:function(e){this.data={dir:"ltr",flags:{read:0,unread:0},items:[]},this.setOptions(e)},setOptions:function(e){var t=this;return t._parent(e),e=t.options,t.id=e.id,t.timeOffset=e.timeOffset,e.error?t.setError(e.error):e.data&&(t.setData(e.data),delete e.data),t},setError:function(e){return this.error=e,this},getError:function(){return this.error},isReadOnly:function(){return!0===this.options.readOnly},setLastFetchedDate:function(e){return this.lastFetchedDate=parseInt(e,10),this},getLastFetchedDate:function(){return parseInt(this.lastFetchedDate,10)},setData:function(t,n){n=n||{};var r,s=this,a=t.server_time||Math.round(Date.now()/1e3),l=t.items,o=this.getItemsLength();return delete t.items,n.last_update?(s.addItems(l,"before"),s.setLastFetchedDate(a)):n.published_before?s.addItems(l,"after"):(e.extend(s.data,t,!0),this.addItems(l),this.setLastFetchedDate(a),t.url&&(this.ownerURL=t.url,this.feedSiteUrlDomain=i.parseUrl(t.url).domain)),r={data:e.clone(this.data),addedItem:o-this.data.length},n.callback&&(n.onComplete=n.callback,delete n.callback),e.is(n.onComplete,"function")&&n.onComplete(r),r},addItems:function(e,t){if(Array.isArray(e)&&e.length>0){var n,i,r,s=this.getItems();if("before"===t){for(n=e.length-1;n>=0;n--)r=this.preProcessItem(e[n]),s.unshift(r);this.setItemsIndexes()}else if("after"===t){for(n=0,i=e.length;n<i;n++)r=this.preProcessItem(e[n]),s.push(r);this.setItemsIndexes()}else{for(n=0,i=e.length;n<i;n++)r=this.preProcessItem(e[n]),s.push(r);this.sortItemsByDate()}}},sortItemsByDate:function(e){this.getItems().sort((function(t,n){var i=new Date(t.date).getTime(),r=new Date(n.date).getTime();return"asc"===e?i-r:r-i})),this.setItemsIndexes()},setItemsIndexes:function(){var e,t=this.getItemsLength();for(e=0;e<t;e++)this.getItem(e).index=e},preProcessItem:function(e){return e.__preProcessed||(e.content=e.content||"",e.title=e.title||"",e.flags=e.flags||{},this.preProcessItemEnclosures(e),this.applyItemLinkFilters(e),this.applyItemEnclosureFilters(e),e.__preProcessed=!0),e},preProcessItemEnclosures:function(){function e(e,t,n){var i,r,s,a,l=[],o=e.getElementsByTagName(t);for(i=0,r=o.length;i<r;i++)a=o[i],(s=o[i].getAttribute(n))&&("img"===t&&(!a.height||a.height>1)&&(!a.width||a.width>1)||"a"===t&&a.href&&a.href.indexOf("#")>1)&&l.push(s);return l}return function(t){var n,r,s,a,l,o,d,u,h=/\.(jpeg|gif|jpg|bmp|png)$/i,c=/\.(m4a|ogg|mp3|acc)$/i,m=/\.(flv|mp4|h264|avi|mpeg|mpg)$/i,f=this.options,g=this.getUrl(),p=t.enclosures,I=f.itemEnclosureFilters,v=[],y={image:[],video:[],audio:[]};for(Array.isArray(p)&&p.forEach((function(e){var t=e.url,n=e.type;t&&(n&&/^image\/(jpeg|gif|jpg|bmp|png)$/.test(n)||h.test(t)?y.image.push(t):n&&/^audio\/mpeg$/.test(n)||c.test(t)?y.audio.push(t):(n&&/^video/.test(n)||m.test(t))&&y.video.push(t))})),l=i.loadHtml(t.content),n=0,r=(v=(v=v.concat(e(l,"img","src"))).concat(e(l,"a","href"))).length;n<r;n++)o=v[n],!t.image&&h.test(o)?y.image.push(o):!t.audio&&c.test(o)?y.audio.push(o):!t.video&&m.test(o)&&y.video.push(o);for(d in t.image&&t.video||(v=t.content.match(/http:\/\/www.youtube.com\/v\/([\w|\-]+)/))&&v.length>0&&(t.video=v[0],t.image="https://i2.ytimg.com/vi/"+v[1]+"/hqdefault.jpg"),y)for(n=0,r=(v=y[d]).length;n<r;n++){if(o=v[n],u=!0,Array.isArray(I))for(s=0,a=I.length;s<a&&u;s++)u=(0,I[s])(o,t);u&&(t[d]=i.buildUrl(g,o))}return t.thumbnail=t.image,t.watchable=Boolean(t.video),t}}(),addItemLinkFilter:function(t){var n=this.options;e.is(n.itemLinkFilters,"array")||(n.itemLinkFilters=[]),e.is(t,"function")&&n.itemLinkFilters.push(t)},applyItemLinkFilters:function(t){var n,i,r,s=this.options.itemLinkFilters;if(Array.isArray(s)&&!t.__linksFiltered){for(i=0,r=s.length;i<r;i++)n=s[i],e.is(n,"function")&&t.link&&(t.link=n(t.link,t,this));t.__linksFiltered=!0}},addItemEnclosureFilter:function(t){var n=this.options;e.is(n.itemEnclosureFilters,"array")||(n.itemEnclosureFilters=[]),e.is(t,"function")&&n.itemEnclosureFilters.push(t)},applyItemEnclosureFilters:function(t){var n,i,r,s,a,l,o=this.options.itemEnclosureFilters,d=["image","audio","video"];if(Array.isArray(o)&&!t.__enclosuresFiltered){for(n=0,i=o.length;n<i;n++)if(l=o[n],e.is(l,"function"))for(r=0,s=d.length;r<s;r++)t[a=d[r]]&&!l(t[a],t)&&delete t[a];t.__enclosuresFiltered=!0}},getTitle:function(){return this.data.title},getDir:function(){return this.data.dir},getUrl:function(){return this.data.url},getLink:function(){return this.data.link},getType:function(){return this.data.type},getItems:function(){return this.data.items},getItem:function(e){return this.getItems()[e]},getItemByGuid:function(e){return this.getItemByProperty("guid",e)},getItemByProperty:function(e,t){var n,i,r=this.getItemsLength();for(i=0;n<r&&(n=this.getItem(i))[e]!==t;i++);return n},getLastItemId:function(){var e=this.getItem(this.getItemsLength()-1);return e&&e.id},getItemsLength:function(){return this.data.items.length},getUnread:function(e){e=e||{};var t,n,i,r,s=0,a=0,l=this.data,o=this.infos,d=this.getItemsLength();if(o&&d>0&&(r=(i=l.flags)&&i.read?i.read:0,a=o.item_count-r,e.onlyNFirst)){for(e.onlyNFirst=e.onlyNFirst<=d?e.onlyNFirst:d,t=0,n=e.onlyNFirst;t<n;t++)this.isItemRead(t)||s++;a=s}return a>=0?a:0},isItemRead:function(e){var t=this.getItem(e);return Boolean(t&&t.flags&&t.flags.read)},setItemRead:function(e,t){this.isItemRead(e)||(this.data.flags.read++,this.setItemsFlag({indexes:[e],flag:"read",value:Math.ceil(Date.now()/1e3),save:t}))},setItemUnread:function(e,t){this.isItemRead(e)&&(this.data.flags.read--,this.setItemsFlag({indexes:[e],flag:"read",value:!1,save:t}))},setAllItemsRead:function(e){var t,n,i=this,r=i.getItemsLength();for(t=0;t<r;t++)i.setItemRead(t,!1),n.push(t);i.setItemsFlag({indexes:n,flag:"read",value:Math.ceil(Date.now()/1e3),save:e})},setAllItemsUnread:function(e){var t,n=this,i=n.getItemsLength(),r=[];for(t=0;t<i;t++)n.setItemRead(t,!1),r.push(t);n.setItemsFlag({indexes:r,flag:"read",value:!1,save:e})},setItemsFlag:function(e){var t,n,i,r=this,s=[],a=!r.isReadOnly()&&(e.save||!0);for(e.index&&(e.indexes=[e.index]),t=0,n=e.indexes.length;t<n;t++)i=r.getItem(t),s.push(i.id),e.value&&!1!==e.value?i.flags[e.flag]=e.value:delete i.flags[e.flag];a&&o.Adapter.Netvibes.feedApiRequest({readState:e.value&&!1!==e.value?"add":"remove",feedIds:r.id,feedItemIds:s})}});return o.Utils={adapterName:s.allowCrossOriginRequest?"Ajax":"Proxy",load:function(e,t){return t=t||this.adapterName,(e=e||{}).callback&&(e.onComplete=e.callback,delete e.callback),o.Adapter.Cache.load(e,t)},getIdFromUrl:function(e){return Math.abs(parseInt(i.getCRC32(e),10)).toString(36)},cleanFeedUrl:function(t){return t.contains("flvProxy.php")?t=i.getQueryString(t,"url"):t.contains("commeaucinemaProxy.php")?t="http://www.commeaucinema.com/rssfile.php?feed=netvibes_"+i.getQueryString(t,"id"):/^feed:\/\/(.*)/.test(t)&&(t=t.replace("feed:",""),/^http(s)?:\/\/(.*)/.test(t)||(t="http://"+t)),/^http(s)?:\/\/(.*)/.test(t)||(t=e.hosts.netvibes+t),t}},o.Adapter={Cache:{load:function(t,n){var i,r,s,a,l={},d=t.urls||[],u=[];for(i=0,r=d.length;i<r;i++)s=o.Utils.cleanFeedUrl(d[i]),(a=this.getFromCache(s))?l[s]=new o(a):u.push(s);u.length>0?(t.urls=u,o.Adapter[n].load(t,l)):e.is(t.onComplete,"function")&&t.onComplete(l)},getCache:function(){return this.data||(this.data=new a),this.data},storeInCache:function(e,t){return this.getCache().set(e,t)},getFromCache:function(e){return this.getCache().get(e)}},Proxy:{load:function(t,n){var i,r,a=0,l=t.urls||[];function d(i,r){var s={url:i,readOnly:!0,data:{title:r.title,dir:r.dir,url:r.url,link:r.link,type:r.type,items:r.items}};n[i]=new o(s),o.Adapter.Cache.storeInCache(i,s),a++,l.length===a&&e.is(t.onComplete,"function")&&t.onComplete(n)}function u(i,r){n[i]=new o({url:i,readOnly:!0,error:r}),a++,l.length===a&&e.is(t.onComplete,"function")&&t.onComplete(n)}for(n=n||{},i=0,r=l.length;i<r;i++){var h=o.Utils.cleanFeedUrl(l[i]);s.request(h,{proxy:"feed",type:"json",onComplete:d.bind(null,h),onFailure:u.bind(null,h)})}}},Ajax:{load:function(){function t(e){var t,n,i,r;if(Array.isArray(e.link))for(i=e.link[0].href||e.link[0],n=0,t=e.link.length;n<t;n++)(r=e.link[n]).rel&&-1!==["self","alternate"].indexOf(r.rel)&&(i=r.href);else i=e.link.href||e.link;return i}function n(t){var n=t.toString?t.toString():t;return e.is(n)&&n.length>0?n:""}function a(e){return new Date(Date.parse(e)).toGMTString()}return function(l,d){d=d||{};var u,h,c=0,m=l.urls||[];function f(s,u){var h,f=function(s,l){var o,d,u,h,c={dir:"ltr",url:l,items:[]};if((s=r.xmlToJson(s)).feed)for(e.extend(c,{title:n(s.feed.title),link:t(s.feed)}),u=0,h=(o=i.splat(s.feed.entry)).length;u<h;u++)d=o[u],c.items[u]={id:u,title:n(d.title),link:t(d),content:n(d.content),date:a(d.updated)},d["media:thumbnail"]&&d["media:thumbnail"].url&&(c.items[u].image=d["media:thumbnail"].url);else if(s["rdf:RDF"])for(s.rdf=s["rdf:RDF"],e.extend(c,{title:n(s.rdf.channel.title),link:t(s.rdf.channel)}),u=0,h=(o=i.splat(s.rss.channel.item)).length;u<h;u++)d=o[u],c.items[u]={id:u,title:n(d.title),link:t(d),content:n(d.description),date:a(d["dc:date"])},d["media:content"]&&d["media:content"].url&&(c.items[u].image=d["media:content"].url);else{if(!s.rss)throw new Error("Unable to Parse Feed using Ajax Adapter.");for(e.extend(c,{title:n(s.rss.channel.title),link:t(s.rss.channel)}),u=0,h=(o=i.splat(s.rss.channel.item)).length;u<h;u++)d=o[u],c.items[u]={id:u,title:n(d.title),link:t(d),content:n(d["content:encoded"]||d.description),date:a(d.pubDate)},"string"!=typeof c.items[u].content&&(c.items[u].content=""),d.enclosure&&(c.items[u].enclosures=[d.enclosure]),d["media:thumbnail"]&&d["media:thumbnail"].url&&(c.items[u].image=n(d["media:thumbnail"].url))}return c}(u,s);h=new o({url:s,readOnly:!0,data:f}),d[s]=new o(h),o.Adapter.Cache.storeInCache(s,h),c++,m.length===c&&e.is(l.onComplete,"function")&&l.onComplete(d)}function g(t,n){d[t]=new o({url:t,readOnly:!0,error:n}),c++,m.length===c&&e.is(l.onComplete,"function")&&l.onComplete(d)}for(u=0,h=m.length;u<h;u++){var p=o.Utils.cleanFeedUrl(m[u]);s.request(p,{method:"GET",onComplete:f.bind(null,p),onFailure:g.bind(null,p)})}}}()},Netvibes:{load:function(){}}},e.namespace("Services/Feed",o,e)}));