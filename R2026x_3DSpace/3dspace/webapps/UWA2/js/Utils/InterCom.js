define("UWA/Utils/InterCom",["UWA/Core","UWA/String","UWA/Utils","UWA/Class","UWA/Dispatcher","UWA/Class/Events","UWA/Class/Options","UWA/Class/Timed","UWA/Class/Debug","UWA/Json"],(function(e,t,n,r,s,i,o,a,c,u){"use strict";function d(e,t){var n,r,s,i;for(n=0,r=e.length;n<r;n++)for(s=0,i=t.length;s<i;s++)if(t[s]===e[n])return!0;return!1}function v(e){return Boolean(e.UWA&&e.UWA.Utils&&e.UWA.Utils.InterCom)&&!e.UWA.Utils.InterCom._listener&&(e.UWA.Utils.InterCom._listener=new i),e.UWA.Utils.InterCom._listener}var l,g="subscribe",h="unSubscribe",p=e.getGlobal();return(l={getAdapter:function(e){var t,r,s,i=l.Adapters,o=e?n.splat(e):Object.keys(i);for(t=0,r=o.length;t<r&&!s;t++){if(e=o[t],!i.hasOwnProperty(e))throw new Error('Unable to get InterCom Adapter with name "'+e+'"');if(i[e].isAvailable(s)){s=i[e];break}}if(!s)throw new Error("Unable to get InterCom Adapter");return s}}).Adapters={PostMessage:function(){var e,r="uwa-intercom";function i(t){var n;try{n="string"==typeof t.data&&"{"===t.data[0]&&JSON.parse(t.data)}catch(e){}n&&n.type===r&&e.dispatch([n.payload,{origin:t.origin,source:t.source}])}return{isAvailable:function(){return p.postMessage&&p.location&&p.location.protocol&&t.contains(p.location.protocol,"http")},removeListener:function(t){e&&(e.remove(t),0===e.getNumListeners()&&(e.dispose(),e=void 0,p.addEventListener?p.removeEventListener("message",i,!1):p.attachEvent&&p.detachEvent("onmessage",i)))},addListener:function(t){e||(e=e||new s,p.addEventListener?p.addEventListener("message",i,!1):p.attachEvent&&p.attachEvent("onmessage",i)),e.add(t)},dispatchEvent:function(e,t,s){var i;if(t||(t=(i=p.parent).postMessage?i:i.document.postMessage?i.document:void 0),s=s&&"*"!==s?n.buildUrl(p.location,s):"*",t&&t.postMessage){var o={type:r,payload:e};t.postMessage(JSON.stringify(o),s)}}}}(),FrameCallback:function(){var e,t=0,r=[],s=!0,i=p.document;function o(){s&&i.body&&r.length>0&&i.body.appendChild(r.shift()),r.length>0&&setTimeout(o,10)}return{isAvailable:function(){return e=v(p),Boolean(e)},removeListener:function(t){e.removeEvent("message",t)},addListener:function(t){e.addEvent("message",t)},dispatchEvent:function(e,a,c){!function(e){try{return e===p||e.location.host===p.location.host&&e.location.protocol===p.location.protocol}catch(e){}}(a)?function(e,a,c){var d,v,l=p.location.toString(),g=n.parseUrl(c),h=g.protocol+"://"+g.domain+"/intercom.html",f={info:e,origin:l};d="#"+Date.now()+t+++"&"+u.encode(f),(v=i.createElement("iframe")).setAttribute("src",h+d),v.style.position="absolute",v.style.top="-2000px",v.style.left="0px",v.onload=function(){s=!0,v.parentNode.removeChild(v)},r.push(v),setTimeout(o,10)}(e,0,c):function(e,t){var n=v(t);setTimeout((function(){n.dispatchEvent("message",[e,{origin:p.location.toString(),source:p}])}))}(e,a)}}}()},l.Server=r.extend(o,c,{id:null,uuid:null,sockets:null,listeners:null,defaultOptions:{adapter:null,autoconnect:!0},init:function(e,t){var n=this;n.setServerId(e),n.sockets={},n.listeners=new i,n.setOptions(t),n.options.autoconnect&&n.connect()},setServerId:function(e){var t=this,r=l.Server.Instances=l.Server.Instances||{};return t.uuid=t.uuid||n.getUUID(),r[e=e||t.uuid]&&(r[e].disconnect(),delete r[e]),t.id=e,r[e]=t,t},connect:function(){var e=this;return e.handleEvent=e.handleEvent.bind(e),e.adapter=l.getAdapter(e.options.adapter),e.adapter.addListener(e.handleEvent),e},disconnect:function(){var e=this;return e.adapter&&(Object.keys(e.sockets).forEach((function(t){e.unsubscribeSocket(t)})),e.adapter.removeListener(e.handleEvent)),e},handleEvent:function(e,t){var n,r,s,i=this,o=i.id,a=i.sockets,c=Object.keys(a);r=(n=t&&t.source&&t.origin&&e.event&&e.target&&e.origin&&e.target.servers&&Array.isArray(e.target.servers)&&e.target.sockets&&Array.isArray(e.target.sockets))&&a[e.origin.socket]&&a[e.origin.socket].uuid===e.uuid,s=n&&0===e.target.sockets.length&&-1!==e.target.servers.indexOf(o),n?s?(i.log('SERVER: server "'+o+'" accept message for event "'+e.event+'"'),e.event===g?r||i.subscribeSocket(e.origin.socket,t.source,t.origin,e.uuid):r&&(e.event===h?i.unsubscribeSocket(e.origin.socket):i.dispatchEvent(e.event,e.data,e.origin.socket,e.target.sockets))):r&&d(e.target.sockets,c)&&d([e.origin.socket],c)?(i.log('SERVER PREDISPATCH: server "'+o+'" dispatch event "'+e.event+'" from "'+e.origin.socket+'"'),i.dispatchEvent(e.event,e.data,e.origin.socket,e.target.sockets)):i.log('SERVER: server "'+o+'" refuse message for event "'+e.event+'"'):i.log('SERVER: server "'+o+'" refuse invalid message for event "'+e.event+'"')},subscribeSocket:function(e,t,n,r){var s=this,i=s.id;return s.log('SERVER: server "'+i+'" register new socket "'+e+'"'),s.sockets[e]={source:t,origin:n,uuid:r},s.dispatchEvent(g,{},void 0,e),s},unsubscribeSocket:function(e){var t=this,n=t.id;return t.sockets[e]&&(t.log('SERVER: server "'+n+'" unregister socket "'+e+'"'),t.dispatchEvent(h,{},void 0,e),delete t.sockets[e]),t},addListener:function(e,t){return this.listeners.addEvent(e,t),this},removeListener:function(e,t){return this.listeners.removeEvent(e,t),this},dispatchEvent:function(e,t,r,s){var i=this,o=i.id,a=i.sockets,c=i.adapter,u={event:e,data:t,target:{sockets:s},origin:{socket:r,server:o},uuid:i.uuid};return s&&s.length?s=n.splat(s):-1!==(s=Object.keys(i.sockets)).indexOf(r)&&s.splice(s.indexOf(r),1),c||(i.connect(),c=i.adapter),0===s.length?i.log('SERVER: server "'+o+'" has no target socket for dispatchEvent "'+e+'"'):s.forEach((function(n){var s=a[n],u={event:e,data:t,target:{sockets:[n]},origin:{socket:r,server:o},uuid:i.uuid};i.log('SERVER: server "'+o+'" dispatchEvent "'+u.event+'" to "'+n+'"');try{c.dispatchEvent(u,s.source,s.origin)}catch(e){p.console&&p.console.error('InterCom server "'+o+'": error while dispatching to socket '+n+": "+e+"\nDeleting socket"),delete a[n]}})),i.listeners.dispatchEvent(e,[t,u]),i}}),l.Socket=r.extend(o,c,{id:null,uuid:null,servers:null,listeners:null,defaultOptions:{adapter:null,autoconnect:!1},init:function(e,t){var n=this;n.setSocketId(e),n.servers={},n.listeners=new i,n.setOptions(t)},setSocketId:function(e){var t=this,r=l.Socket.Instances=l.Socket.Instances||{};return t.uuid=t.uuid||n.getUUID(),r[e=e||t.uuid]&&(r[e].disconnect(),delete r[e]),t.id=e,r[e]=this,t},connect:function(){var e=this;return e.handleEvent=e.handleEvent.bind(e),e.adapter=l.getAdapter(e.options.adapter),e.adapter.addListener(e.handleEvent),e},disconnect:function(){var e=this;return e.adapter&&(Object.keys(e.servers).forEach((function(t){e.unsubscribeServer(t)})),e.adapter.removeListener(e.handleEvent)),e},handleEvent:function(e,t){var n,r,s,i,o=this,a=o.id,c=o.servers;r=(s=t&&t.source&&t.origin&&e&&e.event&&e.target&&e.origin&&e.origin.server&&c[e.origin.server]&&e.target.sockets&&Array.isArray(e.target.sockets))&&c[e.origin.server]&&c[e.origin.server].uuid===e.uuid,i=s&&0!==e.target.sockets.length&&-1!==e.target.sockets.indexOf(a),s?i?(n=o.servers[e.origin.server],o.log('SOCKET: socket "'+a+'" accept message for event "'+e.event+'"'),e.event===g?(r||(n.waiting=!1,n.uuid=e.uuid,n.queue.length&&(n.queue.forEach((function(e){o.adapter.dispatchEvent(e,n.source,n.origin)})),o.log('SOCKET: socket dispatch "'+n.queue.length+'" events in the queue for serverId "'+e.origin.server+'".'),n.queue=[])),o.listeners.dispatchEvent(e.event,[e.data,e])):r?e.event===h?delete o.servers[e.origin.server]:o.listeners.dispatchEvent(e.event,[e.data,e]):o.log('SOCKET: socket "'+a+'" refuse invalid uuid for event "'+e.event+'"')):o.log('SOCKET: socket "'+a+'" refuse message for event "'+e.event+'"'):o.log('SOCKET: socket "'+a+'" refuse invalid message for event "'+e.event+'"')},subscribeServer:function(e,t,n){var r=this;return t=t||p.parent,n=n||p.location.toString(),r.servers[e]={waiting:!0,queue:[],source:t,origin:n},r.dispatchEvent(g,void 0,void 0,e),r},unsubscribeServer:function(e){var t=this,n=t.id;return t.servers[e]&&(t.log('SOCKET: socket "'+n+'" unregister server "'+e+'"'),t.dispatchEvent(h,{},void 0,e),delete t.servers[e]),t},addListener:function(e,t){return this.listeners.addEvent(e,t),this},removeListener:function(e,t){return this.listeners.removeEvent(e,t),this},dispatchEvent:function(e,t,r,s){var i=this,o=i.id,a=i.servers,c=i.adapter;return s=s&&s.length?n.splat(s):Object.keys(i.servers),r=n.splat(r),c||(i.connect(),c=i.adapter),t=u.prune(t),s.forEach((function(n){var s=a[n],u={event:e,data:t,target:{servers:[n],sockets:r},origin:{socket:o},uuid:i.uuid};0===s.queue.length&&!s.waiting||e===g||e===h?(i.log('SOCKET: socket "'+o+'" dispatch event "'+e+'"'),c.dispatchEvent(u,s.source,s.origin)):(i.log('SOCKET: socket "'+o+'" queue event "'+e+'" for serverId "'+n+'"'),s.queue.push(u))})),i}}),e.namespace("Utils/InterCom",l,e)}));