define("DS/CSIViewModelWebProcessor/CSIVMClientTargetsInContext",["DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels","DS/CSIViewModelWebInterfaces/CSIVMClientDrawGroupParameter"],(function(e,t,i){"use strict";function r(e,t,i,r,s){this._context=e,this._batchParent=r,this._noContext=s,this._targetsIds=t||[],this._targetsGeomTypes=i||[]}let s=i.prototype.geomTypeValues,n=function(){return!1},a=function(e){return new r(e.readObject(t.targetsContext,"CSIViewTreeObjectParam"),e.readUint32Array(t.targets),function(e){let t=[];return 1&e&&t.push(s.face),2&e&&t.push(s.boundary_Edge),4&e&&t.push(s.sharp_Edge),8&e&&t.push(s.smooth_Edge),16&e&&t.push(s.boundary_Point),32&e&&t.push(s.sharp_Point),64&e&&t.push(s.smooth_Point),128&e&&t.push(s.surfacic_Point),256&e&&t.push(s.free_Point),512&e&&t.push(s.wire_Edge),1024&e&&t.push(s.infinite_Face),8192&e&&t.push(s.unknown),16384&e&&t.push(s.hidden_Seam_Edge),32768&e&&t.push(s.hidden_Seam_Point),65536&e&&t.push(s.unknown_0D),131072&e&&t.push(s.unknown_1D),262144&e&&t.push(s.unknown_2D),524288&e&&t.push(s.unknown_3D),1048576&e&&t.push(s.high_curvature_edge),t}(e.readUint32(t.targetTag)),e.readObject(t.batchParent,"CSIViewTreeObjectParam"),e.readBool(t.targetsNoContext))};return r.prototype.declareType=function(){e.declareType({type:"CSIViewModelTargetsInContext",serialize:n,unserialize:a})},r})),define("DS/CSIViewModelWebProcessor/CSIVMClientAppliedGPTokenId",["DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels"],(function(e,t){"use strict";function i(e,t,i){this._shortId=e,this._idPath=t,this._batchParent=i}let r=function(){return!1},s=function(e){return new i(e.readInt32(t.shortId),e.readString(t.idPath),e.readObject(t.batchParent,"CSIViewTreeObjectParam"))};return i.prototype.declareType=function(){e.declareType({type:"CSIViewModelGPTokenId",serialize:r,unserialize:s})},i})),define("DS/CSIViewModelWebProcessor/DotGraph",["require","exports"],(function(e,t){"use strict";class i{constructor(e,t,i){this.node=e,this.attribute=t,this.value=i}serialize(){return`${this.node} [ ${this.attribute} = "${this.value}" ] ; `}}class r{constructor(e,t){this.source=e,this.target=t}serialize(e){const t=e?"->":"--";return`${this.source} ${t} ${this.target} ; `}}return class{constructor(){this.directed=!0,this.attributes=[],this.edges=[]}setDirected(e){this.directed=e}addEdge(e,t){this.edges.push(new r(e,t))}addLabel(e,t){this.attributes.push(new i(e,"label",t))}addColor(e,t){this.attributes.push(new i(e,"color",t)),this.attributes.push(new i(e,"style","filled"))}serialize(){let e="";for(var t of this.attributes)e+=t.serialize();for(var i of this.edges)e+=i.serialize(this.directed);return this.directed?`digraph { ${e} }`:`graph { ${e} }`}}})),define("DS/CSIViewModelWebProcessor/CSIVMClientIdPatternParameter",["require","exports","DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels"],(function(e,t,i,r){"use strict";class s{constructor(e){this._id=e.id||0,this._idSpace=e.idSpace||"",this._idContext=e.idContext||"",this._shared=!!e.shared}getId(){return this._id}getIdSpace(){return this._idSpace}getIdContext(){return this._idContext}getShared(){return this._shared}process(e){return e.getProcessor().getModel().getOrCreateIdPattern(this._idSpace,this._idContext,this._shared)}static declareType(){i.declareType({type:"CSIViewModelIdPattern",serialize:n,unserialize:a})}}function n(){return!1}function a(e){let t={id:e.readInt32(r.id),idSpace:e.readString(r.idSpace),idContext:e.readString(r.idContext),shared:e.readBool(r.shared)};return new s(t)}return s})),define("DS/CSIViewModelWebProcessor/CSIVMClientTransactionOnIdent",["require","exports","DS/CSIViewModelWebInterfaces/CSIVMClientStateMode","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey","DS/CSIViewModelWebInterfaces/CSIViewModelWebEnv","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,s,n,a){"use strict";return class{constructor(e,t,i,r){this._reusedObjects=new Map,this._shortIdsToDualIds=new Map,this._IdsObjIsEmpty=!0,this._treeKey=void 0,this._viewTransac=void 0,this._model=e,this._treeKey=t,this._viewTransac=i,this._createdObjects=r,this._IdsObjIsEmpty=!1,null!==t.getUUID()&&(this._ns=e.getOrCreateNameSpace(t,t.getSceneID()))}getObjectFromId(e,t,i=!1){if(null!=e){let t=this._createdObjects.get(e);return void 0===t&&(t=this._reusedObjects.get(e)),t}if(null!=t){let e=n.noPathUsageInViewParam;const r=t.lastIndexOf("/")+1;1==n.throwOnDupIdentification&&0!=r&&(e=!1);const s=e?t.substr(r):t;let a=this._model.decodeGlobalId({treeKey:this._treeKey,isOptimizedPath:!1,Id:s,noPath:e,canFail:i});return a?a[a.length-1]:void 0}}safeCreateObject(e,t,i,r){let s=r,a=!this._model.hasBatching&&2==n.throwOnDupIdentification,o=!1;switch(n.throwOnDupIdentification){case 0:s=!1;break;case 2:s=!0}let d=s?this._ns.getObject(e,t):void 0;if(d)if(d.getViewData(this._treeKey)){if(a)throw new Error(`Dup object with same id ${t}`)}else o=!0;let c=!1;if(void 0===d)c=!0,d=this._ns.createObject(e,t),i&&this._createdObjects.set(i,d);else if(o||this._model.hasBatching){const e=d.getAssociatedViewElt(this._treeKey);e&&(e.setIdentificationObject(void 0),d.associateViewElt(this._treeKey,void 0)),null!=i&&this._reusedObjects.set(i,d)}else{let r=d;c=!0,d=this._ns.createObject(e,t),console.warn(`[3DSync] Unsafe pattern. Create of new object with on existing id (${t} with on tree ${JSON.stringify(this._treeKey)}`,r,d),i&&this._createdObjects.set(i,d)}return[d,c]}completeOperationWithObjects(e){const t=this.getObjectFromId(e?.IdOperatedObject?._ShortId,e?.IdOperatedObject?._GlobalId);if(null!=e.IdOperatedObject){if(void 0!==e.IdOperatedSubElements){if(!t)throw new Error("Parent not found");let s=t.getMappedChildren(this._treeKey,i.TempoOrPermanent),n=e.IdOperatedSubElements.length;if(e.OperatedSubElements??(e.OperatedSubElements=[]),null!=s)for(const t of e.IdOperatedSubElements){const i=s.get(t);i&&e.OperatedSubElements.push(i.getAssociatedViewElt(this._treeKey))}n&&!e.OperatedSubElements.length&&(e.type=r.OperationsTypes.UnknownType,delete e.OperatedSubElements),delete e.IdOperatedSubElements}if(null==t)throw new Error(`[${2===this._treeKey.getViewType()?`3DSync ( ${this._treeKey.getView3DType()})`:"SpecTree"}] we did not find the operatedObject with treekey ${JSON.stringify(this._treeKey)} with operation= ${JSON.stringify(e)}`);e.OperatedObject=t.getAssociatedViewElt(this._treeKey)}const s=this.getObjectFromId(e.ShortIdOperand,e.GlobalIdOperand,e.type===r.OperationsTypes.RemoveExistingCell);if(s&&(e.OperandObject=s.getAssociatedViewElt(this._treeKey),delete e.ShortIdOperand,delete e.GlobalIdOperand),null!=e.ExistingCells){let t,r=[];if(e.ExistingCells._noContext)for(let t of e.ExistingCells._targetsIds){const e=this.getObjectFromId(void 0,`CGMGeom#${t}`);r.push(e.getAssociatedViewElt(this._treeKey))}else{const s=e.ExistingCells._context.getShortId(),n=e.ExistingCells._context.getIdPath();t=this.getObjectFromId(s,n),r=t.getChildrenWithId(this._treeKey,i.TempoOrPermanent,e.ExistingCells._targetsIds).map((e=>e.getAssociatedViewElt(this._treeKey)))}if(null!=e.ExistingCells._batchParent){const t=e.ExistingCells._batchParent.getShortId(),i=e.ExistingCells._batchParent.getIdPath(),r=this.getObjectFromId(t,i);e.BatchParentCellObject=r.getAssociatedViewElt(this._treeKey)}r.length?e.OperandSubElements=r:delete e.OperandSubElements}if(null!=e.IdPreviousObject){const t=this.getObjectFromId(e.IdPreviousObject._ShortId,e.IdPreviousObject._GlobalId);e.PreviousObject=t.getAssociatedViewElt(this._treeKey),delete e.IdPreviousObject}if(null!=e.IdBatchParentObject){const t=this.getObjectFromId(e.IdBatchParentObject._ShortId,e.IdBatchParentObject._GlobalId);e.BatchParentObject=t.getAssociatedViewElt(this._treeKey),delete e.IdBatchParentObject}if(null!=e.IdBatchParentSharedObject){const t=this.getObjectFromId(e.IdBatchParentSharedObject._ShortId,e.IdBatchParentSharedObject._GlobalId);e.BatchParentSharedObject=t.getAssociatedViewElt(this._treeKey)}if(null!=e.GeometricalData&&(null!=e.GeometricalData._idPathInitializers||null!=e.GeometricalData._shortIdInitializers)){let t=[];if(null!=e.GeometricalData._shortIdInitializers){const i=e.GeometricalData._shortIdInitializers.length;t.length=i;for(let r=0;r<i;r++){const i=e.GeometricalData._shortIdInitializers[r],s=this.getObjectFromId(i,void 0).getAssociatedViewElt(this._treeKey);s?t[r]=s:t.length-=1}}if(null!=e.GeometricalData._idPathInitializers){t.length=e.GeometricalData._idPathInitializers.length;for(let i=0;i<e.GeometricalData._idPathInitializers?.length;i++){const r=e.GeometricalData._idPathInitializers[i],s=this.getObjectFromId(void 0,r).getAssociatedViewElt(this._treeKey);s?t[i]=s:t.length-=1}}e.GeometricalData._initializers=t}if(null!=e.Groups){if(null==t)throw new Error(`object to which we want to add groups is undefined  with operation= ${JSON.stringify(e)}`);for(const r of e.Groups){r._groupedElements=[];let e=t.getChildrenWithId(this._treeKey,i.Tempo,r._localIDs);for(const t of e)r._groupedElements.push(t.getAssociatedViewElt(this._treeKey))}}if(e.type==r.OperationsTypes.ModifyBody&&e.VisData)for(let t=0;t<e.VisData.visPrimitives.length;t++){const i=e.VisData.visPrimitives[t];if(!i.shouldRetrieveObject())continue;const r=this.getObjectFromId(void 0,`CGMGeom#${i.getId()}`).getAssociatedViewElt(this._treeKey);i.setObject(r)}if(null==t&&void 0!==e.IdOperatedSubElements&&null!=e.BatchParentObject){e.OperatedSubElements??(e.OperatedSubElements=[]);for(const t of e.IdOperatedSubElements){const i=this.getObjectFromId(void 0,`CGMGeom#${t}`);e.OperatedSubElements.push(i.getAssociatedViewElt(this._treeKey))}e.IdOperatedSubElements.length&&!e.OperatedSubElements.length&&(e.type=r.OperationsTypes.UnknownType),delete e.IdOperatedSubElements}}doOperation(e){a.begin("CSIVMClientTransactionOnIdent::doOperation"),n.isPerformanceTracesActivated()&&n.startPerfo("CSIVMClientTransactionOnIdent.doOperation"),this.completeOperationWithObjects(e);let t=e;void 0!==t&&(t.TreeKey=this._treeKey,this._viewTransac.doOperation(t),this.internalDoOperation(t)),n.isPerformanceTracesActivated()&&n.endPerfo("CSIVMClientTransactionOnIdent.doOperation"),a.end("CSIVMClientTransactionOnIdent::doOperation")}executeEnd(){let e;return a.begin("CSIVMClientTransactionOnIdent::executeEnd"),null!=this._viewTransac.executeEnd&&(e=this._viewTransac.executeEnd()),a.end("CSIVMClientTransactionOnIdent::executeEnd"),e}internalDoOperation(e){a.begin("CSIVMClientTransactionOnIdent::doOperationInternal"),n.isPerformanceTracesActivated()&&n.startPerfo("CSIVMClientTransactionOnIdent.internalDoOperation");let t=e.getType();if(t===r.OperationsTypes.RemoveAll)a.begin("CSIVMClientTransactionOnIdent::clearTree"),this._model.clearTree(this._treeKey),a.end("CSIVMClientTransactionOnIdent::clearTree");else{let s;if(void 0!==e.IdNewObject){let i=!1;const n=e.IdNewObject;void 0===s&&([s,i]=this.safeCreateObject(n._IdPattern,n._LocalId,n._ShortId,!0)),i&&(e.IdNewObject._LocalIdDual&&this._shortIdsToDualIds.set(e.IdNewObject._ShortId,e.IdNewObject._LocalIdDual),t===r.OperationsTypes.CreateRoot||t===r.OperationsTypes.CreateSemanticRoot?this._model.setRootObject(this._treeKey,s):t===r.OperationsTypes.AddBody&&s.activateChildrenMapping()),e.CreatedObject.setIdentificationObject(s),s.associateViewElt(this._treeKey,e.CreatedObject)}const a=e?.OperatedObject?.getIdentificationObject(),o=e?.OperandObject?.getIdentificationObject();switch(t){case r.OperationsTypes.AddBatchNode:case r.OperationsTypes.CreateRootBatch:{this._model.hasBatching=!0,1!==n.throwOnDupIdentification&&(n.throwOnDupIdentification=1);const t=e.BatchCellIdPattern;for(let i=0;i<(e?.CreatedObjectsWithID?.length??0);i++){const r=e.CreatedObjectsWithID[i],[s,n]=this.safeCreateObject(t,r.ident,void 0,!1);r.object.setIdentificationObject(s),s.associateViewElt(this._treeKey,r.object)}a&&this._model.addChild(this._treeKey,a,s);break}case r.OperationsTypes.AddNode:case r.OperationsTypes.AddBody:case r.OperationsTypes.AddCustomNode:case r.OperationsTypes.AddSemanticNode:{this._model.addChild(this._treeKey,a,s);const t=e?.GeometricalData?._initializers??[];if(t.length){this._model.emptyObject(this._treeKey,s);for(let e=0;e<t.length;e++){const r=t[e].getIdentificationObject().getChildren(this._treeKey,i.Tempo);this._model.addChildren(this._treeKey,s,r)}}const r=e?.IdNewObject?._IdPattern;for(let t=0;t<(e.CreatedObjectsWithID?.length??0);t++){const i=e.CreatedObjectsWithID[t],[n,a]=this.safeCreateObject(r,i.ident,void 0,!1);i.object?.setIdentificationObject(n),n.associateViewElt(this._treeKey,i.object),this._model.addChild(this._treeKey,s,n)}break}case r.OperationsTypes.ModifyBody:case r.OperationsTypes.AddCells:if(e.VisData&&void 0===e.IdPattern&&(e.IdPattern=this._model.getIdPattern("PLM","CGMGeom",!0)),e.CreatedObjectsWithID){const t=[];t.length=e.CreatedObjectsWithID.length;for(let i=0;i<e.CreatedObjectsWithID?.length;i++){const r=e.CreatedObjectsWithID[i],[s,n]=this.safeCreateObject(e.IdPattern,r.ident,void 0,!1);r.object.setIdentificationObject(s),s.associateViewElt(this._treeKey,r.object),t[i]=s}this._model.addChildren(this._treeKey,a,t)}break;case r.OperationsTypes.AddExistingNode:case r.OperationsTypes.AddExistingCell:case r.OperationsTypes.AddCGRNode:this._model.addChild(this._treeKey,a,o);break;case r.OperationsTypes.AddExistingCells:for(const t of e.OperandSubElements)this._model.addChild(this._treeKey,a,t.getIdentificationObject());break;case r.OperationsTypes.RemoveExistingNode:this._model.removeChild(this._treeKey,a,o);break;case r.OperationsTypes.RemoveExistingCell:o&&this._model.removeChild(this._treeKey,a,o);break;case r.OperationsTypes.RemoveExistingCells:for(const t of e.OperandSubElements)this._model.removeChild(this._treeKey,a,t.getIdentificationObject())}}n.isPerformanceTracesActivated()&&n.endPerfo("CSIVMClientTransactionOnIdent.internalDoOperation"),a.end("CSIVMClientTransactionOnIdent::doOperationInternal")}commit(){a.begin("CSIVMClientTransactionOnIdent::commit"),this._viewTransac.commit(),null!==this._treeKey.getUUID()&&this._model.commitTree(this._treeKey),a.end("CSIVMClientTransactionOnIdent::commit")}abort(){n.useNewVMClientObject||(a.begin("CSIVMClientTransactionOnIdent::abort"),this._viewTransac.abort(),this._model.abortTree(this._treeKey),a.end("CSIVMClientTransactionOnIdent::abort"))}computeDuality(){if(!this._IdsObjIsEmpty){let e=this._treeKey.getViewType(),t=[];e===s.ViewType.ViewSpecTree||e===s.ViewType.ViewSpecTree2?t.push(s.ViewType.View3D):e===s.ViewType.View3D&&t.push(s.ViewType.ViewSpecTree,s.ViewType.ViewSpecTree2);for(const[i,r]of this._shortIdsToDualIds.entries()){let s=this._createdObjects.get(i);if(void 0!==s)for(const i of t){let t=s.getDualObject(i);if(void 0!==t&&t.getDualObject(e)===s)break;if(t=this._model.getDualObject(i,s.getIdPattern(),r),void 0!==t){s.setDualObject(i,t),t.setDualObject(e,s);break}}}}}}})),define("DS/CSIViewModelWebProcessor/CSIVMClientTreeObjectParameter",["require","exports","DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels"],(function(e,t,i,r){"use strict";let s=function(){return!1},n=function(e){return new a({shortId:e.readInt32(r.shortId),idPath:e.readString(r.idPath)})};class a{constructor(e){this.getShortId=function(){return this._shortId},this.getIdPath=function(){return this._idPath},this._shortId=e.shortId,this._idPath=e.idPath}}return a.declareType=function(){i.declareType({type:"CSIViewTreeObjectParam",serialize:s,unserialize:n})},a})),define("DS/CSIViewModelWebProcessor/CSIVMClientAppliedGPTokenParameter",["DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebProcessor/CSIVMClientTargetsInContext","DS/CSIViewModelWebProcessor/CSIVMClientAppliedGPTokenId"],(function(e,t,i,r,s,n){"use strict";function a(e){this._id=e.id||0,this._shortIds=e.shortIds,this._globalIds=e.globalIds,this._targetsInContext=e.targetsInContext}a.prototype.process=function(e,i){let s=e.getGraphicProperties(),n=(e.getProcessor(),0),a=0;if(void 0!==this._shortIds)for(a=this._shortIds.length,n=0;n<a;n++){let e=t.createOperation({type:r.prototype.OperationType.ApplyGP,IdOperatedObject:{_ShortId:this._shortIds[n]._shortId},GraphicProperties:s[this._id],IdBatchParentObject:void 0!==this._shortIds[n]._batchParent?{_GlobalId:this._shortIds[n]._batchParent.getIdPath(),_ShortId:this._shortIds[n]._batchParent.getShortId()}:void 0});i.doOperation(e)}if(void 0!==this._globalIds)for(a=this._globalIds.length,n=0;n<a;n++){let e=t.createOperation({type:r.prototype.OperationType.ApplyGP,IdOperatedObject:{_GlobalId:this._globalIds[n]._idPath},GraphicProperties:s[this._id],IdBatchParentObject:void 0!==this._globalIds[n]._batchParent?{_GlobalId:this._globalIds[n]._batchParent.getIdPath(),_ShortId:this._globalIds[n]._batchParent.getShortId()}:void 0});i.doOperation(e)}if(void 0!==this._targetsInContext)for(a=this._targetsInContext.length,n=0;n<a;n++){let e=t.createOperation({type:r.prototype.OperationType.ApplyGP,IdOperatedObject:null!=this._targetsInContext[n]._context?{_GlobalId:this._targetsInContext[n]._context.getIdPath(),_ShortId:this._targetsInContext[n]._context.getShortId()}:void 0,GraphicProperties:s[this._id],IdBatchParentObject:void 0!==this._targetsInContext[n]._batchParent?{_GlobalId:this._targetsInContext[n]._batchParent.getIdPath(),_ShortId:this._targetsInContext[n]._batchParent.getShortId()}:void 0,IdOperatedSubElements:this._targetsInContext[n]._targetsIds,OperatedGeomTypes:this._targetsInContext[n]._targetsGeomTypes});i.doOperation(e)}};let o=function(){return!1},d=function(e){return new a({id:e.readUint32(i.idGP),shortIds:e.readObjectArray(i.shortIds,"CSIViewModelGPTokenId"),globalIds:e.readObjectArray(i.globalIds,"CSIViewModelGPTokenId"),targetsInContext:e.readObjectArray(i.targetsInContext,"CSIViewModelTargetsInContext")})};return a.prototype.declareType=function(){e.declareType({type:"CSIViewModelGPTokenParam",serialize:o,unserialize:d}),s.prototype.declareType(),n.prototype.declareType()},a})),define("DS/CSIViewModelWebProcessor/CSIVMClientTreeTokenParameter",["require","exports","DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIVMClientAttributes","DS/CSIViewModelWebInterfaces/CSIVMClientBoundingSphereParameter","DS/CSIViewModelWebInterfaces/CSIVMClientCustomDataParameter","DS/CSIViewModelWebInterfaces/CSIVMClientGeometricalData","DS/CSIViewModelWebInterfaces/CSIVMClientGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels","DS/CSIViewModelWebProcessor/CSIVMClientTreeObjectParameter","DS/CSIViewModelWebInterfaces/CSIVMClientVisPrimitiveGroupRepParameter","DS/EKEventsWeb/EKEvents","DS/CSIViewModelWebInterfaces/CSIViewModelWebEnv","DS/CSIViewModelWebInterfaces/CSIVMClientGroup","DS/CSIViewModelWebInterfaces/CSIVMClientSemanticDataParameter","DS/CSIViewModelWebProcessor/CSIVMClientTargetsInContext","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,s,n,a,o,d,c,l,h,I,u,C,p,S,_,m){"use strict";function b(){return!1}function g(e){return new w(e)}class w{constructor(e){let t=e.readObjectArray(l.valueGeometries,"CSIGeometryParam");if(!t||0===t.length){let i=e.readObject(l.valueGeometry,"CSIGeometryParam");t=i?[i]:void 0}let i=e.readObjectArray(l.valueInfiniteGeometries,"CSIInfiniteGeometryParam");if(!i||0===i.length){let t=e.readObject(l.valueInfiniteGeometry,"CSIInfiniteGeometryParam");i=t?[t]:void 0}const r=e.readUint8(l.valueHasInfiniteGeometry);this._value=c.OperationsTypes[e.readString(l.value)];{const t=e.readUint32(l.localIdInt);void 0!==t&&(this._localIdInt=t)}{const t=e.readString(l.localIdString);void 0!==t&&(this._localIdString=t)}{const t=e.readUint32(l.localIdIntDual);void 0!==t&&(this._localIdIntDual=t)}{const t=e.readString(l.localIdStringDual);void 0!==t&&(this._localIdStringDual=t)}{const t=e.readInt32(l.shortId);void 0!==t&&(this._shortId=t)}{const t=e.readString(l.idPath);void 0!==t&&(this._idPath=t)}{const t=e.readInt32(l.idPattern);void 0!==t&&(this._idPattern=t)}{const t=e.readInt32(l.batchCellIdPattern);void 0!==t&&(this._batchCellIdPattern=t)}{const t=e.readObject(l.parent,"CSIViewTreeObjectParam");void 0!==t&&(this._parent=t)}{const t=e.readObject(l.batchParent,"CSIViewTreeObjectParam");void 0!==t&&(this._batchParent=t)}{const t=e.readObject(l.batchParentShared,"CSIViewTreeObjectParam");void 0!==t&&(this._batchParentShared=t)}{const t=e.readObject(l.previous,"CSIViewTreeObjectParam");void 0!==t&&(this._previous=t)}{const t=e.readInt32(l.index);void 0!==t&&(this._index=t)}t&&(this._geometries=t),i&&(this._infiniteGeometries=i);{const t=e.readObject(l.VisPrimitiveGroupRep,"CSIVisPrimitiveGroupRep");void 0!==t&&(this._visGeometry=t)}{const t=e.readObject(l.valueBoundingSphere,"CSIBoundingSphereParam");void 0!==t&&(this._bs=t)}{const t=e.readStringArray(l.valueIdPathInitializers);void 0!==t&&(this._inits_idPath=t)}{const t=e.readInt32Array(l.valueShortIdInitializers);void 0!==t&&(this._inits_shortId=t)}{const t=e.readObject(l.valueCustomData,"CSICustomDataParam");void 0!==t&&(this._customData=t)}{const t=e.readObjectArray(l.valueGroups,"CSIViewModelGroup");void 0!==t&&(this._groups=t)}{const t=e.readObject(l.valueAttribute,"Parameters");void 0!==t&&(this._attributes=t)}{const t=e.readInt8(l.valueDimension);void 0!==t&&(this._dim=t)}{const t=e.readBool(l.valueUseParentForPixelCulling);void 0!==t&&(this._useParentForPixelCulling=t)}{const t=e.readBool(l.valueTerminalRepWithPrimitivesWithoutGas);void 0!==t&&(this._terminalRepWithPrimitivesWithoutGas=t)}{const t=e.readUint32Array(l.valueMultipleViewElts);void 0!==t&&(this._multipleViewElts=t)}{const e=r>0||void 0!==this._infiniteGeometries;void 0!==e&&(this._hasInfiniteGeometry=e)}{const t=e.readBool(l.valueHasGeomDecorations);void 0!==t&&(this._hasGeomDecorations=t)}{const t=e.readObject(l.targetsInContext,"CSIViewModelTargetsInContext");void 0!==t&&(this._existingCells=t)}{const t=e.readUint8("type");void 0!==t&&(this._type=t)}{const t=e.readObject("data","Parameters");void 0!==t&&(this._data=t)}{const t=e.readString("url");void 0!==t&&(this._url=t)}}process(e,t){let i;m.begin("CSIVMClientTreeTokenParameter::processTreeUpdate"),C.isEKPerfoTracesActivated()&&(i=u.Trace.traceStart(C.getEKPerfoProvider(),"web__csivmclienttreetokenparameter_process"));let s,n,o,d,l,h,I,p,_,b,g,w,V,f,P,O=e.getProcessor(),y=e.getIdPatterns(),M=this._visGeometry;if(this._value==c.OperationsTypes.ModifyCustomNode||this._value==c.OperationsTypes.ApplyAttributes||this._value==c.OperationsTypes.ModifyBody||this._value==c.OperationsTypes.ModifyBatch||this._value==c.OperationsTypes.ModifyBoundingElement?o={_GlobalId:this._idPath}:this._value!=c.OperationsTypes.RemoveAll&&(this.isNotRoot()?(o={_ShortId:this._parent.getShortId(),_GlobalId:this._parent.getIdPath()},I=this._idPath,p=this._shortId):this._value==c.OperationsTypes.AddBatchNode?this._value=c.OperationsTypes.CreateRootBatch:this._value=c.OperationsTypes.CreateRoot,this._previous&&(_={_ShortId:this._previous.getShortId(),_GlobalId:this._previous.getIdPath()}),this._value==c.OperationsTypes.AddCells&&(l=y[this._idPattern]),(this._localIdInt||this._localIdString)&&this._idPattern&&this._shortId&&(d={_LocalId:this._localIdInt||this._localIdString,_LocalIdDual:this._localIdIntDual||this._localIdStringDual,_IdPattern:y[this._idPattern],_ShortId:this._shortId})),this._value!=c.OperationsTypes.AddExistingCells&&this._value!=c.OperationsTypes.AddExistingNode&&this._value!=c.OperationsTypes.AddGroups&&this._value!=c.OperationsTypes.AddBody||this._batchParent&&(b={_ShortId:this._batchParent.getShortId(),_GlobalId:this._batchParent.getIdPath()}),this._value==c.OperationsTypes.AddExistingNode&&this._batchParentShared&&(g={_ShortId:this._batchParentShared.getShortId(),_GlobalId:this._batchParentShared.getIdPath()}),(this._geometries||this._infiniteGeometries||this._inits_idPath||this._inits_shortId||this._bs||this._dim)&&(this._value==c.OperationsTypes.AddBatchNode||this._value==c.OperationsTypes.CreateRootBatch?(h=y[this._batchCellIdPattern],this._geometries&&(s=new a(this._bs,this._inits_idPath,this._inits_shortId,this._geometries,this._dim,e.getViewVersion(),!1,this._hasGeomDecorations,this._useParentForPixelCulling,this._terminalRepWithPrimitivesWithoutGas)),this._infiniteGeometries&&(n=new a(this._bs,this._inits_idPath,this._inits_shortId,this._infiniteGeometries,this._dim,e.getViewVersion(),!0,this._hasGeomDecorations,this._useParentForPixelCulling,this._terminalRepWithPrimitivesWithoutGas))):(s=new a(this._bs,this._inits_idPath,this._inits_shortId,this._hasInfiniteGeometry?this._infiniteGeometries:this._geometries,this._dim,e.getViewVersion(),this._hasInfiniteGeometry,this._hasGeomDecorations,this._useParentForPixelCulling,this._terminalRepWithPrimitivesWithoutGas),void 0!==this._geometries&&void 0!==this._infiniteGeometries&&(n=s,s=new a(this._bs,this._inits_idPath,this._inits_shortId,this._geometries,this._dim,e.getViewVersion(),!1,this._hasGeomDecorations,this._useParentForPixelCulling,this._terminalRepWithPrimitivesWithoutGas)))),null!=this._customData&&this._customData.getBinFormat()==this._customData.binFormatValues.sem&&(w=new S(this._customData.getData()),this._value==c.OperationsTypes.AddCustomNode?this._value=c.OperationsTypes.AddSemanticNode:this._value==c.OperationsTypes.CreateRoot?this._value=c.OperationsTypes.CreateSemanticRoot:this._value==c.OperationsTypes.ModifyCustomNode&&(this._value=c.OperationsTypes.ModifySemanticNode)),null!=this._url){this._value=c.OperationsTypes.AddCGRNode;let e=O._directMap.get(this._url);f=e.node,P=e.model}void 0===this._attributes&&void 0===this._type||(V=new r(this._type,this._data,this._attributes));let v=c.createOperation({type:this._value,GeometricalData:s,InfiniteGeometricalData:n,VisData:M,CustomData:this._customData,SemanticData:w,IdOperatedObject:o,IdNewObject:d,IdPreviousObject:_,IdBatchParentObject:b,IdBatchParentSharedObject:g,IdPattern:l,BatchCellIdPattern:h,ShortIdOperand:p,GlobalIdOperand:I,MultipleViewElts:this._multipleViewElts,Groups:this._groups,Index:this._index,Attributes:V,ExistingCells:this._existingCells,DirectNode:f,DirectModel:P});t.doOperation(v),i&&i.End(),m.end("CSIVMClientTreeTokenParameter::processTreeUpdate")}isNotRoot(){return this._parent&&(null!=this._parent.getShortId()||null!=this._parent.getIdPath())}static declareType(){i.declareType({type:"CSIViewTreeTokenParam",serialize:b,unserialize:g}),h.declareType(),o.prototype.declareType(),d.declareType(),I.declareType(),s.prototype.declareType(),n.prototype.declareType(),p.prototype.declareType(),_.prototype.declareType(),r.declareTypes(i)}}return w})),define("DS/CSIViewModelWebProcessor/CSIVMClientTreeUpdateParameter",["require","exports","DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebProcessor/CSIVMClientAppliedGPTokenParameter","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels","DS/CSIViewModelWebProcessor/CSIVMClientTreeTokenParameter","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,s,n,a){"use strict";function o(){return!1}function d(e){a.begin("CSIVMClientTreeUpdateParameter::unserialize");let t=e.readObject(s.csiTreeKey,"CSIViewTreeKey");a.begin("CSIVMClientTreeUpdateParameter::unserializeTreeTokens");let i=e.readObjectArray(s.tokens,"CSIViewTreeTokenParam");a.end("CSIVMClientTreeUpdateParameter::unserializeTreeTokens"),a.begin("CSIVMClientTreeUpdateParameter::unserializeAppliedGP");let r=e.readObjectArray(s.appliedGP,"CSIViewModelGPTokenParam");return a.end("CSIVMClientTreeUpdateParameter::unserializeAppliedGP"),a.end("CSIVMClientTreeUpdateParameter::unserialize"),new c(t,i,r)}class c{constructor(e,t,i){this._treeKey=e,this._tokens=t,this._appliedGP=i}getTreeKey(){return this._treeKey}getTokens(){return this._tokens}process(e,t){let i=e.getProcessor();this._treeKey=this._treeKey.process(e);let r=i.createTransactionOnIdent(this._treeKey,e.getCreatedObjects());if(this._tokens?.length){a.begin("CSIVMClientTreeUpdateParameter::processTokens");for(const i of this._tokens)try{i.process(e,r)}catch(e){t(e,this._treeKey)}a.end("CSIVMClientTreeUpdateParameter::processTokens")}if(this._appliedGP?.length){a.begin("CSIVMClientTreeUpdateParameter::appliedGP");for(const i of this._appliedGP)try{i.process(e,r)}catch(e){t(e,this._treeKey)}a.end("CSIVMClientTreeUpdateParameter::appliedGP")}return r}static declareType(){i.declareType({type:"CSIViewTreeUpdateParam",serialize:o,unserialize:d}),n.declareType(),r.prototype.declareType()}}return c})),define("DS/CSIViewModelWebProcessor/CSIVMClientProcessor",["require","exports","DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIViewModelWebEnv","DS/CSIViewModelWebInterfaces/CSIVMClientModel","DS/CSIViewModelWebProcessor/CSIVMClientTransactionOnIdent","DS/CSIViewModelWebProcessor/CSIVMClientViewParameter","DS/CSIViewModelWebProcessor/DotGraph","DS/EKEventsWeb/EKEvents","DS/VisualizationProfiler/VisuProfiler","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey"],(function(e,t,i,r,s,n,a,o,d,c,l){"use strict";let h,I=0;class u{constructor(e){if(this._cbOnFatalError={},this._cbOnVisuContextData={},this._cbOnVmUpdate={},this._cbOnVisuContextChanges={},this._delegateMap=new Map,this._model=new s,this._newScenes={},this._subId=0,this._directList=[],this._cgrID=0,this._cgrHelper=void 0,this._csiNode=void 0,this._directMap=new Map,this._answerMode=e,this._subId=0,a.declareType(),1&this._answerMode){i.getDefaultResponse().onAnswerDomain("view",this.onServerMessage.bind(this))}}static initDirectVisuMode(e,t){return h||(h=new u(e),h._cgrHelper=t),h}static init(e,t){void 0===h&&(h=new u(e)),h._newScenes[t]=!0}static get(){return h}isNewScene(e){return!0===this._newScenes[e]}subscribe(e){this._subId||2&this._answerMode&&(this._subId=e.subscribe("CSISceneViewUpdate",this.CallbackOnEmitedMessages.bind(this)),e.subscribe("DirectVisuModeEvent",this.DirectVisuMode.bind(this)),this._csiNode=e)}getFirstView3DTreeKey(){for(const e of this.getModel().getTreeKeysFromViewType(2))return e}fetchCGRFromCSI(e){let t=new i.Parameters;t.writeString("url",e);return new Promise(((e,i)=>{this._csiNode.call({version:1,name:"csiDownloadCGRFunction",parameters:t,onSuccess:function(t){let i=t.readBuffer("buffer");e(new Blob([i]))},onError:i})}))}fetchCGRFromHTTP(e){let t=e.substring(e.lastIndexOf("\\")+1);return fetch("http://dell3790dsy.dsone.3ds.com:8080/"+t).then((e=>e.blob()))}DirectVisuMode(e){const t=e.readString("url"),i=e.readString("source");console.debug("Direct visu mode event received:"+t+" at: "+performance.now()+" from: "+i);let r=this.fetchCGRFromCSI(t);if(this._cgrHelper){let e={cgr:r,node:void 0,model:void 0},s=this._cgrHelper.fromBlob(r).then((t=>(e.node=t,t))).then((e=>this.buildCSIViewModel(e,i)));this._directMap.set(t,e),this._directList.push(s.then((t=>e.model=t)))}}buildCSIViewModel(e,t){let i,r=++this._cgrID<<24,s=this._model.getOrCreateTreeKeyForCGRS(),n=this._model.getOrCreateNameSpace(s,2),a=this._model.getOrCreateIdPattern("PLM","CGR",!0);"toolkit"===t&&(i=n.createObject(a,r++),e.setIdentificationObject(i),i.associateViewElt(s,e));let o=n.createObject(a,r++);e.internalSceneGraph.setIdentificationObject(o),o.associateViewElt(s,e.internalSceneGraph),"toolkit"===t?i.addChild(s,o):"experience"===t&&(i=o);let d=this._cgrHelper,c=function(e){let t=function(e){return e.getIdentificationObject?e.getIdentificationObject():e.modelIdentification};for(let d=0;e.children&&d<e.children.length;d++){let l=e.children[d],h=t(l);h||(i=l,o=h=n.createObject(a,r++),i.setIdentificationObject?i.setIdentificationObject(o):i.modelIdentification=o,h.associateViewElt(s,l)),t(e).addChild(s,h),c(l)}var i,o;for(let i=0;e._primitives&&i<e._primitives.length;i++){let o=n.createObject(a,r++),c=d.newPrimitiveHelper(e,i);c.setIdentificationObject(o,i),o.associateViewElt(s,c),t(e).addChild(s,o),o.commit(s)}t(e).commit(s)};return c(e.internalSceneGraph),i.commit(s),i}getInternalLocalID(e){return 3==e.type?16777215&e.IdentObj.getLocalId():16777215&e.modelIdentification.getLocalId()}dotifyNodeAux(e,t,i){let r=this.getInternalLocalID(e);switch(e.type){case 1:t.addColor(r,"#FF000088");for(let s=0;e.children&&s<e.children.length;s++)t.addEdge(r,this.getInternalLocalID(e.children[s])),this.dotifyNodeAux(e.children[s],t,i);break;case 2:t.addColor(r,"#FFFF0088");for(let s=0;e._primitives&&i&&s<e._primitives.length;s++)t.addEdge(r,this.getInternalLocalID(e._primitives[s])),this.dotifyNodeAux(e._primitives[s],t,i);break;case 3:t.addColor(r,"#FF00FF88")}}dotifyNode(e,t=!1){let i=new o;i.setDirected(!0),this.dotifyNodeAux(e,i,t),console.log(i.serialize())}async CallbackOnEmitedMessages(e){if(void 0!==e){let t=e.readParameters("domains","Parameters");if(void 0!==t){let e=t.readParameters("view","Parameters");void 0!==e&&(this._directList.length&&await Promise.all(this._directList),this.onServerMessage(e),this._directList=[])}}}onServerMessage(e){let t,i;if(c.begin("CSIVMClientProcessor::onServerMessage"),r.isEKPerfoTracesActivated()){const i={msg_size:e.getInputStreamSize()};t=d.Trace.traceStart(r.getEKPerfoProvider(),"web__csivmclientprocessor_onservermessage",i)}let s=[];try{i=this.onServerMessageWithOutCallback(e,((e,t)=>s.push([e,t])))}catch(e){s.push([e,null])}if(t&&t.End(),s.length){for(let[e,t]of s)if(Object.keys(this._cbOnFatalError).length)for(const i of Object.values(this._cbOnFatalError))i&&i(e,t);else console.error("Warning: Uncaught 3DSync error. The current transaction most likely was abnormally aborted. Please consider add ErrorManagement with  CSIVMClientManager.addCBOnFatalError\n\n",e);return!1}return this.answerCallback(i,e),c.end("CSIVMClientProcessor::onServerMessage"),i}onServerMessageWithOutCallback(e,t){let i;r.isEKPerfoTracesActivated()&&(i=d.Trace.traceStart(r.getEKPerfoProvider(),"web__csivmclientprocessor_readviewparam")),c.begin("CSIVMClientProcessor::ReadParameter");let s=e.readObject("view","CSIViewParam"),n=e.readUint8("operationType"),a=!0===e.readBool("commandHasSucceeded")?"S_OK":"E_FAIL";const o=e.readBool("reloadMsg");let l;if(c.end("CSIVMClientProcessor::ReadParameter"),o){l=new Set;for(let e of Object.keys(this.getModel().getNameSpaces())){const t=parseInt(e);void 0===this._newScenes[t]&&l.add(t)}}i&&i.End();let h={Operation:n,rc:a,hasUpdatedView:!1,viewUpdateType:0,hasVisuContextUpdate:!1,promises:[]};if(s){let e;this._model.setInWork(!0),r.isEKPerfoTracesActivated()&&(e=d.Trace.traceStart(r.getEKPerfoProvider(),"web__csivmclientprocessor_processviewparam")),h.viewUpdateType=s.getViewStatus(),c.begin("CSIVMClientProcessor::ProcessViewParam"),s.process(this,h,l,t),c.end("CSIVMClientProcessor::ProcessViewParam"),e&&e.End(),this._newScenes={},this._model.setInWork(!1)}return h}getModel(){return this._model}setNotifier(e,t,i){return void 0===e&&(e=0),void 0===this._delegateMap.get(e)&&this._delegateMap.set(e,new Map),this._delegateMap.get(e).set(t,i),i}getNotifier(e,t){return this._delegateMap.get(e??0)?.get(t)}addCBOn(e,t){return I++,this["_cbOn"+e][I]=t,I}removeCBOn(e,t){this["_cbOn"+e][t]&&delete this["_cbOn"+e][t]}onVisContextData(e){for(const t of Object.values(this._cbOnVisuContextData))t?.call(void 0,e)}onSceneEnvChanges(e){for(const t of Object.values(this._cbOnVisuContextChanges))t?.call(void 0,e)}hasCbOnSceneEnv(){return Object.keys(this._cbOnVisuContextChanges).length>0}answerCallback(e,t){for(const i of Object.values(this._cbOnVmUpdate))i&&i(e,t)}createTransaction(e){let t,i=this._delegateMap.get(e.getSceneID())?.get(e.getViewType());if(!i&&e.getView3DType()===l.View3DType.View3D_Transient&&e.getViewType()===l.ViewType.View3D)for(const t of this._delegateMap.values())if(i=t.get(e.getViewType()),i)break;if(void 0===i)throw new Error(`has no delegate ignore for ${JSON.stringify(e)}`);return t=i.createTransaction(e),t}createTransactionOnIdent(e,t){const i=t.get(e.getViewType());let r=this.createTransaction(e);return new n(this._model,e,r,i)}clear(e=void 0){this._model&&this._model.clearScene(e)}}return u||(u={}),u})),define("DS/CSIViewModelWebProcessor/CSIVMClientManager",["require","exports","DS/CSIViewModelWebInterfaces/CSIVMClientManagerList","DS/CSIViewModelWebProcessor/CSIVMClientProcessor","DS/CSICommandBinder/CSICommandBinder","DS/CSICommandBinder/CSIParameters","DS/CSIViewModelWebInterfaces/CSIVMClientRequestWithView","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey","DS/CSIViewModelWebInterfaces/CSIVMClientDelegateInterface","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels","DS/CSIViewModelWebInterfaces/CSIVMClientDebugTools","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,s,n,a,o,d,c,l,h){"use strict";l.ping();const I={newModelIdentification:!0,defaultAnimationLoop:!0,useQualityManager:!0,useViewPanel:!0,visuFaceMaterialsAsPBR:!0,multiViewer:!0,multiViewerAuto:!0,sgOrder:!0},u=Object.assign({},I,{isA2X:!0,useViewPanel:!1});class C extends Error{}class p{constructor(e){this._clearProcessorOnReload=!0,this._answerDirectlyOnFunctionCall=!0;const t=e??{};this._sceneID=t.sceneID,this._answerMode=t.answerMode||1,this._clearProcessorOnReload=!0,this._answerDirectlyOnFunctionCall=t.answerDirectlyOnFunctionCall,r.init(this._answerMode,this._sceneID),i.Add(this)}static createClientManager(e){return new p(e)}static getViewerOptions(e=!1){return e?u:I}initializeViewer(e){e.displayPoints(!0),e.displaySurfacicPoints(!0),e.setPicking({activated:!0,trapSelection:!0,trapPrimitive:!1,primitive:!0}),e.setPrePicking({activated:!0,primitive:!0}),e.setCSIViewModelManager&&e.setCSIViewModelManager(this),e.currentViewpoint.setDefaultController(!0,"COMBINED"),e.setSectionCapping(!0),e.setCSIViewModelManager(this),e.setFillXSOMode(!1),e.setVisuEnvOCA("Basic")}getModel(){return r.get().getModel()}getProcessor(){return r.get()}getSceneID(){return this._sceneID??0}setNotifier(e,t){r.get().setNotifier(this._sceneID,e,t),e===o.ViewType.View3D&&t instanceof d&&t.setManager(this)}getNotifier(e){return r.get().getNotifier(this._sceneID,e)}addCBOnVMUpdate(e){return r.get().addCBOn("VmUpdate",e)}removeCBOnVMUpdate(e){return r.get().removeCBOn("VmUpdate",e)}addCBOnFatalError(e){return r.get().addCBOn("FatalError",e)}addCBOnVisContextData(e){return r.get().addCBOn("VisuContextData",e)}removeCBOnVisContextData(e){return r.get().removeCBOn("VisuContextData",e)}addCBOnSceneEnvChanges(e){return r.get().addCBOn("VisuContextChanges",e)}createCSIVMRequestWithView(e){let t=this.getProcessor();if(!(void 0===e||void 0===e.node||void 0===e.serverNodeId||void 0===e.command||e.command&&""===e.command.command))return new a(e,t.onServerMessage.bind(t))}async reload(e,t=!1,i=!0){e||(e={}),this._clearProcessorOnReload&&r.get().clear();let n=new s.Parameters;return n.writeBool("noBroadCast",t),n.writeBool("clearCache",i),null!=this._sceneID?await this._sendFunctionCall({name:"csiSceneServiceReloadFunction",parameters:n}):(e.commandParameters=n,await this._sendCommandCall("CSIReloadViewCommand",e)),!0}async forceSend3DNoShowData(e){return null!=this._sceneID?await this._sendFunctionCall({name:"csiSceneServiceForceSend3DNoShowDataFunction"}):await this._sendCommandCall("CSIForceSend3DNoShowDataViewCommand",e),!0}async getTexturesFromUids(e){if(void 0!==e&&e.textureUids.length>0){this._onGetTextureFromUidsAnswer=e.onAnswer;let t=new s.Parameters;t.writeUint32Array(c.textureUids,e.textureUids);let i=await this._sendFunctionCall({name:"csiSceneGetTexturesFromUidsFunction",parameters:t});return this.onGetTextureFromUidsAnswer.bind(this)(i),!0}}async clearServerTextureCache(e){let t;return void 0!==e&&(t=await this._sendFunctionCall({name:"csiSceneClearTextureCacheFunction"}),e.onAnswer&&e.onAnswer(t)),!0}setCBOnCSICommunicationRequest(e){if(!e?.call)throw new Error("setCBOnCSICommunicationRequest need a function as input.");this._cbOnCSICommunicationRequest=e;const t=this.getCSICommunicationComponent();h.setCSIContext(t),r.get().subscribe(t)}getCSICommunicationComponent(){if(null==this._cbOnCSICommunicationRequest)throw new Error("setCBOnCSICommunicationRequest not called before");let e=this._cbOnCSICommunicationRequest();const t=e.node,i=e.serverNodeId;return null==t||null==i?e:Object.assign({},{subscribe:(e,r)=>t.subscribeToEvent(i,e,r),subscribeWithSubject:(e,r,s)=>t.subscribeToEventWithSubject(i,e,r,s),subscribeToEventWithSubject:(e,r,s)=>t.subscribeToEventWithSubject(i,r,e,s),unsubscribe:e=>t.unsubscribeFromEvent(e),unsubscribeFromEvent:e=>t.unsubscribeFromEvent(e),call:e=>{let r={};Object.assign(r,e,{destinationNodeId:i}),t.call(r)}},e)}reset(){this._cbOnCSICommunicationRequest=void 0}setSceneID(e){if(this._sceneID>0)throw new Error("FORBIDDEN SCENE ID MODIFICATION");if(isNaN(e))throw new Error("INVALID SCENE ID");this._sceneID=e}resetSceneID(e=!1){void 0!==this._sceneID&&(i.Remove(this),e&&r.get().clear(this._sceneID))}async initScene(e){null===i.Find(this)&&i.Add(this);await this._sendFunctionCall({name:"csiSceneServiceInitSynchroFunction"});return!0}async getCIDSupportType(e){let t=new s.Parameters;return t.writeUint32(c.sceneID,e),(await this._sendFunctionCall({name:"csiSceneServiceGetCIDSupportTypeFunction",parameters:t})).readUint8("cidSupportType")}async initSpecTree(){let e=0;for(;e++<5;){let e=new s.Parameters;try{return void await this._sendFunctionCall({name:"csiSceneServiceInitSpecTreeFunction",parameters:e})}catch(e){if(!(e instanceof C))throw e;console.warn("InitSpecTree returned with rc=E_FAIL, try again later..."),await new Promise((e=>setTimeout(e,100)))}}throw new Error("InitSpecTree failed after 5 attempts")}stopSpecTree(){if(this._sceneID)return this._sendFunctionCall({name:"csiSceneServiceStopSpecTreeFunction"})}onGetTextureFromUidsAnswer(e){if(e instanceof n&&void 0!==this._onGetTextureFromUidsAnswer){let t={};t.status=e.readBool("commandHasSucceeded");let i=e.readObjectArray("textureBuffers","CSIViewModelNamedBinaryBuffer")||[],r=e.readUint32Array(c.textureUids)||[];if(t.buffers={},i.length!=r.length)t.status=!1;else for(let e=0;e<i.length;++e)t.buffers[r[e]]=i[e];this._onGetTextureFromUidsAnswer(t)}}_sendCommandCall(e,t){let i,r;if(t&&t.node&&t.serverNodeId)i=t.node,r=t.serverNodeId;else if(this._cbOnCSICommunicationRequest){const e=this.getCSICommunicationComponent();e&&(i=e.node,r=e.serverNodeId)}return i&&r||console.error(`No way to communicate with CSI, cannot send request: ${e}`),new Promise((s=>{const n=new a({node:i,serverNodeId:r,command:{command:e,version:1,defaultCallback:s}},(e=>this.getProcessor().onServerMessage(e)));n.begin(),n.send(t.commandParameters),n.end()})).then((i=>{const r=i.readBool("commandHasSucceeded");return r||console.error(`Request ${e} returned RC=E_FAIL`),t.onAnswer&&t.onAnswer({status:r}),i}))}_sendFunctionCall(e){if(null==e||null==e.name)throw new Error("Not a valid command");return null==e.parameters&&(e.parameters=new s.Parameters),null!=this._sceneID&&e.parameters.writeUint32(c.sceneID,this._sceneID),this._answerDirectlyOnFunctionCall&&e.parameters.writeBool("answerNow",!0),new Promise(((t,i)=>{let r={};Object.assign(r,e,{version:1,onSuccess:t,onError:i}),this.getCSICommunicationComponent().call(r)})).then((t=>{if(!t.readBool("commandHasSucceeded"))throw new C(`Request ${e.name} with sceneID=${this._sceneID} returned RC=E_FAIL`);if(t.exists("view")){r.get().onServerMessage(t)}return e.onSuccess&&e.onSuccess(t),t})).catch((t=>{if(t instanceof s.Parameters)throw console.error(`Request ${e.name} with sceneID=${this._sceneID} has failed.`),e.onError&&e.onError(t),new Error(t.readString("error"));throw t}))}}return p})),define("DS/CSIViewModelWebProcessor/CSIVMClientVisuContextParameter",["DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebProcessor/CSIVMClientProcessor","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey","DS/CSIViewModelWebInterfaces/CSIVMClientSupportParameters","DS/CSIViewModelWebInterfaces/CSIVMClientViewMode","DS/CSIViewModelWebInterfaces/CSIVMClientAmbiance","DS/CSIViewModelWebInterfaces/CSIVMClientViewpoints","DS/CSIViewModelWebInterfaces/CSIVMClientPLMViewMode","DS/CSIViewModelWebInterfaces/CSIVMClientVisContextData"],(function(e,t,i,r,s,n,a,o,d,c,l){"use strict";function h(){return!1}function I(e){if(null==e)return null;const t={Ambiance:e.readObject(r.Ambiance,"CSIAmbiance"),Viewpoints:e.readObject(r.Viewpoints,"CSIViewpoints"),SupportParameters:e.readObject(r.SupportParameters,"CSISupportParameters"),ViewMode:e.readObject(r.ViewMode,"CSIViewMode"),PLMViewMode:e.readObject(r.PLMViewMode,"CSIPLMViewMode"),LineDefinitions:e.readString(r.LineDefinitions),sceneID:e.readUint32(r.sceneID)};if(null!=e.exists(r.ColorMap)&&(t.ColorMap=new Float32Array(e.readBuffer(r.ColorMap))),null!=e.exists(r.VisContextData)){const i=e.readParameters(r.VisContextData,"Parameters");t.VisContextData={};const s=i.begin(),n=i.end();for(;!s.equal(n);){const e=s.getName();t.VisContextData[e]=i.readObject(e,"CSIVisContextData"),s.next()}}return new u(t)}class u{constructor(e){e||(e={}),this._ambiance=e.Ambiance,this._viewpoints=e.Viewpoints,this._viewMode=e.ViewMode,this._colorMap=e.ColorMap,this._supportParameters=e.SupportParameters,this._plmViewMode=e.PLMViewMode,this._lineDefinitions=e.LineDefinitions,this._visContextData=e.VisContextData,this._sceneID=e.sceneID}getSceneId(){return this._sceneID}getAmbiance(){return this._ambiance}getViewpoints(){return this._viewpoints}getViewMode(){return this._viewMode}getColorMap(){return this._colorMap}getSupportParameters(){return this._supportParameters}getPLMViewMode(){return this._plmViewMode}getLineDefinitions(){return this._lineDefinitions}getVisContextData(){return this._visContextData}process(e,t){try{const t=e.getProcessor();let r=t.hasCbOnSceneEnv()?{}:void 0;const n={getUUID:()=>null,getViewType:()=>s.ViewType.View3D,getView3DType:()=>s.prototype.View3DType.View3D_Main,getSceneID:()=>this._sceneID},a=t.createTransactionOnIdent(n,new Map),o=i.createOperation({type:i.OperationsTypes.VisuContextUpdate,VisuContext:this});return a.doOperation(o),void 0!==r&&(this._colorMap&&(r.colorMap=this._colorMap),t.onSceneEnvChanges(r)),this._visContextData&&t.onVisContextData(this._visContextData),a}catch(e){t(e,`visuContext_scene${this._sceneID}`)}}static declareType(){e.declareType({type:"CSIVisuContextMessage",serialize:h,unserialize:I}),n.prototype.declareType(),a.prototype.declareType(),o.prototype.declareType(),d.prototype.declareType(),c.prototype.declareType(),l.prototype.declareType()}}return u})),define("DS/CSIViewModelWebProcessor/CSIVMClientViewParameter",["require","exports","DS/CSICommandBinder/CSICommandBinder","DS/CSIViewModelWebInterfaces/CSIViewModelWebEnv","DS/CSIViewModelWebInterfaces/CSIVMClientGraphicPropertyParameter","DS/CSIViewModelWebProcessor/CSIVMClientIdPatternParameter","DS/CSIViewModelWebInterfaces/CSIVMClientMaterialMessageParameter","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebInterfaces/CSIVMClientParameterLabels","DS/CSIViewModelWebInterfaces/CSIVMClientParameterVersion","DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey","DS/CSIViewModelWebProcessor/CSIVMClientTreeUpdateParameter","DS/CSIViewModelWebProcessor/CSIVMClientVisuContextParameter","DS/EKEventsWeb/EKEvents","CSIMathematics/CSIDeclareMathematics","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,s,n,a,o,d,c,l,h,I,u,C,p,S){"use strict";let _=!1;var m;!function(e){e[e.Unknown=0]="Unknown",e[e.Temporary=1]="Temporary",e[e.Permanent=2]="Permanent",e[e.Commit=3]="Commit",e[e.Abort=4]="Abort"}(m||(m={}));class b{constructor(e){this._idPatterns=[],this._createdObjects=new Map,this._viewStatus=e.viewStatus,this._viewVersion=e.viewVersion,_||(this._viewVersion!==c.currentVersion&&(console.error("****************************************"),console.error("           WARNING: 3DSync Issues       "),console.error("****************************************"),console.error(`Your server 3DSync code is currently build on version ${this._viewVersion}`),console.error(`Your web 3DSync code is currently on version ${c.currentVersion}`),console.error("This mismatch between version can create many unexpected behavior")),_=!0),this._idPatterns=e.idPatterns,this._graphicProperties=e.gas,this._treeUpdates=e.treeUpdates,this._visuContext=e.visuContext,this._texturesToBeRemovedFromCache=e.texturesToBeRemovedFromCache;for(const e of h.iterateOnTypes())this._createdObjects.set(e,new Map)}getViewStatus(){return this._viewStatus}getViewVersion(){return this._viewVersion}getIdPatterns(){return this._idPatterns}getGraphicProperties(){return this._graphicProperties}getTreeUpdates(){return this._treeUpdates}getVisuContext(){return this._visuContext}getCreatedObjects(){return this._createdObjects}getProcessor(){return this._processor}process(e,t,i,s){let n;this._processor=e,r.isEKPerfoTracesActivated()&&(n=C.Trace.traceStart(r.getEKPerfoProvider(),"web__csivmclientviewparameter_processvisucontext"));let a=[];if(this._visuContext){S.begin("CSIVMClientViewParameter::processVisuContext");for(const e of this._visuContext)i&&i.has(e._sceneID)||(t.hasVisuContextUpdate=!0,a.push(e.process(this,s)));S.end("CSIVMClientViewParameter::processVisuContext")}if(n&&n.End(),this._idPatterns){S.begin("CSIVMClientViewParameter::processIdPatterns");for(let e in this._idPatterns)try{let t=this._idPatterns[e];this._idPatterns[e]=t.process(this)}catch(e){s(e,"idPatterns")}S.end("CSIVMClientViewParameter::processIdPatterns")}if(this._treeUpdates){S.begin("CSIVMClientViewParameter::processAllTree");for(const e of this._treeUpdates)try{if(i&&i.has(e.getTreeKey().getSceneID()))continue;let r=e.process(this,s);a.push(r),t.hasUpdatedView=!0}catch(t){s(t,e.getTreeKey())}S.end("CSIVMClientViewParameter::processAllTree")}if(t.promises=[],a.length){S.begin("CSIVMClientViewParameter::endTransaction");for(const e of a)try{e.executeEnd()}catch(e){s(e)}S.end("CSIVMClientViewParameter::endTransaction");{let t;S.begin("CSIVMClientViewParameter::processCommit"),r.isEKPerfoTracesActivated()&&(t=C.Trace.traceStart(r.getEKPerfoProvider(),"web__csivmclientprocessor_commit"));for(const e of a)try{e.commit()}catch(e){s(e)}e.getModel().commit(),S.end("CSIVMClientViewParameter::processCommit"),t&&t.End()}S.begin("CSIVMClientViewParameter::ComputeDuality");for(const e of a)e.computeDuality();S.end("CSIVMClientViewParameter::ComputeDuality")}this.cleanTextureCache(e)}cleanTextureCache(e){if(this._texturesToBeRemovedFromCache&&this._texturesToBeRemovedFromCache.length>0){const t=e.getFirstView3DTreeKey();if(!t)return;const i=e.createTransaction(t),r=o.createOperation({type:o.OperationsTypes.RemoveTextureFromCache,TextureUids:this._texturesToBeRemovedFromCache});i.doOperation(r),i.executeEnd()}}static declareType(){p(i),i.declareType({type:"CSIViewParam",serialize:g,unserialize:w}),I.declareType(),n.declareType(),s.declareType(),a.prototype.declareType(),u.declareType(),l.declareType()}}function g(){return!1}function w(e){S.begin("CSIVMClientViewParameter::unserializeTreeUpdates");const t=e.readObjectArray(d.treeUpdates,"CSIViewTreeUpdateParam");S.end("CSIVMClientViewParameter::unserializeTreeUpdates"),S.begin("CSIVMClientViewParameter::unserializeVisuContext");const i=e.readObjectArray(d.VisuContextMessage,"CSIVisuContextMessage");S.end("CSIVMClientViewParameter::unserializeVisuContext"),S.begin("CSIVMClientViewParameter::unserializeOther");let r={viewStatus:e.readUint8(d.viewStatus),viewVersion:e.readUint32(d.viewVersion),gas:{},treeUpdates:t,visuContext:i,texturesToBeRemovedFromCache:e.readUint32Array(d.textureUids),idPatterns:{}},s=e.readObjectArray(d.idPatterns,"CSIViewModelIdPattern"),n=e.readObjectArray(d.graphicProperties,"CSIViewModelGraphicProperty"),a=e.readObject(d.materialMessage,"CSIViewModelMaterialMessage");if(s)for(let e=0;e<s.length;e++){let t=s[e];r.idPatterns[t.getId()]=t}if(n){let e,t;if(void 0!==a){let i=a.getMaterialJSON();void 0!==i&&(e=i.getJSON()),t=a.getMaterialBuffers()}for(let i=0;i<n.length;i++){let s=n[i];if(void 0!==s){let i=s.getMaterial();void 0!==i&&i.updateValues(e,t),r.gas[s.getId()]=s}}}return S.end("CSIVMClientViewParameter::unserializeOther"),new b(r)}return b}));