/*!  Copyright 2025 Dassault Systemes. All rights reserved. */
define("DS/SMAXCTSimVisuWeb/extensions/SMAECXPLegend3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu","DS/CoreEvents/Events","DS/SMAXCTSimBridge/DSXMBridge","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/CanvasNode","DS/SceneGraphNodes/CanvasNodeTexture"],(function(e,t,i,s,n,r,a,o){"use strict";return t.extend({init:function(){this._parent()},Dispose:function(){this._parent(),this._ddNode&&(this._ddNode.removeChildren(),this._ddNode=null)},Build:function(){this._parent(),this.setReady(!0)},_computePow:function(){let e=Math.pow(2048,2);return this._width&&this._height&&(e=Math.min(e,this._width*this._height)),Math.log(e/(this._height*this._width))/(2*Math.log(2))},_drawCanvasTexture:function(e,t,i,n){if(!this._textureImage)return;if(e!==this._legendCanvasNodeTexture)return;let r=this.QueryInterface("CATI3DExperienceObject");if(s.getSceneID(r)!==s.getCurrentSceneID())return;let a=t.canvas.width,o=t.canvas.height;const h=.3*o,d=o-1.5*h;let l,c,u;t.scale(1,1),t.setTransform(-1,0,0,-1,a,o),t.drawImage(this._textureImage,0,h,a,d-h),this._deformationScaleTexts.length>0?(l=this._deformationScaleTexts[this._deformationScaleTexts.length-1],c="Deformation Scale : "+l,u=this._name.length>=c.length?this._name:c):u=this._name;const _=function(e,t,i){let s=1,n=0;for(;;){if(i.font=`bold ${s}px Arial`,n=i.measureText(e).width,n>t)return s-1;s++}}(u,a,t);t.font=`bold ${_}px Arial`,t.fillStyle=this._color?`rgba(${this._color[0]}, ${this._color[1]}, ${this._color[2]}, ${this._color[3]})`:"black",t.textAlign="left",t.textBaseline="top",t.fillText(this._name,0,0),t.textBaseline="bottom",t.textAlign="left",t.fillText(this._minText,0,d+_),t.textAlign="right",t.fillText(this._maxText,a,d+_),c&&(t.textAlign="left",t.fillText(c,0,d+2*_))},_create3DImage:function(){this._legendCanvasNodeTexture=new o({width:this._width,height:this._height,rectangleTexture:!0,drawCB:this._drawCanvasTexture.bind(this),alphaTest:0,materialParams:{opacity:1,depthTest:!0,depthWrite:!0,polygonOffset:!0,polygonOffsetFactor:-10,polygonOffsetUnits:-10}}),this._legendCanvasNodeTexture.maxPow=this._computePow();let e=new a({name:this._name,side:n.DoubleSide,widthVector:new n.Vector3(this._width,0,0),heightVector:new n.Vector3(0,this._height,0),bottomLeftcorner:new n.Vector3(-this._width/2,-this._height/2,0),canvasNodeTexture:this._legendCanvasNodeTexture},r),t=new n.Sphere;t.center=new n.Vector3(this._width/2,this._height/2,0),t.radius=Math.sqrt(Math.pow(.5*this._width,2)+Math.pow(.5*this._height,2));let i=e.getBoundingBox();return e.forceBoundingElements(!0,{sphere:t,box:i},{sphere:t,box:i}),e},_refreshProperties:function(e,t){this._textureImage=new Image;let i=t.stream.getBlobUrl();if(this._textureImage.src=i,this._width=e.GetValueByName("width"),this._height=e.GetValueByName("height"),this._name=t.title,this._min=t.minValue,this._minText=isNaN(this._min)?"":this._min.toPrecision(3),this._max=t.maxValue,this._maxText=isNaN(this._max)?"":this._max.toPrecision(3),this._deformationScaleTexts=t.deformationScales.filter((e=>!isNaN(e)&&e>0)).map((e=>e.toPrecision(3))),e.HasVariable("textColor")&&(this._color=e.GetValueByName("textColor")),!this._color){var s=e.GetParent()._experienceBase.getManager("CAT3DXVisuManager").getViewer().getColorFromColorMap(n.COLORMAP_INDEX.BACKGROUND);this._color=.2126*(r=s).r+.7152*r.g+.0722*r.b>.5?[0,0,0,1]:[1,1,1,1]}var r},_Fill:function(e){this._parent(e);let t=this.QueryInterface("CATI3DExperienceObject"),n=t.GetValueByName("_varName"),r=t.GetObject().GetID();s.setCurrentSceneID(s.getSceneID(t));let a=null;if(s.getLegendDescriptionFromECDM(t).catch((e=>{console.warn(" ! SMAXCT DD GeoVisu - getLegendDescriptionFromECDM rejected !")})).then((i=>{if(i){a=i,this._refreshProperties(t,i);let s=this._create3DImage();s.setName(this._name),e.addChild(s),this._ddNode=s,this.setReady(!0)}})),!a){let s="EC_INTEGRATION_CONTEXT",o="EC_DM_LEGEND_LOADED_CB_"+n;this[o]=i.subscribe({event:s+"/DSXMBRIDGE/ECDM_LEGEND_LOADED_"+r},(s=>{i.unsubscribe(this[o]),a=s.legendDescription,this._refreshProperties(t,a);let n=this._create3DImage();n.setName(this._name),e.addChild(n),this._ddNode=n,this.setReady(!0)}))}},isReady:function(){return this._ready},setReady:function(e){e!==this._ready&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))}})})),define("DS/SMAXCTSimVisuWeb/extensions/SMAECXPSimulation3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu","DS/SMAXCTSimBridge/DSXMBridge"],(function(e,t,i){"use strict";return t.extend({init:function(){this._parent()},Dispose:function(){let e=this.QueryInterface("CATI3DExperienceObject");if(e){let t=i.getActorID(e);i.remove({id:t})}this._parent()},_Fill:function(e){this._parent(e);let t=this.QueryInterface("CATI3DExperienceObject"),s=i.getActorID(t);switch(i.getLWDataModelState(s)){case i.LW_DM_STATE_NOTCREATED:i.loadDataModel({assetId:s,experienceObject:t}).then((()=>{this.setReady(!0)}));break;case i.LW_DM_STATE_LOADING:break;case i.LW_DM_STATE_LOADED:this.setReady(!0)}}})})),define("DS/SMAXCTSimVisuWeb/extensions/SMAECXPDataDisplay3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu","DS/SMAXCTSimBridge/DSXMBridge"],(function(e,t,i){"use strict";return t.extend({init:function(){this._parent(),this._modelLoaded=!1},Dispose:function(){this._parent(),this._ddNode&&(this._ddNode.removeChildren(),this._ddNode=null)},GetNode:function(){return this._parent()},isReady:function(){return this._ready},_Fill:function(e){this._parent(e);let t=this.QueryInterface("CATI3DExperienceObject");i.getDataDisplay3DNode(t,e).catch((()=>{console.warn(" ! SMAXCT DD GeoVisu - getDataDisplay3DNode rejected !")})).then((e=>{this._ddNode=e,e&&(this.RequestVisuRefresh(),this.setReady(!0))}))},_refreshChildrenNodes:function(){this._parent()},GetLocalNodes:function(){return this._ddNode},_isDataDisplayVisuLoaded:function(){if(!this._localVisuLoaded){let e=this.QueryInterface("CATI3DExperienceObject");this._localVisuLoaded=i.isDataDisplayVisuLoaded(e)}return this._localVisuLoaded},setReady:function(e){if(e!==this._ready){if(e){if(!this._isAllChildrenReady())return;if(!this._isDataDisplayVisuLoaded())return}this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e)}},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(let e=0;e<t.length;e++){let i=t[e].QueryInterface("CATI3DGeoVisu");if(i&&!i.isReady())return!1}}return!0}})})),define("DS/SMAXCTSimVisuWeb/extensions/SMAECXP3DElement3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu","DS/SMAXCTSimBridge/DSXMBridge"],(function(e,t,i){"use strict";return t.extend({init:function(){this._parent()},Dispose:function(){this._parent(),this._elm3DNode&&(this._elm3DNode.removeChildren(),this._elm3DNode=null)},GetNode:function(){return this._parent()},Build:function(){this._parent()},isReady:function(){return this._ready},_Fill:function(e){this._parent(e);let t=this.QueryInterface("CATI3DExperienceObject");i.get3DElement3DNode(t,e).catch((()=>{console.warn(" ! SMAXCT 3DElement GeoVisu - get3DElement3DNode rejected !")})).then((e=>{this._elm3DNode=e,e&&(this.RequestVisuRefresh(),this.setReady(!0))}))},GetLocalNodes:function(){return this._elm3DNode},setReady:function(e){e!==this._ready&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))}})})),define("DS/SMAXCTSimVisuWeb/extensions/SMAECXPSimulationSeq3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu"],(function(e,t){"use strict";return t.extend({init:function(){this._parent()},Build:function(){this._parent()}})}));