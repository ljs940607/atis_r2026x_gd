/*!  COPYRIGHT DASSAULT SYSTEMES 2020   */
define("DS/ViewerCommandsExt/ViewerScreenshotUtils",[],(function(){"use strict";function e(){return"object"==typeof e.instance?e.instance:(e.instance=this,this)}return e.prototype.saveScreenshot=function(e){this._viewer=e.viewer,this.__pictureFlash(e).then(this.__getScreenShot.bind(this)).then((t=>{this.__downloadSreenShot(t,e.filenamePrefix)}))},e.prototype.b64Screenshot=function(e){return new Promise((t=>{this._viewer=e.viewer,this.__pictureFlash(e).then(this.__getScreenShot.bind(this)).then(t).catch((()=>{t("")}))}))},e.prototype.__pictureFlash=function(e){return new Promise((t=>{if(e&&!0===e.noBlink)t();else{const i=this._viewer.getContent().getParent(),n=new UWA.Element("div",{id:"_ViewScreenShot-Flash",styles:{position:"absolute",top:0,left:0,width:this._viewer.SCREEN_WIDTH+"px",height:this._viewer.SCREEN_HEIGHT+"px","z-index":"100002","background-color":"white"}}).inject(i);let o=1;const h=()=>{o-=.02,n.setStyle("opacity",o),o<0?(i.removeChild(n),e&&e.flashturnoffcb&&"function"==typeof e.flashturnoffcb&&e.flashturnoffcb()):requestAnimationFrame(h)};h(),t()}}))},e.prototype.__getScreenShot=function(e,t){return new Promise((i=>{this._viewer.save&&this._viewer.save();var n=document.createElement("CANVAS"),o=n.getContext("2d"),h=this._viewer.currentViewpoint,r={data:null,width:this._viewer.SCREEN_WIDTH,height:this._viewer.SCREEN_HEIGHT};n.width=e||r.width,n.height=t||r.height,h.getControl().update(),this._viewer.renderToTarget(r,h);var a=o.getImageData(0,0,n.width,n.height);a.width!==n.width&&(console.error("ViewerScreenshot:: Image width not matching with canvas width"),i(void 0)),a.height!==n.height&&(console.error("ViewerScreenshot:: Image height not matching with canvas height"),i(void 0));var s=(r.width-1)/(a.width-1),c=(r.height-1)/(a.height-1),d=r.data,w=a.data,l=function(e,t,i,n,o){return o?(t=n-t,i*Math.floor(t-1)+Math.floor(e)):i*Math.floor(t)+Math.floor(e)};if(1===s&&1===c)for(var f=a.height,g=a.width,u=4*g,_=0;_<f;++_)for(var v=_*g*4,p=(f-_)*g*4,m=u;m>0;--m)w[v+m]=d[p+m];else{var S=a.height,b=a.width;for(_=0;_<S;++_)for(m=0;m<b;++m){v=4*l(m,_,a.width,a.height,!1),p=4*l(m,_,r.width,r.height,!0);w[v]=d[p],w[v+1]=d[p+1],w[v+2]=d[p+2],w[v+3]=d[p+3]}}o.putImageData(a,0,0,0,0,n.width,n.height),i(n.toDataURL("image/png"))}))},e.prototype.__downloadSreenShot=function(e,t){if("download"in document.createElement("a")){var i=this.__toBlob(e),n=t?t+".png":"Viewer_Screenshot.png",o=new UWA.Element("a",{href:i,download:n,styles:{visibility:"hidden"}}).inject(document.body);o.click(),document.body.removeChild(o)}else console.warn("Unsupported device for this device")},e.prototype.__toBlob=function(e){for(var t=e.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),i=atob(t[3]),n=new ArrayBuffer(i.length),o=new Uint8Array(n),h=0;h<o.length;++h)o[h]=i.charCodeAt(h);var r=new Blob([o],{type:t[1]});return window.URL.createObjectURL(r)},new e}));