/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATW3DMoveManager/CATW3DMoveManager",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/Visualization/PathElement","DS/Visualization/IdPath","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,r,o,a,i,l){"use strict";var s=["PPRContext","Drawing"],c=!1;function u(t){var n=[];return t&&t.modelController?(n.modelController=t.modelController,n.isIn=function(e){var t;return this.some((function(n){return t=n.path.isEqual(e)?n:null})),t},n.initMove=function(e){var t=this.isIn(e);return t||(t={path:e.clone(),lockedID:l.getNodeID(e.getLastElement(!0).children[0])},this.modelController.lockNodes({ids:[t.lockedID]}),this.push(t)),t},n.addMove=function(e){var t=this.isIn(e);return t&&(t.moved=!0,t.hasOwnProperty("isLocked")||(t.isLocked=!1)),t},n.clean=function(e){var t=(e||this).map((function(e){var t=e.lockedID;return delete e.lockedID,t})).filter((function(e){return e}));t.length&&this.modelController.unlockNodes({ids:t})},n):(e.log("Creation fails"),n)}function d(e){return e&&l.isInstance(e)}var f=t.extend({init:function(e){var t,f,v,h,g,m,p=this,M=new n,x=e.context,P=[],D=new u({modelController:x.getController()}),b="Persistent",w=[],E=e.saveToDatabase,I=!1;function C(e){var t=e.externalPath.map((function(e){return l.getNodeID(e)})).filter((function(e){return e}));return t.unshift(v),new o(t)}function S(e){var n,r;if(e&&e.path){t?-1===t.getSceneGraphOverrideSetIndex(f)&&t.pushSceneGraphOverrideSet(f):(v=x.getController().getRootBagId(),t=x.getViewer().getSceneGraphOverrideSetManager(),f=new i(x.getController().getRootBag(),v),t.pushSceneGraphOverrideSet(f));var o=C(e.path);if((n=f.getUniqueOverrideFromIdPath(o))||(n=f.createIdPathOverride({idPathes:[o]})),e.transformation)r=(new a.Matrix4).copy(e.initWorldMatrix).multiply(e.transformation);else{if(e.leafMatrix)return n.setPosition(e.leafMatrix),0;if(e.worldMatrix)r=e.worldMatrix;else if(e.vector){var l=(new a.Vector3).getPositionFromMatrix(e.initWorldMatrix).add(e.vector);r=(new a.Matrix4).copy(e.initWorldMatrix).setPosition(l)}else if(e.axis&&e.center&&void 0!==e.angle){var s=(new a.Matrix4).copy(e.initWorldMatrix),c=(new a.Matrix4).makeRotationAxis(e.axis,e.angle),u=(new a.Matrix4).setPosition(e.center),d=(new a.Matrix4).getInverse(u).multiply(s),h=(new a.Matrix4).copy(c).multiply(d);r=(new a.Matrix4).copy(u).multiply(h)}}if(r){var g=(new a.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix());return n.setPosition(g.multiply(r)),0}}}function L(){x&&(D&&D.clean(),D=new u({modelController:x.getController()}),P=[],b=null,f&&f.deleteOverrides(f.getOverrides()),x.getViewer().render())}function k(e){var t=[];e.forEach((function(e){if(e.moved){var n={};t.push(n),n.path=e.path,n.currentMatrix=e.path.getMatrix(),n.isLocked=e.isLocked;var r=f?f.getUniqueOverrideFromIdPath(C(e.path)):null;r&&r.setPosition(null),delete e.moved,delete e.isLocked}})),M.publish({event:"onCancelMove",data:{objectsCancelled:t,bEmptyMove:!D.some((function(e){return e.moved})),someMovedObjectsAreLocked:D.some((function(e){return e.isLocked}))}}),x&&(x.getViewer().render(),x.publish({event:"onModelUpdated",data:{rootNodes:x.getRoots()}})),c=!1}function O(){for(var e=[],t=D.length-1;t>=0;--t){var n=D[t];n.moved&&(e.push(n),D.splice(t,1))}k(e),D.clean(e),L()}function R(e){var t=[];return e.forEach((function(e){if(e.path||e.pathElement){var n=p.getSubPathToMovable(e.path||e.pathElement);!n||t.some((function(e){return e.path.isEqual(n)}))||t.push({path:n})}})),t}w.push(x.subscribe({event:"onRootRemoved"},(function(e){var t=[],n=new u({modelController:x.getController()});D.forEach((function(r){r.path&&(l.getNodeID(r.path.externalPath[1])!==e.id?n.push(r):t.push(r))})),n.length!==D.length&&(k(t),D.clean(t),D=n)}))),w.push(x.subscribe({event:"onEndDelete"},(function(e){for(var t=[],n=e.pathToReparent,r=D.length-1;r>=0;--r){var o=D[r];o.path.externalPath.some((function(e){return l.getNodeID(e)===n}))&&(t.push(o),D.splice(r,1))}k(t),D.clean(t)}))),w.push(x.subscribe({event:"onBeginReparent"},(function(){O()}))),w.push(x.subscribe({event:"onEndMatriceUpdate"},(function(){O()}))),require(["DS/UPSCommands/UPSCmdUtils"],(function(e){h=e})),this.cancelLocked=function(){!function(){for(var e=[],t=D.length-1;t>=0;--t){var n=D[t];n.isLocked&&(e.push(n),D.splice(t,1))}k(e),D.clean(e)}()},this.onMoveBegin=function(e){if(I=!0,P=[],e&&e.objectsMoved&&e.from&&e.moveMode&&("Persistent"===e.moveMode||"Transient"===e.moveMode)){b=e.moveMode,g=void 0,m=void 0;var t=R(e.objectsMoved);t.forEach((function(t){var n={path:t.path,beforeMoveMatrix:t.path.getMatrix(),initWorldMatrix:t.path.getWorldMatrix()};e.axis&&e.center?(n.axis=e.axis,n.center=e.center,n.angle=0):n.vector=new a.Vector3,P.push(n),D.initMove(t.path)})),M.publish({event:"MoveBegin",data:{objectsMoved:t,from:e.from,moveMode:b}})}},this.onMove=function(e){if(I=!0,e&&e.objectsMoved&&e.from&&(e.vector||void 0!==e.angle||e.transformation||e.leafMatrix||e.worldMatrix)&&("Persistent"===b||"Transient"===b)){if(e.transformation||e.leafMatrix||e.worldMatrix)g=void 0,m=void 0;else if(void 0===g&&e.vector)g=new a.Vector3;else if(void 0===m&&void 0!==e.angle)m=0;else if(m&&void 0===e.angle||g&&void 0===e.vector)return;var t,n,r=R(e.objectsMoved);g?(t=(new a.Vector3).subVectors(e.vector,g),g=(new a.Vector3).copy(e.vector)):void 0!==m&&(n=e.angle-m,m=e.angle);var o=!1;r.forEach((function(r){P.some((function(a){return!!r.path.isEqual(a.path)&&(e.transformation?(a.transformation=e.transformation,a.vector=a.angle=a.leafMatrix=a.worldMatrix=void 0):e.leafMatrix?(a.leafMatrix=e.leafMatrix,a.vector=a.angle=a.transformation=a.worldMatrix=void 0):e.worldMatrix?(a.worldMatrix=e.worldMatrix,a.vector=a.angle=a.transformation=a.leafMatrix=void 0):a.vector?(a.vector.add(t),a.transformation=a.leafMatrix=a.worldMatrix=void 0):a.axis&&void 0!==a.axis&&(a.angle+=n,a.transformation=a.leafMatrix=a.worldMatrix=void 0),("Transient"===b||"Persistent"===b&&0===S(a))&&(o=!0),!0)}))})),r.length>0&&"Persistent"===b&&r.forEach((function(e){d(e.path.getLastElement(!0))&&(D.addMove(e.path),D.bPersistantMoved=!0)})),o&&M.publish({event:"Move",data:{objectsMoved:r,from:e.from,moveMode:b}})}},this.onMoveEnd=function(e){if(I=!1,e&&e.from&&e.status&&("Persistent"===b||"Transient"===b)){if("Persistent"===b&&"Cancelled"===e.status)P.forEach((function(e){var t=f.getUniqueOverrideFromIdPath(C(e.path));t&&t.setPosition(e.beforeMoveMatrix)}));else if("Transient"===b&&"Moved"===e.status){var t=[];if(P.forEach((function(e){if(0===S(e)){var n={path:e.path.clone()};t.push(n)}})),t.length>0){var n={objectsMoved:[],from:e.from,moveMode:"Persistent"};t.forEach((function(e){if(d(e.path.getLastElement(!0))){var t=D.addMove(e.path);t&&n.objectsMoved.push(t)}})),M.publish({event:"Move",data:n})}}M.publish({event:"MoveEnd",data:{from:e.from,status:e.status}}),x.publish({event:"onModelUpdated",data:{rootNodes:x.getRoots()}}),P=[]}},this.isMoving=function(){return I},this.subscribe=function(e,t){var n;return"MoveBegin"!==e&&"Move"!==e&&"MoveEnd"!==e&&"onValidateMove"!==e&&"onCancelMove"!==e||(n=M.subscribe({event:e},t)),n},this.unsubscribe=function(e){M.unsubscribe(e)},this.getSubPathToMovable=function(e){if(e){for(var t=new r(e.externalPath);t&&!d(t.getLastElement(!0));)t=t.getParentPath();if(t){var n=t.externalPath.length>1?l.getNodeType(t.externalPath[t.externalPath.length-2]):"";s.indexOf(n)>-1&&(t=null)}return t}},this.terminateMove=function(e){!0===e.save?function(){if(!c){var e=[],t=[],n=[],r={};if(c=!0,D.forEach((function(n){if(n.moved){var r={};(n.isLocked?e:t).push(r),r.instanceId=l.getNodeID(n.path.getLastElement(!0)),r.path=n.path,r.currentMatrix=n.path.getMatrix(),r.isLocked=n.isLocked,delete n.moved,delete n.isLocked}})),!E)return M.publish({event:"onValidateMove",data:{objectsMoved:t.map((function(e){return{pathElement:e.path,worldMatrix:e.path.getWorldMatrix()}})),eventID:"success"}}),L(),void(c=!1);(r={onComplete:function(e){"success"===e.status?(e.results&&e.results.length&&e.results.forEach((function(e){"success"!==e.status&&window.console.log("Whole transaction is OK but it fails for an instance. Unexpected!!"),e.instanceOut&&e.instance&&e.instance!==e.instanceOut&&n.push({oldId:e.instance,newId:e.instanceOut})})),t.length&&x.getController().switchAuthoringMode(!0,!0,"PADSession_disabling_index_authoring"),t.forEach((function(e){!0===require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_lightNodeModel")?x.getController().updateInstance(e.instanceId,{matrix:e.currentMatrix}):e.path.getLastElement(!0).setMatrix(e.currentMatrix)})),n.length?x.getController().replaceInstances({data:n},{onComplete:o,onFailure:function(){window.console.log("An id has no node associated. Unexpected!!"),o()}}):o()):a()},onFailure:a,instances:t.map((function(e){return{instance:e.instanceId,hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map((function(t){return e.currentMatrix.elements[t]}))}}))}).instances.length?h.move3D(r):o()}function o(){if(M.publish({event:"onValidateMove",data:{objectsMoved:t,objectsCancelled:e,splitInstances:n,eventID:"success"}}),x.getController().onMove3D&&Array.isArray(r.instances)){var o=r.instances.filter((function(e){return!n.some((function(t){return t.oldId===e.instance}))}));o.length&&x.getController().onMove3D({instances:o})}L(),t.length&&x.getController().forceRefresh(),c=!1}function a(){L(),M.publish({event:"onValidateMove",data:{objectsMoved:[],objectsCancelled:e.concat(t),eventID:"error"}}),c=!1}}():O()},this.isPathLocked=function(e){if(!e||!e.pathElement||!e.onCompleted)return{returnCode:-1};var t,n=e.pathElement.getLastElement(!0);if(l.getRoots(x).some((function(e){return e===n})))return t={returnCode:0,pathElement:e.pathElement,isLocked:!1},setTimeout((function(){e.onCompleted(t)}),0),t;if(!l.isInstance(n))return{returnCode:-2};t={returnCode:0};var r=D.isIn(e.pathElement);return r&&r.hasOwnProperty("isLocked")?(t.pathElement=e.pathElement,t.isLocked=r.isLocked,setTimeout((function(){e.onCompleted({pathElement:e.pathElement,isLocked:r.isLocked})}),0)):(r||(r=D.initMove(e.pathElement)),r.isLocked=!1,t.pathElement=e.pathElement,t.isLocked=r.isLocked,setTimeout((function(){e.onCompleted({pathElement:e.pathElement,isLocked:r.isLocked})}),0)),t},this._destroy=function(){w.forEach((function(e){x.unsubscribe(e)})),w=[],O(),L(),f&&t&&t.removeSceneGraphOverrideSet(f),x=t=p=null}}}),v=[],h=0;return t.singleton({init:function(){},giveMoveManager:function(e){var t;return e&&e.context&&v.some((function(n){if(n.context===e.context)return t=n.moveManager,!0})),t},getMoveManager:function(e){var t;if(e&&e.context&&(v.some((function(n){if(n.context===e.context)return t=n.moveManager,h++,!0})),!t)){var n=new f(e);v.push({context:e.context,moveManager:n}),t=n,h=1}return t},unreferenceMoveManager:function(e){v.some((function(t,n){return t.context===e.context&&0===--h&&(v.splice(n,1),t.moveManager._destroy(),!0)}))}})})),define("DS/CATW3DMoveManager/CATW3DMoveReferent",["UWA/Class","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CATW3DMoveManager/assets/nls/CATW3DMoveReferent"],(function(e,t,n,r){"use strict";var o=["PPRContext","Drawing"],a="defaultMoveReferent",i="moveLeafPart",l="C3DAllowDirectManipulation",s="FirstLevel";function c(e){return e&&n.isPLMNode(e)}function u(e){return e&&n.isReference(e)}function d(e){return e&&n.isInstance(e)}function f(e){if(!e||!e.externalPath||0===e.externalPath.length||e.internalPath&&e.internalPath.length)return!1;if(!c(e.externalPath[e.externalPath.length-1]))return!1;for(var t=e.externalPath.length-2;t>=0;--t)if(c(e.externalPath[t]))return!1;return!0}function v(e){if(e&&e.externalPath)for(var t=0;t<e.externalPath.length;t++){var n=e.externalPath[t];if(c(n))return n}}var h=e.extend({init:function(e){var r={},a=e.context;n.getRoots(a).forEach((function(e){r[n.getNodeID(e)]=[]})),a.subscribe({event:"onRootAdded"},(function(e){e&&e.id&&(r[e.id]=[])})),a.subscribe({event:"onRootRemoved"},(function(e){e&&e.id&&delete r[e.id]})),this.addMoveReferent=function(e){var t,o,a,i,l,s,c,h=!1;if(!f(e)&&(t=v(e))&&(o=n.getNodeID(t))&&r[o])for(a=r[o],s=e.externalPath.length-1;s>=0;--s)if(c=e.externalPath[s],h)u(c)&&-1!==(l=a.indexOf(n.getNodeID(c)))&&a.splice(l,1);else if(d(c)){var g=c.children&&c.children.length?c.children[0]:null;if(!g||!u(g))return;i=n.getNodeID(g),-1===a.indexOf(i)&&a.push(i),h=!0}},this.getMoveReferent=function(e){if(e){var a;if(f(e))a=null;else{a=new t;var l=this.getSubPathToMovable(e),c=v(l),h=n.getNodeID(c);if(!h||!r[h])return;var g,m=r[h],p=!1;for(g=0;g<l.externalPath.length;g++){var M=l.externalPath[g];if(d(M)){var x=M.children[0],P=n.getNodeID(x);m.indexOf(P)>-1&&(p=!0)}if(a.addElement(M),p)break}if(!p){var D=!1,b=i!==s&&"moveFirstLevel"!==i;for(g=b?a.externalPath.length-1:0;b?g>=0:g<a.externalPath.length;b?--g:++g){var w=a.externalPath[g];if(u(w)&&o.indexOf(n.getNodeType(w))>-1)g++;else if(d(w)){D=!0,a.externalPath.length=g+1;break}}D||(a=null)}}return a}},this.getSubPathToMovable=function(e){if(!e)return;var r,i=new t(e.externalPath);let l=a.getController().getReadOnlyRootIds();if(l.length){let e=i.externalPath.map((function(e){return e.modelIdentification}));for(var s=0;s<l.length;s++)if(e.indexOf(l[s])>=0)return null}if(i&&!0===require("DS/PADUtils/PADSettingsMgt").getSetting("activateSGI")){for(var f=i.externalPath,v=f.length,h=new t,g=0;g<v&&(!f[g].userData||!f[g].userData.type||"VPMRepInstance"!==f[g].userData.type);g++)h.addElement(i.getElement(g));i=h}for(;i&&!d(i.getLastElement(!0));)i=i.getParentPath();if(i){var m=i.externalPath.length>1?n.getNodeType(i.externalPath[i.externalPath.length-2]):"";o.indexOf(m)>-1&&(i=null)}i||(r=new t,e.externalPath.some((function(e){return r.addElement(e),u(e)}))&&(i=r));i||(r=new t,e.externalPath.some((function(e){return r.addElement(e),c(e)}))&&(i=r));return i}}}),g=[];return e.singleton({init:function(){},getPreferencesDefinition:function(){return[{nls:r.title,id:"W3MprefMove",type:"section",preferences:[{nls:r.allowDirectManipulation,id:l,type:"checkbox",setValue:function(e){e!==("true"===localStorage.getItem(l))&&localStorage.setItem(l,e?"true":"false")},getValue:function(){return"true"===localStorage.getItem(l)},getDefaultValue:function(){return!1}},{nls:r.moveSection,type:"radio",id:a,options:[{id:"moveFirstLevel",nls:r.first},{id:"moveLeafPart",nls:r.leaf}],setValue:function(e){"moveFirstLevel"===e?localStorage.setItem(a,s):localStorage.removeItem(a)},getValue:function(){return localStorage.getItem(a)===s?"moveFirstLevel":"moveLeafPart"},getDefaultValue:function(){return"moveLeafPart"}}]}]},getMoveReferentManager:function(e){var t;if(e&&e.context&&(g.some((function(n){return n.context===e.context&&(t=n.moveReferent,!0)})),!t)){var n=new h(e);g.push({context:e.context,moveReferent:n}),t=n}return t},setMoveReferentDefault:function(e){i=e}})}));