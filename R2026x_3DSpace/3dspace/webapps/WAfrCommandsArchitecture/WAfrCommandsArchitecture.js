define("DS/WAfrCommandsArchitecture/mod_CommandsManagerComponent",["DS/WAfrHandlers/private/private_CommandHandlerUtilities","DS/WAfrHandlers/mod_HandlerComponent","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/CoreUtilities/ErrorManagement","DS/WAfrUtils/mod_Performances","DS/WAfrUtils/Logger","DS/Utilities/UUID","DS/WAfrModelEvents/mod_ModelEvents"],(function(e,n,a,t,r,d,c,i,o){"use strict";const m=o.DEFAULT_COMPONENT_NAME,s={DYNAMIC_COMMAND_CANCELED:"Dynamic Command Canceled",COMPUTE_COMMAND_MODE_FAILED:"Dynamic Command Mode computation failed",CLIENT_COMPUTE_COMMAND_MODE_FAILED:"Applicative Code for Dynamic Command Mode computation failed"};let l=[r.generateReturnValue("COMMAND_NOT_STARTED",!1)],_=r.getErrorManager(l,{merge:!1});var u={exclusiveCmdCalled:0,secondExecuteCalled:1,killedByInfra:2,askedByCmd:3};const p={CANCELED:"Canceled",VALIDATED:"Validated"};function v(e){const n=e.getI18n?.()?e.getI18n():null;return{pd1:e._private._cmdUUID,pd2:n?n.title:"None",pd3:e._private._handlerTrigger}}var g=!1;function C(e,n){g&&console.log(n+" : "+e)}let E=!1;function h(e){if(e.commandHandlerId){if(!e.executionCtx)throw new Error("mod_commandsManagerComponent.js cannot execute a command without an execution context");var a=e.executionCtx.getComponent(n.DEFAULT_COMPONENT_NAME);if(!a)throw new Error("mod_commandsManagerComponent.js cannot execute a command without a handler component registered on the execution context");a.executeHandler({id:e.commandHandlerId})}}function M(n){if(n.cmdsManager._private._runningCmd)throw new Error("CmdsManager.runNextCmd a command is already running");if(n.cmdsManager._private._currentExecutionDone){var a;if(n.cmdsManager._private._executionChain.length>0&&(a=n.cmdsManager._private._executionChain[0].caller.cmdHandler),n.cmdsManager._private._pausedCmds.length>0&&(!n.cmdsManager._private._waitingExecution||a===n.cmdsManager._private._pausedCmds[0]||a.getMode()!==e.CmdMode.NESTED)){var t=Object.create(null);return t.cmdsManager=n.cmdsManager,t.cmdHandler=n.cmdsManager._private._pausedCmds.pop(),void function(n){C("resume",n.cmdHandler.getId()),n.cmdHandler.setStateAndSendEvent({state:e.HandlerState.EXECUTING,event:e.LifeCycleEvents.RESUME}),n.cmdsManager._private._runningCmd=n.cmdHandler,n.cmdHandler._private._command._instance.resumeExecute?(n.cmdHandler._private._command._instance.done=L.bind(n),b({callback:n.cmdHandler._private._command._instance.resumeExecute,caller:n.cmdHandler._private._command._instance})):b({callback:L,caller:n});if(b({callback:function(){n.cmdsManager._private._currentExecutionDone&&f(n.cmdHandler)&&S.call(n.cmdsManager)}}),n.cmdsManager._private._modelEvents.publish({event:n.cmdHandler.getId()+"/resume"}),n.cmdsManager._private._modelEvents.publish({event:"resume",data:n.cmdHandler.getId()}),n.cmdHandler){const e=v(n.cmdHandler),a=n.cmdsManager.getExecutionContext?.()?n.cmdsManager.getExecutionContext():null,t=a.getSourceApp?.()?a.getSourceApp():null,r={id:n.cmdHandler.getId()?n.cmdHandler.getId():"",appID:t?.getId()||"",pds:e},d=a.getComponent(m);d?d.publish({event:"command_resume",data:r}):console.error("Model events is undefined")}}(t)}if(0===n.cmdsManager._private._waitingExecution&&n.cmdsManager._private._currentExecutionDone){var r=n.cmdsManager.getDefaultCommand();r&&h({commandHandlerId:r,executionCtx:n.cmdsManager.getExecutionContext()})}setTimeout((function(){n.cmdsManager._private._waitingExecution||n.cmdsManager._private._executionChain.length>0?S.call(n.cmdsManager):n.cmdsManager._private._currentExecution&&n.cmdsManager._private._currentExecutionDone&&(n.cmdsManager._private._currentExecution=null)}),0)}}function f(n){return n.getState()===e.HandlerState.EXECUTING}var H=new Array(50),x=0;function D(){for(var e=0;e<x;e+=3){var n=H[e],a=H[e+1],t=H[e+2];n.call(a,t),H[e]=void 0,H[e+1]=void 0,H[e+2]=void 0}x=0}function b(e){H[x]=e.callback,H[x+1]=e.caller,H[x+2]=e.arg,3===(x+=3)&&setTimeout(D,0)}function A(e){if(!e.caller.cmdsManager._private._currentExecutionDone)throw new Error("begin forbidden");return e.caller.cmdsManager._private._waitingExecution--,e.caller.cmdsManager._private._currentExecutionDone=!1,setTimeout((function(){e.callback.call(void 0,e.caller)}),0),e.caller}function I(n){var a;if(n.caller.cmdHandler.getState()!==e.HandlerState.PAUSED)return n.caller.cmdsManager._private._runningCmd&&n.caller.cmdsManager._private._runningCmd!==n.caller.cmdHandler&&f(n.caller.cmdsManager._private._runningCmd)&&(n.caller.cmdsManager._private._waitingExecution++,(a=Object.create(null)).caller=Object.create(null),a.caller.cmdsManager=n.caller.cmdsManager,a.caller.cmdHandler=n.caller.cmdsManager._private._runningCmd,n.caller.cmdHandler.getMode()===e.CmdMode.EXCLUSIVE||!0===n.caller.cmdsManager._private._runningCmd._private._command._instance.cancelWhenPaused?(a.callback=P,a.caller.cmdHandler._private._command._instance.params=Object.create(null),a.caller.cmdHandler._private._command._instance.params.cancelReason=u.exclusiveCmdCalled):n.caller.cmdHandler.getMode()===e.CmdMode.NESTED&&(a.callback=O)),a}function S(){return new Promise(((n,a)=>{if(!this._private._currentExecutionDone)return n();if(this._private.executionChaining)return n();if(0===this._private._executionChain.length)return this._private._waitingExecution=0,this._private._executionChain=[],this._private._currentExecution=null,this._private._currentExecutionDone=!0,this._private._runningCmd||M({cmdsManager:this,cmdHandler:void 0}),n();{let t=Promise.resolve();const r=this._private._executionChain[0];if(r.caller.cmdHandler.isDynamic()&&!r.caller.cmdHandler._private._command._dynamicModeComputed){void 0===r.caller.cmdsManager._private._uExecID&&(r.caller.cmdsManager._private._uExecID=0);const n=r.caller.cmdsManager._private._uExecID;r.caller.cmdsManager._private._uExecID++,r.caller.cmdsManager._private._currentComputations||(r.caller.cmdsManager._private._currentComputations=new Map),r.caller.cmdsManager._private._currentComputations.set(n,t),this._private._executionChain[0].caller.cmdHandler.setStateAndSendEvent({state:e.HandlerState.COMPUTING,event:e.LifeCycleEvents.COMPUTE}),r.caller.cmdHandler._private._command._dynamicModeComputed=!0,t=w(r),r.caller.cmdsManager._private._modelEvents.publish({event:r.caller.cmdHandler.getId()+"/compute"})}t.then((()=>{if(0===this._private._executionChain.length)return n();let e=I(this._private._executionChain[0]);return e||(e=this._private._executionChain.shift()),this._private._currentExecution=A(e),n()})).then((()=>{r.caller.cmdsManager._private._currentComputations&&r.caller.cmdsManager._private._currentComputations.delete(currExecID)})).catch((e=>e.cause?a(e):a(new Error(e,{cause:s.COMPUTE_COMMAND_MODE_FAILED}))))}}))}function y(e){var n=!1;if(!e._dirtyUndoStack)return n;var a=this.cmdsManager.getExecutionContext(),t=a.getComponent("AFR_UndoRedoComponent");if(t){var d=t.getLastStepId();if(e._previousUndoId<d){var c=!0;"shared"===e._mode&&e._executeUndoAtEnd&&(c=!1);var i=t._createUndoStep({undoTitle:e.getId(),exclusivity:c,redoEnabled:!e._executeUndoAtEnd});t.registerAction(i);var o=t.groupSteps(i.getId(),e._previousUndoId+1,a);if(r.hasSucceeded(o))n=!0;else{var m=t.removeStepWithId(t.getLastStepId());r.hasSucceeded(m)||r.logResult(m)}}}return n}function w(n){const a=new(0,d.Performances),t=a.start("[DS/WAfrCommandsArchitecture/mod_CommandsManagerComponent::ComputeCmdMode]");if(!n.caller||!n.caller.cmdsManager||!n.caller.cmdHandler)return Promise.reject(new Error("pauseCmd requires the parameter caller with a valid cmdsManager and cmdHandler with a valid command instance"));return new Promise(((r,d)=>{if(n.caller.cmdHandler._private._command._dynamicModeModule&&n.caller.cmdHandler._private._command._dynamicModeFunction)require([n.caller.cmdHandler._private._command._dynamicModeModule],(function(c){if(!c)return d(new Error("Call to "+n.caller.cmdHandler._private._command._dynamicModeMod+" constructor returned undefined"));{const i=n.caller.cmdHandler._private._command._dynamicModeFunction,o=c;if(!o)return d(new Error("Unable to retrieve Dynamic Mode ctor : "+n.caller.cmdHandler._private._command._dynamicModeModule+" in Dynamic Mode Module : "+i));let m=null;const l=n.caller.cmdsManager.getExecutionContext();l&&(m=l.exposedApi,m.ID=n.caller.cmdsManager._private._executionContext.getId());let _=new o;if(!_[i])return d(new Error("Invalid function name for Dynamic Mode computation"));const u=e.CmdMode;let p=_[i](m,u);a.stop(t),p.then((a=>Object.values(e.CmdMode).includes(a)?(n.caller.cmdHandler.setMode(a),r(a)):d(new Error("Invalid return type for Dynamic Mode. Please check doc to see valid types.")))).catch((e=>d(new Error(e,{cause:s.CLIENT_COMPUTE_COMMAND_MODE_FAILED}))))}}),(function(){return d(new Error("Require to "+n.caller.cmdHandler._private._command._dynamicModeMod+" has failed."))}));else{if(n.caller.cmdHandler._private._command._dynamicModeModule&&n.caller.cmdHandler._private._command._dynamicModeFunction)return d(new Error("Missing dynamic mode module in commandHandler parameters."));if(n.caller.cmdHandler._private._command._dynamicModeModule&&!n.caller.cmdHandler._private._command._dynamicModeFunction)return d(new Error("Missing dynamic mode function in commandHandler parameters."))}}))}function N(){this.cmdHandler._private._command._instance.done=function(){},C("paused",this.cmdHandler.getId()),this.cmdsManager._private._modelEvents.publish({event:this.cmdHandler.getId()+"/paused"}),this.cmdsManager._private._modelEvents.publish({event:"paused",data:this.cmdHandler.getId()}),this.cmdsManager._private._runningCmd=null,this.cmdsManager._private._currentExecution&&(this.cmdsManager._private._currentExecutionDone=!0);var e=this;setTimeout((function(){S.call(e.cmdsManager)}),0)}function O(n){if(!n||!n.cmdsManager||!n.cmdHandler)throw new Error("pauseCmd require the parameter capsuleObject with a valid cmdsManager and cmdHandler with a valid command instance");if(n.cmdsManager._private._unstackingCommand&&n.cmdsManager._private._unstackingCommand.length>0)return n.cmdsManager._private._currentExecutionDone=!0,n.cmdsManager._private._unstackingCommand=[],void setTimeout((function(){S.call(n.cmdsManager)}),0);if(f(n.cmdHandler)&&(C("pause",n.cmdHandler.getId()),n.cmdsManager._private._modelEvents.publish({event:n.cmdHandler.getId()+"/pause"}),n.cmdsManager._private._modelEvents.publish({event:"pause",data:n.cmdHandler.getId()}),n.cmdHandler.setStateAndSendEvent({state:e.HandlerState.PAUSED,event:e.LifeCycleEvents.PAUSE}),n.cmdsManager._private._pausedCmds.push(n.cmdHandler),n.cmdHandler._private._command._instance.pauseExecute?(n.cmdHandler._private._command._instance.done=N.bind(n),b({callback:n.cmdHandler._private._command._instance.pauseExecute,caller:n.cmdHandler._private._command._instance})):b({callback:N,caller:n}),n.cmdHandler)){const e=n.cmdHandler.getI18n()?n.cmdHandler.getI18n().title:n.cmdHandler.getId?.(),a=n.cmdsManager._private._executionChain[0];let t="None";a&&(t=a.caller?.cmdHandler?.getI18n()?a.caller.cmdHandler.getI18n().title:a.caller?.cmdHandler?.getId?.());const r=v(n.cmdHandler);r.pd4=e+" paused by "+t;const d=n.cmdsManager.getExecutionContext?.()?n.cmdsManager.getExecutionContext():null,c=d.getSourceApp?.()?d.getSourceApp():null,i={id:n.cmdHandler.getId?.()?n.cmdHandler.getId():"",appID:c?.getId()||"",pds:r},o=d.getComponent(m);o?o.publish({event:"command_pause",data:i}):console.error("Model events is undefined")}}function U(n){var a,t=this.cmdsManager.getExecutionContext();if(t){var r=t.getComponent("AFR_UndoRedoComponent");r&&!0===this.cmdsManager._private._runningCmd._private._command._instance._endUndoGroupingRequested&&(r._stopConcatenateUS(this.cmdsManager._private._runningCmd._private._command._instance._undoGroupID),this.cmdsManager._private._runningCmd._private._command._instance._endUndoGroupingRequested=!1);var d=this.cmdsManager._private._runningCmd._private._command._instance;if(a=y.call(this,d),d.params&&d.params.undoOnEnd&&a){var c=!1;this.cmdsManager&&"WAFRRedoCmd"===this.cmdsManager.getRunningCommand()&&(c=!0),0===r.getUndoStack().getSize()||c||r.undo()}this.cmdsManager._private._runningCmd=null,this.cmdsManager._private._currentExecution&&(this.cmdsManager._private._currentExecutionDone=!0);var i=this.cmdHandler.getState()===e.HandlerState.CANCELED,o=this.cmdHandler.getRepeatMode()===e.RepeatMode.ALWAYS&&!i&&0===this.cmdsManager._private._waitingExecution;if(this.cmdHandler.setStateAndSendEvent({state:e.HandlerState.ENDED,event:e.LifeCycleEvents.END,repeated:o,canceled:i}),C("end",this.cmdHandler.getId()),this.cmdsManager._private._modelEvents.publish({event:this.cmdHandler.getId()+"/end",data:{repeated:o,canceled:i}}),this.cmdsManager._private._modelEvents.publish({event:"end",data:{handlerId:this.cmdHandler.getId(),repeated:o,canceled:i}}),this.cmdHandler._private._cb&&"function"==typeof this.cmdHandler._private._cb&&(this.cmdHandler._private._cb(n?n.error:void 0),o||(this.cmdHandler._private._appCB=[],this.cmdHandler._private._cbIfCommandNotStarted=null)),this.cmdHandler._private._command._instance.destroy&&this.cmdHandler._private._command._instance.destroy(),this.cmdHandler._private._command._instance.stateGraph&&this.cmdHandler._private._command._instance._clearGraph(),this.cmdHandler._private._command._instance=null,this.cmdHandler._private._command._dynamicModeComputed=null,o)this.cmdHandler.execute(),S.call(this.cmdsManager);else{var m=this;setTimeout((function(){m.cmdsManager._private._runningCmd||M(m)}),0)}}}function T(n){if(n&&n.undoOnEnd&&(this.cmdsManager._private._runningCmd._private._command._instance.params||(this.cmdsManager._private._runningCmd._private._command._instance.params={}),this.cmdsManager._private._runningCmd._private._command._instance.params.undoOnEnd=n.undoOnEnd),("CANCELED"===this.cmdHandler._private._command._state||n&&n.undoOnEnd)&&this.cmdHandler){const e=v(this.cmdHandler),n=this.cmdHandler._private._command._instance.params.cancelReason,a=this.cmdHandler.getI18n()?this.cmdHandler.getI18n().title:this.cmdHandler.getId?.();let t="None";switch(n){case 0:const n=this.cmdsManager._private._executionChain[0];n&&(t=n.caller?.cmdHandler?.getI18n()?n.caller.cmdHandler.getI18n().title:n.caller?.cmdHandler?.getId?.()),e.pd4=`${a} canceled by ${t}`;break;case 1:e.pd4=`${a} canceled by itself`;break;default:e.pd4=`${a} canceled internally`}const r=this.cmdsManager.getExecutionContext?.()?this.cmdsManager.getExecutionContext():null,d=r.getSourceApp?.()?r.getSourceApp():null,c={id:this.cmdHandler.getId()?this.cmdHandler.getId():"",appID:d?.getId()||"",pds:e},i=r.getComponent(m);i?i.publish({event:"command_cancel",data:c}):console.error("Model events is undefined")}var a=this.cmdsManager.getExecutionContext();this.cmdHandler._private._command._instance.done=function(){};let t=p.CANCELED;if(this.cmdHandler.getState()!==e.HandlerState.CANCELED&&(this.cmdHandler.setStateAndSendEvent({state:e.HandlerState.ENDING}),t=p.VALIDATED),this.cmdHandler.isUsingComputeServer()){var r={from:this.cmdHandler._private._command._instance},d=a.getComponent("AFR_CSComponent");d&&d.sendStopCommand(r)}else{var c=this;setTimeout((function(){U.call(c,n)}),0)}if("Internal"!==this.cmdHandler._private._handlerTrigger&&this.cmdHandler){const e=v(this.cmdHandler);e.pd4=t;const n=this.cmdsManager.getExecutionContext?.()?this.cmdsManager.getExecutionContext():null,a=n.getSourceApp?.()?n.getSourceApp():null,r={pv1:Date.now()-this.cmdHandler._private._startTimeCmd},d={id:this.cmdHandler.getId()?this.cmdHandler.getId():"",appID:a?.getId()||"",pds:e,pvs:r},c=n.getComponent(m);c?c.publish({event:"command_end",data:d}):console.error("Model events is undefined")}}function L(e){this.cmdHandler._private._command._instance.done=function(){},this.cmdsManager._private._runningCmd===this.cmdHandler&&f(this.cmdHandler)?(e&&e.error&&(this.cmdHandler._private._command._instance.params.error=e.error),e&&e.cancel?(this.cmdHandler._private._command._instance.params.cancelReason=u.askedByCmd,e.undoOnEnd&&(this.cmdHandler._private._command._instance.params.undoOnEnd=e.undoOnEnd),P(this)):T.call(this)):C("done execute callback called but command paused/canceled in between",this.cmdHandler.getId())}function k(){this.cmdHandler._private._command._instance.done=L.bind(this),this.cmdsManager._private._runningCmd===this.cmdHandler&&f(this.cmdHandler)?b({callback:this.cmdHandler._private._command._instance._initGraph,caller:this.cmdHandler._private._command._instance}):C("done execute callback called but command paused/canceled in between",this.cmdHandler.getId())}function R(e){if(!(e&&e.cmdsManager&&e.cmdHandler&&e.cmdHandler._private._command._instance&&e.cmdHandler._private._cb&&e.cmdHandler._private._cb))throw new Error("executeCmd require the parameter capsuleObject with a valid CommandsManager and cmdHandler with a valid command instance");if(C("begin",e.cmdHandler.getId()),e.cmdsManager._private._modelEvents.publish({event:e.cmdHandler.getId()+"/begin"}),e.cmdsManager._private._modelEvents.publish({event:"begin",data:e.cmdHandler.getId()}),e.cmdsManager._private._runningCmd=e.cmdHandler,!e.cmdHandler._private._command._instance.beginExecute&&!0!==e.cmdHandler._private._command._instance.stateGraph)throw new Error("mod_CommandsManagerComponent.executeCmd : Cannot execute a command without a beginExecute method defined on it. It has no sense. BAD Command : "+e.cmdHandler._private._command._module);var n=e.cmdsManager.getExecutionContext(),a=n.getComponent("AFR_UndoRedoComponent");if(a&&(e.cmdHandler._private._command._instance._previousUndoId=a.getLastCreatedUndoStepId()),e.cmdHandler.isUsingComputeServer()){var t={from:e.cmdHandler._private._command._instance},r=n.getComponent("AFR_CSComponent");r&&r.sendStartCommand(t)}!0!==e.cmdHandler._private._command._instance.stateGraph?(e.cmdHandler._private._command._instance.done=L.bind(e),b({callback:e.cmdHandler._private._command._instance.beginExecute,caller:e.cmdHandler._private._command._instance})):(!0===e.cmdHandler._private._command._instance.asyncGraph?e.cmdHandler._private._command._instance.done=k.bind(e):e.cmdHandler._private._command._instance.done=L.bind(e),b({callback:e.cmdHandler._private._command._instance.buildGraph,caller:e.cmdHandler._private._command._instance}),!0!==e.cmdHandler._private._command._instance.asyncGraph&&b({callback:e.cmdHandler._private._command._instance._initGraph,caller:e.cmdHandler._private._command._instance})),e.cmdsManager._private._currentExecution&&(e.cmdsManager._private._currentExecutionDone=!0),b({callback:function(){e.cmdsManager._private._currentExecutionDone&&f(e.cmdHandler)&&S.call(e.cmdsManager)}});const d=i.createUUID();if(e.cmdHandler._private._cmdUUID=d,"Internal"!==e.cmdHandler._private._handlerTrigger&&e.cmdHandler){const n=v(e.cmdHandler),a=e.cmdsManager.getExecutionContext?.()?e.cmdsManager.getExecutionContext():null,t=a.getSourceApp?.()?a.getSourceApp():null;e.cmdHandler._private._startTimeCmd=Date.now();const r={id:e.cmdHandler.getId?.()?e.cmdHandler.getId():"",appID:t?.getId()||"",pds:n},d=a.getComponent(m);d?d.publish({event:"command_launch",data:r}):console.error("Model events is undefined")}}function P(n){if(!(n&&n.cmdsManager&&n.cmdHandler&&n.cmdHandler._private._cb))throw new Error("cancelCmd require the parameter capsuleObject with a valid cmdsManager and cmdHandler with a valid command instance");f(n.cmdHandler)&&(n.cmdHandler.setStateAndSendEvent({state:e.HandlerState.CANCELED,event:e.LifeCycleEvents.CANCEL}),C("canceling",n.cmdHandler.getId()),n.cmdsManager._private._modelEvents.publish({event:n.cmdHandler.getId()+"/canceling"}),n.cmdsManager._private._modelEvents.publish({event:"canceling",data:n.cmdHandler.getId()}),n.cmdHandler._private._command._instance.cancelExecute?(n.cmdHandler._private._command._instance.done=T.bind(n),b({callback:n.cmdHandler._private._command._instance.cancelExecute,caller:n.cmdHandler._private._command._instance,arg:n.cmdHandler._private._command._instance.params})):b({callback:T,caller:n,arg:n.cmdHandler._private._command._instance.params}))}var F=Object.create(null);return F.CommandsManagerComponent=function(){var e=this;this._private||(this._private=Object.create(null)),this._private._defaultCommand=null,this._private._runningCmd=null,this._private._pausedCmds=[],this._private._executionChain=[],this._private._currentExecution=null,this._private._currentExecutionDone=!0,this._private._waitingExecution=0,this._private._modelEvents=new a,this._private._endingCommandsToken=t.subscribe({event:"COMMAND_MANAGER/Ending_Commands"},(function(){e.endAll(void 0)})),this._private._configurations=new Map},F.CommandsManagerComponent.DEFAULT_COMPONENT_NAME="AFR_CommandsManager",F.CommandsManagerComponent.prototype.initialize=function(e){if(E=!1,e){this.getExecutionContext().setContext("usingCS",!0)}return Promise.resolve()},F.CommandsManagerComponent.prototype.setUseEscape=function(e){e?this._boundOnKeyup||(this._boundOnKeyup=function(e){const n=Object(null);let a;if(e.defaultPrevented||e.actionPerformed)return;const t=e.key||e.keyCode;if("Escape"===t||"Esc"===t||27===t)if(this._private._runningCmd)e.preventDefault(),e.stopPropagation(),a=this._private._runningCmd._private._command._instance,a.buildGraph&&a._unsubscribeFromAllEvents(a._stateId),a.params||(a.params=Object(null)),a.params.undoOnEnd=!0,n.cmdHandler=this._private._runningCmd,n.cmdsManager=this,P(n);else{if(Boolean(this.getConfiguration("a2x"))){const e=localStorage.getItem("WAFR_A2X_NO_ESCAPE");if(null!==e&&("string"==typeof e&&"true"===e||"boolean"==typeof e&&e))return void console.warn("A2X Command Escape is deactivated (WAFR_A2X_NO_ESCAPE set to true in your localStorage)");new Promise(((e,n)=>{require(["DS/WA2XCommunication/WA2XClient","DS/CSICommandBinder/CSICommandBinder"],(function(n,a){return e([n,a])}),n)})).then((e=>{const n=e[0],a=e[1],t=n.getA2XClient(),r=a.createParameters(),d="afrA2XCommandEscape",i={name:d,version:1,parameters:r,onSuccess:()=>{c.debug(`${d} onSuccess`)},onError:e=>{const n=e&&e.readString("error"),a=e&&e.readString("errorMessage");c.error(`${d} onError. Escape key to manage command escape failed to execute. Error: ${n}, Error Message: ${a}`)}};t.call(i)}),(e=>{console.error("ESCAPE - Impossible to retrieve prerequisites",e)}))}}}.bind(this),document.addEventListener("keyup",this._boundOnKeyup)):this._boundOnKeyup&&document.removeEventListener("keyup",this._boundOnKeyup)},F.CommandsManagerComponent.prototype.clean=function(){var e=this;E=!0;let n=[];this._private._currentComputations&&this._private._currentComputations.forEach((e=>{n.push(e)})),Promise.allSettled(n).then((()=>this.endAll().then((function(){e.setDefaultCommand(null)}))))},F.CommandsManagerComponent.prototype.destroy=function(){return this._boundOnKeyup&&document.removeEventListener("keyup",this._boundOnKeyup),t.unsubscribe(this._private._endingCommandsToken),delete this._private._endingCommandsToken,Promise.resolve()},F.CommandsManagerComponent.prototype.isCmdExecuting=function(n){return n.getState()===e.HandlerState.EXECUTING},F.CommandsManagerComponent.prototype.setDefaultCommand=function(e){if(void 0===e||e&&"string"!=typeof e)throw new Error("CommandsManagerComponent.setDefaultCommand can only take null or a string (commandHandlerID) as input parameter");e&&null===this._private._runningCmd&&0===this._private._pausedCmds.length&&0===this._private._waitingExecution&&this._private._currentExecutionDone&&h({commandHandlerId:e,executionCtx:this._private._executionContext});this._private._defaultCommand=e},F.CommandsManagerComponent.prototype.getDefaultCommand=function(){return this._private._defaultCommand},F.CommandsManagerComponent.prototype.subscribeToCmdState=function(e,n,a){var t;return t=""===e?n:e+"/"+n,this._private._modelEvents.subscribe({event:t},(function(e){a(e)}))},F.CommandsManagerComponent.prototype.subscribeOnceToCmdState=function(e,n,a){var t;return t=""===e?n:e+"/"+n,this._private._modelEvents.subscribeOnce({event:t},(function(e){a(e)}))},F.CommandsManagerComponent.prototype.unsubscribeToCmdState=function(e){this._private._modelEvents.unsubscribe(e)},F.CommandsManagerComponent.prototype.getRunningCommand=function(){return this._private._runningCmd?this._private._runningCmd.getId():null},F.CommandsManagerComponent.prototype.getExposedComponentCtor=function(){var e=this;function n(){this.cancelReason=u}return n.prototype.getDefaultCommand=e.getDefaultCommand.bind(e),n.prototype.getRunningCommand=e.getRunningCommand.bind(e),n.prototype.setDefaultCommand=e.setDefaultCommand.bind(e),n.prototype.isCmdExecuting=e.isCmdExecuting.bind(e),n.prototype.subscribeToCmdState=e.subscribeToCmdState.bind(e),n.prototype.unsubscribeToCmdState=e.unsubscribeToCmdState.bind(e),n.prototype.subscribeOnceToCmdState=e.subscribeOnceToCmdState.bind(e),n},F.CommandsManagerComponent.prototype.stackCommandExecutionRequest=function(n,a){var t=Object.create(null);t.cmdsManager=this,t.cmdHandler=a.handler;var d=a.cb;t.cmdHandler._private._cbIfCommandNotStarted=d,function(n){const a=n.caller.cmdHandler,t=n.caller.cmdsManager;if(void 0===a||void 0===t||void 0===t._private)throw new Error("Error on arguments in chainNewExecution, please check.");void 0===t._private._uExecID&&(t._private._uExecID=0);const d=t._private._uExecID;t._private._uExecID++,t._private.unstartedExecutions||(t._private.unstartedExecutions=new Map);let c=t._private.unstartedExecutions;return new Promise(((i,o)=>{if(n.caller.cmdsManager._private._waitingExecution++,n.caller.cmdsManager._private.executionChaining||n.caller.cmdsManager._private._currentExecution||!n.caller.cmdsManager._private._currentExecutionDone||n.caller.cmdsManager._private._runningCmd&&!f(n.caller.cmdsManager._private._runningCmd)){if(n.caller.cmdsManager._private._executionChain.length>0){n.caller.cmdsManager._private._waitingExecution--;let a=n.caller.cmdsManager._private._executionChain.pop();if(a.caller.cmdHandler.setStateAndSendEvent({state:e.HandlerState.ENDED,event:e.LifeCycleEvents.END,notStarted:!0}),a.caller.cmdHandler._private._cb&&"function"==typeof a.caller.cmdHandler._private._cb){const e=r.createReturnObject(_.COMMAND_NOT_STARTED,{description:"Can't start the command as another one has been started as the same time."});a.caller.cmdHandler._private._cbIfCommandNotStarted&&a.caller.cmdHandler._private._appCB.push(a.caller.cmdHandler._private._cbIfCommandNotStarted),a.caller.cmdHandler._private._cb(e),a.caller.cmdHandler._private._appCB=[]}a.caller.cmdHandler===n.caller.cmdHandler?n.caller.cmdsManager._private._waitingExecution--:(n.caller.cmdsManager._private._unstackingCommand=[],n.caller.cmdsManager._private._unstackingCommand.push({discardedCommand:a,newCommandToExecute:n}),n.caller.cmdsManager._private._executionChain.push(n))}else n.caller.cmdsManager._private._executionChain.push(n);return i()}{t._private.unstartedExecutions.set(d,a);let r=Promise.resolve();n.caller.cmdHandler.isDynamic()&&!n.caller.cmdHandler._private._command._dynamicModeComputed&&(t._private._currentComputations||(t._private._currentComputations=new Map),n.caller.cmdHandler.setStateAndSendEvent({state:e.HandlerState.COMPUTING,event:e.LifeCycleEvents.COMPUTE}),n.caller.cmdsManager._private._modelEvents.publish({event:n.caller.cmdHandler.getId()+"/compute"}),n.caller.cmdHandler._private._command._dynamicModeComputed=!0,r=w(n),t._private._currentComputations.set(d,r)),a.isDynamic()||(t._private.executionChaining=!0),r.then((()=>{let r;if(t._private&&t._private._runningCmd&&(r=t._private._runningCmd.getState()),r===e.HandlerState.ENDING)return t._private._executionChain.push(n),t._private.executionChaining=!1,i();if(a._private._command.killed)return a._private._command._instance=null,a._private._command._dynamicModeComputed=null,a._private._command.killed=null,o(new Error("Dynamic mode canceled during mode computation",{cause:s.DYNAMIC_COMMAND_CANCELED}));let m=new Map(c);if(c.size>1&&c.forEach(((n,r)=>{r>d&&(t._private._waitingExecution--,m.delete(d),a.isDynamic()&&(a._private._command._instance=null,a._private._command._dynamicModeComputed=null,a._private._command.killed=null),a.setStateAndSendEvent({state:e.HandlerState.CANCELED,event:e.LifeCycleEvents.CANCEL})),n.isDynamic()&&r<d&&(t._private._waitingExecution--,n._private._command.killed=!0,n.setStateAndSendEvent({state:e.HandlerState.CANCELED,event:e.LifeCycleEvents.CANCEL}),m.delete(r)),!n.isDynamic()&&r<d&&(n.setStateAndSendEvent({state:e.HandlerState.CANCELED,event:e.LifeCycleEvents.CANCEL}),m.delete(r))})),t._private.unstartedExecutions=m,t._private.unstartedExecutions.size>1)return o(new Error("Dynamic mode canceled during mode computation",{cause:s.DYNAMIC_COMMAND_CANCELED}));if(1!==t._private.unstartedExecutions.size)return o(new Error("ASYNC FAILURE ON DYNAMIC MODE COMMANDS"));{let e=t._private.unstartedExecutions.entries().next();if(e.value[1]!==a)return o(new Error("ASYNC FAILURE ON DYNAMIC MODE COMMANDS"));t._private.unstartedExecutions.delete(e.value[0])}if(a._private._command.killed)return o(new Error("Dynamic mode canceled during mode computation",{cause:s.DYNAMIC_COMMAND_CANCELED}));let l=I(n);return t._private.executionChaining=!1,l?(t._private._executionChain.push(n),l.caller.cmdsManager._private._currentExecution=A(l)):t._private._currentExecution=A(n),i()})).then((()=>{t._private._currentComputations&&t._private._currentComputations.delete(d)})).catch((e=>e.cause?o(e):o(new Error(e,{cause:s.COMPUTE_COMMAND_MODE_FAILED}))))}}))}({callback:function(t){if(!t)throw new Error("mod_CommandsManagerComponent.js callback in chainNewExecution cannot start a command is no capsuleObject is passed");if(!E){if(null!==d&&"function"==typeof d||(d=void 0),t.cmdHandler.getState()===e.HandlerState.PAUSED)return t.cmdsManager._private._currentExecution&&(t.cmdsManager._private._currentExecutionDone=!0),void setTimeout((function(){S.call(t.cmdsManager)}),0);f(t.cmdHandler)?(t.cmdHandler._private._appCB||(t.cmdHandler._private._appCB=[]),d&&t.cmdHandler._private._appCB.push(d),t.cmdHandler._private._command._instance.params=Object.create(null),t.cmdHandler._private._command._instance.params.cancelReason=u.secondExecuteCalled,P(t)):(t.cmdHandler.setStateAndSendEvent({state:e.HandlerState.EXECUTING,event:e.LifeCycleEvents.BEGIN}),require([t.cmdHandler._private._command._module],(function(e){if(!e)throw new Error("Failed to load the module related to the command",t.cmdHandler._private._id);var r=null,c=t.cmdsManager.getExecutionContext();c&&((r=c.exposedApi).ID=t.cmdsManager._private._executionContext.getId()),a.args||(a.args=Object.create(null)),a.args.cmdLifeCyleEventsChanel=t.cmdsManager._private._modelEvents,a.ID=t.cmdHandler.getId(),e.prototype.isNewInfraActivated=function(){return!0};var i=new e({args:a.args,executionContext:r,ID:a.ID});if(!i)throw S.call(t.cmdsManager),new Error("Call to "+t.cmdHandler._private._command._module+" constructor returned undefined");a.args&&(t.cmdHandler._private._handlerTrigger=a.args.handlerTrigger?a.args.handlerTrigger:"Internal"),t.cmdHandler.isUsingComputeServer()&&(i.getCSIdentifier=function(){return i},i.hasDecalredCS=function(){return!0},i.onCmdEnded=function(e){return U.call(t,e)}),i.getId=function(){return t.cmdHandler.getId()},i.askForUndoGroupingAtEnd=function(e,n){i._endUndoGroupingRequested=!0,i._concatenateServerStep=n,i._undoGroupID=e},i._evtID=r.ID+a.ID,t.cmdHandler._private._command._instance=i,t.cmdHandler._private._command._instance.params={},t.cmdHandler._private._cb=n,t.cmdHandler._private._appCB||(t.cmdHandler._private._appCB=[]),d&&t.cmdHandler._private._appCB.push(d),R(t)}),(function(){var e=new Error("Require failed ("+t.cmdHandler._private._command._module+")");if(!d||"function"!=typeof d)throw e;d(e),S.call(t.cmdsManager)})))}},caller:t}).catch((e=>{if(e.cause!==s.DYNAMIC_COMMAND_CANCELED){if(!d||"function"!=typeof d)throw e;d(e)}}))},F.CommandsManagerComponent.prototype.endAll=function(){var e=this;return new UWA.Promise((function(n,a){var r=e._private._pausedCmds.length;if(r>0)var d=e.subscribeToCmdState("","resume",(function(a){var c=Object.create(null);if(c.cmdsManager=e,c.cmdHandler=e._private._runningCmd,P(c),0===--r)return e.unsubscribeToCmdState(d),t.publish({event:"COMMAND_MANAGER/ALL_CMD_ENDED"}),n()}));if(e._private._runningCmd&&("WAFRUndoCmd"!==e._private._runningCmd._private._id||"Undo"!==e._private._runningCmd._private._id)){var c=Object.create(null);c.cmdsManager=e,c.cmdHandler=e._private._runningCmd,P(c)}if(0===r)return t.publish({event:"COMMAND_MANAGER/ALL_CMD_ENDED"}),n()}))},F.CommandsManagerComponent.prototype.setConfiguration=function(e,n){if(!e||null==n)throw new Error("Missing parameters");this._private._configurations.set(e,n)},F.CommandsManagerComponent.prototype.getConfiguration=function(e){let n;return this._private._configurations.has(e)&&(n=this._private._configurations.get(e)),n},F})),define("DS/WAfrCommandsArchitecture/mod_CommandsInterpreter",["UWA/Class/Promise","DS/WAfrUtils/mod_ConcatenationUtils","DS/WAfrCommandsArchitecture/mod_CommandsManagerComponent"],(function(e,n,a){"use strict";const t=n.getConfigurationFor,r=a.CommandsManagerComponent.DEFAULT_COMPONENT_NAME;var d=function(){};d.prototype.interpret=function(n,a){var d=!1,c=function(e,n){Object.keys(e).some((function(a){a===n&&!0===e[a]?d=!0:e[a]&&"object"==typeof e[a]&&c(e[a],n)}))};c(n,"computeServer"),d&&a.setContext("usingCS",!0);const i=Boolean(t(n,"a2x")),o=Boolean(t(n,"useEscape"))||i,m=a.getComponent(r);if(!m)throw new Error("Missing Commands Manager Component");return m.setUseEscape(o),m.setConfiguration("a2x",i),e.resolve(d)};var c=Object.create(null);return c.generateInterpreter=function(e,n){return Promise.resolve(new d)},c}));