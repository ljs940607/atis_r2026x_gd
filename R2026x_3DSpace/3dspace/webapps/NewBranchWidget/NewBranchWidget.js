define("DS/NewBranchWidget/CredentialSingleObjectViewManager",["i18n!DS/NewBranchWidget/assets/nls/NewBranchWidgetNls","i18n!DS/LifecycleControls/assets/nls/CredentialSelector"],(function(e,t){"use strict";const i=(e,t,i,n)=>{i.attributes_mask.forEach((i=>{if("organization"===i.selectable){var a=e.objectsList[0].volatileAttributes.organization,s=i.authorizedValues.indexOf(a),r=i.authorizedValuesNLS[s];i.authorizedValues=t.get(n.value).rangeCred,i.authorizedValuesNLS=t.get(n.value).rangeOrgTitle;var o=null;if((s=i.authorizedValuesNLS.indexOf(r))&&(o=i.authorizedValues[s]),o||(o=t.get(n.value).rangeCred[0]),i.value=o,e.objectsList[0].volatileAttributes.organization=o,null!==e.objectProp){let t=e.displayIntentsList;var l=e.objectProp.getIntent();e.objectProp.setObject(e.objectsList[0],t?e.intentsList:null,l)}}}))};return{onCollaborativeSpaceSelectionChangedMonoSel:(e,t,n,a)=>{i(e,t,n,a)},manageNoCredential:e=>(e=>{if(e&&e.elements&&e.elements.footer){var i=e.elements.footer.querySelector(".btn-primary");i&&(i.disabled=!0)}return{title:t.noCredentialErrorMessageTitle,subtitle:t.noCredentialErrorMessageSubTitle,submessage:t.noCredentialErrorMessageMsg}})(e),createCredentialAttributeMask:(n,a,s,r)=>{var o=[],l=new Map,c=[];a&&a.size>0&&a.forEach(((e,t)=>{if(o.push(t),a.isMultipleOrg){var i=[],n=[];e.forEach((e=>{i.push(e.ctx),n.push(e.orgTitle)})),l.set(t,{rangeCred:i,rangeOrgTitle:n})}else c.push(e[0].ctx)})),0==o.length&&(o=[e.noCredentials],c=["noCredentials"]);var d=c.length>0?c[0]:null,h=null,u=null,p=c.length>0?c[0]:null,g=function(){};a&&a.isMultipleOrg?(d=o[0],h=l.get(o[0]).rangeOrgTitle[0],p=l.get(o[0]).rangeCred[0],g=function(e,t,n,a,s,o){i(e,t,n,s),r(!0)}.bind(null,n,l)):g=function(){r(!1)};var m=o;a&&!a.isMultipleOrg&&(m=c);let f=null,v=null,b=null;s&&o.length>1&&a.forEach(((e,t)=>e.forEach((e=>{e.ctx==s&&(f=s,v=e,b=t)})))),f&&(a&&a.isMultipleOrg?(d=b,h=v,p=f):(d=f,p=f));var _={selectable:"collaborativeSpace",path:"collaborativeSpace",readOnly:!1,value:d,nls:t.collaborativeSpace,authorizedValues:m,authorizedValuesNLS:o,onAttributeValueChanged:g,volatile:!0};return a&&a.isMultipleOrg&&(u={selectable:"organization",path:"organization",readOnly:!1,value:h.ctx,nls:t.organization,authorizedValues:l.get(d).rangeCred,authorizedValuesNLS:l.get(d).rangeOrgTitle,onAttributeValueChanged:function(){r(!0)},volatile:!0}),{collaborativeSpaceAttributeMask:_,organizationAttributeMask:u,defaultValueOrganization:h,defaultValueCollabSpace:d,defaultValueCredential:p}}}})),define("DS/NewBranchWidget/NewBranchWidget",["UWA/Controls/Abstract","DS/ENOjquery/ENOjquery","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleControls/CredentialList","DS/LifecycleControls/DelayedMask","DS/LifecycleServices/DefaultCredential","DS/LifecycleServices/HTMLTemplating","DS/WAFData/WAFData","DS/LifecycleServices/WebReq","DS/WebToWinInfra/WebToWinCom","DS/WebInWinHelper/WebInWinHelper","DS/UIKIT/Input/Button","DS/Controls/Button","DS/Controls/ComboBox","DS/Controls/Editor","DS/Controls/LineEditor","DS/LifecycleControls/CommandDialog","DS/LifecycleControls/DataGridViewContainer","DS/LifecycleControls/InputValidation","DS/LifecycleControls/CredentialSelector","DS/LifecycleCmd/MessageMediator","DS/WidgetServices/WidgetServices","DS/LifecycleServices/NewBranchObjectProp","DS/LifecycleServices/LifecycleAlert","DS/LifecycleServices/DictionaryServices","DS/ErrorWidget/ErrorWidget","DS/Windows/ImmersiveFrame","DS/AdvancedView/AdvancedTree","DS/LifecycleServices/expandServices/ExpandReqBuilder","DS/LifecycleServices/expandServices/ExpandLoader","DS/LifecycleCmd/SelectionUtil","DS/ENOCollabToolsUI/tracker/ENOCollabTracker","DS/ENOCollabToolsUI/tracker/ENOCollabTrackerBackEnd","DS/LifecycleServices/Utils","DS/LifecycleWidget/utils/LifecycleWidgetSearchUtil","DS/NewBranchWidget/CredentialSingleObjectViewManager","css!DS/NewBranchWidget/NewBranchWidget","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","i18n!DS/NewBranchWidget/assets/nls/NewBranchWidgetNls","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls","i18n!DS/WidgetServicesUI/assets/nls/i18nWidgetService"],(function(e,t,i,n,a,s,r,o,l,c,d,h,u,p,g,m,f,v,b,_,y,S,w,C,E,A,L,I,D,P,j,T,k,W,B,N,x,M,O,R,F,U,V){"use strict";return e.extend({init:function(e,t,n){this.odtmode=!1,this.wintop=!1,this.auto_execute=!1,this.force_multiple_selection_ui=!1,this.without_cred=!1,this.hasCredentials=!1,this.dup_string="",this.selectionList=[],this.objectsList=[],this.intentsList=[],this.filteredRoots=new Map,this.advProhibitedTypes=["Requirement","Requirement Specification"],this.isThereLinearData=!1,this.effectivityBasedModelCase=!1,this.displayIntentsList=!1,this.nbDisplayedObjects=0,this.context={},n&&n.context&&(this.context=n.context),this.tenant=null,this.folderId=null,this.wintop_ChangeActionId=null,this.initBL_already_called=!1,this.objectsListTable=null,this.objectProp=null,this.intentsListSel=null,this.dupStringDiv=null,this.dupStringInput=null,this.commentInput=null,this._parent(n),this.commandManager=new i,this.content=UWA.createElement("div",{class:"newbranch_content dlg_cmd_content"}),this.container=UWA.createElement("div",{class:"newbranch_container"}),this.content.inject(this.container),this.useAdvancedBranch=!1,this.rootIds=[],this.advIds=[],this.providerIdSet=new Set,this.updateCSWarning=N.debounce(this._updateCollabSpaceWarning.bind(this),200),this.addEvent("AdvancedUIModeChanged",(()=>{this.updateCSWarning()})),this.isTargetCSPrivate=!1,this._getIsTargetCSPrivate=()=>this.isTargetCSPrivate,n&&n.odtmode&&(this.odtmode=!0),n&&n.without_cred&&(this.without_cred=!0),n&&n.wintop&&(this.wintop=!0,this.without_cred=!0,u.initTenant(this),u.getServices(this),this.webToWinCom_Socket=h.createSocket({socket_id:"WebInWin_NewBranchWidget_Socket_"+Math.floor(1e5*Math.random()+1)}),void 0!==this.options.serverUrl&&this.options.serverUrl.length>0&&(void 0!==this.options.serverUrl[0].platformId&&(this.tenant=this.options.serverUrl[0].platformId),a.setTenant(this.tenant)),n.ChangeActionId&&(this.wintop_ChangeActionId=n.ChangeActionId),"TRUE"===n.ENOVIA_ForceNewBranchMultiple&&(this.force_multiple_selection_ui=!0),"TRUE"===n.ODT_MODE&&(this.wintop_odt_mode=!0),"TRUE"===n.auto_execute&&(this.auto_execute=!0),n.dup_string&&(this.dup_string=n.dup_string),this.footerDiv=UWA.createElement("div",{class:"newbranch_footer modal-footer"}),this.footerDiv.inject(this.container),this.container.addClassName("column_flex_container"),this.container.addClassName("webinwin_lc_command_dialog"))},initDatafromWin:function(e){var t=[];e.forEach((function(e){var i=e.physicalId,n=e.name,a={physicalid:i,name:n,displayName:n};t.push(a)})),console.log("initDatafromWin / selection size: "+e.length),console.log("initDatafromWin / tenant: "+this.tenant),this.executeCmd(t)},onRefresh:function(){console.log("onRefresh called from win")},onResize:function(){console.log("onResize called from win")},_CloseWebInWinPanel:function(){this.wintop&&(console.log("CloseWebInWinPanel"),this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"ClosePanel",notif_parameters:"ClosePanel",recordable:!0},"lf_web_in_win"))},_setWaitingResponse:function(){void 0!==this.widget&&null!==this.widget?this.widget.body.style.cursor="wait":document.body.style.cursor="wait"},_setEndWaitingResponse:function(){void 0!==this.widget&&null!==this.widget?this.widget.body.style.cursor="default":document.body.style.cursor="default"},_onComplete:function(){},_onCompleteWithoutClose:function(){},_onOk:function(){},_onCancel:function(){},_getUniqueListBy:function(e,t){return[...new Map(e.map((e=>[e[t],e]))).values()]},_isMIB:function(e){return!!e&&(!(!e.physicalid||!e.physicalid.startsWith("cid:"))||!(!e.module&&!e.contenturl))},_displayAsMultiSelPanel:function(){return this.nbDisplayedObjects>1||this.force_multiple_selection_ui},_WafDataPromise:function(e,t,i){var s=i||this._securityContext;this._enrichPayloadForTrackerBackEnd(t);return new Promise(((i,r)=>{var o=a.get3DSpaceWSUrl(this.tenant,e,null);c.authenticatedRequest(o,{method:"POST",type:"json",headers:a.getHeaders(s),timeout:6e5,data:JSON.stringify(t),onComplete:function(e){i(e)},onFailure:function(e,t){console.log("PREPARE BRANCH Failure..."+e),r(n.parseWebServiceError(e,t))},ontimeout:function(){console.log("PREPARE BRANCH A connection timeout occured."),r(R.timeout)}})}))},_NewBranchWafDataPromise:function(e,t,i){return new Promise(((n,a)=>{this._WafDataPromise("/resources/lifecycle/newbranch/"+e,t,i).then((e=>{if("failure"===e.status&&e.hasOwnProperty("report")){var t=e.report;t.length>0&&t[0].hasOwnProperty("message")?a(t[0].message):a()}else n(e)})).catch((e=>{console.log("PREPARE BRANCH Failure..."+object),a(e)}))}))},_enrichPayloadForTrackerBackEnd:function(e){var t={UXName:"NewBranch"};t.isWebInWin=this.wintop,this.options&&this.options.client_app_domain&&(t.client_app_domain=this.options.client_app_domain),this.options&&this.options.client_app_name&&(t.client_app_name=this.options.client_app_name),B.enrichRequestWithMetricsWebInWin(e,t)},executeCmd:function(e,t,i){null==t&&(t={}),null==i&&(i=function(){});var r=this;this.trackerEventBeginTime=Date.now(),this._onComplete=function(){i(),this.wintop&&this._CloseWebInWinPanel(),N.removeCrossHighlightWithColor({widgetId:C.getWidgetId(),appId:n._getAppId(widget)})},this._onCompleteWithoutClose=function(){i()},t.hasOwnProperty("context")&&(this.context=t.context),console.log("executeCmd / tenant: "+this.tenant);try{if(0===(e=this._getUniqueListBy(e,"physicalid")).length)throw R.noObject;e.forEach((function(e){if(!(e.objectId||e.physicalid))throw R.epmtyPhysicalId;null===r.tenant&&(console.log("executeCmd / setting tenant from selection: "+e.tenant),r.tenant=e.tenant,r.commandManager.setTenant(r.tenant))})),this.selectionList=e}catch(e){throw console.log("executeCmd / "+e),e}this.folderId=t.targetFolderId;try{if(void 0!==a.getActiveFolder){var l=a.getActiveFolder();void 0!==l.id&&null!==l.id&&""!==l.id&&(this.folderId=l.id,require(["DS/PlatformAPI/PlatformAPI"],(function(e){e.publish("FolderEditor.ActiveFolderCallBack",{id:l.id,label:l.label})})))}}catch(e){this.folderId=t.targetFolderId}var c=o.loadDefaultContexCredential({tenant:this.tenant,context:this.context}),d=new Promise(((e,t)=>{s.loadCredentialsFromGetdgnctx(r.tenant).then((t=>{var i=t.map((e=>({ctx:e.ctx,displayName:e.displayName})));s.filterCredentialsEx(r.tenant,i,"branch").then((i=>{this.allCredentials=i;let n=i.filter((e=>!e.isFiltered)).map((e=>{let i=t.filter((t=>t.ctx===e.secCtx));return{prjTitle:i?i[0].prjTitle:e.secCtx,ctx:e.secCtx,isPrivate:e.isPrivate,orgTitle:i?i[0].orgTitle:""}}));n.length>0?(n=n.sort(((e,t)=>e.prjTitle.localeCompare(t.prjTitle,void 0,{numeric:!0,sensitivity:"base"}))),e(n)):e([])})).catch((t=>{console.error("Failed to call credential filter svc, error:",t),e()}))}))}));UWA.Promise.all([c,d]).then((([e,t])=>{r._securityContext=e||"",r._defaultCtx=e,console.log("executeCmd / security context: "+r._securityContext),UWA.is(t,"array")?r._userCredentials=s.groupCredentialsByCollabSpace(t):(r._userCredentials=[],console.error("Missing credentials"),r.showError(F.errCredFilterSvc)),r._verifyAndSetObjects()})).catch((e=>{throw console.log("executeCmd / "+e),e}))},executeOk:function(){this._onOk()},cancel:function(){this._onCancel()},_verifyAndSetObjects:function(){var e=this,t=null;console.log("before PREPARE BRANCH"),this._setWaitingResponse(),this._NewBranchWafDataPromise("prepare_newbranch_completesel",{data:this.selectionList}).then((t=>{var i=t.results;if(!Array.isArray(i)||0===i.length)throw R.objectNotFound;if(e.nbDisplayedObjects=0,i.forEach((function(t){if(!(t.objectId||t.physicalid))throw R.epmtyPhysicalId;1==t.visible&&e.nbDisplayedObjects++})),e.nbDisplayedObjects<=0)throw R.objectNotFound;if(e.objectsList=i,this._computeRoots(),e.objectsList.forEach((t=>{t.isRoot&&e.rootIds.push(t.physicalid),t.parentid||1!=t.visible||e.advIds.push(t.physicalid)})),e.rootIds.length<1&&e.selectionList.forEach((function(t){e.rootIds.push(t.physicalid)})),i.some((t=>e._isMIB(t)))||e.wintop)return t;var n=[];return e.rootIds.forEach((function(e){n.push({physicalid:e})})),this._WafDataPromise("/resources/lifecycle/duplicate/capabilites",{data:n,enableProto:!0,validateInput:!0,command:"branch"})})).then((t=>{if(t.providers&&(e.providerIdSet=new Set([].concat(...t.providers.filter((e=>e.capabilities.find((e=>"84a058e4-4e05-4fc3-8c2f-ed137631d5ae"==e.id)))).map((e=>e.objectIds))))),Array.isArray(t.validationFailures)&&t.validationFailures.length>0){for(var i of t.validationFailures){var n=i.objects.map((e=>e.pid));this.objectsList=this.objectsList.filter((e=>!n.includes(e.physicalid))),this.selectionList=this.selectionList.filter((e=>!n.includes(e.physicalid))),this.advIds=this.advIds.filter((e=>!n.includes(e)))}if(0===this.objectsList.length)throw t.validationFailures[0].errorMessage;this.showNotification(F.notSupportedRemoved)}e.nbDisplayedObjects=0,this.objectsList.forEach((function(t){1==t.visible&&e.nbDisplayedObjects++}))})).then((()=>{var t=[];return e.objectsList.forEach((function(e){var i=e.objectId||e.physicalid;t.push(i)})),console.log("executeCmd / pids size: "+t.length),Promise.all([n.getAllowedSemanticsPromise(t,e.context,{nlsintents:!0,scope:"branch"}),this._NewBranchWafDataPromise("prepare_newbranch_checkavailability",{data:e.objectsList})])})).then((([i,a])=>{if(console.log("executeCmd / getAllowedSemanticsPromise done"),n.isBaselineMode(void 0,i)&&"ConfiguredBaseline"!==e.selectionList[0].type){if(e.selectionList.length>1)throw e._setEndWaitingResponse(),R.multipleSelectionObjectsNotSupported;e._setEndWaitingResponse(),require(["DS/HistoryExplorer/HistoryDialog"],(function(t){(new t).executeCmd(e.selectionList,{getAllowedSemanticsResponse:i,context:e.context,name:"history_command"},(()=>{e._onComplete()}))}))}else{if(n.isEffectivityBasedOrEffectivityBasedReuseMode(void 0,i)&&"xRevisionElement"!==e.selectionList[0].policy){if(e._setEndWaitingResponse(),e.selectionList.length>1)throw R.multipleSelectionObjectsNotSupported;var s=n.getRevisionMode(e.selectionList[0].physicalid,i),r=R.effectivity_based;"effectivity_based_reused"===s?r=R.effectivity_based_reused:"effectivity_based_model"===s&&(r=R.effectivity_based_model);var o=h=e.selectionList[0].name?e.selectionList[0].name:e.selectionList[0].displayName;r===R.effectivity_based_reused&&(o=n.getgraphProprietary(e.selectionList[0].physicalid,i).label);var l=R.replace(R.newBranchFailedTitleSingleSel,{dispName:h}),c=R.replace(R.objectUseRevisionMode,{revisionModeName:r}),d=R.replace(R.useRevisionsToCreateBranch,{dispName:o,xRevisionTypeName:R.xRevisionTypeName});throw t={title:l,subtitle:c,submessage:d},R.revisionModeNotSupported}if(e.selectionList[0].revisionModeInfo&&"effectivity_based_reused"===e.selectionList[0].revisionModeInfo.revisionMode){e._setEndWaitingResponse();r=R.effectivity_based_reused;var h=e.selectionList[0].name?e.selectionList[0].name:e.selectionList[0].displayName;l=R.replace(R.newBranchFailedTitleSingleSel,{dispName:h}),c=R.replace(R.objectUseRevisionMode,{revisionModeName:r}),d=R.replace(R.switchToMasterRevisionsGraphBranch,{graphProprietary:e.selectionList[0].revisionModeInfo.graphProprietary.label});throw t={title:l,subtitle:c,submessage:d},R.revisionModeNotSupported}var u=i.allowedSemantics;if(!Array.isArray(u)||0==u.length)throw R.objectNotFound;e.displayIntentsList=!1;var p=["S","F","D"],g=[...p];u.forEach((t=>{if(!Array.isArray(t.semantic))throw R.objectNotFound;var i=[];p.forEach((e=>{t.semantic.includes(e)&&i.push(e)})),p=i;let n=0;g.forEach((e=>{t.semantic.includes(e)&&n++})),n>1&&(e.displayIntentsList=!0)}));var m=i.intents;if(!Array.isArray(m)||0==m.length)throw R.objectNotFound;var f=new Map;m.forEach((e=>{f.set(e.short,e)}));var v=[];p.forEach((e=>{var t=f.get(e);t&&v.push({operation:t.id,nls:t.title})})),e.intentsList=v;var b=new Map;u.forEach((e=>{b.set(e.id,e)}));var _=a.results;if(!Array.isArray(_)||0==_.length)throw R.objectNotFound;e.isThereLinearData=!1,e.effectivityBasedModelCase=!1;var y=!0;if(_.forEach((t=>{var i=t.objectId||t.physicalid;if(!i)throw R.epmtyPhysicalId;var n=b.get(i);if(!n)throw R.objectNotFound;var a=n.semantic;Array.isArray(a)&&(t.availableSemantic=a);var s=n.mode,r=!0;Array.isArray(s)&&s.includes("linear")&&(r=!1,e.isThereLinearData=!0),Array.isArray(s)&&s.includes("effectivity_based_model")&&(r=!1,e.effectivityBasedModelCase=!0),"No"===t.EvolutionAvailability&&(console.log("type "+t.type+" is not valid for New Branch (EvolutionAvailability===No)"),y=!1),"Yes"===t.EvolutionAvailability||r||(console.log("type "+t.type+" is not valid for New Branch (EvolutionAvailability is no set while type is not NLV)"),y=!1)})),!y)throw 1==_.length?R.evolutionAvailabilityFalseMonoSelection:R.evolutionAvailabilityFalseMultiSelection;if(!Array.isArray(v)||0==v.length)throw R.noValidIntent;e.objectsList=_,e._prepareDataForDisplay()}})).catch((i=>{e._setEndWaitingResponse();let n=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,a={UXName:"NewBranch",models:e.selectionList,actionStatus:"failure",actionTime:n};e.trackerEvent=W.createInitActionEvent(a),W.checkAndTrackPageEvent(e.trackerEvent),console.log("executeCmd / prepare new branch error "+i),e.showErrorThenComplete(i,t)}))},_prepareDataForDisplay:function(){var e=this;a.get3DSpaceBaseUrl(this.tenant);this._NewBranchWafDataPromise("prepare_attributeslist",{data:this.objectsList,attributes:["type","current","branch.current","name","attribute[PLMEntity.V_Name]","Title","attribute[Title]","attribute[PLMReference.V_versionComment]","branch.description","type.kindof[PLMReference]","imageUrl"]}).then((e=>{var t=e.results;if(!Array.isArray(t)||0===t.length)throw R.objectNotFound;return t.forEach((function(e){e.hasOwnProperty("attribute[PLMEntity.V_Name]")&&!e["attribute[PLMEntity.V_Name]"]&&delete e["attribute[PLMEntity.V_Name]"],e.hasOwnProperty("Title")&&!e.Title&&delete e.Title,e.hasOwnProperty("attribute[Title]")&&!e["attribute[Title]"]&&delete e["attribute[Title]"]})),this.objectsList=t,this.objectsList.forEach((function(e){e.current_internal=e.current})),this._displayAsMultiSelPanel()||this._isMIB(this.objectsList[0])?void 0:(this.initBL_already_called=!0,this._WafDataPromise("/resources/lifecycle/duplicate/initialize_objects",{data:this.objectsList,operationDetail:"NewEvolution"}))})).then((e=>{var t=new Map;e&&Array.isArray(e.results)&&e.results.forEach((e=>{e.objectId&&Array.isArray(e.attrs)&&e.attrs.length>0&&t.set(e.objectId,e.attrs)})),this.objectsList.forEach((e=>{var i=e.objectId||e.physicalid,n=t.get(i);Array.isArray(n)&&n.length>0&&(e.modifiedAttributes||(e.modifiedAttributes={}),n.forEach((t=>{t.name&&t.value&&(e.modifiedAttributes[t.name]=t.value)})))}));var i=[];return this.objectsList.forEach((function(e){var t=e.objectId||e.physicalid;i.push(t)})),this._displayAsMultiSelPanel()?void 0:n.getVersionNumberProposalPromise(i,this.intentsList.length>0?this.intentsList[0].operation:"",null,this.context)})).then((e=>{var t=new Map;return e&&Array.isArray(e.addRequests)&&e.addRequests.forEach((e=>{t.set(e.copyId,e.code)})),this.objectsList.forEach((e=>{var i=e.objectId||e.physicalid,n=t.get(i);n&&(e.proposedRevision=n,e.modifiedAttributes||(e.modifiedAttributes={}),e.modifiedAttributes.revision=n)})),this._displayAsMultiSelPanel()?{results:this.objectsList}:this._NewBranchWafDataPromise("prepare_newbranch_maskattributes",{data:this.objectsList})})).then((e=>{var t=e.results;if(!Array.isArray(t)||0===t.length)throw R.objectNotFound;this.objectsList=t,this._setEndWaitingResponse(),console.log("PREPARE BRANCH finished"),this._showCommandUI()})).catch((t=>{this._setEndWaitingResponse();let i=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,n={UXName:"NewBranch",models:e.selectionList,actionStatus:"failure",actionTime:i};e.trackerEvent=W.createInitActionEvent(n),W.checkAndTrackPageEvent(e.trackerEvent),console.log("PREPARE BRANCH Failure..."+t),this.showErrorThenComplete(t)}))},_computeRoots:function(){var e=this;let t=new Map;if(!this.wintop){let e=new k;t=e.getAppSelectionRootsPerIds(this.context)}let i=new Set;t.forEach((e=>i.add(e.getID())));let n=!0;this.objectsList.length<=1&&(n=!1),n=n&&this.objectsList.every((e=>!e.visible||t.has(e.physicalid)||e.parentid&&t.has(e.parentid))),this.objectsList.forEach((function(a){if(n)a.physicalid&&i.has(a.physicalid)?a.isRoot=!0:a.isRoot=!1,a.physicalid&&t.has(a.physicalid)&&(a.rootid=t.get(a.physicalid).getID()),a.parentid&&t.has(a.parentid)&&(a.rootid=t.get(a.parentid).getID());else if(a.physicalid){var s=!1;e.selectionList.forEach((function(e){a.physicalid==e.physicalid&&(s=!0)})),s&&!a.parentid?a.isRoot=!0:a.isRoot=!1}else a.isRoot=!1}))},_showCommandUI:function(){var e=this,t=this.content,i="";if(this._displayAsMultiSelPanel())this.objectsList.forEach((e=>{e["attribute[PLMEntity.V_Name]"]&&(e.name=e["attribute[PLMEntity.V_Name]"]),e["attribute[Title]"]&&(e.name=e["attribute[Title]"]),e.Title&&(e.name=e.Title)})),this.content.classList.add("css_grid_container"),this.dgvContainer=new _({idName:"dgvContainer",clickToShowDGV:!1,onContextualEvent:function(e){if(e?.collectionView){let t={filter:!1,pin:!1,sizeColumnToFit:!1,columnsManagement:!1,firstColumnsVisibility:!0};return e.collectionView.buildDefaultContextualMenu(e,t)}}},e.objectsList),this.dgvContainer.inject(t,"top"),i=" - "+this.nbDisplayedObjects+" "+R.multipleSelectionObjects,this.container&&this.container.addClassName("multiSel");else{var n=!1;this.objectsList.forEach((t=>{var i=this._isMIB(t),a="",s="",r="",o=!0;t["attribute[PLMEntity.V_Name]"]&&(a="attribute[PLMEntity.V_Name]"),t["attribute[PLMEntity.V_Name]"]&&(s="PLMEntity.V_Name"),t["attribute[PLMEntity.V_Name]"]&&(r=t["attribute[PLMEntity.V_Name]"]),t.Title&&(a="Title"),t.Title&&(s="Title"),t.Title&&(r=t.Title),t.computedLabel&&t.computedLabel.selectable&&(a=t.computedLabel.selectable),t.computedLabel&&t.computedLabel.path&&(s=t.computedLabel.path),t.computedLabel&&t.computedLabel.value&&t.computedLabel.value.length>=1&&(r=t.computedLabel.value[0]);var l=[];if(t.hasOwnProperty("attributes_mask")&&(l=t.attributes_mask),l.forEach((function(e){e.selectable==a&&!0===e.readOnly&&(o=!1)})),!i&&a&&(n=!0),console.log("showTitle: "+n),n&&(console.log("title selectable: "+a),console.log("title path: "+s),console.log("title value: "+r),console.log("title editable: "+o)),t.modifiedAttributes||(t.modifiedAttributes={}),t.volatileAttributes||(t.volatileAttributes={}),n&&o&&s&&!t.modifiedAttributes.hasOwnProperty(s)&&e.dup_string&&(t.modifiedAttributes[s]=e.dup_string+r),t.hasOwnProperty("attributes_mask")||(t.attributes_mask=[]),"TRUE"!==t["type.kindof[PLMReference]"]||i||t.attributes_mask.push({selectable:"attribute[PLMReference.V_versionComment]",path:"PLMReference.V_versionComment",readOnly:!1,maxlength:256,multiline:!0,nls:U.LifecycleObjectList_versionComment}),i&&(t.attributes_mask.push({selectable:"description",path:"description",readOnly:!1,maxlength:256,multiline:!0,nls:U.LifecycleObjectList_versionComment}),t.attributes_mask.push({selectable:"branchTitle",path:"branchTitle",readOnly:!1,maxlength:256,nls:F.BranchTitle})),!e.without_cred){var c=M.createCredentialAttributeMask(e,e._userCredentials,e._defaultCtx,e._onCredentialSelectionChangedMonoSel.bind(e));e._userCredentials&&e._userCredentials.size>0&&(this.hasCredentials=!0),t.attributes_mask.push(c.collaborativeSpaceAttributeMask),e._userCredentials&&e._userCredentials.isMultipleOrg&&t.attributes_mask.push(c.organizationAttributeMask),t.volatileAttributes.organization=c.defaultValueOrganization,t.volatileAttributes.collaborativeSpace=c.defaultValueCollabSpace,this.isTargetCSPrivate=this._getIsCSPrivateFromSecCtx(c.defaultValueCredential)}}));var a={className:"newbranch_prop is-mobile simpbranch-option",data_rec_id:"newbranch_prop_rec-id",showTitle:n,showProposedRevision:!0,editable:!0,identifier:"LifecycleNewBranchWidget"};this.objectProp=new E(a),this.objectProp.inject(t),!this.wintop&&this.intentsList.length<=1&&this.providerIdSet.size>0&&this.createAdvancedUI(t,!1);let s=this.displayIntentsList;if(this.objectProp.setObject(this.objectsList[0],s?this.intentsList:null,null),this.objectProp.addEvent("onAttributeValidationError",(e=>{e.forEach((e=>{this.showNotificationInDialog(e)}))})),this.objectProp.addEvent("onIntentChanged",(function(){e._onItentSeletionChangedMonoSel()})),Array.isArray(this.selectionList)&&this.selectionList.length&&this.selectionList[0].name){let e=this.selectionList[0].revision?" "+this.selectionList[0].revision:"";i=" - "+this.selectionList[0].name+e}}var s=!0,r=!1,o=!1;this.objectsList.forEach((e=>{e.physicalid&&!e.physicalid.startsWith("cid:")&&(s=!1),e.physicalid&&e.physicalid.startsWith("cid:")&&(r=!0),(e.module||e.contenturl)&&(r=!0),"TRUE"===e["type.kindof[PLMReference]"]&&(o=!0)}));var c=!1;if(this._displayAsMultiSelPanel()&&(o||r)){UWA.createElement("div",{class:"comment_label simpbranch-option",text:U.LifecycleObjectList_versionComment}).inject(t),this.commentInput=(t=>{let i=new f({placeholder:V["Enter a text"],widthInCharNumber:45,newLineMode:"enter"});return i.addEventListener("change",(function(){t.forEach((function(e){e.modifiedAttributes||(e.modifiedAttributes={}),e.modifiedAttributes["PLMReference.V_versionComment"]=i.value})),i.getContent().setAttribute("title",i.value)})),i.addEventListener("uncommittedChange",(function(){i.getContent().setAttribute("title",i.valueToCommit);var t=e._checkVersionCommentValue(i.valueToCommit);t&&e.showNotificationInDialog(t)})),i.getContent().addClassName("comment_input simpbranch-option"),i})(e.objectsList),this.commentInput.inject(t),c=!0}var d=!1;if(this._displayAsMultiSelPanel()&&(this.isThereLinearData||this.effectivityBasedModelCase)&&!s){new UWA.Element("text",{text:F.Prefix,class:"newbranch_dupstring_title simpbranch-option"}).inject(t);var h=UWA.createElement("div",{class:"newbranch_dupstring_input simpbranch-option"});h.inject(t),this.dupStringInput=new v({}),this.dupStringInput.getContent().addClassName("newbranch_dupstring_input_ed"),this.dupStringInput.inject(h),""!==this.dup_string&&(this.dupStringInput.value=this.dup_string),d=!0}this._displayAsMultiSelPanel()&&s&&(new UWA.Element("text",{text:F.BranchTitle,class:"newbranch_branchtitle simpbranch-option"}).inject(t),this.branchTitleInput=(e=>{let t=new v({});return t.getContent().addClassName("newbranch_branchtitle_input simpbranch-option"),t.addEventListener("change",(function(){e.forEach((function(e){e.modifiedAttributes||(e.modifiedAttributes={}),e.modifiedAttributes.branchTitle=t.value})),t.getContent().setAttribute("title",t.value)})),t.addEventListener("uncommittedChange",(function(){t.getContent().setAttribute("title",t.valueToCommit)})),t})(e.objectsList),this.branchTitleInput.inject(t));var u=!1;let g=this.displayIntentsList;if(this._displayAsMultiSelPanel()&&g){new UWA.Element("div",{class:"newbranch_intentslist_text",text:F.IntentSelection}).inject(t);var y=[];this.intentsList.forEach((function(e){y.push({labelItem:e.nls,valueItem:e.operation})})),this.intentsListSel=new m({elementsList:y,selectedIndex:0,enableSearchFlag:!1}),this.intentsListSel.inject(t),this.intentsListSel.addEventListener("change",(function(){e.dispatchEvent("onIntentChangedForODT")})),u=!0}if(this.wintop){let i=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,n={UXName:"NewBranch",models:this.objectsList,actionStatus:"success",actionTime:i};this._displayAsMultiSelPanel()?n.UXMode="ListView":n.UXMode="ObjectView",this.intentsList.length>1&&(n.pv19=this.intentsList.length),this.trackerEvent=W.createInitActionEvent(n),W.checkAndTrackPageEvent(this.trackerEvent);var C=new p({value:F.BtnOK,name:"NewBranchButtonOk",className:"default medium primary"}),A=new p({value:F.BtnCancel,name:"NewBranchButtonCancel",className:"default medium"});C.inject(this.footerDiv),A.inject(this.footerDiv),this._onOkPromise=function(){return new Promise((t=>{var i=e._checkBeforeExecute();null!=i&&i.length>0&&(e.showNotificationInDialog(i[0]),t()),C.setDisabled(),A.setDisabled(),this._setWaitingResponse(),this.trackerEventBeginTime=Date.now(),e._executeNewBranch().then((i=>{i.messageToDisplay=R.newBranchSuccessfulWin,e._setEndWaitingResponse(),t(i)}),(i=>{e._setEndWaitingResponse(),t(i)}))}))},this._onOkPromiseFromWin=function(){return new Promise((t=>{e._onOkPromise().then((i=>{var n=JSON.stringify(i);t(n),e._onCompleteWithoutClose()}))}))},this._onOk=function(){C.setDisabled(),A.setDisabled();var t=require("DS/WebInWinUtils/dscef");t&&t.isA2X?e._onOkPromiseFromWin().then((t=>{var i=JSON.parse(t);i.andClose=!0,e.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"dispatchWinAction",notif_parameters:{action:"WebToWinAction_PostTreatment",data:i}},"lf_web_in_win")})):e.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"dispatchWinAction",notif_parameters:{action:"WebToWinAction_OnOKButton",data:{ExecuteSync:"_onOkPromiseFromWin",timeout:1e6}}},"lf_web_in_win")},this._onCancel=function(){C.setDisabled(),A.setDisabled(),e._onComplete()},C.addEvents({onClick:function(){e._onOk()}}),A.addEvents({onClick:function(){e._onCancel()}}),setTimeout((()=>{t.style.minHeight="127px";let i=t.querySelector(".EditProp_MainContain");i&&(i.style.minHeight=""),this.auto_execute?(console.log("launching automatically execution of the command"),C.dispatchEvent("onClick")):e.dispatchEvent("onReady")}),10)}else{this.rootGrid=UWA.createElement("div",{class:"lcm-branch-root-grid"}),t.inject(this.rootGrid);let n=UWA.createElement("div",{class:"lcm-cspace-warn-root"});n.inject(this.rootGrid),UWA.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-attention lcm-cspace-warn-icon"}).inject(n);let a=UWA.createElement("div",{class:"lcm-cspace-warn-msg"});a.innerText=R.selectedCSNotPrivate,a.inject(n);var L=new b;let s=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,r={UXName:"NewBranch",models:this.objectsList,actionStatus:"success",actionTime:s};this._displayAsMultiSelPanel()?r.UXMode="ListView":r.UXMode="ObjectView",this.intentsList.length>1&&(r.pv19=this.intentsList.length),this.trackerEvent=W.createInitActionEvent(r),W.checkAndTrackPageEvent(this.trackerEvent),this._onOk=function(){if(!this.useAdvancedBranch){var t=e._checkBeforeExecute();if(null!=t&&t.length>0)return e.showNotificationInDialog(t[0]),L._okButton&&L._okButton.setDisabled(!1),L._cancelButton&&L._cancelButton.setDisabled(!1),void(L._closeButton&&(L._closeButton.disabled=!1))}this._setWaitingResponse(),this.trackerEventBeginTime=Date.now(),e._executeNewBranch().then((t=>{e.showSuccess(R.newBranchSuccessful),e.useAdvancedBranch&&e.filteredRoots.size>0&&e.showNotification(R.activeFilterStored,{title:R.activeFilterStoredTitle}),t.warnings&&t.warnings.forEach((t=>{console.log(t.message);let i=t.opts||{};t.hasHtml&&(i.hasHtml=!0),t.sticky&&(i.sticky=!0),e.showNotification(t.message,i)}));try{t&&w.dispatchEvent("onModification",t)}catch(e){console.log("error while calling onModification:"),console.log(e)}e._setEndWaitingResponse(),e._onComplete(),L.destroy()}),(t=>{t&&t.errors&&t.errors.forEach((t=>{let i=t.opts||{};t.hasHtml&&(i.hasHtml=!0),e.showError(t.message,i)})),t&&t.notifs&&t.notifs.forEach((t=>{let i=t.opts||{};t.hasHtml&&(i.hasHtml=!0),t.sticky&&(i.sticky=!0),e.showNotification(t.message,i)})),e._setEndWaitingResponse(),e._onComplete(),L.destroy()}))},this._onCancel=function(){e._setEndWaitingResponse(),e._onComplete(),L.destroy()};var D=L.create(this.rootGrid,{title:F.CommandDialogTitle+i,OKBtnText:F.BtnOK,closeButton:!0,resizable:!0,powerMaximize:!0,imageUrl:this.selectionList[0].imageUrl||"",onOk:function(){e._onOk()},onClose:function(){e._onCancel()}});this.dialog=D,this.commandDialog=L,this.commandDialog.addEvent("widget-maxmized-changed",(function(t){t&&e.useAdvancedBranch&&e.commandDialog.maximize(!0)})),this.commandDialog&&this.commandDialog.setPowermaximizeVisibility(!1),this._displayAsMultiSelPanel()&&D.elements.container.addClassName("multiSel"),this.without_cred||this._userCredentials&&0!=this._userCredentials.length||L._okButton&&L._okButton.setDisabled(),D.inject(widget.body);var P=D.getContent();P||(P=widget.body),this.errorOverlay=new I(this,P,{className:"newbranch_errorManager"});var j=this._displayAsMultiSelPanel(),T=0;l.isTouchMode()&&(T+=j?70:40);var k=j?600:646,B=320+(c?41:0)+(d?29:0)+(u?29:0)+24*(this.nbDisplayedObjects-2)+T;!j&&this.objectProp&&(B=this.objectProp.getComputedMinHeight()+163+28+T);var N=B;D.setNewSize({width:k,height:B}),setTimeout((()=>{let i=t.querySelector(".EditProp_MainContain");if(i&&(i.style.minHeight=""),D.setMinSize(530,N),!this.without_cred&&this._displayAsMultiSelPanel()){let i=D.elements.body.querySelector(".newbranch_grid_container");if(i||(i=D.elements.body.querySelector(".newbranch_content")),this._userCredentials&&this._userCredentials.size>=1){var n=S.createCredentialComboBox({userCredentials:this._userCredentials,dialog:D,dialogContainer:i,className:"simpbranch-option",defaultCtx:this._defaultCtx,activateOkButtonCallback:this._activateOkButton.bind(this)});this.dispatchEvent("CredentialUiCreated",n),this.credComboCollabSpace=n[0],this.credComboOrg=n[1],this.credComboCollabSpace.addEventListener("change",(t=>{console.log("Credentials changed:"+this.credComboCollabSpace.currentLabel),S.manageComboCollabSpaceChange(e._userCredentials,this.credComboCollabSpace,this.credComboOrg),this._activateOkButton(),this.updateCSWarning()})),this._getIsTargetCSPrivate=()=>!!this.credComboOrg.value&&this.credComboOrg.value.isPrivate}else{let t=S.manageNoCredential({dialog:D,dialogContainer:i});e.dispatchEvent("CredentialUiCreated",t.combos),this.showError(t.title,t),this._getIsTargetCSPrivate=()=>!1}this.intentsList.length<=1&&!this.objectsList.some((t=>e._isMIB(t)))&&!this.objectsList.some((t=>e.advProhibitedTypes.includes(t.type)))&&this.createAdvancedUI(t,!0)}if(!this.hasCredentials&&!this.without_cred&&!this._displayAsMultiSelPanel()){var a=M.manageNoCredential(this.dialog);console.log(a.title),e.showError(a.title,a)}e.updateCSWarning(),e.dispatchEvent("onReady")}),10)}},createAdvancedUI:function(e,t){var i=this;let n;this.searchForFilter=!1;let a=new UWA.createElement("div",{id:"adv-content"});a.setStyle("height","100%"),a.setStyle("display","none"),a.inject(e);let s=new UWA.createElement("div",{id:"advbranch-expcontainer",class:t?"advanced_multisel":""});(!t&&"ENOLCMI_AP"===widget.data.appId&&"VPMReferenceExtPos"===this.objectsList[0].type||L.isKindOfFromCache(["VPMReferenceExtPos"],this.objectsList[0].type))&&(this.searchForFilter=!0,s.addClassName("withfilter"),n=new g({domId:"filter-toggle",displayStyle:"lite",label:"lite displayStyle",icon:{iconName:"filter-search",fontIconFamily:WUXManagedFontIcons.Font3DS},showLabelFlag:!1,value:!0}),n.getContent().setAttribute("title","Search for filter"),n.addEventListener("buttonclick",(function(){!0===n.value?(i.searchForFilter=!1,n.icon={iconName:"filter-delete",fontIconFamily:WUXManagedFontIcons.Font3DS},n.value=!1,n.getContent().setAttribute("title",F.doNotSearchForFilter)):(i.searchForFilter=!0,n.icon={iconName:"filter-search",fontIconFamily:WUXManagedFontIcons.Font3DS},n.value=!0,n.getContent().setAttribute("title",F.searchForFilter))})),n.inject(s));let r=new UWA.createElement("div",{text:F.NewBranchAdvanced,class:"advbranch-expander"+(t?" advanced_multisel":""),id:"expander"});r.addEventListener("click",(function(){i.searchForFilter?x.launchSearch({role:"",bMultiSel:!1,additionalQuery:"internal_95_path_95_enostrrefinementvdrpspec_46_enostrrefrootextpos:(((("+i.objectsList[0].physicalid+' BEFORE/1 "PE"))) SPLIT "Sep")',in_apps_callback:function(e){i._applySelectedFilter(e),n.disabled=!0,i.searchForFilter=!1}}):(n&&(n.disabled=!0),i.useAdvancedBranch=!0,i._openAdvancedBranchTree())})),r.inject(s),s.inject(e),this.hasCredentials||(r.style.pointerEvents="none")},_applySelectedFilter:function(e){var t,i=this,a=e[0];n.getPublicVDRPFilterSpecificationPromise(this.context,a.id).then((e=>(t=e,n.getVDRPExpandSpecPromise(this.context,e)))).then((e=>{var n=e[0],a=e[1];for(var s of e)if(s.root&&s.root.physical_id){var r=s.root.physical_id;i.filteredRoots.set(r,t),-1===i.advIds.indexOf(r)&&(i.advIds.push(r),i.providerIdSet.add(r)),-1===i.rootIds.indexOf(r)&&i.rootIds.push(r)}i.hasFilter=e=>({hasFilter:!!i.rootIds.includes(e)}),i.GetFilterSpec=(e,t)=>{if(t.V2){if(n.root&&n.root.physical_id&&n.root.physical_id===e)return{filter:n.filter,aggregation_processors:[]};if(a.root&&a.root.physical_id&&a.root.physical_id===e)return{filter:a.filter,aggregation_processors:[]}}},i.useAdvancedBranch=!0,i._openAdvancedBranchTree()}))},_checkTitleValue:function(){var e=this.objectsList.map((e=>e.name)).reduce((function(e,t){return e.length>t.length?e:t}));if((this.dupStringInput._myInput.value+e).length>100){var t=require("i18n!DS/EditPropWidget/assets/nls/langEditProp"),i="Title error";return t&&(i=t.replace(t.get("MaxLengthAttribute"),{label:U.LifecycleObjectList_title,value:100})),{code:"ERROR",eventID:"warning",message:i}}return null},_openAdvancedBranchTree:function(){var e=this,i=UWA.extendElement(this.content.querySelector("#adv-content"));this.immersiveFrame=this.immersiveFrame||this._createImmersiveFrame(i);var n=UWA.extendElement(this.content.querySelector(".immersive-frame-parent"));this.expandReqBuilder=this.expandReqBuilder||new j(this.context,"branch",{hasFilter:this.hasFilter,GetFilterSpec:this.GetFilterSpec}),this._delayedMask||(this._delayedMask=new r(n,1e3,F.loadingText)),this.advancedBranchTree?(this.advancedBranchTree.launchCrossHighlightWithColor(),this.advancedBranchTree.updateInvalidElements(),this.advancedBranchTree.updateSubmitBtnState()):this.advancedBranchTree=this._createAdvancedBranchTree(i);var a=UWA.extendElement(e.content.querySelector("#collapser"));a||((a=new UWA.createElement("div",{text:F.NewBranchBasic,id:"collapser",class:"advbranch-expander"})).setStyle("display","none"),a.addEventListener("click",(function(){e.useAdvancedBranch=!1,e._closeAdvancedBranchTree(e.dialog)})),a.inject(i)),this.dialog.elements.container.classList.add("advanced-mode"),t(this.dialog.elements.container).find(".simpbranch-option").slideUp(150),t(this.dialog.elements.container).find("#dgvContainer").slideUp(150);var s=UWA.extendElement(e.content.querySelector("#expander"));i.setStyle("display","block"),s.setStyle("display","none"),a.setStyle("display","block"),"function"==typeof this.dialog._handleWidgetResize&&this.dialog._handleWidgetResize(),this._adjustDialogSizeLarge(this.dialog),this.dialog.centerIt(),this.updateCSWarning()},_closeAdvancedBranchTree:function(){this.dialog.elements.container.classList.remove("advanced-mode"),t(this.dialog.elements.container).find(".simpbranch-option").slideDown(150),t(this.dialog.elements.container).find("#dgvContainer").slideDown(150),UWA.extendElement(this.content.querySelector("#adv-content")).setStyle("display","none"),UWA.extendElement(this.content.querySelector("#expander")).setStyle("display",""),this._adjustDialogSizeSmall(this.dialog),this.dialog.centerIt();var e=this.dialog.elements.footer.querySelector(".btn-primary");e&&(e.disabled=!1),N.removeCrossHighlightWithColor({widgetId:C.getWidgetId(),appId:n._getAppId(widget)}),this.updateCSWarning()},_createImmersiveFrame:function(e){if(this.immersiveFrame)return this.immersiveFrame;var t=new D({identifier:"4046f1f2-6823-11e9-a923-1681be663d3e"});t.dockingElements.forEach((function(e){e._properties.side.value===WUXDockAreaEnum.TopDockArea||e._properties.side.value==WUXDockAreaEnum.BottomDockArea?e._properties.dockingZoneSize.value=120:e._properties.side.value!==WUXDockAreaEnum.LeftDockArea&&e._properties.side.value!=WUXDockAreaEnum.RightDockArea||(e._properties.dockingZoneSize.value=230)}));var i=UWA.createElement("div",{class:"immersive-frame-parent"});return i.inject(e),t.inject(i),t},_createAdvancedBranchTree:function(e){var t=this;if(this.trackerEventBeginTime=Date.now(),!t.trackerEvent){let e={UXName:"NewBranch",numberObjects:0};t.trackerEvent=W.createInitActionEvent(e)}var i=new P({submitElement:this.dialog.elements.footer.querySelector(".btn-primary"),tenant:this.tenant,showError:this.showError.bind(this),identifier:"branch",roots:this.rootIds,metadata:{widgetId:C.getWidgetId(),appId:n._getAppId(widget)},getAuthoringMode:this._getAuthoringMode.bind(this)});i.addEvent("expandingStructure",(function(e){var i=t.dialog.elements.footer.querySelector(".btn-primary");i&&(i.disabled=!0)}));let a=this._getOrCreateTreeLoader();return i.loadUI({parentElement:e,immersiveFrame:this.immersiveFrame,securityContext:this._securityContext,treeLoader:a}),i.addEvent("onTreeListCreated",(function(e){t._delayedMask&&t._delayedMask.unmask(),t.filteredRoots.size>t.treeLoader.filteredRoots.size&&(t.treeLoader.filteredRoots=t.filteredRoots),i.treeList.onInitialUpdateView().then((function(){i.initInvalidElements(),t.dispatchEvent("AdvancedUICreated",i);let e=t.trackerEventBeginTime?Date.now()-t.trackerEventBeginTime:0,n={UXMode:"Advanced",numberObjects:i.getTreeData().length,actionStatus:"success",actionTime:e};t.trackerEvent=W.createInitActionEvent(n,t.trackerEvent),W.checkAndTrackPageEvent(t.trackerEvent)})),i.translationService.translationFailure&&t.showNotification("Translation failed")})),i},_getOrCreateTreeLoader:function(){return this.treeLoader||(this.treeLoader=new T({roots:this.advIds,context:this.context,tenant:this.tenant,providerIdSet:this.providerIdSet,objectsList:this.objectsList,expandReqBuilder:this.expandReqBuilder,getAuthoringMode:this._getAuthoringMode.bind(this)})),this.treeLoader},_getInputValidators:function(){return[{name:"maxChars",validate:function(e){return e.length<=100},getErrorInfo:function(e){return F.branchTooLongTitle}}]},_getAuthoringMode:function(){if(this.filteredRoots.size>0)return UWA,Promise.resolve(!1);if(this.context&&"function"==typeof this.context.isIndexMode)return UWA,Promise.resolve(!this.context.isIndexMode());var e=this;return new UWA.Class.Promise((function(t,i){widget&&n.isInPSEditorWidget(widget)?e._getPADSession().then((function(e){var i=!0;e&&(i=e.determineAuthoredFlag()),t(i)})):t(!0)}))},_getPADSession:function(){return this.hasRequestedPADSession?UWA.Class.Promise.resolve(this.PADSession):this.getPADSessionPromise()},getPADSessionPromise:function(){var e=this;return new UWA.Class.Promise((function(t,i){require(["DS/PADUtils/PADSession"],(function(i){e.hasRequestedPADSession=!0,e.PADSession=i,t(e.PADSession)}),(function(i){e.hasRequestedPADSession=!0,e.PADSession=null,t(e.PADSession)}))}))},_adjustDialogSizeLarge:function(e){var t=this._loadSize("advBranchLarge"),i=this._getCurrentSize(e);this._storeSize("advBranchSmall",i),e.setNewSize(t?{width:t.width,height:t.height}:{width:2*i.width,height:480}),this.commandDialog&&this.commandDialog.isWidgetMaximized()&&this.commandDialog.maximize(!0)},_adjustDialogSizeSmall:function(e){var t=this._loadSize("advBranchSmall"),i=this._getCurrentSize(e);this._storeSize("advBranchLarge",i),e.setNewSize(i?{width:t.width,height:t.height}:{})},_getCurrentSize:function(e){var t=e.getModalBodySize();return t.height=e.getContainerHeight(),t},_loadSize:function(e){var t=widget.getValue(e);return t?JSON.parse(t):null},_storeSize:function(e,t){widget.getValue(e)||widget.addPreference({name:e,type:"hidden",defaultValue:"{}"}),widget.setValue(e,JSON.stringify(t))},_getSelectedSecurityContext:function(){if(this.credComboOrg)return this.credComboOrg.value?this.credComboOrg.value.ctx:"noCredentials";if(this._userCredentials&&this._userCredentials.isMultipleOrg){if(this.objectsList.length>=1&&this.objectsList[0].volatileAttributes&&this.objectsList[0].volatileAttributes.organization)return this.objectsList[0].volatileAttributes.organization}else if(this.objectsList.length>=1&&this.objectsList[0].volatileAttributes&&this.objectsList[0].volatileAttributes.collaborativeSpace)return this.objectsList[0].volatileAttributes.collaborativeSpace;return this.without_cred?this._securityContext:"noCredentials"},_getIsCSPrivateFromSecCtx:function(e){let t=this.allCredentials.filter((t=>t.secCtx==e)).map((e=>e.isPrivate));return 1==t.length&&t[0]},_onCredentialSelectionChangedMonoSel:function(e){console.log("Credential changed callback");var t=this;this._setWaitingResponse();var i=null;(i=e?this.objectsList[0].volatileAttributes.organization:this.objectsList[0].volatileAttributes.collaborativeSpace)!=F.noCredentials?(this.isTargetCSPrivate=this._getIsCSPrivateFromSecCtx(i),Promise.resolve().then((()=>this.initBL_already_called?this._WafDataPromise("/resources/lifecycle/duplicate/initialize_objects",{data:this.objectsList,operationDetail:"NewEvolution"},i):void 0)).then((e=>{t._setEndWaitingResponse();var i=new Map;if(e&&Array.isArray(e.results)&&e.results.forEach((e=>{e.objectId&&Array.isArray(e.attrs)&&e.attrs.length>0&&i.set(e.objectId,e.attrs)})),this.objectsList.forEach((e=>{var t=e.objectId||e.physicalid,n=i.get(t);Array.isArray(n)&&n.length>0&&(e.modifiedAttributes||(e.modifiedAttributes={}),n.forEach((t=>{t.name&&t.value&&(e.modifiedAttributes[t.name]=t.value)})))})),null!==t.objectProp){let e=this.displayIntentsList;var n=t.objectProp.getIntent();t.objectProp.setObject(t.objectsList[0],e?t.intentsList:null,n)}this.updateCSWarning(),console.log("Credential changed done")})).catch((e=>{t._setEndWaitingResponse(),console.log("Credential changed Failure..."+e),t.showErrorThenComplete(e)}))):t._setEndWaitingResponse()},_activateOkButton:function(){var e=this.dialog.elements.footer.querySelector(".btn-primary");if(e.disabled){e.disabled=!1;var t=this.dialog.elements.container.querySelector(".advbranch-expander");t&&(t.style.pointerEvents="")}this.hasCredentials=!0},_onItentSeletionChangedMonoSel:function(){console.log("Branch intent changed callback");var e=this;this._setWaitingResponse();var t=[];this.objectsList.forEach((function(e){var i=e.objectId||e.physicalid;t.push(i)}));var i="";null!==this.objectProp&&(i=this.objectProp.getIntent()),n.getVersionNumberProposalPromise(t,i,null,this.context).then((t=>{e._setEndWaitingResponse();var i=new Map;if(!t.addRequests||!Array.isArray(t.addRequests))throw R.objectNotFound;if(t.addRequests.forEach((e=>{i.set(e.copyId,e.code)})),e.objectsList.forEach((e=>{var t="";e.physicalid&&(t=e.physicalid),e.objectId&&(t=e.objectId);var n=i.get(t);n&&(e.proposedRevision=n,e.modifiedAttributes||(e.modifiedAttributes={}),e.modifiedAttributes.revision=n)})),null!==e.objectProp){let t=this.displayIntentsList;var n=e.objectProp.getIntent();e.objectProp.setObject(e.objectsList[0],t?e.intentsList:null,n)}console.log("Branch intent changed callback done"),e.dispatchEvent("onIntentChangedForODT")})).catch((t=>{e._setEndWaitingResponse(),console.log("Branch intent changed Failure..."+t),e.showErrorThenComplete(t)}))},_checkVersionCommentValue:function(e){if(e&&e.length>256){var t=require("i18n!DS/EditPropWidget/assets/nls/langEditProp"),i="checkVersionCommentValue error";return t&&(i=t.replace(t.get("MaxLengthAttribute"),{label:U.LifecycleObjectList_versionComment,value:256})),{code:"ERROR",eventID:"warning",message:i}}return null},_checkBeforeExecute:function(){var e=this,t=[];if(null!=this.objectProp&&(t=this.objectProp.getErrors()),this._displayAsMultiSelPanel()&&this.dupStringInput&&this.dupStringInput.value&&this.dupStringInput.value.length>0){var i=e._checkTitleValue();i&&t.push(i)}return this.objectsList.forEach((function(i){if(i.modifiedAttributes&&i.modifiedAttributes["PLMReference.V_versionComment"]){var n=e._checkVersionCommentValue(i.modifiedAttributes["PLMReference.V_versionComment"]);n&&t.push(n)}})),t},_computeRequest:function(){var e=this.useAdvancedBranch?this._computeAdvRequest():this._computeBasicRequest();return this.request_uuid&&(e.request_uuid=this.request_uuid),e},_computeBasicRequest:function(){var e={data:[]};if(this.objectsList.forEach((function(t){var i={physicalid:t.physicalid};t.modifiedAttributes&&Object.getOwnPropertyNames(t.modifiedAttributes).length&&(i.modifiedAttributes=t.modifiedAttributes),t.rootid&&(i.rootid=t.rootid),t.parentid&&(i.parentid=t.parentid),e.data.push(i)})),this.objectProp&&!this._displayAsMultiSelPanel()){let t=this.objectProp.getIntent();t&&(e.intent=t)}else this.intentsListSel&&(e.intent=this.intentsListSel.currentValue),this.dupStringInput&&(e.prefix=this.dupStringInput.value);return this.folderId&&(e.folderid=this.folderId),this.initBL_already_called&&(e.initBL_already_called=!0),e},_computeAdvRequest:function(){var e={},t=this._getOrCreateTreeLoader().nodeToRoot;0===this.filteredRoots.size&&(this.filteredRoots=this._getOrCreateTreeLoader().filteredRoots),e.data=this.advancedBranchTree.getTreeData(),e.usingAdvanced=!0,e.checkReusable=!1;var i=this.objectsList[0];for(var n of(null!==this.folderId&&(e.folderid=this.folderId),e.data))this.filteredRoots.has(n.physicalid)?n.branchInfo={filter:JSON.stringify(this.filteredRoots.get(n.physicalid))}:t.has(n.physicalid)&&(n.branchInfo={rootPid:t.get(n.physicalid)}),i.modifiedAttributes&&i.modifiedAttributes["PLMReference.V_versionComment"]&&"duplicate"!==n.operation&&(n.versionComment=i.modifiedAttributes["PLMReference.V_versionComment"]);return e},showNotificationInDialog:function(e){this.wintop?this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e.message},recordable:!0},"lf_web_in_win"):"ERROR"===e.code?null!=this.errorOverlay?this.errorOverlay.addError(e.message,e.customClass):this.showError(e.message):null!=this.errorOverlay?this.errorOverlay.addWarning(e.message,e.customClass):this.showNotification(e.message)},showNotification:function(e,t){if(t||(t={}),this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e},recordable:!0},"lf_web_in_win");else{var i={eventID:"primary",title:t.title||"",msg:e,sticky:t.sticky||!1,category:"NewBranch",hasHtml:t.hasHtml||!1};A.displayNotification(i),console.log(e)}},showSuccess:function(e){if(this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e},recordable:!0},"lf_web_in_win");else{var t={eventID:"success",msg:e,category:"NewBranch"};A.displayNotification(t),console.log(e)}},showError:function(e,t){if(t=t||{},this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"error",message:e},recordable:!0},"lf_web_in_win");else{var i={eventID:"error",msg:t.title||t.subtitle?t.submessage:e,title:t.title,subtitle:t.subtitle,category:"NewBranch",hasHtml:t.hasHtml||!1};A.displayNotification(i),console.log(e)}},showErrorThenComplete:function(e,t){e&&this.showError(e,t),this.wintop_odt_mode&&console.log("showErrorThenComplete called in ODT MODE"),setTimeout((()=>{this._onComplete()}),this.wintop_odt_mode?1e3:void 0)},_executeNewBranch:function(){var e=this;return new Promise(((t,i)=>{this.request_uuid=W._create_UUID();var s=e._computeRequest();let r="";if(r=e._displayAsMultiSelPanel()?"ListView":e.useAdvancedBranch?"Advanced":"ObjectView",e.trackerNumberObjects=s.data?s.data.length:0,!e.trackerEvent){let t={UXName:"NewBranch",numberObjects:e.trackerNumberObjects};e.trackerEvent=W.createInitActionEvent(t)}e._enrichPayloadForTrackerBackEnd(s);var o=6e5;s.notificationTimeout=600,console.log("before NEW BRANCH");var l,d,h=JSON.stringify(s),u=a.get3DSpaceWSUrl(e.tenant,"/resources/lifecycle/newbranch/execute_newbranch",null),p=function(){console.log("Timeout error"),e.request_uuid=void 0;let t=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,n={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"running_on_backend",actionTime:t};e.trackerEvent=W.createValidationEventFromEvent(n,e.trackerEvent),W.checkAndTrackPageEvent(e.trackerEvent),i({notifs:[{sticky:!0,hasHtml:!0,message:F.notificationTimeoutInfo}]})},g=e._getSelectedSecurityContext(),m=(new Date).getTime();c.authenticatedRequest(u,{method:"POST",headers:(l=g,d=a.getHeaders(l),e.wintop&&e.wintop_ChangeActionId&&(d["DS-Change-Authoring-Context"]="pid:"+e.wintop_ChangeActionId),d),timeout:o,onComplete:function(n){if(console.log("NEW BRANCH: COMPLETED"),e.request_uuid=void 0,n&&"failure"===n.status){var a=[];if(n.report&&n.report.length>0){var s=[];e.selectionList.forEach((function(e){s[e.physicalid]=e.displayName})),n.report.forEach((function(t){if(t.hasOwnProperty("physicalids")){for(var i="",n=0;n<t.physicalids.length;n++){var r=t.physicalids[n];s.hasOwnProperty(r)&&(i+=s[r],n===t.physicalids.length-1?i+=":\n":i+=",\n")}i+=t.error,a.push({hasHtml:!0,message:i})}else if("NonLinearVersioning.Error.MakeCloneAccess"===t.enoversioning_errornumber){var o=R.newBranchFailed;if(1==e.nbDisplayedObjects&&Array.isArray(e.selectionList)&&e.selectionList.length&&e.selectionList[0].name){let t=e.selectionList[0].revision?" "+e.selectionList[0].revision:"",i=e.selectionList[0].name+t;o=R.replace(R.newBranchFailedTitleSingleSel,{dispName:i})}var l={title:o,subtitle:R.verifyCredentials,submessage:R.lackingBranchingAccessRole};a.push({hasHtml:!0,message:t.error,opts:l})}else a.push({hasHtml:!0,message:t.error})}))}else a.push({hasHtml:!0,message:R.newBranchFailed});let t=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,o={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"failure",actionTime:t};return e.trackerEvent=W.createValidationEventFromEvent(o,e.trackerEvent),W.checkAndTrackPageEvent(e.trackerEvent),void i({errors:a})}console.log(R.newBranchSuccessful);var o=[];n.report&&n.report.length>0&&n.report.forEach((e=>{e.warning&&o.push({message:e.warning})}));var l={created:[],deleted:[],modified:[]};l.context=e.context,l.warnings=o;let c=!1;1==e.selectionList.length&&"xRevisionElement"==e.selectionList[0].policy&&(c=!0);let d=!1;1==e.selectionList.length&&"ConfiguredBaseline"==e.selectionList[0].policy&&(d=!0),(n.results||[]).forEach((function(t){var i=null;if(t.hasOwnProperty("derivedfromphysicalid")&&(i=t.derivedfromphysicalid),e.rootIds.includes(i))if(c||d){n={physicalid:i,operation:"Branch"},a=[e.folderId];n.folders=a,l.refreshFolder=!0,l.modified.push(n)}else{var n={physicalid:t.physicalid,sourceObjectId:i,operation:"Branch"},a=[e.folderId];n.folders=a,l.refreshFolder=!0,l.created.push(n)}}));let h=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,u={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"success",actionTime:h};Array.isArray(n.results)&&(u.pv16=n.results.length),e.trackerEvent=W.createValidationEventFromEvent(u,e.trackerEvent),W.checkAndTrackPageEvent(e.trackerEvent),t(l)},data:h,onTimeout:()=>{var e=(new Date).getTime();console.log("timeout case elapse time: "+(e-m)),p()},onFailure:(t,a)=>{var s=(new Date).getTime();console.log("error case elapse time: "+(s-m)),s-m>595e3?p():function(t,a){e.request_uuid=void 0,n.showWebServiceError(t,a,(function(n,a){if(a){console.log(F.notificationTimeoutInfo),console.log(t);let n=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,a={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"running_on_backend",actionTime:n};e.trackerEvent=W.createValidationEventFromEvent(a,e.trackerEvent),W.checkAndTrackPageEvent(e.trackerEvent),i({notifs:[{sticky:!0,hasHtml:!0,message:F.notificationTimeoutInfo}]})}else{console.log("Failed to retrieve data from the server"),console.log(t);let a=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,s={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"failure",actionTime:a};e.trackerEvent=W.createValidationEventFromEvent(s,e.trackerEvent),W.checkAndTrackPageEvent(e.trackerEvent),i({errors:[{hasHtml:!0,message:F.NewBranchFailed+"<br>"+n}]})}}),!0)}(t,a)},type:"json"})}))},_getProjects:async function(e){let t=await this._getSelectedSecurityContext(),i={data:e,attributes:["project"]},n=a.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/product/attributeList",null),s=await d.post(n,JSON.stringify(i),{securityContext:t}),r=s.results.filter((e=>!this.warningInfoData.allCS.includes(e.project))).map((e=>e.project));return console.log("Unknown projects: "+r),await this._updateCSLists(r),s},_updateCSLists:async function(e){if(0==e.length)return;let t=await this._getSelectedSecurityContext(),i={CollabSpaces:[...new Set(e)]},n=a.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/util/getCSState",null),s=(await d.post(n,JSON.stringify(i),{securityContext:t})).data.filter((e=>!e.IsError)),r=s.filter((e=>e.IsPrivate)).map((e=>e.CSRole));this.warningInfoData.allCS=this.warningInfoData.allCS.concat(s.map((e=>e.CSRole))),this.warningInfoData.privatCS=this.warningInfoData.privatCS.concat(r)},_getStructureObjectsInPrivateCS:async function(){let e=await this._getSelectedSecurityContext(),t=await this._getOrCreateTreeLoader().expand(e),i=[],n=[],a=[];if(t.assemblies.forEach((e=>{n=n.concat(e.nodes.filter((e=>null!=e.project&&!this.warningInfoData.allCS.includes(e.project))).map((e=>({project:e.project}))))})),console.log(n.length+" unknown collab spaces found"),await this._updateCSLists(n.map((e=>e.project))),t.assemblies.forEach((e=>{a=a.concat(e.nodes.filter((e=>this.warningInfoData.privatCS.includes(e.project))).map((e=>e.physicalid))),i=i.concat(e.nodes.filter((e=>null==e.project)).map((e=>({physicalid:e.physicalid}))))})),i.length>0){let e=(await this._getProjects(i)).results.filter((e=>this.warningInfoData.privatCS.includes(e.project))).map((e=>e.physicalid));a=a.concat(e)}return a},_getCSWarningsEnabled:async function(){let e=await this._getSelectedSecurityContext(),t=await d.get("/resources/lifecycle/util/getExpression",{tenant:this.tenant,securityContext:e,params:{expression:"LifecycleConfidentialityEnabled"}});return!!t.result&&"true"==t.result},_showCSWarning:function(e){e?this.rootGrid&&this.rootGrid.addClassName("lcm-branch-root-grid-warning-visible"):this.rootGrid&&this.rootGrid.removeClassName("lcm-branch-root-grid-warning-visible")},_updateCollabSpaceWarning:async function(){console.log("_updateCollabSpaceWarning");let e=this._getIsTargetCSPrivate(),t=this.useAdvancedBranch?"advanced":"basic";if(this.warningInfoData||(this.warningInfoData={isTargetCSPrivate:e,mode:"basic",warningVisible:!1,initialized:!1},this.warningInfoData.enabled=await this._getCSWarningsEnabled(),this.warningInfoData.enabled&&(this.warningInfoData.allCS=this.allCredentials.map((e=>e.cs)),this.warningInfoData.privatCS=this.allCredentials.filter((e=>e.isPrivate)).map((e=>e.cs)),console.log("Private CS list:"+this.warningInfoData.privatCS))),!this.warningInfoData.enabled)return void console.log("Disabled - exiting");if(this.warningInfoData.initialized&&this.warningInfoData.isTargetCSPrivate===e&&this.warningInfoData.mode===t)return void console.log("State unchanged - exiting");console.log("Target is private:"+e),console.log("UI mode:"+t);var i=this.dialog.elements.footer.querySelector("button.btn-primary");let n=!1;if("advanced"==t){if(!this.warningInfoData.objectsInPrivateCS)try{i.disabled=!0,this.warningInfoData.objectsInPrivateCS=await this._getStructureObjectsInPrivateCS(this.warningInfoData.privatCS),i.disabled=!1,console.log("Num objects in private CS: "+this.warningInfoData.objectsInPrivateCS.length)}catch(e){console.log("error loading tree:"+e)}n=this.warningInfoData.objectsInPrivateCS&&this.warningInfoData.objectsInPrivateCS.length>0&&!e}else{if(!this.warningInfoData.rootsInPrivateCS){var a=i.disabled;a||(i.disabled=!0);let e=new r(this.rootGrid,1e3,F.loadingText),t=await this._getProjects(this.objectsList.map((e=>({physicalid:e.physicalid}))));e.unmask(),console.log("projects:"+t),this.warningInfoData.rootsInPrivateCS=t.results.filter((e=>this.warningInfoData.privatCS.includes(e.project))),console.log("Num roots in private CS:"+this.warningInfoData.rootsInPrivateCS.length),a||(i.disabled=!1)}n=this.warningInfoData.rootsInPrivateCS.length>0&&!e}n!=this.warningInfoData.warningVisible&&(n?(console.log("Show CS warning"),this._showCSWarning(!0)):(console.log("Remove CS warning"),this._showCSWarning(!1))),n&&"advanced"==t&&!this.warningInfoData.setAdvObjs&&(this.advancedBranchTree.setObjsInPrivateCS(n?this.warningInfoData.objectsInPrivateCS:[]),this.warningInfoData.setAdvObjs=!0),this.warningInfoData.isTargetCSPrivate=e,this.warningInfoData.warningVisible=n,this.warningInfoData.mode=t,this.warningInfoData.initialized=!0}})}));