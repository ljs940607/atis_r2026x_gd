define("DS/VisualizationProfiler/VisuProfiler",["DS/CSICommandBinder/CSICommandBinder"],(function(t){"use strict";var e=null;const i=Object.freeze({READY:0,RUNNING:1,STOPPED:2}),r=Object.freeze({WEB:0,A2X:1}),a=Object.freeze({enable:0,disable:1,reset:2,postProcess:3,uploadedToServer:4}),s=Object.freeze({NATIF_PANEL:"natif_panel",WEB_PANEL:"web_panel",CLI_COMMAND:"cli_command"}),n=Object.freeze({DURATION:0,COMPLETE:1,INSTANT:2,COUNTER:3,ASYNC:4,FLOW:5,SAMPLE:6,OBJECT:7,METADATA:8,MEM_DUMP:9,MARK:10,CLOCK_SYNC:11,CONTEXT:12}),o=Object.freeze({DEFAULT:0,WEB_CUSTOM:20}),c=Object.freeze({NONE:0,ENABLE:1,DISABLE:2,DOWNLOAD:3,RESET:4}),l=Object.freeze({NOLOG:0,INFO:1,WARN:2,ERROR:3});class h{constructor(t,e,i){this._label=t,this._startTime=e,this._TS=i}get(){return{label:this._label,startTime:this._startTime,ts:this._TS}}}class _{constructor(t,e,i,r){this._label=t,this._startTime=e,this._duration=i,this._TS=r}get(){return{label:this._label,startTime:this._startTime,duration:this._duration,ts:this._TS}}}class f{constructor(t,e,i=null){this._topic=t,this._message=e,this._metadata=i}get(){return{topic:this._topic,message:this._message,metadata:this._metadata}}}const g={init:function(t){this._enabled=!1,this._state=i.READY,this._mode=r.WEB,this._lockLogs=!1,this._CSIClientNode=void 0,this._arrayOfMeasure=[],this._arrayOfMark=[],this._nativeStartTS=0,this._nativeEndTS=0,this._webStartTS=0,this._webEndTS=0,this._webTraces={traceEvents:[]},this._nativeTraces={traceEvents:[]},this._mergedTraces={traceEvents:[]},this._timeOffset=0,this._a2xSynchrOffSet=0,this._nativeTracesUploaded=!1,this._webTracesExtracted=!1,this._nativeTracesExtracted=!1,this._mergedTracesExtracted=!1,this._synchrOffsetExtracted=!1,this._customConfigExtracted=!1,this._tracingConfig=t?this._shallowCopy(t):void 0,this._defaultTracingConfig=Object.freeze({applyFilter:!1,reverseFilter:!1,filterList:[],splitThread:!1,gTraceEvtType:n.DURATION,interface:s.CLI_COMMAND,ODTMode:!1}),this._wPanelInterface=void 0,this._callbackManager={enable:[],disable:[],reset:[],postProcess:[],uploadedToServer:[]},this._callbackManager.call=function(t){switch(t){case a.enable:if(!this.enable.length)break;this.enable.forEach((t=>t())),this.enable=[];break;case a.disable:if(!this.disable.length)break;this.disable.forEach((t=>t())),this.disable=[];break;case a.reset:if(!this.reset.length)break;this.reset.forEach((t=>t())),this.reset=[];break;case a.postProcess:if(!this.postProcess.length)break;this.postProcess.forEach((t=>t())),this.postProcess=[];break;case a.uploadedToServer:if(!this.uploadedToServer.length)break;this.uploadedToServer.forEach((t=>t())),this.uploadedToServer=[]}},this._callbackManager.registerCB=function(t,e){switch(t){case a.enable:this.enable.push(e);break;case a.disable:this.disable.push(e);break;case a.reset:this.reset.push(e);break;case a.postProcess:this.postProcess.push(e);break;case a.uploadedToServer:this.uploadedToServer.push(e)}}},openVisuProfiler:function(){if(this._mode!==r.A2X)return;let t={VisuProfilerPanel:1};t.sceneID=window.debugNavSync.getViewersMap()?window.debugNavSync.getViewersMap().entries().next().value[0]:1,this._sendCSIEmit(this._buildCSIPacket(t)),this._forceSetInterface(s.NATIF_PANEL)},registerWPanel:function(t){t&&(this._wPanelInterface=t,this._forceSetInterface(s.WEB_PANEL))},enable:function(t){t&&this._callbackManager.registerCB(a.enable,t),this._changeState(c.ENABLE)},disable:function(t){t&&this._callbackManager.registerCB(a.disable,t),this._changeState(c.DISABLE)},reset:function(t){t&&this._callbackManager.registerCB(a.reset,t),this._changeState(c.RESET)},subscribeToPostProcessing:function(t){t&&this._callbackManager.registerCB(a.postProcess,t)},downloadWebTraces:function(){this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadBeginCB();let t=this._getWebTraces();t?this._downloadFile(t,"dWebTraces.js"):this._logger(l.ERROR,"Failed to download web traces : no traces content found !")},downloadNativeTraces:function(){this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadBeginCB();let t=this._getNativeTraces();t?this._downloadFile(t,"dNativeTraces.js"):this._logger(l.ERROR,"Failed to download native traces : no traces content found !")},downloadA2XTraces:function(){this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadBeginCB();let t=this._getMergedTraces();t?this._downloadFile(t,"dA2XTraces.js"):this._logger(l.ERROR,"Failed to download a2x traces : no traces content found !")},uploadToServer:function(t,e="dA2XTraces.js",i=void 0){if(!this.isODTMode()||this.getMode()!==r.A2X)return;i&&this._callbackManager.registerCB(a.uploadedToServer,i);let s=new f("upload",JSON.stringify(t),e);this._sendCSIEmit(this._buildCSIPacket(s))},get:function(){return e},getWebTraces:function(t){if(!this._enabled)return t&&!0===t?this._shallowCopy(this._getWebTraces()):this._getWebTraces()},getNativeTraces:function(t){if(!this._enabled)return t&&!0===t?this._shallowCopy(this._getNativeTraces()):this._getNativeTraces()},getA2XTraces:function(t){if(!this._enabled)return t&&!0===t?this._shallowCopy(this._getMergedTraces()):this._getMergedTraces()},getTimeLapses:function(){if(this._enabled)return-1;return{a2x:this._nativeEndTS-this._nativeStartTS,web:this._webEndTS-this._webStartTS,native:this._nativeEndTS-this._nativeStartTS}},getWebTracesPCS:function(t){let e=this.getWebTraces();if(0!==e.traceEvents.length)return this._getPCS(e,t,this._getCustomConfig().gTraceEvtType)},getNativeTracesPCS:function(t){let e=this.getNativeTraces();if(0!==e.traceEvents.length)return this._getPCS(e,t,this._getCustomConfig().gTraceEvtType)},getA2XTracesPCS:function(t){let e=this.getA2XTraces();if(0!==e.traceEvents.length)return this._getPCS(e,t,this._getCustomConfig().gTraceEvtType)},setConfig:function(t){t&&(this._tracingConfig=this._shallowCopy(t),this._customConfigExtracted=!1)},getConfig:function(){return this._shallowCopy(this._getCustomConfig())},isEnabled:function(){return this._enabled&&this._state===i.RUNNING},isODTMode:function(){return this._getCustomConfig().ODTMode},getInterface:function(){return this._getCustomConfig().interface},setLogging:function(t){this._lockLogs=!t},setMode:function(t){t===r.A2X||t===r.WEB?t!==this.getMode()&&(t!==r.A2X||this._CSIClientNode?(this._mode=t,this._logger(l.INFO,(this._mode===r.A2X?"A2X":"Web")+" mode is set."),this._wPanelInterface&&this._wPanelInterface.onModeChangeCB(this.getMode())):this._logger(l.ERROR,"Failed to set A2X mode, a valid CSIContext is required !")):this._logger(l.ERROR,"Invalid argument for mode (should : Web=0 or A2X=1) ")},getMode:function(){return this._mode},getState:function(){return this._state},setCSIContext:function(t){t&&(this._state!==i.RUNNING?(this._CSIClientNode=t,this._mode=r.A2X):this._logger(l.ERROR,"Failed to setCSIContext while profilling !"))},_onCSIAnswer:function(t){let n=t.readString("aTopic");if(n)switch(n){case"command":switch(t.readString("aMsg")){case"start":{let i=t.readString("aContent");i&&(e._startTracing(),e._injectNativeStartTS(i));break}case"stop":{let a=t.readString("aContent");a&&(e._stopTracing(),e._injectNativeStopTS(a),e._mode===r.A2X&&e._state===i.STOPPED&&e._cli_uploadNativeTraces());break}case"upload":{let a=t.readString("aContent");a&&(e._injectNativeTraces(JSON.parse(a)),e._mode===r.A2X&&e._state===i.STOPPED&&e._getCustomConfig().interface===s.NATIF_PANEL&&e.downloadA2XTraces());break}}break;case"upload":{let i=t.readString("aMsg");this._callbackManager.call(a.uploadedToServer),i&&"failed"!==i?e._logger(l.INFO,`Traces uploaded successfully to server with the following path : ${i}`):e._logger(l.ERROR,"Failed to upload traces to server. Check if ODT_LOG_NAME");break}}},_sendCSIEmit:function(t){this._CSIClientNode.call({destinationNodeId:this._CSITargetPoolId,name:"invokeProfilerCommand",version:1,parameters:t,onSuccess:function(t){e._onCSIAnswer(t)},onError:function(t){let i=t.readString("error");i&&e._logger(l.ERROR,i)},onProgress:function(t){}})},_buildCSIPacket:function(e,i=0){var r=new t.Parameters;return r.writeInt32("version",i),r.writeString("xTopic",e.get().topic),r.writeString("xMsg",e.get().message),e.get().metadata&&r.writeString("xMetadata",e.get().metadata),r},_cli_interact:function(t){this._mode===r.A2X&&t&&this._sendCSIEmit(this._buildCSIPacket(t))},_cli_startTracing:function(){this._cli_interact(new f("command","start"))},_cli_stopTracing:function(){this._cli_interact(new f("command","stop"))},_cli_uploadNativeTraces:function(){this._cli_interact(new f("command","download")),this._wPanelInterface&&this._wPanelInterface.onProfilerUploadBeginCB()},_changeState:function(t){switch(this._mode){case r.WEB:switch(t){case c.ENABLE:this._state!==i.RUNNING&&this._startTracing();break;case c.DISABLE:this._state===i.RUNNING&&this._stopTracing();break;case c.RESET:this._state===i.RUNNING&&this._changeState(c.DISABLE),this._factoryReset()}break;case r.A2X:switch(t){case c.ENABLE:this._state!==i.RUNNING&&this._cli_startTracing();break;case c.DISABLE:this._state===i.RUNNING&&this._cli_stopTracing();break;case c.RESET:this._state===i.RUNNING&&this._changeState(c.DISABLE),this._factoryReset()}}},_startTracing:function(){this._factoryReset(),this._enabled=!0,this._state=i.RUNNING,this._webStartTS=this._flagTracing(),this._callbackManager.call(a.enable),this._wPanelInterface&&this._wPanelInterface.onProfilerStartCB(),this._logger(l.INFO,this._getCustomConfig()),this._logger(l.INFO,"Profilling has started !")},_stopTracing:function(){this._enabled=!1,this._state=i.STOPPED,this._webEndTS=this._sampleTS(),this._callbackManager.call(a.disable),this._wPanelInterface&&this._wPanelInterface.onProfilerStopCB(),this._mode===r.WEB&&this._postProcess(),this._logger(l.INFO,"Profilling is stopped !")},_factoryReset:function(){this._arrayOfMeasure=[],this._arrayOfMark=[],this._enabled=!1,this._state=i.READY,this._nativeStartTS=0,this._nativeEndTS=0,this._webStartTS=0,this._webEndTS=0,this._webTraces={traceEvents:[]},this._nativeTraces={traceEvents:[]},this._mergedTraces={traceEvents:[]},this._timeOffset=0,this._a2xSynchrOffSet=0,this._nativeTracesUploaded=!1,this._webTracesExtracted=!1,this._nativeTracesExtracted=!1,this._mergedTracesExtracted=!1,this._synchrOffsetExtracted=!1,this._customConfigExtracted=!1,this._callbackManager.call(a.reset)},_injectNativeTraces:function(t){t&&(this._setNativeTracing(t),this._nativeTracesUploaded=!0,this._wPanelInterface&&this._wPanelInterface.onProfilerUploadEndCB(),this._postProcess())},_injectNativeStartTS:function(t){t&&(this._nativeStartTS=t)},_injectNativeStopTS:function(t){t&&(this._nativeEndTS=t)},_flagTracing:function(){this.probe("VisualizationProfiler::FlagTracing"),this._timeOffset=window.performance.now();let t=this._sampleTS();return this.probe("VisualizationProfiler::FlagTracing"),t},_sampleTS:function(){return Date.now()},_setCustomConfig:function(t){this._tracingConfig=t},_getCustomConfig:function(){return!1===this._customConfigExtracted&&(this._setTracingConfig(this._extractCustomConfig()),this._customConfigExtracted=!0),this._tracingConfig},_forceSetInterface:function(t){t&&this._getCustomConfig().interface!==t&&(this._tracingConfig.interface=t,this._customConfigExtracted=!1)},_setTracingConfig:function(t){t&&(this._tracingConfig=t)},_getTracingConfig:function(){return this._tracingConfig},_setWebTracing:function(t){this._webTraces=t},_getWebTraces:function(){return!1===this._webTracesExtracted&&(this._setWebTracing(this._extractWebTraces()),this._webTracesExtracted=!0),this._webTraces},_setNativeTracing:function(t){this._nativeTraces=t},_getNativeTraces:function(){return!1===this._nativeTracesExtracted&&(this._setNativeTracing(this._extractNativeTraces()),this._nativeTracesExtracted=!0),this._nativeTraces},_setMergedTraces:function(t){this._mergedTraces=t},_getMergedTraces:function(){return!1===this._mergedTracesExtracted&&(this._setMergedTraces(this._extractMergedTraces()),this._mergedTracesExtracted=!0),this._mergedTraces},_setSynchrOffset:function(t){this._a2xSynchrOffSet=t},_getSynchrOffset:function(){return!1===this._synchrOffsetExtracted&&(this._setSynchrOffset(this._extractSynchrOffset()),this._synchrOffsetExtracted=!0),this._a2xSynchrOffSet},_postProcess:function(){this.getWebTraces(),this._mode===r.A2X&&this.getA2XTraces(),this._callbackManager.call(a.postProcess),this._logger(l.INFO,"Profilling postProcess is done !")},_logger:function(t,e){this._lockLogs||t===l.NOLOG||(t===l.INFO&&console.info(`[VisuProfiler] ${e}`),t===l.WARN&&console.warn(`[VisuProfiler] ${e}`),t===l.ERROR&&console.error(`[VisuProfiler] ${e}`))},_shallowCopy:function(t){return Object.assign({},t)},isArrIndex:function(t,e,i){return void 0!==i?t.findIndex((t=>t===e)):-1!==t.findIndex((t=>t===e))},_isElemExist:function(t,e,i){return void 0!==i?t.findIndex((t=>t===e)):-1!==t.findIndex((t=>t===e))},_buildUID:function(){return(Math.random()+1).toString(36).substring(7)},_getPCS:function(t,e,i){return"string"==typeof e?this._extractPCS(t,e,i):Array.isArray(e)?this._extractListOfPCS(t,e,i):void 0},_extractPCS:function(t,e,i){if(!t.traceEvents||0===t.traceEvents.length||!e)return;let r={wallDuration:0,avgWallDuration:0,occurrences:0};switch(i){case n.DURATION:{let i,a;for(let s=0;s<t.traceEvents.length;s++)t.traceEvents[s].name===e&&"B"===t.traceEvents[s].ph&&(i=t.traceEvents[s].ts),i&&t.traceEvents[s].name===e&&"E"===t.traceEvents[s].ph&&(a=t.traceEvents[s].ts,r.wallDuration+=a-i,r.occurrences++,i=void 0,a=void 0);break}case n.COMPLETE:for(let i=0;i<t.traceEvents.length;i++)t.traceEvents[i].name===e&&"X"===t.traceEvents[i].ph&&(r.wallDuration+=t.traceEvents[i].ts,r.occurrences++)}return r.occurrences>0&&(r.wallDuration/=1e3,r.wallDuration=Number.parseFloat(r.wallDuration.toFixed(3)),r.avgWallDuration=r.wallDuration/r.occurrences,r.avgWallDuration=Number.parseFloat(r.avgWallDuration.toFixed(3))),r},_extractListOfPCS:function(t,e,i){if(!t.traceEvents||0===t.traceEvents.length||0===e.length)return;if(1===e.length)return this._extractPCS(t,e[0],i);let r=[];for(let t=0;t<e.length;t++){let i={probe:e[t],wallDuration:0,avgWallDuration:0,occurrences:0,b:0,e:0};r.push(i)}switch(i){case n.DURATION:for(let i=0;i<t.traceEvents.length;i++)if(-1!==e.indexOf(t.traceEvents[i].name)){let a=e.indexOf(t.traceEvents[i].name),s=t.traceEvents[i];"B"===s.ph&&(r[a].b=s.ts),r[a].b&&"E"===s.ph&&(r[a].e=s.ts,r[a].wallDuration+=r[a].e-r[a].b,r[a].occurrences++,r[a].b=void 0,r[a].e=void 0)}break;case n.COMPLETE:for(let i=0;i<t.traceEvents.length;i++)if(-1!==e.indexOf(t.traceEvents[i].name)){let a=e.indexOf(t.traceEvents[i].name),s=t.traceEvents[i];"X"===s.ph&&(r[a].wallDuration+=s.ts,r[a].occurrences++)}}for(let t=0;t<r.length;t++)r[t].occurrences>0&&(r[t].wallDuration/=1e3,r[t].wallDuration=Number.parseFloat(r[t].wallDuration.toFixed(3)),r[t].avgWallDuration=r[t].wallDuration/r[t].occurrences,r[t].avgWallDuration=Number.parseFloat(r[t].avgWallDuration.toFixed(3))),delete r[t].b,delete r[t].e;return r},_downloadFile:function(t,e){const i=new Blob([JSON.stringify(t)],{type:"application/json"}),r=URL.createObjectURL(i);let a=document.createElement("a");a.setAttribute("href",r),a.setAttribute("download",e),document.body.appendChild(a),a.click(),a.remove(),this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadEndCB(),this._logger(l.INFO,"File "+e+" download is done ! ")},_applyFilter:function(t){let e=this._getCustomConfig();const i=(t,e)=>-1!==t.indexOf("*")?-1!==e.indexOf(t.split("*")[0]):t===e;t.traceEvents.length>0&&!0===e.applyFilter&&(!1===e.reverseFilter?t.traceEvents=t.traceEvents.filter((t=>-1!==e.filterList.findIndex((e=>i(e,t.name))))):t.traceEvents=t.traceEvents.filter((t=>!(-1!==e.filterList.findIndex((e=>i(e,t.name)))))))},_extractCustomConfig:function(){let t=this._shallowCopy(this._defaultTracingConfig);return void 0!==this._tracingConfig&&null!==this._tracingConfig&&"object"==typeof this._tracingConfig?(void 0!==this._tracingConfig.applyFilter&&null!==this._tracingConfig.applyFilter&&"boolean"==typeof this._tracingConfig.applyFilter&&(t.applyFilter=this._tracingConfig.applyFilter),void 0!==this._tracingConfig.reverseFilter&&null!==this._tracingConfig.reverseFilter&&"boolean"==typeof this._tracingConfig.reverseFilter&&(t.reverseFilter=this._tracingConfig.reverseFilter),void 0!==this._tracingConfig.filterList&&null!==this._tracingConfig.filterList&&"object"==typeof this._tracingConfig.filterList&&(t.filterList=this._tracingConfig.filterList),void 0!==this._tracingConfig.splitThread&&null!==this._tracingConfig.splitThread&&"boolean"==typeof this._tracingConfig.splitThread&&(t.splitThread=this._tracingConfig.splitThread),void 0!==this._tracingConfig.gTraceEvtType&&null!==this._tracingConfig.gTraceEvtType&&"number"==typeof this._tracingConfig.gTraceEvtType&&(t.gTraceEvtType=this._tracingConfig.gTraceEvtType),void 0!==this._tracingConfig.interface&&null!==this._tracingConfig.interface&&"string"==typeof this._tracingConfig.interface&&(t.interface=this._tracingConfig.interface),void 0!==this._tracingConfig.ODTMode&&null!==this._tracingConfig.ODTMode&&"boolean"==typeof this._tracingConfig.ODTMode&&(t.ODTMode=this._tracingConfig.ODTMode)):this._tracingConfig=t,t},_extractWebTraces:function(){let t=this._getCustomConfig(),e=this._extractSynchrOffset(),i={traceEvents:[]};switch(t.gTraceEvtType){case n.DURATION:this._arrayOfMark.length&&this._arrayOfMark.forEach((r=>{let a={ph:"",name:"",cat:"WebApplication",pid:0,tid:!0===t.splitThread?o.WEB_CUSTOM:o.DEFAULT,ts:0,args:{}};a.ph="0"===r._label.split("#")[1]?"B":"E",a.name=r._label.split("#")[0],a.ts=1===this._mode?1e3*(r._startTime-this._timeOffset)-e:1e3*(r._startTime-this._timeOffset),i.traceEvents.push(a)}));break;case n.COMPLETE:this._arrayOfMeasure.length&&this._arrayOfMeasure.forEach((e=>{let r={ph:"",name:"",cat:"WebApplication",pid:0,tid:!0===t.splitThread?o.WEB_CUSTOM:o.DEFAULT,ts:0,dur:0,args:{}};r.ph="X",r.name=e._label.split("#")[0],r.dur=e._duration,r.ts=e._TS,i.traceEvents.push(r)}))}return this._applyFilter(i),i},_extractNativeTraces:function(){return this._applyFilter(this._nativeTraces),this._nativeTraces},_extractMergedTraces:function(){let t=this._getWebTraces(),e=this._getNativeTraces();return this._mergedTraces.traceEvents=e.traceEvents.concat(t.traceEvents),this._mergedTraces.traceEvents.sort(((t,e)=>t.ts<=e.ts?-1:1)),this._mergedTraces},_extractSynchrOffset:function(){if(!(this._arrayOfMark.length>0&&this._nativeTraces.traceEvents.length>0))return 0;let t=this._nativeStartTS-this._webStartTS,e=(this._arrayOfMark.shift(),this._arrayOfMark.shift()),i=(this._nativeTraces.traceEvents.shift(),this._nativeTraces.traceEvents.shift()),r=1e3*(e._startTime-this._timeOffset),a=0;return a+=t,a+=i.ts-r,a},_wIsCompatible:function(){return!(!window.performance.mark||!window.performance.measure)},_checkGoCondition:function(){return!0===this._enabled},_recordVisPerfoMark:function(t,e,i){let r=new h(t,e,i);this._pushVisPerfoMark(r)},_pushVisPerfoMark:function(t){this._arrayOfMark.push(t)},_wClearPerfoMark:function(t){window.performance.clearMarks(t+"#0"),window.performance.clearMarks(t+"#1")},_recordVisPerfoMeasure:function(t,e,i,r){let a=new _(t,e,i,r);this._pushVisPerfoMeasure(a)},_pushVisPerfoMeasure:function(t){this._arrayOfMeasure.push(t)},_wClearPerfoMeasure:function(t){window.performance.clearMeasures(t)},_wIsEntryExist:function(t){return 1===window.performance.getEntriesByName(t).length},_isLabelCompliant:function(t){if(t.indexOf("::")>=1){let e=t.indexOf("::");if(t.length>e+2){let i=t.lastIndexOf("::");return i>-1&&i==e}}return!1},begin:function(t){if(!this._checkGoCondition())return;if(!this._isLabelCompliant(t))return;let e=window.performance.mark(t+"#0");this._recordVisPerfoMark(e.name,e.startTime,Date.now())},end:function(t){if(!this._checkGoCondition())return;if(!this._wIsEntryExist(t+"#0"))return;let e=window.performance.mark(t+"#1");this._recordVisPerfoMark(e.name,e.startTime,Date.now());let i=window.performance.measure(t,t+"#0",t+"#1");this._recordVisPerfoMeasure(i.name,i.startTime,i.duration,Date.now()),this._wClearPerfoMark(t),this._wClearPerfoMeasure(t)},probe:function(t){this._checkGoCondition()&&(this._wIsEntryExist(t+"#0")?this.end(t):this.begin(t))}};return g.init(),e=g,g}));