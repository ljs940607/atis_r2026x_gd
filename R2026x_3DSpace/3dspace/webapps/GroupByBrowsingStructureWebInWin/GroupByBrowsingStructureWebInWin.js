define("DS/GroupByBrowsingStructureWebInWin/utils/GroupByBrowsingStructureUtils",["UWA/Core","DS/WidgetServices/WidgetServices","DS/BrowsingStructureAPI/utils/BrowsingStructureWebServicesUtil","i18n!DS/GroupByBrowsingStructureWebInWin/assets/nls/GroupByBrowsingStructureWebInWin"],(function(e,t,i,n){"use strict";return{getSelectedNodesFromContext:function(){var e=["DS/IPClassifyUtil/IPContext","DS/PADUtils/PADContext"];return new Promise(((t,i)=>{require(e,(function(e,i){t((e.get()||i.get()).getSelectedNodes())}))}))},getXSOFromContext:function(){var e=["DS/IPClassifyUtil/IPContext","DS/PADUtils/PADContext"];return new Promise(((t,i)=>{require(e,(function(e,i){let n=e.get()||i.get();n&&n.options.model&&t(n.options.model.getXSO())}))}))},_parseSearchResult:function(e){var t=[];let i=e.results;if(i)for(var n=0;n<i.length;n++){for(var o=i[n].attributes,s="",r="",l="",a=0;a<o.length;a++)"ds6w:label"===o[a].name&&(s=o[a].value),"physicalid"===o[a].name?l=o[a].value:"predicatename"===o[a].name&&(r=this._getsixwfromPredicateName(o[a].value));t.push({label:s,value:{predicate:""!==r?r:s,physicalid:l}})}return t},_getsixwfromPredicateName:function(e){if(e)return"ds6w:"+e.charAt(0).toLowerCase()+e.slice(1)},_retrieveBS:function(n){var o=Math.round(1e3*Math.random()).toString(),s={};if(e.extend(s,n),!e.is(s,"object"))throw new Error("Invalid inputs for TerminologyWebService.searchTerminologies");i.get3DSearchUrl().then((function(r){var l=r+"/search",a=widget.lang?widget.lang:widget.getValue("lang");s.payload={with_nls:!1,with_indexing_date:!0,select_predicate:["ds6w:label","ds6w:identifier","ds6w:status","taxonomies","predicatename","physicalid"],order_field:"ds6w:label",order_by:"asc",nresults:100},s.payload.locale=a,s.payload.query='type: "Terminology" AND [ds6w:status]: "Terminology.Released"',s.payload.next_start=void 0,s.payload.start=void 0,s.payload.source=["3dspace"],s.payload.login={"3dspace":{SecurityContext:i.getSecurityContext()}},s.payload.tenant=t.getTenantID(),s.payload.label="GroupByBS_ListBS_"+o,null!=n.next_start?s.payload.next_start=n.next_start:s.payload.start=0,s.method="POST",s.headers={Accept:"application/json","content-type":"application/json","Accept-Language":a,SecurityContext:"ctx::"+widget.getValue("xPref_CREDENTIAL")},s.type="json",s.data=e.Json.encode(s.payload),s.withoutSC=!0,s.timeout=12e4,i._executeRequest(l,s,"searchTerminologies")})).catch(n.onFailure)}}})),window.dsDashboardWindow=window.dsDashboardWindow?window.dsDashboardWindow:{top:window};let prereqCEF="DS/WebInWinUtils/dscef",prereqList=["DS/i3DXCompass/Data","DS/IPClassifyUtil/IPClassifyUtility","DS/GroupByBrowsingStructureWebInWin/views/GroupByBrowsingStructureDialog","DS/GroupByBrowsingStructureWebInWin/commands/UngroupBrowsingStructureCommand"];window.dscef||prereqList.push(prereqCEF),define("DS/GroupByBrowsingStructureWebInWin/GroupByBSWebInWin",prereqList,(function(e,t,i,n){"use strict";console.log("----- GroupByBSWebInWin ------");require(["DS/UWPClientCode/PublicAPI"]);var o=function(){"undefined"!=typeof dscef&&dscef.sendString("readyForInit")},s=!1;window.launchGroupByBSCommand=function(n){console.log("--\x3e Entering launchGroupByBSCommand with parameters : "),console.log(n);var o=("string"==typeof n?JSON.parse(n):n).params;console.log("-> launchGroupByBSCommand");require(["DS/IPClassifyUtil/IPSettingsMgr","DS/IPClassifyUtil/IPServicesMgr"],(function(n,r){widget.setValue("noCompass",!0),o.userId&&(window.dsUserLogin=o.userId),widget.addPreference("pad_security_ctx",o.securityContext);var l=o.securityContext.startsWith("ctx::")?o.securityContext.substring(5):o.securityContext;widget.setValue("xPref_CREDENTIAL",l),o.tenantId&&(n.setSetting("x3dPlatformId",o.tenantId),widget.setValue("x3dPlatformId",o.tenantId));let a=!widget.body;widget.body=a?UWA.createElement("div"):widget.body,widget.body.addClassName("GroupByBSDiv"),widget.body.setStyles({height:"100%",width:"100%","text-align":"initial",position:"relative"}),e.initialize({myAppsBaseUrl:o.myAppsUrl,userId:o.userId,passportUrl:"",proxyTicketUrl:""});var c=document.body.getElement("#tempDiv");c&&c.remove(),window.performance.mark("createWidget_begin"),t.sendTrackerPageEvt("usage","groupByBS",{label:"Launch Group By Command"}),r.app_initialization((function(){console.log("-> app_initialization");var e=o.nodes,t=null;if(e&&e.length>0){if(e[0].hasOwnProperty("bsApplied"))t=e[0].bsApplied,e[0].getReferenceValue=t=>e[0][t];else try{t=e[0].getReferenceValue("bsApplied")}catch(e){console.log(e)}void 0===e[0].getLabel&&(e[0].getLabel=()=>e[0].hasOwnProperty("label")?e[0].label:"")}else console.log("--- invalid command entry, the command should be called on a selection");var n=new i;if(s&&(o.launchDialog||o.ungroup)){var r={getXSOFromContext:()=>new Promise(((t,i)=>{t({onChange:()=>!0,get:()=>e})})),getSelectedNodesFromContext:()=>new Promise(((t,i)=>{t(e)}))};if(o.ungroup){var l={id:"UngroupBSHdr",context:r};widget.elements.wrapper=document.body,require(["DS/GroupByBrowsingStructureWebInWin/commands/UngroupBrowsingStructureCommand"],(e=>{new e(l).begin()}))}else{l={id:"GroupByBSHdr",context:r};widget.elements.wrapper=document.body,require(["DS/GroupByBrowsingStructureWebInWin/commands/GroupByBrowsingStructureCommand"],(e=>{new e(l).begin()}))}}else n.display({isWebInWin:!0,container:widget.body,currentSelection:t}).then((e=>{window.GroupByBSDiv=e,a&&widget.body.inject(document.body,"top")}))})),widget.dispatchEvent("onRefresh"),widget.dispatchEvent("onDestroy"),widget.dispatchEvent("onResize")}))},window.launchUngroupCommand=function(e){};var r={init:()=>{require(["UWA/Widget"],(function(e){var t=window.widget=new e;t.addEvent("onLoad",r.onLoad.bind(this)),t.dispatchEvent("onLoad")}))},onLoad:function(){if(location.search.contains("test=true")||!0===window.odt){s=!0;require(["DS/BksStandalone/Standalone"],(e=>{e({nodes:'[{"bsApplied":"BS1"}]',launchDialog:!1,ungroup:!1}).then((e=>{o(),e.nodes=e.nodes?JSON.parse(e.nodes):void 0,e.launchDialog=!!e.launchDialog&&JSON.parse(e.launchDialog),launchGroupByBSCommand({params:e})}))}))}o()}};r.init()})),define("DS/GroupByBrowsingStructureWebInWin/commands/UngroupBrowsingStructureCommand",["UWA/Core","DS/ApplicationFrame/Command","DS/IPClassifyUtil/PlatformAPIWrapper","DS/IPClassifyUtil/IPClassifyUtility","DS/WidgetServices/WidgetServices","DS/GroupByBrowsingStructureWebInWin/utils/GroupByBrowsingStructureUtils","i18n!DS/GroupByBrowsingStructureWebInWin/assets/nls/GroupByBrowsingStructureWebInWin"],(function(e,t,i,n,o,s,r){"use strict";return t.extend({physicalids:[],options:null,context:null,init:function(e){this.options=e,this._parent(e,{mode:"exclusive",isAsynchronous:!1}),e.hasOwnProperty("context")&&e.context&&(this.context=e.context),(null!==this.context?this.context.getXSOFromContext():s.getXSOFromContext()).then((e=>{e&&(this._check_selection(),e.onChange((()=>{this._check_selection()})),i.subscribe("groupByBSSelection.Select",(e=>{let t=o.getWidgetId();e&&""!==e.label&&""!==e.physicalid&&t===e.widgetID?this._check_selection(!0):this.disable()})),i.subscribe("UngroupBSSelection.Deactivate",(e=>{let t=o.getWidgetId();e&&e.widgetID===t&&this.disable()})))}))},_check_selection:function(e){this.disable(),(null!==this.context?this.context.getXSOFromContext():s.getXSOFromContext()).then((t=>{var i=t.get();i.length<=1&&(i=i.filter((function(t){return e||void 0!==t.getReferenceValue("bsApplied")&&t.getReferenceValue("bsApplied").length>0})))&&i.length>0&&this.enable()}))},beginExecute:function(){},execute:function(){n.sendTrackerPageEvt("usage","ungroupByBS",{label:"Launch UnGroup By Command"}),(null!==this.context?this.context.getSelectedNodesFromContext():s.getSelectedNodesFromContext()).then((e=>{if(e&&e.length>0&&e.length<=1){this.physicalids=[e[0].id];let t=e[0].getReferenceValue("bsApplied"),n=!!this.options.hasOwnProperty("isWebInWin")&&options.isWebInWin,s={label:"",predicate:"",physicalid:""};s&&!s.widgetID&&(s.widgetID=o.getWidgetId()),t&&(n?window.dscef&&window.dscef.sendString("groupByBSSelection.Select",JSON.stringify(s)):i.publish("groupByBSSelection.Select",s))}}))},endExecute:function(){}})})),define("DS/GroupByBrowsingStructureWebInWin/views/GroupByBrowsingStructureDialog",["UWA/Controls/Abstract","UWA/Core","DS/IPClassifyUtil/PlatformAPIWrapper","DS/IPClassifyUtil/IPClassifyUtility","DS/WidgetServices/WidgetServices","DS/Windows/ImmersiveFrame","DS/Windows/Dialog","DS/Controls/Button","DS/WUXAutoComplete/AutoComplete","DS/IPClassifyUtil/IPClassifyAlert","DS/GroupByBrowsingStructureWebInWin/utils/GroupByBrowsingStructureUtils","i18n!DS/GroupByBrowsingStructureWebInWin/assets/nls/GroupByBrowsingStructureWebInWin","css!DS/GroupByBrowsingStructureWebInWin/GroupByBrowsingStructureWebInWin.css"],(function(e,t,i,n,o,s,r,l,a,c,u,d,g){"use strict";return e.extend({content:null,previousSelection:null,isWebInWin:!1,display:function(e){return new Promise(((a,g)=>{let p={onComplete:c=>{if(this.predicates=u._parseSearchResult(c),this.previousSelection=e.currentSelection?e.currentSelection:null,this.isWebInWin=!!e.hasOwnProperty("isWebInWin")&&e.isWebInWin,this.objTitle=e.hasOwnProperty("title")?e.title:"",n.sendTrackerPageEvt("metrics","groupByBS",{label:"Number of browsing structure proposed",value:this.predicates.length}),this.predicates&&this.predicates.length>0?this.content=this._createAutoCompleteDialog(this.predicates):this.content=this._displayNoBSMessage(),this.yesButton=new l({disabled:!0,domId:"group-by-validation-button",emphasize:"primary",label:d.bsChooserDialog.organizeButton,onClick:e=>{let t=this.content.getChipInfo();t&&!t.widgetID&&(t.widgetID=o.getWidgetId()),n.sendTrackerPageEvt("usage","groupByBS",{label:t?this.previousSelection?"Switch of group":"Apply a group":"Remove a group"}),this.isWebInWin?this._sendWebInWinNotification("groupByBSSelection.Select",t):(i.publish("groupByBSSelection.Select",t),this.dialog.close())}}),this.cancelButton=new l({label:d.bsChooserDialog.cancelButton,domId:"group-by-cancel-button",emphasize:"secondary",role:WUXCustomButtonRoleEnum.Escape,onClick:()=>{n.sendTrackerPageEvt("usage","groupByBS",{label:"Click on cancel"}),this._closePanel()}}),this.isWebInWin){let i=t.createElement("div",{class:"groupbydialog_wiw_content"});i.inject(e.container);let n=t.createElement("div",{class:"groupbydialog_wiw_options"});this.content.inject(n),n.inject(i);let o=t.createElement("div",{class:"buttonBar"}).inject(i);this.predicates&&this.predicates.length>0&&this.yesButton.inject(o),this.cancelButton.inject(o),a(i)}else{if(void 0===e.container)throw new Error("Dialog cannot be displayed without a valid container");this.immersiveFrame=new s({}),this.immersiveFrame.inject(e.container);let t=d.bsChooserDialog.title+(this.objTitle?" - "+this.objTitle:""),i=this.dialog=new r({immersiveFrame:this.immersiveFrame,identifier:"ENOGroupByBrowsingStructureDialog_id",domId:"ENOGroupByBrowsingStructureDialog",title:t,content:this.content,activeFlag:!0,resizableFlag:!0,width:350,modalFlag:!0,getDefaultFocusableElement:()=>this.predicates&&this.predicates.length>0?this.content:this.cancelButton,buttons:{Cancel:this.cancelButton,Yes:this.yesButton}});this.dialog.getDefaultFocusableElement((()=>{if(this.predicates&&this.predicates.length>0)return this.content})),this.dialog.addEventListener("keydown",this._eventManagement.bind(this)),a(i)}},onFailure:()=>{c.displayNotification({message:d.webServiceError,className:"error"}),a(null)}};u._retrieveBS(p)}))},_eventManagement:function(e){27==e.keyCode&&this.dialog&&this._closePanel()},_sendWebInWinNotification:function(e,t){window.dscef&&window.dscef.sendString(e,t?"string"!=typeof t?JSON.stringify(t):t:"")},_closePanel:function(){this.dialog?(this.dialog.removeEventListener("keydown",this._eventManagement),this.dialog.close(),this.dialog.destroy(),this.immersiveFrame.destroy(),this.dialog=null):this._sendWebInWinNotification("onPanelClose")},_createAutoCompleteDialog:function(e){let t=new a({domId:"group-by-bs-selector",placeholder:d.bsChooserDialog.chooserLabel,elementsTree:e,allowFreeInputFlag:!1,multiSearchMode:!1,getChipInfo:function(){let e="",t="",i="";return this.selectedItems&&(e=this.selectedItems.options.label,t=this.selectedItems.options.value.predicate,i=this.selectedItems.options.value.physicalid),{label:e,predicate:t,physicalid:i}}});return t.value=this.previousSelection?[((e,t)=>{let i=function(e){return e===t},n=e.find((e=>e.label===t||void 0!==Object.values(e.value).find(i))),o=n&&n.hasOwnProperty("label")?n.label:null;return this.previousSelection=o,o||[]})(e,this.previousSelection)]:[],t.addEventListener("change",(e=>{let t=e.dsModel.selectedItems?e.dsModel.selectedItems.options.label:null;t!==this.previousSelection?(this.activateGroupButton(!0),null===t?this.switchButtonLabel(d.bsChooserDialog.ungroupButton):this.switchButtonLabel(d.bsChooserDialog.organizeButton)):this.activateGroupButton(!1)})),t},activateGroupButton:function(e){this.yesButton.disabled=!e},switchButtonLabel:function(e){this.yesButton.label=e},_displayNoBSMessage:function(){let e=t.createElement("div",{class:"groupbydialog_warning_no_bs"}),i=t.createElement("div",{class:"groupbydialog_warning_no_bs_msg"});return i.innerHTML=d.noBSWarning.message+"<br/>"+d.noBSWarning.advice,i.inject(e),e}})})),define("DS/GroupByBrowsingStructureWebInWin/commands/GroupByBrowsingStructureCommand",["UWA/Core","DS/ApplicationFrame/Command","DS/IPClassifyUtil/IPClassifyUtility","DS/GroupByBrowsingStructureWebInWin/views/GroupByBrowsingStructureDialog","DS/GroupByBrowsingStructureWebInWin/utils/GroupByBrowsingStructureUtils","i18n!DS/GroupByBrowsingStructureWebInWin/assets/nls/GroupByBrowsingStructureWebInWin"],(function(e,t,i,n,o,s){"use strict";return t.extend({physicalids:[],context:null,init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1}),e.hasOwnProperty("context")&&e.context&&(this.context=e.context),(null!==this.context?this.context.getXSOFromContext():o.getXSOFromContext()).then((e=>{e&&(this._check_selection(),e.onChange((()=>{this._check_selection()})))}))},_check_selection:function(){this.disable(),(null!==this.context?this.context.getXSOFromContext():o.getXSOFromContext()).then((e=>{var t=e.get();if((t=t.filter((function(e){var t=void 0===e.getNodeSource||1!==e.getNodeSource();return t&&e.isGroupingNode&&e.options&&void 0!==e.options.bsIntent&&(t=!1),t})))&&t.length>0&&t.length<=1){t.filter((e=>"function"==typeof e.isSupplemental&&e.isSupplemental())).length>0?this.disable():this.enable()}}))},beginExecute:function(){},execute:function(){i.sendTrackerPageEvt("usage","groupByBS",{label:"Launch Group By Command"}),(null!==this.context?this.context.getSelectedNodesFromContext():o.getSelectedNodesFromContext()).then((e=>{if(e&&e.length>0&&e.length<=1){this.physicalids=[e[0].id];let t=e[0].getReferenceValue("bsApplied"),i=e[0].getLabel(),o={container:widget.body,currentSelection:t,title:i};(new n).display(o)}}))},endExecute:function(){}})}));