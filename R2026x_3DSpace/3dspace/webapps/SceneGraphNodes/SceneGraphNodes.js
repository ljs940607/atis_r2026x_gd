define("DS/SceneGraphNodes/ArrowSymbolNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/GraphicAttributeSet"],(function(e,t,i,r,n,a){"use strict";var o=t.extend({init:function(i){this._parent(i.name),this._origin=i.origin?i.origin:new e.Vector3,this._direction=i.direction?i.direction:new e.Vector3(1,0,0),this._size=i.size?i.size:10,this._angle=i.semiAngle?i.semiAngle:.1974,this._zoom=i.zoom,this._symbol=i.symbol,this.globalSelection=i.globalSelection,this._color=i.color,this._threeColor=(new e.Color).setRGB(this._color.r,this._color.g,this._color.b),this._noZ=!i.removeNoZ,this._pickable=!!i.pickable;new r,new e.Vector3(1,0,0);if(this._renderable=null,this._symbolNode=this._buildGeometry(),this.setColor(),this._zoom)this.addChild(this._symbolNode);else{var n=new t("fixedSizeArrowSymbol");this.globalSelection&&n.setPickParent(!0),n.addChild(this._symbolNode),n._setRatio(1),this.addChild(n)}return this},_buildGeometry:function(){var e=0,t=0,r=0,a=i.ConnectivityTypeEnum.LINE_STRIP,o=[];switch(this._symbol){case 0:e=3,t=0;break;case 1:e=6,t=8,o=[0,1,1,2,3,4,4,5],a=i.ConnectivityTypeEnum.LINES;break;case 2:e=3,t=4,o=[0,1,2,0];break;case 3:e=34,t=0;break;case 4:e=3,t=4,r=0,o=[0,1,2,0];break;case 5:e=3,r=0;break;case 6:e=6,r=0}var s=new i.PrimitiveGroup,c=new i.Buffer;c.size=3*e,c.component=i.VertexComponentEnum.POSITION,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size);var h=new i.Buffer({indexBuffer:!0,data:new Uint16Array(t+r)});s.addBuffer(0,c),s.addBuffer(1,h);var l=c.data,d=0;if(3!==this._symbol){var u=this._size*Math.tan(this._angle);l[d++]=this._origin.x-this._size*this._direction.x+u*this._direction.y,l[d++]=this._origin.y-this._size*this._direction.y-u*this._direction.x,l[d++]=0,l[d++]=this._origin.x,l[d++]=this._origin.y,l[d++]=this._origin.z,l[d++]=this._origin.x-this._size*this._direction.x-u*this._direction.y,l[d++]=this._origin.y-this._size*this._direction.y+u*this._direction.x,l[d++]=0}else{for(var p=1.5*Math.PI,_=.5*Math.PI,m=.5*this._size,f=_-p,g=0;g<17;g++){var x=g/16*f+p;let e=m*Math.cos(x),t=m*(Math.sin(x)-1),i=e*this._direction.x-t*this._direction.y,r=e*this._direction.y+t*this._direction.x;l[d++]=this._origin.x+i,l[d++]=this._origin.y+r,l[d++]=0}for(g=0;g<17;g++){x=g/16*f+p;let e=-m*Math.cos(x),t=m*(Math.sin(x)+1),i=e*this._direction.x-t*this._direction.y,r=e*this._direction.y+t*this._direction.x;l[d++]=this._origin.x+i,l[d++]=this._origin.y+r,l[d++]=0}}1!==this._symbol&&6!==this._symbol||(l[d++]=l[0]-this._size*this._direction.x,l[d++]=l[1]-this._size*this._direction.y,l[d++]=0,l[d++]=l[3]-this._size*this._direction.x,l[d++]=l[4]-this._size*this._direction.y,l[d++]=0,l[d++]=l[6]-this._size*this._direction.x,l[d++]=l[7]-this._size*this._direction.y,l[d++]=0),l=h.data,d=0;for(var v=0;v<o.length;v++)l[d++]=o[v];if(this._symbol<=4){var w=new i.Primitive;w.nbIndices=t||e,w.connectivity=a,w.attr={line:new i.LineAttributes},(S=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,S.nbVertices=e,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=0,t&&(S.indices=new i.IndexArray({bufferId:1,offset:0})),w.addVertexComponent(S),s.addPrimitive(w),s.noz=this._noZ?1:0}if(this._symbol>=4){var S,y=new i.Primitive;y.nbIndices=r||e,y.connectivity=i.ConnectivityTypeEnum.TRIANGLES,y.attr={fill:new i.FillAttributes},(S=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,S.nbVertices=e,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=0,r&&(S.indices=new i.IndexArray({bufferId:1,offset:0})),y.addVertexComponent(S),s.addPrimitive(y),s.noz=this._noZ?1:0}var b=window.newMaterialInheritance;window.newMaterialInheritance=!0;var M=n.createMeshNode(s,void 0,void 0,"mono",this._noZ);return window.newMaterialInheritance=b,M.setShadow(!1),M.setFrustumCulled(!1),this.globalSelection&&M.setPickParent(!0),this._renderable=M._occurrences[0].renderable,M.setMaterialMode(!1),this._pickable||M.setPickable(i.NOPICKABLE),M.name="ArrowSymbolLine",M},setColor:function(t){t&&(this._color.copy(t),this._threeColor.setRGB(t.r,t.g,t.b));var i=this._renderable.geometry[0].drawingGroups[0],r=this._renderable.geometry[0].drawingGroups[1];i&&!r?i.gas.setParameters({colorRGB:this._threeColor,basic:!0}):r&&(i.gas.setParameters({colorIndex:e.COLORMAP_INDEX.BACKGROUND,basic:!0,inheritance:e.GASEnum._FORCE_COLOR}),r.gas.setParameters({colorRGB:this._threeColor,basic:!0})),this._renderable._flagAsGSSOInvalidated()},setName:function(e){this._name=e},getNodeType:function(){return"ArrowSymbolNode"}});return o.types={OPEN_ARROW:0,DOUBLE_OPEN_ARROW:1,UNFILLED_ARROW:2,WAVE:3,BLANKED_ARROW:4,FILLED_ARROW:5,DOUBLE_FILLED_ARROW:6},o.CSITypes={14:o.types.OPEN_ARROW,15:o.types.UNFILLED_ARROW,16:o.types.BLANKED_ARROW,17:o.types.FILLED_ARROW,30:o.types.DOUBLE_OPEN_ARROW,31:o.types.WAVE,32:o.types.DOUBLE_FILLED_ARROW},UWA.namespace("THREEDS/Nodes/ArrowSymbolNode",o)})),define("DS/SceneGraphNodes/FixedSizeArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/MaterialApplication"],(function(e,t,i,r,n,a,o,s){"use strict";var c=[],h={},l={},d=t.extend({init:function(i){this._parent(i.name),this.matInherit=window.newMaterialInheritance,this._arrowWidth=i.arrowWidth,this._baseLength=i.baseLength?i.baseLength:0,this._arrowLength=i.arrowLength,this._headLength=i.headLength?i.headLength:this._arrowLength/8,this._headWidth=i.headWidthToHeightRatio?i.headWidthToHeightRatio*this._headLength:this._headLength,this.globalSelection=i.globalSelection,this._color=i.color,this._threeColor=(new e.Color).setRGB(this._color.r,this._color.g,this._color.b),this._head=i.head,this._noZ=!i.removeNoZ,this._pickable=!!i.pickable;new a;var h=new e.Vector3(0,0,1),l=this._noZ?1:0,d=this._arrowLength-this._headLength,u=new t("myFixedSizeNodeG");if(this.globalSelection&&u.setPickParent(!0),this._head){var p=c[this._head],_=r.getWebappsAssetUrl("SceneGraphNodes",""),m=1===this._head?2:1,f=null,g=null,x=function(){};1===this._head?(f=h,g=(new e.Matrix4).rotateX(.5*Math.PI),p||(p=new e.ImageUtils.loadTexture(_+"models/textures/head.png",void 0,x,x,e.ImageUtils.crossOriginPolicy))):3===this._head?p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headSquare.png",void 0,x,x,e.ImageUtils.crossOriginPolicy)):4===this._head?p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headCross.png",void 0,x,x,e.ImageUtils.crossOriginPolicy)):2===this._head&&(p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headDisk.png",void 0,x,x,e.ImageUtils.crossOriginPolicy))),c[this._head]=p,this._updateHeadMaterial();var v={width:this._headWidth,height:this._headLength,fill:!0,color:this._color,noEdge:!0,layerNb:l,material:this._headMaterial,cornerPoint:this._head>=2?new e.Vector2(-this._headWidth/2,-this._headLength/2):new e.Vector2(-this._headWidth/2,0)},w=o.createRectangleNode(v);w.setShadow(!1),w.setFrustumCulled(!1),this.matInherit&&(this._renderableHead=w._occurrences[0].renderable,w.setMaterialApplication(new s({faceMaterial:this._headMaterial,layer:0})),this._headMaterial.useGASColor=!0,w.setMaterialMode(!0)),this._pickable||w.setPickable(n.NOPICKABLE),this.globalSelection&&w.setPickParent(!0),w.name="Arrow's head";var S=new t("billBoardNode");this.globalSelection&&S.setPickParent(!0),S.addChild(w),S._setBillboardData(m,f,g);var y=new t("myFixedSizeNode");this.globalSelection&&y.setPickParent(!0),y.addChild(S),y._setFixedSizeCenter((new e.Vector3).copy(h).multiplyScalar(this._baseLength+d/h.length()),1),u.addChild(y)}else d=this._arrowLength;this._updateBodyMaterial();var b={points:[new e.Vector3(0,0,this._baseLength),new e.Vector3(0,0,this._baseLength+d)],color:this._color,material:this._bodyMaterial,layerNb:l,width:this._arrowWidth},M=o.createLineNode(b);return M.setShadow(!1),M.setFrustumCulled(!1),this.globalSelection&&M.setPickParent(!0),this.matInherit&&(this._renderableBody=M._occurrences[0].renderable,M.setMaterialMode(!1)),this._pickable||M.setPickable(n.NOPICKABLE),M.name="Arrow's body",u.addChild(M),u._setRatio(1),this.addChild(u),this},_updateHeadMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head;this._headMaterial=h[t],this._headMaterial||(this._headMaterial=new e.MeshBasicMaterial({map:c[this._head],side:e.DoubleSide,transparent:!0,alphaTest:.05,color:this._threeColor,force:!this.matInherit}),h[t]=this._headMaterial)},_updateBodyMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head+"_"+this._arrowWidth;this._bodyMaterial=l[t],this._bodyMaterial||(this._bodyMaterial=new e.LineBasicMaterial({side:e.DoubleSide,color:this._threeColor,force:!this.matInherit,linecap:"butt",lineWidth:this._arrowWidth}),l[t]=this._bodyMaterial)},setColor:function(e){this._color.copy(e),this._threeColor.setRGB(e.r,e.g,e.b),this._updateHeadMaterial(),this._updateBodyMaterial(),this.matInherit&&(this._renderableHead.geometry[0].drawingGroups[0].gas.setParameters({colorRGB:this._threeColor}),this._renderableBody.geometry[0].drawingGroups[0].gas.setParameters({colorRGB:this._threeColor}),this._renderableHead._flagAsGSSOInvalidated(),this._renderableBody._flagAsGSSOInvalidated())},setName:function(e){this._name=e},getNodeType:function(){return"FixedSizeArrowNode"}});return d.types={NONE:null,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/FixedSizeArrowNode",d)})),define("SceneGraphNodes/FixedSizeArrowNode",["DS/SceneGraphNodes/FixedSizeArrowNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeArrowNode"),e})),define("DS/SceneGraphNodes/SphereLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.SphereLight(t.color,t.intensity,t.radius,t.mode);return this._radius=r.radius,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SphereLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SphereLight",i)})),define("SceneGraphNodes/SphereLightNode",["DS/SceneGraphNodes/SphereLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/SphereLightNode"),e})),define("DS/SceneGraphNodes/CSSSVGNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SVGLoader/SVGToNode3D","DS/Visualization/GetSVGMode"],(function(e,t,i,r,n){"use strict";var a;return a=t.extend({init:function(e,t,a){if(this._parent(t),this._webGLMode=n.getWebGLMode(),this._webGLMode){var o=new r(e).buildNode3D();this.addChild(o),this._cssSVGNode=!0,this.setPickable(i.PICKTHROUGH)}else{this._gNode=document.createElementNS(a.getSvgNS(),"g"),this._gNode.svgV6Node=this,this._gNode.appendChild(e),this.exludeFromBounding(!0),this.forbidChildren=!0;var s=this._occurrences[0],c=this.createRenderable();s.renderable=c,s.renderable.name=this.name,s.renderable._occurrence=s,this._cssSVGNode=!0,this.viewer=a,this._updateSVGVisibility()}},setVisibility:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisible(!!e),this._updateSVGVisibility()},setVisibilityFree:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisibilityFree(!!e),this._updateSVGVisibility()},getNodeType:function(){return this._webGLMode?this._parent.apply(this,arguments):"CSSSVGNode"},createRenderable:function(){if(this._webGLMode)return this._parent.apply(this,arguments);var t=new e.CSSSVGNode(this._gNode);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!1,t},addChild:function(){if(this._webGLMode)return this._parent.apply(this,arguments)},_updateSVGVisibility:function(){var e;this._webGLMode||(e=this._getVisibilityFree()||this.viewer.visibleSpace?this._getVisible():!this._getVisible(),this._gNode.setAttributeNS(null,"visibility",e?"visible":"hidden"))},_onLinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.appendChild(this._gNode)},_onUnlinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.removeChild(this._gNode)}}),a})),define("DS/SceneGraphNodes/InstancedSphereImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedSphereImpostorsNode","DS/DSMigration/DSMigration"],(function(e,t){return e})),define("DS/SceneGraphNodes/RectangleLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.RectangleLight(t.color,t.intensity,t.width,t.height,t.mode);return this._rectangleWidth=r.width,this._rectangleHeight=r.height,this._parent(r,i),this},attachToViewpoint:function(e){return null},setRectangleSize:function(e,t){e&&(this._rectangleWidth=e),t&&(this._rectangleHeight=t),this._updateRectangleSize()},_updateRectangleSize:function(){var e,t;this.light3js.width=this._rectangleWidth,this.light3js.height=this._rectangleHeight,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.width=this._rectangleWidth,t.renderable.height=this._rectangleHeight},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"RectangleLightNode3D"}});return UWA.namespace("THREEDS/Nodes/RectangleLight",i)})),define("DS/SceneGraphNodes/BillBoardNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],(function(e,t,i){"use strict";const r=new e.Projector,n=new e.Vector3,a=new e.Matrix4,o=new e.Matrix4,s=new e.Matrix4,c=e.__visibleInCurrentSpace;var h=new e.Matrix4(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1);const l=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this.BillBoardType=i.type,this.hack_NRE=i.hack_NRE,this.hack_NRE?this.constraintAxis=new e.Vector3(0,1,0):this.constraintAxis=new e.Vector3(0,0,1),i.constraintAxis&&this.constraintAxis.copy(i.constraintAxis),i.attachedPoint&&(this.attachedPoint=i.attachedPoint.clone()),this._localMatrix=new e.Matrix4;let r=this;const n=e.NoOccurrences;return this.cbChange=function(e){if(!n)if(r.isInstance())for(let i=0;i<r._occurrences.length;i++){const n=r._occurrences[i],a=n.parent;if(!n.scene3js||!a)continue;let o=n.scene3js.viewer;if(c(n._getVisible(),n._getVisibilityFree(),o.getVisibleSpace(),null,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&o!==e.viewpoint.viewer)continue;let s=o.currentViewpoint;if(e){if(!e.viewpoint)return;if((o._viewpointManager.getViewpointScenegraph(e.viewpoint)||o.internalSceneGraph).root3js!=n.scene3js)return}s=n._getViewpoint()||s;const c=r._getDynamicMatrix(a.matrix,e,s,i);n.matrix.multiplyMatrices(a.matrix,c);for(let e=0;e<n.children.length;e++)r._updateOccurrences(n,n.children[e],t.UpdateMatrixMode.Always,!0,t.InvalidateGSSOMode.Always)}}else{const i=r.parents[0];if(!i)return;const n=this._occurrences[0];if(!n.scene3js)return;const a=n.scene3js.viewer;if(c(n._getVisible(),n._getVisibilityFree(),a.getVisibleSpace(),null,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&a!==e.viewpoint.viewer)return;let o=a.currentViewpoint;if(e){if(!e.viewpoint)return;if((a._viewpointManager.getViewpointScenegraph(e.viewpoint)||a.internalSceneGraph).root3js!=n.scene3js)return}o=n._getViewpoint()||o;const s=r._getDynamicMatrix(i.getMatrixWorld(),e,o,0);t.prototype.setMatrix.call(r,s,!0)}}},this.tokenChange=null,this},isPointOfViewDependant:function(){return!0},_linkingClone:function(e){return e=e||new l({name:this.name,type:this.BillBoardType,constraintAxis:this.constraintAxis,attachedPoint:this.attachedPoint}),t.prototype._linkingClone.call(this,e),e},_onLinkedToSceneGraph:function(){let e=this;this.tokenChange=i.subscribe({event:"/VISU/"},(function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)}))},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},setBillboardType:function(e){this.BillBoardType=e,this.cbChange()},getNodeType:function(){return"BillBoardNode3D"},_getDynamicMatrix:function(e,t,i){e||(a.identity(),e=a);const r=(i||t.viewpoint).camera,c=r.getLookAt();c.add(r.position),s.identity(),s.extractRotation(e);const l="Spherical"===this.BillBoardType;return l?(o.identity(),o.lookAt(r.position,c,r.up)):this._ComputeCylindricalTransform(r,r.position,c,e,"PseudoSpherical"===this.BillBoardType),a.getInverse(s),s.multiplyMatrices(a,o),this.hack_NRE&&!l&&(o.multiplyMatrices(s,h),s.copy(o)),s.setPosition(n.getPositionFromMatrix(this._localMatrix)),s},_ComputeCylindricalTransform:function(){const t=new e.Vector3,i=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,c=new e.Vector3,h=new e.Vector3;return function(e,l,d,u,p){if(i.copy(this.constraintAxis).transformDirection(u).normalize(),p){h.getPositionFromMatrix(u),t.subVectors(h,l),c.addVectors(h,i);let n=h.clone();r.projectVector(n,e),r.projectVector(c,e),c.z=n.z,r.unprojectVector(c,e),c.sub(h),c.normalize(),i.copy(c)}else t.subVectors(d,l);if(t.normalize(),n.crossVectors(t,i),n.lengthSq()<1e-10){let e=Math.abs(t.z)<.999?s.set(0,0,1):s.set(1,0,0);n.crossVectors(e,t)}return n.normalize(),a.crossVectors(i,n),a.normalize(),o.set(n.x,a.x,i.x,0,n.y,a.y,i.y,0,n.z,a.z,i.z,0,0,0,0,1),o}}(),setConstraintAxis:function(e){this.constraintAxis=e,this.cbChange()},setMatrix:function(e,t){this._localMatrix=e,this.cbChange(),this._updateMatrix(t)}});return UWA.namespace("THREEDS/Nodes/BillBoard",l)})),define("SceneGraphNodes/BillBoardNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/BillBoardNode3D"),e})),define("DS/SceneGraphNodes/DynamicLeaderNode",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Visualization/SceneGraphFactory"],(function(e,t,i,r,n){let a=-Math.PI/4,o=Math.PI/4,s=-3*Math.PI/4,c=3*Math.PI/4,h=.5,l=.5,d=new e.Vector2;return class extends i{constructor(t){super(t.name),this._boxVisibility=!1,this._isDynamic=!1,this._orientation=null,this._type=t.type||"simple",this._horExtension=null,this._vertExtension=null,"snappable"===this._type&&(t.horizontalOffset>0&&(this._horExtension=t.horizontalOffset),t.verticalOffset>0&&(this._vertExtension=t.verticalOffset)),this._filled=!1,this._target=t.target||new e.Vector3,this._xmin=t.xmin,this._xmax=t.xmax,this._ymin=t.ymin,this._ymax=t.ymax,this._centroidMode=!0,"simple"===this._type&&!1===t.centroidMode&&(this._centroidMode=!1),this._boxAnchorPoint=t.boxAnchorPoint||new e.Vector3,this._boxAngle=t.angle||0,this._arrowLength=null,t.arrowHead&&t.arrowHead>0&&(this._arrowLength=t.arrowHead),this._computeCornerThetas(),this._type,this._createLine()}_createLine(){let i={};if("simple"===this._type)i=this._arrowLength?{points:[new e.Vector3(0,0,0),new e.Vector3(0,0,0),new e.Vector3(0,0,0),new e.Vector3(0,0,0),new e.Vector3(0,0,0)],editable:!0,drawMode:t.ConnectivityTypeEnum.LINES,layerNb:1}:{points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],editable:!0,drawMode:t.ConnectivityTypeEnum.LINES,layerNb:1};else if("snappable"===this._type){i=this._arrowLength?{points:[new e.Vector3(0,0,0),new e.Vector3(0,0,0),new e.Vector3(0,0,0),new e.Vector3(0,0,0),new e.Vector3(0,0,0)],editable:!0,drawMode:t.ConnectivityTypeEnum.LINES,layerNb:1}:{points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],editable:!0,drawMode:t.ConnectivityTypeEnum.LINES,layerNb:1};let r={points:[new e.Vector3(0,0,0),new e.Vector3(0,0,0)],editable:!0,drawMode:t.ConnectivityTypeEnum.LINES,layerNb:1};this._extentLineNode=n.createLineNode(r),this._extentlineNode.setFrustumCulled(!1),this.addChild(this._extentLineNode),this._extentLineNode.setVisibility(!1)}this._lineNode=n.createLineNode(i),this._lineNode.setFrustumCulled(!1),this.addChild(this._lineNode),this._lineNode.setVisibility(!1)}_computeCornerThetas(){h=(this._xmax-this._xmin)/2,l=(this._ymax-this._ymin)/2,d.x=(this._xmax+this._xmin)/2,d.y=(this._ymax+this._ymin)/2;let t=new e.Vector2(this._xmin,this._ymin);t.subVectors(t,d);let i=new e.Vector2(this._xmax,this._ymin);i.subVectors(i,d);let r=new e.Vector2(this._xmax,this._ymax);r.subVectors(r,d);let n=new e.Vector2(this._xmin,this._ymax);n.subVectors(n,d),s=Math.atan2(t.y,t.x),a=Math.atan2(i.y,i.x),o=Math.atan2(r.y,r.x),c=Math.atan2(n.y,n.x)}_updateGeom(e){this._type,this._changeLine(e)}_toCenterBoxCoordMatrix(t){let i=new e.Matrix4,r=this.getMatrixWorld(),n=(new e.Vector3).copy(this._boxAnchorPoint);r&&n.applyMatrix4(r);let a=e.getPixelsPerMM(),o=t.project(n);o.x/=a,o.y/=-a;let s=new e.Vector3(-o.x-d.x,-o.y-d.y,0),c=new e.Vector3(0,0,1),h=(new e.Quaternion).setFromAxisAngle(c,-this._boxAngle);return s.applyQuaternion(h),i.compose(s,h,new e.Vector3(1,1,1)),i}_changeLine(i){this._extentLineNode&&this._extentLineNode.setVisibility(!1);let r=!1,n=this.getMatrixWorld(),d=(new e.Vector3).copy(this._boxAnchorPoint);n&&d.applyMatrix4(n);let u=e.getPixelsPerMM(),p=i.project(d);p.x/=u,p.y/=-u;let _=(new e.Vector3).copy(this._target);n&&_.applyMatrix4(n);let m=i.project(_),f=new e.Vector3(m.x,m.y,0);f.x/=u,f.y/=-u;let g=this._toCenterBoxCoordMatrix(i);f.applyMatrix4(g),p.applyMatrix4(g);let x=new e.Vector3,v=new e.Vector3;if("simple"===this._type)if(this._centroidMode){if(f.x>=-h&&f.x<=h&&f.y>=-l&&f.y<=l)return void this._lineNode.setVisibility(!1);let e=Math.atan2(f.y,f.x);e>=s&&e<=a?(x.y=-l,x.x=-l*(f.x/f.y)):e>=a&&e<=o?(x.x=h,x.y=h*(f.y/f.x)):e>=o&&e<=c?(x.y=l,x.x=l*(f.x/f.y)):(x.x=-h,x.y=-h*(f.y/f.x))}else{let t=(new e.Vector3).subVectors(p,f);t.z=0;let i=t.length();t.normalize();let r=i,n=0;if(0!==t.x){let e;f.x>h&&(n=(h-f.x)/t.x,n>0&&n<r&&(e=f.y+t.y*n,e>-l&&e<l&&(x.x=h,x.y=e,r=n))),f.x<-h&&(n=(-h-f.x)/t.x,n>0&&n<r&&(e=f.y+t.y*n,e>-l&&e<l&&(x.x=-h,x.y=e,r=n)))}if(0!==t.y){let e;f.y>l&&(n=(l-f.y)/t.y,n>0&&n<r&&(e=f.x+t.x*n,e>-h&&e<h&&(x.y=l,x.x=e,r=n))),f.y<-l&&(n=(-l-f.y)/t.y,n>0&&n<r&&(e=f.x+t.x*n,e>-h&&e<h&&(x.y=-l,x.x=e,r=n)))}if(r===i)return void this._lineNode.setVisibility(!1)}else if("snappable"===this._type)if(f.x>=-h&&f.x<=h)if(f.y<=-l)x.y=-l,x.x=0,this._vertExtension>0&&(r=!0,v.x=x.x,v.y=x.y-this._vertExtension,this._extentLineNode.setVisibility(!0));else{if(!(f.y>=l))return void this._lineNode.setVisibility(!1);x.y=l,x.x=0,this._vertExtension>0&&(r=!0,v.x=x.x,v.y=x.y+this._vertExtension,this._extentLineNode.setVisibility(!0))}else if(f.x>=h)x.x=h,x.y=0,this._horExtension&&(r=!0,v.x=x.x+this._horExtension,v.y=x.y,this._extentLineNode.setVisibility(!0));else{if(!(f.x<=-h))return void this._lineNode.setVisibility(!1);x.x=-h,x.y=0,this._horExtension>0&&(r=!0,v.x=x.x-this._horExtension,v.y=x.y,this._extentLineNode.setVisibility(!0))}let w=(new e.Matrix4).getInverse(g);x.applyMatrix4(w),x.x*=u,x.y*=-u,x.z=i.camera.getProjectedDepthNear();let S=i.unProject(x),y=new e.Matrix4;n&&(y.getInverse(n),S.applyMatrix4(y));let b=this._lineNode.getBuffer(t.VertexComponentEnum.POSITION);if(r){let e;v.applyMatrix4(w),v.x*=u,v.y*=-u,v.z=i.camera.getProjectedDepthNear(),e=i.unProject(v),e.applyMatrix4(y);let r=this._extentLineNode.getBuffer(t.VertexComponentEnum.POSITION);r[0]=S.x,r[1]=S.y,r[2]=S.z,r[3]=e.x,r[4]=e.y,r[5]=e.z,this._extentLineNode.updateBuffer(t.VertexComponentEnum.POSITION,0,2),this._extentLineNode._invalidateBoundingElements(),b[0]=e.x,b[1]=e.y,b[2]=e.z}else b[0]=S.x,b[1]=S.y,b[2]=S.z;if(m=i.project(_),b[3]=this._target.x,b[4]=this._target.y,b[5]=this._target.z,this._arrowLength){let n,a=this._arrowLength*u;n=r?new e.Vector2(m.x-v.x,m.y-v.y):new e.Vector2(m.x-x.x,m.y-x.y),n.normalize();let o=new e.Vector2(-n.y,n.x);n.multiplyScalar(-a),o.multiplyScalar(a/5);let s=(new e.Vector2).addVectors(n,o),c=(new e.Vector2).subVectors(n,o),h=new e.Vector3(s.x,s.y,0).add(m);h.z=i.camera.getProjectedDepthNear();let l=new e.Vector3(c.x,c.y,0).add(m);l.z=i.camera.getProjectedDepthNear();let d=i.unProject(h),p=i.unProject(l);b[6]=d.x,b[7]=d.y,b[8]=d.z,b[9]=p.x,b[10]=p.y,b[11]=p.z,b[12]=this._target.x,b[13]=this._target.y,b[14]=this._target.z,this._lineNode.updateBuffer(t.VertexComponentEnum.POSITION,0,5),this._lineNode._invalidateBoundingElements()}else this._lineNode.updateBuffer(t.VertexComponentEnum.POSITION,0,2),this._lineNode._invalidateBoundingElements();this._lineNode.setVisibility(!0)}_createCloud(){this._cloudNodeTab=[];for(let e=0;e<3;++e){let e=n.createCircleLine();this._cloudNodeTab.push(e)}}_changeCloud(){}_onLinkedToSceneGraph(){let e=this._getViewer();e&&e.currentViewpoint&&this._updateGeom(e.currentViewpoint),this.tokenChange=r.subscribe({event:"/VISU/"},(e=>{"@onViewpointChange"===e.eventType&&this._updateGeom(e.viewpoint)}))}_onUnlinkedToSceneGraph(){r.unsubscribe(this.tokenChange)}}})),define("DS/SceneGraphNodes/RectangleWithCornersNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/CoreEvents/Events"],(function(e,t,i,r,n){"use strict";let a=e.__visibleInCurrentSpace;return class extends t{constructor(r){super(r.name),this.cameraName=r.cameraName||"camera",this.bottomLeftCorner=r.bottomLeftCorner,this.topRightCorner=r.topRightCorner,this.brightColor=null,this.darkColor=null,r.brightColor&&(this.brightColor=new i.Color(r.brightColor[0],r.brightColor[1],r.brightColor[2],r.brightColor[3])),r.darkColor&&(this.darkColor=new i.Color(r.darkColor[0],r.darkColor[1],r.darkColor[2],r.darkColor[3])),r.frameColor&&(this.frameColor=new i.Color(r.frameColor[0],r.frameColor[1],r.frameColor[2],r.frameColor[3])),this.squaredCorners=r.squaredCorners||!1,this.chamfer=!1,this._createGeometry();let n=this.topRightCorner.y-this.bottomLeftCorner.y,o=this.topRightCorner.x-this.bottomLeftCorner.x,s=Math.min(n,o)/8;this._moveGeometry(s);let c=this,h=e.NoOccurrences;this.cbChange=function(e){if(!h)if(c.isInstance())for(let r=0;r<c._occurrences.length;r++){let n=c._occurrences[r],o=n.parent;if(!n.scene3js||!o)continue;let s=n.scene3js.viewer;if(a(n._getVisible(),n._getVisibilityFree(),s.getVisibleSpace(),null,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;let r=s.currentViewpoint;if(e){if(!e.viewpoint)return;if((s._viewpointManager.getViewpointScenegraph(e.viewpoint)||s.internalSceneGraph).root3js!=n.scene3js)return}r=n._getViewpoint()||r;let a=o.node.getMatrixWorld();a&&c._scaleGeometries(a,e,r);for(var i=0;i<n.children.length;i++)c._updateOccurrences(n,n.children[i],t.UpdateMatrixMode.Always,!0,t.InvalidateGSSOMode.Always)}}else{let t=c.parents[0];if(!t)return;let i=this._occurrences[0];if(!i.scene3js)return;let r=i.scene3js.viewer;if(a(i._getVisible(),i._getVisibilityFree(),r.getVisibleSpace(),null,i)){if(e&&e.viewpoint&&e.viewpoint.viewer&&r!==e.viewpoint.viewer)return;let n=r.currentViewpoint;if(e){if(!e.viewpoint)return;if((r._viewpointManager.getViewpointScenegraph(e.viewpoint)||r.internalSceneGraph).root3js!=i.scene3js)return}n=i._getViewpoint()||n,c._scaleGeometries(t.getMatrixWorld(),e,n)}}},this.tokenChange=null}setCornerGeometry(t){if(t!==this.squaredCorners)if(this.squaredCorners=t,this.trCorner.removeChildren(),this.tlCorner.removeChildren(),this.brCorner.removeChildren(),this.blCorner.removeChildren(),this.squaredCorners){let t;t=this.brightColor?r.createLineNode({points:[new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(0,1,0)],material:new e.LineBasicMaterial({color:this.brightColor,force:!0})}):r.createLineNode({points:[new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(0,1,0)]}),this.trCorner.addChild(t),this.tlCorner.addChild(t),this.brCorner.addChild(t),this.blCorner.addChild(t)}else{let t;t=this.brightColor?r.createCircleNode({radius:1,segments:5,fill:!1,startAngle:0,endAngle:Math.PI/2,material:new e.LineBasicMaterial({color:this.brightColor,force:!0})}):r.createCircleNode({radius:1,segments:5,fill:!1,startAngle:0,endAngle:Math.PI/2}),this.trCorner.addChild(t),this.tlCorner.addChild(t),this.brCorner.addChild(t),this.blCorner.addChild(t)}}_toggleChamfer(t){if(!this.squaredCorners&&this.chamfer!==t){if(this.trCorner.removeChildren(),this.tlCorner.removeChildren(),this.brCorner.removeChildren(),this.blCorner.removeChildren(),t){let t=r.createLineNode({points:[new e.Vector3(1,0,0),new e.Vector3(0,1,0)]});t._setPixelCullingFromParent(!0),this.trCorner.addChild(t),this.tlCorner.addChild(t),this.brCorner.addChild(t),this.blCorner.addChild(t)}else{let t;t=this.brightColor?r.createCircleNode({radius:1,segments:5,fill:!1,startAngle:0,endAngle:Math.PI/2,material:new e.LineBasicMaterial({color:this.brightColor,force:!0})}):r.createCircleNode({radius:1,segments:5,fill:!1,startAngle:0,endAngle:Math.PI/2}),t._setPixelCullingFromParent(!0),this.trCorner.addChild(t),this.tlCorner.addChild(t),this.brCorner.addChild(t),this.blCorner.addChild(t)}this.chamfer=t}}_createGeometry(){let i={points:[new e.Vector3(0,0,0),new e.Vector3(1,0,0)]},n=r.createLineNode(i);this.bottomLine=new t,this.bottomLine.addChild(n),this.topLine=new t,this.topLine.addChild(n);let a={points:[new e.Vector3(0,0,0),new e.Vector3(0,1,0)]},o=r.createLineNode(a);if(this.leftLine=new t,this.leftLine.addChild(o),this.rightLine=new t,this.rightLine.addChild(o),this.trCorner=new t,this.tlCorner=new t,this.brCorner=new t,this.blCorner=new t,this.squaredCorners){let t;t=this.brightColor?r.createLineNode({points:[new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(0,1,0)],material:new e.LineBasicMaterial({color:this.brightColor,force:!0})}):r.createLineNode({points:[new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(0,1,0)]}),this.trCorner.addChild(t),this.tlCorner.addChild(t),this.brCorner.addChild(t),this.blCorner.addChild(t),t._setPixelCullingFromParent(!0)}else{let t;t=this.brightColor?r.createCircleNode({radius:1,segments:5,fill:!1,startAngle:0,endAngle:Math.PI/2,material:new e.LineBasicMaterial({color:this.brightColor,force:!0})}):r.createCircleNode({radius:1,segments:5,fill:!1,startAngle:0,endAngle:Math.PI/2}),this.trCorner.addChild(t),this.tlCorner.addChild(t),this.brCorner.addChild(t),this.blCorner.addChild(t),t._setPixelCullingFromParent(!0)}this.addChild(this.bottomLine),this.addChild(this.topLine),this.addChild(this.leftLine),this.addChild(this.rightLine),this.addChild(this.brCorner),this.addChild(this.trCorner),this.addChild(this.blCorner),this.addChild(this.tlCorner),this.trCorner._setPixelCullingFromParent(!0),this.tlCorner._setPixelCullingFromParent(!0),this.brCorner._setPixelCullingFromParent(!0),this.brCorner._setPixelCullingFromParent(!0)}_moveGeometry(t){let i=new e.Vector3(this.bottomLeftCorner.x,this.bottomLeftCorner.y,0),r=new e.Vector3(this.topRightCorner.x,this.bottomLeftCorner.y,0),n=new e.Vector3(this.topRightCorner.x,this.topRightCorner.y,0),a=new e.Vector3(this.bottomLeftCorner.x,this.topRightCorner.y,0),o=r.x-i.x-2*t,s=new e.Vector3(i.x+t,i.y,0),c=(new e.Matrix4).compose(s,new e.Quaternion,new e.Vector3(o,o,o));this.bottomLine.setMatrix(c);let h=new e.Vector3(a.x+t,a.y,0),l=(new e.Matrix4).compose(h,new e.Quaternion,new e.Vector3(o,o,o));this.topLine.setMatrix(l);let d=a.y-i.y-2*t,u=new e.Vector3(i.x,i.y+t,0),p=(new e.Matrix4).compose(u,new e.Quaternion,new e.Vector3(d,d,d));this.leftLine.setMatrix(p);let _=new e.Vector3(r.x,r.y+t,0),m=(new e.Matrix4).compose(_,new e.Quaternion,new e.Vector3(d,d,d));this.rightLine.setMatrix(m);let f=new e.Vector3(n.x-t,n.y-t,0),g=(new e.Matrix4).compose(f,new e.Quaternion,new e.Vector3(t,t,t));this.trCorner.setMatrix(g);let x=new e.Vector3(0,0,1),v=(new e.Quaternion).setFromAxisAngle(x,.5*Math.PI),w=new e.Vector3(a.x+t,a.y-t,0),S=(new e.Matrix4).compose(w,v,new e.Vector3(t,t,t));this.tlCorner.setMatrix(S);let y=(new e.Quaternion).setFromAxisAngle(x,Math.PI),b=new e.Vector3(i.x+t,i.y+t,0),M=(new e.Matrix4).compose(b,y,new e.Vector3(t,t,t));this.blCorner.setMatrix(M);let T=(new e.Quaternion).setFromAxisAngle(x,1.5*Math.PI),P=new e.Vector3(r.x-t,r.y+t,0),C=(new e.Matrix4).compose(P,T,new e.Vector3(t,t,t));this.brCorner.setMatrix(C)}_scaleGeometries(t,i,r){let n=r||i.viewpoint,a=n[this.cameraName],o=(new e.Matrix4).multiplyMatrices(t,this.getMatrix()).decompose()[0],s=a.getWorldSizeFromPixelSize(1,o,n.viewer._getDivClientHeight(),1),c=this.topRightCorner.y-this.bottomLeftCorner.y,h=this.topRightCorner.x-this.bottomLeftCorner.x,l=Math.min(c,h)/8,d=Math.min(l,20*s);this._moveGeometry(d)}_onLinkedToSceneGraph(){this.tokenChange=n.subscribe({event:"/VISU/"},(e=>{"@onViewpointChange"===e.eventType&&this.cbChange(e)})),this.cbChange()}_onUnlinkedToSceneGraph(){n.unsubscribe(this.tokenChange)}setName(e){this._name=e}getNodeType(){return"RectangleWithCornersNode"}}})),define("DS/SceneGraphNodes/TubeLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.TubeLight(t.color,t.intensity,t.radius,t.width,t.mode);return this._radius=r.radius,this._width=r.width,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},setWidth:function(e){e&&(this._width=e),this._updateWidth()},_updateWidth:function(){var e;this.light3js.width=this._width,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.width=this._width},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"TubeLightNode3D"}});return UWA.namespace("THREEDS/Nodes/TubeLight",i)})),define("SceneGraphNodes/TubeLightNode",["DS/SceneGraphNodes/TubeLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/TubeLightNode"),e})),define("DS/SceneGraphNodes/CSS2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],(function(e,t){"use strict";var i=t.extend({defaultOptions:{},init:function(t,i,r,n){var a=null,o=null,s=null,c=null;t.hasOwnProperty("html")?(a=t.html,o=t.position,s=t.name,c=t.offset):(console.warn("DEPRECATED : create your CSS2DNode with a litteral object"),a=t,o=i,s=r,c=n),o||(o=new e.Vector3),this._parent(s),this._element=a;var h=document.createElement("div");h.appendChild(a),h.style.display="none",h.ondragstart=function(){return!1},this.css2DNode=new e.CSS2DNode(h,o,c),this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),1),this.explicitBBox=null,this.css2DNode.matrixAutoUpdate=!1,this.css2DNode.applyMatrix((new e.Matrix4).setPosition(o)),this._alwaysOnTopIndex=null;var l=this._occurrences[0];return l.renderable=this.css2DNode,l.renderable.name=this.name,l.renderable._occurrence=l,document.getElementById("divCss2DElement")&&document.getElementById("divCss2DElement").appendChild(this.css2DNode.element),this.setMatrix(this.css2DNode.matrix),this.rank=0,this.vanish=!1,this},setPickability:function(e){this.css2DNode.element.style.pointerEvents=e?"auto":"none"},getElement:function(){return this._element},add:function(){return!1},getNodeType:function(){return"CSS2DNode"},setOffset:function(t){t instanceof e.Vector2&&(this.css2DNode.offset=t.clone(),this._occurrences[0].node.css2DNode.offset=this.css2DNode.offset)},getOffset:function(){return this.css2DNode.offset},setAlwaysOnTopIndex:function(e){this._alwaysOnTopIndex=e},getAlwaysOnTopIndex:function(){return this._alwaysOnTopIndex},updatePosition:function(){var t=this._getViewer();if(t){var i=this.css2DNode,r=t.canvas,n=t.currentViewpoint.camera,a=new e.Vector3;if(a.copy(this.css2DNode.position),n.getLookAt().dot(n.position.clone().sub(a))<0){(new e.Projector).projectVector(a,n),i.element.style.display="block";var o=e.getDevicePixelRatio()||1,s=i.offset.x/o,c=i.offset.y/o;i.element.style.left=s+.5*(a.x+1)*r.clientWidth+"px",i.element.style.top=c-.5*(a.y-1)*r.clientHeight+"px"}else i.element.style.display="none"}},clone:function(){return new THREEDS.Nodes.CSS2DNode(this.css2DNode.element,this.css2DNode.position,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS2DNode",i)})),define("SceneGraphNodes/CSS2DNode",["DS/SceneGraphNodes/CSS2DNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNode"),e})),define("DS/SceneGraphNodes/FixedSizeNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],(function(e,t,i){"use strict";var r=new e.Vector3,n=new e.Matrix4,a=new e.Matrix4,o=e.__visibleInCurrentSpace,s=t.extend({init:function(i){var r;arguments.length>1?(console.error("[WARNING] DEPRECATED FixedSizeNode3D construction: "+(new Error).stack),r={name:arguments[0],ratio:arguments[1],cameraName:arguments[3]}):r=i||{},this._parent(r.name),this.cameraName=r.cameraName||"camera",this._isDynamic=!0,this._autoUpdate=!0,this.invariantPoint=r.invariantPoint||null,this.ratio=r.ratio,this.scaleFactor=1,this.scaleFactorPerOcc=[],this.mutablePositionMatrix=!0===r.mutablePositionMatrix||!1;var n=this,a=e.NoOccurrences;return this.cbChange=function(e){if(!a)if(n.isInstance())for(var i=0;i<n._occurrences.length;i++){var r=(d=n._occurrences[i]).parent;if(d.scene3js&&r){var s=d.scene3js.viewer;if(o(d._getVisible(),d._getVisibilityFree(),s.getVisibleSpace(),null,d)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;var c=s.currentViewpoint;if(e){if(!e.viewpoint)return;if((s._viewpointManager.getViewpointScenegraph(e.viewpoint)||s.internalSceneGraph).root3js!=d.scene3js)return}c=d._getViewpoint()||c;var h=n._getDynamicMatrix(r.matrix,e,c,i);d.matrix.multiplyMatrices(r.matrix,h);for(var l=0;l<d.children.length;l++)n._updateOccurrences(d,d.children[l],t.UpdateMatrixMode.Always,!0,t.InvalidateGSSOMode.Always)}}}else{var d,u=n.parents[0];if(!u)return;if(!(d=this._occurrences[0]).scene3js)return;s=d.scene3js.viewer;if(o(d._getVisible(),d._getVisibilityFree(),s.getVisibleSpace(),null,d)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)return;c=s.currentViewpoint;if(e){if(!e.viewpoint)return;if((s._viewpointManager.getViewpointScenegraph(e.viewpoint)||s.internalSceneGraph).root3js!=d.scene3js)return}c=d._getViewpoint()||c;h=n._getDynamicMatrix(u.getMatrixWorld(),e,c,0);t.prototype.setMatrix.call(n,h,!0)}}},this.tokenChange=null,this},_linkingClone:function(e){return e=e||new s({name:this.name,cameraName:this.cameraName,invariantPoint:this.invariantPoint,ratio:this.ratio}),t.prototype._linkingClone.call(this,e),e},setRatio:function(e){e!==this.ratio&&this._invalidateBoundingElements(),this.ratio=e,this.cbChange()},setMutablePositionMatrix:function(e){this.mutablePositionMatrix=e,this.cbChange()},getRatio:function(){return this.ratio},setInvariantPoint:function(e){this.invariantPoint=e,this.cbChange()},getInvariantPoint:function(){return this.invariantPoint},getScaleFactor:function(e){return e>=0?this.scaleFactorPerOcc[e]:this.scaleFactor},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},(e=>{this._autoUpdate&&"@onViewpointChange"===e.eventType&&this.cbChange(e)}))},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(t,i,o,s){t||(n.identity(),t=n);var c=o||i.viewpoint,h=c[this.cameraName];this._matrix?a.multiplyMatrices(t,this._matrix):a.copy(t);var l=a.getMaxScaleOnAxis();if(this.mutablePositionMatrix){let e=this.getBoundingSphere();this.invariantPoint?(r.copy(this.invariantPoint),t&&r.applyMatrix4(t)):r.copy(e.center)}else this.invariantPoint?r.copy(this.invariantPoint):r.getPositionFromMatrix(a);var d=l/h.getWorldSizeFromPixelSize(1,r,c.viewer._getDivClientHeight(),1)/this.ratio,u=0!==d?1/d:1;if(u||(u=1),n.makeScale(u,u,u),this.scaleFactor=(this._matrix?this._matrix.getMaxScaleOnAxis():1)*u,this.scaleFactorPerOcc[s||0]=this.scaleFactor,this._matrix)return a.multiplyMatrices(this._matrix,n),a;if(this.invariantPoint){let t=(new e.Vector3).copy(this.invariantPoint);t.multiplyScalar(1-this.scaleFactor),n.setPosition(t)}return n},setCameraName:function(e){this.cameraName=e||"camera"},setMatrix:function(e,i){t.prototype.setMatrix.call(this,e,i),this.cbChange()}});return UWA.namespace("THREEDS/Nodes/FixedSizeNode3D",s)})),define("SceneGraphNodes/FixedSizeNode3D",["DS/SceneGraphNodes/FixedSizeNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeNode3D"),e})),define("DS/SceneGraphNodes/InstancedCurvedPipeManager",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],(function(e,t){"use strict";var i,r,n={maxTextureSize:-1,maxTextureTotalSize:-1,isInit:!1,init:function(){this.isInit||(this.maxTextureSize=e.supportedExtensions.maxTextureSize,this.maxTextureTotalSize=this.maxTextureSize*this.maxTextureSize,this.isInit=!0)}},a=function(e,t){for(var i=t||1;i<e;)i*=2;return i},o=(i=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0]),(r=new e.DataTexture(i,3,1,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,r.magFilter=e.NearestFilter,r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0,r),s=function(e){var t=e.x,i=e.y,r=e.z,n=Math.abs(t)+Math.abs(i)+Math.abs(r),a=t/n,o=i/n;if(r<0){var s=(1-Math.abs(o))*(a>=0?1:-1),c=(1-Math.abs(a))*(o>=0?1:-1);a=s,o=c}return 4096*(a=Math.round(4095*(.5*a+.5)))+(o=Math.round(4095*(.5*o+.5)))},c=0,h=1,l=2,d={_VSGlobal:["#define NB_CURVES_MAPS_MAX 2","#define NB_CURVES_MAPS 1","#define NB_MATRICES_MAPS 1","#define PI2 6.28318530718","vec3 cp_objectPosition;","vec3 cp_objectNormal;","vec3 cp_infosUV;","mat4 _curveModelMatrix;","float cp_radius;","vec3 decompressVector(in float iVec) {","return decodeOct24Normal_1(iVec);","}","vec4 getCurveData(float iId, float iMaxMapTotalSize, float iLAST_CURVES_MAP_SIZE_X, float iLAST_CURVES_MAP_SIZE_Y) {","int texId = int(floor(iId/iMaxMapTotalSize));","float idInTexture = iId - float(texId)*iMaxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_CURVES_MAPS) - 1) {","dx = 1.0 / iLAST_CURVES_MAP_SIZE_X;","dy = 1.0 / iLAST_CURVES_MAP_SIZE_Y;","y = floor(idInTexture/iLAST_CURVES_MAP_SIZE_X);","x = idInTexture - y*iLAST_CURVES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","vec4 curveData;","for (int i = 0; i < NB_CURVES_MAPS; i++) {","if (texId == i) {","curveData = texture2D( curvesMaps[i], xy);","}","}","return curveData;","}","","void computeMatrixAndRadius() {","float _idInMatricesMap = specialMeshIds.x;","float LAST_MATRICES_MAP_SIZE_X = curvesMatricesProperties.x;","float LAST_MATRICES_MAP_SIZE_Y = curvesMatricesProperties.y;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","int texId = int(floor(_idInMatricesMap/maxMapTotalSize));","float idInTexture = _idInMatricesMap - float(texId)*maxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_MATRICES_MAPS) - 1) {","dx = 1.0 / LAST_MATRICES_MAP_SIZE_X;","dy = 1.0 / LAST_MATRICES_MAP_SIZE_Y;","y = floor(idInTexture/LAST_MATRICES_MAP_SIZE_X);","x = idInTexture - y*LAST_MATRICES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","_curveModelMatrix[3].w = 1.0;","for (int i = 0; i < NB_MATRICES_MAPS; i++) {","if (texId == i) {","vec4 tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[0].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 1.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[1].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 2.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[2].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 3.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[3].xyz = tmp.xyz;","cp_radius = tmp.w;","}","}","}"].join("\n"),_VSOverridables:{ComputeCommonValues:["void ComputeCommonValues() {","vec3 infos = vGetAttribPosition();","cp_infosUV = infos;","float LAST_CURVES_MAP_SIZE_X = curvesMapsProperties.x;","float LAST_CURVES_MAP_SIZE_Y = curvesMapsProperties.y;","float _idInCurvesMaps = specialMeshIds.y;","float curvePointId = _idInCurvesMaps + infos.x;","float nextCurvePointId = curvePointId + 1.0;","float precCurvePointId = curvePointId - 1.0;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","vec4 curveData = getCurveData(curvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 nextCurveData = getCurveData(nextCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 precCurveData = getCurveData(precCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec3 curvePoint = curveData.xyz;","vec3 u = decompressVector(curveData.w);","vec3 nextCurvePoint = nextCurveData.xyz;","vec3 precCurvePoint = precCurveData.xyz;","computeMatrixAndRadius();","float angle = infos.y;","vec3 localPosition = vec3(cos(angle), sin(angle), 0.0);","vec3 t = normalize(nextCurvePoint - precCurvePoint);","vec3 v = cross(t, u);","cp_objectPosition = curvePoint + cp_radius*normalize(localPosition.x*u + localPosition.y*v);","bool isCap = infos.z > 0.3;","float isFirstSign = infos.z > 0.7 ? 1.0 : -1.0;","cp_objectNormal = isCap ? isFirstSign*t : normalize(cp_objectPosition - curvePoint);","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","mat4 curveMVMatrix = vGetViewMatrix()*_curveModelMatrix;","ioWorldViewTS.Position = vec3(curveMVMatrix*vec4(cp_objectPosition, 1.0));","ioWorldViewTS.Normal = vec3(curveMVMatrix*vec4(cp_objectNormal, 0.0));","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","return vec4(cp_infosUV.x / 16.0, cp_infosUV.y / PI2, 0.0, 0.0);","}"].join("\n")}},u=function(){this._ranges=[]};u.prototype.addID=function(e){if(!(e<0)){var t=this._ranges;if(0!==t.length){for(var i=t.length,r=null,n=0;n<i;){if(e>=(r=t[n]).min&&e<=r.max)return;if(e===r.min-1)return r.min=e,void(n>0&&t[n-1].max===e-1&&(t[n-1].max=r.max,t.splice(n,1)));if(e===r.max+1)return r.max=e,void(n<i-1&&t[n+1].min===e+1&&(r.max=t[n+1].max,t.splice(n+1,1)));n++}if(e<t[0].min)t.splice(0,0,{min:e,max:e});else if(e>t[i-1].max)t.splice(i,0,{min:e,max:e});else for(var a=0;a<i;a++)if(e<(r=t[a]).min)return void t.splice(a,0,{min:e,max:e})}else t.push({min:e,max:e})}},u.prototype.getAvailableID=function(){var e=this._ranges;if(0===e.length)return 0;var t=e[0];return t.min>0?t.min-1:t.max+1},u.prototype.getTotalNumberOfIDs=function(){var e=this._ranges;return 0===e.length?0:e[e.length-1].max+1},u.prototype.getTotalNumberOfIDsNextPowerOfTwo=function(){return a(this.getTotalNumberOfIDs())},u.prototype.removeID=function(e){var t=this._ranges;if(0!==t.length)for(var i=t.length,r=null,n=0;n<i;n++){if(e===(r=t[n]).min)return void(r.min===r.max?t.splice(n,1):r.min++);if(e===r.max)return void r.max--;if(e>r.min&&e<r.max){var a={min:e+1,max:r.max};return r.max=e-1,void t.splice(n+1,0,a)}}},u.prototype.getNbRanges=function(){return this._ranges.length};var p=function(t,i,r,n){this._LODSags=n,this._nbLODs=this._LODSags.length,this._nbCurvePoints=0===t?2:Math.pow(2,t-1)+1,this._nbCurvePointsPlus2=2+this._nbCurvePoints,this._sag=r,this._isCaps=i,this._LODGeometries=[];for(var a=0;a<this._nbLODs;a++)this._LODGeometries.push(this._buildLODGeometry(this._LODSags[a]));var o=Math.random(),s=Math.random(),h=Math.random();this._debugColor=(new e.Color).setRGB(o,s,h),this._nbUsed=0,this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._realMaps=[],this._curvesMapsProperties=new e.Vector3(128,2,1),this._updateCurvesMapsStatus=c,this._idsRanges=new u,this.materials={}};p.prototype._buildLODGeometry=function(i){var r=new e.BufferGeometryDS;r.sharedBuffers=!0;var n=i,a=this._nbCurvePoints;r.drawingGroups=[];for(var o=this._isCaps?6*(n-2):6*n*(a-1),s=this._isCaps?1:0,c=a*n,h=new Float32Array(3*c),l=0,d=1,u=0;u<a;u++){for(var p=0;p<n;p++)h[l++]=d,h[l++]=p/n*2*Math.PI,h[l++]=s?u>0?1:.5:0;d++}r.vertexPositionArray=h;var _=new Uint16Array(o),m=0;if(this._isCaps){for(p=0;p<n-2;p++)_[m++]=0,_[m++]=p+2,_[m++]=p+1;for(p=0;p<n-2;p++)_[m++]=n,_[m++]=n+p+1,_[m++]=n+p+2}else{var f=0,g=0,x=0,v=0,w=0;for(p=0;p<n;p++)for(u=0;u<a-1;u++)f=(w=u*n)+p,g=w+(p+1)%n,x=w+p+n,v=p===n-1?w+n:(w+p+n+1)%c,_[m++]=f,_[m++]=g,_[m++]=x,_[m++]=g,_[m++]=v,_[m++]=x}r.vertexIndexArray=_;var S=new t.DrawingGroup(null,null,4,0,o);return S._geomType=e.GeomTypeEnum.FACE,S.geometry=r,r.drawingGroups.push(S),r};new e.Vector3;var _=new e.Vector3,m=new e.Vector3;new e.Vector3;p.prototype._addCurvedPipe=function(t,i,r,n,a,o,s){var c=e.InstancedCurvedPipeManager;0===n?_.set(r[n+3]+o.x,r[n+4]+o.y,r[n+5]+o.z):_.set(r[n-3],r[n-2],r[n-1]),a===r.length?m.set(r[a-6]+s.x,r[a-5]+s.y,r[a-4]+s.z):m.set(r[a],r[a+1],r[a+2]);var h=this._idsRanges.getAvailableID();this._idsRanges.addID(h);var l=4*h*(2+this._nbCurvePoints),d=this._updateMapSize();this._curvesData[l++]=_.x,this._curvesData[l++]=_.y,this._curvesData[l++]=_.z,this._curvesData[l++]=n>0?c._compressedSideVectors_tmp[(n-3)/3]:0;for(var u=n;u<a;u+=3)this._curvesData[l++]=r[u],this._curvesData[l++]=r[u+1],this._curvesData[l++]=r[u+2],this._curvesData[l++]=c._compressedSideVectors_tmp[u/3];return this._curvesData[l++]=m.x,this._curvesData[l++]=m.y,this._curvesData[l++]=m.z,this._curvesData[l++]=a<r.length?c._compressedSideVectors_tmp[(a+3)/3]:0,this._updateMapData(d),h},p.prototype._removeCurvedPipe=function(e){if(0!==this._idsRanges.getNbRanges()){this._updateCurvesMapsStatus=h;var t=this._idsRanges.getTotalNumberOfIDs();this._idsRanges.removeID(e),t!==this._idsRanges.getTotalNumberOfIDs()&&(this._updateCurvesMapsStatus=c),this._nbUsed--}},p.prototype._resetMapsInfos=function(){this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._curvesMapsProperties.set(128,2,1)},p.prototype._updateMapSize=function(){var e=this._idsRanges.getTotalNumberOfIDs()*(this._nbCurvePoints+2),t=Math.sqrt(e),i=a(t,128),r=a(e/i,2),n=this._reallocateMap(i,r);return this._curvesMapsProperties.x=i,this._curvesMapsProperties.y=r,n},p.prototype._updateMapData=function(t){this._curvesMaps=[],this._curvesMapsProperties.z=1;var i=this._realMaps[0];i?(i.image.width=this._curvesMapsProperties.x,i.image.height=this._curvesMapsProperties.y,t&&(i.image.data=this._curvesData)):((i=new e.DataTexture(this._curvesData,this._curvesMapsProperties.x,this._curvesMapsProperties.y,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,i.magFilter=e.NearestFilter,i.generateMipmaps=!1,i.flipY=!1,this._realMaps.push(i)),this._curvesMaps.push(i),i.needsUpdate=!0;for(var r=2-this._curvesMaps.length,n=0;n<r;n++)this._curvesMaps.push(o)},p.prototype._reallocateMap=function(e,t){if(e>this._curvesMapsProperties.x||t>this._curvesMapsProperties.y){for(var i=4*this._curvesMapsProperties.x*this._curvesMapsProperties.y,r=new Float32Array(4*e*t),n=0;n<i;n++)r[n]=this._curvesData[n];return this._curvesData=r,!0}return!1},p.prototype._initCurvesMaps=function(e){return!0};var f=function(){this._LODSags=[6,8,10,12,14,16],this._nbLODs=this._LODSags.length,this._instancingGroups=[];for(var t=0;t<33;t++)this._instancingGroups.push(null);this._perRenderableData=new Map,this._geometryToInstancingGroup=new Map,this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties=new e.Vector3,this._matrixRanges=new u,this._matricesMaps=[],this._realMaps=[],this._updateMatricesMapsStatus=c,this._compressedSideVectors_tmp=[],this._capsPoints_tmp=new Array(6),this.pipesToRemove=[],this._debugNbPipes=0,this.debugNbCreatedTextures=0};f.prototype._changeMatricesMapStatus=function(e){this._updateMatricesMapsStatus!==c&&(this._updateMatricesMapsStatus=e)},f.prototype._initMatricesMap=function(){if(this._updateMatricesMapsStatus!==l){if(this._updateMatricesMapsStatus===c){n.init(),this._matricesMaps=[];var t=4*this._matrixRanges.getTotalNumberOfIDs(),i=t-Math.floor(t/n.maxTextureTotalSize)*n.maxTextureTotalSize,r=Math.sqrt(i),s=a(r,128),d=a(i/s,2);this._curvesMatricesProperties.x=s,this._curvesMatricesProperties.y=d;var u=Math.max(1,Math.ceil(t/n.maxTextureTotalSize));this._curvesMatricesProperties.z=u;var p=n.maxTextureTotalSize,_=n.maxTextureSize,m=4*((u-1)*p+s*d);this._matricesFloat32Array=new Float32Array(m),this._matricesFloat32Array.set(this._matricesJSArray,0);for(var f,g=this._matricesFloat32Array,x=0,v=0;v<u-1;v++)(f=this._realMaps[x])?(f.image.width=_,f.image.height=_,f.image.data=g.subarray(v*p*4,(v+1)*p*4)):((f=new e.DataTexture(g.subarray(v*p*4,(v+1)*p*4),_,_,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,f.magFilter=e.NearestFilter,f.generateMipmaps=!1,f.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(f)),this._matricesMaps.push(f),f.needsUpdate=!0,x++;(f=this._realMaps[x])?(f.image.width=s,f.image.height=d,f.image.data=g.subarray((u-1)*p*4,m)):((f=new e.DataTexture(g.subarray((u-1)*p*4,m),s,d,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,f.magFilter=e.NearestFilter,f.generateMipmaps=!1,f.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(f)),this._matricesMaps.push(f),f.needsUpdate=!0;for(var w=2-this._matricesMaps.length,S=0;S<w;S++)this._matricesMaps.push(o);return this._updateMatricesMapsStatus=l,!0}if(this._updateMatricesMapsStatus===h){this._matricesFloat32Array.set(this._matricesJSArray,0);for(var y=this._matricesFloat32Array,b=this._matricesMaps.length,M=0,T=0;T<b;T++){var P=this._matricesMaps[T].image,C=P.width*P.height;M+C>y.length||P.data.set(y.subarray(M,C),0),M+=C,this._matricesMaps[T].needsUpdate=!0}this._updateMatricesMapsStatus=l}}return!1},f.prototype.addCurvedPipe=function(e,t,i,r,n,a,o){var s=this._LODSags[this._LODSags.length-1],l=e.id+"_"+t;this._debugNbPipes++,this.computeCompressedSideVectors(r,o,a);var d=4*this._matrixRanges.getAvailableID(),u=this._perRenderableData.get(l);u||(u=[],this._perRenderableData.set(l,u));for(var _=this._instancingGroups,m=r.length/3,f=m-1,g=1,x=0,v=this._LODSags.length;0!==f;){if(f%2==1){if(!_[g]){_[g]=new p(g,!1,s,this._LODSags);for(var w=0;w<v;w++)this._geometryToInstancingGroup.set(_[g]._LODGeometries[w].id,_[g])}_[g]._nbUsed++;var S=3*(Math.pow(2,g-1)+1),y=_[g]._addCurvedPipe(l,i,r,x,x+S,n,a);u.push({idInMaps:y,matrixId4:d,bin:g}),x+=S-3}g++,f>>=1}if(!_[g=0]){_[g]=new p(g,!0,s,this._LODSags);for(w=0;w<v;w++)this._geometryToInstancingGroup.set(_[g]._LODGeometries[w].id,_[g])}_[g]._nbUsed++;S=6;this._capsPoints_tmp[0]=r[0],this._capsPoints_tmp[1]=r[1],this._capsPoints_tmp[2]=r[2],this._capsPoints_tmp[3]=r[3*(m-1)],this._capsPoints_tmp[4]=r[3*(m-1)+1],this._capsPoints_tmp[5]=r[3*(m-1)+2],this._compressedSideVectors_tmp[1]=this._compressedSideVectors_tmp[m-1];y=_[g]._addCurvedPipe(l,i,this._capsPoints_tmp,0,S,n,a);u.push({idInMaps:y,matrixId4:d,bin:g});var b=this._matricesJSArray,M=e.matrixWorld.elements,T=4*d;b[T]=M[0],b[T+1]=M[1],b[T+2]=M[2],b[T+3]=0,b[T+4]=M[4],b[T+5]=M[5],b[T+6]=M[6],b[T+7]=0,b[T+8]=M[8],b[T+9]=M[9],b[T+10]=M[10],b[T+11]=0,b[T+12]=M[12],b[T+13]=M[13],b[T+14]=M[14],b[T+15]=i,this._matrixRanges.addID(d/4);var P=this._matrixRanges.getTotalNumberOfIDs();!this._matricesFloat32Array||16*P>this._matricesFloat32Array.length?this._changeMatricesMapStatus(c):this._changeMatricesMapStatus(h)},f.prototype.addLinkedCurvedPipe=function(e,t){for(var i=0;i<t.geometry.drawingGroups.length;i++){var r=this._perRenderableData.get(t.id+"_"+i);r&&this._perRenderableData.set(e.id+"_"+i,r)}},f.prototype.removeCurvedPipe=function(e,t){e&&this.pipesToRemove.push(e);for(var i=[],r=0;r<this.pipesToRemove.length;r++){var n=this.pipesToRemove[r];if(0===Object.keys(n._tokens).length){this._debugNbPipes-=t._pipes.length;for(var a=0;a<n.geometry.drawingGroups.length;a++){var o=n.id+"_"+a,s=this._perRenderableData.get(o);s&&this._removeCurvedPipe(s,o)}n._flagAsGSSOInvalidated()}else i.push(n)}this.pipesToRemove=i},f.prototype._removeCurvedPipe=function(e,t){for(var i=this._instancingGroups,r=this._matrixRanges.getTotalNumberOfIDs(),n=e.length,a=this._nbLODs,o=0;o<n;o++){var s=e[o],l=s.bin;if(i[l]&&(i[l]._removeCurvedPipe(s.idInMaps),0===i[l]._nbUsed)){for(var d=0;d<a;d++)this._geometryToInstancingGroup.delete(i[l]._LODGeometries[d].id);i[l]=null}this._matrixRanges.removeID(s.matrixId4/4)}if(this._perRenderableData.delete(t),this._changeMatricesMapStatus(h),0!==this._matrixRanges.getNbRanges()){var u=this._matrixRanges.getTotalNumberOfIDs();r!==u&&(this._changeMatricesMapStatus(c),this.resetMapsInfos()),this._matricesJSArray.length=16*u}},f.prototype.resetMapsInfos=function(){this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties.set(0,0,0),this._matricesMaps=[]},f.prototype.computeCompressedSideVectors=function(t,i,r){var n=0,a=(new e.Vector3).copy(i),o=s(a);this._compressedSideVectors_tmp[n++]=o;for(var c=new e.Vector3,h=new e.Vector3,l=new e.Vector3,d=new e.Vector3,u=t.length/3,p=1;p<u;p++){p===u-1?c.copy(r).normalize():(l.set(t[3*(p-1)],t[3*(p-1)+1],t[3*(p-1)+2]),d.set(t[3*(p+1)],t[3*(p+1)+1],t[3*(p+1)+2]),c.subVectors(d,l).normalize());var _=a.dot(c);c.multiplyScalar(_),h.subVectors(a,c).normalize(),this._compressedSideVectors_tmp[n++]=s(h),a=h}};e.glStates;return f.prototype.setMatrixOnCurvedPipe=function(e){for(var t=0;t<e.geometry.drawingGroups.length;t++){var i=e.id+"_"+t,r=this._perRenderableData.get(i);r&&this._setMatrixOnCurvedPipe(r,e)}},f.prototype._setMatrixOnCurvedPipe=function(e,t){var i=e[0].matrixId4,r=this._matricesJSArray,n=t.matrixWorld.elements,a=4*i;r[a]=n[0],r[a+1]=n[1],r[a+2]=n[2],r[a+4]=n[4],r[a+5]=n[5],r[a+6]=n[6],r[a+8]=n[8],r[a+9]=n[9],r[a+10]=n[10],r[a+12]=n[12],r[a+13]=n[13],r[a+14]=n[14],this._changeMatricesMapStatus(h)},f.prototype.setPDSFXParamsOnMaterial=function(e){e.activatePDSFX(),e.setPDSFXGlobalShaderCode(d._VSGlobal,"");var t={curvesMaps:{type:"t2v",value:null,length:2},curvesMapsProperties:{type:"v3",value:null},curvesMatrices:{type:"t2v",value:null,length:2},curvesMatricesProperties:{type:"v3",value:null}};e.setPDSFXUniforms(t);e.setPDSFXVaryings({debugColor:{type:"v3"}}),e.setPDSFXVaryings,e.setPDSFXAttributes({specialMeshIds:{type:"v2",instancing:!0},specialMeshPicking:{type:"v3",instancing:!0}}),e.setPDSFXOverridableFunctions(d._VSOverridables,{})},e.InstancedCurvedPipeManager=new f,e.InstancedCurvedPipeManager})),define("SceneGraphNodes/InstancedCurvedPipeManager",["DS/SceneGraphNodes/InstancedCurvedPipeManager","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/InstancedCurvedPipeManager"),e})),define("DS/SceneGraphNodes/DiskLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.DiskLight(t.color,t.intensity,t.radius,t.mode);return this._radius=r.radius,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DiskLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DiskLightNode",i)})),define("SceneGraphNodes/DiskLightNode",["DS/SceneGraphNodes/DiskLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/DiskLightNode"),e})),define("DS/SceneGraphNodes/InstancedCylinderImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedCylinderImpostorsNode","DS/DSMigration/DSMigration"],(function(e,t){return e})),define("DS/SceneGraphNodes/CSS3DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i,r){this._parent(r),this.scale=i||1,this.css3DNode=new e.CSS3DNode(t);var n=this.createRenderable(),a=t.style.width;a=a.substring(0,a.length-2);var o=t.style.height;o=o.substring(0,o.length-2);var s=.5*i*Math.sqrt(a*a+o*o);this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),s),this.explicitBBox=null,n.matrixAutoUpdate=!1,n.visible=this.css3DNode.visible;var c=this._occurrences[0];return c.renderable=n,c.renderable.name=this.name,c.renderable._occurrence=c,c.renderable.scaleCSS=(new e.Matrix4).scale(new e.Vector3(this.scale,this.scale,this.scale)),document.getElementById("camera")&&document.getElementById("camera").appendChild(this.css3DNode.element),this},createRenderable:function(){var t=new e.CSS3DNode(this.css3DNode.element);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!0,t.visible=this.css3DNode.visible,t},setPickability:function(e){this.css3DNode.element.style.pointerEvents=e?"auto":"none"},add:function(){return!1},getNodeType:function(){return"CSS3DNode"},clone:function(){var t=new e.CSS3DNode(this.css3DNode.element);return new THREEDS.Nodes.CSS3DNode(t.element,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS3DNode",i)})),define("SceneGraphNodes/CSS3DNode",["DS/SceneGraphNodes/CSS3DNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/CSS3DNode"),e})),define("DS/SceneGraphNodes/DirectionalLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});let r=null;return r=t.light?t.light:new e.DirectionalLight(t.color,t.intensity),r._sceneShadow=null==t.sceneShadow||t.sceneShadow,t.target?(r.target=new e.Object3D,r.target.position=t.target,r._sceneShadow=t.sceneShadow):r.target=null,this._previousTarget=r.target,this._direction=null,this._parent(r,i,null),this},setShadowOptions:function(e){if(e){var t=this._occurrences.length,i=!1,r=null!=e.sceneShadow?e.sceneShadow:this.light3js._sceneShadow;e.bias&&(this.light3js.shadowBias=e.bias),e.left&&(this.light3js.shadowCameraLeft=e.left,r=!1),e.right&&(this.light3js.shadowCameraRight=e.right,r=!1),e.bottom&&(this.light3js.shadowCameraBottom=e.bottom,r=!1),e.top&&(this.light3js.shadowCameraTop=e.top,r=!1),e.near&&(this.light3js.shadowCameraNear=e.near,r=!1),e.far&&(this.light3js.shadowCameraFar=e.far,r=!1),e.darkness&&(this.light3js.shadowDarkness=e.darkness),e.mapWidth&&(this.light3js.shadowMapWidth=e.mapWidth,i=!0),e.mapHeight&&(this.light3js.shadowMapHeight=e.mapHeight,i=!0),this.light3js._sceneShadow=r,this.light3js.shadowMap&&i&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0);for(var n=0;n<t;n++){var a=this._occurrences[n].renderable;if(e){i=!1;e.bias&&(a.shadowBias=e.bias),e.left&&(a.shadowCameraLeft=e.left),e.right&&(a.shadowCameraRight=e.right),e.bottom&&(a.shadowCameraBottom=e.bottom),e.top&&(a.shadowCameraTop=e.top),e.near&&(a.shadowCameraNear=e.near),e.far&&(a.shadowCameraFar=e.far),e.darkness&&(a.shadowDarkness=e.darkness),e.mapWidth&&(a.shadowMapWidth=e.mapWidth,i=!0),e.mapHeight&&(a.shadowMapHeight=e.mapHeight,i=!0),a._sceneShadow=this.light3js._sceneShadow,a.shadowMap&&i&&(a.shadowMap.dispose(),a.shadowMap=null,a.updateShadowMap=!0)}}}},castShadows:function(e,t){var i=this._occurrences.length;if(e){this.light3js.castShadow=!0;for(var r=0;r<i;r++)this._occurrences[r].renderable.castShadow=!0,this.setShadowOptions(t)}else{this.light3js.castShadow=!1;for(r=0;r<i;r++)this._occurrences[r].renderable.castShadow=!1}},_castGroundShadows:function(e){this.light3js.castGroundShadow=e,this.light3js.onlyShadow=!0;for(var t=0;t<this._occurrences.length;t++)this._occurrences[t].renderable.castGroundShadow=e,this._occurrences[t].renderable.onlyShadow=!0},attachToViewpoint:function(e){if(this._attachedToVpt!=e){var t=this._occurrences.length;if(e){this.light3js.target=null;for(i=0;i<t;i++)this._occurrences[i].renderable.target=null}else{this.light3js.target=this._previousTarget;for(var i=0;i<t;i++)this._occurrences[i].renderable.target=this._previousTarget}}this._attachedToVpt=e},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var r=this._occurrences.length,n=0;n<r;n++)this._occurrences[n].renderable.target=i},setDirection:function(t,i){i=i||new e.Vector3(0,0,1);let r=(new e.Vector3).crossVectors(t,i);r.normalize();let n=t.angleTo(i),a=(new e.Matrix3).makeRotationAxis(r,n),o=this.getMatrix(),s=o.clone();s.setRotation(a.elements),s.equals(o)||this.setMatrix(s)},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DirectionalLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DirectionalLight",i)})),define("SceneGraphNodes/DirectionalLightNode",["DS/SceneGraphNodes/DirectionalLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/DirectionalLightNode"),e})),define("DS/SceneGraphNodes/PolyLineSectionUtils",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t={makeClosedPolyLine:function(t,i,r){var n=new e.Vector3;n.subVectors(i.center,t.planeOrigin);var o,s,c=new e.Vector2(n.dot(t.planeU),n.dot(t.planeV)),h={xmin:c.x-i.radius,ymin:c.y-i.radius,xmax:c.x+i.radius,ymax:c.y+i.radius};for(o=0;o<t.polyLinePoints.length;o++)(s=t.polyLinePoints[o]).x<h.xmin&&(h.xmin=s.x),s.x>h.xmax&&(h.xmax=s.x),s.y<h.ymin&&(h.ymin=s.y),s.y>h.ymax&&(h.ymax=s.y);return new a(h,t,r).buildPolyLine()},computePolyLineOrientation:function(e){let t,i=-1/0,r=0;if(e.length<3)return 1;for(t=0;t<e.length;t++){let n=e[t];n>i&&(r=t,i=n)}let n=(r+e.length-1)%e.length,a=r,o=(r+1)%e.length,s=e[n].x,c=e[n].y,h=e[a].x,l=e[a].y,d=e[o].x,u=e[o].y;return h*u+s*l+c*d-(c*h+l*d+s*u)<=0?1:-1}};function i(t,i,r,n){var a=new e.Vector2;a.subVectors(i,t);var o=new e.Vector2;return o.subVectors(r,n),function(t,i,r,n){var a=i.y,o=-i.x,s=i.x*t.y-i.y*t.x,c=n.y,h=-n.x,l=n.x*r.y-n.y*r.x,d=a*h-o*c;if(0===d)return null;var u=(o*l-s*h)/d,p=-(a*l-s*c)/d;return new e.Vector2(u,p)}(t,a,r,o)}function r(t,i,r){var n=new e.Vector2;n.subVectors(i,t);var a=new e.Vector2;return a.subVectors(r,t),n.dot(a)>=0}function n(t,i,r){var n=new e.Vector2;n.subVectors(i,t);var a=new e.Vector2;a.subVectors(r,t);var o=n.dot(a),s=n.lengthSq();return o>=0||o<=s}var a=function(t,i,r){this.bounds=t,this.points=[],this.normalExtrapolation=r,this.center=new e.Vector2((this.bounds.xmin+this.bounds.xmax)/2,(this.bounds.ymin+this.bounds.ymax)/2),this.polyLine=i;var n,a=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin)];for(n=0;n<a.length;n++)this.addPoint(a[n],"corner")};return a.prototype.addPointFromLine=function(t,a,o,s,c){var h=t,l=a;s&&(h=a,l=new e.Vector2(a.x+c*(t.y-a.y),a.y-c*(t.x-a.x)));var d,u=!1,p=null,_=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymin)];for(d=0;d<_.length-1&&!u;d++)(p=i(h,l,_[d],_[d+1]))&&r(h,l,p)&&n(_[d],_[d+1],p)&&(this.addPoint(p,o),u=!0)},a.prototype.addPoint=function(t,i){var r,n,a,o=new e.Vector2;o.subVectors(t,this.center),o.normalize();var s={point:t,angle:r=(o.y>=0?-1:1)*Math.acos(o.x),tag:i};for(n=0;n<this.points.length&&!a;n++)this.points[n].angle<r&&(this.points.splice(n,0,s),a=!0);a||this.points.push(s)},a.prototype.buildPolyLine=function(){var t=this.polyLine;this.addPointFromLine(new e.Vector2(t.polyLinePoints[1].x,t.polyLinePoints[1].y),new e.Vector2(t.polyLinePoints[0].x,t.polyLinePoints[0].y),"start",this.normalExtrapolation,-1);var i=t.polyLinePoints.length;this.addPointFromLine(new e.Vector2(t.polyLinePoints[i-2].x,t.polyLinePoints[i-2].y),new e.Vector2(t.polyLinePoints[i-1].x,t.polyLinePoints[i-1].y),"end",this.normalExtrapolation,1);var r,n=-1,a=-1;for(r=0;r<this.points.length&&(n<0||a<0);r++)"start"===this.points[r].tag&&(n=r),"end"===this.points[r].tag&&(a=r);if(n<0||a<0)return null;var o={polyLinePoints:[],planeOrigin:t.planeOrigin,planeU:t.planeU,planeV:t.planeV};o.polyLinePoints.push(this.points[n].point);var s=this.normalExtrapolation?0:1;for(r=s;r<t.polyLinePoints.length-s;r++)o.polyLinePoints.push(new e.Vector2(t.polyLinePoints[r].x,t.polyLinePoints[r].y));o.polyLinePoints.push(this.points[a].point);var c=n<a?n+this.points.length:n;for(r=a+1;r<c;r++)o.polyLinePoints.push(this.points[r%this.points.length].point);return o},UWA.namespace("THREEDS/Nodes/PolyLineSectionUtils",t)})),define("DS/SceneGraphNodes/PointLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});var r=t.intensity;void 0===r&&(r=t.power?t.power/(4*Math.PI):1);var n=new e.PointLight(t.color,r,t.distance);return t.physicalAttenuation&&(n.isPhysicallyAttenuated=!0,n.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(n,i,null),this},setPower:function(e){var t=e/(4*Math.PI);this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,t){var r=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,r=!0),this.light3js.shadowMap&&r&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var n=0;n<i;n++){var a=this._occurrences[n].renderable;if(a.castShadow=!0,t){r=!1;t.bias&&(a.shadowBias=t.bias),t.near&&(a.shadowCameraNear=t.near),t.far&&(a.shadowCameraFar=t.far),t.darkness&&(a.shadowDarkness=t.darkness),t.mapWidth&&(a.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(a.shadowMapHeight=t.mapHeight,r=!0),a.shadowMap&&r&&(a.shadowMap.dispose(),a.shadowMap=null,a.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(n=0;n<i;n++)this._occurrences[n].renderable.castShadow=!1}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"PointLightNode3D"}});return UWA.namespace("THREEDS/Nodes/PointLight",i)})),define("SceneGraphNodes/PointLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/PointLightNode"),e})),define("DS/SceneGraphNodes/VoxelVolumeNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],(function(e,t){"use strict";return t.extend({init:function(e,t){return this._parent(t),this.debugMode=!0,e&&this.build(e),this},add:function(){return!1},_nextPowerOf2:function(e,t){for(var i=t||1;i<e;)i*=2;return i},build:function(t){var i,r,n=t.voxelRep,a=(performance.now(),[n.width,n.height,n.depth]),o=new e.Vector3(a[0],a[1],a[2]),s=Math.max(o.x,Math.max(o.y,o.z)),c=this._nextPowerOf2(s,4),h=this._nextPowerOf2(Math.ceil(Math.sqrt(c))),l=c*h,d=null,u=n.bufferData,p=a[0]*a[1]*a[2],_=p%8?Math.floor(p/8)+1:p/8,m=_+(4-_%4)%4;i=(r=new Uint8Array(u.buffer,u.byteOffset+m))[0];var f=0,g=null;if(this.debugMode){g=new Uint32Array(256);for(var x=0;x<256;x++)g[x]=0}d=new Uint8Array(l*l);for(var x=0;x<l*l;x++)d[x]=i;var v=0,w=0,S=0,y=0,b=0,M=[1,2,4,8,16,32,64,128],T=i>0?i:Number.MAX_SAFE_INTEGER,P=i>0?i:0;for(x=0;x<_/4;x++)for(var C=3;C>=0;C--)for(var D=u[4*x+C],V=7;V>=0;V--){if(D&M[V]){var N=r[1+b++],A=(Math.floor(S/h)*c+w)*c*h+S%h*c+v;d[A]=N,N>0&&(N<T&&(T=N),N>P&&(P=N)),this.debugMode&&(g[N]++,f++)}if(++y>=p)break;++v>=a[0]&&(v=0,++w>=a[1]&&(w=0,S++))}this.debugMode&&(g[i]+=a[0]*a[1]*a[2]-f),this.volumeData={tileSetRange:{min:0,max:1},valueRange:{min:T/255,max:P/255},voxelRepartition:g,mapData:{type:"uint8",data:d,width:l,height:l},chunkSize:c,nbCol:h,mapDim:o,_voxelDensity:0}},getNodeType:function(){return"VoxelVolumeNode"}})})),define("DS/SceneGraphNodes/CanvasNodeTexture",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],(function(e,t,i,r){"use strict";var n=["map","transparent","alphaTest","force","canvasNodeTextureSize","canvasNodeTextureSaveParams"],a=!0,o=t.extend({init:function(e){this.width=e.width,this.height=e.height,this.longestEdge=this.width>=this.height?"width":"height",this.maxZoom=e.maxZoom||null,this.maxPow=this.maxZoom?Math.floor(Math.log(this.maxZoom)/Math.log(2)):null,this.drawCB=e.drawCB,this.rectangleTexture=e.rectangleTexture||!1,this.viewer=e.webGLV6Viewer,this.alphaTest=e.alphaTest,this.depthWrite=e.depthWrite,this.tick=0,this.materials={},this.lastTexture=null,this._canvas2DTexture=null,this._canvas2DCanvas=null,this.setMaterialParams(e.materialParams)},setMaterialParams:function(e){var t;for(t in this.materialParams=e||{},this.materials)this._updateMaterialWithParams(this.materials[t].material,this.materialParams)},requestRedraw:function(){this._requestRedraw()},_updateMaterialWithParams:function(e,t){var i;if(e.canvasNodeTextureSaveParams)for(i in e.canvasNodeTextureSaveParams)e[i]=e.canvasNodeTextureSaveParams[i];for(i in t)-1===n.indexOf(i)&&(e.canvasNodeTextureSaveParams||(e.canvasNodeTextureSaveParams={}),e.canvasNodeTextureSaveParams[i]=e[i],e[i]=t[i])},startAnimation:function(e,t){this.animationDeltaTime=e,this.tick=-1,this._animationStep(t)},_animationStep:function(e){this.tick++,this.requestRedraw(),e&&e.render(),setTimeout(this._animationStep.bind(this,e),this.animationDeltaTime)},_requestRedraw:function(){var e;for(e in this.materials)this.materials[e].redrawRequested=!0;this._canvas2DTexture&&(this._canvas2DTexture.redrawRequested=!0)},_getCanvas2DTexture:function(){if(!this._canvas2DTexture){var t=document.createElement("canvas");t.width=this.width,t.height=this.height,this._canvas2DTexture=new e.Texture(t,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this._canvas2DCanvas=t,this._redrawCanvas2DTexture()}return this._canvas2DTexture},_redrawCanvas2DTexture:function(){this._drawToCanvas(this._canvas2DCanvas,this.width,this.height),this._canvas2DTexture.needsUpdate=!0,this._canvas2DTexture.redrawRequested=!1},_buildMaterial:function(t,i,r,n){var a={};return a.canvas=document.createElement("canvas"),a.canvas.width=i,a.canvas.height=r,o.totalAllocatedTextures+=a.canvas.width*a.canvas.height,a.useCount=0,this._drawToCanvas(a.canvas,i,r),a.texture=new e.Texture(a.canvas,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter),a.texture.anisotropy=16,a.texture.needsUpdate=!0,n?(n.setMap(a.texture),a.material=n):a.material=new e.MeshBasicMaterial({transparent:!0,force:!0,map:a.texture}),void 0!==this.alphaTest&&(a.material.alphaTest=this.alphaTest),void 0!==this.depthWrite&&(a.material.depthWrite=this.depthWrite),a.material.canvasNodeTextureSize=t,this._updateMaterialWithParams(a.material,this.materialParams),a.redrawRequested=!1,a},_drawToCanvas:function(e,t,i){var r=e.getContext("2d");r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,t,i),r.globalAlpha=1;var n=Math.max(t,i)/Math.max(this.width,this.height);r.scale(n,n);var a=null;this.viewer&&this.viewer.renderer&&this.viewer.renderer.renderer&&(a=this.viewer.renderer.renderer),this.drawCB(this,r,this.tick,n,a)},_getNewMaterial:function(e,t){var i=t&&t.canvasNodeTextureSize?t:null,r=e,n=11;null!==this.maxPow&&(n=this.maxPow);var s=.01024;if(this.rectangleTexture&&(r=e/this[this.longestEdge],null===this.maxPow)){var c=Math.ceil(Math.log(this[this.longestEdge])/Math.log(2)+s);n=Math.max(0,n-c)}var h=Math.ceil(Math.log(r)/Math.log(2)+s);h=Math.min(h,n);var l=Math.pow(2,h),d=this.rectangleTexture?Math.floor(l*this.width):l,u=this.rectangleTexture?Math.floor(l*this.height):l;0!==d&&0!==u||(d=16,u=16);var p=i?this.materials[i.canvasNodeTextureSize]:null,_=p?p.canvas.width:0,m=p?p.canvas.height:0;!this.materials[l]&&o.totalAllocatedTextures+d*u-_*m>o.maxAllocatedTextures&&(a&&console.warn("CanvasNodeTexture: max amount of allowed texture allocation has been exceeded"),p?(l=i.canvasNodeTextureSize,d=p.canvas.width,u=p.canvas.height):(l=this.rectangleTexture?1:512,d=this.rectangleTexture?this.width:l,u=this.rectangleTexture?this.height:l));var f,g=this.materials[l];return i&&i.canvasNodeTextureSize===l||(i&&(f=this._releaseMaterial(i)),g||(this.materials[l]=this._buildMaterial(l,d,u,f),g=this.materials[l]),g.useCount++,f&&g.material!==f&&f.dispose()),g&&g.redrawRequested&&(this._drawToCanvas(g.canvas,d,u),g.texture.needsUpdate=!0,g.redrawRequested=!1),g?g.material:null},_releaseMaterial:function(e){if(e.canvasNodeTextureSize){var t=e?this.materials[e.canvasNodeTextureSize]:null;if(t)if(t.useCount--,t.useCount<=0)return o.totalAllocatedTextures-=t.canvas.width*t.canvas.height,(e=this.materials[e.canvasNodeTextureSize].material).map&&(e.map.dispose(),e.map=null),delete this.materials[e.canvasNodeTextureSize],e}return null}});return o.totalAllocatedTextures=0,o.maxAllocatedTextures=16777216,o.enableMemoryWarning=function(e){a=e},o})),define("DS/SceneGraphNodes/Canvas2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],(function(e,t,i,r){"use strict";var n=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture;var r=this.canvasNodeTexture._getCanvas2DTexture(),a=new e.MeshBasicMaterial({transparent:!0,side:e.DoubleSide,force:!0});this.canvas2DMaterial=a,a.activatePDSFX("PDSFXCanvas2D");var o={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},canvas2DTexture:{type:"t2",value:r},highlight:{type:"i",value:0,stage:e.FragmentStage},angle:{type:"f",value:t.angle||0},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};a.setPDSFXUniforms(o);a.setPDSFXVaryings({_uv:{type:"v2"}});a.setPDSFXOverridableFunctions({ProcessClipSpacePosition:function(e,t){const i=e.variableHandler,r=t=>e.getUniform(t),n=e=>i.float(e),a=i.dereference(t[0]);return`\n                            ${o="_uv",e.getVarying(o)} = ${e.vGetAttribTexCoord0()}.xy;\n                            ${n("dx")} = ${a}.w * (${r("pixelSize")}.x*(-${r("hotspot")}.x + _uv.x*${r("size")}.x));\n                            ${n("dy")} = ${a}.w * (${r("pixelSize")}.y*(-${r("hotspot")}.y + _uv.y*${r("size")}.y));\n                            ${n("ratio")} = ${r("pixelSize")}.x / ${r("pixelSize")}.y;\n                            ${n("_angle")} = ${r("angle")};\n                            ${a}.x += cos(_angle)*dx - sin(_angle)*dy*ratio;\n                            ${a}.y += sin(_angle)*dx/ratio + cos(_angle)*dy;\n                        `;var o}},{ProcessFinalColor:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions,n=e=>i.vec3(e),a=i.dereference(t[0]);return`\n                            ${a} = ${r.sample2DTexture((o="canvas2DTexture",e.getTextureUniform(o)),(t=>e.getVarying(t))("_uv"))};\n                            if (${(t=>e.getUniform(t))("highlight")} != 0) {\n                                ${n("norm")} = length(${a}.xyz)*${n()}(0.0, 0.6, 1.0)/1.73205;\n                                ${a}.x *= norm.x;\n                                ${a}.y *= norm.y;\n                                ${a}.z *= norm.z;\n                            }\n                        `;var o},ComputeDiscard:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions;return`\n                            ${n="color",i.vec4(n)} = ${r.sample2DTexture((t=>e.getTextureUniform(t))("canvas2DTexture"),(t=>e.getVarying(t))("_uv"))};\n                            return color.a <= ${(t=>e.getUniform(t))("alphaTest")};\n                        `;var n},ComputeViewNormal:function(e,t){return`\n                            return ${e.variableHandler.vec3(i)}(0.0, 0.0, 1.0);\n                        `;var i}}),this.rectangle=n._createRectangle(a,i),this.rectangle.setPrimitivePicking(!1);this.rectangle._occurrences[0].renderable;a._refreshPDSFXUniforms_private=function(t,i){var r;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)r=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var n=2*t._gpuPickingTolerance+1;r=new e.Vector2(2/n,2/n)}this.updatePDSFXUniform("pixelSize",r)},this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),this.exludeFromBounding(!0);var s=this;return this.rectangle._setBeforeRenderCB((function(e,t){r.redrawRequested&&s.canvasNodeTexture._redrawCanvas2DTexture()})),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setHotspot:function(e){e&&this.canvas2DMaterial.updatePDSFXUniform("hotspot",e.clone())},getHotspot:function(){return this.canvas2DMaterial.getPDSFXUniform("hotspot").value.clone()},setAngle:function(e){this.canvas2DMaterial.updatePDSFXUniform("angle",e)},getAngle:function(){return this.canvas2DMaterial.getPDSFXUniform("angle").value}});return n._createRectangle=function(e,t){var i,n,a,o,s,c,h,l,d,u,p,_,m,f,g;for(10,(i=new r.PrimitiveGroup).fillAttr=new r.FillAttributes,i.lineAttr=new r.LineAttributes,i.pointAttr=new r.PointAttributes,(n=new r.Buffer).size=12,n.component=r.VertexComponentEnum.POSITION,n.format=r.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(a=new r.Buffer).size=3,a.component=r.VertexComponentEnum.NORMAL,a.format=r.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(o=new r.Buffer).size=12,o.component=r.VertexComponentEnum.TEX_COORD_0,o.format=r.DataTypeEnum.FLOAT,o.dimension=3,o.data=new Float32Array(o.size),(s=new r.Buffer).indexBuffer=!0,s.size=4,s.format=r.DataTypeEnum.UINT,s.dimension=1,s.data=new Uint16Array(s.size),(c=new r.Buffer).indexBuffer=!0,c.size=4,c.format=r.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(c.size),(h=new r.Buffer).indexBuffer=!0,h.size=4,h.format=r.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(h.size),i.addBuffer(0,n),i.addBuffer(1,a),i.addBuffer(2,s),i.addBuffer(3,c),i.addBuffer(4,o),i.addBuffer(5,h),m=0,(g=s.data)[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2,g=c.data,m=0,f=0;f<1;f++)g[m++]=f,g[m++]=f,g[m++]=f,g[m++]=f;for(m=0,(g=h.data)[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2,g=n.data,m=0,m=0;m<12;m++)g[m]=0;for(m=0,(g=a.data)[m++]=0,g[m++]=0,g[m++]=1,m=0,(g=o.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,f=0;f<1;f++)(l=new r.Primitive).nbIndices=4,l.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,l.attr={fill:new r.FillAttributes(new r.Color(1-f/6,0,f/6,1),1),line:new r.LineAttributes,point:new r.PointAttributes},(d=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,d.nbVertices=4,d.nbValuesPerVertex=3,d.format=r.DataTypeEnum.FLOAT,d.cardinality=0,d.bufferId=0,d.indices=new r.IndexArray,d.indices.format=r.DataTypeEnum.UINT,d.indices.bufferId=2,d.indices.offset=4*f,(u=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=r.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=1,u.indices=new r.IndexArray,u.indices.format=r.DataTypeEnum.UINT,u.indices.bufferId=3,u.indices.offset=4*f,(p=new r.VertexComponent).component=r.VertexComponentEnum.TEX_COORD_0,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=r.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=4,p.indices=new r.IndexArray,p.indices.format=r.DataTypeEnum.UINT,p.indices.bufferId=5,p.indices.offset=0,l.addVertexComponent(d),l.addVertexComponent(u),l.addVertexComponent(p),i.addPrimitive(l);return(_=t.createMeshNode(i,e)).setShadow(!1),_},UWA.namespace("THREEDS/Nodes/Canvas2DNode",n)})),define("DS/SceneGraphNodes/FixedSizeNodeA2X",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],(function(e,t,i){"use strict";const r=new e.Vector3,n=new e.Matrix4,a=new e.Matrix4,o=e.__visibleInCurrentSpace;class s extends t{constructor(i){super(i.name),this.cameraName=i.cameraName||"camera",this._isDynamic=!0,this._autoUpdate=!0,this.invariantPoint=i.invariantPoint||null,this.ratio=i.ratio&&0!==i.ratio?i.ratio:1,this.scaleFactor=1,this.scaleFactorPerOcc=[],this._localMatrix=new e.Matrix4,this.is2D=!0===i.is2D||!1,this.mutablePositionMatrix=this.is2D&&!0===i.mutablePositionMatrix||!1;let r=this;const n=e.NoOccurrences;this.cbChange=function(e){if(!n)if(r.isInstance())for(let i=0;i<r._occurrences.length;i++){const n=r._occurrences[i],a=n.parent;if(!n.scene3js||!a)continue;let s=n.scene3js.viewer;if(o(n._getVisible(),n._getVisibilityFree(),s.getVisibleSpace(),null,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;let o=s.currentViewpoint;if(e){if(!e.viewpoint)return;if((s._viewpointManager.getViewpointScenegraph(e.viewpoint)||s.internalSceneGraph).root3js!=n.scene3js)return}o=n._getViewpoint()||o;const c=r._getDynamicMatrix(a.matrix,e,o,i);n.matrix.multiplyMatrices(a.matrix,c);for(let e=0;e<n.children.length;e++)r._updateOccurrences(n,n.children[e],t.UpdateMatrixMode.Always,!0,t.InvalidateGSSOMode.Always)}}else{const i=r.parents[0];if(!i)return;const n=this._occurrences[0];if(!n.scene3js)return;const a=n.scene3js.viewer;if(o(n._getVisible(),n._getVisibilityFree(),a.getVisibleSpace(),null,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&a!==e.viewpoint.viewer)return;let o=a.currentViewpoint;if(e){if(!e.viewpoint)return;if((a._viewpointManager.getViewpointScenegraph(e.viewpoint)||a.internalSceneGraph).root3js!=n.scene3js)return}o=n._getViewpoint()||o;const s=r._getDynamicMatrix(i.getMatrixWorld(),e,o,0);t.prototype.setMatrix.call(r,s,!0)}}},this.tokenChange=null}_linkingClone(e){return e=e||new s({name:this.name,cameraName:this.cameraName,invariantPoint:this.invariantPoint,ratio:this.ratio,is2D:this.is2D}),t.prototype._linkingClone.call(this,e),e}setRatio(e){e!==this.ratio&&this._invalidateBoundingElements(),this.ratio=e&&0!==e?e:1,this._matrix=null,this.cbChange()}setMutablePositionMatrix(e){this.mutablePositionMatrix=e,this._matrix=null,this.cbChange()}getRatio(){return this.ratio}setInvariantPoint(e){this.invariantPoint=e,this._matrix=null,this.cbChange()}getInvariantPoint(){return this.invariantPoint}getScaleFactor(e){return e>=0?this.scaleFactorPerOcc[e]:this.scaleFactor}isPointOfViewDependant(){return!0}_onLinkedToSceneGraph(){this.tokenChange=i.subscribe({event:"/VISU/"},(e=>{this._autoUpdate&&"@onViewpointChange"===e.eventType&&this.cbChange(e)}))}_onUnlinkedToSceneGraph(){i.unsubscribe(this.tokenChange)}_getDynamicMatrix(t,i,o,s){t||(n.identity(),t=n);var c=o||i.viewpoint,h=c[this.cameraName];a.multiplyMatrices(t,this._localMatrix);var l=a.getMaxScaleOnAxis();if(this.invariantPoint)r.copy(this.invariantPoint),r.applyMatrix4(this._localMatrix);else if(this.mutablePositionMatrix){let e=this.getBoundingSphere();this._invalidateBoundingElements(!1),r.copy(e.center)}else r.getPositionFromMatrix(a);var d=l/h.getWorldSizeFromPixelSize(1,r,c.viewer._getDivClientHeight(),1);this.scaleFactor=0!==d?this.ratio/d:1,this.scaleFactorPerOcc[s||0]=this.scaleFactor,n.makeScale(this.scaleFactor,this.scaleFactor,this.scaleFactor);let u=new e.Vector3;if(this.invariantPoint){u.copy(this.invariantPoint),this.is2D?u.multiplyScalar(-this.scaleFactor):u.multiplyScalar(1-this.scaleFactor),u.applyMatrix4(this._localMatrix),n.setPosition(u);let t=(new e.Matrix4).extractRotation(this._localMatrix);n.multiply(t)}else n.multiplyMatrices(this._localMatrix,n);return n}setCameraName(e){this.cameraName=e||"camera"}setMatrix(e,t){this._localMatrix=e,this.cbChange(),this._updateMatrix(t)}}return s})),define("DS/SceneGraphNodes/ProjectionNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],(function(e,t,i){"use strict";let r=e.__visibleInCurrentSpace;class n extends t{constructor(i){super(i.name),this._isDynamic=!0,this.fromLeftRatio=void 0!==i.leftRatio?i.leftRatio:.5,this.fromTopRatio=void 0!==i.topRatio?i.topRatio:.5,this.onScreenScale=void 0!==i.scale?i.scale:0;let n=this;const a=e.NoOccurrences;this.cbChange=function(e){if(!a)if(n.isInstance())for(let i=0;i<n._occurrences.length;i++){const a=n._occurrences[i],o=a.parent;if(!a.scene3js||!o)continue;let s=a.scene3js.viewer;if(r(a._getVisible(),a._getVisibilityFree(),s.getVisibleSpace(),null,a)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;let r=s.currentViewpoint;if(e){if(!e.viewpoint)return;if((s._viewpointManager.getViewpointScenegraph(e.viewpoint)||s.internalSceneGraph).root3js!=a.scene3js)return}r=a._getViewpoint()||r;const c=n._getDynamicMatrix(o.matrix,e,r,i);a.matrix.multiplyMatrices(o.matrix,c);for(let e=0;e<a.children.length;e++)n._updateOccurrences(a,a.children[e],t.UpdateMatrixMode.Always,!0,t.InvalidateGSSOMode.Always)}}else{const t=n.parents[0];if(!t)return;const i=this._occurrences[0];if(!i.scene3js)return;const a=i.scene3js.viewer;if(r(i._getVisible(),i._getVisibilityFree(),a.getVisibleSpace(),null,i)){if(e&&e.viewpoint&&e.viewpoint.viewer&&a!==e.viewpoint.viewer)return;let r=a.currentViewpoint;if(e){if(!e.viewpoint)return;if((a._viewpointManager.getViewpointScenegraph(e.viewpoint)||a.internalSceneGraph).root3js!=i.scene3js)return}r=i._getViewpoint()||r;const o=n._getDynamicMatrix(t.getMatrixWorld(),e,r,0);n.setMatrix(o,!0)}}},this.tokenChange=null}setFromPositionRatio(e,t){null!=e&&(this.fromLeftRatio=e),null!=t&&(this.fromTopRatio=t)}setOnScreenScale(e){null!=e&&(this.onScreenScale=e)}_onLinkedToSceneGraph(){let e=this;this.tokenChange=i.subscribe({event:"/VISU/"},(function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)}))}_onUnlinkedToSceneGraph(){i.unsubscribe(this.tokenChange)}_getDynamicMatrix(t,i,r){let n=this._getViewer(),a=n._getCanvasOffsetWidth(),o=n._getCanvasOffsetHeight(),s=new e.Matrix4;const c=new e.Quaternion;let h=new e.Vector3,l=a*this.fromLeftRatio,d=o*this.fromTopRatio,u=new e.Vector3(l,d,r.camera.getProjectedDepthNear()),p=r.unProject(u),_=new e.Vector3(l,d,1),m=r.unProject(_),f=(new e.Vector3).addVectors(m,p).multiplyScalar(.5),g=this.getBoundingSphere(),x=new e.Vector3,v=new e.Vector3(1,1,1),w=1;if(this.onScreenScale>0){if(g&&g.radius>0){let t=(new e.Vector3).crossVectors(r.getUpDirection(),r.getSightDirection());t.normalize(),t.multiplyScalar(g.radius);let i=(new e.Vector3).addVectors(f,t),n=(new e.Vector3).subVectors(f,t),s=r.project(i),c=r.project(n),h=(new e.Vector3).subVectors(s,c),l=Math.sqrt(h.x*h.x+h.y*h.y);w=this.onScreenScale*Math.max(a,o)/l}v.multiplyScalar(w)}return g&&(x=g.center,h.subVectors(f,x.multiplyScalar(w))),s.compose(h,c,v),s}getNodeType(){return"ProjectionNode3D"}isPointOfViewDependant(){return!0}_linkingClone(e){return e=e||new n({name:this.name,leftRatio:this.fromLeftRatio,topRatio:this.fromTopRatio,scale:this.onScreenScale}),t.prototype._linkingClone.call(this,e),e}}return n})),define("DS/SceneGraphNodes/SpotLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){var r,n;t||(t={}),r=void 0!==t.outerAngle&&null!==t.outerAngle?Math.max(Math.min(t.outerAngle,Math.PI),0):Math.PI/2,n=void 0!==t.innerAngle&&null!==t.innerAngle?Math.max(Math.min(t.innerAngle,r-.001),0):r-.001,this._outerAngle=r,this._innerAngle=n;var a=t.intensity;void 0===a&&(a=t.power?t.power/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle)))):1);var o=new e.SpotLight(t.color,a,t.distance,r,n);return t.target?(o.target=new e.Object3D,o.target.position=t.target):o.target=null,this._previousTarget=o.target,t.physicalAttenuation&&(o.isPhysicallyAttenuated=!0,o.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(o,i,null),this},attachToViewpoint:function(t){if(this._attachedToVpt!=t){var i=this._occurrences.length;if(t){this.light3js.target=new e.Object3D,this.light3js.target.position=new e.Vector3(0,0,0);for(r=0;r<i;r++)this._occurrences[r].renderable.target=new e.Object3D,this._occurrences[r].renderable.target.position=new e.Vector3(0,0,0)}else{this.light3js.target=this._previousTarget;for(var r=0;r<i;r++)this._occurrences[r].renderable.target=this._previousTarget}}this._attachedToVpt=t},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var r=this._occurrences.length,n=0;n<r;n++)this._occurrences[n].renderable.target=i},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,this.light3js.shadowCameraFov=180*this.light3js.angle/Math.PI*2,t){var r=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,r=!0),this.light3js.shadowMap&&r&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var n=0;n<i;n++){var a=this._occurrences[n].renderable;if(a.castShadow=!0,a.shadowCameraFov=180*a.angle/Math.PI*2,t){r=!1;t.bias&&(a.shadowBias=t.bias),t.near&&(a.shadowCameraNear=t.near),t.far&&(a.shadowCameraFar=t.far),t.darkness&&(a.shadowDarkness=t.darkness),t.mapWidth&&(a.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(a.shadowMapHeight=t.mapHeight,r=!0),a.shadowMap&&r&&(a.shadowMap.dispose(),a.shadowMap=null,a.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(n=0;n<i;n++)this._occurrences[n].renderable.castShadow=!1}},setAngles:function(e,t,i){if(i)var r=this._intensity*(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));e=null!=e?Math.max(Math.min(e,Math.PI/2),0):Math.PI/2,t=null!=t?Math.max(Math.min(t,e-.001),0):e-.001,this._outerAngle=e,this._innerAngle=t,i&&this.setIntensity(r/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))))),this._updateAngles(),this.updateShadowMap()},_updateAngles:function(){var e,t;this.light3js.angle=this._outerAngle,this.light3js.innerAngle=this._innerAngle,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.angle=this._outerAngle,t.renderable.innerAngle=this._innerAngle},setPower:function(e){var t=e/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SpotLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SpotLight",i)})),define("SceneGraphNodes/SpotLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/SpotLightNode"),e})),define("DS/SceneGraphNodes/IESLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.IESLight(t.color,t.intensity,t.distance,t.texture);return t.physicalAttenuation&&(r.isPhysicallyAttenuated=!0,r.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._texture=t.texture,this._parent(r,i),this},setIESTexture:function(e){this._texture=e,this._updateTexture()},_updateTexture:function(){var e;this.light3js.iesTexture=this._texture,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.iesTexture=this._texture},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"IESLightNode3D"}});return UWA.namespace("THREEDS/Nodes/IESLight",i)})),define("SceneGraphNodes/IESLightNode",["DS/SceneGraphNodes/IESLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/IESLightNode"),e})),define("DS/SceneGraphNodes/SimpleArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],(function(e,t,i,r,n,a,o,s){"use strict";var c=new e.Vector3,h=(new e.Matrix4,t.extend({init:function(t){this._parent(t.name),this.viewpoint=t.viewpoint,this._baseLength=t.baseLength?t.baseLength:0,this._length=t.length?t.length:5,this._headHeight=t.headHeight?t.headHeight:1,this._begin=t.begin?(new e.Vector3).copy(t.begin):new e.Vector3,this._direction=t.direction?(new e.Vector3).copy(t.direction):new e.Vector3(1,0,0),this._normal=t.normal?(new e.Vector3).copy(t.normal):new e.Vector3(0,1,0),this.constraintAxis=(new e.Vector3).copy(this._direction).normalize();var i=this._length-this._headHeight,r=new e.Vector3,h=new e.Vector3,l=new e.Vector3,d=new e.Vector3,u=new e.Vector3,p=new e.Vector3(0,0,1),_=new e.Vector3(1,0,0);c.copy(p),r.addVectors(this._begin,c.multiplyScalar(this._baseLength)),c.copy(p),h.addVectors(r,c.multiplyScalar(i)),c.copy(p),l.addVectors(h,c.multiplyScalar(this._headHeight)),c.copy(_),d.addVectors(h,c.multiplyScalar(.2*this._headHeight)),u.subVectors(h,c),this._noZ=!t.removeNoZ,this.materialArrow=new e.LineBasicMaterial({side:e.DoubleSide,color:t.color,scale:t.arrowScale?t.arrowScale:6.666,lineWidth:t.arrowWidth?t.arrowWidth:1,dashType:t.arrowDashType?t.arrowDashType:"None",linecap:"butt",transparent:!0,isCPUPattern:!0,alphaTest:.05}),this.materialArrow.force=!0;new o;this.nodeArrowBody=s.createLineNode({points:[r,h,d,l,u,h],drawMode:n.ConnectivityTypeEnum.LINE_STRIP,material:this.materialArrow,layerNb:this._noZ?1:0}),this.nodeArrowBody.setShadow(!1),this.nodeArrowBody.setFrustumCulled(!1),this.nodeArrowBody.setPickParent(!0),this.nodeArrowBody.name="simple arrow";var m={constraintAxis:this.constraintAxis,name:"billBoardNode_simpleArrow",type:"Cylindrical",viewpoint:this.viewpoint};return this.billBoardArrowBody=new a(m),this.billBoardArrowBody.addChild(this.nodeArrowBody),this.billBoardArrowBody.setPickParent(!0),this.addChild(this.billBoardArrowBody),this.name="SimpleArrow",this},updateColor:function(e){this.materialArrow.color=e},setArrowWidth:function(e){this.materialArrow.setLineWidth(e)},setArrowPattern:function(e){this.materialArrow.setDashPatternType(e)},setArrowPatternScale:function(e){this.materialArrow.setScale(e)},getNodeType:function(){return"SimpleArrowNode"},getTopHead:function(){var t=new e.Vector3;return c.copy(this._direction),t.addVectors(this._begin,c.multiplyScalar(this._baseLength+this._length)),t}}));return UWA.namespace("THREEDS/Nodes/SimpleArrowNode",h)})),define("DS/SceneGraphNodes/Canvas2DInstancingNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/Canvas2DNode"],(function(e,t,i,r,n){"use strict";var a=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture,this.texture=this.canvasNodeTexture._getCanvas2DTexture(),this.rectangle=n._createRectangle(null,i),this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.setInstancingParams(t,this.texture),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),void 0!==t.excludeFromBounding?this.excludeFromBounding=!!t.excludeFromBounding:this.excludeFromBounding=!0,this.excludeFromBounding?this.exludeFromBounding(!0):this._setupBoundingSphere(t.matrices);var r=this;return this.rectangle._setBeforeRenderCB((function(e,t){r.texture.redrawRequested&&r.canvasNodeTexture._redrawCanvas2DTexture()})),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setInstancingParams:function(e){this.material=this._buildInstancingMaterial(this.texture),this.material.force=!0,this.rectangle.setMaterial(this.material),this._setUpMeshInstancingParameters(this.rectangle,e.nbInstances,e.matrices,e.colors),this.excludeFromBounding||this._setupBoundingSphere(e.matrices)},_buildInstancingMaterial:function(t){var i=new e.MeshBasicMaterial({force:!0,transparent:!0,side:e.DoubleSide});i.activatePDSFX("PDSFXCanvas2DInstancing");var r={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},map:{type:"t2",value:t},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};return i.setPDSFXVaryings({vColor:{type:"v3"},vTex:{type:"v2"}}),i.setPDSFXUniforms(r),i.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){return`\n                            return (instanceMatrix * ${e.variableHandler.vec4(i)}(${e.vGetAttribPosition()}, 1.0)).xyz;\n                        `;var i},ProcessClipSpacePosition:function(e,t){const i=e.variableHandler,r=t=>e.getUniform(t),n=i.dereference(t[0]);return`           \n                            ${a="myUv",i.vec2(a)} = ${e.vGetAttribTexCoord0()}.xy;\n                            ${n}.x += ${n}.w * (${r("pixelSize")}.x*(-${r("hotspot")}.x + myUv.x*${r("size")}.x));\n                            ${n}.y += ${n}.w * (${r("pixelSize")}.y*(-${r("hotspot")}.y + myUv.y*${r("size")}.y));\n                        `;var a},ComputeVaryingValues:function(e,t){const i=t=>e.getVarying(t);return`                     \n                            ${i("vColor")} = instanceColor;\n                            ${i("vTex")} = ${e.vGetAttribTexCoord0()}.xy;\n                        `}},{ProcessFinalColor:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions,n=e=>i.vec4(e),a=i.dereference(t[0]);return`\n                            ${n("color")} = ${r.sample2DTexture((o="map",e.getTextureUniform(o)),(t=>e.getVarying(t))("vTex"))};\n                            ${a} = ${n()}(color.r*vColor.r, color.g*vColor.g, color.b*vColor.b, color.a);\n                        `;var o},ComputeViewNormal:function(e,t){return`\n                            return ${e.variableHandler.vec3(i)}(0.0, 0.0, 1.0);\n                        `;var i},ComputeDiscard:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions;return`\n                        \n                            ${n="color",i.vec4(n)} = ${r.sample2DTexture((t=>e.getTextureUniform(t))("map"),(t=>e.getVarying(t))("vTex"))};\n                            return color.a <= ${(t=>e.getUniform(t))("alphaTest")};\n                        `;var n}}),i.refreshUniforms=function(t,i){var r;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)r=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var n=2*t._gpuPickingTolerance+1;r=new e.Vector2(2/n,2/n)}this.updatePDSFXUniform("pixelSize",r)},i},_setUpMeshInstancingParameters:function(t,i,r,n){var a,o,s,c,h,l,d=new Float32Array(16*i),u=new Float32Array(3*i),p=new e.Matrix4;for(a=0;a<i;a++){for(o=r[a],p.copy(o),s=16*a,c=o.elements,l=0;l<16;l++)d[s+l]=c[l];s=3*a,h=n[a],u[s]=h.r,u[s+1]=h.g,u[s+2]=h.b}var _={data:d,type:"m4",attribName:"instanceMatrix",isFlattened:!0},m={data:u,type:"v3",attribName:"instanceColor",isFlattened:!0};t.setInstancingParameters(i,[_,m])},_setupBoundingSphere:function(t){var i,r,n,a,o,s=new e.Vector3(-1/0,-1/0,-1/0),c=new e.Vector3(1/0,1/0,1/0),h=new e.Vector3(0,0,0);for(i=0;i<t.length;i++)n=(r=t[i]).elements[12],a=r.elements[13],o=r.elements[14],n<c.x&&(c.x=n),a<c.y&&(c.y=a),o<c.z&&(c.z=o),n>s.x&&(s.x=n),a>s.y&&(s.y=a),o>s.z&&(s.z=o);h.x=(c.x+s.x)/2,h.y=(c.y+s.y)/2,h.z=(c.z+s.z)/2;var l,d=new e.Vector3,u=0;for(i=0;i<t.length;i++)n=(r=t[i]).elements[12],a=r.elements[13],o=r.elements[14],d.set(n,a,o),(l=h.distanceTo(d))>u&&(u=l);var p=new e.Sphere(h,u);this.rectangle.forceBoundingSphere(p)}});return UWA.namespace("THREEDS/Nodes/Canvas2DInstancingNode",a)})),define("DS/SceneGraphNodes/CanvasNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CanvasNodeTexture"],(function(e,t,i,r,n){"use strict";var a=t.extend({init:function(t,i){this._parent(t.name),this._isDynamic=!0,this.bottomLeftCorner=t.bottomLeftcorner,this.vectors={},this.vectors.width=t.widthVector,this.vectors.height=t.heightVector,this.canvasNodeTexture=t.canvasNodeTexture,this.requestTextureUpdate=!0;var n=t.side?t.side:e.FrontSide,a=t._noZPriority?t._noZPriority:-1/0;this.rectangle=function(t,i,n,a,o,s,c,h){var l,d,u,p,_,m,f,g,x,v,w,S,y,b,M;for(10,(l=new r.PrimitiveGroup).fillAttr=new r.FillAttributes,l.lineAttr=new r.LineAttributes,l.pointAttr=new r.PointAttributes,(d=new r.Buffer).size=12,d.component=r.VertexComponentEnum.POSITION,d.format=r.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(u=new r.Buffer).size=3,u.component=r.VertexComponentEnum.NORMAL,u.format=r.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(u.size),(p=new r.Buffer).size=12,p.component=r.VertexComponentEnum.TEX_COORD_0,p.format=r.DataTypeEnum.FLOAT,p.dimension=3,p.data=new Float32Array(p.size),(_=new r.Buffer).indexBuffer=!0,_.size=4,_.format=r.DataTypeEnum.UINT,_.dimension=1,_.data=new Uint16Array(_.size),(m=new r.Buffer).indexBuffer=!0,m.size=4,m.format=r.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(m.size),(f=new r.Buffer).indexBuffer=!0,f.size=4,f.format=r.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,d),l.addBuffer(1,u),l.addBuffer(2,_),l.addBuffer(3,m),l.addBuffer(4,p),l.addBuffer(5,f),M=_.data,y=0,M[y++]=0,M[y++]=1,M[y++]=3,M[y++]=2,M=m.data,y=0,b=0;b<1;b++)M[y++]=b,M[y++]=b,M[y++]=b,M[y++]=b;M=f.data,y=0,M[y++]=0,M[y++]=1,M[y++]=3,M[y++]=2,M=d.data,y=0,M[y++]=i.x,M[y++]=i.y,M[y++]=i.z,M[y++]=i.x+n.x,M[y++]=i.y+n.y,M[y++]=i.z+n.z,M[y++]=i.x+n.x+a.x,M[y++]=i.y+n.y+a.y,M[y++]=i.z+n.z+a.z,M[y++]=i.x+a.x,M[y++]=i.y+a.y,M[y++]=i.z+a.z,M=u.data,y=0;var T=(new e.Vector3).crossVectors(n,a).normalize();M[y++]=T.x,M[y++]=T.y,M[y++]=T.z;var P=o?1:a.length()/n.length();M=p.data,y=0,M[y++]=0,M[y++]=1-P,M[y++]=0,M[y++]=1,M[y++]=1-P,M[y++]=0,M[y++]=1,M[y++]=1,M[y++]=0,M[y++]=0,M[y++]=1,M[y++]=0;var C=s==e.DoubleSide?0:1;for(b=0;b<1;b++)(g=new r.Primitive).nbIndices=4,g.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,g.attr={fill:new r.FillAttributes(new r.Color(1-b/6,0,b/6,1),C),line:new r.LineAttributes,point:new r.PointAttributes},(x=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=r.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new r.IndexArray,x.indices.format=r.DataTypeEnum.UINT,x.indices.bufferId=2,x.indices.offset=4*b,(v=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,v.nbVertices=4,v.nbValuesPerVertex=3,v.format=r.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=1,v.indices=new r.IndexArray,v.indices.format=r.DataTypeEnum.UINT,v.indices.bufferId=3,v.indices.offset=4*b,(w=new r.VertexComponent).component=r.VertexComponentEnum.TEX_COORD_0,w.nbVertices=4,w.nbValuesPerVertex=3,w.format=r.DataTypeEnum.FLOAT,w.cardinality=0,w.bufferId=4,w.indices=new r.IndexArray,w.indices.format=r.DataTypeEnum.UINT,w.indices.bufferId=5,w.indices.offset=0,g.addVertexComponent(x),g.addVertexComponent(v),g.addVertexComponent(w),l.addPrimitive(g);return S=c.createMeshNode(l,t,void 0,void 0,h),S.setShadow(!1),S}(null,this.bottomLeftCorner,this.vectors.width,this.vectors.height,t.canvasNodeTexture.rectangleTexture,n,i,a),this.rectangle.name=void 0!==t.name?t.name:"";var o=this;return this.rectangle._setBeforeRenderCB((function(e,t){o.requestTextureUpdate&&t.viewpoint&&o._textureUpdate(e,t.viewpoint,t.camera)})),this.rectangle.setSSAO(!1),this.rectangle.setMirror(!1),this.addChild(this.rectangle),this.cbChange=function(e){"@onViewpointChange"===e.eventType&&o._onViewpointChange()},this.tokenChange=null,this},setFrustumCulled:function(){this.rectangle.setFrustumCulled.apply(this.rectangle,arguments)},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){var e;for(i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange),e=0;e<this.rectangle._occurrences.length;e++){var t=this.rectangle._occurrences[e].renderable;if(t.material){var r;if(this.canvasNodeTexture._releaseMaterial(t.material),t.material=null,t.highlightMeshes)for(r=0;r<t.highlightMeshes.length;r++)t.highlightMeshes[r].renderable.material=null;t.preHighlight&&(t.preHighlight.material=null)}}},_getDynamicMatrix:function(e,t,i){return this._onViewpointChange(),this.getMatrix()},_onViewpointChange:function(){this.requestTextureUpdate=!0},_textureUpdate:function(t,i,r){r.position;var n=this.bottomLeftCorner.clone(),a=this.vectors[this.canvasNodeTexture.longestEdge],o=new e.Vector3(n.x+a.x,n.y+a.y,n.z+a.z),s=t._getMMMatrix();n.applyMatrix4(s),o.applyMatrix4(s);var c=i.project(n,r),h=i.project(o,r),l=c.distanceTo(h),d=t.material,u=this.canvasNodeTexture._getNewMaterial(l,d);if(u&&t.material!==u){var p;if(t.material=u,t.highlightMeshes)for(p=0;p<t.highlightMeshes.length;p++)t.highlightMeshes[p].renderable.material=u;t.preHighlight&&(t.preHighlight.material=u),t._flagAsGSSOInvalidated()}}});return UWA.namespace("THREEDS/Nodes/CanvasNode",a)})),define("DS/SceneGraphNodes/RefPlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/MaterialApplication","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,i,r,n,a,o,s,c){"use strict";const h=(e,t,i)=>c.FunctionHandler.callFunction(e,t,i),l=.075,d=.8,u=.8;var p=new e.MeshBasicMaterial({force:!1}),_=new e.Matrix4,m=new e.Vector3(0,0,1),f=new e.Vector3,g=new e.Vector3,x=new e.Vector3,v=new e.Vector3,w=new e.Vector3,S=new e.Vector3,y=new e.Vector3,b=new e.Vector3,M=new e.Vector3,T=new e.Vector3,P=new e.Vector3,C=e.__visibleInCurrentSpace,D=function(){this._backBorderMaterial=null,this._frontPlaneMaterial=null,this._backPlaneMaterial=null,this._margin=null,this._frontText=null,this._backText=null,this._frontPlane=null,this._backPlane=null,this._backBorder=null,this._frontTextNode=null,this._backTextNode=null,this._fixedSizeFrontText=null,this._fixedSizeBackText=null,this._xArrowIndicatorFront=null,this._xArrowIndicatorBack=null};class V{constructor(e,t){this.keys=e,this.cache=new Map,this._create=t}get(e){const t=this._getKey(e);let i=this.cache.get(t);return i||this.cache.set(t,i=this._create(e)),i}_getKey(e){let t="";for(let i=0;i<this.keys.length;i++){let r=e[this.keys[i]];r.getHexString&&(r=r.getHexString()),t+="-"+r}return t}}const N=new V(["color","opacity","lineWidth","force"],(t=>{const i=new e.LineBasicMaterial({color:t.color,opacity:t.opacity,lineWidth:t.lineWidth,side:2,polite:!0,force:t.force,forceSide:!0,enableClipPlanes:!1});return i.line=i,i})),A=new V(["color","opacity","side","force"],(t=>new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,side:t.side,polygonOffset:!0,polygonOffsetFactor:.5,force:t.force,forceSide:!0,enableClipPlanes:!1}))),k=new V(["color","force"],(t=>new e.MeshBasicMaterial({color:t.color,opacity:.8,side:2,force:t.force,forceSide:!0,depthTest:!1,enableClipPlanes:!1})));class I{static retrieveTextTexture(t,i){return""===t?null:o._createTextTexture({text:t,fontFamily:"Trebuchet MS",color:new e.Color(16777215),opacity:1,resolutionCoef:2*(i||64)})}static createGeometry(){let t=new e.BufferGeometryDS;t.vertexPositionArray=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-.3,1,-.25,0,1,-1,.3,1]),t.vertexIndexArray=new Uint16Array([0,1,2,0,2,3,4,5,6,0,1,1,2,2,3,3,0]),t.boundingBox=new e.Box3(new e.Vector3(-1,-1,0),new e.Vector3(1,1,0)),t.computeBoundingSphere();const i=new a.SGRep;function r(e,t){const r=new a.SGPrimitive({start:e,count:t,rep:i});return i._primitives.push(r),r}const n=window.newMaterialInheritance?e.GraphicAttributeSet.DefaultGASs.skin:null,o=window.newMaterialInheritance?e.GraphicAttributeSet.DefaultGASs.edge:null,s=new a.DrawingGroup(n,null,4,0,9,[r(0,9)]);s._primitives[0].group=s,s.geometry=t;const c=new a.DrawingGroup(o,null,1,9,8,[r(9,8)]);return c._primitives[0].group=c,c.geometry=t,t.drawingGroups=[s,c],t}static createMaterial(){const e=I.createPlaneMaterial();return e.line=I.createBorderMaterial({withOpacity:!0}),e.line.politeMaterial=I.createBorderMaterial({withOpacity:!1}),e.line.politeMaterial.depthTest=!1,e.line.politeMaterial.depthWrite=!1,e}static recompileMaterial(e){e.recompileShaders(!0),e.line.recompileShaders(!0),e.line.politeMaterial.recompileShaders(!0)}static getShaderHelpers(){return{VS:{main:function(e){const t=e.variableHandler,i=e.functionHandler,r=e.pdsfxDefines,n=e=>t.float(e),a=e=>t.vec3(e),o=e=>t.vec4(e);return`\n                        ${i.dF("isArrow","b",[])}{\n\t\t\t\t\t\t\treturn ${e.vGetAttribPosition()}.z > 0.0;\n\t\t\t\t\t\t}\n\n                        ${i.dF("transpose","m4",[i.prmM4("m")])}{\n\t\t\t\t\t\t\t${s="n",t.mat4(s)};\n\t\t\t\t\t\t\tn[0] = ${o()}(m[0][0], m[1][0], m[2][0], m[3][0]);\n\t\t\t\t\t\t\tn[1] = ${o()}(m[0][1], m[1][1], m[2][1], m[3][1]);\n\t\t\t\t\t\t\tn[2] = ${o()}(m[0][2], m[1][2], m[2][2], m[3][2]);\n\t\t\t\t\t\t\tn[3] = ${o()}(m[0][3], m[1][3], m[2][3], m[3][3]);\n\t\t\t\t\t\t\treturn n;\n\t\t\t\t\t\t}\n\n                        ${i.dF("computeClipPosition","v4",[i.prmV3("pos")])}{\n\t\t\t\t\t\t\treturn ${e.vGetProjectionMatrix()} * ${h("getModelViewTransformation","v4",[i.prmV3("pos")])};\n\t\t\t\t\t\t}\n\n                        ${i.dF("get_pixel_size_in_model_units","v3",[i.prmV3("pos_model")])}{\n                            ${a("x")} = ${a()}(1.0, 0.0, 0.0);\n                            ${a("y")} = ${a()}(0.0, 1.0, 0.0);\n                            ${a("z")} = ${a()}(0.0, 0.0, 1.0);\n\t\t\t\t\t\t\t${n("Lx")} = length(${h("computeModelViewDirection","v4",[i.prmV3("x")])}.xyz);\n\t\t\t\t\t\t\t${n("Ly")} = length(${h("computeModelViewDirection","v4",[i.prmV3("y")])}.xyz);\n\t\t\t\t\t\t\t${n("Lz")} = length(${h("computeModelViewDirection","v4",[i.prmV3("z")])}.xyz);\n\n\t\t\t\t\t\t\t${n("W")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("pos_model")])}.w;\n\t\t\t\t\t\t\t${a("clip_radius")}  = ${a()}(\n\t\t\t\t\t\t\t\t(${e.vGetProjectionMatrix()} * ${o()}(0.0, Lx, 0.0, 0.0)).y,\n\t\t\t\t\t\t\t\t(${e.vGetProjectionMatrix()} * ${o()}(0.0, Ly, 0.0, 0.0)).y,\n\t\t\t\t\t\t\t\t(${e.vGetProjectionMatrix()} * ${o()}(0.0, Lz, 0.0, 0.0)).y\n\t\t\t\t\t\t\t) / W;\n\n\t\t\t\t\t\t\t${n("clip1px")}  = 2.0 / ${n()}(${e.vGetViewportSize()}.y);\n\t\t\t\t\t\t\t${a("pixel")}  = clip1px / clip_radius;\n                            ${r.fixedSize?"\n                                pixel /= simpleNodeData.fixedSizeScale;\n                                ":""}\n\t\t\t\t\t\t\treturn pixel;\n\t\t\t\t\t\t}\n\n                        ${i.dF("is_front_facing","b",[])}{\n                            ${a("z")} = ${a()}(0.0, 0.0, 1.0);\n\t\t\t\t\t\t\t${o("Z")} = ${h("computeModelViewDirection","v4",[i.prmV3("z")])};\n\t\t\t\t\t\t\tif(${e.vGetProjectionMatrix()}[3][3] > 0.5) {\n\t\t\t\t\t\t\t\treturn Z.z >= 0.0;\n                            } else {\n                                ${a("zeros")} = ${a()}(0.0, 0.0, 0.0);\n\t\t\t\t\t\t\t\t${o("C")} = ${h("computeModelViewPosition","v4",[i.prmV3("zeros")])};\n\t\t\t\t\t\t\t\treturn dot(C.xyz / C.w, Z.xyz) <= 0.0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n                        ${i.dF("compute_body_position","v3",[i.prmV2("pos2D")])}{\n\t\t\t\t\t\t\treturn ${a()}(pos2D, 0.0);\n\t\t\t\t\t\t}\n\n                        ${i.dF("swap","v2",[i.prmV2("p")])}{\n                            ${n("swapped")} = p;\n\t\t\t\t\t\t\t${n("tmp")} = swapped.x;\n\t\t\t\t\t\t\tswapped.x = swapped.y;\n\t\t\t\t\t\t\tswapped.y = tmp;\n\t\t\t\t\t\t\treturn swapped;\n\t\t\t\t\t\t}\n                        `;var s},arrow:function(e){const t=e.variableHandler,i=e.functionHandler,r=e=>t.vec2(e),n=e=>t.vec3(e);return`\n                        ${i.dF("compute_arrow_position","v3",[i.prmV3("pos2D")])}{\n\t\t\t\t\t\t\tif(!${a="RPShowArrow",e.getUniform(a)}) {\n                                return ${n()}(0.0, 0.0, 0.0);\n                            }\n\n\t\t\t\t\t\t\t${n("arrow_pos")}  = ${n()}(1.0, 0.0, 0.0);\n\t\t\t\t\t\t\t${r("arrow1px")}  = ${i.cF("get_pixel_size_in_model_units","v3",[i.prmV3("arrow_pos")])}.xy;\n\t\t\t\t\t\t\t${r("scale")}  = ${20..toFixed(2)} * arrow1px;\n\n\t\t\t\t\t\t\t// Arrow should not take more than a third of the refplane\n\t\t\t\t\t\t\t${(e=>t.float(e))("body_width")}  = 2.0;\n\t\t\t\t\t\t\tif(scale.x * 3.0 > body_width) {\n                                return ${n()}(0.0, 0.0, 0.0);\n                            }\n\n\t\t\t\t\t\t\t// Normal arrow transform\n\t\t\t\t\t\t\treturn ${n()}(arrow_pos.xy + scale * pos2D, 0.0);\n\t\t\t\t\t\t}\n                        `;var a},text:function(e){const t=e.variableHandler,i=e.functionHandler,r=t=>e.getUniform(t),n=e=>t.bool(e),a=e=>t.float(e),o=e=>t.vec2(e),s=e=>t.vec3(e),c=e=>t.vec4(e);return`\n                        ${i.dF("compute_text_placement","v2",[i.prmV2("pos2D")])}{\n\t\t\t\t\t\t\t// Model space\n\t\t\t\t\t\t\t${s("m0")}  = ${s()}(-1.0, -1.0, 0.0);\n\t\t\t\t\t\t\t${s("m1")}  = ${s()}( 1.0, -1.0, 0.0);\n\t\t\t\t\t\t\t${s("m2")}  = ${s()}( 1.0,  1.0, 0.0);\n\t\t\t\t\t\t\t${s("m3")}  = ${s()}(-1.0,  1.0, 0.0);\n\n\t\t\t\t\t\t\t// Clip space\n\t\t\t\t\t\t\t${c("c0")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m0")])};\n\t\t\t\t\t\t\tc0.x /= c0.w;\n\t\t\t\t\t\t\tc0.y /= c0.w;\n\t\t\t\t\t\t\tc0.z /= c0.w;\n\t\t\t\t\t\t\t${c("c1")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m1")])};\n\t\t\t\t\t\t\tc1.x /= c1.w;\n\t\t\t\t\t\t\tc1.y /= c1.w;\n\t\t\t\t\t\t\tc1.z /= c1.w;\n\t\t\t\t\t\t\t${c("c2")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m2")])};\n\t\t\t\t\t\t\tc2.x /= c2.w;\n\t\t\t\t\t\t\tc2.y /= c2.w;\n\t\t\t\t\t\t\tc2.z /= c2.w;\n\t\t\t\t\t\t\t${c("c3")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m3")])};\n\t\t\t\t\t\t\tc3.x /= c3.w;\n\t\t\t\t\t\t\tc3.y /= c3.w;\n\t\t\t\t\t\t\tc3.z /= c3.w;\n\n\t\t\t\t\t\t\t// Find the appropriate border for text (that is, the one with the most X available)\n\t\t\t\t\t\t\t${a("dx")} = -1.0;\n                            ${a("lx")} = -1.0;\n                            ${n("_front_facing")} = ${i.cF("is_front_facing","b",[])};\n\t\t\t\t\t\t\t${a("side")}  = -1.0;\n                            if (_front_facing) {\n                                side = 1.0;\n                            }\n\t\t\t\t\t\t\t${s("corner")} ;\n\t\t\t\t\t\t\t${o("oriented_uv")} ;\n\t\t\t\t\t\t\t${n("need_swap")} = false;\n\t\t\t\t\t\t\tif( (lx = (c1.x - c0.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m1;\n                                if (_front_facing) {\n                                    corner = m0;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = pos2D;\n\t\t\t\t\t\t\t\tneed_swap = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif( (lx = (c2.x - c1.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m2;\n                                if (_front_facing) {\n                                    corner = m1;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = ${o()}(pos2D.y, -pos2D.x);\n\t\t\t\t\t\t\t\tneed_swap = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif( (lx = (c3.x - c2.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m3;\n                                if (_front_facing) {\n                                    corner = m2;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = ${o()}(-pos2D.x, -pos2D.y);\n\t\t\t\t\t\t\t\tneed_swap = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif( (lx = (c0.x - c3.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m0;\n                                if (_front_facing) {\n                                    corner = m3;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = ${o()}(-pos2D.y, pos2D.x);\n\t\t\t\t\t\t\t\tneed_swap = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// If not on the front face, vertices will be oriented the other way\n\t\t\t\t\t\t\tif(!_front_facing) {\n\t\t\t\t\t\t\t\toriented_uv.x *= -1.0;\n                            }\n\n\t\t\t\t\t\t\t// Adjustments: half-size -> size, UV in [0,1]^2 instead of [-1,1]^2\n\t\t\t\t\t\t\toriented_uv = 0.5 + 0.5 * oriented_uv;\n\n\t\t\t\t\t\t\t// Text parameters\n\t\t\t\t\t\t\t${o("text_margin")}  = ${r("RPTextBackRect")}.xy;\n\t\t\t\t\t\t\t${o("text_size")}    = ${r("RPTextBackRect")}.zw;\n                            if (_front_facing) {          \n\t\t\t\t\t\t\t    text_margin = ${r("RPTextFrontRect")}.xy;\n\t\t\t\t\t\t\t    text_size   = ${r("RPTextFrontRect")}.zw;\n                            }\n\n\t\t\t\t\t\t\t// Scale\n\t\t\t\t\t\t\t${o("uv_per_px")}  = ${i.cF("get_pixel_size_in_model_units","v3",[i.prmV2("corner")])}.xy / 2.0;\n\t\t\t\t\t\t\tif(need_swap) {\n                                uv_per_px = ${i.cF("swap","v2",[i.prmV2("uv_per_px")])};\n                            }\n\n\t\t\t\t\t\t\t// Is the text too big for the refplane ?\n\t\t\t\t\t\t\tif((text_size.x + 2.0 * text_margin.x) * uv_per_px.x >= 1.0) {\n\t\t\t\t\t\t\t\treturn ${o()}(-1.0, -1.0);\n                            }\n\n\t\t\t\t\t\t\t// Rescale UV to fit [0,1]^2 to the actual size of the text\n\t\t\t\t\t\t\treturn (oriented_uv / (text_size * uv_per_px) - text_margin / text_size);\n\t\t\t\t\t\t}\n                        `}}}}static createPlaneMaterial(){const t={RPShowArrow:{type:"b",value:!0},RPBodyFrontColor:{type:"v4",value:new e.Vector4(1,0,0,l)},RPBodyBackColor:{type:"v4",value:new e.Vector4(0,1,0,l)},RPTextFrontTexture:{type:"t2"},RPTextBackTexture:{type:"t2"},RPTextFrontRect:{type:"v4",value:new e.Vector4(10,10,40,40)},RPTextBackRect:{type:"v4",value:new e.Vector4(10,10,40,40)},RPTextFrontColor:{type:"v4",value:new e.Vector4(1,1,1,u)},RPTextBackColor:{type:"v4",value:new e.Vector4(1,1,1,u)}},i=I.getShaderHelpers(),r=(function(e){const t=e.variableHandler,i=e.functionHandler,r=e.bridgeFunctions,n=t=>e.getTextureUniform(t),a=t=>e.getUniform(t),o=t=>e.getVarying(t),s=e=>t.vec2(e),c=e=>t.vec4(e);return`             \n                    ${i.dF("isArrow","b",[])}{\n                        return ${o("is_arrow")} > 0.0;\n                    }\n                    ${i.dF("is_front_facing","b",[])}{\n                        return ${o("front_facing")} > 0.0;\n                    }\n                    ${i.dF("is_inside_text","b",[])}{\n                        ${s("uv")} = ${o("text_uv")};\n                        return uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0; \n                    }\n\n                    ${i.dF("get_body_color","v4",[])}{\n                        if (${i.cF("is_front_facing","b",[])}) {\n                            return ${a("RPBodyFrontColor")};\n                        }\n                        return ${a("RPBodyBackColor")};\n                    }\n                    ${i.dF("get_text_color","v4",[])}{\n                        if (${i.cF("is_front_facing","b",[])}) {\n                            return ${a("RPTextFrontColor")};\n                        }\n                        return ${a("RPTextBackColor")};\n                    }\n\n                    ${i.dF("compute_text_color","v4",[])}{\n                        ${c("body")}  = ${i.cF("get_body_color","v4",[])};\n                        ${c("tex")}  = ${i.cF("get_text_color","v4",[])};\n                        ${s("uv")} = ${o("text_uv")};\n                        if(${i.cF("is_front_facing","b",[])}) {\n                            tex *= ${r.sample2DTexture(n("RPTextFrontTexture"),"uv")};\n                        } else {\n                            tex *= ${r.sample2DTexture(n("RPTextBackTexture"),"uv")};\n                        }\n                        ${h="resultA",t.float(h)} = tex.a + body.a * (1.0 - tex.a);\n                        ${(e=>t.vec3(e))("resultRGB")} = (tex.rgb * tex.a + body.rgb * body.a * (1.0 - tex.a)) / result.a;\n                        return ${c()}(resultRGB, resultA);\n                    }\n                `;var h})`
			`,n={ComputeAlbedo:function(e,t){const i=e.variableHandler,r=e.functionHandler;return`\n\t\t\t\t\t${e.vSetFragDepth(`${e.vGetFragCoord()}.z`)};\n                    ${n="arrow",i.bool(n)} = ${r.cF("isArrow","b",[])};\n\t\t\t\t\tif(arrow) {\n                        ${e.vSetFragDepth("-0.002")};\n                    }\n\n\t\t\t\t\tif(arrow) {\n                        return ${r.cF("get_body_color","v4",[])}.rgb;\n                    } else if(!${r.cF("is_inside_text","b",[])}) {\n                        return ${r.cF("get_body_color","v4",[])}.rgb;\n\t\t\t\t\t} else {\n                        return ${r.cF("compute_text_color","v4",[])}.rgb;\n                    }\n                    `;var n},ComputeOpacity:function(e,t){const i=e.functionHandler;return`                 \n\t\t\t\t\tif(${i.cF("isArrow","b",[])}) {\n                        return ${.8.toFixed(2)};\n                    } else if(!${i.cF("is_inside_text","b",[])}) {\n                        return ${i.cF("get_body_color","v4",[])}.a;\n                    } else {\n                        return ${i.cF("compute_text_color","v4",[])}.a;\n                    }\n                    `},ComputeDiscard:function(e,t){return e.pdsfxDefines.highlightMaterial?"return true;":"return false;"}};let a=new e.MeshBasicMaterial({side:e.DoubleSide,color:16777215,opacity:.1,force:!0,polygonOffset:!0,polygonOffsetFactor:.5,enableClipPlanes:!1});return a.activatePDSFX("PDSFXRefPlanePlane"),a.setPDSFXUniforms(t),a.setPDSFXVaryings({is_arrow:{type:"f"},front_facing:{type:"f"},text_uv:{type:"v2"}}),a.setPDSFXGlobalShaderCode((function(e){return`\n                    ${i.VS.main(e)}\n                    ${i.VS.arrow(e)}\n                    ${i.VS.text(e)}\n                `}),r),a.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){const i=e.variableHandler,r=e.functionHandler;return`\n                    \n\t\t\t\t\t${n="pos2D",i.vec2(n)}  = ${e.vGetAttribPosition()}.xy;\n\n\t\t\t\t\tif(${r.cF("isArrow","b",[])}) {\n\t\t\t\t\t\treturn ${r.cF("compute_arrow_position","v3",[r.prmV2("pos2D")])};\n                    }else {\n\t\t\t\t\t\treturn ${r.cF("compute_body_position","v3",[r.prmV2("pos2D")])};\n                    }\n                    `;var n},ComputeVaryingValues:function(e,t){const i=e.functionHandler,r=t=>e.getVarying(t);return`\n                        ${r("is_arrow")} = 0.0;\n                        if(${i.cF("isArrow","b",[])}) {\n                            ${r("is_arrow")} = 1.0;;\n                        }\n                        ${r("front_facing")} = -1.0;\n                        if(${i.cF("is_front_facing","b",[])}) {\n                            ${r("front_facing")} = 1.0;;\n                        }\n                        ${r("text_uv")} = ${i.cF("compute_text_placement","v2"[i.prmV2(`${e.vGetAttribPosition()}.xy`)])};\n                    `}},n),a}static createBorderMaterial({withOpacity:t}){const i={RPBorderFrontColor:{type:"v4",value:new e.Vector4(1,1,0,d)},RPBorderBackColor:{type:"v4",value:new e.Vector4(1,0,1,d)},RPBorderHalfWidth:{type:"v2",value:new e.Vector2(1,1)}},r=I.getShaderHelpers(!1),n={ComputeAlbedo:function(e,t){const i=t=>e.getUniform(t);return`\n                        if (${e.functionHandler.cF("is_front_facing","b",[])}) {\n                            return ${i("RPBorderFrontColor")}.xyz;\n                        }\n                        return ${i("RPBorderBackColor")}.xyz;\n                    `},ComputeOpacity:t?function(e){const t=t=>e.getUniform(t);return`           \n                            if (${e.functionHandler.cF("is_front_facing","b",[])}) {\n                                return ${t("RPBorderFrontColor")}.w;\n                            }\n                            return ${t("RPBorderBackColor")}.w;\n                        `}:null};let a=new e.LineBasicMaterial({side:e.DoubleSide,color:16777215,opacity:.3,lineWidth:1,polite:!0,force:!0,enableClipPlanes:!1});return a.defines=a.defines||{},a.defines.PDSFX_REFPLANE_BORDER_WOPACITY=t?1:0,a.activatePDSFX("PDSFXRefPlaneBorder"),a.setPDSFXUniforms(i),a.setPDSFXVaryings({front_facing:{type:"f"}}),a.setPDSFXGlobalShaderCode(r.VS.main,(function(e){return`                \n                    ${e.functionHandler.dF("is_front_facing","b",[])}{\n                        return ${t="front_facing",e.getVarying(t)} > 0.0;\n                    }\n                `;var t})),a.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){const i=e.functionHandler,r=t=>e.getVarying(t);return`              \n                        ${r("front_facing")} = -1.0;\n                        if(${i.cF("is_front_facing","b",[])}) {\n                            ${r("front_facing")} = 1.0;;\n                        }\n                    `},ComputeHalfWidth:function(e,t){const i=t=>e.getUniform(t);return`\n                        if (${e.functionHandler.cF("is_front_facing","b",[])}) {\n                            return ${i("RPBorderHalfWidth")}.x;\n                        }\n                        return ${i("RPBorderHalfWidth")}.y;\n                    `}},n),a}static updateMaterial(e,{wireframe:t,show_arrow:i,plane_front_color:r,plane_back_color:n,border_front_color:a,border_back_color:o,text_front_color:s,text_back_color:c,border_front_width:h,border_back_width:l,text_front_text:d,text_back_text:u,text_front_size:p,text_back_size:_,text_front_margin:m,text_back_margin:f}){const g={},x={};function v(e){return e.x*=e.x,e.y*=e.y,e.z*=e.z,e}t&&(o=a,l=h),void 0!==i&&(g.RPShowArrow=!!i),void 0!==r&&(g.RPBodyFrontColor=v(r)),void 0!==n&&(g.RPBodyBackColor=v(n)),void 0!==s&&(g.RPTextFrontColor=v(s)),void 0!==c&&(g.RPTextBackColor=v(c)),void 0!==a&&(x.RPBorderFrontColor=v(a)),void 0!==o&&(x.RPBorderBackColor=v(o));const w=e.line.getPDSFXUniform("RPBorderHalfWidth").value;void 0!==h&&(w.x=h/2,x.RPBorderHalfWidth=w),void 0!==l&&(w.y=l/2,x.RPBorderHalfWidth=w),g.RPTextFrontRect=e.getPDSFXUniform("RPTextFrontRect").value,g.RPTextBackRect=e.getPDSFXUniform("RPTextBackRect").value,g.RPTextFrontTexture=e.getPDSFXUniform("RPTextFrontTexture").value,g.RPTextBackTexture=e.getPDSFXUniform("RPTextBackTexture").value,void 0!==m&&(g.RPTextFrontRect.x=g.RPTextFrontRect.y=m),void 0!==f&&(g.RPTextBackRect.x=g.RPTextBackRect.y=f),void 0!==d&&(g.RPTextFrontTexture=I.retrieveTextTexture(d,p)),void 0!==u&&(g.RPTextBackTexture=I.retrieveTextTexture(u,_));const S=g.RPTextFrontTexture?g.RPTextFrontTexture.image.width/g.RPTextFrontTexture.image.height:1,y=g.RPTextBackTexture?g.RPTextBackTexture.image.width/g.RPTextBackTexture.image.height:1;g.RPTextFrontRect.w=g.RPTextFrontTexture?g.RPTextFrontTexture.image.height/2:0,g.RPTextFrontRect.z=S*g.RPTextFrontRect.w,g.RPTextBackRect.w=g.RPTextBackTexture?g.RPTextBackTexture.image.height/2:0,g.RPTextBackRect.z=y*g.RPTextBackRect.w;const b=2*Math.max(x.RPBorderHalfWidth.x,x.RPBorderHalfWidth.y);e.line.setLineWidth(b),e.line.politeMaterial.setLineWidth(b);for(let t in g)e.updatePDSFXUniform(t,g[t]);for(let t in x)e.line.updatePDSFXUniform(t,x[t]),e.line.politeMaterial.updatePDSFXUniform(t,x[t])}static retrieveGeometry(){return I.sharedGeometry||(I.sharedGeometry=I.createGeometry()),I.sharedGeometry}static deriveColor(t){const i=t.getHSL(),r=i.h+20/255,n=Math.min(1,1.3*i.l);return(new e.Color).setHSL(r,i.s,n)}}I.sharedGeometry=null;const B=i.extend({init:function(t){this.parameters={show_arrow:!0,wireframe:!1,plane_front_color:new e.Vector4(1,0,0,l),plane_back_color:new e.Vector4(0,1,0,l),border_front_color:new e.Vector4(1,0,0,d),border_front_width:2,border_back_color:new e.Vector4(0,1,0,d),border_back_width:2,text_front_text:"",text_front_size:30,text_front_margin:5,text_front_color:new e.Vector4(1,0,0,u),text_back_text:"",text_back_size:30,text_back_margin:5,text_back_color:new e.Vector4(0,1,0,u)};const i=I.retrieveGeometry(),r=I.createMaterial(),n=new e.Mesh(null,r);return n.addGeometry(i,!0),n.matrixAutoUpdate=!1,n.receiveShadow=!1,n.castShadow=!1,this.refplane_material=r,this._parent(n,t.name),this.setShadow(!1),this.setSSAO(!1),this.setFrustumCulled(!1),this.setPickingPriorityId({faces:"RefPlanePickPriority",edges:"RefPlanePickPriority",points:"RefPlanePickPriority"}),this.setPickingPriorityId({edges:"RefPlaneEdges"}),this.setParameters(t),this},setParameters:function(e){function t(e,t){return e?(t||(t={}),e.color&&!t.color&&(t.color=I.deriveColor(e.color)),t):t}function i(e,t,i){return void 0!==t&&(e.x=t.r,e.y=t.g,e.z=t.b),void 0!==i&&(e.w=i),e}void 0!==e.wireframe&&(this.parameters.wireframe=e.wireframe),void 0!==e.showArrow&&(this.parameters.show_arrow=e.showArrow);const r=e.plane||e.planeAttributes,n=r&&r.front,a=t(n,r&&r.back);n&&i(this.parameters.plane_front_color,n.color,n.opacity),a&&i(this.parameters.plane_back_color,a.color,a.opacity);const o=e.border||e.borderAttributes,s=o&&o.front,c=t(s,o&&o.back);s&&(i(this.parameters.border_front_color,s.color,s.opacity),void 0!==s.width&&(this.parameters.border_front_width=s.width)),c&&(i(this.parameters.border_back_color,c.color,c.opacity),void 0!==c.width&&(this.parameters.border_back_width=c.width));const h=e.text||e.textAttributes,l=h&&h.front,d=h&&h.back;l&&(i(this.parameters.text_front_color,l.color,l.opacity),void 0!==l.data&&(this.parameters.text_front_text=l.data),void 0!==l.size&&(this.parameters.text_front_size=l.size)),d&&(i(this.parameters.text_back_color,d.color,d.opacity),void 0!==d.data&&(this.parameters.text_back_text=d.data),void 0!==d.size&&(this.parameters.text_back_size=d.size)),I.updateMaterial(this.refplane_material,this.parameters);const u=this.mesh3js.geometry[0].drawingGroups[0]._primitives[0];this.parameters.wireframe?this.hide([u]):this.show([u])}});t.extend({init:function(t){return this._enable_refplane_counting=void 0===t.enableRefplaneCounting||t.enableRefplaneCounting,this._enable_refplane_counting&&(this.tokenChange=null),this._parent(t.name),this._main=new B({name:`RefPlane3D-${t.name}`}),this._main.setPickParent(!0),this.addChild(this._main),this._zoomable=!1,this._size=new e.Vector2(2,2),this.setParameters(t),this},setParameters:function(t){void 0!==(t=Object.assign({},t)).fill&&(t.wireframe=!t.fill),void 0!==t.newLook&&(t.wireframe=!t.newLook),void 0!==t.fixedSize&&(t.zoomable=!t.fixedSize),void 0!==t.orientationArrow&&(t.showArrow=!!t.orientationArrow),delete t.fill,delete t.newLook,delete t.fixedSize,delete t.orientationArrow;const i=void 0!==t.zoomable||void 0!==t.size;if(void 0!==t.zoomable&&(this._zoomable=t.zoomable),void 0!==t.size&&this._size.copy(t.size),i){const t=(new e.Matrix4).makeScale(this._size.x/2,this._size.y/2,1);this._main.setMatrix(t);const i=t.getMaxScaleOnAxis();this._main.setRatio(this._zoomable?0:i),I.recompileMaterial(this._main.refplane_material)}delete t.size,delete t.zoomable,this._main.setParameters(t)},setNewLook:function(e){this.setParameters({wireframe:!e})},getNewLook:function(){return!this._main.parameters.wireframe},setFixedSize:function(e){this.setParameters({zoomable:!e})},counter_update:function(e){if(!this._enable_refplane_counting)return;if(this._main.parameters.wireframe)return;const t={};for(let i=0;i<this._occurrences.length;i++){const r=this._occurrences[i],n=r.parent;if(!r.scene3js||!n)continue;const a=r.scene3js.viewer;C(r._getVisible(),r._getVisibilityFree(),a.getVisibleSpace(),null,r)&&(e&&e.viewpoint&&e.viewpoint.viewer&&a!==e.viewpoint.viewer||(t[a.id]||(t[a.id]={viewer:a,count:0}),t[a.id].count++,a._refPlaneCounter>100&&this.setParameters({wireframe:!0})))}for(let e in t){const i=t[e],r=i.viewer._refPlaneMap.get(this.id)||0;i.viewer._refPlaneMap.set(this.id,i.count),i.viewer._refPlaneCounter+=i.count-r}},counter_subscribe:function(){this._enable_refplane_counting&&(this.tokenChange=r.subscribe({event:"/VISU/"},(e=>{"@onViewpointChange"===e.eventType&&this.counter_update(e)})),this.counter_update())},counter_unsubscribe:function(){if(!this._enable_refplane_counting)return;r.unsubscribe(this.tokenChange);const e=[];for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t],r=i.parent;if(!i.scene3js||!r)continue;const n=i.scene3js.viewer;n&&e.push(n)}for(let t=0;t<e.length;t++){const i=e[t],r=i._refPlaneMap.get(this.id)||0;i._refPlaneMap.set(this.id,0),i._refPlaneCounter+=0-r}},_onLinkedToSceneGraph:function(){this.counter_subscribe()},_onUnlinkedToSceneGraph:function(){this.counter_unsubscribe()}});const z=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this.matInherit=window.newMaterialInheritance,this.fixedSize=i.fixedSize;var r=this;return this.cbChange=function(e){if(this._newLook){for(var t={},i=0;i<r._occurrences.length;i++){var n=r._occurrences[i],a=n.parent;if(n.scene3js&&a){var o=n.scene3js.viewer;if(C(n._getVisible(),n._getVisibilityFree(),o.getVisibleSpace(),null,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&o!==e.viewpoint.viewer)continue;if(t[o.id]||(t[o.id]={viewer:o,count:0}),t[o.id].count++,o._refPlaneCounter>100){r.setNewLook(!1);continue}var s=o.currentViewpoint;r._updateNode(n,i,e,s)}}}r._updateViewersCount(t)}},this.tokenChange=null,this._length=new e.Vector2(10,10),this._frontBorderMaterial=this._getBorderMaterial({color:new e.Color("green"),opacity:d,lineWidth:2}),this._frontBorder=this._buildEditableRectangle(!0,this._frontBorderMaterial.color,this._frontBorderMaterial.opacity),this.matInherit&&this._frontBorder.setMaterialMode(!0),this._setMaterial(this._frontBorder,"line",this._frontBorderMaterial),this._frontBorder.setShadow(!1),this._frontBorder.setSSAO(!1),this._frontBorder.setFrustumCulled(!1),this._frontBorder.setPickParent(!0),this._frontBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),this._mainNode=new t("RefPlaneNode"),this._mainNode.setPickParent(!0),this._mainNode.setPickingPriorityId({faces:"RefPlanePickPriority",edges:"RefPlanePickPriority",points:"RefPlanePickPriority"}),this._advanced=null,this._newLook=void 0===i.newLook||i.newLook,this._setNewLook(this._newLook),this._currentParams=null,this.setParameters(i),this._mainNode.addChild(this._frontBorder),this._updateFixedSizeProperties(this._advanced),this.addChild(this._mainNode),this},_createTextNodes:function(e){e._frontTextNode=new t,e._backTextNode=new t,e._fixedSizeFrontText=new n({name:"fixedSizeNodeFrontText",ratio:1}),e._fixedSizeFrontText._autoUpdate=!1,e._fixedSizeBackText=new n({name:"fixedSizeNodeBackText",ratio:1}),e._fixedSizeBackText._autoUpdate=!1,e._fixedSizeFrontText.setPickable(a.NOPICKABLE),e._fixedSizeBackText.setPickable(a.NOPICKABLE),this.fixedSize?(e._subNode=new n({name:"FixedSizeForText",ratio:1}),e._subNode.addChild(e._frontTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._subNode.addChild(e._backTextNode),e._backTextNode.addChild(e._fixedSizeBackText),this._mainNode.addChild(e._subNode)):(this._mainNode.addChild(e._frontTextNode),this._mainNode.addChild(e._backTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._backTextNode.addChild(e._fixedSizeBackText))},_removeTextNodes:function(e){e._frontTextNode&&(this.fixedSize?(e._subNode.removeChild(e._frontTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._subNode.removeChild(e._backTextNode),e._backTextNode.removeChild(e._fixedSizeBackText),this._mainNode.removeChild(e._subNode)):(this._mainNode.removeChild(e._frontTextNode),this._mainNode.removeChild(e._backTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._backTextNode.removeChild(e._fixedSizeBackText)),e._subNode=null,e._frontTextNode=null,e._backTextNode=null,e._fixedSizeFrontText=null,e._fixedSizeBackText=null)},_initAdvancedNodes:function(e){this._mainNode.addChild(e._frontPlane),this._mainNode.addChild(e._backPlane),this._mainNode.addChild(e._backBorder),this._mainNode.addChild(e._xArrowIndicatorFront),this._mainNode.addChild(e._xArrowIndicatorBack),e._xArrowIndicatorFront.setRatio(20),e._xArrowIndicatorBack.setRatio(20),this._updateFixedSizeProperties(this._advanced)},_initAdvancedParameters:function(t){t._frontPlaneMaterial=this._getPlaneMaterial({color:new e.Color("green"),opacity:l,side:0});var i=t._frontPlaneMaterial.color.getHSL();n=i.h+20/255,a=Math.min(1,1.3*i.l),t._backPlaneMaterial=this._getPlaneMaterial({color:(new e.Color).setHSL(n,i.s,a),opacity:l,side:1});var r=this._frontBorderMaterial.color.getHSL(),n=r.h+20/255,a=Math.min(1,1.3*r.l);t._backBorderMaterial=this._getBorderMaterial({color:(new e.Color).setHSL(n,r.s,a),opacity:d,lineWidth:2}),t._margin=.02,t._frontText={data:"",color:new e.Color("green"),opacity:u,size:.5,token:null},t._backText={data:"",color:new e.Color("green"),opacity:u,size:.5,token:null},t._frontPlane=this._buildEditableRectangle(!1,t._frontPlaneMaterial.color,t._frontPlaneMaterial.opacity),this.matInherit&&t._frontPlane.setMaterialMode(!0),this._setMaterial(t._frontPlane,"face",t._frontPlaneMaterial),t._frontPlane.setShadow(!1),t._frontPlane.setSSAO(!1),t._frontPlane.setFrustumCulled(!1),t._frontPlane.setPickParent(!0),t._frontPlane.excludeFromHighlight(!0,!0),t._backPlane=this._buildEditableRectangle(!1,t._backPlaneMaterial.color,t._backPlaneMaterial.opacity),this.matInherit&&t._backPlane.setMaterialMode(!0),this._setMaterial(t._backPlane,"face",t._backPlaneMaterial),t._backPlane.setShadow(!1),t._backPlane.setSSAO(!1),t._backPlane.setFrustumCulled(!1),t._backPlane.setPickParent(!0),t._backPlane.excludeFromHighlight(!0,!0),t._backBorder=this._buildEditableRectangle(!0,t._backBorderMaterial.color,t._backBorderMaterial.opacity),this.matInherit&&t._backBorder.setMaterialMode(!0),this._setMaterial(t._backBorder,"line",t._backBorderMaterial),t._backBorder.setShadow(!1),t._backBorder.setSSAO(!1),t._backBorder.setFrustumCulled(!1),t._backBorder.setPickParent(!0),t._backBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),t._xArrowIndicatorFront=this._buildXIndicator(),t._xArrowIndicatorFront.setShadow(!1),t._xArrowIndicatorFront.setSSAO(!1),t._xArrowIndicatorFront.excludeFromHighlight(!0,!0),t._xArrowIndicatorBack=this._buildXIndicator(),t._xArrowIndicatorBack.setShadow(!1),t._xArrowIndicatorBack.setSSAO(!1),t._xArrowIndicatorBack.excludeFromHighlight(!0,!0),t._displayArrowOrientation=!0,this.matInherit&&t._xArrowIndicatorFront.setMaterialMode(!0),this._setMaterial(t._xArrowIndicatorFront,"face",this._getXIndicatorMaterial({color:t._frontPlaneMaterial.color})),this.matInherit&&t._xArrowIndicatorBack.setMaterialMode(!0),this._setMaterial(t._xArrowIndicatorBack,"face",this._getXIndicatorMaterial({color:t._backPlaneMaterial.color}))},_updateFixedSizeProperties:function(t){const i=this.fixedSize?1:0;this._frontBorder.setRatio(i),t&&t._backBorder&&t._backBorder.setRatio(i),t&&t._frontPlane&&t._frontPlane.setRatio(i),t&&t._backPlane&&t._backPlane.setRatio(i);const r=new e.Vector3(.5*this._length.x,0,0),n=t=>{t.setMatrix(this.fixedSize?null:(new e.Matrix4).setPosition(r)),t.setFixedSizeCenter(this.fixedSize?r:new e.Vector3)};t&&t._xArrowIndicatorFront&&n(t._xArrowIndicatorFront),t&&t._xArrowIndicatorBack&&n(t._xArrowIndicatorBack)},setFixedSize:function(e){if((e=!!e)===this.fixedSize)return;const t=this._advanced;t&&this._removeTextNodes(t),this.fixedSize=e;t&&(t._frontText&&""!==t._frontText.data||t._backText&&""!==t._backText.data)&&(this._createTextNodes(t),this._createTextTokens(t),this.fixedSize?t._subNode&&t._subNode.setVisibility(this._newLook):(t._frontTextNode&&t._frontTextNode.setVisibility(this._newLook),t._backTextNode&&t._backTextNode.setVisibility(this._newLook),t._xArrowIndicatorFront.setVisibility(this._newLook),t._xArrowIndicatorBack.setVisibility(this._newLook))),this._updateFixedSizeProperties(t)},_setNewLook:function(e){var t=this._advanced;if(e&&!t&&(t=new D,this._advanced=t,this._initAdvancedParameters(t),this._initAdvancedNodes(t)),this._resetOccurrenceVisibility(this._frontBorder),this._frontBorder.setVisibility(!0),t){const i=[t._backBorder,t._frontPlane,t._backPlane,t._frontTextNode,t._backTextNode,t._xArrowIndicatorFront,t._xArrowIndicatorBack];for(let t=0;t<i.length;t++){const r=i[t];if(!r)return;this._resetOccurrenceVisibility(r),r.setVisibility(e)}}this.fixedSize?t&&t._subNode&&t._subNode.setVisibility(e):t&&(t._frontTextNode&&t._frontTextNode.setVisibility(e),t._backTextNode&&t._backTextNode.setVisibility(e),t._xArrowIndicatorFront.setVisibility(e),t._xArrowIndicatorBack.setVisibility(e)),e&&this._currentParams&&(this.setParameters(this._currentParams),this._currentParams=null)},setNewLook:function(e){this._newLook!==e&&(this._newLook=e,this._setNewLook(e))},getNewLook:function(){return this._newLook},_getBorderMaterial:function(e){return N.get({...e,force:!this.matInherit})},_getPlaneMaterial:function(e){return A.get({...e,force:!this.matInherit})},_getXIndicatorMaterial:function(e){return k.get({...e,force:!this.matInherit})},_setMaterial:function(e,t,i){if(e.getMaterial()!==i)if(this.matInherit){const r=new s({layer:0,[`${t}Material`]:i});e.setMaterialApplication(r)}else e.setMaterial(i)},_updateTextPosition:function(e,t,i,r){const n=void 0===t,a=!n&&t;let o=0,s=0;if(e){const t=e.camera;var c=this._advanced._subNode?this._advanced._subNode._occurrences[r].matrix:this._occurrences[r].matrix;c.extractBasis(f,g,x),f.multiplyScalar(.5*this._length.x),g.multiplyScalar(.5*this._length.y),v.getPositionFromMatrix(c),w.addVectors(f,g),w.negate(),w.addVectors(w,v),S.subVectors(f,g),S.addVectors(S,v),y.addVectors(f,g),y.addVectors(y,v),b.subVectors(g,f),b.addVectors(b,v);const i=[e.project(w,t),e.project(S,t),e.project(y,t),e.project(b,t)];for(let e=0;e<i.length;e++){const t=i[e],r=i[(e+1)%i.length].x-t.x;r<=s||(o=e,s=r)}}var h=o%2?this._length.y:this._length.x,l=o%2?this._length.x:this._length.y;if(n||a){_.makeRotationAxis(m,.5*Math.PI*o),_.translate(v.set(-(.5-this._advanced._margin)*h,-(.5-this._advanced._margin)*l,0));var d=this._advanced._frontTextNode._occurrences[r];d._relativeMatrix?d._relativeMatrix.copy(_):d._relativeMatrix=_.clone()}if(n||!a){_.makeRotationAxis(m,Math.PI+.5*Math.PI*o),_.rotateY(Math.PI),_.translate(v.set(-(.5-this._advanced._margin)*h,-(.5-this._advanced._margin)*l,0));var u=this._advanced._backTextNode._occurrences[r];u._relativeMatrix?u._relativeMatrix.copy(_):u._relativeMatrix=_.clone()}return s},_setParametersOld:function(e){e.size&&(this._length.copy(e.size),this._updateRectangleSize(this._frontBorder));var t=e.borderAttributes;if(t&&t.front){var i=void 0!==t.front.color?t.front.color:this._frontBorderMaterial.color,r=void 0!==t.front.opacity?t.front.opacity:this._frontBorderMaterial.opacity,n=void 0!==t.front.width?t.front.width:this._frontBorderMaterial.lineWidth;this._frontBorderMaterial=this._getBorderMaterial({color:i,opacity:r,lineWidth:n}),this._setMaterial(this._frontBorder,"line",this._frontBorderMaterial)}},_createTextTokens:function(e){""!==e._frontText.data&&(e._frontText.token=o.createTextNode({name:"_refplaneitem_",text:e._frontText.data,font:"Trebuchet MS",fontSize:e._frontText.size,color:e._frontText.color,opacity:e._frontText.opacity,depthWrite:!1}),e._frontText.token.children[0].excludeFromHighlight(!0,!0),e._fixedSizeFrontText.addChild(e._frontText.token)),""!==e._backText.data&&(e._backText.token=o.createTextNode({name:"_refplaneitem_",text:e._backText.data,font:"Trebuchet MS",fontSize:e._backText.size,color:e._backText.color,opacity:e._backText.opacity,depthWrite:!1}),e._backText.token.children[0].excludeFromHighlight(!0,!0),e._fixedSizeBackText.addChild(e._backText.token))},setParameters:function(t){if(this._currentParams=t,this.setFixedSize(t.fixedSize),this._newLook){var i=this._advanced;t.size&&(this._length.copy(t.size),this._updateRectangleSize(i._frontPlane),this._updateRectangleSize(i._backPlane),this._updateRectangleSize(this._frontBorder),this._updateRectangleSize(i._backBorder));var r=t.planeAttributes;if(r){if(r.front){var n=void 0!==r.front.color?r.front.color:i._frontPlaneMaterial.color,a=void 0!==r.front.opacity?r.front.opacity:i._frontPlaneMaterial.opacity;if(this._setMaterial(i._xArrowIndicatorFront,"face",this._getXIndicatorMaterial({color:n})),i._frontPlaneMaterial=this._getPlaneMaterial({color:n,opacity:a,side:0}),this._setMaterial(i._frontPlane,"face",i._frontPlaneMaterial),!r.back||!r.back.color){var o=n.getHSL(),s=o.h+20/255,c=Math.min(1,1.3*o.l),h=(new e.Color).setHSL(s,o.s,c);this._setMaterial(i._xArrowIndicatorBack,"face",this._getXIndicatorMaterial({color:h})),i._backPlaneMaterial=this._getPlaneMaterial({color:h,opacity:i._backPlaneMaterial.opacity,side:1}),this._setMaterial(i._backPlane,"face",i._backPlaneMaterial)}}if(r.back){n=void 0!==r.back.color?r.back.color:i._backPlaneMaterial.color,a=void 0!==r.back.opacity?r.back.opacity:i._backPlaneMaterial.opacity;this._setMaterial(i._xArrowIndicatorBack,"face",this._getXIndicatorMaterial({color:n})),i._backPlaneMaterial=this._getPlaneMaterial({color:n,opacity:a,side:1}),this._setMaterial(i._backPlane,"face",i._backPlaneMaterial)}}var l=t.borderAttributes;if(l){if(l.front){n=void 0!==l.front.color?l.front.color:this._frontBorderMaterial.color,a=void 0!==l.front.opacity?l.front.opacity:this._frontBorderMaterial.opacity;var d=void 0!==l.front.width?l.front.width:this._frontBorderMaterial.lineWidth;if(this._frontBorderMaterial=this._getBorderMaterial({color:n,opacity:a,lineWidth:d}),this._setMaterial(this._frontBorder,"line",this._frontBorderMaterial),!l.back||!l.back.color){var u=n.getHSL();s=u.h+20/255,c=Math.min(1,1.3*u.l),h=(new e.Color).setHSL(s,u.s,c);i._backBorderMaterial=this._getBorderMaterial({color:h,opacity:i._backBorderMaterial.opacity,lineWidth:i._backBorderMaterial.lineWidth}),this._setMaterial(i._backBorder,"line",i._backBorderMaterial)}}if(l.back){n=void 0!==l.back.color?l.back.color:i._backBorderMaterial.color,a=void 0!==l.back.opacity?l.back.opacity:i._backBorderMaterial.opacity,d=void 0!==l.back.width?l.back.width:i._backBorderMaterial.lineWidth;i._backBorderMaterial=this._getBorderMaterial({color:n,opacity:a,lineWidth:d}),this._setMaterial(i._backBorder,"line",i._backBorderMaterial)}}var p=""!==i._frontText.data||""!==i._backText.data,_=t.textAttributes;if(_){_.front&&(void 0!==_.front.data&&(i._frontText.data=_.front.data),void 0!==_.front.size&&(i._frontText.size=_.front.size),void 0!==_.front.opacity&&(i._frontText.opacity=_.front.opacity),void 0!==_.front.color&&i._frontText.color.copy(_.front.color)),_.back&&(void 0!==_.back.data&&(i._backText.data=_.back.data),void 0!==_.back.size&&(i._backText.size=_.back.size),void 0!==_.back.opacity&&(i._backText.opacity=_.back.opacity),void 0!==_.back.color&&i._backText.color.copy(_.back.color)),p&&(i._frontText&&i._frontText.token&&i._fixedSizeFrontText.removeChild(i._frontText.token),i._backText&&i._backText.token&&i._fixedSizeBackText.removeChild(i._backText.token));var m=""!==i._frontText.data||""!==i._backText.data;!p&&m&&this._createTextNodes(i),p&&!m&&this._removeTextNodes(i),this._createTextTokens(i)}void 0!==t.orientationArrow&&i._displayArrowOrientation!==t.orientationArrow&&(t.orientationArrow?(this._mainNode.addChild(i._xArrowIndicatorFront),this._mainNode.addChild(i._xArrowIndicatorBack)):(this._mainNode.removeChild(i._xArrowIndicatorFront),this._mainNode.removeChild(i._xArrowIndicatorBack)),i._displayArrowOrientation=t.orientationArrow),this._updateFixedSizeProperties(i)}else this._setParametersOld(t)},_updateViewersCount:function(e){for(var t in e){var i=e[t],r=i.viewer._refPlaneMap.get(this.id);void 0===r&&(r=0),i.viewer._refPlaneMap.set(this.id,i.count),i.viewer._refPlaneCounter+=i.count-r}},_updateCount:function(e){for(var t={},i=0;i<this._occurrences.length;i++){var r=this._occurrences[i],n=r.parent;if(r.scene3js&&n){var a=r.scene3js.viewer;a&&(t[a.id]||(t[a.id]={viewer:a,count:0}),e?t[a.id].count=0:t[a.id].count++)}}this._updateViewersCount(t)},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=r.subscribe({event:"/VISU/"},(function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)})),this.cbChange()},_onUnlinkedToSceneGraph:function(){r.unsubscribe(this.tokenChange),this._updateCount(!0)},_getDynamicMatrix:function(){return null},_resetOccurrenceVisibility:function(e){for(var i=0;i<e._occurrences.length;i++){var r=e._occurrences[i];r._relativeVisibility=null,r.parent&&this._updateOccurrences(r.parent,r,t.UpdateMatrixMode.Always,!0,t.InvalidateGSSOMode.Never)}},_setOccurrenceVisibility:function(e,i,r,n){var a=i?1:0;if(r||e._relativeVisibility!==a){e._relativeVisibility=a;var o=n||e;this._updateOccurrences(o.parent,o,t.UpdateMatrixMode.Always,!0,t.InvalidateGSSOMode.Never)}},_updateNode:function(e,t,i,r){var n=this._advanced,a=r||i.viewpoint,o=a.getEyePosition(),s=e.matrix.elements;M.set(s[12],s[13],s[14]),T.subVectors(o,M),T.normalize(),P.set(s[8],s[9],s[10]);var c=T.dot(P)>0,h=""!==n._frontText.data||""!==n._backText.data;let l;h&&(l=this._updateTextPosition(a,c,e,t)),this._setOccurrenceVisibility(this._frontBorder._occurrences[t],c),this._setOccurrenceVisibility(n._backBorder._occurrences[t],!c);var d=!1;if(h){var u=c?n._fixedSizeFrontText:n._fixedSizeBackText,p=c?n._backText.token:n._frontText.token,_=c?n._frontText.token:n._backText.token,m=c?n._backTextNode:n._frontTextNode,f=c?n._frontTextNode:n._backTextNode,g=(p._occurrences[t],_._occurrences[t]),x=m._occurrences[t],v=f._occurrences[t];this._setOccurrenceVisibility(x,!1,!1,x),u.cbChange();var w=!1;if(u._bsShow||u.getBoundingSphere(),this.fixedSize)w=1.414*(u._bsShow?u._bsShow.radius*u.getRatio():0)<=(n._frontPlane.explicitBSphere?n._frontPlane.explicitBSphere.radius*n._frontPlane.getRatio():0);else w=!u._bsShow||2*u._bsShow.radius*u.getScaleFactor(t)<.9*Math.min(this._length.x,this._length.y);v._relativeVisibility=1,this._setOccurrenceVisibility(g,w,!0,v),d=d||w}if(n._displayArrowOrientation){const e=c?n._xArrowIndicatorFront:n._xArrowIndicatorBack,i=c?n._xArrowIndicatorBack:n._xArrowIndicatorFront;var S=1;this.fixedSize||(S=a.camera.getWorldSizeFromPixelSize(1,M,a.viewer._getDivClientHeight(),2));var y=20*S<.3*Math.min(this._length.x,this._length.y);this._setOccurrenceVisibility(e._occurrences[t],y),this._setOccurrenceVisibility(i._occurrences[t],!1)}n._subNode&&n._subNode.setVisibility(d)},_buildXIndicator:function(){var e=new a.PrimitiveGroup;e.fillAttr=new a.FillAttributes;var t=new a.Buffer({component:a.VertexComponentEnum.POSITION,data:new Float32Array(9)}),i=new a.Buffer({component:a.VertexComponentEnum.NORMAL,data:new Float32Array(9)});e.addBuffer(0,t),e.addBuffer(1,i);var r=t.data,n=0;r[n++]=-1,r[n++]=-.3,r[n++]=0,r[n++]=-.25,r[n++]=0,r[n++]=0,r[n++]=-1,r[n++]=.3,r[n++]=0,r=i.data,n=0;for(var s=0;s<3;s++)r[n++]=0,r[n++]=0,r[n++]=1;var c=new a.Primitive({nbIndices:3,connectivity:a.ConnectivityTypeEnum.TRIANGLES,fillGAS:new a.FillAttributes}),h=new a.VertexComponent({nbVertices:3,bufferId:0}),l=new a.VertexComponent({nbVertices:3,bufferId:1});c.addVertexComponent(h),c.addVertexComponent(l),e.addPrimitive(c);var d=o.createMeshNode(e,p);return d.name="_refplaneitem_",d},_buildEditableRectangle:function(e,t,i){var r=new a.PrimitiveGroup;r.editable=!0,r.fillAttr=new a.FillAttributes,r.lineAttr=new a.LineAttributes,r.pointAttr=new a.PointAttributes;var n=new a.Buffer({component:a.VertexComponentEnum.POSITION,data:new Float32Array(12)}),s=new a.Buffer({component:a.VertexComponentEnum.NORMAL,data:new Float32Array(12)}),c=new a.Buffer({indexBuffer:!0,data:new Uint16Array(e?8:6)});r.addBuffer(0,n),r.addBuffer(1,s),r.addBuffer(2,c);var h=c.data,l=0;e?(h[0]=0,h[1]=1,h[2]=1,h[3]=2,h[4]=2,h[5]=3,h[6]=3,h[7]=0):(h[l++]=0,h[l++]=1,h[l++]=2,h[l++]=0,h[l++]=2,h[l++]=3),l=0,(h=n.data)[l++]=.5*this._length.x,h[l++]=-.5*this._length.y,h[l++]=0,h[l++]=.5*this._length.x,h[l++]=.5*this._length.y,h[l++]=0,h[l++]=-.5*this._length.x,h[l++]=.5*this._length.y,h[l++]=0,h[l++]=-.5*this._length.x,h[l++]=-.5*this._length.y,h[l++]=0,h=s.data,l=0;for(var d=0;d<4;d++)h[l++]=0,h[l++]=0,h[l++]=1;var u=new a.Primitive({nbIndices:e?8:6,connectivity:e?a.ConnectivityTypeEnum.LINES:a.ConnectivityTypeEnum.TRIANGLES,fillGAS:new a.FillAttributes(new a.Color(t.r,t.g,t.b,i)),lineGAS:new a.LineAttributes(new a.Color(t.r,t.g,t.b,i))}),_=new a.VertexComponent({nbVertices:4,bufferId:0,indices:new a.IndexArray({bufferId:2,offset:0})}),m=new a.VertexComponent({nbVertices:4,bufferId:1,indices:new a.IndexArray({bufferId:2,offset:0})});u.addVertexComponent(_),u.addVertexComponent(m),r.addPrimitive(u);var f=o.createMeshNode(r,p);return f.name="_refplaneitem_",f},_updateRectangleSize:function(t){var i=t.getBuffer(a.VertexComponentEnum.POSITION);i[0]=.5*this._length.x,i[1]=-.5*this._length.y,i[3]=.5*this._length.x,i[4]=.5*this._length.y,i[6]=-.5*this._length.x,i[7]=.5*this._length.y,i[9]=-.5*this._length.x,i[10]=-.5*this._length.y,t.updateBuffer(a.VertexComponentEnum.POSITION,0,4);var r=Math.sqrt(.25*this._length.x*this._length.x+.25*this._length.x*this._length.x),n=new e.Sphere(new e.Vector3(0,0,0),r),o=new e.Box3(new e.Vector3(-.5*this._length.x,-.5*this._length.y,0),new e.Vector3(.5*this._length.x,.5*this._length.y,0));t.forceBoundingElements(!0,{sphere:n,box:o})}});return UWA.namespace("THREEDS/Nodes/RefPlaneNode",z)})),define("DS/SceneGraphNodes/CurvedPipeBatchDummyNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/InstancedCurvedPipeManager"],(function(e,t,i,r){"use strict";var n=t.extend({init:function(t){this._name=t.name||"curvedPipeBatchDummy",this._pipes=[],this._maxRadius=0,this.dummyGeom=new e.BufferGeometryDS;for(var n=0,a=new Map,o=0;o<t.curvedPipes.length;o++){var s=t.curvedPipes[o],c=!!s.material,h=s.gas.id;c&&(h+="_"+s.material.id);var l=a.get(h);if(void 0===l){l=n,a.set(h,n++);var d=new i.DrawingGroup(s.gas,c?s.material:null,4);this.dummyGeom.drawingGroups.push(d)}this._pipes.push({curvePoints:s.curvePoints,radius:s.radius,baseNormal:s.baseNormal.normalize(),endNormal:s.endNormal.normalize(),baseSideVector:s.baseSideVector.normalize(),material:c?s.material:null,gas:s.gas,dgId:l}),s.radius>this._maxRadius&&(this._maxRadius=s.radius)}var u=new e.CurvedPipeMesh(this.dummyGeom);u.castShadow=!0,u._capWorldRadius=this._maxRadius,u._nbLODsMinusOne=r._nbLODs-1,this._parent(u);var p=this._curvedPipeBBox();return this.forceBoundingBox(p),this},createRenderable:function(){var e=this._parent();return e.isCurvedPipe=!0,e},setMaterial:function(e,t){this._parent(t);for(var i=this._occurrences.length,r=0;r<i;r++)this._occurrences[r].renderable.material=t},setMatrix:function(e){this._parent(e);for(var t=this._occurrences.length,i=null,n=0;n<t;n++)i=this._occurrences[n].renderable,r.setMatrixOnCurvedPipe(i),i._capWorldRadius=this._maxRadius*i.matrixWorld.getMaxScaleOnAxis()},_curvedPipeBBox:function(){for(var t=new e.Vector3(1/0,1/0,1/0),i=new e.Vector3(-1/0,-1/0,-1/0),r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,o=new e.Vector3,s=new e.Vector3,c=new e.Vector3,h=new e.Vector3,l=new e.Vector3,d=null,u=0;u<this._pipes.length;u++)for(var p=this._pipes[u].curvePoints,_=this._pipes[u].radius,m=p.length/3-1,f=0;f<m;f++){n.set(p[3*f],p[3*f+1],p[3*f+2]),a.set(p[3*f+3],p[3*f+4],p[3*f+5]),r.subVectors(a,n);var g=r.dot(r);o.set(_*Math.sqrt(1-r.x*r.x/g),_*Math.sqrt(1-r.y*r.y/g),_*Math.sqrt(1-r.z*r.z/g)),s.subVectors(n,o),h.subVectors(a,o),s.min(h),c.addVectors(n,o),l.addVectors(a,o),c.max(l),d=new e.Box3(s,c),t.min(d.min),i.max(d.max)}var x=(new e.Vector3).addVectors(t,i).multiplyScalar(.5),v=(new e.Vector3).addVectors(x,(new e.Vector3).subVectors(t,x).multiplyScalar(1.05)),w=(new e.Vector3).addVectors(x,(new e.Vector3).subVectors(i,x).multiplyScalar(1.05));return new e.Box3(v,w)},_onLinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,n=0;n<t;n++){i=e[n].renderable;for(var a=0;a<this._pipes.length;a++){var o=this._pipes[a];r.addCurvedPipe(i,o.dgId,o.radius,o.curvePoints,o.baseNormal,o.endNormal,o.baseSideVector)}}},_onUnlinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,n=0;n<t;n++)i=e[n].renderable,r.removeCurvedPipe(i,this)},setName:function(e){this._name=e},getNodeType:function(){return"Mesh3D"}});return UWA.namespace("THREEDS/Nodes/CurvedPipeBatchDummyNode",n)})),define("DS/SceneGraphNodes/ArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],(function(e,t,i,r,n,a,o,s,c){"use strict";var h=new e.Vector3,l=new e.Matrix4,d=new e.Matrix4,u=new e.Matrix4,p=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this._headLength=i.headLength?i.headLength:20,this.viewpoint=i.viewpoint,this._initialPoint=i.initialPoint,this._finalPoint=i.finalPoint,this._head=i.head?i.head:0,this._noZ=!i.removeNoZ,this.direction=(new e.Vector3).subVectors(this._finalPoint,this._initialPoint),this.constraintAxis=(new e.Vector3).copy(this.direction).normalize(),this.arrowLength=this.direction.length();var r=a.getWebappsAssetUrl("SceneGraphNodes","");this.mapHead=new e.ImageUtils.loadTexture(r+"models/textures/head.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadDisk=new e.ImageUtils.loadTexture(r+"models/textures/headDisk.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadSquare=new e.ImageUtils.loadTexture(r+"models/textures/headSquare.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadCross=new e.ImageUtils.loadTexture(r+"models/textures/headCross.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHead.anisotropy=8,this.materialArrow=new e.LineBasicMaterial({side:e.DoubleSide,color:i.color,scale:i.arrowScale?i.arrowScale:6.666,lineWidth:i.arrowWidth?i.arrowWidth:1,dashType:i.arrowDashType?i.arrowDashType:"None",linecap:"butt",transparent:!0,isCPUPattern:!0,alphaTest:.05}),this.materialArrow.force=!0,this.materialHead=new e.MeshBasicMaterial({map:null,side:e.DoubleSide,color:i.color,transparent:!0,alphaTest:.05}),this.materialHead.force=!0;var o=new s;this.nodeArrowBody=c.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],material:this.materialArrow,layerNb:this._noZ?1:0}),this.nodeArrowBody.setShadow(!1),this.nodeArrowBody.setFrustumCulled(!1),this.nodeArrowBody.setPickParent(!0),this.nodeArrowBody.name="tronc de la flche";var h={constraintAxis:this.constraintAxis,name:"billBoardNode_body",type:"Cylindrical",viewpoint:this.viewpoint};this.billBoardArrowBody=new n(h),this.billBoardArrowBody.addChild(this.nodeArrowBody),this.billBoardArrowBody.setPickParent(!0),this.addChild(this.billBoardArrowBody);var l=o.createRectangle({width:1,height:1,fill:!0,fillColor:null,noEdge:!0,layerNb:this._noZ?1:0});this.nodeArrowHead=c.createMeshNode(l,this.materialHead),this.nodeArrowHead.setShadow(!1),this.nodeArrowHead.setFrustumCulled(!1),this.nodeArrowHead.setPickParent(!0),this.nodeArrowHead.name="tte de la flche",this.billBoardArrowHead=new n({name:"billBoardNode_head",viewpoint:this.viewpoint}),this.billBoardArrowHead.addChild(this.nodeArrowHead),this.billBoardArrowHead.setPickParent(!0),this.nodeArrowHeadParent=new t,this.nodeArrowHeadParent.setPickParent(!0),this.addChild(this.nodeArrowHeadParent),this.nodeArrowHeadParent.addChild(this.billBoardArrowHead),this._updateData(),this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this.name="CustomizableArrow";var d=this;return this.cbChange=function(e){d.viewpoint&&d.viewpoint!==e.viewpoint||"@onViewpointChange"===e.eventType&&d._CallBackEventHandler(e)},this.tokenChange=null,this},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(e,t,i){return this._CallBackEventHandler(t,i),this.getMatrix()},_CallBackEventHandler:function(e,t){var i=this.getMatrixWorld().getMaxScaleOnAxis();h.getPositionFromMatrix(this.nodeArrowHead.getMatrixWorld());var r=t||e.viewpoint,n=1/(i/r.camera.getWorldSizeFromPixelSize(1,h,r.viewer._getDivClientHeight(),2))*(this._head?this._headLength:0),a=this._head>=2?this.arrowLength:this.arrowLength-n;l.makeScale(n,n,n),d.makeScale(1,1,a),1===this._head?(this.nodeArrowHeadParent.setMatrix(u),h.set(-n/2,0,0),this.nodeArrowHead.setMatrix(l.rotateX(.5*Math.PI).setPosition(h)),h.copy(this.constraintAxis).multiplyScalar(a),l.identity(),this.nodeArrowHeadParent.setMatrix(l.setPosition(h))):2!==this._head&&3!==this._head&&4!==this._head||(h.set(-n/2,-n/2,0),this.nodeArrowHead.setMatrix(l.setPosition(h)),h.copy(this.constraintAxis).multiplyScalar(a),l.identity(),this.nodeArrowHeadParent.setMatrix(l.setPosition(h))),this.nodeArrowBody.setMatrix(d),this.billBoardArrowBody.cbChange(e),this.billBoardArrowHead.cbChange(e)},updateInitialPosition:function(t){this._initialPoint=t,this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateFinalPosition:function(e){this._finalPoint=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateColor:function(e){this.materialArrow.color=e,this.materialHead.color=e},setArrowWidth:function(e){this.materialArrow.setLineWidth(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPattern:function(e){this.materialArrow.setDashPatternType(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPatternScale:function(e){this.materialArrow.setScale(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadSize:function(e){this._headLength=e,this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadType:function(e){this._head=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},getNodeType:function(){return"ArrowNode"},_updateData:function(){switch(this.direction.subVectors(this._finalPoint,this._initialPoint),this.constraintAxis.copy(this.direction).normalize(),this.arrowLength=this.direction.length(),this.billBoardArrowBody.setConstraintAxis(this.constraintAxis),this._head){case 0:this.billBoardArrowHead.setVisibility(!1),this.billBoardArrowHead.setVisibilityFree(!0);break;case 1:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setConstraintAxis(this.constraintAxis),this.billBoardArrowHead.setBillboardType("PseudoSpherical"),this.materialHead.map=this.mapHead;break;case 2:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadDisk;break;case 3:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadSquare;break;case 4:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadCross}this.materialHead._invalidateDisplayRangeLists(),this.materialHead.updateDeferredMaterials()}});return p.types={NONE:0,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/ArrowNode",p)})),define("SceneGraphNodes/ArrowNode",["DS/SceneGraphNodes/ArrowNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/ArrowNode"),e})),define("DS/SceneGraphNodes/AreaLightNode",["DS/SceneGraphNodes/RectangleLightNode"],(function(e){"use strict";return console.warn("Deprecated module, please use RectangleLightNode instead"),UWA.namespace("THREEDS/Nodes/AreaLight",e)})),define("SceneGraphNodes/AreaLightNode",["DS/SceneGraphNodes/AreaLightNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/AreaLightNode"),e})),define("DS/SceneGraphNodes/AxisSystemNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/ArrowNode"],(function(e,t,i,r,n,a,o,s,c,h){"use strict";var l=t.extend({init:function(t){this._parent(t.name),this._sgRep=t.sgRep?t.sgRep:null,this.headLength=t.headLength,this.arrowLength=t.arrowLength,this.arrowWidth=t.arrowWidth,this.sceneGraph=t.sceneGraph,this.viewpoint=t.viewpoint,this.zoomable=t.zoomable||!1,this._colorX=new o.Color(1,0,0),this._colorY=new o.Color(0,1,0),this._colorZ=new o.Color(0,0,1),t.colors&&(this._colorX=t.colors.colorX?t.colors.colorX:this._colorX,this._colorY=t.colors.colorY?t.colors.colorY:this._colorY,this._colorZ=t.colors.colorZ?t.colors.colorZ:this._colorZ),this._nameX="X",this._nameY="Y",this._nameZ="Z",t.names&&(this._nameX=t.names.nameX?t.names.nameX:this._nameX,this._nameY=t.names.nameY?t.names.nameY:this._nameY,this._nameZ=t.names.nameZ?t.names.nameZ:this._nameZ),this.head=t.head;var i={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorZ,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameZ,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},r=null;this.zoomable?(i.initialPoint=new e.Vector3,i.finalPoint=new e.Vector3(0,0,this.arrowLength),r=new h(i)):r=new c(i);var n={sceneGraph:this.sceneGraph,headLength:this.headLength,direction:new e.Vector3(1,0,0),color:this._colorX,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameX,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},a=null;this.zoomable?(n.initialPoint=new e.Vector3,n.finalPoint=new e.Vector3(this.arrowLength,0,0),a=new h(n)):(a=new c(n)).setMatrix((new e.Matrix4).rotateY(Math.PI/2));var s={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorY,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameY,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},l=null;return this.zoomable?(s.initialPoint=new e.Vector3,s.finalPoint=new e.Vector3(0,this.arrowLength,0),l=new h(s)):(l=new c(s)).setMatrix((new e.Matrix4).rotateX(-Math.PI/2)),this.addChild(l),this.addChild(a),this.addChild(r),this.setNoZ(!0),this},getNodeType:function(){return"AxisSystemNode"},getSGRep:function(){return this._sgRep}});return l.types={NONE:null,ARROW:1,DISK:2},UWA.namespace("THREEDS/Nodes/AxisSystemNode",l)})),define("SceneGraphNodes/AxisSystemNode",["DS/SceneGraphNodes/AxisSystemNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/AxisSystemNode"),e})),define("DS/SceneGraphNodes/CSS2DNodeManager",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/SceneGraphNodes/CSS2DNode"],(function(e,t,i,r,n){"use strict";return e.extend({options:{},init:function(e){this.billboards=[],this._divLayers=[],this.mainLayer=document.createElement("div"),this.mainLayer.id="HTMLBillboards",e.divCss2DElement.appendChild(this.mainLayer),this.viewer=e,this.rank=4,this._subscribe(),this.update()},add:function(e,t){if(!(e instanceof n))return error.log("This is not a CSS2DNode");e.rank=t&&t.rank||0,e.vanish=t&&t.vanish||!1,this.billboards.push(e),this._divLayers[e.rank]||(this._divLayers[e.rank]=document.createElement("div"),this._divLayers[e.rank].id="layer-"+e.rank,this.mainLayer.appendChild(this._divLayers[e.rank])),this._divLayers[e.rank].appendChild(e.css2DNode.element),this.update()},remove:function(e){-1!==this.billboards.indexOf(e)&&this.billboards.splice(this.billboards.indexOf(e),1)},update:function(){this.cameraPosition=this.viewer.viewpoints[0].camera.position;var e=this.viewer.getSceneBoundingSphere();this.centerScene=e.center,this.fadingDistance=e.radius;var t=0,i=this.billboards.length;for(t=0;t<i;++t)this._follow3D(this.billboards[t]);this._zIndexManager()},_subscribe:function(){var e=this;t.subscribe({event:"/VISU/"},(function(t){"@onViewpointChange"===t.eventType&&e.update.call(e)})),t.subscribe({event:"/VISU/onWindowResized"},(function(t){e.update.call(e)}))},_follow3D:function(e){if(e.css2DNode.visible){if(e.css2DNode.element.style.display="initial",e.rank>this.rank)return void(e.css2DNode.element.style.display="none");if(e.vanish){var t=1-(e.css2DNode.position.clone().distanceTo(this.cameraPosition)-5*this.fadingDistance)/(15*this.fadingDistance-5*this.fadingDistance);t<0?e.css2DNode.element.style.display="none":t<1&&(e.css2DNode.element.style.opacity=t)}}},_zIndexManager:function(){var e=this.cameraPosition;this.billboards.sort((function(t,i){return e.distanceTo(i.css2DNode.position)-e.distanceTo(t.css2DNode.position)}));var t=0,i=this.billboards.length;for(t=0;t<i;++t)this.billboards[t].css2DNode.element.style["z-index"]=t}})})),define("SceneGraphNodes/CSS2DNodeManager",["DS/SceneGraphNodes/CSS2DNodeManager","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNodeManager"),e})),define("DS/SceneGraphNodes/AnnotationText",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Viewpoint","DS/Visualization/GeometryHelper","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/GraphicAttributeSet","DS/SceneGraphNodes/BillBoardNode3D","DS/CoreEvents/Events"],(function(e,t,i,r,n,a,o,s,c){"use strict";new e.Projector,new e.Vector3,new e.Matrix4,new e.Matrix4,new e.Matrix4;var h=e.__visibleInCurrentSpace,l=function(t,i,r){if(t){var n=0,a=0,o=1,s=0;switch(i){case 0:case 2:a=1,o=0;break;case 1:case 3:n=1,s=e.COLORMAP_INDEX.BACKGROUND,o=1;break;case 4:r?(n=1,s=e.COLORMAP_INDEX.BACKGROUND,o=1):(a=1,o=0)}return{useColorForText:a,useColorForBackground:n,textColorIndex:s,backgroundOpacity:o}}},d=t.extend({init:function(t){this._parent(t.name),this.height=t.height,this.ready=!1,this.initialize=!1,this.mipMaps=[],this.nbTexturesLoaded=0,this.nbTexturesToLoad=0,this.currentRatio=0,this.realTextHeight=0,this.anchor=t.anchor?t.anchor:0,this.point=t.point?new e.Vector3(t.point.x,t.point.y,t.point.z):new e.Vector3;var i=this;this.viewer=t.viewer,this.contour=t.contour,this.billBoardNode=null,this.quadNode=null,this.textPrimitive=null,this.backgroundPrimitive=null,this.textMaterial=null,this.backgroundMaterial=null,this.gasTransition=t.gasTransition,this.descent=t.descent||0;var r=e.NoOccurrences;return this.viewer&&this.viewer.currentViewpoint&&(this.realTextHeight=this._getRealTextHeight(null,this.viewer.currentViewpoint)),this.cbChange=function(e){if(!r&&i._occurrences)for(var t=0;t<i._occurrences.length;t++){var n=i._occurrences[t],a=n.parent;if(n.scene3js){var o=n.scene3js.viewer;if(h(n._getVisible(),n._getVisibilityFree(),o.getVisibleSpace(),void 0,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&o!==e.viewpoint.viewer)continue;var s=null;if(e){if(!e.viewpoint)return;if((o._viewpointManager.getViewpointScenegraph(e.viewpoint)||o.internalSceneGraph).root3js!=n.scene3js)return;s=e.viewpoint}else o&&(s=n._getViewpoint()||o.currentViewpoint);s&&(i.ready?i.immediateDraw2DAnnotationText(a.matrix,s):this.realTextHeight=this._getRealTextHeight(a.matrix,s))}}}},this.tokenChange=null,this},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=c.subscribe({event:"/VISU/"},(function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)})),this.cbChange()},_onUnlinkedToSceneGraph:function(){c.unsubscribe(this.tokenChange)},getFontIndex:function(e){if(0===this.height&&this.mipMaps.length>0)return this.mipMaps.length>1?this.mipMaps.length-2:this.mipMaps.length-1;for(var t=0,i=1;i<this.mipMaps.length;i++)e>=this.mipMaps[i].image.height&&(t=i);return t},setMipmaps:function(t){this.nbTexturesToLoad=t.length,this.mipMaps=t,this.nbTexturesLoaded=0;for(var i=this,r=function(){if(i.nbTexturesLoaded++,i.nbTexturesToLoad==i.nbTexturesLoaded){i.ready=!0;var e=i.getFontIndex(i.realTextHeight);e>i.mipMaps.length-1&&(e=i.mipMaps.length-1),e<0&&(e=0),i.currentRatio=e,i.updateMipMaps(),i.viewer&&i.viewer.render()}},n=0;n<t.length;n++)t[n]instanceof e.Texture&&(t[n].loadEndStatus!==e.AssetLoadingStatus.READY?t[n].onLoadCallbacks.push(r):r(),t[n].minFilter=e.NearestFilter,t[n].magFilter=e.NearestFilter)},setPosition:function(e){this.point=e},getNodeType:function(){return"AnnotationText"},_createMaterial:function(t,i,r,n){var a=new e.MaterialUtils.createMatteFaceMaterial;a.transparent=!0,a.side=e.DoubleSide,a.force=!0,a.useLighting=!1,a.useGASColor=!0,a.activatePDSFX("PDSFXAnnotationText");a.setPDSFXVaryings({vTexCoord:{type:"v3"}});var o=r?t.useColorForText:t.useColorForBackground,s={annotColor:{type:"v4",value:new e.Vector4(1)},opacityBack:{type:"f",value:n},drawText:{type:"f",value:r},useGASColorAnnot:{type:"f",value:o},textMask:{type:"t2",value:i}};a.setPDSFXUniforms(s);return a.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                            ${i="vTexCoord",e.getVarying(i)} = ${e.vGetAttribTexCoord0()}.xyz;\n                        `;var i}},{ComputeDiscard:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions,n=t=>e.getUniform(t);return`\n                            ${a="maskValue",i.vec4(a)}  = ${r.sample2DTexture((t=>e.getTextureUniform(t))("textMask"),`${(t=>e.getVarying(t))("vTexCoord")}.xy`)};\n\n                            \n                            return ( (${n("drawText")} == 0.0 && maskValue.r >0.10) ||  (${n("drawText")} == 1.0 && maskValue.r < 0.80) || (${n("opacityBack")} == 0.0));\n                        `;var a},ProcessFinalColor:function(e,t){return`\n                        //ioFinalColor.rgb = (ioFinalColor.rgb * useGASColorAnnot) + ((1.0 -useGASColorAnnot)* annotColor.rgb);\n                        ${e.variableHandler.dereference(t[0])}.a = 1.0 * ${i="opacityBack",e.getUniform(i)};                      \n                        `;var i}}),a.needsUpdate=!0,a.force=!0,a},_createGeometry:function(e,t,i,r){var o=new n.PrimitiveGroup;o.editable=!0,o.fillAttr=new n.FillAttributes,o.lineAttr=new n.LineAttributes,o.pointAttr=new n.PointAttributes;var s=new n.Buffer;s.size=12,s.component=n.VertexComponentEnum.POSITION,s.format=n.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size);var c=new n.Buffer;c.size=12,c.component=n.VertexComponentEnum.NORMAL,c.format=n.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size);var h=new n.Buffer;h.indexBuffer=!0,h.size=6,h.format=n.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(6);var l=new n.Buffer;l.size=12,l.component=n.VertexComponentEnum.TEX_COORD_0,l.format=n.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(l.size),o.addBuffer(0,s),o.addBuffer(1,c),o.addBuffer(2,h),o.addBuffer(3,l),h.data[0]=0,h.data[1]=1,h.data[2]=2,h.data[3]=0,h.data[4]=2,h.data[5]=3,s.data[0]=e,s.data[1]=t,s.data[2]=0,s.data[3]=i,s.data[4]=t,s.data[5]=0,s.data[6]=i,s.data[7]=r,s.data[8]=0,s.data[9]=e,s.data[10]=r,s.data[11]=0;var d=c.data,u=0;d[u++]=0,d[u++]=0,d[u++]=1,d[u++]=0,d[u++]=0,d[u++]=1,d[u++]=0,d[u++]=0,d[u++]=1,d[u++]=0,d[u++]=0,d[u++]=1,u=0,(d=l.data)[u++]=0,d[u++]=0,d[u++]=0,d[u++]=1,d[u++]=0,d[u++]=0,d[u++]=1,d[u++]=1,d[u++]=0,d[u++]=0,d[u++]=1,d[u++]=0;var p=new n.Primitive;p.nbIndices=6,p.connectivity=n.ConnectivityTypeEnum.TRIANGLES,p.geomType="FACE",p.material=this.textMaterial;var _=new n.Primitive;_.nbIndices=6,_.connectivity=n.ConnectivityTypeEnum.TRIANGLES,_.geomType="FACE",_.material=this.backgroundMaterial;var m=new n.VertexComponent;m.component=n.VertexComponentEnum.POSITION,m.nbVertices=4,m.nbValuesPerVertex=3,m.format=n.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=0,m.indices=new n.IndexArray,m.indices.format=n.DataTypeEnum.UINT,m.indices.bufferId=2,m.indices.offset=0;var f=new n.VertexComponent;f.component=n.VertexComponentEnum.NORMAL,f.nbVertices=4,f.nbValuesPerVertex=3,f.format=n.DataTypeEnum.FLOAT,f.cardinality=0,f.bufferId=1,f.indices=new n.IndexArray,f.indices.format=n.DataTypeEnum.UINT,f.indices.bufferId=2,f.indices.offset=0;var g=new n.VertexComponent;g.component=n.VertexComponentEnum.TEX_COORD_0,g.nbVertices=4,g.nbValuesPerVertex=3,g.format=n.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=3,g.indices=new n.IndexArray,g.indices.format=n.DataTypeEnum.UINT,g.indices.bufferId=2,g.indices.offset=0,p.addVertexComponent(m),p.addVertexComponent(f),p.addVertexComponent(g),_.addVertexComponent(m),_.addVertexComponent(f),_.addVertexComponent(g),o.addPrimitive(p),o.addPrimitive(_),this.quadNode=a.createMeshNode(o);var x=this.quadNode.getPrimitives();x.length&&2!==x.length&&console.warn("Error during initializers of annotation Text"),this.textPrimitive=x[0],this.backgroundPrimitive=x[1],this.quadNode.setRatio(1),this.quadNode.setMaterialMode(!0)},_updateGeometry:function(e,t,i,r){var a=this.quadNode.getBuffer(n.VertexComponentEnum.POSITION);a[0]=i,a[1]=r,a[3]=i+e,a[4]=r,a[6]=i+e,a[7]=r+t,a[9]=i,a[10]=r+t,this.quadNode.updateBuffer(n.VertexComponentEnum.POSITION,0,4)},_getRealTextHeight:function(e,t){if(t.isNative2D()){var r=this.height,n=t.getPixelFromModelRatio();this.realTextHeight=1*r/n}else this.realTextHeight=this.height/function(e,t){var r=1;if(e.getProjectionType()==i.PERSPECTIVE){var n=e.getEyePosition(),a=e.getSightDirection();r=a.x*(t.x-n.x)+a.y*(t.y-n.y)+a.z*(t.z-n.z)}else r=e.control.distanceToTarget;return Math.abs(r)*e.getScaleFactor()}(t,this.point);return this.realTextHeight},updateMipMaps:function(){this.initialize=!0;var t=this.mipMaps[this.currentRatio],i=t.image.height,r=t.image.width,n=(this.point.x,this.point.y,0),a=0,o=this.anchor;void 0!==o&&(o!=e.AnchorPoint.BOTTOM_CENTER&&o!=e.AnchorPoint.BASE_CENTER&&o!=e.AnchorPoint.TOP_CENTER||(n-=.5*r),o!=e.AnchorPoint.BOTTOM_RIGHT&&o!=e.AnchorPoint.BASE_RIGHT&&o!=e.AnchorPoint.TOP_RIGHT||(n-=r),o!=e.AnchorPoint.BOTTOM_LEFT&&o!=e.AnchorPoint.BOTTOM_CENTER&&o!=e.AnchorPoint.BOTTOM_RIGHT||(a+=this.descent),o!=e.AnchorPoint.TOP_LEFT&&o!=e.AnchorPoint.TOP_CENTER&&o!=e.AnchorPoint.TOP_RIGHT||(a+=this.descent-i)),a-=this.descent;var c=l(this.viewer.getRenderer(),this.contour,this.viewer.currentViewpoint.isNative2D());if(this.backgroundMaterial||this.textMaterial)this._updateMaterials(c,this.mipMaps[this.currentRatio]);else{this.backgroundMaterial=this._createMaterial(c,this.mipMaps[this.currentRatio],0,c.backgroundOpacity),this.textMaterial=this._createMaterial(c,this.mipMaps[this.currentRatio],1,1);var h=this;const e=this.viewer;e.onColorMapUpdated((function(){var t=l(e.getRenderer(),h.contour,e.currentViewpoint.isNative2D());h._updateMaterials(t,h.mipMaps[h.currentRatio])}))}if(this.quadNode)this._updateGeometry(r,i,n,a);else{this._createGeometry(n,a,n+r,a+i);var d=(new e.Matrix4).setPosition(this.point);this.billBoardNode=new s({type:"Spherical"}),this.billBoardNode.setMatrix(d),this.billBoardNode.addChild(this.quadNode),this.quadNode._setGAS(this.gasTransition),this.billBoardNode._setGAS(this.gasTransition),this.addChild(this.billBoardNode)}this._setPrimitivesGas(c)},_setPrimitivesGas:function(t){var i=this.gasTransition,r=this.gasTransition;t.useColorForText||(i=new o({basic:!0,colorIndex:t.textColorIndex,inheritanceCustom:e.GASEnumCustom._TYPE_FROM_PARENT})),this.quadNode._setGAS([this.textPrimitive],i),this.quadNode._setGAS([this.backgroundPrimitive],r)},_updateMaterials:function(e,t){this.backgroundMaterial.updatePDSFXUniform("opacityBack",e.backgroundOpacity),this.backgroundMaterial.updatePDSFXUniform("useGASColorAnnot",e.useColorForBackground),this.backgroundMaterial.updatePDSFXUniform("textMask",t),this.textMaterial.updatePDSFXUniform("useGASColorAnnot",e.useColorForText),this.textMaterial.updatePDSFXUniform("textMask",t),this.backgroundMaterial.needsUpdate=!0,this.textMaterial.needsUpdate=!0},immediateDraw2DAnnotationText:function(e,t){var i=this._getRealTextHeight(e,t),r=this.getFontIndex(i);r>this.mipMaps.length-1&&(r=this.mipMaps.length-1),r<0&&(r=0),this.currentRatio===r&&this.initialize||(this.currentRatio=r,this.updateMipMaps())}});return UWA.namespace("THREEDS/Nodes/AnnotationText",d)})),define("SceneGraphNodes/AnnotationText",["DS/SceneGraphNodes/AnnotationText","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("SceneGraphNodes/AnnotationText"),e})),define("DS/SceneGraphNodes/FixedSizePlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],(function(e,t,i,r,n,a,o,s,c){"use strict";var h=t.extend({init:function(i){this._parent(i.name),this.setColor(i.color),this.setName(i.name);var r=i.length1?i.length1:10,n=i.length2?i.length2:10,a=i.origin?i.origin:new e.Vector3,o=i.direction1?i.direction1.normalize():new e.Vector3(0,1,0),s=i.direction2?i.direction2.normalize():new e.Vector3(1,0,0),h=(new e.Vector3).crossVectors(o,s),l=c.createRectangleNode({color:this._color,width:r,height:n,fill:i.fill,sharing:i.sharing,cornerPoint:new e.Vector2(-r/2,-n/2)});l.setShadow(!1),l.setFrustumCulled(!1);var d=new e.Matrix4;d.makeBasis(o,s,h),d.setPosition(a);var u=new t("NodeForPlane");return u.setMatrix(d),u.addChild(l),this.addChild(u),u._setRatio(1),this},setColor:function(e){this._color=e},setName:function(e){this._name=e}});return UWA.namespace("THREEDS/Nodes/FixedSizePlaneNode",h)}));