define("DS/DMUPersistence/DMUMarkupContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter"],(function(e){"use strict";let t=!1;return e.extend({getSharedContextualMenuCommandList:function(e){var t=[];return e&&e.length&&e.forEach((function(e){-1===t.indexOf(e.getType())&&("DMUMarkup"===e.getType()?t.push(e.getType()):e.isReadOnly()||t.push(e.getType()))})),1===t.length&&"DMUMarkup"===t[0]?this.getContextualMenuCommandList(e):[]},getContextualMenuCommandList:function(){var e=[],o=[];if(this.getMarkupOwner()&&!this.getMarkupOwner().isReadOnly()||!this.getMarkupOwner()&&!this.isReadOnly()?t?o.push("DMUReviewMarkupHdr","DMURenameMarkupHdr","DMUEditPropertiesHdr","DMUDeleteHdr"):e=[{line:1,name:"DMUReviewMarkupStr",hdr_list:["DMUReviewMarkupHdr"]},{line:1,name:"DMURenameMarkupStr",hdr_list:["DMURenameMarkupHdr"]},{line:1,name:"DMUEditPropertiesStr",hdr_list:["DMUEditPropertiesHdr"]},{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}]:t?o.push("DMUEditPropertiesHdr"):e=[{line:1,name:"DMUEditPropertiesStr",hdr_list:["DMUEditPropertiesHdr"]}],t){for(let t=0;t<o.length;t++)e.push({type:"WAfrDefaultHandlerItem",handlerId:o[t]});return e}return e},register:function(e){e.frmWindow&&(t=Boolean(e.frmWindow.getExecutionContext)),this._parent({frmWindow:e.frmWindow,contextualMenu:{type:"DMUMarkup",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:{type:"DMUMarkup",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})}})})),define("DS/DMUPersistence/DMURenameMarkupCmd",["DS/CATWebUXComponents/DMUCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewController","DS/Selection/CSOManager"],(function(e,t,o,r,i,n,a){"use strict";return e.extend({init:function(e){e.mode="shared",e.repeatMode=!1,e.isAsynchronous=!0,this._parent(e);var s=this;this.beginExecute=function(){var e=a.get(),l=t.getReviewContext({viewer:s.getFrameWindow().getViewer()});if(l){if(1===e.length&&e[0].pathElement.getLastElement(!0).getDMUType&&"DMUMarkup"===e[0].pathElement.getLastElement(!0).getDMUType()){let t,a=l.getValidation();if(a&&a.getMarkups().some((o=>{let r=o.getRepRef();if(r.getMarkupContent()&&r.getMarkupContent().getNode()===e[0].pathElement.getLastElement(!0))return t=r,!0})),t){var d=r.giveDMUSlidesController({context:s.getFrameWindow()});d&&d.editMarkupName(t);const e=n.giveDMUReviewController({context:s.getFrameWindow()});e&&e.editMarkupName(t);let a=o.getManager({name:"DMU2DSheetManager",context:s.getFrameWindow()});if(a&&("Requirement"===a.getDocumentType()||"Document"===a.getDocumentType())){let e=i.giveDMUCommentsController({context:s.getFrameWindow()});e&&e.editMarkupName(t)}}}s.end&&s.end(),s.done()}else s.end()}}})})),define("DS/DMUPersistence/DMUSaveServices",["require","exports","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPUtils","DS/DMUBaseExperience/DMUModelServices"],(function(e,t,o,r,i,n){"use strict";let a,s;return class{static isCreatingAMarkup(e){a=e}static isProcessing(){return a||s}static saveCurrent3DMarkup(e){return new Promise(((t,a)=>{e&&e.frmWindow&&i.isPersistenceAllowed({onPersistenceAllowed:async function(){var i;s=!0;let l=null,d=r.getReviewContext({viewer:e.frmWindow.getViewer()}),c=d?d.getCurrentSessionMarkup():null;if(c){let t;if(e.superType&&("SIMItfSimulation"===e.superType||"Document"===e.superType)||"Specification Report"===e.superType){t={Version:"1.0",Contexts:[],Model:[]};let o=await n.getObjectDefinition(c);t.Model.push(o),null===(i=t.Contexts)||void 0===i||i.push({superType:e.superType,documentType:e.documentType,listData:e.listData,loadingInfos:e.loadingInfos,documentVersionInfos:e.documentVersionInfos})}else{t={Version:"1.0",Model:[]},c.getApplicativeContext()&&Object.keys(c.getApplicativeContext()).length>0&&(t.ApplicativeContext=c.getApplicativeContext());let e=await n.getObjectDefinition(c);t.Model.push(e)}c.setDirtyFlag(!1),l=JSON.stringify(t)}if(l){let r=new o,i=null==d?void 0:d.getReviewCtxInformation();if(i){let o,n={json:l,reviewPhysicalId:i.reviewId,markupName:i.reviewName,markupType:i.reviewType,newFile:"boolean"==typeof e.newFile?e.newFile:void 0};o="Markup"===i.reviewType?r.updateReviewAndJSONFile:r.updateMarkupStream,o(n,(function(e){i&&(null==d||d.setReviewCtxInformation({contextId:i.contextId,subContext:i.subContext,subContextId:i.subContextId,reviewId:e.reviewId,reviewName:e.reviewName,reviewDescription:i.reviewDescription,reviewType:e.reviewType,modifiable:i.modifiable,owner:i.owner,tempObjectInfo:i.tempObjectInfo})),s=!1,t()}),(function(){s=!1,null==c||c.setDirtyFlag(!0),a(new Error("Error at save current markup"))}))}else null==c||c.setDirtyFlag(!0),s=!1,t()}else s=!1,t()},onPersistenceNotAllowed:function(){a(new Error("Error at save current markup: Persistence is not allowed"))}})}))}}})),define("DS/DMUPersistence/DMUMarkupMaturityChangeCmd",["require","exports","DS/CATWebUXComponents/DMUCommand","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DMUBaseExperience/DMUContextManager"],(function(e,t,o,r,i){"use strict";return class extends o{beginExecute(){const e=this.getFrameWindow().getViewer();let t=this,o=i.getReviewContext({viewer:e});const n=o&&o.getReviewCtxInformation();let a=o&&o.getCurrentSessionMarkup();if(!a||!n)return void(this.end?this.end():this.done());let s=i.getEventsController({viewer:e});window.require(["DS/MaturityWidget/MaturityWidget"].concat([]),(function(e){let o;o&&o.dialog&&o.dialog.destroy(),o=new e({externalSettings:r.getOption("platform_services")}),o.addEvent("onMaturityCanceled",(function(){t.cancel()})),o.addEvent("onMaturityTransitionEnd",(function(e){if(e&&e.data&&e.data.length>0&&a){for(let t=0;t<e.data.length;t++)if(e.data[t]&&e.data[t].physicalid===n.reviewId&&e.data[t].tostate){a.setMaturityState(e.data[t].tostate),s&&s.fireEvent("onMarkupObjectAttributesModified",{object:a,attr:[{currentState:e.data[t].tostate}]});break}t.end()}else t.end()})),r.getServerContext({onComplete:function(e){o.executeCmd([{physicalid:n.reviewId,tenant:r.getTenant()}],{context:{getSecurityContext:()=>({SecurityContext:e})}},(()=>{}))},onFailure:function(){}})})),this.done()}}})),define("DS/DMUPersistence/DMUDOSThumbnailServices",["DS/WAFData/WAFData","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting"],(function(e,t){"use strict";return class{static saveObjectThumbnail(o,r,i){return new Promise((n=>{const a=i+"_thb";(function(o,r){return new Promise(((i,n)=>{t.sendWebServiceCall({url:"resources/markup/service/getDosUploadTicket",config:{verb:"POST",data:JSON.stringify({sBucketName:o,sTenant:t.getTenant(),sFileId:r})},onSuccess:function(t){e.authenticatedRequest(JSON.parse(t).result,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:function(e){i(JSON.parse(e))},onFailure:function(e){n(e)}})}})}))})(o,a).then((e=>{const o=e.ticket,i=e.url;if(o&&i){const e=new Image;e.src=r,e.onload=function(){const r=document.createElement("canvas"),s=r.getContext("2d");r.width=144,r.height=108,s.drawImage(e,0,0),r.toBlob((function(e){var r;(r={file:e,ticket:o,URL:i,fileName:a},new Promise((function(e){var t=new FormData;t.append("__fcs__jobTicket",r.ticket),t.append("imageFile",r.file,r.fileName);var o=new XMLHttpRequest;o.open("POST",r.URL,!0),o.onload=function(){200===o.status&&e(o.responseText)},o.send(t)}))).then((function(e){e&&function(e){return new Promise((o=>{t.sendWebServiceCall({url:"resources/markup/service/getDosCommit",config:{verb:"POST",data:JSON.stringify({sTenant:t.getTenant(),sReceipt:e})},onSuccess:function(e){o(e)}})}))}(e.replace(/\n/g,"")).then((()=>{n()}))}))}))}}})).catch((e=>{window.console.log(e)}))}))}static deleteMarkupThumbnail(e,o){!function(e,o){new Promise((r=>{t.sendWebServiceCall({url:"resources/markup/service/deleteFile",config:{verb:"POST",data:JSON.stringify({sBucketName:e,sFileId:o,sTenant:t.getTenant()})},onSuccess:function(e){r(e)}})}))}(e,o+"_thb")}}})),define("DS/DMUPersistence/DMUPersistence",[],(function(){})),define("DS/DMUPersistence/DMUAuthPersistenceUtils",["UWA/Utils","DS/DMUBaseExperience/DMUModelServices","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet"],(function(e,t,o,r,i){"use strict";return{getTransientMarkersAndOverloads:async function(e,i,n){var a={overloads:[],markers:[]};if(!i||!n)return a;let s=r.giveEventsController({viewer:i.getViewer()});s&&s.fireEvent("onBeginDMUObjectDuplication");var l=o.getDMUSceneDisplayController({context:i});if((!e||e&&!e.getCurrentSessionMarkup()||e&&e.getCurrentSessionMarkup()&&!e.getCurrentSessionMarkup().isVisible())&&(a.overloads=l.getDisplayedAndHiddenOccurrences(n)),e){var d=e.getTransientReviewBag(),c=d.getDMUObjects("DMUCompare3D");if(c.length||(c=d.getDMUObjects("DMUCompare2D")),c.length>=1){let t=(c=c[0]).getParent().getAttribute("oLinksManager"),o=c.getAttribute("oSelections"),r=[],a=l.getCurrentCompareBalance();if(t&&o){for(let e=0;e<o.length;e++){let n=t.getChildWithID(o[e].id);if(n){let e=n.idPath&&n.idPath.length?n.idPath:t.getOccurrenceIdPath(n.path);if(e&&e.length){let t=i.getController().isFiltered(e[0]);r.push(t&&t.hasFilter&&t.filterId?t.filterId:e[0])}}}let s=e.getReviewCtxInformation()?e.getReviewCtxInformation().contextId:null;i.getApplicativeData()&&i.getApplicativeData().getLoadedItfData&&i.getApplicativeData().getLoadedItfData()&&i.getApplicativeData().getLoadedItfData().data&&i.getApplicativeData().getLoadedItfData().data.length&&(s=i.getApplicativeData().getLoadedItfData().data[0].prd[0]?i.getApplicativeData().getLoadedItfData().data[0].prd[0]:s),-1===r.indexOf(n)&&-1===r.indexOf(s)?d.removeDMUObjects("DMUCompare3D"):r[1]===n&&(c.setAttribute("oSelections",[o[1],o[0]]),a=100-a)}c.setAttribute("fBalance",a),c.setAttribute("bLocalAxis",l.getCurrentLocalAxisValue())}var p=d.getDMUObjects();if(p)for(var g=0;g<p.length;g++)if(p[g]){let e=await t.getObjectDefinition(p[g]);a.markers.push(e)}}return o.unreferenceDMUSceneDisplayController({context:i}),a},copyTransientMarkersAndOverloads:async function(t,n,a,s,l){if(!t||!n||!a)return;if(s.length){var d=i.getManager({name:"DMUUserExperienceManager",context:a.getFrameWindow()});d&&await d.duplicateDMUElements({elementDefinitions:s,parent:n,cb:function(o){if(o&&o.duplicatedElements)for(var r=0;r<o.duplicatedElements.length;r++)o.duplicatedElements[r].setAttributes([{name:"sID",value:t.computeNewID()},{name:"sUuid",value:e.getUUID()}])}})}var c=o.giveDMUSceneDisplayController({context:a});if(l&&c){var p,g,u=[],h=function(e,o){(p=t.getOrCreateOccurrenceOverloader(e,!0))&&(u.push({target:p,state:{bVisible:o}}),n.addObjectOverload({target:p,state:{bVisible:o}}))};l.hidden&&(l.hidden.paths.forEach((function(e){h({pathElement:e},!1)})),l.hidden.idPaths.forEach((function(e){(g=e.slice())[0]===a.getController().getRootBagId()&&g.splice(0,1),h({idPath:g},!1)}))),l.shown&&(l.shown.paths.forEach((function(e){h({pathElement:e},!0)})),l.shown.idPaths.forEach((function(e){(g=e.slice())[0]===a.getController().getRootBagId()&&g.splice(0,1),h({idPath:g},!0)}))),u.length&&n.fireEvent("onDMUOverloadPropertiesChanged",{overloads:u})}let D=r.giveEventsController({viewer:a.getViewer()});D&&D.fireEvent("onDMUObjectDuplicated")}}})),define("DS/DMUPersistence/DMUErrorClasses",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExportCancel=t.ExportError=void 0;class o extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,o.prototype),t&&(this.cause=t)}}t.ExportError=o;class r extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,r.prototype),t&&(this.cause=t)}}t.ExportCancel=r})),define("DS/DMUPersistence/DMUExportServices",["require","exports","DS/Visualization/ThreeJS_DS","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DocumentManagement/DocumentManagement","DS/WAFData/WAFData","DS/DMUBaseUIControllers/DMUSlidesController","UWA/Core","DS/Controls/ProgressBar","DS/Controls/Button","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/EXPUtils","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUMarker","DS/DMUPlayMarker/DMUCommentAnnotationBase","DS/DMUBaseUI/DMUToolsUsers","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUPersistence/DMUErrorClasses","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],(function(e,t,o,r,i,n,a,s,l,d,c,p,g,u,h,D,M,f,x,m){"use strict";const y={ENOR3D_AP:"ENOVIA - 3D Markup",ENOR3R_AP:"ENOVIA - Design Review",ENOR3V_AP:"ENOVIA - Design Validation"},w={DMUMarker3DRectangle:"Square",DMUMarker3DCircle:"Circle",DMUMarker3DText:"FreeText",DMUMarker2DText:"FreeText",DMUMarker3DStamp:"FreeText",DMUMarker3DEllipse:"Circle",DMUMarker3DLine:"Line",DMUMarker3DSpline:"Ink",DMUMarker3DFreehand:"Ink",DMUMarker3DCloud:"Polygon",DMUMarker3DArrow:"Line",DMUCommentHighlight:"Highlight",DMUCommentPositioned:"Text",DMUMarker3DPicture:"FileAttachment",DMUMarker2DPicture:"FileAttachment"},P={processed:"Completed",withdrawn:"Cancelled",accepted:"Accepted",rejected:"Rejected"};let b;const S=function(e){const t=`<p>${window.require("DS/DMUBaseUIComponents/DMURichTextServices").formatRichTextToExportToPDF(e)}</p>`;let o=document.createElement("div");o.innerHTML=t;const r=o.innerText;return{richContent:`<?xml version="1.0"?><body xmlns="http://www.w3.org/1999/xhtml" xmlns:xfa="http://www.xfa.org/schema/xfa-data/1.0/" xfa:APIVersion="3DExperience:24.1" xfa:spec="2.4" xfa:contentType="text/html">${o.innerHTML}</body>`,flatContent:r}};let v=function(e,t,o){var r,i;let n;if(o){let a={x:0,y:0},s={x:0,y:0},l=Math.atan2(o.y-e.leaderPosition[1],o.x-e.leaderPosition[0]);let d=4*e.lineThickness;a.x=e.leaderPosition[0]+d*Math.cos(l-Math.PI/6),a.y=e.leaderPosition[1]+d*Math.sin(l-Math.PI/6),s.x=e.leaderPosition[0]+d*Math.cos(l+Math.PI/6),s.y=e.leaderPosition[1]+d*Math.sin(l+Math.PI/6);let c=e.leaderEndType,p=e.hasLeader;if("OpenArrow"===c&&b&&p)n=[b.setGraphicsState("GS0"),b.setFillingRgbColor(e.borderColor.r,e.borderColor.g,e.borderColor.b),b.setStrokingRgbColor(e.borderColor.r,e.borderColor.g,e.borderColor.b),b.setLineWidth(t.border?t.border.thickness:1),b.setDashPattern(t.border&&t.border.pattern?t.border.pattern:[],0),b.moveTo(e.leaderPosition[0],e.leaderPosition[1]),b.lineTo(a.x,a.y),b.lineTo(s.x,s.y),b.lineTo(e.leaderPosition[0],e.leaderPosition[1]),b.closePath(),b.fill()].filter(Boolean);else if("Square"===c&&b&&p){let o=(null===(r=t.border)||void 0===r?void 0:r.thickness)?t.border.thickness+5:5;n=b.drawRectangle({x:e.leaderPosition[0]-o/2,y:e.leaderPosition[1]-o/2,width:o,height:o,borderWidth:0,borderColor:e.borderColor?b.rgb(e.borderColor.r,e.borderColor.g,e.borderColor.b):void 0,rotate:b.radians(0),xSkew:b.radians(0),ySkew:b.radians(0),color:e.borderColor?b.rgb(e.borderColor.r,e.borderColor.g,e.borderColor.b):void 0,graphicsState:"GS0"})}else if("Bubble"===c&&b&&p){let o=(null===(i=t.border)||void 0===i?void 0:i.thickness)?t.border.thickness:2.5;n=b.drawEllipse({x:e.leaderPosition[0],y:e.leaderPosition[1],xScale:o,yScale:o,borderColor:e.borderColor?b.rgb(e.borderColor.r,e.borderColor.g,e.borderColor.b):void 0,borderWidth:0,color:e.borderColor?b.rgb(e.borderColor.r,e.borderColor.g,e.borderColor.b):void 0,graphicsState:"GS0"}),n.splice(n.length-2,0,b.closePath())}else"Cross"===c&&b&&p?(n=[b.setGraphicsState("GS0"),b.setFillingRgbColor(e.borderColor.r,e.borderColor.g,e.borderColor.b),b.setStrokingRgbColor(e.borderColor.r,e.borderColor.g,e.borderColor.b),b.setLineWidth(1),b.setDashPattern([],0),b.moveTo(e.leaderPosition[0]-5,e.leaderPosition[1]-5),b.lineTo(e.leaderPosition[0]+5,e.leaderPosition[1]+5),b.moveTo(e.leaderPosition[0]-5,e.leaderPosition[1]+5),b.lineTo(e.leaderPosition[0]+5,e.leaderPosition[1]-5),b.stroke()].filter(Boolean),n.splice(n.length-2,0,b.closePath())):n=[]}else n=[];return n};class C{static prepareAnnotationDefinition(e,t,r,i,n){let a=c.getMMPerPtRatio();r.border&&(r.border={...r.border,thickness:r.border.thickness*a,pattern:r.border.pattern?r.border.pattern.map((e=>e*a)):void 0});let s,l,d,p,g,u,h,D,M,f,x,m,y=0,w=0,P=0,b="DMUMarker2DPicture"===t.type||"DMUMarker2DText"===t.type;if(i&&("DMUMarker3DSpline"===t.type||"DMUMarker3DFreehand"===t.type||"DMUMarker3DCloud"===t.type)){let e=[];if("DMUMarker3DSpline"===t.type||"DMUMarker3DFreehand"===t.type||"DMUMarker3DCloud"===t.type){if(t.points.forEach((t=>{let r=c.getViewerPositionFromPoint(n,new o.Vector3(t.x,t.y,t.z));r&&e.push({x:r.left*i,y:-r.top*i})})),t.points=e,"DMUMarker3DCloud"===t.type){let e=new o.Vector3(t.position.x,t.position.y,t.position.z);e=c.getViewerPositionFromPoint(n,e),e=new o.Vector2(e.left*i,-e.top*i),t.arcPoints=t.arcPoints.map((r=>({x:c.convertModelToPixels({sizeInMM:r.x-t.position.x,viewer:n,coords:new o.Vector3(t.position.x,t.position.y,t.position.z)})*i+e.x,y:c.convertModelToPixels({sizeInMM:r.y-t.position.y,viewer:n,coords:new o.Vector3(t.position.x,t.position.y,t.position.z)})*i+e.y})))}t.points=e,t.rect.width=c.convertModelToPixels({sizeInMM:t.rect.width,viewer:n,coords:new o.Vector3(t.position.x,t.position.y,t.position.z)})*i,t.rect.height=c.convertModelToPixels({sizeInMM:t.rect.height,viewer:n,coords:new o.Vector3(t.position.x,t.position.y,t.position.z)})*i}}const S=e.getRotation();S&&S.angle&&(P="degrees"===S.type?S.angle*Math.PI/180:S.angle);const v=e.getHeight()*(Math.cos(P)-Math.sin(P)+1)/2,C=e.getWidth()*(1-Math.cos(P)-Math.sin(P))/2;"position"in t&&(b?(t.position.x=t.position.x*(i||1),t.position.y=-t.position.y*(i||1)):(s=i?new o.Vector3(t.position.x,t.position.y,t.position.z):void 0,l=i?c.getViewerPositionFromPoint(n,s):t.position,i&&l&&l.left&&l.top&&(t.position.x=l.left*i,t.position.y=-l.top*i)),t.position={x:(t.position.x*Math.cos(P)-t.position.y*Math.sin(P))*a+C,y:(t.position.x*Math.sin(P)+t.position.y*Math.cos(P))*a+v}),"rotationAngle"in t&&(t.rotationAngle=(t.rotationAngle||0)+P),"DMUMarker3DRectangle"===t.type?(t.width=i?c.convertModelToPixels({sizeInMM:t.width,viewer:n,coords:s})*i:t.width,t.height=i?c.convertModelToPixels({sizeInMM:t.height,viewer:n,coords:s})*i:t.height,t.width=t.width*a,t.height=t.height*a):"DMUMarker3DText"===t.type||"DMUMarker3DStamp"===t.type?(t.fontSize=t.fontSize*a,t.offwidth=i?t.width*a*i:t.offwidth*a,t.offheight=t.offheight*a,i&&(d=c.getViewerPositionFromPoint(n,t.leaderPosition[0]),t.leaderPosition[0]={x:d.left*i,y:-d.top*i},p=c.getViewerPositionFromPoint(n,t.leaderPosition[1]),t.leaderPosition[1]={x:p.left*i,y:-p.top*i},u=c.getViewerPositionFromPoint(n,t.leaderPosition[2]),t.leaderPosition[2]={x:u.left*i,y:-u.top*i},g=c.getViewerPositionFromPoint(n,t.leaderPosition[3]),t.leaderPosition[3]={x:g.left*i,y:-g.top*i}),y=t.leaderPosition[0].x,w=t.leaderPosition[0].y,t.leaderPosition[0].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[0].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[1].x,w=t.leaderPosition[1].y,t.leaderPosition[1].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[1].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[2].x,w=t.leaderPosition[2].y,t.leaderPosition[2].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[2].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[3].x,w=t.leaderPosition[3].y,t.leaderPosition[3].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[3].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,p=[],p.push(t.leaderPosition[0].x),p.push(t.leaderPosition[0].y),p.push(t.leaderPosition[1].x),p.push(t.leaderPosition[1].y),p.push(t.leaderPosition[2].x),p.push(t.leaderPosition[2].y),p.push(t.leaderPosition[3].x),p.push(t.leaderPosition[3].y),t.leaderPosition=p):"DMUMarker2DText"===t.type?(t.fontSize=t.fontSize*a,t.offwidth=i?t.width*a*i:t.offwidth*a,t.offheight=t.offheight*a,i&&(t.leaderPosition[0]={x:t.leaderPosition[0].x*i,y:-t.leaderPosition[0].y*i},t.leaderPosition[1]={x:t.leaderPosition[1].x*i,y:-t.leaderPosition[1].y*i},t.hasLeader?(u=c.getViewerPositionFromPoint(n,t.leaderPosition[2]),t.leaderPosition[2]={x:u.left*i,y:-u.top*i},g=c.getViewerPositionFromPoint(n,t.leaderPosition[3]),t.leaderPosition[3]={x:g.left*i,y:-g.top*i}):(t.leaderPosition[2]={x:t.leaderPosition[2].x*i,y:-t.leaderPosition[2].y*i},t.leaderPosition[3]={x:t.leaderPosition[3].x*i,y:-t.leaderPosition[3].y*i})),y=t.leaderPosition[0].x,w=t.leaderPosition[0].y,t.leaderPosition[0].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[0].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[1].x,w=t.leaderPosition[1].y,t.leaderPosition[1].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[1].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[2].x,w=t.leaderPosition[2].y,t.leaderPosition[2].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[2].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[3].x,w=t.leaderPosition[3].y,t.leaderPosition[3].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[3].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,p=[],p.push(t.leaderPosition[0].x),p.push(t.leaderPosition[0].y),p.push(t.leaderPosition[1].x),p.push(t.leaderPosition[1].y),p.push(t.leaderPosition[2].x),p.push(t.leaderPosition[2].y),p.push(t.leaderPosition[3].x),p.push(t.leaderPosition[3].y),t.leaderPosition=p):"DMUMarker3DPicture"===t.type?(t.width=t.width*a,t.height=t.height*a,t.offwidth=t.offwidth*a,t.offheight=t.offheight*a,t.fontSize=t.fontSize*a,i&&(d=c.getViewerPositionFromPoint(n,t.leaderPosition[0]),t.leaderPosition[0]={x:d.left*i,y:-d.top*i},p=c.getViewerPositionFromPoint(n,t.leaderPosition[1]),t.leaderPosition[1]={x:p.left*i,y:-p.top*i},u=c.getViewerPositionFromPoint(n,t.leaderPosition[2]),t.leaderPosition[2]={x:u.left*i,y:-u.top*i},g=c.getViewerPositionFromPoint(n,t.leaderPosition[3]),t.leaderPosition[3]={x:g.left*i,y:-g.top*i}),y=t.leaderPosition[0].x,w=t.leaderPosition[0].y,t.leaderPosition[0].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[0].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[1].x,w=t.leaderPosition[1].y,t.leaderPosition[1].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[1].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[2].x,w=t.leaderPosition[2].y,t.leaderPosition[2].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[2].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[3].x,w=t.leaderPosition[3].y,t.leaderPosition[3].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[3].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,p=[],p.push(t.leaderPosition[0].x),p.push(t.leaderPosition[0].y),p.push(t.leaderPosition[1].x),p.push(t.leaderPosition[1].y),p.push(t.leaderPosition[2].x),p.push(t.leaderPosition[2].y),p.push(t.leaderPosition[3].x),p.push(t.leaderPosition[3].y),t.leaderPosition=p):"DMUMarker2DPicture"===t.type?(t.width=t.width*a*(i||1),t.height=t.height*a*(i||1),t.offwidth=t.offwidth*a*(i||1),t.offheight=t.offheight*a*(i||1),t.fontSize=t.fontSize*a,i&&(t.leaderPosition[0]={x:t.leaderPosition[0].x*i,y:-t.leaderPosition[0].y*i},t.leaderPosition[1]={x:t.leaderPosition[1].x*i,y:-t.leaderPosition[1].y*i},t.hasLeader?(u=c.getViewerPositionFromPoint(n,t.leaderPosition[2]),t.leaderPosition[2]={x:u.left*i,y:-u.top*i},g=c.getViewerPositionFromPoint(n,t.leaderPosition[3]),t.leaderPosition[3]={x:g.left*i,y:-g.top*i}):(t.leaderPosition[2]={x:t.leaderPosition[2].x*i,y:-t.leaderPosition[2].y*i},t.leaderPosition[3]={x:t.leaderPosition[3].x*i,y:-t.leaderPosition[3].y*i})),y=t.leaderPosition[0].x,w=t.leaderPosition[0].y,t.leaderPosition[0].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[0].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[1].x,w=t.leaderPosition[1].y,t.leaderPosition[1].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[1].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[2].x,w=t.leaderPosition[2].y,t.leaderPosition[2].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[2].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,y=t.leaderPosition[3].x,w=t.leaderPosition[3].y,t.leaderPosition[3].x=(y*Math.cos(P)-w*Math.sin(P))*a+C,t.leaderPosition[3].y=(y*Math.sin(P)+w*Math.cos(P))*a+v,p=[],p.push(t.leaderPosition[0].x),p.push(t.leaderPosition[0].y),p.push(t.leaderPosition[1].x),p.push(t.leaderPosition[1].y),p.push(t.leaderPosition[2].x),p.push(t.leaderPosition[2].y),p.push(t.leaderPosition[3].x),p.push(t.leaderPosition[3].y),t.leaderPosition=p):"DMUMarker3DCircle"===t.type?(t.radius=i?c.convertModelToPixels({sizeInMM:t.radius,viewer:n,coords:s})*i:t.radius,t.radius=t.radius*a):"DMUMarker3DEllipse"===t.type?(t.xLength=i?c.convertModelToPixels({sizeInMM:t.xLength,viewer:n,coords:s})*i:t.xLength,t.yLength=i?c.convertModelToPixels({sizeInMM:t.yLength,viewer:n,coords:s})*i:t.yLength,t.xLength=t.xLength*a,t.yLength=t.yLength*a):"DMUCommentHighlight"===t.type?t.selection=t.selection.map((e=>({width:e.width*a,height:e.height*a,rotationAngle:(e.rotationAngle||0)-P,position:{x:(e.position.x*Math.cos(P)-e.position.y*Math.sin(P))*a+C,y:(e.position.x*Math.sin(P)+e.position.y*Math.cos(P))*a+v}}))):"DMUMarker3DArrow"===t.type?(i&&(h=new o.Vector3(t.pointing.x,t.pointing.y,t.pointing.z),D=new o.Vector3(t.ending.x,t.ending.y,t.ending.z),s=c.getViewerPositionFromPoint(n,h),D=c.getViewerPositionFromPoint(n,D),t.pointing.x=s.left*i,t.pointing.y=-s.top*i,t.ending.x=D.left*i,t.ending.y=-D.top*i),t.pointing={x:(t.pointing.x*Math.cos(P)-t.pointing.y*Math.sin(P))*a+C,y:(t.pointing.x*Math.sin(P)+t.pointing.y*Math.cos(P))*a+v},t.ending={x:(t.ending.x*Math.cos(P)-t.ending.y*Math.sin(P))*a+C,y:(t.ending.x*Math.sin(P)+t.ending.y*Math.cos(P))*a+v},t.points=t.points.map((e=>i?{x:t.pointing.x+(c.convertModelToPixels({sizeInMM:e.x,viewer:n,coords:h})*Math.cos(P)-c.convertModelToPixels({sizeInMM:e.y,viewer:n,coords:h})*Math.sin(P))*a*i,y:t.pointing.y+(c.convertModelToPixels({sizeInMM:e.x,viewer:n,coords:h})*Math.sin(P)+c.convertModelToPixels({sizeInMM:e.y,viewer:n,coords:h})*Math.cos(P))*a*i}:{x:t.pointing.x+(e.x*Math.cos(P)-e.y*Math.sin(P))*a,y:t.pointing.y+(e.x*Math.sin(P)+e.y*Math.cos(P))*a}))):"DMUCommentPositioned"===t.type?(t.radius=t.radius*a,t.width=t.width*a*(i||1/4),t.height=t.height*a*(i||1/4)):"DMUMarker3DLine"===t.type?(i&&(M=new o.Vector3(t.points.start.x,t.points.start.y,t.points.start.z),f=new o.Vector3(t.points.end.x,t.points.end.y,t.points.end.z),x=c.getViewerPositionFromPoint(n,M),M.x=x.left*i,M.y=-x.top*i,m=c.getViewerPositionFromPoint(n,f),f.x=m.left*i,f.y=-m.top*i),t.points=i?{start:{x:(M.x*Math.cos(P)-M.y*Math.sin(P))*a+C,y:(M.x*Math.sin(P)+M.y*Math.cos(P))*a+v},end:{x:(f.x*Math.cos(P)-f.y*Math.sin(P))*a+C,y:(f.x*Math.sin(P)+f.y*Math.cos(P))*a+v}}:{start:{x:(t.points.start.x*Math.cos(P)-t.points.start.y*Math.sin(P))*a+C,y:(t.points.start.x*Math.sin(P)+t.points.start.y*Math.cos(P))*a+v},end:{x:(t.points.end.x*Math.cos(P)-t.points.end.y*Math.sin(P))*a+C,y:(t.points.end.x*Math.sin(P)+t.points.end.y*Math.cos(P))*a+v}}):"DMUMarker3DSpline"===t.type||"DMUMarker3DFreehand"===t.type?(t.rect.width=t.rect.width*a,t.rect.height=t.rect.height*a,t.points=t.points.map((e=>({x:(e.x*Math.cos(P)-e.y*Math.sin(P))*a+C,y:(e.x*Math.sin(P)+e.y*Math.cos(P))*a+v})))):"DMUMarker3DCloud"===t.type&&(t.rect.width=t.rect.width*a,t.rect.height=t.rect.height*a,t.points=t.points.map((e=>({x:(e.x*Math.cos(P)-e.y*Math.sin(P))*a+C,y:(e.x*Math.sin(P)+e.y*Math.cos(P))*a+v}))),t.arcPoints=t.arcPoints.map((e=>({x:(e.x*Math.cos(P)-e.y*Math.sin(P))*a+C,y:(e.x*Math.sin(P)+e.y*Math.cos(P))*a+v}))))}static async getAnnotationAppearance(e,t,{rect:o,definition:r,material:i}){var n;if(!b)return;let a,s,l;if("DMUMarker3DRectangle"===r.type)a=[b.setGraphicsState("GS0"),i.fill&&b.setFillingColor(b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b)),i.border&&b.setStrokingColor(b.rgb(i.border.color.r,i.border.color.g,i.border.color.b)),b.setLineWidth(i.border?i.border.thickness:0),b.setDashPattern(i.border&&i.border.pattern?i.border.pattern:[],0),b.translate(r.position.x,r.position.y),b.rotateRadians(r.rotationAngle||0),b.moveTo(-r.width/2,-r.height/2),b.lineTo(-r.width/2,r.height/2),b.lineTo(r.width/2,r.height/2),b.lineTo(r.width/2,-r.height/2),b.closePath(),i.fill&&i.border?b.fillAndStroke():i.fill?b.fill():b.stroke()].filter(Boolean);else if("DMUMarker3DPicture"===r.type||"DMUMarker2DPicture"===r.type){let t,o,n,d,c,g,u=r.width,h=r.height,D=Math.max(r.lineThickness/2,r.fontSize/3),M={x:u/2,y:h/2},f={x:u/2-D,y:h/2+r.fontSize},x={x:u/2,y:h/2+r.fontSize+D};d={x:M.x*Math.cos(r.rotationAngle)-M.y*Math.sin(r.rotationAngle),y:M.x*Math.sin(r.rotationAngle)+M.y*Math.cos(r.rotationAngle)},c={x:f.x*Math.cos(r.rotationAngle)-f.y*Math.sin(r.rotationAngle),y:f.x*Math.sin(r.rotationAngle)+f.y*Math.cos(r.rotationAngle)},g={x:x.x*Math.cos(r.rotationAngle)-x.y*Math.sin(r.rotationAngle),y:x.x*Math.sin(r.rotationAngle)+x.y*Math.cos(r.rotationAngle)},o={x:-c.x+r.position.x,y:-c.y+r.position.y},t={x:-d.x+r.position.x,y:-d.y+r.position.y},n={x:-g.x+r.position.x,y:-g.y+r.position.y};let m={x:r.leaderPosition[4],y:r.leaderPosition[5]},y={x:r.leaderPosition[6],y:r.leaderPosition[7]},w=v(r,i,m),P=[];m&&y&&(P=[b.setGraphicsState("GS0"),b.setStrokingRgbColor(r.borderColor.r,r.borderColor.g,r.borderColor.b),b.setLineWidth(r.lineThickness),b.setDashPattern(i.border&&i.border.pattern?i.border.pattern:[],0),b.moveTo(r.leaderPosition[0],r.leaderPosition[1]),b.lineTo(m?m.x:r.leaderPosition[2],m?m.y:r.leaderPosition[3]),b.moveTo(m?m.x:r.leaderPosition[2],m?m.y:r.leaderPosition[3]),b.lineTo(y?y.x:r.leaderPosition[2],y?y.y:r.leaderPosition[3]),b.stroke()]);let S=[],C=[];if(!1===r.shortDisplay){let e,t,a=[],s=r.textContent[0],l="";e=s.length,t=u/r.fontSize*1.2,e>t?(l=s.slice(0,Math.round(t)),l+="..."):l=s,r.textContent[0]=l;for(let e=0;e<r.textContent.length;e++)a.push(b.PDFString.of(r.textContent[e]));C=b.drawLinesOfText(a,{x:o.x,y:o.y,font:b.StandardFonts.Helvetica,lineHeight:1.2*r.fontSize,size:.97*r.fontSize,rotate:b.radians(r.rotationAngle||0),xSkew:b.radians(0),ySkew:b.radians(0),color:b.rgb(r.fontColor.r,r.fontColor.g,r.fontColor.b),graphicsState:"GS0"}),S=b.drawRectangle({x:n.x,y:n.y,width:u,height:r.fontSize+D,borderWidth:0,borderColor:i.border&&r.hasBorder?b.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,rotate:b.radians(r.rotationAngle||0),borderDashArray:i.border&&r.hasBorder&&i.border.pattern?i.border.pattern:[],borderDashPhase:i.border&&r.hasBorder?Number(r.lineType):void 0,xSkew:b.radians(0),ySkew:b.radians(0),color:i.fill?b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b):void 0,graphicsState:"GS0"})}let U=[];r.hasBorder&&(U=b.drawRectangle({x:!1===r.shortDisplay?n.x:t.x,y:!1===r.shortDisplay?n.y:t.y,width:u,height:!1===r.shortDisplay?h+r.fontSize+D:h,borderWidth:r.hasBorder?r.lineThickness:0,borderColor:i.border&&r.hasBorder?b.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,rotate:b.radians(r.rotationAngle||0),borderDashArray:i.border&&r.hasBorder&&i.border.pattern?i.border.pattern:[],borderDashPhase:i.border&&r.hasBorder?Number(r.lineType):void 0,xSkew:b.radians(0),ySkew:b.radians(0),color:void 0,graphicsState:"GS0"}));let E=[];E=b.drawRectangle({x:!1===r.shortDisplay?n.x:t.x,y:!1===r.shortDisplay?n.y:t.y,width:u,height:!1===r.shortDisplay?h+r.fontSize+D:h,borderWidth:0,borderColor:void 0,rotate:b.radians(r.rotationAngle||0),borderDashArray:i.border&&r.hasBorder&&i.border.pattern?i.border.pattern:[],borderDashPhase:i.border&&r.hasBorder?Number(r.lineType):void 0,xSkew:b.radians(0),ySkew:b.radians(0),color:i.fill?b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b):void 0,graphicsState:"GS0"});let k=p.getImageDataUrl(r.imageType,r.imagedata);"png"===r.imageType?s=await e.embedPng(k):"jpeg"===r.imageType&&(s=await e.embedJpg(k)),l=e.context.addRandomSuffix("Image",10);let A=b.drawImage(l,{x:t.x,y:t.y,rotate:b.radians(r.rotationAngle||0),xSkew:b.radians(0),ySkew:b.radians(0),width:r.width,height:r.height});a=[...P,...w,...E,...A,...S,...C,...U].filter(Boolean)}else if("DMUMarker3DCircle"===r.type){let e=r.radius;a=b.drawEllipse({x:r.position.x,y:r.position.y,xScale:e,yScale:e,borderDashArray:i.border&&i.border.pattern?i.border.pattern:void 0,borderColor:i.border?b.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,borderWidth:i.border?i.border.thickness:0,color:i.fill?b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b):void 0,graphicsState:"GS0"}),a.splice(a.length-2,0,b.closePath())}else if("DMUMarker3DEllipse"===r.type)a=b.drawEllipse({x:r.position.x,y:r.position.y,xScale:r.xLength/2,yScale:r.yLength/2,borderDashArray:i.border&&i.border.pattern?i.border.pattern:void 0,rotate:b.radians(r.rotationAngle||0),borderColor:i.border?b.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,borderWidth:i.border?i.border.thickness:0,color:i.fill?b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b):void 0,graphicsState:"GS0"}),a.splice(a.length-2,0,b.closePath());else if("DMUMarker3DLine"===r.type)a=b.drawLine({start:{x:r.points.start.x,y:r.points.start.y},end:{x:r.points.end.x,y:r.points.end.y},dashArray:i.border&&i.border.pattern?i.border.pattern:void 0,color:i.border?b.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,thickness:i.border?i.border.thickness:0,graphicsState:"GS0"});else if("DMUMarker3DText"===r.type||"DMUMarker3DStamp"===r.type||"DMUMarker2DText"===r.type){let t=[];for(let e=0;e<r.textContent.length;e++)t.push(b.PDFString.of(r.textContent[e]));let o,n,d=r.offwidth,c=r.offheight,p=Math.max(r.lineThickness/2,r.fontSize/3);if("rotationAngle"in r&&r.rotationAngle){let e,t,i={x:d/2,y:c/2},a={x:d/2-p,y:-c/2+p+r.fontSize};e={x:i.x*Math.cos(r.rotationAngle)-i.y*Math.sin(r.rotationAngle),y:i.x*Math.sin(r.rotationAngle)+i.y*Math.cos(r.rotationAngle)},t={x:a.x*Math.cos(r.rotationAngle)-a.y*Math.sin(r.rotationAngle),y:a.x*Math.sin(r.rotationAngle)+a.y*Math.cos(r.rotationAngle)},n={x:-t.x+r.position.x,y:-t.y+r.position.y},o={x:-e.x+r.position.x,y:-e.y+r.position.y}}else n={x:r.leaderPosition[2]-d/2+p,y:r.leaderPosition[3]+c/2-p-r.fontSize},o={x:r.leaderPosition[2]-d/2,y:r.leaderPosition[3]-c/2};let g=b.drawLinesOfText(t,{x:n.x,y:n.y,font:b.StandardFonts.Helvetica,lineHeight:1.2*r.fontSize,size:.97*r.fontSize,rotate:b.radians(r.rotationAngle||0),xSkew:b.radians(0),ySkew:b.radians(0),color:b.rgb(r.fontColor.r,r.fontColor.g,r.fontColor.b),graphicsState:"GS0"}),u=b.drawRectangle({x:o.x,y:o.y,width:d,height:c,borderWidth:r.hasBorder?r.lineThickness:0,borderColor:i.border&&r.hasBorder?b.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,rotate:b.radians(r.rotationAngle||0),borderDashArray:i.border&&r.hasBorder&&i.border.pattern?i.border.pattern:[],borderDashPhase:i.border&&r.hasBorder?Number(r.lineType):void 0,xSkew:b.radians(0),ySkew:b.radians(0),color:i.fill?b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b):void 0,graphicsState:"GS0"}),h={x:r.leaderPosition[4],y:r.leaderPosition[5]},D={x:r.leaderPosition[6],y:r.leaderPosition[7]},M=v(r,i,h),f=[];if(h&&D&&(f=[b.setGraphicsState("GS0"),b.setStrokingRgbColor(r.borderColor.r,r.borderColor.g,r.borderColor.b),b.setLineWidth(r.lineThickness),b.setDashPattern(i.border&&i.border.pattern?i.border.pattern:[],0),b.moveTo(r.leaderPosition[0],r.leaderPosition[1]),b.lineTo(h?h.x:r.leaderPosition[2],h?h.y:r.leaderPosition[3]),b.moveTo(h?h.x:r.leaderPosition[2],h?h.y:r.leaderPosition[3]),b.lineTo(D?D.x:r.leaderPosition[2],D?D.y:r.leaderPosition[3]),b.stroke()]),"DMUMarker3DStamp"===r.type){let t=e=>({r:parseInt(e.slice(1,3),16)/255,g:parseInt(e.slice(3,5),16)/255,b:parseInt(e.slice(5,7),16)/255}),i="Validated"===r.stampType?t("#008000"):t("#FF0000"),d=[b.setGraphicsState("GS0"),b.setStrokingRgbColor(i.r,i.g,i.b),b.setLineWidth(3),b.setDashPattern([],0),b.moveTo(o.x,o.y),b.lineTo(o.x,o.y+c),b.stroke()],g=r.ownerIcon||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACIAAAAiCAMAAAANmfvwAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAACKUExURQeL+my6/P////T6/9fs/n3C/AmM+ne//EGm+0yr+6PU/YLE/E2s+/D4/9Lq/u73/8vn/lKu/A+P+hqU+oXG/XW+/Lje/guN+nG9/Dqj+0Kn+3nA/Pv9/7Pc/bDa/SOY+7Lb/Suc+4rI/Uep+0qq+4PF/f3+/83o/sPj/uf0//r9/+Lx/prQ/RuV+pe8Dn0AAAAJcEhZcwAADsMAAA7DAcdvqGQAAAB4SURBVDhP7c5HEoIAFIPh96KCFbFhQ1Cxl/tfjwE2mRzAhcO3+meyibV+wQF0ur2ASzjC/mCIEZdwjM2CScQl6sGmMZdwzOaLJVZcojoJJGsu4dhsd/v0wCWaBxlyKtEMR5yohONcXK63O5coHs9X+v58uVp/w6wE5ZwJR3yBOjsAAAAASUVORK5CYII=";s=await e.embedPng(g),l=e.context.addRandomSuffix("Image",10);let h=.15*s.width,D=c-.75*s.height,x=b.drawImage(l,{x:o.x+h,y:o.y+D,rotate:b.radians(r.rotationAngle||0),xSkew:b.radians(0),ySkew:b.radians(0),width:.65*s.height,height:.65*s.height}),m=[b.PDFString.of((r.owner.length>10?r.owner.substring(0,11)+"...":r.owner)+" - "+(new Date(r.creationDate).toISOString().length>18?new Date(r.creationDate).toISOString().substring(0,19)+"...":new Date(r.creationDate).toISOString()))],y=b.drawLinesOfText(m,{x:n.x+6*h,y:n.y,font:b.StandardFonts.Helvetica,lineHeight:1.2*r.fontSize,size:.97*r.fontSize,rotate:b.radians(r.rotationAngle||0),xSkew:b.radians(0),ySkew:b.radians(0),color:b.rgb(t("#77797C").r,t("#77797C").g,t("#77797C").b),graphicsState:"GS0"}),w=[b.PDFString.of(r.textContent[0])],P=b.drawLinesOfText(w,{x:n.x+6*h,y:n.y-4*p,font:b.StandardFonts.HelveticaBold,lineHeight:1.2*r.fontSize,size:.97*r.fontSize,rotate:b.radians(r.rotationAngle||0),xSkew:b.radians(0),ySkew:b.radians(0),color:b.rgb(i.r,i.g,i.b),graphicsState:"GS0"}),S=[b.PDFString.of(r.textComment[0])],v=b.drawLinesOfText(S,{x:n.x+6*h,y:n.y-8*p,font:b.StandardFonts.Helvetica,lineHeight:1.2*r.fontSize,size:.97*r.fontSize,rotate:b.radians(r.rotationAngle||0),xSkew:b.radians(0),ySkew:b.radians(0),color:b.rgb(r.fontColor.r,r.fontColor.g,r.fontColor.b),graphicsState:"GS0"});a=[...M,...f,...u,...d,...x,...y,...P,...v].filter(Boolean)}else a=[...M,...f,...u,...g].filter(Boolean)}else if("DMUMarker3DSpline"===r.type){let e={x:0,y:0};a=[b.setGraphicsState("GS0"),i.border&&b.setStrokingColor(b.rgb(i.border.color.r,i.border.color.g,i.border.color.b)),b.setLineWidth(i.border?i.border.thickness:0),b.setDashPattern(i.border&&i.border.pattern?i.border.pattern:[],0),...r.points.map(((t,o,r)=>{if(!b)return;if(0===o)return b.moveTo(t.x,t.y);let i=e.x,n=e.y,a=r[o+1],s=r[o-1];if(a){let t={x:a.x-s.x,y:a.y-s.y};e={x:t.x/6,y:t.y/6}}else{let o={x:t.x-s.x,y:t.y-s.y};e={x:o.x/3,y:o.y/3}}return b.appendBezierCurve(s.x+i,s.y+n,t.x-e.x,t.y-e.y,t.x,t.y)})),b.stroke()].filter(Boolean)}else if("DMUMarker3DArrow"===r.type)a=[b.setGraphicsState("GS0"),i.fill&&b.setFillingRgbColor(i.fill.color.r,i.fill.color.g,i.fill.color.b),i.border&&b.setStrokingRgbColor(i.border.color.r,i.border.color.g,i.border.color.b),b.setLineWidth(i.border?i.border.thickness:0),b.setDashPattern(i.border&&i.border.pattern?i.border.pattern:[],0),...r.points.map(((e,t)=>{if(b)return 0===t?b.moveTo(e.x,e.y):b.lineTo(e.x,e.y)})),b.closePath(),i.fill&&i.border?b.fillAndStroke():i.fill?b.fill():b.stroke()].filter(Boolean);else if("DMUCommentPositioned"===r.type){const e=t.getRotation();let o=0;e&&e.angle&&(o="degrees"===e.type?e.angle*Math.PI/180:e.angle);let n=r.radius,s=.75*r.width,l=.625*r.width,d=.5519150244935106*n,c=l/2,p=s/2;a=[b.setGraphicsState("GS0"),i.fill&&b.setFillingRgbColor(i.fill.color.r,i.fill.color.g,i.fill.color.b),i.border&&b.setStrokingRgbColor(i.border.color.r,i.border.color.g,i.border.color.b),b.setLineWidth(i.border?i.border.thickness:0),b.translate(r.position.x,r.position.y),b.rotateRadians(o),b.moveTo(-p,-c+n),b.lineTo(-p,c-n),b.appendBezierCurve(-p,c-n+d,-p+n-d,c,-p+n,c),b.lineTo(p-n,c),b.appendBezierCurve(p-n+d,c,p,c-n+d,p,c-n),b.lineTo(p,-c+n),b.appendBezierCurve(p,-c+n-d,p-n+d,-c,p-n,-c),b.lineTo(.45*s-p,-c),b.lineTo(.1*s-p,-c-.3*l),b.lineTo(-p+n,-c),b.appendBezierCurve(-p+n-d,-c,-p,-c+n-d,-p,-c+n),b.closePath(),i.border?b.fillAndStroke():b.fill(),i.border&&b.moveTo(.2*s-p,.7*l-c),i.border&&b.lineTo(.8*s-p,.7*l-c),i.border&&b.stroke(),i.border&&b.moveTo(.2*s-p,.4*l-c),i.border&&b.lineTo(.65*s-p,.4*l-c),i.border&&b.stroke()].filter(Boolean)}else if("DMUMarker3DCloud"===r.type)a=[b.setGraphicsState("GS0"),i.border&&b.setStrokingColor(b.rgb(i.border.color.r,i.border.color.g,i.border.color.b)),i.fill&&b.setFillingColor(b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b)),b.setLineWidth(i.border?i.border.thickness:0),...r.arcPoints.map(((e,t,o)=>{let r=t%15;if(b){if(0===t)return b.moveTo(e.x,e.y);if(0===r&&void 0===i.fill&&0===t)return b.moveTo(e.x,e.y);if(0===r&&void 0===i.fill){let e=o[t-3];return b.moveTo(e.x,e.y)}return t+1===o.length?b.lineTo(o[0].x,o[0].y):b.lineTo(e.x,e.y)}})),i.fill&&i.border?b.fillAndStroke():i.fill?b.fill():b.stroke()].filter(Boolean);else if("DMUMarker3DFreehand"===r.type&&0===r.rect.width&&0===r.rect.height){let e=c.getMMPerPtRatio(),t=.5;i.border&&i.border.thickness/e==9&&(t=.5);let n=o[2]-o[0];a=b.drawEllipse({x:r.position.x,y:r.position.y,xScale:n*t,yScale:n*t,borderDashArray:void 0,borderColor:void 0,borderWidth:0,color:i.border?b.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,graphicsState:"GS0"}),a.splice(a.length-2,0,b.closePath())}else"DMUMarker3DFreehand"===r.type&&(a=[b.setGraphicsState("GS0"),i.border&&b.setStrokingColor(b.rgb(i.border.color.r,i.border.color.g,i.border.color.b)),i.fill&&b.setFillingColor(b.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b)),b.setLineWidth(i.border?i.border.thickness:0),b.moveTo(r.points[0].x,r.points[0].y),...r.points.map((e=>{if(b)return b.lineTo(e.x,e.y)})),b.stroke()].filter(Boolean));if(a&&a.length){let t=e.context.formXObject(a,{BBox:o,Matrix:[1,0,0,1,-o[0],-o[1]],Resources:e.context.obj({ExtGState:e.context.obj({GS0:e.context.obj({Type:"ExtGState",ca:i.fill?i.fill.opacity:"DMUMarker3DFreehand"===r.type&&0===r.rect.width&&0===r.rect.height?null===(n=i.border)||void 0===n?void 0:n.opacity:1,CA:i.border?i.border.opacity:1})}),XObject:s&&l?{[l]:s.ref}:void 0})}),d=e.context.register(t);return e.context.obj({N:d})}}static getAnnotationRect(e,t){let o={x:0,y:0},r={x:0,y:0};if("rotationAngle"in e&&e.rotationAngle){let t="DMUMarker3DRectangle"===e.type?e.width:"DMUMarker3DEllipse"===e.type?e.xLength:"DMUMarker3DText"===e.type||"DMUMarker2DText"===e.type||"DMUMarker3DStamp"===e.type||"DMUMarker3DPicture"===e.type||"DMUMarker2DPicture"===e.type?e.offwidth:e.rect.width,i="DMUMarker3DRectangle"===e.type?e.height:"DMUMarker3DEllipse"===e.type?e.yLength:"DMUMarker3DText"===e.type||"DMUMarker2DText"===e.type||"DMUMarker3DStamp"===e.type||"DMUMarker3DPicture"===e.type||"DMUMarker2DPicture"===e.type?e.offheight:e.rect.height,n={x:t/2,y:i/2},a={x:-t/2,y:i/2},s={x:n.x*Math.cos(e.rotationAngle)-n.y*Math.sin(e.rotationAngle),y:n.x*Math.sin(e.rotationAngle)+n.y*Math.cos(e.rotationAngle)},l={x:a.x*Math.cos(e.rotationAngle)-a.y*Math.sin(e.rotationAngle),y:a.x*Math.sin(e.rotationAngle)+a.y*Math.cos(e.rotationAngle)},d={x:-s.x,y:-s.y},c={x:s.x,y:s.y},p={x:l.x,y:l.y},g={x:-l.x,y:-l.y};if(o.x=Math.min(d.x,g.x,c.x,p.x)+e.position.x,o.y=Math.min(d.y,g.y,c.y,p.y)+e.position.y,r.x=Math.max(d.x,g.x,c.x,p.x)+e.position.x,r.y=Math.max(d.y,g.y,c.y,p.y)+e.position.y,"DMUMarker3DText"!==e.type&&"DMUMarker2DText"!==e.type&&"DMUMarker3DStamp"!==e.type&&"DMUMarker3DPicture"!==e.type&&"DMUMarker2DPicture"!==e.type||!e.hasLeader){if("DMUMarker3DCloud"===e.type){const t=15;o.x=Math.min(d.x,g.x,c.x,p.x)+e.position.x-t,o.y=Math.min(d.y,g.y,c.y,p.y)+e.position.y-t,r.x=Math.max(d.x,g.x,c.x,p.x)+e.position.x+t,r.y=Math.max(d.y,g.y,c.y,p.y)+e.position.y+t}}else{let t={x:e.leaderPosition[0],y:e.leaderPosition[1]};o.x=Math.min(o.x,t.x)-5,o.y=Math.min(o.y,t.y)-5,r.x=Math.max(r.x,t.x)+5,r.y=Math.max(r.y,t.y)+5}}else if("DMUMarker3DRectangle"===e.type||"DMUCommentPositioned"===e.type||"DMUMarker3DCircle"===e.type||"DMUMarker3DEllipse"===e.type||"DMUMarker3DSpline"===e.type||"DMUMarker3DFreehand"===e.type||"DMUMarker3DCloud"===e.type){let t="DMUMarker3DRectangle"===e.type||"DMUCommentPositioned"===e.type?e.width:"DMUMarker3DCircle"===e.type?2*e.radius:"DMUMarker3DEllipse"===e.type?e.xLength:e.rect.width?e.rect.width:5,i="DMUMarker3DRectangle"===e.type||"DMUCommentPositioned"===e.type?e.height:"DMUMarker3DCircle"===e.type?2*e.radius:"DMUMarker3DEllipse"===e.type?e.yLength:e.rect.height?e.rect.height:5;if(o.x=e.position.x-t/2,o.y=e.position.y-i/2,r.x=e.position.x+t/2,r.y=e.position.y+i/2,"DMUMarker3DCloud"===e.type){const n=15;o.x=e.position.x-t/2-n,o.y=e.position.y-i/2-n,r.x=e.position.x+t/2+n,r.y=e.position.y+i/2+n}}else"DMUMarker3DLine"===e.type?(o.x=Math.min(e.points.start.x,e.points.end.x),o.y=Math.min(e.points.start.y,e.points.end.y),r.x=Math.max(e.points.start.x,e.points.end.x),r.y=Math.max(e.points.start.y,e.points.end.y)):"DMUMarker3DArrow"===e.type?(o.x=1/0,o.y=1/0,r.x=-1/0,r.y=-1/0,e.points.forEach((e=>{o.x=Math.min(o.x,e.x),o.y=Math.min(o.y,e.y),r.x=Math.max(r.x,e.x),r.y=Math.max(r.y,e.y)}))):"DMUCommentHighlight"===e.type?(o.x=1/0,o.y=1/0,r.x=-1/0,r.y=-1/0,e.selection.forEach((e=>{o.x=Math.min(o.x,e.position.x),o.y=Math.min(o.y,e.position.y-e.height),r.x=Math.max(r.x,e.position.x+e.width),r.y=Math.max(r.y,e.position.y)}))):"DMUMarker3DText"!==e.type&&"DMUMarker2DText"!==e.type&&"DMUMarker3DStamp"!==e.type&&"DMUMarker3DPicture"!==e.type&&"DMUMarker2DPicture"!==e.type||(e.hasLeader?(o.x=Math.min(e.leaderPosition[0],e.leaderPosition[2]-e.offwidth/2,e.leaderPosition[2]+e.offwidth/2)-5,o.y=Math.min(e.leaderPosition[3]-e.offheight/2,e.leaderPosition[1],e.leaderPosition[3]+e.offheight/2)-5,r.x=Math.max(e.leaderPosition[2]+e.offwidth/2,e.leaderPosition[0],e.leaderPosition[2]-e.offwidth/2)+5,r.y=Math.max(e.leaderPosition[3]+e.offheight/2,e.leaderPosition[1],e.leaderPosition[3]-e.offheight/2)+5):(o.x=e.leaderPosition[2]-e.offwidth/2,o.y=e.leaderPosition[3]-e.offheight/2,r.x=e.leaderPosition[2]+e.offwidth/2,r.y=e.leaderPosition[3]+e.offheight/2));return[o.x-t/2,o.y-t/2,r.x+t/2,r.y+t/2]}static async createAnnotation(e,{definition:t,subject:o,material:r,comments:i,pageNumber:n}){if(b&&t.type in w){let a=e.getPage(n-1);if(a){let n=C.getAnnotationRect(t,r.border?r.border.thickness:1),s=e.context.obj({Type:"Annot",Subtype:w[t.type],NM:b.PDFString.of(t.id),Rect:n,F:t.visible?4:2,P:a.ref,IC:r.fill?[r.fill.color.r,r.fill.color.g,r.fill.color.b]:void 0,C:r.border?[r.border.color.r,r.border.color.g,r.border.color.b]:void 0,CA:r.border?r.border.opacity:1,AP:await C.getAnnotationAppearance(e,a,{rect:n,definition:t,material:r}),BS:e.context.obj({Type:"Border",W:"DMUCommentPositioned"!==t.type&&r.border?r.border.thickness:0,S:r.border&&r.border.pattern?"D":"S",D:r.border&&r.border.pattern?r.border.pattern:void 0}),Subj:o}),l=e.context.register(s);if(a.node.addAnnot(l),"DMUCommentPositioned"===t.type)r.fill&&(s.set(b.PDFName.of("C"),e.context.obj([r.fill.color.r,r.fill.color.g,r.fill.color.b])),s.set(b.PDFName.of("CA"),b.PDFNumber.of(r.fill.opacity))),s.set(b.PDFName.of("Name"),b.PDFName.of("Comment"));else if("DMUCommentHighlight"===t.type){r.fill&&(s.set(b.PDFName.of("C"),e.context.obj([r.fill.color.r,r.fill.color.g,r.fill.color.b])),s.set(b.PDFName.of("CA"),b.PDFNumber.of(r.fill.opacity)));let o=t.selection.map((e=>{let t=e.position.x,o=e.position.x+(e.width*Math.cos(e.rotationAngle||0)-e.height*Math.sin(e.rotationAngle||0)),r=e.position.y,i=e.position.y-(e.width*Math.sin(e.rotationAngle||0)+e.height*Math.cos(e.rotationAngle||0));return[t,r,o,r,t,i,o,i]}));s.set(b.PDFName.of("QuadPoints"),e.context.obj(o.flat()))}else if("DMUMarker3DLine"===t.type)s.set(b.PDFName.of("L"),e.context.obj([t.points.start.x,t.points.start.y,t.points.end.x,t.points.end.y]));else if("DMUMarker3DSpline"===t.type)s.set(b.PDFName.of("InkList"),e.context.obj([t.points.map((e=>[e.x,e.y])).flat()]));else if("DMUMarker3DFreehand"===t.type)s.set(b.PDFName.of("InkList"),e.context.obj([t.points.map((e=>[e.x,e.y])).flat()]));else if("DMUMarker3DCloud"===t.type)s.set(b.PDFName.of("BE"),e.context.obj({I:b.PDFNumber.of(2),S:b.PDFName.of("C")})),s.set(b.PDFName.of("IT"),b.PDFName.of("PolygonCloud")),s.set(b.PDFName.of("Vertices"),e.context.obj(t.points.map((e=>[e.x,e.y])).flat()));else if("DMUMarker3DArrow"===t.type)s.set(b.PDFName.of("IT"),b.PDFName.of("LineArrow")),s.set(b.PDFName.of("L"),e.context.obj([t.pointing.x,t.pointing.y,t.ending.x,t.ending.y]));else if("DMUMarker3DPicture"===t.type||"DMUMarker2DPicture"===t.type){let o=t.imagedata;e.attach(o,"Test.PNG",{mimeType:"image/png"});let r=e.embeddedFiles.at(-1).ref;s.set(b.PDFName.of("FS"),r)}if(i&&i.length){let t;if(i.length>1){let o="";i.forEach((e=>{o+=`<p>${e.owner}&nbsp;&nbsp;${e.lastModificationDate.toLocaleString()}</p><p>${e.content}</p>`,e.replies&&e.replies.forEach((e=>{o+=`<p>&nbsp;&nbsp;&nbsp;${e.owner}&nbsp;&nbsp;${e.lastModificationDate.toLocaleString()}</p><p>&nbsp;&nbsp;&nbsp;${e.content}</p>`})),o+="<p>\n</p>"}));const{richContent:r,flatContent:d}=S(o),c=b.PDFHexString.fromText(d),p=b.PDFHexString.fromText(r);t=e.context.obj({Type:"Annot",Subtype:"Popup",Contents:c,RC:p,Parent:l,Rect:n}),s.set(b.PDFName.of("Contents"),c),s.set(b.PDFName.of("RC"),p);let g=i[0].status;if(g&&i.every((e=>e.status===g))){const t=P[g],o=t+" defined by "+i[0].owner,r=b.PDFString.of(o),n=b.PDFString.fromDate(i[0].creationDate),s=b.PDFString.of(i[0].owner);let d=e.context.obj({Contents:r,CreationDate:n,F:30,IRT:l,M:n,NM:b.PDFString.of(i[0].id+"_status"),P:a.ref,Rect:[0,0,0,0],State:b.PDFString.of(t),StateModel:b.PDFString.of("Review"),Subtype:"Text",T:s,Type:"Annot"}),c=e.context.register(d);a.node.addAnnot(c)}}else{const{richContent:o,flatContent:d}=S(i[0].content),p=b.PDFHexString.fromText(d),g=b.PDFHexString.fromText(o),u=b.PDFHexString.fromText(i[0].owner);if(t=e.context.obj({Type:"Annot",Subtype:"Popup",Contents:p,CreationDate:b.PDFString.fromDate(i[0].creationDate),T:u,M:b.PDFString.fromDate(i[0].lastModificationDate),Parent:l,Rect:n,RC:g}),s.set(b.PDFName.of("Contents"),p),s.set(b.PDFName.of("RC"),g),s.set(b.PDFName.of("T"),u),s.set(b.PDFName.of("CreationDate"),b.PDFString.fromDate(i[0].creationDate)),s.set(b.PDFName.of("M"),b.PDFString.fromDate(i[0].lastModificationDate)),i[0].replies){let t=0;i[0].replies.forEach((async o=>{if(!b)return;let i=c.getMMPerPtRatio();const s=5*i;t-=4*i;let d=[n[2]-s,n[1]+t,n[2],n[1]+t+s];const{richContent:p,flatContent:g}=S(o.content),u=b.PDFHexString.fromText(g),h=b.PDFHexString.fromText(p),D=b.PDFHexString.fromText(o.owner);let M=e.context.obj({Type:"Annot",Subtype:"Text",NM:b.PDFString.of(o.id),Name:"Comment",Contents:u,RC:h,T:D,CreationDate:b.PDFString.fromDate(o.creationDate),M:b.PDFString.fromDate(o.creationDate),Rect:d,F:4,P:a.ref,C:r.border?[r.border.color.r,r.border.color.g,r.border.color.b]:r.fill?[r.fill.color.r,r.fill.color.g,r.fill.color.b]:void 0,BS:e.context.obj({Type:"Border",W:0,S:"S"}),AP:await C.getAnnotationAppearance(e,a,{rect:d,definition:{id:"",visible:!0,type:"DMUCommentPositioned",position:{x:d[0]+s/2,y:d[1]+s/2},width:s-1,height:s-1,radius:.5},material:{border:void 0,fill:{color:r.fill?r.fill.color:r.border?r.border.color:{r:0,g:0,b:0},opacity:1}}}),IRT:l}),f=e.context.register(M);a.node.addAnnot(f);let x=e.context.obj({Type:"Annot",Subtype:"Popup",Parent:f,Rect:n}),m=e.context.register(x);a.node.addAnnot(m),M.set(b.PDFName.of("Popup"),m)}))}if(i[0].status){const t=P[i[0].status],o=t+" defined by "+i[0].owner,r=b.PDFString.of(o),n=b.PDFString.fromDate(i[0].creationDate),s=b.PDFString.of(i[0].owner);let d=e.context.obj({Contents:r,CreationDate:n,F:30,IRT:l,M:n,NM:b.PDFString.of(i[0].id+"_status"),P:a.ref,Rect:[0,0,0,0],State:b.PDFString.of(t),StateModel:b.PDFString.of("Review"),Subtype:"Text",T:s,Type:"Annot"}),c=e.context.register(d);a.node.addAnnot(c)}}let o=e.context.register(t);a.node.addAnnot(o),s.set(b.PDFName.of("Popup"),o)}}}}}class U{static displayLoadingDiv(e,t){let o,r,i;t&&(i=window&&window.widget?window.widget.getView().type:null,i&&"maximized"!==i&&window.widget.requestView({type:"maximized"})),o=s.createElement("div",{class:"DMUExportMainDiv",styles:{zIndex:1e9,width:"100%",height:"100%",backgroundColor:"#F9F9F9",position:"absolute",top:0,left:0,padding:"0px 25%",display:"flex",flexDirection:"column",justifyContent:"center",background:"linear-gradient(0deg, #E2E4E3 0%, #F9F9F9 100%);"}}),r=s.createElement("span",{class:"DMUExportLabel",styles:{margin:"10px 0px"}}).inject(o);let n=s.createElement("div",{styles:{display:"flex",gap:"10px",alignItems:"center"}}).inject(o),a=new l;a.inject(n);let c=new d({label:m.exportCancelButtonLabel,emphasize:"secondary"}).inject(n);c.elements.container.setStyles({padding:"unset"});const p=()=>{c&&(c.disabled=!0),a.emphasize="high-attention",a.infiniteFlag=!0,r&&(r.innerText=m.exportCancel),e()},g=t=>{"27"!==t.code&&"Escape"!==t.key||(a.emphasize="high-attention",a.infiniteFlag=!0,r&&(r.innerText=m.exportCancel),e(),document.removeEventListener("keydown",g))};c.getContent().addEventListener("buttonclick",p),document.addEventListener("keydown",g);let u=s.createElement("div",{styles:{position:"absolute",top:30,right:30}}).inject(o),h=new d({displayStyle:"lite",label:m.exportCancelButtonLabel,icon:{iconName:"close",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"3x"},showLabelFlag:!1}).inject(u);return h.getContent().addEventListener("buttonclick",p),{loadingDivView:o,disableCancel:()=>{c.hide(),h.hide(),document.removeEventListener("keydown",g)},updateLoadingValue:e=>{a&&"number"==typeof e.value&&(a.value=e.value),r&&"string"==typeof e.label&&(r.innerText=e.label)},destroyLoadingDiv:()=>{t&&i&&"maximized"!==i&&window.widget.requestView({type:i}),c&&c.destroy(),h&&h.destroy(),a&&a.destroy(),o&&o.destroy(),document.removeEventListener("keydown",g)}}}static abortExport(){U.isAborted=!0}static async exportPdfAsImage(e){window.PDFJS_VERSION="2.13.216";let t=await new Promise((e=>{window.require(["DS/PDFjs/PDFjs"],(t=>{e(t)}))})),o=0,r=0,i=[],n=t.getDocument({data:e}),a=await n.promise;if(a){for(let e=0;e<a.numPages;e++){let t=await a.getPage(e+1),n=t.getViewport({scale:1});t.canvas=s.createElement("canvas"),t.canvas.id="PDFcanvasPage"+t.number,t.canvas.height=n.height,t.canvas.width=n.width;let l=t.canvas.getContext("2d");l&&(l.fillStyle="white",l.fillRect(0,0,t.canvas.width,t.canvas.height));let d={canvasContext:l,viewport:n,enableWebGL:!0};await t.render(d).promise,r=t.canvas.height,o=t.canvas.width,t.canvas.id="PDFcanvasPage"+(e+1).toString(),l.putImageData(l.getImageData(0,0,window.innerWidth,window.innerHeight),0,r),l.drawImage(t.canvas,0,0,o,-r),i.push(await new Promise((e=>{t.canvas.toBlob((i=>{l.clearRect(t.canvas,0,0,o,-r),e(i)}))})))}return i}}static async generateExportDocument(e,t,o){var r,i;U.isAborted=!1;let n,l,d,p=g.getContextViewer({viewer:t.getViewer()}),w=!1;o({value:0,label:m.initializingExport});let P=function(t,o){if(!t)return;let r=t.getNode().getChildren();r&&r.length&&r.forEach((t=>{let r=t.getDMUType();if("DMUMarker3DText"===r||"DMUMarker3DStamp"===r||"DMUMarker3DPicture"===r){t.getChildren()[1].setVisibility(!0)}"pdf"===e&&"DMUClipping"!==r&&"DMUMeasure"!==r&&t.setVisibility(o)}))},S=function(e,t){let o=p.getViewer().SCREEN_WIDTH,r=p.getViewer().SCREEN_HEIGHT;return new Promise(((i,a)=>{n.setActiveSlide(e,{duration:1,isExporting:!0,afterSlideActivationCB:async()=>{P(e,!1);let n=s.createElement("canvas");n.set({height:r,width:o});let l=new ImageData(n.width,n.height);p.getViewer().renderToTarget(l,p.getViewer().currentViewpoint,!0),P(e,!0);let d=n.getContext("2d");if(d){d.putImageData(l,0,0),d.scale(1,-1),d.drawImage(n,0,0,n.width,-n.height);let e=await t.embedPng(n.toDataURL("image/png")),o=t.addPage([e.width,e.height]);o.drawImage(e,{width:e.width,height:e.height}),i(o)}a(new x.ExportError("Page not generated"))}})}))};const v=window.require("DS/WebDocumentVisualization/WebDocumentVisualizationController"),[E,k]=await new Promise((e=>window.require(["DS/DMUComment/DMUCommentExport","DS/DMUMarker/DMUMarkerExport"],((t,o)=>e([t,o])))));if(U.isAborted)throw new x.ExportCancel("Export cancelled");let A,I,T=v.giveWebDocumentVisualizationController({context:p});if(b=await new Promise((e=>{window.require(["DS/PDFLib/PDFLib"],(t=>{e(t)}))})),b){T?(I=T.getDocumentBuffer(),A=I,I=await b.PDFDocument.load(A,{ignoreEncryption:!0}),w=!0):b&&(I=await b.PDFDocument.create());try{l="true"===(await f.readPreferences([{Repository:"DMURepository",PreferenceNames:["ExportPersonalData"]}])).repositories[0].preferences[0].value}catch(e){l=!1,window.console.warn("Could not get server value, default value set instead.",e)}let s=g.getReviewContext({context:p}),P=!1;if(P=!s||!s.getCurrentSessionMarkup(),s&&s.getCurrentSessionMarkup()){let e=s.getCurrentSessionMarkup();e&&(P=!e.getActiveFlag()||!e.isVisible())}if(P&&T&&T.isADocumentDisplayed())return d=new Blob([A],{type:"application/pdf;base64"}),{blobData:d,fileName:"",reviewName:"",contextInfo:{owner:"",tempObjectInfo:{title:""},reviewDescription:"",reviewId:""},slideNames:[""]};if(s){if(I){let g=[],f="",P=s.getValidation();if(P)null===(r=P.getMarkups())||void 0===r||r.forEach((e=>{var t;let o=e.getRepRef(),r=null==o?void 0:o.getMarkupContent();r&&g.push({content:r,name:e.getName()}),null===(t=e.getReplies())||void 0===t||t.forEach((t=>{o=t.getRepRef();let r=null==o?void 0:o.getMarkupContent();r&&g.push({content:r,name:e.getName()})}))})),f=P.getName()||"";else{const e=s.getCurrentSessionMarkup();e&&(g.push({content:e,name:e.getAttribute("sName")||""}),f=e.getAttribute("sName")||"")}const b=s.getReviewCtxInformation()||{owner:"",tempObjectInfo:{title:""},reviewDescription:"",reviewId:"",reviewName:""};let v=l?await M.getUserName(b.owner):b.owner;const A=null===(i=b.tempObjectInfo)||void 0===i?void 0:i.title;b&&b.reviewName&&""!==b.reviewName&&(f=b.reviewName);const T=w?`${A}-${f}-${(new Date).toLocaleDateString().replace(/\//g,"-")}`:`${f}`;let F=[],R=0,L=[],N=[],O=w?void 0:1/c.getMMPerPtRatio();if(g&&g.length)for(let e=0;e<g.length;e++){const{content:t}=g[e];let o=t.getComments();if(o)for(const e of o)if(e instanceof u){if(U.isAborted)throw new x.ExportCancel("Export cancelled");F.push(await E.getCommentExportDefinition(e,l))}let r=t.getSlides();r&&r.length&&r.forEach((t=>{t.getAttribute("bMarkedAsDeleted")||(L.push({slide:t,markupName:g[e].name}),R++)}))}let V=function(e){if(!e||!e.length)return[];let t=[],o=[],r=[];for(let t=0;t<e.length;t++)e[t].slide.getAttribute("sParentSlideID")?r.push(e[t]):o.push(e[t]);for(let e=0;e<o.length;e++){let i=o[e];t.push(i);for(let e=0;e<r.length;e++){let o=i.slide.getAttribute("sUuid");r[e].slide.getAttribute("sParentSlideID")===o&&t.push(r[e])}}return t}(L);if(n=a.giveDMUSlidesController({context:p.getFrameWindow()}),V.length)for(let r=0;r<V.length;r++){if(U.isAborted)throw new x.ExportCancel("Export cancelled");let i=V[r].slide;if(w||(o({label:`${m.generatingSlides}: ${r+1} / ${R}`,value:80*(r+1)/R}),await S(i,I),N.push(`${r+1}_${i.getAttribute("sName")}`)),"pdf"===e){let e=i.getDMUObjects();for(let o=0;o<e.length;o++){if(U.isAborted)throw new x.ExportCancel("Export cancelled");const i=e[o];let n;try{i instanceof h?n=await k.getExportDefinition(i,l,t.getViewer(),w?void 0:r+1):i instanceof D&&!i.getAttribute("bMarkedAsDeleted")&&(n=await E.getExportDefinition(i,l,w?void 0:r+1))}catch(e){window.console.warn(e)}if(n){n.subject=V[r].markupName,n.comments&&n.comments.forEach((e=>{let t=F.filter((t=>t.parentCommentId===e.id));e.replies=t}));const e=I.getPage(w?n.pageNumber-1:r);e&&C.prepareAnnotationDefinition(e,n.definition,n.material,O,t.getViewer()),await C.createAnnotation(I,n)}}}}if(U.isAborted)throw new x.ExportCancel("Export cancelled");return o({label:m.exportPreparingDocumentMessage,value:80}),d=await async function({pdfDocument:t,metadata:o}){if(!t)throw new x.ExportError("No document to export");try{if(U.isAborted)throw new x.ExportCancel("Export cancelled");if(o&&(t.setTitle(o.title?o.title:""),t.setAuthor(o.author?o.author:""),t.setSubject(o.subject?o.subject:""),t.setCreator(o.creator?o.creator:"")),t.setCreationDate(new Date),t.setModificationDate(new Date),t.setProducer("3DEXPERIENCE - Dassault Systmes"),U.isAborted)throw new x.ExportCancel("Export cancelled");const r=await t.save();if(U.isAborted)throw new x.ExportCancel("Export cancelled");return"png"===e?await U.exportPdfAsImage(r):new Blob([r],{type:"application/pdf;base64"})}catch(e){throw window.console.error(e),new x.ExportError("Error during exporting document")}}({pdfDocument:I,metadata:{author:v||"",title:f||"",creator:window.widget&&window.widget.getValue("appId")?y[window.widget.getValue("appId")]:"",subject:b.reviewDescription||""}}),o({label:m.exportPreparingDocumentMessage,value:100}),{blobData:d,fileName:T,reviewName:f,contextInfo:b,slideNames:N}}throw new Error("Document buffer is undefined !")}throw new x.ExportError("Export error","No review context has been found")}throw new Error("PDFLib not found !")}static getDocumentIDsAndFileTypes(e){return new Promise(((t,o)=>{r.sendWebServiceCall({url:"resources/markup/service/getDocumentIDsAndFileTypes",config:{verb:"GET",data:`sMarkupID=${e}`},onSuccess:e=>{t({documents:JSON.parse(JSON.parse(e).AssociatedDocuments).data})},onFailure:e=>{o(new x.ExportError("Error when retrieving documents IDs and filetypes",e))}})}))}static createExportedDocument(e,t,o){return new Promise(((r,n)=>{let a=window.require("DS/PADUtils/PADSettingsMgt"),s=window.require("DS/PADUtils/PADUtilsServices");i.createDocument({title:t,description:o||"",relInfo:{parentId:e}},{tenantUrl:s.get3DSpaceUrl(),tenant:s.getPlatformId(),securityContext:a.getSetting("pad_security_ctx"),onComplete:e=>{let t=e.data[0];t?r({document:t}):n(new x.ExportError(e,"document"))},onFailure:e=>{n(new x.ExportError(e,"document"))}})}))}static getExportedDocument(e){return new Promise(((t,o)=>{let r=window.require("DS/PADUtils/PADSettingsMgt"),n=window.require("DS/PADUtils/PADUtilsServices");i.getDocuments([e],{tenantUrl:n.get3DSpaceUrl(),tenant:n.getPlatformId(),securityContext:r.getSetting("pad_security_ctx"),onComplete:function(e){let o=e.data[0];t({document:o})},onFailure:function(e){o(new x.ExportError("Error while fetching exported document",e))}})}))}static addFileToExportedDocument(e,t,o,r){return new Promise(((n,a)=>{let s=window.require("DS/PADUtils/PADSettingsMgt"),l=window.require("DS/PADUtils/PADUtilsServices");i.addFileToDocument({id:e,fileInfo:{file:new File([t],o+("pdf"===r?".pdf":".png"))}},{tenantUrl:l.get3DSpaceUrl(),tenant:l.getPlatformId(),securityContext:s.getSetting("pad_security_ctx"),onComplete:function(e){n({success:e})},onFailure:function(e){a(new x.ExportError("Error while adding files to exported document",e))}})}))}static deleteFileFromExportedDocument(e,t){return new Promise(((o,r)=>{let n=window.require("DS/PADUtils/PADSettingsMgt"),a=window.require("DS/PADUtils/PADUtilsServices");i.deleteFile(e,t,{tenantUrl:a.get3DSpaceUrl(),tenant:a.getPlatformId(),securityContext:n.getSetting("pad_security_ctx"),onComplete:function(e){o(e)},onFailure:function(e){r(new x.ExportError("Error while deleting files in exported document",e))}})}))}static changeDocumentMaturityState(e,t,o,r){return new Promise(((i,a)=>{let s=window.require("DS/PADUtils/PADSettingsMgt"),l=window.require("DS/PADUtils/PADUtilsServices");n.authenticatedRequest(l.get3DSpaceUrl()+"/resources/lifecycle/maturity/promote?tenant="+l.getPlatformId(),{method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:s.getSetting("pad_security_ctx")},timeout:36e5,data:JSON.stringify({data:[{physicalid:e,name:t,fromstate:o,tostate:r,type:"Document"}]}),onComplete:e=>{i(e)},onFailure:e=>{a(new x.ExportError("Failed to change the maturity of the exported document",e))},onTimeout:e=>{a(new x.ExportError("Process timed out while changing the maturity of the exported document",e))}})}))}static reviseDocument(e){return new Promise(((t,o)=>{let r=window.require("DS/PADUtils/PADSettingsMgt"),i=window.require("DS/PADUtils/PADUtilsServices");n.authenticatedRequest(i.get3DSpaceUrl()+"/resources/lifecycle/revise/major?tenant="+i.getPlatformId(),{method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:r.getSetting("pad_security_ctx")},timeout:36e5,data:JSON.stringify({data:[{physicalid:e}],command:"revise"}),onComplete:r=>{if("failure"===r.status)o(r);else{let i,n=r.results;n.length?n.forEach((o=>{o.derivedfromphysicalid===e&&(i=o.physicalid,t({physicalid:i}))})):o(r)}},onFailure:e=>{o(new x.ExportError(e,"revision"))},onTimeout:e=>{o(new x.ExportError(e,"revision"))}})}))}static updateDocumentTitle(e,t){return new Promise(((o,r)=>{let n=window.require("DS/PADUtils/PADSettingsMgt"),a=window.require("DS/PADUtils/PADUtilsServices");i.modifyDocument({title:t,id:e},{tenantUrl:a.get3DSpaceUrl(),tenant:a.getPlatformId(),securityContext:n.getSetting("pad_security_ctx"),onComplete:e=>{o(e)},onFailure:e=>{r(new x.ExportError(e,"document"))}})}))}static createSemanticRelation(e,t){return new Promise(((o,i)=>{let n=[];for(let e=0;e<t.length;e++)n.push(t[e].docId);r.sendWebServiceCall({url:"resources/markup/service/createExportedRelations",config:{verb:"POST",data:{sMarkupID:e,aNewPointedDocumentsIDs:n}},onSuccess:function(e){o(e)},onFailure:function(e){i(new x.ExportError(e,"relation"))}})}))}static updateSemanticRelations(e,t){return new Promise(((o,i)=>{let n=[];for(let e=0;e<t.length;e++)n.push(t[e].docId);r.sendWebServiceCall({url:"resources/markup/service/updateExportedRelations",config:{verb:"POST",data:{sMarkupID:e,aNewPointedDocumentsIDs:n}},onSuccess:function(e){o(e)},onFailure:function(e){i(new x.ExportError(e,"relation"))}})}))}}return U.isAborted=!1,U})),define("DS/DMUPersistence/DMUExportReviewAsPDFOrPNGCmd",["require","exports","DS/CoreEvents/Events","DS/DMUBaseUIControllers/DMUSlidesController","DS/CATWebUXComponents/DMUCommand","DS/DMUPersistence/DMUExportServices","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPUtils","DS/DMUPersistence/DMUErrorClasses","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],(function(e,t,o,r,i,n,a,s,l,d){"use strict";return class extends i{constructor(e){super(e),this.beginExecute=async()=>{super.beginExecute();let t=this,i=e.executionContext.getComponent("Viewer"),c=a.getContextViewer({viewer:i.getViewer()}),p="DMUExportMarkupAsImageHdr"===this.getId()?"png":"pdf",g=r.giveDMUSlidesController({context:c.getFrameWindow()}),u=g.getActiveSlide(),h=window&&window.widget?window.widget.getView().type:null;const{loadingDivView:D,disableCancel:M,updateLoadingValue:f,destroyLoadingDiv:x}=n.displayLoadingDiv((()=>{n.abortExport()}),void 0);"DMUExportMarkupAsImageHdr"!==this.getId()&&"DMUExportMarkupAsPdfHdr"!==this.getId()||!window.widget.getView||"maximized"===window.widget.getView().type||await new Promise((e=>{window.widget.requestView({type:"maximized"}),window.widget.addEventOnce("onViewChange",(t=>{t&&t.type&&"maximized"===t.type&&e()}))}));try{D.inject(c.elements.container);let e=await n.generateExportDocument(p,i,(e=>{f({value:.75*e.value,label:e.label})})),o=e.blobData,r=e.fileName,a=e.reviewName,g=e.contextInfo,u=e.slideNames;if(n.isAborted)throw new l.ExportCancel("Export cancelled");if(!o)throw new l.ExportError("Export error","Blob is missing");M(),f({label:d.checkForLinkedDocument,value:75});let h,x="",m=!1,y=Array.isArray(o)?o:[o],w=0,{documents:P}=await n.getDocumentIDsAndFileTypes(g.reviewId);if(P.length)for(let e=0;e<P.length;e++)p===P[e].fileType&&(x=P[e].docId,w=e);if(""!==x){f({label:d.newRevision,value:80}),x=(await n.reviseDocument(x)).physicalid,h=(await n.getExportedDocument(x)).document,x=h.id,P[w].docId=x,f({label:d.updateFiles,value:85}),h.dataelements.title!==a&&await n.updateDocumentTitle(x,a),"PRIVATE"===h.dataelements.state&&await n.changeDocumentMaturityState(x,h.dataelements.name,"PRIVATE","IN_WORK");let e=h.relateddata.files||[],o=[];if(e&&e.length){o=[];for(let t=0;t<e.length;t++)o.push(n.deleteFileFromExportedDocument(x,e[t].id));await Promise.all(o)}s._sendUsageProbe("command",t.getId(),"Export [REVISION]")}else{m=!0,f({label:d.createDocument,value:80}),h=(await n.createExportedDocument(g.reviewId,a||"",g.reviewDescription)).document,x=h.id,1===P.length&&(P[0]={docId:x,fileType:p}),s._sendUsageProbe("command",t.getId(),"Export [CREATION]")}f({label:d.addFiles,value:85});let b=[];for(let e=0;e<y.length;e++)b.push(n.addFileToExportedDocument(x,y[e],"pdf"===p?r:u[e],p));await Promise.all(b),f({label:d.setMaturity,value:90}),await n.changeDocumentMaturityState(x,h.dataelements.name,"IN_WORK","FROZEN"),await n.changeDocumentMaturityState(x,h.dataelements.name,"FROZEN","RELEASED"),f({label:d.createRelation,value:95}),m?await n.createSemanticRelation(g.reviewId,P):await n.updateSemanticRelations(g.reviewId,P),f({label:d.done,value:100}),c.displayNotification({msg:"ENOR3D_AP"===window.widget.getValue("appId")?d.exportMarkupSuccess:d.exportReviewSuccess,eventID:"success"})}catch(e){let t,o;if(window.console.log(e),e instanceof l.ExportCancel)o=d.exportCancel,t={msg:d.exportCancel,eventID:"info"};else{switch(o=d.exportError,e.cause){case"document":t={label:d.exportDocError,msg:d.creationError,eventID:"error"};break;case"revision":t={label:d.exportDocError,msg:d.revisionError,eventID:"error"};break;case"relation":t={label:d.exportDocError,msg:d.relationError,eventID:"error"};break;default:t={msg:d.exportError,eventID:"error"}}}c.displayNotification(t),f({label:o})}finally{s._sendUsageProbe("command",t.getId(),""+("png"===p?"Export as PNGs":"DMUExportReviewAsPdfHdr"===t.getId()?"Export as PDF from document markup":"Export as PDF from slides markup")),h&&"maximized"!==h&&window.widget.requestView({type:h}),n.isAborted||o.publish({event:"onDMUExportedDocumentDone"}),await g.setActiveSlide(u,{duration:0,isExporting:!0,thumbnailViewUpdate:!0,afterSlideActivationCB:()=>{x(),t.done()}})}}}}})),define("DS/DMUPersistence/DMUPrintCmd",["require","exports","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/WAFData/WAFData","DS/MMPrint/MMPrintCmd","DS/DMUBaseUIControllers/DMUSlidesController","DS/CATWebUXComponents/DMUCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUPersistence/DMUExportServices","DS/DMUBaseExperience/EXPUtils","DS/DMUPersistence/DMUErrorClasses","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],(function(e,t,o,r,i,n,a,s,l,d,c,p,g){"use strict";return class extends s{constructor(e){e.mode="shared",super(e),this.beginExecute=async()=>{var t;super.beginExecute();let s,u,h=e.frameWindow||this.getFrameWindow(),D=h.getViewer(),M=l.getContextViewer({viewer:D}),f=M.getRootBagPath().externalPath[0].path.getChildrenPathes().length,x=window&&window.widget?window.widget.getView().type:null;f&&(s=M.getRootBagPath().externalPath[0].path.getChildrenPathes()[f-1]);let m=o.getNodeType(s.getLastElement(!0));const{loadingDivView:y,updateLoadingValue:w,destroyLoadingDiv:P}=d.displayLoadingDiv((()=>{d.abortExport()}));window.widget.getView&&"maximized"!==window.widget.getView().type&&await new Promise((e=>{window.widget.requestView({type:"maximized"}),window.widget.addEventOnce("onViewChange",(t=>{t&&t.type&&"maximized"===t.type&&e()}))}));let b=function(e){switch(e){case"cancel":throw new Error("Print has been cancelled");case"failure":throw new Error("Print has failed");default:throw new Error("Something went wrong during print")}},S=l.getReviewContext({context:M}),v=!1;if(v=!S||!S.getCurrentSessionMarkup(),S&&S.getCurrentSessionMarkup()){let e=S.getCurrentSessionMarkup();e&&(v=!e.getActiveFlag()||!e.isVisible())}if(v&&"Drawing"===m){let a=r.getManager({name:"DMU2DSheetManager",context:M.getFrameWindow()}),l=new n(e);l.getFrameWindow=this.getFrameWindow;let d=o.getNodeID(s.getLastElement(!0));a.load2DDocument(d,m,M.getRootBagPath().getChildrenPathes()[M.getRootBagPath().getChildrenPathes().length-1].getLastElement(!0));let p=a.getLoadedDocuments(),g=p[0].sheetNodes.findIndex((e=>e.modelID===p[0].activatedSheet)),u={tenant:window.require("DS/PADUtils/PADSettingsMgt").getSetting("x3dPlatformId"),physicalid:p[0].parentID};if(p[0]&&(null===(t=p[0])||void 0===t?void 0:t.svg)){(function(){M.getController().getAttributes({ids:[d],attributes:["svg"],callbacks:{onComplete:function(e){if(e[d]){let t={method:"GET",authentication:"passport",proxy:"none",type:"text",timeout:6e4,cache:3600,onComplete:function(e){let t={currentSheetIndex:g,numberOfSheets:p[0].sheetNodes.length,svgStream:e};h.drawingPrintInfo=t,h.assetInfo=u,null==l||l.beginExecute()},onCancel:()=>{b("cancel")},onFailure:()=>{b("failure")}};i.handleRequest(e[d].svg,t)}else b()},onFailure:()=>{b("failure")}}})})()}else{let e=p[0].activatedSheet,t=p[0].UDLLoader.getSheetSize(e),o={currentSheetIndex:g,numberOfSheets:p[0].sheetNodes.length,svgStream:null,currentSheetSize:t};h.drawingPrintInfo=o,h.assetInfo=u,null==l||l.beginExecute()}c._sendUsageProbe("command","PrintDrawingWithMarkupCommand","Print drawing with native command")}else{let e=!1,t=a.giveDMUSlidesController({context:M.getFrameWindow()}),o=t?t.getActiveSlide():void 0;try{y.inject(M.elements.container);let e=await d.generateExportDocument("pdf",M,(e=>{if(d.isAborted)throw new p.ExportCancel("Export cancelled");w({value:e.value,label:e.label})}));u=null==e?void 0:e.blobData,function(e){if(!e||d.isAborted)throw new p.ExportCancel("Export cancelled");const t=window.URL.createObjectURL(e),o=window.open(t,"","width=800,height=600");document.createElement("a").href=t,o.addEventListener("load",(function(){o.focus(),o.print(),o.addEventListener("unload",(function(){URL.revokeObjectURL(t)}))}),!0)}(u)}catch(e){let t,o;window.console.log(e),e instanceof p.ExportCancel?(o=g.exportCancel,t={msg:g.exportCancel,eventID:"info"}):(o=g.exportError,t={msg:g.printError,eventID:"error"}),M.displayNotification(t),w({label:o})}finally{x&&"maximized"!==x&&window.widget.requestView({type:x}),t&&o&&await t.setActiveSlide(o,{duration:0,isExporting:!0,thumbnailViewUpdate:!0}),P()}c._sendUsageProbe("command",this.getId(),"PrintPDFCommand"+(e?"WithMarkup":"WithoutMarkup"))}null==h||delete h.drawingPrintInfo,null==h||delete h.assetInfo,this.end&&this.end(),this.done()}}}})),define("DS/DMUPersistence/DMUAuthPersistenceServices",["UWA/Utils","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUPlayMarkup/DMUMarkup","DS/DMUBaseExperience/DMULinksManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUPlaySlide/DMUSlide","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/DMUPersistence/DMUAuthPersistenceUtils","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],(function(e,t,o,r,i,n,a,s,l,d,c,p,g,u,h){"use strict";return{createSessionMarkup:async function(a,p,D,M,f){if(a){var x=a.getViewer(),m=a.getFrameWindow(),y=t.getReviewContext({context:a}),w=null,P=null,b={entities:null,occurrences:null};if(y&&((w=y.getTransientReviewBag())&&"DMUTemporaryBag"===w.getType()&&(P=w.getAttribute("oLinksManager")),P&&P.exportLinksManagerData(b)),y||(y=await o.createReviewContext({context:a})),w=new r(x,y),P=new i(x,w),(b.entities&&b.entities.length>0||b.occurrences&&b.occurrences.length>0)&&P.importLinksManagerData(b),w.setAttributes([{name:"oLinksManager",value:P},{name:"sName",value:p}]),w.setMaturityState("IN_WORK"),y.setCurrentSessionMarkup(w),n.setSlidePreferences({context:m,preferences:{panelTitle:p}}),f){let o,r=1,i=u.giveReqCompareController({context:a});i&&i.isRequirementCompareActive()&&(r=2);for(let i=0;i<r;i++){const r=y.getCurrentSessionMarkup();o=new s(x,r),o.setAttributes([{name:"sID",value:w.computeNewID()},{name:"sUuid",value:e.getUUID()}]),o.updateEnvironmentOverload({target:y.getEnvironment(),state:y.getEnvironment().getEnvironmentInfo()}),r.addSlide(o);var S=null,v=l.giveDMUApplicativeContextManager({context:t.getContextViewer({viewer:x})});if(v){var C,U,E=v?v.getApplicativeControllers():[];let e=[];for(var k=0;k<E.length;k++){U=E[k].getApplicativeContainerID();var A=await v.getVerifiedApplicativeContainerState(U);if(A){let t;o.setSlideApplicativeContext(U,A),null,(C=E[k].getCurrentAppContainerStateTitle())&&(S?S+=" - ":S="",S+=C);try{t="true"===(await g.readPreferences([{Repository:"DMURepository",PreferenceNames:["SlideNameFromFeature"]}])).repositories[0].preferences[0].value}catch(e){t=!0,window.console.warn("Could not get server value, default value set instead.",e)}if(t&&E[k]&&E[k].getFeatureInformation){let t=E[k].getFeatureInformation();t&&t.name&&e.push(t.name)}o.setSlideApplicativeContext(U,A)}}1===e.length&&e[0]&&(S=e[0])}S&&!S.length&&(S=null),o.setAttribute("sName",w.computeNewName({object:o,prefix:S||h.createMarkup.slideTitle,noSuffixIfPossible:null!==S,separator:null!==S?"parenthesis":null})),o.fireEvent("onDMUObjectInitialized",{dmuObject:o})}await d.copyTransientMarkersAndOverloads(w,o,a,D,M),y.getTransientReviewBag().removeDMUObjects(),i&&i.isRequirementCompareActive()&&await i.addActiveCompareToNewSlide(o);var I=c.giveDMUSlidesController({context:m});I&&I.setActiveSlide(o,{duration:0})}return w}},getPossibleRootContexts:function(e){if(!e)return[];var t=e.getRootBagPath().getChildrenPathes();if(t.length>1){var o=p.getDMUSceneDisplayController({context:e});if(o){let e=o.getCurrentComparedObjectIDPaths();if(e&&e.firstObject&&e.secondObject)for(let o=t.length-1;o>=0;o--)if(e.secondObject[0]===a.getNodeID(t[o].getLastElement(!0))){t.splice(o,1);break}}let r=u.giveReqCompareController({context:e});if(r){let e=r.getCurrentComparedObjectIDPaths();if(e&&e.firstObject&&e.secondObject)for(let o=t.length-1;o>=0;o--)if(e.secondObject===a.getNodeID(t[o].getLastElement(!0))){t.splice(o,1);break}}}return t}}})),define("DS/DMUPersistence/DMUCreateMarkupCmd",["UWA/Core","DS/CATWebUXComponents/DMUCommand","DS/CATWebUXComponents/CATWebUXNotification","DS/DMUBaseExperience/DMUContextManager","DS/DMUPersistence/DMUSaveServices","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/Controls/ComboBox","DS/Controls/LineEditor","DS/Controls/Editor","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUReadPersistence/DMULoadingContextController","DS/Windows/Dialog","DS/Controls/Button","DS/Utilities/TouchUtils","DS/DMUControls/DMUInfoModalDiv","DS/DMUPersistence/DMUAuthPersistenceServices","DS/DMUPersistence/DMUAuthPersistenceUtils","i18n!DS/DMUPersistence/assets/nls/DMUPersistence","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","css!DS/DMUPersistence/DMUPersistence.css"],(function(e,t,o,r,i,n,a,s,l,d,c,p,g,u,h,D,M,f,x){"use strict";return t.extend({init:function(t){t.mode="shared",t.repeatMode=!1,t.isAsynchronous=!0,this._parent(t);var m,y,w,P,b,S,v,C,U,E,k=this,A=t.frameWindow||this.getFrameWindow(),I=A.getViewer(),T=[];let F,R,L=null,N=!1;var O=[],V=[];function B(){v=null,C=null,E&&(E.destroy(),E=null),T=[],y&&y.destroy(),m&&m.destroy(),y=m=null,P=b=S=void 0,v=C=void 0,k.end?k.end():k.done()}function j(e){y||(y=new o),y.build({type:"error",autoHide:!0,message:f.createMarkup.errorMessage,body:A.getUIFrame()});var t=r.giveEventsController({viewer:I});t&&t.fireEvent("onDMUMarkupCreationFailed"),window.console.error(e),B()}function W(){if(!w)return;var e,t,o,a;S?(e=S.value,S.elementsList&&S.elementsList.length>=1&&Object.keys(S.elementsList).forEach((t=>{let r=S.elementsList[t];r.valueItem===e&&(o=r.strURI)}))):(e=T[0].valueItem,o=T[0].strURI),C&&(a=(a=JSON.stringify(C)).substring(1,a.length-1));const s=w.getController().getRootStats(e)&&w.getController().getRootStats(e).serviceId?w.getController().getRootStats(e).serviceId:"";!function(e){var t=r.getReviewContext({viewer:I});i.isCreatingAMarkup(!0);var o=[];e.parentID&&o.push(e.parentID),e.subContext&&e.subContext.id&&o.push(e.subContext.id),n.sendWebServiceCall({url:"resources/markup/service/createmarkup",config:{verb:"POST",data:{sTitle:e.reviewName,sContextIds:o,sDescription:e.reviewDescription?e.reviewDescription:"",sServiceId:e.serviceID,sExternalID:U,strURI:e.strURI?e.strURI:"",appData:e.appData?e.appData:""}},onSuccess:function(t){var o=JSON.parse(t);e.onMarkupCreationCompleted(o),i.isCreatingAMarkup(!1)},onFailure:function(o){e.onMarkupCreationFailed(o),i.isCreatingAMarkup(!1),t&&t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().setActiveFlag(!1)}})}({reviewName:v,reviewDescription:a,parentID:e,subContext:t,subContextId:t?t.id:void 0,serviceID:s,strURI:o,onMarkupCreationCompleted:async function(o){var i=await D.createSessionMarkup(w,v,O,V,F);if(L||(L=c.getLoadingContextController({context:w})),L){let o=L.getSubContextInformations(e);o&&o.id&&(t=o)}var n=r.getReviewContext({viewer:I});if(n&&n.setReviewCtxInformation({contextId:e,subContext:t,subContextId:t&&t.id?t:void 0,reviewId:o.pId,reviewName:v,modifiable:!0,reviewDescription:a||"",reviewType:"DMUMarkupRepReference",owner:o.owner,tempObjectInfo:L?L.getTempObjectInformations():void 0}),E&&(E.destroy(),E=null),i){if("r2vsurvey"===s){w.toggleSOITimelinesUsability(!1);const e=r.giveEventsController({viewer:I});e&&e.fireEvent("onR2VMarkupCreationSuccess")}i.fireEvent("onDMUObjectInitialized",{dmuObject:i}),i.fireEvent("onDMUMarkupCreationSucceeded",{dmuObject:i}),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","CreateMarkup")})),setTimeout((function(){B()}))}},onMarkupCreationFailed:j})}r.setAuthoringFeatureTypes("Markup"),this.beginExecute=function(){N||(N=!0,setTimeout((function(){N=!1}),500),new Promise((e=>{n.sendWebServiceCall({url:"resources/markup/service/generateName",config:{verb:"POST",data:JSON.stringify({sType:"DMUMarkupRepReference"})},onSuccess:function(t){e(t?{markupName:JSON.parse(t).title,externalID:JSON.parse(t).name}:{})}})})).then((t=>{var o;if(U=t.externalID,w=r.getContextViewer({viewer:I})){var i,n,y,k=D.getPossibleRootContexts(w),N=[],z=[];for(o=0;o<k.length;o++){var q=w.getController().isFiltered(d.getNodeID(k[o].getLastElement(!0)));L=c.getLoadingContextController({context:w});var H=L.getLoadedWorkplanInformations();let e=L.getLoadedFMEAInformations();if(w.getApplicativeData&&w.getApplicativeData().getLoadedItfData&&w.getApplicativeData().getLoadedItfData().data.length){w.getApplicativeData().getLoadedItfData().data.forEach((function(e){N.push({rootID:e.isrID,type:"ISR"})}));break}if(H)(N=[]).push({rootID:H.id,type:H.type});else if(e)(N=[]).push({rootID:e.id,type:e.type});else if(q.filterId)N.push({rootID:q.filterId,type:"Filter"});else{const e=d.getNodeID(k[o].getLastElement(!0));""!==e&&N.push({rootID:e,type:w.getController().getRootStats(e)&&"r2vsurvey"===w.getController().getRootStats(e).serviceId?"R2V_Activity":d.getNodeType(k[o].getLastElement(!0))})}}N.length&&new Promise((function(e){var t=0;N.forEach((function(o){if("R2V_Activity"===o.type){L||(L=c.getLoadingContextController({context:w}));L.getLoadedR2VInformations().forEach((r=>{r.id===o.rootID&&(t++,T.push({labelItem:r.info[0]["ds6w:label"],iconItem:r.info[0].icon||r.info[0]["ds6w:icon"],valueItem:o.rootID,type:y,strURI:r.strURI?r.strURI:void 0}),t===N.length&&e())}))}else w.getController().getAttributes({ids:[o.rootID],attributes:["ds6w:label","ds6wg:revision","type_icon_url","ds6w:type"],callbacks:{onComplete:function(r){t++,r[o.rootID]&&(i=r[o.rootID].type_icon_url,n=r[o.rootID]["ds6w:label"],y=r[o.rootID]["ds6w:type"],r[o.rootID]["ds6wg:revision"]&&(n+=" "+r[o.rootID]["ds6wg:revision"]),z.push(n),"R2V_Activity"!==y&&T.push({labelItem:n,iconItem:i,valueItem:o.rootID,type:y}),t===N.length&&e())},onFailure:function(){t++;[{type:"Filter",label:"Filter"},{type:"Document",label:"Document"},{type:"ISR",label:"Iterference Simulation"},{type:"PLMPIMMetricReference",label:"Iterference Metric"},{type:"DesignSight",label:"Physics Simulation"},{type:"Requirement",label:"Requirement"},{type:"Requirement Specification",label:"Requirement Specification"}].some((r=>{if(o.type===r.type)return z.push(r.label),T.push({labelItem:r.label+t,valueItem:o.rootID,type:r.type}),e(),!0}))}}})}))})).then((async function(){try{let e=(await x.readPreferences([{Repository:"DMURepository",PreferenceNames:["CreateFirstSlide","DisplayMarkupCreationDialog"]}])).repositories[0].preferences;for(let t=0;t<e.length;t++)"CreateFirstSlide"===e[t].name?(F="true"===e[t].value,N[0]&&N[0].type&&("Document"===N[0].type||"Requirement"===N[0].type||"Requirement Specification"===N[0].type)&&(F=!0)):"DisplayMarkupCreationDialog"===e[t].name&&(R="true"===e[t].value)}catch(e){F=!0,R=!0,window.console.warn("Could not get server value, default value set instead.",e)}v||(v=t.markupName);var o=r.getReviewContext({context:w}),i=function(){m&&m.destroy(),async function(){let e;if((E=new h).display({modal:!0,frmWindow:A,type:"load",message:f.createMarkup.loadingMessage}),e=S?S.value:T[0].valueItem,F){let t=await M.getTransientMarkersAndOverloads(o,w,e);V=t.overloads,O=t.markers}o&&o.getCurrentSessionMarkup()?new Promise(((e,t)=>{let o=r.giveEventsController({viewer:I});if(o){let r,n,a=null;var i=function(){o.removeEvent(r),o.removeEvent(n),o.removeEvent(a)};r=o.addEvent("on3DMarkupSaved",(function(){i(),e()})),n=o.addEvent("on3DMarkupSaveNotNeeded",(function(){i(),e()})),a=o.addEvent("on3DMarkupSaveFailed",(function(){i(),t(new Error("Issue when trying to save the markup stream"))})),o.fireEvent("onSaveRequested")}})).then(W,j):W()}()};if(R||T.length>1||o&&o.getCurrentSessionMarkup()){var n,d,D,y=e.createElement("div",{class:"DMUCreateMarkupPanelMainDiv"});if(T.length>1){var U=e.createElement("p",{class:"DMUCreateMarkupPanelLabel"}).inject(y);U.setStyles({width:"calc(100% - 20px)",paddingLeft:"10px",paddingRight:"10px",margin:0}),U.innerText=f.createMarkup.multipleRootsLabel,(S=new a({elementsList:T,selectedIndex:0,enableSearchFlag:!0,actionOnClickFlag:!1}).inject(y)).elements.container.setStyles({width:"calc(100% - 10px)",margin:"5px"}),S.addEventListener("change",(function(){b.value=S.label}))}var k=function(){var t=""===P.value;n.disabled=t,n.disabled||(v=P.value,C=b.value),d.innerHTML="",D.innerHTML="";var o=e.createElement("span",{class:"wux-ui-genereatedicon-fi wux-ui-3ds wux-ui-3ds-required wux-ui-3ds-lg"});o.setStyles({color:"#E87B00",display:"inline-block","font-weight":"bold"});var r=e.createElement("span",{class:"condBadString"});r.innerHTML=f.createMarkup.condBadString,r.setStyles({color:"#E87B00",display:"inline","font-weight":"bold","font-style":"italic"}),t&&o.inject(d),d.setStyle("display",""!==d.innerHTML?"":"none"),D.setStyle("display",""!==D.innerHTML?"":"none")},z=e.createElement("div",{class:"DMUCreateMarkupPanelLineEditorSection"}).inject(y);z.setStyles({paddingTop:"0px"});var q=e.createElement("div").inject(z),H=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(q);H.setStyles({marginRight:"5px"}),(d=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(q)).setStyles({color:"#E87B00",display:"none"}),H.innerHTML=f.createMarkup.nameLabel,(P=new s({placeholder:f.createMarkup.namePlaceholder,value:v||"",selectAllOnFocus:!0,maxLength:100,autoCommitFlag:!0}).inject(z)).elements.container.setStyles({width:"100%"}),P.elements.container.childNodes[0].setStyles({width:"100%"}),P.addEventListener("change",k);var _=e.createElement("div",{class:"DMUCreateMarkupPanelLineEditorSection"}).inject(y),G=e.createElement("div").inject(_),X=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(G);if((D=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(G)).setStyles({color:"red",display:"none","font-weight":"normal","font-style":"italic"}),!C)if("Specification Report"===T[0].type){if(L||(L=c.getLoadingContextController({context:w})),L){let e=L.getSubContextInformations(T[0].valueItem);e&&e.id&&(C=e.label)}}else C=T[0].labelItem;if(X.innerHTML=f.createMarkup.descriptionLabel,(b=new l({nbRows:5,newLineMode:"shiftEnter",placeholder:f.createMarkup.descriptionPlaceholder,value:C||"",selectAllOnFocus:!0,maxLength:256,autoCommitFlag:!0}).inject(_)).elements.container.setStyles({width:"100%"}),b.elements.container.childNodes[0].setStyles({width:"100%"}),b.addEventListener("change",k),o&&o.getCurrentSessionMarkup()){var J=e.createElement("p",{class:"DMUCreateMarkupPanelLabel"}).inject(y);J.innerHTML=f.createMarkup.warningMessage,J.setStyles({color:"#e87b00","font-weight":"normal","font-style":"italic",margin:"0","margin-top":"10px"})}(n=new g({emphasize:"primary",label:f.createMarkup.createMarkupButton,onClick:i})).getContent().addClassName("markupCreationButton");var $=new g({label:f.createMarkup.cancelButton,onClick:function(){let e=r.giveEventsController({viewer:I});e&&e.fireEvent("onDMUMarkupCreationCancelled"),m&&m.destroy(),B()}});m=new p({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:f.createMarkup.panelTitle,resizableFlag:!0,immersiveFrame:A.getImmersiveFrame(),position:u.getTouchMode()?{my:"center bottom"}:void 0,buttons:{Ok:n,Cancel:$},width:400,content:y});let t=r.giveEventsController({viewer:I});t&&t.fireEvent("onDMUMarkupCreationPanelDisplayed"),o&&o.getCurrentSessionMarkup()&&(n.emphasize="medium-attention",n.icon={iconName:"warning",fontIconFamily:WUXManagedFontIcons.font3DS}),m.addEventListener("close",(function(){t&&t.fireEvent("onDMUMarkupCreationCancelled"),B()})),k()}else i()}))}else B()})))},this.cancelExecute=function(){B()},this.setDefaultInfo=function(e){v=e.title,C=e.description}}})}));