define("DS/DMUMarker/DMUMarkerTextCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DText","DS/DMUPlayMarker/DMUMarker3DStamp","DS/DMUPlayMarker/DMUMarker2DText","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUI/DMUToolsUsers","DS/Utilities/TouchUtils","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUBaseUI/assets/nls/DMUBaseUI","i18n!DS/DMUMarker/assets/nls/DMUMarker"],(function(e,t,n,i,r,a,o,l,s,d,c,u,g,h,m,f,p,D){"use strict";return t.extend({init:function(t){let M,v,C,S="markerTextCmdHdr"===t.ID||"DMUCreateRejectedMkrHdr"===t.ID||"DMUCreateValidatedMkrHdr"===t.ID?"3D":"2D",y="DMUCreateRejectedMkrHdr"===t.ID||"DMUCreateValidatedMkrHdr"===t.ID,P=this,U=null,w=!1,b=!0,x="Validated",k="Rejected";function A(){U.fireEvent("onDMUObjectInitialized",{dmuObject:U}),P.addInCSO(U),b&&!g.getTouchMode()&&U.startEdition(),P._endExecute()}function E(){var e=null;if(P._clickEventData&&P._clickEventData.from&&P._clickEventData.from.length){var t=M.getMousePosition(P._clickEventData.from[0].getCurrentPosition(M.canvas)),n=M.pick(t,"primHybrid",!0);n&&n.path.length&&(e=n.path[0])}return e}function F(e,t){if(t){let i;if(e&&t.associatedMarkers&&t.associatedMarkers.length&&t.userData&&"Requirement Specification"!==t.userData.type){for(var n=0;n<t.associatedMarkers.length;n++)t.associatedMarkers[n]&&(t.associatedMarkers[n].setAttribute(-1!==t.associatedMarkers[n].getType().indexOf("Stamp")?"lTextComment":"sTextContents",[e]),t.associatedMarkers[n].fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:t.associatedMarkers[n]}),i=t.associatedMarkers[n]);t.associatedMarkers=void 0,i&&i.startEdition&&!g.getTouchMode()&&i.startEdition(),M.render()}}}async function T(c,g){var T=c[0].position,I="3D"===S?r.getWindowPositionFromPoint(M,T,P._frmWindow):r.getViewerPositionFromPoint(M,T),L=r.getDistanceFromPixel(M,T,100,P._frmWindow);I.top<100&&(L=-L);var _,V=r.getViewpointInfo(M.currentViewpoint).up.clone().multiplyScalar(L),H=T.clone().add(V);if(g&&(H=g),v||(v=new d(M)),v.createHVAxis(T,{key:"Shift",keyCode:16},t.dragEventCallback),v.activate(),"3D"===S)_=T.clone();else{var B=r.getViewerPositionFromPoint(M,T);_=[new i.Vector2(B.left,B.top)]}var R=a.getReviewContext({viewer:P.getFrameWindow().getViewer()}),O=R.getCurrentSessionMarkup();let W;U=!1===y?"3D"===S?new o(M,O):new s(M,O):new l(M,O),C&&await C,y&&(W="DMUCreateRejectedMkrHdr"===t.ID?k:x,W||(W="DMUCreateRejectedMkrHdr"===t.ID?p.defaultRejectedStampLabel:p.defaultValidatedStampLabel)),U.setAttributes([{name:"sID",value:O.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:O.computeNewName({object:U,prefix:"3D"===S?D.text3DPrefix:D.text2DPrefix})},{name:"sTextContents",value:y?[W]:[D.markertext.standard]},{name:"lLeaderPointingPoints",value:"3D"===S?[P.getRelativePosition(_)]:_},{name:"bHasALeader",value:"3D"===S},{name:"sLeaderEndType",value:"Arrow"},{name:"cLineStyleColor",value:new i.Color("#afafaf")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!0},{name:"fFontSize",value:4.23},{name:"fBorderRadius",value:!0===y?0:4},{name:"fPointedPageNumber",value:P.getPageNumber()},{name:"sPointedElementID",value:P.getElementId(_)}]),"3D"===S?U.setAttribute("vLeaderBreakPoint3D",P.getRelativePosition(H)):U.setAttribute("vLeaderBreakPoint2D",_[0]),!0===y&&U.setAttributes([{name:"sOwner",value:u.getUserLogin()},{name:"sStampType",value:"DMUCreateRejectedMkrHdr"===t.ID?"Rejected":"Validated"},{name:"lTextComment",value:[""]},{name:"fCreationDate",value:Date.now()}]);var N=O.getCurrentSlide();if(N.addDMUObject(U),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command",(y?"CreateStamp":"CreateText")+S+N.getType())})),b=!0,"3D"===S){var z=!0,j=E();if(j&&(z=!1),!j&&c[0].pathElement?j=c[0].pathElement:!j&&P._selectedPathElement&&void 0!==g&&(j=P._selectedPathElement),j){if(n.isAPOIPath(j)){const{position:e,label:t}=m.getPOIInformationFromPathElement(j);e&&U.setAttributes([{name:"lLeaderPointingPoints",value:[e]},{name:y?"lTextComment":"sTextContents",value:[t||(y?W:D.markertext.standard)]}])}var q=function(e){return!(!(e&&e.getLastElement(!0)&&e.getLastElement(!0).getDMUType)||"DMUSection"!==e.getLastElement(!0).getDMUType()&&"DMUClipping"!==e.getLastElement(!0).getDMUType())||!!e.getParentPath()&&q(e.getParentPath())};if(z&&q(j)&&(j=E()),j){let e="";if(j.internalPath.length){let t=[],n=h.giveDMUApplicativeContextManager({context:a.getContextViewer({viewer:P.getFrameWindow().getViewer()})});if(n){var X=n.getApplicativeControllers();if(X&&X.length)for(let e=0;e<=X.length;e++)if(X[e]&&X[e].getFeatureInformation){let n=X[e].getFeatureInformation(j);n&&n.name&&t.push(n.name)}1===t.length&&t[0]&&(e=t[0],U.setAttribute(!0===y?"lTextComment":"sTextContents",[e]),U.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:U}))}}if(!e){var G=n.getLastReference(j);if(G){var K=G.getLastElement(!0);if(K){K.associatedMarkers||(K.associatedMarkers=[]),K.associatedMarkers.push(U),b=!1;let e=f.giveReqCompareController({context:a.getContextViewer({reviewContext:R})});if(e&&e.isRequirementCompareActive()&&e.getActiveCompareTitle().length){F(e.getActiveCompareTitle()[0]+" | "+e.getActiveCompareTitle()[1],K)}else n.getName([K],(function(e){e&&1===e.length&&e[0]&&F(e[0].slice(),K)}),a.getContextViewer({reviewContext:R}),"")}}}}}}w||A()}a.setAuthoringFeatureTypes("Marker"),y&&t.executionContext&&(C=new Promise((async(e,t)=>{await c.readPreferences([{Repository:"DMURepository",PreferenceNames:["MarkerValidatedStampLabel","MarkerRejectedStampLabel"]}]).then((t=>{let n=t.repositories[0].preferences;for(let e=0;e<n.length;e++)"MarkerValidatedStampLabel"===n[e].name?x=n[e].value:"MarkerRejectedStampLabel"===n[e].name&&(k=n[e].value);e()})).catch((e=>{window.console.warn("Could not get server value, default value set instead.",e),t(e)}))}))),t.dragEventCallback=function(e){if(U){var t=r.getViewerPositionFromPoint(M,e.vCurrentPosition);if(t=r.get2DSnappedPosition(new i.Vector2(t.left,t.top)),e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey){var n=r.getViewerPositionFromPoint(M,e.vStartPosition);Math.abs(t.y-n.top)>=Math.abs(t.x-n.left)?t.setX(n.left):t.setY(n.top)}if("3D"===S){let n=P.getElementId(e.vCurrentPosition);U.setAttribute("vLeaderBreakPoint3D",P.getRelativePosition(r.getPositionFromIntersection(M,t,e.vCurrentPosition),n))}else U.setAttribute("vLeaderBreakPoint2D",t);U.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:U})}else w=!0,T([{position:e.vStartPosition}],e.vCurrentPosition);v.updateManipulationData(e),e.bLastUpdate&&A()},this.clean=function(){v&&v.remove(),w=!1,U=null};let I=this.beginExecute;this.beginExecute=function(){var e=a.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?(y&&c.readPreferences([{Repository:"DMURepository",PreferenceNames:["MarkerValidatedStampLabel","MarkerRejectedStampLabel"]}]).then((e=>{let t=e.repositories[0].preferences;for(let e=0;e<t.length;e++)"MarkerValidatedStampLabel"===t[e].name?x=t[e].value:"MarkerRejectedStampLabel"===t[e].name&&(k=t[e].value)})).catch((e=>{window.console.warn("Could not get server value, default value set instead.",e)})),I.call(this),this.done()):this._endExecute()},this._parent(t,(function(e){w||U||T(e)}),D.textPositionLabel,{},!0),M=this.getFrameWindow().getViewer()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},cancelExecute:function(){this._parent()},destroy:function(){this._endExecute()}})})),define("DS/DMUMarker/DMUMarkerCloudShapePreview",["require","exports","UWA/Core","DS/Visualization/ThreeJS_DS","DS/DMUBaseUIServices/DMUObjectsServices"],(function(e,t,n,i,r){"use strict";return class{constructor(e){let t,a,o,l={lineCap:"round",lineJoin:"round",lineStyleOpacity:1,lineStyleColor:new i.Color(13371695),lineStyleThicknessIndex:4},s=[];function d(){let n=e.viewerFrame.getDimensions();t.width=n.width,t.height=n.height}function c(){a&&(a.lineCap=l.lineCap,a.lineJoin=l.lineJoin,a.globalAlpha=l.lineStyleOpacity,a.strokeStyle=l.lineStyleColor.getStyle(),a.fillStyle=l.lineStyleColor.getStyle(),a.lineWidth=r.getLineThickness(l.lineStyleThicknessIndex))}function u(e,t){return{x:t.x-e.x,y:t.y-e.y}}this.startPreview=function(){if(!t||!a){let i=e.uiFrame;t=new n.Element("canvas",{id:"CloudPreviewCanvas",styles:{zIndex:"2000",pointerEvents:"none",position:"absolute",top:0,left:0}}).inject(i);let r=e.viewerFrame,o=r.getDimensions();r.addEvent("resize",d),t.width=o.width,t.height=o.height,a=t.getContext("2d"),c()}},this.refreshPreview=function(){t&&a&&(a.clearRect(0,0,t.width,t.height),s.length=0,o=0)},this.destroy=function(){s.length=0,o=0,a&&t&&(e.viewerFrame.removeEvent("resize",d),a.clearRect(0,0,t.width,t.height),a=null,t.remove(),t=null)},this.updatePreview=function(e,n){if(t&&a){if(!s.length)return c(),void s.push(e);if(n?(o||(o=s.length),s[o]=e):(s[s.length-1].x!==e.x&&s[s.length-1].y!==e.y&&s.push(e),o=s.length),s.length>1){a.clearRect(0,0,t.width,t.height);const e=15;let n,i,r=function(e){const t=e.length;let n=0,i=0;for(const t of e)n+=t.x,i+=t.y;return{x:n/t,y:i/t}}(s),o=function(e,t,n){const i=u(e,t),r=u(e,n),a=(l=r,(o=i).x*l.y-o.y*l.x);var o,l;return a>0?1:a<0?-1:0}(s[0],s[1],r);for(let t=0,r=1;t<s.length-1;t++,r++){let l,d,c,u=s[t].x,g=s[r].x,h=s[t].y,m=u,f=h,p=g-u,D=s[r].y-h,M=Math.sqrt(p*p+D*D)/(1.6*e),v=M-Math.floor(M),C=Math.atan2(D,p);2===s.length||o>0?(d=1.2,c=1.9,l=!1):(d=.9,c=.2,l=!0);for(let r=0;r<M;r++){m=u+e*r*Math.cos(C)*1.6,f=h+e*r*Math.sin(C)*1.6;let o=0===r&&t>0,g=r===Math.ceil(M-1)&&t!==s.length-2,p=d*Math.PI+C,D=c*Math.PI+C;if(o&&i&&n){let e;e=i<=.3?.42:i>.3&&i<.6?.28:.14,p=l?p-e*Math.PI-C+n:p+e*Math.PI-C+n}else if(g){let e;e=v<=.3?.3:v>.3&&v<.6?.2:.1,D=l?D+e*Math.PI:D-e*Math.PI}a.beginPath(),a.arc(m,f,e,p,D,l),a.stroke(),n=C,i=v}}}}},this.getPreviewPoints=function(){return s}}}})),define("DS/DMUMarker/DMUMarkerExport",["require","exports","DS/DMUPlayMarker/DMUMarker3DText","DS/DMUPlayMarker/DMUMarker2DText","DS/DMUPlayMarker/DMUMarker3DStamp","DS/DMUPlayMarker/DMUMarker3DPicture","DS/DMUPlayMarker/DMUMarker2DPicture","DS/Visualization/ThreeJS_DS","DS/DMUPlayMarker/DMUMarker3DRectangle","DS/DMUPlayMarker/DMUMarker3DEllipse","DS/DMUPlayMarker/DMUMarker3DSpline","DS/DMUPlayMarker/DMUMarker3DFreehand","DS/DMUPlayMarker/DMUMarker3DCloud","DS/DMUPlayMarker/DMUMarker3DCircle","DS/DMUPlayMarker/DMUMarker3DArrow","DS/DMUPlayMarker/DMUMarker3DLine","DS/DMUPlayMarker/DMUMarker3DPoint","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUI/DMUToolsUsers"],(function(e,t,n,i,r,a,o,l,s,d,c,u,g,h,m,f,p,D,M,v){"use strict";const C={1:[],2:[2,2],3:[3,1],4:[3,2,1,2],5:[6,2,2,2,2,2],6:[1,1],7:[2,1,12,1]};class S{static getCommentExportDefinition(e,t){return new Promise((n=>{(async()=>{const i=e.getAttribute("sOwner")||"";let r=t?await v.getUserName(i):i,a={id:e.getAttribute("sUuid")||"",content:(e.getAttribute("sTextContents")||[""]).join("\n"),owner:r,creationDate:new Date(e.getAttribute("fCreationDate")||Date.now()),lastModificationDate:new Date(e.getAttribute("fLastModificationDate")||Date.now())};n(a)})()}))}static getExportDefinition(e,t,y,P){return new Promise(((U,w)=>{(async()=>{let b,x=e.getPointedPosition(),k=e.getAttribute("sUuid")||"",A=e.getAttribute("bVisible")||!1;if(e instanceof s){let t=e.getAttribute("fWidth")||0,n=e.getAttribute("fHeight")||0;b={id:k,visible:A,type:e.getType(),position:{x:x.x,y:x.y,z:x.z},width:t,height:n,rotationAngle:e.getAttribute("fRotationAngle")}}else if(e instanceof n&&"Marker3DText"===e.getAttribute("sType")){let t,n=e.getAttribute("sTextContents"),i=e.getAttribute("bHasALeader"),r=e.getAttribute("bHasBorder"),a=e.getAttribute("sLeaderEndType"),o=e.getAttribute("vLeaderBreakPoint3D"),l=e.getAttribute("lLeaderPointingPoints"),s=e.getNode().getLabelDimensions(),d=e.getNode().getRepNode().leader.getChildren()[0].getChildren(),c=D.getRelativePosition(e,d[0]._initialPoint);t=1===d.length?c.clone():D.getRelativePosition(e,d[1]._finalPoint);let u=e.getAttribute("sFontName"),g=e.getAttribute("fFontSize"),h=e.getAttribute("sFontStyle"),m=e.getAttribute("sLineStylePattern"),f=e.getAttribute("fLineStyleThicknessIndex"),p=f?D.getLineThickness(f):e.getAttribute("fLineStyleThickness"),M=[];"Arrow"===a&&(a="OpenArrow"),l&&l.length&&M.push(l[0]),o&&(M.push(o.clone()),M.push(c),M.push(t)),b={id:k,visible:A,type:"DMUMarker3DText",position:{x:x.x,y:x.y,z:x.z},textContent:n||[""],hasLeader:i||!1,hasBorder:r||!1,offheight:s.offsetHeight,offwidth:s.offsetWidth,height:s.height,width:s.width,leaderEndType:a||"OpenArrow",leaderPosition:M,fontName:u||"",fontSize:g||1,fontColor:e.getAttribute("cFontColor"),fontStyle:h||"",borderColor:e.getAttribute("cLeaderStyleColor"),lineType:m||"",lineThickness:p||1,rotationAngle:e.getAttribute("fBoxRotationAngle")}}else if(e instanceof i&&"Marker2DText"===e.getAttribute("sType")){let t=e.getAttribute("sTextContents"),n=e.getAttribute("bHasALeader"),i=e.getAttribute("bHasBorder"),r=e.getAttribute("sLeaderEndType"),a=e.getAttribute("vLeaderBreakPoint2D");x=new l.Vector3(a.x,a.y,0);let o,s,d,c=e.getAttribute("lLeaderPointingPoints"),u=e.getNode().getLabelDimensions(),g=e.getNode().getRepNode().leader;g&&g.getChildren()&&g.getChildren().length?(o=e.getNode().getRepNode().leader.getChildren()[0].getChildren(),d=D.getRelativePosition(e,o[0]._initialPoint),s=1===o.length?d.clone():D.getRelativePosition(e,o[1]._finalPoint)):c&&c.length&&(d=c[0],s=1===c.length?d.clone():c[1]);let h=e.getAttribute("sFontName"),m=e.getAttribute("fFontSize"),f=e.getAttribute("sFontStyle"),p=e.getAttribute("sLineStylePattern"),M=e.getAttribute("fLineStyleThicknessIndex"),v=M?D.getLineThickness(M):e.getAttribute("fLineStyleThickness"),C=[];"Arrow"===r&&(r="OpenArrow"),c&&c.length&&C.push(new l.Vector3(c[0].x,c[0].y,c[0].z?c[0].z:0)),a&&(C.push(new l.Vector3(a.x,a.y,0)),C.push(d),C.push(s)),b={id:k,visible:A,type:"DMUMarker2DText",position:{x:x.x,y:x.y,z:x.z},textContent:t||[""],hasLeader:n||!1,hasBorder:i||!1,offheight:u.offsetHeight,offwidth:u.offsetWidth,height:u.height,width:u.width,leaderEndType:r||"OpenArrow",leaderPosition:C,fontName:h||"",fontSize:m||1,fontColor:e.getAttribute("cFontColor"),fontStyle:f||"",borderColor:e.getAttribute("cLeaderStyleColor"),lineType:p||"",lineThickness:v||1,rotationAngle:e.getAttribute("fBoxRotationAngle")}}else if(e instanceof r&&"Marker3DStamp"===e.getAttribute("sType")){let n,i="",r=e.getAttribute("sStampType")||"",a=e.getAttribute("lTextComment")||[""],o=e.getAttribute("fCreationDate")||0,l=e.getAttribute("sTextContents"),s=e.getAttribute("bHasALeader"),d=e.getAttribute("bHasBorder"),c=e.getAttribute("sLeaderEndType"),u=e.getAttribute("vLeaderBreakPoint3D"),g=e.getAttribute("lLeaderPointingPoints"),h=e.getNode().getLabelDimensions(),m=e.getNode().getRepNode().leader.getChildren()[0].getChildren(),f=D.getRelativePosition(e,m[0]._initialPoint);n=1===m.length?f.clone():D.getRelativePosition(e,m[1]._finalPoint);let p=e.getAttribute("sFontName"),M=e.getAttribute("fFontSize"),C=e.getAttribute("sFontStyle"),S=e.getAttribute("sLineStylePattern"),y=e.getAttribute("fLineStyleThicknessIndex"),P=y?D.getLineThickness(y):e.getAttribute("fLineStyleThickness"),U=[],w=e.getAttribute("sOwner")||"",E=w;if(w){t&&(E=await v.getUserName(w));let e=v.getUserImageURL(w)||"";i=await new Promise((t=>{v.getImage(e,(function(e){t(e)}))}))}"Arrow"===c&&(c="OpenArrow"),g&&g.length&&U.push(g[0]),u&&(U.push(u.clone()),U.push(f),U.push(n)),b={id:k,visible:A,type:"DMUMarker3DStamp",position:{x:x.x,y:x.y,z:x.z},textContent:l||[""],hasLeader:s||!1,hasBorder:d||!1,offheight:h.offsetHeight,offwidth:h.offsetWidth,height:h.height,width:h.width,leaderEndType:c||"OpenArrow",leaderPosition:U,fontName:p||"",fontSize:M||1,fontColor:e.getAttribute("cFontColor"),fontStyle:C||"",borderColor:e.getAttribute("cLeaderStyleColor"),lineType:S||"",lineThickness:P||1,rotationAngle:e.getAttribute("fBoxRotationAngle"),owner:E,ownerIcon:i,textComment:a,stampType:r,creationDate:o}}else if(e instanceof a&&"Marker3DPicture"===e.getAttribute("sType")){let t,n=e.getAttribute("bHasALeader"),i=e.getAttribute("bHasBorder"),r=e.getAttribute("sLeaderEndType"),a=e.getAttribute("vLeaderBreakPoint3D").clone(),o=e.getAttribute("lLeaderPointingPoints"),l=e.getAttribute("fImageWidth"),s=e.getAttribute("fImageHeight"),d=e.getNode().getRepNode().leader.getChildren()[0].getChildren(),c=D.getRelativePosition(e,d[0]._initialPoint);t=1===d.length?c.clone():D.getRelativePosition(e,d[1]._finalPoint);let u=e.getAttribute("sFontName"),g=e.getAttribute("fFontSize"),h=e.getAttribute("sFontStyle"),m=e.getAttribute("sImageData"),f=e.getAttribute("sImageType"),p=e.getAttribute("bShortDisplay"),M=e.getAttribute("sTextContents"),v=e.getAttribute("fLineStyleThicknessIndex"),C=e.getAttribute("sLineStylePattern"),S=D.getLineThickness(v||1)||e.getAttribute("fLineStyleThickness"),y=[];"Arrow"===r&&(r="OpenArrow"),o&&o.length&&y.push(o[0]),a&&(y.push(a.clone()),y.push(c),y.push(t)),b={id:k,visible:A,type:"DMUMarker3DPicture",position:{x:x.x,y:x.y,z:x.z},hasLeader:n||!1,hasBorder:i||!1,offheight:s&&g&&S?s+g+S:1,offwidth:l||1,height:s||1,width:l||1,imagedata:m||"",imageType:f||"",leaderEndType:r||"OpenArrow",leaderPosition:y,borderColor:e.getAttribute("cLeaderStyleColor"),lineType:C||"",lineThickness:S&&S>=8?.8*S:S||1,shortDisplay:p,fontName:u||"",fontSize:g||1,fontColor:e.getAttribute("cFontColor"),fontStyle:h||"",textContent:M&&!1===p?M:[""],rotationAngle:e.getAttribute("fBoxRotationAngle")||0}}else if(e instanceof o&&"Marker2DPicture"===e.getAttribute("sType")){let t=e.getAttribute("bHasALeader"),n=e.getAttribute("bHasBorder"),i=e.getAttribute("sLeaderEndType"),r=e.getAttribute("vLeaderBreakPoint2D").clone();x=new l.Vector3(r.x,r.y,0);let a,o,s,d=e.getAttribute("lLeaderPointingPoints"),c=e.getAttribute("fImageWidth"),u=e.getAttribute("fImageHeight"),g=e.getNode().getRepNode().leader;g&&g.getChildren()&&g.getChildren().length?(a=e.getNode().getRepNode().leader.getChildren()[0].getChildren(),s=D.getRelativePosition(e,a[0]._initialPoint),o=1===a.length?s.clone():D.getRelativePosition(e,a[1]._finalPoint)):d&&d.length&&(s=d[0],o=1===d.length?s.clone():d[1]);let h=e.getAttribute("sFontName"),m=e.getAttribute("fFontSize"),f=e.getAttribute("sFontStyle"),p=e.getAttribute("sImageData"),M=e.getAttribute("sImageType"),v=e.getAttribute("bShortDisplay"),C=e.getAttribute("sTextContents"),S=e.getAttribute("fLineStyleThicknessIndex"),y=e.getAttribute("sLineStylePattern"),P=D.getLineThickness(S||1)||e.getAttribute("fLineStyleThickness"),U=[];"Arrow"===i&&(i="OpenArrow"),d&&d.length&&U.push(new l.Vector3(d[0].x,d[0].y,d[0].z?d[0].z:0)),r&&(U.push(new l.Vector3(r.x,r.y,0)),U.push(s),U.push(o)),b={id:k,visible:A,type:"DMUMarker2DPicture",position:{x:x.x,y:x.y,z:x.z},hasLeader:t||!1,hasBorder:n||!1,offheight:u&&m&&P?u+m+P:1,offwidth:c||1,height:u||1,width:c||1,imagedata:p||"",imageType:M||"",leaderEndType:i||"OpenArrow",leaderPosition:U,borderColor:e.getAttribute("cLeaderStyleColor"),lineType:y||"",lineThickness:P&&P>=8?.8*P:P||1,shortDisplay:v,fontName:h||"",fontSize:m||1,fontColor:e.getAttribute("cFontColor"),fontStyle:f||"",textContent:C&&!1===v?C:[""],rotationAngle:e.getAttribute("fBoxRotationAngle")||0}}else if(e instanceof h){let t=e.getAttribute("fRadius")||0;b={id:k,visible:A,type:e.getType(),position:{x:x.x,y:x.y,z:x.z},radius:t}}else if(e instanceof d){let t=e.getAttribute("fxAxisLength")||0,n=e.getAttribute("fyAxisLength")||0;b={id:k,visible:A,type:e.getType(),position:{x:x.x,y:x.y,z:x.z},rotationAngle:e.getAttribute("fRotationAngle"),xLength:t,yLength:n}}else if(e instanceof f){let t=e.getPoints()[1].getAttribute("vPosition");b={id:k,visible:A,type:e.getType(),points:{start:{x:x.x,y:x.y,z:x.z},end:{x:t.x,y:t.y,z:t.z}}}}else if(e instanceof c){let t=[],n=e.getPoints(),i=e.getManipulationData(),r=e.getAttribute("fRotationAngle"),a=D.getRelativePosition(e,i.position);n&&n.forEach((e=>{if(e instanceof p){let n=e.getAttribute("vPosition");if(r){let e=n.sub(a);t.push({x:e.x*Math.cos(r)-e.y*Math.sin(r)+a.x,y:e.x*Math.sin(r)+e.y*Math.cos(r)+a.y,z:e.z})}else t.push({x:n.x,y:n.y,z:n.z})}})),b={id:k,visible:A,type:e.getType(),rect:{width:i.width,height:i.height},position:{x:a.x,y:a.y,z:a.z},rotationAngle:i.rotation,points:t}}else if(e instanceof u){let t=[],n=e.getPoints(),i=e.getManipulationData(),r=e.getAttribute("fRotationAngle"),a=D.getRelativePosition(e,i.position);n&&n.forEach((e=>{if(e instanceof p){let n=e.getAttribute("vPosition");if(r){let e=n.sub(a);t.push({x:e.x*Math.cos(r)-e.y*Math.sin(r)+a.x,y:e.x*Math.sin(r)+e.y*Math.cos(r)+a.y,z:e.z})}else t.push({x:n.x,y:n.y,z:n.z})}})),b={id:k,visible:A,type:"DMUMarker3DFreehand",rect:{width:i.width?i.width:0,height:i.height?i.height:0},position:{x:a.x,y:a.y,z:a.z},rotationAngle:i.rotation,points:t}}else if(e instanceof g){let t=[],n=[],i=e.getPoints(),r=e.getManipulationData().boundingBoxDimensions,a=e.getAttribute("fRotationAngle"),o=[],l=D.getRelativePosition(e,r.position);r.arcPoints.forEach((function(t){o.push(D.getRelativePosition(e,t))})),i&&(i.forEach((e=>{if(e instanceof p){let n=e.getAttribute("vPosition");if(a){let e=n.sub(l);t.push({x:e.x*Math.cos(a)-e.y*Math.sin(a)+l.x,y:e.x*Math.sin(a)+e.y*Math.cos(a)+l.y,z:e.z})}else t.push({x:n.x,y:n.y,z:n.z})}})),t.push({x:t[0].x,y:t[0].y,z:t[0].z})),o&&o.forEach((e=>{if(a){let t=e.sub(l);n.push({x:t.x*Math.cos(a)-t.y*Math.sin(a)+l.x,y:t.x*Math.sin(a)+t.y*Math.cos(a)+l.y,z:t.z})}else n.push({x:e.x,y:e.y,z:e.z})})),b={id:k,visible:A,type:"DMUMarker3DCloud",rect:{width:r.width,height:r.height},position:{x:l.x,y:l.y,z:l.z},rotationAngle:r.rotation,points:t,arcPoints:n}}else if(e instanceof m){let t=e.getNode().getArrowSpecs(),n=x,i=e.getAttribute("vSecondPoint").clone();n=M.getViewerPositionFromPoint(y,x),n=new l.Vector2(n.left,-n.top);let r=i;r=M.getViewerPositionFromPoint(y,i),r=new l.Vector2(r.left,-r.top);let a=r.sub(n),o=Math.acos(a.x/Math.sqrt(a.x*a.x+a.y*a.y))*(Math.sign(a.y)||1),s=Math.cos(o),d=Math.sin(o);b={id:k,visible:A,type:e.getType(),pointing:{x:x.x,y:x.y,z:x.z},ending:{x:i.x,y:i.y,z:i.z},points:t.coordinates.map((e=>({x:e.x*s-e.y*d,y:e.x*d+e.y*s})))}}if(b){let i=M.getMMPerPixelRatio(e.getViewer(),x),r=C[e.getAttribute("sLineStylePattern")||1],a=r?r.map((e=>6*e*i)):[],o={definition:b,pageNumber:e.getAttribute("fPointedPageNumber")||P||1,material:{fill:e.getAttribute("bIsFilled")?{color:e.getAttribute("cFillStyleColor"),opacity:"number"==typeof e.getAttribute("fOpacity")?e.getAttribute("fOpacity"):1}:void 0,border:e.getAttribute("bHasBorder")||e instanceof f||e instanceof c||e instanceof u||e instanceof g||e instanceof n?{color:e.getAttribute("cLineStyleColor"),thickness:D.getLineThickness(e.getAttribute("fLineStyleThicknessIndex"),"mm")||D.convertLineThickness(e.getAttribute("fLineStyleThickness"),"mm")||0,pattern:a,opacity:"number"==typeof e.getAttribute("fLineStyleOpacity")?e.getAttribute("fLineStyleOpacity"):1}:void 0}},l=e.getDMUComments();if(l.length){o.comments=[];for(let e=0;e<l.length;e++)if(!l[e].getAttribute("bMarkedAsDeleted")){let n=await S.getCommentExportDefinition(l[e],t);o.comments.push(n)}}return U(o)}w(new Error("This type cannot be exported"))})()}))}}return S})),define("DS/DMUMarker/DMUMarkerPictureCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUControls/EXPSnapshotControl","DS/DMUControls/EXPFileBrowser","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPUtils","DS/StateCommandEngine/PathElementAgent","DS/CoreEvents/Events","DS/ApplicationFrame/ContextualBar","DS/DMUPlayMarker/DMUMarker3DPicture","DS/DMUPlayMarker/DMUMarker2DPicture","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],(function(e,t,n,i,r,a,o,l,s,d,c,u,g,h,m,f){"use strict";var p,D,M,v=!1,C=t.extend({init:function(e){this.markerType="markerPictureCmdHdr"===e.ID?"3D":"2D",g.setAuthoringFeatureTypes("Marker"),e.dragEventCallback=function(e){},this._parent(e,"exclusive",f.picturePositionLabel,{},!0)},initiateCmd:function(){var e=g.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?this._parent():this.cancel()},cancelExecute:function(){this._parent(),this._cleanData&&this._cleanData(),D._frmWindow.getExecutionContext&&v&&(D._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().getContextualBar().hide(),D._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().unregister("DMUCreatePictureCtxCmds"),v=!1),this.cancel()},buildGraph:function(){let t,C;function S(e){D.sendNotify("error",e,3e3)}function y(t){if(t.img){let P=o.convertImageDataUrl(t.img.src);if(P&&P.type&&P.data){var i=g.getReviewContext({viewer:D.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),r=300,l=t.img.width,s=t.img.height;l>r&&(s=r*s/l,l=r),s>r&&(l=r*l/s,s=r),l=Math.round(l),s=Math.round(s);var d=C,h="3D"===D.markerType?n.getWindowPositionFromPoint(D._viewer,d,D._frmWindow):n.getViewerPositionFromPoint(D._viewer,d),m=n.getDistanceFromPixel(D._viewer,d,l,D._frmWindow);h.top<l&&(m=-m);var p,M=n.getViewpointInfo(D._viewer.currentViewpoint).up.clone().multiplyScalar(m);if(d=d.clone().add(M),"3D"===D.markerType)p=C.clone();else{var v=n.getViewerPositionFromPoint(D._viewer,C);p=[new a.Vector2(v.left,v.top)]}var S="3D"===D.markerType?new c(D._viewer,i):new u(D._viewer,i);S.setAttributes([{name:"sID",value:i.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:i.computeNewName({object:S,prefix:"3D"===D.markerType?f.picture3DPrefix:f.picture2DPrefix})},{name:"lLeaderPointingPoints",value:"3D"===D.markerType?[D.getRelativePosition(p)]:p},{name:"sTextContents",value:[t.name?t.name:""]},{name:"sImageType",value:P.type},{name:"sImageData",value:P.data},{name:"bHasALeader",value:"3D"===D.markerType},{name:"sLeaderEndType",value:"Arrow"},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"fFontSize",value:3.5},{name:"fBorderRadius",value:4},{name:"bShortDisplay",value:!0},{name:"fCreationDate",value:Date.now()},{name:"fImageWidth",value:"3D"===D.markerType?n.convertPixelToModel({sizeInPixels:l,viewer:D._viewer}):l},{name:"fImageHeight",value:"3D"===D.markerType?n.convertPixelToModel({sizeInPixels:s,viewer:D._viewer}):s},{name:"fPointedPageNumber",value:D.getPageNumber()},{name:"sPointedElementID",value:D.getElementId(p)}]),"3D"===D.markerType?S.setAttribute("vLeaderBreakPoint3D",D.getRelativePosition(d)):S.setAttribute("vLeaderBreakPoint2D",p[0]);var y=i.getCurrentSlide();y.addDMUObject(S),S.fireEvent("onDMUObjectInitialized",{dmuObject:S}),D.addInCSO(S),o._sendUsageProbe("command","CreatePicture"+D.markerType+y.getType())}}}M="browser",(D=this).initiateCmd();var P=new r({onFileLoadedCB:function(e){y(e),D._cleanData()},onErrorCB:function(){D._cleanData(),S(f.markerpicture.FileBrowserInvalidFile)}}),U=new l({agentId:"_pathElementAgent",frameWindow:D._frmWindow});function w(){D.options.executionContext&&(D._frmWindow=D.options.executionContext.getComponent("Viewer").getFrameWindow());var e,t=g.getContextViewer({reviewContext:g.getReviewContext({viewer:D.getFrameWindow().getViewer()})});C&&(e=D._frmWindow.getViewer().currentViewpoint.project(C));let n=[{name:"DMUImportPictureFromFileStr",line:1,hdr_list:["DMUImportPictureFromFileHdr"],type:"handler",identifier:"DMUImportPictureFromFileHdr"},{name:"DMUCreateSnapshotStr",line:1,hdr_list:["DMUCreateSnapshotHdr"],type:"handler",identifier:"DMUCreateSnapshotHdr"},{name:"DMUCancelPictureCmdStr",line:1,hdr_list:["DMUCancelPictureCmdHdr"],type:"handler",identifier:"DMUCancelPictureCmdHdr"}],i=D._frmWindow.getExecutionContext?{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:n}}},subscriberId:"DMUCreatePictureCtxCmds",merge:!0,workbenchName:"DMUCreatePictureCtxCmds",module:"DMUMarker",context:t.getCommandContext(),cmdPrefix:"",fileName:"DMUCreatePictureCtxCmds.xml"}:[{onContextualBarReady:function(){return{cmdList:n}},workbenchName:"DMUCreatePictureCtxCmds",module:"DMUMarker",context:t.getCommandContext(),cmdPrefix:"",fileName:"DMUCreatePictureCtxCmds.xml"}];var r={subscribersOptions:i,viewerFrame:D._frmWindow.getViewer(),uiFrame:D._frmWindow.getUIFrame(),Xposition:e.x,Yposition:e.y,hideWithDistance:!1};if(D._frmWindow.getExecutionContext){let e=D._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager();v||(e.register(i),v=!0),e.getContextualBar()._isShown||setTimeout((function(){e._showContextualBar(r)}),100)}else d.show(r);D.sendNotify("info",f.markerpicture.notifypicturesource)}this._cleanData=function(){P&&P.cleanFileBrowser(),D.cleanNotify(),d.hide(),p&&clearInterval(p),d.hide(),P=U=t=C=null,D.__endExecute()};var b=function(e){y(e),D._cleanData()},x=function(){D._cleanData()},k=function(){S(f.markerpicture.onSnaphotErrorMsg)},A=function(e){"webcam"===M?t=new i({immersiveFrame:D._frmWindow.getImmersiveFrame(),onValidateSnapshotCB:b,onCloseSnapshotCB:x,onErrorCB:k}):"browser"===M&&(P.openFileBrowser(),setTimeout((function(){if(D.isRunning())var e=s.subscribe({event:"/VISU/"},(function(){s.unsubscribe(e),D._cleanData()}))}),100)),D._frmWindow.getExecutionContext&&v&&(D._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().unregister("DMUCreatePictureCtxCmds"),v=!1),D.end(),e()},E=this.createInitialState("selectGeometryState");this.setEnterStateAction(E,(function(){D._frmWindow.getViewerFrame().setStyle("cursor","crosshair"),D.sendNotify("info",f.markerpicture.notifypictureposition)})),this.setExitStateAction(E,(function(){D._frmWindow.getViewerFrame().setStyle("cursor","auto"),D.cleanNotify()}));var F=this.createState("selectOriginState"),T=this.createState("captureSnapshotState"),I=this.getFinalState();navigator.userAgent&&(-1!==navigator.userAgent.search("Chrome")||-1!==navigator.userAgent.search("Firefox"))&&(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)?(this.setPictureCreationChoice=function(e){M=e,d.hide(),p&&clearInterval(p),p=setInterval((function(){D.isRunning()&&(clearInterval(p),D.publish({event:M?"contextBarOK":"contextBarCancel",data:null}))}),10)},this.setEnterStateAction(F,w),this.setExitStateAction(F,(function(){D.cleanNotify()})),this.addTransition({iEvent:U,iInitialState:E,iFinalState:F,iAction:function(e,t){C=null;const n=t[0].pathElement||D._selectedPathElement;if(m.isAPOIPath(n)){const{position:e}=h.getPOIInformationFromPathElement(n);e&&(C=e)}C||(C=t[0].position.clone()),e()}}),this.addEmptySelectionTransition(E,F,(function(e,t){var n=D.computeEmptySelectionInformation(t);C=n[0].position.clone(),e()})),this.addTransition({iEvent:U,iInitialState:F,iFinalState:F,iAction:function(e,t){C=t[0].position.clone(),w(),e()}}),this.addEmptySelectionTransition(F,F,(function(e,t){var n=D.computeEmptySelectionInformation(t);C=n[0].position.clone(),w(),e()}))):(M="browser",this.addTransition({iEvent:U,iInitialState:E,iFinalState:I,iAction:function(e,t){C=null;const n=t[0].pathElement||D._selectedPathElement;if(m.isAPOIPath(n)){const{position:e}=h.getPOIInformationFromPathElement(n);e&&(C=e)}C||(C=t[0].position.clone()),A(e)}}),this.addEmptySelectionTransition(E,I,(function(e,t){var n=D.computeEmptySelectionInformation(t);C=n[0].position.clone(),A(e)}))),this.addTransition({iSender:this,iEvent:"contextBarOK",iInitialState:F,iFinalState:I,iAction:function(e){A(e)}}),this.addTransition({iSender:this,iEvent:"contextBarCancel",iInitialState:F,iFinalState:I,iAction:function(e){D._frmWindow.getExecutionContext&&(D._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().getContextualBar().hide(),D._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().unregister("DMUCreatePictureCtxCmds"),v=!1),this._cleanData(),e()}}),this.addTransition({iSender:this,iEvent:"ActionOK",iInitialState:T,iFinalState:I,iAction:function(e){this._cleanData(),e()}})}});return C.setNewPictureCreationChoice=function(e,t){M=t&&t.args?t.args.Choice:null,t.executionContext&&t.executionContext.getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().getContextualBar().hide(),p&&clearInterval(p),p=setInterval((function(){clearInterval(p),D.publish({event:M?"contextBarOK":"contextBarCancel",data:null})}),10),e()},C})),define("DS/DMUMarker/DMUMarkerCircleCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DCircle","DS/DMUPlayMarker/DMUMarker2DCircle","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],(function(e,t,n,i,r,a,o,l,s,d){"use strict";return t.extend({init:function(t){var c,u="markerCircleCmdHdr"===t.ID?"3D":"2D",g=this,h=null,m=!1;function f(){h.fireEvent("onDMUObjectInitialized",{dmuObject:h}),g.addInCSO(h),g._endExecute()}function p(t,p){var D,M=r.getReviewContext({viewer:g.getFrameWindow().getViewer()}),v=M?M.getCurrentSessionMarkup():null,C=t[0].position,S=p?C.clone().sub(p).length():100;if("3D"===u){const e=t[0].pathElement||g._selectedPathElement;if(s.isAPOIPath(e)){const{position:t}=l.getPOIInformationFromPathElement(e);t&&(D=t)}D||(D=C.clone())}else{var y=n.getViewerPositionFromPoint(c,C);D=new i.Vector2(y.left,y.top)}(h="3D"===u?new a(c,v):new o(c,v)).setAttributes([{name:"sID",value:v.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:v.computeNewName({object:h,prefix:"3D"===u?d.circle3DPrefix:d.circle2DPrefix})},{name:"vCenter",value:g.getRelativePosition(D)},{name:"fRadius",value:"3D"===u?n.getDistanceFromPixel(c,C,S,g._frmWindow):S},{name:"cLineStyleColor",value:new i.Color("#cc092f")},{name:"cFillStyleColor",value:new i.Color("#cc092f")},{name:"fLineStyleThicknessIndex",value:4},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0},{name:"fPointedPageNumber",value:g.getPageNumber()},{name:"sPointedElementID",value:g.getElementId(D)}]);var P=v.getCurrentSlide();P.addDMUObject(h),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","CreateCircle"+u+P.getType())})),m||f()}r.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(h){var t=e.vStartPosition.clone(),r=g.getElementId(t),a=g.getAbsolutePosition(n.getPositionFromIntersection(c,g.getRelativePosition(e.vCurrentPosition,r),g.getRelativePosition(e.vCurrentPosition,r),!0),r);if("2D"===u){var o=n.getViewerPositionFromPoint(c,t);t=new i.Vector2(o.left,o.top),o=n.getViewerPositionFromPoint(c,a),a=new i.Vector2(o.left,o.top)}var l=t.sub(a);h.setAttributes([{name:"fRadius",value:Math.max(0,l.length())}]),h.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:h})}else m=!0,p([{position:e.vStartPosition}],e.vCurrentPosition);e.bLastUpdate&&f()},this.clean=function(){m=!1,h=null},this._parent(t,(function(e){m||h||p(e)}),d.circlePositionLabel,{},!0),c=this.getFrameWindow().getViewer()},beginExecute:function(){var e=r.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)||this._endExecute(),this._parent(),this.done()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},destroy:function(){this._endExecute()}})})),define("DS/DMUMarker/DMUMarkerRectangleCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUPlayMarker/DMUMarker3DRectangle","DS/DMUPlayMarker/DMUMarker2DRectangle","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],(function(e,t,n,i,r,a,o,l,s,d,c){"use strict";return t.extend({init:function(t){var u,g,h="DMU3DRectangleCmdHdr"===t.ID?"3D":"2D",m=this,f=null,p=!1;function D(){let e=f.getAttribute("vPosition");f.setAttributes([{name:"vPosition",value:m.getRelativePosition(e)},{name:"sPointedElementID",value:m.getElementId(e)},{name:"fPointedPageNumber",value:m.getPageNumber()}]),f.fireEvent("onDMUObjectInitialized",{dmuObject:f}),m.addInCSO(f),m._endExecute()}function M(M,v){var C=o.getReviewContext({viewer:m.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),S=M[0].position;g||(g=new l(u)),g.addToListener("Control",t.dragEventCallback),g.addToListener("Shift",t.dragEventCallback),g.activate();var y,P=200,U=160,w=S.clone(),b=v;if("3D"===h){if(b){y=(new i.Plane).setFromNormalAndCoplanarPoint(u.currentViewpoint.getSightDirection(),S).projectPoint(b);var x=u.currentViewpoint.getUpDirection(),k=(new i.Vector3).crossVectors(x,u.currentViewpoint.getSightDirection());U=y.dot(x)-S.dot(x),P=y.dot(k)-S.dot(k),w=(new i.Vector3).addVectors(y,S).multiplyScalar(.5)}const e=M[0].pathElement||m._selectedPathElement;if(d.isAPOIPath(e)){const{position:t}=s.getPOIInformationFromPathElement(e);t&&(w=t)}}else{var A=n.getViewerPositionFromPoint(u,S);if(w=new i.Vector2(A.left,A.top),b)A=n.getViewerPositionFromPoint(u,b),P=2*(y=new i.Vector2(A.left,A.top).clone().sub(w)).x,U=2*y.y;else U=160,P=200}P="3D"===h?n.getDistanceFromPixel(u,S,200,m._frmWindow):P,U="3D"===h?n.getDistanceFromPixel(u,S,160,m._frmWindow):U,P=Math.abs(P),U=Math.abs(U),(f="3D"===h?new r(u,C):new a(u,C)).setAttributes([{name:"sID",value:C.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:C.computeNewName({object:f,prefix:"3D"===h?c.rectangle3DPrefix:c.rectangle2DPrefix})},{name:"vPosition",value:w},{name:"fWidth",value:P},{name:"fHeight",value:U},{name:"cLineStyleColor",value:new i.Color(13371695)},{name:"fLineStyleThicknessIndex",value:3},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0}]);var E=C.getCurrentSlide();E.addDMUObject(f),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","CreateRectangle"+h+E.getType())})),p||D()}t.dragEventCallback=function(e){if(f){var t,r,a,o,l=m.getElementId(e.vStartPosition.clone()),c=m.getAbsolutePosition(n.getPositionFromIntersection(u,m.getRelativePosition(e.vCurrentPosition,l),m.getRelativePosition(e.vCurrentPosition,l),!0),l);if("2D"===h){var v=n.getViewerPositionFromPoint(u,e.vStartPosition);o=new i.Vector2(v.left,v.top),v=n.getViewerPositionFromPoint(u,e.vCurrentPosition),t=2*(a=new i.Vector2(v.left,v.top).sub(o)).x,r=2*a.y}else{var C=e.ctrlKey||void 0===e.ctrlKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.ctrlKey,S=e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey;a=(new i.Plane).setFromNormalAndCoplanarPoint(u.currentViewpoint.getSightDirection(),e.vStartPosition).projectPoint(c);var y=u.currentViewpoint.getUpDirection(),P=(new i.Vector3).crossVectors(y,u.currentViewpoint.getSightDirection());if(S){var U=a.dot(y)-e.vStartPosition.dot(y),w=a.dot(P)-e.vStartPosition.dot(P),b=Math.max(Math.abs(U),Math.abs(w));r=b*Math.sign(U),t=b*Math.sign(w),(a=y.clone().multiplyScalar(r).add(P.clone().multiplyScalar(t))).add(e.vStartPosition)}else r=a.dot(y)-e.vStartPosition.dot(y),t=a.dot(P)-e.vStartPosition.dot(P);if(C){const n=m._selectedPathElement;if(n&&d.isAPOIPath(n)){const{position:e}=s.getPOIInformationFromPathElement(n);e&&(o=e)}else o=e.vStartPosition.clone();r*=2,t*=2}else o=(new i.Vector3).addVectors(a,e.vStartPosition).multiplyScalar(.5)}f.setAttributes([{name:"fWidth",value:Math.abs(t)},{name:"fHeight",value:Math.abs(r)},{name:"vPosition",value:o}]),f.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:f})}else p=!0,M([{position:e.vStartPosition}],e.vCurrentPosition);g.updateManipulationData(e),e.bLastUpdate&&D()},this.clean=function(){g&&g.remove(),p=!1,f=null},this._parent(t,(function(e){p||f||M(e)}),c.rectangleCreationLabel,{},!0),u=this.getFrameWindow().getViewer()},beginExecute:function(){var e=o.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?(this._parent(),this.done()):this._endExecute()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},destroy:function(){this._endExecute()}})})),define("DS/DMUMarker/DMUMarkerBoxContextCmd",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager"],(function(e,t,n){"use strict";return e.extend({init:function(e){var t=e||{};t.mode="shared",this._parent(t)},beginExecute:function(e){this._parent(e);for(var i=t.get(),r=[],a=n.getReviewContext({viewer:this.getFrameWindow().getViewer()}),o=0;o<i.length;o++){var l=a.getDMUObjectFromPathElement(i[o].pathElement);l&&r.push(l)}if("DMUMarkerShortDisplayHdr"===this._id){for(var s,d,c=0;c<r.length;c++)if("boolean"==typeof(d=r[c].getAttribute("bShortDisplay")))if(void 0===s)s=d;else if(s!==d){s=null;break}r.forEach((function(e){e.setAttribute("bShortDisplay",null===s||!s),e.refreshNode()}))}this.getFrameWindow().getViewer().render(),a&&a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().getCurrentSlide()&&a.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:a.getCurrentSessionMarkup().getCurrentSlide()}),this.done()}})})),define("DS/DMUMarker/DMUMarkerFreehandShapePreview",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlayAnnotationUtils/CanvasShapes","DS/DMUBaseUIServices/DMUObjectsServices"],(function(e,t,n,i,r){"use strict";return t.extend({init:function(t){if(t&&t.graphicProperties&&t.frameWindow){this._parent();var a,o,l,s={};s.lineCap=t.graphicProperties.lineCap?t.graphicProperties.lineCap:"round",s.lineJoin=t.graphicProperties.lineJoin?t.graphicProperties.lineJoin:"round",s.lineStyleOpacity=t.graphicProperties.lineStyleOpacity?t.graphicProperties.lineStyleOpacity:1,s.lineStyleColor=t.graphicProperties.lineStyleColor?t.graphicProperties.lineStyleColor:new n.Color(13371695),s.lineStyleThicknessIndex=t.graphicProperties.lineStyleThicknessIndex?t.graphicProperties.lineStyleThicknessIndex:4,this.setGraphicProperties=function(e){e&&(s.lineCap=e.lineCap?e.lineCap:s.lineCap,s.lineJoin=e.lineJoin?e.lineJoin:s.lineJoin,s.lineStyleOpacity=e.lineStyleOpacity?e.lineStyleOpacity:s.lineStyleOpacity,s.lineStyleColor=e.lineStyleColor?e.lineStyleColor:s.lineStyleColor,s.lineStyleThicknessIndex=e.lineStyleThicknessIndex?e.lineStyleThicknessIndex:s.lineStyleThicknessIndex,c())},this.startPreview=function(){if(!a||!o){var n=t.frameWindow.getUIFrame();a=new e.Element("canvas",{id:"freehandPreviewCanvas",styles:{zIndex:"2000",pointerEvents:"none",position:"absolute",top:0,left:0}}).inject(n);var i=t.frameWindow.getViewerFrame(),r=i.getDimensions();i.addEvent("resize",d),a.width=r.width,a.height=r.height,o=a.getContext("2d"),c()}},this.drawHalfPreview=function(e,t,n){o.clearRect(0,0,a.width,a.height);let l={color:s.lineStyleColor,thickness:r.getLineThickness(s.lineStyleThicknessIndex),transparency:1};if(e){let t=i.createShape({shapeData:e,settings:l});o.globalAlpha=1,i.drawShape({shape:JSON.parse(JSON.stringify(t)),canvas:a,scale:1,angle:0})}else{o.globalAlpha=1,o.beginPath();let e=n.length;o.moveTo(n[0].x,n[0].y);for(let t=1;t<e;++t)o.lineTo(n[t].x,n[t].y);o.stroke()}o.globalAlpha=.3,o.beginPath();let d=t.length;o.moveTo(t[0].x,t[0].y);for(let e=1;e<d;++e)o.lineTo(t[e].x,t[e].y);o.stroke()},this.destroyHalfPreview=function(e){o.clearRect(0,0,a.width,a.height),o.globalAlpha=1;let t=e.length;o.moveTo(e[0].x,e[0].y);for(let n=1;n<t;++n)o.lineTo(e[n].x,e[n].y);o.stroke()},this.refreshPreview=function(){a&&o&&(o.clearRect(0,0,a.width,a.height),l=null)},this.destroy=function(){l=null,o&&a&&(t.frameWindow.getViewerFrame().removeEvent("resize",d),o.clearRect(0,0,a.width,a.height),o=null,a.remove(),a=null)},this.updatePreview=function(e,t){if(a&&o){if(!l)return c(),void(l=[]).push(e);t?l[1]=e:l.push(e),o.clearRect(0,0,a.width,a.height),o.beginPath(),o.moveTo(l[0].x,l[0].y);for(var n=1;n<l.length;n++)o.lineTo(l[n].x,l[n].y);o.stroke()}},this.getPreviewPoints=function(){return l}}function d(){var e=t.frameWindow.getViewerFrame().getDimensions();a.width=e.width,a.height=e.height}function c(){o&&(o.lineCap=s.lineCap,o.lineJoin=s.lineJoin,o.globalAlpha=s.lineStyleOpacity,o.strokeStyle=s.lineStyleColor.getStyle(),o.fillStyle=s.lineStyleColor.getStyle(),o.lineWidth=r.getLineThickness(s.lineStyleThicknessIndex))}}})})),define("DS/DMUMarker/DMUMarkerContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/CATWebUXComponents/DMUCommandsManager"],(function(e,t){"use strict";let n=function(){return Boolean("wafr"===require("DS/PADUtils/PADSettingsMgt").getSetting("eno3dviewer_infrastructure_version"))};return e.extend({getSharedContextualMenuCommandList:function(e,t){var n=[];return e&&e.length&&e.forEach((function(e){e.isReadOnly()||-1!==n.indexOf(e.getType())||n.push(e.getType())})),n.length&&-1===n.indexOf("DMUSlide")&&-1===n.indexOf("DMUFormat")?this.getContextualMenuCommandList(e,t):[]},getContextualMenuCommandList:function(e,t){var i,r=[],a=[],o=[],l=n(),s="Document"===t||"Requirement"===t||"Requirement Specification"===t||"Specification Report"===t;if(!this.isReadOnly())if(this.isEditable()){l?(s||a.push("DMUCutHdr","DMUCopyHdr"),a.push("DMUHideShowHdr","DMUDeleteHdr")):(s||r.push({line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]}),r.push({line:1,name:"DMUHideShowStr",hdr_list:["DMUHideShowHdr"]},{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}));var d,c,u,g=!1,h=!0,m=!1,f=!1,p=!1;for(this.cmdHdrState_list=[],i=0;i<e.length;i++)e[i].getSharedHeaderTypes&&(d=e[i].getSharedHeaderTypes())&&(d.leaderProperties?(g=!0,d.hideShowLeaderProperties&&(m=!0)):h=!1,d.pointTypeProperties&&(c=e[i],f=!0),d.extremityTypeProperties&&(u=e[i],p=!0)),!h||e[0].getAttribute("sLeaderEndType")===e[i].getAttribute("sLeaderEndType")&&e[0].getAttribute("bHasALeader")===e[i].getAttribute("bHasALeader")||(h=!1);if(g){let t={line:1,name:"DMULeaderStr",hdr_list:["DMUArrowLeaderHdr","DMUBubbleLeaderHdr","DMUCrossLeaderHdr","DMUSquareLeaderHdr","DMUNoEndLeaderHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"};if(l?(o.push({category:"Leader end type",hdrs:["DMUArrowLeaderHdr","DMUBubbleLeaderHdr","DMUCrossLeaderHdr","DMUSquareLeaderHdr","DMUNoEndLeaderHdr"]}),m&&o[0].hdrs.push("DMUNoLeaderHdr")):(m&&t.hdr_list.push("DMUNoLeaderHdr"),r.push(t)),e.length>0){var D=!1,M=!1,v=!1,C=!1,S=!1,y=!1;if(h){var P=e[0].getAttribute("sLeaderEndType");switch(e[0].getAttribute("bHasALeader")||(P="None"),P){case"Arrow":D=!0;break;case"Bubble":M=!0;break;case"Cross":v=!0;break;case"Square":C=!0;break;case"No end":S=!0;break;case"None":y=!0}}var U=[{name:"DMUArrowLeaderHdr",state:D},{name:"DMUBubbleLeaderHdr",state:M},{name:"DMUCrossLeaderHdr",state:v},{name:"DMUSquareLeaderHdr",state:C},{name:"DMUNoEndLeaderHdr",state:S},{name:"DMUNoLeaderHdr",state:y}];for(i=0;i<U.length;i++)this.cmdHdrState_list.push(U[i])}}if(f&&c&&c.getPointTypeHdr){var w=c.getPointTypeHdr();if(w&&w.hdr_list.length>0){l?a.push(...w.hdr_list):r.push(w);var b,x=[];for(b=0;b<w.hdr_list.length;b++)x.push({name:w.hdr_list[b],state:!1});for(b=0;b<x.length;b++)this.cmdHdrState_list.push(x[b])}}if(p&&u&&u.getExtremityTypeHdr){var k=u.getExtremityTypeHdr();if(k&&k.hdr_list.length>0){l?a.push(...k.hdr_list):r.push(k);var A,E=[];for(A=0;A<k.hdr_list.length;A++)E.push({name:k.hdr_list[A],state:!1});for(A=0;A<E.length;A++)this.cmdHdrState_list.push(E[A])}}}else l?a.push("DMUDeleteHdr"):r=[{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}];if(l){for(let e=0;e<a.length;e++)r.push({type:"WAfrDefaultHandlerItem",handlerId:a[e]});return o.forEach((e=>{let t={type:"PushItem",title:e.category,submenu:[]};for(let n=0;n<e.hdrs.length;n++)"ENO3DToggleStatusBarCmd"===e.hdrs[n]?t.submenu.push({type:"WAfrCheckHandlerItem",handlerId:e.hdrs[n]}):t.submenu.push({type:"WAfrDefaultHandlerItem",handlerId:e.hdrs[n]});r.push(t)})),r}return r},getSharedContextualCommandList:function(e){var t=[],i=n();let r=e&&e.length&&e.every((function(e){const n=e.getParent(),i=n&&n.getParent(),r=i&&i.getRestrictions(n);return!(r&&!r.markup.canEdit&&!r.reply.canEdit)&&(!e.isReadOnly()&&e.isInEdition()?(-1===t.indexOf(e.getType())&&t.push(e.getType()),e.isEditable()):void 0)}));if(!t.length||-1!==t.indexOf("DMUSection")||-1!==t.indexOf("DMUClipping")||!r)return i?void 0:[];if(1===t.length||2===t.length&&-1!==t.indexOf("DMUMarker2DPicture")&&-1!==t.indexOf("DMUMarker3DPicture")||2===t.length&&-1!==t.indexOf("DMUMarker2DText")&&-1!==t.indexOf("DMUMarker3DText"))return this.getContextualCommandList(e[0]);var a,o=[];for(a=0;a<e.length;a++){for(var l=!1,s=0;s<o.length;s++)if(o[s].type===e[a].getType()){l=!0;break}if(!l){if(!e[a].getSharedHeaderTypes)return i?void 0:[];o.push({sharedTypes:e[a].getSharedHeaderTypes()})}}var d=!1;for(a=0;a<o.length;a++)o[a].sharedTypes.fontProperties&&(d=!0);var c=[];return c=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}],d&&(c.push({name:"Marker_DMUStylesStr",line:1,hdr_list:["Marker_DMUDefaultStyleHdr","Marker_DMULightStyleHdr","Marker_DMUMeasureStyleHdr","Marker_DMUPostitStyleHdr","Marker_DMUValidateStyleHdr","Marker_DMUWarningStyleHdr","Marker_DMUCautionStyleHdr"],selectedHdr:"DefaultStyle",type:"handler",identifier:"Marker_DMUStylesStr"}),c.push({name:"Marker_DMUIncreaseFontSizeStr",line:1,hdr_list:["Marker_DMUIncreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUIncreaseFontSizeHdr"}),c.push({name:"Marker_DMUDecreaseFontSizeStr",line:1,hdr_list:["Marker_DMUDecreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUDecreaseFontSizeHdr"})),c=c.concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"],type:"handler",identifier:"DMUGraphicPropertiesPanelHdr"}])},getContextualCommandList:function(){var e=[];return!this.isReadOnly()&&this.isInEdition()&&this.isEditable()?e=(e=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}]).concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"],type:"handler",identifier:"DMUGraphicPropertiesPanelHdr"}]):e},getSharedHeaderTypes:function(){return{}},register:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"},contextualMenu:{type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"},contextualMenu:{type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}})},applyStateToContextHdr:function(e){if(e.length>0)for(var n=0;n<e.length;n++){var i=t.getCommand(e[n].name,"Default");void 0!==i&&i.setState&&i.setState(e[n].state)}},setCheckCmdHdrState:function(e){this.applyStateToContextHdr&&e.length>0&&this.applyStateToContextHdr(e)}})})),define("DS/DMUMarker/DMUMarkerCreatePictureCtxInternalCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATWebUXComponents/DMUCommandsManager"],(function(e,t){"use strict";return e.extend({init:function(e){e.mode="shared",this._parent(e),this.setRepeatMode(!1)},beginExecute:function(){var e=this.options.executionContext?this.options.ID:t._getCurrent(this.options.context),n=t.getCommand("markerPictureCmdHdr",this.options.executionContext?this.options.executionContext:this._ctx);(!n||n&&!n.isPaused()||n&&!n.setPictureCreationChoice)&&(n=t.getCommand("marker2DPictureCmdHdr",this.options.executionContext?this.options.executionContext:this._ctx)),n&&(!n||n.setPictureCreationChoice||this.options.executionContext)&&("DMUImportPictureFromFileHdr"===e?n.setPictureCreationChoice("browser"):"DMUCreateSnapshotHdr"===e?n.setPictureCreationChoice("webcam"):n.setPictureCreationChoice(null),this.cancel())}})})),define("DS/DMUMarker/DMUMarkerArrowCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DArrow","DS/DMUPlayMarker/DMUMarker2DArrow","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],(function(e,t,n,i,r,a,o,l,s,d,c){"use strict";return t.extend({init:function(t){var u,g,h,m,f="markerArrowCmdHdr"===t.ID||"marker3DDoubleArrowCmdHdr"===t.ID?"3D":"2D",p=this,D=null,M=!1;function v(){let e=D.getAttribute("vFirstPoint"),t=D.getAttribute("vSecondPoint"),n=p.getElementId(e);D.setAttributes([{name:"vFirstPoint",value:p.getRelativePosition(e)},{name:"vSecondPoint",value:p.getRelativePosition(t,n)},{name:"fPointedPageNumber",value:p.getPageNumber()},{name:"sPointedElementID",value:n}]),D.fireEvent("onDMUObjectInitialized",{dmuObject:D}),p.addInCSO(D),p._endExecute()}function C(C,S){var y=r.getReviewContext({viewer:p.getFrameWindow().getViewer()}),P=y?y.getCurrentSessionMarkup():null,U=C[0].position;h=n.getSnapRotationInfos().snapRotationToggle;var w=parseFloat(n.getSnapRotationInfos().snapRotationAngle);m=(isNaN(w)?90:w)*Math.PI/180,g||(g=new l(u)),g.addToListener("Shift",t.dragEventCallback),g.activate();var b,x=U.clone(),k=S;if("3D"===f){var A=n.getDistanceFromPixel(u,U,100,p.getFrameWindow()),E=n.getViewpointInfo(u.currentViewpoint),F=E.right.clone().add(E.up).normalize().multiplyScalar(A);const e=C[0].pathElement||p._selectedPathElement;if(d.isAPOIPath(e)){const{position:t}=s.getPOIInformationFromPathElement(e);t&&(x=t)}k?b=k.clone().sub(U.clone()).length():(k=U.clone().add(F),b=A/10)}else{var T=n.getViewerPositionFromPoint(u,x);x=new i.Vector2(T.left,T.top),k?(T=n.getViewerPositionFromPoint(u,k),k=new i.Vector2(T.left,T.top)):(k=(new i.Vector2).copy(x)).add(new i.Vector2(150,0)),b=k.clone().sub(x).length()/10}(D="3D"===f?new a(u,P):new o(u,P)).setAttributes([{name:"sID",value:P.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:P.computeNewName({object:D,prefix:"3D"===f?c.arrow3DPrefix:c.arrow2DPrefix})},{name:"vFirstPoint",value:x},{name:"vSecondPoint",value:k},{name:"fWidth",value:b},{name:"cLineStyleColor",value:new i.Color("#cc092f")},{name:"cFillStyleColor",value:new i.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sStyle",value:-1===t.ID.indexOf("DoubleArrow")?"beginSide":"bothSide"}]);var I=P.getCurrentSlide();I.addDMUObject(D),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","CreateArrow"+f+I.getType())})),M||v()}r.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(e.isCanvasToDraw){if(D){var t,r;let M=p.getElementId(e.vStartPosition.clone());var a=p.getAbsolutePosition(n.getPositionFromIntersection(u,p.getRelativePosition(e.vCurrentPosition,M),p.getRelativePosition(e.vCurrentPosition,M),!0),M),o=e.iEventData.from[0].getCurrentPosition(u.canvas),l="2D"===f?e.vStartPosition:D.getAttribute("vFirstPoint"),s=n.getViewerPositionFromPoint(u,l);s=new i.Vector2(s.left,s.top);var d=(new i.Vector2).subVectors(o,s),c=new i.Vector2(1,0).dot(d.clone().normalize());r=o.y<=s.y?Math.acos(c):2*Math.PI-Math.acos(c);var S=e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey;if(h!==S){var y=Math.round(r/m)*m,P=new i.Vector2(Math.cos(y),-Math.sin(y));if(P.setLength(d.dot(P)),P.distanceTo(d)<g.ROTATION_SNAP_THRESHOLD){P.normalize();var U=(new i.Vector2).subVectors(n.get2DSnappedPosition(o,y),s);P.setLength(U.dot(P)),a=n.getPositionFromIntersection(u,s.add(P),l),g.displayAxis(l,y,U.length()+20)}else g.removeAxis()}else g.removeAxis();if("2D"===f){var w=n.getViewerPositionFromPoint(u,a);a=new i.Vector2(w.left,w.top)}t=a.clone().sub(D.getAttribute("vFirstPoint")).length()/10,D.setAttributes([{name:"fWidth",value:t},{name:"vSecondPoint",value:a}]),D.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:D})}else M=!0,C([{position:e.vStartPosition}],e.vCurrentPosition);g.updateManipulationData(e)}e.bLastUpdate&&D&&v()},this.clean=function(){g&&g.remove(),M=!1,g=D=null},this._parent(t,(function(e){M||D||C(e)}),c.arrowPositionLabel,{},!0),u=this.getFrameWindow().getViewer()},beginExecute:function(){var e=r.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?(this._parent(),this.done()):this._endExecute()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},destroy:function(){this._endExecute()}})})),define("DS/DMUMarker/DMUMarkerCloudCreateCmd",["require","exports","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseExperience/DMUContextManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPManagerSet","DS/Selection/CSOManager","DS/Selection/HSOManager","UWA/Utils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseCommands/EXPStateCommand","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","DS/WebappsUtils/WebappsUtils","i18n!DS/DMUMarker/assets/nls/DMUMarker","DS/DMUMarker/DMUMarkerCloudShapePreview","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUPlayMarker/DMUMarker3DCloud"],(function(e,t,n,i,r,a,o,l,s,d,c,u,g,h,m,f,p,D){"use strict";return class extends u{constructor(e){super(e,"exclusive",!0);const t=this.getFrameWindow().getUIFrame(),u=this.getFrameWindow().getViewer();this.executionContext=e.executionContext;const M=this;let v,C,S,y,P,U,w,b=!1,x=[];const k=h.getWebappsAssetUrl("DMUBaseCommands","icons/32/");function A(e){return S&&"Requirement"===S.getDocumentType()?S.getPointedElemIDAtPosition(e):null}function E(){const e=i.getReviewContext({viewer:M.getFrameWindow().getViewer()});let t=e?e.getCurrentSessionMarkup():null;if(!t)return;let n,r=S?S.getPageNumber(P):null,o=Boolean(r);o&&(n=new a.Vector3(0,0,0));let l,s=-1/0,c=1/0,g=-1/0,h=1/0,m=[];l=x,l.forEach((function(e){s=Math.max(s,e.x),c=Math.min(c,e.x),g=Math.max(g,e.y),h=Math.min(h,e.y)}));let f=new a.Vector2(c,g),v=new a.Vector2(s,h),y=(new a.Vector2).addVectors(f,v).multiplyScalar(.5),U=p.getNearPositionFrom2DCoordinates(y,u,n,o),w=A(U);U&&l.forEach((function(e){w=A(U);let t,n=p.get3DPositionFromScreenCoordinates({coords:e,viewer:u});U&&(t=function(e,t,n){if(P===u.canvas||!S)return e;let i=S.getElementMatrix(n||t);return e.clone().applyMatrix4((new a.Matrix4).getInverse(i))}(p.getPositionFromIntersection(u,n,U),w,r),m.push({Point3D:t.toArray()}))})),C=new D(u,t),C.setAttributes([{name:"sID",value:t.computeNewID()},{name:"sUuid",value:d.getUUID()},{name:"sName",value:t.computeNewName({object:C,prefix:"CloudMarker3D"})},{name:"oPoints",value:m},{name:"fRotationAngle",value:0},{name:"cLineStyleColor",value:new a.Color("#cc092f")},{name:"cFillStyleColor",value:new a.Color("#cc092f")},{name:"fLineStyleThicknessIndex",value:3},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0},{name:"fLineStyleOpacity",value:1},{name:"fPointedPageNumber",value:r},{name:"sPointedElementID",value:A(U)}]);let b=p.getViewpointInfo(u.currentViewpoint);b&&C.updateProjectionPlaneDefinition({up:b.up,right:b.right});let k=t.getCurrentSlide();k.addDMUObject(C),window.require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","CreateCloudMarker"+k.getType())}))}function F(e){if(e&&e===P)return!0;let t=e.parentNode;for(;t&&"___view___1"!==t.id;){if(t===P)return!0;t=t.parentElement}return!1}function T(){u.currentViewpoint.isMoving()||(M.publish({event:"endCommand",data:null}),b=!1),v=null}function I(e){!u.currentViewpoint.isMoving()&&F(e.from[0].getView())&&(b=!0,v||(v=e.from[0].getStartPosition(u.canvas)),y&&y.updatePreview(e.from[0].getCurrentPosition(u.canvas),!0))}function L(e){if(P=S?S.getElementToDraw(e.from[0].getView()):u.canvas,!P)return;let t=e.from[0].getStartPosition(u.canvas);v||(v=t),y&&(y.updatePreview(e.from[0].getCurrentPosition(u.canvas),!1),y.getPreviewPoints&&3===y.getPreviewPoints().length&&function(){let e={nls:m.ok,url:k+"I_Validate.png",id:"okButtonForCloud",callback:T};if(v){let t=p.getNearPositionFrom2DCoordinates(new a.Vector2(v.x,v.y),u);w=new g({body:M.getFrameWindow().getUIFrame(),viewer:u,frmWindow:M.getFrameWindow(),position:t,mode:"curve",dir:"bottom",lJsonElement:[e]}),w.build(),M.sendNotify("info",m.cloudCreationAndValidationLabel)}}())}function _(e){F(e.from[0].getView())&&v&&!u.currentViewpoint.isMoving()&&M.publish({event:"click",data:e.from[0].getCurrentPosition(u.canvas)})}function V(){var e;M.restoreDefaultController(),u.manipulatorManager.setActivate(!0),u.setDefaultPicking(!0),M.cleanNotify();let t=n.giveDMUCursorsController({context:M.getFrameWindow()});t&&t.restoreCursors(),w&&(w.clear(),w=null);const i=document.getElementById("okButtonForCloud");if(i&&(null===(e=i.parentNode)||void 0===e||e.removeChild(i)),v&&(v=null),r.removeEvent(U,"onMouseMove",I),r.removeEvent(U,"onPrimaryPointerUpUnique",_),r.removeEvent(U,"onPrimaryPointerDownUnique",L),r.removeEvent(U,"onPrimaryPointerDoubleClick",T),S&&S.setTextSelectionFlag(!0),y&&y.destroy(),u.currentViewpoint.setDefaultController(!0,"FLY_WALK"),b=!1,x.length=0,C){let e=C.getNode&&C.getNode()?c.buildPathElement(C.getNode()):null;e&&l.add({pathElement:e}),C=null}M.cancel(),M.done()}this.resumeExecute=function(){let e=n.giveDMUCursorsController({context:M.getFrameWindow()});e&&e.resetCursors(),M.done&&M.done()},this.cancelExecute=function(){V()},this.destroy=function(){V()},this.buildGraph=function(){!function(){let e=i.getReviewContext({viewer:u});if(!e||!e.getCurrentSessionMarkup())return;u.currentViewpoint.setDefaultController(!1,"FLY_WALK"),S||(S=o.getManager({name:"DMU2DSheetManager",context:M.getFrameWindow()})),U=S?S.getPointedElem():u.canvas,S&&S.setTextSelectionFlag(!1),s.empty(),l.empty();let a=n.giveDMUCursorsController({context:M.getFrameWindow()});a&&a.setCursors({pages:U!==u.canvas?"crosshair":null,canvas:U===u.canvas?"crosshair":null,preHLMarkers:"crosshair"}),M.sendNotify("info",m.cloudCreationLabel),u.manipulatorManager.setActivate(!1),u.setDefaultPicking(!1),r.addEvent(U,"onPrimaryPointerDownUnique",L),r.addEvent(U,"onPrimaryPointerUpUnique",_),r.addEvent(U,"onPrimaryPointerDoubleClick",T),y||(y=new f({viewerFrame:M.getFrameWindow().getViewerFrame(),uiFrame:t})),y&&y.startPreview(),M.changeDefaultController()}();let e=this.createInitialState("initialState"),a=this.createState("clickState"),d=this.getFinalState(),c={iSender:this,iEvent:"click",iInitialState:e,iFinalState:a,iCondition:function(){return!b},iAction:function(e){P&&r.addEvent(U,"onMouseMove",I),e()}};this.addTransition(c);let g={iSender:this,iEvent:"click",iInitialState:a,iFinalState:a,iCondition:()=>b};M.addTransition(g);let h={iSender:this,iEvent:"endCommand",iInitialState:a,iFinalState:d,iCondition:null,iAction:function(e){y&&(x=y.getPreviewPoints(),b&&x.pop(),x&&x.length>=3?(E(),y.refreshPreview(),C&&C.fireEvent("onDMUObjectInitialized",{dmuObject:C})):y.refreshPreview(),M.done()),V(),e()}};this.addTransition(h)}}}})),define("DS/DMUMarker/DMUMarkerPictureContextualBar",["DS/DMUMarker/DMUMarkerContextualBar"],(function(e){"use strict";return e.extend({getContextualCommandList:function(e){var t=this._parent(e);return e&&!e.isReadOnly()&&e.isInEdition()&&e.isEditable()&&(t||(t=[]),t.unshift({name:"DMUMarkerShortDisplayStr",line:1,hdr_list:["DMUMarkerShortDisplayHdr"],type:"handler",identifier:"DMUMarkerShortDisplayHdr"})),t},getSharedHeaderTypes:function(){return{leaderProperties:!0,hideShowLeaderProperties:!0}}})})),define("DS/DMUMarker/DMUMarkerLineContextualBar",["DS/DMUMarker/DMUMarkerContextualBar"],(function(e){"use strict";return e.extend({getContextualCommandList:function(){var e=[];return!this.isReadOnly()&&this.isInEdition()&&this.isEditable()&&(e=e.concat([{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"},{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"],type:"handler",identifier:"DMUGraphicPropertiesPanelHdr"}])),e}})})),define("DS/DMUMarker/DMUMarkerTextContextualBar",["DS/DMUMarker/DMUMarkerContextualBar","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";return e.extend({getContextualCommandList:function(e){var n=this._parent(e);if(e&&!e.isReadOnly()&&e.isInEdition()&&e.isEditable()&&(n||(n=[]),n.unshift({name:"Marker_DMUIncreaseFontSizeStr",line:1,hdr_list:["Marker_DMUIncreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUIncreaseFontSizeHdr"},{name:"Marker_DMUDecreaseFontSizeStr",line:1,hdr_list:["Marker_DMUDecreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUDecreaseFontSizeHdr"}),"Marker3DStamp"!==e.getAttribute("sType"))){var i="DefaultStyle";e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#000000")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#ffffff")},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="LightStyle":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#368ec4")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="MeasureStyle":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#000000")},{name:"sFontStyle",value:"italic"},{name:"cFillStyleColor",value:new t.Color("#fee000")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#ff8a2e")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#ff8a2e")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="PostitStyle":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#57b847")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#477738")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#477738")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="ValidateStyle":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#ff8a2e")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#8f4c00")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#8f4c00")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="WarningStyle":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"bold"},{name:"cFillStyleColor",value:new t.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#6d2828")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#6d2828")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))&&(i="CautionStyle"),n.unshift({name:"Marker_DMUStylesStr",line:1,hdr_list:["Marker_DMUDefaultStyleHdr","Marker_DMULightStyleHdr","Marker_DMUMeasureStyleHdr","Marker_DMUPostitStyleHdr","Marker_DMUValidateStyleHdr","Marker_DMUWarningStyleHdr","Marker_DMUCautionStyleHdr"],selectedHdr:i,type:"handler",identifier:"Marker_DMUStylesStr"})}return n},getSharedHeaderTypes:function(){return{leaderProperties:!0,fontProperties:!0,hideShowLeaderProperties:!0}}})})),define("DS/DMUMarker/DMUMarkerFreehandCreateCmd",["DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMarker/DMUMarkerFreehandShapePreview","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/DMUPlayMarker/DMUMarkerFactory","DS/DMUPlayMarker/DMUMarkerTools","DS/3DPlayAnnotationUtils/ShapeUtils","DS/DMUControls/DMUContextToolsMenu","DS/WebappsUtils/WebappsUtils","DS/Utilities/TouchUtils","DS/DMUBaseExperience/EXPManagerSet","DS/WebRunloop/Runloop","i18n!DS/DMUMarker/assets/nls/DMUMarker"],(function(e,t,n,i,r,a,o,l,s,d,c,u,g,h,m,f,p){"use strict";return e.extend({init:function(e){this._parent(e,"exclusive",!0);var D,M,v,C,S,y,P,U,w,b=this.getFrameWindow().getViewer(),x=this,k=!1,A=localStorage.getItem("currentFreehandMode")?localStorage.getItem("currentFreehandMode"):"DMUFreehandAnnotate",E=localStorage.getItem("currentFreehandAnnotateColor")?localStorage.getItem("currentFreehandAnnotateColor"):"DMUFreehandColorRed",F=localStorage.getItem("currentFreehandHighlightColor")?localStorage.getItem("currentFreehandHighlightColor"):"DMUFreehandColorYellow",T=[],I={},L=g.getWebappsAssetUrl("DMUMarker","icons/");let _,V,H,B,R,O,W=!1,N=[],z=new l.Vector3(0,0,0),j=!0;function q(){j&&(z=function(){let e=-1/0,t=1/0,n=-1/0,r=1/0;T.forEach((function(i){e=Math.max(e,i.x),t=Math.min(t,i.x),n=Math.max(n,i.y),r=Math.min(r,i.y)}));let a=new l.Vector2(t,n),o=new l.Vector2(e,r),s=(new l.Vector2).addVectors(a,o).multiplyScalar(.5),d=i.get3DPositionFromScreenCoordinates({coords:s,viewer:b}),c=i.getNearPositionFrom2DCoordinates(s,b,void 0,!1);return i.getPositionFromIntersection(b,d,c)}()),j=!1;var e=n.getReviewContext({viewer:x.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),t=M?M.getPageNumber(U):null;let r=c.shapeEval(N).shape;if(!O&&r&&(r.type="freehand"),S=s.create3DMarker({viewer:b,points:T,shape:r,parent:e,graphicProperties:I,pageNb:t,projectionPoint:z,getRelativePositionCB:function(e,n){if(U===b.canvas||!M)return e;var i=M.getElementMatrix(t||n);return e.clone().applyMatrix4((new l.Matrix4).getInverse(i))},getRelativeRotationCB:function(e){return U!==b.canvas&&M&&t?e-M.getPageRotation(t):e},getElementIDAtPosition:function(e){return M&&"Requirement"===M.getDocumentType()?M.getPointedElemIDAtPosition(e):null}})){var a=e.getCurrentSlide();a.addDMUObject(S),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","CreateFreehand"+("DMUFreehandAnnotate"===A?"Annotate":"Highlight")+a.getType())}))}}function X(){(T=v.getPreviewPoints())&&T.length?(q(),v.refreshPreview(),S&&(S.fireEvent("onDMUObjectInitialized",{dmuObject:S}),P||(P=[]),P.push(S))):v.refreshPreview(),B&&(B.stop(),B.dispose(),B=null),N=[],V=void 0,R=void 0,H=0,W=!1}function G(e){var t;if(W&&k)if(!R&&V)R=V,H=e.time,O=void 0;else if(V&&(t=V.distanceTo(R)),N&&N.length&&(_=c.shapeEval(N).shape),t<5){if(e.time-H>300&&N.length>=2)if(_&&"unknownOpen"!==_.type&&"unknownClosed"!==_.type&&"triangle"!==_.type)v.drawHalfPreview(_,N,!1),O=!0;else if(_&&"unknownOpen"===_.type){let e=[];e=d.getControlPoints(N,15);let t=function(e){if(!e)return;let t=[];return e.forEach((function(e){t.push(new l.Vector2(e.x,e.y))})),new l.SplineCurve(t).getPoints(200)}(e);v.drawHalfPreview(!1,N,t),O=!0}}else O&&(O=void 0,v.destroyHalfPreview(N)),R=V,H=e.time}function K(e){if(e&&e===U)return!0;for(var t=e.parentNode;t&&"___view___1"!==t.id;){if(t===U)return!0;t=t.parentElement}return!1}function J(e){if(!(x.isPaused()||x.getFrameWindow().getViewpoint().isMoving()||y&&y.isCornerButtonActive())){if(k=!0,K(e.from[0].getView())){"touchmove"!==e.from[0].event.type||e.from[0].event.pageX||e.from[0].event.pageY||(e.from[0].event.pageX=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageX:0,e.from[0].event.pageY=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageY:0),D||"begin"!==e.state||(D=e.from[0].getStartPosition(b.canvas));const t=e.from[0].getCurrentPosition(b.canvas);if(V){let e=Math.abs(t.x-V.x),n=Math.abs(t.y-V.y),r=i.convertModelToPixels({sizeInMM:e}),a=i.convertModelToPixels({sizeInMM:n});(r>2||a>2)&&(v.updatePreview(t,!1),N.push(t))}V=t}"end"===e.state&&(k=!1,x.publish({event:"dragEnd"}),X())}}function Y(e){var n,i;"DMUFreehandAnnotate"===A?(E=e.id,localStorage.setItem("currentFreehandAnnotateColor",E),n="22/I_MarkerFreehandCursor",i=") 11 11, auto"):(F=e.id,localStorage.setItem("currentFreehandHighlightColor",F),n="32/I_MarkerFreehandHighlightCursor",i=") 16 16, auto");var r=t.giveDMUCursorsController({context:x.getFrameWindow()});switch(e.id){case"DMUFreehandColorGreen":I.lineStyleColor=new l.Color(5748807),r&&r.setCursors({pages:w!==b.canvas?"url("+L+n+"Green.png"+i:null,canvas:w===b.canvas?"url("+L+n+"Green.png"+i:null});break;case"DMUFreehandColorOrange":I.lineStyleColor=new l.Color(16747054),r&&r.setCursors({pages:w!==b.canvas?"url("+L+n+"Orange.png"+i:null,canvas:w===b.canvas?"url("+L+n+"Orange.png"+i:null});break;case"DMUFreehandColorYellow":I.lineStyleColor=new l.Color(16703488),r&&r.setCursors({pages:w!==b.canvas?"url("+L+n+"Yellow.png"+i:null,canvas:w===b.canvas?"url("+L+n+"Yellow.png"+i:null});break;case"DMUFreehandColorRed":I.lineStyleColor=new l.Color(13371695),r&&r.setCursors({pages:w!==b.canvas?"url("+L+n+"Red.png"+i:null,canvas:w===b.canvas?"url("+L+n+"Red.png"+i:null})}v.setGraphicProperties(I)}function Z(e){"DMUFreehandHighlight"===e.id?(localStorage.setItem("currentFreehandMode","DMUFreehandHighlight"),A=e.id,I.lineCap="square",I.lineStyleThicknessIndex=9,I.lineStyleOpacity=.4,I.isFilled=!0,I.hasBorder=!1,v.setGraphicProperties(I),y.setColor(F),Y({id:F})):"DMUFreehandAnnotate"===e.id?(localStorage.setItem("currentFreehandMode","DMUFreehandAnnotate"),A=e.id,I.lineCap="round",I.lineStyleThicknessIndex=3,I.lineStyleOpacity=1,I.isFilled=!1,I.hasBorder=!0,v.setGraphicProperties(I),y.setColor(E),Y({id:E})):x.publish({event:"lastClick"})}function Q(e){x.isPaused()||y&&y.isCornerButtonActive()||(U=M?M.getElementToDraw(e.from[0].getView()):b.canvas)&&(W=!0,O=void 0,D=e.from[0].getStartPosition(b.canvas),v.updatePreview(D.clone(),!1),N.push(D.clone()),V=D.clone(),B=new f({data:x,func:G}),B.start())}function $(e){x.isPaused()||y&&y.isCornerButtonActive()||!K(e.from[0].getView())||(!D||k||x.getFrameWindow().getViewpoint().isMoving()||(x.publish({event:"click",data:e.from[0].getCurrentPosition(b.canvas)}),X()),D=null,k=!1)}function ee(e){e()}function te(e){"@onViewpointBeginMove"!==e.eventType&&"@onViewpointEndMove"!==e.eventType||v.refreshPreview()}function ne(e){var t=b.get2DMode()?p.freehandManipulationModeLabel2D:p.freehandManipulationModeLabel;x.sendNotify("info",e.checked?t:p.freehandCreationLabel);var n=b.currentViewpoint.getControl();b.get2DMode()||(n.setRotationActive(e.checked),n.setTouchRotationActive(e.checked)),n.setPanActive(e.checked),n.setZoomActive(e.checked),M&&M.setTouchPanActive(e.checked),v.refreshPreview()}this.pauseExecute=function(){y&&y.setVisibleFlag(!1)},this.resumeExecute=function(){y&&y.setVisibleFlag(!0);let e=t.giveDMUCursorsController({context:x.getFrameWindow()});e&&e.resetCursors()},this.cancelExecute=function(){this._endExecute()},this.destroy=function(){this._endExecute()},this._endExecute=function(){C&&a.unsubscribe(C),b.get2DMode()?M&&M.setTouchPanActive(!0):b.currentViewpoint.getControl().setTouchRotationActive(!0),h.getTouchMode()&&(b.get2DMode()||b.currentViewpoint.getControl().setRotationActive(!0),b.currentViewpoint.getControl().setPanActive(!0),b.currentViewpoint.getControl().setZoomActive(!0)),x.cleanNotify(),b.manipulatorManager.setActivate(!0),b.setDefaultPicking(!0);var e=t.giveDMUCursorsController({context:x.getFrameWindow()});e&&e.restoreCursors(),o.removeEvent(w,"onPrimaryPointerUpUnique",$),o.removeEvent(w,"onDrag",J),o.removeEvent(w,"onPrimaryPointerDownUnique",Q),M&&M.setTextSelectionFlag(!0),y&&(y.destroy(),y=null),v&&(v.destroy(),v=null),b.currentViewpoint.setDefaultController(!0,"FLY_WALK"),k=!1,S=T=null,P&&(P.forEach((function(e){x.addInCSO(e,!0)})),P=null),x.restoreDefaultController(),x.cancel(),B&&(B.stop(),B.dispose(),B=null),N=[],V=void 0,R=void 0,H=0,W=!1,j=!0},this.buildGraph=function(){var e;this.changeDefaultController(),(e=n.getReviewContext({viewer:x.getFrameWindow().getViewer()}))&&e.getCurrentSessionMarkup()?(b.currentViewpoint.setDefaultController(!1,"FLY_WALK"),M||(M=m.getManager({name:"DMU2DSheetManager",context:x.getFrameWindow()})),w=M?M.getPointedElem():b.canvas,M&&M.setTextSelectionFlag(!1),x.emptyHSO(),x.emptyCSO(),x.sendNotify("info",p.freehandCreationLabel),b.manipulatorManager.setActivate(!1),b.setDefaultPicking(!1),o.addEvent(w,"onPrimaryPointerDownUnique",Q),o.addEvent(w,"onPrimaryPointerUpUnique",$),o.addEvent(w,"onDrag",J),(y=new u({frameWindow:x.getFrameWindow()})).addButton({label:p.exitFreehandAnnotationsLabel,id:"DMUFreehandExit",icon:L+"32/I_MarkerFreehandExit.png",isOneShot:!0,isSelected:!1,onClickCB:Z}),y.addSeparator(),y.addButton({label:p.annotateModeLabel,id:"DMUFreehandAnnotate",icon:L+"32/I_MarkerFreehand.png",isSelected:"DMUFreehandAnnotate"===A,onClickCB:Z}),y.addButton({label:p.highlightModeLabel,id:"DMUFreehandHighlight",icon:L+"32/I_MarkerFreehandHighlight.png",isSelected:"DMUFreehandHighlight"===A,onClickCB:Z}),y.createColorPalette([{id:"DMUFreehandColorGreen",color:new l.Color(5748807),isSelected:"DMUFreehandAnnotate"===A?"DMUFreehandColorGreen"===E:"DMUFreehandColorGreen"===F,onClickCB:Y},{id:"DMUFreehandColorYellow",color:new l.Color(16703488),isSelected:"DMUFreehandAnnotate"===A?"DMUFreehandColorYellow"===E:"DMUFreehandColorYellow"===F,onClickCB:Y},{id:"DMUFreehandColorOrange",color:new l.Color(16747054),isSelected:"DMUFreehandAnnotate"===A?"DMUFreehandColorOrange"===E:"DMUFreehandColorOrange"===F,onClickCB:Y},{id:"DMUFreehandColorRed",color:new l.Color(13371695),isSelected:"DMUFreehandAnnotate"===A?"DMUFreehandColorRed"===E:"DMUFreehandColorRed"===F,onClickCB:Y}]),v||(v=new r({frameWindow:x.getFrameWindow(),graphicProperties:I})),v.startPreview(),Z({id:A}),C=a.subscribe({event:"/VISU/"},te),b.get2DMode()?M&&M.setTouchPanActive(!1):b.currentViewpoint.getControl().setTouchRotationActive(!1),h.getTouchMode()&&(b.currentViewpoint.getControl().setPanActive(!1),b.currentViewpoint.getControl().setZoomActive(!1),b.get2DMode()||b.currentViewpoint.getControl().setRotationActive(!1),y.createCornerButton({id:"DMUFreehandTouchButton",enabledIcon:L+"../textures/DMUFreehandRotationOn.png",disabledIcon:L+"../textures/DMUFreehandRotationOff.png",onClickCB:ne}))):x.cancel();var t=x.createInitialState("initialState"),i=x.createState("clickState"),s=x.getFinalState(),d={iSender:x,iEvent:"click",iInitialState:t,iFinalState:i,iCondition:function(){return!k},iAction:ee};x.addTransition(d);var c={iSender:x,iEvent:"click",iInitialState:i,iFinalState:i,iCondition:null,iAction:ee};x.addTransition(c);var g={iSender:x,iEvent:"dragEnd",iInitialState:t,iFinalState:i,iCondition:null};x.addTransition(g);var f={iSender:x,iEvent:"dragEnd",iInitialState:i,iFinalState:i,iCondition:null};x.addTransition(f);var D={iSender:x,iEvent:"lastClick",iInitialState:t,iFinalState:s,iCondition:null,iAction:function(e){this._endExecute(),e()}};x.addTransition(D);var S={iSender:x,iEvent:"lastClick",iInitialState:i,iFinalState:s,iCondition:null,iAction:function(e){this._endExecute(),e()}};x.addTransition(S)}}})}));