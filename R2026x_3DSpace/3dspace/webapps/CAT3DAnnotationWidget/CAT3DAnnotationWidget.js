/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationWidget/CATA3EAppInit",["DS/WAfrContainer/App","UWA/Core","DS/Controls/Loader","i18n!DS/CAT3DAnnotationWidget/assets/nls/CAT3DAnnotationWidget"],(function(e,t,n,i){"use strict";var o,a,r={wkbFile:"CAT3DAnnotationWidgetWkb.xml",wkbModule:"CAT3DAnnotationWidget",defaultCmdHdr:"CAT3DAnnotationWidgetDefaultHdr",defaultCmdJSModule:"DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd"};return e.extend({setUp:function(e){var d=this;if(window.widget.getValue("X3DContentId")){var s="",l=JSON.parse(window.widget.getValue("X3DContentId"));l.data&&l.data.items&&l.data.items[0]&&l.data.items[0].displayName&&(s=l.data.items[0].displayName);var c=t.createElement("div",{class:"DMULoadingPanel"}).inject(document.body);(a=new n({text:i.loadingMessage+" "+s}).inject(c)).on(),a.getContent().addClassName("DMULoadingPanelInfoDiv");var p=a.elements.label.getSize().width,u=a.elements.progressBar.getContent().getSize().width,g=a.elements.progressBar.getContent().getSize().height,w=p+u;c.setStyles({position:"absolute",bottom:"0",left:"0","z-index":"40000","background-color":"rgba(255,255,255,1",height:"100%",width:"100%"}),a.getContent().setStyles({position:"absolute",left:"calc(50% - "+w/2+"px)",top:"calc(50% - "+g/2+"px)"})}if(e.sourceApp)if(e.sourceApp.pad3DViewer){this.pad3DViewer=e.sourceApp.pad3DViewer,this.appMainDiv=e.sourceApp.appMainDiv;var A=function(t){t.sourceApp&&!t.sourceApp.isDisposeCalled()&&t.sourceApp.dispose();var n=t;n.widgetData=r;var i=t.done;e.done=function(t){d.appMainDiv||(d.appMainDiv=t.appMainDiv),e.done=i,e.done()},o.setUp(n)};o?A(e):require(["DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget"],(function(t){o=new t({widget:window.widget,data:r,pad3DViewer:e.sourceApp.pad3DViewer,appMainDiv:e.sourceApp.appMainDiv}),A(e)}))}else e.done();else require(["DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget"],(function(t){o=new t({widget:window.widget,viewerAttachment:e.done,done:function(e){d.pad3DViewer=e.pad3DViewer,d.appMainDiv=e.appMainDiv},data:r})}))},dispose:function(e){o&&o.dispose&&o.dispose(e),a&&(a.destroy(),a=null);var t=window.document.getElementsByClassName("DMULoadingPanel");t.length&&t[0].destroy(),this._parent(e)},onWillEnter:function(e){return o&&o.onWillEnter&&o.onWillEnter(e),require(["DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],(function(t){t._sendUsageProbe("appTransitionFrom",e.options.id,"resolved")})),this._parent(e)},onWillLeave:function(e){return o&&o.onWillLeave&&o.onWillLeave(e),require(["DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],(function(t){t._sendUsageProbe("appTransitionTo",e.options.id,"resolved")})),this._parent(e)}})})),window.top.performance.mark("A3E_jsAppLoad"),window.performance.mark("A3E_jsAppLoad"),define("DS/CAT3DAnnotationWidget/CATCommonA3Widget",["DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","DS/CATWebUXComponents/DMUCommandsManager","DS/PADUtils/PADSettingsMgt","DS/CATWebUXComponents/DMUFrameWindow","i18n!DS/CAT3DAnnotationWidget/assets/nls/CAT3DAnnotationWidget"],(function(e,t,n,i){"use strict";var o,a,r,d={};let s=null,l=null;var c=function(e,t,n){window.top.performance.measure(window.widget.id+"_"+e,n?t:window.widget.id+"_"+t),window.performance.measure(e,t)},p=function(e){window.top.performance.mark(window.widget.id+"_"+e),window.performance.mark(e)};function u(){d.viewer.getContentName({callbacks:{onComplete:function(e){d.widget.setTitle(e.contentName)},onFailure:function(){}}})}var g=function(){c("A3E_Global widget creation time","A3E_jsAppLoad",!0),d.widget.dispatchEvent("onWidgetAndAppReady","1"===d.widget.getValue("widgetForODTReplay")?[{pad3DViewer:d.viewer}]:void 0)};function w(e){e.objectId&&require(["DS/CAT3DAnnotControllerForReview/CATDIFAnnotSetLoader"],(function(t){if(d.viewer){new t({context:d.viewer}).load({id:e.objectId})}}))}var A=function(){if(n&&n.setSetting("useNewUXGuidelinesWP",!0),!d.viewer){var A;c("A3E_UWA widget loading","A3E_widgetLoad"),p("A3E_LoadJSPAD3DViewer"),c("A3E_PAD3DViewer load JS","A3E_LoadJSPAD3DViewer"),p("A3E_PAD3DViewerReady"),require("DS/PADUtils/PADUtilsServices").isCloud()?n.setSetting("mouseProfile",window.__mouseProfile):n.setSetting("mouseProfile","CATIA");d.widget;A=d.viewer=s,i.init(A,{executionContext:l}),t.dmuSetExecutionContext(s.getExecutionContext()),t.dmuSetHandlerComponent(s.getExecutionContext()),n.getSetting("mouseProfile")&&A.getViewpoint().setDefaultController(!0,n.getSetting("mouseProfile")),A.setOption("propertiesFacet",n.getSetting("propertiesFacet")),A.setAuthorizedRootTypes(n.getSetting("ups_authorized_root_types")),n.setSetting("settypes",!0),"1"===d.widget.getValue("widgetForODTReplay")&&d.widget.dispatchEvent("onPAD3DViewerCreated",[{pad3DViewer:A}]),d.widgetInitDone&&d.widgetInitDone({appMainDiv:d._appMainDiv,pad3DViewer:A}),function(n){n.unsubscribe(o),o=null,n.setLoadingDelegations({_DIFAnnotationSet:w,...e.getDelegation(d.viewer)}),u(),require("DS/PADUtils/PADUtilsServices").isCloud()&&!window.__preventPrefPanel&&n.getViewer().displayIntroductoryControlPreferencePanel(),n.getController()&&n.getController()._model&&n.getController()._model._modelLoader&&n.getController()._model._modelLoader.setCGRWithSG(!0),c("A3E_PAD3DViewer creation","A3E_PAD3DViewerReady"),p("A3E_ownCommands"),require(["DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],(function(e,t){c("A3E_Annot controller JS Load","A3E_ownCommands"),p("A3E_annotController"),a=t;var i=(r=e).getFavoriteContextManager({context:n});i.setActivationDropState(!0),a.getAnnotationModelLoader({context:n,favoriteCtxManager:i}).setActiveState(1),d.viewerAttachment&&d.viewerAttachment(d._appMainDiv),d.viewerAttachment=null,n.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClic(),c("A3E_Annot controller Init","A3E_annotController"),d.annotControllerReady=!0,g()})),c("A3E_Action Bar merge app commands","A3E_ownCommands"),d.viewer.subscribe({event:"onRootAdded"},u),d.viewer.subscribe({event:"onRootRemoved"},u),d.viewer.subscribe({event:"onRootAttached"},u),d.viewer.subscribe({event:"onRootDetached"},u),d.viewer.subscribe({event:"onContentNameModified"},u),p("A3E_beforeDefaultCmdLoad");var i=d.viewer.getCommandContext?d.viewer.getCommandContext():null;t.setDefaultCommand({ID:d.widgetData.defaultCmdHdr,className:d.widgetData.defaultCmdJSModule,context:i}),c("A3E_Default Cmd Init","A3E_beforeDefaultCmdLoad"),d.defaultCmdReady=!0,g(),d.viewer.getLandingPageComponent().appReady()}(A)}};var m=function(){!function(){var e=n.getSetting("enopad3dviewer_roles");let t=!0,i=require("DS/PADUtils/PADUtilsServices").isCloud(),o=require("DS/PADUtils/PADSession").isAuthoring();for(var a=0;a<e.length;a++)if("E19"===e[a].id&&(!e[a].platforms||e[a].platforms&&e[a].platforms.indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)){t=!1;break}n.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",t&&!i&&!o),n.setSetting("enopad3dviewer_staticMappingSupportActivated",!o)}(),d.viewer&&d.viewer.refresh()},D=function(){d.viewer&&(a.unreferenceAnnotationModelLoader({context:d.viewer}),r.unreferenceFavoriteContextManager({context:d.viewer}),d.viewer.destroy()),d={},a=r=null};function v(e){d.viewer&&d.viewer.search({searchQuery:e})}return class{constructor(n){d.widget=n.widget,d.widgetData=n.data,d._appMainDiv=n.appMainDiv,d.widgetInitDone=n.done,s=n.viewer,l=n.executionContext,n.pad3DViewer?(d.viewer=n.pad3DViewer,i.init(d.viewer,{executionContext:l})):(c("A3E_JS dependencies loading","A3E_jsAppLoad",!0),p("A3E_widgetLoad"),n.viewerAttachment?(d.viewerAttachment=n.viewerAttachment,A()):(d.viewerAttachment=function(e){e&&d.widget.setBody(e)},d.widget.addEvent("onLoad",A)),d.widget.addEvent("onRefresh",m),d.widget.addEvent("onDestroy",D),d.widget.addEvent("onSearch",v),d.widget.setMetas({helpPath:(d.widgetData.defaultCmdHdr.search("Insight")>=0?"CAT3DAnnotSemanticWidget":"CAT3DAnnotationWidget")+"/assets/help"})),this.setUp=function(n){require(["DS/CATWebUXComponents/DMUCommandsManager"],(function(o){d.widget.addEvent("onRefresh",m),d.widget.addEvent("onSearch",v),d.widget.setMetas({helpPath:(d.widgetData.defaultCmdHdr.search("Insight")>=0?"CAT3DAnnotSemanticWidget":"CAT3DAnnotationWidget")+"/assets/help"}),o.refreshCommandsManager(l,"CAT3DAnnotationWidgetDefaultHdr"),n.sourceApp&&n.sourceApp.pad3DViewer!==d.viewer&&(d.viewer=n.sourceApp.pad3DViewer,i.init(d.viewer,{executionContext:l})),d.viewer.setOption("propertiesFacet",require("DS/PADUtils/PADSettingsMgt").getSetting("propertiesFacet")),d.viewer.getBIController().toggleBetweenStandaloneAndSlaveMode("DUAL"),d.viewer.setLoadingDelegations({_DIFAnnotationSet:w,...e.getDelegation(d.viewer)}),d.viewer.getViewer().updateViewPanelUIConfiguration&&d.viewer.getViewer().updateViewPanelUIConfiguration({useShadingIllustration:!1,useOutline:!1}),u(),require(["DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],(function(e,i){var o=d.viewer?d.viewer.getFrameWindow():null;o&&o.removeReviewModel&&o.removeReviewModel("DMUSection"),o&&o.removeReviewModel&&o.removeReviewModel("DMUClipping"),a=i;var s=(r=e).getFavoriteContextManager({context:d.viewer});s.setActivationDropState(!0),a.getAnnotationModelLoader({context:d.viewer,favoriteCtxManager:s}).setActiveState(1);var l=d.viewer.subscribe({event:"onActionBarReady"},(function(){d.viewer.unsubscribe(l),t.setDefaultCommand({ID:n.widgetData.defaultCmdHdr,className:n.widgetData.defaultCmdJSModule,context:d.viewer.getCommandContext()}),d.defaultCmdReady=!0,n.done({appMainDiv:d._appMainDiv,pad3DViewer:d.viewer}),g()}));d.annotControllerReady=!0,g()})),require("DS/ENOXInterWdgCom/LinkManager").updateLinkability({appIds:[],open:!0,uses:["ENXContent","ENXContentSync3D","ENXContentSync2D","ENXAuthoring2D","ENXAuthoring3D","ENXLandingPageSync"],implements:["ENXContent","ENXContentSync3D","ENXLandingPageSync"]}),require("DS/PADUtils/PADSettingsMgt").setSetting("activateWidgetLink",!0),require("DS/PADUtils/PADSettingsMgt").setSetting("useNewUXGuidelinesWP",!0);let s=d.viewer.getLandingPageComponent();s.setViewer(d.viewer),s.appReady(),n.done&&n.done()}))};var o=!1;this.dispose=function(){if(d.widget.removeEvent("onRefresh",m),d.widget.removeEvent("onSearch",v),d.viewer){if(d.viewer.setLoadingDelegations({}),o){var e=require("DS/CAT3DAnnotationController/CAT3DAnnotationController");if(e){var t=e.giveAnnotationController({context:d.viewer});t&&t.saveLastFTAViewOrCaptureDisplayed(!0)}}a&&!o&&a.unreferenceAnnotationModelLoader({context:d.viewer}),r&&r.unreferenceFavoriteContextManager({context:d.viewer})}d.defaultCmdReady=!1,d.annotControllerReady=!1;let n=d.viewer&&d.viewer.getExecutionContext&&d.viewer.getExecutionContext()&&d.viewer.getExecutionContext().getTargetApp?d.viewer.getExecutionContext().getTargetApp():void 0;i.reset(n&&"ENX3DIR_AP"===n.getAfrAppId()?d.viewer:void 0)},this.onWillLeave=function(e){o=!(!e||!e.options||"ENOR3D_AP"!==e.options.id)}}}})),define("DS/CAT3DAnnotationWidget/CATCommonA3AppInit",["DS/WAfrContainer/App","UWA/Core","DS/Controls/Loader","i18n!DS/CAT3DAnnotationWidget/assets/nls/CAT3DAnnotationWidget"],(function(e,t,n,i){"use strict";var o,a,r;return e.extend({setUp:function(e){r=this.options.id.includes("Semantic")?{wkbFile:"CAT3DAnnotSemanticWidgetWkb.xml",wkbModule:"CAT3DAnnotSemanticWidget",defaultCmdHdr:"CAT3DAnnotationWidgetDefaultHdr",defaultCmdJSModule:"DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticWidgetDefaultCmd"}:{wkbFile:"CAT3DAnnotationWidgetWkb.xml",wkbModule:"CAT3DAnnotationWidget",defaultCmdHdr:"CAT3DAnnotationWidgetDefaultHdr",defaultCmdJSModule:"DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd"};var d=this;if(window.widget.getValue("X3DContentId")&&!e.sourceApp){var s="",l=JSON.parse(window.widget.getValue("X3DContentId"));l.data&&l.data.items&&l.data.items[0]&&l.data.items[0].displayName&&(s=l.data.items[0].displayName);var c=t.createElement("div",{class:"DMULoadingPanel"}).inject(document.body);(a=new n({text:i.loadingMessage+" "+s}).inject(c)).on(),a.getContent().addClassName("DMULoadingPanelInfoDiv");var p=a.elements.label.getSize().width,u=a.elements.progressBar.getContent().getSize().width,g=a.elements.progressBar.getContent().getSize().height,w=p+u;c.setStyles({position:"absolute",bottom:"0",left:"0","z-index":"40000","background-color":"rgba(255,255,255,1",height:"100%",width:"100%"}),a.getContent().setStyles({position:"absolute",left:"calc(50% - "+w/2+"px)",top:"calc(50% - "+g/2+"px)"})}if(!e.sourceApp)return new Promise((t=>{require(["DS/CAT3DAnnotationWidget/CATCommonA3Widget"],(function(t){o=new t({widget:window.widget,viewer:d.getExecutionContext().getComponent("Viewer"),executionContext:d.getExecutionContext(),viewerAttachment:e.done,done:function(e){d.pad3DViewer=e.pad3DViewer,d.appMainDiv=e.appMainDiv},data:r})})),e.done&&e.done(),t()}));if(e.sourceApp.pad3DViewer){this.pad3DViewer=e.sourceApp.pad3DViewer,this.appMainDiv=e.sourceApp.appMainDiv;var A=function(t){t.sourceApp&&!t.sourceApp.isDisposeCalled()&&t.sourceApp.dispose();var n=t;n.widgetData=r;var i=t.done;e.done=function(t){!d.appMainDiv&&t&&t.appMainDiv&&(d.appMainDiv=t.appMainDiv),e.done=i,e.done()},o.setUp(n)};o?A(e):require(["DS/CAT3DAnnotationWidget/CATCommonA3Widget"],(function(t){o=new t({widget:window.widget,data:r,pad3DViewer:e.sourceApp.pad3DViewer,appMainDiv:e.sourceApp.appMainDiv,viewer:d.getExecutionContext().getComponent("Viewer"),executionContext:d.getExecutionContext()}),A(e)}))}else e.done()},dispose:function(e){o&&o.dispose&&o.dispose(e),a&&(a.destroy(),a=null);var t=window.document.getElementsByClassName("DMULoadingPanel");t.length&&t[0].destroy(),this._parent(e)},onWillEnter:function(e){return o&&o.onWillEnter&&o.onWillEnter(e),this.options.id.includes("Semantic")?require(["DS/PADUtils/PADSettingsMgt"],(function(e){e.setSetting("enopad3dviewer_staticMappingSupportActivated",!0)})):require(["DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],(function(t){t._sendUsageProbe("appTransitionFrom",e.options.id,"resolved")})),this._parent(e)},onWillLeave:function(e){return o&&o.onWillLeave&&o.onWillLeave(e),this.options.id.includes("Semantic")||require(["DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],(function(t){t._sendUsageProbe("appTransitionTo",e.options.id,"resolved")})),this._parent(e)}})})),window.top.performance.mark("A3E_jsAppLoad"),window.performance.mark("A3E_jsAppLoad"),define("DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget",["UWA/Core","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions","DS/PADServices/views/LandingPage","DS/PADServices/utils/GlobalModelEvents","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","DS/PADUtils/PADSettingsMgt","DS/CATWebUXComponents/DMUFrameWindow","i18n!DS/CAT3DAnnotationWidget/assets/nls/CAT3DAnnotationWidget"],(function(e,t,n,i,o,a,r,d){"use strict";var s,l,c,p={},u=function(e,t,n){window.top.performance.measure(window.widget.id+"_"+e,n?t:window.widget.id+"_"+t),window.performance.measure(e,t)},g=function(e){window.top.performance.mark(window.widget.id+"_"+e),window.performance.mark(e)};const w=[{key:"difAnnotSet",type:"DIFAnnotationSet"}],A=["ds6w:label","ds6w:type","ds6wg:revision","ds6w:status","owner","ds6w:responsible","ds6w:modified","ds6w:project","ds6w:identifier"];function m(){var e=this.params.widget.getValue("xsceneStoredObjects");return e&&"string"==typeof e||(e='{"products":{},"filters":{}}'),JSON.parse(e)}function D(e){e&&e.length&&(this.showWelcomePanel(!1),this.pad3DViewer.addRootNodesFromContent({json3DXContent:{protocol:"3DXContent",version:"1.1",source:"X3DSEAR_AP",data:{items:e.map((function(e){return{envId:require("DS/PADUtils/PADUtilsServices").getPlatformId(),objectId:e.id,objectType:e.type,displayName:e.displayName}}))}}}))}function v(e){D.call(this,e.map((function(e){return{id:e.resourceid,type:e["ds6w:type_value"],displayName:e["ds6w:label"]}})))}function f(e){if(e&&e.length){i.publish({event:"ENXViews/LandingPage/addOrRefresh",data:{objects:e.map((function(e){return{resourceid:e,openWithFilter:!1,loading:!0,fromCustom:!0}}))}});var t=setInterval(function(){this.isAppReady&&this.welcomePanel&&(clearInterval(t),function(e,t){require("DS/WAFData/WAFData").authenticatedRequest(require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/fetch/v2?tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId(),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")},data:JSON.stringify({physicalid:e,label:"A3IFetchForWelcomePanel"+Date.now(),select_predicate:A,select_file:["icon","thumbnail_2d"]}),onComplete:t,onFailure:function(){},onTimeout:function(){}})}(e,function(e){if(this.welcomePanel){var t=((e?JSON.parse(e):{}).results||[]).map(function(e){var t={},n=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),i=n.getRoots(this.pad3DViewer).map((function(e){return n.getNodeID(e)}));e.attributes.forEach((function(e){t[e.name]=e.value}));var o=t["ds6w:type"],a={resourceid:t.resourceid,label:t["ds6w:label"],icons:[t.type_icon_url],thumbnail:t.preview_url,grid:t,subLabel:t["ds6w:responsible"]+" | "+new Date(t["ds6w:modified"]).toLocaleString(),description:t["ds6w:identifier"],openWithFilter:!1,fromCustom:!0,loading:void 0,opened:i.indexOf(t.resourceid)>-1,item2Load:{}};return a.item2Load[a.resourceid]={},"DIFAnnotationSet"===o&&(a.addRemoveFromViewCtx=!0),a}.bind(this));i.publish({event:"ENXViews/LandingPage/addOrRefresh",data:{objects:t}})}}.bind(this)))}.bind(this),100)}}function C(e){this.isAppReady=!1,this.params=e,this.welcomePanel=this.pad3DViewer=null,this.tokensWelcomePanel=[],this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/LandingPage/refreshCustom"},f.bind(this))),this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/LandingPage/openCustom"},function(e){var t=m.call(this),n=[];e.customitem2open.forEach((function(e){w.some((function(i){if(t[i.key]&&t[i.key][e])return n.push({id:e,type:i.type}),!0}))})),D.call(this,n)}.bind(this))),this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/LandingPage/removeFromView"},function(e){if(e&&e.customitem2remove&&e.customitem2remove.length){var t=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),n=t.getRoots(this.pad3DViewer).map((function(e){return t.getNodeID(e)}));this.pad3DViewer.getApplicativeData().removeDIFAnnotSetKeepPrd&&e.customitem2remove.forEach((e=>{this.pad3DViewer.getApplicativeData().removeDIFAnnotSetKeepPrd(e)})),n.forEach((function(t){e.customitem2remove.indexOf(t)>-1&&this.pad3DViewer.removeRoots({pids:[t]})}),this)}}.bind(this))),this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/LandingPage/removeFromStore"},function(e){if(e&&e.customitem2remove&&e.customitem2remove.length){var t=m.call(this),n=[];e.customitem2remove.forEach((function(e){w.some((function(i){if(t[i.key]&&t[i.key][e]&&-1===n.indexOf(e))return n.push(e),delete t[i.key][e],!0}))})),this.params.widget.setValue("xsceneStoredObjects",JSON.stringify(t)),i.publish({event:"ENXViews/LandingPage/removeFromView",data:{customitem2remove:n}})}}.bind(this))),this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelDIFAnnotationSet"},function(){n.launchSearch({title:d.difAnnotSet,precondition:'flattenedtaxonomies:"types/DIFAnnotationSet"',showApplyButton:!1,ok:v.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/WelcomePanel/action/welcomPanelPrefCmd"},function(){require(["DS/CATWebUXComponents/DMUCommandsManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,t){let n=t.givePreferenceManager({context:this.pad3DViewer.getFrameWindow()});if(n)var i=n.subscribe("onPreferencesPanelDestroyed",function(){n.unsubscribe(i),this.showWelcomePanel(!0)}.bind(this));this.showWelcomePanel(!1),e&&e.getCommand("CATWebUXPreferencesHdr",this.pad3DViewer&&this.pad3DViewer.getCommandContext?this.pad3DViewer.getCommandContext():null).begin()}.bind(this))}.bind(this))),this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/WelcomePanel/action/userAssistance"},(function(){let e=require("DS/WebUAUtils/WebUAUtils");window.open(e.getHelpFullPath(d.userAssistanceURL))}))),this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/WelcomePanel/action/whatsNew"},(function(){let e=require("DS/WebUAUtils/WebUAUtils");window.open(e.getEmbeddedHelpFullPath(d.whatsNewURL))})));var t=n.getDefaultActivities();t.activities[0].section.actions.splice(4,0,{id:"welcomePanelDIFAnnotationSet",title:d.difAnnotSet,icon:"annotation"}),t.activities.push({section:{id:"customizeAppSection",title:d.customApp,actions:[{id:"welcomPanelPrefCmd",title:d.prefs,icon:"cog"}]}}),t.activities.push({section:{id:"contentAndKnowledge",title:d.contentAndKnowledge,actions:[{id:"userAssistance",title:d.userAssistance,icon:"help"},{id:"whatsNew",title:d.whatsNew,icon:"megaphone"}]}}),this.welcomePanel=new n({widget:e.widget,readOnlyApp:!1,renderDiv:e.renderDiv,externalViewerMgt:!0,externalViewerMgtCB:function(e,t){!0!==t&&this.showWelcomePanel("viewer"!==e)}.bind(this),globalSearchPrecond:'flattenedtaxonomies:"types/DIFAnnotationSet" OR flattenedtaxonomies:"types/VPMReference" OR flattenedtaxonomies:"types/VPMRepReference"',defaultActionId:t.defaultActionId,activities:t.activities,onLandingPageReady:e.onLandingPageReady})}function h(){p.viewer.getContentName({callbacks:{onComplete:function(e){p.widget.setTitle(e.contentName)},onFailure:function(){}}})}C.prototype={constructor:C,initialize:function(){var e=this.welcomePanel.initialize();return e.then(function(){var e=m.call(this),t=Array.prototype.concat.apply([],w.map((function(t){return Object.keys(e[t.key]||[])})));f.call(this,t)}.bind(this)),e},setViewer:function(e){this.pad3DViewer=e,!this.params.initApp&&this.showWelcomePanel(!1);var t=e.render().getContent(),n=t.parentNode;t.style.position="relative",!this.params.renderDiv.parentNode&&n&&n!==this.params.renderDiv&&n.insertBefore(this.params.renderDiv,n.firstChild),this.params.renderDiv.insertBefore(t,this.params.renderDiv.firstChild),this.welcomePanel&&(this.params.renderDiv.insertBefore(this.welcomePanel.elements.mainBody,this.params.renderDiv.firstChild),this.welcomePanel.setViewer(e,!this.params.initApp)),this.params.initApp&&!this.welcomePanel&&require(["DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession"],function(t){t.init({widget:this.params.widget,pad3DViewer:e})}.bind(this))},appReady:function(){if(this.isAppReady=!0,!this.welcomePanel&&this.params.initApp)require(["DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession"],(function(e){e.restoreSession()}));else if(this.welcomePanel&&this.params.initApp){var e=this.params.widget.getValue("X3DContentId");let t=this;this.params.widget.deleteValue("X3DContentId"),e&&setTimeout((function(n){t.showWelcomePanel(!1),n.addRootNodesFromContent({json3DXContent:JSON.parse(e),dispatch:!1})}),0,this.pad3DViewer)}if(this.welcomePanel){var t=this.welcomePanel.appReady();return this.welcomePanel.redraw(),t}},dispose:function(){if(this.showWelcomePanel(!1),this.welcomePanel)return this.pad3DViewer=this.params=null,this.tokensWelcomePanel.forEach(i.unsubscribe,i),this.tokensWelcomePanel.length=0,this.welcomePanel.dispose()},showWelcomePanel:function(e){this.welcomePanel&&(this.welcomePanel.elements.mainBody.style.position="relative",this.welcomePanel.elements.mainBody.style.display=e?"":"none",e&&this.welcomePanel.redraw())}};var S=function(){p.annotControllerReady&&p.defaultCmdReady&&(u("A3E_Global widget creation time","A3E_jsAppLoad",!0),p.widget.dispatchEvent("onWidgetAndAppReady","1"===p.widget.getValue("widgetForODTReplay")?[{pad3DViewer:p.viewer}]:void 0))};function P(e,n){var i={merge:!1,file:n.wkbFile,module:n.wkbModule};t.getOption("testWkb")&&"CAT3DAnnotSemanticWidgetWkb.xml"===i.file?i={merge:!1,file:"CAT3DAnnotSemanticWidgetWkb_TST.xml",module:"CAT3DAnnotSemanticTestWidget"}:t.getOption("testWkb")&&"CAT3DAnnotationWidgetWkb.xml"===i.file&&(i={merge:!1,file:"CAT3DAnnotationWidgetWkb_TST.xml",module:"CAT3DAnnotationTestWidget"}),e.loadActionBar(i)}var b,y,E,_=function(){require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","DS/PADUtils/PADCommandProxy"],(function(e,t){(b=e).renderDiv||b.initialize2(p.viewer.getFrameWindow().getViewerFrame(),t.appId(),p.widget.getValue("changeControlActivation")?"show":"hide","top-right",(function(){b.addEvent("onAuthoringCtxVisible",(function(e){e.showAuthoringContext&&p.widget.setValue("changeControlActivation",!0)}))}))}))},M=function(e){require(["DS/PADUtils/PADCommandProxy","DS/PADUtils/PADSharedSettings","i18n!DS/PADUtils/assets/nls/PADUtils"],(function(n,i,o){var r,d=[],s=[];E=function(){p.widget.setPreferences([]),r.destroy(),d.forEach((function(e){e.cb&&a.removeEvent(e.cb,e.padFct)})),E=function(){}},y=function(){d.forEach((function(e){var t=e.preference.name,n=p.widget.getValue(t),i=a.getSetting(t);(n="boolean"===e.preference.type&&"boolean"!=typeof n?"true"===n:n)!==i&&a.setSetting(t,n),e.fct&&e.fct(n)})),a.updateWidgetPreferences(),!r&&d.length&&(r=n.create({events:{onPreferenceModification:function(e){d.some((function(t){if(e.name===t.preference.name){if("boolean"!=typeof e.value&&"string"!=typeof e.value)throw new Error("Value must be a string or a boolean");if(a.getSetting(e.name)!==e.value){if("boolean"===t.preference.type&&"boolean"!=typeof e.value)throw new Error("Preference is a boolean type so value must be a boolean");t.debounce=!0,p.widget.setValue(e.name,e.value),a.setSetting(e.name,e.value)}return t.fct&&t.fct(e.value),!0}}))}}}),d.forEach((function(e){e.cb&&a.addEvent(e.cb,e.padFct=function(t){e.debounce?e.debounce=!1:r.preferenceModification({name:e.preference.name,value:t})})})))},p.widget.setPreferences([]),a.setSetting("syncAutoReload",!0),i.destroy(),i.addSharedSettings(p.widget),d.push({preference:{name:"changeControlActivation",type:"boolean",label:o.changeControlActivation_label,defaultValue:!1},fct:function(e){b&&b[e?"show":"hide"]()},cb:"onChangeControlActivation",debounce:!1}),d.push({preference:{name:"changeControlPosition",type:"list",label:o.changeControlPosition_label,defaultValue:"top-right",options:[{label:o["top-right_label"],value:"top-right"},{label:o["top-left_label"],value:"top-left"},{label:o["bottom-left_label"],value:"bottom-left"},{label:o["bottom-right_label"],value:"bottom-right"}]},fct:function(e){b&&b.setPosition(e)}}),a.setSetting("authorizeChangeControl",!0),e&&_(),t.getOption("debug")?d.push({preference:{name:"webapi_timeout",type:"text",label:"Query timeout",defaultValue:"60000"}}):s=["webapi_timeout"],s.forEach((function(e){p.widget.deleteValue(e)})),s.length=0,d.forEach((function(e){p.widget.mergePreferences([e.preference])})),y(),require(["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer"],(e=>{p.widget.addEvent("onChangeFlexibleAssembliesSupport",(function(e,t){a.setSetting(e,t)}));var t=a.getSetting("enopad3dviewer_roles");let n=!0,i=require("DS/PADUtils/PADUtilsServices").isCloud(),o=require("DS/PADUtils/PADSession").isAuthoring();for(var r=0;r<t.length;r++)if("E19"===t[r].id&&(!t[r].platforms||t[r].platforms&&t[r].platforms.indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)){n=!1;break}!n||i||o?(p.widget.addPreference({name:"enopad3dviewer_flexibleAssemblySupportActivated",type:"hidden",defaultValue:!1,label:e.flexibleAssemblySupport,onchange:"onChangeFlexibleAssembliesSupport",value:!1}),a.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",!1)):p.widget.getPreference("enopad3dviewer_flexibleAssemblySupportActivated")||(p.widget.addPreference({name:"enopad3dviewer_flexibleAssemblySupportActivated",type:"boolean",defaultValue:!1,label:e.flexibleAssemblySupport,onchange:"onChangeFlexibleAssembliesSupport",value:void 0!==p.widget.getValue("enopad3dviewer_flexibleAssemblySupportActivated")&&p.widget.getValue("enopad3dviewer_flexibleAssemblySupportActivated")}),a.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",p.widget.getValue("enopad3dviewer_flexibleAssemblySupportActivated"))),a.setSetting("enopad3dviewer_staticMappingSupportActivated",!o)})),p.widget.addEvent("endEdit",y)}))};function W(e){e.objectId&&require(["DS/CAT3DAnnotControllerForReview/CATDIFAnnotSetLoader"],(function(t){if(p.viewer){new t({context:p.viewer}).load({id:e.objectId})}}))}var x=function(e){e.unsubscribe(s),s=null,e.setLoadingDelegations({_DIFAnnotationSet:W,...o.getDelegation(p.viewer)}),h(),_(),require("DS/PADUtils/PADUtilsServices").isCloud()&&!window.__preventPrefPanel&&e.getViewer().displayIntroductoryControlPreferencePanel(),e.getController()&&e.getController()._model&&e.getController()._model._modelLoader&&e.getController()._model._modelLoader.setCGRWithSG(!0),u("A3E_PAD3DViewer creation","A3E_PAD3DViewerReady"),g("A3E_ownCommands"),require(["DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],(function(t,n){u("A3E_Annot controller JS Load","A3E_ownCommands"),g("A3E_annotController"),l=n;var i=(c=t).getFavoriteContextManager({context:e});i.setActivationDropState(!0),l.getAnnotationModelLoader({context:e,favoriteCtxManager:i}).setActiveState(1),p.viewerAttachment&&p.viewerAttachment(p._appMainDiv),p.viewerAttachment=null,e.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange(),u("A3E_Annot controller Init","A3E_annotController"),p.annotControllerReady=!0,S()}));var t=e.subscribe({event:"onActionBarReady"},(function(){u("A3E_Action Bar merge app commands","A3E_ownCommands"),p.viewer.unsubscribe(t),t=null,p._welcomePanel.appReady(),p.viewer.subscribe({event:"onRootAdded"},h),p.viewer.subscribe({event:"onRootRemoved"},h),p.viewer.subscribe({event:"onRootAttached"},h),p.viewer.subscribe({event:"onRootDetached"},h),p.viewer.subscribe({event:"onContentNameModified"},h),p.viewer.subscribe({event:"onBeginRootLoading"},(function(){var e=window.document.getElementsByClassName("DMULoadingPanelInfoDiv"),t=window.document.getElementsByClassName("DMULoadingPanel");e.length&&(e[0].dsModel.off(),e[0].dsModel.destroy(),e=null),t.length&&t[0].destroy()})),g("A3E_beforeDefaultCmdLoad"),require(["DS/CATWebUXComponents/DMUCommandsManager"],(function(e){var t=p.viewer.getCommandContext?p.viewer.getCommandContext():null;e.setDefaultCommand({ID:p.widgetData.defaultCmdHdr,className:p.widgetData.defaultCmdJSModule,context:t}),u("A3E_Default Cmd Init","A3E_beforeDefaultCmdLoad"),p.defaultCmdReady=!0,S()}))}));P(e,p.widgetData)};function V(t){return p._appMainDiv||(p._appMainDiv=e.createElement("div",{class:"appMain",styles:{width:"auto",height:"100%"}})),p._welcomePanel=new C({widget:p.widget,readOnlyApp:!1,renderDiv:p._appMainDiv,initApp:t&&t.initApp,onLandingPageReady:t&&t.onLandingPageReady}),p._welcomePanel.initialize()}var T=function(){if(a&&(a.setSetting("activateWidgetLink",!0),a.setSetting("useNewUXGuidelinesWP",!0)),!p.viewer){u("A3E_UWA widget loading","A3E_widgetLoad"),g("A3E_LoadJSPAD3DViewer");var e=new Promise((function(e){require(["DS/PADUtils/PADSharedSettings"],(t=>{t.addSharedSettings(p.widget,["showWelcomePanel"]),V({initApp:!0,onLandingPageReady:function(){p.viewerAttachment(p._appMainDiv),p.viewerAttachment=null}}).then(e)}))})),t=new Promise((function(e){require(["DS/ENOPAD3DViewer/PAD3DViewer","text!DS/CAT3DAnnotationWidget/assets/json/CAT3DAnnotationWidget.json"],(function(t,n){e([t,n])}))})),n=new Promise((e=>{require(["DS/ENOXInterWdgCom/LinkManager"],(t=>{t.initializeWidgetLink(p.widget,{appIds:[],uses:["ENXContent","ENXContentSync3D","ENXContentSync2D","ENXAuthoring2D","ENXAuthoring3D","ENXLandingPageSync"],implements:["ENXContent","ENXContentSync3D","ENXLandingPageSync"],open:!0}).then(e)}))}));Promise.all([e,t,n]).then((function(e){u("A3E_PAD3DViewer load JS","A3E_LoadJSPAD3DViewer"),g("A3E_PAD3DViewerReady");var t,n=JSON.parse(e[1][1]);n.context="Default",n.mouseProfile=require("DS/PADUtils/PADUtilsServices").isCloud()?window.__mouseProfile:"CATIA";var i={widget:p.widget,windowOptions:n,enableFiltering:!0,binaryPrimitives:!0,enableSidePanel:!0,readyCB:M,visuProgressiveTileModel:!0};t=p.viewer=new e[1][0](i),r.init(t),n.mouseProfile&&t.getViewpoint().setDefaultController(!0,n.mouseProfile),p._welcomePanel.setViewer(t),t.setOption("propertiesFacet",a.getSetting("propertiesFacet")),t.setAuthorizedRootTypes(a.getSetting("ups_authorized_root_types")),s=t.subscribe({event:"onReady"},x),a.setSetting("settypes",!0),"1"===p.widget.getValue("widgetForODTReplay")&&p.widget.dispatchEvent("onPAD3DViewerCreated",[{pad3DViewer:t}]),p.widgetInitDone&&p.widgetInitDone({appMainDiv:p._appMainDiv,pad3DViewer:t})}))}};var U=function(){!function(){var e=a.getSetting("enopad3dviewer_roles");let t=!0,n=require("DS/PADUtils/PADUtilsServices").isCloud(),i=require("DS/PADUtils/PADSession").isAuthoring();for(var o=0;o<e.length;o++)if("E19"===e[o].id&&(!e[o].platforms||e[o].platforms&&e[o].platforms.indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)){t=!1;break}a.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",t&&!n&&!i),a.setSetting("enopad3dviewer_staticMappingSupportActivated",!i)}(),p.viewer&&p.viewer.refresh()},L=function(){p._welcomePanel&&p._welcomePanel.dispose(),p._welcomePanel=null,p.viewer&&(l.unreferenceAnnotationModelLoader({context:p.viewer}),c.unreferenceFavoriteContextManager({context:p.viewer}),p.viewer.destroy()),p={},l=c=null};function R(e){p.viewer&&p.viewer.search({searchQuery:e})}var N=function(e){p.widget=e.widget,p.widgetData=e.data,p._appMainDiv=e.appMainDiv,p.widgetInitDone=e.done,e.pad3DViewer?(p.viewer=e.pad3DViewer,r.init(p.viewer)):(u("A3E_JS dependencies loading","A3E_jsAppLoad",!0),g("A3E_widgetLoad"),e.viewerAttachment?(p.viewerAttachment=e.viewerAttachment,T()):(p.viewerAttachment=function(e){p.widget.setBody(e)},p.widget.addEvent("onLoad",T)),p.widget.addEvent("onRefresh",U),p.widget.addEvent("onDestroy",L),p.widget.addEvent("onSearch",R),p.widget.setMetas({helpPath:(p.widgetData.defaultCmdHdr.search("Insight")>=0?"CAT3DAnnotSemanticWidget":"CAT3DAnnotationWidget")+"/assets/help"}))};N.prototype.setUp=function(e){require(["DS/CATWebUXComponents/DMUCommandsManager"],(function(t){p.widget.addEvent("onRefresh",U),p.widget.addEvent("onSearch",R),p.widget.setMetas({helpPath:(p.widgetData.defaultCmdHdr.search("Insight")>=0?"CAT3DAnnotSemanticWidget":"CAT3DAnnotationWidget")+"/assets/help"});var n={lastCommand:[],currentCommand:null,defaultCommand:null},i=p.viewer.getCommandContext();i?t._commandsState[i]=n:t._commandsState=n,t.resetDefaultCommand(i),t._isCommandEnding=!1,t._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach((function(e){var n=i?t[e][i]:t[e];Object.keys(n).forEach((function(e){var t=n[e];t&&t._destroy&&t._destroy(),delete n[e]}))})),e.sourceApp&&e.sourceApp.pad3DViewer!==p.viewer&&(p.viewer=e.sourceApp.pad3DViewer,r.init(p.viewer)),p.viewer.setOption("propertiesFacet",require("DS/PADUtils/PADSettingsMgt").getSetting("propertiesFacet")),p.viewer.getBIController().toggleBetweenStandaloneAndSlaveMode("DUAL"),p.viewer.setLoadingDelegations({_DIFAnnotationSet:W,...o.getDelegation(p.viewer)}),M(p.viewer),p.viewer.getViewer().updateViewPanelUIConfiguration&&p.viewer.getViewer().updateViewPanelUIConfiguration({useShadingIllustration:!1,useOutline:!1}),h(),require(["DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],(function(n,i){var o=p.viewer?p.viewer.getFrameWindow():null;o&&o.removeReviewModel&&o.removeReviewModel("DMUSection"),o&&o.removeReviewModel&&o.removeReviewModel("DMUClipping"),l=i;var a=(c=n).getFavoriteContextManager({context:p.viewer});a.setActivationDropState(!0),l.getAnnotationModelLoader({context:p.viewer,favoriteCtxManager:a}).setActiveState(1);var r=p.viewer.subscribe({event:"onActionBarReady"},(function(){p.viewer.unsubscribe(r),t.setDefaultCommand({ID:e.widgetData.defaultCmdHdr,className:e.widgetData.defaultCmdJSModule,context:p.viewer.getCommandContext()}),p.defaultCmdReady=!0,e.done({appMainDiv:p._appMainDiv,pad3DViewer:p.viewer}),S()}));P(p.viewer,e.widgetData),p.annotControllerReady=!0,S()})),require("DS/ENOXInterWdgCom/LinkManager").updateLinkability({appIds:[],open:!0,uses:["ENXContent","ENXContentSync3D","ENXContentSync2D","ENXAuthoring2D","ENXAuthoring3D","ENXLandingPageSync"],implements:["ENXContent","ENXContentSync3D","ENXLandingPageSync"]}),require("DS/PADUtils/PADSettingsMgt").setSetting("activateWidgetLink",!0),require("DS/PADUtils/PADSettingsMgt").setSetting("useNewUXGuidelinesWP",!0),V().then((function(){p._welcomePanel.setViewer(p.viewer),p._welcomePanel.appReady()}))}))};var F=!1;return N.prototype.dispose=function(){if(p.widget.removeEvent("onRefresh",U),p.widget.removeEvent("onSearch",R),p.widget.removeEvent("endEdit",y),E&&E(),p._welcomePanel&&p._welcomePanel.dispose(),p._welcomePanel=null,p.viewer){if(p.viewer.setLoadingDelegations({}),F){var e=require("DS/CAT3DAnnotationController/CAT3DAnnotationController");if(e){var t=e.giveAnnotationController({context:p.viewer});t&&t.saveLastFTAViewOrCaptureDisplayed(!0)}}l&&!F&&l.unreferenceAnnotationModelLoader({context:p.viewer}),c&&c.unreferenceFavoriteContextManager({context:p.viewer})}p.defaultCmdReady=!1,p.annotControllerReady=!1},N.prototype.onWillLeave=function(e){F=!(!e||!e.options||"ENOR3D_AP"!==e.options.id)},N}));