define("DS/3DXMTiles/CopyViscaURLServices",(function(){"use strict";var e="api/v1/rep?",t=function(){};function n(e){for(var t=e.split("&"),n={},i=0;i<t.length;i++){var r=t[i].split("=");"s"===r[0]?n.source=r[1]:"t"===r[0]?n.tenant=r[1]:"id"===r[0]?n.boid=r[1]:"b"===r[0]?n.bucket=r[1]:"f"===r[0]?n.filename=r[1]:"fmt"===r[0]?n.format=r[1]:"e"===r[0]?n.element=Number(r[1]):"v"===r[0]?n.version=r[1]:"ts"===r[0]?n.timestamp=r[1]:"type"===r[0]?n.type=r[1]:"sgn"===r[0]&&(n.signature=r[1])}return n}function i(e){const t="bytes=";if("Range"==e.name&&0==e.value.indexOf(t)){var n=e.value.indexOf("-");if(n>0){const t=6;var i=e.value.substring(t,n),r=e.value.substring(n+1);return Number(r)-Number(i)}}return-1}function r(e){var t=e;if("number"!=typeof t.element)return t;if(t.elements=[t.element],delete t.element,"number"!=typeof t.index)return t;if(t.indices=[t.index],delete t.index,Array.isArray(t.headers)&&1==t.headers.length){var n=i(t.headers[0]);n>=0&&(t.contentSize=n)}return t}return t.prototype.CreateURLsRequestBody=function(e,t){if(void 0!==e&&0!==e.length){for(var n={},i={files:[]},r=0;r<e.length;r++){if(void 0===e[r])return;i.files.push(e[r])}return"object"==typeof t&&"boolean"==typeof t.fallback&&t.fallback&&(i.fallback=!0),n.body=JSON.stringify(i),n}},t.prototype.IsURLFetchCompatible=function(e){return!e.toLowerCase().includes("&type=av")},t.prototype.CreateBatchURLAndBody=function(t,i){if(void 0!==t&&0!==t.length){for(var r={},o={files:[]},s=0;s<t.length;s++){if(void 0===t[s])return;var a=t[s].toLowerCase().search(e);if(-1===a)return;0===s&&(r.url=t[s].substring(0,a)+"api/v1/reps");var d=n(t[s].substring(a+11,t[s].length));o.files.push(d)}return"object"==typeof i&&"boolean"==typeof i.allowPartial&&i.allowPartial&&(o.allowPartial=!0),"object"==typeof i&&"boolean"==typeof i.fallback&&i.fallback&&(o.fallback=!0),"object"==typeof i&&"string"==typeof i.emptyFallback&&i.emptyFallback.length>0&&(o.emptyFallback=emptyFallback),"object"==typeof i&&"boolean"==typeof i.checkVersion&&i.checkVersion&&(o.checkVersion=!0),r.body=JSON.stringify(o),r}},t.prototype.MergeBatchAnswer=function(e,t){if("object"==typeof e&&Array.isArray(e.files)){for(var n="number"==typeof t?t:0,o=[],s=0;s<e.files.length;s++){var a=e.files[s];if("object"==typeof a&&"string"==typeof a.url&&(Array.isArray(o[a.url])||(o[a.url]=[]),a.index=s,o[a.url].push(a),o[a.url][0].source!=a.source||o[a.url][0].boid!=a.boid))return}var d={files:[]};for(var l in o)h(o[l]);return d}function h(e){if(!Array.isArray(e)||0==e.length)return;for(var t=r(e[0]),o=1;o<e.length;o++)if("number"!=typeof t.contentSize||0!=n&&t.contentSize>=n)d.files.push(t),t=r(e[o]);else if(Array.isArray(e[o].headers)&&1==e[o].headers.length){var s=i(e[o].headers[0]);s<0?d.files.push(e[o]):0!=n&&t.contentSize+s>n?(d.files.push(t),t=r(e[o])):(t.contentSize+=s,t.elements.push(e[o].element),t.indices.push(e[o].index),t.headers[0].value+=","+e[o].headers[0].value.substring(6))}else d.files.push(e[o]);d.files.push(t)}},t.prototype.CreateFetchURLAndBody=function(t,i,r){if(void 0!==t&&0!==t.length&&void 0!==i&&i.length===t.length){for(var o={},s={files:[]},a=0;a<t.length;a++){if(void 0===t[a])return;var d=t[a].toLowerCase().search(e);if(-1===d)return;0===a&&(o.url=t[a].substring(0,d)+"api/v1/fetch");var l=n(t[a].substring(d+11,t[a].length));l.correlationID=i[a],s.files.push(l)}return"object"==typeof r&&"number"==typeof r.splitTargetedSize&&r.splitTargetedSize>0&&(s.splitTargetedSize=r.splitTargetedSize),"object"==typeof r&&"boolean"==typeof r.allowPartial&&r.allowPartial&&(s.allowPartial=!0),"object"==typeof r&&"boolean"==typeof r.checkVersion&&r.checkVersion&&(s.checkVersion=!0),o.body=JSON.stringify(s),o}},t})),define("DS/3DXMTiles/OOCQuickOverrideSet",[],(function(){"use strict";function e(e,t){this.referenceId=e,this.overrideCB=t}var t=0,n=function(e){this.oocManager=e,this._overrides=new Map,this._active=!1,this._id="_quick_"+t,t++};return n.prototype.setOverrideCB=function(t,n){n=n||null;var i=this._overrides.get(t);n?i||(i=new e(t,n),this._overrides.set(t,i)):i&&this._overrides.delete(t),this._active&&this.oocManager.setOverrideCB(t,n,this._id)},n.prototype.removeOverrideCB=function(e){this.setOverrideCB(e,null)},n.prototype.hasOverrideCB=function(e){var t=this._overrides.get(e);return!!t&&null!==t.overrideCB},n.prototype.setActive=function(e){var t=this.oocManager,n=this._id;(e=!!e)!==this._active&&(this._active=e,e?(t.registerOverrideSet(n),this._overrides.forEach((function(e,i){t.setOverrideCB(e.referenceId,e.overrideCB,n)}))):t.removeOverrideSet(n))},n})),define("DS/3DXMTiles/DSTilesStylingFilterOperator",[],(function(){"use strict";return class{constructor(){}buildShaderCode(e){throw new Error("missing implementation")}filter(e){throw new Error("missing implementation")}}})),define("DS/3DXMTiles/DSTilesForceLoadTransaction",[],(function(){"use strict";var e=function({tileSet:e,onExploreCB:t,onLoadedCB:n,requestBoundingBox:i}){this.onExploreCB=t,this.onLoadedCB=n,this.tileSet=e,this.nodesToExplore=new Set,this.lockedNodesToExplore=new Set;let r=e.getRootNode();r.lockUnload(),this.lockedNodesToExplore.add(r),this.nodesToExplore.add(e.rootURI),this.toExpand=new Set,this.toDownload=new Set,this.forcedTileNodes=new Set,this.requestBoundingBox=i};function t(e,t,n,i){this.isError=e.isError(),this.uri=e.uri,this.geometricalError=e.geometricalError*i,this.isLeaf=e.isLeaf(),this.content=t?e.exportContent():null,this.contentType=null,e.contentSet&&1===e.contentSet.contents.length&&(this.contentType=e.contentSet.contents[0].type||null),this.hasContent=e.hasContent();var r,o=n?e.getDistanceToBoxCache():null;if(o)for(this.boundingBoxes=[],r=0;r<o.length;r++)this.boundingBoxes.push(o[r].boundingBox);else this.boundingBoxes=null}function n(){this.reset()}return e.prototype.update=function(){var e=[],i=[],r=this.nodesToExplore.size>0;for(this.tileSet.getRootNode().updateWorldMatrix();r;){for(r=!1,this.nodesToExplore.forEach((o=>{var s,a=this.tileSet.getTile(o),d=new n;if(a){if(this.lockedNodesToExplore.has(a)||(this.lockedNodesToExplore.add(a),a.lockUnload()),d.reset(),this.onExploreCB(new t(a,!1,this.requestBoundingBox,this.tileSet.unitScale),d),d._exploreChildren&&a.hasExpand()){for(s=0;s<a.childrenURIs.length;s++)i.push(a.childrenURIs[s]);a.isExpandLoaded()?r=!0:this.toExpand.add(o)}d._forceLoad&&a.hasContent()&&(a.isContentLoaded()?this.forcedTileNodes.add(a):this.toDownload.add(o),a.lockUnload()),e.push(o)}})),o=0;o<e.length;o++)this.nodesToExplore.delete(e[o]);for(e.length=0,o=0;o<i.length;o++)this.nodesToExplore.add(i[o]);i.length=0}var o,s=[];for(this.toExpand.forEach((e=>{if(this.tileSet.canExpand()){var t=this.tileSet.getTile(e);t.isExpandLoading()||this.tileSet.expandTile(t)}else s.push(e)})),this.toExpand.clear(),o=0;o<s.length;o++)this.toExpand.add(s[o]);for(0===this.nodesToExplore.size&&(this.lockedNodesToExplore.forEach((e=>{e.unlockUnload()})),this.lockedNodesToExplore.clear()),s=[],this.toDownload.forEach((e=>{if(this.tileSet.canLoadContent()){var t=this.tileSet.getTile(e);t.isContentLoading()||this.tileSet.loadTileContent(t),this.forcedTileNodes.add(t)}else s.push(e)})),this.toDownload.clear(),o=0;o<s.length;o++)this.toDownload.add(s[o]);var a=!0;return(this.nodesToExplore.size>0||this.toExpand.size>0||this.toDownload.size>0)&&(a=!1),a&&this.forcedTileNodes.forEach((e=>{e.isContentLoaded()||e.isError()||(a=!1)})),a&&this.onLoadingComplete(),a},e.prototype.onLoadingComplete=function(){var e=[];this.forcedTileNodes.forEach((n=>{e.push(new t(n,!0,this.requestBoundingBox,this.tileSet.unitScale))})),this.forcedTileNodes.clear(),setTimeout((()=>{this.onLoadedCB.call(null,e)}),0)},n.prototype.exploreChildren=function(){this._exploreChildren=!0},n.prototype.forceLoad=function(){this._forceLoad=!0},n.prototype.reset=function(){this._exploreChildren=!1,this._forceLoad=!1},e})),define("DS/3DXMTiles/DSTilesExpander",[],(function(){"use strict";var e=function(){};return e.prototype.isReady=function(){return!0},e.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},e.prototype.expand=function(e,t){setTimeout(t.onNodeExpandError.bind(t,e),0)},e})),define("DS/3DXMTiles/OOCTilesManager",[],(function(){"use strict";return class{constructor(e){this._oocManager=e,this._tilesManager=e._ldhNodeManager.tilesManager}getSelectedIds(e){let t=this._tilesManager.selectionManager.managersMap.get(e).selectedIds,n=[];return t&&t.forEach(((e,t)=>{n.push(t)})),n}addIdsToXSO(e,t){let n,i=this._tilesManager.selectionManager,r=this._oocManager._ldhNodeManager.getAllTileSets();for(n=0;n<r.length;n++)i.addSelectedIdsToXSO(e,t,r[n])}removeIdsFromXSO(e,t){this._tilesManager.selectionManager.removeSelectedIdsFromXSO(e,t)}getPathElementsWithSelectionId(e){let t,n=this._oocManager._ldhNodeManager.getAllTileSets(),i=this._tilesManager.selectionManager,r=[];for(t=0;t<n.length;t++){let o,s=n[t],a=s.getPathesLeadingToRoot();for(o=0;o<a.length;o++)i.addSelectedId_internal(e,s,a[o],r,null)}let o=[];for(t=0;t<r.length;t++)o.push(r[t].pathElement);return o}getOOCTilesAttributesFromPathElement(e){return this._tilesManager.getTilesAttributesFromPathElement(e)}}})),define("DS/3DXMTiles/ExtraMemoryBudgetManager",[],(function(){"use strict";class e{constructor(){this.reset()}isEmpty(){return 0===this.memoryGPU}reset(){this.memoryGPU=0}init(e){this.memoryGPU=e.initialExtraBudgetGPU}setFromJSON(e){let t=parseFloat(e.memoryGPU);!isFinite(t)||t<0?this.memoryGPU=0:this.memoryGPU=t}createJSON(){return{memoryGPU:this.memoryGPU}}equals(e){return this.memoryGPU===e.memoryGPU}remove(e){this.memoryGPU-=e.memoryGPU}add(e){this.memoryGPU+=e.memoryGPU}getSubBudget(t){let n=new e,i=t.memoryGPU;return n.memoryGPU=Math.min(i,this.memoryGPU),n}}return class{constructor(t){this.unloadManager=t,this.initialExtraBudgetGPU=5368709120,this.usedExtraBudget=new e,this.sessionExtraBudget=this.getCurrentExtraBudget(),window.addEventListener("beforeUnload",this.releaseExtraBudget.bind(this)),window.addEventListener("unload",this.releaseExtraBudget.bind(this))}getCurrentExtraBudget(){let t=new e;try{let e=window.sessionStorage.getItem("OOCExtraMemoryBudget");if(e){let n=JSON.parse(e);t.setFromJSON(n)}else t.init(this),this.saveSessionExtraBudget(t)}catch(e){}return t}updateSessionExtraBudget(){let e=this.getCurrentExtraBudget();this.sessionExtraBudget.equals(e)||(this.sessionExtraBudget=e)}saveSessionExtraBudget(e){let t=JSON.stringify(e.createJSON());window.sessionStorage.setItem("OOCExtraMemoryBudget",t)}releaseExtraBudget(){this.usedExtraBudget.isEmpty()||(this.sessionExtraBudget.add(this.usedExtraBudget),this.usedExtraBudget=new e,this.saveSessionExtraBudget(this.sessionExtraBudget))}dispose(){this.releaseExtraBudget()}requestExtraBudget(e){this.updateSessionExtraBudget();let t=this.sessionExtraBudget.getSubBudget(e);return t.isEmpty()||(this.usedExtraBudget.add(t),this.sessionExtraBudget.remove(t),this.saveSessionExtraBudget(this.sessionExtraBudget)),this.usedExtraBudget}}})),define("DS/3DXMTiles/PGLinkReference",[],(function(){"use strict";return class{constructor(e){this.pgReferenceId=e,this.pgLinkInstanceMap=new Map}}})),define("DS/3DXMTiles/LDHOcclusionStatus",[],(function(){return{unknown:"unknown",visible:"visible"}})),define("DS/3DXMTiles/PGInstance",[],(function(){"use strict";return class{constructor({parentReference:e,childReference:t,instanceId:n,matrix:i}){this.parentReference=e,this.childReference=t,t.addRef(),this.instanceId=n,this.matrix=i}dispose(e){this.childReference.release(e),e.unregisterPGInstance(this)}}})),define("DS/3DXMTiles/InstancingFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,n){"use strict";var i=function(){};function r(e,t){if(0===t.length)return e;var n=new Float32Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}return i.prototype.buildInstancingBox=function(t){var n=t.matrices.length,i=t.matrices,r=t.boxes,o=t.colors,s=t.attributes||{},a=this.buildBoxMesh(s),d=this.buildMaterial(t);a.setMaterial(d);new e.Box3;return this.setUpMeshInstancingParameters(a,n,i,r,o),a.setExcludeFromBounding(!0),a.setFrustumCulled(!1),a},i.prototype.updateInstancingBox=function(t){var n=t.mesh,i=t.instancingParams.matrices.length,o=t.instancingParams.matrices,s=t.instancingParams.boxes,a=t.instancingParams.colors,d=new e.Box3,l=this.buildInstancingParameters(i,o,s,a,d),h=n.nbInstances+i;n.nbInstances=h,n.drawCount=n.nbInstances;var c=t.mesh.mesh3js;c._instancingInfos.nbInstances=h,c._instancingInfos.drawCount=h;var u,p=c._instancingInfos.instanceAttribArrays,g=new Float32Array(h);for(u=0;u<h;u++)g[u]=5+5*u;p.instanceId.array=g,p.instanceId.isDynamic=!0;var f=p.instanceMatrix;f.array=r(f.array,l[0].data),f.isDynamic=!0;var m=p.instanceColor;m.array=r(m.array,l[1].data),m.isDynamic=!0;var v,S=t.indexesToHide;for(u=0;u<S.length;u+=2)v=3*S[u],m.array[v]=0,m.array[v+1]=0,m.array[v+2]=0;for(S=t.indexesToHideTmp,u=0;u<S.length;u+=2)v=3*S[u],m.array[v]=0,m.array[v+1]=0,m.array[v+2]=0;var y,M,D,T=t.indexesToShow,C=new e.Color;for(u=0;u<T.length;u+=2)v=3*T[u],y=T[u+1],C.setHex(y),m.array[v]=C.r,m.array[v+1]=C.g,m.array[v+2]=C.b;for(M=0;M<n._occurrences.length;M++)(D=n._occurrences[M].renderable)._instancingInfos.instanceAttribArrays.instanceId.isDynamic=!0,D._instancingInfos.instanceAttribArrays.instanceMatrix.isDynamic=!0,D._instancingInfos.instanceAttribArrays.instanceColor.isDynamic=!0},i.prototype.buildBoxMesh=function(n){if(1===n.dimension){var i,r=[new e.Vector3(0,0,0),new e.Vector3(1,0,0),new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,0),new e.Vector3(0,0,1),new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0),new e.Vector3(1,0,1),new e.Vector3(0,1,0),new e.Vector3(0,1,1),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(0,0,1),new e.Vector3(0,1,1),new e.Vector3(0,0,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(0,1,1),new e.Vector3(1,1,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(1,1,0)],o=[];for(i=0;i<r.length;i++)o.push(i);return t.createLineNode({points:r,drawMode:Mesh.ConnectivityTypeEnum.LINES,idx:o})}return t.createCuboidNodeFromBox3(new e.Box3(new e.Vector3(0,0,0),new e.Vector3(1,1,1)))},i.prototype.buildMaterial=function(t){var i=t.material,r=t.attributes;i||(i=1===r.dimension?new e.LineBasicMaterial({force:!0,opacity:r.opacity}):new e.MeshBasicMaterial({force:!0,opacity:r.opacity})),i.activatePDSFX("PDSFXLDHInstancing");i.setPDSFXVaryings({vLDHColor:{type:"v3"}});if(t.useDBuffer){i.defines=i.defines||{},i.defines.LDH_CORRECT_Z_FIGHT=!0;var o={depthBuffer:{type:"t2",value:t.depthBuffer}};i.setPDSFXUniforms(o),i.setPDSFXGlobalShaderCode(null,(function(e){const t=e.variableHandler,i=e.functionHandler,r=e.bridgeFunctions,o=e=>t.float(e),s=e=>t.vec2(e),a=e=>t.vec4(e);return`\n                    \n                ${i.dF("getDepth","f",[i.prmV2("coord")])} {\n                    ${a("rgba_depth")}  = ${r.sample2DTexture((d="depthBuffer",e.getTextureUniform(d)),"coord")};\n                    ${o("depth")}  = ${((e,t,i)=>n.FunctionHandler.callFunction(e,t,i))("unpackRGBA","f",[i.prmV4("rgba_depth")])};\n                    if (depth > 1e-6) {\n                        return depth + DEPTH_PRECISION;\n                    }\n                    return 1.0;\n\n                }\n                ${i.dF("depthSampleTest","f",[i.prmV2("coord"),i.prmF("delta"),i.prmF("depth")])}{\n                    ${s("coordToUse")} = coord;     \n                    ${r.uvConvention("coordToUse")}\n                    ${o("fDepth")}  = ${i.cF("getDepth","f",[i.prmV2("coordToUse")])};\n                    if (fDepth < depth) {\n                        return delta;\n                    }\n                    return 0.0;\n                }\n                ${i.dF("correctZFighting","b",[])} {\n                    ${a("occlusionCLipPosition")}  = ${e.vGetClipSpacePosition()};\n                    ${s("coord")}  = 0.5 + 0.5*occlusionCLipPosition.xy/occlusionCLipPosition.w;\n                    ${o("depth")}  = ${r.setDepthWithConvention("occlusionCLipPosition.z / occlusionCLipPosition.w")};\n    \n                \n                    ${o("test")} = ${i.cF("depthSampleTest","f",[i.prmV2("coord"),i.prmF("1.0/9.0"),i.prmF("depth")])};\n                    if (test > 0.0) {\n                       return true;\n                    }\n                    return false;\n                }\n                `;var d})),i.side=e.DoubleSide}return i.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){const n=e.variableHandler,i=e=>n.vec4(e);return`\n\t\t\t\t    ${i("localPosition")}  = ${i()}(${e.vGetAttribPosition()}, 1.0);\n\t\t\t\t    ${i("newPosition")}  = instanceMatrix*localPosition;\n\t\t\t\t    return newPosition.xyz;\n                `},ComputeVaryingValues:function(e,t){return`\n                    ${n="vLDHColor",e.getVarying(n)} = instanceColor;\n                `;var n}},{ComputeAlbedo:function(e,t){return`\n                    return ${n="vLDHColor",e.getVarying(n)};\n                `;var n},ComputeSpecularReflectance:function(e,t){return`\n                    return ${e.variableHandler.vec3(n)}(1.0, 1.0, 1.0);\n                `;var n},ComputeDiscard:function(e,t){const n=e.functionHandler,i=t=>e.getVarying(t),r=e.userDefines;return`\n                    return (${i("vLDHColor")}.x == 0.0 && ${i("vLDHColor")}.y == 0.0 && ${i("vLDHColor")}.z == 0.0)\n                        ${r.LDH_CORRECT_Z_FIGHT?` || ${n.cF("correctZFighting","b",[])};`:";"}\n                `}}),i},i.prototype.buildInstancingParameters=function(t,n,i,r,o){var s,a,d,l,h,c,u,p=new Float32Array(16*t),g=new Float32Array(3*t),f=(new e.Matrix4,new e.Matrix4),m=new e.Vector3,v=new e.Matrix4,S=(new e.Matrix4,v);for(s=0;s<t;s++){for(d=n[s],c=i[s].clone(),m.set(c.max.x-c.min.x,c.max.y-c.min.y,c.max.z-c.min.z),f.makeTranslation(c.min.x,c.min.y,c.min.z),f.scale(m),v.multiplyMatrices(d,f),l=16*s,h=S.elements,a=0;a<16;a++)p[l+a]=h[a];l=3*s,u=r[s],g[l]=u.r,g[l+1]=u.g,g[l+2]=u.b}return[{data:p,type:"m4",attribName:"instanceMatrix",isFlattened:!0},{data:g,type:"v3",attribName:"instanceColor",isFlattened:!0}]},i.prototype.setUpMeshInstancingParameters=function(e,t,n,i,r,o){var s=this.buildInstancingParameters(t,n,i,r,o);e.setInstancingParameters(t,s)},new i})),define("DS/3DXMTiles/3DXMTilesUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/BufferGPUManager","DS/Visualization/Mesh3D"],(function(e,t,n,i){"use strict";function r(t,n,i,r){this.center=t,this.radius=n,this.scale=i,null!==r?(this.matrixPosition=new e.Vector3,this.matrixPosition.getPositionFromMatrix(r)):this.matrixPosition=null}function o(e){this.boundingBox=e}function s(e){var t=n.mapGeomBufferSize.get(e.id);return t||(t=e.getBuffersMemorySize()),t}r.prototype.isNode3DCache=function(){return null!==this.matrixPosition},r.prototype.positionHasChanged=function(e){var t=e.elements;return t[12]!==this.matrixPosition.x||t[13]!==this.matrixPosition.y||t[14]!==this.matrixPosition.z},r.prototype.containsPoint=function(e){return this.center.distanceTo(e)<=this.radius},r.prototype.distanceToPoint=function(e){return this.center.distanceTo(e)-this.radius};new e.Matrix4,new e.Vector3,new e.Vector3,new e.Matrix4;var a=e.MaterialUtils.createShinyFaceMaterial({color:"red",force:!0}),d=new Set;return{computeScreenRadiusFactor:function(n,i,r,o,s,l,h){var c,u=n.center,p=n.radius;if(!(h||r.performFrustumCullingNoNearFar(p,u)))return-1;if(i.isOrtho)c=1/o;else{var g=i.matrixWorldInverse.elements;c=1/(o*Math.abs(g[2]*u.x+g[6]*u.y+g[10]*u.z+g[14]))}if(s&&!d.has(s)){d.add(s);var f=new e.Matrix4;f.setPosition(u);var m=t.createSphereNode({matrix:f,radius:p*l});m.setNoZ(!0),m.setMaterial(a),m.showKey=s,debugWebGLV6Viewer.getRootNode().addChild(m)}return c},computeScreenRadius:function(e,t,n,i,r,o,s){let a=e.radius,d=this.computeScreenRadiusFactor(e,t,n,i,r,o,s);if(d>=0){return d*a}return-1},computeScreenRadiusCache:function(n,i,o,s,d){var l=n?n.getMaxScaleOnAxis():1,h=o.radius*l,c=new e.Vector3;if(c.copy(o.center),n&&c.applyMatrix4(n),i&&c.applyMatrix4(i),s){var u=new e.Matrix4;u.setPosition(c);var p=t.createSphereNode({matrix:u,radius:h});p.setMaterial(a),debugWebGLV6Viewer.getRootNode().addChild(p)}return new r(c,h,l,d?n:null)},computeScreenRadiusCstComponent:function(e,t){if(e.isOrtho)return e.getCameraConstant(1,t.y);var n=.5*t.y;return n/=Math.tan(.5*e.fov*Math.PI/180),e.fullWidth&&(n*=e.fullWidth/e.width),n=1/n},computeDistanceToBoxCache:function(e,t){var n=t.clone();return n.applyMatrix4(e),new o(n)},computeMeshSize:function(e){var t=new Set,n=new Set,r=0;e.traverse((function(e){if(e instanceof i&&!t.has(e)){var o;t.add(e);var a=e.mesh3js.geometry;for(o=0;o<a.length;o++){var d,l,h,c=a[o];for(r+=s(c),d=0;d<c.drawingGroups.length;d++){var u;if(l=(h=c.drawingGroups[d]).material?h.material._getTextures():null)for(u=0;u<l.length;u++)l[u]&&n.add(l[u])}}}}));var o=0;return n.forEach((e=>{var t=this.computeTextureSize(e);o+=t})),r+=o},computeTextureSize:function(e){let t=0,n=0;if(e.image&&e.image.width&&e.image.height&&(n=e.image.width*e.image.height*4,e.generateMipmaps&&(!e.mipmaps||0===e.mipmaps.length))){t=0;let n=e.image.width>>1,i=e.image.height>>1;for(;n>0&&i>0;)t+=n*i*4,n>>=1,i>>=1}if(e.mipmaps){let n,i;for(t=0,n=0;n<e.mipmaps.length;n++)i=e.mipmaps[n],t+=i.data?i.data.byteLength:0}return n+t}}})),define("DS/3DXMTiles/DSTilesChildLoader",[],(function(){"use strict";return function(){}})),define("DS/3DXMTiles/SSBData",[],(function(){"use strict";return class{constructor(){this.currentRadius=-1,this.radiusArray=null}setFromCullingData(e){this.radiusArray=e.cullingData&&e.cullingData.tab||null}setRadius(e){this.currentRadius=e}needsRefresh(e,t){if(!this.radiusArray||!t&&e>=this.currentRadius)return!1;{let n=this.findRadius(this.currentRadius,0,this.radiusArray.length-1);if(t){return this.findRadius(e,0,n)!==n}if(n>=this.radiusArray.length-1)return!1;return this.findRadius(e,0,n)>n}}findRadius(e,t,n){if(this.radiusArray){if(this.radiusArray[t]<=e)return t;if(this.radiusArray[n]>e)return n+1;let i,r=t,o=n;for(;r+1<o;)i=Math.floor((r+o)/2),this.radiusArray[i]<=e?o=i:r=i;return o}return-1}}})),define("DS/3DXMTiles/LODSelector",["DS/Visualization/ThreeJS_DS","UWA/Class"],(function(e,t){"use strict";return t.extend({init:function(){this.type=null,this.disableDowngrade=!1},setDisableDowngrade:function(e){this.disableDowngrade=!!e},getMaxLOD:function(){return 1},createJSON:function(e){return(e=e||{}).type=this.type,this.disableDowngrade&&(e.disableDowngrade=!0),e}})})),define("DS/3DXMTiles/ParsingStatus",[],(function(){"use strict";class e{constructor(e){this._error=!!e,this._message=null,this._subErrors=null}copy(e){this._error=e._error,this._message=e._message,this._subErrors=e._subErrors}isOk(){return!this._error}setOk(){this._error=!1}setError(e,t,n){let i=(t?t+": ":"")+(e||"");this._error=!0,this._message=i||null,this._subErrors=n||null}}return e.isStylingAttributeName=function(e){return"string"==typeof e||e instanceof String},e.isNumberOrString=function(e){return"string"==typeof e||e instanceof String||null!==e&&isFinite(e)},e.isNumber=function(e){return null!==e&&isFinite(e)},e.error=function(t,n,i){let r=new e(!0);return r.setError(t,n,i),r},e.ok=new e(!1),e})),define("DS/3DXMTiles/OOCIdPathWatcher",["DS/Visualization/IdPath","DS/Visualization/IdPathWatcher"],(function(e,t){"use strict";return class{constructor({oocManager:e,onIdPathUserActiveCB:n,onIdPathUserInactiveCB:i}){let r=e._ldhNodeManager.viewer;this.idPathWatcher=new t({onIdPathActiveCB:n,onIdPathInactiveCB:i,idPathMatcher:r.idPathMatcher||null,viewer:r,listenToSceneGraphOnly:!0})}addIdPathUser(e,t){this.idPathWatcher.addIdPath(t,e)}removeIdPathUser(e){this.idPathWatcher.removeIdObject(e)}dispose(){this.idPathWatcher.dispose(),this.idPathWatcher=null}}})),define("DS/3DXMTiles/OOCPath",[],(function(){"use strict";var e=function(e,t){this.ids=[].concat(e),this._ldhReference=t};return e.prototype.isLeaf=function(e){var t=this.getLastId();return e.isLeaf(t)},e.prototype.isRoot=function(){return this.ids.length<=1},e.prototype.getLastId=function(){return this.ids[this.ids.length-1]},e.prototype.expandReference=function(e){var t=e.getInstRefJSON(this.getLastId());t.representation&&(this.ids.push(t.instanceId),this.ids.push(t.representation))},e.prototype.getLastInstanceId=function(){return this.ids.length>=3?this.ids[this.ids.length-2]:null},e.prototype.getParentReferenceId=function(){return this.ids.length>=3?this.ids[this.ids.length-3]:null},e.prototype.isCGR=function(){return-1!==this.ids[this.ids.length-1].indexOf(".cgr")},e.prototype.buildSubPath=function(t,n){var i=new e(this.ids,null);return i.ids.push(t),i.ids.push(n),i},e.buildFromReference=function(t,n,i,r){var o,s=null,a=-1;for(o=0;o<t._occurrences.length;o++){var d=t._occurrences[o];(i||d.viewpointTag!==r.viewpointTag&&(d._screenRadius>a||null===s))&&(a=d._screenRadius,s=d)}if(!s)return null;var l=[t.referenceId];n&&(s.viewpointTag=r.viewpointTag);var h=new e(l,t);return t.children.length>0&&(h.approximate=!0),h},e})),define("DS/3DXMTiles/VDRPInstanceOverride",["UWA/Class","DS/SceneGraphOverrides/OverrideSet2","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/OverrideLink2","DS/Visualization/JSONSettings"],(function(e,t,n,r,o,s){"use strict";function a(e,t,n){let i;for(i=0;i<e._overrideArray.length;i++){let r=e._overrideArray[i];r[t].apply(r,n)}}function d(e,t,n){let i,r=null;for(i=0;i<e._overrideArray.length;i++){let o=e._overrideArray[i],s=o[t].apply(o,n);s&&(r||(r=[]),r=r.concat(s))}return r}function l(e,t,n){let r=e._overrideArray[i];return r[t].apply(r,n)}return class{constructor({overrideArray:e,vdrpOverrideSet:t}){this._overrideArray=e,this._vdrpOverrideSet=t}setColor(e,t){a(this,"setColor",arguments)}setColorAttribute({value:e,inheritance:t}){a(this,"setColorAttribute",arguments)}setPGPNoColor(){a(this,"setPGPNoColor",arguments)}resetColor(){a(this,"resetColor",arguments)}setMaterial(e,t){a(this,"setMaterial",arguments)}setMaterialAttribute({value:e,inheritance:t}){a(this,"setMaterialAttribute",arguments)}resetMaterial(){a(this,"resetMaterial",arguments)}setOpacity(e,t){a(this,"setOpacity",arguments)}setOpacityAttribute({value:e,inheritance:t,keepOcclusion:n}){a(this,"setOpacityAttribute",arguments)}setPGPNoOpacity(){a(this,"setPGPNoOpacity",arguments)}resetOpacity(){a(this,"resetOpacity",arguments)}setPGPInheritance(e){a(this,"setPGPInheritance",arguments)}setPickability(e,t){a(this,"setPickability",arguments)}setPosition(e){a(this,"setPosition",arguments)}setVisibility(e){a(this,"setVisibility",arguments)}setVisibilityFree(e){a(this,"setVisibilityFree",arguments)}setClippingContext(e){a(this,"setClippingContext",arguments)}setRenderMode(e){a(this,"setRenderMode",arguments)}setRenderStyle(e,t){a(this,"setRenderStyle",arguments)}setRenderStyleAttribute({value:e,inheritance:t}){a(this,"setRenderStyleAttribute",arguments)}getPosition(){return l(this,"getPosition",arguments)}getVisibility(){return l(this,"getVisibility",arguments)}getVisibilityFree(){return l(this,"getVisibilityFree",arguments)}getColor(){return l(this,"getColor",arguments)}getMaterial(){return l(this,"getMaterial",arguments)}getOpacity(){return l(this,"getOpacity",arguments)}getPGPInheritance(){return l(this,"getPGPInheritance",arguments)}getPickability(){return l(this,"getPickability",arguments)}getPickingPriorityID(){return l(this,"getPickingPriorityID",arguments)}getRenderMode(){return l(this,"getRenderMode",arguments)}getRenderStyle(){return l(this,"getRenderStyle",arguments)}getClippingContext(){return l(this,"getClippingContext",arguments)}hasBoundingElementInfluence(){return l(this,"hasBoundingElementInfluence",arguments)}hasPositionOverride(){return l(this,"hasPositionOverride",arguments)}getPathes(){return d(this,"getPathes",arguments)}getIdPathes(){return d(this,"getIdPathes",arguments)}getVDRPIdPathes(){return d(this,"getVDRPIdPathes",arguments)}isTargetingNode(e){return function(e,t,n){let i;for(i=0;i<e._overrideArray.length;i++){let r=e._overrideArray[i];if(r[t].apply(r,n))return!0}return!1}(this,"isTargetingNode",arguments)}enable(e){a(this,"enable",arguments)}isEnabled(){return l(this,"isEnabled",arguments)}getSceneGraphOverrideSet(){return this._vdrpOverrideSet}isIdPathOverride(e){return l(this,"isIdPathOverride",arguments)}isNodeIdOverride(){return l(this,"isNodeIdOverride",arguments)}getValues(){return l(this,"getValues",arguments)}}})),define("DS/3DXMTiles/AsyncCaller",(function(){var e=null,t=[];function n(){var e,n;if(t.length>0){for(e=0;e<t.length;e++)(n=t[e])&&n.call(null);t.length=0}}return{call:function(i){t.push(i),null===e&&(e=setInterval(n,33))},multiCall:function(i){i&&(t=t.concat(i),null===e&&(e=setInterval(n,33)))}}})),define("DS/3DXMTiles/LDHOccurrence",["DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/IdPath","DS/SceneGraphOverrides/OverrideUtils","DS/Visualization/Node3D"],(function(e,t,n,i,r){"use strict";var o=new e.Matrix4,s=function(e,t){this.flags=1;var n=e.reference;this.reference=n||null,n._occurrences.length>0&&e.manager.forceUpdateNode(n),n._occurrences.push(this),this.node=e.node||null,this.parent=e.parent||null,this.depth=this.parent?this.parent.depth+2:0,this.instanceData=e.instanceData||null,this.children=[],this.instanceOverrideData=null,this.referenceOverrideData=null,this.occurrenceNode=null,this.viewpointTag=-1,this.updateMatrix(e.manager);for(var i=0;i<n.children.length;++i){var r=n.children[i],o=new s({reference:r.reference,boundingSphere:r.reference.boundingSphere,node:null,manager:e.manager,parent:this,instanceData:r},t);this.children.push(o)}this.reference.requestBuildSceneGraphHierarchy(),this.reference.updateMemorySizeNEW(e.manager),this.reference._optional&&this.reference._optional.hasOverride()&&t&&t.add(this.reference),this.requestUpdate()};s.prototype.addChild=function(e,t){this.instanceOverrideData&&this.instanceOverrideData.originalOverrideSet&&this.instanceOverrideData.originalOverrideSet.onAddCandidateChild(t),this.referenceOverrideData&&this.referenceOverrideData.originalOverrideSet&&this.referenceOverrideData.originalOverrideSet.onAddCandidateChild(t),this.children.push(e)},s.prototype.removeChild=function(e){let t=this.children.indexOf(e);t>=0&&this.children.splice(t,1)},s.prototype.updateMatrix=function(t){var n=this.parent?this.parent.matrix:null,i=this.getLocalMatrix(t);null===i?this.matrix=n||o:(this.matrix=new e.Matrix4,n?this.matrix.multiplyMatrices(n,i):this.matrix.copy(i))},s.getOccurrenceMatrix=function(t,n){return null===n?t:(new e.Matrix4).multiplyMatrices(t,n)},s.prototype.getChildren=function(){return this.children.concat([])},s.prototype.getIdPath=function(e){if(this.parent){var t=this.parent.getIdPath(!1);return t.push(this.instanceData.instanceId),!e&&t.push(this.reference.referenceId),t}return[this.reference.referenceId]},s.prototype.removeFromSceneGraph=function(){this.node&&this.reference.node&&this.reference.node.removeChild(this.node)},s.prototype.detach=function(e){e&&e.add(this.reference),this.reference._removeOccurrenceFromList(this);var t,n=this.getChildren();for(t=0;t<n.length;t++)n[t].detach(e);this.parent&&this.parent.removeChild(this),this.parent=null},s.prototype.buildPathElement=function(){if(this.reference.node){for(var e,n=[],i=this;i;){if(n.unshift(i.reference.node),e=null,i.parent){if(!(e=i.parent.reference.getChildInstanceNode(i.instanceData.instanceId)))return null;n.unshift(e)}i=i.parent}return new t(n)}return null},s.prototype.getBoundingSphere=function(){var e=this.reference.getBoundingSphere(),t=null;return e&&(t=e.clone()).applyMatrix4(this.matrix),t};var a=new e.Matrix4;s.prototype.getLocalMatrix=function(e){e.oocManager._findPositionOverride(this);var t=e.viewer.getSceneGraphOverrideSetManager(),n=e.viewer.getIdPathMatcher(),i=this.reference.referenceId,r=this.instanceData&&this.instanceData.instanceId,o=t._hasIdPathOverride(i),s=this.instanceData&&t._hasIdPathOverride(r),d=null,l=null,h=null,c=null,u=e.oocManager;if(o||(o=!!(d=u._findPositionOverride(this,!1))),s||(s=!!(l=u._findPositionOverride(this,!0))),o||s){var p=this.buildIdPath(n,e);return o&&!d&&(d=t._getIdPathPositionOverride(p)),s&&!l&&(p.removeLastId(),l=t._getIdPathPositionOverride(p)),d&&(h=d.getPosition())&&h.isIdentity()&&(h=null),l&&(c=l.getPosition()),c?c.isIdentity()&&(c=null):c=this.instanceData&&this.instanceData.matrix,h&&c?(a.multiplyMatrices(c,h),a):h||(c||null)}return this.instanceData?this.instanceData.matrix:null},s.prototype.buildIdPath=function(e,t){for(var i=this,r=this.getIdPath();i.parent;)i=i.parent;var o=t.targetNode;return r.unshift(e.nodeToId(o)),new n(r)},s.prototype.updateChildrenOccurrenceNode=function(){let e,t=this.getChildren();if(this.occurrenceNode){let n=this.occurrenceNode.children,i=null;if(this._getChildNeedsOccurrenceNodeUpdate()){for(i=new Map,e=0;e<n.length;e++){let t=n[e].node,r=t&&t.getModelIdentification();i.set(r,n[e])}for(e=0;e<t.length;e++){let n=t[e],r=i.get(n.instanceData.instanceId);n.setOccurrenceNode(r&&r.children[0]||null)}}}for(e=0;e<t.length;e++){let n=t[e];(n._getDescendantNeedsOccurrenceNodeUpdate()||n._getChildNeedsOccurrenceNodeUpdate())&&n.updateChildrenOccurrenceNode()}this._setChildNeedsOccurrenceNodeUpdate(!1),this._setDescendantNeedsOccurrenceNodeUpdate(!1)},s.prototype.setOccurrenceNode=function(e){let t=null;this.occurrenceNode||!this.instanceOverrideData&&!this.referenceOverrideData||this.requestOverridesUpdate(),this.occurrenceNode=e,e&&(e.ldhOccurrence!==this&&(e.ldhOccurrence=this,t=e),this.parent&&e.parent&&e.parent.ldhOccurrence!==this&&(e.parent.ldhOccurrence=this,t=e.parent),this._setVisible(e._getVisible())),t&&t.parent.node._updateOccurrences(t.parent,t,r.UpdateMatrixMode.Always,void 0,r.InvalidateGSSOMode.Always)},s.prototype.resetOccurrenceNode=function(){if(this.occurrenceNode){let e;for(e=0;e<this.children.length;e++)this.children[e].resetOccurrenceNode();this.occurrenceNode.ldhOccurrence=null,this.occurrenceNode=null}},s.prototype.removeChildWithInstanceId=function(e){let t,n=this.children,i=0;for(t=0;t<n.length;t++){let r=n[t];r.instanceData.instanceId!==e?(n[i]=r,i++):n[i]=null}n.length=i},s.prototype.getChild=function(e){let t,n=this.children;for(t=0;t<n.length;t++){let i=n[t];if(i.instanceData.instanceId===e)return i}return null},s.prototype.getOverrideData=function(e){return this.reference.referenceId===e?this.getReferenceOverrideData():this.instanceData.instanceId===e?this.getInstanceOverrideData():null},s.prototype.requestOverridesUpdate=function(){for(var e=this.parent,t=e&&e.occurrenceNode?e.occurrenceNode.parent:null;e&&!e._getDescendantNeedsOverridesUpdate();)e._setDescendantNeedsOverridesUpdate(!0),t=e.occurrenceNode?e.occurrenceNode.parent:null,e=e.parent;for(;!e&&t;)t._setDescendantNeedsOverridesUpdate(!0),t=t.parent;this._setNeedOverridesUpdate(!0)},s.prototype.requestUpdate=function(){for(var e=this.parent;e&&!e._getDescendantNeedsUpdate();)e._setDescendantNeedsUpdate(!0),e=e.parent;this._setNeedsUpdate(!0)},s.prototype.traverseWithCondition=function(e,t){var n,i,r=this.children.length;if(i=e(this,t))for(n=0;n<r;n++)this.children[n].traverseWithCondition(e,i)},s.prototype.dualTraverse=function(e,t){var n,i=this.children.length;e(this);let r=new Set,o=this.occurrenceNode;for(n=0;n<i;n++){let i=this.children[n];o&&i.occurrenceNode&&r.add(i.occurrenceNode),this.children[n].dualTraverse(e,t)}if(o&&o.parent&&o.parent.children.length>1){let e=o.parent.children;for(n=0;n<e.length;n++){let i=e[n];i.ldhOccurrence||t(i)}}if(o&&o.children.length!==r.size){let e=o.children.length;for(n=0;n<e;n++){let e=o.children[n];r.has(e)||e.traverse(t)}}},s.prototype.getOverrideLinkFromOccurrenceNode=function(e){let t=null;return e==this.occurrenceNode?t=this.referenceOverrideData:e.node===this.instanceData.node&&(t=this.instanceOverrideData),t&&t.overrideLink},s.prototype.getOriginalOverrideSetFromOccurrenceNode=function(e){let t=null;return e==this.occurrenceNode?t=this.referenceOverrideData:e.node===this.instanceData.node&&(t=this.instanceOverrideData),t&&t.originalOverrideSet},s.prototype.getOverrideDataFromOccurrenceNode=function(e){let t=null;return e==this.occurrenceNode?t=this.getReferenceOverrideData():e.node===this.instanceData.node&&(t=this.getInstanceOverrideData()),t},s.prototype.clearOverridesUpdateRequest=function(){this.traverseWithCondition((function(e){var t=!!e._getDescendantNeedsOverridesUpdate()||null;return e._setNeedOverridesUpdate(!1),e._setDescendantNeedsOverridesUpdate(!1),t}))},s.prototype.updateOverrideStatus=function(e){e?this.dualTraverse((function(e){if(e.parent){let t=e.parent.getReferenceOverrideData(),n=e.getInstanceOverrideData(),r=i.fillOverrideLink(n.overrideLink,n.originalOverrideSet,t&&t.overrideLink,t&&t.originalOverrideSet);n.overrideLink=r}else if(e.occurrenceNode){let t=e.occurrenceNode.parent,n=t.overrideLink,r=t.originalOverrideSet,o=e.getReferenceOverrideData(),s=i.fillOverrideLink(o.overrideLink,o.originalOverrideSet,n,r);o.overrideLink=s}if(e.parent){let t=e.getInstanceOverrideData(),n=e.getReferenceOverrideData(),r=i.fillOverrideLink(n.overrideLink,n.originalOverrideSet,t&&t.overrideLink,t&&t.originalOverrideSet);n.overrideLink=r}return!0}),(function(e){if(!e.ldhOccurrence){let t=e.parent,n=null,r=t&&t.originalOverrideSet;t&&(t.ldhOccurrence?(n=t.ldhOccurrence.getOverrideLinkFromOccurrenceNode(t),r=t.ldhOccurrence.getOriginalOverrideSetFromOccurrenceNode(t)):(n=t&&t.overrideLink,r=t&&t.originalOverrideSet));let o=i.fillOverrideLink(e.overrideLink,e.originalOverrideSet,n,r);e.overrideLink=o}})):this.traverseWithCondition((function(e){return e.instanceOverrideData&&e.instanceOverrideData.overrideLink&&e.instanceOverrideData.overrideLink.reset(),e.referenceOverrideData&&e.referenceOverrideData.overrideLink&&e.referenceOverrideData.overrideLink.reset(),!0}));let t=this.occurrenceNode,n=t&&t.node;if(t&&t.parent)t.parent.parent?t.parent.parent.node._updateOccurrences(t.parent.parent,t.parent,r.UpdateMatrixMode.Never,void 0,r.InvalidateGSSOMode.Never):t.parent.node._updateOccurrences(t.parent,t,r.UpdateMatrixMode.Never,void 0,r.InvalidateGSSOMode.Never);else if(n){var o=t.children,s=0;for(s=0;s<o.length;s++)n._updateOccurrences(this,o[s],e?r.UpdateMatrixMode.Never:r.UpdateMatrixMode.Always,void 0,r.InvalidateGSSOMode.Never)}this.requestUpdate()},s.prototype.getInstanceOverrideData=function(){return this.parent?(this.instanceOverrideData||(this.instanceOverrideData=new c(this)),this.instanceOverrideData):null},s.prototype.getReferenceOverrideData=function(){return this.referenceOverrideData||(this.referenceOverrideData=new c(this)),this.referenceOverrideData},s.prototype.setDepthFromParentNode=function(e){this.depth=e._occurrences[0].depth+1},s.prototype.getParentDepthFromId=function(e,t){if(t){let n=t._getLDHReference(e,!0);if(n&&1===n._occurrences.length)return n._occurrences[0].depth;if(n=t._getInstance(e),n&&1===n._occurrences.length)return n._occurrences[0].depth+1;let i=t.getExternalNode(e);if(i&&1===i._occurrences.length)return i._occurrences[0].depth}let n=this,i=this.occurrenceNode;for(;n;){if(n.reference.referenceId===e)return n.depth;if(n.instanceData.instanceId===e)return n.depth-1;n=n.parent,i=i&&i.parent}for(;i;){if(i.node.getModelIdentification()===e||i.node.name===e)return i.depth;i=i.parent}return 0},s.prototype.updateLDHOccurrence=function(){let e,t,n,i=this.parent&&this.parent._getDisableOcclusionClipping()||this.instanceOverrideData&&this.instanceOverrideData.hasUnCut()||this.referenceOverrideData&&this.referenceOverrideData.hasUnCut();if(this._setDisableOcclusionClipping(i),this._setNeedsUpdate(!1),this._setDescendantNeedsUpdate(!1),this.occurrenceNode)e=this.occurrenceNode._getVisible(),t=this.occurrenceNode._getVisibilityFree();else{let n=this.instanceData&&this.instanceData.node,i=this.reference.getNode(),r=!this.parent||this.parent._getVisible(),o=this.computeSubVisibility(r,n,this.instanceOverrideData);e=this.computeSubVisibility(o,i,this.referenceOverrideData);let s=!!this.parent&&this.parent._getVisibilityFree(),a=this.computeSubVisibilityFree(s,n,this.instanceOverrideData);t=this.computeSubVisibilityFree(a,i,this.referenceOverrideData)}for(this._setVisible(e),this._setVisibilityFree(t),n=0;n<this.children.length;n++)this.children[n].updateLDHOccurrence()},s.prototype.computeSubVisibility=function(e,t,n){let i=!t||t.isVisible(),r=n&&n.overrideLink,o=r&&r.getVisibility();return!!(r&&r.getForceShowVisibility()&&o&&o.visibility)||e&&(o?o.visibility:i)},s.prototype.computeSubVisibilityFree=function(e,t,n){let i=!!t&&t._getVisibilityFree(),r=n&&n.overrideLink,o=r&&r.getVisibilityFree();return!(r&&r.getForceShowVisibilityFree()&&o&&!o.visibilityFree)&&(e||(o?o.visibilityFree:i))},s.prototype.requestOccurrenceNodeUpdate=function(){if(this.parent&&this.parent._setChildNeedsOccurrenceNodeUpdate(!0),this.traverseWithCondition((e=>(e._setChildNeedsOccurrenceNodeUpdate(!0),e._setDescendantNeedsOccurrenceNodeUpdate(!0),!0))),this.parent){let e=this.parent.parent;for(;e&&!e._getDescendantNeedsOccurrenceNodeUpdate();)e._setDescendantNeedsOccurrenceNodeUpdate(!0),e=e.parent}};var d={visible:1,needOverridesUpdate:4,descendantNeedsOverridesUpdate:8,visibilityFree:16,childNeedsOccurrenceNodeUpdate:32,descendantNeedsOccurrenceNodeUpdate:64,disableOcclusionClipping:128,needsUpdate:256,descendantNeedsUpdate:512};function l(e){return function(){return(this.flags&e)>0}}function h(e){return function(t){this.flags=t?this.flags|e:this.flags&~e}}s.prototype._getNeedOverridesUpdate=l(d.needOverridesUpdate),s.prototype._setNeedOverridesUpdate=h(d.needOverridesUpdate),s.prototype._getDescendantNeedsOverridesUpdate=l(d.descendantNeedsOverridesUpdate),s.prototype._setDescendantNeedsOverridesUpdate=h(d.descendantNeedsOverridesUpdate),s.prototype._getVisible=l(d.visible),s.prototype._setVisible=h(d.visible),s.prototype._getVisibilityFree=l(d.visibilityFree),s.prototype._setVisibilityFree=h(d.visibilityFree),s.prototype._getChildNeedsOccurrenceNodeUpdate=l(d.childNeedsOccurrenceNodeUpdate),s.prototype._setChildNeedsOccurrenceNodeUpdate=h(d.childNeedsOccurrenceNodeUpdate),s.prototype._getDescendantNeedsOccurrenceNodeUpdate=l(d.descendantNeedsOccurrenceNodeUpdate),s.prototype._setDescendantNeedsOccurrenceNodeUpdate=h(d.descendantNeedsOccurrenceNodeUpdate),s.prototype._getDisableOcclusionClipping=l(d.disableOcclusionClipping),s.prototype._setDisableOcclusionClipping=h(d.disableOcclusionClipping),s.prototype._getNeedsUpdate=l(d.needsUpdate),s.prototype._setNeedsUpdate=h(d.needsUpdate),s.prototype._getDescendantNeedsUpdate=l(d.descendantNeedsUpdate),s.prototype._setDescendantNeedsUpdate=h(d.descendantNeedsUpdate),Object.defineProperty(s.prototype,"dbgFlags",{get:function(){let e,t="";for(e in d)this.flags&d[e]&&(t?t+=" "+e:t=e);return t},set:function(e){throw new Error("forbidden")}});class c{constructor(e){this.ldhOccurrence=e,this.occurrenceRenderingOverride=null,this.originalOverrideSet=null,this.overrideLink=null}stealFrom(e){e.__overrideData.occurrenceRenderingOverride&&(this.occurrenceRenderingOverride=e.__overrideData.occurrenceRenderingOverride,e.__overrideData.occurrenceRenderingOverride=null),e.__overrideData.originalOverrideSet&&(this.originalOverrideSet=e.__overrideData.originalOverrideSet,e.__overrideData.originalOverrideSet=null),e.__overrideData.overrideLink&&(this.occurrenceRenderingOverride=e.__overrideData.overrideLink,e.__overrideData.overrideLink=null)}isInstanceOverrideData(){return this.ldhOccurrence.instanceOverrideData===this}getDepth(){let e=this.ldhOccurrence;return this.isInstanceOverrideData()?e.depth-1:e.depth}hasUnCut(){let e=this.originalOverrideSet&&this.originalOverrideSet.clipping,t=e&&e.getClippingContext();return!(!t||!t._internal_hasUncut())}}return s})),define("DS/3DXMTiles/LDHReferenceUnloadStatus",[],(function(){return{frozen:"frozen",unloadable:"unloadable",unloaded:"unloaded"}})),define("DS/3DXMTiles/UpdateNodeContentData",[],(function(){"use strict";return class{constructor(e,t,n,i){this.node=e,this.content=t,this.updateVersion=n,this.onUpdatedCB=i}isStillValid(){return this.updateVersion===this.content.updatedContentVersion}}})),define("DS/3DXMTiles/MemoryBudgetManager",[],(function(){"use strict";var e=function(e){this.budgets=new Map,this.alwaysUnload=!!window.OOCUnloadAlways,this.physicalLimits={cpu:e.initialMemoryLimit,gpu:e.memoryLimitGPU}};function t(e){this.name=e.name,this.memoryBudgetManager=e.memoryBudgetManager,this.physicalBudget=e.physicalBudget,this.currentLimit=0,this.theoreticalLimit=0,this.usage=0,this.active=!1,this.unloadFactor=e.unloadFactor||1,this.maxLimit=e.maxLimit||1/0,this.limitTarget=0,this.weight=e.weight||1,this.unloading=!1}return e.prototype.createBudget=function({name:e,physicalBudget:n,params:i}){var r=new t({name:e,memoryBudgetManager:this,physicalBudget:n,maxLimit:(i=i||{}).maxLimit,weight:i.weight,unloadFactor:i.unloadFactor});return this.budgets.set(e,r),r},e.prototype.getBudget=function(e){return this.budgets.get(e)||null},e.prototype.updateLimits=function(){var e={cpu:0,gpu:0},t={cpu:0,gpu:0};this.budgets.forEach(((n,i)=>{if(n.active){var r=n.physicalBudget;e[r]+=n.weight,t[r]+=n.usage}}));var n={cpu:this.physicalLimits.cpu-t.cpu,gpu:this.physicalLimits.gpu-t.gpu},i=!1,r={cpu:0,gpu:0};this.budgets.forEach(((t,o)=>{if(t.active){var s=t.physicalBudget;t.theoreticalLimit=t.weight*t.memoryBudgetManager.physicalLimits[s]/e[s],t.currentLimit=n[s]<=0?t.theoreticalLimit:t.usage+t.weight*n[s]/e[s],t.currentLimit>t.maxLimit&&(i=!0,r[s]+=t.currentLimit-t.maxLimit,t.currentLimit=t.maxLimit)}else t.theoreticalLimit=0,t.currentLimit=0}));for(var o={cpu:0,gpu:0};i;)e.cpu=0,e.gpu=0,o.cpu=r.cpu,o.gpu=r.gpu,r.cpu=0,r.gpu=0,i=!1,this.budgets.forEach(((t,n)=>{if(t.active&&t.currentLimit!==t.maxLimit){var i=t.physicalBudget;e[i]+=t.weight}})),this.budgets.forEach(((t,n)=>{if(t.active&&t.currentLimit!==t.maxLimit){var s=t.physicalBudget;t.currentLimit+=o[s]*t.weight/e[s],t.currentLimit>t.maxLimit&&(i=!0,r[s]+=t.currentLimit-t.maxLimit,t.currentLimit=t.maxLimit)}}))},e.prototype.startUnload=function(){var e=!1,t=!1;this.budgets.forEach(((e,n)=>{e.usage>=this.currentLimit&&(t=!0)})),t&&this.updateLimits();var n={cpu:!1,gpu:!1};return this.budgets.forEach(((t,i)=>{t.active&&(t.isUnloadNeeded()||this.alwaysUnload)&&(e=!0,n[t.physicalBudget]=!0)})),this.budgets.forEach(((e,t)=>{e.unloading=n[e.physicalBudget]})),e},e.prototype.endUnload=function(){this.budgets.forEach(((e,t)=>{e.unloading=!1}))},e.prototype.isLoadingAllowed=function(){var e=!0;return this.budgets.forEach(((t,n)=>{t.isLoadingAllowed()||(e=!1)})),e},e.prototype.getMemoryUsageGPU=function(){var e=0;return this.budgets.forEach(((t,n)=>{"gpu"===t.physicalBudget&&(e+=t.usage)})),e},t.prototype.updateUsage=function(e,t){this.active=!0,this.usage+=t-e},t.prototype.updateUsageDelta=function(e){this.active=!0,this.usage+=e},t.prototype.isLoadingAllowed=function(){return this.usage<=this.currentLimit||(this.active=!0,this.memoryBudgetManager.updateLimits(),this.usage<this.currentLimit)},t.prototype.isUnloadNeeded=function(){return 1!=this.unloadFactor&&this.usage>=this.unloadFactor*this.memoryBudgetManager.physicalLimits[this.physicalBudget]||!this.isLoadingAllowed()},e})),define("DS/3DXMTiles/DSTilesNodeReplaceStatus",[],(function(){"use strict";return{onHold:"onHold",commited:"commited",uncommited:"uncommited",reloadParent:"reloadParent"}})),define("DS/3DXMTiles/DSTilesScoreComputer",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t=function(){this.tmpBoundingBox=new e.Box3};return t.prototype.getSortingMetric=function(){throw new Error("unimplemented")},t})),define("DS/3DXMTiles/DSTilesRootEntry",[],(function(){"use strict";return function(e){this.node=e.node}})),define("DS/3DXMTiles/PriorityQueue",[],(function(){"use strict";var e=function(){this.reset()};e.prototype.reset=function(){this.tileNode=null,this.parent=null,this.less=null,this.more=null},e.prototype.check=function(){var e=[];!function t(n){e.indexOf(n)>-1?console.log("argl"):(e.push(n),n.less&&t(n.less),n.more&&t(n.more))}(this)},e.prototype.checkMinMax=function(e,t){var n=!0;return this.tileNode&&(this.tileNode.getScore()<e||this.tileNode.getScore()>t)&&(console.log("ERRRRRRRRRRREUUUUUUR"),n=!1),this.less&&!this.less.checkMinMax(e,t)&&(n=!1),this.more&&!this.more.checkMinMax(e,t)&&(n=!1),n},e.prototype.removeMin=function(e){var t=this.less;null!==t&&(null===t.less?(this.less=t.more,null!==this.less&&(this.less.parent=this),e.releaseHeapNode(t)):t.removeMin(e))},e.prototype.removeMax=function(e){var t=this.more;null!==t&&(null===t.more?(this.more=t.less,null!==this.more&&(this.more.parent=this),e.releaseHeapNode(t)):t.removeMax(e))},e.prototype.insert=function(e){e.tileNode.getScore()<this.tileNode.getScore()?null!==this.less?this.less.insert(e):(this.less=e,e.parent=this):null!==this.more?this.more.insert(e):(this.more=e,e.parent=this)},e.prototype.getMin=function(){return null===this.less?this:this.less.getMin()},e.prototype.getMax=function(){return null===this.more?this:this.more.getMax()},e.prototype.getTileNodes=function(e){null!==this.tileNode&&e.push(this.tileNode),this.more&&this.more.getTileNodes(e),this.less&&this.less.getTileNodes(e)};var t=function(e){this.size=0,this.sizeLimit=e,this.root=null,this.firstFreeHeapNode=null,this.minHeapValue=-1/0,this.maxHeapValue=1/0};t.prototype.getTileNodes=function(){var e=[];return null!==this.root&&this.root.getTileNodes(e),e},t.prototype.tryToInsertTileNodeMax=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.minHeapValue<e.getScore()){this.insert(e),t.min=null;var i=this.root.getMin();return this.minHeapValue=i.tileNode.getScore(),!0}return!1}if(this.minHeapValue<e.getScore()){i=this.root.getMin();t.min=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMin(this):this.setRoot(i.more),this.size--;var r=this.root.getMin();return this.minHeapValue=r.tileNode.getScore(),!0}return!1},t.prototype.tryToInsertTileNodeMin=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.maxHeapValue>e.getScore()){this.insert(e),t.max=null;var i=this.root.getMax();return this.maxHeapValue=i.tileNode.getScore(),!0}return!1}if(this.maxHeapValue>e.getScore()){i=this.root.getMax();t.max=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMax(this):this.setRoot(i.less),this.size--;var r=this.root.getMax();return this.maxHeapValue=r.tileNode.getScore(),!0}return!1},t.prototype.setRoot=function(e){null!==this.root&&this.releaseHeapNode(this.root),this.root=e,null!==e&&(e.parent=null)},t.prototype.getAndRemoveMaxTileNode=function(){var e=this.root.getMax(),t=e.tileNode;return this.removeMaxHeapNode(e),t},t.prototype.removeMaxHeapNode=function(e){null!==e.parent?e.parent.removeMax(this):this.setRoot(e.less),this.size--},t.prototype.removeMinHeapNode=function(e){null!==e.parent?e.parent.removeMin(this):this.setRoot(e.more),this.size--},t.prototype.getAndRemoveMinTileNode=function(){var e=this.root.getMin(),t=e.tileNode;return this.removeMinHeapNode(e),t},t.prototype.getMinHeapNode=function(){return null!==this.root?this.root.getMin():null},t.prototype.getMaxHeapNode=function(){return null!==this.root?this.root.getMax():null},t.prototype.insert=function(e){var t=this.getHeapNode(e);null===this.root?this.setRoot(t):this.root.insert(t),this.size++},t.prototype.getHeapNode=function(t){var n;return this.firstFreeHeapNode?(n=this.firstFreeHeapNode,this.firstFreeHeapNode=n.more,n.reset()):n=new e,n.tileNode=t,n},t.prototype.releaseHeapNode=function(e,t){e.less=null,t&&t(e.tileNode),e.tileNode=null,e.more=this.firstFreeHeapNode,this.firstFreeHeapNode=e},t.prototype.releaseHeapNodeTree=function(e,t,n){null!==e.less&&(this.releaseHeapNodeTree(e.less,t+1,n),e.less=null),null!==e.more&&(this.releaseHeapNodeTree(e.more,t+1,n),e.more=null),this.releaseHeapNode(e,n)},t.prototype.reset=function(e){null!==this.root&&(this.releaseHeapNodeTree(this.root,0,e),this.root=null,this.minHeapValue=-1/0),this.size=0};var n=0,i=function(e){this.id=n++,this.nodeList=[],this.nbProcessedNodes=0,this.nodeListLength=0,this.listWasUpdated=!1,this.maxHeapNode=null,this.minHeapNode=null,this.negativeNodes=[],this.heap=new t(e||100)};i.prototype.fillHeapMax=function(e){var t,n,i,r={min:null},o=this.nodeListLength,a=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):a.tryToInsertTileNodeMax(t,r,0!==l)&&(n=r.min,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;s(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},i.prototype.fillHeapMin=function(e){var t,n,i,r={max:null},o=this.nodeListLength,a=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):a.tryToInsertTileNodeMin(t,r,0!==l)&&(n=r.max,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;s(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},i.prototype.getMaxNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var e,t=this.nodeListLength,n=-1,i=-1/0,r=null,o=0;for(e=0;e<t;e++)null!==(r=this.nodeList[e])&&r.isAlive()?r.getScore()>i&&(n=e,i=r.getScore()):o++;return n>-1?(r=this.nodeList[n],this.nodeList[n]=null):r=null,o>=this.nodeListLength?this.nodeListLength=0:o>200&&this.cleanNulls(!1),r},i.prototype.peekMaxNode=function(){if(!this.maxHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0?e=this.heap.root.getMax():this.negativeNodes.length>0&&(e=this.negativeNodes[this.negativeNodes.length-1]),this.maxHeapNode=e}return this.maxHeapNode?this.maxHeapNode.tileNode:null},i.prototype.peekMinNode=function(){if(!this.minHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0&&(e=this.heap.root.getMin()),this.minHeapNode=e}return this.minHeapNode?this.minHeapNode.tileNode:null},i.prototype.removeMaxHeapNode=function(e){this.heap.removeMaxHeapNode(e)},i.prototype.getMaxNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.heap.size>0?t=e?this.heap.getAndRemoveMaxTileNode():this.heap.getMaxNode():this.negativeNodes.length>0&&(t=this.negativeNodes.pop()),t},i.prototype.getMinNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.negativeNodes.length>0?t=this.negativeNodes.pop():this.heap.size>0&&(t=e?this.heap.getAndRemoveMinTileNode():this.heap.getMinNode()),t},i.prototype.checkIntegrity=function(e){var t,n=-1/0,i=1/0;if(this.heap.size>0)for(n=this.heap.root.getMin().tileNode.getScore(),i=this.heap.root.getMax().tileNode.getScore(),this.heap.root.checkMinMax(n,i)||console.log("checkMinMax has failed!!!"),t=0;t<(void 0!==e?e:this.nodeListLength);t++)this.nodeList[t]&&this.nodeList[t].getScore()>n&&console.log("found probleme!!!")},i.prototype.getMinNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var e,t=this.nodeListLength,n=-1,i=1/0,r=null,o=0;for(e=0;e<t;e++)null!==(r=this.nodeList[e])&&r.isAlive()?r.getScore()<i&&(n=e,i=r.getScore()):o++;return n>-1?(r=this.nodeList[n],this.nodeList[n]=null):r=null,o>=this.nodeListLength?this.nodeListLength=0:o>200&&this.cleanNulls(!1),r},i.prototype.cleanNulls=function(e){var t,n=this.nodeListLength,i=null,r=0;for(t=0;t<n;t++)null!==(i=this.nodeList[t])&&i.isAlive()?(this.nodeList[r]=i,r++):e&&t<this.nbProcessedNodes&&this.nbProcessedNodes--;this.nodeListLength=r,this.nodeList.length=this.nodeListLength},i.prototype.isEmpty=function(){return 0===this.heap.size&&0===this.nodeListLength&&0===this.negativeNodes.length},i.prototype.clear=function(e){var t;if(this.heap.reset(e),e)for(t=0;t<this.nodeListLength;t++)this.nodeList[t]&&e(this.nodeList[t]);this.nodeListLength=0,this.nbProcessedNodes=0,this.maxHeapNode=null,this.minHeapNode=null},i.prototype.resetOrder=function(e){var t,n=this.heap.getTileNodes();for(this.heap.reset(),t=0;t<n.length;t++)this.addNode(n[t]);for(t=0;t<this.negativeNodes.length;t++)this.addNode(this.negativeNodes[t]);if(this.negativeNodes.length=0,e){var i,r=0;for(t=0;t<this.nodeListLength;t++)(i=this.nodeList[t])&&e(i)&&(this.nodeList[r]=i,r++);this.nodeListLength=r}};var r=0;function o(e,t){var n,i=(n=r+=1831565813,n=Math.imul(n^n>>>15,1|n),(((n^=n+Math.imul(n^n>>>7,61|n))^n>>>14)>>>0)%(t-e)),o=e+(i=i<0?i+(t-e):i);return isFinite(o)?o:-1}function s(e,t,n,i){let r;for(r=0;r<t.length;r++){let s=t[r],a=o(n,i),d=e[s];a!==s&&a>=0&&(e[s]=e[a],e[a]=d)}}return i.prototype.addNode=function(e,t){this.nodeListLength>=this.nodeList.length?(this.nodeList.push(null),this.nodeListLength=this.nodeList.length):this.nodeList[this.nodeListLength++]=null,t?this.nodeList[this.nodeListLength-1]=e:function(e,t,n,i){if(i<=1)e[i-1]=t;else{var r=o(n,i);r<0&&(r=i-1),r>=i-1?e[i-1]=t:(e[i-1]=e[r],e[r]=t)}}(this.nodeList,e,this.nbProcessedNodes,this.nodeListLength),this.listWasUpdated=!0},i.prototype.peekMinHeapNode=function(e){return 0!==this.heap.size&&!this.listWasUpdated||e||(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMinHeapNode()},i.prototype.peekMaxHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMaxHeapNode()},i.prototype.traverseMin=function(e){var t,n,i;for((0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),t=this.negativeNodes.length-1;t>=0;t--){if(!e(this.negativeNodes[t]))return;this.negativeNodes.length--}do{i=!0,null!==(n=this.peekMinHeapNode())&&e(n.tileNode)&&(this.heap.removeMinHeapNode(n),i=!1)}while(!i)},i.prototype.traverseMinPlus=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t,n,i,r,o,s=[];function a(){i=!0}function d(){n=!0}for(n=!1,r=this.negativeNodes.length-1;r>=0&&!n;r--)o=this.negativeNodes[r],i=!1,n=!1,e(o,d,a),this.negativeNodes.length--,i&&s.push(o);for(;!n;)n=!1,i=!1,null!==(t=this.peekMinHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&s.push(t.tileNode),this.heap.removeMinHeapNode(t))):n=!0;for(r=0;r<s.length;r++)this.addNode(s[r],!1)},i.prototype.traverseMax=function(e){var t,n;do{n=!0,null!==(t=this.peekMaxHeapNode())&&e(t.tileNode)&&(this.heap.removeMaxHeapNode(t),n=!1)}while(!n)},i.prototype.traverseMaxPlus=function(e){var t,n,i,r,o=[],s=!1;function a(){i=!0}function d(){n=!0}do{n=!1,i=!1,null!==(t=this.peekMaxHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&o.push(t.tileNode),this.heap.removeMaxHeapNode(t))):s=!0}while(!n&&!s);for(r=this.negativeNodes.length-1;r>=0&&!n;r--){let t=this.negativeNodes[r];i=!1,n=!1,e(t,d,a),this.negativeNodes.length--,i&&o.push(t)}for(r=0;r<o.length;r++)this.addNode(o[r],!1)},i.prototype.removeNode=function(e){var t;for(this.resetOrder(),t=0;t<this.nodeListLength;t++)this.nodeList[t]===e&&(this.nodeList[t]=null)},i.prototype.getAllNodes=function(){var e,t,n=[];for(t=0;t<this.nodeListLength;t++)(e=this.nodeList[t])&&n.push(e);var i=this.heap.getTileNodes();return n.concat(i)},i.prototype.getMaxNodes=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getTileNodes()},i.prototype.getSize=function(){return this.cleanNulls(),this.nodeListLength+this.heap.size},i.prototype.traverseNoOrder=function(e){var t,n,i,r,o,s=[];function a(){i=!0}function d(){n=!0}for(n=!1,r=this.negativeNodes.length-1;r>=0&&!n;r--)o=this.negativeNodes[r],i=!1,n=!1,e(o,d,a),this.negativeNodes.length--,i&&s.push(o);let l=!1;for(;!n&&!l;)n=!1,i=!1,(t=this.peekMinHeapNode(!0))?(e(t.tileNode,d,a),n&&i||(i&&s.push(t.tileNode),this.heap.removeMinHeapNode(t))):l=!0;let h=0;for(r=0;r<this.nodeList.length&&!n;r++)n=!1,i=!1,(o=this.nodeList[r])?(e(o,d,a),i||(this.nodeList[r]=null,h++),n&&(n=!0)):h++;for(h>200&&this.cleanNulls(!0),r=0;r<s.length;r++)this.addNode(s[r],!1)},i})),define("DS/3DXMTiles/OOCInstanceIterator",[],(function(){"use strict";var e=function(e,t){this._referenceIterator=e,this._childData=t};return e.prototype.getReferenceIterator=function(){return this._referenceIterator},e.prototype.getInstanceId=function(){return this._childData.instanceId},e.prototype.getMatrix=function(){var e=this._childData.matrix;return e&&e.clone()},e.prototype.getNode=function(){return this._childData.node},e})),define("DS/3DXMTiles/Debug3DXMTiles",[],(function(){var e=-1;return window.OOCGetProbes=function(){var e=-1,t=[];return measures=window.top.performance.getEntriesByType("measure"),measures=measures.concat(window.top.performance.getEntriesByType("mark")),measures.forEach((function(n){-1===e&&(e=n.startTime),"measure"===n.entryType?t.push({name:n.name,duration:n.duration,startTime:n.startTime-e,entryType:n.entryType}):t.push({name:n.name,startTime:n.startTime-e,entryType:n.entryType})})),t},{setSceneGraphMode:function(e){if("flat"===e)this.sceneGraphMode=0;else{if("dual"!==e)throw new Error("Unknown mode");this.sceneGraphMode=1}},sceneGraphMode:1,configs:{1:{modelDir:"../airbus/assets/airbusnew4/",instrefDir:"../airbus/assets/instref2/",assetsDir:"../airbus/assets/",toReplace:[],root:"XWB-A350-900-RR.instref"},2:{modelDir:"../airbus2/assets/3DXM/",instrefDir:"../airbus2/assets/InstRef/",assetsDir:"../airbus2/assets/",toReplace:["../airbus2/assets/NewCGRs/"],root:"XWB-A350-900-RR.instref"},3:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],root:"A350.instref"},4:{modelDir:"../airbus3/CGR/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/"],root:"A350.instref",cgr:!0},5:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],toReplaceAV1:"../airbus3/3dxm/",root:"A350.instref"}},probePrefix:"WebVisuOOC_",probeMap:new Map,probeIndex:0,startProbe:function(t){if(-1===e&&(e=window.OOCProbes?1:0),1===e){var n=this.probePrefix+t+"_"+this.probeIndex;this.probeIndex++,this.probeMap.set(t,n),window.top.performance.mark(n+"_begin")}},endProbe:function(t){if(1===e){var n=this.probeMap.get(t);this.probeMap.delete(t);var i=n+"_end";window.top.performance.mark(i);var r=n+"_begin";window.top.performance.measure(this.probePrefix+t,r,i)}}}})),define("DS/3DXMTiles/DSTilesConstantScoreComputer",[],(function(){"use strict";var e=function(e){this.score=e.score||0,this.pixelError=e.pixelError||0};return e.prototype.computeScore=function(e,t,n){e.score=this.score,n&&(e.pixelError=this.pixelError)},e})),define("DS/3DXMTiles/VDRPIdPath",["DS/Visualization/IdPath"],(function(e){"use strict";class t{constructor(e,t){this.productIdPath=e,this.positionIdPath=t,this._key=null}buildRIRVersion(e){let n=new t(null,null),i=!1,r=!1;if(this.productIdPath){if(n.productIdPath=[],!e.isPLMReference(this.productIdPath[0])){let t=e.getInstanceParentReferenceId(this.productIdPath[0]);if(!t)return null;n.productIdPath.push(t),i=!0}n.productIdPath=n.productIdPath.concat(this.productIdPath);let t=this.productIdPath[this.productIdPath.length-1];if(!e.isPLMReference(t)){let i=e.getInstanceChildReferenceId(t);n.productIdPath.push(i),r=!0}}if(this.positionIdPath){n.positionIdPath=[];let t=e._getPGManager();if(!t.getPGReference(this.positionIdPath[0])){let e=t.getPGInstance(this.positionIdPath[0]);if(!e)return null;n.positionIdPath.push(e.parentReference.referenceId)}n.positionIdPath=n.positionIdPath.concat(this.positionIdPath);let i=this.positionIdPath[this.positionIdPath.length-1];if(!t.getPGReference(i)){let e=t.getPGInstance(i);if(!e)return null;n.positionIdPath.push(e.childReference.referenceId)}}return{vdrpIdPath:n,removeStart:i,removeEnd:r}}_buildInternalIdPathes(e,t){return this.productIdPath?this.positionIdPath?this._buildIdPathesWithPosition(e,t):this._buildIdPathesWithoutPosition(e,t):null}_buildIdPathesWithPosition(t,n){let r,o=[];if(n){if(!n.length)return null;for(r=0;r<n.length;r++)o.push(n[r])}let s=-1;for(r=0;r<this.productIdPath.length&&s<0;r++){let e=this.productIdPath[r];t.isExternalNodeId(e)?o.push(e):s=r}if(s<this.productIdPath.length){let e=null;0===s&&(e=this.buildRIRVersion(t));let n=e?e.vdrpIdPath:this,a=t._getPGManager(),d=0;for(o.push(n.productIdPath[s]),r=s+1;r<n.productIdPath.length;r+=2){let e,s,l=n.productIdPath[r],h=n.productIdPath[r+1],c=n.positionIdPath;if(t.isPLMInstance(l))e=l;else{let t=a.getPGLink(l);t&&(s=t.findInPositionIdPath(c,d),s>0&&(e=i(l,c,d,s+1),d=s))}o.push(e),o.push(h)}e&&e.removeStart&&o.shift(),e&&e.removeEnd&&o.pop()}return[new e(o)]}_buildIdPathesWithoutPosition(t,i){let r,o=[],s=null;if(i){if(!i.length)return null;for(r=0;r<i.length;r++)o.push([i[r]])}let a=-1;for(r=0;r<this.productIdPath.length&&a<0;r++){let e=this.productIdPath[r];t.isExternalNodeId(e)?o.push([e]):a=r}let d=t._getPGManager(),l=!1;for(r=a;r<this.productIdPath.length&&!l;r++){let e=this.productIdPath[r],n=[];if(o.push(n),t.isPLMReference(e)||t.isPLMInstance(e))n.push(e);else{let t=d.getOOCDerivedInstanceIds(e);if(t){let e;for(e=0;e<t.length;e++)n.push(t[e])}}0===n.length&&(l=!0)}if(!l){let t=[];for(n(o,[],t,0),s=[],r=0;r<t.length;r++)s.push(new e(t[r]))}return s}getKey(){if(null===this._key){let e,t="";for(e=0;e<this.productIdPath.length;e++)t=0===e?this.productIdPath[e]:`${t}/${this.productIdPath[e]}`;if(this.positionIdPath)for(e=0;e<this.positionIdPath.length;e++)t=0===e?`${t}|${this.positionIdPath[e]}`:`${t}/${this.positionIdPath[e]}`;else t=`${t}|null`;this._key=t}return this._key}createJSON(){return[this.productIdPath,this.positionIdPath]}setFromJSON(e){this.productIdPath=e[0],this.positionIdPath=e[1],this._key=null}}function n(e,t,i,r){if(r>=e.length)i.push(t);else{let o,s=e[r];for(o=0;o<s.length;o++)n(e,t.concat([s[o]]),i,r+1)}}function i(e,t,n,i){let r,o=e;for(r=n+1;r<t.length&&r<i;r+=2)o=`${o}/${t[r]}`;return o}return t})),define("DS/3DXMTiles/LDHModelLoader",["DS/Visualization/ModelLoader"],(function(e){return new class{constructor(){this.modelLoader=null}getModelLoader(){return this.modelLoader||(this.modelLoader=new e,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.modelLoader.sharedBuffers=!1),this.modelLoader}}})),define("DS/3DXMTiles/LDHStats",[],(function(){"use strict";var e={startNbLoadedModels:0,nbLoadedModels:0,startTime:0,nbBatches:0,bytesLoaded:0,history:[],occlusion:0,batchSize:0,flags:[],firstLoadTime:-1,endLoadingTime:-1,tts:-1,ttsTime:-1,fullVPStartTime:-1,fullVP:-1,fullVPRunning:!1,loading:!1,memoryFull:!1,onStartCGRLoading:function(){-1===this.firstLoadTime&&(this.firstLoadTime=Date.now())},init:function(){var e=window.localStorage.getItem("TileModelPreloadData");if(this.tts=-1,e){var t=JSON.parse(e);t.tts&&(this.tts=parseInt(t.tts))}0===this.startTime&&(this.startTime=Date.now(),this.history.push({time:this.startTime,nbLoadedModels:0,bytesLoaded:0}))},onNewViewpoint:function(){this.startNbLoadedModels=this.nbLoadedModels,this.firstLoadTime=-1,this.endLoadingTime=-1,this.ttsTime=-1},onStartLoading:function(){this.loading=!0},onEndLoading:function(e){this.loading=!1,this.memoryFull=e,this.endLoadingTime=Date.now(),this.status=e?"stopped":"complete"},addFlag:function(e){this.flags.push(e)},onOcclusion:function(){this.occlusion++},computeInstantStats:function(){var e,t=Date.now(),n=0;for(e=0;e<this.history.length;e++)t-this.history[e].time>2e3&&(n=e);n>0&&this.history.splice(0,n);var i=this.history[0],r={mps:1e3*(this.nbLoadedModels-this.startNbLoadedModels)/(t-this.startTime),imps:(this.nbLoadedModels-i.nbLoadedModels)/(t-i.time)*1e3,batches:this.nbBatches,batchSize:this.nbBatches>0?this.batchSize/this.nbBatches:0,mbps:8e3*(this.bytesLoaded-i.bytesLoaded)/(1048576*(t-i.time)),occlusion:this.occlusion,flags:this.flags,modelLoadingTime:-1!==this.startLoadTime&&-1!==this.endLoadingTime?(this.endLoadingTime-this.firstLoadTime)/1e3:-1,ttsTime:this.ttsTime,firstLoadTime:this.firstLoadTime,fullVP:this.fullVP,status:this.computeStatus()};return this.history.push({time:t,nbLoadedModels:this.nbLoadedModels,bytesLoaded:this.bytesLoaded}),r},onLoadedModel:function(e){e&&(this.bytesLoaded+=e),this.nbLoadedModels++,this.nbLoadedModels-this.startNbLoadedModels>=this.tts&&this.ttsTime<0&&(this.ttsTime=Date.now())},onStartBatch:function(e){this.nbBatches++,this.batchSize+=e},onEndBatch:function(e){this.nbBatches--,this.batchSize-=e},onFullVP:function(e){this.fullVPStartTime=Date.now(),this.fullVPRunning=!0;let t=e.viewer;t&&t.fpsCounter&&t.render()},onFullVPDone:function(e){this.fullVP=Date.now()-this.fullVPStartTime,this.fullVPRunning=!1},computeStatus:function(){let e=window.oocLDHNodeManager.viewer.isManipulatedViewpointMoving(),t="---";return t=this.fullVPRunning?"index":this.loading?e?"moving":"loading":this.memoryFull?"stopped":"complete",t}};return window.modelLoaderPoolStats=e,e})),define("DS/3DXMTiles/DSTilesStylingAttributePack",[],(function(){"use strict";class e{constructor(){this.map=new Map}setAttribute(e,t){this.map.set(e,t)}getValue(e){return this.map.get(e)}getAttributes(){let e=[];return this.map.forEach(((t,n)=>{e.push(n)})),e}createFilteredPack(t,n){let i,r=new e;for(i=0;i<t.length;i++){let e,o=t[i],s=!1;this.hasAttribute(o)?(e=this.getValue(o),s=!0):n&&n.hasAttribute(o)&&(e=n.getValue(o),s=!0),s&&r.setAttribute(o,e)}return r}hasAttribute(e){return this.map.has(e)}}return e})),define("DS/3DXMTiles/DSTilesSourceIdWithParams",[],(function(){"use strict";return class{constructor(e,t){this.sourceId=e||null,this.params=t||null}}})),define("DS/3DXMTiles/PointCloudServices",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t={parseBigInt:function(e){var t;try{t=BigInt("0xFFFFFFFFFFFFFFFF")}catch{t=JSBI.BigInt("0xFFFFFFFFFFFFFFFF")}return t},createTileContentFromBuffer:function(e,n){let i=new DataView(e);const r=new Uint8Array(e);let o=0,s=t.oldUnstream?i.getUint32(o):i.getUint32(o,!0);if(o+=4,2===s){let t=i.getUint32(o,!0);o+=4;const a=new TextDecoder("utf-8"),d=JSON.parse(a.decode(r.subarray(o,o+t)));o+=t;let l=i.getUint32(o,!0);o+=4;let h=i.getFloat32(o,!0);o+=4;let c,u=0;for(let e of d)u+=e.size;c=o%4==0?r.subarray(o,o+l*u):new Uint8Array(e.slice(o,o+l*u));let p=l>1?{buffer:c,attributes:[],points:l,spacing:h}:null;if(p)for(let e of d)"DEF_POSITION"===e.name?p.attributes.push(this._buildPosition(e,u)):"DEF_COLOR"===e.name?p.attributes.push(this._buildColor(e,u)):this.pushStylingAttribute(p,e,u,n);return{version:s,geometry:p}}return null},_buildPosition:function(e,t){return{name:"position",offset:e.offset,size:e.size,count:3,stride:t}},_buildColor:function(e,t){return{name:"color",offset:e.offset,size:e.size,count:4,stride:t}},pushStylingAttribute:function(e,t,n,i){let r=i.get(t.name);if(r){let i=r.type;"integer"!==i&&"float"!==i||e.attributes.push({name:t.name,offset:t.offset,size:t.size,count:1,stride:n})}}};return t.bigIntZero=t.parseBigInt("0"),t.oldUnstream=!1,t})),define("DS/3DXMTiles/DSTilesNodeMemorySize",[],(function(){"use strict";return function(e,t){this.memory=e||0,this.memoryGPU=t||0,this.memoryMeshInRAM=0}})),define("DS/3DXMTiles/ModelBank",["DS/QualityManager/QMController","DS/Visualization/TaskManager"],(function(e,t){"use strict";var n=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,i=function(){this.timeLimitDays=7,this.refreshTimeDays=1,this.debugData=window.ModelBank_debug_init,this.db=null,this.nbTickets=100,this.queue=[],this.referenceSet=new Set,this.errorReferenceSet=new Set,this.metaMap=new Map,this.maxSize=0,this.size=0,this.initComplete=!1,this.nbTransactions=0,this.nbStartedTransactions=0,this.clearRequest=!1,this.disabled=!1,this.initNeeded=!0,this._dbgDisabled="true"===window.localStorage.getItem("OOCDisableBank")};i.prototype.init=function(){if(this.initNeeded){this.initNeeded=!1;var t=this;this.maxSize=1024*e.getLocalCacheSize(!0)*1024,this.debugData&&(void 0!==this.debugData.timeLimitDays&&(this.timeLimitDays=this.debugData.timeLimitDays),void 0!==this.debugData.refreshTimeDays&&(this.refreshTimeDays=this.debugData.refreshTimeDays),void 0!==this.debugData.maxSize&&(this.maxSize=this.debugData.maxSize));var i=n.open("modelsDBLocal",2);let r=0;i.onerror=function(e){console.log("error creating/accessing models database"),n.deleteDatabase("modelsDBLocal"),t.initComplete=!0},i.onsuccess=function(e){t.db=i.result;var n=t.db.transaction(["models","meta"],"readonly");n.objectStore("models").getAllKeys().onsuccess=function(e){var n;if(e.target.result&&!t.isDisabled())for(n=0;n<e.target.result.length;n++)t.referenceSet.add(e.target.result[n]);r++,2===r&&_onInitComplete()},n.objectStore("meta").openCursor().onsuccess=function(e){var n,i=e.target.result;i?(void 0!==i.key&&(n=i.value,t.metaMap.set(i.key,n),t.size+=n.size||0),i.continue()):(r++,2===r&&(t.debugData&&t.debugData.beforeCheckSizeCB&&t.debugData.beforeCheckSizeCB(t),t.clearRequest&&(t.clear(),t.clearRequest=!1),t.removeOldData(),t.checkSize(),t.initComplete=!0))},n.onerror=()=>{this.initComplete=!0},t.db.onerror=t.onDbError.bind(t)},i.onupgradeneeded=function(e){var t,n;t=e.target.result,n=e.oldVersion,console.log("Updating objectstore"),n<1&&t.createObjectStore("models"),n<2&&t.createObjectStore("meta")}}},i.prototype.onDbError=function(e){console.log("Db error")},i.prototype.removeOldData=function(){window.ModelBank_debug_init&&(window.ModelBank_debug_init.referenceSetSize=this.referenceSet.size,window.ModelBank_debug_init.metaMapSize=this.metaMap.size);var e=[],t=Date.now()-24*this.timeLimitDays*60*60*1e3;this.metaMap.forEach((function(n,i,r){n.time<t&&e.push(i)})),this.removeKeys(e,!1)},i.prototype.removeKeys=function(e,t){let n,i=[];for(n=0;n<e.length;n++){let r=e[n];if(t&&this.errorReferenceSet.add(r),this.referenceSet.delete(r)&&i.push(r),this.metaMap.has(r)){let e=this.metaMap.get(r);e&&(this.size-=e.size),this.metaMap.delete(r)}}if(i.length>0)try{var r,o,s=this.db.transaction(["models","meta"],"readwrite");for(n=0;n<i.length;n++)r=i[n],s.objectStore("models").delete(r),o=s.objectStore("meta").delete(r),this.debugData&&this.debugData.onRemoveKeysCB&&(o.onsuccess=this.debugData.onRemoveKeysCB.bind(null,this))}catch(e){}},i.prototype.buildKey=function(e,t,n){return e+t.substring(7)+"@"+n},i.prototype.storeModelData=function(e,t,n,i,r){if(!this.db||this.isDisabled())return;var o=null;let s=[],a=[];for(var d=0;d<e.length;++d){var l=t[d],h=e[d],c=this.buildKey(h,l,n);if(!this.referenceSet.has(c)&&!this.errorReferenceSet.has(c)){var u={time:Date.now(),wms:r[d],size:i[d].byteLength};try{o||(o=this.db.transaction(["models","meta"],"readwrite")),o.objectStore("models").put(i[d],c),o.objectStore("meta").put(u,c),s.push(c),a.push(u)}catch(e){}}}o&&(this.nbTransactions++,this.nbStartedTransactions++,o.oncomplete=()=>{let e;for(this.nbTransactions--,e=0;e<s.length;e++){let t=s[e],n=a[e];this.referenceSet.add(t),this.metaMap.set(t,n)}})},i.prototype.oocRetrieveModelData=function(e,t,n,i,r,o){let s,a=[];for(s=0;s<e.length;s++){let t=e[s];a.push(t.referenceId)}this.loadModelsData(a,t,n,((t,n,s)=>{i.onModelBankData(e[t],r,o,n||null,s)}),(t=>{o(e[t])}))},i.prototype.loadModelsData=function(e,n,i,o,s){var a,d,l,h=[];if(!this.db)for(a=0;a<e.length;a++)setTimeout(s.bind(null,a),0);var c=Date.now()-24*this.refreshTimeDays*60*60*1e3;for(a=0;a<e.length;++a){var u=e[a];l=this.buildKey(u,n[a],i),(d=this.metaMap.get(l)).time<c&&h.push(l)}var p=0===h.length?this.db.transaction(["models"],"readonly"):this.db.transaction(["models","meta"],"readwrite");for(a=0;a<e.length;++a){u=e[a];l=this.buildKey(u,n[a],i);var g=p.objectStore("models").get(l);g.onsuccess=function(e,n){return t.postponeAfterManipulation((function(t){var i=t.target.result;o(e,i,n)}))}(a,l),g.onerror=function(e,t){return function(){s(e),r.removeKeys([t],!0)}}(a,l)}var f=Date.now();for(a=0;a<h.length;a++)l=h[a],(d=this.metaMap.get(l))&&(d.time=f,p.objectStore("meta").put(d,l))},i.prototype.hasModelData=function(e,t,n,i){if(this.isDisabled())return!1;var r=this.buildKey(e,t,n),o=!1;if(this.referenceSet.has(r)&&!this.errorReferenceSet.has(r)){var s=this.metaMap.get(r);if(i&&s&&s.wms===i&&(o=!0),!o){this.referenceSet.delete(r),this.metaMap.delete(r);var a=this.db.transaction(["models","meta"],"readwrite");a.objectStore("models").delete(r),a.objectStore("meta").delete(r)}}return o},i.prototype.clear=function(){if(!this.isDisabled())if(this.db){this.referenceSet.clear(),this.metaMap.clear(),this.errorReferenceSet.clear();var e=this.db.transaction(["models","meta"],"readwrite");e.objectStore("models").clear(),e.objectStore("meta").clear()}else this.clearRequest=!0},i.prototype.checkSize=function(){if(!this.isDisabled()&&this.maxSize>=0&&this.size>this.maxSize){var e=Array.from(this.metaMap);e.sort((function(e,t){return e[1].time-t[1].time}));var t,n=.8*this.maxSize,i=this.size,r=[];for(t=0;t<e.length&&i>n;t++)i-=e[t][1].size||0,r.push(e[t][0]);this.removeKeys(r,!1)}},i.prototype.hasTileData=function(e,t){if(this.isDisabled())return!1;var n=e,i=!1;if(this.referenceSet.has(n)){var r=this.metaMap.get(n);if(t&&r&&r.wms===t&&(i=!0),!i){this.referenceSet.delete(n),this.metaMap.delete(n);var o=this.db.transaction(["models","meta"],"readwrite");o.objectStore("models").delete(n),o.objectStore("meta").delete(n)}}return i},i.prototype.retrieveTileData=function(e,t,n){var i,o,s,a=[];if(this.db){var d=Date.now()-24*this.refreshTimeDays*60*60*1e3;for(i=0;i<e.length;++i)s=e[i],(o=this.metaMap.get(s)).time<d&&a.push(s);var l=0===a.length?this.db.transaction(["models"],"readonly"):this.db.transaction(["models","meta"],"readwrite");for(i=0;i<e.length;++i){s=e[i];var h=l.objectStore("models").get(s);h.onsuccess=function(e,n){return function(n){var i=n.target.result;t(e,i)}}(i),h.onerror=function(e,t){return function(){r.removeKeys([t],!0),n(e)}}(i,s)}var c=Date.now();for(i=0;i<a.length;i++)s=a[i],(o=this.metaMap.get(s))&&(o.time=c,l.objectStore("meta").put(o,s))}else for(i=0;i<e.length;i++)setTimeout(n.bind(null,e[i]),0)},i.prototype.storeTileData=function(e,t,n){if(this.db&&!this.isDisabled()){for(var i=this.db.transaction(["models","meta"],"readwrite"),r=0;r<e.length;++r){var o=e[r],s={time:Date.now(),wms:n[r],size:t[r].byteLength};i.objectStore("models").put(t[r],o),i.objectStore("meta").put(s,o),this.referenceSet.add(o),this.metaMap.set(o,s)}this.nbTransactions++,this.nbStartedTransactions++,i.oncomplete=()=>{this.nbTransactions--}}},i.prototype.setDisabled=function(e){this.disabled=e},i.prototype.isDisabled=function(){return this._dbgDisabled||this.disabled};var r=new i;return r})),define("DS/3DXMTiles/DSTilesNodeStatus",[],(function(){"use strict";return{waiting:"waiting",toLoad:"toLoad",loading:"loading",loaded:"loaded",error:"error",dead:"dead"}})),define("DS/3DXMTiles/PGReference",[],(function(){"use strict";return class{constructor({referenceId:e}){this.referenceId=e,this.instances=[],this.links=[],this.parentPGInstances=[],this.useCount=0}addPGInstance(e){this.instances.push(e)}addPGLink(e){this.links.push(e)}addParentPGInstance(e){this.parentPGInstances.push(e)}getPGInstance(e){let t;for(t=0;t<this.instances.length;t++){let n=this.instances[t];if(n.instanceId===e)return n}return null}buildPGInstancePathes(){let e=[];return this.buildPGInstancePathes_internal([],e,!0),e}buildPGInstancePathes_internal(e,t,n){if((this.links.length>0||0===this.parentPGInstances.length)&&!n)t.push(e);else{let n;for(n=0;n<this.parentPGInstances.length;n++){let i=this.parentPGInstances[n],r=e.concat([]);r.unshift(i),i.parentReference.buildPGInstancePathes_internal(r,t,!1)}}}addRef(){this.useCount++}release(e){this.useCount--,0===this.useCount&&this.dispose(e)}dispose(e){let t;for(t=0;t<this.instances.length;t++){this.instances[t].dispose(e)}e.unregisterPGReference(this)}}})),define("DS/3DXMTiles/DSTilesWorldPosition",["DS/Visualization/ThreeJS_R57"],(function(e){"use strict";var t=function(){this.matrixArray=[null],this.inverseMatrixArray=[null],this.inverseMatrixUpToDate=!1};return t.prototype.setFromOccurrences=function(t,n){var i,r;for(this.matrixArray.length=t.length,this.inverseMatrixArray.length=t.length,i=0;i<t.length;i++)(r=new e.Matrix4).copy(t[i].matrix),n&&r.multiplyMatrices(r,n),this.matrixArray[i]=r;this.inverseMatrixUpToDate=!1},t.prototype.update=function(t){var n,i=t.parent&&t.parent.worldPosition;for(i&&(this.matrixArray.length=i.matrixArray.length,this.inverseMatrixArray.length=i.matrixArray.length),this.inverseMatrixUpToDate=!1,n=0;n<this.matrixArray.length;n++){var r;r=i&&i.matrixArray[n],t.matrix?r?(this.matrixArray[n]=new e.Matrix4,this.matrixArray[n].multiplyMatrices(r,t.matrix)):this.matrixArray[n]=t.matrix:this.matrixArray[n]=r,this.inverseMatrixArray[n]=null}},t.prototype.updateInverseMatrix=function(t){if(!this.inverseMatrixUpToDate){var n,i=t.parent;for(n=0;n<this.matrixArray.length;n++){var r=this.matrixArray[n];i&&i.worldPosition.matrixArray[n]===r&&(i.worldPosition.updateInverseMatrix(i),o=i.worldPosition.inverseMatrixArray[n]);var o=new e.Matrix4;r&&o.getInverse(r),this.inverseMatrixArray[n]=o}}this.inverseMatrixUpToDate=!0},t.prototype._getInverseMatrix=function(e){return this.inverseMatrixUpToDate||this.updateInverseMatrix(e),this.inverseMatrixArray[0]},t})),define("DS/3DXMTiles/LDHSwitchRepresentationData",[],(function(){"use strict";var e=function(e){this.rep=e,this.onSwitchRepCBArray=null};return e.prototype.setRep=function(e){this.rep=e},e.prototype.addOnSwitchRepCB=function(e){e&&(null===this.onSwitchRepCBArray&&(this.onSwitchRepCBArray=[]),this.onSwitchRepCBArray.push(e))},e})),define("DS/3DXMTiles/DSTilesContent",[],(function(){"use strict";return class{constructor(e,t,n){this.sourceId=e.source||null,this.type=e.type,this.format=e.format,this.uri=e.uri,this.etag=e.etag||null,this.metaData=n;var i=e.fileSize?parseFloat(e.fileSize):0;if(isFinite(i)||(i=0),this.fileSize=i,this.instances=e.instances||null,this.contentToken=null,this.updatedContentToken=null,this.updatedContentVersion=0,this.contentLoader=t.getContentLoader(e.type),!this.contentLoader)throw new Error("unknown content type '"+e.type+"'")}needsSgNode(){return this.contentLoader.needsSgNodePerContent()}replaceContentWithUpdated(e){if(!this.updatedContentToken||!e.isAlive())return;this.updatedContentToken&&!this.contentToken&&this.deleteContent(e,!0);let t=e.getContentVisible();t&&this.hideContent(e),this.deleteContent(e),this.contentToken=this.updatedContentToken,this.updatedContentToken=null,t&&this.showContent(e)}showContent(e){this.contentLoader.showContent(e,this)}hideContent(e){this.contentLoader.hideContent(e,this)}deleteContent(e,t){t?(this.updatedContentToken&&this.contentLoader.deleteContent(e,this,this.updatedContentToken),this.updatedContentToken=null):(this.contentToken&&this.contentLoader.deleteContent(e,this,this.contentToken),this.contentToken=null)}getContentToken(e){return e?this.updatedContentToken:this.contentToken}setContentToken(e,t){t?this.updatedContentToken=e:this.contentToken=e}invalidateContentTokens(e){this.contentLoader&&(this.contentToken&&this.contentLoader.invalidateContentToken(e,this,this.contentToken),this.updatedContentToken&&this.contentLoader.invalidateContentToken(e,this,this.updatedContentToken))}getUri(e,t){let n=this.contentLoader.getURIPostFix(),i=t&&t.uriPostFix||"";return this.uri&&"string"!=typeof this.uri?this.uri[e]+(n||""):this.uri+i+(n||"")}getFormat(){return this.format}getSourceIdWithParamsArray(e){return this.contentLoader.getSourceIdWithParamsArray(this,e)}exportContent(e){return this.contentLoader.exportContent(e,this)}getSingleSource(e){return e.tileSet.getContentSource(this.sourceId)}getSingleSourceId(){return this.sourceId||"default"}setUpdatedContentVersion(e){this.updatedContentVersion=e}getMetaData(){return this.metaData}getAttributeValue(e,t){return this.contentLoader.getAttributeValue(e,t,this)}getAllAttributes(e){return this.contentLoader.getAllAttributes(e,this)}getPathElementsLeadingToAttribute(e,t,n,i){this.contentLoader.getPathElementsLeadingToAttribute(e,t,n,i,this)}}})),define("DS/3DXMTiles/PGOOCInstance",[],(function(){"use strict";return class{constructor(e,t,n){this.childId=e,this.instanceId=t,this.matrix=n||null,this.derivedInstanceIds=null,this.userData=null}buildDerivedInstanceId(e){let t,n=this.instanceId;for(t=0;t<e.length;t++)n+="/"+e[t].instanceId;return n}resetDerivedInstanceIds(){this.derivedInstanceIds=null}addDerivedInstanceId(e){this.derivedInstanceIds||(this.derivedInstanceIds=[]),this.derivedInstanceIds.push(e)}setUserData(e,t){if(this.userData=e,this.derivedInstanceIds){let n;for(n=0;n<this.derivedInstanceIds.length;n++){let i=this.derivedInstanceIds[n];t.setUserData(i,e,!0)}}}}})),define("DS/3DXMTiles/LDHReferenceStatus",[],(function(){return{loading:"loading",loaded:"loaded",toLoad:"toLoad",toUnload:"toUnload",toUnloadLight:"toUnloadLight",freezeUnload:"freezeUnload",dead:"dead",waiting:"waiting",error:"error"}})),define("DS/3DXMTiles/DSTilesR2VOctree",[],(function(){"use strict";function e({tileNode:e}){this.root=new n({tileNode:e,cellCoords:new t(0,0,0,0),tree:this,parent:null})}function t(e,t,n,i){this.x=e,this.y=t,this.z=n,this.depth=i}function n({tileNode:e,cellCoords:t,tree:n,parent:i}){this.tree=n,this.cellCoords=t,this.tileNode=e,this.children=null,this.childCount=0,this.maxDepth=0,this.parent=i||null}return e.prototype.getSizeData=function(){var e=this.getMaxDepth(),t=Math.pow(2,e),n=new Float32Array(t*t*t);return this.root.writeDataToBuffer_traverse(n,e),n},e.prototype.getMaxDepth=function(){return this.root.maxDepth},e.prototype.addTileNode=function(e,t){if(e!==this.root.tileNode){var n=this.root.getTileNodeCellCoords(e,t);this.root.addTileNode(e,n)}},e.prototype.removeTileNode=function(e,t){if(e!==this.root.tileNode){var n=this.root.getTileNodeCellCoords(e,t);this.root.removeTileNode(e,n)}},n.prototype.getTileNodeCellCoords=function(e,n){var i=this.tileNode.getBoundingBox(),r=Math.pow(2,n),o=(i.max.x-i.min.x)/r,s=(i.max.y-i.min.y)/r,a=(i.max.z-i.min.z)/r,d=e.getBoundingBox(),l=(d.max.x+d.min.x)/2,h=(d.max.y+d.min.y)/2,c=(d.max.z+d.min.z)/2;return new t(Math.floor((l-i.min.x)/o),Math.floor((h-i.min.y)/s),Math.floor((c-i.min.z)/a),n)},t.prototype.buildChildCoords=function(e){var n=e%2,i=2&e?1:0,r=4&e?1:0;return new t((this.x<<1)+n,(this.y<<1)+i,(this.z<<1)+r,this.depth+1)},n.prototype.writeDataToBuffer_traverse=function(e,t){var n,i;if(this.tileNode&&this.writeDataToBuffer(e,t),this.children)for(n=0;n<this.children.length;n++)(i=this.children[n])&&i.writeDataToBuffer_traverse(e,t)},n.prototype.writeDataToBuffer=function(e,t){var n,i,r,o=this.tileNode.geometricalError,s=Math.pow(2,t-this.cellCoords.depth),a=s*this.cellCoords.x,d=s*this.cellCoords.y,l=s*this.cellCoords.z,h=Math.pow(2,t),c=h*h-s*s,u=h-s,p=a+h*d+h*h*l;for(r=0;r<s;r++){for(i=0;i<s;i++){for(n=0;n<s;n++)e[p]=o,p++;p+=u}p+=c}return o},n.prototype.getChildIndex=function(e){var t=Math.pow(2,e.depth-this.cellCoords.depth);return Math.floor(2*(e.x/t-this.cellCoords.x))+(Math.floor(2*(e.y/t-this.cellCoords.y))<<1)+(Math.floor(2*(e.z/t-this.cellCoords.z))<<2)},n.prototype.addTileNode=function(e,t){var i=this.getChildIndex(t);this.children||(this.children=[null,null,null,null,null,null,null,null]),t.depth===this.cellCoords.depth+1?(this.children[i]?this.children[i].tileNode=e:(this.children[i]=new n({tileNode:e,cellCoords:t,tree:this.tree,parent:this}),this.childCount++),this.updateMaxDepth()):(this.children[i]||(this.children[i]=new n({tileNode:null,cellCoords:this.cellCoords.buildChildCoords(i),tree:this.tree,parent:this}),this.childCount++),this.children[i].addTileNode(e,t))},n.prototype.removeTileNode=function(e,t){if(this.children){var n=this.getChildIndex(t),i=this.children[n];i&&(t.depth===this.cellCoords.depth+1?i.tileNode=null:i.removeTileNode(e,t),0!==i.childCount||i.tileNode||(this.children[n]=null,this.childCount--,0===this.childCount&&(this.children=null),this.updateMaxDepth()))}},n.prototype.updateMaxDepth=function(){var e,t,n=0;if(this.children)for(e=0;e<this.children.length;e++)(t=this.children[e])&&t.maxDepth+1>n&&(n=t.maxDepth+1);n!==this.maxDepth&&(this.maxDepth=n,this.parent&&this.parent.updateMaxDepth())},e})),define("DS/3DXMTiles/LDHHandler",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/VisuTools/OOCReplay"],(function(e,t,n){"use strict";var i=function(e){this.type=e};i.prototype.handleReferences=function(e,t){},i.prototype.getBatchSize=function(){return 1},i.prototype.setRestricted=function(){},i.prototype.isReady=function(){return!1};var r=function(e){this.maxSize=e,this.references=[]};r.prototype.containsReference=function(e){return this.references.indexOf(e.referenceId)>=0},r.prototype.addReferenceIfPossible=function(e){return this.references.length<this.maxSize&&(this.references.push(e),!0)},r.prototype.isEmpty=function(){return 0===this.references.length},r.prototype.getSize=function(){return this.references.length},r.prototype.setReferencesLoading=function(e){var t,n,i=this.references;for(t=0;t<i.length;t++)(n=i[t]).isLoading()||n.setLoading(e)},i.prototype.handleBatch=function(e,t){this.handleReferences(e.references,t)},i.prototype.createBatch=function(){return new r(this.getBatchSize())},i.prototype.acceptsRepresentation=function(e,t){return!0},i.prototype.commitModelLoadedTransaction=function(e,t,i,r){var o=e.getActiveRepresentation();if(n.download&&n.recording&&o){let e=o.node;e&&(e.removeChildren(),i=[])}i&&i.nodes&&e.setCGRNodeNames(i.nodes,o);var s=t._ldhNodeManager;e.referenceId;e.setSSBDataFromCullingData(i&&i.cullingData||null),e.showActiveRepresentation(s),e.setRepLoaded(!0),e.isAlive()&&s.onLeafReferenceLoadedCB&&s.onLeafReferenceLoadedCB(e.referenceId,i),o.updateMeshSize(e),e.updateMemorySizeNEW(s),t._startModelLoaderTransaction(),t._onRepLoaded(e),t._endModelLoaderTransaction()};var o={red:new e.MeshPhongMaterial({color:"#ffaaaa"}),green:new e.MeshPhongMaterial({color:"#aaffaa"})},s="ON"===window.localStorage.getItem("OOCColorMode");return i.prototype.dbgSetupNodes=function(e,t){if(s&&e){var n,i=o[t];for(n=0;n<e.length;n++)e[n].traverse((function(e){if("Mesh3D"===e.getNodeType()&&e.mesh3js)for(var t=0;t<e.mesh3js.geometry.length;t++)for(var n=e.mesh3js.geometry[t],r=0;r<n.drawingGroups.length;r++){var o=n.drawingGroups[r];4===o.glType&&(o.gas=i)}}))}},i.prototype.getNodeUsage=function(){switch(this.type){case i.Model3DHandler:return t.REPRESENTATION_NODE;case i.TileSetHandler:return t.TILESET_NODE;default:return t.REFERENCE_NODE}},i.prototype.setRedirectUrlCB=function(){},i.prototype.setAutoRedirect=function(){},i.Model3DHandler=0,i.InstRefHander=1,i.TileSetHandler=2,i})),define("DS/3DXMTiles/DSTilesScreenRadiusScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],(function(e,t,n){"use strict";var i=function(e){n.apply(this,arguments)};return i.prototype=Object.create(n.prototype),n.prototype.getSortingMetric=function(){return"screenRadius"},i.prototype.computeScore=function(t,n,i){var r=t.screenRadiusCache,o=t.getBoundingSphere(),s=!1;if(o){r||(r=e.computeScreenRadiusCache(t._getWorldMatrix(),null,o,!1,!1),t.screenRadiusCache=r);var a=n.viewpoint,d=n.cst,l=a.getEyePosition().distanceTo(r.center),h=0;if(l<r.radius||0===l)return h=1/0,t.score=h,void(i&&(t.pixelError=1/0));if(s=a._frustum.performFrustumCullingNoNearFar(r.radius,r.center)){var c=e.computeScreenRadius(r,a.camera,a._frustum,d);h=c>=5?c:-1}t.score=h}else t.score=1/0;t.pixelError=i&&s?this.computePixelError(t.geometricalError,r,n):-1},i})),define("DS/3DXMTiles/DSTilesPixelErrorScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],(function(e,t,n){"use strict";var i=function(e){n.apply(this,arguments)};return(i.prototype=Object.create(n.prototype)).getSortingMetric=function(){return"pixelError"},i.prototype.computeScore=function(t,n,i){var r=t.screenRadiusCache,o=t.getBoundingSphere();if(o){r||(r=e.computeScreenRadiusCache(t._getWorldMatrix(),null,o,!1,!1),t.screenRadiusCache=r);var s=n.viewpoint,a=n.cst,d=s.getEyePosition().distanceTo(r.center),l=0,h=-1;if(d<r.radius||0===d)return l=1/0,t.score=l,void(i&&(t.pixelError=1/0));s._frustum.performFrustumCullingNoNearFar(r.radius,r.center)&&(l=e.computeScreenRadius(r,s.camera,s._frustum,a)>=5?h=this.computePixelError(t.geometricalError,r,n):-1),t.score=l,t.pixelError=h}else t.score=1/0},i})),define("DS/3DXMTiles/DSTilesJSONContent",["DS/3DXMTiles/DSTilesContent"],(function(e){"use strict";var t=function(t){e.call(this),this.json=t.json||{}};return t.prototype=Object.create(e.prototype),t})),define("DS/3DXMTiles/LDHInstRefHandler",["DS/3DXMTiles/LDHHandler"],(function(e){"use strict";var t=function(){e.call(this,e.InstRefHander)};return t.prototype=Object.create(e.prototype),t})),define("DS/3DXMTiles/DSTilesDistanceScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],(function(e,t,n){"use strict";var i=function(){};return(i.prototype=Object.create(n.prototype)).computeScore=function(t,n,i){var r=t.screenRadiusCache,o=t.getBoundingSphere(),s=!1;if(o){r||(r=e.computeScreenRadiusCache(t._getWorldMatrix(),null,o,!1,!1),t.screenRadiusCache=r);var a=n.viewpoint,d=a.getEyePosition().distanceTo(r.center),l=0;if(d<r.radius||0===d)return l=1/0,t.score=l,void(i&&(t.pixelError=1/0));(s=a._frustum.performFrustumCullingNoNearFar(r.radius,r.center))&&(l=1/d),t.score=l}else t.score=1/0;t.pixelError=i&&s?this.computePixelError(t.geometricalError,r,n):-1},i})),define("DS/3DXMTiles/DSTilesHandler",["DS/3DXMTiles/DSTilesNodeMemorySize"],(function(e){"use strict";var t=function(){};return t.prototype.isReady=function(){return!0},t.prototype.isThereEnoughMemoryToLoad=function(e,t){return!0},t.prototype.load=function(e,t){setTimeout(t.onLoadError.bind(t,e),0)},t.prototype.computeMemorySize=function(t){return new e(0,0)},t.prototype.removeRepresentation=function(e){},t})),define("DS/3DXMTiles/LDHRepresentationLoader",["DS/Visualization/ModelLoader","DS/Visualization/LoaderUtils","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHStats","DS/Visualization/PLMMaterialConnectionFactory","DS/VisuTools/OOCReplay","DS/VisuTools/Downloader","DS/3DXMTiles/ModelBank","DS/QualityManager/QMController","DS/Visualization/Node3D","DS/3DXMTiles/LDHModelLoader"],(function(e,t,n,i,r,o,s,a,d,l,h){"use strict";var c=i,u={init:function(){d.getLDHOpt2SSB()&&(this.useSSB=!0),d.getLDHOpt3Compression()&&(this.gpuPlanarFaces=!0)},statsInit:function(){c.init()},statsOnLoadedModel:function(){c.onLoadedModel()},modelLoader3dx:null,debug:!1,debugSaveToBank:!1,loadedRepresentationsBuffer:[],debugPlanarFace:!1,useSSB:!1,useSSB_showBBox:!1,compression:!1,gpuPlanarFaces:!1,setDebug:function(e){this.debug=e},_loadModel:function(e,t,n,i,r,o,s,d){if(!this.debugSaveToBank||a.nbTransactions<10)this._loadModel_internal(e,t,n,i,r,o,s,d);else{let l=setInterval((()=>{a.nbTransactions<10&&(this._loadModel_internal(e,t,n,i,r,o,s,d),clearInterval(l))}),100)}},_loadModel_internal:function(i,r,o,s,a,d,p,g){function f(e){n.endProbe("load_"+r.referenceId),c.onLoadedModel(),r.updateMemorySizeNEW(g),r=null,m.setTargetNode(null),s(S)}var m;this.debug&&(i=this.removeTag(i)),t.__storeCGRNames=0,d||(i.endsWith(".cgr")?d="cgr":i.endsWith(".3dxc")&&(d="3dxc")),"3dxc"===d?(this.modelLoader3dx||(this.modelLoader3dx=new e,this.modelLoader3dx.sharedBuffers=!1,this.modelLoader3dx.setKeepLoaderMode(!0)),m=this.modelLoader3dx):m=h.getModelLoader();var v,S=r.getActiveRepresentation(),y=r.getPrimaryRepresentation();if(r.requestBuildSceneGraphHierarchy(!0),g.tryBuildSceneGraphHierarchy(),S!==y&&S.buildNode(),v=new l,S.node){m.setSceneGraph(v),(g.newLoadingBoxes||r.isSlave())&&r.removeBox(g),a&&(m.activateSmartLoading(a.getRenderer()),m.setRenderCallback(a.render,1e3)),m.setFileType(d||"xmlv43"),(i.endsWith(".cgr")||"cgr"===d?m.setOnLoadedProductStructureCallback:m.setOnLoadedCallback).call(m,(function(e){n.endProbe("load_"+r.referenceId),c.onLoadedModel(),m.setTargetNode(null),u.addToSceneGraph(g,v,S,(()=>{o(e,S)})),r=null})),m.setOnErrorCallback(f),c.init();var M,D={filename:i,format:d||void 0,loaderSettings:{gasSharing:!0}};if(p)for(M in p)D[M]=p[M];var T={};!1,u.setupModelLoaderOptions(m,T,r,S,y,g,null),n.startProbe("load_"+r.referenceId),this.debugSaveToBank?this.debugHandleSaveToBank(m,D,T,r,S,v):this.loadRepresentation(m,D,T)}else setTimeout(f,1)},loadRepresentation:function(e,t,n){e.loadModel(t,void 0,void 0,n)},debugMassDownloader:null,debugHandleSaveToBank:function(e,t,n,i,r,o){this.debugMassDownloader||(this.debugMassDownloader=new f);let s=e.onLoadedCB,d=e.onLoadedPrdCB,l=e.onErrorCB;this.debugMassDownloader.download(t.filename,(function(t){a.storeModelData([i.referenceId],[r.type],"DEBUG",[t],[r.wms]),e.onLoadedCB=s,e.onLoadedPrdCB=d,e.onErrorCB=l,e.loadModelFromBuffer(t,o,n)}),l)},setupModelLoaderOptions:function(e,t,n,i,a,d,l){if(l&&o.download){let t=e.onLoadedPrdCB,i=new ArrayBuffer(l.byteLength);new Uint8Array(i).set(new Uint8Array(l)),e.onLoadedPrdCB=()=>{s.download({filename:n.referenceId+".cgr",data:i,group:!0,onEndCB:()=>{t()}})}}var h=!1,c=!1,g=d.oocManager.getDefaultLoadModelOptions(),f=void 0;g&&(g.CGRWithSG&&(h=!0),g.CGRWithBlanking&&(c=!0),void 0!==g.noMeshInRAM&&(f=g.noMeshInRAM)),r.hasInternalPath(n.referenceId)&&(h=!0);var m=!1;n.isLegacyUV()&&(m=!0);var v,S=n.getLoadModelOptions();if(S)for(v in S)"CGRWithSG"===v?h=!!S[v]:"CGRWithBlanking"===v?c=!!S[v]:"noMeshInRAM"===v&&void 0!==S[v]?f=!!S[v]:"applicativeContainers"===v&&S[v]&&(t[v]=p(S[v]),t[v]&&(t[v].applicativeContainersNode=a.node));let y=n.getSSBLimitRadius();i.isPR()&&u.useSSB&&y>0?(t.OOCSmartStaticInfo={radius:y,showBBox:!!u.useSSB_showBBox},n.setSSBRadius(y)):n.setSSBRadius(0),u.compression&&(t.keepCompression=!0),void 0!==f||i.noMeshInRAM,void 0!==f&&i.forceMeshInRAM(!f),e.setAccelerationStructure(d.oocManager.getUsePickingAccelerationStructure()),e.setCGRWithBlanking(c),e.setCGRWithSG(h),e.setOOCLoader(!0),e.setNoMeshInRAM(n.getActiveRepresentation().noMeshInRAM),e.useDefaultTCSet=m,e.setGPUPlanarFaces(this.gpuPlanarFaces||this.debugPlanarFace)},removeTag:function(e){var t=e.indexOf("#");if(t>=0){var n=e.lastIndexOf(".");return e.substring(0,t)+e.substring(n)}return e},flushLoadingBuffer:function(){let e;for(e=0;e<this.loadedRepresentationsBuffer.length;e++)this.loadedRepresentationsBuffer[e].addToSceneGraph();this.loadedRepresentationsBuffer.length=0},addToSceneGraph(e,t,n,i){let r=new g(t,n,i);e.authorizeRepresentationLoading?r.addToSceneGraph():this.loadedRepresentationsBuffer.push(r)}};function p(e){var t,n={};for(t in e)n[t]=e[t];return n}class g{constructor(e,t,n){this.targetNode=e,this.representation=t,this.onLoadedCB=n}addToSceneGraph(){let e=this.representation.node;if(e&&e!==this.targetNode){let t,n=this.targetNode.children.concat([]);for(this.targetNode.removeChildren(),this.targetNode=null,t=0;t<n.length;t++)e.addChild(n[t])}this.onLoadedCB()}}class f{constructor(){this.fifoRequests=[],this.nbTickets=6}download(e,t,n){this.fifoRequests.push({url:e,onRequestComplete:t,onError:n}),this.downloadNext()}downloadNext(){if(this.fifoRequests.length>0&&this.nbTickets>0){this.nbTickets--;let e=new XMLHttpRequest,t=this.fifoRequests.shift();e.responseType="arraybuffer",e.onload=()=>{if(4===e.readyState){if(200===e.status){var n=e.response;t.onRequestComplete(n)}else t.onError();this.nbTickets++,this.downloadNext()}},e.onerror=()=>{t.onError(),this.downloadNext()},e.open("GET",t.url,!0),e.send(null)}}}return u})),define("DS/3DXMTiles/DSTilesContentLoader",["DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/DSTilesSourceIdWithParams"],(function(e,t){"use strict";var n=function(e){this.budget=null,this.tilesManager=e.tilesManager};n.prototype.init=function(){this.budget||(this.budget=this.tilesManager.memoryManager.createBudget(this.getBudgetParams()))},n.prototype.getBudget=function(){return this.budget},n.prototype.isNodeVisible=function(e,t){return!0};var i=[new t("default",null)];return n.prototype.getSourceIdWithParamsArray=function(e){return e.sourceId?[new t(e.sourceId,null)]:i},n.prototype.isReady=function(){return!0},n.prototype.isThereEnoughMemoryToLoad=function(e,t){},n.prototype.loadContentFromBuffer=function({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,params:o}){setTimeout(r,0)},n.prototype.loadContentFromExistingData=function(e,t,n,i,r){setTimeout(r,0)},n.prototype.invalidateContentToken=function(e,t,n){},n.prototype.computeMemorySize=function(t,n){return new e(0,0)},n.prototype.showContent=function(e,t){},n.prototype.hideContent=function(e,t){},n.prototype.deleteContent=function(e,t,n){},n.prototype.exportContent=function(e,t){},n.prototype.onContentMetaDataUpdate=function(e){},n.prototype.needsSgNodePerContent=function(){return!1},n.prototype.setTileSetVisibility=function(e){},n.prototype.hasExistingData=function(e,t,n){return!1},n.prototype.onStartLoading=function(e,t,n){},n.prototype.needsDownload=function(){return!0},n.prototype.getURIPostFix=function(e,t){return null},n.prototype.createUpdatedContentTokenFromContentToken=function(e,t){return!1},n.prototype.getAttributeValues=function(e,t,n){return null},n.prototype.getAllAttributes=function(e,t){return null},n})),define("DS/3DXMTiles/DSTilesNode",["DS/3DXMTiles/DSTilesNodeStatus","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesNodeMemorySize","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/3DXMTiles/DSTilesWorldPosition","DS/Visualization/PathElement"],(function(e,t,n,i,r,o,s,a){"use strict";var d=1,l=2,h=4,c=8,u={matrixUpdate:1,descendantMatrixUpdate:2,onHold:4,childrenOnHold:8,descendantToUnload:16,contentVisible:32,wished:64,toUnload:128,noWishedUnder:256,noVisibleUnder:512,dead:1024,noContent:2048},p=0;class g{constructor(t){g.sgNodeToTilesNode||(g.sgNodeToTilesNode=new WeakMap),this.id=p++,this.tileSet=t.tileSet,this.uri=t.uri,this.handler=null,this.expander=t.expander||null,this.childrenURIs=t.childrenURIs||[],this.childrenEtags=t.childrenEtags||null,this.children=null,t.childrenURIs&&0===t.childrenURIs.length&&(this.children=[]),this.parent=t.parent||null,this.mode=t.mode||g.Mode.add,this.scoreComputer=t.scoreComputer||null,this.score=-2,this.pixelError=-1,this.occlusionStatus=-2,this.matrix=t.matrix||null,this.worldPosition=new s,t.worldMatrix&&(this.worldPosition.matrixArray[0]=t.worldMatrix),this._boundingSphere=t.boundingSphere||null,this._boundingBox=t.boundingBox||null,this.geometricalError=t.geometricalError||0,this.contentSet=t.contentSet||null,this.contentLoaders=this.contentSet?this.contentSet.getContentLoaders():null,this._contentStatus=this.contentSet?e.waiting:e.loaded,this._expandStatus=this.childrenURIs.length>0?e.waiting:null,this.flags=0,this.sgNode=null,this.inListStatus=0,this.screenRadiusCache=null,this.distanceToBoxCache=null,this.lastUpdateIndex=-1,this.memorySize=new n,this.isLODMode()&&this.setChildrenOnHold(!0),this.queue=t.queue||null,this._debugBBox=null,this.lockLoadDate=0,this.unloadLock=0,this.descendantLocked=0,this.userData=t.userData,this.metaData_deprecated=t.metaData_deprecated,this.triggerMetric=t.triggerMetric||"pixelError"}computeScore(e,t){e>this.lastUpdateIndex&&(this.lastUpdateIndex=e,this.scoreComputer.computeScore(this,t,this.isLODMode()))}getScore(){return this.score}lockUnload(){this.unloadLock++;for(var e=this.parent;e;)e.descendantLocked=1,e=e.parent}unlockUnload(){this.unloadLock--;for(var e=this.parent;e;)e.descendantLocked=-1,e=e.parent}isUnloadLocked(){return this.unloadLock>0}updateDescendantLocked(){var e;if(-1===this.descendantLocked&&(this.descendantLocked=0,this.children))for(e=0;e<this.children.length;e++){var t=this.children[e];t.updateDescendantLocked(),(t.isUnloadLocked()||t.descendantLocked)&&(this.descendantLocked=1)}}getTriggerMetric(){return this.triggerMetric}getSortingMetric(){return this.tileSet.getSortingMetric()}isMorePrioritaryThan(e){return this.score>e.score}isLessPrioritaryThan(e){return this.score<e.score}isLeaf(){return!(this.childrenURIs&&this.childrenURIs.length>0)}isLODMode(){return this.mode===g.Mode.replaceLOD||this.mode===g.Mode.addLOD}isReplaceLODMode(){return this.mode===g.Mode.replaceLOD}isAddLODMode(){return this.mode===g.Mode.addLOD}needsSgNode(){return null!==this.matrix||this.contentSet&&this.contentSet.needsSgNode()}setSgNode(e){this.sgNode=e,g.sgNodeToTilesNode.set(e,this),e.setMatrix(this.matrix)}updateWorldPositionFromSgNode(){let e=this.getSgNode();e&&this.worldPosition.setFromOccurrences(e._occurrences)}buildSgNode(){null===this.sgNode&&(this.needsSgNode()?(this.sgNode=new i,g.sgNodeToTilesNode.set(this.sgNode,this),this.sgNode.setUserData({dsTilesNode:this}),this.matrix&&this.sgNode.setMatrix(this.matrix),this.parent&&(this.parent.buildSgNode(),this.parent.sgNode.addChild(this.sgNode))):this.parent&&(this.sgNode=this.parent.getSgNode()))}hasChildren(){return!!(this.children&&this.children.length>0)}getSgNode(){return this.buildSgNode(),this.sgNode}addChild(e,t){if(null!==e.parent)throw new Error("node already has a parent");null===this.children&&(this.children=[]),e.getDescendantToUnload()&&this.setDescendantToUnload(!0),void 0===t?this.children.push(e):this.children[t]=e,e.parent=this,e.setMatrixUpdate(!0),this.traverse((function(e){var t=!1;return e.getMatrixUpdate()?t=!0:e.setMatrixUpdate(!0),t})),(this.getChildrenOnHold()||this.getOnHold())&&e.setOnHoldTree(),this.getRoot()._dbgCheckConsistency()}setOnHoldTree(e){var t=this;this.traverse((function(n){if(n.setChildrenOnHold(!0),n!==t||!e)return n.parent&&n.setDescendantToUnload(!0),!!n.getOnHold()||(n.hideContent(),n.setOnHold(!0),!1)}))}activateChildren(e){if(this.children){var t,n;for(t=0;t<this.children.length;t++)(n=this.children[t]).getOnHold()&&(n.setOnHold(!1),e.registerDSTilesNode(n,!0));this.setChildrenOnHold(!1)}}updateWorldMatrix(e,t){if(e){var n=this.getMatrixUpdate()||t;if(n&&(this.parent?this.worldPosition.update(this):this.updateWorldPositionFromSgNode(),this.screenRadiusCache=null,this.distanceToBoxCache=null,this.setMatrixUpdate(!1)),n||this.getDescendantMatrixUpdate()){var i;if(this.children)for(i=0;i<this.children.length;i++)this.children[i]&&this.children[i].updateWorldMatrix(!0,!!n);this.setDescendantMatrixUpdate(!1)}}else{for(var r=this;r.parent;)r=r.parent;r.updateWorldMatrix(!0)}}_getWorldMatrix(){return this.worldPosition.matrixArray[0]}getWorldBoundingSphere(){this.updateWorldMatrix();var e=this.getBoundingSphere().clone();return e.applyMatrix4(this._getWorldMatrix()),e}getOccurrencesWorldBoundingSphere(){this.updateWorldMatrix();var e,n=null;for(e=0;e<this.worldPosition.matrixArray.length;e++){var i=this.getBoundingSphere();n=t.mergeBoundingSphereInto(n,i,this.worldPosition.matrixArray[0],0)}return n}setInList(e){this.inListStatus=e?this.inListStatus|d:this.inListStatus&65535-d}isInList(){return!!(this.inListStatus&d)}isInToBeLoaded(){return!!(this.inListStatus&l)}setInToBeLoaded(e){this.inListStatus=e?this.inListStatus|l:this.inListStatus&65535-l}isInUnload(){return!!(this.inListStatus&h)}setInUnload(e){this.inListStatus=e?this.inListStatus|h:this.inListStatus&65535-h}isInToExpand(){return!!(this.inListStatus&c)}setInToExpand(e){this.inListStatus=e?this.inListStatus|c:this.inListStatus&65535-c}getMatrixUpdate(){return!!(this.flags&u.matrixUpdate)}setMatrixUpdate(e){e?(this.flags=this.flags|u.matrixUpdate,this.parent&&this.parent.setDescendantMatrixUpdate(!0)):this.flags=this.flags&65535-u.matrixUpdate}getDescendantMatrixUpdate(){return!!(this.flags&u.descendantMatrixUpdate)}setDescendantMatrixUpdate(e){e?(this.flags=this.flags|u.descendantMatrixUpdate,this.parent&&!this.parent.getDescendantMatrixUpdate()&&this.parent.setDescendantMatrixUpdate(!0)):this.flags=this.flags&65535-u.descendantMatrixUpdate}checkConsistency(){if(this.parent&&this.parent.getChildrenOnHold()&&!this.getOnHold())throw new Error("inconsistency!!");var e;for(e=0;this.children&&e<this.children.length;e++)this.children[e].checkConsistency()}getDead(){return!!(this.flags&u.dead)}setDead(t){this.flags=this.flags|u.dead,t.registerDSTilesNode(this,!0),this._contentStatus=e.dead,this._expandStatus=e.dead}getOnHold(){return!!(this.flags&u.onHold)}setOnHold(e){this.flags=e?this.flags|u.onHold:this.flags&65535-u.onHold}getNoContent(){return!!(this.flags&u.noContent)}setNoContent(e){this.flags=e?this.flags|u.noContent:this.flags&65535-u.noContent}getChildrenOnHold(){return!!(this.flags&u.childrenOnHold)}setChildrenOnHold(e){this.flags=e?this.flags|u.childrenOnHold:this.flags&65535-u.childrenOnHold}getDescendantToUnload(){return!!(this.flags&u.descendantToUnload)}setDescendantToUnload(e){e?(this.flags=this.flags|u.descendantToUnload,this.parent&&!this.parent.getDescendantToUnload()&&this.parent.setDescendantToUnload(!0)):this.flags=this.flags&65535-u.descendantToUnload}getToUnload(){return!!(this.flags&u.toUnload)}setToUnload(e){e?(this.flags=this.flags|u.toUnload,this.parent&&!this.parent.getDescendantToUnload()&&this.parent.setDescendantToUnload(!0)):this.flags=this.flags&65535-u.toUnload}getWished(){return!!(this.flags&u.wished)}setWished(e){this.flags=e?this.flags|u.wished:this.flags&65535-u.wished}getNoWishedUnder(){return!!(this.flags&u.noWishedUnder)}setNoWishedUnder(e){this.flags=e?this.flags|u.noWishedUnder:this.flags&65535-u.noWishedUnder}getNoVisibleUnder(){return!!(this.flags&u.noVisibleUnder)}setNoVisibleUnder(e){this.flags=e?this.flags|u.noVisibleUnder:this.flags&65535-u.noVisibleUnder}getContentVisible(){return!!(this.flags&u.contentVisible)}setContentVisible(e){this.flags=e?this.flags|u.contentVisible:this.flags&65535-u.contentVisible}traverseParents(e){!e(this)&&this.parent&&this.parent.traverseParents(e)}traverse(e){var t;if(!e(this)&&this.children)for(t=0;t<this.children.length;t++)this.children[t]&&this.children[t].traverse(e)}traverseBreadthFirst(e){var t,n=[this],i=0;for(i=0;i<n.length;i++){let r=n[i];if(!e(r)&&r.children)for(t=0;t<r.children.length;t++)n.push(r.children[t]);n[i]=null}n=null}traverseChildren(e){var t;if(this.children)for(t=0;t<this.children.length;t++)this.children[t]&&this.children[t].traverse(e)}hasContent(){return null!==this.contentSet}hasContentToken(){if(this.contentSet){let e;for(e=0;e<this.contentSet.contents.length;e++){if(this.contentSet.contents[e].contentToken)return!0}}return!1}invalidateContentTokens(){this.contentSet&&this.contentSet.invalidateContentTokens(this)}getBoundingBox(){if(!this._boundingBox){var e=this._boundingSphere;if(!e)return null;var n=new t.Box3;n.min.x=e.center.x-e.radius,n.min.y=e.center.y-e.radius,n.min.z=e.center.z-e.radius,n.max.x=e.center.x+e.radius,n.max.y=e.center.y+e.radius,n.max.z=e.center.z+e.radius,this._boundingBox=n}return this._boundingBox}getBoundingSphere(){return this._boundingSphere?this._boundingSphere:this._boundingBox?(this._boundingBox.getBoundingSphere(f),f):null}isContentToLoad(){return this._contentStatus===e.toLoad}isContentLoaded(){return this._contentStatus===e.loaded}isContentLoading(){return this._contentStatus===e.loading}isContentWaiting(){return this._contentStatus===e.waiting}isExpandToLoad(){return this._expandStatus===e.toLoad}isExpandLoaded(){return this._expandStatus===e.loaded}isExpandLoading(){return this._expandStatus===e.loading}isExpandWaiting(){return this._expandStatus===e.waiting}isAlive(){return!this.getDead()}isLoading(){return this._contentStatus===g.loading||this._expandStatus===g.loading}isError(){return this._contentStatus===e.error||this._expandStatus===e.error}isWaiting(){return!(null!==this._contentStatus&&this._contentStatus!==e.waiting||null!==this._expandStatus&&this._expandStatus!==e.waiting)}hasExpand(){return null!==this._expandStatus}setContentStatus(t,n){if(null!==this._contentStatus){var i=this._contentStatus,r=i!==t;if(this._contentStatus=t,r){var o=!0;i===e.waiting&&t===e.toLoad&&(o=!1),t===e.toLoad&&this.tileSet.setNodeStartLoading(),n.registerDSTilesNode(this,o)}this.getRoot()._dbgCheckConsistency()}}setExpandStatus(t,n){if(null!==this._expandStatus){var i=this._expandStatus,r=i!==t;if(this._expandStatus=t,r){var o=!0;i===e.waiting&&t===e.toLoad&&(o=!1),t===e.toLoad&&this.tileSet.setNodeStartExpanding(),n.registerDSTilesNode(this,o)}this.getRoot()._dbgCheckConsistency()}}passVisibilityTest(){if(1===this.descendantLocked||this.isUnloadLocked())return!0;if(this.score>0){if(this.contentSet){let e=0,t=!1;for(e=0;e<this.contentSet.contents.length;e++){let n=this.contentSet.contents[e];n.contentLoader.isNodeVisible(this,n)&&(t=!0)}return t}return!0}return!1}passPixelErrorTest(){return 1!==this.descendantLocked&&(this.pixelError>=0&&this.pixelError<this.tileSet.getMaxPixelError())}showContent(){this.contentSet?!this.getContentVisible()&&this.contentSet.showContent(this)&&(this.setContentVisible(!0),this.updateSelection()):this.setContentVisible(!0)}hideContent(){this.contentSet?this.getContentVisible()&&this.contentSet.hideContent(this)&&this.setContentVisible(!1):this.setContentVisible(!1)}deleteContentTree(){let e,t,n=this.queue;for(e=0;e<this.children&&this.children.length;e++)t=this.children[e],t.deleteContentTree(n);this.hideContent(),this.deleteContent(n)}deleteContent(t){this.contentSet&&this.contentSet.deleteContent(this)&&(this.setContentVisible(!1),this.setContentStatus(e.waiting,t))}getRoot(){for(var e=this;e.parent;)e=e.parent;return e}addToHSO(e){if(e||o.empty(),this.handler)this.contentSet&&this.contentSet.addToHSO();else if(this.children){var t;for(t=0;t<this.children.length;t++)this.children[t].addToHSO(!0)}}checkVisibilityConsistency(){this.getContentVisible()?this.traverseChildren((e=>{if(e.getContentVisible())throw new Error("content visible inconsistency")})):this.traverseChildren((e=>{e.checkVisibilityConsistency()}))}_dbgCheckConsistency(){}_dbgCheckOnHoldConsistency(){this.traverse((function(e){if(e.parent&&!e.getOnHold()&&e.parent.getChildrenOnHold())throw new Error("Inconsistency!!!")}))}tryUnload(e){var t,n,i=[];for(this._dbgCheckConsistency(),this.tryUnload_internal(i,e),t=0;t<i.length;t++)(n=i[t].parent)&&n.setDescendantToUnload(!0);this.queue.cleanLists(),this._dbgCheckConsistency()}isUnloading(){if(this.contentLoaders){let t,n=!1;for(t=0;t<this.contentLoaders.length;t++){let i=this.contentLoaders[t];var e=i&&i.getBudget();e&&!e.unloading||(n=!0)}return n}return!0}isContentLoadingAllowed(){let e,t=!0;if(this.contentLoaders)for(e=0;e<this.contentLoaders.length;e++){let i=this.contentLoaders[e];var n=i&&i.getBudget();n&&n.isLoadingAllowed()||(t=!1)}else t=!1;return t}isExpandLoadingAllowed(){return!0}tryUnload_internal(e,t){var n=this.hasChildren()&&(this.getDescendantToUnload()||this.getChildrenOnHold()),i=!1,r=this.isUnloadLocked(),o=!r&&(this.getToUnload()||this.getOnHold())&&this.isUnloading(t);if(this.isWaiting())this.setToUnload(!1),i=!r;else if(o||n)if(this.isLoading())i=!1;else{var s,a=!0;if(this.children){let n=0;for(s=0;s<this.children.length;s++)this.children[s].tryUnload_internal(e,t)?n++:a=!1;n>0&&this.children.length}a?(this.setDescendantToUnload(!1),o&&(this.doUnload(),i=!0)):i=!1}else i=!1;return o&&!i&&e.push(this),i}doUnload(){var t=this.queue;if(this.handler&&this.getRepLoaded()&&this.handler.removeRepresentation(this),this.deleteContent(t),this.children&&this.children.length>0){var n,i;for(n=0;n<this.children.length;n++)(i=this.children[n]).setDead(t),i.tileSet.removeNode(i.uri),i.parent=null;this.children=null}this.setToUnload(!1),this.setExpandStatus(e.waiting,t),this.sgNode&&this.parent&&(this.parent.sgNode.removeChild(this.sgNode),this.sgNode=null)}destroy(){if(this.children&&this.children.length>0){var e;for(e=0;e<this.children.length;e++)this.children[e].destroy();this.children=null}var t=this.queue;this.handler&&this.getRepLoaded()&&this.handler.removeRepresentation(this),this.deleteContent(t),this.children=null,this.setDead(t),this.sgNode&&this.parent&&this.parent.sgNode.removeChild(this.sgNode),this.sgNode=null,this.parent=null}traverseUpdateNodes(e){if(!this.getOnHold()||this.descendantLocked){var t,n=!1,i=[],r=this.tileSet.progressiveMode;for(this.traverseBreadthFirst((e=>{var t=!1;if(e.passVisibilityTest()){e.setNoWishedUnder(!1);var o=!1;e.isAddLODMode()?o=!0:!e.passPixelErrorTest()&&e.hasChildren()||(o=!0);var s=e.isAddLODMode();r&&e.startLoading(s),o?(e.setWished(!0),r||e.startLoading(s)&&(n=!0),e.isReplaceLODMode()&&(e.traverseChildren((t=>!(!t.getNoWishedUnder()||e.getChildrenOnHold())||(t.setNoWishedUnder(!0),t.setWished(!1),t.setOnHold(!0),t.setChildrenOnHold(!0),!1))),e.setChildrenOnHold(!0),t=!0),e.isAddLODMode()&&e.passPixelErrorTest()&&(e.traverseChildren((t=>!(!t.getNoWishedUnder()||e.getChildrenOnHold())||(n=!0,t.hideContent(),t.setNoWishedUnder(!0),t.setWished(!1),t.setOnHold(!0),t.setChildrenOnHold(!0),!1))),e.setChildrenOnHold(!0),t=!0)):e.setWished(!1)}else e.getNoWishedUnder()||(i.push(e),t=!0);return t})),t=0;t<i.length;t++)i[t].setNoWishedUnder(!0),i[t].traverse((e=>{e.setNoWishedUnder(!0),e.setWished(!1)}));n&&e.render(),!g.DBGUnloadSmallNodes&&this.isReplaceLODMode()&&this.traverseReplace(e)}}traverseReplace(e){if(!this.getOnHold())if(this.tileSet.progressiveMode)this.traverseReplaceProgressive(e);else{var t=!1;this.traverse((e=>{var n=!1;if(e.passVisibilityTest()){if(e.getContentVisible()&&!e.getWished()){var i,r=!0,o=[];if(e.traverse((e=>{if(e.getWished())return e.isContentLoaded()||(r=!1),o.push(e),!0})),r&&o.length>0)for(t=!0,e.hideContent(),i=0;i<o.length;i++)o[i].showContent();n=!0}e.getWished()&&(e.isContentLoaded()&&!e.getContentVisible()&&(t=!0,e.showContent(),e.traverseChildren((e=>{e.hideContent()}))),n=!0)}return n})),t&&e.render()}}traverseReplaceProgressive(e){if(this.parent)throw new Error("unexpected");var t=new Set,n=new Set,i=new Set,r=this.parent?this.parent:this,o=!1;r.traverseReplaceProgressive_internal(t,n,i),t.forEach((e=>{e.showContent(),o=!0,e.traverseChildren((e=>{var t=!1;return e.getNoVisibleUnder()&&(t=!0),e.setNoVisibleUnder(),e.getContentVisible()&&e.hideContent(),t}))})),n.forEach((e=>{e.hideContent(),o=!0})),i.forEach((e=>{e.traverse((e=>{var t=!1;return e.getNoVisibleUnder()&&(t=!0),e.getContentVisible()&&(o=!0,e.hideContent()),t}))})),o&&e.render({budgeted:!0})}traverseReplaceProgressive_internal(e,t,n){if(this.setNoVisibleUnder(!1),this.hasContent()&&!this.getContentVisible()&&e.add(this),!this.passPixelErrorTest()&&this.children){var i,r,o=!0,s=!1;for(i=0;i<this.children.length;i++)(r=this.children[i]).passVisibilityTest()&&(s=!0,r.isContentLoaded()||(o=!1));if(this.hasContent()&&!o||!s)for(i=0;i<this.children.length;i++)r=this.children[i],n.add(r);else for(e.delete(this),this.hasContent()&&this.getContentVisible()&&t.add(this),i=0;i<this.children.length;i++)(r=this.children[i]).passVisibilityTest()?r.traverseReplaceProgressive_internal(e,t,n):n.add(r)}else if(this.children)for(i=0;i<this.children.length;i++)r=this.children[i],n.add(r)}startLoading(t){var n=this.queue,i=this,r=!1;return i.hasContent()&&!i.isError()&&(i.isContentLoaded()?t&&(i.showContent(),r=!0):i.hasContent()&&!i.isContentLoading()&&(i.setContentStatus(e.toLoad,n),i.isInToBeLoaded()||(n.nodesToLoadQueue.addNode(i),i.setInToBeLoaded(!0)))),r}exportContent(){return this.hasContent()&&this.isContentLoaded()&&this.contentSet?this.contentSet.exportContent(this):null}getDistanceToBoxCache(){return this.scoreComputer?this.scoreComputer.getDistanceToBoxCache(this):null}showBox(){v||(v=new i,window.debugWebGLV6Viewer.addNode(v));var e=this.getBoundingBox();v.removeChildren();var t=r.createCuboidNodeFromBox3(e,m),n=this._getWorldMatrix();n&&t.setMatrix(n),v.addChild(t),window.debugWebGLV6Viewer.render()}onTileSetContentMetaDataUpdate(){this.traverse((e=>{if(e.contentLoaders){let t;for(t=0;t<e.contentLoaders.length;t++)e.contentLoaders[t].onContentMetaDataUpdate(e)}}))}getContentFileSize(){var e=0;return this.contentSet&&(e=this.contentSet.getFileSize()),e}getSourcesWithContents(e){return this.contentSet?this.contentSet.getSourcesWithContents(this,e):null}getSourceWithContents(e){return this.contentSet?this.contentSet.getSourceWithContents(e,this):null}hasContentType(e){return!!this.contentSet&&this.contentSet.hasContentType(e)}getContentUris(){return this.contentSet?this.contentSet.getUris():null}getContentSpec(){return this.contentSet?this.contentSet.getSpec():null}getContentFromContentLoader(e){return this.contentSet?this.contentSet.getContentFromContentLoader(e):null}getStyling(){return this.tileSet.styling||null}getAttributeValue(e,t){return this.getContentVisible()?this.contentSet.getAttributeValue(e,t):null}getAllAttributes(e){return this.getContentVisible()?this.contentSet.getAllAttributes(e):null}getPathElementsLeadingToAttribute(e,t,n){if(!this.getContentVisible())return null;let i=this.tileSet.getRootNode().getSgNode(),r=[],o=this.sgNode;if(o&&i){for(;o&&o!==i;)r.push(o),o=o.parents[0];let s;for(s=0;s<r.length;s++){let e=r[s],t=r.length-s-1;if(!(s<t))break;r[s]=r[t],r[t]=e}let a=n.concat(r);return this.contentSet.getPathElementsLeadingToAttribute(e,t,a)}return null}updateSelection(){let e=this.tileSet.getTilesManager().selectionManager;e&&e.updateTileNodeSelection(this)}}g.getTileNodeFromPathElement=function(e){if(!e)return null;let t=function e(t){let n,i=g.sgNodeToTilesNode&&g.sgNodeToTilesNode.get(t);for(n=0;!i&&n<t.parents.length;n++)i=e(t.parents[n]);return i}(e.getLastElement(!0));return t};var f=new t.Sphere,m=t.MaterialUtils.createShinyFaceMaterial({color:"blue",transparent:!0,opacity:.2,force:!0}),v=null;return Object.defineProperty(g.prototype,"flagsStr",{get:function(){var e,t=null;for(e in u)this.flags&u[e]&&(null===t?t="":t+=" ",t+=e);return t},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(g.prototype,"metaData",{get:function(){throw new Error("metaData get")},set:function(){throw new Error("metaData set")}}),g.sgNodeToTilesNode=null,g.Mode={add:"add",addLOD:"addLOD",replaceLOD:"replaceLOD"},g.PlusInfinity=new g({}),g.PlusInfinity.score=1/0,g.PlusInfinity.priority=1/0,g.MinusInfinity=new g({}),g.MinusInfinity.score=-1/0,g.MinusInfinity.priority=-1/0,g})),define("DS/3DXMTiles/DSTilesStylingRender",["DS/3DXMTiles/ParsingStatus","DS/Visualization/ThreeJS_DS","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,n){"use strict";class i{constructor(){}addNeededAttributesToSet(e){throw new Error("missing implementation")}buildShaderCode(e){throw new Error("missing implementation")}buildShaderGlobalCode(e){return null}fillGraphicAttributes(e,t){throw new Error("missing implementation")}}return i.createFromJSON=function(e,t,n){let i,r=null;for(i=0;i<n.length&&!r;i++){let t=n[i];e.type===t.jsonType&&(r=t)}if(!r)return t.setError("Unknown render type","render"),null;let o=new r,s=o.setFromJSON(e);return s.isOk()||(o=null),t.copy(s),o},i.toShaderColor=function(e,i,r,o){o.variableHandler;const s=o.functionHandler,a=o.pdsfxDefines;let d=new t.Color(e),l=`${i()}(${r()}(${d.r}), ${r()}(${d.g}), ${r()}(${d.b}))`;return a.gammaInput?`${h="convertToLinear",c="v3",u=[s.prmV3(l)],n.FunctionHandler.callFunction(h,c,u)}`:l;var h,c,u},i})),define("DS/3DXMTiles/DSTilesStylingFilterOperatorParser",["DS/3DXMTiles/ParsingStatus"],(function(e){"use strict";return{filterClasses:[],setFilterClasses:function(e){this.filterClasses=e},parse:function(t){let n,i=this.filterClasses,r=null;for(n=0;n<i.length&&!r;n++){let e=i[n];t.hasOwnProperty(e.majorProperty)&&(r=e)}let o=null,s=null;if(r){let e=new r;o=e.setFromJSON(t),o.isOk()&&(s=e)}else o=e.error("Unknown filter","filter");return{status:o,operator:s}}}})),define("DS/3DXMTiles/LDHReferenceRep",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHHandler","DS/Visualization/BufferGPUManager","DS/3DXMTiles/3DXMTilesUtils"],(function(e,t,n,i,r){"use strict";var o=-10,s=0,a=10,d=function(e){e=e||{},this.node=null,this.meshSize=-1,this.src=e.url||e.src||null,this.meshInRAMStatus=s,this.active=!1,this.type=e.type,this.nextRep=null,this.wms=e.wms||0};return d.prototype.clone=function(){var e=new d;return e.src=this.src,e.wms=this.wms,e.type=this.type,e},d.prototype.setWMS=function(e){this.wms=e||0},d.prototype.setSrc=function(e){this.src=e},d.prototype.setUrlAndType=function(e,t){this.src=e,this.type=t},d.prototype.updateUrl=function(e){this.src=e},d.prototype.equals=function(e){return this.src===e.src&&this.noMeshInRAM===e.noMeshInRAM&&this.wms===e.wms},d.prototype.hasMeshInRAM=function(){return this.meshInRAMStatus>0},d.prototype.copyMissingParams=function(e){e&&(null===this.src&&(this.src=e.src),0===this.wms&&(this.wms=e.wms),this.meshInRAMStatus===s&&(this.meshInRAMStatus=e.meshInRAMStatus))},d.prototype.forceMeshInRAM=function(e){this.meshInRAMStatus=e?a:o},d.prototype.setMeshInRAM=function(e){this.meshInRAMStatus=e?a:o},d.prototype.isPartiallyDefined=function(){return null===this.src||this.meshInRAMStatus===s},d.prototype.isClearMeshInRAMOnly=function(e){return!!(e&&e.meshInRAMStatus<0&&e.src===this.src&&this.meshInRAMStatus>0&&e.wms===this.wms)},d.prototype.buildNode=function(){return this.node||(this.node=new e),this.node},d.prototype.getJSON=function(){return{src:this.src,meshInRAM:!this.noMeshInRAM}},d.prototype.clearMeshInRAM=function(){this.node&&this.node.traverse((function(e){e instanceof t&&e.forceNoMeshInRAM()})),this.meshInRAMStatus>0&&(this.meshInRAMStatus*=-1)},d.prototype.getMeshSize=function(){return-1!==this.meshSize?this.meshSize:0},d.prototype.updateMeshSize=function(e){var t=0;this.node&&this.node.children.length>0&&e.handler.type===n.Model3DHandler&&(t=r.computeMeshSize(this.node)),this.meshSize=t},d.prototype.isAV1=function(){return this.type===d.RepType.av1},d.prototype.isPR=function(){return this.type===d.RepType.pr},d.prototype.getSrc=function(){return this.src},Object.defineProperty(d.prototype,"noMeshInRAM",{get:function(){return this.meshInRAMStatus<0},set:function(){throw new Error("patata")}}),Object.defineProperty(d.prototype,"url",{get:function(){return this.src},set:function(e){this.src=e}}),d.RepType={none:"RepType##NONE",av1:"RepType##AV1",pr:"RepType##PR",rr:"RepType##RR"},d})),define("DS/3DXMTiles/DSTilesStylingValue",["DS/3DXMTiles/ParsingStatus"],(function(e){"use strict";class t{constructor(){this.isAttribute=!1,this.attribute=null,this.value=null}setAttribute(e){this.isAttribute=!0,this.attribute=e}setValue(e){this.isAttribute=!1,this.value=e}getValue(e){return this.isAttribute?e?e.getValue(this.attribute):null:this.value}}return t.parseFromJSON=function(n,i){if(!n)return i.push(e.error("Missing operand")),null;let r=null;if(n.attribute){if(!e.isStylingAttributeName(n.attribute))return i.push(e.error(`Illegal attribute name ${n.attribute}`)),null;r=new t,r.setAttribute(n.attribute)}if(n.value){if(r)return i.push(e.error("Cannot have both value and attribute")),null;r=new t,r.setValue(n.value)}return r||i.push(e.error("illegal operand")),r},t})),define("DS/3DXMTiles/LDHZipHandler",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHModelLoader","DS/3DXMTiles/ModelBank"],(function(e,t,n,i,r,o){"use strict";var s=function(e,n){t.call(this,t.Model3DHandler),this.manager=null,this.nbTickets=1,this.nbLoading=0,this.maxBatchSize=1,this.unzipLib=e.unzipLib||"zipjs2",this.loadModelCB=e.loadModelCB||this.CGRLoadCB.bind(this)};(s.prototype=Object.create(t.prototype)).isReady=function(){return this.nbLoading<this.nbTickets},s.prototype.handleReference=function(e,t){this.manager=t.manager._ldhNodeManager;var n=this.manager;e.requestBuildSceneGraphHierarchy(!0),n.tryBuildSceneGraphHierarchy();var i=e.getActiveRepresentation();i!==e.getPrimaryRepresentation()&&i.buildNode();var r=i.node;this.nbLoading++;var o,s=this.onModelLoaded.bind(this,e,t),a=this.onModelError.bind(this,e,t),d=i.src.zipArchive,l=i.src.path;"zipjs2"===this.unzipLib?(o=d.find(l))?o.getUint8Array().then((e=>{this.loadModelCB({targetNode:r,data:e,onLoadedCB:s,onErrorCB:a})})).catch((e=>{a()})):a():"zipjs1"===this.unzipLib&&(o=d.find(l)).getBlob("application/octet-stream",(e=>{var t=new FileReader;t.onload=e=>{this.loadModelCB({targetNode:r,data:e.target.result,onLoadedCB:s,onErrorCB:a})},t.readAsArrayBuffer(e)}))},s.prototype.onModelLoaded=function(e,t,i){this.nbLoading--;e.getActiveRepresentation();n.statsInit(),n.statsOnLoadedModel();e.referenceId;var r=t.manager;this.commitModelLoadedTransaction(e,r,i),t.doneCB([e],[])},s.prototype.onModelError=function(e,t){this.nbLoading--;e.referenceId;t.doneCB([],[e])},s.prototype.acceptsRepresentation=function(e,t){return!0},s.prototype.CGRLoadCB=function(e){let t=r.getModelLoader();t.setOnLoadedProductStructureCallback((t=>{e.onLoadedCB(t)})),t.setOnErrorCallback((()=>{e.onErrorCB()}));t.loadModelFromBuffer(e.data,e.targetNode,{})};var a=function(e){this.handler=e,this.reference=null};return a.prototype.containsReference=function(e){return this.reference&&this.reference.referenceId===e},a.prototype.addReferenceIfPossible=function(e,t){return!this.reference&&(this.reference=e,!0)},a.prototype.isEmpty=function(){return!this.reference},a.prototype.getSize=function(){return this.reference?1:0},a.prototype.setReferencesLoading=function(e){this.reference&&(this.reference.isLoading()||this.reference.setLoading(e))},s.prototype.handleBatch=function(e,t){this.handleReference(e.reference,t)},s.prototype.createBatch=function(){return new a(this)},s})),define("DS/3DXMTiles/MultiPartLoader",["DS/3DXMTiles/ModelBank","DS/3DXMTiles/LDHStats","DS/Visualization/ModelLoader","DS/WAFData/WAFData","DS/3DXMTiles/LDHRepresentationLoader"],(function(e,t,n,i,r){"use strict";var o=localStorage.getItem("OOCBoxDebug");function s(e,t,n){var i,r;for(i=t;i<e.length;i++){if(13===(r=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===r)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}return class{constructor({onModelLoaded:e,onModelError:t,manager:i,saveToBank:r}){this.onModelError=t||function(){},this.onModelLoaded=e||function(){},this.saveToBank=!!r,this.modelLoader=new n,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.manager=i,this.datas=[]}parseMultiPartData(n,i,r,s,a,d){var l,h=0,c=i.__file_count__;if(d)h=1;else if(c)h=parseInt(c);else for(l=0;l<r.length;l++)r[l]&&h++;var u=this;function p(e,n,i){o&&(e.byteSize=i),t.onLoadedModel(i),u.onModelLoaded(e,n,a)}function g(e){u.onModelError(e)}if(h>1){var f=0,m=0;for(l=0;l<h;l++){for(;!r[m]&&m<r.length-1;)m++;f=this.parsePart(new Int8Array(n),f,r,p,g,m,s),m++}var v,S=[],y=[],M=[],D=[];for(l=0;l<this.datas.length;l++)(C=r[this.datas[l].referenceIndex])&&(v=C.getActiveRepresentation(),S.push(C.referenceId),y.push(v.type),M.push(v.wms),D.push(this.datas[l].data));u.saveToBank&&(e.storeModelData(S,y,this.tenant,D,M),u.datas=[])}else{m=-1;if(d){var T=d.split("reference_");m=parseInt(T[1])}for(l=0;l<r.length;l++){var C,b;(C=r[l])&&(m<0||l===m)&&(this.saveToBank&&(b=C.getActiveRepresentation(),e.storeModelData([C.referenceId],[b.type],this.tenant,[n],[b.wms])),this.loadPart(n,C,p,g))}}}parsePart(e,t,n,i,r,o,a){var d,l,h,c=new TextDecoder,u=t,p=-1;do{u=(d=s(e,u,c)).index,(h=d.str).startsWith("Content-length:")&&(l=h.split(" "),p=parseInt(l[1])),a&&h.startsWith("X-CorelationID:")&&(l=h.split("reference_"),o=parseInt(l[1]))}while(p<0&&u<e.length);var g=n[o];if(u=(d=s(e,u,c)).index,p>0){var f=e.buffer.slice(u,u+p);if(this.saveToBank){var m=e.buffer.slice(u,u+p);this.datas.push({data:m,referenceIndex:o})}this.loadPart(f,g,i,r)}return u+p}loadPart(e,t,n,i){if(t){var o=t.getActiveRepresentation(),s=t.getPrimaryRepresentation(),a=o.node;if(a){var d=e.byteLength;this.modelLoader.setOnLoadedProductStructureCallback((function(e){n(t,e,d)})),this.modelLoader.setOnErrorCallback((function(){i(t)}));var l={};r.setupModelLoaderOptions(this.modelLoader,l,t,o,s,this.manager,e),this.modelLoader.loadModelFromBuffer(e,a,l)}else i(t)}}loadFromFCSTicket(e,t,n,r){var o={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:t},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:(e,t)=>{this.parseMultiPartData(e,t,n,!1,r)},onFailure:()=>{let e;for(e=0;e<n.length;e++)this.onModelError(n[e]);console.log("checkout ERROR")}};i.authenticatedRequest(e,o)}}})),define("DS/3DXMTiles/DSTilesStylingFilterBinaryOperator",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilterOperator","DS/3DXMTiles/DSTilesStylingValue"],(function(e,t,n){"use strict";var i="==",r="!=",o="<",s=">",a="<=",d=">=";class l extends t{constructor(){super(),this.operator=null,this.operand1=null,this.operand2=null}setFromJSON(t){let l=[],h={"==":i,"!=":r,"<":o,">":s,"<=":a,">=":d}[t.operator]||0;return h||l.push(e.error(`Illegal operator "${t.operator}"`)),this.operator=h,this.operand1=n.parseFromJSON(t.operand1,l),this.operand2=n.parseFromJSON(t.operand2,l),l.length?e.error("Error parsing binary operator","operator",l):e.ok}addNeededAttributesToSet(e){this.operand1.isAttribute&&e.add(this.operand1.attribute),this.operand2.isAttribute&&e.add(this.operand2.attribute)}buildShaderCode(){return""}filter(e){let t=!1,n=this.operand1.getValue(e),l=this.operand2.getValue(e);switch(this.operator){case i:t=n===l;break;case r:t=n!==l;break;case o:t=n<l;break;case s:t=n>l;break;case a:t=n<=l;break;case d:t=n>=l}return t}}return l.majorProperty="operator",l})),define("DS/3DXMTiles/DSTilesStylingFilterOperatorInList",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilterOperator"],(function(e,t){"use strict";class n extends t{constructor(){super(),this.values=[],this.attribute=null}setFromJSON(t){let n=[];if(Array.isArray(t.inList)){let e;for(e=0;e<t.inList.length;e++)this.values.push(t.inList[e])}else n.push(e.error("illegal inList property","inList"));let i=t.attribute;return e.isStylingAttributeName(i)?this.attribute=i:n.push(e.error("illegal attribute property","inList")),n.length?e.error("Error parsing inList filter","filter",n):e.ok}addNeededAttributesToSet(e){e.add(this.attribute)}buildShaderCode(e){const t=e.variableHandler,n=e=>t.float(e);let i="";for(let e=0;e<this.values.length;e++){let t=this.values[e];i=0===e?`\n                        ${i}\n                        if(${n()}(${this.attribute})==${n()}(${t})) {\n                            return true;\n                        }\n                    `:`\n                        ${i}\n                        else if(${n()}(${this.attribute})==${n()}(${t})) {\n                            return true;\n                        }\n                    `}return i=`\n                ${i}\n                return false;\n            `,i}filter(e){let t=!1;if(e.hasAttribute(this.attribute)){let n=e.getValue(this.attribute);t=this.values.indexOf(n)>=0}return t}}return n.majorProperty="inList",n})),define("DS/3DXMTiles/LDHUserQueue",["DS/3DXMTiles/PriorityQueue"],(function(e){"use strict";var t=function(t,n){this.queue=new e,this.handler=t,this.manager=n};return t.prototype.addNode=function(e){this.queue.addNode(e)},t.prototype.computeOrder=function(e){var t,n;for(this.queue.resetOrder(),t=0;t<this.queue.nodeListLength;t++)!(n=this.queue.nodeList[t])||!n.isAlive()||n.isInList()&&n.needScreenRadiusSizeComputation()||n.updateNodeLOD(e)},t.prototype.handleViewpointChange=function(e){this.computeOrder(e)},t.prototype.traverseQueue=function(){var e=this.handler,t=[],n={doneCB:this.onHandlerDone.bind(this)};this.queue.traverseMax((function(i){return!i.isAlive()||!!(i._screenRadius>=0&&e.isReady())&&(t.push(i.referenceId),t.length>=e.getBatchSize()&&(e.handleReferences(t,n),t=[]),!0)})),t.length>0&&(e.handleReferences(t,n,this.queue.isEmpty()),t=[]),this.queue.isEmpty()&&this.manager.removeUserQueue(this.handler)},t.prototype.onHandlerDone=function(){this.manager.requestUpdate(!1,!1)},t})),define("DS/3DXMTiles/MassiveOcclusionChecker",["DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ComposerContext","DS/3DXMTiles/InstancingFactory","DS/Plugins/EffectComposer","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/ClippingContext"],(function(e,t,n,i,r,o,s,a,d,l){"use strict";var h=function(e,t,n){this.id=n,this.occurrenceIndex=-1,this.box=e,this.matrices=t},c=-1;h.prototype.fillInstancingParams=function(t,n){var i,r=new e.Color(n?0:this.id+1),o=this.matrices;for(i=0;i<o.length;i++)t.matrices.push(o[i]),t.boxes.push(this.box),t.colors.push(r)};var u=new e.Box3;h.prototype.isContainingPoint=function(e){var t;for(t=0;t<this.matrices.length;t++)if(u.copy(this.box),u.applyMatrix4(this.matrices[t]),u.containsPoint(e))return!0;return!1},h.prototype.addDebugBoxes=function(t){var n,i,r=this.matrices;for(i=0;i<r.length;i++)(n=a.createCuboidNodeFromBox3(this.box,e.MaterialUtils.createShinyFaceMaterial({color:"red",force:!0}))).setMatrix(this.matrices[i]),t.addChild(n)};var p=-1,g=function(r){-1===c&&(c=!!window.OOCDebugOcclusionChecker)&&(window.myOcclusion=[],window.myReferences=[]),this.ldhNodeManager=r.ldhNodeManager||null,this.viewer=r.viewer,this.debugId=-1,this.renderer=this.viewer.renderer.renderer,this.renderTargetPool=this.viewer.renderer.renderTargetPool,this.width=r.width,this.height=r.height,this.ratio=r.ratio||1,this.viewpoint=r.viewpoint||null,this.only=-1,this.renderList=r.renderList||"main",this.disabled=!1,this.scoreTarget=1;this.composer=new o(this.renderer,void 0,this.renderTargetPool,["--\x3e(main)","clearPass","occlusionPass"]),this.clearPass=new t("clearPass"),this.clearPass.clearColor=new e.Color("black"),this.clearPass.clearAlpha=1,this.occlusionPass=new n(null,null,null,null,null,null,"occlusionPass"),this.occlusionPass.disableToneMapping=!0,this.lastBufferSize=0,this.lastBuffer=null;var s=new e.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.occlusionComposerContext=new i(s,this.composer,"occlusionComposerContext"),this.occlusionComposerContext.keepResult=!0,this.composer.addPass(this.clearPass),this.composer.addPass(this.occlusionPass),this.boxSet=new f,this.boxSetNoClipping=new f,this.nextBoxId=0,this.visibilitySet=new Set,this.depthBuffer=null,this.debugInput=!1,this.scene=new e.Scene,this.material=new e.MeshBasicMaterial({color:"red",force:!0,side:e.DoubleSide}),this.alwaysVisibleIds=new Set,this.idsToHideSet=new Set,this.idsToHide=[],this.idsToShowSet=new Set,this.idsToShow=[],this.nextId=0,this.idToReference=new Map,this.scores=[],this.needUpdateIdsTable=!1,this.dbgPng=[]};g.prototype.dispose=function(){this.idToReference.forEach((function(e,t){e.occlusionId=-1})),this.idToReference=null,this.occlusionComposerContext.keepResult=!1,this.occlusionComposerContext.releaseRenderTargets(this.renderTargetPool,"main"),this.occlusionComposerContext.keepResult=!0,this.boxSet.reset(),this.boxSetNoClipping.reset(),this.material.dispose(),this.material=null,this.boxSet.dispose(this.viewer),this.boxSetNoClipping.dispose(this.viewer),this.scene.dispose(),this.scene=null,this.mesh=null},g.prototype.hasReference=function(e){return e.occlusionId>=0&&this.idToReference.has(e.occlusionId)},g.prototype.addReference=function(e){this.idToReference.set(e.occlusionId,e)},g.prototype.hideReference=function(e){this.hasReference(e)&&this.hideId(e.occlusionId)},g.prototype.hideId=function(e){this.idsToHideSet.add(e),this.idsToShowSet.delete(e),this.needUpdateIdsTable=!0},g.prototype.updateIdsTables=function(){this.disabled=!1,this.idsToHide=[],this.idsToShow=[],this.idsToHideSet.forEach((e=>{this.idsToHide.push(e)})),this.boxSet.updateIdsToHide(this.idsToHide),this.boxSetNoClipping.updateIdsToHide(this.idsToHide),this.idsToShowSet.forEach((e=>{this.idsToShow.push(e)}))},g.prototype.showReference=function(e){if(this.hasReference(e)){var t=e.occlusionId;this.idsToShowSet.add(t),this.idsToHideSet.delete(t),this.needUpdateIdsTable=!0}},g.prototype.clear=function(){this.boxes=[]},g.prototype.addBox=function(e,t,n){if(!n.length)return;var i=this.nextBoxId++;let r;this.disabled=!1;let o,s,a=!1,d=n[0];for(r=1;r<n.length;r++)n[r]!==n[r-1]&&(a=!0);if(a)for(o=[],s=[],r=0;r<n.length;r++)n[r]?o.push(t[r]):s.push(t[r]);else o=d?t:null,s=d?null:t;return o&&this.boxSet.addBox(e,o,i),s&&this.boxSetNoClipping.addBox(e,s,i),i},e.WebGLRenderTarget.prototype.readPixels=function(e){e.setRenderTarget(this),null!==this.lastBuffer&&this.lastBufferSize===this.width*this.height||(this.lastBuffer=new Uint8Array(4*this.width*this.height),this.lastBufferSize=this.width*this.height);var t=this.lastBuffer,n=e.getContext();return n.readPixels(0,0,this.width,this.height,n.RGBA,n.UNSIGNED_BYTE,t),t},g.prototype.getVisibility=function(e){return this.visibilitySet.has(e)},g.prototype.getVisibleReferences=function(){var e=[],t=this;return this.visibilitySet.forEach((function(n){var i=t.idToReference.get(n);i?e.push(i):console.log("problem")})),e},g.prototype.buildNode=function(e,t){return this.boxes[e].buildNode(t)},g.prototype.computeDepthBuffer=function(){var e,t=this.viewer.renderer,n=t.renderer.getContext(),i=this.viewer.internalSceneGraph.scene,r=this.viewer.internalSceneGraph,o=i.defaultRenderList;return i.defaultRenderList="ooc",e=t.renderOcclusionRealDepth({cameraName:"main",scene:i,gl:n,cameraSet:{main:this.viewpoint.camera},resultId:"main",doSectionCapping:!1,sceneGraph:r,width:this.width,height:this.height,viewportScale:this.ratio}),i.defaultRenderList=o,e},g.prototype.computeVisibility=async function(){if(this.needUpdateIdsTable&&(this.updateIdsTables(),this.needUpdateIdsTable=!1),this.visibilitySet=new Set,this.disabled)return;let t;if(this.renderer.increaseFrameCount(e._FrameTypes.OOC_OCCLUSION),this.depthBuffer=this.computeDepthBuffer(),this.debugInput){var n=new s;this.viewer.addNode(n);let e=this.boxSet.boxes;for(t=0;t<e.length;t++)box=e[t],box&&(this.only<0||t===this.only)&&box.addDebugBoxes(n);for(e=this.boxSetNoClipping.boxes,t=0;t<e.length;t++)box=e[t],box&&(this.only<0||t===this.only)&&box.addDebugBoxes(n)}this.boxSet.clippingPlanes=this.ldhNodeManager&&this.ldhNodeManager.getClippingPlanes(),await this.compute([this.boxSet,this.boxSetNoClipping],[]);let i=this.visibilitySet.size-this.alwaysVisibleIds.size;this.alwaysVisibleIds.forEach((e=>{this.visibilitySet.add(e),this.scores[e]=1/0})),0===i&&(this.disabled=!0),c&&this.buildPNG(!0)},g.prototype.compute=async function(t,n){var i=null!==this.viewer.getSceneBoundingSphere(void 0,!0);let o,s=this.scene,a=this.renderer,h=a.clipPlanes;for(a.clipPlanes=[],o=0;o<t.length;o++){let e=t[o];if(e.boxes.length>0){let t=e.buildInstancingParams(this,i),o=e.occurrencesToHide,h=e.occurrencesToShow;this.scores=[];let c=e.mesh;if(c)r.updateInstancingBox({mesh:c,instancingParams:t,indexesToHide:o,indexesToHideTmp:n,indexesToShow:h});else{c=r.buildInstancingBox(t),c.setVisibilityFree(!0);let n=c._occurrences[0].renderable;s.add(n),e.mesh=c}let p=e.clippingPlanes;if(p&&p.length){var u=e.mesh._occurrences[0];let t,n;for(u.occurrenceRenderingOverride||(u.occurrenceRenderingOverride=new d),e.clippingContext||(e.clippingContext=new l(p)),e.clippingContext.setPlanes(p),u.occurrenceRenderingOverride.clipPlanes=p,u.occurrenceRenderingOverride.clippingContext=e.clippingContext,u.renderable.occurrenceRenderingOverride=u.occurrenceRenderingOverride,n=0;n<p.length;n++)t=p[n],t.clippingContext||(t.clippingContext={}),t.clippingContext[a.id]||(t.clippingContext[a.id]={}),t.clippingContext[a.id].clippingPlaneAdded=!0,a.clipPlanes.indexOf(t)<0&&a.clipPlanes.push(t)}}}var g={main:this.viewpoint.camera};this.composer.updateScene(s),a.materialToUse=e.MaterialToUse.originalMaterial,this.composer.setComposerContext(this.occlusionComposerContext);window.performance.now();this.composer.render(void 0,void 0,g,"main"),a.clipPlanes=h;window.performance.now(),this.viewer;var f=this.composer.getRenderResult("main");let m=f.width*f.height;null!==this.lastBuffer&&this.lastBufferSize===m||(this.lastBuffer=new Uint8Array(4*m),this.lastBufferSize=m);let v=this.lastBuffer,S=a.gl;await a.readPixelsPromise(0,0,f.width,f.height,v,f,S&&S.RGBA,S&&S.UNSIGNED_BYTE);for(var y,M,D=this.width,T=this.height,C=[],b=this.scoreTarget,L=0;L<T;L++)for(var R=0;R<D;R++){var _=4*(R+(T-L-1)*D);(y=(v[_]<<16)+(v[_+1]<<8)+v[_+2]-1)>=0&&(M=this.scores[y]?this.scores[y]+1:1,this.scores[y]=M,M===b&&(this.visibilitySet.add(y),c&&C.push(this.idToReference.get(y)),!0))}c&&window.myReferences.push(C),-1===p&&(p=Date.now())},g.prototype.buildPNG=async function(e){var t=this.composer.getRenderResult("main");let n=t.width*t.height;null!==this.lastBuffer&&this.lastBufferSize===n||(this.lastBuffer=new Uint8Array(4*n),this.lastBufferSize=n);let i=window.myOcclusion.length;e&&window.myOcclusion.push(null);let r=new Uint8Array(4*n),o=this.renderer.gl;await this.renderer.readPixelsPromise(0,0,t.width,t.height,r,t,o&&o.RGBA,o&&o.UNSIGNED_BYTE);var s,a=this.width,d=this.height,l=document.createElement("canvas");l.width=a,l.height=d;for(var h=l.getContext("2d"),c=h.createImageData(a,d),u=c.data,p=0;p<c.height;p++)for(var g=0;g<c.width;g++){var f=g+p*a,m=g+(d-p-1)*a;u[4*f]=r[4*m]?256-r[4*m]:0,u[4*f+1]=r[4*m+1]?256-r[4*m+1]:0,u[4*f+2]=r[4*m+2]?256-r[4*m+2]:0,u[4*f+3]=r[4*m+3]}return h.putImageData(c,0,0),s=l.toDataURL(),window.myDataURL=s,e&&(window.myOcclusion[i]=s),s};class f{constructor(){this.boxes=[],this.occurrencesToHide=[],this.occurrencesToShow=[],this.nbProcessedBoxes=0,this.occurrenceCount=0,this.clippingPlanes=[],this.mesh=null,this.clippingContext=null}addBox(e,t,n){if(!(t instanceof Array))throw new Error("invalid argument");var i=new h(e,t,n);this.boxes[n]=i}reset(){this.boxes=[],this.occurrencesToHide=[],this.occurrencesToShow=[],this.nbProcessedBoxes=0,this.occurrenceCount=0}dispose(e){if(this.mesh){var t=this.mesh._occurrences[0].renderable;e.renderer.renderer.__glResources__&&e.renderer.renderer.__glResources__.removeGeometryList([t])}}updateIdsToHide(e){this.occurrencesToHide=[],e.forEach((e=>{var t,n=this.boxes[e];if(n&&n.occurrenceIndex>=0)for(t=0;t<n.matrices.length;t++)this.occurrencesToHide.push(n.occurrenceIndex+t),this.occurrencesToHide.push(n.id+1)}))}updateIdsToShow(e){this.occurrencesToShow=[],e.forEach((e=>{var t,n=this.boxes[e];if(n&&n.occurrenceIndex>=0)for(t=0;t<n.matrices.length;t++)this.occurrencesToShow.push(n.occurrenceIndex+t),this.occurrencesToShow.push(n.id+1)}))}buildInstancingParams(e,t){let n,i=this.boxes,r=e.viewpoint,o={matrices:[],boxes:[],colors:[],material:e.material,useDBuffer:t,depthBuffer:e.depthBuffer};var s,a,d=r.camera;for(n=this.nbProcessedBoxes;n<i.length;n++)(s=i[n])&&(a=s.id,d.isOrtho||!s.isContainingPoint(d.position)?(i[n].fillInstancingParams(o,e.idsToHide.indexOf(a)>=0||e.only>=0&&n!==e.only),s.occurrenceIndex=this.occurrenceCount,this.occurrenceCount+=s.matrices.length):e.alwaysVisibleIds.add(a));return this.nbProcessedBoxes=i.length,o}setClippingPlanes(e){this.clippingPlanes=e}}return g})),define("DS/3DXMTiles/VDRPInstanceOverrideSet",["DS/3DXMTiles/VDRPInstanceOverride"],(function(e){"use strict";return class{constructor({sceneGraphOverrideSetArray:e,oocManager:t,rootId:n}){this._rootId=n,this._oocManager=t,this._sceneGraphOverrideSetArray=e,this._vdrpOverrideArray=[],this._idPathToOverridesMap=null,this._nodeIdToOverridesMap=null}createOverride(e){return null}createIdPathOverride(t){if(t.vdrpIdPathes){let n,i=new Map;for(n=0;n<t.vdrpIdPathes.length;n++){let e=t.vdrpIdPathes[n];if(e.productIdPath[0]!==this._rootId)return console.log("illegal VDRPIdPath"),null;{let t,n=e._buildInternalIdPathes(this._oocManager);for(t=0;t<n.length;t++){let e=n[t],r=i.get(e.ids[0]);r||(r=[],i.set(e.ids[0],r)),r.push(e)}}}if(this._sceneGraphOverrideSetArray.length!==i.size)return console.log("inconsistent VDRPIdPath"),null;let r,o=[],s={};for(r in t)"vdrpIdPathes"!==r&&(s[r]=t[r]);for(n=0;n<this._sceneGraphOverrideSetArray.length;n++){let e=this._sceneGraphOverrideSetArray[n],t=i.get(e.rootId);if(!t)return console.log("inconsistent VDRPIdPath 2"),null;s.idPathes=t;let r=e.createIdPathOverride(s);if(!r)return console.log("inconsistent VDRPIdPath 3"),null;o.push(r)}let a=new e({overrideArray:o,vdrpOverrideSet:this});return this._vdrpOverrideArray.push(a),a}return console.log("only overrides with vdrpidpathes are supported"),null}createNodeIdOverride(e,t,n,i){}getOverrides(){return[].concat(this._vdrpOverrideArray)}deleteOverrides(e){var t;for(t=0;t<e.length;t++)this.deleteOverride(e[t])}deleteOverride(e){var t,n=this._vdrpOverrideArray.indexOf(e);if(n>=0){for(t=0;t<this._sceneGraphOverrideSetArray.length;t++)this._sceneGraphOverrideSetArray[t].deleteOverride(e._overrideArray[t]);return this._vdrpOverrideArray.splice(n,1),e.isIdPathOverride()?this._idPathToOverridesMap&&this._removeIdPathOverrideFromMap(e,this._idPathToOverridesMap):e.isNodeIdOverride()&&this._nodeIdToOverridesMap&&this._removeNodeIdOverrideFromMap(e,this._nodeIdToOverridesMap),!0}return!1}clone(){return null}getOverridesFromPathElement(e){return null}getUniqueOverrideFromPathElement(e){return null}getOverridesFromIdPath(e){this._idPathToOverridesMap||(this._idPathToOverridesMap=this._buildIdPathToOverridesMap());var t=e.getKey();return this._idPathToOverridesMap[t]||null}getUniqueOverrideFromIdPath(e){var t=this.getOverridesFromIdPath(e);return t&&1===t.length?t[0]:null}getOverridesFromVDRPIdPath(e){this._idPathToOverridesMap||(this._idPathToOverridesMap=this._buildIdPathToOverridesMap());var t=e.getKey();return this._idPathToOverridesMap[t]||null}getUniqueOverrideFromVDRPIdPath(e){var t=this.getOverridesFromVDRPIdPath(e);return t&&1===t.length?t[0]:null}getOverridesFromNodeId(e){return this._nodeIdToOverridesMap||(this._nodeIdToOverridesMap=this._buildNodeIdToOverridesMap()),this._nodeIdToOverridesMap[e]||null}getUniqueOverrideFromNodeId(e){var t=this.getOverridesFromNodeId(e);return t&&1===t.length?t[0]:null}getOverridesTargetingNode(e){return null}getAllowNodeOverrides(){return this._sceneGraphOverrideSetArray[0].getAllowNodeOverrides()}enable(e){let t;for(t=0;t<this._sceneGraphOverrideSetArray.length;t++)this._sceneGraphOverrideSetArray[t].enable(e)}_buildIdPathToOverridesMap(){var e,t,n={};for(e=0;e<this._overrides.length;e++)(t=this._overrides[e]).isIdPathOverride()&&this._addIdPathOverrideToMap(t,n);return n}_buildNodeIdToOverridesMap(){var e,t,n={};for(e=0;e<this._overrides.length;e++)(t=this._overrides[e]).isNodeIdOverride()&&this._addNodeIdOverrideToMap(t,n);return n}_addIdPathOverrideToMap(e,t){var n,i,r;if(e._vdrpIdPathes)for(n=0;n<e._vdrpIdPathes.length;n++)(r=t[i=e._vdrpIdPathes[n].getKey()])||(r=[],t[i]=r),r.push(e);else for(n=0;n<e._idPathes.length;n++)(r=t[i=e._idPathes[n].getKey()])||(r=[],t[i]=r),r.push(e)}_removeIdPathOverrideFromMap(e,t){var n,i,r,o;if(e._vdrpIdPathes)for(n=0;n<e._vdrpIdPathes.length;n++)(r=t[i=e._vdrpIdPathes[n].getKey()])&&(o=r.indexOf(e))>=0&&r.splice(o,1),r&&0!==r.length||delete t[i];else for(n=0;n<e._idPathes.length;n++)(r=t[i=e._idPathes[n].getKey()])&&(o=r.indexOf(e))>=0&&r.splice(o,1),r&&0!==r.length||delete t[i]}_addNodeIdOverrideToMap(e,t){var n,i;(i=t[n=e._buildNodeIdKey()])||(i=[],t[n]=i),i.push(e)}_removeNodeIdOverrideFromMap(e,t){var n,i,r;(i=t[n=e._buildNodeIdKey()])&&(r=i.indexOf(e))>=0&&i.splice(r,1),i&&0!==i.length||delete t[n]}_activate(e,t,n,i,r,o,s){let a;for(a=0;a<this._sceneGraphOverrideSetArray.length;a++){let e=this._sceneGraphOverrideSetArray[a];e._activate.apply(e,arguments)}}_deactivate(e,t,n){let i;for(i=0;i<this._sceneGraphOverrideSetArray.length;i++){let e=this._sceneGraphOverrideSetArray[i];e._deactivate.apply(e,arguments)}}_getViewerEntries(){return this._sceneGraphOverrideSetArray[0]._getViewerEntries()}_getViewerEntryFromViewer(e){return this._sceneGraphOverrideSetArray[0]._getViewerEntryFromViewer(e)}_updateOverridesWithMissingTarget(e){let t;for(t=0;t<this._sceneGraphOverrideSetArray.length;t++){let e=this._sceneGraphOverrideSetArray[t];e._updateOverridesWithMissingTarget.apply(e,arguments)}}}})),define("DS/3DXMTiles/LDHBatchModel3DHandlerVISCANoStream",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/WAFData/WAFData","DS/3DXMTiles/LDHModelLoader","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHStats","DS/3DXMTiles/LDHReferenceRep","DS/3DXMTiles/ModelBank","DS/Visualization/Node3D","DS/Visualization/TaskManager"],(function(e,t,n,i,r,o,s,a,d,l){"use strict";var h=0;function c(e,t){this.index=h++,this.context=e,this.references=[],this.size=t}var u=function(t,n,i){e.call(this,e.Model3DHandler),this.loadModelOptions=null,this.debug=!!t.debug,this.debugSingleMode=!!t.debugSingleMode,this.manager=null,this.tenant=null,this.loadingInProgress=!1,this.saveToBank=t.saveToBank||!1,this.nbTickets=n,this.batchSize=this.debugSingleMode?1:i,this.referenceToBatch=new Map,this.urlServices=new r,this.ODT=!1,this.maxTicketSize=t.maxTicketSize||0,this.getSecurityParamsCB=t.getSecurityParamsCB||null,this.batchAV1=void 0===t.batchAV1||t.batchAV1,this.datas=[],this.dosHandler=t.dosHandler||null,this.useFileurls="2"===localStorage.getItem("OOCOneByOneMode"),this.oneByOneMode=this.useFileurls||"1"===localStorage.getItem("OOCOneByOneMode")};function p(e){return decodeURIComponent((e+"").replace(/\+/g,"%20"))}(u.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},u.prototype.setRestricted=function(){},u.prototype.isReady=function(){return this.nbTickets>0},u.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},u.prototype.setRedirectUrlCB=function(){},u.prototype.setAutoRedirect=function(){};var g=document.createElement("a");u.prototype.getParams=function(e){var t={};g.href=e;for(var n=g.search.substring(1).split("&"),i=0;i<n.length;i++){var r=n[i].split("=");t[r[0]]=p(r[1])}return t};var f={url:"/resources/fcsservices/fcs/fileurls",verb:"POST"},m={url:"/i3dx/services/xmql",verb:"POST"};function v(e,t,n){var i,r;for(i=t;i<e.length;i++){if(13===(r=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===r)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}u.prototype.getMQLUrl=function(){return this.getMCSUrl()+m.url},u.prototype.getMCSUrl=function(){return this.getSecurityParamsCB().service3DSpaceUrl},u.prototype.buildMQLRequest=function(e,t){var n,i,r,o,s="[";for(n=0;n<e.length;n++)r=e[n].getActiveRepresentation(),n>0&&(s+=","),s+='{"correlationId":"'+(o=n+1)+'","filename":"'+((i=this.getParams(r.url)).filename||i.f)+'","format":"'+(i.format||i.fmt)+'","path":"'+o+'","physicalid":"'+(i.boid||i.id)+'"}';return s+="]",['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>get_checkout_ticket</function>","    <version>2.1.0</version>","    <params>",'      <param name="label">ticket</param>','      <param name="mcsurl">'+this.getMCSUrl()+"</param>",'      <param name="bops">[{"bops":'+s+',"store":"'+t+'"}]</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")},u.prototype.buildMQLSizeRequest=function(e,t){var n,i,r,o='"';for(n=0;n<e.length;n++){r=e[n].getActiveRepresentation(),n>0&&(o+=","),n+1;let s=(i=this.getParams(r.url)).boid||i.id;if(!s)return null;o+=""+s,t.push(i.filename||i.f)}o+='" ","';this.getMCSUrl();return['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>query_bus</function>","    <version>2.2.0</version>","    <params>",'      <param name="label">fetch</param>','      <param name="type">*</param>','      <param name="name">*</param>','      <param name="revision">*</param>','      <param name="vault">*</param>','      <param name="select">["physicalid","format.file.name","format.file.size","format.file.location"]</param>','      <param name="where">physicalid matchlist '+o+"</param>",'      <param name="dump">|</param>','      <param name="format">tcl</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")},u.prototype.doDebugSingleLoad=function(e,t){var i=this,r={type:"arraybuffer",onComplete:function(n,r){i.parseMultiPartData(n,r,e,t,!1)},onFailure:function(){i.errorCallbackTest(e,t),console.log("checkout ERROR")}},o=t[0].getActiveRepresentation();n.authenticatedRequest(o.url,r)},u.prototype.doCheckoutMQL=function(e,t,i,r){var o=/\{\{([^\}]*)\}\{([^\}]*)\}\}/.exec(e);if(o){var s=o[1],a=o[2],d=this,h={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:s},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:l.postponeAfterManipulation((function(e,n){d.parseMultiPartData(e,n,t,i,!1,r)})),onFailure:function(){d.errorCallbackTest(t,i),console.log("checkout ERROR")}};n.authenticatedRequest(a,h)}else this.errorCallbackTest(t,i)},u.prototype.loadPart=function(e,n,r,o){if(!n)return;var s=n.getActiveRepresentation(),a=n.getPrimaryRepresentation();if(!s.node)return void o(n);let l=new d;var h=e.byteLength;let c=this.manager,u=i.getModelLoader();u.setOnLoadedProductStructureCallback((function(e){t.addToSceneGraph(c,l,s,(()=>{r(n,e,h)}))})),u.setOnErrorCallback((function(){o(n)}));var p={};t.setupModelLoaderOptions(u,p,n,s,a,this.manager,e),u.loadModelFromBuffer(e,l,p)},u.prototype.parsePart=function(e,t,n,i,r,o,s){var a,d,l,h=new TextDecoder,c=t,u=-1;do{c=(a=v(e,c,h)).index,(l=a.str).startsWith("Content-length:")&&(d=l.split(" "),u=parseInt(d[1])),s&&l.startsWith("X-CorelationID:")&&(d=l.split("reference_"),o=parseInt(d[1]))}while(u<0&&c<e.length);var p=n[o];if(c=(a=v(e,c,h)).index,u>0){var g=e.buffer.slice(c,c+u);if(this.saveToBank){var f=e.buffer.slice(c,c+u);this.datas.push({data:f,referenceIndex:o})}this.loadPart(g,p,i,r)}return c+u};var S=localStorage.getItem("OOCBoxDebug");return u.prototype.parseMultiPartData=function(e,t,n,i,r,s,d){var l,h=0,c=t.__file_count__;if(d)h=1;else if(c)h=parseInt(c);else for(l=0;l<i.length;l++)i[l]&&h++;var u=this;function p(e,t,n){S&&(e.byteSize=n),o.onLoadedModel(n),u.onModelLoaded(e,t,s)}function g(e){u.onModelError(e)}if(h>1){var f=0,m=0;for(this.datas=[],l=0;l<h;l++){for(;!i[m]&&m<i.length-1;)m++;f=this.parsePart(new Int8Array(e),f,i,p,g,m,r),m++}var v,y=[],M=[],D=[],T=[];for(l=0;l<this.datas.length;l++)(b=i[this.datas[l].referenceIndex])&&(v=b.getActiveRepresentation(),y.push(b.referenceId),M.push(v.type),D.push(v.wms),T.push(this.datas[l].data));u.saveToBank&&!s&&a.storeModelData(y,M,this.tenant,T,D),u.datas=[]}else{m=-1;if(d){var C=d.split("reference_");m=parseInt(C[1])}for(l=0;l<i.length;l++){var b,L;(b=i[l])&&(m<0||l===m)&&(this.saveToBank&&!s&&(L=b.getActiveRepresentation(),a.storeModelData([b.referenceId],[L.type],this.tenant,[e],[L.wms])),this.loadPart(e,b,p,g))}}},u.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},u.prototype.updateTenant=function(){this.tenant=this.getSecurityParamsCB?this.getSecurityParamsCB().tenant:"#NONE#"},u.prototype.handleReferences=function(e,t){this.tenant||this.updateTenant(),this.manager=t.manager._ldhNodeManager;var n,i,r,s=this.manager;for(i=0;i<e.length;i++)r=(n=e[i]).getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0);s.tryBuildSceneGraphHierarchy();var a=[],d=[],l=[],h=new c(t,e.length);for(i=0;i<e.length;i++)(r=(n=e[i]).getActiveRepresentation()).url?(r!==n.getPrimaryRepresentation()&&r.buildNode(),r.node,this.isViscaUrl(r.url)&&!this.debugSingleMode?/*!this.activateVISCAElement || */this.urlServices.IsURLFetchCompatible(r.url)?d.push(n):l.push(n):a.push(n),h.references.push(n),this.referenceToBatch.set(n,h)):setTimeout(function(e){t.doneCB([],[e])}.bind(this,n),0);(a.length>0||d.length>0||l.length>0)&&(this.nbTickets--,o.onStartBatch(h.references.length),a.length>0&&(this.debugSingleMode?this.doDebugSingleLoad(h,a):this.downloadReferencesMQL(a,h,!1)),d.length>0&&this.requestVISCACheckoutTicket(d,h),l.length>0&&this.handleVISCAElementReferences(l,h,!1))},u.prototype.downloadReferencesMQL=function(e,t,n){this.oneByOneMode?this.useFileurls?this.downloadWithFileurls(e,t,n):this.downloadOneByOne(e,t,n):this.maxTicketSize>0?this.requestMQLCheckoutTicket_size(e,t,n,this.maxTicketSize):this.requestMQLCheckoutTicket(e,t,n)},u.xmqlFetchToArray=function(e){var t,n,i,r,o=[],s="fetch: ",a=o,d=[o],l=null;if(e&&e.startsWith(s)){for(t=e.substring(7),n=0;n<t.length;n++)switch(i=t[n]){case"\n":case"\t":case"\r":break;case"{":l=null,r=[],a.push(r),d.push(r),a=r;break;case"}":null!==l&&(0===a.length&&a.push(l),l=null),d.pop(),a=d[d.length-1]||null;break;default:null===l?l=i:l+=i}if(1!==d.length)return null}return o},u.prototype.requestMQLCheckoutTicket_size=function(e,t,i,r){var o=this,s=this.getMQLUrl(),a=[],d=this.getSecurityParamsCB(),l=d.securityCtx?d.securityCtx:"preferred",h=d.userLogin||"",c=this.buildMQLSizeRequest(e,a,t);c?n.authenticatedRequest(s,{data:c,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain",SecurityToken:h+"|"+l},proxy:"passport",onComplete:function(n){var s,d,l,h,c=u.xmqlFetchToArray(n),p=new Map,g=new Map,f=[];for(l=0;l<c.length;l++)for(d=c[l],h=0;h<d[4].length;h++){p.set(d[4][h][0],parseInt(d[5][h][0]));let e=d[6][h][0];g.set(d[4][h][0],d[6][h][0]),f.indexOf(e)<0&&f.push(e)}var m,v,S=0,y=[];for(v=0;v<f.length;v++){for(l=0;l<e.length;l++){s=e[l],g.get(a[l])===f[v]&&(S+(m=p.get(a[l])||0)<r||0===S?(y.push(s),S+=m):(o.requestMQLCheckoutTicket(y,t,i,f[v]),y=[s],S=m))}y.length>0&&(o.requestMQLCheckoutTicket(y,t,i,f[v]),y=[],S=0)}0===f.length&&o.downloadWithFileurls(e,t,i)},onFailure:function(n){console.log("mql size error"),o.requestMQLCheckoutTicket(e,t,i,"plmx")}}):setTimeout((()=>{this.errorCallbackTest(t,e)}),0)},u.prototype.requestMQLCheckoutTicket=function(e,t,n,i){var r=this,o=this.getSecurityParamsCB(),s=o.securityCtx?o.securityCtx:"preferred",a=o.userLogin||"",d=this.getMQLUrl(),l=this.buildMQLRequest(e,i);this.authenticatedRequest_MQL(d,{data:l,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain",SecurityToken:a+"|"+s},proxy:"passport",onComplete:function(i){r.doCheckoutMQL(i,t,e,n)},onFailure:function(i){r.downloadWithFileurls(e,t,n)}})},u.prototype.authenticatedRequest_MQL=function(e,t){n.authenticatedRequest(e,t)},u.prototype.downloadOneByOne=function(e,t,n){let i;for(i=0;i<e.length;i++)this.downloadSingle(e[i],t,n)},u.prototype.downloadSingle=function(e,t,i,r){let o=[e],s={cors:!0,headers:{"x-requested-with":"xmlhttprequest"},timeout:36e5,type:"arraybuffer",onComplete:(e,n)=>{this.parseMultiPartData(e,n,t,o,!1,i)},onFailure:()=>{this.errorCallbackTest(t,o),console.log("downoad ERROR")}};var a=e.getActiveRepresentation();n.authenticatedRequest(r||a.url,s)},u.prototype.requestVISCACheckoutTicket=function(e,t){var n,i,r=[],o=[];for(n=0;n<e.length;n++)i=e[n].getActiveRepresentation(),r.push(i.url),o.push("reference_"+n);var s=this.urlServices.CreateFetchURLAndBody(r,o,{allowPartial:!0,splitTargetedSize:this.maxTicketSize>0?this.maxTicketSize:void 0}),a=this.getSecurityParamsCB(),d=a.securityCtx?a.securityCtx:"preferred",l=this,h=s.url.replace("//api","/api");this.authenticatedRequest_VISCA(h,{method:"POST",data:s.body,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:d},onComplete:function(n){var i=JSON.parse(n);l.doCheckoutVISCA(i,t,e)},onFailure:function(n){l.errorCallbackTest(t,e)}})},u.prototype.authenticatedRequest_VISCA=function(e,t){n.authenticatedRequest(e,t)},u.prototype.authenticatedRequest_VISCA_element=function(e,t){n.authenticatedRequest(e,t)},u.prototype.doCheckoutVISCA=function(e,t,n){var i,r,o,s,a,d,l=e.ticketWrappers,h=e.filesNotFound,c=[],u=[];let p=[];if(h){for(i=0;i<h.length;i++)if((r=(d=h[i]).correlationID)&&(o=r.split("reference_"),a=n[s=parseInt(o[1])],n[s]=null),a)if(d.filename&&d.bucket){let e=d.bucket;p.push({reference:a,bucket:e})}else if(d.emptyReason)"EmptyDerivedObject"===d.emptyReason?this.onModelLoaded(a,null,0,!1):this.onModelError(a);else{let e=a.getActiveRepresentation(),t=e&&e.url;t&&t.toLowerCase().indexOf("&e=")>=0?u.push(a):c.push(a)}c.length&&this.downloadReferencesMQL(c,t,!0),u.length&&this.handleVISCAElementReferences(u,t,!0),p.length&&this.handleDOSFallbackReferences(p,t)}if(l)for(i=0;i<l.length;i++)this.doTicketWrapperCheckout(l[i],t,n)},u.prototype.doTicketWrapperCheckout=function(e,t,n){var i=e.url,r=e.ticket,o=null;e.correlationIDs&&1===e.correlationIDs.length&&(o=e.correlationIDs[0]),this.doCheckoutVISCASingle(i,r,t,n,o)},u.prototype.doCheckoutVISCASingle=function(e,t,n,i,r){var o=this,s={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:t},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:l.postponeAfterManipulation((function(e,t){o.parseMultiPartData(e,t,n,i,!0,!1,r)})),onFailure:function(){o.errorCallbackTest(n,i),console.log("checkout ERROR")}};this.authenticatedRequest_checkoutVISCASingle(e,s)},u.prototype.authenticatedRequest_checkoutVISCASingle=function(e,t){n.authenticatedRequest(e,t)},u.prototype.errorCallbackTest=function(e,t){this.doneCB(e,t,!1)},u.prototype.onModelLoaded=function(e,t,n){var i=e.getActiveRepresentation();n&&(i.type=s.RepType.av1);var r=this.referenceToBatch.get(e),o=r.context.manager;this.commitModelLoadedTransaction(e,o,t),this.doneCB(r,[e],!0)},u.prototype.onModelError=function(e){var t=this.referenceToBatch.get(e);this.doneCB(t,[e],!1)},u.prototype.doneCB=function(e,t,n){var i,r,s=e.context,a=s.manager;for(i=0;i<t.length;i++)(r=t[i])&&(r.referenceId,this.referenceToBatch.delete(r),n?s.doneCB([r],[]):s.doneCB([],[r]),e.size--);0===e.size&&(this.nbTickets++,o.onEndBatch(e.references.length),a._ldhNodeManager.requestUpdate(!1,!1))},u.prototype.getBatchSize=function(){return this.batchSize},u.prototype.acceptsRepresentation=function(e,t){return!!this.batchAV1||!(!e||e.isAV1())},u.prototype.handleVISCAElementReferences=function(e,t,n){var i,r=[],o=new RegExp("&type=pr","i");for(i=0;i<e.length;i++){let t=e[i].getActiveRepresentation().url;n&&t&&(t=t.replace(o,"&type=av")),r.push(t)}var s=this.urlServices.CreateBatchURLAndBody(r,{allowPartial:!0,fallback:!0}),a=this.getSecurityParamsCB(),d=a.securityCtx?a.securityCtx:"preferred",l=this,h=s.url.replace("//api","/api");this.authenticatedRequest_VISCA_element(h,{method:"POST",data:s.body,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:d},onComplete:function(i){var r=JSON.parse(i);l.handleVISCAElementFetchResult(r,t,e,n)},onFailure:function(n){l.errorCallbackTest(t,e)}})},u.prototype.handleVISCAElementFetchResult=function(e,t,n,i){let r,o=this.urlServices.MergeBatchAnswer(e,this.maxTicketSize);for(r=0;r<o.files.length;r++){let e=o.files[r];this.handleVISCAElementFetchSingleResult(e,t,n,i)}},u.prototype.handleVISCAElementFetchSingleResult=function(e,t,n,i){let r,o=[];for(r=0;r<e.indices.length;r++)o.push(n[e.indices[r]]);if(!e.headers)return console.log("elementNotFound in /reps"),void this.errorCallbackTest(t,o);let s={Accept:"text/plain"};for(r=0;r<e.headers.length;r++)s[e.headers[r].name]=e.headers[r].value;this.authenticatedRequest_viscaElementDownload(e.url,{cors:!0,timeout:36e5,method:"GET",type:"arraybuffer",async:!0,headers:s,onComplete:l.postponeAfterManipulation(((e,n)=>{this.parseMultiPartData(e,n,t,o,!1,i)})),onFailure:()=>{this.errorCallbackTest(t,o),console.log("checkout ERROR")}})},u.prototype.authenticatedRequest_viscaElementDownload=function(e,t){n.authenticatedRequest(e,t)},u.prototype.handleDOSFallbackReferences=function(e,t){let n,i=new Map;for(n=0;n<e.length;n++){let t=e[n].reference,r=e[n].bucket,o=i.get(r);o||(o=[],i.set(r,o)),o.push(t)}i.forEach(((e,n)=>{this.handleDOSFallbackReferencesInBucket(e,t,n)}))},u.prototype.handleDOSFallbackReferencesInBucket=function(e,t,n){let i,r=this.getMCSUrl()+"/cvservlet/fetch/v2?isSupplemental=true&bucket="+n,o=[];for(i=0;i<e.length;i++)o.push(this.fetchDOSUrlSingle(e[i],r));Promise.all(o).then((n=>{let i,r=[];for(i=0;i<e.length;i++){let o=e[i];if(n[i]){let e=o.getActiveRepresentation();e.type=s.RepType.av1,e.updateUrl(n[i]),r.push(o)}else this.doneCB(t,[o],!1)}if(e.length>0){let n=t.context,i={viewpointTag:n.viewpointTag,manager:n.manager,doneCB:(e,n)=>{e.length>0&&this.doneCB(t,e,!0),n.length>0&&this.doneCB(t,n,!1)}};this.dosHandler.handleReferences(e,i)}}))},u.prototype.fetchDOSUrlSingle=function(e,t){return new Promise(((i,r)=>{let o={physicalid:[e.referenceId],label:"OOCManager-"+Date.now(),select_predicate:["cgrwms"],select_file:["cgr"]},s={authentication:"passport",proxy:"passport",method:"POST",headers:{"Content-type":"application/json",Accept:"application/json"},data:JSON.stringify(o),onComplete:function(e,t){if("string"!=typeof e||0===e.length)return void i(null);let n=JSON.parse(e);if("object"!=typeof n||!Array.isArray(n.results))return void r();let o=n.results,s=null;if(o&&o.length>0){let e;for(e=0;e<o.length;e++){let t=o[e].attributes;if(t&&t.length){let e;for(e=0;e<t.length;e++){let n=t[e];"cgr"===n.name&&(s=n.value)}}}}i(s)},onFailure:function(){i(null)}};n.authenticatedRequest(t,s)}))},u.prototype.downloadWithFileurls=function(e,t,i){var r=this.getSecurityParamsCB();let o;function s(e){var t={},n=document.createElement("a");n.href=e;for(var i=n.search.substring(1).split("&"),r=0;r<i.length;r++){var o=i[r].split("="),s=o[0];"boid"===s&&(s="id"),t[s]=p(o[1])}return t}o="onPremise"===r.tenant?r.service3DSpaceUrl+f.url:r.service3DSpaceUrl+f.url+"?tenant="+r.tenant;let a,d=[];for(a=0;a<e.length;a++){let t=e[a].getActiveRepresentation();d.push(s(t.url))}let l={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:r.securityCtx?r.securityCtx:"preferred"},data:JSON.stringify(d),onComplete:n=>{let r=JSON.parse(n);for(a=0;a<e.length;a++){let n=r[a].fileurl;this.downloadSingle(e[a],t,i,n)}},onFailure:()=>{this.downloadOneByOne(e,t,i)}};n.authenticatedRequest(o,l)},u})),define("DS/3DXMTiles/LDHBatchModel3DHandlerDOS",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/WAFData/WAFData","DS/3DXMTiles/MultiPartLoader"],(function(e,t,n,i,r){"use strict";return class extends t{constructor(e,n){super(t.Model3DHandler),this.loadModelOptions=null,this.manager=null,this.tenant=null,this.getSecurityParamsCB=e.getSecurityParamsCB||null,this.referenceToContext=new Map,this.toLoadQueue=[],this.nbTickets=40,this.maxTicketSize=20971520,this.useBatch=n,this.multiPartLoader=null}isReady(){return this.nbTickets>0}setFileType(e){}setLoadModelOptions(e){this.loadModelOptions=e}getBatchSize(){return 40}handleReferences(e,t){var n=this.getSecurityParamsCB();n.securityCtx&&n.securityCtx,n.userLogin;this.manager=t.manager._ldhNodeManager,this.multiPartLoader||(this.multiPartLoader=new r({onModelLoaded:this.onModelLoaded.bind(this),onModelError:this.onModelError.bind(this),manager:this.manager,saveToBank:!1}));var i,o,s,a=this.manager,d=[];for(o=0;o<e.length;o++)i=e[o],this.referenceToContext.set(i,t),(s=i.getActiveRepresentation())!==i.getPrimaryRepresentation()&&s.buildNode(),d.push(s.url),this.nbTickets--,i.requestBuildSceneGraphHierarchy(!0);a.tryBuildSceneGraphHierarchy();let l=d[0].indexOf("/file/"),h=d[0].substring(0,l);this.useBatch?this.downloadPerBatch(e,h,d,!0):this.downloadOneByOne(e,h,d)}downloadPerBatch(e,t,n,r){let o=t+"/batch/downloadticket";i.authenticatedRequest(o,{data:JSON.stringify(n),authentication:"passport",cors:!0,method:"POST",headers:{"Content-type":"application/json",Accept:"application/json"},proxy:"passport",onComplete:i=>{let o=JSON.parse(i),s=!1;if(r){let i,r=0,a=0;for(i=0;i<o.results.length;i++)if(r+=parseInt(o.results[i].filesize),r>this.maxTicketSize||s&&i===o.results.length-1){s=!0;let o=e.slice(a,i+1),d=n.slice(a,i+1);this.downloadPerBatch(o,t,d,!1),a=i+1,r=0}}s||this.multiPartLoader.loadFromFCSTicket(o.url,o.ticket,e,!1)},onFailure:t=>{let n;for(n=0;n<e.length;n++)this.onModelError(e[n])}})}downloadOneByOne(e,t,r){let o=t+"/batch/fileurls";i.authenticatedRequest(o,{data:JSON.stringify(r),authentication:"passport",cors:!0,method:"POST",headers:{"Content-type":"application/json",Accept:"application/json"},proxy:"passport",onComplete:t=>{let i,r=JSON.parse(t);for(i=0;i<r.length;i++){let t=r[i].url,o=e[i];n._loadModel(t,o,this.onModelLoaded.bind(this,o),this.onModelError.bind(this,o),null,"cgr",this.loadModelOptions,this.manager)}},onFailure:t=>{let n;for(n=0;n<e.length;n++)this.onModelError(e[n])}})}onModelLoaded(e,t){this.nbTickets++;e.getActiveRepresentation();t&&t.nodes&&this.dbgSetupNodes(t.nodes,"green"),n.statsInit(),n.statsOnLoadedModel();e.referenceId;var i=this.referenceToContext.get(e);this.referenceToContext.delete(e);var r=i.manager;this.commitModelLoadedTransaction(e,r,t),i.doneCB([e],[])}onModelError(e){this.nbTickets++;e.referenceId;var t=this.referenceToContext.get(e);this.referenceToContext.delete(e),t.doneCB([],[e])}isDOSUrl(e){return e&&e.indexOf("-dos.")>=0&&e.indexOf("/file/")>=0}acceptsRepresentation(e,t){return this.isDOSUrl(e.url)}handleBatch(e,t){this.handleReferences(e.references,t)}}})),define("DS/3DXMTiles/LDHHandlerOOCAdapter",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/OOCPath"],(function(e,t){"use strict";var n=function(t){e.call(this,t.type),this.oocHandler=t};return(n.prototype=Object.create(e.prototype)).handleReferences=function(e,n,i,r){var o,s,a=[];for(o=0;o<e.length;o++){var d=e[o];(s=t.buildFromReference(d,!0,r,this.oocHandler.manager))&&a.push(s)}var l={viewpointTag:n.viewpointTag,doneCB:this.adapterDoneCB.bind(this,n),screenRadius:n.screenRadius,viewpoint:n.viewpoint,screenWidth:n.screenWidth,screenHeight:n.screenHeight};this.oocHandler.handlePathes(a,l,i)},n.prototype.isReady=function(){return this.oocHandler.isReady()},n.prototype.getBatchSize=function(){return this.oocHandler.getBatchSize()},n.prototype.adapterDoneCB=function(e,t,n){var i,r,o=[],s=[];for(i=0;i<t.length;i++)(r="string"==typeof t[i]?this.oocHandler.manager._getLDHReference(t[i],!0):t[i]._ldhReference)&&o.push(r);for(i=0;i<n.length;i++)r="string"==typeof n[i]?this.oocHandler.manager._getLDHReference(n[i]):n[i]._ldhReference,s.push(r);e.doneCB(o,s)},n})),define("DS/3DXMTiles/OOCHandler",["DS/3DXMTiles/LDHHandlerOOCAdapter"],(function(e){"use strict";var t=0,n=function(n,i){this.type=n,this.id=t++,this.ldhHandler=i||new e(this)};return n.prototype.handlePathes=function(e,t){},n.prototype.getBatchSize=function(){return 1},n.Model3DHandler=0,n.InstRefHander=1,n.TileSetHandler=2,n})),define("DS/3DXMTiles/OOCDefaultRefHandler",["DS/3DXMTiles/OOCHandler"],(function(e){"use strict";var t=function(t,n){e.call(this,e.InstRefHander)};return(t.prototype=Object.create(e.prototype)).handlePathes=function(e,t){},t.prototype.getBatchSize=function(){return 1},t.prototype.isReady=function(){return!0},t})),define("DS/3DXMTiles/OOCModel3DZipHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHZipHandler"],(function(e,t){var n=function(n){var i=new t(n=n||{});e.call(this,e.Model3DHandler,i)};return n.prototype=Object.create(e.prototype),n})),define("DS/3DXMTiles/VDRPInstanceOverrideSetManager",["DS/3DXMTiles/VDRPInstanceOverrideSet","DS/SceneGraphOverrides/SceneGraphOverrideSetManager"],(function(e,t){"use strict";return class{constructor({nodeId:e,oocManager:n,active:i}){this.nodeId=e||null,this._overrideSetManagers=[],this._vdrpOverrideSets=[],this._oocManager=n,this.active=void 0===i||i;let r,o=n._pgManager.getOOCDerivedInstanceIds(e),s=n._ldhNodeManager.viewer._getIdPathOverrideWatcher();for(r=0;r<o.length;r++){let e=new t({active:this.active,nodeId:o[r],idPathOverrideWatcher:s});this._overrideSetManagers.push(e)}}pushSceneGraphOverrideSet(e,t){return this.insertSceneGraphOverrideSetAt(e,this._vdrpOverrideSets.length,t)}getSceneGraphOverrideSetAt(e){return this._vdrpOverrideSets[e]}getNumberOfSceneGraphOverrideSets(){return this._vdrpOverrideSets.length}getSceneGraphOverrideSetIndex(e){var t,n=-1;for(t=0;t<this._vdrpOverrideSets.length&&n<0;t++)this._vdrpOverrideSets[t]===e&&(n=t);return n}getSceneGraphOverrideSetByName(e){for(var t=0;t<this._vdrpOverrideSets.length;t++){var n=this._vdrpOverrideSets[t];if(n&&n.name===e)return n}return null}getSceneGraphOverrideSetsByPrefix(e){for(var t=[],n=0;n<this._vdrpOverrideSets.length;n++){var i=this._vdrpOverrideSets[n];i&&i.name.startsWith(e)&&t.push(i)}return t}removeSceneGraphOverrideSet(e){var t=this.getSceneGraphOverrideSetIndex(e);this.removeSceneGraphOverrideSetAt(t)}removeSceneGraphOverrideSetAt(e){if(e>-1&&e<this._vdrpOverrideSets.length){var t=this._vdrpOverrideSets.concat([]);let n;for(t.splice(e,1),this._vdrpOverrideSets=t,n=0;n<this._overrideSetManagers.length;n++)this._overrideSetManagers[n].removeSceneGraphOverrideSetAt(e)}}insertSceneGraphOverrideSetAt(t,n,i){if(!(t instanceof e))throw new Error("sceneGraphOverrideSet must be a VDRPInstanceOverrideSet");if(i=i||{},this._checkSceneGraphOverrideSetParameters(t,i)){if(!(this.getSceneGraphOverrideSetIndex(t)>=0)){var r=this._vdrpOverrideSets.concat([]);let e;for(r.splice(n,0,t),this._vdrpOverrideSets=r,e=0;e<this._overrideSetManagers.length;e++)this._overrideSetManagers[e].insertSceneGraphOverrideSetAt(t._sceneGraphOverrideSetArray[e],n,i);return!0}console.warn("SceneGraphOverrideSet already active")}else console.warn("SceneGraphOverrideSet not added because either prefixPathes or substractive path were missing/incorrect/provided.\nPlease check VDRPInstanceOverrideSetManager methods documentation");return!1}clear(){let e;for(this._vdrpOverrideSets=[],e=0;e<this._overrideSetManagers.length;e++)this._overrideSetManagers[e].clear()}hasSceneGraphOverrideSet(){return this._sceneGraphOverrideSetArray.length>0}createSceneGraphOverrideSet(t){(t=t||{}).rootNode=null,t.nodeId=null,t.rootId=null;let n,i=[];for(n=0;n<this._overrideSetManagers.length;n++){let e=this._overrideSetManagers[n];i.push(e.createSceneGraphOverrideSet(t))}return new e({sceneGraphOverrideSetArray:i,oocManager:this._oocManager,rootId:this.nodeId})}exportIdPathOverrides(e){let t,n=null;for(t=0;t<this._overrideSetManagers.length;t++){let i=this._overrideSetManagers[t].exportIdPathOverrides(e);i&&(n=n||[],n=n.concat(i))}return n}_activate(){let e;for(e=0;e<this._overrideSetManagers.length;e++)this._overrideSetManagers[e]._activate()}_deactivate(){let e;for(e=0;e<this._overrideSetManagers.length;e++)this._overrideSetManagers[e]._deactivate()}_refresh(e){let t;for(t=0;t<this._overrideSetManagers.length;t++)this._overrideSetManagers[t]._refresh(e)}_checkSceneGraphOverrideSetParameters(e,t){return!(!this.nodeId||this.nodeId!==e._rootId)||(console.warn("SceneGraphOverrideSet root must be equal to VDRPInstanceOverrideSetManager root"),!1)}_hasIdPathOverride(e){var t;for(t=0;t<this._vdrpOverrideSets.length;t++)if(this._vdrpOverrideSets[t]._hasIdPathOverride(e))return!0;return!1}_getIdPathPositionOverride(e){var t,n,i=null;for(t=0;t<this._vdrpOverrideSets.length;t++)null!==(n=this._vdrpOverrideSets[t]._getIdPathPositionOverride(e))&&(i=n);return i}_getIdPathOverrideWatcher(){return this._overrideSetManagers[0]._getIdPathOverrideWatcher()}_removeNodeId(){let e;for(e=0;e<this._overrideSetManagers.length;e++)this._overrideSetManagers[e]._removeNodeId()}dispose(){let e;for(e=0;e<this._overrideSetManagers.length;e++)this._overrideSetManagers[e].dispose();this._overrideSetManagers=null,this._vdrpOverrideSets=null}_setOOCManager(e){let t;for(t=0;t<this._overrideSetManagers.length;t++)this._overrideSetManagers[t]._setOOCManager(e)}_setPGManager(e){let t;for(t=0;t<this._overrideSetManagers.length;t++)this._overrideSetManagers[t]._setPGManager(e)}}})),define("DS/3DXMTiles/DSTilesContentSet",["DS/3DXMTiles/DSTilesContent"],(function(e){"use strict";class t{constructor(e,t){this.contents=e,this.spec=t}getSize(){return this.contents.length}needsSgNode(){let e;for(e=0;e<this.contents.length;e++)if(this.contents[e].needsSgNode())return!0;return!1}showContent(e){let t;for(t=0;t<this.contents.length;t++)if(!this.contents[t].contentToken)return!1;for(t=0;t<this.contents.length;t++)this.contents[t].showContent(e);return!0}hideContent(e){let t;for(t=0;t<this.contents.length;t++)if(!this.contents[t].contentToken)return!1;for(t=0;t<this.contents.length;t++)this.contents[t].hideContent(e);return!0}deleteContent(e){let t;for(t=0;t<this.contents.length;t++)if(!this.contents[t].contentToken)return!1;for(t=0;t<this.contents.length;t++)this.contents[t].deleteContent(e);return!0}exportContent(e){let t,n=null;for(t=0;t<this.contents.length;t++){let i=this.contents[t].exportContent(e);i&&(n||(n=[]),n=n.concat(i))}return n}getSourcesWithContents(e,t){let i,r=new Map,o=t||this.contents;for(i=0;i<o.length;i++){let t=o[i];if(t){let i=t.getSourceIdWithParamsArray(e);if(i){let e;for(e=0;e<i.length;e++){let o=i[e],s=o.sourceId,a=r.get(s);a||(a=new n(s),r.set(s,a)),a.contents.push(t),a.sourceParams.push(o.params)}}}}let s=[];return r.forEach((e=>{s.push(e)})),s}getSourceWithContents(e,t){let n=this.getSourcesWithContents(t);if(!e)return 1===n.length?n[0]:null;{let t;for(t=0;t<n.length;t++)if(n[t].sourceId===e)return n[t]}return null}getContentLoaders(){let e,t=[];for(e=0;e<this.contents.length;e++){let n=this.contents[e].contentLoader;t.indexOf(n)<0&&t.push(n)}return t}invalidateContentTokens(e){let t;for(t=0;t<this.contents.length;t++){this.contents[t].invalidateContentTokens(e)}}getContentsWithContentLoader(e){let t,n=[];for(t=0;t<this.contents.length;t++){this.contents[t].contentLoader===e&&n.push(this.contents[t])}return n}getFileSize(){let e,t=0;for(e=0;e<this.contents.length;e++)t+=this.contents[e].fileSize;return t}hasContentType(e){let t;for(t=0;t<this.contents.length;t++)if(this.contents[t].type.toLowerCase()===e.toLowerCase())return!0;return!1}getUris(){let e,t=[];for(e=0;e<this.contents.length;e++)t.push(this.contents[e].uri);return t}getSpec(){return this.spec}getContentFromContentLoader(e){let t,n=null;for(t=0;t<this.contents.length;t++){let i=this.contents[t];if(i.contentLoader===e){if(null!==n)return null;n=i}}return n}getAttributeValue(e,t){let n=0,i=null;for(n=0;null===i&&n<this.contents.length;n++)i=this.contents[n].getAttributeValue(e,t);return i}getPathElementsLeadingToAttribute(e,t,n){let i=0,r=[];for(i=0;i<this.contents.length;i++)this.contents[i].getPathElementsLeadingToAttribute(e,t,n,r);return r}getAllAttributes(e){let t=0,n=[];for(t=0;t<this.contents.length;t++){let i=this.contents[t].getAllAttributes(e);n=i?n.concat(i):n}return n}}t.create=function(n,i,r){let o=null;if(n){let s=[];if(Array.isArray(n)){let t=0;for(t=0;t<n.length;t++)n[t].uri&&s.push(new e(n[t],i,n[t].contentMetaData||null))}else if(n.uri){let t=r&&r[n.type]||null;s.push(new e(n,i,n.contentMetaData||t))}s.length>0&&(o=new t(s,n))}return o};class n{constructor(e,t){this.sourceId=e,this.contents=[],this.sourceParams=[],this.options=t||null}}return t})),define("DS/3DXMTiles/DSTilesTerrainContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/Visualization/ThreeJS_DS","DS/Visualization/ImageUtils","DS/Visualization/Mesh3D","DS/Mesh/Mesh","DS/3DXMTiles/DSTilesSourceIdWithParams"],(function(e,t,n,i,r,o){"use strict";function s(e){const t=e.BYTES_PER_ELEMENT;if(1===t)return e;const n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0;e<n.length;e+=t)for(let i=0;i<t/2;i++){const r=t-1-i,o=n[e+i];n[e+i]=n[e+r],n[e+r]=o}return e}function a(e){this.sourceIds=[];for(let t in e.contentSources)this.sourceIds.push(t)}return class extends e{constructor(e){super(e),this.tileSetDataMap=new WeakMap,this.nbTickets=10}getBudgetParams(){return{name:"terrain",physicalBudget:"gpu"}}getSourceIdWithParamsArray(e,t){let n,i=this.getTileSetData(t.tileSet).sourceIds,r=[];for(n=0;n<i.length;n++)r.push(new o(i[n],{name:i[n]}));return r}isReady(){return this.nbTickets>0}isThereEnoughMemoryToLoad(e,t){return t.isLoadingAllowed()}_fetchElevation(e,t,n){for(let i of n.elevations)if(i.source===t){s(e=new Float32Array(e));const t=e.length-2;return{...i,data:e,num_vertices:t}}return null}_fetchMap(e,i,r){if(!e||0===e.byteLength)return null;for(let o in r.maps){const s=r.maps[o];if(s.source===i){let i=null;if("basis"!==s.type){const t=URL.createObjectURL(new Blob([e],{type:`image/${s.type}`}));i=new Promise(((e,i)=>n.Utils.loadTexture(t,null,e,i)))}else i=new Promise(((n,i)=>t.ImageUtils.loadBasisTexture(new Uint8Array(e),null,n,i,!0,t.BasisUsage.RGB,!1,void 0)));return{padding:0,...s,name:o,data:e,texture:i}}}return null}_computeBBox(e,n){let i=new t.Box3,r=n.boundaries&&n.boundaries.box;i.setFromJSON(r);let o=e.metaData,s=Math.pow(2,o.level),a=(i.max.x-i.min.x)/s,d=(i.max.y-i.min.y)/s,l=o.coords[0],h=o.coords[1];return new t.Box3(new t.Vector3(i.min.x+l*a,i.min.y+h*d,i.min.z),new t.Vector3(i.min.x+(l+1)*a,i.min.y+(h+1)*d,i.max.z))}_initializeNode(e,n,o){const s=this._createMaterial(n),a=new t.BufferGeometryDS,d=new r.DrawingGroup(null,s,5,0,0);d.geometry=a,a.drawingGroups=[d];const l=new t.Mesh(a,s),h=new i(l,`Terrain/${e.uri}`);h.setUserData({dsTilesNode:e});const c=this._computeBBox(o,n);let u=new t.Vector3(c.min.x,c.min.y,0);return h.setMatrix((new t.Matrix4).setPosition(u)),u=u.negate(),this._updateMaterial(s,{bbox:c}),a.boundingBox=c.clone().translate(u),a.boundingSphere=e.getBoundingSphere().clone().translate(u),h.explicitBSphere.copy(a.boundingSphere),h.explicitBBox.copy(a.boundingBox),{mesh3D:h,bgds:a,material:s}}_updateElevation(e,t,n){const i=e.getBuffersMemorySize();e.clear();const r=n.size=Math.floor(Math.sqrt(n.num_vertices));e.layout.set({elevation:{bufferId:0,offset:0,stride:4,type:"float32"},index:{bufferId:1,offset:0,stride:4,type:"float32"}}),e.buffers[0]=n.data.subarray(0,n.num_vertices),e.buffers[1]=Float32Array.from({length:n.num_vertices},((e,t)=>t)),e.vertexIndexArray=function({start_x:e,start_y:t,height:n,width:i,use32bitIndices:r,index_of:o}){const s=2*(n-1)*i,a=r?new Uint32Array(s):new Uint16Array(s);let d=0;for(let r=0;r+1<n;r++){const n=r%2==0?(n,i)=>a[d++]=o(e+n,t+r+i):(n,s)=>a[d++]=o(e+i-1-n,t+r+s);for(let e=0;e<i;e++)n(e,0),n(e,1)}return a}({start_x:n.padding,start_y:n.padding,width:r-2*n.padding,height:r-2*n.padding,use32bitIndices:n.num_vertices>65535,index_of:(e,t)=>e+t*r}),e.drawingGroups[0].count=e.vertexIndexArray.length,this._updateMaterial(t,{elevation:n});const o=e.getBuffersMemorySize();this.budget.updateUsageDelta(o-i)}_updateMap(e,t,n){t.texture=n,this._updateMaterial(e,{map:t})}loadContentFromBuffer({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,sourceId:o,params:s}){const a=t.tileSet.contentMetaData.terrain;n.contentToken||n.setContentToken(Object.assign({node:t},this._initializeNode(t,a,n)));const{bgds:d,material:l}=n.contentToken,h=this._fetchElevation(e,o,a);h&&this._updateElevation(d,l,h);const c=this._fetchMap(e,o,a);c?c.texture.then((e=>{this._updateMap(l,c,e),i()})).catch(r):i()}showContent(e,t){let n=t.contentToken;n.node.getSgNode().addChild(n.mesh3D)}hideContent(e,t){let n=t.contentToken;n.node.getSgNode().removeChild(n.mesh3D)}deleteContent(e,t){let n=t.contentToken;this.hideContent(e,t),n.mesh3D=null,n.bgds=null,n.material=null}exportContent(e,t){}getTileSetData(e){let t=this.tileSetDataMap.get(e);return t||(t=new a(e),this.tileSetDataMap.set(e,t)),t}_make_rect(e,n,i,r){return new t.Vector4(e,n,i-e,r-n)}_getMapWeight(e,t){return e.renderInfo.mapWeights[t]}_updateMaterial(e,{bbox:n,elevation:i,map:r}){if(n&&e.updatePDSFXUniform("rect_world",this._make_rect(n.min.x,n.min.y,n.max.x,n.max.y)),i&&e.updatePDSFXUniform("heightmap_shape",new t.Vector2(i.size,i.padding)),r){const{width:t,height:n}=r.texture.image,i=this._make_rect(r.padding/t,r.padding/n,(t-r.padding-1)/t,(n-r.padding-1)/n);e.updatePDSFXUniform(`terrain_${r.name}`,r.texture),e.updatePDSFXUniform(`terrain_${r.name}_rect`,i)}}_createMaterial(e){const n=new t.MeshBasicMaterial({opacity:e.renderInfo.opacity,side:t.DoubleSide,force:!0});n.activatePDSFX(),n.setPDSFXAttributes({elevation:{type:"f"},index:{type:"f"}});const i=this;n.setPDSFXGlobalShaderCode((function(e){const t=e.variableHandler,n=e.functionHandler,i=e.bridgeFunctions,r=t=>e.getUniform(t),o=e=>t.int(e),s=e=>t.float(e),a=e=>t.vec2(e),d=e=>t.ivec2(e);return`\n                    ${n.dF("get_heightmap_coords","i2",[])} {\n                        ${o("iHShape")} = ${r("heightmap_shape")}.x;\n                        ${s("hShape")} = ${s()}(iHShape);\n                        return ${d()}(\n                            ${o()}(${i.modulo("index","hShape")}),\n                            ${o()}(index) / iHShape\n                        );\n                    }\n                    ${n.dF("get_heightmap_uv","v2",[])} {\n                        ${d("iHShape")} = ${r("heightmap_shape")};\n                        ${d("heightCoords")} = ${n.cF("get_heightmap_coords","i2",[])};\n                        ${s("denom")} = ${s()}(iHShape.x - 2 * iHShape.y - 1);\n                        ${a("uv_")} = ${a()}(heightCoords - ${d()}(iHShape.y, iHShape.y)) / denom;\n                        uv_.y = 1.0 - uv_.y;\n                        return uv_;\n                    }\n                    ${n.dF("get_heightmap_pos","v3",[])} {                 \n                        ${a("U")} = ${n.cF("get_heightmap_uv","v2",[])};\n                        return ${t.vec3(l)}(U * ${r("rect_world")}.zw, elevation);\n                    }\n                `;var l}),(function(t){const n=t.variableHandler,r=t.functionHandler,o=t.bridgeFunctions,s=e=>t.getUniform(e),a=e=>n.float(e),d=e=>n.vec3(e);let l=`\n                    ${r.dF("compute_normal","v3",[])} {   \n                        ${d("p")} = ${t.vGetViewPosition()}.xyz;\n                        ${d("x")}  = ${o.dpdx("p")};\n                        ${d("y")}  = ${o.dpdy("p")};\n                        ${d("normal")}  = normalize(cross(x, y));\n\n                        // counter the flipping that occur later in the code\n                        ${a("front_facing")} = 2.0 * ${a()}(${t.vIsFrontFacing()}) - 1.0;\n                        return normal * front_facing;\n                    }\n                    ${r.dF("sample_terrain_maps","v3",[r.prmV2("uv_")])} {   \n                        ${d("color")}  = ${d()}(0.0);\n                        ${a("weight")}  = 0.0;\n                `;for(let n in e.maps)l=`\n                        ${l}\n                        ${a(`w_${n}`)}  = ${a()}(${i._getMapWeight(e,n)});\n                        color += w_${n} * ${o.sample2DTexture((h=`terrain_${n}`,t.getTextureUniform(h)),`${s(`terrain_${n}_rect`)}.xy + uv_ * ${s(`terrain_${n}_rect`)}.zw`)}.xyz;\n                        weight += w_${n};\n                    `;var h;return l=`\n                    ${l}\n\t\t\t\t\treturn color / weight;\n                }\n                `,l}));const r={rect_world:{type:"v4"},heightmap_shape:{type:"i2",stage:t.VertexStage,value:new t.Vector2(0,0)}};for(let n in e.maps)r[`terrain_${n}`]={type:"t2"},r[`terrain_${n}_rect`]={type:"v4",value:new t.Vector4};n.setPDSFXUniforms(r),n.setPDSFXVaryings({heightmap_uv:{type:"v2"}});return n.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){const n=e.functionHandler;return`\n                        ${i="heightmap_uv",e.getVarying(i)} = ${n.cF("get_heightmap_uv","v2",[])};\n                    `;var i},ComputeObjectPosition:function(e,t){return`\n                        return ${e.functionHandler.cF("get_heightmap_pos","v3",[])};\n                    `}},{ComputeViewNormal:function(e,t){return`\n                        return ${e.functionHandler.cF("compute_normal","v3",[])};\n                    `},ComputeAlbedo:function(e,t){const n=e.variableHandler,i=e.functionHandler;return`       \n\t\t\t\t\t\t${r="uv",n.vec2(r)}  = ${(t=>e.getVarying(t))("heightmap_uv")}.xy;\n\t\t\t\t\t\treturn ${i.cF("sample_terrain_maps","v3",[i.prmV2("uv")])} * abs(${i.cF("compute_normal","v3",[])}.z);\n                    `;var r}}),n}}})),define("DS/3DXMTiles/LDHBatchModel3DHandlerBank",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHModelLoader","DS/3DXMTiles/ModelBank","DS/Visualization/Node3D"],(function(e,t,n,i,r,o,s){"use strict";var a=function(e,n){t.call(this,t.Model3DHandler),this.loadModelOptions=null,this.manager=null,this.tenant=null,this.getSecurityParamsCB=e.getSecurityParamsCB||null,this.referenceToContext=new Map,this.toLoadQueue=[],this.maxNbLoading=40,this.nbTickets=120,this.nbLoading=0};(a.prototype=Object.create(t.prototype)).isReady=function(){return 0===this.nbLoading},a.prototype.setFileType=function(e){},a.prototype.setRedirectUrlCB=function(){},a.prototype.setAutoRedirect=function(){},a.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},a.prototype.updateTenant=function(){this.tenant=this.getSecurityParamsCB?this.getSecurityParamsCB().tenant:"#NONE#"},a.prototype.handleReferences=function(e,t){this.tenant||this.updateTenant(),this.manager=t.manager._ldhNodeManager;var n,i,r,s=this.manager,a=[];for(i=0;i<e.length;i++)n=e[i],this.referenceToContext.set(n,t),r=n.getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0),a.push(r.type);s.tryBuildSceneGraphHierarchy();var d=this.onModelLoaded.bind(this),l=this.onModelError.bind(this);for(i=0;i<e.length;i++)(r=(n=e[i]).getActiveRepresentation())!==n.getPrimaryRepresentation()&&r.buildNode(),r.node,this.nbLoading++;try{o.oocRetrieveModelData(e,a,this.tenant,this,d,l)}catch(t){try{o.clear()}catch{}for(o.setDisabled(!0),i=0;i<e.length;i++)this.onModelError(e[i])}},a.prototype.onModelBankData=function(e,t,i,a,d){if(a){if(!e.getActiveRepresentation().node)return void i(e);let u=new s,p=this.manager,g=r.getModelLoader();g.setOnLoadedProductStructureCallback((function(i){n.addToSceneGraph(p,u,l,(()=>{t(e,i)}))})),g.setOnErrorCallback((function(){o.removeKeys([d],!0),i(e)}));var l=e.getActiveRepresentation(),h=e.getPrimaryRepresentation(),c={};n.setupModelLoaderOptions(g,c,e,l,h,this.manager,a),g.loadModelFromBuffer(a,u,c)}else o.removeKeys([d],!0),i(e)},a.prototype.onModelLoaded=function(e,t){this.nbLoading--;e.getActiveRepresentation();t&&t.nodes&&this.dbgSetupNodes(t.nodes,"green"),n.statsInit(),n.statsOnLoadedModel();e.referenceId;var i=this.referenceToContext.get(e);this.referenceToContext.delete(e);var r=i.manager;this.commitModelLoadedTransaction(e,r,t),i.doneCB([e],[])},a.prototype.onModelError=function(e){this.nbLoading--;var t=e.referenceId;let n=!1,i=e.getActiveRepresentation();if(i){let e=i.type,r=o.buildKey(t,e,this.tenant);o.removeKeys([r],!0),n=!0}var r=this.referenceToContext.get(e);this.referenceToContext.delete(e),r.doneCB([],[e],{retry:n})},a.prototype.acceptsRepresentation=function(e,t){return this.tenant||this.updateTenant(),!!o.hasModelData(t.referenceId,e.type,this.tenant,e.wms)};var d=function(e){this.handler=e,this.references=[]};return d.prototype.containsReference=function(e){return this.references.indexOf(e)>=0},d.prototype.addReferenceIfPossible=function(e,t){return t=t||e.getActiveRepresentation(),!!(o.hasModelData(e.referenceId,t.type,this.handler.tenant,t.wms)&&this.references.length<this.handler.nbTickets)&&(this.references.push(e),!0)},d.prototype.isEmpty=function(){return 0===this.references.length},d.prototype.getSize=function(){return this.references.length},d.prototype.setReferencesLoading=function(e){var t,n,i=this.references;for(t=0;t<i.length;t++)(n=i[t]).isLoading()||n.setLoading(e)},a.prototype.handleBatch=function(e,t){this.handleReferences(e.references,t)},a.prototype.createBatch=function(){return new d(this)},a})),define("DS/3DXMTiles/UnloadManager",["DS/3DXMTiles/ExtraMemoryBudgetManager","DS/QualityManager/QMController"],(function(e,t){"use strict";var n=-2,i=!!window.OOCForceExtendedMemory,r=window.performance.memory;r&&r.jsHeapSizeLimit>4e9&&(i=!0);var o={v0:{memoryLimitMb:512,memoryLimitGPUMb:512},full:{memoryLimitMb:i?512:256,memoryLimitGPUMb:i?2048:1024},medium:{memoryLimitMb:64,memoryLimitGPUMb:64},medium_plus:{memoryLimitMb:64,memoryLimitGPUMb:128},restricted:{memoryLimitMb:48,memoryLimitGPUMb:32}},s=function(i,r,s){var a;if("string"!=typeof i)a=i;else{let e="auto"===i?this.getConfig():i;a=o[e]}var d=a.memoryLimitMb,l=a.memoryLimitGPUMb;this.absoluteUnloadLimit="true"===localStorage.getItem("OOCAbsoluteUnloadLimit"),this.isRestricted="restricted"===i,this.oocManager=s,this.extraMemoryBudgetManager=new e(this),-2===n&&void 0!==window.OOCUnloadMemoryLimit&&(n=window.OOCUnloadMemoryLimit),this.config=i,this.unloadAlwaysTab=[!1,!1],this.hasUnloadAlways=!1,window.OOCUnloadAlways&&this.setUnloadAlwaysTab([!0,!0]),n>=0&&(d=n,l=n),this.memoryUsage=0,this.memoryUsageMeshInRAM=0,this.memoryUsageGPU=0,this.initialMemoryLimit=1024*d*1024,this.memoryLimit=this.initialMemoryLimit,this.meshInRAMRatio=0,this.memoryLimitMeshInRAM=0,this.memoryLimitGPU=1024*l*1024,this.initialMemoryLimitGPU=this.memoryLimitGPU,this.usage=0,this.usageMeshInRAM=0,this.usageGPU=0,this.memoryPeak=0,this.memoryPeakGPU=0,this.flashMode=!1,this.flashUnload=!1,this.unloadThreshold=.95,this.emergencyUnloadThreshold=1.1,window.debugUnloadManager=this,this.hasMeshInRAM=!1,this.autoMeshInRAMChange=!1,this.autoMeshInRAM="auto"===r,this.meshInRAM="on"===r,t.getLDHOpt1ExtendMemory()?this.maxPossibleExtraBudgetGPU=5368709120:this.maxPossibleExtraBudgetGPU=0,this.remainingExtraBudgetGPU=this.maxPossibleExtraBudgetGPU,this.extraBudgetGPUDelta=1073741824};return s.prototype.setHasMeshInRam=function(e){e&&!this.hasMeshInRAM&&(this.hasMeshInRAM=!0,this.meshInRAMRatio=.1,this.updateMeshInRAMLimits())},s.prototype.updateMeshInRAMLimits=function(){this.memoryLimitMeshInRAM=Math.floor(this.meshInRAMRatio*this.initialMemoryLimit),this.memoryLimit=this.initialMemoryLimit-this.memoryLimitMeshInRAM},s.prototype.setFlashMode=function(e){this.flashMode=e},s.prototype.tryToRaiseMeshInRAMLimit=function(){if(this.hasMeshInRAM&&.8*this.memoryLimitMeshInRAM<this.memoryUsageMeshInRAM){for(var e=this.meshInRAMRatio;e*this.initialMemoryLimit*.8<this.memoryUsageMeshInRAM&&(1-e)*this.initialMemoryLimit>this.memoryUsage&&e<.9;)e=1-.75*(1-e);this.meshInRAMRatio!==e&&(this.meshInRAMRatio=e,this.updateMeshInRAMLimits())}},s.prototype.restoreMemoryFromMeshInRAM=function(){var e=Math.min(this.memoryUsageMeshInRAM,this.memoryLimitMeshInRAM);0===this.memoryUsageMeshInRAM&&(this.hasMeshInRAM=!1),this.memoryLimit=this.initialMemoryLimit-e,this.memoryLimitMeshInRAM=e,this.meshInRAMRatio=this.memoryLimitMeshInRAM/this.initialMemoryLimit,this.tryToRaiseMeshInRAMLimit()},s.prototype.onReferenceMemoryDataChange=function(e,t,n){this.memoryUsage+=t.memory-e.memory,this.memoryUsageGPU+=t.memoryGPU-e.memoryGPU,(n||this.hasMeshInRAM)&&this.setHasMeshInRam(!0),this.memoryUsageMeshInRAM+=t.memoryMeshInRAM-e.memoryMeshInRAM,this.tryToRaiseMeshInRAMLimit(),this.autoMeshInRAM&&.25*this.initialMemoryLimit<this.memoryUsageMeshInRAM&&(this.autoMeshInRAM=!1,this.autoMeshInRAMChange=!0),this.updateUsage()},s.prototype.beforeLoadedNodesQueueTraversal=function(){this.flashUnload=!1,this.isUnloadNeeded()&&(this.flashUnload=!0,this.autoMeshInRAM&&(this.autoMeshInRAM=!1,this.autoMeshInRAMChange=!0))},s.prototype.afterLoadedNodesQueueTraversal=function(){this.flashUnload=!1},s.prototype.requestExtraBudgetIfNeeded=function(){this.remainingExtraBudgetGPU>0&&this.memoryUsageGPU>=.8*this.memoryLimitGPU&&this.requestExtraBudget()},s.prototype.isLoadingAllowed=function(e){return this.tryToRaiseMeshInRAMLimit(),0===e?(this.requestExtraBudgetIfNeeded(),this.memoryUsageGPU<this.memoryLimitGPU&&(!this.hasMeshInRAM||this.memoryUsageMeshInRAM<this.memoryLimitMeshInRAM)):this.memoryUsage<this.getMemoryLimit()},s.prototype.isUnloadSmalNodesRequired=function(){return this.memoryUsage>.9*this.getMemoryLimit()||this.memoryUsageGPU>.9*this.memoryLimitGPU||this.hasMeshInRAM&&this.memoryUsageMeshInRAM>.9*this.memoryLimitMeshInRAM},s.prototype.isEmergencyUnloadRequired=function(e,t){return 0===t?this.isEmergencyUnloadRequiredGPU(e):this.isEmergencyUnloadRequiredCPU(e)},s.prototype.isEmergencyUnloadRequiredCPU=function(e){return e=e||0,this.memoryUsage+e>=this.emergencyUnloadThreshold*this.getMemoryLimit()},s.prototype.isEmergencyUnloadRequiredGPU=function(e){e=e||0;var t=this.memoryUsageGPU+e>=this.emergencyUnloadThreshold*this.memoryLimitGPU;return this.hasMeshInRAM&&(t=t||this.memoryUsageMeshInRAM+e>=this.emergencyUnloadThreshold*this.memoryLimitMeshInRAM),t},s.prototype.isUnloadNeeded=function(e){if(this.flashUnload)return!0;if(void 0===e)return this.isUnloadNeeded(0)||this.isUnloadNeeded(1);if(this.unloadAlwaysTab[e])return!0;if(this.tryToRaiseMeshInRAMLimit(),0===e){this.requestExtraBudgetIfNeeded();let e=this.absoluteUnloadLimit?this.initialMemoryLimitGPU:this.memoryLimitGPU;return this.memoryUsageGPU>.8*e||this.hasMeshInRAM&&this.memoryUsageMeshInRAM>.8*this.memoryLimitMeshInRAM}return this.memoryUsage>.8*this.getMemoryLimit()},s.prototype.updateUsage=function(){this.usage=100*this.memoryUsage/this.getMemoryLimit(),this.usageGPU=100*this.memoryUsageGPU/this.memoryLimitGPU,this.usageMeshInRAM=100*this.memoryUsageMeshInRAM/this.memoryLimitMeshInRAM,this.memoryPeak=this.memoryUsage>this.memoryPeak?this.memoryUsage:this.memoryPeak,this.memoryPeakGPU=this.memoryUsageGPU>this.memoryPeakGPU?this.memoryUsageGPU:this.memoryPeakGPU},s.prototype.setUnloadAlwaysTab=function(e){this.unloadAlwaysTab=e,this.hasUnloadAlways=e[0]||e[1]},s.prototype.wouldDownloadCauseEmergencyUnload=function(e,t){if(0===t.type&&this.isRestricted){var n=t.getMemorizedReferenceSize(e);return n>=0&&this.isEmergencyUnloadRequired(n,0)}return!1},s.prototype.restoreAutoMeshInRAM=function(){this.autoMeshInRAM=!0,this.autoMeshInRAMChange=!1},s.prototype.getMemoryLimit=function(){return this.oocManager.getUsePickingAccelerationStructure()?this.memoryLimit-.05*this.memoryUsageGPU:this.memoryLimit},s.prototype.getConfig=function(){var e="full";return navigator.userAgent.match(/iPad/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1?e="medium":navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)&&(e="restricted"),e},s.prototype.dispose=function(){this.extraMemoryBudgetManager.dispose()},s.prototype.requestExtraBudget=function(){let e=Math.min(this.remainingExtraBudgetGPU,this.extraBudgetGPUDelta),t=this.extraMemoryBudgetManager.requestExtraBudget({memoryGPU:e});this.remainingExtraBudgetGPU=this.maxPossibleExtraBudgetGPU-t.memoryGPU,this.memoryLimitGPU=this.initialMemoryLimitGPU+t.memoryGPU},s})),define("DS/3DXMTiles/DSTilesSelectionManager",["DS/3DXMTiles/DSTilesNode","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager"],(function(e,t,n,i){"use strict";class r{constructor(e,t){this.xso=e,this.selectionManager=t,this.selectedIds=new Map}init(){this.xso.onPreAdd(this.onPreAdd.bind(this)),this.xso.onPreRemove(this.onPreRemove.bind(this)),this.xso.onPreEmpty(this.onPreEmpty.bind(this))}onPreAdd(t){if(!this.selectionManager.freezePropagation){let n,i=[],r=new Set;for(n=0;n<t.length;n++){let o=t[n].pathElement,s=!1;if(o){let t=this.selectionManager.selectionAttribute,n=e.getTileNodeFromPathElement(o);if(n){let e=n.getAttributeValue(t,o);null===e||this.selectedIds.has(e)||(this.selectionManager.addSelectedId_internal(e,n.tileSet,o,i,this),s=!0)}}r.add(t[n])}let o=[];for(n=0;n<i.length;n++)r.has(i[n])||o.push(i[n]);this.selectionManager.freezePropagation=!0,this.xso.add(o),this.selectionManager.freezePropagation=!1}}onPreRemove(t){if(!this.selectionManager.freezePropagation){let n,i=[],r=new Set;for(n=0;n<t.length;n++){let o=t[n].pathElement;if(o){let t=this.selectionManager.selectionAttribute,n=e.getTileNodeFromPathElement(o);if(n){let e=n.getAttributeValue(t,o);i.indexOf(e)<0&&(i.push(e),this.selectedIds.delete(e))}}r.add(t[n])}let o=this.selectionManager.filterItemsWithId(i,this.xso.get()),s=[];for(n=0;n<o.length;n++)r.has(o[n])||s.push(o[n]);this.selectionManager.freezePropagation=!0,this.xso.remove(s),this.selectionManager.freezePropagation=!1}}onPreEmpty(){this.selectedIds.clear()}updateTileNodeSelection(e){let t=[];if(this.selectedIds.forEach((n=>{let i,r=this.selectionManager.selectionAttribute,o=e.tileSet.getPathesLeadingToRoot();for(i=0;i<o.length;i++){let s=e.getPathElementsLeadingToAttribute(r,n.id,o[i].externalPath);if(s){let e=0;for(e=0;e<s.length;e++)t.push({pathElement:s[e]})}}})),t.length>0){this.selectionManager.freezePropagation=!0;try{this.xso.add(t)}catch(e){}this.selectionManager.freezePropagation=!1}}}class o{constructor(e){this.id=e}}return class{constructor(e){this.managersMap=new Map,this.tilesManager=e,this.selectionAttribute="id",this.managersMap.set(t,new r(t,this)),this.managersMap.set(n,new r(n,this)),this.managersMap.set(i,new r(i,this)),this.freezePropagation=!1}init(){this.managersMap.forEach(((e,t)=>{e.init()}))}getRootNodes(){return this.tilesManager.getRootNodes()}updateTileNodeSelection(e){this.managersMap.forEach(((t,n)=>{t.updateTileNodeSelection(e)}))}addSelectedIdsToXSO(e,t,n){this.freezePropagation=!0;try{let i,r=[],o=n.getPathesLeadingToRoot(),s=this.managersMap.get(t);for(i=0;i<e.length;i++){let t;for(t=0;t<o.length;t++)this.addSelectedId_internal(e[i],n,o[t],r,s)}t.add(r)}catch(e){}this.freezePropagation=!1}addSelectedId_internal(e,t,n,i,r){let s=t.getRootNode(),a=null,d=n.externalPath.indexOf(s.getSgNode());if(a=n.externalPath.slice(0,d+1),r&&!r.selectedIds.has(e)&&r.selectedIds.set(e,new o(e)),a){let t=this.selectionAttribute;s.traverse((n=>{let r=n.getPathElementsLeadingToAttribute(t,e,a);if(r&&r.length>0){let e=0;for(e=0;e<r.length;e++)i.push({pathElement:r[e]})}}))}}removeSelectedIdsFromXSO(e,t){let n,i=t.get(),r=this.filterItemsWithId(e,i);if(r.length>0){this.freezePropagation=!0;try{t.remove(r)}catch(e){}this.freezePropagation=!1}let o=this.managersMap.get(t);for(n=0;n<e.length;n++)o.selectedIds.delete(e[n])}filterItemsWithId(t,n){let i=this.selectionAttribute;return n.filter((n=>{let r=n.pathElement,o=e.getTileNodeFromPathElement(r);if(o){let e=o.getAttributeValue(i,r);if(t.indexOf(e)>=0)return!0}return!1}))}}})),define("DS/3DXMTiles/LDHHandlerMultiple",["DS/3DXMTiles/LDHHandler"],(function(e){"use strict";var t=function(e){this.type=0,this.handlers=e.handlers,this.batchSize=e.batchSize||40,this.getSecurityParamsCB=e.getSecurityParamsCB||null};(t.prototype=Object.create(e.prototype)).setLoadModelOptions=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setLoadModelOptions(e)},t.prototype.setFileType=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setFileType(e)},t.prototype.setRedirectUrlCB=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setRedirectUrlCB(e)},t.prototype.setAutoRedirect=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setAutoRedirect(e)},t.prototype.handleBatch=function(e,t){var n,i,r=this.handlers;for(n=0;n<r.length;n++)(i=e.batches[n]).isEmpty()||r[n].handleBatch(i,t)},t.prototype.createBatch=function(){return new n(this,this.batchSize)},t.prototype.isReady=function(){var e,t=this.handlers;for(e=0;e<t.length;e++)if(!t[e].isReady())return!1;return!0};var n=function(e,t){this.maxSize=t,this.handler=e,this.batches=[];var n,i=this.handler.handlers;for(n=0;n<i.length;n++)this.batches.push(i[n].createBatch())};return n.prototype.containsReference=function(e){var t;for(t=0;t<this.batches.length;t++)if(this.batches[t].containsReference(e))return!0;return!1},n.prototype.addReferenceIfPossible=function(e,t){var n,i=this.handler.handlers;for(t=t||e.getActiveRepresentation(),n=0;n<i.length;n++)if(i[n].acceptsRepresentation(t,e))return!!this.batches[n].addReferenceIfPossible(e,t);return!1},n.prototype.isEmpty=function(){var e;for(e=0;e<this.batches.length;e++)if(!this.batches[e].isEmpty())return!1;return!0},n.prototype.getSize=function(){var e,t=0;for(e=0;e<this.batches.length;e++)t+=this.batches[e].getSize();return t},n.prototype.setReferencesLoading=function(e){var t;for(t=0;t<this.batches.length;t++)this.batches[t].setReferencesLoading(e)},t})),define("DS/3DXMTiles/VDRPUtils",["DS/3DXMTiles/VDRPIdPath","DS/Visualization/PathElement","DS/Visualization/IdPath"],(function(e,t,n){"use strict";class i{static computeVDRPIdPathFromPathElement(t,n){let i,r=n._pgManager,o=!1,s=[],a=[],d=-1;for(i=0;d<0&&i<t.externalPath.length;i++){let e=t.externalPath[i].getModelIdentification(),r=n._getLDHReference(e,!0);r&&r.isRoot&&(d=i)}if(d>=0)for(i=d;i<t.externalPath.length;i++){let e=t.externalPath[i].getModelIdentification(),d=n.isPLMInstance(e),l=n.isPLMReference(e);if(d||l){let t=e.split("/");if(s.push(t[0]),d){let e;for(e=1;e<t.length;e++){let n=t[e],i=r.getChildPGReferenceFromPGInstanceId(n);if(0===a.length){let e=r.getParentPGReferenceFromInstanceId(n);a.push(e.referenceId)}a.push(n),a.push(i.referenceId)}}}else o=!0}else o=!0;return o?null:new e(s,a)}static computePathElementsFromVDRPIdPath(e,n,i){let r=e._buildInternalIdPathes(n),o=null;function s(e){return n.getSceneGraphNode(e)||n.getExternalNode(e)}if(r){let e;for(o=[],e=0;e<r.length;e++){let n=r[e];if(n){let e,r=n.ids,a=s(r[0]),d=[];if(i){if(i.children.indexOf(a)<0)return null;d.push(i)}for(e=0;e<r.length;e++){if(a=s(r[e]),!a)return null;d.push(a)}o.push(new t(d))}}}return o}static computePathElementFromVDRPIdPath(e,t,n){let r=i.computePathElementsFromVDRPIdPath(e,t,n);return r&&1===r.length&&r[0]}}return i})),define("DS/3DXMTiles/OOCReferenceIterator",["DS/3DXMTiles/OOCInstanceIterator"],(function(e){"use strict";var t=function(e){this._reference=e};return t.prototype.getReferenceId=function(){return this._reference.referenceId},t.prototype.getParents=function(){var e,n=[];for(e=0;e<this._reference.parents.length;e++)n.push(new t(this._reference.parents[e]));return n},t.prototype.getChildren=function(){var n,i,r=[];for(i=0;i<this._reference.children.length;i++)n=this._reference.children[i],r.push(new e(new t(n.reference),n));return r},t.prototype.getNode=function(){return this._reference.getNode()},t.prototype.equals=function(e){return!!e&&this._reference===e._reference},t.prototype.isRepRef=function(){return this._reference.isLeaf()},t.prototype.getParentInstanceIterators=function(){var n,i=[],r=this._reference.parents;for(n=0;n<r.length;n++){var o,s=r[n],a=null;for(o=0;s.children[o];o++){var d=s.children[o];d.reference===this._reference&&(null===a&&(a={referenceIterator:new t(s),instanceIterators:[]}),a.instanceIterators.push(new e(a.referenceIterator,d)))}null!==a&&i.push(a)}return i},t})),define("DS/3DXMTiles/PGOOCInstanceList",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/PGOOCInstance"],(function(e,t){"use strict";return class{constructor(e){this.parentId=e,this.instances=[]}getPGOOCInstance(e){let t;for(t=0;t<this.instances.length;t++){let n=this.instances[t];if(n.instanceId===e)return n}return null}addInstance({childId:e,instanceId:n,matrix:i}){let r,o=!1;for(r=0;r<this.instances.length&&!o;r++)this.instances.instanceId===n&&(o=!0);o||this.instances.push(new t(e,n,i))}updateOOCInstances(t,n){let i;for(i=0;i<this.instances.length;i++){let r=this.instances[i];r.resetDerivedInstanceIds();let o=n.getPGLink(r.instanceId);if(o){let e=0;for(e=0;e<o.pgLinkReferences.length;e++){let i=n.getPGReference(o.pgLinkReferences[e].pgReferenceId).buildPGInstancePathes(),s=0;for(s=0;s<i.length;s++){let e=r.buildDerivedInstanceId(i[s]);r.addDerivedInstanceId(e);let n=this.buildMatrixFromPGInstancePath(i[s]);t.addChild(this.parentId,r.childId,{instanceId:e,matrix:n,_vdrpUpdate:!0}),r.userData&&t.setUserData(e,r.userData,!0)}}}else t.addChild(this.parentId,r.childId,{instanceId:r.instanceId,matrix:r.matrix||new e.Matrix4,_vdrpUpdate:!0})}}buildMatrixFromPGInstancePath(t){let n,i=new e.Matrix4;for(n=t.length-1;n>=0;n--){if(!t[n].matrix)return null;i.multiplyMatrices(t[n].matrix,i)}return i}traverseUnique(e,t){let n=new Set;this.traverseUnique_internal(e,n,t)}traverseUnique_internal(e,t,n){if(!t.has(this)){var i;if(t.add(this),!e(this))for(i=0;i<this.instances.length;i++){let r=this.instances[i],o=n.getOOCInstances(r.childId);o&&o.traverseUnique_internal(e,t,n)}}}}})),define("DS/3DXMTiles/LDHTileSetHandler",["DS/3DXMTiles/LDHHandler","DS/WAFData/WAFData","DS/Visualization/ThreeJS_DS"],(function(e,t,n){"use strict";var i=function(t){this.type=e.TileSetHandler,this.getSecurityParamsCB=t&&t.getSecurityParamsCB||null,this.getDataCB=t&&t.getDataCB};return(i.prototype=Object.create(e.prototype)).isReady=function(){return!0},i.prototype.handleResolvedReference=function(e,t){var i,r=t.manager._ldhNodeManager,o=t.manager,s=r.tilesManager;e.setRepLoaded(!0),e.requestBuildSceneGraphHierarchy(!0),r.tryBuildSceneGraphHierarchy();var a,d=[];if((i=e.getActiveRepresentation().getSrc()).tileSets)for(a=0;a<i.tileSets.length;a++)d.push(this.createSingleTileSet(i.tileSets[a],s,r,t.manager,e,!0));else d.push(this.createSingleTileSet(i,s,r,t.manager,e,!1));Promise.all(d).then((i=>{var s,a,d,l,h=null,c=null;for(s=0;s<i.length;s++){if((d=i[s]).setPauseLoading(!1,"_init_",r),a=(l=d.getRootNode()).matrix,1!==d.unitScale){var u=new n.Matrix4;u.makeScale(d.unitScale,d.unitScale,d.unitScale),a?(a=a.clone()).multiplyMatrices(u,a):a=u}h=n.mergeBoundingSphereInto(h,l.getBoundingSphere(),a),c=n.mergeBoundingBoxInto(c,l.getBoundingBox(),a)}r.registerTileSets(e,i),e.hasBoundingElement()||(e.setBoundingElements(h,c,null),e.isRoot&&o._updateBoundingSphere()),o._startModelLoaderTransaction(),o._onRepLoaded(e),o.endInstRefGraphTransaction(),t.doneCB([e],[]),e.isRoot&&o._onRootReferenceLoaded(e.referenceId)})),e.lockUnload()},i.prototype.createSingleTileSet=function(e,t,n,i,r,o){let s=r.getNode();return t.createFromJSON(e,s,o)},i.prototype.isReferenceResolved=function(e){var t=e.getActiveRepresentation().getSrc();return t.tileSets||null!=t.rootURI&&null!=t.rootURI},i.prototype.handleBatch=function(e,t){var n,i,r=t.manager._ldhNodeManager,o=(t.manager,r.tilesManager,[]);for(n=0;n<e.references.length;n++)i=e.references[n],this.isReferenceResolved(i)?this.handleResolvedReference(i,t):o.push(i);var s,a=[],d=[];for(n=0;n<o.length;n++)(s=(i=o[n]).getActiveRepresentation().getSrc()).sourceId||s.i3dx?(d.push(i),this.handleReferenceWithSourceId(i,t)):a.push(i);if(a.length)if(this.getDataCB){var l=[];for(n=0;n<a.length;n++)l.push(a[n].referenceId);this.getDataCB(l).then(this.onReferenceData.bind(this,a,t)).catch((()=>{t.doneCB([],a)}))}else t.doneCB([],a)},i.prototype.onReferenceData=function(e,t,n){var i,r,o,s;for(i=0;i<e.length;i++)r={sourceId:(o=n[e[0].referenceId]).sourceId,resourceId:o.resourceId},(s=e[i]).getActiveRepresentation().src=r,this.handleReferenceWithSourceId(s,t)},i.prototype.handleReferenceWithSourceId=function(e,t){let n=e.getActiveRepresentation().getSrc(),i=n.sourceId,r=t.manager._ldhNodeManager,o=n.resourceId||null,s=n.i3dx||null;if(s&&s.startsWith("i3dx:")){i=s.substring(5).split("!uuid:")[0]}let a=r.getServiceUrl(i),d=this.getSecurityParamsCB?"?tenant="+this.getSecurityParamsCB().tenant:"";if("r2vsurvey"===i)null!==s?this.loadTileSetFromi3dx_r2v(a,s,e,t):this.loadTileSetFromResourceId_r2v(a,o,e,t);else{let n=a+({globe:"/datasupplier/dataset/3dstile"}[i]||"")+"/tileset"+d;this.loadTileSetFromResourceId(n,o,e,t)}},i.prototype.loadTileSetFromResourceId=function(e,n,i,r){var o={resourceId:n};t.authenticatedRequest(e,{cors:!0,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify(o),onComplete:(e,t)=>{var n=JSON.parse(e);i.getActiveRepresentation().setSrc(n),this.handleResolvedReference(i,r)},onFailure:()=>{r.doneCB([],[i])}})},i.prototype.loadTileSetFromi3dx_r2v=function(e,n,i,r){let o=`${e}/enovia/resources/r2v/modeler/v2/i3dx/fetch`;var s={data:[{"ds6w:i3dx":n}]};t.authenticatedRequest(o,{cors:!0,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify(s),onComplete:(t,n)=>{let o=JSON.parse(t),s=o&&o.data&&o.data[0],a="R2V_FeatureOfInterest"===(s&&s["ds6w:type"])?s.bsfIngestId:s.resourceid;a?this.loadTileSetFromResourceId_r2v(e,a,i,r):r.doneCB([],[i])},onFailure:()=>{r.doneCB([],[i])}})},i.prototype.loadTileSetFromResourceId_r2v=function(e,n,i,r){let o=`${e}/enovia/resources/r2v/modeler/v2/ingest/${n}/tileset`;t.authenticatedRequest(o,{cors:!0,method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(e,t)=>{var n=JSON.parse(e);i.getActiveRepresentation().setSrc(n),this.handleResolvedReference(i,r)},onFailure:()=>{r.doneCB([],[i])}})},i})),define("DS/3DXMTiles/OOCTileSetHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHTileSetHandler"],(function(e,t){var n=function(n){var i=new t(n=n||{});e.call(this,e.TileSetHandler,i)};return n.prototype=Object.create(e.prototype),n})),define("DS/3DXMTiles/DSTilesStylingFilterOrOperator",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilterOperator","DS/3DXMTiles/DSTilesStylingFilterOperatorParser"],(function(e,t,n){"use strict";class i extends t{constructor(){super(),this.filterOperators=[]}setFromJSON(t){let r,o=t[i.majorProperty],s=[];for(r=0;r<o.length;r++){let e=o[r],t=n.parse(e),i=t.status;i.isOk()?this.filterOperators.push(t.operator):s.push(i)}return s.length||this.filterOperators.length<=0?e.error("Error parsing "+i.majorProperty+" operator","operator",s):e.ok}addNeededAttributesToSet(e){let t;for(t=0;t<this.filterOperators.length;t++)this.filterOperators[t].addNeededAttributesToSet(e)}buildShaderCode(){return""}filter(e){let t,n=!1;for(t=0;!n&&t<this.filterOperators.length;t++)this.filterOperators[t].filter(e)&&(n=!0);return n}}return i.majorProperty="or",i})),define("DS/3DXMTiles/PGLink",["DS/3DXMTiles/PGLinkReference"],(function(e){"use strict";return class{constructor(e){this.oocInstanceId=e,this.pgLinkReferences=[]}addPGReferenceId(t){let n,i=!1;for(n=0;n<this.pgLinkReferences.length;n++){this.pgLinkReferences[n].pgReferenceId===t&&(i=!0)}i||this.pgLinkReferences.push(new e(t))}findInPositionIdPath(e,t){let n;for(n=t;n<e.length;n++){let t,i=e[n];for(t=0;t<this.pgLinkReferences.length;t++)if(i===this.pgLinkReferences[t].pgReferenceId)return n}return-1}}})),define("DS/3DXMTiles/DSTilesPriorityQueue",["DS/3DXMTiles/DSTilesNode"],(function(e){"use strict";var t=function(){this.reset()};t.prototype.reset=function(){this.tileNode=null,this.parent=null,this.less=null,this.more=null},t.prototype.check=function(){var e=[];!function t(n){e.indexOf(n)>-1?console.log("argl"):(e.push(n),n.less&&t(n.less),n.more&&t(n.more))}(this)},t.prototype.checkMinMax=function(e,t){var n=!0;return this.tileNode&&(this.tileNode.isLessPrioritaryThan(e)||this.tileNode.isMorePrioritaryThan(t))&&(console.log("ERRRRRRRRRRREUUUUUUR"),n=!1),this.less&&!this.less.checkMinMax(e,t)&&(n=!1),this.more&&!this.more.checkMinMax(e,t)&&(n=!1),n},t.prototype.removeMin=function(e){var t=this.less;null!==t&&(null===t.less?(this.less=t.more,null!==this.less&&(this.less.parent=this),e.releaseHeapNode(t)):t.removeMin(e))},t.prototype.removeMax=function(e){var t=this.more;null!==t&&(null===t.more?(this.more=t.less,null!==this.more&&(this.more.parent=this),e.releaseHeapNode(t)):t.removeMax(e))},t.prototype.insert=function(e){e.tileNode.isLessPrioritaryThan(this.tileNode)?null!==this.less?this.less.insert(e):(this.less=e,e.parent=this):null!==this.more?this.more.insert(e):(this.more=e,e.parent=this)},t.prototype.getMin=function(){return null===this.less?this:this.less.getMin()},t.prototype.getMax=function(){return null===this.more?this:this.more.getMax()},t.prototype.getTileNodes=function(e){null!==this.tileNode&&e.push(this.tileNode),this.more&&this.more.getTileNodes(e),this.less&&this.less.getTileNodes(e)};var n=function(t){this.size=0,this.sizeLimit=t,this.root=null,this.firstFreeHeapNode=null,this.minHeapNode=e.MinusInfinity,this.maxHeapNode=e.PlusInfinity};n.prototype.getTileNodes=function(){var e=[];return null!==this.root&&this.root.getTileNodes(e),e},n.prototype.tryToInsertTileNodeMax=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.minHeapNode.isLessPrioritaryThan(e)){this.insert(e),t.min=null;var i=this.root.getMin();return this.minHeapNode=i.tileNode,!0}return!1}if(this.minHeapNode.isLessPrioritaryThan(e)){i=this.root.getMin();t.min=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMin(this):this.setRoot(i.more),this.size--;var r=this.root.getMin();return this.minHeapNode=r.tileNode,!0}return!1},n.prototype.tryToInsertTileNodeMin=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.maxHeapNode.isMorePrioritaryThan(e)){this.insert(e),t.max=null;var i=this.root.getMax();return this.maxHeapNode=i.tileNode,!0}return!1}if(this.maxHeapNode.isMorePrioritaryThan(e)){i=this.root.getMax();t.max=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMax(this):this.setRoot(i.less),this.size--;var r=this.root.getMax();return this.maxHeapNode=r.tileNode,!0}return!1},n.prototype.setRoot=function(e){null!==this.root&&this.releaseHeapNode(this.root),this.root=e,null!==e&&(e.parent=null)},n.prototype.getAndRemoveMaxTileNode=function(){var e=this.root.getMax(),t=e.tileNode;return this.removeMaxHeapNode(e),t},n.prototype.removeMaxHeapNode=function(e){null!==e.parent?e.parent.removeMax(this):this.setRoot(e.less),this.size--},n.prototype.removeMinHeapNode=function(e){null!==e.parent?e.parent.removeMin(this):this.setRoot(e.more),this.size--},n.prototype.getAndRemoveMinTileNode=function(){var e=this.root.getMin(),t=e.tileNode;return this.removeMinHeapNode(e),t},n.prototype.getMinHeapNode=function(){return null!==this.root?this.root.getMin():null},n.prototype.getMaxHeapNode=function(){return null!==this.root?this.root.getMax():null},n.prototype.insert=function(e){var t=this.getHeapNode(e);null===this.root?this.setRoot(t):this.root.insert(t),this.size++},n.prototype.getHeapNode=function(e){var n;return this.firstFreeHeapNode?(n=this.firstFreeHeapNode,this.firstFreeHeapNode=n.more,n.reset()):n=new t,n.tileNode=e,n},n.prototype.releaseHeapNode=function(e,t){e.less=null,t&&t(e.tileNode),e.tileNode=null,e.more=this.firstFreeHeapNode,this.firstFreeHeapNode=e},n.prototype.releaseHeapNodeTree=function(e,t,n){null!==e.less&&(this.releaseHeapNodeTree(e.less,t+1,n),e.less=null),null!==e.more&&(this.releaseHeapNodeTree(e.more,t+1,n),e.more=null),this.releaseHeapNode(e,n)},n.prototype.reset=function(t){null!==this.root&&(this.releaseHeapNodeTree(this.root,0,t),this.root=null,this.minHeapNode=e.MinusInfinity),this.size=0};var i=0,r=function(e){this.id=i++,this.nodeList=[],this.nbProcessedNodes=0,this.nodeListLength=0,this.listWasUpdated=!1,this.maxHeapNode=null,this.minHeapNode=null,this.negativeNodes=[],this.heap=new n(e||100)};r.prototype.fillHeapMax=function(e){var t,n,i,r={min:null},o=this.nodeListLength,s=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):s.tryToInsertTileNodeMax(t,r,0!==l)&&(n=r.min,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;a(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},r.prototype.fillHeapMin=function(e){var t,n,i,r={max:null},o=this.nodeListLength,s=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):s.tryToInsertTileNodeMin(t,r,0!==l)&&(n=r.max,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;a(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},r.prototype.getMaxNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var t,n=this.nodeListLength,i=-1,r=e.MinusInfinity,o=null,s=0;for(t=0;t<n;t++)null!==(o=this.nodeList[t])&&o.isAlive()?o.isMorePrioritaryThan(r)&&(i=t,r=o):s++;return i>-1?(o=this.nodeList[i],this.nodeList[i]=null):o=null,s>=this.nodeListLength?this.nodeListLength=0:s>200&&this.cleanNulls(!1),o},r.prototype.peekMaxNode=function(){if(!this.maxHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0?e=this.heap.root.getMax():this.negativeNodes.length>0&&(e=this.negativeNodes[this.negativeNodes.length-1]),this.maxHeapNode=e}return this.maxHeapNode?this.maxHeapNode.tileNode:null},r.prototype.peekMinNode=function(){if(!this.minHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0&&(e=this.heap.root.getMin()),this.minHeapNode=e}return this.minHeapNode?this.minHeapNode.tileNode:null},r.prototype.removeMaxHeapNode=function(e){this.heap.removeMaxHeapNode(e)},r.prototype.getMaxNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.heap.size>0?t=e?this.heap.getAndRemoveMaxTileNode():this.heap.getMaxNode():this.negativeNodes.length>0&&(t=this.negativeNodes.pop()),t},r.prototype.getMinNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.negativeNodes.length>0?t=this.negativeNodes.pop():this.heap.size>0&&(t=e?this.heap.getAndRemoveMinTileNode():this.heap.getMinNode()),t},r.prototype.checkIntegrity=function(e){var t,n=-1/0,i=1/0;if(this.heap.size>0)for(n=this.heap.root.getMin().tileNode,i=this.heap.root.getMax().tileNode,this.heap.root.checkMinMax(n,i)||console.log("checkMinMax has failed!!!"),t=0;t<(void 0!==e?e:this.nodeListLength);t++)this.nodeList[t]&&this.nodeList[t].isMorePrioritaryThan(n)&&console.log("found probleme!!!")},r.prototype.getMinNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var t,n=this.nodeListLength,i=-1,r=e.PlusInfinity,o=null,s=0;for(t=0;t<n;t++)null!==(o=this.nodeList[t])&&o.isAlive()?o.isLessPrioritaryThan(r)&&(i=t,r=o):s++;return i>-1?(o=this.nodeList[i],this.nodeList[i]=null):o=null,s>=this.nodeListLength?this.nodeListLength=0:s>200&&this.cleanNulls(!1),o},r.prototype.cleanNulls=function(e){var t,n=this.nodeListLength,i=null,r=0;for(t=0;t<n;t++)null!==(i=this.nodeList[t])&&i.isAlive()?(this.nodeList[r]=i,r++):e&&t<this.nbProcessedNodes&&this.nbProcessedNodes--;this.nodeListLength=r,this.nodeList.length=this.nodeListLength},r.prototype.isEmpty=function(){return 0===this.heap.size&&0===this.nodeListLength&&0===this.negativeNodes.length},r.prototype.clear=function(e){var t;if(this.heap.reset(e),e)for(t=0;t<this.nodeListLength;t++)this.nodeList[t]&&e(this.nodeList[t]);this.nodeListLength=0,this.nbProcessedNodes=0,this.maxHeapNode=null,this.minHeapNode=null},r.prototype.resetOrder=function(e){var t,n=this.heap.getTileNodes();for(this.heap.reset(),t=0;t<n.length;t++)this.addNode(n[t]);for(t=0;t<this.negativeNodes.length;t++)this.addNode(this.negativeNodes[t]);if(this.negativeNodes.length=0,e){var i,r=0;for(t=0;t<this.nodeListLength;t++)(i=this.nodeList[t])&&e(i)&&(this.nodeList[r]=i,r++);this.nodeListLength=r}};var o=0;function s(e,t){var n,i=(n=o+=1831565813,n=Math.imul(n^n>>>15,1|n),(((n^=n+Math.imul(n^n>>>7,61|n))^n>>>14)>>>0)%(t-e)),r=e+(i=i<0?i+(t-e):i);return isFinite(r)?r:-1}function a(e,t,n,i){let r;for(r=0;r<t.length;r++){let o=t[r],a=s(n,i),d=e[o];a!==o&&a>=0&&(e[o]=e[a],e[a]=d)}}return r.prototype.addNode=function(e,t){this.nodeListLength>=this.nodeList.length?(this.nodeList.push(null),this.nodeListLength=this.nodeList.length):this.nodeList[this.nodeListLength++]=null,t?this.nodeList[this.nodeListLength-1]=e:function(e,t,n,i){if(i<=1)e[i-1]=t;else{var r=s(n,i);r<0&&(r=i-1),r>=i-1?e[i-1]=t:(e[i-1]=e[r],e[r]=t)}}(this.nodeList,e,this.nbProcessedNodes,this.nodeListLength),this.listWasUpdated=!0},r.prototype.peekMinHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMinHeapNode()},r.prototype.peekMaxHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMaxHeapNode()},r.prototype.traverseMin=function(e){var t,n,i;for((0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),t=this.negativeNodes.length-1;t>=0;t--){if(!e(this.negativeNodes[t]))return;this.negativeNodes.length--}do{i=!0,null!==(n=this.peekMinHeapNode())&&e(n.tileNode)&&(this.heap.removeMinHeapNode(n),i=!1)}while(!i)},r.prototype.traverseMinPlus=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t,n,i,r,o,s=[];function a(){i=!0}function d(){n=!0}for(n=!1,r=this.negativeNodes.length-1;r>=0&&!n;r--)o=this.negativeNodes[r],i=!1,n=!1,e(o,d,a),this.negativeNodes.length--,i&&s.push(o);for(;!n;)n=!1,i=!1,null!==(t=this.peekMinHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&s.push(t.tileNode),this.heap.removeMinHeapNode(t))):n=!0;for(r=0;r<s.length;r++)this.addNode(s[r],!1)},r.prototype.traverseMax=function(e){var t,n;do{n=!0,null!==(t=this.peekMaxHeapNode())&&e(t.tileNode)&&(this.heap.removeMaxHeapNode(t),n=!1)}while(!n)},r.prototype.traverseMaxPlus=function(e){var t,n,i,r,o=[],s=!1;function a(){i=!0}function d(){n=!0}do{n=!1,i=!1,null!==(t=this.peekMaxHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&o.push(t.tileNode),this.heap.removeMaxHeapNode(t))):s=!0}while(!n&&!s);for(r=this.negativeNodes.length-1;r>=0&&!n;r--){let t=this.negativeNodes[r];i=!1,n=!1,e(t,d,a),this.negativeNodes.length--,i&&o.push(t)}for(r=0;r<o.length;r++)this.addNode(o[r],!1)},r.prototype.removeNode=function(e){var t;for(this.resetOrder(),t=0;t<this.nodeListLength;t++)this.nodeList[t]===e&&(this.nodeList[t]=null)},r.prototype.getAllNodes=function(){var e,t,n=[];for(t=0;t<this.nodeListLength;t++)(e=this.nodeList[t])&&n.push(e);var i=this.heap.getTileNodes();return n.concat(i)},r.prototype.getMaxNodes=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getTileNodes()},r.prototype.getSize=function(){return this.cleanNulls(),this.nodeListLength+this.heap.size},r})),define("DS/3DXMTiles/DSTilesQueue",["DS/3DXMTiles/DSTilesPriorityQueue","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/UpdateNodeContentData"],(function(e,t,n){"use strict";var i=function(t,n){this.sortingMetric=n,this.nodes=[],this.newNodes=[],this.contentsToUpdateSet=new Set,this.nodesToUpdateSet=new Set,this.nodesToLoadQueue=new e,this.nodesToExpandQueue=new e,this.unloadSmallNodesQueue=new e,this.tmpTraverseRoots=new Set,this.unloadSmallNodesInitNeeded=!0,this.queueSet=t,this.nbLoading=0,this.nbExpanding=0,this.updateIndex=0};i.prototype.registerRootNodeFromLink=function(e,t,n){var i=e.expander,r=this;i.loadNodeFromLink(e.link,(function(n){e.node=n,r.registerDSTilesNode(n),r.registerRootNode(e),t(n)}),n,this)},i.prototype.registerDSTilesNode=function(e,t){if(e.isAlive())e.isInUnload()||e.setInUnload(!0),e.isInList()?t&&this.forceUpdateNode(e):(e.setInList(!0),this.newNodes.push(e)),this.getLDHManager().requestUpdate(!1,!1);else if(e.isInToBeLoaded()&&(e.setInToBeLoaded(!1),this.nodesToLoadQueue.removeNode(e)),e.isInToExpand()&&(this.nodesToExpandQueue.removeNode(e),e.setInToExpand(!1)),e.isInUnload()&&e.setInUnload(!1),e.isInList()){var n=this.newNodes.indexOf(e);n>=0&&(this.newNodes[n]=null),(n=this.nodes.indexOf(e))>=0&&(this.nodes[n]=null),e.setInList(!1)}},i.prototype.unloadSmallNodes=function(e){var t,n,i=this.getTilesManager().memoryManager;if(this.unloadSmallNodesInitNeeded)for(this.unloadSmallNodesInitNeeded=!1,t=0;t<this.nodes.length;t++)(n=this.nodes[t])&&n.isContentLoaded()&&!n.getToUnload()&&this.unloadSmallNodesQueue.addNode(n);var r=!1,o=null;if(this.unloadSmallNodesQueue.traverseMinPlus(((t,n,s)=>{t.getScore()<e||t.getOnHold()?t.isUnloadLocked()?s():(t.lockLoadDate=Date.now()+2e3,t.isReplaceLODMode()&&t.getContentVisible()&&(o||(o=new Set),o.add(t.getRoot())),t.deleteContent(this),i.isLoadingAllowed()&&n()):(r=!0,n())})),o){let e=this.getViewer();o.forEach((t=>{t.traverseReplaceProgressive(e)}))}return r},i.prototype.getTilesManager=function(){return this.queueSet.tilesManager},i.prototype.getLDHManager=function(){return this.queueSet.tilesManager.ldhNodeManager},i.prototype.forceUpdateNode=function(e){this.nodesToUpdateSet.add(e)},i.prototype.updateNodes=function(e,t){var n;if(this.updateIndex++,!e)for(this.updateNodesToLoad(this.newNodes,t);this.nodesToUpdateSet.size>0;){var i=this.nodesToUpdateSet;this.nodesToUpdateSet=new Set,this.updateNodesToLoad(Array.from(i),t)}for(n=0;n<this.newNodes.length;n++)this.nodes.push(this.newNodes[n]);if(this.newNodes.length=0,this.nodesToUpdateSet.clear(),e&&this.resetNodesToLoad(),e)this.updateNodesToLoad(this.nodes,t);else{var r=this.getViewer();this.tmpTraverseRoots.forEach((e=>{e.traverseUpdateNodes(r)})),this.tmpTraverseRoots.clear()}},i.prototype.loadNodes=function(e,t){this.unloadSmallNodesInitNeeded=!0,this.unloadSmallNodesQueue.clear();var n=!1,i=this.getTilesManager().memoryManager,r=this,o=Date.now(),s=new Set;this.loadUpdatedContent(s),this.nodesToLoadQueue.traverseMaxPlus((function(e,t,a){if(e.isAlive()){var d=!1,l=e.tileSet;l.getPauseLoading()?e.setInToBeLoaded(!1):(l.canLoadContent()&&e.lockLoadDate<o&&(n||e.isContentLoadingAllowed(i)||(n=r.unloadSmallNodes(e.getScore())),e.isContentLoadingAllowed(i)&&e.isContentToLoad()&&!e.isError()&&(l.loadTileContent(e),s.add(l),r.nbLoading++,e.setInToBeLoaded(!1),d=!0)),d||(a(),t()))}})),s.forEach((e=>{e.flushLoadTileContent()})),s=new Set,this.nodesToExpandQueue.traverseMaxPlus((function(e,t,n){if(e.isAlive()){var o=!1,a=(e.expander,e.tileSet);!a.getPauseLoading()&&a.canExpand()&&e.isExpandLoadingAllowed(i)&&e.isExpandToLoad()&&!e.isError()&&(a.expandTile(e),s.add(a),r.nbExpanding++,e.setInToExpand(!1),o=!0),o||(n(),t())}})),s.forEach((e=>{e.flushExpandTile()}))},i.prototype.loadUpdatedContent=function(e){let t,n=[],i=new Set;for(this.contentsToUpdateSet.forEach((e=>{let t=e.node,r=e.content,o=!1;t.isContentLoading()||(r.contentLoader.createUpdatedContentTokenFromContentToken(r,t)?(e.onUpdatedCB(),n.push(e)):(!r.contentToken||r.updatedContentVersion>e.updateVersion?o=!0:t.getContentVisible()||(o=!0,i.add(t)),o&&(e.onUpdatedCB(),n.push(e))))})),i.forEach((e=>{e.deleteContent(e.queue)})),t=0;t<n.length;t++)this.contentsToUpdateSet.delete(n[t]);n.length>0&&this.getLDHManager().requestUpdate(!1);for(n.length=0,this.contentsToUpdateSet.forEach((t=>{let i=t.node,r=i.tileSet;t.content;r.getPauseLoading()||!r.canLoadContent()||i.isContentLoading()||(e.add(r),r.updateNodeContent(t,this),n.push(t))})),t=0;t<n.length;t++)this.contentsToUpdateSet.delete(n[t])},i.prototype.cleanLists=function(){function e(e){var t,n=0;for(t=0;t<e.length;t++)null!==e[t]&&(e[n]=e[t],n++);e.length=n}e(this.nodes),e(this.newNodes)},i.prototype.onNodeLoaded=function(e){if(this.nbLoading--,e.tileSet.setNodeEndLoading(),e.isAlive()){e.setContentStatus(t.loaded,this);e.parent;e.isAddLODMode()&&e.getWished()&&e.showContent();var n=this.getLDHManager();e.isReplaceLODMode()&&this.tmpTraverseRoots.add(e.getRoot()),n.requestUpdate(!1,!1),n.viewer.render({budgeted:!0})}},i.prototype.onNodeLoadError=function(e){(this.nbLoading--,e.isAlive())&&(e.setContentStatus(t.error,this),e.tileSet.setNodeEndLoading(),this.getLDHManager().requestUpdate(!1,!1))},i.prototype.onNodeExpanded=function(e){(this.nbExpanding--,e.isAlive())&&(this.tmpTraverseRoots.add(e.getRoot()),e.setExpandStatus(t.loaded,this),e.tileSet.setNodeEndExpanding(),e.children||(e.children=[]),this.getLDHManager().requestUpdate(!1,!1))},i.prototype.onNodeExpandError=function(e){(this.nbExpanding--,e.isAlive())&&(e.setExpandStatus(t.error,this),e.tileSet.setNodeEndExpanding(),e.children=[],this.getLDHManager().requestUpdate(!1,!1))},i.prototype.computeTilesScore=function(e,n,i){var r,o,s;for(r=0;r<e.length;r++)if((o=e[r])&&!o.getOnHold()&&!o.isError())if(o.computeScore(this.updateIndex,n),o.passVisibilityTest()){if(o.setToUnload(!1),o.getChildrenOnHold()&&!o.passPixelErrorTest()&&(o.setChildrenOnHold(!1),o.children))for(s=0;s<o.children.length;s++)i.add(o.children[s]),o.children[s].setOnHold(!1);!o.hasExpand()||o.isExpandLoading()||o.isExpandLoaded()||(o.setExpandStatus(t.toLoad,this),o.isInToExpand()||(this.nodesToExpandQueue.addNode(o),o.setInToExpand(!0)))}else o.setToUnload(!0)},i.prototype.updateNodesToLoad=function(e,t){for(var n=e;n.length;){var i=new Set;this.computeTilesScore(n,t,i),n=Array.from(i)}};let r=0;return i.getNewUpdateVersion=function(){return r++},i.updateNodesContents=function(e,t,i,r){let o;for(o=0;o<t.length;o++){let s=e[o],a=t[o],d=s.queue,l=new n(s,a,i,r);l.content.setUpdatedContentVersion(i),d.contentsToUpdateSet.add(l)}},i.prototype.resetNodesToLoad=function(){this.nodesToExpandQueue.clear((function(e){e.setInToExpand(!1)})),this.nodesToLoadQueue.clear((function(e){e.setInToBeLoaded(!1)}))},i.prototype.getViewer=function(){return this.getLDHManager().viewer},i.prototype._dbgGetNodeFromURI=function(e){var t;for(t=0;t<this.nodes.length;t++)if(this.nodes[t].uri===e)return this.nodes[t];return null},i})),define("DS/3DXMTiles/DSTilesStylingFilterAndOperator",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilterOperator","DS/3DXMTiles/DSTilesStylingFilterOperatorParser"],(function(e,t,n){"use strict";class i extends t{constructor(){super(),this.filterOperators=[]}setFromJSON(t){let r,o=t[i.majorProperty],s=[];for(r=0;r<o.length;r++){let e=o[r],t=n.parse(e),i=t.status;i.isOk()?this.filterOperators.push(t.operator):s.push(i)}return s.length||this.filterOperators.length<=0?e.error("Error parsing "+i.majorProperty+" operator","operator",s):e.ok}addNeededAttributesToSet(e){let t;for(t=0;t<this.filterOperators.length;t++)this.filterOperators[t].addNeededAttributesToSet(e)}buildShaderCode(){return""}filter(e){let t,n=!0;for(t=0;n&&t<this.filterOperators.length;t++)this.filterOperators[t].filter(e)||(n=!1);return n}}return i.majorProperty="and",i})),define("DS/3DXMTiles/PGManager",["DS/3DXMTiles/PGReference","DS/3DXMTiles/PGInstance","DS/3DXMTiles/PGLink","DS/3DXMTiles/PGOOCInstanceList"],(function(e,t,n,i){"use strict";return class{constructor(e){this.oocManager=e,this.rootIdToReferenceId=new Map,this.rootIdToPGReferenceId=new Map,this.referenceMap=new Map,this.instanceMap=new Map,this.linkMap=new Map,this.oocParentToInstanceListMap=new Map,this.oocInstanceToParentMap=new Map,this.needVDRPUpdate=!1}addRoot({referenceId:e,rootId:t}){this.rootIdToReferenceId.set(t,e)}registerPGReference({referenceId:t}){let n=this.referenceMap.get(t);return n||(n=new e({referenceId:t}),this.referenceMap.set(t,n),this.requestVDRPUpdate()),n}registerPGInstance({parentId:e,childId:n,instanceId:i,matrix:r}){let o=this.getPGReference(e);if(o){let s=this.getPGReference(n);if(o&&s){let n=new t({parentReference:o,childReference:s,instanceId:i,matrix:r});this.instanceMap.set(i,e),o.addPGInstance(n),s.addParentPGInstance(n),this.requestVDRPUpdate()}}}registerOOCInstance({parentId:e,childId:t,instanceId:n,matrix:r}){this.oocInstanceToParentMap.set(n,e);let o=this.oocParentToInstanceListMap.get(e);o||(o=new i(e),this.oocParentToInstanceListMap.set(e,o)),o.addInstance({childId:t,instanceId:n,matrix:r}),this.requestVDRPUpdate()}getPGReference(e){return this.referenceMap.get(e)||null}getParentPGReferenceFromInstanceId(e){return this.getPGReference(this.instanceMap.get(e))}getPGInstance(e){let t=this.getPGReference(this.instanceMap.get(e));return t&&t.getPGInstance(e)}addPGLink({oocInstanceId:e,positionGraphReferenceId:t}){let i=this.linkMap.get(e);i||(i=new n(e),this.linkMap.set(e,i)),i.addPGReferenceId(t);let r=this.getPGReference(t);r.addPGLink(r),this.requestVDRPUpdate()}getPGLink(e){return this.linkMap.get(e)}getChildPGReferenceFromPGInstanceId(e){let t=this.instanceMap.get(e);if(t){return this.getPGReference(t).getPGInstance(e).childReference}return null}requestVDRPUpdate(){this.needVDRPUpdate=!0}updateOOCInstances(e){this.needVDRPUpdate&&this.rootIdToReferenceId.forEach(((t,n)=>{this.needVDRPUpdate=!1,this.getOOCInstances(t).traverseUnique((t=>{t.updateOOCInstances(e,this)}),this)}))}getOOCInstances(e){return this.oocParentToInstanceListMap.get(e)}getOOCDerivedInstanceIds(e){let t=this.oocInstanceToParentMap.get(e),n=null;if(t){let i=this.getOOCInstances(t),r=i&&i.getPGOOCInstance(e);r&&(n=r.derivedInstanceIds&&[].concat(r.derivedInstanceIds))}return n}getPGOOCInstance(e){let t=this.oocInstanceToParentMap.get(e);if(t){let n=this.getOOCInstances(t);return n&&n.getPGOOCInstance(e)}return null}getOOCRerenceIdFromInstanceId(e){return this.oocInstanceToParentMap.get(e)||null}getOOCChildReference(e){let t=this.getOOCRerenceIdFromInstanceId(e),n=t&&this.getOOCInstances(t),i=n&&n.getPGOOCInstance(e);return i&&i.childId}unregisterDerivedInstanceId(e){let t=e.split("/")[0],n=this.oocInstanceToParentMap.get(t);this.oocParentToInstanceListMap.delete(n),this.oocInstanceToParentMap.delete(t),this.linkMap.delete(t)}removePGRoot(e){this.rootIdToReferenceId.delete(e);let t=this.rootIdToPGReferenceId.get(e);this.rootIdToPGReferenceId.delete(e),this.getPGReference(t).release(this)}registerPositionArchLink(e,t){this.rootIdToPGReferenceId.set(e,t),this.getPGReference(t).addRef()}unregisterPGInstance(e){this.instanceMap.delete(e.instanceId)}unregisterPGReference(e){this.referenceMap.delete(e.referenceId)}}})),define("DS/3DXMTiles/DSTilesQueueSet",["DS/3DXMTiles/DSTilesQueue"],(function(e){"use strict";var t=function(e){this.tilesManager=e,this.queues=[]};return t.prototype.getQueueFromTileSet=function(t){var n,i,r=t.getSortingMetric();for(n=0;n<this.queues.length;n++)if((i=this.queues[n]).sortingMetric===r)return i;return i=new e(this,r),this.queues.push(i),i},t.prototype.updateNodes=function(e,t){var n;for(n=0;n<this.queues.length;n++)this.queues[n].updateNodes(e,t)},t.prototype.loadNodes=function(e,t){var n;for(n=0;n<this.queues.length;n++)this.queues[n].loadNodes(e,t)},t.prototype.isLoading=function(){var e,t;for(t=0;t<this.queues.length;t++)if((e=this.queues[t]).nbLoading>0||e.nbExpanding>0||e.contentsToUpdateSet.size>0)return!0;return!1},t.prototype.cleanLists=function(){let e;for(e=0;e<this.queues.length;e++)this.queues[e].cleanLists()},t})),define("DS/3DXMTiles/DSTilesStylingRenderConstant",["DS/3DXMTiles/ParsingStatus","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesStylingValue","DS/3DXMTiles/DSTilesStylingRender"],(function(e,t,n,i){"use strict";class r extends i{constructor(){super(),this.color=null,this.opacity=null}setFromJSON(t){let i=[];return t.color&&(this.color=n.parseFromJSON(t.color,i)),t.opacity&&(this.opacity=n.parseFromJSON(t.opacity,i)),t.color||t.opacity||i.push(e.error("Missing 'color' or 'opacity' property")),i.length?e.error("Error parsing color render","render",i):e.ok}fillGraphicAttributes(e,t){if(this.color){let n=this.color.getValue(t);e.color=n}if(this.opacity){let n=this.opacity.getValue(t);e.opacity=n}}addNeededAttributesToSet(e){this.color&&this.color.isAttribute&&e.add(this.color.attribute),this.opacity&&this.opacity.isAttribute&&e.add(this.opacity.attribute)}}return r.jsonType="constant",r})),define("DS/3DXMTiles/DSTilesR2VPointCloudContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/PointCloudServices","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHStats","DS/3DXMTiles/DSTilesR2VOctree","DS/3DXMTiles/DSTilesSourceIdWithParams","DS/ShaderBuilders/ShaderUtils/ShaderInOutUtils","DS/ShaderBuilders/ShaderUtils/FunctionUtils","DS/ShaderBuilders/ShaderUtils/TypeUtils"],(function(e,t,n,i,r,o,s,a,d,l,h,c,u){"use strict";const p="",g=(e=null,t=0)=>{var n={name:e,size:t};return u.float(n)},f=(e=null,t=0)=>{var n={name:e,size:t};return u.vec4(n)},m=(e,t,n)=>c.FunctionHandler.callFunction(e,t,n);var v=function(t){e.call(this,t),this.PointCloudHQ=!!localStorage.getItem("PointCloudHQ")&&"true"===localStorage.getItem("PointCloudHQ"),window.PointCloudHQ&&(this.PointCloudHQ=window.PointCloudHQ),this.tilesManager&&this.tilesManager.viewer&&this.tilesManager.viewer.pointCloudHQ&&(this.PointCloudHQ=!0),this.rootSGNode=t.targetSGNode,this.buildUrlCB=t.buildUrlCB,this.materialMap=new WeakMap,window.__materialLibrary||(window.__materialLibrary=[]),this.materialLib=window.__materialLibrary;let n=parseFloat(window.localStorage.getItem("OOCMinPointSize"))||v.defaultMinPointSize,i=parseFloat(window.localStorage.getItem("OOCMaxPointSize"))||255;this._ptMinSize=n,this._ptMaxSize=i,this.maxPixelErrorFactor=1,this.updateMaxPixelErrorFactorFromPtMinSize(),this._maxSpacing=0,this.nbTickets=10,this._dbgNoPickParent=!!window.OOCTilesNoPickParent,this._enableHighlight=!!window.OOCTilesR2VHighlight,this.splattingFactor=1.3,this.roundPoints=!1,this.seeThroughRange=5,this.queryFilterMap=new WeakMap};v.defaultMinPointSize=4,v.prototype=Object.create(e.prototype),v.prototype.setSplattingParameters=function(e){void 0!==e.splattingFactor&&(this.splattingFactor=e.splattingFactor),void 0!==e.minSize&&(this._ptMinSize=e.minSize,this.updateMaxPixelErrorFactorFromPtMinSize()),void 0!==e.maxSize&&(this._ptMaxSize=e.maxSize),void 0!==e.roundPoints&&(this.roundPoints=e.roundPoints)},v.prototype.updateMaxPixelErrorFactorFromPtMinSize=function(){let e=this.maxPixelErrorFactor,t=Math.max(1,this._ptMinSize);if(this.maxPixelErrorFactor=t/v.defaultMinPointSize,this.maxPixelErrorFactor!==e){let e=this.tilesManager&&this.tilesManager.ldhNodeManager;e&&e.requestUpdate(!0)}},v.prototype.getBudgetParams=function(){return{name:"pointCloud",physicalBudget:"gpu",params:{maxLimit:251658240}}},v.prototype.isReady=function(){return this.nbTickets>0},v.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},v.prototype.loadContentFromBuffer=function({data:e,node:t,content:n,onLoadedCB:r,onErrorCB:o,params:s,updateContent:d}){let l=this.getStylingAttributesMap(t.tileSet);var h=t.queue;if(0===this._maxSpacing){var c=t.getBoundingBox(),u=c.min.distanceTo(c.max)/1e3;this._maxSpacing=u}var p=n.getContentToken(d);p||(p=new S(t,n,h,s?s.count:1,this.PointCloudHQ),n.setContentToken(p,d));var g=i.createTileContentFromBuffer(e,l);if(g){let e=0;if(s&&s.attributes&&s.attributes.length>0&&(e=s.index,p.attributes||(p.attributes=[]),p.attributes=p.attributes.concat(s.attributes)),p.geometries[e]=g.geometry,p.geometries.indexOf(void 0)<0){a.onLoadedModel(0);var f=g.geometry;if(f){let e=this.getMaterial(n,t);this.materialsInitialized=!0,this._maxSpacing=f.spacing,e.depth.updatePDSFXUniform("uMaxSpacing",f.spacing),e.accum.updatePDSFXUniform("uMaxSpacing",f.spacing),e.simple.updatePDSFXUniform("uMaxSpacing",f.spacing),this.setupNode3D(p,p.geometries,e.simple,l),p.computeMemorySize(),this.budget.updateUsage(0,p.size)}else p.mesh3D=null}r()}else o()},v.prototype.getMaterial=function(e,t){let n=this.materialMap.get(t.tileSet),i=n?n.material:null,r=t.tileSet.styling;if(!i||n.styling!==r){i={depth:this.createMaterial(t.tileSet,"depth"),accum:this.createMaterial(t.tileSet,"accum"),simple:this.createMaterial(t.tileSet,"simple")},this.materialMap.set(t.tileSet,{material:i,styling:r}),this.materialLib.push(i)}return i},v.prototype.setupNode3D=function(e,t,n,i){var r=e.node;if(r.isAlive()){let s,a=0;for(s=0;s<t.length;s++)a+=t[s].buffer.byteLength;e.size=a,e.mesh3D=this.createNode3D(t,n,r,!0,i),e.nodeDepth=new o("depth"),e.nodeColor=new o("accum"),e.nodeSimple=new o("simple")}else e.content.setContentToken(null)},v.prototype.getOctreeFromContent=function(e){var t=this.octreeMap.get(e.root);return t||(t=new d({tileNode:e.root}),this.octreeMap.set(e.root,t)),t},v.prototype.showContent=function(e,t){let n=t.contentToken;if(!n)return;var i=n.mesh3D;if(!i)return;let r=this.getMaterial(t,e);var o=e.getSgNode();if(this.PointCloudHQ){let e=i.getParents();if(e.length>=3)for(var s=0;s<3;s++){var a=e[s].name;r[a]&&e[s].setMaterial(r[a])}}else i.setMaterial(r.simple);this._enableHighlight||(o.excludeFromHighlight(!0,!0),o.propagateXSOExclusion(!0)),0===i.parents.length&&(this.PointCloudHQ?(n.nodeDepth.setMaterial(r.depth),n.nodeColor.setMaterial(r.accum),n.nodeSimple.setMaterial(r.simple),o.addChild(n.nodeDepth),o.addChild(n.nodeColor),o.addChild(n.nodeSimple),n.nodeDepth.addChild(i),n.nodeColor.addChild(i),n.nodeSimple.addChild(i),n.nodeDepth.setRenderPasses(["depthPointCloud"]),n.nodeColor.setRenderPasses(["colorWeightAccumulation"]),n.nodeSimple.setRenderPasses(["main"])):o.addChild(i)),n.mesh3D.setVisibilityFree(!1),this._dbgNoPickParent||i.setPickParent(!0),i.setVisibility(!0)},v.prototype.hideContent=function(e,t){let n=t.contentToken;n&&n.mesh3D&&(n.mesh3D.setVisibilityFree(!0),n.mesh3D.setVisibility(!1))},v.prototype.deleteContent=function(e,t,n){n&&(n.release(),n.mesh3D=null,this.budget.updateUsage(n.size,0))},v.prototype.exportContent=function(e,t){let n=t.contentToken;if(n)return[n.mesh3D]},v.prototype.createNode3D=function(e,n,i,o,a){null!=this.geometry&&console.error(this.toString()+":geometry exist already !");var d=new t.BufferGeometryDS;d.noMeshInRAM=!0;let l,h=0;for(l=0;l<e.length;l++){let t=e[l];if(d.buffers[l]=t.buffer,t.attributes.constructor===Array)for(let e of t.attributes)if("position"===e.name&&3===e.count&&12===e.size)h=l,d.layout.set({position:{type:"float32x3",offset:e.offset,stride:e.stride,bufferId:l}});else if("color"===e.name&&4===e.count&&4===e.size)d.layout.set({ptCol:{type:"unorm8x3",offset:e.offset,stride:e.stride,bufferId:l},ptSize:{type:"unorm8",offset:e.offset+3,stride:e.stride,bufferId:l}});else{let t=a.get(e.name);if(t){let n=t.type;this.setLayoutFromType(d,e,n,l)||console.error("Error handling attribute: "+e)}}else for(let e in t.attributes){const n=t.attributes[e];d.layout.setAttribute(Object.assign({name:e},n,{bufferId:l}))}}d.boundingBox=i.getBoundingBox().clone(),d.boundingSphere=i.getBoundingSphere().clone();let c=new r.DrawingGroup(null,n,0,0,e[h].points);c.geometry=d,c.nonIndexed=!0,d.drawingGroups=[c];let u=new t.Mesh(d,n);u.hasPoint=!0;var p=new s(u,"OOCNode");p.explicitBSphere.copy(d.boundingSphere),p.explicitBBox.copy(d.boundingBox),p.setUserData({dsTilesNode:i}),p.setFrustumCulled(!1);i._getWorldMatrix();return p},v.prototype.setLayoutFromType=function(e,t,n,i){let r=null,o=t.name;switch(n){case"float":1===t.count&&4===t.size&&(r={type:"float32",offset:t.offset,stride:t.stride,bufferId:i});break;case"integer":1===t.count&&4===t.size&&(o=t.name+"_v2",r={type:"uint16x2",offset:t.offset,stride:t.stride,bufferId:i})}if(null!==r){let t={};return t[o]=r,e.layout.set(t),!0}return!1},v.prototype.getNodeMaterial=function(){return this._nodeMaterial},v.prototype.getLODMaterial=function(){return this._LODMaterial},v.prototype.createMaterial=function(e,n){let i="depth"===n,r="simple"===n,o=!i&&!r,s=new t.ParticleBasicMaterial({force:!0,transparent:o});s.defines={CIRCLE:this.PointCloudHQ,PARABOLOID_SHAPE:this.PointCloudHQ,NO_COLOR:!1},o?(s.useBlending=!0,s.blending=t.AdditiveBlending,s.depthTest=!0,s.depthWrite=!1):(s.useBlending=!1,s.blending=t.NoBlending,s.depthTest=!0,s.depthWrite=!0),s.activatePDSFX();let a={uMinRamp:{type:"f",value:0},uMaxRamp:{type:"f",value:1},uMinPtSize:{type:"f",value:this._ptMinSize},uMaxPtSize:{type:"f",value:this._ptMaxSize},uMaxSpacing:{type:"f",value:this._maxSpacing},uDPR:{type:"f",value:t.getDevicePixelRatio()},splattingFactor:{type:"f",value:this.splattingFactor},roundPoints:{type:"i",value:this.roundPoints?1:0,stage:t.FragmentStage},seeThroughRange:{type:"f",value:this.seeThroughRange}};o&&(a.normalDepthMap={type:"t2",value:null}),s.setPDSFXUniforms(a);s.setPDSFXVaryings({vScalar:{type:"f"},oocColor:{type:"v3"},viewPos:{type:"v3"},vRadius:{type:"f"}});let d={ptSize:{type:"f"},ptCol:{type:"v3"}},l=this.getStylingAttributesMap(e);l.forEach(((e,t)=>{if(!t.startsWith("Predefined3DSTiles_"))switch(e.type){case"integer":d[t+"_v2"]={type:"v2"};break;case"float":d[t]={type:"f"}}})),s.setPDSFXAttributes(d);let h=e.styling&&e.styling.getRules(),u=h&&h[0],v=null;v=function(e){const t=e.variableHandler;e.functionHandler,e.userDefines;return`\n                ${t.floatG("distance2")};\n                ${t.floatG("weight")};\n                ${t.floatG("customDepth")};\n                `};const S=this;s.setPDSFXGlobalShaderCode((function(e){const t=e.variableHandler,n=e.functionHandler;e.userDefines;return`\n                ${t.vec4G("p")};\n\n                ${u&&u.render&&u.render.buildShaderGlobalCode(e)||""}\n\n                ${S.buildshader_declareAttributes(l,e)}\n\n                ${n.dF("isShowFilterVisible","b",[])}{\n                    ${S.buildshader_filter(u&&u.showFilter,e)}\n                }\n\n                ${n.dF("isRenderFilterVisible","b",[])}{\n                    ${S.buildshader_filter(u&&u.renderFilter,e)}\n                }\n\n                ${n.dF("computeColor","v3",[])}{\n                    ${S.buildshader_computeColor(u&&u.render,e)}\n                }\n            `}),v);let y={ComputeCommonValues:function(e,t){const n=e.variableHandler,i=e.functionHandler;e.userDefines;return`\n                ${S.buildshader_setAttributes(l,e)}\n\n                ${n.vec3("pos")} = ${e.vGetAttribPosition()};\n                p = ${m("computeModelViewPosition","v4",[i.prmV3("pos")])};\n            `},ComputeVaryingValues:function(e,t){const n=e.variableHandler,i=e.functionHandler,r=e.userDefines,o=e.pdsfxDefines;return`\n            ${r.NO_COLOR?p:`\n                if (${i.cF("isRenderFilterVisible","b",[])}) {\n                    ${e.getVarying("oocColor")} = ${i.cF("computeColor","v3",[])};\n                } else {\n\n\n                    ${n.vec3("color")} =  ${o.gammaInput?`${m("convertToLinear","v3",[i.prmV3("ptCol")])}`:"ptCol"};\n\n                    ${e.getVarying("oocColor")} = color;\n                }\n                `}`},ComputePointSize:function(e,t){const n=e.variableHandler,i=(e.functionHandler,t=>e.getUniform(t)),r=e.userDefines;return`\n                ${n.float("spacingScale")} = ptSize*length(modelMatrix[0]);\n                ${n.float("spacing")} = spacingScale * ${i("uMaxSpacing")} * ${i("splattingFactor")};\n\n                ${n.mat4("projMatrix")} = ${e.vGetProjectionMatrix()};\n                //2*near/(top-bottom) for persp. 2/(top-bottom) for ortho.\n                ${n.float("topBottomComposant")} = projMatrix[1][1];\n                ${n.float("pixelSpacingProjection")} = (spacing)*${n.float()}(${e.vGetViewportSize()}.y)*(topBottomComposant/2.0);\n                //-1 in persp, 0 in ortho\n                ${n.float("perspectiveComposant")} = projMatrix[2][3];\n                //1 in ortho, 0 in persp\n                ${n.float("orthographicComposant")} = projMatrix[3][3];\n                ${n.float("spacingInPixels")} = pixelSpacingProjection * ( perspectiveComposant/p.z + orthographicComposant);\n\n                ${n.float("radius")} = clamp( spacingInPixels, ${i("uMinPtSize")}, ${i("uMaxPtSize")} ) * ${i("uDPR")};\n\n                ${r.CIRCLE?"radius *= 1.414;":p}\n\n                ${e.getVarying("vRadius")} = -p.z * tan(0.5 * 45.0 * 3.14159 / 180.0) * radius / ${n.float()}(${e.vGetViewportSize()}.y);\n\n                return radius;\n            `}};y.ProcessClipSpacePosition=i||r?function(e,t){const n=e.variableHandler,r=e.functionHandler,o=(e.userDefines,n.dereference(t[0]));return`\n                    ${S.PointCloudHQ?`\n                            ${n.vec4("mvPos")} = ${n.vec4()}(p.xyz, 1.0);\n                            ${f("tmpPos")} = ${e.vGetProjectionMatrix()} * mvPos;\n                            ${g("adjustedDepth")} = ${s="seeThroughRange",e.getUniform(s)} * ${e.getVarying("vRadius")};\n                            ${i?"adjustedDepth *= 0.99;":p}; // bypass to avoid flickering...\n                            ${g("adjust")} = 1.0 + adjustedDepth / tmpPos.w; // tmpPos.w is original depth\n                            //mvPos.xyz = mvPos.xyz * adjust;\n                            mvPos = ${f()}(mvPos.xyz * adjust, mvPos.w);\n                            ${f("outPos")} = ${e.vGetProjectionMatrix()} * mvPos;\n\n                            ${e.getVarying("viewPos")} = mvPos.xyz;\n\n                            ${o}.x = outPos.x;\n                            ${o}.y = outPos.y;\n                            ${o}.z = outPos.z;\n                            ${o}.w = outPos.w;\n                        `:p}\n\n                    if (!${r.cF("isShowFilterVisible","b",[])}) {\n                        ${o}.x = -10.0;\n                        ${o}.y = -10.0;\n                        ${o}.w = 1.0;\n                    }\n                `;var s}:function(e,t){const n=e.variableHandler,i=e.functionHandler,r=(e.userDefines,n.dereference(t[0]));return`\n                    ${e.getVarying("viewPos")} = p.xyz;\n\n                    if (!${i.cF("isShowFilterVisible","b",[])}) {\n                        ${r}.x = -10.0;\n                        ${r}.y = -10.0;\n                        ${r}.w = 1.0;\n                    }\n                `};let M={ComputeCommonValues:function(e,t){const n=e.variableHandler,i=e.userDefines;return`\n                ${n.vec2("p")} = ${e.vGetPointCoord()};\n                ${n.vec2("uuvv")} = 2.0*p-1.0;\n                distance2 = min(1.0, uuvv.x * uuvv.x + uuvv.y * uuvv.y);\n                ${i.NO_COLOR?p:"weight = pow(1.0 - distance2, 0.5);"}\n            `},ComputeDiscard:function(e,t){const n=e.variableHandler,i=(e.bridgeFunctions,e.userDefines);return`\n                ${i.PARABOLOID_SHAPE?`\n                    ${n.float("wi")} = 0.0 - distance2;\n                    ${n.vec4("pos")} = ${n.vec4()}(${e.getVarying("viewPos")}, 1.0);\n                    pos.z += wi * ${e.getVarying("vRadius")};\n                    pos = ${e.vGetProjectionMatrix()} * pos;\n                    pos = pos / pos.w;\n                    ${e.vSetFragDepth(c.BridgeFunctions.setDepthWithConvention("pos.z"))};\n                    `:p}\n\n                ${S.PointCloudHQ?i.CIRCLE?"return (distance2 >= 1.0);":"return false;":`\n                    if (${e.getUniform("roundPoints")} != 0) {\n                        return (distance2 >= 1.0);\n                    } else {\n                        return false;\n                    }\n                    `}\n            `}};o?(M.ComputeAlbedo=function(e,t){return`\n                    return weight * ${e.getVarying("oocColor")};\n                `},M.ComputeOpacity=function(e,t){return"return weight;"}):r&&(M.ComputeAlbedo=function(e,t){return"\n                "+(e.userDefines.NO_COLOR?"return vec3(1.0);":`return ${e.getVarying("oocColor")};`)}),s.setPDSFXOverridableFunctions(y,M);let D=this;return s._refreshPDSFXUniforms_private=function(e,n){if(e._fixedPointSize?(this.updatePDSFXUniform("uMinPtSize",e._fixedPointSize),this.updatePDSFXUniform("uMaxPtSize",e._fixedPointSize),this.updatePDSFXUniform("uDPR",1),this.updatePDSFXUniform("splattingFactor",1.3)):(this.updatePDSFXUniform("uMinPtSize",D._ptMinSize),this.updatePDSFXUniform("uMaxPtSize",D._ptMaxSize),this.updatePDSFXUniform("uDPR",t.getDevicePixelRatio()),this.updatePDSFXUniform("splattingFactor",D.splattingFactor)),this.updatePDSFXUniform("roundPoints",D.roundPoints?1:0),o){var i=e._v6renderer.PointCloudEffect.composerDepth.composerContext;this.updatePDSFXUniform("normalDepthMap",i.getResult("main",!1))}},s},v.prototype.buildshader_declareAttributes=function(e,t){let n="";const i=t.variableHandler;return e.forEach(((e,t)=>{if(t.startsWith("Predefined3DSTiles_"))n=`\n                    ${n}\n                    ${r=t,i.floatG(r)};\n                `;else if("integer"===e.type)n=`\n                            ${n}\n                            ${(e=>i.intG(e))(t)};\n                        `;var r})),n},v.prototype.buildshader_setAttributes=function(e,t){let n="",i=!1;const r=t.variableHandler;return e.forEach(((e,o)=>{var s;if(i||(i=!0,n=`\n                    ${n}\n                    ${s="_3dstiles_position",r.vec3(s)} = ${t.vGetAttribPosition()};\n                `),"Predefined3DSTiles_x"===o)n=`\n                    ${n}\n                    Predefined3DSTiles_x = _3dstiles_position.x;\n                `;else if("Predefined3DSTiles_y"===o)n=`\n                    ${n}\n                    Predefined3DSTiles_y = _3dstiles_position.y;\n                `;else if("Predefined3DSTiles_z"===o)n=`\n                    ${n}\n                    Predefined3DSTiles_z = _3dstiles_position.z;\n                `;else if("integer"===e.type)n=`\n                            ${n}\n                            ${o} = ${(e=>r.int(e))()}(${o}_v2.x + 65535.0*${o}_v2.y);\n                        `})),n},v.prototype.buildshader_filter=function(e,t){return e?e.buildShaderCode(t):"return true;"},v.prototype.buildshader_computeColor=function(e,t){const n=t.variableHandler,i=t.functionHandler,r=t.pdsfxDefines;if(e){return e.buildShaderCode(t)}return`\n            ${n.vec3("color")} =  ${r.gammaInput?`${m("convertToLinear","v3",[i.prmV3("ptCol")])}`:"ptCol"};\n            return color;\n            `},v.prototype.getStylingAttributesMap=function(e){let t=new Map;if(e.styling){let n,i=e.styling.getNeededAttributes();for(n=0;n<i.length;n++){let r=e.availableAttributesMap.get(i[n]);t.set(i[n],r)}}return t},v.prototype.createUpdatedContentTokenFromContentToken=function(e,t){let n=e.getContentToken(!1);if(!n||n.invalidated)return!1;let i=t.tileSet,r=i.styling&&i.styling.getNeededAttributes(),o=!1;if(r&&0!==r.length){let e;for(o=!0,e=0;e<r.length;e++)r[e].startsWith("Predefined3DSTiles_")||n.attributes&&!(n.attributes.indexOf(r[e])<0)||(o=!1)}else o=!0;if(o){let t=null;t=n.clone(),e.setContentToken(t,!0)}return o},v.prototype.onContentMetaDataUpdate=function(e){let t=e.tileSet,n=t.getContentMetaData("pointCloud/query")||null;if(n=n?encodeURIComponent(n):null,n!==this.getTileSetQuery(t)){let n,i=e.contentSet.getContentsWithContentLoader(this);for(n=0;n<i.length;n++)i[n].invalidateContentTokens(e);t.getTilesManager().requestUpdateTileSetContent(t)}},e.prototype.invalidateContentToken=function(e,t,n){n.invalidated=!0},v.prototype.getSourceIdWithParamsArray=function(e,t){var n=[new l(e.getSingleSourceId(),{urlPostFix:"",attributes:[],index:0,count:0})];let i=t.tileSet,r=null,o=t.tileSet.getContentMetaData("pointCloud/query");if(o){let e=encodeURIComponent(o);r="&query="+e,this.setTileSetQuery(i,e)}else this.setTileSetQuery(i,null);let s,a=i.styling&&i.styling.getNeededAttributes();if(a||o)if(o){let e,t="&m=DEF_POSITION&m=DEF_COLOR",i=[];if(a)for(e=0;e<a.length;e++)a[e].startsWith("Predefined3DSTiles_")||(t+="&m="+a[e],i.push(a[e]));t+=r,n[0].params={uriPostFix:t,attributes:i,index:0}}else{let t;for(t=0;t<a.length;t++)a[t].startsWith("Predefined3DSTiles_")||n.push(new l(e.getSingleSourceId(),{uriPostFix:"&m="+a[t],attributes:[a[t]],index:t+1,count:0}))}for(s=0;s<n.length;s++)n[s].params.count=n.length;return n},v.prototype.setTileSetQuery=function(e,t){let n=this.queryFilterMap.get(e)||null;t=t||null,this.queryFilterMap.set(e,t),t&&n||n===t||(n?e.unlockUseBankForContent():t&&e.lockUseBankForContent())},v.prototype.getTileSetQuery=function(e){return this.queryFilterMap.get(e)||null};class S{constructor(e,t,n,i,r){let o;for(this.node=e,this.content=t,this.geometries=[],this.attributes=null,this.invalidated=!1,this.useCount=[1],o=0;o<i;o++)this.geometries.push(void 0);this.queue=n,this.mesh3D=null,this.size=0,this.PointCloudHQ=r,this.nodeDepth=null,this.nodeColor=null,this.nodeSimple=null}addRef(){this.useCount[0]++}release(){if(this.useCount[0]--,this.useCount[0]<=0){var e=this.node.getSgNode();this.PointCloudHQ?(this.nodeDepth&&this.nodeDepth.removeChild(this.mesh3D),this.nodeColor&&this.nodeColor.removeChild(this.mesh3D),this.nodeSimple&&this.nodeSimple.removeChild(this.mesh3D),e.removeChild(this.nodeDepth),e.removeChild(this.nodeColor),e.removeChild(this.nodeSimple)):e.removeChild(this.mesh3D)}}updateRootAndDepth(){var e=this.node;this.root=this.node,this.depth=-1;do{this.depth++,this.root=e,e=e.parent}while(e)}computeMemorySize(){return new n(0,this.size)}setTileSetVisibility(e){}clone(){let e=new S(this.node,this.content,this.queue,this.geometries.length,this.PointCloudHQ);return e.attributes=this.attributes,e.geometries=this.geometries,e.useCount=this.useCount,e.queue=this.queue,e.mesh3D=this.mesh3D,e.size=this.size,e.addRef(),e.nodeDepth=this.nodeDepth,e.nodeColor=this.nodeColor,e.nodeSimple=this.nodeSimple,e}}return v})),define("DS/3DXMTiles/DSTilesStylingRenderRamp",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingRender","DS/Visualization/ThreeJS_DS"],(function(e,t,n){"use strict";class i extends t{constructor(){super(),this.attribute=null,this.values=[],this.colors=[]}setFromJSON(t){let n=[],i=t.attribute;e.isStylingAttributeName(i)?this.attribute=i:n.push(e.error("illegal attribute property","ramp"));let r,o=!1;for(r=0;r<t.values.length;r++){let n=t.values[r];e.isNumberOrString(n)?this.values.push(n):o=!0}for(o&&n.push(e.error("illegal value","ramp")),o=!1,r=0;r<t.colors.length;r++){let n=t.colors[r];e.isNumberOrString(n)?this.colors.push(n):o=!0}return o&&n.push(e.error("illegal color","ramp")),n.length?e.error("Error parsing ramp render","render",n):this.colors.length!==this.values.length?e.error("colors.length !== values.length","ramp"):e.ok}addNeededAttributesToSet(e){e.add(this.attribute)}buildShaderGlobalCode(e){const t=e.variableHandler,n=e.functionHandler,i=e=>n.prmF(e),r=e=>n.prmV3(e);return`\n            ${n.dF("computeInterpolatedColor","v3",[i("value"),i("value0"),i("value1"),r("color0"),r("color1")])} {\n                if(value0 == value1) {\n                    return color0;\n                } else {\n                    ${o="k",t.float(o)} = (value - value0)/(value1 - value0);\n                    return (1.0 - k) * color0 + k*color1;\n                }\n            }\n            `;var o}buildShaderCode(e){const n=e.variableHandler,r=e.functionHandler,o=e=>n.float(e),s=e=>n.vec3(e),a=e=>r.prmF(e),d=e=>r.prmV3(e);let l=`\n                ${s("color")} = ${i.toShaderColor(this.colors[this.colors.length-1],s,o,e)};\n                ${o("value")} = ${o()}(${this.attribute});\n            `;for(let n=0;n<this.values.length;n++){let i=this.values[n],h=t.toShaderColor(this.colors[n],s,o,e);if(0===n)l=`\n                        ${l}\n                        if (value <= ${o()}(${i})) {\n                            color = ${h};\n                        }\n                    `;else{let c=t.toShaderColor(this.colors[n-1],s,o,e),u=this.values[n-1];l=`\n                        ${l}\n                        else if (value <= ${o()}(${i})) {\n                            color = ${r.cF("computeInterpolatedColor","v3",[a("value"),a(`${o()}(${u})`),a(`${o()}(${i})`),d(`${c}`),d(`${h}`)])};\n                        }\n                    `}}return l=`\n                ${l}\n                return color;\n            `,l}fillGraphicAttributes(e,t){if(t.hasAttribute(this.attribute)){let i=t.getValue(this.attribute),r=null,o=this.values.length;if(i<=this.values[0])r=this.colors[0];else if(i>=this.values[o-1])r=this.colors[o-1];else{let e,t,s,a,d,l=!1;for(e=1;e<o&&!l;e++)t=this.values[e-1],s=this.values[e],i<=s&&(a=this.colors[0],d=this.colors[1],l=!0);if(s===t)r=a;else{r=new n.Color(a);let e=new n.Color(d),o=(i-t)/(s-t);r.lerp(e,o)}}e.color=r}}}return i.jsonType="ramp",i})),define("DS/3DXMTiles/DSTilesStylingRenderRange",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingRender"],(function(e,t){"use strict";class n extends t{constructor(){super(),this.attribute=null,this.values=[],this.colors=[]}setFromJSON(t){let n=[],i=t.attribute;e.isStylingAttributeName(i)?this.attribute=i:n.push(e.error("illegal attribute property","range"));let r,o=!1;for(r=0;r<t.values.length;r++){let n=t.values[r];e.isNumberOrString(n)?this.values.push(n):o=!0}for(o&&n.push(e.error("illegal value","range")),o=!1,r=0;r<t.colors.length;r++){let n=t.colors[r];e.isNumberOrString(n)?this.colors.push(n):o=!0}return o&&n.push(e.error("illegal color","range")),n.length?e.error("Error parsing range render","render",n):this.colors.length!==this.values.length+1?e.error("colors.length !== values.length+1","range"):e.ok}addNeededAttributesToSet(e){e.add(this.attribute)}buildShaderCode(e){const i=e.variableHandler,r=e=>i.float(e),o=e=>i.vec3(e);let s,a=`\n                ${o("color")}  = ${n.toShaderColor(this.colors[this.colors.length-1],o,r,e)};\n            `;for(s=0;s<this.values.length;s++){let n=this.values[s],i=t.toShaderColor(this.colors[s],o,r,e);a=0===s?`\n                        ${a}\n                        if (${r()}(${this.attribute}) <= ${r()}(${n})) {\n                            color = ${i};\n                        }\n                    `:`\n                        ${a}\n                        else if (${r()}(${this.attribute}) <= ${r()}(${n})) {\n                            color = ${i};\n                        }\n                    `}return a=`\n                ${a}\n                return color;\n            `,a}fillGraphicAttributes(e,t){if(t.hasAttribute(this.attribute)){let n=t.getValue(this.attribute),i=null;if(n<=this.values[0])i=this.colors[0];else if(n>this.values[this.values.length-1])i=this.colors[this.colors.length-1];else{let e,t,r,o=!1;for(e=1;e<this.values.length&&!o;e++)t=this.values[e-1],r=this.values[e],n<=r&&(i=this.colors[e],o=!0)}e.color=i}}}return n.jsonType="range",n})),define("DS/3DXMTiles/LDHLoadingBoxManager",["DS/Visualization/ThreeJS_R57","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/3DXMTiles/PriorityQueue"],(function(e,t,n,i){"use strict";var r=function(n,i){this.oocManager=n,this.queue=i,this.lastReferences=[],this.attributes=new o({dimension:2,color:new e.Color("red"),opacity:.1}),this.material=null,this.materialApplication=null,this.pickable=t.PICKABLE,this.maxNbBoxes=r.maxNbBoxes};r.maxNbBoxes=1e3,r.prototype.updateLoadingBoxes=function(){var e,t,n=this.queue.manager.occlusionTestEnabled,i=new Set,r=this.computeReferenceList(n);for(t=0;t<r.length;t++)(e=r[t]).requestBuildSceneGraphHierarchy(!0),e.lockUnload(),i.add(e);var o=this.queue.manager;for(o.tryBuildSceneGraphHierarchy(),t=0;t<r.length;t++)(e=r[t]).displayBox(o);for(t=0;t<this.lastReferences.length;t++)e=this.lastReferences[t],i.has(e)||e.removeBox(o),e.unlockUnload();this.lastReferences=r},r.prototype.removeBoxes=function(){var e,t,n=this.queue.manager;for(e=0;e<this.lastReferences.length;e++)(t=this.lastReferences[e]).removeBox(n),t.unlockUnload();this.lastReferences=[]},r.prototype.getMaterial=function(){var t;return null===this.material&&(t=this.attributes,this.material=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,transparent:t.opacity<1,force:!0})),this.material},r.prototype.getMaterialApplication=function(){return null===this.materialApplication&&(this.materialApplication=new n({faceMaterial:this.getMaterial(),layer:-1/0})),this.materialApplication},r.prototype.computeReferenceList=function(e){var t,n,i=[],r=this.queue,o=0,s=this.oocManager._getActiveRootLDHReferences();for(t=0;t<s.length;t++)0!==(n=s[t]).children.length||n.isLeaf()||i.push(s[t]);for(t=0;t<r.nodes.length;t++)n=r.nodes[t],this.shouldDisplayBox(n,e)&&(o+=n.getNbOccurrences(),i.push(n));return o>this.maxNbBoxes&&(i=this.selectBiggestReferences(i,this.maxNbBoxes)),i},r.prototype.selectBiggestReferences=function(e,t){var n,r=new i(t);for(n=0;n<e.length;n++)r.addNode(e[n]);var o=[],s=0;return r.traverseMaxPlus((function(e,n,i){o.push(e),(s+=e.getNbOccurrences())>t&&n()})),o},r.prototype.shouldDisplayBox=function(e,t){return!(!e.isInToBeLoaded()||t&&!e.isOcclusionVisible())},r.prototype.setParams=function(e){e=e||{},this.material=null,this.materialApplication=null,this.attributes.setParams(e.repRefAttributes)},r.prototype.dispose=function(){this.removeBoxes()},r.prototype.updateBoxes=function(){var e,t,n=this.oocManager._ldhNodeManager;for(e=0;e<this.lastReferences.length;e++)(t=this.lastReferences[e]).removeBox(n),t.displayBox(n)},r.prototype.setPickable=function(e){this.pickable=e,this.updateBoxes()};var o=function(e){this.color=e.color.clone(),this.opacity=e.opacity,this.count=e.count||0};return o.prototype.setParams=function(e){e.color&&(this.color=e.color.clone()),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.count&&(this.count=e.count||0)},r})),define("DS/3DXMTiles/BSScreenSizeLODSelector",["DS/3DXMTiles/LODSelector","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";new t.Vector3,new t.Matrix4;var n=e.extend({init:function(){this._parent(),this.type="BSScreenSize",this._debug_screenSize=-1},computeLOD:function(e,t){return e.computeScreenRadius(t)>=(this._debug_screenSize>=0?this._debug_screenSize:t.pixelCulling)?1:0},getLOD:function(e,t){return e>=(this._debug_screenSize>=0?this._debug_screenSize:t.pixelCulling)?1:0}});return n.createFromJSON=function(e){var t=e.screenSize;return new n(parseFloat(t))},n})),define("DS/3DXMTiles/LDHReference",["DS/3DXMTiles/BSScreenSizeLODSelector","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHOccurrence","DS/Visualization/ThreeJS_R57","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHHandler","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/3DXMTiles/LDHReferenceUnloadStatus","DS/3DXMTiles/LDHOcclusionStatus","DS/Visualization/SceneGraphFactory","DS/3DXMTiles/AsyncCaller","DS/3DXMTiles/LDHSwitchRepresentationData","DS/Visualization/PLMMaterialConnectionFactory","DS/VisuTools/OOCReplay","DS/3DXMTiles/SSBData"],(function(e,t,n,r,o,s,a,d,l,h,c,u,p,g,f,m,v,S,y,M){"use strict";var D=1,T={inList:1,inToBeLoaded:2,inLoaded:4,inForced:8,inUnknown:16,inHighPriority:24,occlusionVisible:32,loadingBoxVisible:64,repLoaded:128,legacyUV:256,needUpdateOccurrences:512,needUpdateOccurrencesUnder:1024,needFullUpdateOccurrences:2048,hidden:4096,visibilityFree:8192,vdrp:16384,hierarchyChange:32768,hierarchyChangeUnder:65536,overrideSetUnder:1<<17},C="requested",b="none",L="slave",R=new e;let _=-1;var w=function(e,t,n){this.reference=e,this.node=null,this.matrix=t,this.instanceId=n,this.userData=null,this.sceneGraphOverrideSet=null},N=-1,x=localStorage.getItem("OOCBoxDebug"),O=new Map,P=function(e){this.flags=0,-1===N&&(N=window.OOCForceBoundingSphere?1:0),-1===_&&(_="true"===localStorage.getItem("OOCLoadOrderNearFirst")?1:0),this.id=D++,this._occurrences=[],this._rep=null,e.positioningArch&&this.setVDRP(!0),this._boundingSphere=e.boundingSphere,this._boundingBox=e.boundingBox,this.updateBoundingSphere(),this.handler=e.handler,this._screenRadiusCache=[],this._screenRadius=0,this._ssbLimitRadius=0,this._rep=null,this.children=[],this._status=d.waiting,this._optional=null,this.parents=[],this.referenceId=e.referenceId,this.userData=null,this.unloadLockCounter=0,this.occlusionId=-1,this.isRoot=!1,this.ssbData=null,x&&(this.byteSize=0),this.memoryData=new B,this.sgFlag=e.leaf?L:b,S.hasLegacyUV(e.referenceId)&&this.setLegacyUV(),this.instancesToUpdate=null,this.sceneGraphOverrideSet=null,this.updateMemorySizeNEW(e.manager)};P.prototype.isLoading=function(){return this._status===d.loading},P.prototype.isToUnload=function(){return this._status===d.toUnload||this._status===d.toUnloadLight},P.prototype.isToUnloadLight=function(){return this._status===d.toUnloadLight},P.prototype.isToLoad=function(){return this._status===d.toLoad},P.prototype.shouldBeExpanded=function(){return this._status!==d.dead&&(!(!this._rep||this._rep.active)||this._status!==d.error&&(this._status!==d.error&&!this.isRepLoaded()))},P.prototype.hasGoodRep=function(){return this._rep&&this._rep.active},P.prototype.setIsRoot=function(e,t,n){if(e!==this.isRoot)if(this.isRoot=e,e){if(this._rep.node){t.targetNode.addChild(this._rep.node);let e,i=t.targetNode._occurrences[0];for(e=0;e<i.children.length;e++){let t=i.children[e];t.node===this._rep.node&&n.setOccurrenceNode(t)}n.requestOccurrenceNodeUpdate(),n.updateChildrenOccurrenceNode()}}else this._rep.node&&t.targetNode.removeChild(this._rep.node)},P.prototype.getNbOccurrences=function(){return this.getOccurrences().length},P.prototype.hasNode3D=function(){return!(!this._rep||!this._rep.node)},P.prototype.getOccurrences=function(){return this.hasNode3D()?this._rep.node?this._rep.node._occurrences:null:this._occurrences},P.prototype.getLDHOccurrences=function(){return this._occurrences},P.prototype.isComplete=function(){return this.isLoaded()},P.prototype.isLoaded=function(){return this._status===d.loaded},P.prototype.forceLoad=function(e,t,n){var i=this.isForced();this._optional||(this._optional=new V),e?(this._optional._force||(this._optional._force=new H),!this.isLoading()&&this.isRepLoaded()&&(this.isLoaded()||this.isToUnload())&&this.hasGoodRep()?(m.call(t),this._optional._force=new H):this._optional._force.onForce(t)):this._optional._force=null;var r=this.isForced();i!==r&&(r?this.lockUnload(void 0,void 0,!0):this.unlockUnload(void 0,void 0,void 0,!0),n.registerTilesNode(this))},P.prototype.getMeshInRAM=function(){var e=this.getActiveRepresentation();return!!e&&!e.noMeshInRAM},P.prototype.setOverrideCB=function(e,t,n){t&&!this._optional&&(this._optional=new V),this._optional&&(this._optional.setOverride(e,t),this.updateOverride(n))},P.prototype.hasOverrideCB=function(e){return!!this._optional&&this._optional.hasOverride(e)},P.prototype.removeParentFromParentsArray=function(e){var t,n=0;for(t=0;t<this.parents.length;t++)this.parents[t]!==e&&(this.parents[n]=this.parents[t],n++);this.parents.length=n},P.prototype.removeParent=function(e,t){var n;t||this.removeParentFromParentsArray(e);var i,r=0;for(i=0;i<this._occurrences.length;i++)(n=this._occurrences[i]).parent&&n.parent.reference!==e?(this._occurrences[r]=n,r++):n.parent=null;this._occurrences.length=r,this.unloadLockCounter>0&&this.unlockUnload(this.unloadLockCounter,e)},P.prototype.removeChild=function(e,t){var n,i,r,o,s=t._ldhNodeManager.viewer._idPathOverrideWatcher.idPathWatcher,a=0;for(n=0;n<this.children.length;n++)if((r=this.children[n]).reference===e){for(i=r.instanceId,o=0;o<this._occurrences.length;o++)this._occurrences[o].removeChildWithInstanceId(i);t._unregisterInstance(i),s.onCandidateRemoveChild(i,r.reference.referenceId),s.onCandidateRemoveChild(this.referenceId,i)}else this.children[a]=r,a++;this.children.length=a,this.updateMemorySizeNEW(t._ldhNodeManager)},P.prototype.removeFromParents=function(e){var t;for(t=0;t<this.parents.length;t++)this.parents[t].removeChild(this,e),this.removeParent(this.parents[t],!0);this.parents=[]},P.prototype.unregister=function(e){this.isAlive()&&e._unregisterReference(this.referenceId)},P.prototype.addToOcclusionChecker=function(e){if(!e.hasReference(this)){var t,n=[],i=[];if(this.hasNode3D()){var r,o=this._rep.node._occurrences;for(t=0;t<o.length;t++)r=o[t],n.push(r.matrix),i.push(!(r.occurrenceRenderingOverride&&r.occurrenceRenderingOverride.clippingContext&&r.occurrenceRenderingOverride.clippingContext._internal_hasUncut()))}else{var s,a=this._occurrences;for(t=0;t<a.length;t++)s=a[t],n.push(s.matrix),i.push(!s._getDisableOcclusionClipping())}var d=this.getBoundingBox();this.occlusionId=e.addBox(d,n,i),e.addReference(this)}},P.prototype.setStatus=function(e,t){if(this._status!==d.dead){var n=this._status!==e;this._status=e,n&&t.registerTilesNode(this)}},P.prototype.setLoading=function(e){this.setStatus(d.loading,e)},P.prototype.hasUnloadFrozenParent=function(){return 0!==this.parents.length&&this.parents[0].isUnloadFrozen()},P.prototype.isUnloadFrozen=function(){return this._status===d.freezeUnload},P.prototype.isLeaf=function(){return this.handler.type===l.Model3DHandler||this.handler.type===l.TileSetHandler},P.prototype.is3DShape=function(){return this.handler.type===l.Model3DHandler},P.prototype.freezeUnload=function(){this.traverse((function(e){return!(!e.isLeaf()&&!e.isUnloadFrozen())||(e._status=d.freezeUnload,!1)}))},P.prototype.buildFlatList=function(){var e=[];this.traverse((function(t){return!(t.id>0)||(t.id*=-1,e.push(t),!1)}));var t=0;for(t=0;t<e.length;t++)e[t].id*=-1;return e},P.prototype.addReferenceChild=function(e,t,n,i,o){var s,a,d;e.getCandidateOverrideSetManagerUnder()&&this.setCandidateOverrideSetManagerUnderTraverse();var l=new w(e,t,n),h=this._occurrences.length;for(s=0;s<this._occurrences.length;s++)if(a=this._occurrences[s],d=new r({reference:e,matrix:t,manager:o,node:null,parent:a,instanceData:l},i),a.addChild(d,o),this._occurrences.length>h)return!1;return this.children.push(l),e.unloadLockCounter>0&&e.lockUnload(e.unloadLockCounter),-1===e.parents.indexOf(this)&&e.parents.push(this),null!==e._rep.node&&this.requestBuildSceneGraphHierarchy(!0),this.isLegacyUV()&&e.setLegacyUV(),this.setHierarchyChangeTraverse(),this.updateMemorySizeNEW(o),!0},P.prototype.getOccurrencesFromInstanceId=function(e){var t,n=[];for(i=0;i<this._occurrences.length;i++)(t=this._occurrences[i]).instanceId===e&&n.push(t);return n},P.prototype.detachReference=function(e,t,n,i,r){var o,s,a,d,l,h=[],c=[],u=[];if(a=0,null===e){for(o=0;o<this._occurrences.length;o++)u=u.concat(this._occurrences[o].getChildren());if(0===this._occurrences.length&&r){var p=this;this.traverse((function(e){if(e!==p){if(e._occurrences.length>0)return!0;r.add(e)}}))}if(h=this.children,n)for(o=0;o<h.length;o++)c.push(h[o].instanceId),h[o].reference.removeParentFromParentsArray(this);this.children=[]}else{for(d=!1,o=0;o<this.children.length;o++)(s=this.children[o]).reference!==e||null!==t&&s.instanceId!==t?(this.children[a]=this.children[o],s.reference===e&&(d=!0),a++):(h.push(s),c.push(s.instanceId));var g;for(this.children.length=a,o=0;o<e._occurrences.length;o++)!(g=(l=e._occurrences[o]).parent)||g.reference!==this||null!==t&&l.instanceData.instanceId!==t||-1!==u.indexOf(l)||u.push(l)}var f=new Set;for(o=0;o<u.length;o++)(l=u[o]).detach(f);f.forEach((function(e){e._removeNullsFromOccurrenceList(),r&&0===e._occurrences.length&&r.add(e)}));var m=i._ldhNodeManager,v=m.viewer._getIdPathOverrideWatcher().idPathWatcher,S=this.getNode(),y=[];for(o=0;o<h.length;o++){s=h[o],y.push(s.instanceId,s.reference.referenceId),y.push(this.referenceId,s.instanceId),S&&S.removeChild(s.node);var M=s.reference.getNode();s.node&&(s.node.removeChild(M),s.node=null)}if(0===this.children.length&&this.removeFromSceneGraph(!1,m),!d&&e&&n){for(a=0,o=0;o<e.parents.length;o++)e.parents[o]!==this&&(e.parents[a]=e.parents[o],a++);e.parents.length=a}if(null!==t)i._unregisterInstance(t);else for(o=0;o<c.length;o++)i._unregisterInstance(c[o]);for(o=0;o<y.length;o+=2)v.onCandidateRemoveChild(y[o],y[o+1])},P.prototype.updateInstance=function(e,t,n){var i=this.getChild(e);t.instanceId&&(i.instanceId=t.instanceId,i.node&&i.node.setModelIdentification(t.instanceId)),t.matrix&&(i.node&&i.node.setMatrix(t.matrix),i.matrix?i.matrix.copy(t.matrix):i.matrix=t.matrix.clone(),this.updateOccurrencesPosition(n,i.instanceId))},P.prototype.addOnLoadedCB=function(e){this._optional||(this._optional=new V),this._optional.addOnLoadedCB(e)},P.prototype._onLoaded=function(){this._optional&&this._optional._force&&this._optional._force.onLoaded(),this._optional&&this._optional.onLoaded()},P.prototype._onOccluded=function(){this._optional&&this._optional.onLoaded()},P.prototype.computeLODValue=function(e){var t=R.computeLOD(this,e);return y.recording&&(t=1),null===this._boundingSphere&&(t=1),t},P.prototype.getLODValue=function(e){return R.getLOD(this._screenRadius,e)};var I=[];function B(){this.memory=0,this.memoryGPU=0,this.memoryMeshInRAM=0}P.prototype.computeScreenRadius=function(e){var n=e.cst,i=e.viewpoint,r=this.hasNode3D(),o=!1,s=!1;if(this._topLoadPriority)return this._screenRadius=1/0,this._ssbLimitRadius=0,this.setHidden(o),this.setVisibilityFree(!0),this._screenRadius;if(this._boundingSphere){var a,d,l,h,c,u,p=-1/0,g=0,f=this._screenRadiusCache,m=!1;if(r)for(d=this._rep.node._occurrences,u=0;u<d.length&&!m;u++)d[u]._getNeedOverridesUpdate()&&(m=!0);let y=!1;if(!r||m)for(l=this._occurrences,I.length=l.length,o=!0,u=0;u<l.length;u++){I[u]=l[u].matrix,l[u]._getVisible()&&(o=!1);let e=l[u]._getVisibilityFree();e&&(s=!0),e!==s&&(y=!0)}else{for(d=this._rep.node._occurrences,I.length=d.length,o=!0,u=0;u<d.length;u++){I[u]=d[u].matrix,d[u]._getVisible()&&(o=!1);let e=d[u]._getVisibilityFree();e&&(s=!0),e!==s&&(y=!0)}if(f){var v=!1;for(f.length!==d.length&&(v=!0),u=0;!v&&u<d.length;u++)(c=f[u]).positionHasChanged(d[u].matrix)&&(v=!0)}v&&(f=[],this._screenRadiusCache=f)}for(u=0;u<I.length;u++){var S=I[u];g>=f.length?(c=t.computeScreenRadiusCache(S,null,this._boundingSphere,void 0,r),f.push(c)):c=f[g],g++,p<(h=t.computeScreenRadius(c,i.camera,i._frustum,n))&&(p=h,a=t.computeScreenRadiusFactor(c,i.camera,i._frustum,n))}if(_<=0)this._screenRadius=p;else{let e=1/0,t=i.camera.position;for(u=0;u<f.length;u++){let n=Math.max(f[u].distanceToPoint(t),0);n<e&&(e=n)}this._screenRadius=e>0?1/e:1/0}return this._ssbLimitRadius=a>0?e.pixelCulling/a:0,this.setHidden(!y&&o),this.setVisibilityFree(!!s||s),p}return this._screenRadius=1,this._ssbLimitRadius=0,this.setHidden(o),this.setVisibilityFree(s),this._screenRadius},P.prototype.getAllMatrices=function(){var e,t,n,i=[];if(this.hasNode3D())for(t=this._rep.node._occurrences,i.length=t.length,e=0;e<t.length;e++)i[e]=t[e].matrix;else for(n=this._occurrences,i.length=n.length,e=0;e<n.length;e++)i[e]=n[e].matrix;return i},P.prototype.getScreenRadiusCache=function(e){var n=null,i=this.hasNode3D(),r=this.getBoundingSphere();if(r){var o,s,a,d;if(n=this._screenRadiusCache,i){for(a=this._rep.node._occurrences,e.length=a.length,s=0;s<a.length;s++)e[s]=a[s].matrix;if(n){var l=!1;for(n.length!==a.length&&(l=!0),s=0;!l&&s<a.length;s++)(o=n[s]).positionHasChanged(a[s].matrix)&&(l=!0)}l&&(n=[],this._screenRadiusCache=n)}else for(d=this._occurrences,e.length=d.length,s=0;s<d.length;s++)e[s]=d[s].matrix;for(s=n.length;s<e.length;s++){var h=e[s];0>=n.length&&(o=t.computeScreenRadiusCache(h,null,r,void 0,i),n.push(o))}}return n},P.prototype.isCollidingWithBox=function(e,t,n,i){var r,o,s=this.getScreenRadiusCache(i),a=!1,d=null;if(s)for(r=0;r<s.length;r++)if(o=s[r],n.center.x=o.center.x,n.center.y=o.center.y,n.center.z=o.center.z,n.radius=o.radius,t.intersectsSphere(n)&&(a||(a=!0,d=this.getBoundingBox()),d&&e.isIntersectingWith(d,i[r])))return!0;return!1},P.prototype.updateNodeLOD=function(e){var t;return this.isForced()?(t=1,this._screenRadius=1/0):t=this.computeLODValue(e),t},B.prototype.set=function(e){if(e.isAlive()){var t=e.getMeshSize();if(e.handler.type===l.Model3DHandler)this.memory=0;else{var n=e._rep&&e._rep.node,i=0;n&&(i=824+280*(n._occurrences.length-1)),this.memory=232+336*e._occurrences.length+336*e.children.length+i}this.memoryMeshInRAM=e._rep&&!e._rep.noMeshInRAM?t:0,this.memoryGPU=t}},B.prototype.equals=function(e){return this.memory===e.memory&&this.memoryGPU===e.memoryGPU&&this.memoryMeshInRAM===e.memoryMeshInRAM},B.bank=new Map,B.getFromBank=function(e){var t=null;if(0!==e.memory)if(t=B.bank.get(e.memory)){if(e.equals(t))return t}else B.bank.set(e.memory,e);return e},P.prototype.computeMemoryData=function(e){var t=null;return(t=new B).set(this),t=B.getFromBank(t)},P.prototype.getMeshSize=function(){return this._rep?this._rep.getMeshSize():0},P.prototype.updateMemorySizeNEW=function(e){var t=this.memoryData,n=e.unloadManager,i=this.computeMemoryData(),r=!1;if(0===this.handler.type){r=this.getMeshInRAM();var o=this.getLDHNodeManagerQueue(e);this.getMeshSize()>0&&o.memorizeReferenceSize(this.referenceId,this.getMeshSize())}n.onReferenceMemoryDataChange(t,i,r),this.isAlive()||O.delete(this),this.memoryData=i},P.prototype.requestBuildSceneGraphHierarchy=function(e){if(this.sgFlag===b){var t,n=e||!1;for(t=0;t<this.children.length&&!n;t++)this.children[t].reference.sgFlag!==b&&(n=!0);if(n)for(this.setSGFlag(C),t=0;t<this.parents.length;t++)this.parents[t].requestBuildSceneGraphHierarchy(!0)}},P.prototype.setSGFlag=function(e){this.sgFlag=e},P.prototype.tryBuildSceneGraphHierarchy=function(e,t){let n=new Set;if(this.tryBuildSceneGraphHierarchy_internal(e,t,n),!t.isSlave()){let e;for(e=0;e<this._occurrences.length;e++){let t=this._occurrences[e];(t.occurrenceNode&&t._getDescendantNeedsOccurrenceNodeUpdate()||t._getChildNeedsOccurrenceNodeUpdate())&&t.updateChildrenOccurrenceNode()}}},P.prototype.tryBuildSceneGraphHierarchy_internal=function(e,t,n){var i,r,o,a=!1;let d=new Set;if(this.sgFlag===C){this.clearScreenRadiusCache();var l=!!this._rep.node;let n=!1;if(!this._rep.node){if(this._rep.node=new s,a=!0,this.requestOccurrenceNodeUpdate(null),this.userData&&this._rep.node.setUserData(this.userData),this._rep.node.setModelIdentification(this.referenceId),this._rep.node.setNodeUsage(this.handler.getNodeUsage()),this._boundingSphere&&N&&this._rep.node.forceBoundingElements(!0,{sphere:this._boundingSphere},null),this.isRoot&&(t.targetNode.addChild(this._rep.node),1===this._occurrences.length)){var h=this._occurrences[0];h.instanceData.matrix&&this._rep.node.setMatrix(h.instanceData.matrix),t.isSlave()||h.setOccurrenceNode(this._rep.node._occurrences[0])}if(this._optional&&this._optional.hasOverride()&&e.push(this),this.sceneGraphOverrideSet){let e=this._rep.node,t=this.sceneGraphOverrideSet;t.node=e,e._setOverrideSetManager(t)}t.oocManager._onNodeCreate(this._rep.node)}let c=[],u=[];for(i=0;i<this.children.length;i++)if((o=(r=this.children[i]).reference).tryBuildSceneGraphHierarchy_internal(e,t,d),!r.node&&o._rep.node){if(a=!0,o.requestOccurrenceNodeUpdate(this),r.node=new s,r.userData&&r.node.setUserData(r.userData),r.node.setModelIdentification(r.instanceId),r.node.setNodeUsage(s.INSTANCE_NODE),o.getVDRP()&&t.oocManager._ghostInstances.has(r.instanceId)&&(r.node.setVisibility(!1),r.node.setVisibilityFree(!0)),t.oocManager._onNodeCreate(r.node),r.node.setMatrix(r.matrix),r.node._addChild(o._rep.node,void 0,!0),c.push(r.node),u.push(o._rep.node),this._rep.node._addChild(r.node,void 0,!0),r.sceneGraphOverrideSet){let e=r.node,t=r.sceneGraphOverrideSet;t.node=e,e._setOverrideSetManager(t),t._activate()}c.push(this._rep.node),u.push(r.node),n=!0}for(i=0;i<c.length;i++)c[i]._addChild_publishEvent(u[i]);this.setSGFlag(b),this._rep.node&&!l&&this._optional&&this._optional.onAddedToSceneGraphCB&&this._optional.onAddedToSceneGraphCB.call(void 0,this.referenceId),this.updateMemorySizeNEW(t)}a?n.add(this):d.forEach((e=>{n.add(e)}))},P.prototype.recursiveUpdateMemorySize=function(e){if(0===this.handler.type)this.updateMemorySizeNEW(e);else{var t,n=this.buildFlatList();for(t=0;t<n.length;t++)n[t].updateMemorySizeNEW(e)}},P.prototype.updateOverride=function(e){var t=this._optional;t&&t.overrideData&&(t.overrideData.updateOverride(e,this._rep.node,this.referenceId),t.overrideData.isEmpty()&&(t.overrideData=null))},P.prototype.removeRepresentationChildren=function(e){if(-1===P.useRepNodeName&&(P.useRepNodeName=window.OOCEnableRepNodeName?1:0),e){var t,n,i=e.children;for(t=i.length-1;t>=0;t--)n=i[t],1===P.useRepNodeName?n.name===P.RepNodeName&&e.removeChild(n):P.RepNodeSet.has(n.id)&&(e.removeChild(n),P.RepNodeSet.delete(n.id))}},P.prototype.removeFromSceneGraph=function(e,t){if(this.isSlave())t.unloadLeafReferenceCB(this.referenceId);else{if(this.clearScreenRadiusCache(),0===this.parents.length&&!this.isLeaf())return;if(null!==this._rep.node)if(this.isUnloadLocked())e&&this.removeRepresentationChildren(this._rep.node);else{var n,i,r=t.oocManager;if(this._rep.node.children.length>0)for(this._rep.node.removeChildren(),n=0;n<this.children.length;n++)(i=this.children[n]).node&&(i.node.removeChildren(),i.node=null);if(this.parents.length>0){var o,s,a=this._rep.node.parents.concat([]);for(n=0;n<a.length;n++)s=(o=a[n]).parents[0],o.removeChild(this._rep.node),s.removeChild(o),r._onNodeRemove(o);for(n=0;n<this.parents.length;n++)this.parents[n].removeChildNode(this,t),this.parents[n]._rep.node&&0===this.parents[n]._rep.node.children.length&&this.parents[n].removeFromSceneGraph(!1,t)}for(r._onNodeRemove(this._rep.node),n=0;n<this._occurrences.length;n++)this._occurrences[n].resetOccurrenceNode();this._rep.node=null,this._optional&&this._optional.onRemovedFromSceneGraphCB&&this._optional.onRemovedFromSceneGraphCB.call(void 0,this.referenceId)}}this.ssbData=null,this.setRepLoaded(!1),this._rep.updateMeshSize(this),this.updateMemorySizeNEW(t),this.updateOverride(t)},P.prototype.removeChildNode=function(e,t){var n,i;for(n=0;n<this.children.length;n++)(i=this.children[n]).reference===e&&(i.node=null);this.updateMemorySizeNEW(t)},P.prototype.getChildInstanceNode=function(e){var t,n;for(t=0;t<this.children.length;t++)if((n=this.children[t]).instanceId===e)return n.node;return null},P.prototype.traverse=function(e){var t;if(!e(this))for(t=0;t<this.children.length;t++)this.children[t].reference.traverse(e)},P.prototype.traverseUnique=function(e){let t=new Set;this.traverseUnique_internal(e,t)},P.prototype.traverseUnique_internal=function(e,t){var n;if(!t.has(this)&&(t.add(this),!e(this)))for(n=0;n<this.children.length;n++)this.children[n].reference.traverseUnique_internal(e,t)},P.prototype.traverseParents=function(e,t){if(!t||!t.has(this)){var n=new Set;n.add(this),this.traverseParents_internal(e,t,n)}},P.prototype.traverseParents_internal=function(e,t,n){var i,r;if(!e(this))for(i=0;i<this.parents.length;i++)r=this.parents[i],n.has(r)||t&&t.has(r)||(n.add(r),r.traverseParents_internal(e,t,n))},P.prototype.createJSON=function(){var e={references:[]};this.traverse((function(e){e.visited=!1}));var t,n,i,r,o=0;for(this.traverse((function(t){if(!t.visited){t.visited=!0,t.jsonIndex=o++;var n=t.createJSON_internal();e.references.push(n)}})),t=0;t<e.references.length;t++)for(i=e.references[t],n=0;n<i.c.length;n++)(r=i.c[n]).r=r.r.jsonIndex;return e},P.prototype.createJSON_internal=function(){var e,t,n,i={url:this.url,bs:this._boundingSphere?this._boundingSphere.createJSON():null,i:!!this._rep.node,c:[]};for(e=0;e<this.children.length;e++)t=this.children[e],(n={}).m=t.matrix.createJSON(),n.r=t.reference,n.i=!!t.node,i.c.push(n);return i},P.prototype._removeOccurrenceFromList=function(e){var t=this._occurrences.indexOf(e);t<0?console.log("Internal inconsistency"):this._occurrences[t]=null},P.prototype._removeNullsFromOccurrenceList=function(){var e,t=0;for(e=0;e<this._occurrences.length;e++){var n=this._occurrences[e];n&&(this._occurrences[t]=n,t++)}this._occurrences.length=t},P.prototype._isDetachPossible=function(){return 0===this._occurrences.length},P.prototype.isWaiting=function(){return this._status===d.waiting},P.prototype.isUnknown=function(){return!this._boundingSphere&&!this.isLoaded()},P.prototype.isForced=function(){return!(!this._optional||!this._optional._force)},P.prototype.setOnRemovedFromSceneGraphCB=function(e){this._optional||(this._optional=new V),this._optional.onRemovedFromSceneGraphCB=e,!this._rep.node&&e&&e.call(void 0,this.referenceId)},P.prototype.setOnAddedToSceneGraphCB=function(e){this._optional||(this._optional=new V),this._optional.onAddedToSceneGraphCB=e,this._rep.node&&e&&e.call(void 0,this.referenceId)},P.prototype.isInList=function(){return!!(this.flags&T.inList)},P.prototype.setInList=function(e){this.flags=e?this.flags|T.inList:this.flags&4294967295-T.inList},P.prototype.isInToBeLoaded=function(){return!!(this.flags&T.inToBeLoaded)},P.prototype.setInToBeLoaded=function(e){this.flags=e?this.flags|T.inToBeLoaded:this.flags&4294967295-T.inToBeLoaded},P.prototype.isInLoaded=function(){return!!(this.flags&T.inLoaded)},P.prototype.setInLoaded=function(e){this.flags=e?this.flags|T.inLoaded:this.flags&4294967295-T.inLoaded},P.prototype.isInForced=function(){return!!(this.flags&T.inForced)},P.prototype.setInForced=function(e){this.flags=e?this.flags|T.inForced:this.flags&4294967295-T.inForced},P.prototype.isInUnknown=function(){return!!(this.flags&T.inUnknown)},P.prototype.isInHighPriority=function(){return!!(this.flags&T.inHighPriority)},P.prototype.setInUnknown=function(e){this.flags=e?this.flags|T.inUnknown:this.flags&4294967295-T.inUnknown},P.prototype.setOcclusionVisible=function(e){this.flags=e?this.flags|T.occlusionVisible:this.flags&4294967295-T.occlusionVisible},P.prototype.isOcclusionVisible=function(){return!!(this.flags&T.occlusionVisible)},P.prototype.setLoadingBoxVisible=function(e){this.flags=e?this.flags|T.loadingBoxVisible:this.flags&4294967295-T.loadingBoxVisible},P.prototype.isLoadingBoxVisible=function(){return!!(this.flags&T.loadingBoxVisible)},P.prototype.setRepLoaded=function(e){this.flags=e?this.flags|T.repLoaded:this.flags&4294967295-T.repLoaded},P.prototype.isRepLoaded=function(){return!!(this.flags&T.repLoaded)},P.prototype.setLegacyUV=function(){var e;if(!this.isLegacyUV())for(this.flags=this.flags|T.legacyUV,e=0;e<this.children.length;e++)this.children[e].reference.setLegacyUV()},P.prototype.isLegacyUV=function(){return!!(this.flags&T.legacyUV)},P.prototype.getNeedUpdateOccurrences=function(){return!!(this.flags&T.needUpdateOccurrences)},P.prototype.setNeedUpdateOccurrences_internal=function(e){this.flags=e?this.flags|T.needUpdateOccurrences:this.flags&4294967295-T.needUpdateOccurrences},P.prototype.getNeedUpdateOccurrencesUnder=function(){return!!(this.flags&T.needUpdateOccurrencesUnder)},P.prototype.setNeedUpdateOccurrencesUnder=function(e){this.flags=e?this.flags|T.needUpdateOccurrencesUnder:this.flags&4294967295-T.needUpdateOccurrencesUnder},P.prototype.getNeedFullUpdateOccurrences=function(){return!!(this.flags&T.needFullUpdateOccurrences)},P.prototype.setNeedFullUpdateOccurrences=function(e){this.flags=e?this.flags|T.needFullUpdateOccurrences:this.flags&4294967295-T.needFullUpdateOccurrences},P.prototype.getHidden=function(){return!!(this.flags&T.hidden)},P.prototype.setHidden=function(e){this.flags=e?this.flags|T.hidden:this.flags&4294967295-T.hidden},P.prototype.getVisibilityFree=function(){return!!(this.flags&T.visibilityFree)},P.prototype.setVisibilityFree=function(e){this.flags=e?this.flags|T.visibilityFree:this.flags&4294967295-T.visibilityFree},P.prototype.getVDRP=function(){return!!(this.flags&T.vdrp)},P.prototype.setVDRP=function(e){this.flags=e?this.flags|T.vdrp:this.flags&4294967295-T.vdrp},P.prototype.setNeedUpdateOccurrences=function(e){e&&this.traverseParents((e=>!!e.getNeedUpdateOccurrencesUnder()||(e!==this&&e.setNeedUpdateOccurrencesUnder(!0),!1)),null),this.setNeedUpdateOccurrences_internal(e)},P.prototype.requestUpdateOccurrencesPosition=function(e,t){t?(this.instancesToUpdate||(this.instancesToUpdate=[]),this.instancesToUpdate.push(t)):this.setNeedFullUpdateOccurrences(!0),this.setNeedUpdateOccurrences(!0),e.requestUpdate(!1)};var U="OOC##beImpostor";function A(e,t){if(!e.isEmpty()){var n,i,r=e.get();for(n=0;n<r.length;n++){var o=r[n].pathElement,s=o&&o.externalPath;if(o)for(i=s.length-1;i>=0;i--)if(s[i]===t)return!0}}return!1}P.prototype.updateBoundingElementImpostor=function(){if(P.slaveBoxFix&&(this._boundingBox||this._boundingSphere)){var e,t,n=!1;for(e=0;!n&&e<this._rep.node.children.length;e++)(t=this._rep.node.children[e]).name===U&&(this._rep.node.removeChild(t),n=!0);var i=new s(U);this._rep.node.forceBoundingElements(!0,{sphere:this.getBoundingSphere(),box:this.getBoundingBox()}),this._rep.node.addChild(i)}},P.setScreenSize=function(e){R._debug_screenSize=e},P.getScreenSize=function(){return R._debug_screenSize},P.prototype.isAlive=function(){return this._status!==d.dead},P.prototype.isError=function(){return this._status===d.error},P.prototype.lockUnload=function(e,t,n){e=e||1,this.unloadLockCounter+=e},P.prototype.unlockUnload=function(e,t,n,i){e=e||1,this.unloadLockCounter-=e},P.prototype.isUnloadLocked=function(){return this.isForced()||this.unloadLockCounter>0},P.prototype.hasGrandChildren=function(){var e=0;for(e=0;e<this.children.length;e++)if(this.children[e].reference.children.length>0)return!0;return!1},P.prototype.getChild=function(e){var t;for(t=0;t<this.children.length;t++)if(this.children[t].instanceId===e)return this.children[t];return null},P.prototype.isSlave=function(){return this.sgFlag===L},P.prototype.isUnloadable=function(e){if(e){var t=this._rep.node;if(t&&(A(h,t)||A(c,t)||A(u,t)))return!1}return this._status!==d.freezeUnload},P.prototype.isLoading=function(){return this._status===d.loading},P.prototype.clearViewpointTags=function(){var e;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].viewpointTag=-1},P.prototype.getLDHNodeManagerQueue=function(e){return e.queues[this.handler.type]},P.prototype.updateBoundingSphereFromNode=function(){if(this._rep.node){var e=this._rep.node.getBoundingSphere();e&&(this._boundingSphere=e.clone())}},P.prototype.hasDifferentViewpointTag=function(e){if(this._occurrences.length>0){var t;for(t=0;t<this._occurrences.length;t++)if(this._occurrences[t].viewpointTag!==e)return!0;return!1}return!0},P.prototype.buildDebugJSON=function(e,t){var n,i=this;var r,o={screenRadius:i._screenRadius,status:function(e){return t&&e._status===d.loaded?"complete":e._status}(i),unloadStatus:i._unloadStatus,handlerType:this.handler.type,parents:[],nbOccurrences:i._occurrences.length};for(e||(o.referenceId=i.referenceId),r=0;r<this.parents.length;r++)o.parents.push(this.parents[r].referenceId);if(i.children.length>0&&(o.nbChildren=i.children.length,i.children.length>0)){var s,a=[];for(n=0;n<i.children.length;n++)s=i.children[n],a.push({ref:s.reference.referenceId,inst:s.instanceId});o.children=a}return i.unloadLockCounter>0&&(o.unloadLockCounter=i.unloadLockCounter),i._rep.node&&(o.inSceneGraph=!0),o},P.prototype.setLoadModelOptions=function(e){this._optional||(this._optional=new V),this._optional.setLoadModelOptions(e)},P.prototype.getLoadModelOptions=function(){return this._optional?this._optional.loadModelOptions:null},P.prototype.userLockUnload=function(){this._optional||(this._optional=new V),this.lockUnload(),this._optional.addUserLockUnload()},P.prototype.userUnlockUnload=function(){this._optional&&this._optional.userLockUnload>0&&(this.unlockUnload(),this._optional.removeUserLockUnload())},P.prototype.needScreenRadiusSizeComputation=function(){return!(this._status!==d.waiting&&this._status!==d.loaded&&this._status!==d.toUnload&&this._status!==d.toUnloadLight&&this._status!==d.toLoad&&(this._status!==d.error||!this._rep||this._rep.active))},P.prototype.updateBoundingSphere=function(){!this._boundingSphere&&this._boundingBox&&(this._boundingSphere=this._boundingBox.getBoundingSphere())},P.prototype.getBoundingBox=function(){if(!this._boundingBox){var e=this._boundingSphere;if(!e)return null;var t=new o.Box3;t.min.x=e.center.x-e.radius,t.min.y=e.center.y-e.radius,t.min.z=e.center.z-e.radius,t.max.x=e.center.x+e.radius,t.max.y=e.center.y+e.radius,t.max.z=e.center.z+e.radius,this._boundingBox=t}return this._boundingBox},P.prototype.hasBoundingElement=function(){return this._boundingBox&&this._boundingSphere},P.prototype.setBoundingElements=function(e,t,n,i){e&&(this._boundingSphere=e.clone(),n&&this._boundingSphere.applyMatrix4(n)),t&&(this._boundingBox=t.clone(),n&&this._boundingBox.applyMatrix4(n))};var E=new o.Sphere;P.prototype.getBoundingSphere=function(e){return this._boundingSphere?this._boundingSphere:this._boundingBox?(this._boundingBox.getBoundingSphere(E),E):e?new o.Sphere:null},P.prototype.getScore=function(){return this._screenRadius};var F="OOC##Box",k=new o.MeshBasicMaterial({color:"red"});P.prototype.displayBox=function(e){var t=e,n=t.newLoadingBoxes;if(n&&!this.isLoadingBoxVisible()&&this._rep&&this._rep.node||!n&&P.slaveBoxFix){var i,r,o,s,a=!1;if(t.queueRenderer){for(i=0;!a&&i<this._rep.node.children.length;i++)this._rep.node.children[i].name===F&&(a=!0);a||(r=this.getBoundingBox(),s=n?t.queueRenderer.getMaterialApplication():t.queueRenderer.getRepMaterialApplication(),r&&((o=f.createCuboidNodeFromBox3(r,k)).setRenderPasses(["main"]),o.setModelIdentification(this.referenceId),o.setPickable(t.queueRenderer.pickable),o.setPickParent(!0),o.name=F,o.setMaterialApplication(s),this._rep.node.addChild(o)))}this.setLoadingBoxVisible(!0)}},P.prototype.removeBox=function(e){var t=e.newLoadingBoxes;if(t&&this.isLoadingBoxVisible()&&this._rep&&this._rep.node||!t&&P.slaveBoxFix){var n,i,r=!1;for(n=0;!r&&n<this._rep.node.children.length;n++)(i=this._rep.node.children[n]).name===F&&(this._rep.node.removeChild(i),r=!0)}this.setLoadingBoxVisible(!1)},P.lodSelector=R;var V=function(){this._force=null,this.onAddedToSceneGraphCB=null,this.onRemovedFromSceneGraphCB=null,this.onLoadedCallbacks=null,this.loadModelOptions=null,this.userLockUnload=0,this.overrideData=null};V.prototype.setOverride=function(e,t){this.overrideData||(this.overrideData=new G),this.overrideData.setOverride(e,t),this.overrideData.isEmpty()&&(this.overrideData=null)},V.prototype.hasOverride=function(e){return void 0===e?null!==this.overrideData:this.overrideData&&this.overrideData.hasOverride(e)},V.prototype.addUserLockUnload=function(){this.userLockUnload++},V.prototype.removeUserLockUnload=function(){this.userLockUnload--},V.prototype.addOnLoadedCB=function(e){this.onLoadedCallbacks||(this.onLoadedCallbacks=[]),this.onLoadedCallbacks.push(e)},V.prototype.onLoaded=function(){if(this.onLoadedCallbacks){var e;for(e=0;e<this.onLoadedCallbacks.length;e++)this.onLoadedCallbacks[e]();this.onLoadedCallbacks=null}},V.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e};var H=function(){this.callbacks=[]};H.prototype.onForce=function(e){e&&this.callbacks.push(e)},H.prototype.onLoaded=function(){var e;for(e=0;e<this.callbacks.length;e++)this.callbacks[e]();this.callbacks.length=0},H.prototype.clear=function(){this.callbacks.length=0};var z=function(){this.override=null,this.overrideCB=null},G=function(){this.count=0,this.overrideMap={}};G.prototype.setOverride=function(e,t){var n=this.overrideMap[e];n?n.overrideCB=t:t&&((n=new z).overrideCB=t,this.overrideMap[e]=n,this.count++)},G.prototype.hasOverride=function(e){var t=this.overrideMap[e];return!(!t||!t.overrideCB)},G.prototype.isEmpty=function(){return 0===this.count},G.prototype.updateOverride=function(e,t,n){var i,r,o,s,a,d,l=null;for(i in this.overrideMap)r=e.getOverrideSet(i),o=(a=this.overrideMap[i]).override,s=a.overrideCB,t&&s?(o?o._forceOverrideUpdate():(o=r._createNodeOverride(t),a.override=o),s(n,o)):o&&(r.deleteOverride(o),a.override=null,s||(l=l||[]).push(i));for(d=0;l&&d<l.length;d++)delete this.overrideMap[l[d]],this.count--},P.prototype.updateOccurrencesPosition=function(e,t){var n;for(this.clearScreenRadiusCache(),n=0;n<this._occurrences.length;n++)this._occurrences[n].updateMatrix(e);var i,r,o=new Set;for(n=0;n<this.children.length;n++)r=this.children[n],null!==t&&r.instanceId!==t||(i=r.reference,o.has(i)||(o.add(i),i.updateOccurrencesPosition(e,null)))},P.prototype.updateLDHOccurrences=function(e){let t,n;for(t=0;t<this._occurrences.length;t++)n=this._occurrences[t],e?n.updateLDHOccurrence():n.traverseWithCondition((e=>{if(e._getNeedsUpdate())return e.updateLDHOccurrence(),!1;{let t=e._getDescendantNeedsUpdate();return e._setDescendantNeedsUpdate(!1),t}}))},P.prototype.clearScreenRadiusCache=function(){this._screenRadiusCache=[]},P.createChildData=function(e,t,n){return new w(e,t,n)},P.prototype.removeRep=function(e){if(this._rep===e)this._rep=e.nextRep;else for(var t=this._rep;t;)if(t.nextRep===e){t.nextRep=e.nextRep;break}},P.prototype.switchMeshInRAM=function(e,t){if(this.isLeaf()){var n=this.getActiveRepresentation();if(n.hasMeshInRAM()!==e)if(this.isLoading()){var i=t.switchRepresentationBuffer.get(this.referenceId);i||(i=new v(n.clone()),t.switchRepresentationBuffer.set(this.referenceId,i))}else{if(n!==this.getPrimaryRepresentation())n.setMeshInRAM(e);else{var r=n.clone();this.switchRepresentation(r,e,t)}}}},P.prototype.switchRepresentation=function(e,t,n,i,r){if(!this.isLoading())if(null===this._rep)e.active=!0,e.copyMissingParams(null),e.setMeshInRAM(t),this._rep=e;else if(this.isLeaf()){var o=this._rep,s=null,a=null,l=!1;e.isPartiallyDefined()&&(a=this.getActiveRepresentation(),e.copyMissingParams(a),a=null),e.setMeshInRAM(t);for(var h,c=this.getPrimaryRepresentation();o;)!r&&o.equals(e)&&(s=o),o.active&&(a=o),o=o.nextRep;if(s!==a?!r&&a.isClearMeshInRAMOnly(e)?(a.clearMeshInRAM(e),this.updateMemorySizeNEW(n),a===c&&(l=!0)):(this.clearScreenRadiusCache(),s||(e.nextRep=this._rep.nextRep,this._rep.nextRep=e,s=e),a.active=!1,s.active=!0,a!==e&&(this.isError()&&this.setStatus(d.waiting,n),n.forceUpdateNode(this))):a===c&&(l=!0),l)n.onSwitchRepCB&&m.call(n.onSwitchRepCB.bind(null,this.referenceId)),i&&m.multiCall(i);else if(i)for(h=0;h<i.length;h++)this.addOnLoadedCB(i[h])}},P.prototype.refreshRepresentation=function(e){let t=this.getActiveRepresentation().clone();this.switchRepresentation(t,t.hasMeshInRAM(),e,null,!0)},P.prototype.setSSBDataFromCullingData=function(e){e?(this.ssbData||(this.ssbData=new M),this.ssbData.setFromCullingData(e)):this.ssbData=null},P.prototype.setSSBRadius=function(e){this.ssbData||(this.ssbData=new M),this.ssbData.setRadius(e)},P.prototype.refreshRepresentationIfSSBChange=function(e,t){return!(!this.ssbData||!this.ssbData.needsRefresh(this._ssbLimitRadius,t))&&(this.refreshRepresentation(e),!0)},P.prototype.getActiveRepresentation=function(){for(var e=this._rep;e;){if(e.active)return e;e=e.nextRep}return e},P.prototype.getPrimaryRepresentation=function(){return this._rep},P.prototype.showActiveRepresentation=function(e){if(this.isAlive()){var t=this.getActiveRepresentation(),n=this.getPrimaryRepresentation();if(t!==n){var i,r=null,o=n.node,s=t.node,a=this.isSlave();if(a?e.unloadLeafReferenceCB&&e.unloadLeafReferenceCB.call(null,this.referenceId):this.removeRepresentationChildren(o),s&&(r=s.children.concat([]),s.removeChildren()),n.noMeshInRAM!==t.noMeshInRAM&&(n.noMeshInRAM||e.unloadManager.setHasMeshInRam(!0)),this.removeRep(t),t.nextRep=null,t.node=o,n.node=s,t.updateMeshSize(this),this._rep=t,o&&r)for(i=0;i<r.length;i++)o.addChild(r[i]);this.updateMemorySizeNEW(e),a&&e.onLeafReferenceLoadedCB&&e.onLeafReferenceLoadedCB.call(null,this.referenceId)}var d=e.onSwitchRepCB;d&&m.call(d.bind(null,this.referenceId))}},P.prototype.hasRootBoundingElement=function(){return!(!this._boundingBox&&this._boundingSphere&&0===this._boundingSphere.radius)},P.prototype.getNode=function(){return this._rep.node},P.weakCGRNodeMap=new WeakMap;var X=-1;function q(e){return function(){return(this.flags&e)>0}}function W(e){return function(t){this.flags=t?this.flags|e:this.flags&~e}}return P.prototype.setCGRNodeNames=function(e,t){-1===P.useRepNodeName&&(P.useRepNodeName=window.OOCEnableRepNodeName?1:0);var n,i,r=!1;if(e)for(n=0;n<e.length&&!r;n++)i=e[n],1===P.useRepNodeName?i.name=P.RepNodeName:P.RepNodeSet.add(i.id),-1===X&&(X=!1!==window.OOCEnablePRPrimPicking),!X&&t.isPR()&&i.traverse((function(e){"Mesh3D"===e.getNodeType()&&e._setDisablePrimPicking(!0)})),t.node&&S.idPathWatcher&&i.internalSceneGraph&&(P.weakCGRNodeMap.set(i,"##REP##"+this.referenceId),S.idPathWatcher.onAddChild(t.node,i),r=!0)},P.prototype.getCGRNode=function(){var e,t,n=this.getActiveRepresentation().node;if(n)for(t=0;t<n.children.length;t++)if((e=n.children[t]).internalSceneGraph)return e;return null},P.prototype.updateOccurrences_traverse=function(e){this.traverse((t=>{if(t.getNeedUpdateOccurrences())t.updateOccurrencesHierarchy(e);else if(!t.getNeedUpdateOccurrencesUnder())return!0;t.setNeedUpdateOccurrencesUnder(!1)}))},P.prototype.updateOccurrencesHierarchy=function(e){if(this.getNeedFullUpdateOccurrences())this.updateOccurrencesPosition(e,null);else{let t=this.instancesToUpdate;if(t){let n,i=new Set;for(n=0;n<t.length;n++){let r=t[n];i.has(r)||(i.add(r),this.updateOccurrencesPosition(e,r))}}}this.traverse((e=>{e.instancesToUpdate=null,e.setNeedFullUpdateOccurrences(!1),e.setNeedUpdateOccurrences(!1),e.setNeedUpdateOccurrencesUnder(!1)}))},P.prototype.getSSBLimitRadius=function(){return this._ssbLimitRadius},P.prototype.isFullyClipped=function(e){let t=this.getActiveRepresentation(),n=t&&t.node,i=!1;if(n){let t,r=n._occurrences;for(i=!0,t=0;t<r.length&&i;t++){let n=r[t],o=n.occurrenceRenderingOverride&&n.occurrenceRenderingOverride.clippingContext;if(o){let t=n._getBoundingSphere();e.copy(t),e.applyMatrix4(n.matrix),2!==o._getBoundingSphereClippingStatus(e.radius,e.center)&&(i=!1)}else i=!1}}return i},P.prototype.setSceneGraphOverrideSet=function(e,t){let n=!1;if(e===this.referenceId){if(!this.sceneGraphOverrideSet){if(this.sceneGraphOverrideSet=t,this._rep.node){let e=this._rep.node,t=this.sceneGraphOverrideSet;t.node=e,e._setOverrideSetManager(t)}this.sceneGraphOverrideSet._activate(),n=!0}}else{let i=this.getChild(e);if(i&&!i.sceneGraphOverrideSet){if(i.sceneGraphOverrideSet=t,i.node&&i.sceneGraphOverrideSet){let e=i.node,t=i.sceneGraphOverrideSet;t.node=e,e._setOverrideSetManager(t),n=!0}i.sceneGraphOverrideSet._activate()}}n&&this.setCandidateOverrideSetManagerUnderTraverse()},P.prototype.setCandidateOverrideSetManagerUnderTraverse=function(){if(!this.getCandidateOverrideSetManagerUnder()){let e;for(this._setCandidateOverrideSetManagerUnder(!0),e=0;e<this.parents.length;e++)this.parents[e].setCandidateOverrideSetManagerUnderTraverse()}},P.prototype.setHierarchyChangeTraverse=function(){!function e(t,n){if(n?t._setHierarchyChange(!0):t.setHierarchyChangeUnder(!0),!t.getHierarchyChangeUnder()){let n;for(n=0;n<t.parents.length;n++)e(t.parents[n],!1)}}(this,!0)},P.prototype.tryCandidateOverridesUpdate=function(e,t){var n,i=this._occurrences;let r=new Set;for(this.traverseUnique((t=>{if(t.getHierarchyChange())t.traverseUnique((t=>(t.sceneGraphOverrideSet&&(r.add(t.sceneGraphOverrideSet),e=!0),!t.getCandidateOverrideSetManagerUnder())));else if(t.getCandidateOverrideSetManagerUnder()&&t.getHierarchyChangeUnder())return!1;return!0})),this.traverse((e=>{let t=!0;return e.getHierarchyChangeUnder()&&(t=!1),e._setHierarchyChange(!1),e.setHierarchyChangeUnder(!1),t})),r.forEach((e=>{e._refresh(!0)})),n=0;n<i.length;n++)i[n].traverseWithCondition((function(t){return t._getNeedOverridesUpdate()?(t.updateOverrideStatus(e),t.requestUpdate(),null):!!t._getDescendantNeedsOverridesUpdate()||null})),i[n].clearOverridesUpdateRequest()},P.prototype.requestOccurrenceNodeUpdate=function(e){let t;for(t=0;t<this._occurrences.length;t++){let n=this._occurrences[t];e&&n.parent&&n.parent.reference!==e||n.requestOccurrenceNodeUpdate()}},P.slaveBoxFix=!1,Object.defineProperty(P.prototype,"manager",{get:function(){throw new Error("forbidden")},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(P.prototype,"node",{get:function(){return this._rep&&this._rep.node},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(P.prototype,"url",{get:function(){return this._rep&&this._rep.url},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(P.prototype,"memorySize",{get:function(){return this.memoryData.memory},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(P.prototype,"memorySizeGPU",{get:function(){return this.memoryData.memoryGPU},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(P.prototype,"dbgFlags",{get:function(){let e,t="";for(e in T)this.flags&T[e]&&(t?t+=" "+e:t=e);return t},set:function(e){throw new Error("forbidden")}}),P.prototype.getCandidateOverrideSetManagerUnder=q(T.overrideSetUnder),P.prototype._setCandidateOverrideSetManagerUnder=W(T.overrideSetUnder),P.prototype.getHierarchyChangeUnder=q(T.hierarchyChangeUnder),P.prototype.setHierarchyChangeUnder=W(T.hierarchyChangeUnder),P.prototype.getHierarchyChange=q(T.hierarchyChange),P.prototype._setHierarchyChange=W(T.hierarchyChange),P.useRepNodeName=-1,P.RepNodeSet=new Set,P.RepNodeName="OOC##RepNode",P})),define("DS/3DXMTiles/DSTilesGaussianCloudContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesSourceIdWithParams","DS/Visualization/GaussianSplattingUtils"],(function(e,t,n){"use strict";class i extends e{constructor(e={}){e.tilesManager||(e.tilesManager=null),super(e),this.GSUtils=new n(e)}getBudgetParams(){return{name:"gaussianCloud",physicalBudget:"gpu",params:{maxLimit:251658240}}}loadContentFromBuffer({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:o,params_unused:s,updateContent:a}){var d=n.getContentToken(a);d||(d=new r(t,n),n.setContentToken(d,a));var l=this.GSUtils._createTileContentFromResponse(e);l?(d.splatContainer=this.GSUtils.splatContainer,this.GSUtils._setupNode3D(d,l),d.computeMemorySize(),this.budget.updateUsage(0,d.memorySize),i()):o()}showContent(e,t){let n=t.contentToken;if(n){var i=n.node3D;if(i){i.setMaterial(this.GSUtils.splatContainer.material);var r=e.getSgNode();0===i.parents.length&&r.addChild(i),this.GSUtils.viewer=r._getViewer(),n.node3D.setVisibilityFree(!1),n.node3D.setVisibility(!0)}}}hideContent(e,t){let n=t.contentToken;n&&n.node3D&&(n.node3D.setVisibilityFree(!0),n.node3D.setVisibility(!1))}deleteContent(e,t,n){n&&(n.release(),n.node3D=null,this.budget.updateUsage(n.memorySize,0),console.error("TODO: GaussianCloudContentLoader: Deleted content doesn't load content back"))}_setupNode3D(e,t){e.node.isAlive()?e.node3D=this.GSUtils._createNode3D(t):e.content.setContentToken(null)}getSourceIdWithParamsArray(e,n){return[new t("default",{uriPostFix:"&m=DEF_POSITION&m=rot_0&m=rot_1&m=rot_2&m=rot_3&m=scale_0&m=scale_1&m=scale_2&m=f_dc_0&m=f_dc_1&m=f_dc_2&m=opacity"})]}}i.CGR_TYPE_UNKNOWN=0,i.CGR_TYPE_PLY=1;class r{constructor(e,t){this.node=e,this.content=t,this.memorySize=0,this.splatContainer=null,this.node3D=null,this.useCount=[1]}computeMemorySize(){var e=this.splatContainer.splatBuffers[0];this.memorySize=48*e.splatCount}addRef(){this.useCount[0]++}release(){(this.useCount[0]--,this.useCount[0]<=0)&&this.node.getSgNode().removeChild(this.node3D)}}return i})),define("DS/3DXMTiles/DSTilesContentSource",["DS/WAFData/WAFData","DS/Usage/TrackerAPI","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/ModelBank"],(function(e,t,n,i){"use strict";var r=null,o=function(e,t,n,i){this.sourceId=e,this.tileSet=n,this.baseContentURL=t.baseContentURL||null,this.urlPostfix=t.urlPostFix||t.urlPostfix||null,this.contentURLPostfix=t.contentURLPostfix||null,this.contentBatchingURL=t.contentBatchingURL||null,this.currentContentBatch=null,this.currentBankBatch=null,this.maxBankBatchSize=20,this.loadedFromNetwork=0,this.loadedFromBank=0,this.encodeSingleURL=!!window.OOCEncodeSingleURL,r=i};o.prototype.buildContentURL=function(e){var t=e;return this.baseContentURL&&(t=this.baseContentURL+t),this.contentURLPostfix&&(t+=this.contentURLPostfix),this.urlPostfix&&(t+=this.urlPostfix),t},o.prototype.loadTileContent=function(e,t,r,o,s,a){if(e.setContentStatus(n.loading,e.queue),t.contentLoader.needsDownload())if(t.contentLoader.hasExistingData(e,t,this.sourceId))t.contentLoader.loadContentFromExistingData(e,t,this.sourceId,o.bind(null,e),s.bind(null,e));else{t.contentLoader.onStartLoading(e,t,this.sourceId);var d=t.getUri(this.sourceId,r);this.encodeSingleURL&&(d=encodeURIComponent(d));var l=this.buildContentURL(d);this.tileSet.useBankForContent()&&t.etag&&i.hasTileData(l,t.etag)?this.addToBankBatch(e,t,r,o,s,a):this.contentBatchingURL&&this.tileSet.info.maxContentBatchSize>1?this.loadTileContent_multi(e,t,r,o,s,a):this.loadTileContent_single(e,t,l,r,o,s,a)}else setTimeout((()=>{t.contentLoader.loadContentFromBuffer({data:null,node:e,content:t,onLoadedCB:o.bind(null,e),onErrorCB:s.bind(null,e),sourceId:this.sourceId,params:r,updateContent:!!a})}),0)},o.prototype.loadTileContent_single=function(t,n,i,o,s,a,d){this.tileSet.contentTickets--;var l=this;let c=new h(1,1/0);c.addContent(t,n,o,d,s,a),function n(){let o=null;r.ODTWAFData&&r.ODTWAFData.content_single&&(o=e,e=r.ODTWAFData.content_single),e.authenticatedRequest(i,{method:"GET",timeout:36e5,type:"arraybuffer",onComplete:(e,t,i)=>{var r=i?i.status:200;i&&202===i.status?setTimeout(n,3e4):204===r?l.loadContentFromBuffer({data:null,batch:c,index:0,fromBank:!1}):l.loadContentFromBuffer({data:e,batch:c,index:0,fromBank:!1})},onFailure:e=>{l.tileSet.contentTickets++,a(t)}}),o&&(e=o)}()},o.prototype.loadContentFromBuffer=function({data:e,batch:t,index:n,fromBank:r}){let o=t.getContent(n),s=t.getNode(n),a=t.getOnLoadedCB(n),d=t.getOnErrorCB(n),l=t.getParams(n),h=t.getUpdateContentData(n);if(!h||h.isStillValid()){if(r?this.loadedFromBank++:this.loadedFromNetwork++,this.tileSet.useBankForContent()&&o.etag&&!r){let t=o.getUri(this.sourceId,l),n=this.buildContentURL(t);i.storeTileData([n],[e],[o.etag])}t.onContentLoaded(),t.isFullyLoaded()&&this.tileSet.contentTickets++,o.contentLoader.loadContentFromBuffer({data:e,node:s,content:o,onLoadedCB:()=>{a(s)},onErrorCB:()=>{d(s)},sourceId:this.sourceId,params:l,updateContent:!!h})}else a(s)},o.prototype.addToBankBatch=function(e,t,n,i,r,o){this.currentBankBatch||(this.currentBankBatch=this.createBankBatch()),this.currentBankBatch.addContent(e,t,n,o,i,r)&&(this.loadBankBatch(this.currentBankBatch),this.currentBankBatch=null)},o.prototype.loadBankBatch=function(e){let t=[];var n,r=e.getContentUris(this.sourceId);for(n=0;n<r.length;n++)t.push(this.buildContentURL(r[n]));this.tileSet.contentTickets--,i.retrieveTileData(t,((t,n)=>{this.loadContentFromBuffer({data:n,batch:e,index:t,fromBank:!0})}),(()=>{e.onFullError()}))},o.prototype.createBankBatch=function(){return new h(this.maxBankBatchSize,1/0)};var s=window.OOCTilesTargetContentBatchFileSize||2097152;o.prototype.createContentBatch=function(){return new h(this.tileSet.getMaxContentBatchSize(),s)},o.prototype.loadTileContent_multi=function(e,t,n,i,r,o){this.currentContentBatch||(this.currentContentBatch=this.createContentBatch()),this.currentContentBatch.addContent(e,t,n,o,i,r)&&(this.downloadMultiPart(this.currentContentBatch),this.currentContentBatch=this.createContentBatch())},o.prototype.flushLoadTileContent=function(){this.currentContentBatch&&!this.currentContentBatch.isEmpty()&&(this.downloadMultiPart(this.currentContentBatch),this.currentContentBatch=this.createContentBatch()),this.currentBankBatch&&!this.currentBankBatch.isEmpty()&&(this.loadBankBatch(this.currentBankBatch),this.currentBankBatch=null)};let a=-1;function d(e,t,n){var i,r;for(i=t;i<e.length;i++){if(13===(r=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===r)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}o.prototype.downloadMultiPart=function(n){-1===a&&(a=window.OOCHackR2VFilterQuery?1:0),this.tileSet.contentTickets--;var i=n.getContentUris(this.sourceId);let o=a?function(e){let t,n=0,i="&query=";for(t=0;t<e.length;t++)e[t].indexOf(i)>=0&&n++;if(n>0){if(n!==e.length)throw new Error("Mix encountered");let r=[],o=null,s=7;for(t=0;t<e.length;t++){let n=e[t],a=n.indexOf(i);r.push(n.substring(0,a)),null===o&&(o=decodeURIComponent(n.substring(a+s)))}return{urls:r,query:o}}return e}(i):i;var s=this.contentBatchingURL,d=null;r.ODTWAFData&&r.ODTWAFData.content_multi&&(d=e,e=r.ODTWAFData.content_multi),e.authenticatedRequest(s,{cors:!0,timeout:36e5,method:"POST",data:JSON.stringify(o),async:!0,type:"arraybuffer",headers:{"Content-Type":"application/json"},onComplete:(e,i,r)=>{t.trackPageEvent({eventCategory:"WebVisualization",eventAction:"3DXMTiles",eventLabel:r&&c(r.url),appID:g,persDim:{pd1:p,pd2:g},persVal:{pv1:r&&r.timeoutTimer,pv2:e.byteLength}});var o={contentData:0,nextIndex:0},s=0,a=new Int8Array(e);do{(o=this.extractNextData(a,o.nextIndex)).contentData&&this.loadContentFromBuffer({data:o.contentData,batch:n,index:s,fromBank:!1}),s++}while(o.contentData)},onFailure:()=>{this.tileSet.contentTickets++,n.onFullError()}}),d&&(e=d)},o.prototype.extractNextData=function(e,t){var n,i,r,o=new TextDecoder,s=t,a=-1;do{s=(n=d(e,s,o)).index,(r=n.str).toLowerCase().startsWith("content-length:")&&(i=r.split(" "),a=parseInt(i[1]))}while((r.length>0||a<0)&&s<e.length);var l=null;return s=n.index,a>0&&(l=e.buffer.slice(s,s+a)),{contentData:l,nextIndex:s+a}};class l{constructor(e,t,n,i,r,o){this.node=e,this.content=t,this.params=n,this.updateContentData=i,this.onLoadedCB=r,this.onErrorCB=o}}class h{constructor(e,t){this.maxSize=e,this.targetFileSize=t,this.contents=[],this.toLoadCount=0,this.fileSize=0}addContent(e,t,n,i,r,o){return this.contents.push(new l(e,t,n,i,r,o)),this.fileSize+=t.fileSize,this.toLoadCount++,this.contents.length>=this.maxSize||this.fileSize>=this.targetFileSize}getSize(){return this.contents.length}onContentLoaded(){this.toLoadCount--}isFullyLoaded(){return this.toLoadCount<=0}getNode(e){return this.contents[e].node}getContent(e){return this.contents[e].content}getParams(e){return this.contents[e].params}getOnLoadedCB(e){return this.contents[e].onLoadedCB}getOnErrorCB(e){return this.contents[e].onErrorCB}getUpdateContentData(e){return this.contents[e].updateContentData}isEmpty(){return 0===this.contents.length}getContentUris(e){var t,n=[];for(t=0;t<this.contents.length;t++)n.push(this.contents[t].content.getUri(e,this.contents[t].params));return n}onFullError(){let e;for(e=0;e<this.contents.length;e++){let t=this.contents[e].node;(0,this.contents[e].onErrorCB)(t)}}}function c(e){var t=e.split("/");if(t.length>5){var n=t[t.length-1],i=t[t.length-1].indexOf("?");return-1!==i&&(n=n.substring(0,i),t[t.length-1]=n),t.slice(4,t.length).join("/")}return 0===t[t.length-1].length?t[t.length-2]:t[t.length-1]}var u="undefined"!=typeof widget&&null!==widget?widget:void 0,p=u?u.id:"no_widget",g=u?u.getValue("x3dAppId")?u.getValue("x3dAppId"):u.getValue("appId"):"no_widget_appid";return o})),define("DS/3DXMTiles/DSTilesStylingFilterNotOperator",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilterOperator","DS/3DXMTiles/DSTilesStylingFilterOperatorParser"],(function(e,t,n){"use strict";class i extends t{constructor(){super(),this.filterOperator=null}setFromJSON(e){let t=e.not,i=n.parse(t),r=i.status;return r.isOk()&&(this.filterOperator=i.operator),r}addNeededAttributesToSet(e){this.filterOperator.addNeededAttributesToSet(e)}buildShaderCode(){return""}filter(e){return!this.filterOperator.filter(e)}}return i.majorProperty="not",i})),define("DS/3DXMTiles/LDHModel3DHandler2",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/WAFData/WAFData","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHReferenceRep","DS/3DXMTiles/LDHStats"],(function(e,t,n,i,r,o,s,a){"use strict";var d=function(e,t){this.references=e,this.nbRedirected=0,this.context=t,this.okReferences=[],this.koReferences=[]};d.prototype.addOkReference=function(e){var t=e.getReference();this.okReferences.push(t)},d.prototype.addKoReference=function(e){var t=e.getReference();this.koReferences.push(t)},d.prototype.isComplete=function(){return this.okReferences.length+this.koReferences.length>=this.references.length};var l=function(e,t,n){this.batch=e,this.index=t,this.newURL=n,this.newType=null};l.prototype.getUrl=function(){return this.batch.references[this.index].getActiveRepresentation().url},l.prototype.getReference=function(){return this.batch.references[this.index]};var h=function(t){e.call(this,e.Model3DHandler),this.fileType=null,this.redirectUrlCB=null,this.loadModelOptions=null,this.batches=[],this.toLoad=[],this.debug=!!t.debug,this.urlPostProcessCB=t.urlPostProcessCB||null,this.manager=null,this.minBatchSize=t.minBatchSize||40,this.maxTickets=t.batchSize||100,this.maxRedirectTickets=t.redirectBatchSize||40,this.tickets=this.maxTickets,this.redirectTickets=this.maxRedirectTickets,this.nbLoadReferenceTickets=20,this.pauseInterval=null,this.getSecurityParamsCB=t.getSecurityParamsCB||null,this.autoRedirect=!1,this.urlServices=new r,this.debugLoadModelDelay=0,this.debugLockedReferences=null,this.debugModelLoaded=null};(h.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},h.prototype.setRestricted=function(){this.minBatchSize=2,this.maxTickets=2,this.maxRedirectTickets=2,this.tickets=this.maxTickets,this.redirectTickets=this.maxRedirectTickets},h.prototype.isReady=function(){return this.tickets>=this.minBatchSize},h.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},h.prototype.redirectNeeded=function(){return!this.autoRedirect&&window.WUXForceAutoRedirect&&this.setAutoRedirect(!0),!(!this.redirectUrlCB&&!this.autoRedirect)},h.prototype.handleReferences=function(e,t){if(this.debugLoadModelDelay){var n=this;setTimeout((function(){n.handleReferences_internal(e,t)}),this.debugLoadModelDelay)}else this.handleReferences_internal(e,t)},h.prototype.handleReferences_internal=function(e,t){if(this.debugLockedReferences){var n=[];for(r=0;r<e.length;r++)this.debugLockedReferences.indexOf(e[r].referenceId)>=0&&(n.push(e[r]),e[r]=null);var i=0;for(r=0;r<e.length;r++)null!==e[r]&&(e[i]=e[r],i++);e.length=i,n.length&&setTimeout(this.handleReferences.bind(this,n,t),100)}this.manager=t.manager._ldhNodeManager;var r,o,s,h=new d(e,t);if(this.batches.push(h),a.onStartBatch(e.length),this.incTickets(-e.length),!this.redirectNeeded()||this.urlPostProcessCB){for(r=0;r<h.references.length;r++){s=(o=h.references[r]).getActiveRepresentation();let e=this.urlPostProcessCB?this.urlPostProcessCB(o,s.url):s.url;this.toLoad.push(new l(h,r,e))}this.loadModels()}else this.redirectUrls()},h.prototype.redirectUrls=function(){if(this.redirectTickets>0){var e,t,n,i,r=[],o=[];for(e=0;e<this.batches.length;e++)for(i=(t=this.batches[e]).nbRedirected;this.redirectTickets>0&&i<t.references.length;i++)t.nbRedirected++,(n=new l(t,i,null)).getUrl()?(r.push(n),o.push(n.getUrl()),this.incRedirectTickets(-1)):this.toLoad.push(n);if(r.length>0){var s=this;this.incRedirectTickets(-this.redirectTickets),this.doRedirectUrls(o,(function(e,t,n){var i;for(s.incRedirectTickets(-s.redirectTickets+s.maxRedirectTickets),i=0;i<e.length;i++){if(r[i].newURL=e[i],t&&(r[i].newType=t[i]),n&&n[i])r[i].batch.references[r[i].index].getActiveRepresentation().updateUrl(n[i]);s.toLoad.push(r[i])}s.redirectUrls(),s.loadModels()}))}}},h.prototype.doRedirectUrls=function(e,t){this.redirectUrlCB&&!this.autoRedirect?this.redirectUrlCB(e,t):this.autoRedirectUrl(e,t)},h.prototype.loadModels=function(){if(!this.manager.getPauseLoading())return this.loadModels_internal();if(!this.pauseInterval){var e=this;this.pauseInterval=setInterval((function(){e.manager.getPauseLoading()||(clearInterval(e.pauseInterval),e.pauseInterval=null,e.loadModels_internal())}),100)}},h.prototype.loadModels_internal=function(){var e;for(this.debug&&t.setDebug(!0);this.nbLoadReferenceTickets>0&&this.toLoad.length>0;)(e=this.toLoad.shift()).newURL?(this.nbLoadReferenceTickets--,t._loadModel(e.newURL,e.getReference(),this.onModelLoaded.bind(this,e),this.onModelError.bind(this,e),null,this.fileType,this.loadModelOptions,this.manager)):setTimeout(this.onModelError.bind(this,e),1)},h.prototype.onModelLoaded=function(e,t){this.incTickets(1),this.nbLoadReferenceTickets++;var n,i=e.batch,r=i.context;n=e.getReference(),this.debugModelLoaded&&this.debugModelLoaded(n);var o=n.getActiveRepresentation();e.newType&&"av1"===e.newType.toLowerCase()&&(o.type=s.RepType.av1),this.commitModelLoadedTransaction(n,r.manager,t),r.doneCB([n],[]),i.isComplete()&&this.onBatchComplete(i),this.loadModels()},h.prototype.onModelError=function(e){this.incTickets(1),this.nbLoadReferenceTickets++;var t,n=e.batch,i=n.context;t=e.getReference(),i.manager._startModelLoaderTransaction(),i.manager._onRepLoaded(t),i.manager.endInstRefGraphTransaction(),i.doneCB([],[t]),n.isComplete()&&this.onBatchComplete(n),this.loadModels()},h.prototype.onBatchComplete=function(e){a.onEndBatch(e.references.length);var t=this.batches.indexOf(e);this.batches.splice(t,1);e.context,e.okReferences;e.references=[],e.okReferences=[],e.koReferences=[]},h.prototype.getModelLoader=function(){return t.modelLoader},h.prototype.getBatchSize=function(){return this.tickets},h.prototype.setRedirectUrlCB=function(e){this.redirectUrlCB=e},h.prototype.setAutoRedirect=function(e){this.autoRedirect=!!e},h.prototype.incTickets=function(e){this.tickets+=e},h.prototype.incRedirectTickets=function(e){this.redirectTickets+=e},h.prototype.autoRedirectUrl=function(e,t){this._fcsFileurls({urls:e,callbacks:{onComplete:function(e,n){if(e){var i,r,o=[],s=[],a=[];for(i=0;i<e.length;i++)r=n[i],void 0!==e[i].checksum?(o[r]=e[i].url,s[r]=e[i].type,a[r]=e[i].updatedAccessUrl):0===e[i].status?(o[r]=e[i].fileurl,s[r]=null):o[r]=null;t(o,s,a)}},onFailure:function(n){for(var i=[],r=0;r<e.length;r++)i.push(null);t(i)}}})},h.prototype._fcsFileurls=function(e){var t;var n=function(e){var t={},n=document.createElement("a");n.href=e;for(var i,r=n.search.substring(1).split("&"),o=0;o<r.length;o++){var s=r[o].split("="),a=s[0];"boid"===a&&(a="id"),t[a]=(i=s[1],decodeURIComponent((i+"").replace(/\+/g,"%20")))}return t},i=[],r=0,o=[];function s(t,n){r--,i=i.concat(t),o=o.concat(n),0===r&&e.callbacks.onComplete(i,o)}var a,d,l=[],h=[],u={data:[],onComplete:function(e){try{s(UWA.is(e,"object")?e:JSON.parse(e),l)}catch(e){console.warn("Error while parsing results")}},onFailure:function(t){e.callbacks.onFailure(t)}},p={data:[],onComplete:function(e){try{s((UWA.is(e,"object")?e:JSON.parse(e)).files,h)}catch(e){console.warn("Error while parsing results")}},onFailure:function(t){e.callbacks.onFailure(t)}},g=null,f=[];for(t=0;t<e.urls.length;t++)if(a=e.urls[t],this.isViscaUrl(a)){if(this.urlServices)f.push(a);else{if(d=n(a),!g){var m=a.toLowerCase().indexOf(c.rep.urlLower);g=m>=0?a.substring(0,m)+c.reps.url:"##error##"}p.data.push(d)}h.push(t)}else(d=n(a)).id&&d.format&&d.filename&&u.data.push(d),l.push(t);u.data.length&&(r++,this.fileurls(u)),p.data.length&&(r++,this.reps(p,g)),f.length>0&&(r++,this.viscaQuery(f,p))};var c={fileurls:{url:"/resources/fcsservices/fcs/fileurls",verb:"POST"},reps:{url:"/api/V1/reps",verb:"POST"},rep:{url:"/api/V1/rep",urlLower:"/api/v1/rep",verb:"POST"}};return h.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},h.prototype.buildDataWithGoodNames=function(e,t){var n,i={};for(n in e)i[e[n]]=t[n];return i},h.prototype.reps=function(e,t){var n,i={s:"source",t:"tenant",id:"boid",f:"filename",v:"version",ts:"timeStamp",type:"repType",sgn:"signature"};for(n=0;n<e.data.length;n++)e.data[n]=this.buildDataWithGoodNames(i,e.data[n]);return e.data=JSON.stringify(e.data),e.method="POST",e.headers={Accept:"application/json","Content-Type":"application/json"},this.finalExecuteRequest(t,e)},h.prototype.fileurls=function(e){var t,n=this.getSecurityParamsCB(),i=e;return t="onPremise"===n.tenant?n.service3DSpaceUrl+c.fileurls.url:n.service3DSpaceUrl+c.fileurls.url+"?tenant="+n.tenant,i.method=c.fileurls.verb,i.headers={Accept:"application/json","Content-Type":"application/json"},i.data=JSON.stringify(i.data),this.executeRequest_fileurls(t,i,void 0,void 0,n)},h.prototype.executeRequest_fileurls=function(e,t,n,i,r){var o=r.securityCtx?r.securityCtx:"preferred";return UWA.is(o,"string")&&!0!==n&&(t.headers.SecurityContext=o),this.finalExecuteRequest(e,t)},h.prototype.viscaQuery=function(e,t){var n=this.getSecurityParamsCB(),i=n.securityCtx?n.securityCtx:"preferred",r=this.urlServices.CreateBatchURLAndBody(e,{allowPartial:!0,fallback:!0});t.data=r.body,t.method="POST",t.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:i};var o=r.url.replace("//api","/api");return this.finalExecuteRequest(o,t)},h.prototype.finalExecuteRequest=function(e,t){return i.authenticatedRequest(e,t)},h.prototype.acceptsRepresentation=function(e,t){let n=e.url;return!n||!(n.indexOf("?e=")>=0||n.indexOf("&e=")>0)},h})),define("DS/3DXMTiles/OOCModel3DHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHModel3DHandler2","DS/3DXMTiles/LDHStats","DS/3DXMTiles/LDHBatchModel3DHandlerVISCANoStream","DS/QualityManager/QMController","DS/3DXMTiles/LDHHandlerMultiple","DS/3DXMTiles/LDHBatchModel3DHandlerBank","DS/3DXMTiles/LDHBatchModel3DHandlerDOS","DS/3DXMTiles/LDHRepresentationLoader"],(function(e,t,n,i,r,o,s,a,d){var l=function(l){d.init(),l=l||{};var h=window.OOCBatchMode||window.localStorage.getItem("OOCBatchMode"),c=r.getBatching();h?c="ON"===h:void 0!==l.batching&&(c=!!l.batching),void 0!==l.useBank?bankMode=l.useBank:bankMode=!(navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&r.getLocalCache(),"ON"===window.localStorage.getItem("OOCBankMode")&&(bankMode=!0),bankMode&&(l.saveToBank=!0,l._dbg_no_batching||(c=!0)),window.OOCNoDashboard&&(c=!1),n.addFlag(c?"batching":"no batching");var u=new a(l,c);l.maxTicketSize=void 0!==l.maxTicketSize?l.maxTicketSize:20971520,l.dosHandler=u;var p=window.localStorage.getItem("OOCMaxTicketSize");p&&(p=parseInt(p));let g=new i(l,12,40);var f=new t(l);this.singleHandler=f;var m=c?[u,g,f]:[u,f,g];if(bankMode){m=[new s(l,40)].concat(m)}var v=new o({handlers:m,getSecurityParamsCB:l.getSecurityParamsCB});e.call(this,e.Model3DHandler,v)};return(l.prototype=Object.create(e.prototype)).setFileType=function(e){this.ldhHandler.setFileType(e)},l.prototype.setLoadModelOptions=function(e){this.ldhHandler.setLoadModelOptions(e)},l.prototype.getModelLoader=function(){return this.ldhHandler.getModelLoader()},l.prototype._dbg_getBatchHandler=function(){return this.ldhHandler.handlers[1]},l.prototype._dbg_getDOSHandler=function(){return this.ldhHandler.handlers[0]},l.prototype.setRedirectUrlCB=function(e){this.ldhHandler.setRedirectUrlCB(e)},l.prototype.setAutoRedirect=function(e){this.ldhHandler.setAutoRedirect(e)},l})),define("DS/3DXMTiles/LDHNodeManagerQueue",["DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHOcclusionStatus","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHStats","DS/Visualization/ThreeJS_R57"],(function(e,t,n,i,r,o,s,a){"use strict";var d=function(t,n){this.type=t,this.handler=null,this.manager=n,this.newNodes=[],this.nodes=[],this.pendingNodes=[],this.nbNodesToRemoveFromList=0,this.viewpointData=null,this.enableOcclusionTest=!0,this.occlusionList=[],this.nodesToLoadQueue=new e,this.unloadableNodesSet=new Set,this.nodesToUpdateSet=new Set,this.loadedNodesQueue=new e,this.forcedReferences=[],this.unknownReferences=[],this.referenceSizeMap=new Map,this.nbLoading=0,this.nbLoaded=0,this.occlusionNbLoaded=0,this.renderingOccured=!1,this.nodesToLoadHasBeenReset=!1,this.unloadedReferenceIds=new Set,this.targetOcclusionNbLoaded=0};return d.prototype.registerNode=function(e){if(null==this.handler)this.handler=e.handler,this.manager.unloadManager.isRestricted&&this.handler.setRestricted();else if(this.handler!==e.handler)throw new Error("different handler found");this.addToLoadedNodesQueue(e);var t=!1;e.isForced()&&e.shouldBeExpanded()?e.isInForced()||(t=!0,e.setInForced(!0),this.forcedReferences.push(e)):e.isInForced()&&(this.removeForcedNode(e),e.setInForced(!1)),e.isUnknown()?e.isInUnknown()||t||(t=!0,e.setInUnknown(!0),this.unknownReferences.push(e)):e.isInUnknown()&&(this.removeUnknownNode(e),e.setInUnknown(!1),e.updateBoundingElementImpostor()),e.isInList()?this.forceUpdateNode(e):(e.setInList(!0),this.newNodes.push(e))},d.prototype.unregisterNode=function(e){e.isInUnknown()&&(this.removeUnknownNode(e),e.setInUnknown(!1)),e.isInForced()&&(this.removeForcedNode(e),e.setInForced(!1))},d.prototype.getEstimatedSize=function(){return this.nodes.length+this.newNodes.length},d.prototype.onReferenceUnloaded=function(){this.nodesToLoadQueue.cleanNulls()},d.prototype.removeUnknownNode=function(e){var t=this.unknownReferences.indexOf(e);t>=0&&this.unknownReferences.splice(t,1)},d.prototype.removeForcedNode=function(e){var t=this.forcedReferences.indexOf(e);t>=0&&this.forcedReferences.splice(t,1)},d.prototype.forceUpdateNode=function(e){e&&(this.nodesToUpdateSet.add(e),e.isForced()&&!e.isInForced()&&e.shouldBeExpanded()&&(this.forcedReferences.push(e),e.setInForced(!0)))},d.prototype.updateNodes=function(e,t){if(null!==this.handler){t?this.viewpointData=t:t=this.viewpointData,e&&(this.unloadedReferenceIds=new Set,this.unloadableNodesSet.clear());var n=e;n||this.nodesToLoadHasBeenReset||(this.updateNodesToLoad(this.newNodes,t),this.updateNodesToLoad(Array.from(this.nodesToUpdateSet),t),this.newNodes.length>0||this.nodesToUpdateSet.size>0),function(e,t){var n;for(n=0;n<t.length;n++)e.push(t[n])}(this.nodes,this.newNodes),this.newNodes.length=0,this.nodesToUpdateSet.clear(),this.removeUselessNodesFromList(this.nodes,e),n&&(this.resetNodesToLoad(),!0),(n||this.nodesToLoadHasBeenReset)&&this.updateNodesToLoad(this.nodes,t)}},d.prototype.updateNodesToLoad=function(e,t){var i,r,s,d=this.manager.enableUnload,l=this.manager.newLoadingBoxes,h=this.manager.occlusionChecker,c=this.manager.unloadManager.isUnloadNeeded(this.handler.type),u=!1;this.manager.ignoreVisibility;let p=new a.Sphere;for(i=0;i<e.length;i++)(r=e[i]).needScreenRadiusSizeComputation()&&(s=r.updateNodeLOD(t),u=r.isFullyClipped(p),1!==s||u||this.isReferenceHidden(r)?d&&(!r.isSlave()&&!r.hasUnloadFrozenParent()||r.isLoaded()||r.isToUnload())&&(this.unloadableNodesSet.add(r),0===s?r.setStatus(n.toUnload,this.manager):r.setStatus(n.toUnloadLight,this.manager),this.unloadedReferenceIds.add(r.referenceId)):r.shouldBeExpanded()&&!this.unloadedReferenceIds.has(r.referenceId)?r.isInToBeLoaded()||r.isInHighPriority()||(r.setInToBeLoaded(!0),this.enableOcclusionTest?(h&&h.showReference(r),this.occlusionList.push(r)):this.nodesToLoadQueue.addNode(r),r.setStatus(n.toLoad,this.manager)):r.isRepLoaded()?r.refreshRepresentationIfSSBChange(this.manager,c)||r.setStatus(n.loaded,this.manager):r.setStatus(n.waiting,this.manager),!l&&o.slaveBoxFix&&r.isSlave()&&!r.isComplete()&&(1===s?r.displayBox(this.manager):r.removeBox(this.manager)));this.nodesToLoadHasBeenReset=!1},d.prototype.requiresOcclusion=function(){return!!(this.handler&&this.handler.isReady()&&this.occlusionList.length>0&&this.nodesToLoadQueue.isEmpty())||(this.isLoading()||!this.handler||this.handler.isReady()||this.manager.requestUpdate(!1,!1),!1)},d.prototype.hasOcclusionList=function(){return this.occlusionList.length>0},d.prototype.computeOcclusion=async function(e,t){if(this.handler){if(r.startProbe("occlusion"+this.handler.type),this.renderingOccured=!1,!this.nodesToLoadQueue.isEmpty()){var n=this.nodesToLoadQueue.getAllNodes();this.occlusionList=n.concat(this.occlusionList)}var i,o;this.nodesToLoadQueue.clear();var s=!1;for(i=0;i<this.occlusionList.length;i++)(o=this.occlusionList[i])&&(o.addToOcclusionChecker(e),s=!0);if(s){await e.computeVisibility();var a,d=0;for(i=0;i<this.occlusionList.length;i++)(o=this.occlusionList[i])&&(a=o.occlusionId)>=0&&o&&(e.getVisibility(a)||!o.hasGoodRep()?(o.setOcclusionVisible(!0),this.nodesToLoadQueue.addNode(o),this.occlusionList[i]=null,d++):(o.setOcclusionVisible(!1),o._onOccluded()));this.occlusionNbLoaded=this.nbLoaded+Math.floor(d/2)}r.endProbe("occlusion"+this.handler.type)}},d.prototype.resetNodesToLoad=function(){var e,t;for(this.nodesToLoadQueue.clear((function(e){e.setInToBeLoaded(!1),e.setOcclusionVisible(!1)})),e=0;e<this.occlusionList.length;e++)(t=this.occlusionList[e])&&(t.setInToBeLoaded(!1),t.setOcclusionVisible(!1));this.occlusionList=[],this.nodesToLoadHasBeenReset=!0},d.prototype.loadHighPriorityNodes=function(e,t){return this.loadNodeLists(e,[this.forcedReferences],t,!0)},d.prototype.loadUnknownNodes=function(e,t){return this.loadNodeLists(e,[this.unknownReferences],t,!1)},d.prototype.loadNodeLists=function(e,t,n,i){var r,o,s,a,d,l=this.handler,h=this.manager.unloadManager,c=this.manager,u=n||(l?l.createBatch():null);if(l&&l.isReady()){l.type;for(r=0;r<t.length;r++)for(s=t[r],o=0;o<s.length&&l.isReady();o++)(a=s[o]).isLoading()||u.containsReference(a)||a.isError()||(d=h.isLoadingAllowed(l.type),i&&!d&&(c.forceUnloadSmallNodes(1/0,e,l.type),d=h.isLoadingAllowed(l.type)),d&&(u.addReferenceIfPossible(a)||(this.loadBatch(u),u=l.createBatch())))}return u},d.prototype.loadNodes=function(e,t){var n=this.handler;if(n){var i=this.loadHighPriorityNodes(t,null),r=this.manager,o=!r.enableUnload||r.unloadManager.isLoadingAllowed(this.type),s=r.unloadManager,a=this;n.type;this.nodesToLoadQueue.traverseMaxPlus((function(e,d,l){if(e.isAlive()){if(!e.isToLoad())return e.setInToBeLoaded(!1),void e.setOcclusionVisible(!1);if(s.wouldDownloadCauseEmergencyUnload(e.referenceId,a))return r.emergencyUnloadAvoided=!0,l(),void d();if(n.isReady()&&(!o&&r.unloadSmallNodesEnabled&&(a.manager.forceUnloadSmallNodes(e.getScore(),t,n.type),o=s.isLoadingAllowed(n.type)),o))return e.hasDifferentViewpointTag(r.viewpointTag)&&(e._occurrences.length>0||e.isSlave())&&!e.isInHighPriority()&&!i.addReferenceIfPossible(e)?(l(),a.loadBatch(i),void(i=n.createBatch())):(e.setInToBeLoaded(!1),void e.setOcclusionVisible(!1));d(),l()}})),i=this.loadUnknownNodes(t,i),this.loadBatch(i)}},d.prototype.loadBatch=function(e){if(!e.isEmpty()){var t={viewpointTag:this.manager.viewpointTag,manager:this.manager.oocManager,doneCB:this.onHandlerDone.bind(this)};e.setReferencesLoading(this.manager),this.nbLoading+=e.getSize(),s.onStartCGRLoading(),this.handler.handleBatch(e,t)}},d.prototype.onHandlerDone=function(e,i,r){e=e||[];var o=(i=i||[]).length+e.length;this.nbLoaded+=o,0===this.handler.type||this.manager.progressiveExpand?this.nbLoading-=o:this.nbLoading--;this.manager.enableUnload;var s,a,d,l,h=this.manager.occlusionChecker,c=e.concat(i);this.manager.unloadManager;if(this.manager.progressiveExpand)for(a=0;a<e.length;a++)(d=e[a]).setRepLoaded(!0);for(a=0;a<c.length;a++){if(d=c[a],h&&h.hideReference(d),d.isLoading()&&d.setStatus(n.loaded,this.manager),0===this.handler.type){var u=this.manager.switchRepresentationBuffer.get(d.referenceId);u&&(s=this.manager.oocManager,this.manager.switchRepresentationBuffer.delete(d.referenceId),d.switchRepresentation(u.rep,s.isMeshInRAMRequested(d.referenceId),this.manager,u.onSwitchRepCBArray,!0))}d._boundingSphere||d._boundingBox||this.handler.type!==t.Model3DHandler||(d.updateBoundingSphereFromNode(),l=!0),(d.isForced()||l)&&this.manager.registerTilesNode(d)}let p=!(!r||!r.retry);for(a=0;a<i.length;a++)this.handler.type===t.Model3DHandler||this.handler.type===t.TileSetHandler?p?(i[a].setStatus(n.waiting,this.manager),this.forceUpdateNode(i[a])):(i[a].setStatus(n.error,this.manager),i[a].showActiveRepresentation(this.manager),i[a]._onLoaded(),this.onNodeToRemoveFromList()):this.forceUpdateNode(i[a]);this.handler.isReady()&&this.manager.requestUpdate(!1,!1),this.handler.type===t.Model3DHandler&&this.manager.viewer.render({budgeted:!0})},d.prototype.onNodeToRemoveFromList=function(){this.nbNodesToRemoveFromList++},d.prototype.removeUselessNodesFromList=function(e,t){if(this.nbNodesToRemoveFromList>200||t){var n,i;for(n=0;n<e.length;n++)(i=e[n]).isAlive()||(e[n]=null);var r=0;for(n=0;n<e.length;n++)null!==(i=e[n])&&(e[r]=i,r++);e.length=r,this.nbNodesToRemoveFromList=0}},d.prototype.isLoading=function(){return this.nbLoading>0},d.prototype.hasMoreToLoad=function(){return!this.nodesToLoadQueue.isEmpty()},d.prototype.fillDebugArray=function(e){var t,n,i,r;for(this.removeUselessNodesFromList(this.nodes,!0),t=0;t<this.nodes.length;t++){if(i={id:(n=this.nodes[t]).referenceId,screenRadius:n._screenRadius,status:n._status,unloadStatus:n._unloadStatus},n.children.length>0&&(i.nbChildren=n.children.length,n.children.length>0)){var o=[],s=[];for(r=0;r<n.children.length;r++)o.push(n.children[r].reference.referenceId),s.push(n.children[r].instanceId);i.children=o,i.instances=s}n.unloadLockCounter>0&&(i.unloadLockCounter=n.unloadLockCounter),e.push(i)}},d.prototype.memorizeReferenceSize=function(e,t){(!this.referenceSizeMap.has(e)||this.referenceSizeMap.get(e)<t)&&this.referenceSizeMap.set(e,t)},d.prototype.getMemorizedReferenceSize=function(e){return this.referenceSizeMap.has(e)?this.referenceSizeMap.get(e):-1},d.prototype.addToLoadedNodesQueue=function(e){e.isInLoaded()||(e.setInLoaded(!0),this.loadedNodesQueue.addNode(e))},d.prototype.unloadSmallNodes=function(e,t,n){var i=this.manager.unloadManager,r=this.loadedNodesQueue,o=this.manager,s=this.handler.type,a=this.unloadedReferenceIds;r.traverseMinPlus((function(n,r,d){var l=!1;!i.isLoadingAllowed(s)&&n.getScore()<e?n.isUnloadLocked()?l=!0:o.unloadNode(n,t,!0)?(a.add(n.referenceId),o.hasUnloadedSmallNodes=!0):l=!0:(r(),l=!0),l?d():n.setInLoaded(!1)}))},d.prototype.standardUnloadNodes=function(e,t){var n=this.manager.unloadManager;if(this.handler&&n.isUnloadNeeded(this.handler.type)){var i=!1,r=this.manager;let e,n=null;for(this.unloadableNodesSet.forEach((e=>{e.isUnloadLocked()?(n=n||[],n.push(e)):e.isAlive()&&e.isUnloadable()&&e.isToUnload()&&(i=!0,r.unloadNode(e,t))})),this.unloadableNodesSet.clear(),e=0;n&&e<n.length;e++)this.unloadableNodesSet.add(n[e]);i&&this.onReferenceUnloaded()}e&&this.loadedNodesQueue.cleanNulls()},d.prototype.doEmergencyUnload=function(e){var t=this.manager,n=!1,i=this.type,r=this.unloadedReferenceIds;this.loadedNodesQueue.traverseMinPlus((function(o,s,a){if(t.unloadManager.isEmergencyUnloadRequired(void 0,i)){var d=!1;o.handler;o.isAlive()&&(o.isUnloadLocked()?d=!0:(n=!0,t.unloadNode(o,e,!0)?r.add(o.referenceId):d=!0)),d?a():o.setInLoaded(!1)}else a(),s()})),n&&this.onReferenceUnloaded()},d.prototype.computeNodesCollidingWithBox=function(e){var t,n,i=[];i=(i=i.concat(this.nodes)).concat(this.newNodes);var r=e.getBoundingSphere(),o=new a.Sphere,s=[],d=[];for(t=0;t<i.length;t++)(n=i[t]).isCollidingWithBox(e,r,o,s)&&d.push(n.referenceId);return d},d.prototype.isReferenceHidden=function(e){if(this.manager.ignoreVisibility)return!1;let t=this.manager.viewer,n=e.getHidden(),i=e.getVisibilityFree();return t.visibleSpace||i?n:!n},d})),define("DS/3DXMTiles/OOCManagerEntry",["DS/3DXMTiles/LDHReference"],(function(e){"use strict";return function(t,n){this.id=t,this.reference=new e({handler:n.handler,manager:n.manager._ldhNodeManager,boundingSphere:n.boundingSphere&&n.boundingSphere.clone(),boundingBox:n.boundingBox&&n.boundingBox.clone(),urlOrId:n.url,referenceId:t,leaf:!!n.leaf,node:n.node||null,positioningArch:n.positioningArch}),n.loadModelOptions&&this.reference.setLoadModelOptions(n.loadModelOptions)}})),define("DS/3DXMTiles/OOCManagerRootEntry",["DS/3DXMTiles/LDHReference"],(function(e){"use strict";var t=function(e,t,n,i){this.occurrence=e,this.boundingBox=t&&t.clone(),this.enableExpand=!0,this.treeModified=!1,this.elasticLoading=!1,this.rootId=n,this.onLoadedCB=i||null,this.visible=!0,this.isLarge=!0};return t.prototype.computeSceneMin=function(){var e=this.boundingBox.clone();return e.applyMatrix4(this.occurrence.matrix),e.min.z},t})),define("DS/3DXMTiles/DSTilesStylingFilter",["DS/3DXMTiles/DSTilesStylingFilterOperatorParser","DS/3DXMTiles/DSTilesStylingFilterOperatorInList","DS/3DXMTiles/DSTilesStylingFilterBinaryOperator","DS/3DXMTiles/DSTilesStylingFilterNotOperator","DS/3DXMTiles/DSTilesStylingFilterOrOperator","DS/3DXMTiles/DSTilesStylingFilterAndOperator"],(function(e,t,n,i,r,o){"use strict";return class{constructor(){this.rootOperator}setFromJSON(s){e.setFilterClasses([t,n,i,r,o]);let a=e.parse(s),d=a.status;return d.isOk()&&(this.rootOperator=a.operator),d}addNeededAttributesToSet(e){this.rootOperator&&this.rootOperator.addNeededAttributesToSet(e)}buildShaderCode(e){return this.rootOperator.buildShaderCode(e)}filter(e){return this.rootOperator.filter(e)}}})),define("DS/3DXMTiles/DSTilesGenericScoreComputer",["DS/3DXMTiles/DSTilesScoreComputer","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS"],(function(e,t,n){"use strict";var i=function(e){this.minScreenRadius=e.minScreenRadius||5};return(i.prototype=Object.create(e.prototype)).getSortingMetric=function(){return this.sortingMetric},i.prototype.getScreenRadiusCache=function(e){var n=e.screenRadiusCache;if(!n){var i=e.getBoundingSphere();n=[];var r,o=e.worldPosition;for(r=0;r<o.matrixArray.length;r++)n.push(t.computeScreenRadiusCache(o.matrixArray[r],null,i,!1,!1));e.screenRadiusCache=n.length>0?n:null}return n},i.prototype.getDistanceToBoxCache=function(e){var n=e.distanceToBoxCache;if(!n||0===n.length){var i=e.getBoundingBox();n=[];var r,o=e.worldPosition;for(r=0;r<o.matrixArray.length;r++)n.push(t.computeDistanceToBoxCache(o.matrixArray[r],i));e.distanceToBoxCache=n.length>0?n:null}return n},i.prototype.computeScore=function(e,n,i){let r=e.tileSet.r2vFullLOD;var o=e.getTriggerMetric(),s=e.getSortingMetric();if(e.getBoundingSphere()){var a,d,l,h=n.viewpoint,c=h.getEyePosition(),u=n.cst,p=this.getScreenRadiusCache(e),g=!1,f=-1/0;for(a=0;a<p.length;a++){if((l=p[a]).containsPoint(c))return e.score=1/0,void(e.pixelError=1/0);h._frustum.performFrustumCullingNoNearFar(l.radius,l.center)&&(d=t.computeScreenRadius(l,h.camera,h._frustum,u,!1,!1,!0))>=this.minScreenRadius&&(g=!0,f=d>f?d:f)}var m=0;if("pixelError"===s||i&&"pixelError"===o){let t,i=r?2:1;for(m=-1/0,a=0;a<p.length;a++)t=this.computePixelError(i*e.geometricalError,p[a],n),m=t>m?t:m;if(e.tileSet.singleContentLoader){m*=e.tileSet.singleContentLoader.pixelErrorFactor}}var v=0;("distanceToBox"===s||i&&"distanceToBox"===o)&&(v=this.computeDistanceToBox(e,n));var S=1/0;if("distanceToSphere"===s){var y=1/0;for(a=0;a<p.length;a++)S=(l=p[a]).containsPoint(c)?0:S<(y=l.center.distanceTo(c)-l.radius)?S:y}var M=0,D=-1;if(g)switch(s){case"screenRadius":M=f;break;case"distanceToBox":M=1/v;break;case"distanceToSphere":M=1/S;break;case"pixelError":if(r){let t=e.parent;if(t){M=(e.geometricalError>0?t.geometricalError/e.geometricalError:1)*m}else M=1/0;break}M=m}if(g&&i)switch(o){case"pixelError":D=m;break;case"distanceToBox":for(D=0,a=0;a<p.length;a++)l=p[a],v<e.geometricalError*l.scale&&(D=1/0)}e.score=M,e.pixelError=D}else e.score=1/0,i&&(e.pixelError=-1)},i.prototype.computeDistanceToBox=function(e,t){if(!e.getBoundingBox())return-1;var n,i=this.getDistanceToBoxCache(e),r=t.viewpoint.getEyePosition(),o=1/0;let s;for(s=0;s<i.length;s++)o=(n=i[s].boundingBox.distanceToPoint(r))<o?n:o;return o},i.prototype.computePixelError=function(e,t,i){var r,o=i.viewpoint,s=t.radius,a=t.center,d=o.getEyePosition(),l=o.getSightDirection(),h=new n.Vector3(a.x-d.x,a.y-d.y,a.z-d.z),c=h.length();h.multiplyScalar((c-s)/c);var u=h.dot(l);if(u<0)r=1/0;else{var p=1/(u*i.cst);r=t.scale*e*p}return t.radius=s,t.center=a,r},i})),define("DS/3DXMTiles/DSTilesStylingRule",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilter","DS/3DXMTiles/DSTilesStylingRender","DS/3DXMTiles/DSTilesStylingRenderRange","DS/3DXMTiles/DSTilesStylingRenderRamp","DS/3DXMTiles/DSTilesStylingRenderConstant"],(function(e,t,n,i,r,o){"use strict";return class{constructor(e){this.name=e,this.showFilter=null,this.renderFilter=null,this.render=null,this.priority=0}setFromJSON(s){let a=[];if(s.showFilter){let n=new t,i=n.setFromJSON(s.showFilter);i.isOk()?this.showFilter=n:a.push(e.error("Error parsing showFilter","rule",[i]))}if(s.renderFilter){let n=new t,i=n.setFromJSON(s.renderFilter);i.isOk()?this.renderFilter=n:a.push(e.error("Error parsing renderFilter","rule",[i]))}if(s.render){let t=new e,d=n.createFromJSON(s.render,t,[i,r,o]);t.isOk()?this.render=d:a.push(e.error("Error parsing render","rule",[t]))}if(void 0!==s.priority){let t=parseFloat(s.priority);null!==s.priority&&isFinite(t)?this.priority=t:a.push(e.error("Invalid priority","rule"))}return a.length?e.error("Error parsing styling rule","rule",a):this.showFilter||this.render?e.ok:e.error("Invalid rule: no showFilter, no render","rule")}addNeededAttributesToSet(e){this.showFilter&&this.showFilter.addNeededAttributesToSet(e),this.renderFilter&&this.renderFilter.addNeededAttributesToSet(e),this.render&&this.render.addNeededAttributesToSet(e)}fillGraphicAttributes(e,t){!this.render||this.renderFilter&&!this.renderFilter.filter(t)||(e.render=!0,this.render.fillGraphicAttributes(e,t))}}})),define("DS/3DXMTiles/DSTilesStylingObjectToAttributes",["DS/3DXMTiles/DSTilesStylingAttributePack","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";class n{constructor(){this.containerToMapMap=new Map}getMap(e){let t=this.containerToMapMap.get(e);return t||(t=new Map,this.containerToMapMap.set(e,t)),t}setAttribute(t,n,i,r){let o=this.getMap(t),s=o.get(n);s||(s=new e,o.set(n,s)),s.setAttribute(i,r)}getAllAttributes(e,t){let n=this.getMap(e),i=n&&n.get(t),r=null;return i&&(r=[],i.map.forEach(((e,t)=>{r.push({name:t,value:e})}))),r}getValue(e,t,n){let i=this.getMap(e),r=i&&i.get(t),o=null;return r&&(o=r.getValue(n)),o}getObjectsWithValue(e,t,n,i){let r=this.getMap(e),o=[],s=new Set,a=null;if(r&&r.forEach(((e,i)=>{null===i?a=e:e.hasAttribute(t)&&(s.add(i),e.getValue(t)===n&&o.push(i))})),a&&a.getValue(t)===n)if(0===o.length)o.push(null);else{let e;for(e=0;e<i.length;e++)s.has(i[e])||o.push(i[e])}return o}computeAttributesForEachGroup(e,t){let i=new n,r=this.containerToMapMap.get(e);if(r){let n=r.get(null)||null;r.forEach(((r,o)=>{let s=r.createFilteredPack(t,n);i.getMap(e).set(o,s)}))}return i}getGraphicAttributes(e,t,n){let o=t.getNeededAttributes(),s=this.computeAttributesForEachGroup(e,o),a=[],d=s.getMap(e);d&&d.forEach(((e,n)=>{let o=t.computeGraphicAttributes(e);a.push(new r(n?[n]:null,new i(o)))}));let l,h=s.compactResults(a),c=null,u=new Set;for(l=0;l<h.length;l++){let e=h[l];if(e.objects){let t,n=e.objects;for(t=0;t<n.length;t++)u.add(n[t])}else c=e}if(c)for(c.objects=[],l=0;l<n.length;l++){let e=n[l];u.has(e)||c.objects.push(e)}return h}compactResults(e){let t,n=[],i=null,o=null;for(t=0;t<e.length&&!i;t++){let s=e[t];s.objects||(i=s.graphicAttributes,o=i.getKey(),n.push(new r(null,i)))}let s=new Map;for(t=0;t<e.length;t++){let n=e[t],i=n.objects;if(i){let e;for(e=0;e<i.length;e++){let t=n.graphicAttributes.clone(),a=t.getKey();if(a!==o){let n=s.get(a);n||(n=new r([],t),s.set(a,n)),n.objects.push(i[e])}}}}return s.forEach(((e,t)=>{n.push(e)})),n}}class i{constructor(e){this.render=void 0!==e.render?e.render:null,this.visible=void 0!==e.visible?e.visible:null,this.color=void 0!==e.color?e.color:null,this.opacity=void 0!==e.opacity?e.opacity:null}mergeWithCommon(e){this.render=e.render||this.render,null===this.visible&&(this.visible=e.visible),null===this.color&&(this.color=e.color),null===this.opacity&&(this.opacity=e.opacity)}clone(){return new i(this)}getKey(){let e=this.color instanceof t.Color?this.color.getHexString():this.color;return`${this.visible}-${e}-${this.opacity}-${this.render}`}}class r{constructor(e,t){this.objects=e,this.graphicAttributes=t}}return n})),define("DS/3DXMTiles/DSTilesModelLoader",["DS/Visualization/ModelLoader","DS/VisuLoaders/ThreeDXLoader","DS/3DXMTiles/DSTilesStylingObjectToAttributes","DS/Visualization/Mesh3D"],(function(e,t,n,i){"use strict";var r=function(){this.nbLoading=0,this.maxNbLoading=1,this.modelLoader=null,this.threeDXLoader=null,this.reuseMap=new o};r.prototype.isReady=function(){return this.nbLoading<this.maxNbLoading},r.prototype.loadFromBuffer=function(e,t,n,i,r,o,s,a){if(null!==e)return"3dxc"===(n=n||"cgr").toLowerCase()?this.load3DX.apply(this,arguments):this.loadGeneric.apply(this,arguments);setTimeout(i,0)},r.prototype.createModelLoader=function(){var t=new e;return t.setKeepLoaderMode(!0),t.sharedBuffers=!1,t},r.prototype.createThreeDXLoader=function(){return new t},r.prototype.load3DX=function(e,t,n,i,r,o,s,a){var d=this.threeDXLoader;d||(d=this.createThreeDXLoader(),this.threeDXLoader=d),this.nbLoading++;var l=!1,h=!1;let c=()=>{o&&this.reuseMap.registerData(s,a.getUri(s.sourceId),t.children);let e=this.buildAttributesMap(t,a);i(e)};d.load({arrayBuffer:e,destinationNode:t,zipped:!1,concat:!0,primitives:!0,doneCallback:e=>{h=!0,(0===e.nbTextures||l)&&(this.nbLoading--,c())},onTexturesLoadedCallback:e=>{l=!0,h&&(this.nbLoading--,c())},errorCallback:()=>{this.nbLoading--,o&&this.reuseMap.onError(s,a.getUri(s.sourceId)),r()}})},r.prototype.loadGeneric=function(e,t,n,i,r,o,s,a){var d=this.modelLoader;d||(d=this.createModelLoader(),this.modelLoader=d),this.nbLoading++,d.setSceneGraph(t),d.setFileType(n);var l=this;d.setOnLoadedProductStructureCallback((e=>{l.nbLoading--,d.setTargetNode(null),o&&this.reuseMap.registerData(s,a.getUri(s.sourceId),t.children),i()})),d.setOnErrorCallback((function(){l.nbLoading--,d.setTargetNode(null),o&&this.reuseMap.onError(s,a.getUri(s.sourceId)),r()}));d.loadModelFromBuffer(e,t,{})},r.prototype.reuseStartLoading=function(e,t){this.reuseMap.startLoading(e,t.getUri(e.sourceId))},r.prototype.loadFromReuse=function(e,t,n,i,r){this.reuseMap.getNodesAndAddRef(i,r.getUri(i.sourceId),(n=>{let i;for(i=0;i<n.length;i++)e.addChild(n[i]);t()}),n)},r.prototype.buildAttributesMap=function(e,t){let r=new n,o=t.metaData;if(o){let t=o.objects;e.traverseUnique((e=>{if(e instanceof i){if(o.attributes){let t;for(t in o.attributes)r.setAttribute(e,null,t,o.attributes[t])}if(t){let n;for(n=0;n<t.length;n++){let i,o,s=t[n].tags,a=t[n].attributes,d=[];for(i=0;i<s.length;i++){let t=e.getPrimitive(s[i],!1);t&&d.push(t)}for(o in a)for(i=0;i<d.length;i++)r.setAttribute(e,d[i],o,a[o])}}}}))}return r};class o{constructor(){this.sourceMap=new WeakMap}hasData(e,t){let n=this.sourceMap.get(e);return!!n&&n.hasData(t)}startLoading(e,t){let n=this.sourceMap.get(e);n||(n=new s,this.sourceMap.set(e,n)),n.startLoading(t)}registerData(e,t,n){let i=this.sourceMap.get(e);i&&i.registerData(t,n)}onError(e,t){let n=this.sourceMap.get(e);n&&n.onError(t)}release(e,t){let n=this.sourceMap.get(e);n&&n.release(t)}getNodesAndAddRef(e,t,n,i){let r=this.sourceMap.get(e);r?r.getNodesAndAddRef(t,n,i):i()}}class s{constructor(){this.nodeMap=new Map}registerData(e,t){if(t){let n=this.nodeMap.get(e);if(n){let e;for(n.nodes=[].concat(t),n.loaded=!0,n.addRef(),e=0;e<n.onLoadedCBs.length;e++)n.onLoadedCBs[e](t);n.onLoadedCBs=[],n.onErrorCBs=[]}}}onError(e){let t=this.nodeMap.get(e);if(t){let e;for(t.loaded=!1,t.error=!0,e=0;e<t.onErrorCBs.length;e++)t.onErrorCBs[e](nodes);t.onLoadedCBs=[],t.onErrorCBs=[]}}release(e){let t=this.nodeMap.get(e);t&&(t.release(),t.usecount<=0&&this.nodeMap.delete(e))}getNodesAndAddRef(e,t,n){let i=this.nodeMap.get(e);i?(i.addRef(),i.loaded?t(i.nodes):i.error?n():(i.onLoadedCBs.push(t),i.onErrorCBs.push(n))):n()}hasData(e){return!!this.nodeMap.get(e)}startLoading(e){let t=this.nodeMap.get(e);t||(t=new a,this.nodeMap.set(e,t)),t.loading=!0}}class a{constructor(e){this.usecount=0,this.loaded=!1,this.error=!1,this.onLoadedCBs=[],this.onErrorCBs=[],this.nodes=[]}addRef(){this.usecount++}release(){this.usecount--}}return new r})),define("DS/3DXMTiles/DSTilesStyling",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingRule"],(function(e,t){"use strict";return class{constructor(){this.ruleSet=new Map,this.orderedRules=[],this.neededAttributes=[]}setFromJSON(n){let i=[],r=!1;if(n.rules){let o;for(o in n.rules){let s=new t(o),a=s.setFromJSON(n.rules[o]);a.isOk()?(s.priority&&(r=!0),this.ruleSet.set(o,s)):i.push(e.error("Error parsing rule '"+o+"'","styling",[a]))}}if(Array.isArray(n.applyRules)){let t;for(t=0;t<n.applyRules.length;t++){let r=n.applyRules[t],o=this.ruleSet.get(r);o?this.orderedRules.push(o):i.push(e.error("Error parsing applyRules - unknown rule'"+r+"'","styling"))}}return r&&this.orderedRules.sort(((e,t)=>(e.priority||0)-(t.priority||0))),this.neededAttributes=this.computeNeededAttributes(),i.length?e.error("Error parsing rules","styling",i):e.ok}computeNeededAttributes(){let e,t=this.getRules(),n=new Set;for(e=0;e<t.length;e++)t[e].addNeededAttributesToSet(n);let i=[];return n.forEach((e=>{i.push(e)})),i}getRules(){return this.orderedRules}getNeededAttributes(){return this.neededAttributes}computeGraphicAttributes(e){let t,n=this.getRules(),i=!0;for(t=0;t<n.length&&i;t++){let r=n[t];r.showFilter&&!r.showFilter.filter(e)&&(i=!1)}let r={visible:i};if(i)for(t=0;t<n.length;t++){n[t].fillGraphicAttributes(r,e)}return r}hasShowFilter(){let e,t=this.orderedRules;for(e=0;t&&e<t.length;e++)if(t[e].showFilter)return!0;return!1}hasRender(){let e,t=this.orderedRules;for(e=0;t&&e<t.length;e++)if(t[e].render)return!0;return!1}}})),define("DS/3DXMTiles/DSTilesCustomContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/DSTilesModelLoader","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/3DXMTilesUtils"],(function(e,t,n,i,r,o){"use strict";var s=function(t){t=t||{},e.call(this,t),this.customContentManager=t.customContentManager};function a(){}return(s.prototype=Object.create(e.prototype)).getBudgetParams=function(){return this.customContentManager._getBudgetParams()},s.prototype.loadContentFromBuffer=function({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,params:o}){n.setContentToken(new a),i()},s.prototype.showContent=function(e,t){this.customContentManager.createNodeCB({uri:e.uri,tileSet:e.tileSet.oocTileSet,parentNode:this.needsSgNodePerContent()?e.getSgNode():null})},s.prototype.hideContent=function(e,t){this.customContentManager.removeNodeCB({uri:e.uri,tileSet:e.tileSet.oocTileSet,parentNode:this.needsSgNodePerContent()?e.getSgNode():null})},s.prototype.deleteContent=function(e,t,n){},s.prototype.needsSgNodePerContent=function(){return!this.customContentManager.needsSgNodePerContentCB||this.customContentManager.needsSgNodePerContentCB()},s.prototype.needsDownload=function(){return!1},s})),define("DS/3DXMTiles/DSTilesInstancingContentLoader",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesModelLoader","DS/Visualization/Node3D","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/InstancingNode3D"],(function(e,t,n,i,r,o){"use strict";class s{constructor(t,n,i){this.node=t,this.content=n,this.queue=i,this.instancingNode=new o;let r=n.instances;if(r){let t,n=[];for(t=0;t<r.length;t++){let i=r[t];if(i&&i.matrix){let t=new e.Matrix4;t.setFromJSON(i.matrix),n.push(t)}}n.length>0&&this.instancingNode.setInstancingParameters(n)}this.visible=!1,this.geometrySize=0}computeMemorySize(){this.geometrySize=r.computeMeshSize(this.instancingNode)}}return class extends t{constructor(e){super(e=e||{}),this.instancingRoot=null}getBudgetParams(){return{name:"instancedMesh",physicalBudget:"gpu",params:{}}}getInstancingRoot(){if(!this.instancingRoot){this.instancingRoot=new i,this.tilesManager.getOOCTargetNode().addChild(this.instancingRoot)}}isReady(){return n.isReady()}hasExistingData(e,t,i){let r=e.tileSet.getContentSource(i);return n.reuseMap.hasData(r,t.uri)}onStartLoading(e,t,i){let r=e.tileSet.getContentSource(i);return n.reuseMap.startLoading(r,t.uri)}loadContentFromExistingData(e,t,i,r,o){var a=e.queue;let d=e.tileSet.getContentSource(i);var l=new s(e,t,a);n.loadFromReuse(l.instancingNode,this.onModelLoaded.bind(this,l,r),this.onModelError.bind(this,l,o),d,t)}loadContentFromBuffer({data:e,node:t,content:i,onLoadedCB:r,onErrorCB:o,sourceId:a,params:d}){var l=t.queue,h=new s(t,i,l);let c=t.tileSet.getContentSource(a);n.loadFromBuffer(e,h.instancingNode,i.getFormat(),this.onModelLoaded.bind(this,h,r),this.onModelError.bind(this,h,o),!0,c,i)}onModelLoaded(e,t){var n=e.node,i=(e.queue,e.content);n.isAlive()&&(i.setContentToken(e),e.computeMemorySize(),this.budget.updateUsage(0,e.geometrySize)),t()}onModelError(e,t){e.node,e.queue;t()}showContent(e,t){let n=t.contentToken;n&&n.node.getSgNode().addChild(n.instancingNode)}hideContent(e,t){let n=t.contentToken;n&&n.node.getSgNode().removeChild(n.instancingNode)}deleteContent(e,t,i){n.reuseMap.release(t.getSingleSource(e),t.uri),i&&(this.hideContent(e,i),this.budget.updateUsage(i.geometrySize,0),i.instancingNode.removeChildren(),i.instancingNode=null,i.geometrySize=0)}exportContent(e,t){let n=t.contentToken;if(n)return n.nodes.length>0?[].concat(n.nodes):[].concat(n.instancingNode.children)}needsSgNodePerContent(){return!0}}})),define("DS/3DXMTiles/DSTilesMeshContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesModelLoader","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement"],(function(e,t,n,i,r,o,s){"use strict";class a{constructor(e,t,i){this.node=e,this.content=t,this.queue=i,this.targetSGNode=new n,this.nodes=[],this.visible=!1,this.geometrySize=0,this.attributesMap=null,this.styling=null}computeMemorySize(){this.geometrySize=r.computeMeshSize(this.targetSGNode)}clone(){let e=new a(this.node,this.content,this.queue);return e.targetSGNode=this.targetSGNode,e.nodes=this.nodes,e.visible=this.visible,e.geometrySize=this.geometrySize,e.attributesMap=this.attributesMap,e.styling=this.styling,e}}return class extends e{constructor(e){super(e=e||{})}getBudgetParams(){return{name:"mesh",physicalBudget:"gpu",params:{}}}isReady(){return t.isReady()}loadContentFromBuffer({data:e,node:n,content:i,onLoadedCB:r,onErrorCB:o,sourceId:s,params:d,updateContent:l}){var h=n.queue;let c=n.tileSet.getContentSource(s);var u=new a(n,i,h);t.loadFromBuffer(e,u.targetSGNode,i.getFormat(),this.onModelLoaded.bind(this,u,r,l),this.onModelError.bind(this,u,o),!1,c,i)}onModelLoaded(e,t,n,i){e.node.isAlive()&&(e.attributesMap=i,e.content.setContentToken(e,n),e.computeMemorySize(),this.budget.updateUsage(0,e.geometrySize)),t()}onModelError(e,t){e.node,e.queue;t()}showContent(e,t){let n=t.contentToken;if(!n)return;let i=(e=n.node).tileSet.tilesManager.ldhNodeManager.viewer.renderer.renderer;var r,o,s=n.targetSGNode,a=e.getSgNode();for(n.nodes.length=0,o=0;o<s.children.length;o++)r=s.children[o],a.addChild(r),n.nodes.push(r);s.removeChildren();let d=e.getStyling();n.styling!==d&&(n.styling=d,this.applyStyling(d,n,i))}hideContent(e,t){let n=t.contentToken;if(n){e=n.node;var i,r,o=n.targetSGNode,s=e.getSgNode();for(r=0;r<n.nodes.length;r++)i=n.nodes[r],s.removeChild(i),o.addChild(i)}}deleteContent(e,t,n){n&&(this.hideContent(e,t),this.budget.updateUsage(n.geometrySize,0),n.targetSGNode=null,n.geometrySize=0)}exportContent(e,t){let n=t.contentToken;if(n)return n.nodes.length>0?[].concat(n.nodes):[].concat(n.targetSGNode.children)}needsSgNodePerContent(){return!0}applyStyling(e,t,n){if(!e)return;let r;for(r=0;r<t.nodes.length;r++){t.nodes[r].traverse((r=>{if(r instanceof i){r._resetLayers();let i=t.attributesMap.getGraphicAttributes(r,e,this.getMeshPrimitives(r));if(e.hasShowFilter()){let e;for(r.hide(),e=0;e<i.length;e++){let t=i[e];t.graphicAttributes.visible&&r.show(t.objects)}}if(e.hasRender()){let e;for(e=0;e<i.length;e++){let t=i[e];this.applyGraphicAttributes(r,t,n)}}}}))}}applyGraphicAttributes(e,t,n){if(t.graphicAttributes.render){let i=t.graphicAttributes.color,r=null;null!=i&&(r=i instanceof o.Color?i:new o.Color(i));let s,a=t.graphicAttributes.opacity;for(s=0;s<t.objects.length;s++){let i=t.objects[s],o=(i.sgNode.container.material||i.sgNode.container.gas).clone();null!=a&&(o.transparent=1!==a,o.opacity=a),r&&this.applyColorToMaterial(o,r,n),e.setMaterial([i],o)}}}applyColorToMaterial(e,t,n){if(e.map&&e.hasOwnProperty("diffuseMulCoef")){let i=new o.Vector3(1,1,1),r=t.clone();n.gammaInput&&r.copyToLinear(r,n.simpleGamma),i.x=r.r,i.y=r.g,i.z=r.b,e.diffuseMulCoef=i,e.diffuseAddCoef=new o.Vector3(0,0,0)}else e.color=t}createUpdatedContentTokenFromContentToken(e,t){let n=e.getContentToken(!1);if(!n)return!1;let i=null;return i=n.clone(),e.setContentToken(i,!0),!0}getAttributeValue(e,t,n){let i=null,r=n.getContentToken();if(r&&r.attributesMap){let r=n.getContentToken(),o=null,s=t.getLastElement(!0);t.internalPath.length>0&&(o=t.getLastElement()),i=r.attributesMap.getValue(s,o,e),i||(i=r.attributesMap.getValue(s,null,e))}return i}getAllAttributes(e,t){let n=null,i=t.getContentToken();if(i&&i.attributesMap){let i=t.getContentToken(),r=null,o=e.getLastElement(!0);e.internalPath.length>0&&(r=e.getLastElement()),n=i.attributesMap.getAllAttributes(o,r),n||(n=i.attributesMap.getAllAttributes(o,null))}return n}buildPathElement(e,t,n,i){let r=e.concat([]),o=n;for(;o&&o!==t;)r.push(null),o=o.parents[0];r.push(null);let a=r.length-1;for(o=n;o&&o!==t;)r[a--]=o,o=o.parents[0];r[a--]=o;let d=new s;return d.setFromArray(r,i?[i]:null),d}getPathElementsLeadingToAttribute(e,t,n,r,o){let s,a=o.getContentToken(),d=a&&a.attributesMap;if(d&&a)for(s=0;s<a.nodes.length;s++){let o=a.nodes[s];o.traverse((s=>{if(s instanceof i){let i,a=d.getObjectsWithValue(s,e,t,this.getMeshPrimitives(s));if(a)for(i=0;i<a.length;i++)r.push(this.buildPathElement(n,o,s,a[i]))}}))}}getMeshPrimitives(e){let t,n=[],i=e._getPrimitives();for(t=0;t<i.length;t++){let e=i[t];2===e.getCellDimension()&&n.push(e)}return n}}})),define("DS/3DXMTiles/DSTilesTileSetContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/DSTilesModelLoader","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/3DXMTilesUtils"],(function(e,t,n,i,r,o){"use strict";function s(e){this.tileSet=e}return class extends e{constructor(e){super(e=e||{})}getBudgetParams(){return{name:"json",physicalBudget:"cpu",params:{}}}isReady(){return!0}loadContentFromBuffer({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,params:o}){t.queue;let a=(new TextDecoder).decode(e),d=JSON.parse(a);this.tilesManager.createFromJSON(d,t.getSgNode(),!1).then((e=>{let t=new s(e);n.setContentToken(t),e.setVisibility(!1),e.setPauseLoading(!1,"_init_",this.tilesManager.ldhNodeManager),i()}))}showContent(e,t){t.contentToken.tileSet.setVisibility(!0)}hideContent(e,t){t.contentToken.tileSet.setVisibility(!1)}deleteContent(e,t,n){this.tilesManager.removeTileSet(n.tileSet)}exportContent(e,t){}needsSgNodePerContent(){return!0}}})),define("DS/3DXMTiles/OOCTilesCustomContentManager",["DS/3DXMTiles/DSTilesCustomContentLoader"],(function(e){"use strict";var t=function({type:e,createNodeCB:t,removeNodeCB:n,needsSgNodePerContentCB:i}){this.type=e,this.createNodeCB=t,this.removeNodeCB=n,this.needsSgNodePerContentCB=i,this.budgetName="mesh",this.physicalBudget="gpu",this.contentLoader=null};return t.prototype._getBudgetParams=function(){return{name:this.budgetName,physicalBudget:this.physicalBudget,params:{}}},t.prototype._getContentLoader=function(t){return this.contentLoader||(this.contentLoader=new e({tilesManager:t,customContentManager:this}),this.contentLoader.init(t)),this.contentLoader},t})),define("DS/3DXMTiles/LDHCandidateListRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/PriorityQueue"],(function(e,t,n,i,r,o,s,a,d){"use strict";var l=function(e){this.references=[],this.node=null,this.root=e,this.occurrences=[],this.preserveReferences=null,this.material=null,this.previousDimension=-1,this.lastClusters=null,this.priorityQueue=null};l.prototype.createMesh=function(n){if(2===n.dimension)return t.createCuboidNode({cornerPoint:new e.Vector3(0,0,0),firstAxis:new e.Vector3(1,0,0),secondAxis:new e.Vector3(0,1,0),thirdAxis:new e.Vector3(0,0,1)});if(1===n.dimension){var i,r=[new e.Vector3(0,0,0),new e.Vector3(1,0,0),new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,0),new e.Vector3(0,0,1),new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0),new e.Vector3(1,0,1),new e.Vector3(0,1,0),new e.Vector3(0,1,1),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(0,0,1),new e.Vector3(0,1,1),new e.Vector3(0,0,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(0,1,1),new e.Vector3(1,1,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(1,1,0)],o=[];for(i=0;i<r.length;i++)o.push(i);return t.createLineNode({points:r,drawMode:s.ConnectivityTypeEnum.LINES,idx:o})}},l.prototype.clearRepresentation=function(){this.node&&(this.root.removeChild(this.node),this.node=null)},l.prototype.dispose=function(){this.clearRepresentation(),this.material&&this.material.dispose()};l.prototype.updateRepresentation=function(e,t){this.previousDimension!==e.dimension&&this.material&&(this.material.dispose(),this.material=null),this.material||(this.material=this.buildMaterial(e)),this.clearRepresentation();var n=this.createMesh(e);this.occurrences=[],n.setMaterial(this.material);var i=null;i=-1===e.clusters?this.createInstancingData(e):this.createInstancingData_cluster(e,t),this.setUpMeshInstancingParameters(n,i.nbInstances,i.matrices,i.colors),n.forceBoundingElements(!0,{box:i.boundingBox}),this.node=n,i.nbInstances>0&&this.root.addChild(n)},l.prototype.createInstancingData=function(t){t=t||{};var n,i,r,o,s=new e.Box3,a=this.computeNbInstances(),l=new Float32Array(16*a),h=new Float32Array(3*a),c=0,u=this.references,p=t.count;if(p){for(this.priorityQueue||(this.priorityQueue=new d),this.priorityQueue.clear(),n=0;n<this.references.length;n++)this.priorityQueue.addNode(this.references[n]);u=[],this.priorityQueue.traverseMax((function(e,t,n){return u.push(e),!(u.length>=p)}))}for(n=0;n<u.length;n++)if((r=u[n]).isAlive())for(o=r.getOccurrences(),i=0;null!==o&&i<o.length;i++)this.fillInstancingData(r,o[i],c,l,h,s,t)&&(this.occurrences.push(o[i]),c++);return{boundingBox:s,nbInstances:a,matrices:l,colors:h}},l.prototype.computeNbInstances=function(){var e,t,n,i=0;for(e=0;e<this.references.length;e++)n=(t=this.references[e]).getOccurrences(),t.isAlive()&&null!==n&&(i+=n.length);return i},l.prototype.buildMaterial=function(t){var n=1===t.dimension?new e.LineBasicMaterial({force:!0,opacity:t.opacity,depthWrite:!1}):new e.MeshBasicMaterial({force:!0,opacity:t.opacity,depthWrite:!1});n.activatePDSFX("PDSFXLDHCandidate");n.setPDSFXVaryings({vCandidateColor:{type:"v3"}});return n.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){const n=e.variableHandler,i=e=>n.vec4(e);return`\n\t\t\t\t    ${i("localPosition")}  = ${i()}(${e.vGetAttribPosition()}, 1.0);\n\t\t\t\t    ${i("newPosition")}  = instanceMatrix*localPosition;\n\t\t\t\t    return newPosition.xyz;\n                `},ComputeVaryingValues:function(e,t){return`\n                    ${n="vCandidateColor",e.getVarying(n)} = instanceColor;\n                `;var n}},{ComputeAlbedo:function(e,t){return`\n                    return ${n="vCandidateColor",e.getVarying(n)};\n                `;var n},ComputeSpecularReflectance:function(e,t){return`\n                    return ${e.variableHandler.vec3(n)}(1.0, 1.0, 1.0);\n                `;var n}}),n},l.prototype.getOccurrencesInXSO=function(e){var t,n,i=e.get(),r=null;for(t=0;t<i.length;t++){var o;if(void 0!==(n=i[t].pathElement).instanceId&&n.getLastElement()===this.node)if(r||(r=[]),o=this.getOccurrenceFromInstanceId(n.instanceId)){var s=o.reference;r.push(o),this.preserveReferences||(this.preserveReferences=[]),-1===this.preserveReferences.indexOf(s)&&this.preserveReferences.push(s)}}return r},l.prototype.getOccurrenceFromInstanceId=function(e){var t=e/5-1;return this.occurrences[t]},l.prototype.getInstanceId=function(e){return 5*(this.occurrences.indexOf(e)+1)},l.prototype.createSelectionRestoringData=function(){return this.preserveReferences=null,[{xso:n,occurrences:this.getOccurrencesInXSO(n)},{xso:i,occurrences:this.getOccurrencesInXSO(i)},{xso:r,occurrences:this.getOccurrencesInXSO(r)}]},l.prototype.restoreSelection=function(e){var t;for(t=0;t<e.length;t++){var n=e[t].xso,i=e[t].occurrences;i&&this.addOccurrencesToXSO(n,i)}},l.prototype.addOccurrencesToXSO=function(e,t){var n,i,r,s;for(n=0;n<t.length;n++)s=null,i=t[n],(r=this.getInstanceId(i))>0?(s=new o([this.root,this.node])).instanceId=r:i instanceof a?i.reference.node&&(s=i.buildPathElement()):(s=new o).setFromOccurrence(i),s&&e.add({pathElement:s})};var h=new e.Matrix4,c=new e.Matrix4,u=new e.Matrix4,p=new e.Matrix4,g=new e.Vector3;function f(e,t){this.center=e.center(),this.bbox=e,this.bbox.applyMatrix4(t),this.matrix=t,this.center.applyMatrix4(t),this.clusterIndex=-1}function m(){this.center=new e.Vector3,this.nodes=[]}l.prototype.fillInstancingData=function(e,t,n,i,r,o,s){var a=e.getBoundingBox();if(!a)return!1;a=a.clone();var d=t.matrix;h.copy(d),g.set(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z),u.identity(),p.identity(),u.translate(a.min),p.scale(g),h.multiplyMatrices(u,p),c.multiplyMatrices(d,h);var l,f=16*n,m=c.elements;for(l=0;l<16;l++)i[f+l]=m[l];var v=s.color.r,S=s.color.g,y=s.color.b;return r[f=3*n]=v,r[f+1]=S,r[f+2]=y,a.applyMatrix4(d),o.expandByPoint(a.min),o.expandByPoint(a.max),!0},l.prototype.getReferenceFromOccurrence=function(e){var t,n,i,r,o=0;for(t=0;t<this.references.length;t++)if((i=this.references[t]).isAlive())for(r=i.getOccurrences(),n=0;null!==r&&n<r.length;n++){if(this.occurrences[o]===e)return i.referenceId;o++}},l.prototype.setUpMeshInstancingParameters=function(e,t,n,i){var r={data:n,type:"m4",attribName:"instanceMatrix",isFlattened:!0},o={data:i,type:"v3",attribName:"instanceColor",isFlattened:!0};e.setInstancingParameters(t,[r,o])},f.prototype.selectCluster=function(e){var t,n,i=1/0,r=-1;for(t=0;t<e.length;t++)(n=e[t].center.distanceTo(this.center))<i&&(r=t,i=n);return r},window.myRnd=[];var v=void 0,S=0;function y(){var e;return void 0===v&&(v=window.WUXLDH_RndTable?window.WUXLDH_RndTable:null),v?(e=v[S],S=(S+1)%v.length,e):(e=Math.random(),window.myRnd.push(e),e)}return m.prototype.randomize=function(e){this.center.set(e.min.x+y()*(e.max.x-e.min.x),e.min.y+y()*(e.max.y-e.min.y),e.min.z+y()*(e.max.z-e.min.z))},m.prototype.resetNodes=function(){this.nodes=[]},m.prototype.updateCenter=function(){var e,t=this.nodes,n=this.center;if(t.length>0){for(n.set(0,0,0),e=0;e<t.length;e++)n.addVectors(n,t[e].center);n.multiplyScalar(1/t.length)}},m.prototype.buildBoundingBox=function(){var t,n,i=new e.Box3;for(t=0;t<this.nodes.length;t++)n=this.nodes[t],i.union(n.bbox);return i},l.prototype.createClusterData=function(e,t,n){var i=e.getBoundingBox(),r=t.matrix,o=new f(i.clone(),r);return o&&!o.bbox.containsPoint(n)?o:null},l.prototype.fillInstancingData_cluster=function(e,t,n,i,r,o,s,a){c.identity();var d=e.buildBoundingBox();if(d.containsPoint(a))return 0;s.union(d),d.size(t),c.scale(t),c.setPosition(d.min);var l,h=16*n,u=c.elements;for(l=0;l<16;l++)i[h+l]=u[l];var p=o.color.r,g=o.color.g,f=o.color.b;return r[h=3*n]=p,r[h+1]=g,r[h+2]=f,1},l.prototype.createInstancingData_cluster=function(t,n){var i,r,o=this.createClusters(t,n),s=new e.Box3,a=o.length,d=0,l=new Float32Array(16*a),h=new Float32Array(3*a),c=new e.Vector3(s.max.x-s.min.x,s.max.y-s.min.y,s.max.z-s.min.z);for(c.multiplyScalar(.02),c.set(100,100,100),i=0;i<o.length;i++)r=o[i],d+=this.fillInstancingData_cluster(r,c,d,l,h,t,s,n);return{boundingBox:s,nbInstances:a=d,matrices:l,colors:h}},l.prototype.createClusters=function(t,n){var i,r,o,s,a=[];for(i=0;i<this.references.length;i++)if((o=this.references[i]).isAlive())for(s=o.isSlave()?o.node._occurrences:o._occurrences,r=0;r<s.length;r++)(c=this.createClusterData(o,s[r],n))&&a.push(c);var d=new e.Box3;for(i=0;i<a.length;i++)d.expandByPoint(a[i].center);var l,h,c,u=t.clusters,p=this.lastClusters;if(!p||0===p.length&&a.length>0)for(p=[],i=0;i<u;i++)(l=new m).randomize(d),p.push(l);else for(i=0;i<p.length;i++)(l=p[i]).resetNodes();for(i=0;i<a.length;i++)p[h=(c=a[i]).selectCluster(p)].nodes.push(c),c.clusterIndex=h;for(var g=!!this.lastClusters;!g;){for(g=!0,i=0;i<p.length;i++)(l=p[i]).updateCenter(),l.nodes.length=0;for(i=0;i<a.length;i++)p[h=(c=a[i]).selectCluster(p)].nodes.push(c),c.clusterIndex!==h&&(g=!1,c.clusterIndex=h)}var f=[];for(i=0;i<p.length;i++)p[i].nodes.length>0&&f.push(p[i]);return this.lastClusters=f,f},l.prototype.clearClusters=function(){this.lastClusters=null},l})),define("DS/3DXMTiles/Default360ContentManager",["DS/3DXMTiles/OOCTilesCustomContentManager","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture"],(function(e,t,n,i){"use strict";var r={canvasNodeTexture:null,createNode:function({uri:e,tileSet:r,parentNode:o}){this.canvasNodeTexture||(this.canvasNodeTexture=new i({width:10,height:10,drawCB:this.drawCanvasCB,alphaTest:.02}));var s=t.createCanvas2DNode({canvasNodeTexture:this.canvasNodeTexture,hotspot:new n.Vector2(25,25)});o.addChild(s)},removeNode:function({uri:e,tileSet:t,parentNode:n}){n.removeChildren()},drawCanvasCB:function(e,t){var n=e.width,i=e.height;t.fillStyle="red",t.fillRect(0,0,n,i)}},o=-1;function s(){return-1===o&&(o=window.OOC360RedDots?1:0),1===o}return new e({type:"360",displayRedDots:-1,createNodeCB:function({uri:e,tileSet:t,parentNode:n}){s()&&r.createNode({uri:e,tileSet:t,parentNode:n})},removeNodeCB:function({uri:e,tileSet:t,parentNode:n}){s()&&r.removeNodeCB({uri:e,tileSet:t,parentNode:n})},needsSgNodePerContentCB:function(){return s()}})})),define("DS/3DXMTiles/LDHCandidateQueueRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/3DXMTiles/LDHCandidateListRenderer","DS/3DXMTiles/LDHOccurrence","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHReference","DS/Visualization/MaterialApplication"],(function(e,t,n,i,r,o,s,a,d){"use strict";var l=function(t,i){this.manager=t,this.viewer=t.viewer,this.root=i||new n("CandidateQueueRenderer"),this.root.setRenderPasses(["main"]),this.viewer.addNode(this.root),this.displayIntermediateReferences=!1,this.preserveReferences=null,this.preserveSelection=!1,this.pickable=s.PICKABLE,this.attributes=[new h({dimension:2,color:new e.Color("red"),opacity:.1}),new h({dimension:1,color:new e.Color("black"),opacity:1})],this.repMaterial=null,this.repMaterialApplication=null,this.candidateListRenderers=[new r(this.root),new r(this.root)]};l.prototype.setPickable=function(e,t,n){this.pickable=e,this.root.setPickable(e),!t&&this.manager.isSlave()&&(this.removeSlaveBoxes(),this.displaySlaveBoxes(n))},l.prototype.setParams=function(e){e=e||{},this.repMaterial=null,this.repMaterialApplication=null,this.displayIntermediateReferences=!!e.displayIntermediateReferences,e.repRefAttributes&&this.attributes[0].setParams(e.repRefAttributes),e.refAttributes&&this.attributes[1].setParams(e.refAttributes)},l.prototype.dispose=function(){var e;for(e=0;e<this.candidateListRenderers.length;e++)this.candidateListRenderers[e].dispose();this.root=null},l.prototype.addNodeList=function(e,t,n){var i,r;for(i=0;i<e.length;i++)r=e[i],this.shouldDisplayReference(r,n)&&t.references.push(r)},l.prototype.shouldDisplayReference=function(e,t){var n=e.getNode();if(1===e.handler.type&&e.isRoot)return!0;if(a.slaveBoxFix){if(!n&&e.getLODValue(t)>0)return!0}else if((!n||e.isSlave()&&0===n.children.length)&&e.getLODValue(t)>0)return!0;return!!(this.preserveReferences&&this.preserveReferences.indexOf(e)>=0)},l.prototype.getNodesFromQueue=function(e,t){var n,i,r=[];for(n=0;n<e.nodes.length;n++)i=e.nodes[n],t?0===i.children.length&&r.push(i):i.isLoaded()||r.push(i);return r},l.prototype.getCandidateRoots=function(){return this.manager.getCandidateRoots()},l.prototype.updateRepresentation=function(e,t){var n=this.manager;if(!a.slaveBoxFix||n.isOOC()){var i,r,o,s=[];for(i=0;i<this.candidateListRenderers.length;i++)-1===(o=this.attributes[i]).clusters&&(r=this.candidateListRenderers[i],this.preserveSelection?s.push(r.createSelectionRestoringData()):s.push(null),r.references=[]);for(i=0;i<this.candidateListRenderers.length;i++){if(o=this.attributes[i],r=this.candidateListRenderers[i],this.displayIntermediateReferences||0===i){var d=n.queues[i],l=0===i?this.getNodesFromQueue(d,1===i):this.getCandidateRoots();this.addNodeList(l,r,t),r.updateRepresentation(o,e)}-1===o.clusters&&s[i]&&r.restoreSelection(s[i])}}},l.prototype.getPathFromPathElement=function(e){var t,n;for(t=0;t<this.candidateListRenderers.length;t++)if(n=this.candidateListRenderers[t],e.externalPath.indexOf(n.node)>=0){var i=n.getOccurrenceFromInstanceId(e.instanceId),r=null;if(i&&i instanceof o)for(r=[];i;)r.unshift(i.reference.referenceId),i.parent&&r.unshift(i.instanceData.instanceId),i=i.parent;return r}return null},l.prototype.getReferenceFromPathElement=function(e){var t,n;for(t=0;t<this.candidateListRenderers.length;t++)if(n=this.candidateListRenderers[t],e.externalPath.indexOf(n.node)>=0){var i=n.getOccurrenceFromInstanceId(e.instanceId);if(i)return i instanceof o?i.reference.referenceId:n.getReferenceFromOccurrence(i)}return null},l.prototype.clearClusters=function(){var e;for(e=0;e<this.candidateListRenderers.length;e++)this.candidateListRenderers[e].clearClusters()},l.prototype.displaySlaveBoxes=function(e){var t,n,i=this.manager,r=this.getNodesFromQueue(i.queues[0],!1);for(t=0;t<r.length;t++)(n=r[t]).getLODValue(e)>0&&n.displayBox(i)},l.prototype.removeSlaveBoxes=function(){var e,t=this.manager,n=t.queues[0].nodes;for(e=0;e<n.length;e++)n[e].removeBox(t)},l.prototype.getRepMaterial=function(){var t;return null===this.repMaterial&&(t=this.attributes[0],this.repMaterial=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,transparent:t.opacity<1,force:!0})),this.repMaterial},l.prototype.getRepMaterialApplication=function(){return null===this.repMaterialApplication&&(this.repMaterialApplication=new d({faceMaterial:this.getRepMaterial(),layer:-1/0})),this.repMaterialApplication};var h=function(e){this.color=e.color.clone(),this.opacity=e.opacity,this.dimension=e.dimension,this.clusters=e.clusters||-1,this.count=e.count||0};return h.prototype.setParams=function(e){e.color&&(this.color=e.color.clone()),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.dimension&&(this.dimension=e.dimension),void 0!==e.clusters&&(this.clusters=e.clusters||-1),void 0!==e.count&&(this.count=e.count||0)},l})),define("DS/3DXMTiles/DSTilesVolumeContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/DSTilesModelLoader","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/VolumeRenderingManagerSimple"],(function(e,t,n,i,r,o,s,a){"use strict";var d=function(t){if(t=t||{},e.call(this,t),this.buildUrlCB=t.buildUrlCB,this.viewer=t.viewer||debugWebGLV6Viewer,this.volumeManager=null,this.fromCGR=!1,this.needUpdateMetaData=!0,this.tileSet=null,this.contentMetaDataVersion=0,this.viewer){var n=this.viewer.getEffect("VolumeRendering");this.volumeManager=n?n.volumeManager:null}};(d.prototype=Object.create(e.prototype)).getBudgetParams=function(){return{name:"volume",physicalBudget:"gpu",params:{}}},d.prototype.onContentMetaDataUpdate=function(e){this.updateEffect(e.tileSet)},d.prototype.updateEffect=function(e){if(!this.volumeManager){this.viewer.renderer.setEffect("VolumeRendering",!0);let e=this.viewer.getEffect("VolumeRendering");this.volumeManager=new a(this.viewer),e.volumeManager=this.volumeManager,d._dbgNoAttenuation||(e.setAttenuation(.001),e.setAttenuationScale(.001))}if(this.tileSet!==e||this.contentMetaDataVersion!==e.contentMetaDataVersion){this.contentMetaDataVersion=e.contentMetaDataVersion;var t=e.contentMetaData&&e.contentMetaData.volume,n=this.volumeManager;this.tileSet=e;let r=e.getRootNode().getContentFromContentLoader(this);if(i=r.metaData&&r.metaData.range){var i=[parseFloat(i[0]),parseFloat(i[1])];n.setTileSetRange(i)}t&&t.displayRange&&(this.volumeManager.setMinValue(parseFloat(t.displayRange[0])),this.volumeManager.setMaxValue(parseFloat(t.displayRange[1]))),t&&t.transferFunction&&this.volumeManager.updateTransferFunctionRaw(t.transferFunction),t&&t.colorMap&&this.volumeManager.setColorMapRaw(t.colorMap)}},d.prototype.isReady=function(){return n.isReady()},d.prototype.isNodeVisible=function(e,t){var n=e.tileSet;this.updateEffect(n);var i=t.metaData&&t.metaData.range;return!i||!!this.volumeManager.isRangeVisible({min:i[0],max:i[1]})},d.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},d.prototype.loadContentFromBuffer=function({data:e,node:t,content:i,onLoadedCB:r,onErrorCB:o,params:s}){var a=t.queue,d=new l(t,i,a),h=t.tileSet;this.updateEffect(h),"3dxc"!==i.getFormat()&&(this.fromCGR=!0),n.loadFromBuffer(e,d.targetSGNode,i.getFormat(),this.onModelLoaded.bind(this,d,r),this.onModelError.bind(this,d,o))},d.prototype.onModelLoaded=function(e,t){e.node,e.queue;(e.content.setContentToken(e),e.computeMemorySize(),this.volumeManager)&&this.volumeManager.getVolumeData(e,this.fromCGR);t()},d.prototype.onModelError=function(e,t){e.node,e.queue;t()},d.prototype.computeMemorySize=function(e){return new t(0,0)},d.prototype.showContent=function(e,t){let n=t.contentToken;if(n){if(this.volumeManager){n.node;var i=n.data.valueRange;if(i&&!this.volumeManager.isRangeVisible(i))return}if(this.volumeManager&&n.data)this.volumeManager.addChunk(n)&&0}},d.prototype.hideContent=function(e,t){let n=t.contentToken;n&&(this.volumeManager&&this.volumeManager.removeChunk(n)&&0)},d.prototype.deleteContent=function(e,t,n){},d.prototype.exportContent=function(e,t){return null},d._dbgNoAttenuation=!1;var l=function(e,t,n){this.node=e,this.content=t,this.queue=n,this.targetSGNode=new i,this.nodes=[],this.visible=!1,this.memorySize=null};return l.prototype.computeMemorySize=function(){this.memorySize=new t(0,0)},d})),define("DS/3DXMTiles/OOCTileSet",["DS/3DXMTiles/DSTilesForceLoadTransaction","DS/Visualization/PathElement"],(function(e,t){"use strict";return class{constructor(e,t){this._tileSet=e,this.oocManager=t,this.override=null}forceLoadTraverse({onExploreCB:t,onLoadedCB:n,requestBoundingBox:i}){var r=new e({tileSet:this._tileSet,onExploreCB:t,onLoadedCB:n,requestBoundingBox:i});this._tileSet.addForceLoadTransaction(r),this.oocManager._ldhNodeManager.requestUpdate(!1,!1)}unlockNodeUnload(e){this._getDSTilesNode(e).unlockUnload()}getWorldBoundingSphere(){return this._getRoot().getOccurrencesWorldBoundingSphere()}updateContentMetaData(e){this._tileSet.updateContentMetaData(e),this.oocManager._ldhNodeManager.requestUpdate(!0)}setOpacity(e){var n=this._tileSet.getRootNode().getSgNode();if(!this.override){var i=n.createOverrideSetManager(),r=i.createSceneGraphOverrideSet();this.override=r.createOverride(new t([n])),i.pushSceneGraphOverrideSet(r)}this.override.setOpacity(e)}setVisibility(e){this._tileSet.setVisibility(e)}setVisibilityFree(e){this._tileSet.setVisibilityFree(e)}getUnitValue(){return this._tileSet.getUnitValue()}refreshWorldMatrix(){this._getDSTilesNode(this._tileSet.rootURI).setMatrixUpdate(!0),this.oocManager._updateBoundingSphere(),this.oocManager._ldhNodeManager.requestUpdate(!0,!0)}getUserData(){return this._tileSet.userData}getContentTypes(){return this._tileSet.contentTypes}hasType(e){return!!(this._tileSet.contentTypes&&this._tileSet.contentTypes.indexOf(e)>=0)}getCRS(){return this._tileSet.crs}getUnitScale(){return this._tileSet.unitScale}setPauseLoading(e,t){this._tileSet.setPauseLoading(e,t,this.oocManager._ldhNodeManager)}registerOnStartLoadingCB(e){return this._tileSet.registerOnStartLoadingCB(e)}unregisterOnStartLoadingCB(e){this._tileSet.unregisterOnStartLoadingCB(e)}registerOnEndLoadingCB(e){return this._tileSet.registerOnEndLoadingCB(e)}unregisterOnEndLoadingCB(e){this._tileSet.unregisterOnEndLoadingCB(e)}getTileUserData(e){var t=this._getDSTilesNode(e);if(!t)return null;var n=null;return t&&(n=t.userData),n}getTileWorldMatrices(e){let t=this._getDSTilesNode(e);if(!t)return null;t.updateWorldMatrix();let n,i=[];for(n=0;n<t.worldPosition.matrixArray.length;n++){let e=t.worldPosition.matrixArray[n];i.push(e?e.clone():null)}return i}getTileContentUrl(e,t){let n=this._getDSTilesNode(e);if(!n)return null;let i=n.getSourceWithContents(t),r=i&&(1===i.contents.length?i.contents[0]:null);if(r){let e=r.getUri(t),i=n&&n.tileSet.getContentSource(t);return i&&i.buildContentURL(e)}return null}getTileContentSpec(e){let t=this._getDSTilesNode(e);return t?t.getContentSpec():null}getTileContentMetaData(e){let t=this._getDSTilesNode(e);return t&&t.contentSet&&1===t.contentSet.contents.length?t.metaData_deprecated:null}getTileBoundingSphere(e){let t=this._getDSTilesNode(e),n=t&&t.getBoundingSphere();return n&&n.clone()}getTileBoundingBox(e){let t=this._getDSTilesNode(e),n=t&&t.getBoundingBox();return n&&n.clone()}setStyling({json:e}){let t=this._tileSet.setStyling(e);return this.oocManager._ldhNodeManager.requestUpdate(!0),t}getAvailableAttributes(){let e=[],t=this._tileSet;return t.availableAttributesMap&&t.availableAttributesMap.forEach(((t,n)=>{e.push({name:n,type:t.type||null,userData:t.userData||null})})),e}setAvailableAttribute({name:e,type:t,userData:n}){this._tileSet.availableAttributesMap.set(e,{name:e,type:t,userData:n})}getRootURI(){return this._tileSet.rootURI}_getDSTilesNode(e){return this._tileSet.getTile(e)}_getRoot(){return this._getDSTilesNode(this._tileSet.rootURI)}}})),define("DS/3DXMTiles/DSTilesStdExpander",["DS/3DXMTiles/DSTilesExpander","DS/3DXMTiles/DSTilesNode","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesContentSet","DS/3DXMTiles/DSTilesMeshContentLoader","DS/3DXMTiles/DSTilesR2VPointCloudContentLoader","DS/3DXMTiles/DSTilesGaussianCloudContentLoader","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/DSTilesVolumeContentLoader","DS/3DXMTiles/DSTilesTerrainContentLoader","DS/3DXMTiles/DSTilesTileSetContentLoader","DS/3DXMTiles/DSTilesInstancingContentLoader"],(function(e,t,n,i,r,o,s,a,d,l,h,c){"use strict";var u=function(e){this.tilesManager=e.tilesManager,this.contentLoaderMap=new Map,this.createContentLoaders(),this.buildUrlCB=e.buildUrlCB||null,this.scoreComputer=e.scoreComputer,this._dbg_onLoadedNodeCB=e._dbg_onLoadedNodeCB,this.nbTickets=20,this.jsonPreprocessCB=e.jsonPreprocessCB||null,this.worldMatrixMap=new WeakMap};return(u.prototype=Object.create(e.prototype)).init=function(){this.contentLoaderMap.forEach((e=>{e.init()}))},u.prototype.createContentLoaders=function(){this.contentLoaderMap.set("mesh",new r({tilesManager:this.tilesManager})),this.contentLoaderMap.set("pointCloud",new o({tilesManager:this.tilesManager})),this.contentLoaderMap.set("gaussianCloud",new s({tilesManager:this.tilesManager})),this.contentLoaderMap.set("volume",new d({tilesManager:this.tilesManager})),this.contentLoaderMap.set("terrain",new l({tilesManager:this.tilesManager})),this.contentLoaderMap.set("tileSet",new h({tilesManager:this.tilesManager})),this.contentLoaderMap.set("instancedMesh",new c({tilesManager:this.tilesManager}))},u.prototype.isReady=function(){return this.nbTickets>0},u.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},u.prototype.getContentLoader=function(e){var t=this.contentLoaderMap.get(e)||null,n=null;return t||(n=this.tilesManager.getCustomContentManager(e))&&(t=n._getContentLoader(this.tilesManager)),t},u.prototype.expandNow=function(e){if(!e.isAlive())return!0;var t=e.queue,n=e.queue.queueSet,i=e.tileSet,r=e.childrenURIs,o=[],s=[];let d;for(d=0;d<r.length;d++){let t=e.childrenEtags&&e.childrenEtags[d];var l=this.createNodeFromPreloaded(e,r[d],t,n,i,s);if(!l)return!1;o.push(l)}return function(){var n,i,r;for(e.tileSet.addNode(e),n=0;n<o.length;n++)(i=o[n]).tileSet.addNode(i),e.addChild(i),i.children&&i.children.length>0&&i.setExpandStatus(a.loaded,t),t.registerDSTilesNode(i);for(n=0;n<s.length;n++)(r=s[n]).tileSet.addNode(s[n]),r.children&&r.children.length>0?r.setExpandStatus(a.loaded,t):t.registerDSTilesNode(r)}(),!0},u.prototype.createNodeFromPreloaded=function(e,t,n,i,r,o){if(r.hasPreloadedNode(t,n)){var s=r.getPreloadedNodeJSON(t);if(s)return this.createNodeFromJSON(s,e,t,i,r,o)}return null},u.prototype.createNodeFromJSON=function(e,r,o,s,a,d){var l,h=null,c=null,u=1/0,p=null,g=[];if(e.children)for(l=0;l<e.children.length;l++)g.push(e.children[l]);var f=null;if(e.matrix)(p=new n.Matrix4).setFromJSON(e.matrix);else if(e.worldMatrix){var m=null;if((m=new n.Matrix4).setFromJSON(e.worldMatrix),f=m.clone(),r){var v=this.worldMatrixMap.get(r)||null;if(r.updateWorldMatrix(),v){var S=new n.Matrix4;S.getInverse(v),m.multiplyMatrices(S,m)}}p=m}var y=e.boundingVolume;y&&(y.sphere&&(h=new n.Sphere).setFromJSON(y.sphere),y.box&&(c=new n.Box3).setFromJSON(y.box));var M=e.triggerCondition,D=null;M&&(M.hasOwnProperty("geometricalError")?(u=parseFloat(M.geometricalError),D="pixelError"):M.hasOwnProperty("distanceToBox")&&(u=parseFloat(M.distanceToBox),D="distanceToBox"));var T=null;if(null===(T="add"===e.mode||"ADD"==e.mode?t.Mode.addLOD:"replace"==e.mode?t.Mode.replaceLOD:r?r.mode:t.Mode.replaceLOD))throw new Error("mode is mandatory");e.content&&"POINTCLOUD"===e.content.type&&(e.content.type="pointCloud");var C=i.create(e.content,this,e.contentMetaData||null);if(C){let e=C.contents[0];e&&"string"==typeof e.format&&"r2v_fulllod"===e.format.toLowerCase()&&(a.r2vFullLOD=!0)}var b=s.getQueueFromTileSet(a),L=new t({uri:o,tileSet:a,expander:this,childrenURIs:g,childrenEtags:e.childrenEtags,scoreComputer:this.scoreComputer,matrix:p&&!p.isIdentity()?p:null,geometricalError:u,boundingBox:c,boundingSphere:h,contentSet:C,mode:T,queue:b,userData:e.userData,metaData_deprecated:e.contentMetaData,triggerMetric:D});return L.setMatrixUpdate(!0),f&&this.worldMatrixMap.set(L,f),d&&this.completeNodeChildrenIfPossible(L,s,a,b,d),L},u.prototype.completeNodeChildrenIfPossible=function(e,t,n,i,r){var o,s=!1;for(o=0;e.childrenURIs&&o<e.childrenURIs.length&&!s;o++){let t=e.childrenEtags&&e.childrenEtags[o];n.hasPreloadedNode(e.childrenURIs[o],t)||(s=!0)}if(!s){var a,d,l;for(o=0;e.childrenURIs&&o<e.childrenURIs.length&&!s;o++)l=e.childrenURIs[o],a=n.getPreloadedNodeJSON(l),d=this.createNodeFromJSON(a,e,l,t,n,r),r.push(d),e.addChild(d);e.children||(e.children=[])}},u.prototype.setSplattingParameters=function(e){this.getContentLoader("pointCloud").setSplattingParameters(e)},u})),define("DS/3DXMTiles/DSTilesTileSet",["DS/3DXMTiles/OOCTileSet","DS/WAFData/WAFData","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/DSTilesContentSource","DS/3DXMTiles/ModelBank","DS/QualityManager/QMController","DS/3DXMTiles/DSTilesStyling","DS/3DXMTiles/ParsingStatus","DS/Visualization/SceneGraphUtils","DS/3DXMTiles/DSTilesQueue"],(function(e,t,n,i,r,o,s,a,d,l){"use strict";class h{constructor(t,n){var i=t.ldhNodeManager.oocManager;this.tilesManager=t,this.rootURI=n.rootURI||null,this.rootEtag=n.rootEtag||null,this.baseTileURL=n.baseTileURL||null,this.tileExtension=n.tilesExtension||null,this.loginURL=n.loginURL||null,this.urlPostfix=n.urlPostFix||n.urlPostfix||null,this.tileURLPostfix=n.tileURLPostfix||null,this.infoURL=n.infoURL||null,this.tileBatchingURL=n.tileBatchingURL||null,this.unit=n.unit||null,this.jsonPreprocessCB=n.jsonPreprocessCB||null,this.preloadedTileMap=new Map,this.nodeMap=new Map,this.oocTileSet=new e(this,i),this.contentMetaData=n.contentMetaData||null,this.contentMetaDataVersion=0,this.forceLoadTransactions=[],this.contentTypes=n.contentTypes||null;let r=null;if((this.contentTypes?this.contentTypes.indexOf("pointCloud"):-1)>=0&&(r=t.expander.getContentLoader("pointCloud")),this.pointCloudContentLoader=r,this.userData=n.userData||null,this.crs=n.crs||null,this.availableAttributesMap=this.createAvailableAttributesMap(n.availableAttributes),this.styling=null,n.styling&&this.setStyling(n.styling),n.contentSources?this.contentSources=this.buildContentSources(n.contentSources):this.contentSources=this.buildContentSources({default:n}),this.baseMaxPixelError=window.WUXDefaultTileSetMaxPixelError||5,this.maxPixelErrorFactor=1,this.progressiveMode=!0,n.unit){var s=i._computeUnitValue(n.unit);this.unitScale=s/i.getUnitValue(),this.unit=s}else this.unitScale=1,this.unit=-1;this.sortingMetric=n.sortingMetric||"screenRadius",this.contentTickets=6,this.currentExpandBatch=new u,this.expandTickets=6,this.info={maxTileBatchSize:1,maxContentBatchSize:1},this.nbLoading=0,this.nbExpanding=0,this.ghostMode=!1,this.loadingStatus=!1,this.onStartLoadingCallbacks=new Map,this.onEndLoadingCallbacks=new Map,this.nodeSourceLoadingStatus=new WeakMap,this.contentLoaders=new Map,this.visibility=!0,this.fileSizeBudget=1/0,this.pauseLoading=null,this.updateBankTimeout=!1,this.r2vFullLOD=!1,this.useBank=o.getLocalCache(),this.useBankForContentLock=0,this.useBankForTiles=!(!window.OOCUseBankForTilesTree&&"ON"!==window.localStorage.getItem("OOCUseBankForTilesTree"))}static setFileSizeBudget(e){this.fileSizeBudget=e||1/0}buildContentSources(e){var t,n={};for(t in e)n[t]=new i(t,e[t],this,h);return n}hasPreloadedNode(e,t){let n=this.preloadedTileMap.get(e);return!!n&&(!n.fromBank||!(!t||n.etag!==t))}getPreloadedNodeJSON(e){let t=this.preloadedTileMap.get(e);return t&&t.json}getContentSource(e){return e=e||"default",this.contentSources[e]||null}getTile(e){return this.nodeMap.get(e)||null}getUnitValue(){return this.unit>0?this.unit:this.oocTileSet.oocManager.getUnitValue()}getSortingMetric(){return this.sortingMetric}getTriggerMetric(){return this.triggerMetric}removeNode(e){var t=this.nodeMap.get(e);if(t){var n=t.contentLoaders;if(n){let e;for(e=0;e<n.length;e++){let t=n[e];var i=this.contentLoaders.get(t)||0;0===--i?this.contentLoaders.delete(t):this.contentLoaders.set(t,i)}}}this.nodeMap.delete(e)}getContentLoaders(){var e=[];return this.contentLoaders.forEach(((t,n,i)=>{e.push(n)})),e}getMaxContentBatchSize(){return this.info.maxContentBatchSize}getMaxExpandBatchSize(){return this.info.maxTileBatchSize}dispose(){this.preloadedTileMap=new Map,this.nodeMap=new Map,this.oocTileSet=null}buildTileURL(e){var t=e;return this.baseTileURL&&(t=this.baseTileURL+t),this.tileExtension&&(t+=this.tileExtension),this.tileURLPostfix&&(t+=this.tileURLPostfix),this.urlPostfix&&(t+=this.urlPostfix),t}addNode(e){this.nodeMap.set(e.uri,e);var t=e.contentLoaders;if(t){let e;for(e=0;e<t.length;e++){let i=t[e];if(i){var n=this.contentLoaders.get(i)||0;n++,this.contentLoaders.set(i,n)}}}}getRootNode(){return this.nodeMap.get(this.rootURI)}canLoadContent(){return this.contentTickets>0}onSourceLoaded(e){var t=this.nodeSourceLoadingStatus.get(e);t.count--,0===t.count&&(this.nodeSourceLoadingStatus.delete(e),t.error?e.queue.onNodeLoadError(e):e.queue.onNodeLoaded(e))}onSourceError(e){var t=this.nodeSourceLoadingStatus.get(e);t.count--,t.error=!0,0===t.count&&(this.nodeSourceLoadingStatus.delete(e),e.queue.onNodeLoadError(e))}getNbContents(e){let t,n=0;for(t=0;t<e.length;t++)n+=e[t].contents.length;return n}loadTileContent(e){var t,i=e.getSourcesWithContents();if(i.length>0)for(this.nodeSourceLoadingStatus.set(e,new c(this.getNbContents(i))),t=0;t<i.length;t++){var r=this.contentSources[i[t].sourceId];let n,o=i[t].contents,s=i[t].sourceParams;for(n=0;n<o.length;n++)r.loadTileContent(e,o[n],s[n],this.onSourceLoaded.bind(this),this.onSourceError.bind(this),null)}else this.nodeSourceLoadingStatus.set(e,new c(1)),e.setContentStatus(n.loading,e.queue),setTimeout((()=>{let t=e.contentSet.contents[0];t.contentLoader.loadContentFromBuffer({data:null,node:e,content:t,onLoadedCB:this.onSourceLoaded.bind(this,e),onErrorCB:this.onSourceError.bind(this,e),updateContent:!1})}),0)}updateNodeContent(e,t){let i=e.node,r=e.content,o=e.onUpdatedCB,s=i.getSourcesWithContents([r]),a=0,d=this.oocTileSet.oocManager._ldhNodeManager;function l(e){if(a--,a<=0){t.nbLoading--,e.setContentStatus(n.loaded,e.queue),o();var i=new Set;t.loadUpdatedContent(i),i.forEach((e=>{e.flushLoadTileContent()})),d.requestUpdate(!1)}}var h;for(t.nbLoading++,h=0;h<s.length;h++){var c=this.contentSources[s[h].sourceId];let t,n=s[h].contents,r=s[h].sourceParams;for(t=0;t<n.length;t++)a++,c.loadTileContent(i,n[t],r[t],l,l,e)}a<=0&&(o(),d.requestUpdate(!1))}flushLoadTileContent(){var e;for(e in this.contentSources)this.contentSources[e].flushLoadTileContent()}canExpand(){return this.expandTickets>0}expandTile(e){var t=e.expander,i=e.queue;if(e.setExpandStatus(n.loading,i),this.tileBatchingURL){if(!this.currentExpandBatch.tryToAdd(e,this.getMaxExpandBatchSize(),this,!1)){var r=this.currentExpandBatch;this.expandBatch(r),this.currentExpandBatch=new u,this.currentExpandBatch.tryToAdd(e,this.getMaxExpandBatchSize(),this,!0)}}else e.childrenURIs?(this.expandTickets--,this.downloadTilesJSON(e.childrenURIs,e.childrenEtags,(()=>{this.expandTickets++,t.expandNow(e)?i.onNodeExpanded(e):i.onNodeExpandError(e)}))):i.onNodeExpanded(e)}expandBatch(e){var t=e.childrenURIs;function n(){var t;for(t=0;t<e.nodes.length;t++){var n=e.nodes[t],i=n.expander,r=n.queue;i.expandNow(n)?r.onNodeExpanded(n):r.onNodeExpandError(n)}}this.expandTickets--,t.length>0?this.downloadPerBatch(e.childrenURIs,e.etags,(()=>{this.expandTickets++,n()})):setTimeout((()=>{this.expandTickets++,n()}),0)}downloadTilesJSON(e,t,n){if(this.tileBatchingURL){var i=e.length;function a(e){0===(i-=e)&&n()}var r,o=this.getMaxExpandBatchSize();for(r=0;r<i;r+=o){var s=e.slice(r,r+o);let d=t&&t.slice(r,r+o);this.downloadPerBatch(s,d,a.bind(null,s.length))}}else this.downloadTilesOneByOne(e,t,n)}downloadPerBatch(e,n,i){e.length;var r=this.tileBatchingURL,o=null;h.ODTWAFData&&h.ODTWAFData.tile_multi&&(o=t,t=h.ODTWAFData.tile_multi),t.authenticatedRequest(r,{cors:!0,timeout:36e5,method:"POST",data:JSON.stringify(e),async:!0,headers:{"Content-Type":"application/json"},onComplete:(e,t)=>{var n=JSON.parse(e);this.registerTileJSON(n),i()},onFailure:()=>{i()}}),o&&(t=o)}downloadTilesOneByOne(e,t,n){var i,r,o,s,a=e.length;function d(){0===--a&&n()}for(i=0;i<e.length;i++)o=e[i],s=t&&t[i],this.hasPreloadedNode(o,s)?setTimeout(d,0):(r=this.buildTileURL(o),this.downloadTile(r,d,o))}downloadTile(e,n,i){let r=null;h.ODTWAFData&&h.ODTWAFData.tile_single&&(r=t,t=h.ODTWAFData.tile_single),t.authenticatedRequest(e,{timeout:36e5,onComplete:e=>{var t=JSON.parse(e);this.registerTileJSON(t),n()},onFailure:e=>{n()}}),r&&(t=r)}registerTileJSON(e,t){void 0===e.length&&(e=[e]);let n=!1;for(let i=0;i<e.length;i++){let r=e[i].etag;r&&(n=!0),this.preloadedTileMap.set(e[i].uri,{json:e[i].json,etag:r||null,fromBank:t})}this.useBankForTiles&&this.useBank&&n&&!t&&!this.updateBankTimeout&&(this.updateBankTimeout=!0,setTimeout((()=>{this.updateBankTimeout=!1;let e=this.buildTileURL(this.rootURI),t=[];this.preloadedTileMap.forEach(((e,n)=>{e.etag&&t.push({uri:n,json:e.json,etag:e.etag})}));let n=JSON.stringify(t);r.storeTileData([e],[n],[1])}),2e3))}flushExpandTile(){this.currentExpandBatch.nodes.length>0&&(this.expandBatch(this.currentExpandBatch),this.currentExpandBatch=new u)}async init(){await this.getInfo(),await this.login(),await this.initPreloadedTilesFromBank()}getInfo(){return this.infoURL?new Promise(((e,n)=>{t.authenticatedRequest(this.infoURL,{cors:!0,timeout:36e5,method:"GET",onComplete:(t,n)=>{var i,r=JSON.parse(t);r&&r.maxTileBatchSize&&(i=parseFloat(r.maxTileBatchSize),isFinite(i)&&(this.info.maxTileBatchSize=i)),r&&r.maxContentBatchSize&&(i=parseFloat(r.maxContentBatchSize),isFinite(i)&&(this.info.maxContentBatchSize=i)),e()},onFailure:()=>{console.log("Login error"),n()}})})):Promise.resolve(!0)}login(){return this.loginURL?new Promise(((e,n)=>{t.authenticatedRequest(this.loginURL,{cors:!0,timeout:36e5,method:"GET",onComplete:(t,n)=>{e()},onFailure:()=>{console.log("Login error"),n()}})})):Promise.resolve(!0)}initPreloadedTilesFromBank(){let e=this.buildTileURL(this.rootURI);return this.useBank&&r.hasTileData(e,1)?new Promise(((t,n)=>{r.retrieveTileData([e],((e,n)=>{try{let e,t=JSON.parse(n);for(e=0;e<t.length;e++)this.registerTileJSON(t[e],!0)}catch{t()}t()}),n)})):Promise.resolve(!0)}useBankForContent(){return this.useBank&&this.useBankForContentLock<=0}lockUseBankForContent(){this.useBankForContentLock++}unlockUseBankForContent(){this.useBankForContentLock--}addForceLoadTransaction(e){this.forceLoadTransactions.push(e)}removeForceLoadTransaction(e){var t=this.forceLoadTransaction.indexOf(e);this.forceLoadTransaction.splice(t,1)}updateForceLoad(){var e;let t=!1;for(e=0;e<this.forceLoadTransactions.length;e++)this.forceLoadTransactions[e].update()&&(this.forceLoadTransactions[e]=null,t=!0);var n=0;for(e=0;e<this.forceLoadTransactions.length;e++)this.forceLoadTransactions[e]&&(this.forceLoadTransactions[n]=this.forceLoadTransactions[e],n++);return this.forceLoadTransactions.length=n,t}setGhostMode(e){(e=!!e)!==this.ghostMode&&(this.ghostMode=e,this.ghostMode?this.sgNode.setVisibility(!1):this.sgNode.setVisibility(!0))}setNodeStartLoading(){this.nbLoading++}setNodeEndLoading(){this.nbLoading--}setNodeStartExpanding(){this.nbExpanding++}setNodeEndExpanding(){this.nbExpanding--}registerOnStartLoadingCB(e){var t={};return this.onStartLoadingCallbacks.set(t,e),t}unregisterOnStartLoadingCB(e){this.onStartLoadingCallbacks.delete(e)}registerOnEndLoadingCB(e){var t={};return this.onEndLoadingCallbacks.set(t,e),t}unregisterOnEndLoadingCB(e){this.onEndLoadingCallbacks.delete(e)}updateLoadingStatus(){var e=this.nbLoading>0||this.nbExpanding>0;e!==this.loadingStatus&&(this.loadingStatus=e,e?this.onStartLoadingCallbacks.forEach(((e,t,n)=>{e.call(null)})):this.onEndLoadingCallbacks.forEach(((e,t,n)=>{e.call(null)})))}updateContentMetaData(e){var t;for(t=0;t<e.length;t++){let o=e[t].path,s=e[t].value;var n,i=o.split("/"),r=this.contentMetaData;for(r||(r={},this.contentMetaData=r),n=0;n<i.length;n++)if(n<i.length-1){let e=r[i[n]];e||(e={},r[i[n]]=e),r=e}else r[i[n]]=s}this.contentMetaDataVersion++,this.getRootNode().onTileSetContentMetaDataUpdate()}getContentMetaData(e){let t=null,n=function(e,t){let n=null;var i=e.split("/");let r,o=t;for(r=0;o&&r<i.length-1;r++)o=o[i[r]],o instanceof Object||(o=null);o&&o instanceof Object&&(n={object:o,property:i[i.length-1]});return n}(e,this.contentMetaData);return n&&(t=n.object[n.property]),t}setVisibility(e){var t;if(e!==this.visibility)for(this.visibility=!!e,this.getRootNode().getSgNode().setVisibility(this.visibility),this.getContentLoaders(),t=0;t<this.contentLoaders.length;t++)this.contentLoaders[t].setTileSetVisibility(this.visibility)}setVisibilityFree(e){this.getRootNode().getSgNode().setVisibilityFree(e)}getPauseLoading(){return!!(this.pauseLoading&&this.pauseLoading.size>0)}setPauseLoading(e,t,n){this.pauseLoading||(this.pauseLoading=new Set),e?this.pauseLoading.add(t):(this.pauseLoading.delete(t),0===this.pauseLoading.size&&(this.pauseLoading=null,n.requestUpdate(!0,!0)))}createAvailableAttributesMap(e){let t,n=new Map,i=["integer","float","string"];for(t=0;e&&t<e.length;t++){let r=e[t],o=r.name,s=i.indexOf(r.type)>=0?r.type:null,a=r.userData||null;o&&n.set(o,{type:s,userData:a})}return n}setStyling(e){let t=null,n=a.ok;return e&&(t=new s,n=t.setFromJSON(e),!n.isOk())?(t=null,n):(this.styling=t,this.getTilesManager().requestUpdateTileSetContent(this),n)}beforeUpdateNodes(){this.pointCloudContentLoader&&this.r2vFullLOD&&(this.maxPixelErrorFactor=this.pointCloudContentLoader.maxPixelErrorFactor)}updateContents(e){let t=this.getRootNode();if(t){let n=[];t.traverse((e=>{(e.hasContentToken()||e.isContentLoading())&&n.push(e)}));let i,r=[],o=[];for(i=0;i<n.length;i++){let h,c=n[i],u=c.contentSet,p=u&&u.contents;for(h=0;h<p.length;h++)r.push(c),o.push(p[h])}let s=o.length,a=l.getNewUpdateVersion();function d(){if(s--,s<=0){let t;for(t=0;t<o.length;t++){let e=o[t],n=r[t];e.updatedContentVersion===a&&e.replaceContentWithUpdated(n),n.updateSelection()}e.render({budgeted:!0})}}l.updateNodesContents(r,o,a,d)}}getTilesManager(){return this.tilesManager}getMaxPixelError(){return this.baseMaxPixelError*this.maxPixelErrorFactor}getPathesLeadingToRoot(){let e=this.tilesManager.ldhNodeManager.targetNode,t=this.getRootNode().getSgNode();return d.buildPathesLeadingToNode(t,e)}}function c(e){this.count=e,this.error=!1}function u(){this.nodes=[],this.childrenURIs=[],this.etags=[]}return h.ODTWAFData=!1,u.prototype.tryToAdd=function(e,t,n,i){if(!e.childrenURIs)return this.nodes.push(e),!0;var r,o,s,a=[],d=[];for(r=0;r<e.childrenURIs.length;r++)o=e.childrenURIs[r],s=e.childrenEtags&&e.childrenEtags[r],n.hasPreloadedNode(o,s)||(a.push(o),d.push(s));if(this.childrenURIs.length+a.length<t||i){for(r=0;r<a.length;r++)this.childrenURIs.push(a[r]),this.etags.push(d[r]);return this.nodes.push(e),!0}return!1},h})),define("DS/3DXMTiles/DSTilesManager",["DS/3DXMTiles/DSTilesQueueSet","DS/3DXMTiles/MemoryBudgetManager","DS/3DXMTiles/DSTilesStdExpander","DS/3DXMTiles/DSTilesGenericScoreComputer","DS/3DXMTiles/DSTilesTileSet","DS/Visualization/Node3D","DS/3DXMTiles/DSTilesRootEntry","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesSelectionManager","DS/3DXMTiles/DSTilesNode"],(function(e,t,n,i,r,o,s,a,d,l){"use strict";return class{constructor(e,r){this.viewer=r.viewer,this.memoryManager=new t(e.unloadManager),this.ldhNodeManager=e,this.rootEntries=[],this.queueSets=[],this.customContentManagerMap=new Map,this.selectionManager=null,this.updateContentTileSets=new Set,(r&&r.enableTilesSelection||window.OOCTilesSelectionPrototype)&&(this.selectionManager=new d(this),this.selectionManager.init()),this.expander=new n({tilesManager:this,scoreComputer:new i({})})}getQueueSet(t){return 0===this.queueSets.length&&this.queueSets.push(new e(this)),this.queueSets[0]}requestUpdateTileSetContent(e){this.updateContentTileSets.add(e)}registerRootNode(e){this.expander.init();var t=e.node;t.sgNode||t.buildSgNode();var n=e.targetSGNode;n&&n!==t.sgNode&&n.addChild(t.sgNode);var i=new s({node:t});this.rootEntries.push(i)}removeTileSet(e){var t,n=e.getTile(e.rootURI);for(t=0;t<this.rootEntries.length;t++)if(this.rootEntries[t].node==n){this.rootEntries.splice(t,1);break}for(n.destroy(),t=0;t<this.queueSets.length;t++)this.queueSets[t].cleanLists();e.dispose()}registerDSTilesNode(e){e.queue.registerDSTilesNode(e)}updateNodes(e,t){this.updateContentTileSets.forEach((e=>{e.updateContents(this.ldhNodeManager.viewer)})),this.updateContentTileSets.clear();var n,i,r,o=!1;for(n=0;n<this.rootEntries.length;n++)r=this.rootEntries[n].node,(i=this.rootEntries[n].node.tileSet).beforeUpdateNodes();for(n=0;n<this.rootEntries.length;n++)r=this.rootEntries[n].node,i=this.rootEntries[n].node.tileSet,r.updateDescendantLocked(),i.getPauseLoading()||i.updateForceLoad()&&(o=!0);let s=e||o;for(n=0;n<this.rootEntries.length;n++)(r=this.rootEntries[n].node).updateWorldMatrix(!0);for(n=0;n<this.queueSets.length;n++)this.queueSets[n].updateNodes(s,t);if(s)for(n=0;n<this.rootEntries.length;n++)(r=this.rootEntries[n].node).tileSet.getPauseLoading()||r.traverseUpdateNodes(this.ldhNodeManager.viewer);for(n=0;n<this.rootEntries.length;n++)(i=this.rootEntries[n].node.tileSet).flushLoadTileContent(),i.flushExpandTile()}loadNodes(e,t){var n,i=this.memoryManager;for(i.startUnload()&&(this.unloadNodes(),i.endUnload()),n=0;n<this.queueSets.length;n++)this.queueSets[n].loadNodes(e,t)}isLoading(){var e;for(e=0;e<this.queueSets.length;e++)if(this.queueSets[e].isLoading())return!0;return!1}unloadNodes(e){var t;for(e&&(window.forceUnload=!0),t=0;t<this.rootEntries.length;t++)this.rootEntries[t].node.tryUnload(this.memoryManager);e&&(window.forceUnload=!1)}registerCustomContentManager(e){var t=e.type;this.customContentManagerMap.set(t,e)}getCustomContentManager(e){return this.customContentManagerMap.get(e)||null}createFromJSON(e,t,n){var i=new r(this,e);return i.setPauseLoading(!0,"_init_",this.ldhNodeManager),i.init().then((()=>new Promise(((e,r)=>{var s=this.getQueueSet();i.downloadTilesOneByOne([i.rootURI],[i.rootEtag],(()=>{var r=i.rootURI,d=i.getPreloadedNodeJSON(r),l=this.expander.createNodeFromJSON(d,null,r,s,i,null);i.addNode(l);var h=t;if(n&&(h=new o,t.addChild(h)),1!==i.unitScale){var c=new o,u=new a.Matrix4;u.makeScale(i.unitScale,i.unitScale,i.unitScale),c.setMatrix(u),h.addChild(c);var p=new o;c.addChild(p),h=p}var g={targetSGNode:h,node:l};l.setSgNode(h),l.updateWorldMatrix(),this.registerDSTilesNode(l),this.registerRootNode(g),e(i)}))}))))}setSplattingParameters(e){this.expander.setSplattingParameters(e)}getOOCTargetNode(){return this.ldhNodeManager.targetNode}getRootNodes(){let e,t=[];for(e=0;e<this.rootEntries.length;e++)t.push(this.rootEntries[e].node);return t}getTilesAttributesFromPathElement(e){let t=l.getTileNodeFromPathElement(e);return t&&t.getAllAttributes(e)}}})),define("DS/3DXMTiles/LDHNodeManager",["DS/3DXMTiles/LDHNodeManagerQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/3DXMTilesUtils","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/LDHUserQueue","DS/3DXMTiles/LDHCandidateQueueRenderer","DS/3DXMTiles/LDHLoadingBoxManager","DS/3DXMTiles/Debug3DXMTiles","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/3DXMTiles/MassiveOcclusionChecker","DS/3DXMTiles/LDHStats","DS/Visualization/BufferGPUManager","DS/VisuTools/FPSCounter","DS/3DXMTiles/DSTilesManager","DS/VisuTools/OOCReplay","DS/3DXMTiles/ModelBank","DS/3DXMTiles/LDHRepresentationLoader","DS/CoreEvents/Events"],(function(e,t,n,i,r,o,s,a,d,l,h,c,u,p,g,f,m,v,S,y,M){"use strict";var D="ON"===window.localStorage.getItem("OOCPerfo"),T=function(n){p.init(),g.initAtLoading=!0,g.fillMapGeomBufferSize=!0,D&&(f.setAutoRefresh(!1),n.viewer.showPerfo(!0,!1)),this.getServiceUrlCB=n.getServiceUrlCB||null,this.tilesQueueSuperUpdate="OFF"!==localStorage.getItem("DSTilesSuperUpdate"),this.forceClientBox="ON"===localStorage.getItem("OOCClientBox"),this.enableUnload=void 0===window.OOCEnableUnload||window.OOCEnableUnload,this.viewer=n.viewer,this.bsNode=new c("ooc_bsNode"),this.bsNode.setVisibilityFree(!0),this.viewer.addNode(this.bsNode),this.fullVPToken=null,this.fullVPLoading=0,this.viewpointHasChangedSinceLastFullVP=!0,this.forceSceneMin=n.forceSceneMin,this.ignoreVisibility=!(!window.OOCIgnoreVisibility&&!n.ignoreVisibility),this.newLoadingBoxes=!!n.newLoadingBoxes,void 0!==n.maxNbBoxes&&(d.maxNbBoxes=n.maxNbBoxes);var i=this;this.alreadyCalledFullVP=!1,this.onViewpointMoveToken=this.viewer.currentViewpoint.onMove((function(){i.onViewpointMove()})),this.onSwapVisibleSpaceToken=this.viewer.onSwapVisibleSpace((function(){setTimeout((function(){i.onViewpointMove()}),200)})),this.onSceneGraphUpdateToken=M.subscribe({event:"/VISU/onSceneGraphUpdate"},this.onSceneGraphUpdate.bind(this)),this.progressiveExpand=!!n.progressiveExpand,this.queues=[new e(t.Model3DHandler,this),null,new e(t.TileSetHandler,this)],this.progressiveExpand&&(this.queues[1]=new e(t.InstRefHandler,this),this.queues[1].enableOcclusionTest=!1),this.queues[2].enableOcclusionTest=!1,v.download&&v.recording&&this.disableOcclusionTest(),this.requestUpdateToken=null,this.fullVPPending=!1,this.updateOptions={viewpointChanged:!1},this.viewpointHasChanged=!0,this.targetNode=null,this.targetNodeParentSet=new Set,this.requestUpdate(!0),this.unloadManager=new r(n.config,n.meshInRAM,n.oocManager),this.tilesManager=new m(this,n),this.previousIsLoading=!1,this.defaultLoadingCBToken={},this.onStartLoadingCBMap=new Map,this.onEndLoadingCBMap=new Map,this.suspendedReferenceActions=[],this.debugThrottle=0,this.pauseLoadingMap=new Map,this.authorizeRepresentationLoading=!0,this.oocManager=n.oocManager,this.viewpointTag=0,this.debugMissingExpectedNbChildren=!!window.debugMissingExpectedNbChildren,this.unloadSmallNodesEnabled=!0,this.unloadLeafReferenceCB=null,this.onLeafReferenceLoadedCB=null,this.pauseLoadingDuringViewpointMove=!0,this._dbg_freezeViewpointTag=!1,this.overrideSetManager=null,this.overrideSetMap={},this.lastQueueRendererUpdateTime=0,this.queueRenderer=null,this.userQueues=[],this.rootAdded=!1,this.lastDeltaTime=-1,this.startLoadTime=null,this.hasUnloadedSmallNodes=!1,this.emergencyUnloadOccured=!1,this.emergencyUnloadAvoided=!1,this.instRefTransactionCPUMemoryFullOccurred=!1,this.boundingSphere=new h.Sphere,this.viewer.onPreRender(this.onPreRender.bind(this)),this.occlusionTestEnabled=void 0===n.enableOcclusionTest||n.enableOcclusionTest,this.occlusionTestEnabled||(this.queues[0].enableOcclusionTest=!1),this.fullVPHandler=null,this.switchRepresentationBuffer=new Map,this.globalMeshInRAMCounter=0,this.needGlobalSwitchNoMeshInRAM=!1,this.switchNoMeshInRAMReferences=new Set,this.loadingReferencesToSwitchToNoMeshInRAM=new Set,this.occlusionChecker=null,window.oocLDHNodeManager=this,this.needsOcclusion=!1,this.updateLoadingBoxesRequested=!1,this.tileSetMap=new Map,this.disableFullVP=!1,this.fullVPScreenRadius=0,this.loadingReferencesFromBox=0,this.waitForBankVpMoveToken=null,this.waitForBankFullVpToken=null,this.waitForBankRequestUpdate=null,this.lastWheelMovingTime=0,this.needUpdateLDHOccurrences=!1,this.pauseLoadingWhileWaitingForIndex="true"===window.localStorage.getItem("OOCPauseLoadingWhileWaitingForIndex"),this.waitingForOcclusion=!1,this.renderToTargetData=null,this.renderToTargetInProgress=!1};T.prototype.registerTileSets=function(e,t){this.tileSetMap.set(e,t)},T.prototype.removeTileSets=function(e){var t,n=this.tileSetMap.get(e);for(this.tileSetMap.delete(e),t=0;n&&t<n.length;t++)this.tilesManager.removeTileSet(n[t])},T.prototype.getTileSets=function(e){let t=this.tileSetMap.get(e);if(!t&&0===e.parents.length&&1===e.children.length){let n=e.children[0].reference;t=this.tileSetMap.get(n)}return t||null},T.prototype.getAllTileSets=function(){let e=[];return this.tileSetMap.forEach(((t,n)=>{t&&(e=e.concat(t))})),e},T.prototype.onSceneChange=function(){this.needsOcclusion=!0},T.prototype.isSlave=function(){return this.oocManager.isSlave()},T.prototype.isOOC=function(){return this.oocManager.isOOC()};var C=function(e,t){this.references=e,this.callback=t};function b(e,t,n,i){this.viewpoint=e,this.cst=t,this.bsRadius=n?n.radius:0,this.pixelCulling=Math.min(i.getPixelCulling("static"),i.getPixelCulling("dynamic"))}T.prototype.setUnloadSmallNodesEnabled=function(e){this.unloadSmallNodesEnabled=e},T.prototype.onPreRender=function(e){if(this.queues[0].renderingOccured=!0,e.viewpoint==this.viewer.currentViewpoint&&this.updateLoadingBoxesRequested){var t=this.createViewpointData();this.updateCandidateQueueRenderer(!1,t),this.updateLoadingBoxesRequested=!1}},T.prototype.tryBuildSceneGraphHierarchy=function(){var e,t=this.oocManager.getRootOccurrences(),n=[],i=this;for(t.forEach((function(e,t,r){e.occurrence.reference.tryBuildSceneGraphHierarchy(n,i)})),e=0;e<n.length;e++)n[e].updateOverride(this)},T.prototype.setPauseLoadingDuringViewpointMove=function(e){this.pauseLoadingDuringViewpointMove=e},T.prototype.tryToPerformReferenceAction=function(e,t){if(this.waitingForOcclusion)return!1;var n,i=!0;for(n=0;n<e.length;n++)e[n].isLoading()&&(i=!1);if(i){var r=this;return t.call(void 0,e,(function(){r.requestUpdate(!0)})),!0}return!1},T.prototype.executeReferenceAction=function(e,t){this.tryToPerformReferenceAction(e,t)||this.suspendedReferenceActions.push(new C(e,t))},T.prototype.setTargetNode=function(e){this.targetNodeParentSet.clear(),function e(t,n){if(t&&!n.has(t)){let i;for(n.add(t),i=0;i<t.parents.length;i++)e(t.parents[i],n)}}(e,this.targetNodeParentSet),this.targetNode=e;this.oocManager.getRootOccurrences().forEach(((e,t,n)=>{var i=e.occurrence,r=i.reference;i.setDepthFromParentNode(this.targetNode),r.requestBuildSceneGraphHierarchy(!0)})),this.tryBuildSceneGraphHierarchy()},T.prototype.registerTilesNode=function(e){if(this.alreadyCalledFullVP||this.progressiveExpand||this.onViewpointMove(),this.progressiveExpand||1!==e.handler.type){if(e._status!==i.loaded&&e._status!==i.loading&&e._status!==i.waiting&&e._status!==i.toUnload&&e._status!==i.toUnloadLight&&e._status!==i.toLoad&&e._status!==i.error)return;var t=e.handler;this.queues[t.type].registerNode(e),this.requestUpdate(!1)}else this.fullVPHandler||(this.fullVPHandler=e.handler,this.onViewpointMove())},T.prototype.unregisterNode=function(e){if(!e.isAlive()){var t=e.handler,n=this.queues[t.type];n&&n.unregisterNode(e)}},T.prototype.forceUpdateNode=function(e){var t=e.handler;0===t.type&&(this.queues[t.type].forceUpdateNode(e),this.requestUpdate(!1))},T.prototype.requestUpdate=function(e){if(this.updateOptions.viewpointChanged=this.updateOptions.viewpointChanged||e,null===this.requestUpdateToken){if(!S.initComplete)return void(null===this.waitForBankRequestUpdate&&(this.waitForBankRequestUpdate=setTimeout((()=>{this.waitForBankRequestUpdate=null,this.requestUpdate(!1)}),10)));this.requestUpdateToken=setTimeout(this._updateNodes.bind(this),0)}},T.prototype._updateNodes=async function(){if(!this.viewer||!this.viewer.currentViewpoint)return;if(this.waitingForOcclusion)return void setTimeout(this._updateNodes.bind(this),0);l.startProbe("updateNodes");var e,t,n,i=this.createViewpointData();if(this.oocManager.isSlave()||this.tryCandidateOverridesUpdate(),this.suspendedReferenceActions.length>0){for(e=0;e<this.suspendedReferenceActions.length;e++)n=this.suspendedReferenceActions[e],this.tryToPerformReferenceAction(n.references,n.callback)&&(this.suspendedReferenceActions[e]=null);this.suspendedReferenceActions=this.suspendedReferenceActions.filter((function(e){return null!==e}))}null!==this.requestUpdateToken&&(clearTimeout(this.requestUpdateToken),this.requestUpdateToken=null),this.updateOccurrences(),this.updateAllLDHOccurences();var r=this.isManipulatedViewpointMoving();if(this.pauseLoadingDuringViewpointMove&&r||this.pauseLoadingWhileWaitingForIndex&&this.fullVPLoading>0)return this.authorizeRepresentationLoading=!1,this.emergencyUnloadNodes(i),this.requestUpdate(!1),void l.endProbe("updateNodes");var o=this.updateOptions.viewpointChanged;if(this.updateOptions.viewpointChanged=!1,this.viewpointHasChanged=this.viewpointHasChanged||o,v.recording&&this.viewpointHasChanged&&v.addViewointMove(this.viewer.currentViewpoint),this.viewpointHasChanged&&(this.hasUnloadedSmallNodes=!1,this.emergencyUnloadOccured=!1,this.emergencyUnloadAvoided=!1),(this.viewpointHasChanged||this.needsOcclusion)&&(this.occlusionChecker&&this.occlusionChecker.dispose(),this.occlusionChecker=null),this.clearMeshInRAMForLoadingReferences(),this.getPauseLoading()||2===this.debugThrottle)return this.authorizeRepresentationLoading=!1,this.updateUserQueues(this.viewpointHasChanged,i),this.checkAutoMeshInRAM(),this.emergencyUnloadNodes(i),this.updateLoadingStatus(),void l.endProbe("updateNodes");for(this.authorizeRepresentationLoading=!0,y.flushLoadingBuffer(),this.viewpointHasChanged&&!this._dbg_freezeViewpointTag&&this.viewpointTag++,!this.newLoadingBoxes&&this.viewpointHasChanged&&this.queueRenderer&&this.queueRenderer.clearClusters(),e=0;e<this.queues.length;e++)(t=this.queues[e])&&t.updateNodes(this.viewpointHasChanged,i);this.tilesManager.updateNodes(this.viewpointHasChanged,i),this.updateUserQueues(this.viewpointHasChanged,i);let s=this.needsOcclusion;this.needsOcclusion=!1,this.waitingForOcclusion=!0,await this.computeOcclusion(this.viewpointHasChanged||s),this.waitingForOcclusion=!1,this.getPauseLoading()||(this.checkAutoMeshInRAM(),this.enableUnload&&(this.unloadManager.isUnloadNeeded()&&this.removeMeshInRAMForUnload(),this.standardUnloadNodes(this.viewpointHasChanged,i),this.emergencyUnloadNodes(i)),this.debugThrottle<1&&(this.loadNodes(this.viewpointHasChanged,i),this.tilesManager.loadNodes(this.viewpointHasChanged,i)),this.viewpointHasChanged=!1,this.updateLoadingStatus(),this.updateLoadingBoxesRequested=!0,l.endProbe("updateNodes"))},T.prototype.removeMeshInRAMForUnload=function(){if(this.needGlobalSwitchNoMeshInRAM)this.globalMeshInRAMSwitch(!1),this.needGlobalSwitchNoMeshInRAM=!1;else{var e=this,t=this.oocManager;this.switchNoMeshInRAMReferences.forEach((function(n){if(!t.isMeshInRAMRequested(n)){var i=t._getLDHReference(n,!0);i&&i.switchMeshInRAM(!1,e)}})),0!==this.switchNoMeshInRAMReferences.size&&(this.switchNoMeshInRAMReferences=new Set)}},T.prototype.onViewpointMove=function(){if(this.viewpointHasChangedSinceLastFullVP=!0,S.initComplete){if(this.requestUpdate(!0),this.startLoadTime=(new Date).getTime(),this.getPauseLoading()||this.requestFullVP(1e3),!this.getPauseLoading()&&this.tilesQueueSuperUpdate){var e=this.createViewpointData();this.tilesManager.updateNodes(true,e),this.tilesManager.loadNodes(true,e),this.updateLoadingStatus()}}else null===this.waitForBankVpMoveToken&&(this.waitForBankVpMoveToken=setTimeout((()=>{this.waitForBankVpMoveToken=null,this.onViewpointMove(this)}),10))},T.prototype.forceFullVP=function(){this.requestFullVP(0)},T.prototype.requestFullVP=function(e){if(S.initComplete){if(!this.progressiveExpand&&!this.getPauseLoading()&&this.oocManager.hasActiveRoot()){var t=this;null!==t.fullVPToken&&(t.decFullVPLoading(),clearTimeout(t.fullVPToken),t.fullVPToken=null),this.incFullVPLoading(),this.fullVPToken=setTimeout((function(){t.fullVPToken=null,t.decFullVPLoading(),t.goFullVP()}),e)}}else null===this.waitForBankFullVpToken&&(this.waitForBankFullVpToken=setTimeout((()=>{this.waitForBankFullVpToken=null,this.requestFullVP(e)}),10))},T.prototype.getRootsToExpand=function(){var e=[];return this.oocManager.getRootOccurrences().forEach((function(t,n,i){(t.enableExpand||t.treeModified)&&(t.occurrence.reference.isLeaf()||e.push(t))})),e},T.prototype.getClippingPlanes=function(){let e=[];var t=this.oocManager.getRootOccurrences();t.forEach((function(t,n,i){let r=t.occurrence.reference.getNode(),o=r&&r._occurrences[0].clippingContext;o&&e.push(o)}));let n=null;if(e.length>0&&e.length===t.size){let t;for(n=e[0].planes,t=0;t<e.length;t++){e[t];let i,r=e[t].planes;for(i=0;i<r.length;i++)if(r[i]!==n[i])return null}}return n},T.prototype.getViewpoint=function(){let e;return e=this.renderToTargetData?this.renderToTargetData.viewpoint:this.viewer.currentViewpoint,e},T.prototype.getScreenSize=function(){let e;return e=this.renderToTargetData?this.renderToTargetData.screenSize:new h.Vector2(this.viewer.SCREEN_WIDTH,this.viewer.SCREEN_HEIGHT),e},T.prototype.goFullVP=function(){var e=this.fullVPHandler;if(!this.progressiveExpand&&null!==e&&!this.getPauseLoading()&&this.debugThrottle<1&&!this.disableFullVP)if(p.onNewViewpoint(),e.isReady()){this.fullVPPending=!1,this.alreadyCalledFullVP=!0;var t=this.getRootsToExpand();let o=this.getScreenSize(),s=this.getViewpoint();if(t.length>0){var n,i,r={viewpointTag:this.viewpointTag,manager:this.oocManager,doneCB:this.onFullVPDone.bind(this),screenRadius:this.fullVPScreenRadius,viewpoint:s,screenWidth:o.x,screenHeight:o.y};for(p.onFullVP(this),i=0;i<t.length;i++)(n=t[i]).treeModified=!1,this.incFullVPLoading(),e.handleReferences([n.occurrence.reference],r,[n.rootId],!0);this.viewpointHasChangedSinceLastFullVP=!1}this.updateLoadingStatus()}else this.fullVPPending=!0;else this.updateLoadingStatus()},T.prototype.boxQuery=function(e,t,n){var i,r=this.fullVPHandler,o=this.oocManager.getRootOccurrences(),s=[],a=[],d=this.forceClientBox;if(o.forEach((function(e,t,n){var i=e.occurrence.reference;i.isLeaf()||(e.elasticLoading&&e.enableExpand&&!d?s.push(i):a.push(i))})),s.length>0||a.length>0){var l,h=s.length,c=[],u=[],p={doneCB:e=>{if(h--,c=c.concat(e.representationsList),0===h){this.loadingReferencesFromBox--;var n=function(e,t){if(0===t.length)return e;if(0===e.length)return t;var n,i=new Set;for(n=0;n<e.length;n++)i.add(e[n]);for(n=0;n<t.length;n++)i.add(t[n]);return Array.from(i)}(c,u);t(n),this.updateLoadingStatus()}},errorCB:e=>{p.doneCB({representationsList:[]}),n&&n(e)}};for(this.loadingReferencesFromBox++,l=0;l<s.length;l++){var g=s[l].referenceId;r.oocHandler.handleBox(g,(void 0,{corner_min:[""+(i=e).min.x,""+i.min.y,""+i.min.z],corner_max:[""+i.max.x,""+i.max.y,""+i.max.z],transformation_matrix:["1.000","0.000","0.000","0.000","1.000","0.000","0.000","0.000","1.000","0.000","0.000","0.000"],intersection_mode:"partly_in",filter_only_on_bounding_box:1}),p)}if(a.length>0){var f=this.queues[0];f&&(u=f.computeNodesCollidingWithBox(e)),0===h&&setTimeout(t.bind(null,u))}}else setTimeout(t.bind(null,[]));this.updateLoadingStatus()},T.prototype.onFullVPDone=async function(){this.waitingForOcclusion?setTimeout(this.onFullVPDone.bind(this),0):(this.decFullVPLoading(),0===this.fullVPLoading&&p.onFullVPDone(this),await this._updateNodes(),this.fullVPPending&&this.forceFullVP(),this.updateLoadingStatus(),this.requestUpdate(!1))},T.prototype.computeOcclusion=async function(e){var t=this.queues[0];if(t.enableOcclusionTest&&(e&&(this.occlusionChecker&&this.occlusionChecker.dispose(),this.occlusionChecker=null),e||this.queues[0].requiresOcclusion())){if(!this.occlusionChecker){let e,t,n,i;this.renderToTargetData&&this.renderToTargetInProgress?(n=.25,e=this.renderToTargetData.screenSize.x,t=this.renderToTargetData.screenSize.y,i=this.renderToTargetData.viewpoint):(n=.25,e=Math.ceil(n*this.viewer.renderer.viewportWidth),t=Math.ceil(n*this.viewer.renderer.viewportHeight),i=this.viewer.currentViewpoint),this.occlusionChecker=new u({ldhNodeManager:this,viewer:this.viewer,width:e,height:t,ratio:n,viewpoint:i,renderList:"ooc"})}return this.occlusionChecker.disabled||p.onOcclusion(),t.computeOcclusion(this.occlusionChecker,e)}},T.prototype.updateUserQueues=function(e,t){var n;for(n=0;n<this.userQueues.length;n++){var i=this.userQueues[n];this.getPauseLoading()&&i.pauseSensitive||(e&&i.handleViewpointChange(t),i.traverseQueue())}},T.prototype.loadNodes=function(e,t){var n,i;if(this.debugThrottle<.5)for(n=0;n<this.queues.length;n++)(i=this.queues[n])&&i.loadNodes(e,t)},T.prototype.createViewpointData=function(){let e=this.getViewpoint(),t=this.getScreenSize();return new b(e,n.computeScreenRadiusCstComponent(e.camera,t),this.boundingSphere,this.viewer)},T.prototype.removeRemovedNodes=function(){var e;for(e=0;e<this.queues.length;e++)this.queues[e]&&this.queues[e].removeUselessNodesFromList(this.queues[e].nodes)},T.prototype.updateLoadingStatus=function(){var e,t,n,i=!1,r=this.hasUnloadedSmallNodes;for(i=this.fullVPLoading>0||i||this.rootAdded||this.loadingReferencesFromBox>0,this.tilesManager.isLoading()&&(i=!0),this.rootAdded=!1,t=0;t<this.queues.length;t++)(n=this.queues[t])&&(i=i||n.isLoading(),r=r||n.hasMoreToLoad());var o=!this.unloadManager.isLoadingAllowed(0)||!this.unloadManager.isLoadingAllowed(1);if(i!==this.previousIsLoading){var s={isLoading:i,memoryFull:o||this.emergencyUnloadOccured||this.emergencyUnloadAvoided||this.instRefTransactionCPUMemoryFullOccurred,emergencyUnload:this.emergencyUnloadOccured,emergencyUnloadAvoided:this.emergencyUnloadAvoided};if(i)l.startProbe("viewpoint"),this.startLoadTime=(new Date).getTime(),this.viewer.setRenderIteration(!1),p.onStartLoading(),this.onStartLoadingCBMap.forEach(((e,t)=>{e&&e.call(void 0,s)}));else{e=(new Date).getTime(),l.endProbe("viewpoint"),this.lastDeltaTime=e-this.startLoadTime;var a=this.createViewpointData();this.updateCandidateQueueRenderer(!0,a),this.viewer.setRenderIteration(!0),this.forceSceneMin?this.viewer.render():this.queues[0].nbLoaded>0&&(this.viewer._forceSceneMin(null),this.viewer.render({updateInfinitePlane:!0})),p.onEndLoading(o),v.recording&&v.addEndLoading(),this.onEndLoadingCBMap.forEach(((e,t)=>{e&&e.call(void 0,s)}))}this.previousIsLoading=i}this.renderToTargetInProgress&&this.renderToTargetData&&!i&&(this.renderToTargetInProgress=!1,this.renderToTargetData.onReadyToRenderCB(),this.renderToTargetData.onReadyToRenderCB=null),this.tileSetMap.forEach(((e,t,n)=>{var i;for(i=0;i<e.length;i++)e[i].updateLoadingStatus()}))},T.prototype.addLoadedNode=function(e){e.getLDHNodeManagerQueue(this).addToLoadedNodesQueue(e)},T.prototype.standardUnloadNodes=function(e,t){this.unloadManager.beforeLoadedNodesQueueTraversal(),this.queues[0].standardUnloadNodes(e,t),this.unloadManager.afterLoadedNodesQueueTraversal()},T.prototype.onReferenceUnloaded=function(){this.queues[0].onReferenceUnloaded()},T.prototype.unloadNode=function(e,t,n){if(e.isUnloadLocked()||!e.isUnloadable(!0))return!1;if(0===e.handler.type){if(!e.isToUnload()&&!n)return!1}else if(e.isRoot||e.children.length>0)return!1;(this.newLoadingBoxes&&e.removeBox(this),e.removeFromSceneGraph(!1,this),e.recursiveUpdateMemorySize(this),e.isInList())&&e.getLDHNodeManagerQueue(this).onNodeToRemoveFromList();var r,o=e.parents;for(e.isSlave()||e.hasUnloadFrozenParent()||e.isToUnloadLight()?e.setStatus(i.waiting,this):(e.removeFromParents(this.oocManager),e.unregister(this.oocManager)),r=0;r<o.length;r++)this.unloadNode(o[r],t);return!0},T.prototype.setOnStartLoadingCB=function(e){this.onStartLoadingCBMap.set(this.defaultLoadingCBToken,e)},T.prototype.setOnEndLoadingCB=function(e){this.onEndLoadingCBMap.set(this.defaultLoadingCBToken,e)},T.prototype.addOnStartLoadingCB=function(e){var t={};return this.onStartLoadingCBMap.set(t,e),t},T.prototype.addOnEndLoadingCB=function(e){var t={};return this.onEndLoadingCBMap.set(t,e),t},T.prototype.removeLoadingCB=function(e){this.onStartLoadingCBMap.delete(e),this.onEndLoadingCBMap.delete(e)},T.prototype.onInstRefGraphTransactionEnd=function(e){var n,r;for(n=0;n<e.length;n++)(r=e[n]).isAlive()&&!r.isUnloadFrozen()&&r.setStatus(i.loaded,this);for(n=0;n<e.length;n++)!(r=e[n]).isAlive()||r.handler.type!==t.Model3DHandler&&r.handler.type!==t.TileSetHandler||(r.updateMemorySizeNEW(this),r._onLoaded(),r.isUnloadable()&&this.addLoadedNode(r));if(this.instRefTransactionCPUMemoryFullOccurred&&e.length&&!e[0].isLeaf()){var o=new Set;this.oocManager.getRootOccurrences().forEach((function(e,t,n){e.occurrence.reference.traverse((function(e){e.isLeaf()||0!==e.children.length||o.add(e)}))}));var s=this;o.forEach((function(e){s.unloadNode(e)}))}this.tryBuildSceneGraphHierarchy(!1,this)},T.prototype.fillDebugJSON=function(e){return e.references={Model3DHandler:[],InstRefHandler:[]},this.queues[0].fillDebugArray(e.references.Model3DHandler),e},T.prototype.setPauseLoading=function(e,t){t=t||"default",this.pauseLoadingMap.set(t,e),this.getPauseLoading()&&(this.authorizeRepresentationLoading=!1)},T.prototype.getPauseLoading=function(){var e=!1;return this.pauseLoadingMap.forEach((function(t,n,i){t&&(e=!0)})),e},T.prototype.registerOverrideSet=function(e){this.overrideSetManager||(this.overrideSetManager=this.viewer.getSceneGraphOverrideSetManager()),this.overrideSetMap[e]||(this.overrideSetMap[e]=new o(this.targetNode,void 0,!0),this.overrideSetManager.pushSceneGraphOverrideSet(this.overrideSetMap[e]))},T.prototype.removeOverrideSet=function(e){var t=this.overrideSetMap[e];t&&(this.overrideSetManager.removeSceneGraphOverrideSet(t),delete this.overrideSetMap[e])},T.prototype.getOverrideSet=function(e){return this.overrideSetMap[e]},T.prototype.getOverrideSetManager=function(){return this.overrideSetManager},T.prototype.addUserQueue=function(e){var t;for(t=0;t<this.userQueues.length;t++)if(this.userQueues[t].handler===e)throw new Error("duplicate handler");var n,i=e.getParams?e.getParams():{},r=(void 0===i.addLeaves||i.addLeaves,void 0!==i.addIntermediateNodes&&i.addIntermediateNodes),o=new s(e,this),a=new Set,d=this.queues[0];for(t=0;t<d.nodes.length;t++)(n=d.nodes[t])&&(r?a.has(n)||n.traverseParents((function(e){a.add(e),o.addNode(e)}),a):o.addNode(n));var l=this.createViewpointData();o.computeOrder(l),this.requestUpdate(!1),this.userQueues.push(o)},T.prototype.removeUserQueue=function(e){var t;for(t=this.userQueues.length-1;t>=0;t--)this.userQueues[t].handler===e&&this.userQueues.splice(t,1)},T.prototype.setCandidateQueueRendererParams=function(e,t){if(!this.newLoadingBoxes&&this.queueRenderer&&this.oocManager.isSlave()&&this.queueRenderer.removeSlaveBoxes(),e){var n=this.createViewpointData(),i=this.queueRenderer;i||(i=this.newLoadingBoxes?new d(this.oocManager,this.queues[0]):new a(this,t.rootNode),this.queueRenderer=i,void 0!==t.pickable&&this.queueRenderer.setPickable(t.pickable,!this.newLoadingBoxes,n)),this.newLoadingBoxes||void 0===t.preserveSelection||(this.queueRenderer.preserveSelection=t.preserveSelection),i.setParams(t),this.newLoadingBoxes&&i.removeBoxes(),this.newLoadingBoxes&&i.updateLoadingBoxes(),!this.newLoadingBoxes&&this.oocManager.isSlave()&&i.displaySlaveBoxes(n)}else this.queueRenderer&&(this.queueRenderer.dispose(),this.queueRenderer=null,this.viewer.render({budgeted:!0}));this.requestUpdate(!1)},T.prototype.getCandidateRoots=function(){var e=this.oocManager.getRootOccurrences(),t=[];return e.forEach((function(e,n,i){var r=e.occurrence.reference;0===r.children.length&&t.push(r)})),t},T.prototype.updateCandidateQueueRenderer=function(e,t){var n=this.queueRenderer,i=this.viewer.currentViewpoint.camera.position;if(n){var r=Date.now();(r-this.lastQueueRendererUpdateTime>500||e)&&(this.lastQueueRendererUpdateTime=r,this.newLoadingBoxes?n.updateLoadingBoxes():n.updateRepresentation(i,t),this.viewer.render({budgeted:!0}))}},T.prototype.emergencyUnloadNodes=function(e){var t=this.unloadManager.isEmergencyUnloadRequiredCPU(),n=this.unloadManager.isEmergencyUnloadRequiredGPU();(t||n)&&(this.emergencyUnloadOccured=!0,n&&this.queues[0].doEmergencyUnload(e))},T.prototype.forceUnloadSmallNodes=function(e,t,n){this.queues[n].unloadSmallNodes(e,t,n)},T.prototype.setBoundingSphere=function(e){this.boundingSphere=e,e?this.bsNode.forceBoundingElements(!0,{sphere:e.clone()}):this.bsNode.forceBoundingElements(!1),this.viewer.render()},T.prototype.onAddRoot=function(){this.rootAdded=!0,this.viewpointHasChangedSinceLastFullVP=!0,this.requestUpdate(!1),this.updateLoadingStatus(),this.forceFullVP()},T.prototype.incFullVPLoading=function(){this.fullVPLoading++},T.prototype.decFullVPLoading=function(){this.fullVPLoading--};var L=-1;T.prototype.getGlobalMeshInRAM=function(e,t){if(this.globalMeshInRAMCounter>0)return!0;if((this.unloadManager.autoMeshInRAM&&this.queues[0].getEstimatedSize()>=1e3&&(this.unloadManager.autoMeshInRAM=!1,this.unloadManager.autoMeshInRAMChange=!0),e)&&(this.unloadManager.autoMeshInRAM&&(-1===L&&(L=window.OOCEnableAutoMeshInRAM?1:0),t=t||e.getActiveRepresentation())))return 1===L||t.isAV1();return this.unloadManager.meshInRAM||this.unloadManager.autoMeshInRAM},T.prototype.lockGlobalMeshInRAM=function(){this.globalMeshInRAMCounter++,this.needGlobalSwitchNoMeshInRAM=!1,1===this.globalMeshInRAMCounter&&this.globalMeshInRAMSwitch(!0)},T.prototype.unlockGlobalMeshInRAM=function(){this.globalMeshInRAMCounter>0&&this.globalMeshInRAMCounter--,0===this.globalMeshInRAMCounter&&(this.needGlobalSwitchNoMeshInRAM=!0)},T.prototype.clearMeshInRAMForLoadingReferences=function(){var e,t=this.oocManager,n=this,i=[];for(this.loadingReferencesToSwitchToNoMeshInRAM.forEach((function(e){var r=t._getLDHReference(e,!0);r&&!r.isLoading()&&(t.isMeshInRAMRequested(e)||r.switchMeshInRAM(!1,n),i.push(e)),r||i.push(e)})),e=0;e<i.length;e++)this.loadingReferencesToSwitchToNoMeshInRAM.delete(i[e])},T.prototype.globalMeshInRAMSwitch=function(e){var t=this,n=this.oocManager;n._referenceTos.forEach((function(i,r){var o=i.reference;o.isLeaf()&&(!e&&o.isLoading()?t.loadingReferencesToSwitchToNoMeshInRAM.add(o.referenceId):e?o.switchMeshInRAM(!0,t):n._lockMeshInRAMTos.has(r)||o.switchMeshInRAM(!1,t))})),e||(this.switchNoMeshInRAMReferences=new Set,this.unloadManager.restoreMemoryFromMeshInRAM())},T.prototype.checkAutoMeshInRAM=function(){this.unloadManager.autoMeshInRAMChange&&(this.unloadManager.autoMeshInRAMChange=!1,0===this.globalMeshInRAMCounter&&this.globalMeshInRAMSwitch(this.unloadManager.autoMeshInRAMChange))},T.prototype.updateOccurrences=function(){var e=this.oocManager.getRootOccurrences(),t=this;e.forEach((function(e,n,i){var r=e.occurrence.reference;(r.getNeedUpdateOccurrencesUnder()||r.getNeedUpdateOccurrences())&&r.updateOccurrences_traverse(t)}))},T.prototype.dispose=function(){this.unloadManager.dispose(),this.viewer.currentViewpoint.unsubscribe(this.onViewpointMoveToken),this.occlusionChecker&&(this.occlusionChecker.dispose(),this.occlusionChecker=null),this.onViewpointMoveToken=null,M.unsubscribe(this.onSceneGraphUpdateToken),this.onSceneGraphUpdateToken=null},T.prototype.getServiceUrl=function(e){return this.getServiceUrlCB(e)},T.prototype.disableOcclusionTest=function(){let e;for(e=0;e<this.queues.length;e++)this.queues[e]&&(this.queues[e].enableOcclusionTest=!1)},T.prototype.getOOCReplay=function(){return v},T.prototype.loadOOCDebugViews=function(){require(["DS/VisuTools/OOCDebugViews"],(function(e){window.OOCDebugViews=e}))},T.prototype.isManipulatedViewpointMoving=function(){let e=this.viewer,t=e.currentViewpoint.control,n=t&&t._wheelMoving,i=Date.now();return n&&(this.lastWheelMovingTime=i),!!(e.isManipulatedViewpointMoving()||i-this.lastWheelMovingTime<500)},T.prototype.addOverrideToUpdate=function(e){this.viewer._idPathOverrideWatcher.requestActivateOverride(e)},T.prototype.tryCandidateOverridesUpdate=function(){let e=this.viewer,t=e._idPathOverrideWatcher;t&&!e.isManipulatedViewpointMoving()&&t.update();this.oocManager.getRootOccurrences().forEach(((e,t,n)=>{var i=e.occurrence.reference;i.tryCandidateOverridesUpdate(true,this),i.updateLDHOccurrences(!1)}))},T.prototype.onSceneGraphUpdate=function(e){if("SHOWTREE"===e.eventType||"HIDETREE"===e.eventType){let t=e.fromNode;t&&(this.oocManager.isRegistered(t.getModelIdentification())||this.targetNodeParentSet.has(t))&&(this.needUpdateLDHOccurrences=!0,this.requestUpdate(!0))}},T.prototype.updateAllLDHOccurences=function(){this.oocManager.getRootOccurrences().forEach((e=>{e.occurrence.reference.updateLDHOccurrences(this.needUpdateLDHOccurrences)})),this.needUpdateLDHOccurrences=!1},T.prototype.renderToTargetOOC=function({buffer:e,viewpoint:t,subScreen:n,effectsOverride:i,onRenderCB:r}){if(this.renderToTargetInProgress)setTimeout(r,0);else{this.renderToTargetInProgress=!0;let o=!1,s=this.renderToTargetData;s&&s.viewpoint===t&&s.screenSize.x===e.width&&s.screenSize.y===e.height||(o=!0),o?(this.forceFullVP(),this.requestUpdate(!0)):this.requestUpdate(!1),this.renderToTargetData=new R(e.width,e.height,t,(()=>{this.viewer.renderToTarget(e,t,n,i),r(e),this.requestUpdate(!0)}))}};class R{constructor(e,t,n,i){this.screenSize=new h.Vector2(e,t),this.viewpoint=n,this.onReadyToRenderCB=i}}return T})),define("DS/3DXMTiles/OOCManager",["DS/3DXMTiles/LDHNodeManager","DS/3DXMTiles/OOCManagerEntry","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/OOCReferenceIterator","DS/3DXMTiles/OOCManagerRootEntry","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/VisuTools/FPSCounter","DS/Visualization/IdPathMatcher","DS/3DXMTiles/LDHReference","DS/Visualization/Node3D","DS/Visualization/PLMMaterialConnectionFactory","DS/3DXMTiles/LDHReferenceRep","DS/Visualization/IdPath","DS/3DXMTiles/LDHSwitchRepresentationData","DS/3DXMTiles/AsyncCaller","DS/3DXMTiles/Debug3DXMTiles","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/3DXMTiles/Default360ContentManager","DS/3DXMTiles/ModelBank","DS/3DXMTiles/OOCTilesManager","DS/3DXMTiles/PGManager","DS/3DXMTiles/VDRPIdPath","DS/3DXMTiles/VDRPUtils","DS/3DXMTiles/VDRPInstanceOverrideSetManager"],(function(e,t,n,i,r,o,s,a,d,l,h,c,u,p,g,f,m,v,S,y,M,D,T,C,b,L,R,_){"use strict";l.VDRPIdPath=L,l.VDRPUtils=R;var w=1,N=function(t,n){n=n||{},T.init(),function(){var e=window.localStorage.getItem("OOCDebug");if(e){var t,n=JSON.parse(e);for(t in n)window[t]=n[t]}}(),this._config=n.config||"v0";var i=n.meshInRAM?n.meshInRAM:"on";this._pgManager=new b(this),this._ldhNodeManager=new e({viewer:t,oocManager:this,config:this._config,enableOcclusionTest:n.enableOcclusionTest,fullVP:!!n.fullVP,meshInRAM:i,newLoadingBoxes:n.newLoadingBoxes,maxNbBoxes:n.maxNbBoxes,forceSceneMin:!!n.forceSceneMin,getServiceUrlCB:n.getServiceUrlCB||null,progressiveExpand:!!n.progressiveExpand,ignoreVisibility:!!n.ignoreVisibility,enableTilesSelection:!!n.enableTilesSelection}),t._setOOCManager(this),this._oocTilesManager=new C(this);var r=void 0===n.fullOOC||!!n.fullOOC;this.disableSlaveBoxFix=!1===n.solution3BoxFix,this._ldhNodeManager.unloadManager.setFlashMode(!0),void 0!==n.unloadSmallNodes&&this._ldhNodeManager.setUnloadSmallNodesEnabled(!!n.unloadSmallNodes),this._referenceTos=new Map,this._instanceTos=new Map,this._rootOccurrenceTos=new Map,this._externalNodeIdToNode=new Map,this._externalNodeToNodeId=new Map,this._lockMeshInRAMTos=new Map,this._onCycleDetectedCB=null,this._cycleDetected=!1,this._instRefGraphTransaction=null,this._mode=r?N.Mode.ooc:N.Mode.slave,r&&this._initIdPathMatcher(),this._defaultLoadModelOptions=null,this._initialMeshInRAM=i,this._overrideSetMap=new Map,this._usePickingAccelerationStructure=!1,this._boxes=new Map,this._3DShapeCounter=0,this._overrideSetManagerMap=null,this._unitValue=this._computeUnitValue(n.unit),this._handlers={repRef:null,ref:null,tileSet:null},this._nextInstanceAutoId=0,this.registerCustomTilesManager(D),this._idToPositionOverrideSets=null,this._serverProperties={isCloud:!0,isElasticLoading:!0},this._ghostInstances=new Set};function x(e){var t,n,i=[];for(t=0;t<e.externalPath.length;t++)(n=e.externalPath[t].getModelIdentification())&&i.push(n);return i}function O(e){var t,n,i=e.getLastElement(!0),r=[];for(t=0;t<i.children.length;t++)"OOC##Box"===(n=i.children[t]).name&&r.push(n.getModelIdentification());return r}N.prototype.setTargetNode=function(e){e.setRenderPasses(["main","ooc"]),this._ldhNodeManager.setTargetNode(e)},N.prototype.getTargetNode=function(){return this._ldhNodeManager.targetNode},N.prototype.setDefaultLoadModelOptions=function(e){this._defaultLoadModelOptions=e},N.prototype.getDefaultLoadModelOptions=function(){return this._defaultLoadModelOptions},N.prototype.registerReference=function(e,n){if(this._mode===N.Mode.slave)throw new Error("Cannot mix slave and OOC");var i=this._getOOCEntry(e,!0);if(!i){var r=n.handler||this._handlers[n.handlerType]||null;i=new t(e,{manager:this,handler:r.ldhHandler,boundingSphere:n.boundingSphere||null,boundingBox:n.boundingBox||null,loadModelOptions:n.loadModelOptions,positioningArch:n.positioningArch||!1}),this._referenceTos.set(e,i),this._handleNewReference(i.reference,n),this._ldhNodeManager.progressiveExpand||this._ldhNodeManager.onSceneChange(),this._ldhNodeManager.viewer._getIdPathOverrideWatcher().idPathWatcher.onCandidateAddSingle(e)}},N.prototype.registerTileSet=function({rootId:e,referenceId:t,tileSet:n,onTileSetReadyCB:i}){var r=this._rootOccurrenceTos.get(e),o=(r&&r.occurrence).reference,s=this._getAutoInstanceId();this.registerReference(t,{handlerType:"tileSet",tileSet:n}),this.addChild(o.referenceId,t,{instanceId:s,matrix:null}),this.setForceReferenceLoad(t,!0,(()=>{var e=this.getTileSet(t);i.call(null,e)}))},N.prototype.setOverrideCB=function(e,t,n){void 0===n&&(console.warn("Calling setOverrideCB(...) without 3rd argument is deprecated"),n="#undefined#",this.registerOverrideSet(n));var i=this._overrideSetMap.get(n);i&&(this._getLDHReference(e).setOverrideCB(n,t,this._ldhNodeManager),i.add(e))},N.prototype.hasOverrideCB=function(e,t){return!!this._overrideSetMap.get(t)&&!!this._getLDHReference(e).hasOverrideCB(t)},N.prototype.registerOverrideSet=function(e){"#undefined#"!==e&&(this._ldhNodeManager.registerOverrideSet(e),this._overrideSetMap.has(e)||this._overrideSetMap.set(e,new Set))},N.prototype.clearOverrideSet=function(e){if("#undefined#"!==e){var t=this._overrideSetMap.get(e),n=this;t&&t.forEach((function(t){var i=n._getLDHReference(t,!0);i&&i.setOverrideCB(e,null,n._ldhNodeManager)}))}},N.prototype.removeOverrideSet=function(e){"#undefined#"!==e&&(this.clearOverrideSet(e),this._ldhNodeManager.removeOverrideSet(e),this._overrideSetMap.delete(e))},N.prototype.registerLeafReference=function(e,n){if(this._mode===N.Mode.ooc)throw new Error("Cannot mix slave and OOC");n.handlerType||console.warn("OOCManager.registerLeafReference: 'handler' parameter is deprecated - use registerHandlers() + 'handlerType' parameter"),u.slaveBoxFix=!this.disableSlaveBoxFix;var i=this._getOOCEntry(e,!0);if(!i){var r=n.node.getModelIdentification();if(r&&this.isRegistered(r))throw new Error("illegal node: used for another OOC reference");var o=this._handlers[n.handlerType]||n.handler||null;i=new t(e,{manager:this,handler:o.ldhHandler,boundingSphere:n.boundingSphere||null,boundingBox:n.boundingBox||null,leaf:!0,loadModelOptions:n.loadModelOptions}),this._referenceTos.set(e,i),n.node.setRenderPasses(["main","ooc"]),this._handleNewReference(i.reference,n),i.reference.updateBoundingElementImpostor(),this._ldhNodeManager.onSceneChange()}},N.prototype._handleNewReference=function(e,t){var n=new f({src:t.url||t.tileSet||t.src,noMeshInRAM:t.meshInRAM,active:!0,type:t.type||N.RepType.none,wms:t.wms});t.node&&(n.node=t.node);var i=e.referenceId,r=this._isMeshInRAMRequested(i,n);e.switchRepresentation(n,r,this._ldhNodeManager);var o=this._ldhNodeManager.switchRepresentationBuffer.get(i);o&&(o.rep.copyMissingParams(n),this._ldhNodeManager.switchRepresentationBuffer.delete(i),e.switchRepresentation(o.rep,r,this._ldhNodeManager,o.onSwitchRepCBArray)),e.is3DShape()&&this._on3DShapeAdd(),this._ldhNodeManager.registerTilesNode(e),this._activateOverrideSetManager(i,null)},N.prototype.switchRepresentation=function(e,t,n){var i=new f({url:t.url,type:t.type||N.RepType.none,wms:t.wms});if(i.url){var r=this._getLDHReference(e,!0),o=null;if(r&&!r.isLoading())return!r.isForced()&&r.isToUnload()||(o=n?[n]:null),r.switchRepresentation(i,this._isMeshInRAMRequested(e,i),this._ldhNodeManager,o,!0),this._ldhNodeManager.onSceneChange(),!o&&n&&S.call(n),!0;var s=this._ldhNodeManager.switchRepresentationBuffer.get(e);return s?(i.copyMissingParams(s.rep),s.setRep(i)):(s=new v(i),this._ldhNodeManager.switchRepresentationBuffer.set(e,s)),n&&(r?s.addOnSwitchRepCB(n):S.call(n)),!1}setTimeout(n)},N.prototype.lockGlobalMeshInRAM=function(){this._ldhNodeManager.lockGlobalMeshInRAM()},N.prototype.unlockGlobalMeshInRAM=function(){this._ldhNodeManager.unlockGlobalMeshInRAM(),this._ldhNodeManager.requestUpdate(!1)},N.prototype.lockReferenceMeshInRAM=function(e){if(this._lockMeshInRAMTos.has(e)){var t=this._lockMeshInRAMTos.get(e);t++,this._lockMeshInRAMTos.set(e,t)}else{this._lockMeshInRAMTos.set(e,1);var n=this._getLDHReference(e,!0);n&&n.switchMeshInRAM(!0,this._ldhNodeManager)}this._ldhNodeManager.switchNoMeshInRAMReferences.delete(e)},N.prototype.unlockReferenceMeshInRAM=function(e,t){if(this._lockMeshInRAMTos.has(e)){var n=this._lockMeshInRAMTos.get(e);if(0===--n||t){this._lockMeshInRAMTos.delete(e);var i=this._getLDHReference(e,!0);this._ldhNodeManager.getGlobalMeshInRAM(i)||this._ldhNodeManager.switchNoMeshInRAMReferences.add(e)}else this._lockMeshInRAMTos.set(e,n)}this._ldhNodeManager.requestUpdate(!1)},N.prototype.isRepresentationUpToDate=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return!(!n||!n.active)},N.prototype.getRepresentation=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getActiveRepresentation();return n&&n.getJSON()},N.prototype.unregisterLeafReference=function(e){var t=this._getOOCEntry(e).reference;t.isSlave()&&(t.getLDHNodeManagerQueue(this._ldhNodeManager).onNodeToRemoveFromList(),this._ldhNodeManager.unloadLeafReferenceCB&&this._ldhNodeManager.unloadLeafReferenceCB(e),t._rep.node=null,this._unregisterReference(e))},N.prototype.setUnloadLeafReferenceCB=function(e){this._ldhNodeManager.unloadLeafReferenceCB=e},N.prototype.setOnLeafReferenceLoadedCB=function(e){this._ldhNodeManager.onLeafReferenceLoadedCB=e},N.prototype.setOnSwitchRepCB=function(e){this._ldhNodeManager.onSwitchRepCB=e},N.prototype.setOnCycleDetectedCB=function(e){this._onCycleDetectedCB=e},N.prototype.isRegistered=function(e,t){var n=null!==this._getOOCEntry(e,!0),i=!!this._instanceTos.get(e);return n||!t&&i},N.prototype.isPLMReference=function(e){return null!==this._getOOCEntry(e,!0)},N.prototype.isPLMInstance=function(e){return!!this._instanceTos.get(e)},N.prototype.addRoot=function(e,t){if(this._mode===N.Mode.slave)throw new Error("Cannot mix slave and OOC");this._rootOccurrenceTos.forEach((function(t,n,i){if(t.occurrence.reference.referenceId===e)throw new Error("Multiple occurrences for root are unsupported")}));var i=this._getLDHReference(e),r=new Set,s=new n({reference:i,manager:this._ldhNodeManager,instanceData:u.createChildData(i,t.matrix||null,t.instanceId)},r),a=this._ldhNodeManager;s.updateMatrix(a),r.forEach((function(e){e.updateOverride(a)}));var d=w,l=new o(s,t.boundingBox,d,t.onLoadedCB);if(l.elasticLoading=!!t.elasticLoading,this._rootOccurrenceTos.set(d,l),w++,this._updateSceneMin(),i.setIsRoot(!0,this._ldhNodeManager,s),this._updateBoundingSphere(),this._ldhNodeManager.onAddRoot(),a.targetNode&&(s.setDepthFromParentNode(a.targetNode),i.requestBuildSceneGraphHierarchy(!0),a.tryBuildSceneGraphHierarchy()),this._externalNodeToNodeId.has(a.targetNode)){let t=this._externalNodeToNodeId.get(a.targetNode);this._ldhNodeManager.viewer._getIdPathOverrideWatcher().idPathWatcher.onCandidateAddChild(t,e)}if(i.getVDRP()){this._getPGManager().addRoot({referenceId:i.referenceId,rootId:d})}return d},N.prototype.getReframeBoundingSphere=function(){var e=this.getRootOccurrences(),t=null;return e.forEach((function(e,n,i){var r=e.occurrence,o=r.reference.getBoundingSphere(!0).clone();if(o.applyMatrix4(r.matrix),t){let e=t.clone();o.mergeWithSphere(t,e),t=e}else t=o})),t||new l.Sphere},N.prototype.removeRoot=function(e){var t=this._rootOccurrenceTos.get(e),n=t&&t.occurrence,i=n.reference;if(this._rootOccurrenceTos.delete(e),i.setIsRoot(!1,this._ldhNodeManager,n),i._occurrences.length>1){var r=new Set;n.detach(r),r.forEach((function(e){e._removeNullsFromOccurrenceList()}))}else this.removeReferenceTree(i.referenceId);var o=this._ldhNodeManager.getTileSets(i);if(o){let e=this._ldhNodeManager.viewer;if(e&&e._viewer360Manager){let t,n=[];for(t=0;t<o.length;t++){let e=o[t].oocTileSet;e.hasType("360")&&n.push(e)}n.length>0&&e._viewer360Manager.onTileSetsRemoved(n)}this._ldhNodeManager.removeTileSets(i)}this._ldhNodeManager.removeRemovedNodes(),this._ldhNodeManager.requestUpdate(!0),this._updateSceneMin();var s=this;this._overrideSetMap.forEach((function(e,t,n){var i,r=[];for(e.forEach((function(e){s._getLDHReference(e,!0)||r.push(e)})),i=0;i<r.length;i++)e.delete(r[i])})),this._updateBoundingSphere(),0===this._rootOccurrenceTos.size&&"auto"===this._initialMeshInRAM&&this._ldhNodeManager.unloadManager.restoreAutoMeshInRAM(),i.getVDRP()&&this._pgManager.removePGRoot(e)},N.prototype.isRootAlive=function(e){return!!this._rootOccurrenceTos.get(e)},N.prototype.setRootEnabled=function(e,t){var n=this._rootOccurrenceTos.get(e);n?(t=!!t,n.enableExpand!==t&&(n.enableExpand=t,t&&this._ldhNodeManager.forceFullVP())):console.warn("Unknown rootId: '"+e+"'")},N.prototype.freezeRoot=function(e,t){let n=this._rootOccurrenceTos.get(e);var i=n.occurrence.reference;n.isLarge=!(!t||!t.isLarge),i.freezeUnload(),this.setRootEnabled(e,!1)},N.prototype.declareTreeModified=function(e){var t=this._rootOccurrenceTos.get(e);t&&(t.treeModified=!0,this._ldhNodeManager.forceFullVP())},N.prototype.isRepRef=function(e){var t=this._getLDHReference(e,!0);return!!t&&t.isLeaf()},N.prototype.createReferenceIterator=function(e){var t=this._getLDHReference(e,!0);return t&&new r(t)},N.prototype.notifyRootVisibilityChange=function(e,t){var n=this._rootOccurrenceTos.get(e);n&&(n.visible=!!t,this._updateBoundingSphere())},N.prototype.isCPUMemoryFull=function(){if(this._cycleDetected)return!0;var e=!this._ldhNodeManager.unloadManager.isLoadingAllowed(1);if(e&&this._instRefGraphTransaction){if(!this._instRefGraphTransaction.unloadTried){this._instRefGraphTransaction.unloadTried=!0;var t=this._ldhNodeManager.createViewpointData();this._ldhNodeManager.standardUnloadNodes(!0,t),e=!this._ldhNodeManager.unloadManager.isLoadingAllowed(1)}e&&this._instRefGraphTransaction.onCPUMemoryFull(this)}return e},N.prototype._unregisterReference=function(e){var t=this._getLDHReference(e,!0);if(t){t.children.length>0&&console.log("_unregisterReference internal error"),t&&(t.is3DShape()&&this._on3DShapeRemove(),t.setStatus(i.dead,this._ldhNodeManager),this._ldhNodeManager.unregisterNode(t),t.updateMemorySizeNEW(this._ldhNodeManager)),this._referenceTos.delete(e);var n=this._ldhNodeManager.viewer._getIdPathOverrideWatcher();if(n)n.idPathWatcher.onCandidateRemoveSingle(e)}},N.prototype._unregisterInstance=function(e){this._instanceTos.delete(e),this._ghostInstances.delete(e),this._pgManager.unregisterDerivedInstanceId(e);var t=this._ldhNodeManager.viewer._getIdPathOverrideWatcher();t&&t.idPathWatcher.onCandidateRemoveSingle(e)},N.prototype.addChild=function(e,t,n){var i=this._getLDHReference(e,!0);if(i){var r=this._getLDHReference(t);let c=i.getVDRP();if(!c||n._vdrpUpdate){if(!n._vdrpUpdate&&r.getVDRP())throw new Error("parent reference needs positioningArch flag");var o=this._ldhNodeManager.viewer._getIdPathOverrideWatcher(),s=o.idPathWatcher,a=n.instanceId,d=new Set,l=!1;this._instanceTos.get(a)||(i.addReferenceChild(r,n.matrix||null,a,d,this._ldhNodeManager)||(l=!0),a&&this._instanceTos.set(a,i)),l&&(this._cycleDetected=!0,this._onCycleDetectedCB&&this._onCycleDetectedCB()),c&&!n.matrix&&this._ghostInstances.add(a),null!==this._instRefGraphTransaction&&this._instRefGraphTransaction.onAddChild(i),this._ldhNodeManager.tryBuildSceneGraphHierarchy();var h=this._ldhNodeManager;d.forEach((function(e){e.updateOverride(h)})),i.isUnloadFrozen()&&r.freezeUnload(),this._ldhNodeManager.progressiveExpand||this._ldhNodeManager.onSceneChange(),this._activateOverrideSetManager(a,null),o.onSceneGraphUpdate(),s.onCandidateAddSingle(n.instanceId),s.onCandidateAddChild(e,n.instanceId),s.onCandidateAddChild(n.instanceId,t)}else{this._getPGManager().registerOOCInstance({parentId:e,childId:t,instanceId:n.instanceId,matrix:n.matrix})}}},N.prototype.createNodeIdOverrideSetManager=function(e){this._overrideSetManagerMap||(this._overrideSetManagerMap=new Map);var t=this._overrideSetManagerMap.get(e);if(!t){var n=this._ldhNodeManager.viewer.getIdPathMatcher().idToNode(e);n?((t=n.createOverrideSetManager()).nodeId=e,t._idPathOverrideWatcher=this._ldhNodeManager.viewer._getIdPathOverrideWatcher()):t=this._pgManager.getPGOOCInstance(e)?new _({nodeId:e,oocManager:this}):new M({active:!1,nodeId:e,idPathOverrideWatcher:this._ldhNodeManager.viewer._getIdPathOverrideWatcher()}),t&&(t._setOOCManager(this),t._setPGManager(this._getPGManager())),this._overrideSetManagerMap.set(e,t),this._activateOverrideSetManager(e,null)}return t},N.prototype.removeNodeIdOverrideSetManager=function(e){this._overrideSetManagerMap||(this._overrideSetManagerMap=new Map),this._overrideSetManagerMap.has(e.nodeId)&&(this._overrideSetManagerMap.delete(e.nodeId),e._removeNodeId())},N.prototype.getOccurrencesMatrices=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i,r=t.getAllMatrices(),o=[];for(i=0;i<r.length;i++)(n=r[i])&&o.push(n.clone());return o}return null},N.prototype._onRepLoaded=function(e){null!==this._instRefGraphTransaction&&this._instRefGraphTransaction.onAddChild(e)},N.prototype.getReferenceUrl=function(e){return this._getLDHReference(e)._rep.url},N.prototype.getReferenceBoundingSphere=function(e){var t=this._getLDHReference(e);return t.updateBoundingSphere(),t._boundingSphere&&t._boundingSphere.clone()},N.prototype.getReferenceBoundingBox=function(e){var t=this._getLDHReference(e).getBoundingBox();return t&&t.clone()},N.prototype._getOOCEntry=function(e,t){var n=this._referenceTos.get(e);if(!t&&!n)throw new Error("Unknown OOC referenceId: '"+e+"'");return n||null},N.prototype._getLDHReference=function(e,t){var n=this._getOOCEntry(e,t);return n?n.reference:null},N.prototype._getInstance=function(e){return this._instanceTos.get(e)},N.prototype.getSceneGraphNode=function(e){var t,n=this._getLDHReference(e,!0);if(n)return n._rep.node;if(n=this._instanceTos.get(e))for(t=0;t<n.children.length;t++){var i=n.children[t];if(i.instanceId===e)return i.node}return null},N.prototype.forceReferenceLoad=function(e,t){this.setForceReferenceLoad(e,!0,t)},N.prototype.setForceReferenceLoad=function(e,t,n){var i=this,r=i._getLDHReference(e,!0);r&&!r.isError()?this._ldhNodeManager.executeReferenceAction([r],(function(e){var r,o;for(r=0;r<e.length;r++)(o=e[r]).forceLoad(!!t,n,i._ldhNodeManager),i._ldhNodeManager.forceUpdateNode(o);i._ldhNodeManager.requestUpdate(!0)})):setTimeout(n,0)},N.prototype.setUserData=function(e,t,n){var i,r,o=!1,s=this._getLDHReference(e,!0);if(s)s.userData=t,o=!0,(i=s.getNode())&&i.setUserData(t);else if(!(s=this._instanceTos.get(e))||!n&&s.getVDRP()){if(!n){let n=this._pgManager.getPGOOCInstance(e);n&&(o=!0,n.setUserData(t,this))}}else for(r=0;r<s.children.length;r++){var a=s.children[r];a.instanceId===e&&(a.userData=t,o=!0,a.node&&a.node.setUserData(t))}if(!o)throw new Error("unknown id")},N.prototype.getUserData=function(e){var t=this._getLDHReference(e,!0);if(t)return t.userData;if((t=this._instanceTos.get(e))&&!t.getVDRP()){var n;for(n=0;n<t.children.length;n++){var i=t.children[n];if(i.instanceId===e)return i.userData}}else{let t=this._pgManager.getPGOOCInstance(e);if(t)return t.userData}throw new Error("unknown id")},N.prototype.setOnStartLoadingCB=function(e){this._ldhNodeManager.setOnStartLoadingCB(e)},N.prototype.setOnEndLoadingCB=function(e){this._ldhNodeManager.setOnEndLoadingCB(e)},N.prototype.addOnStartLoadingCB=function(e){return this._ldhNodeManager.addOnStartLoadingCB(e)},N.prototype.addOnEndLoadingCB=function(e){return this._ldhNodeManager.addOnEndLoadingCB(e)},N.prototype.removeLoadingCB=function(e){this._ldhNodeManager.removeLoadingCB(e)},N.prototype.setOnAddedToSceneGraphCB=function(e,t){this._getLDHReference(e).setOnAddedToSceneGraphCB(t)},N.prototype.setOnRemovedFromSceneGraphCB=function(e,t){this._getLDHReference(e).setOnRemovedFromSceneGraphCB(t)},N.prototype.getAllReferences=function(){var e=[];return this._referenceTos.forEach((function(t,n,i){e.push(n)})),e},N.prototype.switchLOD=function(e,t,n,r,o){var s=this._getLDHReference(e),a=this._ldhNodeManager;this._ldhNodeManager.executeReferenceAction([s],(function(e,s){var d,l,h=0;function c(){for(d=0;d<e.length;d++){e[d].userUnlockUnload()}0===--h&&n&&(n(),n=null)}for(d=0;d<e.length;d++){var u;(u=e[d]).isToUnload()||u.isWaiting()||(u.userLockUnload(),h++,u.addOnLoadedCB(c)),(l=u.getActiveRepresentation())&&(l.setUrlAndType(t,r||N.RepType.none),l.setWMS(o)),u.removeFromSceneGraph(!0,a),u.setStatus(i.waiting,a),a.registerTilesNode(u)}0===h&&setTimeout(n,1),s()})),this._ldhNodeManager.onSceneChange()},N.prototype.getNbChildren=function(e){return this._getLDHReference(e).children.length},N.prototype.isReferenceComplete=function(e){return this.isReferenceLoaded(e)},N.prototype.isReferenceLoaded=function(e){var t=this._getLDHReference(e,!0);return null!==t&&(t.isLoaded()||t.isToUnload())},N.prototype.dumpAllMemorySize=function(e){this._referenceTos.forEach((function(t,n,i){var r=t.reference;e&&r.updateMemorySize(),console.log(n+" "+r.memorySize)})),console.log("TOTAL "+this._ldhNodeManager.unloadManager.memoryUsage)},N.prototype.startInstRefGraphTransaction=function(){this._instRefGraphTransaction&&console.log("ERROR - A transaction already exists"),this._instRefGraphTransaction=new P,this._ldhNodeManager.instRefTransactionCPUMemoryFullOccurred=!1},N.prototype.endInstRefGraphTransaction=function(){this._instRefGraphTransaction.endTransaction(this),this._instRefGraphTransaction=null},N.prototype.addSceneGraphLock=function(e){var t=this._getLDHReference(e,!0);return!!t&&(t.requestBuildSceneGraphHierarchy(!0),t.userLockUnload(),this._ldhNodeManager.tryBuildSceneGraphHierarchy(),!0)},N.prototype.removeSceneGraphLock=function(e){var t=this._getLDHReference(e,!0);return!!t&&(t.userUnlockUnload(),!0)},N.prototype.isSceneGraphLocked=function(e){return this.getSceneGraphLockCounter(e)>0},N.prototype.getSceneGraphLockCounter=function(e){var t=this._getLDHReference(e,!1);return t._optional?t._optional.userLockUnload:0},N.prototype.getRootOccurrences=function(){return this._rootOccurrenceTos},N.prototype.getRoots=function(){var e=[];return this._rootOccurrenceTos.forEach((t=>{var n=t.occurrence.reference.referenceId;e.indexOf(n)<0&&e.push(n)})),e},N.prototype.getIdPathesLeadingToReference=function(e){var t=null,n=this._getLDHReference(e,!0);if(n){t=[];var i,r,o=n.getLDHOccurrences();for(i=0;i<o.length;i++)r=o[i].getIdPath(),t.push(new m(r))}return t},N.prototype.setDisableFullVP=function(e){!e&&this._ldhNodeManager.disableFullVP&&this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.disableFullVP=e},N.prototype.setFullVPScreenRadius=function(e){this._ldhNodeManager.fullVPScreenRadius=e},N.prototype._getDebugJSON=function(){var e={references:{},roots:[]};return this._referenceTos.forEach((function(t,n,i){e.references[n]=t.reference.buildDebugJSON(!0,!0)})),this._rootOccurrenceTos.forEach((function(t,n,i){var r=t.occurrence;e.roots.push(r.reference.referenceId)})),e},N.prototype._getReferenceDebugJSON=function(e){var t=this._getLDHReference(e,!0);return t?t.buildDebugJSON():null},N.prototype._getAllInstancesDebugJSON=function(){var e={};return this._instanceTos.forEach((function(t,n,i){var r,o;for(r=0;r<t.children.length;r++)(o=t.children[r]).instanceId===n&&(e[n]={parent:t.referenceId,child:o.reference.referenceId})})),e},N.prototype._getSingleInstanceDebugJSON=function(e){var t,n,i=this._instanceTos.get(e);if(i)for(t=0;t<i.children.length;t++)if((n=i.children[t]).instanceId===e)return{instanceId:e,parent:i.referenceId,child:n.reference.referenceId};return null},N.prototype.setPauseLoading=function(e,t){var n=this._ldhNodeManager.getPauseLoading();this._ldhNodeManager.setPauseLoading(!!e,t),n&&!this._ldhNodeManager.getPauseLoading()&&(this._ldhNodeManager.viewpointHasChangedSinceLastFullVP&&this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.requestUpdate(!0))},N.prototype.forceRefresh=function(){this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.requestUpdate(!0)},N.prototype.setReferenceLoadModelOptions=function(e,t){this._getLDHReference(e).setLoadModelOptions(t)},N.prototype.getReferenceLoadModelOptions=function(e){this._getLDHReference(e).setLoadModelOptions(loadModelOptions)},N.prototype.getReferenceLoadModelOptions=function(e){var t=this._getLDHReference(e);return t._optional&&t._optional.loadModelOptions},N.prototype.setPerformancesOptions=function(e){e.fullAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!0,!0]),e.repAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!0,!1]),e.noAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!1,!1]),void 0!==e.pauseLoadingDuringViewpointMove&&this._ldhNodeManager.setPauseLoadingDuringViewpointMove(!!e.pauseLoadingDuringViewpointMove)},N.prototype.getWorldMatrix=function(e,t){let n=0;for(;t[n]&&this.isExternalNodeId(t[n]);)n++;let i,r,o=this._rootOccurrenceTos.get(e).occurrence;for(i=n+1;i<t.length;i+=2){r=o.getChildren();let e,n=!1;for(e=0;e<r.length;e++)r[e].instanceData.instanceId===t[i]&&(o=r[e],n=!0);if(!n)throw new Error("inconsistent path")}return o.matrix.clone()},N.prototype.getVDRPIdPathWorldMatrix=function(e,t){let n=t._buildInternalIdPathes(this,null);if(n&&1===n.length){let t=n[0].ids;return this.getWorldMatrix(e,t)}return null},N.prototype.addUserQueue=function(e){this._ldhNodeManager.addUserQueue(e)},N.prototype.removeUserQueue=function(e){this._ldhNodeManager.removeUserQueue(e)},N.prototype.setCandidateQueueRendererParams=function(e,t){this._ldhNodeManager.setCandidateQueueRendererParams(e,t)},N.prototype.setExpandAllowed=function(e,t){},N.prototype._updateSceneMin=function(){var e=0,t=!1;(this._rootOccurrenceTos.forEach((function(n,i,r){if(n.boundingBox){var o=n.computeSceneMin();(!t||o<e)&&(e=o,t=!0)}})),t)&&this._ldhNodeManager.viewer.forceSceneMin(e)},N.prototype.getSelectedPath=function(e){var t,n,i={hso:s,pso:a,cso:d}[e=e||"hso"].get(),r=[],o=[];for(t=0;t<i.length;t++)r=void 0!==(n=i[t].pathElement).instanceId&&this._ldhNodeManager.queueRenderer?this._ldhNodeManager.queueRenderer.getPathFromPathElement(n):x(n),o.push(r);return o&&1===o.length?o[0]:o},N.prototype.getSelectedReference=function(e){var t,n,i,r,o={hso:s,pso:a,cso:d}[e=e||"hso"].get(),l=[];for(t=0;t<o.length;t++)void 0!==(n=o[t].pathElement).instanceId&&this._ldhNodeManager.queueRenderer?r=this._ldhNodeManager.queueRenderer.getReferenceFromPathElement(n):(r=(i=this._mode===N.Mode.slave?O(n):x(n))[i.length-1],this.isRegistered(r,!0)||(r=null)),l.push(r);return l&&1===l.length?l[0]:l},N.prototype.registerExternalSceneGraphNode=function(e,t){if(null===t){var n=this._externalNodeIdToNode.get(e);this._externalNodeIdToNode.delete(e),this._externalNodeToNodeId.delete(n)}else{if(t===this._ldhNodeManager.targetNode&&!this._externalNodeIdToNode.has(e)){let t=this._ldhNodeManager;this._rootOccurrenceTos.forEach((function(n,i,r){var o=n.occurrence.reference.referenceId;t.viewer._getIdPathOverrideWatcher().idPathWatcher.onCandidateAddChild(e,o)}))}this._externalNodeToNodeId.set(t,e),this._externalNodeIdToNode.set(e,t)}},N.prototype.setLoadingBoxesPickable=function(e){if(this._ldhNodeManager.queueRenderer){var t=this._ldhNodeManager.createViewpointData();this._ldhNodeManager.queueRenderer.setPickable(e,!1,t)}},N.prototype.showPerfos=function(){h.setAutoRefresh(!1),this._ldhNodeManager.viewer.showPerfo(!0,!1)},N.prototype._updateBoundingSphere=function(){var e=null;this._rootOccurrenceTos.forEach((function(t,n,i){var r=t.occurrence,o=null;t.visible&&r.reference.hasRootBoundingElement()&&(o=r.getBoundingSphere()),o&&(e?e.clone().mergeWithSphere(o,e):e=o.clone())}));var t=this._ldhNodeManager.targetNode;if(e&&t&&1===t._occurrences.length){var n=t._occurrences[0].matrix;n&&!n.isIdentity()&&e.applyMatrix4(n)}this._ldhNodeManager.setBoundingSphere(e)},N.prototype.isSlave=function(){return this._mode===N.Mode.slave},N.prototype.isOOC=function(){return this._mode===N.Mode.ooc},N.prototype._debug_UnloadReference=function(e){var t=!1,n=this._ldhNodeManager.createViewpointData(),i=this._getLDHReference(e,!0);return i&&(t=this._ldhNodeManager.unloadNode(i,n),this.setPauseLoading(!0),this._ldhNodeManager.viewer.render()),t},N.prototype._startModelLoaderTransaction=function(){this._instRefGraphTransaction&&console.log("ERROR - A transaction already exists"),this._instRefGraphTransaction=new P},N.prototype._endModelLoaderTransaction=function(){this._instRefGraphTransaction.endTransaction(this),this._instRefGraphTransaction=null},N.prototype._updateOccurrences=function(e){if(!this.isSlave()){var t,n,i,r=this._ldhNodeManager;for(t=0;t<e.length;t++)n=e[t].getLastId(),(i=this._getLDHReference(n,!0))?i.requestUpdateOccurrencesPosition(r,null):(i=this._instanceTos.get(n))&&i.requestUpdateOccurrencesPosition(r,n)}},N.prototype.hasMeshInRAM=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return!!n&&(!(!n.node||!t.isLoaded()&&!t.isToUnload())&&n.hasMeshInRAM())},N.prototype.isMeshInRAMRequested=function(e){return this._isMeshInRAMRequested(e)},N.prototype.getRepType=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return n?n.type:null},N.prototype.getRequestedRepType=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getActiveRepresentation();return n?n.type:null},N.prototype.hasRoot=function(){return this._rootOccurrenceTos.size>0},N.prototype.hasActiveRoot=function(){return this._ldhNodeManager.getRootsToExpand().length>0},N.prototype.getInstanceParentReferenceId=function(e){var t=this._instanceTos.get(e);let n=t?t.referenceId:null;return n||(n=this._pgManager.getOOCRerenceIdFromInstanceId(e)),n},N.prototype.getInstanceChildReferenceId=function(e){var t=this._instanceTos.get(e),n=t?t.getChild(e):null;if(n)return n.reference.referenceId;return this._pgManager.getOOCChildReference(e)||null},N.prototype.removeInstance=function(e){var t=this._instanceTos.get(e);if(!t)throw new Error("Unknown instanceId");var n=t.getChild(e);if(!n)throw new Error("Bad instanceId");t.detachReference(n.reference,e,!0,this)},N.prototype.removeInstanceTree=function(e){var t=this._instanceTos.get(e);if(!t)throw new Error("Unknown instanceId");var n=t.getChild(e);if(!n)throw new Error("Bad instanceId");t.detachReference(n.reference,e,!0,this),0!==n.reference.parents.length||n.reference.isRoot||this.removeReferenceTree(n.reference.referenceId)},N.prototype.removeReference=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i=t.parents;for(t.detachReference(null,null,!0,this),n=0;n<i.length;n++)i[n].detachReference(t,null,!1,this);t.parents.length=0,this._unregisterReference(e)}},N.prototype.removeReferenceTree=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i=t.parents,r=new Set;for(t.detachReference(null,null,!0,this,r),n=0;n<i.length;n++)i[n].detachReference(t,null,!1,this);t.parents.length=0;var o=this;r.forEach((function(e){e.detachReference(null,null,!0,o),e.parents.length=0,o._unregisterReference(e.referenceId)})),this._unregisterReference(e)}},N.prototype.updateInstance=function(e,t){if(!t.instanceId||t.instanceId===e||!this._instanceTos.get(t.instanceId)){var n=this._instanceTos.get(e);if(!n)throw new Error("Unknown instanceId");n.updateInstance(e,t,this._ldhNodeManager),t.instanceId&&t.instanceId!==e&&(this._unregisterInstance(e),this._instanceTos.set(t.instanceId,n))}},N.prototype._initIdPathMatcher=function(){var e=this._ldhNodeManager.viewer,t=this;var n=new c({idToNodeCB:function(e){var n=t._externalNodeIdToNode.get(e);if(n)return n;if("string"==typeof e&&e.startsWith("##REP##")){var i=e.substring(7),r=t._getLDHReference(i,!0);return r?r.getCGRNode():null}return t.getSceneGraphNode(e)},nodeToIdCB:function(e){if(!e)return null;var n=t._externalNodeToNodeId.get(e);return n||((n=e.getModelIdentification())||(n=u.weakCGRNodeMap.get(e)||null),n)},isNodeRepRefCB:function(e){var n,i=t._externalNodeToNodeId.get(e);return!i&&(i=e.getModelIdentification(),!!(n=t._getLDHReference(i,!0))&&n.isLeaf())}});e.setIdPathMatcher(n),g.setParams({useIdPathMatcher:!0,viewer:e,oocManager:this})},N.prototype.setUsePickingAccelerationStructure=function(e,t){var n=this._usePickingAccelerationStructure;this._usePickingAccelerationStructure=!!e,e&&n!==this._usePickingAccelerationStructure?this._doMassiveReload(t):t&&setTimeout(t,0)},N.prototype.registerCustomTilesManager=function(e){this._ldhNodeManager.tilesManager.registerCustomContentManager(e)},N.prototype.getUsePickingAccelerationStructure=function(){return this._usePickingAccelerationStructure},N.prototype.loadBox=function(e,t,n,i){if(this._boxes.has(t))throw new Error("box with name "+t+" already exists");this._boxes.set(t,null),y.startProbe("box_"+t);var r,o,s,a,d=localStorage.getItem("OOCBoxDebug");let l=0;d&&(r=performance.now()),this._ldhNodeManager.boxQuery(e,(e=>{d&&(o=performance.now());let i=e.length,h=[];for(let t=0;t<i;t++){let n=this._getLDHReference(e[t]);h.push({obj:n,skip:!1})}var c,u,p=()=>{if(--c===l){var u;for(d&&(s=0,a=0),u=0;u<i;u++){let t=h[u];d&&(s+=t.obj.byteSize,t.skip&&(a+=t.obj.byteSize)),t.skip||(this.addSceneGraphLock(e[u]),this.setForceReferenceLoad(e[u],!1,null))}if(y.endProbe("box_"+t),d){var p=performance.now();console.log("skipped"+a+" of "+s+" bytes or "+a/s*100+"% of total size"),console.log("box query : "+(o-r)/1e3+" / "+i+" cgrs : "+(p-o)/1e3)}n(t)}};if(c=i,this._boxes.has(t))if(this._boxes.set(t,e),i>0){var g=localStorage.getItem("OOCBoxMinSize");for(u=0;u<i;u++){let t=h[u];if(null!=g){let e=t.obj.getBoundingSphere();if(e&&2*e.radius<g){l++,t.skip=!0;continue}}this.forceReferenceLoad(e[u],p)}l&&d&&console.log(l+" objects can be skipped")}else{if(y.endProbe("box_"+t),d){var f=performance.now();console.log("box query : "+(o-r)/1e3+" / "+i+" cgrs : "+(f-o)/1e3)}n(t)}}),(e=>{i(t,e)}))},N.prototype.releaseBox=function(e){if(!this._boxes.has(e))throw new Error("box with name "+e+" does not exist");var t,n=this._boxes.get(e);if(this._boxes.delete(e),n)for(t=0;t<n.length;t++)this.removeSceneGraphLock(n[t])},N.prototype.getTileSet=function(e){var t=this._getLDHReference(e,!0),n=null;if(t){var i=this._ldhNodeManager.getTileSets(t);n=i?i[0].oocTileSet:null}return n},N.prototype.getTileSets=function(e){var t=this._getLDHReference(e,!0),n=null;if(t){var i,r=this._ldhNodeManager.getTileSets(t);if(r)for(n=[],i=0;i<r.length;i++)n.push(r[i].oocTileSet)}return n},N.prototype.getTileSetsWithContentType=function(e,t){var n=this._getLDHReference(e,!0),i=null;if(n){var r,o,s,a,d=this._ldhNodeManager.getTileSets(n);if(d)for(i=[],r=0;r<d.length;r++)s=(o=d[r]).getRootNode(),a=o.oocTileSet.hasType(t),s.traverse((e=>(e.hasContentType(t)&&(a=!0),a))),a&&i.push(d[r].oocTileSet)}return i},N.prototype.registerHandlers=function({repRef:e,ref:t,tileSet:n}){this._handlers.repRef?console.warn("registerHandlers repRef ignored since already valued"):this._handlers.repRef=e,this._handlers.ref?console.warn("registerHandlers ref ignored since already valued"):this._handlers.ref=t,this._handlers.tileSet?console.warn("registerHandlers tileSet ignored since already valued"):this._handlers.tileSet=n},N.prototype.setSplattingParameters=function(e){this._ldhNodeManager.tilesManager.setSplattingParameters(e)},N.prototype.getHandler=function(e){return this._handlers[e]},N.prototype._doMassiveReload=function(e){var t,n,i,r,o=this.getAllReferences(),s=o.length,a=function(){s--,e&&0===s&&e()};for(t=0;t<o.length;t++)n=o[t],(r=this._getLDHReference(n)).isLeaf()?(i=r.getActiveRepresentation(),n=o[t],this.switchLOD(n,i.url,a,i.type,i.wms)):s--},N.prototype._getActiveRootLDHReferences=function(){var e=[];return this._rootOccurrenceTos.forEach((function(t,n,i){(t.enableExpand||t.treeModified)&&e.push(t.occurrence.reference)})),e},N.prototype.hasLargeAssemblyRoot=function(){var e=!1;return this._rootOccurrenceTos.forEach((function(t,n,i){t.isLarge&&(e=!0)})),e},N.prototype._dispose=function(){this._ldhNodeManager.dispose()},N.prototype.replace360Root=function({fromRootId:e,toRootId:t,removeFromRoot:n,onTransitionCompleteCB:i}){let r=!1;function o(e,t){let n=t._rootOccurrenceTos.get(e),i=(n&&n.occurrence).reference,r=i&&t.getTileSetsWithContentType(i.referenceId,"360");return r&&1===r.length?r[0]:null}let s=o(e,this),a=o(t,this);if(s&&a){let t=this._ldhNodeManager.viewer._viewer360Manager;t&&t.start360TileSetTransition&&(t.start360TileSetTransition(s,a,i),r=!0),n&&this.removeRoot(e)}return r},N.prototype.replaceTileSetRoot=function(e,t,n){n=n||{};let i={};for(let e in n)i[e]=n[e];let r=n.onRemovedCB||null,o=n.onLoadedCB||null,s=n.onTransitionCompleteCB||null;i.onLoadedCB=()=>{let t=!1;n.userRequest360&&this.replace360Root({fromRootId:e,toRootId:a,removeFromRoot:!1,onTransitionCompleteCB:s})&&(t=!0),this.removeRoot(e),r&&r(),o&&o(),!t&&s&&s()};let a=this.addRoot(t,i);return a},N.prototype.renderToTargetOOC=function({buffer:e,viewpoint:t,subScreen:n,effectsOverride:i,onRenderCB:r}){this._ldhNodeManager.renderToTargetOOC({buffer:e,viewpoint:t,subScreen:n,effectsOverride:i,onRenderCB:r})},N.prototype._isMeshInRAMRequested=function(e,t){var n=this._getLDHReference(e,!0),i=n&&n.getLoadModelOptions();return i&&void 0!==i.noMeshInRAM?!i.noMeshInRAM:this._defaultLoadModelOptions&&void 0!==this._defaultLoadModelOptions.noMeshInRAM?!this._defaultLoadModelOptions.noMeshInRAM:!(!this._ldhNodeManager.getGlobalMeshInRAM(n,t)&&!this._lockMeshInRAMTos.has(e))},N.prototype._onRootReferenceLoaded=function(e){let t=this._getLDHReference(e,!0),n=!1,i=this._ldhNodeManager.viewer;if(t){var r=this._ldhNodeManager.getTileSets(t);if(r&&i){let e;for(e=0;e<r.length;e++)r[e].oocTileSet.hasType("360")&&(n=!0)}}n&&i._on360TileSetAddedBefore();let o=!1;this._rootOccurrenceTos.forEach(((t,n,i)=>{if(t&&t.occurrence.reference.referenceId===e){if(!t.boundingBox){let e=t.occurrence.reference,n=e&&e.getBoundingBox();n=n&&n.clone(),n&&(t.boundingBox=n,o=!0)}t.onLoadedCB&&t.onLoadedCB(e)}})),n&&i._on360TileSetAddedAfter(),o&&(this._updateSceneMin(),i.render({updateInfinitePlane:!0})),this._updateBoundingSphere()},N.prototype._onNodeCreate=function(e){var t=e.getModelIdentification();this._activateOverrideSetManager(t,e)},N.prototype._onNodeRemove=function(e){var t=e.getModelIdentification(),n=this._overrideSetManagerMap&&this._overrideSetManagerMap.get(t);n&&n._deactivate()},N.prototype._activateOverrideSetManager=function(e,t){var n=this._overrideSetManagerMap&&this._overrideSetManagerMap.get(e);if(n){let t=this._getLDHReference(e,!0)||this._getInstance(e);t&&t.setSceneGraphOverrideSet(e,n)}},N.prototype._computeUnitValue=function(e){return e?N.unitsTable[e]:1},N.prototype.getUnitValue=function(){return this._unitValue},N.prototype._registerPositionOverrideSet=function(e,t){this._idToPositionOverrideSets||(this._idToPositionOverrideSets=new Map);var n=this._idToPositionOverrideSets.get(e);n||(n=[],this._idToPositionOverrideSets.set(e,n)),-1===n.indexOf(t)&&n.push(t);var i=this._getLDHReference(e,!0),r=null;i||(i=this._getInstance(e),r=e),i&&i.updateOccurrencesPosition(this._ldhNodeManager,r),this._ldhNodeManager.requestUpdate(!0)},N.prototype._unregisterPositionOverrideSet=function(e,t){var n=this._idToPositionOverrideSets&&this._idToPositionOverrideSets.get(e);if(n){var i=n.indexOf(t);i>=0&&n.splice(i,1),0===n.length&&this._idToPositionOverrideSets.delete(e)}var r=this._getLDHReference(e,!0),o=null;r||(r=this._getInstance(e),o=e),r&&r.updateOccurrencesPosition(this._ldhNodeManager,o),this._ldhNodeManager.requestUpdate(!0)},N.prototype._findPositionOverride=function(e,t){var n=e.getIdPath(t);if(this._idToPositionOverrideSets){var i,r,o,s,a=this._idToPositionOverrideSets.get(n[n.length-1]),d=[];if(a){for(r=0;r<a.length;r++){var l;if(o=a[r],i=this._overrideSetManagerMap.get(o.rootId))if(s=i.getSceneGraphOverrideSetIndex(o),(l=n.indexOf(o.rootId))>=0){let e=n.slice(l),t=o._getPositionOverrides(e);t&&t.length>0&&d.push({depth:e.length,override:t[t.length-1],index:s})}}let e=-1,t=null,h=-1;for(r=0;r<d.length;r++)(d[r].depth>e||d[r].depth===e&&h<d[r].index)&&(e=d[r].depth,t=d[r].override,h=d[r].index);return t}}return null},N.prototype._getAutoInstanceId=function(){return"##OOCManager##Instance"+this._nextInstanceAutoId++},N.prototype.hasVirtualProduct=function(){return this._3DShapeCounter>0},N.prototype._on3DShapeAdd=function(){if(this._3DShapeCounter++,1===this._3DShapeCounter){let e=this._ldhNodeManager.viewer;e._modelEvent.publish({event:"VirtualProductAdded",data:{viewer:e}})}},N.prototype._on3DShapeRemove=function(){if(this._3DShapeCounter>0&&(this._3DShapeCounter--,0===this._3DShapeCounter)){let e=this._ldhNodeManager.viewer;e._modelEvent.publish({event:"VirtualProductRemoved",data:{viewer:e}})}},N.prototype.updateServerProperties=function(e){void 0!==e.isCloud&&(this._serverProperties.isCloud=!!e.isCloud),void 0!==e.isElasticLoading&&(this._serverProperties.isElasticLoading=!!e.isElasticLoading)},N.prototype.isElasticCloud=function(){return this._serverProperties.isCloud&&this._serverProperties.isElasticLoading},N.prototype._debug_getLastLoadingTime=function(){return this._ldhNodeManager.lastDeltaTime},N.prototype.isExternalNodeId=function(e){return this._externalNodeIdToNode.has(e)},N.prototype.getExternalNode=function(e){return this._externalNodeIdToNode.get(e)},N.prototype.registerPAAxisReference=function({referenceId:e}){this._getPGManager().registerPGReference({referenceId:e})},N.prototype.registerPAAxisInstance=function({parentReferenceId:e,childReferenceId:t,instanceId:n,matrix:i}){this._getPGManager().registerPGInstance({parentId:e,childId:t,instanceId:n,matrix:i})},N.prototype.addPSInstanceToAxisLink=function({contentInstanceId:e,axisReferenceId:t}){this._getPGManager().addPGLink({oocInstanceId:e,positionGraphReferenceId:t})},N.prototype.registerPositionArchLink=function({rootId:e,axisReferenceId:t}){this._getPGManager().registerPositionArchLink(e,t)},N.prototype._getPGManager=function(){return this._pgManager},N.prototype.getTilesManager=function(){return this._oocTilesManager},N.unitsTable={mm:1,cm:10,dm:100,m:1e3,dam:1e4,hm:1e5,km:1e6};var P=function(){this.updatedRefencesMap=new Map,this.unloadTried=!1};return P.prototype.onAddChild=function(e){this.updatedRefencesMap.set(e,!0)},P.prototype.endTransaction=function(e){let t=e._getPGManager();t&&t.updateOOCInstances(e);var n=[];this.updatedRefencesMap.forEach((function(e,t,i){var r=t;r&&n.push(r)})),e._ldhNodeManager.onInstRefGraphTransactionEnd(n)},P.prototype.onCPUMemoryFull=function(e){e._ldhNodeManager.instRefTransactionCPUMemoryFullOccurred=!0},require(["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Selection/HSOManager","DS/Visualization/PathElement"],(function(e,t,n,i,r){var o=null;window.OOCShowReferenceBoundingSphere=function(i,r,s,a){var d=r._getLDHReference(i),l=d.getBoundingBox(),h=d.getNode(),c={cornerPoint:l.min,firstAxis:new t.Vector3(l.max.x-l.min.x,0,0),secondAxis:new t.Vector3(0,l.max.y-l.min.y,0),thirdAxis:new t.Vector3(0,0,l.max.z-l.min.z),material:new t.MeshBasicMaterial({color:"red",force:!0,opacity:.2,transparent:!0})};null===o&&(o=new n("##OOCDebugBBRoot"),s.addNode(o));var u,p,g=d.isSlave()?h._occurrences:d._occurrences;for(u=0;u<g.length;u++)p=g[u].matrix,(h=e.createCuboidNode(c)).setMatrix(p),a&&h.setNoZ(!0),o.addChild(h);debugWebGLV6Viewer.render()},window.OOCBuildTileModelPreloadData=function(e,t){e=e||window.oocLDHNodeManager.oocManager,t=t||window.debugWebGLV6Viewer;var n=e.getRootOccurrences().values().next().value.occurrence,i=n&&n.reference.referenceId,r={viewpoint:{pos:t.currentViewpoint.getEyePosition().createJSON(),sight:t.currentViewpoint.getSightDirection().createJSON(),up:t.currentViewpoint.getUpDirection(),distanceToTarget:t.currentViewpoint.getTargetDistance()},rootId:i};return JSON.stringify(r)},window.OOCHighlightReference=function(e,t,n){var o=(t=t||window.oocLDHNodeManager.oocManager).getSceneGraphNode(e);if(o){var s=new r([o]);!n&&i.empty(),i.add({pathElement:s})}else console.log("no node");return t._getLDHReference(e,!0)}})),N.Mode={unknown:"unknown",ooc:"ooc",slave:"slave"},N.RepType={none:f.RepType.none,av1:f.RepType.av1,pr:f.RepType.pr,rr:f.RepType.rr},N}));