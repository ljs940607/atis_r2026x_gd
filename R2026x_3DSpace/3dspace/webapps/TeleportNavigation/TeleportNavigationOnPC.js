define("DS/TeleportNavigation/TeleportNavigationOnPC",["UWA/Class","DS/VisuEvents/EventsManager","DS/Visualization/TrackballControls","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/TeleportNavigation/TeleportNavigationRunLoop","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/BillBoardNode3D","DS/RuntimeView/NLSManager"],(function(e,t,i,o,n,r,s,a,l,_,c){"use strict";var h=300,u=3e3,p="Release to Teleport",v=e.extend({init:function(){this._enabled=!1,this._prevDistanceToTarget=0,this._viewer=null,this._domElement=null,this._evtTokenMouse=[],this._evtTokenTouch=[],this._nlsHandle=null,this._downCursorPosition=null,this._cursorPosition=null,this._teleportTransitionPossible=!1,this._teleportTransitionActive=!1,this._forwardTransitionActive=!1,this._forwardTransitionWalkActive=!1,this._selectionTimer=null,this._teleportTimer=null,this._teleportPosition=null,this._teleportIconNode=null,this._teleportIconRectNode=null,this._teleportIconShown=!1,this._teleportIconOnTouch=!1,this._gravity=new o.Vector3(0,0,-1),this._groundHeight=0,this._currentHeight=0,this._animationLoopCB=null,this._bBox=null,this._bBoxRadius=0,this._viewerState={TrapSelectionState:!0,PrePickingActivation:!0,PreHighlightDisplay:!0}},setup:function(e){this._viewer=e.viewer,this._frameWindow=e.frameWindow,this._domElement=void 0!==this._viewer?this._viewer.canvas:document},enable:function(){this._enabled=!0,this._setNLSResources(),this._setGravity(),this._setBBox(),this._setMouseEventsMap(),this._setTouchEventsMap(),this._setPickingForNavigation(),this._viewer.currentViewpoint.onCenterCamera(this._onCenterCamera),this._prevDistanceToTarget=this._viewer.currentViewpoint.getTargetDistance(),this._viewer.currentViewpoint.setTargetDistance(u),this._animationLoopCB=new r,this._animationLoopCB.setup({subscriber:this,animationLoopCB:this._onAnimationLoop})},disable:function(){this._enabled&&(this._enabled=!1,this._destroyTeleportIcon(),this._unsetMouseEventsMap(),this._unsetTouchEventsMap(),this._unsetPickingForNavigation(),this._viewer.currentViewpoint.onCenterCamera(null),this._viewer.currentViewpoint.setTargetDistance(this._prevDistanceToTarget),this._animationLoopCB&&(this._animationLoopCB.stop(),this._animationLoopCB=null))},_setPickingForNavigation:function(){this._storeViewerState(),this._setViewerState()},_unsetPickingForNavigation:function(){this._unsetViewerState()},_storeViewerState:function(){this._viewerState.TrapSelectionState=this._viewer.picking.trapSelection,this._viewerState.PrePickingActivation=this._viewer.pPicking.activated,this._viewerState.PreHighlightDisplay=this._viewer.pPicking.displayHL},_setViewerState:function(){this._viewer.setPicking({trapSelection:!1}),this._viewer.setPrePicking({activated:!1,displayHL:!1})},_unsetViewerState:function(){this._viewer.setPicking({trapSelection:this._viewerState.TrapSelectionState}),this._viewer.setPrePicking({activated:this._viewerState.PrePickingActivation,displayHL:this._viewerState.PreHighlightDisplay})},_setNLSResources:function(){var e=this;c.DEFAULT_LANGUAGE=widget.lang?widget.lang:widget.getValue("lang"),c.loadResource({resourceFile:"TeleportNavigation/TeleportNavigationOnPC"}),c.onResourceLoaded({resourceFile:"TeleportNavigation/TeleportNavigationOnPC",language:widget.lang?widget.lang:widget.getValue("lang")},(function(){e._nlsHandle=this,p=this.getKey({key:"TeleportNavigationOnPC.Text"})}))},_setGravity:function(){var e=this._viewer.currentViewpoint.getWorldOrientation().upAttribute;this._gravity="y"===e?new o.Vector3(0,-1,0):new o.Vector3(0,0,-1)},_setBBox:function(){this._frameWindow.experience?this._bBox=this._frameWindow.experience.getRootBag().bBox:this._bBox=this._viewer.getRootNode().bBox;var e=this._bBox.max.x-this._bBox.min.x,t=this._bBox.max.y-this._bBox.min.y,i=this._bBox.max.z-this._bBox.min.z;this._bBoxRadius=Math.sqrt(e*e+t*t+i*i)},_getBbox:function(){return this._bBox||this._setBBox(),this._bBox},_isInsideBboxLimits:function(e){return this._bBox||(this._bBox=this._getBbox()),this._bBox.min.x<e.x&&e.x<this._bBox.max.x&&this._bBox.min.y<e.y&&e.y<this._bBox.max.y},_getBboxDistance:function(e){this._bBox||(this._bBox=this._getBbox());var t=new o.Vector3((this._bBox.max.x+this._bBox.min.x)/2,(this._bBox.max.y+this._bBox.min.y)/2,(this._bBox.max.z+this._bBox.min.z)/2),i=1,n=1;this._bBox.max.x<e.x?n=(e.x-this._bBox.max.x)/(e.x-t.x):e.x<this._bBox.min.x&&(n=(this._bBox.min.x-e.x)/(t.x-e.x));var r=1;this._bBox.max.y<e.y?r=(e.y-this._bBox.max.y)/(e.y-t.y):e.y<this._bBox.min.y&&(r=(this._bBox.min.y-e.y)/(t.y-e.y));var s=1;return this._bBox.max.z<e.z?s=(e.z-this._bBox.max.z)/(e.z-t.z):e.z<this._bBox.min.z&&(s=(this._bBox.min.z-e.z)/(t.z-e.z)),(i=n)<r&&(i=r),i<s&&(i=s),e.distanceTo(t)*i},_getBboxTarget:function(e){this._bBox||(this._bBox=this._getBbox());var t=null,i=this._gravity.clone().multiplyScalar(-1),n=new o.Plane(i,this._groundHeight);t=new o.Ray(e,i.clone()).intersectPlane(n);var r=new o.Vector3((this._bBox.max.x+this._bBox.min.x)/2,(this._bBox.max.y+this._bBox.min.y)/2,(this._bBox.max.z+this._bBox.min.z)/2),s=1,a=1;this._bBox.max.x<e.x?a=(e.x-this._bBox.max.x)/(e.x-r.x):e.x<this._bBox.min.x&&(a=(this._bBox.min.x-e.x)/(r.x-e.x));var l=1;return this._bBox.max.y<e.y?l=(e.y-this._bBox.max.y)/(e.y-r.y):e.y<this._bBox.min.y&&(l=(this._bBox.min.y-e.y)/(r.y-e.y)),(s=a)<l&&(s=l),t.x=t.x*s,t.y=t.y*s,t},_setMouseEventsMap:function(){var e=this,i=0;e._evtTokenMouse.push(t.addEvent(e._domElement,"onLeftMouseDown",(function(t){i=1,e._onLeftMouseDown(t)}))),e._evtTokenMouse.push(t.addEvent(e._domElement,"onLeftMouseUp",(function(t){i=0,e._onLeftMouseUp(t)}))),e._evtTokenMouse.push(t.addEvent(e._domElement,"onMouseMove",(function(t){1===i&&e._onLeftMouseMove(t)})))},_setTouchEventsMap:function(){var e=this;e._evtTokenTouch.push(t.addEvent(e._domElement,"onTouch",(function(i){t.getTouchEvents().length>1?e._onTouchUp(i):e._onTouchDown(i)}))),e._evtTokenTouch.push(t.addEvent(e._domElement,"onRelease",(function(t){e._onTouchUp(t)}))),e._evtTokenTouch.push(t.addEvent(e._domElement,"onSwipe",(function(t){e._onTouchMove(t)})))},_unsetMouseEventsMap:function(){var e=this;e._evtTokenMouse&&(e._evtTokenMouse.forEach((function(e){t.removeEventFromToken(e)})),e._evtTokenMouse=void 0)},_unsetTouchEventsMap:function(){var e=this;e._evtTokenTouch&&(e._evtTokenTouch.forEach((function(e){t.removeEventFromToken(e)})),e._evtTokenTouch=void 0)},_onLeftMouseDown:function(e){var t=this;null!==t._selectionTimer&&clearTimeout(t._selectionTimer),t._selectionTimer=null,null!==t._teleportTimer&&clearTimeout(t._teleportTimer),t._teleportTimer=null;var o=(e.from&&e.from.length?e.from[0]:null).getCurrentPosition(t._domElement);this._downCursorPosition=o.clone(),this._cursorPosition=o.clone(),this._teleportIconOnTouch=!1,this._teleportPosition=null;var n=t._viewer.currentViewpoint.control.getManipulationState();n!==i.State.FORCE_ZOOM&&n!==i.State.FORCE_PAN&&n!==i.State.FORCE_ROTATE&&(t._teleportTransitionPossible=!0),t._selectionTimer=setTimeout((function(){if(!0===t._teleportTransitionPossible){t._teleportTransitionActive=!0;var e=t._getTeleportPosition(o);t._showTeleportIcon(e),t._viewer.setCursor("Auto",0),t._teleportTimer=setTimeout((function(){null!==t._selectionTimer&&clearTimeout(t._selectionTimer),t._selectionTimer=null,null!==t._teleportTimer&&clearTimeout(t._teleportTimer),t._teleportTimer=null,t._teleportTransitionPossible=!1,t._teleportTransitionActive=!1,t._forwardTransitionActive=!0;var e=t._viewer.currentViewpoint.getEyePosition();t._isInsideBboxLimits(e)?t._forwardTransitionWalkActive=!0:t._forwardTransitionWalkActive=!1,t._hideTeleportIcon(),t._animationLoopCB&&t._animationLoopCB.start()}),700)}}),h)},_onTouchDown:function(e){var t=this;null!==t._selectionTimer&&clearTimeout(t._selectionTimer),t._selectionTimer=null,null!==t._teleportTimer&&clearTimeout(t._teleportTimer),t._teleportTimer=null;var o=(e.from&&e.from.length?e.from[0]:null).currentPosition;this._downCursorPosition=o.clone(),this._cursorPosition=o.clone(),this._teleportIconOnTouch=!0,this._teleportPosition=null;var n=t._viewer.currentViewpoint.control.getManipulationState();n!==i.State.FORCE_ZOOM&&n!==i.State.FORCE_PAN&&n!==i.State.FORCE_ROTATE&&(t._teleportTransitionPossible=!0),t._selectionTimer=setTimeout((function(){if(!0===t._teleportTransitionPossible){t._teleportTransitionActive=!0;var e=t._getTeleportPosition(o);t._showTeleportIcon(e),t._viewer.setCursor("Auto",0),t._teleportTimer=setTimeout((function(){null!==t._selectionTimer&&clearTimeout(t._selectionTimer),t._selectionTimer=null,null!==t._teleportTimer&&clearTimeout(t._teleportTimer),t._teleportTimer=null,t._teleportTransitionPossible=!1,t._teleportTransitionActive=!1,t._forwardTransitionActive=!0;var e=t._viewer.currentViewpoint.getEyePosition();t._isInsideBboxLimits(e)?t._forwardTransitionWalkActive=!0:t._forwardTransitionWalkActive=!1,t._hideTeleportIcon(),t._animationLoopCB&&t._animationLoopCB.start()}),700)}}),h)},_onLeftMouseUp:function(e){var t=this,i=(e.from&&e.from.length?e.from[0]:null).getCurrentPosition(t._domElement);this._cursorPosition=i.clone(),null!==t._selectionTimer&&clearTimeout(t._selectionTimer),t._selectionTimer=null,null!==t._teleportTimer&&clearTimeout(t._teleportTimer),t._teleportTimer=null,!0===t._teleportTransitionActive?(t._hideTeleportIcon(),t._teleport(this._teleportPosition)):!0===t._forwardTransitionActive&&t._animationLoopCB&&t._animationLoopCB.stop(),t._teleportTransitionPossible=!1,t._teleportTransitionActive=!1,t._forwardTransitionActive=!1},_onTouchUp:function(e){var t=this,i=(e.from&&e.from.length?e.from[0]:null).currentPosition;this._cursorPosition=i.clone(),null!==t._selectionTimer&&clearTimeout(t._selectionTimer),t._selectionTimer=null,null!==t._teleportTimer&&clearTimeout(t._teleportTimer),t._teleportTimer=null,!0===t._teleportTransitionActive?(t._hideTeleportIcon(),t._teleport(this._teleportPosition)):!0===t._forwardTransitionActive&&t._animationLoopCB&&t._animationLoopCB.stop(),t._teleportTransitionPossible=!1,t._teleportTransitionActive=!1,t._forwardTransitionActive=!1},_onLeftMouseMove:function(e){var t=this,i=(e.from&&e.from.length?e.from[0]:null).getCurrentPosition(t._domElement);this._cursorPosition=i.clone(),(this._downCursorPosition.x>i.x+10||this._downCursorPosition.x<i.x-10||this._downCursorPosition.y>i.y+10||this._downCursorPosition.y<i.y-10)&&(t._teleportTransitionPossible=!1,t._teleportTransitionActive=!1,t._forwardTransitionActive=!0,t._hideTeleportIcon())},_onTouchMove:function(e){var t=this,i=(e.from&&e.from.length?e.from[0]:null).currentPosition;this._cursorPosition=i.clone(),(this._downCursorPosition.x>i.x+10||this._downCursorPosition.x<i.x-10||this._downCursorPosition.y>i.y+10||this._downCursorPosition.y<i.y-10)&&(t._teleportTransitionPossible=!1,t._teleportTransitionActive=!1,t._forwardTransitionActive=!0,t._hideTeleportIcon())},_createTeleportIcon:function(){if(this._viewer&&!this._teleportIconNode){var e=null,t=o.ImageUtils.loadTexture(l.getWebappsAssetUrl("TeleportNavigation","images/TeleportOnModel.png"));if(t){var i=new o.MeshPhongMaterial({map:t,side:o.DoubleSide,alphaTest:.05,transparent:!0});i.force=!0;var n={width:46,height:46,fill:!0,fillColor:null,noEdge:!0,material:i};e=a.createRectangleNode(n),this._teleportIconRectNode=e;var r=(new o.Matrix4).makeTranslation(-23,0,0);e.setMatrix(r),e.setShadow(!0),e.setFrustumCulled(!1),e.exludeFromBounding(!0)}var c=null;(c=a.createTextNode({text:p,fontSize:14,color:new o.Color("yellow"),sdf:1})).setNoZ(!0),c.setMatrix((new o.Matrix4).makeTranslation(30,0,0)),c.setPickable(s.NOPICKABLE),c.name="text";var h=null;e&&c&&((h=a.createFixedSizeNode()).addChild(c),h.addChild(e));var u=null;if(h){var v={viewpoint:this._viewer.currentViewpoint,position:new o.Vector3,name:"Teleport 3D",type:"Spherical"};(u=new _(v)).setMatrix(new o.Matrix4),u.addChild(h)}this._teleportIconNode=u,this._viewer.getRootNode().addChild(this._teleportIconNode)}},_destroyTeleportIcon:function(){this._teleportIconNode&&this._viewer&&this._viewer.getRootNode().removeChild(this._teleportIconNode)},_computeModelIntersection:function(e){var t=null,i=this._viewer.pick(this._viewer.getMousePosition(e),"mesh",!0);return i.path.length>0&&(t=i.position.clone()),t},_computeGroundIntersection:function(e){var t=null,i=this._viewer.currentViewpoint.getEyePosition(),n=this._viewer.currentViewpoint.camera.getLookAt(),r=this._gravity.clone().multiplyScalar(-1),s=new o.Plane(r,this._groundHeight),a=new o.Vector3(this._viewer.getMousePosition(e).x,this._viewer.getMousePosition(e).y,.5);return(new o.Projector).unprojectVector(a,this._viewer.currentViewpoint.camera),(t=new o.Ray(i,a.clone().sub(i).normalize()).intersectPlane(s)).clone().sub(i).dot(n)<=0&&(t=null),t},_computeCursorDirection:function(e){var t=null,i=this._viewer.currentViewpoint.getEyePosition(),n=new o.Vector3(this._viewer.getMousePosition(e).x,this._viewer.getMousePosition(e).y,.5);return(new o.Projector).unprojectVector(n,this._viewer.currentViewpoint.camera),(t=n.clone().sub(i)).normalize(),t},_getTeleportPosition:function(e){var t=this._viewer.currentViewpoint.getEyePosition(),i=this._viewer.currentViewpoint.camera.getLookAt(),n=this._computeModelIntersection(e),r=this._computeGroundIntersection(e),s=this._computeCursorDirection(e),a=null,l=null;if(n&&r&&t.distanceTo(r)<t.distanceTo(n)&&(n=null),n){l=n;var _=n.clone().sub(t);_.sub(this._gravity.clone().multiplyScalar(_.clone().dot(this._gravity))),_.normalize(),_.setLength(1500),a=l.clone().sub(_);var c=t.dot(this._gravity.clone().multiplyScalar(-1)),h=this._groundHeight-a.dot(this._gravity.clone().multiplyScalar(-1)),u=c-a.dot(this._gravity.clone().multiplyScalar(-1));Math.abs(u)<2e3?a.add(this._gravity.clone().multiplyScalar(-u)):Math.abs(h)<1e3&&a.add(this._gravity.clone().multiplyScalar(-h-1800))}else if(r)a=(l=r).clone().sub(this._gravity.clone().multiplyScalar(1800));else if(s){l=t.clone().add(s.clone().multiplyScalar(5e3));var p=s.clone().sub(this._gravity.clone().multiplyScalar(s.clone().dot(this._gravity)));a=t.clone().add(p.clone().multiplyScalar(5e3))}if(this._teleportPosition=a,l){new o.Ray(t,s);var v=.9*(t.distanceTo(l)-this._viewer.currentViewpoint.camera.near/s.dot(i));l=l.clone().sub(s.clone().multiplyScalar(v))}return l},_showTeleportIcon:function(e){if(e){var t=e.clone();if(this._createTeleportIcon(),this._teleportIconNode&&t){var i=null;i=!1===this._teleportIconOnTouch?(new o.Matrix4).makeTranslation(-23,0,0):(new o.Matrix4).makeTranslation(-23,35,0),this._teleportIconRectNode.setMatrix(i);var n=new o.Matrix4;n.setPosition(t),this._teleportIconNode.setMatrix(n),this._teleportIconNode.setVisibility(!0),this._teleportIconNode.cbChange(),this._viewer.render(),this._teleportIconShown=!0}}},_hideTeleportIcon:function(){!1!==this._teleportIconShown&&this._teleportIconNode&&(this._teleportIconNode.setVisibility(!1),this._teleportIconNode.cbChange(),this._viewer.render(),this._teleportIconShown=!1)},_teleport:function(e){if(null!==e){this._viewer.currentViewpoint.getTargetDistance();var t=this._viewer.currentViewpoint.camera.getLookAt();this._viewer.currentViewpoint.getEyePosition();u;var i;i={eyePosition:e,sightDirection:t,distanceToTarget:3e3,duration:2e3,interpolationType:1},this._viewer.currentViewpoint.moveTo(i)}},_isTeleportRequired:function(){return!this._viewer.manipulatorManager||!this._viewer.manipulatorManager.isInManipulation()},_onAnimationLoop:function(){!0===this._forwardTransitionActive&&!0===this._isTeleportRequired()&&this._updatePositionForLinearAngularMove()},_getRotationSpeed:function(e){var t=Math.PI/180*.035;return t*=e},_getTranslationSpeed:function(){var e=this._bBoxRadius/1e4;e>1.5&&(e=1.5);var t=e,i=this._viewer.currentViewpoint.getEyePosition();this._isInsideBboxLimits(i)||(t+=this._getBboxDistance(i)/2e3);return t<e&&(t=e),t},_updatePositionForLinearAngularMove:function(){this._setGravity(),this._setBBox();this._viewer.currentViewpoint.getTargetDistance();var e=this._viewer.currentViewpoint.getUpDirection(),t=this._viewer.currentViewpoint.camera.getLookAt(),i=this._viewer.currentViewpoint.getEyePosition(),n=200;var r=this._gravity.clone();r.multiplyScalar(-1);var s;s=this._getTranslationSpeed();var a,l;a=this._getRotationSpeed(this._viewer.getMousePosition(this._cursorPosition).x),l=this._getRotationSpeed(this._viewer.getMousePosition(this._cursorPosition).y);var _=t.clone(),c=s*n;!0===this._forwardTransitionWalkActive&&((h=new o.Vector3(0,0,0)).crossVectors(this._gravity,t),h&&h.length()>.1?_.crossVectors(h,this._gravity):_=null);_&&(_.setLength(c),i.add(_));var h,u=0,p=0;p=l*n,u=-(u=a*n),(h=new o.Vector3(0,0,0)).crossVectors(t,e);var v=r.angleTo(e),m=new o.Vector3(0,0,0);m.crossVectors(r,e),m.dot(h)<0&&(v=-v),v+p>Math.PI/2&&(p=Math.PI/2-v),v+p<-Math.PI/2&&(p=-Math.PI/2-v);var T=new o.Vector3(0,0,0);if(T.crossVectors(t,r),T&&T.length()>.1){var d=e.dot(T);T.setLength(d),T.multiplyScalar(-1),e.add(T),e.normalize()}h.applyAxisAngle(r,u),t.applyAxisAngle(r,u),0!==p&&t.applyAxisAngle(h,p),e.crossVectors(h,t);var w;w={upDirection:e,eyePosition:i,sightDirection:t,distanceToTarget:3e3,duration:n,interpolationType:1},this._viewer.currentViewpoint.moveTo(w)},_onCenterCamera:function(e){var t=this.camera.getLookAt(),i=this.getEyePosition(),o=e.clone().sub(i),r=o.dot(t),s=o.clone().sub(t.multiplyScalar(r)),a=i.clone().add(s);r=u;if(this._focusMode===n._FOCUS_MODE.TRANSLATION){var l;l={eyePosition:a,distanceToTarget:r,duration:2e3,interpolationType:1},this.moveTo(l)}}});return UWA.namespace("DS/TeleportNavigation/TeleportNavigationOnPC",v)}));