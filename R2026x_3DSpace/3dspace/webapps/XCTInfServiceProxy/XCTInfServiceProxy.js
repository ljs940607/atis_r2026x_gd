define("DS/XCTInfServiceProxy/XCTInfServiceProxy",["UWA/Core","UWA/Class/Promise","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/XCTInfUtilsWeb/XCTLogger"],(function(e,t,n,r,i,o){"use strict";var s,a={},c={getTenantId:function(){return window.widget?window.widget.getValue("tenantId")||window.widget.getValue("x3dPlatformId"):"OnPremise"},getRepositoryType:function(){return"PLM1"},isCloudEnv:function(){var e=c.getTenantId();return void 0!==e&&"OnPremise"!==e},retrievePlatformUrl:function(){if(!s){var r=t.deferred();n.getServiceUrl({serviceName:"3DSpace",platformId:c.getTenantId(),onComplete:function(t){var n=e.Utils.parseUrl(t),i=n.port;n.port="0";var o=e.Utils.composeUrl(n).replace(":0",":"+i);r.resolve(o)},onFailure:function(){s=void 0,r.reject("Failed to retrieve platform URI")}}),s=r.promise}return s},retrieveHypervisorServiceUrl:function(e){return c.retrieveServiceUrl(e).then((function(e){return e?e.replace(/(^\w+:|^)\/\//,"")+"/hypervisor":t.reject(new Error("Warning: Url could not be discovered!"))}))},retrieveServiceUrl:function(e){var r=a[e];if(!r){var i=t.deferred();r=i.promise,a[e]=i.promise,n.getServiceUrl({serviceName:e,platformId:c.getTenantId(),onComplete:i.resolve,onFailure:function(){a[e]=void 0,i.reject("Failed to retrieve URI for service "+e)}})}return r},retrieveDataPrepRunUrl:function(){return c.retrieveHypervisorServiceUrl("datapreprun")},retrieveDataPrepAuthoringUrl:function(){return c.retrieveServiceUrl("dataprepauthoring").then((function(e){return e?"https://"+e.replace(/(^\w+:|^)\/\//,"")+"/3drdfpersist/":t.reject(new Error("Warning: DataPrepAuthoring URL not discovered!"))}))},getSelectedCollabSpace:function(e){return c.addCollabSpacesToWidget(e).then((function(){return window.widget.getValue(e||"context")}))},setCollabSpace:function(e,t){return c.addCollabSpacesToWidget(t).then((function(){window.widget.setValue(t||"context",e)}))},retrieveLoginTicket:function(e){return c.retrievePlatformUrl().then((function(n){var i=t.deferred(),s=n+"/ticket/get?";s+="runasctx="+encodeURIComponent(e.context?e.context.trim():"preferred");var a=n;return a+="/resources/modeler/pno/person?current=true&select=preferredcredentials",c.isCloudEnv()&&(s+="&tenant="+encodeURIComponent(c.getTenantId().trim()),a+="&tenant="+encodeURIComponent(c.getTenantId().trim())),o.log("url :"+s),r.authenticatedRequest(a,{method:"GET",type:"json",proxy:"passport",onComplete:function(e){o.log("onComplete response:"),o.log(e),r.authenticatedRequest(s,{headers:{Accept:"application/json","Accept-Language":null},method:"GET",type:"json",proxy:"passport",onComplete:function(e){o.log("loginTicket: "+e.ticket),i.resolve(e.ticket)},onFailure:function(e){o.log(e),i.reject("Failed to retrieve login ticket")}})}}),i.promise}))},getUser:function(){return o.log("*** getting user ***"),c.retrievePlatformUrl().then((function(e){var n=t.deferred(),i=e;return i+="/resources/modeler/pno/person?current=true&select=preferredcredentials",c.isCloudEnv()&&(i+="&tenant="+encodeURIComponent(c.getTenantId().trim())),o.log("url :"+i),r.authenticatedRequest(i,{method:"GET",type:"json",proxy:"passport",onComplete:function(e){n.resolve(e)}}),n.promise}))},getSessionId:function(){if(this.sessionId)return this.sessionId;var e=i.getUser();return e||(e={login:"user"+Date.now()}),this.sessionId=e.login+"_"+c.getTenantId(),this._appSpecificSettings&&this._appSpecificSettings.csiClientName?this.sessionId=this.sessionId+"_"+this._appSpecificSettings.csiClientName:o.warn("CSI client name is not set up. On app initialization phase call setApplicationSpecificSettings method of XCTInfServiceProxy with object containing csiClientName"),this.sessionId},getProductIds:function(e){return c.retrievePlatformUrl().then((function(n){var i=t.deferred(),o=c.isCloudEnv(),s=n+(o?"/resources/v1/model/":"/resources/v0/model/")+"bus?"+("type=*"+("&where="+encodeURIComponent("(physicalid=='"+e+"')")))+"&select=name&select=revision&select=type";return o&&(s+="&tenant="+encodeURIComponent(c.getTenantId().trim())),r.authenticatedRequest(s,{method:"GET",type:"json",onComplete:function(e){i.resolve(e.results)},onFailure:function(){i.reject()}}),i.promise}))},getPhysicalId:function(e,n,i){return c.retrievePlatformUrl().then((function(o){var s=t.deferred(),a="type="+n+"&name="+e+"&revision="+i,l=c.isCloudEnv(),d=o+(l?"/resources/v1/model/":"/resources/v0/model/")+"bus?"+a+"&select=physicalid";return l&&(d+="&tenant="+encodeURIComponent(c.getTenantId().trim())),r.authenticatedRequest(d,{method:"GET",type:"json",onComplete:function(e){s.resolve(e.results)},onFailure:function(){s.reject()}}),s.promise}))},retrieveTransientToken:function(n){return new t((function(t,o){var s=i.getApplicationConfiguration("app.urls.passport")+"/api/authenticated/cas/transient?service=";s+=encodeURIComponent("https://"+n.serviceUrl),c.isCloudEnv()&&(s+="&tenant="+encodeURIComponent(c.getTenantId().trim())),r.authenticatedRequest(s,{method:"GET",type:"json",onComplete:function(r){t(e.extend({x3ds_service_url:n.serviceUrl},r))},onFailure:o})}))},setApplicationSpecificSettings:function(t){this._appSpecificSettings||(this._appSpecificSettings={}),this._appSpecificSettings=e.extend({csiClientName:this._appSpecificSettings.csiClientName},t)},addTenantIdToWidget:function(){const e=c.getTenantId();window.widget.addPreference({type:"text",name:e,label:"Platform",defaultValue:e,disabled:!0})}};return c}));