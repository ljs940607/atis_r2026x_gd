define("DS/XCADSTEPDocument/STEPInputDocument",["DS/XCADInputDocuments/XCADInputDocument","DS/XCADInputDocuments/XCADRepresentation","DS/XCADSTEPDocument/STEPTessellatedRepresentation","DS/XCADSTEPDocument/STEPTessellatedAnnotationRepresentation","DS/XCADSTEPDocument/STEPProductRepresentation","DS/XCADSTEPDocument/STEPProduct","DS/XCADInputDocuments/XCADFaceData","DS/Mesh/ThreeJS_Base","DS/XCADLoader/XCADError"],(function(e,s,t,n,r,i,o,E,a){"use strict";s.XCAD_TESSELLATED_REPRESENTATION,s.XCAD_TESSELLATED_ANNOTATION_REPRESENTATION;var T=/\(([^)]+)\)/g,c=/([^,]+)/g;return e.extend((function(){this.bodyColors=[],this.overridingFaceColors=[],this.assyProducts=[],this.tesselatedReps=[],this.annotationTesselatedReps=[],this.annotationDefaultView=[],this.stepEntities=[],this.curveFont=[],this.curveWidth=[],this.rootProducts=[],this.nbCpxTriFace=0,this.nbWire=0,this.CoordSystem={Coord:!1,Origin:void 0,Axis:void 0,RefDir:void 0},this.nbInstPart=0,this.geomRepresToshapeRepres=[]}),{zipped:!1,requestResponseType:"arraybuffer",stepTokenizeComplexEntity:function(e,s){var t=0,n="";s.length=0;for(var r=0;r<e.length;r++)"("===e[r]?(t>=1&&(n+=e[r]),t++):")"===e[r]?--t>=1&&(n+=e[r],1===t&&(s.push(n),n="")):n+=e[r]},stepGetNodeIdFromCpxEntity:function(e){var s=this.stepEntities[e],t=[];this.stepTokenizeComplexEntity(s,t);var n=[];this.stepTokenizeArgs(t[3],n);var r=[];return this.stepTokenizeArgs(n[0],r),r},_stepGetEntityType:function(e){var s,t=this.stepEntities[e];void 0!==t&&(s="("===t[0]?-1!==t.indexOf("TESSELLATED_GEOMETRIC_SET")?"TESSELLATED_GEOMETRIC_SET":"[COMPLEX_STEP_ENTITY]":t.match(/^\w+/)[0]);return{first:s,second:t}},close:function(){void 0!==this._internalRepresentationIndex&&delete this._internalRepresentationIndex},getProductReference:function(e){return new i(this,this.assyProducts[e])},getRepresentation:function(e){var i;if(void 0!==this._internalRepresentationIndex)e===s.XCAD_TESSELLATED_REPRESENTATION&&(i=new t(this,this._internalRepresentationIndex));else if(0===Object.keys(this.assyProducts).length&&0!==this.tesselatedReps.length&&e===s.XCAD_TESSELLATED_REPRESENTATION)i=new t(this,this.tesselatedReps[0]);else if(0!==this.annotationTesselatedReps.length&&e===s.XCAD_TESSELLATED_ANNOTATION_REPRESENTATION)i=new n(this,this.annotationTesselatedReps);else if(0!==Object.keys(this.assyProducts).length&&e===s.XCAD_PRODUCT_REPRESENTATION){i=new r(this,s.XCAD_PRODUCT_REPRESENTATION,"root");var o,E=this.getRootProducts();if(E.length>0)o=E[0];else for(var a in this.assyProducts)if(this.assyProducts[a].isRoot){o=a;break}var T=this.getProductReference(o);i.addRootProduct(T)}return i},getRootProducts:function(){return this.rootProducts},serialize:function(){return JSON.stringify(this)},unserialize:function(e){let s=JSON.parse((new TextDecoder).decode(e));this.nbCpxTriFace=s.nbCpxTriFace,this.nbInstPart=s.nbInstPart,this.nbWire=s.nbWire,this.CoordSystem=s.CoordSystem,this.bodyColors=s.bodyColors,this.overridingFaceColors=s.overridingFaceColors,this.assyProducts=s.assyProducts,this.tesselatedReps=s.tesselatedReps,this.annotationTesselatedReps=s.annotationTesselatedReps,this.annotationDefaultView=s.annotationDefaultView,this.stepEntities=s.stepEntities,this.curveFont=s.curveFont,this.curveWidth=s.curveWidth,this.rootProducts=s.rootProducts},stepTokenizeArgs:function(e,s){if(void 0!==e){s.length=0;e.substr(e.indexOf("(")+1,e.lastIndexOf(")")).match(/(\'[a-zA-Z0-9\s.,+-_#()~:&\\\"]*\')*(\([()]*(\([^()]*\)[^()]*)*\))*(\([a-zA-Z0-9\s.,-_#]*\))*(\.[a-zA-Z0-9\s.,-_#]*\.)*(\#?\-?[0-9]+[.-E0-9]*)*(\$)*/g).filter((function(e){return""!=e})).forEach((e=>{if("string"==typeof e&&e.startsWith("'")&&e.endsWith("'")&&(e=e.slice(1,-1)),e.indexOf("\\X2\\")>=0){var t=e.substr(e.indexOf("\\X2\\")+4,e.indexOf("\\X0\\")).match(/.{1,4}/g);t.forEach(((e,s,t)=>{t[s]="0x"+e}));var n=String.fromCharCode.apply(String,t);e=e.substr(0,e.indexOf("\\X2\\"))+n+e.substr(e.indexOf("\\X0\\")+4,e.length-1)}s.push(e)}))}},initialize:async function(e){var s=[];if("string"==typeof e)s[0]=e;else{var t=268435456,n=new TextDecoder("utf-8");if(e.byteLength>t){let r=0,i=t,o=0;for(;i<e.byteLength;)s[o]=n.decode(e.slice(r,i)),o++,r=i+1,i+=t;s[o]=n.decode(e.slice(r,e.byteLength))}else s[0]=n.decode(e)}if(""!==s[0]){for(var r=1;r<s.length;r++){let e=s[r].indexOf("\n#"),t=s[r].substring(0,e+1);s[r-1]+=t,s[r]=s[r].slice(e+1,s[r].length)}if(null===s[0].match(/FILE_SCHEMA\s*\(\s*\(\s*\'\s*AP242/))return console.error("Only STEP AP242 file are supported"),(i=new a).setError("XCADLoader/XCADLoader","error.STP_UNSUPPORT",null),i;var i,o=!0;for(r=0;r<s.length;r++)null!=s[r].match(/#\d+=TESSELLATED_SHAPE_REPRESENTATION/)&&(o=!1);if(!0===o)return console.error("Only STEP file with tessellated data are supported"),(i=new a).setError("XCADLoader/XCADLoader","error.NO_TESSELLATION",null),i;for(r=0;r<s.length;r++)s[r]=s[r].replace(/\r?\n/g,""),s[r]=s[r].replace(/\/\*.*\*\//g,""),s[r]=s[r].split(";");e="";var l=this,d=[],u=[],f=[],A=[],h=[],p=[],R=[],O=[],_=[],g=[],N=/^(#[0-9]+)\=(.+)$/,S=/^\w+/,C="";for(r=0;r<s.length;r++){C=s[r];for(var I=0;I<C.length;I++){var b=C[I].match(N);if(null!==b){var D=b[2].match(S);if(null===D&&("("===b[2][0]&&(D=["[COMPLEX_STEP_ENTITY]"]),b[2].includes("ANNOTATION_OCCURRENCE")&&(D=["ANNOTATION_CURVE_OCCURRENCE"])),null===D)console.error("STEPInputDocument::initialize entityType is null");else{var P=b[1].substring(1);switch(this.stepEntities[P]=b[2],D[0]){case"TESSELLATED_SHAPE_REPRESENTATION":case"TESSELLATED_SHAPE_REPRESENTATION_WITH_ACCURACY_PARAMETERS":this.tesselatedReps.push(b[1]);break;case"STYLED_ITEM":d.push(P);break;case"OVER_RIDING_STYLED_ITEM":u.push(P);break;case"CONTEXT_DEPENDENT_SHAPE_REPRESENTATION":f.push(P);break;case"SHAPE_REPRESENTATION_RELATIONSHIP":A.push(P);break;case"PROPERTY_DEFINITION_REPRESENTATION":h.push(P);break;case"SHAPE_DEFINITION_REPRESENTATION":R.push(P);break;case"APPLIED_EXTERNAL_IDENTIFICATION_ASSIGNMENT":O.push(P);break;case"COMPLEX_TRIANGULATED_FACE":this.nbCpxTriFace++;break;case"TESSELLATED_WIRE":this.nbWire++;break;case"SHAPE_REPRESENTATION":p.push(P);break;case"DRAUGHTING_CALLOUT":case"ANNOTATION_CURVE_OCCURRENCE":case"ANNOTATION_FILL_AREA_OCCURRENCE":this.annotationTesselatedReps.push(P);break;case"DEFAULT_MODEL_GEOMETRIC_VIEW":this.annotationDefaultView.push(P)}}}}s[r].length=0}for(I=0;I<this.annotationTesselatedReps.length;I++)k(this.annotationTesselatedReps[I],d,u);var v=function(e){let s;if(0!=e.length){var t=[];l.stepTokenizeArgs(l.stepEntities[e],t);let r=t[3].substr(1);l.stepTokenizeArgs(l.stepEntities[r].substring(l.stepEntities[r].indexOf("REPRESENTATION("),l.stepEntities[r].length-2),t),s=t[2].substr(1,t[2].length-2).match(c);for(var n=0;n<s.length;n++)s[n]=s[n].substring(s[n].indexOf("#")+1,s[n].length)}return s}(this.annotationDefaultView);null!=v&&(this.annotationTesselatedReps=v);for(I=0;I<d.length;I++)y(d[I],!0);for(I=0;I<u.length;I++)y(u[I],!1);if(f.length>0){for(I=0;I<p.length;I++){var L=[];this.stepTokenizeArgs(this.stepEntities[p[I]],L),"[COMPLEX_STEP_ENTITY]"===x(L[2].substr(1)).first&&(this.geomRepresToshapeRepres[L[2].substr(1)]="#"+p[I].toString())}for(I=0;I<A.length;I++)F(A[I],"internal");for(I=0;I<R.length;I++)F(R[I],"alternative");for(I=0;I<O.length;I++)U(O[I]);for(I=0;I<h.length;I++)F(h[I],"external");for(I=0;I<f.length;I++)m(f[I])}else l.nbInstPart++}function x(e){var s,t=l.stepEntities[e];void 0!==t&&(s="("===t[0]||"("===t[1]?-1!==t.indexOf("TESSELLATED_GEOMETRIC_SET")?"TESSELLATED_GEOMETRIC_SET":"[COMPLEX_STEP_ENTITY]":t.match(/^\w+/)[0]);return{first:s,second:t}}function y(e,s){let t,n=[];var r=x(e);if("[COMPLEX_STEP_ENTITY]"===r.first){var i=[];let e;if(l.stepTokenizeArgs(r.second,i),s?e=i[5].substr(1,i[5].length-2).match(c):r.second.includes("TESSELLATED_ANNOTATION_OCCURRENCE")?e=i[3].substr(1,i[3].length-2).match(c):r.second.includes("ANNOTATION_CURVE_OCCURRENCE")?e=i[4].substr(1,i[4].length-2).match(c):console.log("TODO : "+r.second),n[0]=e[0].substr(1,e[0].length-2),s)t=e[1].substr(1);else{var o=x(e[1].substr(1));l.stepTokenizeArgs(o.second,i),r.second.includes("TESSELLATED_ANNOTATION_OCCURRENCE")?t=i[3].substr(2,i[3].length-4).substr(1):r.second.includes("ANNOTATION_CURVE_OCCURRENCE")?t=i[1].substr(1,i[1].length-2).substr(1):console.log("TODO : "+r.second)}}else{let s=l.stepEntities[e].substring(12,l.stepEntities[e].lastIndexOf(")")).match(c);var a=!1;t=s[2].substr(1),n=s[1].substr(1,s[1].length-2).match(c)}for(var d=0;d<n.length;d++){var u=n[d];if("PRESENTATION_STYLE_ASSIGNMENT"===(C=x(u.substr(1))).first){let e=C.second.substr(C.second.indexOf("((")+1,C.second.indexOf("))")-2).match(T),n=e[0].substr(1,e[0].length-2).match(c);for(var f=0;f<n.length;f++){var A=x((u=n[f]).substr(1));if("SURFACE_STYLE_USAGE"===A.first){var h=x(u=A.second.substring(A.second.indexOf("#")+1,A.second.indexOf(")")));if("SURFACE_SIDE_STYLE"===h.first){let e=h.second.substring(h.second.indexOf("#"),h.second.indexOf("))")).match(c);for(var p=0;p<e.length;p++){var R=x((u=e[p]).substr(1));if("SURFACE_STYLE_FILL_AREA"===R.first){var O=x(u=R.second.substring(R.second.indexOf("#")+1,R.second.indexOf(")")));if("FILL_AREA_STYLE"===O.first){let e=O.second.substring(O.second.indexOf("#"),O.second.indexOf("))")).match(c);for(var _=0;_<e.length;_++){var g=x((u=e[_]).substr(1));if("FILL_AREA_STYLE_COLOUR"===g.first){var N=x(u=g.second.substring(g.second.indexOf("#")+1,g.second.indexOf(")")));if("COLOUR_RGB"===N.first){let e=N.second.substring(N.second.indexOf("(")+1,N.second.indexOf(")")).match(c);s?l.bodyColors[t]=[e[1],e[2],e[3]]:l.overridingFaceColors[t]=[e[1],e[2],e[3]]}else if("DRAUGHTING_PRE_DEFINED_COLOUR"===N.first){let e=N.second.substring(N.second.indexOf("('")+2,N.second.indexOf("')"));(b=new E.Color).setStyle(e),e.startsWith("gre")&&(b.g=1),s?l.bodyColors[t]=[b.r,b.g,b.b]:l.overridingFaceColors[t]=[b.r,b.g,b.b]}}}}}else if("SURFACE_STYLE_RENDERING_WITH_PROPERTIES"===R.first){let e=R.second.substring(R.second.indexOf("(#")+2,R.second.indexOf(")"));var S=x(e);if("SURFACE_STYLE_TRANSPARENT"===S.first){let s=S.second.substring(S.second.indexOf("(")+1,S.second.indexOf(")"));null!=l.bodyColors[t]?s<=1&&s>=0?l.bodyColors[t][3]=1-s:a&&console.log("Warning: transparency value must be between [0-1] ("+s+") for entity: "+e):null!=l.overridingFaceColors[t]&&(s<=1&&s>=0?l.overridingFaceColors[t][3]=1-s:a&&console.log("Warning: transparency value must be between [0-1] ("+s+") for entity: "+e))}}}}}else if("CURVE_STYLE"===A.first){var C,I=[];if(l.stepTokenizeArgs(A.second,I),"COLOUR_RGB"===(C=x(u=A.second.substring(A.second.indexOf("),#")+3,A.second.lastIndexOf(")")))).first){let e=C.second.substring(C.second.indexOf("(")+1,C.second.indexOf(")")).match(c);l.bodyColors[t]=[e[1],e[2],e[3]]}else if("DRAUGHTING_PRE_DEFINED_COLOUR"===C.first){let e=C.second.substring(C.second.indexOf("('")+2,C.second.indexOf("')"));var b;(b=new E.Color).setStyle(e),e.startsWith("gre")&&(b.g=1),l.bodyColors[t]=[b.r,b.g,b.b]}var D=I[2].match(/\((.*?)\)/);if(D&&(l.curveWidth[t]=parseFloat(D[1])),"DRAUGHTING_PRE_DEFINED_CURVE_FONT"===(C=x((u=I[1]).substr(1))).first){let e=C.second.substring(C.second.indexOf("('")+2,C.second.indexOf("')"));l.curveFont[t]=e}}}}}}function k(e,s,t){var n=[],r=x(e);if("[COMPLEX_STEP_ENTITY]"===r.first)l.stepEntities[e].includes("OVER_RIDING_STYLED_ITEM")?t.push(e):l.stepEntities[e].includes("STYLED_ITEM")&&s.push(e);else if("ANNOTATION_FILL_AREA_OCCURRENCE"===r.first||"ANNOTATION_CURVE_OCCURRENCE"===r.first)s.push(e);else if("DRAUGHTING_CALLOUT"===r.first){l.stepTokenizeArgs(l.stepEntities[e],n);let t=n[1].substr(1,n[1].length-2).match(c);for(var i=0;i<t.length;i++){var o=t[i];s.push(o.substr(1))}}else"CAMERA_MODEL_D3"===r.first||console.log("processAnnotation "+r.first+" not yet supported ")}function m(e){var s=[];l.stepTokenizeArgs(l.stepEntities[e],s);var t,n=s[0].substr(1),r=s[1].substr(1),i=[];l.stepTokenizeComplexEntity(l.stepEntities[n],i);var o=[];l.stepTokenizeArgs(i[0],o);var a=o[2],T=o[3],c=[];l.stepTokenizeArgs(i[1],c);var d=x(c[0].substr(1));if("ITEM_DEFINED_TRANSFORMATION"===d.first){var u=[];l.stepTokenizeArgs(d.second,u);var f=u[2];t=function(e,s){var t={},n=[],r=[],i=[],o=[],a=[],T=[];l.stepTokenizeArgs(l.stepEntities[e],n),n[1]=n[1].substr(1),n[2]=n[2].substr(1),n[3]=n[3].substr(1),l.stepTokenizeArgs(l.stepEntities[n[1]],r),l.stepTokenizeArgs(r[1],i),l.stepTokenizeArgs(l.stepEntities[n[2]],r),l.stepTokenizeArgs(r[1],o),l.stepTokenizeArgs(l.stepEntities[n[3]],r),l.stepTokenizeArgs(r[1],a),l.stepTokenizeArgs(l.stepEntities[s],n),n[1]=n[1].substr(1),n[2]=n[2].substr(1),n[3]=n[3].substr(1),l.stepTokenizeArgs(l.stepEntities[n[1]],r),l.stepTokenizeArgs(r[1],T),l.stepTokenizeArgs(l.stepEntities[n[2]],r),l.stepTokenizeArgs(r[1],[]),l.stepTokenizeArgs(l.stepEntities[n[3]],r),l.stepTokenizeArgs(r[1],[]),t.rotation=new E.Matrix3;var c=new E.Vector3(o[0],o[1],o[2]),d=new E.Vector3(a[0],a[1],a[2]),u=new E.Vector3;return u.crossVectors(c,d),t.rotation.set(a[0],a[1],a[2],u.x,u.y,u.z,o[0],o[1],o[2]),t.translation=new E.Vector3(i[0]-T[0],i[1]-T[1],i[2]-T[2]),t}(u[3].substr(1),f.substr(1))}var A=[];l.stepTokenizeArgs(l.stepEntities[r],A);var h=[];l.stepTokenizeArgs(l.stepEntities[A[2].substr(1)].replaceAll("*",""),h);var p=h[0],R=z(h[3]),O=R[0],_=R[1],N=(R=z(h[4]))[0],S=R[1];if(null!==O&&null!==N){if(O in l.assyProducts||(l.assyProducts[O]={referenceName:_,isRoot:!0,childrenList:[],geomRep:g[T]},l.rootProducts.push(O)),N in l.assyProducts){l.assyProducts[N].isRoot=!1;var C=l.rootProducts.indexOf(N);-1!=C&&l.rootProducts.splice(C,1)}else l.assyProducts[N]={referenceName:S,isRoot:!1,childrenList:[],geomRep:g[a]};l.assyProducts[O].childrenList.push({instanceName:p,productReferenceIdx:N,transfo:t}),void 0!==l.assyProducts[N].geomRep&&l.nbInstPart++}}function z(e){var s=null,t=null;if(null==e)return[s,t];var n=x(e.substr(1));if("PRODUCT_DEFINITION"===n.first){var r=[];if(l.stepTokenizeArgs(n.second,r),"PRODUCT_DEFINITION_FORMATION_WITH_SPECIFIED_SOURCE"===(n=x(r[r.length-2].substr(1))).first){var i=[];if(l.stepTokenizeArgs(n.second,i),"PRODUCT"===(n=x(i[2].substr(1))).first){var o=[];l.stepTokenizeArgs(n.second,o),s=i[2],t=o[0]}}}return[s,t]}function U(e){var s=[];l.stepTokenizeArgs(l.stepEntities[e],s);var t=[];l.stepTokenizeArgs(s[3],t),"DOCUMENT_FILE"===x(t[0].substr(1)).first&&(_[t[0]]=s[0])}function F(e,s){if("external"===s){var t=[];l.stepTokenizeArgs(l.stepEntities[e],t);var n=x(t[0].substr(1)),r=x(t[1].substr(1));if("PROPERTY_DEFINITION"===n.first&&"SHAPE_REPRESENTATION"===r.first){var i=[];l.stepTokenizeArgs(n.second,i),g[t[1]]={type:"external",location:_[i[2]]}}}else if("internal"===s){var o=[];l.stepTokenizeArgs(l.stepEntities[e],o),g[o[2]]={type:"internal",location:o[3]}}else if("alternative"===s){t=[];l.stepTokenizeArgs(l.stepEntities[e],t);n=x(t[0].substr(1));if("TESSELLATED_SHAPE_REPRESENTATION"===(r=x(t[1].substr(1))).first){i=[];l.stepTokenizeArgs(r.second,i);var E=l.geomRepresToshapeRepres[i[2].substr(1)];g[E]={type:"internal",location:t[1]}}}}}})}));