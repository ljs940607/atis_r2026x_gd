define("DS/ModelLoader_3dskt/loader",["UWA/Core","UWA/Promise","DS/SceneGraphNodes/FixedSizeNode3D","DS/ZipJS/zip","DS/Visualization/SceneGraphFactory","DS/CAT3DWVisu/CAT3DWThreeJsExtender","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CAT3DSKExperience/CAT3DSKAnnotationAbbreviationsExperience","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/Usage/TrackerAPI","DS/Plugins/UserRenderList","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices","DS/CAT3DWInfraUI/CAT3DWHandleErrors","DS/Visualization/MaterialApplication","DS/CAT3DWInfra/CAT3DWUrlServices","DS/Visualization/Ambience","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfra/CAT3DWFileServices","DS/CAT3DWInfraUI/CAT3DWDataModelConverter"],(function(e,t,r,i,a,n,o,s,l,d,c,m,h,p,u,g,y,x,f,w,v,M,D){"use strict";return e.Class.extend({init:function(e){this._parent(e),this._3dMediaCounter=0,this._2dMediaCounter=0,this.isR2V=null,this.texture=[],this._isMobileApp=!1,window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(this._isMobileApp=!0,v.setPreferenceValue("M3DEMobile",!0))},unzip:function(e){return new t((function(t){var r=new i.BlobReader(e);i.createReader(r,(function(e){var r=e;r.getEntries((function(e){var a=e.find((function(e){return"sketch.json"===e.filename}));a&&a.getData(new i.TextWriter,(function(e){var i=e.target.result;r.close((function(){t(i)}))}))}))}),(function(){console.log("zip error")}))}))},readJsonFile:function(e){return new t((function(t,r){var i={proxy:"none",type:"arraybuffer",timeout:6e5,onComplete:function(e){t(new Blob([e],{type:"application/zip"}))},onError:function(e){r(e)}};d.authenticatedRequest(e,i)}))},getListPointFromCircle:function(e,t){for(var r=[],i=new o.Vector3(t.x,t.y,t.z),a=new o.Vector3(e.annotStartPoint.x,e.annotStartPoint.y,e.annotStartPoint.z),n=new o.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),s=e.geometry.radius,l=(new o.Vector3).subVectors(a,n).normalize(),d=(new o.Vector3).crossVectors(l,i).normalize(),c=2*Math.PI/e.pointsCount,m=0;m<2*Math.PI;m+=c){var h=n.x+s*Math.cos(m)*l.x+s*Math.sin(m)*d.x,p=n.y+s*Math.cos(m)*l.y+s*Math.sin(m)*d.y,u=n.z+s*Math.cos(m)*l.z+s*Math.sin(m)*d.z;r.push(new o.Vector3(h,p,u))}return r.push(r[0]),r},getListPointFromEllipse:function(e){var t,r,i,a=[];if(e.matrix){let a=JSON.parse(e.matrix),n=new o.Matrix4;n.setFromArray(a.elements);let s=new o.Vector3,l=new o.Quaternion,d=new o.Vector3;n.decompose(s,l,d),n=(new o.Matrix4).compose(s,l,new o.Vector3(1,1,1)),l=(new o.Matrix4).extractRotation(n),t=new o.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z).applyMatrix4(n),r=new o.Vector3(e.geometry.majorAxis.dir.x,e.geometry.majorAxis.dir.y,e.geometry.majorAxis.dir.z).applyMatrix4(l).normalize(),i=new o.Vector3(e.geometry.minorAxis.dir.x,e.geometry.minorAxis.dir.y,e.geometry.minorAxis.dir.z).applyMatrix4(l).normalize()}else t=new o.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),r=new o.Vector3(e.geometry.majorAxis.dir.x,e.geometry.majorAxis.dir.y,e.geometry.majorAxis.dir.z),i=new o.Vector3(e.geometry.minorAxis.dir.x,e.geometry.minorAxis.dir.y,e.geometry.minorAxis.dir.z);for(var n=e.geometry.majorAxis.length,s=e.geometry.minorAxis.length,l=2*Math.PI/e.pointsCount,d=0;d<2*Math.PI;d+=l){var c=t.x+n*Math.cos(d)*r.x+s*Math.sin(d)*i.x,m=t.y+n*Math.cos(d)*r.y+s*Math.sin(d)*i.y,h=t.z+n*Math.cos(d)*r.z+s*Math.sin(d)*i.z;a.push(new o.Vector3(c,m,h))}return a.push(a[0]),a},getListPointFromLine:function(e){var t=[],r=new o.Vector3(e.geometry.startPoint.x,e.geometry.startPoint.y,e.geometry.startPoint.z),i=new o.Vector3(e.geometry.endPoint.x,e.geometry.endPoint.y,e.geometry.endPoint.z);if(t.push(r,i),e.matrix){let r=JSON.parse(e.matrix),i=new o.Matrix4;i.setFromArray(r.elements);let a=new o.Vector3,n=new o.Quaternion,s=new o.Vector3;i.decompose(a,n,s),i=(new o.Matrix4).compose(a,n,new o.Vector3(1,1,1));for(let e=0;e<t.length;e++)t[e]=t[e].applyMatrix4(i)}return t},getListPointFromRectangle:function(e){var t=[],r=new o.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),i=new o.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),a=new o.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z),n=new o.Vector3(e.geometry.vertexD.x,e.geometry.vertexD.y,e.geometry.vertexD.z);if(t.push(r,i,a,n,r),e.matrix){let r=JSON.parse(e.matrix),i=new o.Matrix4;i.setFromArray(r.elements);let a=new o.Vector3,n=new o.Quaternion,s=new o.Vector3;i.decompose(a,n,s),i=(new o.Matrix4).compose(a,n,new o.Vector3(1,1,1));for(let e=0;e<t.length-1;e++)t[e]=t[e].applyMatrix4(i)}return t},getListPointFromTriangle:function(e){var t=[],r=new o.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),i=new o.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),a=new o.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z);if(t.push(r,i,a,r),e.matrix){let r=JSON.parse(e.matrix),i=new o.Matrix4;i.setFromArray(r.elements);let a=new o.Vector3,n=new o.Quaternion,s=new o.Vector3;i.decompose(a,n,s),i=(new o.Matrix4).compose(a,n,new o.Vector3(1,1,1));for(let e=0;e<t.length-1;e++)t[e]=t[e].applyMatrix4(i)}return t},getListPointFromUnknown:function(e){var t=[];let r;if(e.matrix){let t=JSON.parse(e.matrix);r=new o.Matrix4,r.setFromArray(t.elements);let i=new o.Vector3,a=new o.Quaternion,n=new o.Vector3;r.decompose(i,a,n),r=(new o.Matrix4).compose(i,a,new o.Vector3(1,1,1))}for(var i=0;i<e.geometry.points.length;i++){var a=new o.Vector3(e.geometry.points[i].x,e.geometry.points[i].y,e.geometry.points[i].z);r&&(a=a.applyMatrix4(r)),t.push(a)}return t},_getLineMaterial:function(e){var t={color:e.color,lineWidth:e.thickness*window.devicePixelRatio,opacity:e.opacity,transparent:!1,force:!0,isCPUPattern:!0,linecap:"round",needsUpdate:!0};return new o.LineBasicMaterial(t)},_getSphereMaterial:function(e){return new o.MeshBasicMaterial({color:e.color,opacity:e.opacity,transparent:!1,force:!0})},_applyOpacityStencilOp:function(e,t){if(t.opacity<1){var r=this._viewer.getUserPassManager(),i=new h("StencilOpacityPass"),a=r.createUserRenderPass("userRenderPass",i);a.setEnableStencilTest(!0),a.setEnableStencilWrite(!0),a._passes[0].stencilRef=100*t.opacity,a.setStencilFunc("NOTEQUAL"),a.setStencilOpsSeparate("REPLACE","REPLACE","KEEP","KEEP");var n=r.getSystemPass("main");r.insertUserPassAfterPass(a,n),e.setRenderPasses([i])}},draw:function(e,t,i){var n=this._getLineMaterial(i);if("point"!==t){var s={points:e},l=a.createLineNode(s);if(l.setName("3DSketch_Annot"),l.oldSetMaterial(n),this._annotContainer.add(l),"line"===t){var d=new r({name:"3DSketch_Linecap",ratio:1});this._annotContainer.addChild(d),d.setMatrix((new o.Matrix4).setPosition(e[0].clone()));var c=this._getSphereMaterial(i),m=a.createSphereNode({sag:3,radius:i.thickness/2,fill:!0,material:c});this._applyOpacityStencilOp(m,i),d.add(m)}this._applyOpacityStencilOp(l,i)}else this.drawPoint(e,i)},drawPoint:function(e,t){var i=new o.MeshBasicMaterial({color:t.color,transparent:!1,force:!0,opacity:t.opacity,side:o.DoubleSide}),n=new r({name:"CAT3DSketch-PointNode",ratio:1});this._annotContainer.addChild(n),n.setMatrix((new o.Matrix4).setPosition(e[0]));var s=a.createSphereNode({sag:20,radius:.5*t.thickness,material:i});n.add(s),this._applyOpacityStencilOp(s,t)},load3DModel:function(t,r,i){t=(new f).generateUrlWithSuffix(t),this._isMobileApp&&(t=e.Data.proxifyUrl(t,{proxy:"passport"}));var a=new c,n="model3DNode_"+this._3dMediaCounter;this._3dMediaCounter++;var l=new s(n);if(this._3DSKTContainer.addChild(l),a.setOnLoadedCallback((()=>{var e=l.getBoundingBox().center(),t=new o.Matrix4;t.makeTranslation(-e.x,-e.y,-e.z);for(var r=0;r<l.children.length;r++)l.children[r].setMatrix(t);this._viewer.render(),i&&i()})),a.setOnErrorCallback((function(e){console.error(e),i&&i()})),a.loadModel({filename:t,proxyurl:"none",withCredentials:!0},l),r){var d=new o.Matrix4;d.setFromArray(r),l.setMatrix(d)}},_onTextureLoaded:function(e,t,r){this.apply2Dtexture(this.texture[e],t,null),r&&r()},onLoadImageError:function(e){e&&e()},drawSketch:function(e){var r=JSON.parse(e);return this.isR2V=r.isR2V,v.setPreferenceValue("isR2V",this.isR2V),new t(function(e){if(r.ver)for(var t=(new l).processJSON(r,"expand").explodeStates,i=0;i<t.length;i++)if(0===t[i].id)for(var a=t[i].drawPlanes,n=0;n<a.length;n++){var s=a[n],d=s.annotList.filter((function(e){return e.isVisible}));if(d.length)for(var c=null,m=0;m<d.length;m++){switch(d[m].type){case"circle":c=this.getListPointFromCircle(d[m],s.drawPlaneInfo.normal);break;case"ellipse":c=this.getListPointFromEllipse(d[m]);break;case"line":c=this.getListPointFromLine(d[m]);break;case"rectangle":c=this.getListPointFromRectangle(d[m]);break;case"triangle":c=this.getListPointFromTriangle(d[m]);break;case"unknownOpen":case"unknownClosed":default:c=this.getListPointFromUnknown(d[m]);break;case"point":c=[new o.Vector3(d[m].annotStartPoint.x,d[m].annotStartPoint.y,d[m].annotStartPoint.z)]}this.draw(c,d[m].type,d[m].graphicalProp)}}e(r.ExternalRef)}.bind(this))},apply2Dtexture:function(e,t,r){var i,n="";r?(n="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,i=new s(n),this.VideoModelsNode.addChild(i)):(n="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,i=new s(n),this._3DSKTContainer.addChild(i)),e.flipY=!1;var l={width:-100,height:-100,fill:!0,noEdge:!0},d=a.createRectangleNode(l);d.setRenderPasses([this._beforeMainPass]),d.setMatrix((new o.Matrix4).setPosition(new o.Vector3(50,50,0)));var c=(new o.Matrix4).makeRotationX(Math.PI);if(i.addChild(d),i.setMatrix(t),d.applyMatrix(c),!(e.image.width<=0||e.image.height<=0)){var m=o.MaterialUtils.createMatteFaceMaterial({map:e,side:o.DoubleSide,force:!0,transparent:!0,depthTest:!1});r&&this.mapVid.set(i.name,r);var h=new x({faceMaterial:m});d.setMaterialApplication(h),this.textureLoaded=!0}},load2DModel:function(t,r,i,a,n){a!==M.STATUS_KO&&a!==M.STATUS_PROCESSING&&(t=(new f).generateUrlWithSuffix(t));this._isMobileApp&&(t=e.Data.proxifyUrl(t,{proxy:"passport"}));var s=new o.Matrix4;s.setFromArray(r),this.texture.push(null);var l=this.texture.length-1;i===M.TYPE_IMAGE||a===M.STATUS_PROCESSING?(this.texture[l]=o.ImageUtils.loadTexture3DWhiteboard(t,void 0,this._onTextureLoaded.bind(this,l,s,n),this.onLoadImageError.bind(this,n),"use-credentials",1),this.texture[l].magFilter=o.LinearMipMapLinearFilter,this.texture[l].minFilter=o.LinearFilter):n()},getMedias:function(r){var i=[];if(r&&r.media3D&&r.media3D.length)for(let e=0;e<r.media3D.length;e++)i.push({mediaId:r.media3D[e].mediaId,associatedData:{id:r.media3D[e].id,matrix:r.media3D[e].matrixModel?r.media3D[e].matrixModel:r.media3D[e].matrix}});if(r&&r.mediaId&&i.push({mediaId:r.mediaId,associatedData:{id:r.id,matrix:null}}),r&&r.media2D&&r.media2D.length&&!0===this.isR2V)for(let e=0;e<r.media2D.length;e++)i.push({mediaId:r.media2D[e].mediaId,associatedData:{id:r.media2D[e].id,matrix:r.media2D[e].matrix,background:r.media2D[e].background}}),!0===r.media2D[e].background&&(v.setPreferenceValue("camPosR2V",r.media2D[e].R2VCamera.camPos),v.setPreferenceValue("quatR2V",r.media2D[e].R2VCamera.quat),v.setPreferenceValue("fovR2V",r.media2D[e].R2VCamera.fov),v.setPreferenceValue("focalR2V",r.media2D[e].R2VCamera.focal),v.setPreferenceValue("imWidthR2V",r.media2D[e].R2VCamera.imWidth),v.setPreferenceValue("imHeightR2V",r.media2D[e].R2VCamera.imHeight));return i.length?new t(function(t){g.getMedias(i,function(e){p.mask(this._mask,"Loading "+e+"%")}.bind(this)).then(function(r){y.initialize();var i=null,a=null,n="",s=0,l=0,d=0;const c=()=>{++d===r.length&&t()};for(var m=0;m<r.length;m++)if(r[m].status===M.STATUS_PROCESSING&&r[m].type&&(n+=r[m].title+" ",l++),r[m].status===M.STATUS_KO&&r[m].type&&s++,r[m].format===M.FORMAT_3D&&r[m].status!==M.STATUS_PROCESSING&&(a=r[m].associatedData.matrix?(i=JSON.parse(r[m].associatedData.matrix)).elements:null,this.load3DModel(r[m].url,a,c)),r[m].format===M.FORMAT_2D||r[m].status===M.STATUS_PROCESSING)if(r[m].associatedData.background&&!0===r[m].associatedData.background){var h=new w({viewer:this._viewer});this._viewer.setAmbience(h);var p=r[m].url;p=(new f).generateUrlWithSuffix(p),this._isMobileApp&&(p=e.Data.proxifyUrl(p,{proxy:"passport"})),h.setBackGroundMap({url:p,mapping:new o.SimpleEnvMappingFit,hdr:!1}),c()}else i=JSON.parse(r[m].associatedData.matrix),this.load2DModel(r[m].url,i.elements,r[m].type,r[m].status,c);l&&(y.setGeneralErrorMessage(l+" media not yet processed. Try reloading when all medias are processed","",n,"warning"),t()),s&&(y.setGeneralErrorMessage(s+" media not available. Check your access rights","","","warning"),t())}.bind(this)).catch((function(e){e&&console.log(e)}))}.bind(this)):new t((function(e){e()}))},_convertJSON:function(e){return new Promise(function(t){this._DataModelConverter.convertToLatestVersion(e).then((function(e){t(e)})).catch((function(){t(e)}))}.bind(this))},load:function(t,r,i,a){this._3DSKTContainer=new s("3DSKTContainer"),this._annotContainer=new s("annotContainer"),this._3DSKTContainer.addChild(this._annotContainer),this._viewer=t.viewer,this._maskContainer=e.createElement("div",{styles:{opacity:.7,pointerEvents:"none",position:"absolute",top:"0",width:"100%",height:"100%",zIndex:10,display:"none"}}).inject(document.body),this._mask=e.createElement("div",{styles:{position:"absolute",top:"0",width:"100%",height:"100%"}}).inject(this._maskContainer),p.mask(this._mask,"Loading");var n={};if(t.requestsOptions&&t.requestsOptions.serverurl)n.platformUrl=t.requestsOptions.serverurl;else{n.platformId=u.getTenant();try{!n.platformId&&parent.ds&&parent.ds.swymTenant&&(n.platformId=parent.ds.swymTenant)}catch(e){}}t.requestsOptions&&t.requestsOptions.appname&&(this._appname=t.requestsOptions.appname),"3dstory"!==this._appname&&(this._maskContainer.style.display="block"),g.initWithTenant(n),this._DataModelConverter=new D({version:"5.0",webapp:D.APP_3DSKETCH,platformId:v.getPreferenceValue("swymTenant"),platformUrl:n.platformUrl,viewer:this._viewer,viewpoint:this._viewer.currentViewpoint});var o=this._viewer.getUserPassManager();this._beforeMainPass=new h("BeforeMain");var l=o.createUserClearPass("userClearPass",this._beforeMainPass);l.setClearDepth(!0);var d=o.createUserRenderPass("userRenderPass",this._beforeMainPass),c=o.getSystemPass("main");o.insertUserPassBeforePass(l,c),o.insertUserPassBeforePass(d,l),this.readJsonFile(t.filename).then(this.unzip.bind(this)).then(this._convertJSON.bind(this)).then(this.drawSketch.bind(this)).then(this.getMedias.bind(this)).then(function(){p.unmask(this._mask),document.body.removeChild(this._maskContainer),r(this._3DSKTContainer),a(this._3DSKTContainer),this.isR2V||this._viewer.currentViewpoint.reframe(null,0),m.trackPageEvent({eventCategory:"3DSketch_Loader",eventAction:"3DSketch_LoadVisu",eventLabel:"Load visu of sketch in other apps",appID:"CAT3DSKT_AP"})}.bind(this)).catch(this._error)},_error:function(e){console.error(e)}})}));