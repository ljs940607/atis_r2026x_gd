define("DS/DMUValWebAppController/DMUValWebAppController",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/CATWebUXComponents/CATWebUXNotification","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","DS/DMUReviewCommonWebApp/DMUCommonWebAppController","DS/DMUControls/DMUToolsSave","i18n!DS/DMUValWebAppController/assets/nls/DMUValWebAppController"],(function(e,t,n,i,o,r,a){"use strict";var s=o.extend({init:function(e){this._parent(e,"R3V");let o=this;var s,c=(e||{}).ctxViewer,d={};function l(e){var n=t.getEventsController({viewer:c.getViewer()});r.tryToSaveData({frameWindow:c.getFrameWindow(),saveFunction:function(){return new Promise((function(t,r){i.setCheckRequirement({checkId:e.checkId,requirementId:e.requirementId,removeReq:e.removeReq,onSetCheckRequirementComplete:async i=>{if(i.removeReq)n.fireEvent("onRequirementRemoved",i);else{let t,r;e.requirementTitle?r=e.requirementTitle:(t=await o.getRequirementData({phyId:i.requirementId}),r=t[0]["attribute[Title]"]),n.fireEvent("onRequirementAdded",{checkId:i.checkId,requirementId:i.requirementId,requirementTitle:r})}t()},onSaveFailed:r})}))}}).catch((e=>{window.console.error(e)}))}function u(e){"ValidationRequirement"===e.type&&l({checkId:e.checkId,removeReq:"true",requirementId:e.objectId})}function m(e){i.removeImpactedCheck({check:e.check,highlight:e.highlight,iCtxViewer:c,onRemoveImpactedCheckComplete:function(){},onRemoveImpactedCheckFailed:function(){var e;e={type:"error",msg:a.remImpactedCheckError},(new n).build({type:e.type,autoHide:!0,message:e.msg,body:c.getFrameWindow().getUIFrame()})}})}function v(e){let n={};n[e.markupId]=[e.commentId];var o=t.getReviewContext({viewer:c.getViewer()}),r=o.getValidation();r&&!o.getIsRemovingInternalDataModel()&&i.removeCommentStatus({viewer:c.getViewer(),validation:r,commentsID:n,onRemoveCommentStatusSuccess:()=>{},onRemoveCommentStatusFailed:()=>{}})}function p(e){var n=[],o=[];if(void 0!==e.status){n.push({iCheckState:e.status});for(let t=0;t<e.objectIds.length;t++)o.push({attributesList:n,objectId:e.objectIds[t]})}else e.name&&n.push({sName:e.name}),e.description&&n.push({sDescription:e.description}),o.push({attributesList:n,objectId:e.objectId});r.tryToSaveData({frameWindow:c.getFrameWindow(),saveFunction:function(){return new Promise((function(e,n){i.updateAttributes({objectsToModify:o,ctxViewer:c,onAttributesSaveCompleted:function(n){var i=t.getReviewContext({viewer:c.getViewer()}),o=t.getEventsController({viewer:c.getViewer()}),r=i.getValidation().getChecks();for(let e=0;e<r.length;e++){var a=n.modifiedObjects;for(let t=0;t<a.length;t++)r[e].getPlmID()===a[t].pId&&(a[t].sName&&r[e].setName(a[t].sName),a[t].sDescription&&r[e].setDescription(a[t].sDescription),void 0!==a[t].iCheckState&&r[e].setStatus(a[t].iCheckState),o.fireEvent("onAttributeSaved",{type:"Check",id:a[t].pId,name:a[t].sName?a[t].sName:void 0,status:a[t].iCheckState?parseInt(a[t].iCheckState):void 0,description:a[t].sDescription?a[t].sDescription:void 0,object:r[e]}))}e()},onSaveFailed:n})}))}}).catch((e=>{window.console.error(e)}))}function h(e){var n=[],o=[];if(void 0!==e.rating){n.push({iPresentationRating:e.rating});for(let t=0;t<e.objectIds.length;t++)o.push({attributesList:n,objectId:e.objectIds[t]})}else e.name&&n.push({sName:e.name}),e.description&&n.push({sDescription:e.description}),e.slideId&&n.push({sPresentationSlideID:e.slideId}),o.push({attributesList:n,objectId:e.objectId});r.tryToSaveData({frameWindow:c.getFrameWindow(),saveFunction:function(){return new Promise((function(e,n){i.updateAttributes({objectsToModify:o,ctxViewer:c,onAttributesSaveCompleted:function(n){var i=t.getReviewContext({viewer:c.getViewer()}),o=t.getEventsController({viewer:c.getViewer()}),r=i.getValidation().getHighlights();for(let e=0;e<r.length;e++){var a=n.modifiedObjects;for(let t=0;t<a.length;t++)r[e].getPlmID()===a[t].pId&&(a[t].sName&&r[e].setName(a[t].sName),a[t].sDescription&&r[e].setDescription(a[t].sDescription),a[t].iPresentationRating&&r[e].setRating(a[t].iPresentationRating),a[t].sPresentationSlideID&&r[e].setPresentationSlideId(a[t].sPresentationSlideID),o.fireEvent("onAttributeSaved",{type:"Highlight",id:a[t].pId,name:a[t].sName?a[t].sName:void 0,rating:a[t].iPresentationRating?parseInt(a[t].iPresentationRating):void 0,description:a[t].sDescription?a[t].sDescription:void 0}))}e()},onSaveFailed:n})}))}}).catch((e=>{window.console.error(e)}))}this.setActiveState=async function(e){var n=e;s=t.getEventsController({viewer:c.getViewer()}),n?(d.onCheckAttributeChanged=s.addEvent("onCheckAttributeChanged",p),d.onHighlightAttributeChanged=s.addEvent("onHighlightAttributeChanged",h),d.onRequirementAdded=s.addEvent("requirementAddRequested",l),d.onRequirementRemoveRequested=s.addEvent("onRequirementRemoveRequested",u),d.onRemoveImpactedCheckRequested=s.addEvent("onRemoveImpactedCheckRequested",m),d.onDMUCommentWithStatusDeleted=s.addEvent("onDMUCommentWithStatusDeleted",v),await this.setControllerActiveState(e)):(d={},this.setControllerActiveState(e))}}}),c=[];return e.singleton({init:function(){},giveController:function(e){if(e&&e.context)for(var t=0;t<c.length;t++)if(c[t].context===e.context)return c[t].controller},getController:function(e){var t;if(e&&e.context&&!(t=this.giveController(e))){var n=new s({ctxViewer:e.context});t=Object.freeze({setActiveState:async function(e){n&&await n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},clearController:function(){n&&(n.clearController(),n=null)},appInitFromTransition:function(e){return n?n.appInitFromTransition(e):Promise.resolve()},loadValidation:function(e){n&&n.loadValidation(e)},refreshContext:function(){n&&n.refreshContext()},loadReviewAfterRefresh:function(e){n&&n.loadReviewAfterRefresh(e)},disableDMUContextualBar:function(){n&&n.disableDMUContextualBar()},enableDMUContextualBar:function(){n&&n.enableDMUContextualBar()},publish:function(e,t){n&&n.publish(e,t)},setappTransition:function(e){n&&n.setappTransition(e)}}),c.push({context:e.context,controller:t})}return t},unreferenceController:function(e){if(e&&e.context)for(var t=0;t<c.length;t++)if(c[t].context===e.context){e.options&&e.options.appInfo&&"X3DPLAW_AP"===e.options.appInfo&&c[t].controller.setappTransition(!0),c[t].controller.clearController(),c.splice(t,1);break}}})}));