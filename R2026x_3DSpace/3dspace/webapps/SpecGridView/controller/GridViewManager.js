define("DS/SpecGridView/controller/GridViewManager",["UWA/Core","UWA/Class","DS/Utilities/Utils","DS/XSRCommonComponents/utils/Utils","DS/DataGridView/DataGridView","DS/SpecGridView/controller/GridColumn","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/components/XSpecDnD/DragDropUtil","i18n!DS/SpecGridView/assets/nls/SpecGridView","css!DS/SpecGridView/GridViewManger.css"],(function(e,t,n,o,i,a,l,r,s,d,u,c){"use strict";return t.extend({init:function(t){var n=t;this._parent(n),this.appCore=n.appCore,this.itemId=n.itemId;var o=n.container,i=n.columns;this.modelEvents=n.appCore.specViewerModelEvents,this.model=n.model,this.currentTabKey=n.currentTabKey,this.rowDragEnabledFlag=!t.dvgOpts||!1!==t.dvgOpts.rowDragEnabledFlag,this.basicModelEvents=n.appCore.basicModelEvents,this.container=e.createElement("div",{id:"grid-row-view"}).inject(o),this.parentModel=t.parentModel,this.gridColumns=new a,i&&this.initializeColumns(i),this._subscribe()},_subscribe:function(){this.eventList=[]},initializeColumns:function(e){this.columnCharValidationList={},this.exportableColums=[],this.columns=this.gridColumns.process.call(this,e)},addColumn:function(e,t,n){if(!n){let n=[e];this.processedColumns=this.gridColumns.process.call(this,n),this.grid.addColumnOrGroup(this.processedColumns[0],t)}},removeColumn:function(e,t){t&&this.grid.removeColumnOrGroup(e)},setColumns:function(e){this.initializeColumns(e)},drawGrid:function(t,a){var l=this;!async function(){l.grid=new i({columns:l.columns,showModelChangesFlag:!0,showTreeIconsFlag:!0,showRowBorderFlag:!0,rowGroupingOptions:l.model.rowGroupingOptions,treeDocument:l.model,showNodeKPIColorFlag:l.model.isColorized,cellSelection:"multiple",rowSelection:"multiple",rowDragEnabledFlag:l.rowDragEnabledFlag,onContextualEvent:function(e,t){if(e&&e.collectionView&&e.cellInfos){e.collectionView.columns.length;var n=e.cellInfos.columnID,o=e.cellInfos.rowID;if(!(n>=0&&o>=0))return e.collectionView.buildDefaultContextualMenu(e,t);e.cellInfos.nodeModel.isSelected()||(e.collectionView.unselectAll(),e.cellInfos.nodeModel.select());var i=l.currentTabKey?r.GRID_CONTEXT_MENU+"-"+l.currentTabKey:r.GRID_CONTEXT_MENU;l.modelEvents&&l.modelEvents.publish({event:i,data:e})}}.bind(this)}),l.grid.onDelayedModelDataRequest=n.debounce((function(e){if(l.modelEvents){let t="xsr-grid-lazy-load";l.currentTabKey&&(t=t+"-"+l.currentTabKey);let n=l.grid.model.slice(e.startNodeIndex,e.endNodeIndex+1);l.modelEvents.publish({event:t,data:n})}}),200),l.grid.inject(l.container),l.grid.layout.cellHeight=24,l.model.setLayoutInstance(l.grid.layout),l.grid.onCustomViewsSave=function(t,n){var i=t,a=s.getSecurityContext();if("bom"===l.currentTabKey||"formulatedbom"===l.currentTabKey){if("VPLMAdmin"===a.split("::")[1].split(".")[0]&&"DefaultConfiguration"===t[n].identifier){var r={},u=new e.Element("div",{class:"Update-Dialog-Option-Container"}),m=new e.Element("div",{class:"xsr-update-message-icon"}).inject(u);new e.Element("span",{class:"xsr-update_warning_icon fonticon fonticon-attention fonticon-2x"}).inject(m),new e.Element("p",{class:"message-container",html:c.Update_Attribute}).inject(m);r.position={at:"center",my:"center"},r.Title=c.Update_Att_Title,r.Content=u,r.width=450,r.height=150,r.renderTo=document.getElementById("xspecsContainer"),r.RemoveApplyButton=!0,r.OKLabel="OK";var g=new d(r);g.render(),g._dialog.buttons.Ok.disabled=!1,g.listenTo(g,"EVENT_CLICK_SPEC_CANCEL",(async function(){var e=await o.loadBOMCustomViewConfiguration(l.currentTabKey);let t;delete e.tab;try{t=JSON.parse(e)}catch(e){t={}}let n={identifier:"DefaultConfiguration",label:"Default Configuration",columnsVisibleFlag:t};l.grid.loadCustomViews([n],0)})),g.listenTo(g,"EVENT_CLICK_SPEC_OK",(function(){g.closeDialog(),o.saveBOMCustomConfiguration(i,l.currentTabKey)}))}"VPLMAdmin"!==a.split("::")[1].split(".")[0]&&(widget.getValue("recipeView")?(widget.setValue("CustomGridViewsRecipeview"+l.currentTabKey,i),widget.setValue("CurrentCustomViewIndexRecipeView"+l.currentTabKey,n)):(widget.setValue("CustomGridViews"+l.currentTabKey,i),widget.setValue("CurrentCustomViewIndex"+l.currentTabKey,n)))}"bom"!==l.currentTabKey&&"formulatedbom"!==l.currentTabKey&&(widget.setValue("CustomGridViews"+l.currentTabKey,i),widget.setValue("CurrentCustomViewIndex"+l.currentTabKey,n)),l.modelEvents&&l.modelEvents.publish({event:"XSR-CUSTOM-VIEW-SAVE"})};var t,a=widget.getValue("CustomGridViews"+l.currentTabKey),m=widget.getValue("CurrentCustomViewIndex"+l.currentTabKey);if(widget.getValue("recipeView")&&(a=widget.getValue("CustomGridViewsRecipeview"+l.currentTabKey),m=widget.getValue("CurrentCustomViewIndexRecipeView"+l.currentTabKey)),t="number"==typeof m?m>=0:m,"bom"===l.currentTabKey||"formulatedbom"===l.currentTabKey){var g=await o.loadBOMCustomViewConfiguration(l.currentTabKey);if(delete g.tab,a&&t)l.grid.loadCustomViews(a,m);else if(g){let e={identifier:"DefaultConfiguration",label:"Default Configuration",columnsVisibleFlag:JSON.parse(g)};l.grid.loadCustomViews([e],0)}}"bom"!==l.currentTabKey&&"formulatedbom"!==l.currentTabKey&&a&&t&&l.grid.loadCustomViews(a,m),l.rowDragEnabledFlag&&(l.grid.onDragStartRowHeaderDefault=function(e,t){l.model.unselectAll(),t.nodeModel.select();var n=(new u).prepareDragData(l.model.getSelectedNodes());e.dataTransfer.effectAllowed="all",e.dataTransfer.setData("text",n)},l.grid.onDragOverRowHeader=function(){console.log("Drag over ignored to avoid css change in UI")},l.grid.onDragOverCell=function(){console.log("Drag over cell ignored to avoid css change in UI")},l.grid.onDropRowHeader=function(e,t){console.log("Drop ignored")});l.grid.getTypeRepresentationFactory().registerTypeTemplates(JSON.stringify({UWAObjectTemplate:{path:"DS/SpecGridView/utils/UWAObjectTemplate",options:{}}})),l.addEvents();var p={};p[c.label_Yes]=!0,p[c.label_No]=!1;var h={contextMenu:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"chevron-down",fontIconFamily:1}}},quickViewMenu:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"eye",fontIconFamily:1}}},positiveInteger:{stdTemplate:"spinEdit",semantics:{stepValue:1,minValue:1}},UWAObject:{stdTemplate:"UWAObjectTemplate"},DisplayBooleanCombobox:{stdTemplate:"enumCombo",semantics:{possibleValues:p,valueType:"enumCusto"}}};l.grid.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(h))}(),this.model.unselectAll(),a?l.hide():l.show()},addEvents:function(){var t=this;this.grid.getCellsXSO().onPostAdd((function(n){if(n&&e.is(n,"array")&&1==n.length){t.grid.unselectAll(),!n[0].nodeModel._canBeGrouped()?setTimeout((function(){n[0].nodeModel.select()}),50):n[0].nodeModel.select()}})),this.grid.addEventListener("click",(function(e,n){if(void 0!==n&&-1!==n.rowID){if(!e.target.hasClassName("wux-tweakers-string-icon"))return;var o=e.dsModel.layout.getDataIndexFromColumnIndex(n.columnID);if("Alternate"===o){let e={cellInfo:n,column:o};t.modelEvents&&t.modelEvents.publish({event:r.EVENT_BOM_GRID_ICON_CLICK,data:e})}}})),this.grid.addEventListener("dragstart",(function(e,t){o.dragStartedInXSR=!0})),this.grid.addEventListener("dragend",(function(e,t){o.dragStartedInXSR=!1})),this.grid.addEventListener("preEdit",(function(e,n){t.grid.getTreeDocument().cancelChanges()}));var n=function(e){if(e.columnIndex)var n=e.columnIndex;else n=t.grid.layout.getDataIndexFromColumnIndex(e.columnID);var i=e.cellModel,a=e.nodeModel?e.nodeModel.getReferenceValue(n):void 0;a=a&&Array.isArray(a)?a[0]:a;var s="string"==typeof i?i.trim():i;"date"===t.grid.layout.getColumnTypeRepresentation(e.columnID)&&("Invalid Date"===(s=new Date(i).toUTCString())&&(s=""));if(n.startsWith("bom")||n.startsWith("formulatedbom")){var d=t.grid.getColumnOrGroup(e.columnID);if(d&&("bom"===e.nodeModel.currentTabKey||"formulatedbom"===e.nodeModel.currentTabKey)&&(e.nodeModel.setCustomDimensionType(d.dimensionType),e.nodeModel.setCustomUnit(d.unit),d.unit)){let t=s.split(" ");s=t[0]?t[0]:"";var u=t[1]?t[1]:"";s.trim(),u.trim();var m=a.split(" ")[1];if(a=a.includes(" ")?a.split(" ")[0]:"",isNaN(parseFloat(s))||isNaN(s)){if(""!=s||""!=u)return void e.nodeModel.cancelChanges();if("0.0"===a||a===d.default)return void e.nodeModel.cancelChanges();s=d.default?d.default:"0"}else if(u!==m&&""!==u)return void e.nodeModel.cancelChanges()}}if(s!==a)if(t.columnCharValidationList&&t.columnCharValidationList[n]&&o.hasBadChar(s)){var g=c.replace(c.get("FailedToUpdateCell"),{forbiddenChar:r.FORBIDDEN_CHARS});l.displayNotification({eventID:"error",msg:g}),t.modelEvents&&t.modelEvents.publish({event:"xsr-show-toolbar-reset-command-"+t.currentTabKey})}else t.modelEvents&&(t.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+t.currentTabKey}),t.modelEvents.publish({event:"grid-cell-value-update-"+t.currentTabKey,data:{nodeModel:e.nodeModel,newValue:s,oldValue:a,dataIndex:n}}));else t.modelEvents&&t.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+t.currentTabKey})};this.grid.getTreeDocument().onNodeModelUpdate((function(e){if(e.data.attributes){var t=e.data.attributes;if(t.hasOwnProperty("quantity"))(o={}).columnIndex=r.COLUMN_QUANTITY,o.nodeModel=e.target,o.cellModel=t.quantity,n(o);else if(t.hasOwnProperty("asRequired")){(o={columnIndex:"asRequired"}).nodeModel=e.target,o.cellModel=t.asRequired,n(o)}else if(t.hasOwnProperty("unitNLS")){(o={columnIndex:"unitNLS"}).nodeModel=e.target,o.cellModel=t.unitNLS,n(o)}else if(t.hasOwnProperty("minQuantity")){(o={columnIndex:"minQuantity"}).nodeModel=e.target,o.cellModel=t.minQuantity,n(o)}else if(t.hasOwnProperty("maxQuantity")){(o={columnIndex:"maxQuantity"}).nodeModel=e.target,o.cellModel=t.maxQuantity,n(o)}else if(t.hasOwnProperty("targetQuantity")){(o={columnIndex:"targetQuantity"}).nodeModel=e.target,o.cellModel=t.targetQuantity,n(o)}else if(t.hasOwnProperty("quantityLength")){(o={columnIndex:"quantityLength"}).nodeModel=e.target,o.cellModel=t.quantityLength,n(o)}else if(t.hasOwnProperty("quantityWidth")){var o;(o={columnIndex:"quantityWidth"}).nodeModel=e.target,o.cellModel=t.quantityWidth,n(o)}}})),this.grid.addEventListener("change",(function(e,o){void 0===o||"double"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"boolean"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"independantBoolean"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"string"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"integer"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"date"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"real"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"textBlock"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)||n(o)}))},highlightCell:function(e,t){if(e&&t){var n=this.grid.layout.getColumnIndex(t),o=this.grid.layout.getCellIDFromCoordinates({rowID:e,columnID:n});o&&this.grid.selectCell(o)}},setColumnVisibilityFlag:function(e,t){this.grid.layout.setColumnVisibleFlag(e,t)},exportCSV:function(e){var t=this.grid.layout.getVisibleOrderedLeafColumns(),n=[];let i="",a="",l=!1;if(t&&t.length>0){for(var s=0;s<t.length;s++){var d=t[s],u=d.dataIndex;if(d.exportFlag)switch(n.push(u),i+=d.text+",",u){case"tree":a+=this.parentModel.getAttributeValue("ds6w:label")+",";break;case"partNumber":a+=this.parentModel.getAttributeValue("ds6wg:EnterpriseExtension.V_PartNumber")+",";break;case"ds6w:type":a+=this.parentModel.getAttributeValue("ds6w:type")+",";break;case"ds6wg:revision":a+=this.parentModel.getAttributeValue("ds6wg:revision")+",";break;case"ds6w:status":a+=this.parentModel.options.maturity+",";break;case"name":a+=this.parentModel.options.name+",";break;case"ds6w:description":a+=this.parentModel.options.description+",";break;case"ds6w:responsible":a+=this.parentModel.getAttributeValue("ds6w:responsible")+",";break;case"ds6w:modified":a+=this.parentModel.options.lastmodified+",";break;case"ds6w:created":a+=this.parentModel.options.originated+",";break;case"level":a+="0,",l=!0;break;case"ds6w:library":a+='"'+this.parentModel.getAttributeValue("ds6w:library")+'",';break;default:a+=","}}let m=this.currentTabKey===r.FORMULABOM_TAB;this.currentTabKey===r.BOM_TAB&&(m=!l);var c=this.grid.getAsCSV({forceQuotes:!1,allColumns:!1,onlySelectedRows:!(!e||!e.onlySelectedRows)&&e.onlySelectedRows,columnKeys:n,columnSeparator:e&&e.columnSeparator?e.columnSeparator:void 0,addLevelInformation:m});this.currentTabKey===r.BOM_TAB&&(m&&(i=","+i,a=","+a),c=i+"\n"+a+"\n\n"+c.trim()),o.downloadCSV(c,e.fileName)}},personalizeColumns:function(){this.grid.showCustomViewsDialog()},hide:function(){this.container.setStyle("display","none")},show:function(){this.container.setStyle("display","block")},destroy:function(){this.eventList&&this.eventList.length>0&&this.modelEvents.unsubscribeList(this.eventList),this.grid.destroy&&this.grid.destroy(),this.model&&this.model.destroy&&this.model.destroy()}})}));