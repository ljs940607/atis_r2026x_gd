define("DS/VisuLoaders/ColladaLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction"],(function(e,t,s){var i=function(){var i,r,a,n,o,h,l=null,c=null,u=null,d={},p={},f={},m={},g={},v={},b={},y={},N=e.SmoothShading,x={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null,waitMaterial:new e.MeshPhongMaterial({color:new e.Color(16777215)})},w=1,k="Y",T=null;function _(t,s,d){if(l=t,s=s||u,void 0!==d){var N=d.split("/");N.pop(),n=(N.length<1?".":N.join("/"))+"/"}!function(){var e=l.evaluate("//dae:asset",l,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(e&&e.childNodes)for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];switch(s.nodeName){case"unit":var i=s.getAttribute("meter");i&&(w=parseFloat(i));break;case"up_axis":k=s.textContent.charAt(0)}}}(),function(){if(x.convertUpAxis&&k!==x.upAxis)switch(k){case"X":T="Y"===x.upAxis?"XtoY":"XtoZ";break;case"Y":T="X"===x.upAxis?"YtoX":"YtoZ";break;case"Z":T="X"===x.upAxis?"ZtoX":"ZtoY"}else T=null}(),p=O("//dae:library_images/dae:image",X,"image"),v=O("//dae:library_materials/dae:material",te,"material"),b=O("//dae:library_effects/dae:effect",ne,"effect"),g=O("//dae:library_geometries/dae:geometry",G,"geometry"),y=O(".//dae:library_cameras/dae:camera",de,"camera"),m=O("//dae:library_controllers/dae:controller",P,"controller"),f=O("//dae:library_animations/dae:animation",he,"animation"),a=O(".//dae:library_visual_scenes/dae:visual_scene",B,"visual_scene"),o=[],h=[],i=function(){var e=l.evaluate(".//dae:scene/dae:instance_visual_scene",l,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(e){var t=e.getAttribute("url").replace(/^#/,"");return a[t.length>0?t:"visual_scene0"]}return null}(),c=new e.Object3D;for(var _=0;_<i.nodes.length;_++)c.add(E(i.nodes[_]));c.scale.multiplyScalar(w),r=[],C(c);var A={scene:c,morphs:o,skins:h,animations:r,dae:{images:p,materials:v,cameras:y,effects:b,geometries:g,controllers:m,animations:f,visualScenes:a,scene:i}};return s&&s(A),A}function O(e,t,s){for(var i=l.evaluate(e,l,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),r={},a=i.iterateNext(),n=0;a;){var o=(new t).parse(a);o.id&&0!=o.id.length||(o.id=s+n++),r[o.id]=o,a=i.iterateNext()}return r}function C(e){var t=i.getChildById(e.name,!0),s=null;if(t&&t.keys){s={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},r.push(s);for(var a=0,n=t.keys.length;a<n;a++)s.length=Math.max(s.length,t.keys[a].time)}else s={hierarchy:[{keys:[],sids:[]}]};for(a=0,n=e.children.length;a<n;a++)for(var o=0,h=C(e.children[a]).hierarchy.length;o<h;o++)s.hierarchy.push({keys:[],sids:[]});return s}function A(e,t){var s=t instanceof U?m[t.url]:t;if(s&&s.morph)for(var i=s.morph,r=0;r<i.targets.length;r++){var a=i.targets[r],n=g[a];if(n.mesh&&n.mesh.primitives&&n.mesh.primitives.length)n.mesh.primitives[0].geometry}else console.log("could not find morph controller!")}function M(t,s,i,r){if(t.world=t.world||new e.Matrix4,t.world.copy(t.matrix),t.channels&&t.channels.length){var a=t.channels[0].sampler.output[i];a instanceof e.Matrix4&&t.world.copy(a)}r&&t.world.multiplyMatrices(r,t.world),s.push(t);for(var n=0;n<t.nodes.length;n++)M(t.nodes[n],s,i,t.world)}function R(t,s){for(var i=0;i<t.length;i++){var r=t[i],a=-1;if("JOINT"==r.type){for(var n=0;n<s.joints.length;n++)if(r.sid==s.joints[n]){a=n;break}if(!(a>=0))throw"ColladaLoader: Could not find joint '"+r.sid+"'.";var o=s.invBindMatrices[a];r.invBindMatrix=o,r.skinningMatrix=new e.Matrix4,r.skinningMatrix.multiplyMatrices(r.world,o),r.weights=[];for(n=0;n<s.weights.length;n++)for(var h=0;h<s.weights[n].length;h++){var l=s.weights[n][h];l.joint==a&&r.weights.push(l)}}}}function j(t,s,r){var a=m[s.url];if(r=void 0!==r?r:40,a&&a.skin)if(s.skeleton&&s.skeleton.length){var n,o,h,l,c,u,d,p=function(){var e=1e6,t=-e,s=0;for(var i in f)for(var r=f[i],a=0;a<r.sampler.length;a++){var n=r.sampler[a];n.create(),e=Math.min(e,n.startTime),t=Math.max(t,n.endTime),s=Math.max(s,n.input.length)}return{start:e,end:t,frames:s}}(),g=i.getChildById(s.skeleton[0],!0)||i.getChildBySid(s.skeleton[0],!0),v=new e.Vector3;for(n=0;n<t.vertices.length;n++)t.vertices[n].applyMatrix4(a.skin.bindShapeMatrix);for(r=0;r<p.frames;r++){var b=[],y=[];for(n=0;n<t.vertices.length;n++)y.push(new e.Vector3);for(M(g,b,r),R(b,a.skin),n=0;n<b.length;n++)if("JOINT"==b[n].type)for(o=0;o<b[n].weights.length;o++)l=(h=b[n].weights[o]).index,c=h.weight,u=t.vertices[l],d=y[l],v.x=u.x,v.y=u.y,v.z=u.z,v.applyMatrix4(b[n].skinningMatrix),d.x+=v.x*c,d.y+=v.y*c,d.z+=v.z*c}}else console.log("ColladaLoader: Could not find the skeleton for the skin. ");else console.log("ColladaLoader: Could not find skin controller.")}function E(t,s){var i,r,a,n,l=new e.Object3D;for(a=0;a<t.controllers.length;a++){var c=m[t.controllers[a].url];switch(c.type){case"skin":if(g[c.skin.source])(d=new F).url=c.skin.source,d.instance_material=t.controllers[a].instance_material,t.geometries.push(d),!0,i=t.controllers[a];else if(m[c.skin.source]){var u=m[c.skin.source];if(r=u,u.morph&&g[u.morph.source])(d=new F).url=u.morph.source,d.instance_material=t.controllers[a].instance_material,t.geometries.push(d)}break;case"morph":var d;if(g[c.morph.source])(d=new F).url=c.morph.source,d.instance_material=t.controllers[a].instance_material,t.geometries.push(d),r=t.controllers[a];console.log("ColladaLoader: Morph-controller partially supported.")}}var p={};for(a=0;a<t.geometries.length;a++){var f,N=t.geometries[a],w=N.instance_material,k=g[N.url],T={},_=[],O=0;if(k){if(!k.mesh||!k.mesh.primitives)continue;if(0==l.name.length&&(l.name=k.id),w)for(n=0;n<w.length;n++){var C=w[n],M=v[C.target],R=M.instance_effect.url,S=b[R].shader.material;if(k.doubleSided){if(!(S in p)){var D=S.clone();D.side=e.DoubleSide,p[S]=D}S=p[S]}S.opacity=S.opacity?S.opacity:1,T[C.symbol]=O,_.push(S),(f=S).name=null==M.name||""===M.name?M.id:M.name,O++}var I,X=f||new e.MeshLambertMaterial({color:14540253,shading:e.FlatShading,side:k.doubleSided?e.DoubleSide:e.FrontSide}),P=k.mesh.geometry3js;if(O>1)for(X=new e.MeshFaceMaterial(_),n=0;n<P.faces.length;n++){var Y=P.faces[n];Y.materialIndex=T[Y.daeMaterial]}void 0!==i?(j(P,i),X.morphTargets=!0,(I=new e.SkinnedMesh(P,X,!1)).skeleton=i.skeleton,I.skinController=m[i.url],I.skinInstanceController=i,I.name="skin_"+h.length,h.push(I)):void 0!==r?(A(0,r),X.morphTargets=!0,(I=new e.Mesh(P,X)).name="morph_"+o.length,o.push(I)):I=new e.Mesh(P,X),t.geometries.length>1?l.add(I):l=I}}for(a=0;a<t.cameras.length;a++){var V=t.cameras[a],B=y[V.url];l=new e.PerspectiveCamera(B.fov,B.aspect_ratio,B.znear,B.zfar)}l.name=t.name||t.id||"",l.matrix=t.matrix;var Z=t.matrix.decompose();if(l.position=Z[0],l.quaternion=Z[1],l.useQuaternion=!0,l.scale=Z[2],x.centerGeometry&&l.geometry){var L=e.GeometryUtils.center(l.geometry);L.multiply(l.scale),L.applyQuaternion(l.quaternion),l.position.sub(L)}for(a=0;a<t.nodes.length;a++)l.add(E(t.nodes[a],t));return l}function S(e,t){for(var s=null,i=0,r=e.length;i<r&&null==s;i++){var a=e[i];if(a.time===t)s=a;else if(a.time>t)break}return s}function D(e,t){for(var s=-1,i=0,r=e.length;i<r&&-1==s;i++){e[i].time>=t&&(s=i)}return s}function I(e,t,s,i){var r=function(e,t,s){for(s=s>=0?s:s+e.length;s>=0;s--){var i=e[s];if(i.hasTarget(t))return i}return null}(e,i,s?s-1:0),a=function(e,t,s){for(;s<e.length;s++){var i=e[s];if(i.hasTarget(t))return i}return null}(e,i,s+1);if(r&&a){var n,o=(t.time-r.time)/(a.time-r.time),h=r.getTarget(i),l=a.getTarget(i).data,c=h.data;if("matrix"===h.type)n=c;else if(c.length){n=[];for(var u=0;u<c.length;++u)n[u]=c[u]+(l[u]-c[u])*o}else n=c+(l-c)*o;t.addTarget(i,h.transform,h.member,n)}}function X(){this.id="",this.init_from=""}function P(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function Y(){this.method=null,this.source=null,this.targets=null,this.weights=null}function V(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function B(){this.id="",this.name="",this.nodes=[],this.scene=new e.Object3D}function Z(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new e.Matrix4}function L(){this.sid="",this.type="",this.data=[],this.obj=null}function U(){this.url="",this.skeleton=[],this.instance_material=[]}function z(){this.symbol="",this.target=""}function F(){this.url="",this.instance_material=[]}function G(){this.id="",this.mesh=null}function q(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function H(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new e.Geometry}function W(){H.call(this),this.vcount=[]}function J(){H.call(this),this.vcount=3}function Q(){this.source="",this.count=0,this.stride=0,this.params=[]}function K(){this.input={}}function $(){this.semantic="",this.offset=0,this.source="",this.set=0}function ee(e){this.id=e,this.type=null}function te(){this.id="",this.name="",this.instance_effect=null}function se(){this.color=new e.Color(0),this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function ie(e,t){this.type=e,this.effect=t,this.material=null}function re(e){this.effect=e,this.init_from=null,this.format=null}function ae(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function ne(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function oe(){this.url=""}function he(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function le(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function ce(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ue(e){this.targets=[],this.time=e}function de(){this.id="",this.name="",this.technique=""}function pe(){this.url=""}function fe(e){var t=e.getAttribute("id");return null!=d[t]||(d[t]=new ee(t).parse(e)),d[t]}function me(e){return"dae"==e?"http://www.collada.org/2005/11/COLLADASchema":null}function ge(e){for(var t=ye(e),s=[],i=0,r=t.length;i<r;i++)s.push("true"==t[i]||"1"==t[i]);return s}function ve(e){for(var t=ye(e),s=[],i=0,r=t.length;i<r;i++)s.push(parseFloat(t[i]));return s}function be(e){for(var t=ye(e),s=[],i=0,r=t.length;i<r;i++)s.push(parseInt(t[i],10));return s}function ye(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}function Ne(e,t,s){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):s}function xe(e,t){for(var s=l.evaluate(t,e,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),i=s.iterateNext(),r=[];i;)r.push(i),i=s.iterateNext();return r}function we(e,t){e.doubleSided=!1;var s=l.evaluate(".//dae:extra//dae:double_sided",t,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);s&&(s=s.iterateNext())&&1===parseInt(s.textContent,10)&&(e.doubleSided=!0)}function ke(e,t){if(x.convertUpAxis&&k!==x.upAxis)switch(T){case"XtoY":var s=e[0];e[0]=t*e[1],e[1]=s;break;case"XtoZ":s=e[2];e[2]=e[1],e[1]=e[0],e[0]=s;break;case"YtoX":s=e[0];e[0]=e[1],e[1]=t*s;break;case"YtoZ":s=e[1];e[1]=t*e[2],e[2]=s;break;case"ZtoX":s=e[0];e[0]=e[1],e[1]=e[2],e[2]=s;break;case"ZtoY":s=e[1];e[1]=e[2],e[2]=t*s}}function Te(t,s){var i=[t[s],t[s+1],t[s+2]];return ke(i,-1),new e.Vector3(i[0],i[1],i[2])}function _e(t){if(x.convertUpAxis){var s=[t[0],t[4],t[8]];ke(s,-1),t[0]=s[0],t[4]=s[1],t[8]=s[2],ke(s=[t[1],t[5],t[9]],-1),t[1]=s[0],t[5]=s[1],t[9]=s[2],ke(s=[t[2],t[6],t[10]],-1),t[2]=s[0],t[6]=s[1],t[10]=s[2],ke(s=[t[0],t[1],t[2]],-1),t[0]=s[0],t[1]=s[1],t[2]=s[2],ke(s=[t[4],t[5],t[6]],-1),t[4]=s[0],t[5]=s[1],t[6]=s[2],ke(s=[t[8],t[9],t[10]],-1),t[8]=s[0],t[9]=s[1],t[10]=s[2],ke(s=[t[3],t[7],t[11]],-1),t[3]=s[0],t[7]=s[1],t[11]=s[2]}return new e.Matrix4(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function Oe(e){if(e>-1&&e<3){e={X:0,Y:1,Z:2}[e=Ce(["X","Y","Z"][e])]}return e}function Ce(e){if(x.convertUpAxis)switch(e){case"X":switch(T){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(T){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(T){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}return X.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];"init_from"==s.nodeName&&(this.init_from=s.textContent)}return this},P.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];switch(s.nodeName){case"skin":this.skin=(new V).parse(s),this.type=s.nodeName;break;case"morph":this.morph=(new Y).parse(s),this.type=s.nodeName}}return this},Y.prototype.parse=function(e){var t,s={},i=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":s[(n=(new ee).parse(r)).id]=n;break;case"targets":i=this.parseInputs(r);break;default:console.log(r.nodeName)}}for(t=0;t<i.length;t++){var a=i[t],n=s[a.source];switch(a.semantic){case"MORPH_TARGET":this.targets=n.read();break;case"MORPH_WEIGHT":this.weights=n.read()}}return this},Y.prototype.parseInputs=function(e){for(var t=[],s=0;s<e.childNodes.length;s++){var i=e.childNodes[s];if(1==i.nodeType&&"input"===i.nodeName)t.push((new $).parse(i))}return t},V.prototype.parse=function(e){var t,s,i={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var n=ve(a.textContent);this.bindShapeMatrix=_e(n);break;case"source":var o=(new ee).parse(a);i[o.id]=o;break;case"joints":t=a;break;case"vertex_weights":s=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,i),this.parseWeights(s,i),this},V.prototype.parseJoints=function(e,t){for(var s=0;s<e.childNodes.length;s++){var i=e.childNodes[s];if(1==i.nodeType&&"input"===i.nodeName){var r=(new $).parse(i),a=t[r.source];"JOINT"==r.semantic?this.joints=a.read():"INV_BIND_MATRIX"==r.semantic&&(this.invBindMatrices=a.read())}}},V.prototype.parseWeights=function(e,t){for(var s,i,r=[],a=0;a<e.childNodes.length;a++){var n=e.childNodes[a];if(1==n.nodeType)switch(n.nodeName){case"input":r.push((new $).parse(n));break;case"v":s=be(n.textContent);break;case"vcount":i=be(n.textContent)}}var o=0;for(a=0;a<i.length;a++){for(var h=i[a],l=[],c=0;c<h;c++){for(var u={},d=0;d<r.length;d++){var p=r[d],f=s[o+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f]}}l.push(u),o+=r.length}for(c=0;c<l.length;c++)l[c].index=a;this.weights.push(l)}},B.prototype.getChildById=function(e,t){for(var s=0;s<this.nodes.length;s++){var i=this.nodes[s].getChildById(e,t);if(i)return i}return null},B.prototype.getChildBySid=function(e,t){for(var s=0;s<this.nodes.length;s++){var i=this.nodes[s].getChildBySid(e,t);if(i)return i}return null},B.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType&&"node"===s.nodeName)this.nodes.push((new Z).parse(s))}return this},Z.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var s,i=this.channels[t],r=i.target.split("/"),a=(r.shift(),r.shift()),n=a.indexOf(".")>=0,o=a.indexOf("(")>=0;if(n)r=a.split("."),a=r.shift(),r.shift();else if(o){s=a.split("("),a=s.shift();for(var h=0;h<s.length;h++)s[h]=parseInt(s[h].replace(/\)/,""))}if(a==e)return i.info={sid:a,dotSyntax:n,arrSyntax:o,arrIndices:s},i}return null},Z.prototype.getChildById=function(e,t){if(this.id==e)return this;if(t)for(var s=0;s<this.nodes.length;s++){var i=this.nodes[s].getChildById(e,t);if(i)return i}return null},Z.prototype.getChildBySid=function(e,t){if(this.sid==e)return this;if(t)for(var s=0;s<this.nodes.length;s++){var i=this.nodes[s].getChildBySid(e,t);if(i)return i}return null},Z.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid==e)return this.transforms[t];return null},Z.prototype.parse=function(t){var s,i;this.id=t.getAttribute("id"),this.sid=t.getAttribute("sid"),this.name=t.getAttribute("name"),this.type=t.getAttribute("type"),this.type="JOINT"==this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.controllers=[],this.matrix=new e.Matrix4;for(var r=0;r<t.childNodes.length;r++){var a=t.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"node":this.nodes.push((new Z).parse(a));break;case"instance_camera":this.cameras.push((new pe).parse(a));break;case"instance_controller":this.controllers.push((new U).parse(a));break;case"instance_geometry":this.geometries.push((new F).parse(a));break;case"instance_light":case"extra":break;case"instance_node":s=a.getAttribute("url").replace(/^#/,"");var n=(i=s,l.evaluate(".//dae:library_nodes//dae:node[@id='"+i+"']",l,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext());n&&this.nodes.push((new Z).parse(n));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new L).parse(a));break;default:console.log(a.nodeName)}}return this.channels=function(e){var t=[],s=1e6,i=-1e6;for(var r in f)for(var a=f[r],n=0;n<a.channel.length;n++){var o=a.channel[n],h=a.sampler[n];(r=o.target.split("/")[0])==e.id&&(h.create(),o.sampler=h,s=Math.min(s,h.startTime),i=Math.max(i,h.endTime),t.push(o))}return t.length&&(e.startTime=s,e.endTime=i),t}(this),function(e){if(e.channels&&e.channels.length){for(var t=[],s=[],i=0,r=e.channels.length;i<r;i++){var a,n=e.channels[i],o=n.fullSid,h=n.sampler,l=h.input,c=e.getTransformBySid(n.sid);if(n.arrIndices){a=[];for(var u=0,d=n.arrIndices.length;u<d;u++)a[u]=Oe(n.arrIndices[u])}else a=Ce(n.member);if(c)for(-1===s.indexOf(o)&&s.push(o),u=0,d=l.length;u<d;u++){var p=l[u],f=h.getData(c.type,u);if(!(v=S(t,p))){v=new ue(p);var m=D(t,p);t.splice(-1==m?t.length:m,0,v)}v.addTarget(o,c,a,f)}else console.log('Could not find transform "'+n.sid+'" in node '+e.id)}for(i=0;i<s.length;i++){var g=s[i];for(u=0;u<t.length;u++){var v;(v=t[u]).hasTarget(g)||I(t,v,u,g)}}e.keys=t,e.sids=s}}(this),this.updateMatrix(),this},Z.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},L.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=ve(e.textContent),this.convert(),this},L.prototype.convert=function(){switch(this.type){case"matrix":this.obj=_e(this.data);break;case"rotate":this.angle=e.Math.degToRad(this.data[3]);case"translate":ke(this.data,-1),this.obj=new e.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":ke(this.data,1),this.obj=new e.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},L.prototype.apply=function(e){switch(this.type){case"matrix":e.multiply(this.obj);break;case"translate":e.translate(this.obj);break;case"rotate":e.rotateByAxis(this.obj,this.angle);break;case"scale":e.scale(this.obj)}},L.prototype.update=function(t,s){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(s)if(1===s.length)switch(s[0]){case 0:this.obj.n11=t[0],this.obj.n21=t[1],this.obj.n31=t[2],this.obj.n41=t[3];break;case 1:this.obj.n12=t[0],this.obj.n22=t[1],this.obj.n32=t[2],this.obj.n42=t[3];break;case 2:this.obj.n13=t[0],this.obj.n23=t[1],this.obj.n33=t[2],this.obj.n43=t[3];break;case 3:this.obj.n14=t[0],this.obj.n24=t[1],this.obj.n34=t[2],this.obj.n44=t[3]}else if(2===s.length){var r="n"+(s[0]+1)+(s[1]+1);this.obj[r]=t}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(t);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(s)&&(s=i[s[0]]),s){case"X":this.obj.x=t;break;case"Y":this.obj.y=t;break;case"Z":this.obj.z=t;break;default:this.obj.x=t[0],this.obj.y=t[1],this.obj.z=t[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(s)&&(s=i[s[0]]),s){case"X":this.obj.x=t;break;case"Y":this.obj.y=t;break;case"Z":this.obj.z=t;break;case"ANGLE":this.angle=e.Math.degToRad(t);break;default:this.obj.x=t[0],this.obj.y=t[1],this.obj.z=t[2],this.angle=e.Math.degToRad(t[3])}}},U.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1===s.nodeType)switch(s.nodeName){case"skeleton":this.skeleton.push(s.textContent.replace(/^#/,""));break;case"bind_material":var i=l.evaluate(".//dae:instance_material",s,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(i)for(var r=i.iterateNext();r;)this.instance_material.push((new z).parse(r)),r=i.iterateNext()}}return this},z.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},F.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType&&"bind_material"==s.nodeName){var i=l.evaluate(".//dae:instance_material",s,me,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(i)for(var r=i.iterateNext();r;)this.instance_material.push((new z).parse(r)),r=i.iterateNext();break}}return this},G.prototype.parse=function(e){this.id=e.getAttribute("id"),we(this,e);for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if("mesh"===s.nodeName)this.mesh=new q(this).parse(s)}return this},q.prototype.parse=function(t){var s;for(this.primitives=[],s=0;s<t.childNodes.length;s++){var i=t.childNodes[s];switch(i.nodeName){case"source":fe(i);break;case"vertices":this.vertices=(new K).parse(i);break;case"triangles":this.primitives.push((new J).parse(i));break;case"polygons":this.primitives.push((new H).parse(i));break;case"polylist":this.primitives.push((new W).parse(i))}}this.geometry3js=new e.Geometry;var r=d[this.vertices.input.POSITION.source].data;for(s=0;s<r.length;s+=3)this.geometry3js.vertices.push(Te(r,s).clone());for(s=0;s<this.primitives.length;s++){var a=this.primitives[s];a.setVertices(this.vertices),this.handlePrimitive(a,this.geometry3js)}return this.geometry3js.computeCentroids(),this.geometry3js.computeFaceNormals(),this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this.geometry3js.computeBoundingBox(),this},q.prototype.handlePrimitive=function(t,s){var i,r,a,n,o,h,l,c=t.p,u=t.inputs,p=0,f=3,m=0,g=[];for(i=0;i<u.length;i++){var v=(a=u[i]).offset+1;if(m=m<v?v:m,"TEXCOORD"===a.semantic)g.push(a.set)}for(var b=0;b<c.length;++b)for(var y=c[b],N=0;N<y.length;){var w=[],k=[],T=null,_=[];for(f=t.vcount?t.vcount.length?t.vcount[p++]:t.vcount:y.length/m,i=0;i<f;i++)for(r=0;r<u.length;r++)switch(a=u[r],h=d[a.source],o=(n=y[N+i*m+a.offset])*(l=h.accessor.params.length),a.semantic){case"VERTEX":w.push(n);break;case"NORMAL":k.push(Te(h.data,o));break;case"TEXCOORD":void 0===(T=T||{})[a.set]&&(T[a.set]=[]),T[a.set].push(new e.Vector2(h.data[o],h.data[o+1]));break;case"COLOR":_.push((new e.Color).setRGB(h.data[o],h.data[o+1],h.data[o+2]))}if(0==k.length)if(a=this.vertices.input.NORMAL){l=(h=d[a.source]).accessor.params.length;for(var O=0,C=w.length;O<C;O++)k.push(Te(h.data,w[O]*l))}else s.calcNormals=!0;if(!T&&(T={},a=this.vertices.input.TEXCOORD)){g.push(a.set),l=(h=d[a.source]).accessor.params.length;for(O=0,C=w.length;O<C;O++)o=w[O]*l,void 0===T[a.set]&&(T[a.set]=[]),T[a.set].push(new e.Vector2(h.data[o],1-h.data[o+1]))}if(0==_.length&&(a=this.vertices.input.COLOR)){l=(h=d[a.source]).accessor.params.length;for(O=0,C=w.length;O<C;O++)o=w[O]*l,_.push((new e.Color).setRGB(h.data[o],h.data[o+1],h.data[o+2]))}var A,M,R=null,j=[];if(3===f)j.push(new e.Face3(w[0],w[1],w[2],k,_.length?_:new e.Color));else if(4===f)j.push(new e.Face4(w[0],w[1],w[2],w[3],k,_.length?_:new e.Color));else if(f>4&&x.subdivideFaces){var E=_.length?_:new e.Color;for(r=1;r<f-1;)j.push(new e.Face3(w[0],w[r],w[r+1],[k[0],k[r++],k[r]],E))}if(j.length)for(O=0,C=j.length;O<C;O++)for((R=j[O]).daeMaterial=t.material,s.faces.push(R),r=0;r<g.length;r++)A=T[g[r]],M=f>4?[A[0],A[O+1],A[O+2]]:4===f?[A[0],A[1],A[2],A[3]]:[A[0],A[1],A[2]],s.faceVertexUvs[r]||(s.faceVertexUvs[r]=[]),s.faceVertexUvs[r].push(M);else console.log("dropped face with vcount "+f+" for geometry with id: "+s.id);N+=m*f}},H.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source==e.id&&(this.inputs[t].source=e.input.POSITION.source)},H.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=Ne(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];switch(s.nodeName){case"input":this.inputs.push((new $).parse(e.childNodes[t]));break;case"vcount":this.vcount=be(s.textContent);break;case"p":this.p.push(be(s.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},W.prototype=Object.create(H.prototype),J.prototype=Object.create(H.prototype),Q.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=Ne(e,"count",0),this.stride=Ne(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if("param"==s.nodeName){var i={};i.name=s.getAttribute("name"),i.type=s.getAttribute("type"),this.params.push(i)}}return this},K.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"==e.childNodes[t].nodeName){var s=(new $).parse(e.childNodes[t]);this.input[s.semantic]=s}return this},$.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=Ne(e,"set",-1),this.offset=Ne(e,"offset",0),"TEXCOORD"==this.semantic&&this.set<0&&(this.set=0),this},ee.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];switch(s.nodeName){case"bool_array":this.data=ge(s.textContent),this.type=s.nodeName;break;case"float_array":this.data=ve(s.textContent),this.type=s.nodeName;break;case"int_array":this.data=be(s.textContent),this.type=s.nodeName;break;case"IDREF_array":case"Name_array":this.data=ye(s.textContent),this.type=s.nodeName;break;case"technique_common":for(var i=0;i<s.childNodes.length;i++)if("accessor"==s.childNodes[i].nodeName){this.accessor=(new Q).parse(s.childNodes[i]);break}}}return this},ee.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var s=0;s<this.data.length;s+=16){var i=_e(this.data.slice(s,s+16));e.push(i)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"==e.childNodes[t].nodeName){this.instance_effect=(new oe).parse(e.childNodes[t]);break}return this},se.prototype.isColor=function(){return null==this.texture},se.prototype.isTexture=function(){return null!=this.texture},se.prototype.parse=function(t){for(var s=0;s<t.childNodes.length;s++){var i=t.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"color":var r=ve(i.textContent);this.color=new e.Color(0),this.color.setRGB(r[0],r[1],r[2]),this.color.a=r[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},se.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1]).childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]);for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];switch(s.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[s.nodeName]=parseFloat(s.textContent);break;case"wrapU":case"wrapV":this.texOpts[s.nodeName]=parseInt(s.textContent);break;default:this.texOpts[s.nodeName]=s.textContent}}return this},ie.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":case"normal":this[s.nodeName]=(new se).parse(s);break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var i=xe(s,".//dae:float");i.length>0&&(this[s.nodeName]=parseFloat(i[0].textContent))}}return this.create(),this},ie.prototype.create=function(){var t={},s=void 0!==this.transparency&&this.transparency<1,i=null;function r(){i&&i.numberOfAwaitedTextures&&(i.numberOfAwaitedTextures--,0===i.numberOfAwaitedTextures&&delete i.numberOfAwaitedTextures)}for(var a in this)switch(a){case"ambient":case"emission":case"diffuse":case"specular":case"normal":var o=this[a];if(o instanceof se)if(o.isTexture()){var h=o.texture,l=this.effect.sampler[h].source;if(l){var c=this.effect.surface[l],u=p[c.init_from];if(u){var d=e.ImageUtils.loadTexture(n+u.init_from,void 0,r,null,!0);d.wrapS=o.texOpts.wrapU?e.RepeatWrapping:e.ClampToEdgeWrapping,d.wrapT=o.texOpts.wrapV?e.RepeatWrapping:e.ClampToEdgeWrapping,d.offset.x=o.texOpts.offsetU,d.offset.y=o.texOpts.offsetV,d.repeat.x=o.texOpts.repeatU,d.repeat.y=o.texOpts.repeatV,"normal"===a?t.normalMap=d:t.map=d,"emission"===a&&(t.emissive=16777215)}}}else"diffuse"!==a&&s||("emission"===a?t.emissive=o.color.getHex():t[a]=o.color.getHex());break;case"shininess":t[a]=this[a];break;case"reflectivity":t[a]=this[a],t[a]>0&&(t.envMap=x.defaultEnvMap),t.combine=e.MixOperation;break;case"index_of_refraction":t.refractionRatio=this[a],1!==this[a]&&(t.envMap=x.defaultEnvMap);break;case"transparency":s&&(t.transparent=!0,t.opacity=this[a],s=!0)}switch(t.shading=N,t.side=this.effect.doubleSided?e.DoubleSide:e.FrontSide,this.type){case"constant":null!=t.emissive&&(t.color=t.emissive),i=new e.MeshBasicMaterial(t);break;case"phong":case"blinn":null!=t.diffuse&&(t.color=t.diffuse),i=new e.MeshPhongMaterial(t);break;default:null!=t.diffuse&&(t.color=t.diffuse),i=new e.MeshLambertMaterial(t)}return this.material=i,this.material},re.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"init_from":this.init_from=s.textContent;break;case"format":this.format=s.textContent;break;default:console.log("unhandled Surface prop: "+s.nodeName)}}return this},ae.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"source":this.source=s.textContent;break;case"minfilter":this.minfilter=s.textContent;break;case"magfilter":this.magfilter=s.textContent;break;case"mipfilter":this.mipfilter=s.textContent;break;case"wrap_s":this.wrap_s=s.textContent;break;case"wrap_t":this.wrap_t=s.textContent;break;default:console.log("unhandled Sampler2D prop: "+s.nodeName)}}return this},ne.prototype.create=function(){if(null==this.shader)return null},ne.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),we(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType&&"profile_COMMON"===s.nodeName)this.parseTechnique(this.parseProfileCOMMON(s))}return this},ne.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),s=0;s<e.childNodes.length;s++){var i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"surface":this.surface[t]=new re(this).parse(i);break;case"sampler2D":this.sampler[t]=new ae(this).parse(i);break;case"extra":break;default:console.log(i.nodeName)}}},ne.prototype.parseProfileCOMMON=function(e){for(var t,s=0;s<e.childNodes.length;s++){var i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseProfileCOMMON(i);break;case"technique":t=i;break;case"newparam":this.parseNewparam(i);break;case"image":var r=(new X).parse(i);p[r.id]=r;break;case"extra":break;default:console.log(i.nodeName)}}return t},ne.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new ie(s.nodeName,this).parse(s)}}},oe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},he.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"animation":var i=(new he).parse(s);for(var r in i.source)this.source[r]=i.source[r];for(var a=0;a<i.channel.length;a++)this.channel.push(i.channel[a]),this.sampler.push(i.sampler[a]);break;case"source":r=(new ee).parse(s);this.source[r.id]=r;break;case"sampler":this.sampler.push(new ce(this).parse(s));break;case"channel":this.channel.push(new le(this).parse(s))}}return this},le.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),s=(t.shift(),t.shift()),i=s.indexOf(".")>=0,r=s.indexOf("(")>=0;if(i)t=s.split("."),this.sid=t.shift(),this.member=t.shift();else if(r){var a=s.split("(");this.sid=a.shift();for(var n=0;n<a.length;n++)a[n]=parseInt(a[n].replace(/\)/,""));this.arrIndices=a}else this.sid=s;return this.fullSid=s,this.dotSyntax=i,this.arrSyntax=r,this},ce.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType&&"input"===s.nodeName)this.inputs.push((new $).parse(s))}return this},ce.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],s=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=s.read();break;case"OUTPUT":this.output=s.read(),this.strideOut=s.accessor.stride;break;case"INTERPOLATION":this.interpolation=s.read();break;case"IN_TANGENT":case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},ce.prototype.getData=function(e,t){var s;if("matrix"===e&&16===this.strideOut)s=this.output[t];else if(this.strideOut>1){s=[],t*=this.strideOut;for(var i=0;i<this.strideOut;++i)s[i]=this.output[t+i];if(3===this.strideOut)switch(e){case"rotate":case"translate":ke(s,-1);break;case"scale":ke(s,1)}else 4===this.strideOut&&"matrix"===e&&ke(s,-1)}else s=this.output[t];return s},ue.prototype.addTarget=function(e,t,s,i){this.targets.push({sid:e,member:s,transform:t,data:i})},ue.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var s=this.targets[t];e&&s.sid!==e||s.transform.update(s.data,s.member)}},ue.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ue.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ue.prototype.interpolate=function(e,t){for(var s=0;s<this.targets.length;++s){var i,r=this.targets[s],a=e.getTarget(r.sid);if("matrix"!==r.transform.type&&a){var n=(t-this.time)/(e.time-this.time),o=a.data,h=r.data;if((n<0||n>1)&&(console.log("Key.interpolate: Warning! Scale out of bounds:"+n),n=n<0?0:1),h.length){i=[];for(var l=0;l<h.length;++l)i[l]=h[l]+(o[l]-h[l])*n}else i=h+(o-h)*n}else i=r.data;r.transform.update(i,r.member)}},de.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType&&"optics"===s.nodeName)this.parseOptics(s)}return this},de.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"==e.childNodes[t].nodeName)for(var s=e.childNodes[t],i=0;i<s.childNodes.length;i++)if(this.technique=s.childNodes[i].nodeName,"perspective"==this.technique)for(var r=s.childNodes[i],a=0;a<r.childNodes.length;a++){switch((o=r.childNodes[a]).nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}else if("orthographic"==this.technique){var n=s.childNodes[i];for(a=0;a<n.childNodes.length;a++){var o;switch((o=n.childNodes[a]).nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}}return this},pe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},{load:function(e,t,s){var i=0;if(document.implementation&&document.implementation.createDocument){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==r.readyState){if(0==r.status||200==r.status)if(r.responseXML)u=t,_(r.responseXML,void 0,e);else if(r.responseText){u=t,_((new DOMParser).parseFromString(r.responseText,"application/xml"),void 0,e)}else console.error("ColladaLoader: Empty or non-existing file ("+e+")")}else 3==r.readyState&&s&&(0==i&&(i=r.getResponseHeader("Content-Length")),s({total:i,loaded:r.responseText.length}))},r.open("GET",e,!0),r.withCredentials=!0,r.send(null)}else alert("Don't know how to parse XML!")},loadFromSpec:function(e,i,r){var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"";var n=new s;t.setProxyFromSpec(e,n),n.executeGetHttpRequest(a,"text",null,(function(e){u=i,_((new DOMParser).parseFromString(e,"application/xml"),void 0,a)}),(function(){console.error("ColladaLoader: Empty or non-existing file ("+a+")")}))},parse:_,setPreferredShading:function(e){N=e},applySkin:j,geometries:g,options:x}};return e.ColladaLoader=i,i}));