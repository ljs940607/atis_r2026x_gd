define("DS/VisuLoaders/CGRReader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/Mesh","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/LoaderUtils","DS/ZipJS2/LoaderInflate","DS/Visualization/TaskManager"],(function(e,r,a,o,t,i,n,s,l,d,c,h,u,k){"use strict";var p=a.matchUrl(r.getWebappsBaseUrl(),window.location)?null:"Passport",f={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:r.getWebappsBaseUrl()+"Workers/",module:"Workers",requiredAuth:p},w=o.getWorkerAssets(),m=o.getCGRLoaderAssets(),C=function(r,a,i){i||(i={}),this.gl=r;var n=void 0;e.supportedExtensions&&(n=!!e.supportedExtensions.elementIndexUint||void 0),this.renderCallbackFunc=void 0!==a?a:null,this.isWorkerLoading=!1,this.workers=null,this.workerJobs=null,this.workerJobsId=[],this.urlToRevoke="",this.keepLoader=!!i.keepLoader&&i.keepLoader,this.type="",this.dataArray=[],this.materials=[];this.modelsToLoad=new Map,this.modelsToLoadCount=0,this.loadIndex=0,this.actualLoadIndex=0,this.nbWorkers=4,this.workersLoaded=[],this.workerActivate=!1,this.currentDownload=0,this.maxParrallelDownload=40,this.currentWorkerTask=0,this.maxTaskPerWorker=10,this.maxWorkerTask=this.maxTaskPerWorker*this.nbWorkers;C.prototype.cleanLoader=function(){this.materials=[],[]};var s=function(e,r,a){var o=a;if(r&&r.applicativeContainersNode&&(o=r.applicativeContainersNode),r&&e)for(var t in r){var i=r[t].doneCallback,n=r[t].errorCallback;if(e[t]){var s=e[t];if(!s){n({node:o});continue}var l=s.buffer.subarray(s.options.offset,s.options.compressed+s.options.offset);if(l.length<=2){n({node:o});continue}if(120!==l[0]){n({node:o});continue}if(218!==l[1]){n({node:o});continue}var d=l.subarray(2,s.options.compressed),c=(new u).Inflate(d),h=new TextDecoder("UTF-8").decode(c);i&&i({xml:h,node:o})}else i&&i({node:o})}};this.jobsScheduler=function(e){for(var r=[this.nbWorkers],a=0;a<this.nbWorkers;++a)r[a]=-1;for(a=0;a<this.workersLoaded.length;++a){for(var o=0,t=0;t<this.workerJobs[this.workersLoaded[a]].length;++t)o+=this.workerJobs[this.workersLoaded[a]][t];r[this.workersLoaded[a]]=o}var i=0,n=-1;for(a=0;a<this.nbWorkers;++a)-1!=r[a]&&(-1==n||r[a]<n)&&(n=r[a],i=a);this.workerJobs[i].push(e.inputFile.byteLength),this.workerJobsId[i].push(e.loadIndex),this.currentWorkerTask++,this.workers[i].postMessage(e,[e.inputFile])},this.internalLoad=function(){var e,r=this,a=this.actualLoadIndex,i=null,s=this.modelsToLoad.get(this.actualLoadIndex++),l=s.url;s.launched=!0;var d=function(e){var r=[];if(!e)return r;for(var a in e)r.push(a);return r}(s.applicativeContainers);s.isBuffer?((i=s.url)&&i.buffer&&(i=i.buffer),e="CGR"):l&&l.filename&&(e=l.filename);var c={loadIndex:a,inputFile:i,readDecoration:s.readDecoration,primitiveWithBS:s.primitiveWithBS,repWithBS:s.repWithBS,withSAG:s.withSAG,withBagUUID:s.withBagUUID,sagInfo:s.sagInfo,withSceneGraph:s.withSceneGraph,udlMode:s.udlMode,depthMode2D:s.depthMode2D,withBlanking:s.withBlanking,useDefaultTCSet:s.useDefaultTCSet,smartStaticBatching:s.smartStaticBatching,mode2D:s.mode2D,sceneGraphOrderMode:s.sceneGraphOrderMode,sceneGraphOrderPriority:s.sceneGraphOrderPriority,edgeTransparency:s.edgeTransparency,node:e,uint32Index:n,applicativesContainers:d,processText:s.processText,OOCSmartStaticInfo:s.OOCSmartStaticInfo,linkableBagRepUUID:s.linkableBagRepUUID,keepCompression:s.keepCompression,forceNoShowCGR:s.forceNoShowCGR,useGPUPLanar:s.GPUPlanarFace};if(s.isBuffer)this.jobsScheduler(c);else{this.currentDownload++;var h=new t;o.setProxyFromSpec(l,h);var u=l.serverurl?l.serverurl:"";u+=l.filename?l.filename:"";h.executeGetHttpRequest(u,"arraybuffer",null,(function(e){r.currentDownload--;c.inputFile=e,r.jobsScheduler(c)}),(function(e){r.currentDownload--,s.errorCallback(e)}))}},this.setKeepLoaderMode=function(e){this.keepLoader=e,this.keepLoader||0!=this.modelsToLoadCount||this.abort()},this.load=function(e,r,a){var t=this;this.cleanLoader();void 0!==a.isBuffer&&a.isBuffer;var i,n,l=(i=this.loadIndex,n=r.errorCallback,function(e){console.log("index :  "+i),n&&n(e);var r=t.modelsToLoad.get(i);if(r.applicativeContainers)for(var a in r.applicativeContainers)r.applicativeContainers[a].errorCallback&&r.applicativeContainers[a].errorCallback(e);for(t.modelsToLoad.delete(i),t.modelsToLoadCount--,0==t.modelsToLoadCount&&(null!==t.renderCallbackFunc&&t.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,reframe:!0}),r.doneCallback&&r.doneCallback()),[];t.currentDownload<t.maxParrallelDownload&&t.currentWorkerTask<t.maxWorkerTask;){var o=t.modelsToLoad.get(t.actualLoadIndex);if(!o||!1!==o.launched)break;t.internalLoad()}}),d={url:e,readyCallback:r.readyCallback,progressCallback:r.progressCallback,doneCallback:r.doneCallback,errorCallback:l,isBuffer:a.isBuffer,destinationNode:a.destination,readDecoration:a.readDeco,primitiveWithBS:a.primWithBS,repWithBS:a.repWithBS,smartStaticBatching:a.smartStaticBatching,sceneGraphOrderMode:a.sceneGraphOrderMode,sceneGraphOrderPriority:a.sceneGraphOrderPriority,withSAG:a.withSAG,withBagUUID:a.withBagUUID,sagInfo:a.sagInfo,withSceneGraph:a.withSceneGraph,fromOOC:a.fromOOC,udlMode:a.udlMode,depthMode2D:a.depthMode2D,withBlanking:a.withBlanking,useDefaultTCSet:a.useDefaultTCSet,edgeTransparency:a.edgeTransparency,sharedBuffers:a.sharedBuffers,noMeshInRAM:a.noMeshInRAM,unlinkToSG:a.unlinkToSG,mode2D:a.mode2D,applicativeContainers:a.applicativeContainers?a.applicativeContainers:null,launched:!1,processText:a.processText,accelStruct:a.accelStruct,OOCSmartStaticInfo:a.OOCSmartStaticInfo,linkableBagRepUUID:a.linkableBagRepUUID,keepCompression:a.keepCompression,forceNoShowCGR:a.forceNoShowCGR,GPUPlanarFace:a.GPUPlanarFace};if(this.modelsToLoad.set(this.loadIndex++,d),this.modelsToLoadCount++,this.workers)this.currentDownload<this.maxParrallelDownload&&this.currentWorkerTask<this.maxWorkerTask&&this.workerActivate&&this.internalLoad();else if(!this.isWorkerLoading){this.type="cgr",this.isWorkerLoading=!0;var c=w.concat(m.concat(f));o.getWorkerBlobFromSpecs(c,(function(e){t.workers=[];var r=t.workers;t.workerJobs=[],t.workerJobsId=[],t.urlToRevoke=e;for(var a=0;a<t.nbWorkers;++a){t.workers[a]=new Worker(e),t.workerJobs[a]=[],t.workerJobsId[a]=[];!function(e){t.workers[e].onerror=function(a){if(r[e]){var o=t.workerJobsId[e].shift();for(t.workerJobs[e].shift(),t.modelsToLoad.get(o).errorCallback(a),console.log("error worker: numWorker : "+e+" id : "+o);t.currentDownload<t.maxParrallelDownload&&t.currentWorkerTask<t.maxWorkerTask;){var i=t.modelsToLoad.get(t.actualLoadIndex);if(!i||!1!==i.launched)break;t.internalLoad()}}},t.workers[e].onmessage=k.postponeAfterManipulation((function(a){if(r[e]){var o=a.data;if(o.error&&o.loadIndex)return t.currentWorkerTask--,void((n=t.modelsToLoad.get(o.loadIndex)).errorCallback&&n.errorCallback(o));if(o.loaded){if(t.workersLoaded.push(e),!t.workerActivate)for(t.workerActivate=!0;t.currentDownload<t.maxParrallelDownload&&t.currentWorkerTask<t.maxWorkerTask;){var i=t.modelsToLoad.get(t.actualLoadIndex);if(!i||!1!==i.launched)break;t.internalLoad()}}else{t.currentWorkerTask--,t.workerJobs[e].shift(),t.workerJobsId[e].shift();var n,l={accelStruct:(n=t.modelsToLoad.get(a.data.loadIndex)).accelStruct,processText:n.processText,cullingData:o.cullingData,keepCompression:n.keepCompression,forceNoShowCGR:n.forceNoShowCGR,edgeTransparency:n.edgeTransparency,sharedBuffers:n.sharedBuffers,noMeshInRAM:n.noMeshInRAM,fromCGR:!0,sceneGraphOrderMode:n.sceneGraphOrderMode,primitiveWithBS:n.primitiveWithBS,repWithBS:n.repWithBS,unlinkToSG:n.unlinkToSG,withSAG:n.withSAG,withBagUUID:n.withBagUUID,sagInfo:n.sagInfo,withSG:n.withSceneGraph,fromOOC:n.fromOOC,udlMode:n.udlMode,depthMode2D:n.depthMode2D,withBlanking:n.withBlanking};h.processData([n.destinationNode],o,void 0,n.withSceneGraph,l,(function(e,r){if(n.readyCallback){var i={nodes:e};n.OOCSmartStaticInfo&&r&&(i.cullingData=r),n.readyCallback(i)}if(o.applicativesContainers&&s(o.applicativesContainers,n.applicativeContainers,n.destinationNode),t.modelsToLoad.delete(a.data.loadIndex),t.modelsToLoadCount--,[],0==t.modelsToLoadCount?(null!==t.renderCallbackFunc&&t.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,reframe:!0}),n.doneCallback&&n.doneCallback({isLast:!0})):null!==t.renderCallbackFunc&&t.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,budgeted:!0}),[],t.keepLoader||0!=t.modelsToLoadCount)for(;t.currentDownload<t.maxParrallelDownload&&t.currentWorkerTask<t.maxWorkerTask;){var l=t.modelsToLoad.get(t.actualLoadIndex);if(!l||!1!==l.launched)break;t.internalLoad()}else t.abort();n=null}))}}}))}(a)}}))}},this.loadUVR=function(e,r,a,o,t){this.load(e,r,a,o,t)},C.prototype.abort=function(){if(this.workers){for(var e=0;e<this.workers.length;++e)this.workers[e].terminate(),this.workers[e]=null;window.URL.revokeObjectURL(this.urlToRevoke)}this.workers=null,this.urlToRevoke="",this.isWorkerLoading=!1,this.modelsToLoad=new Map,this.modelsToLoadCount=0,this.loadIndex=0,this.actualLoadIndex=0,this.workersLoaded=[],this.workerActivate=!1,this.cleanLoader()}};return C}));