define("DS/VisuLoaders/ThreeDXLoader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/MaterialApplication","DS/Visualization/LightNode3D","DS/SceneGraphNodes/DirectionalLightNode","DS/SceneGraphNodes/SpotLightNode","DS/SceneGraphNodes/PointLightNode","DS/SceneGraphNodes/IESLightNode","DS/Visualization/Viewpoint","DS/Visualization/Ambience","DS/ZipJS2/ZipJS2","DS/Visualization/KDTree"],(function(e,t,i,a,r,o,s,n,l,p,u,c,h,d,f,m,g){"use strict";class v{constructor(e,t,i,a,r){this.imageData=e,this.bufferData=t,this.loadCB=i,this.type=a,this.basisUsage=r}}var b=e.NoOccurrences,y=window.newMaterialInheritance,x=!1,T=!1;window.displayDebugThreeDXLoader=function(e,t){x=e,T=t};var w=function(e){x&&console.log("3DX Loader >> "+e)},M=function(e,t){T&&console.log("3DX Loader texture not supported >> component: "+e+" format: "+t)},S={indexMap:null,indices:null,positions:null,normals:null},C={1:"vertexPositionArray",2:"vertexNormalArray",4:"vertexUvArray",8:"vertexUv2Array",16:"vertexColorArray",32:"vertexTangentArray",64:"vertexBinormalArray"},A={1:3,2:3,4:2,8:2,16:4,32:3,64:3},O={1:0,2:3,4:6,8:8,16:10,32:14,64:17},B={NEAREST:e.NearestFilter,NEAREST_MIPMAP_NEAREST:e.NearestMipMapNearestFilter,NEAREST_MIPMAP_LINEAR:e.NearestMipMapLinearFilter,LINEAR:e.LinearFilter,LINEAR_MIPMAP_NEAREST:e.LinearMipMapNearestFilter,LINEAR_MIPMAP_LINEAR:e.LinearMipMapLinearFilter},D={REPEAT:e.RepeatWrapping,CLAMP_TO_EDGE:e.ClampToEdgeWrapping,CLAMP_TO_BORDER:e._ClampToBorderWrapping,MIRRORED_REPEAT:e.MirroredRepeatWrapping},G={POINTS:0,LINES:1,TRIANGLES:4},L={Physical:"PhysicalMaterial",Phong:"MeshPhongMaterial",PointBasic:"ParticleBasicMaterial",LineBasic:"LineBasicMaterial",MeshBasic:"MeshBasicMaterial",Visu_Basic:"_CATGraphicalMaterial",DSPBR:"DSPBR19xMaterial",EVisuPBR:"DSPBR19xMaterial",DSPBR2021x:"DSPBR21xMaterial","DSPBR 2021x":"DSPBR21xMaterial","DSPBR 2022x":"DSPBR22xMaterial","DSPBR 2025x":"DSPBR25xMaterial",PDSFX:"DSPBR19xMaterial"},R={NO_INHERIT:0,INHERIT:1,FORCE_INHERIT:2};const P=e.TextureBlendOperations,I=e.MappingType;var N=new e.Matrix3;const U=new e.PhysicalMaterial;var _=function(t){var i=null;return 16==t.length?i=new e.Matrix3(t[0],t[4],t[12],t[1],t[5],t[13],t[3],t[7],t[15]):9==t.length&&(i=new e.Matrix3(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])),i.isIdentity()?N:i},F={diffuse:"diffuse",emissive:"emissionColor",specular:"specular",opacity:"opacity",glossiness:"roughness",anisotropy:"anisotropy",anisotropyAngle:"anisotropyAngle",metalness:"metalness",fresnelTransparency:"transparency",coatingSpecular:"clearCoatColor",coatingNormalMap:"clearCoatNormal",normalMap:"normal",normalScale:"normalScale",bumpMap:"bump",bumpScale:"bumpScale",displacement:"displacement"},k={normal:"normal",opacity:"opacity",anisotropy:"anisotropy",anisotropyRotation:"anisotropyAngle",displacement:"displacement",thickness:"thickness",albedo:"diffuse",metallic:"metalness",roughness:"roughness",transparency:"transparency",cutoutOpacity:"opacity",translucency:"translucency",translucencyColor:"translucencyColor",sheen:"sheen",sheenColor:"sheenColor",sheenRoughness:"sheenRoughness",specularTint:"specular",specular:"specularContrib",clearcoat:"clearCoat",clearcoatRoughness:"clearCoatRoughness",clearcoatNormal:"clearCoatNormal",emissionColor:"emissionColor",flakeColor:"flakesColor",flakeSize:"flakesSize",flakeCoverage:"flakesCoverage",flakeRoughness:"flakesRoughness",flipFlopColor:"flipFlopColor",flipFlop:"flipFlop",thinFilm:"iridescence",thinFilmThickness:"iridescenceThickness"},E=function(e){this.options={},this.isGAS=!0,this.id="",this.data=e,this.model=null,this.switchLODTextureCB=null};E.prototype.read=function(e,t,i){this.options={visible:e.visible,force:!0,side:e.side,transparent:e.transparent,depthTest:e.depthTest,depthWrite:e.depthWrite},this.model=t,this.switchLODTextureCB=i,this.id="VIS"+this.options.visible+"S"+this.options.side+"T"+this.options.transparent,this.id+="DT"+this.options.depthTest+"DW"+this.options.depthWrite,e.needTangentBinormal&&(this.options.needTangentBinormal=e.needTangentBinormal),e.alphatTest&&(e.alphaTest=e.alphatTest),e.alphaTest&&(!0===e.alphaTest?this.options.alphaTest=.5:this.options.alphaTest=e.alphaTest),e.vertexColors&&(this.options.vertexColors=e.vertexColors),void 0!==e.iterative&&(this.options.iterative=e.iterative),void 0!==e.sslr&&(this.options.sslr=e.sslr),void 0!==e.useGASColor&&(this.options.useGASColor=!!e.useGASColor)};var V=function(e){this.options={force:!0},this.isGAS=!1,this.data=e,this.id=""};V.prototype.read=function(e,t,i){if(this.model=t,this.switchLODTextureCB=i,void 0!==e.useGASColor&&(this.options.useGASColor=!!e.useGASColor),void 0!==e.shaderName&&(this.options.shaderName=e.shaderName),void 0!==e.baseMaterial&&(this.options.baseMaterial=e.baseMaterial,this.options.useBaseMaterial=!0),void 0!==e.activeTechnique&&(this.options.activeTechnique=e.activeTechnique),void 0!==e.shaderParameters){var a=e.shaderParameters;this.options.shaderParameters={};for(var r=0;r<a.length;r++)if(a[r]&&a[r].parameterName&&"undefined"!==a[r].parameterValue)if(!a[r].parameterType||"ParamTypeTexture"!==a[r].parameterType&&"PDSFXShaderParameterTexture"!==a[r].parameterType||-1==a[r].parameterValue)this.options.shaderParameters[a[r].parameterName]=a[r].parameterValue;else{var o=this.data.textures[a[r].parameterValue].texture;this.options.shaderParameters[a[r].parameterName]={map:o}}}};var j=function(e){E.call(this,e)};(j.prototype=Object.create(E.prototype)).buildGenericColor=function(t,i,a,r){if(void 0!==t[i]){var o=t[i];this.options[a]=(new e.Color).setRGB(o[0],o[1],o[2]),null!==r&&(this.id+=r+this.options[a].getStyle())}},j.prototype.buildGenericFloat=function(e,t,i,a){if(void 0!==e[t]){var r=e[t];"shininess"===t&&r<1&&0===(r*=255)&&(r=30),this.options[i]=r,null!==a&&(this.id+=a+this.options[i])}},j.prototype.buildGenericMap=function(e,t,i,a){if(void 0!==e[t]){this.isGAS=!1;var r=this.data.textures[e[t]].texture;this.options[i]=r,r.withSubstituteTexture(1,1,1),this.options.transparent=this.options.transparent||"opacityMap"===i,a&&(this.options[i+"Linear"]=!this.options[i].sRGB)}},j.prototype.read=function(t,i,a){if(E.prototype.read.apply(this,arguments),this.buildGenericFloat(t,"opacity","opacity","O"),this.buildGenericColor(t,"color","color","C"),this.buildGenericColor(t,"ambient","ambient","A"),this.buildGenericColor(t,"emissive","emissive","E"),this.buildGenericColor(t,"specular","specular","SP"),this.buildGenericFloat(t,"shininess","shininess","SH"),this.buildGenericMap(t,"specularMap","specularMap",!0),this.buildGenericMap(t,"opacityMap","opacityMap",!1),void 0!==t.diffuseMap){this.isGAS=!1;var r=this.data.textures[t.diffuseMap];if(this.options.map=r.texture,this.options.map.withSubstituteTexture(1,1,1),void 0!==t.diffuseMapBlendFunc?this.options.textureBlending=P[t.diffuseMapBlendFunc]:this.options.color&&"material"===i.content&&this.options.color.setRGB(1,1,1),r.lods){const e=r.lods;this.options.map.setAsLOD(i.switchLODTextureCB?i.switchLODTextureCB:a);for(var o=0;o<e.length;o++)this.options.map.lods.push(new v(e[o].textureData,null,e[o].loadCB,e[o].format,e[o].basisUsage))}}if(void 0!==t.normalMap&&(this.options.normalMap=this.data.textures[t.normalMap].texture,this.options.needTangentBinormal=!0,void 0!==t.needTangentBinormal&&(this.options.needTangentBinormal=t.needTangentBinormal),this.isGAS=!1),void 0!==t.normalMapFlipY&&(this.options.normalMapFlipY=t.normalMapFlipY),void 0!==t.bumpMap&&(this.options.bumpMap=this.data.textures[t.bumpMap].texture,this.isGAS=!1),void 0!==t.normalMapScale&&(this.options.normalScale=t.normalMapScale),void 0!==t.bumpMapScale&&(this.options.bumpScale=t.bumpMapScale),void 0!==t.size&&(this.options.size=t.size),void 0!==t.sizeAttenuation&&(this.options.sizeAttenuation=t.sizeAttenuation),void 0!==t.lineWidth&&(this.options.lineWidth=t.lineWidth),void 0!==t.envMap&&(this.options.envMap=this.data.textures[t.envMap].texture,this.options.envMap.withSubstituteTexture(1,1,1),this.isGAS=!1),void 0!==t.refractionRatio&&(this.options.refractionRatio=t.refractionRatio,this.isGAS=!1),void 0!==t.refractionRatioMap&&(this.options.refractionRatioMap=this.data.textures[t.refractionRatioMap].texture,this.options.refractionRatioMap.withSubstituteTexture(),this.isGAS=!1),this.options.useGASColor=!1,void 0!==t.uv0Transform){this.options.mappingType||(this.options.mappingType=0);var s=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8])}};var z=function(e){j.call(this,e),this.isGAS=!1};(z.prototype=Object.create(j.prototype))._startread=function(e,t,i){E.prototype.read.call(this,e,t,i),this.options.useAlphaFromDiffuseMap=!1},z.prototype.read=function(t,i,a){this._startread(t,i,a);var r=null;this.buildGenericColor(t,"DiffuseColor","color",r),this.buildGenericColor(t,"SpecularColor","specular",r),void 0!==t.DiffuseCoeff&&this.options.color.multiplyScalar(t.DiffuseCoeff),void 0!==t.SpecularCoeff&&this.options.specular.multiplyScalar(t.SpecularCoeff),this.buildGenericFloat(t,"TransparencyCoeff","opacity",r),void 0!==this.options.opacity&&(this.options.opacity=1-this.options.opacity,this.options.transparent=this.options.transparent||this.options.opacity<.999),this.buildGenericFloat(t,"ReflectionCoeff","reflectivity",r);var o=e.MaterialUtils.convertShininessToIoRRoughness(t.ShininessCoeff?t.ShininessCoeff:0);if(Object.assign(this.options,o),this.buildGenericMap(t,"Texture","map",r),this.options.textureBlending=P.REPLACE,this.options.map){var s=this.data.textures[t.Texture];if(s.mapping){var n=s.mapping;if(n.uvTransform&&(this.options.diffuseUvTransform=_(n.uvTransform)),n.operator){var l=n.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[l.type],this.options.mappingObjTransformation=new e.Matrix4,l.transform&&(this.options.mappingObjTransformation.elements=l.transform)}n.slot&&(this.options.diffuseUvSlot="TEX_COORD_1"===n.slot?2:1)}else s.uvTransform&&(this.options.diffuseUvTransform=_(s.uvTransform));if(void 0!==t.TextureMapping&&(this.options.textureMapping=t.TextureMapping,void 0!==typeof t.ProjectionPlaneS&&(this.options.projectionPlaneS=t.ProjectionPlaneS),void 0!==typeof t.ProjectionPlaneT&&(this.options.projectionPlaneT=t.ProjectionPlaneT)),void 0!==t.TextureFunction&&(this.options.textureBlending=P[t.TextureFunction]),void 0!==t.UseAlphaChannel){var p=!!t.UseAlphaChannel,u=this.options.textureBlending;u===P.REPLACE&&u===P.MODULATE&&u===P.BLEND||(p=!1),this.options.transparent=this.options.transparent||p}}};var W=function(e){E.call(this,e),this.isGAS=!1};(W.prototype=Object.create(E.prototype)).buildGenericPhysicalColorOptions=function(t,i,a,r,o){if(void 0!==t[i]&&null!==t[i]){var s=t[i];if(s.length)return void(this.options[a]=(new e.Color).setRGB(s[0],s[1],s[2]));if(void 0!==s.value){var n=s.value;this.options[a]=(new e.Color).setRGB(n[0],n[1],n[2])}else null!==o&&(this.options[a]=o);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[a]=(new e.Color).setRGB(1,1,1));var p=this.data.textures[l];if(null!==o&&p.texture.withSubstituteTexture(o.r,o.g,o.b),this.options[a+"Map"]=p.texture,p.lods){const e=p.lods,t=this.model.switchLODTextureCB?this.model.switchLODTextureCB:this.switchLODTextureCB;this.options[a+"Map"].setAsLOD(t);for(var u=0;u<e.length;u++)this.options[a+"Map"].lods.push(new v(e[u].textureData,null,e[u].loadCB,e[u].format,e[u].basisUsage))}if(!p.isSupported&&M(i,p.format),r)if(p.mapping){var c=p.mapping;if(c.uvTransform&&(this.options[a+"UvTransform"]=_(c.uvTransform)),c.operator){var h=c.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[h.type],this.options.mappingObjTransformation=new e.Matrix4,h.transform&&(this.options.mappingObjTransformation.elements=h.transform)}c.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===c.slot?2:1)}else p.uvTransform&&(this.options[a+"UvTransform"]=_(p.uvTransform))}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[a+"MulCoef"]=new e.Vector3(d[0],d[1],d[2]),this.options[a+"AddCoef"]=new e.Vector3(d[3],d[4],d[5])}}else null!==o&&(this.options[a]=o)},W.prototype.buildGenericPhysicalFloatOptions=function(t,i,a,r,o){if(void 0!==t[i]){var s=t[i];if("object"!=typeof s)return void(this.options[a]=s);if(void 0!==s.value){var n=s.value;this.options[a]=n}else null!==o&&(this.options[a]=o);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[a]=1),this.options.transparent=this.options.transparent||"opacity"===a||"transparency"===a;var p=this.data.textures[l];if(null!==o&&p.texture.withSubstituteTexture(o),this.options[a+"Map"]=p.texture,p.lods){const e=p.lods,t=this.model.switchLODTextureCB?this.model.switchLODTextureCB:this.switchLODTextureCB;this.options[a+"Map"].setAsLOD(t);for(var u=0;u<e.length;u++)this.options[a+"Map"].lods.push(new v(e[u].textureData,null,e[u].loadCB,e[u].format,e[u].basisUsage))}if(!p.isSupported&&M(i,p.format),r)if(p.mapping){var c=p.mapping;if(c.uvTransform&&(this.options[a+"UvTransform"]=_(c.uvTransform)),c.operator){var h=c.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[h.type],this.options.mappingObjTransformation=new e.Matrix4,h.transform&&(this.options.mappingObjTransformation.elements=h.transform)}c.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===c.slot?2:1)}else p.uvTransform&&(this.options[a+"UvTransform"]=_(p.uvTransform))}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[a+"MulCoef"]=d[0],this.options[a+"AddCoef"]=d[1]}}else null!==o&&(this.options[a]=o)},W.prototype.buildGenericPhysicalFloat2Options=function(t,i,a,r,o){if(void 0!==t[i]){var s=t[i];if(void 0!==s.value){var n=s.value;this.options[a]="number"==typeof n?new e.Vector2(n,n):new e.Vector2(n[0],n[1])}else null!==o&&(this.options[a]=o);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[a]=new e.Vector2(1,1));var p=this.data.textures[l];if(null!==o&&p.texture.withSubstituteTexture(o.x,o.y),this.options[a+"Map"]=p.texture,p.lods){const e=p.lods,t=this.model.switchLODTextureCB?this.model.switchLODTextureCB:this.switchLODTextureCB;this.options[a+"Map"].setAsLOD(t);for(var u=0;u<e.length;u++)this.options[a+"Map"].lods.push(new v(e[u].textureData,null,e[u].loadCB,e[u].format,e[u].basisUsage))}if(!p.isSupported&&M(i,p.format),r)if(p.mapping){var c=p.mapping;if(c.uvTransform&&(this.options[a+"UvTransform"]=_(c.uvTransform)),c.operator){var h=c.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[h.type],this.options.mappingObjTransformation=new e.Matrix4,h.transform&&(this.options.mappingObjTransformation.elements=h.transform)}c.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===c.slot?2:1)}else p.uvTransform&&(this.options[a+"UvTransform"]=_(p.uvTransform))}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[a+"MulCoef"]=d[0],this.options[a+"AddCoef"]=d[1]}}else null!==o&&(this.options[a]=o)},W.prototype.buildGenericPhysicalMapOptions=function(t,i,a,r,o){var s=i+"Map";if(void 0!==t[s]){var n=t[s],l=this.data.textures[n];if(null!==o&&l.texture.withSubstituteTexture(o.x,o.y,o.z),this.options[a+"Map"]=l.texture,l.lods){const e=l.lods,t=this.model.switchLODTextureCB?this.model.switchLODTextureCB:this.switchLODTextureCB;this.options[a+"Map"].setAsLOD(t);for(var p=0;p<e.length;p++)this.options[a+"Map"].lods.push(new v(e[p].textureData,null,e[p].loadCB,e[p].format,e[p].basisUsage))}if(!l.isSupported&&M(i,l.format),r)if(l.mapping){var u=l.mapping;if(u.uvTransform&&(this.options[a+"UvTransform"]=_(u.uvTransform)),u.operator){var c=u.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[c.type],this.options.mappingObjTransformation=new e.Matrix4,c.transform&&(this.options.mappingObjTransformation.elements=c.transform)}u.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===u.slot?2:1)}else l.uvTransform&&(this.options[a+"UvTransform"]=_(l.uvTransform))}void 0!==t[i+"MapFlipY"]&&(this.options[i+"MapFlipY"]=t[i+"MapFlipY"])},W.prototype._startread=function(t,i,a){E.prototype.read.call(this,t,i,a),this.options.useAlphaFromDiffuseMap=!1,this.buildGenericPhysicalMapOptions(t,"normal","normal",!0,new e.Vector3(.5,.5,1))},W.prototype._endread=function(t,i,a){if(void 0!==t.uv0Transform){var r=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(r[0],r[3],r[6],r[1],r[4],r[7],r[2],r[5],r[8])}},W.prototype.read=function(t,i,a){this._startread(t,i,a),this.buildGenericPhysicalColorOptions(t,"diffuse","diffuse",!0,(new e.Color).setRGB(0,0,0)),void 0!==t.useAlphaDiffuseChannel&&(this.options.useAlphaFromDiffuseMap=t.useAlphaDiffuseChannel,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap&&!!this.options.diffuseMap),this.buildGenericPhysicalColorOptions(t,"emissive","emissionColor",!0,(new e.Color).setRGB(0,0,0)),this.options.emissionValue=1,this.buildGenericPhysicalColorOptions(t,"specular","specular",!0,(new e.Color).setRGB(.04,.04,.04)),this.buildGenericPhysicalColorOptions(t,"coatingSpecular","clearCoatColor",!0,(new e.Color).setRGB(.04,.04,.04)),this.buildGenericPhysicalColorOptions(t,"flakesColor","flakesColor",!1,(new e.Color).setRGB(0,0,0)),this.options.flakesColorMulCoef=new e.Vector3(.12,.12,.12),this.options.flakesColorAddCoef=new e.Vector3(0,0,0),this.buildGenericPhysicalColorOptions(t,"pearlFlakesColor","pearlFlakesColor",!1,(new e.Color).setRGB(0,0,0)),this.options.pearlFlakesColorMulCoef=new e.Vector3(.08,.08,.08),this.options.pearlFlakesColorAddCoef=new e.Vector3(0,0,0),this.buildGenericPhysicalFloatOptions(t,"opacity","opacity",!0,1),this.buildGenericPhysicalFloatOptions(t,"glossiness","glossiness",!0,1),this.buildGenericPhysicalFloatOptions(t,"anisotropy","anisotropy",!0,0),this.buildGenericPhysicalFloatOptions(t,"anisotropyAngle","anisotropyAngle",!0,0),this.buildGenericPhysicalMapOptions(t,"bump","bump",!0,new e.Vector3(0,0,1)),this.buildGenericPhysicalFloatOptions(t,"bumpScale","bumpScale",!0,1),this.buildGenericPhysicalFloatOptions(t,"metalness","metalness",!0,0),this.options.specGlossNRE=this.options.metalness<1e-6,this.buildGenericPhysicalFloatOptions(t,"fresnelTransparency","transparency",!0,0),this.buildGenericPhysicalFloatOptions(t,"coating","clearCoat",!1,!1),this.buildGenericPhysicalMapOptions(t,"coatingNormal","clearCoatNormal",!0,new e.Vector3(.5,.5,1)),this.buildGenericPhysicalFloatOptions(t,"coatingGlossiness","coatingGlossiness",!1,1),this.buildGenericPhysicalFloatOptions(t,"proceduralCoating","orangePeel",!1,!1),this.buildGenericPhysicalFloatOptions(t,"coatingNormalBump","clearCoatNormalScale",!1,0),this.buildGenericPhysicalFloatOptions(t,"coatingNormalScale","orangePeelScale",!1,0),this.buildGenericPhysicalFloatOptions(t,"flakes","flakes",!1,!1),this.buildGenericPhysicalFloatOptions(t,"flakesScale","flakesScale",!1,.5),this.buildGenericPhysicalFloatOptions(t,"flakesBump","flakesBump",!1,1),this.buildGenericPhysicalFloatOptions(t,"flakesRoughness","flakesRoughness",!1,.25),this.buildGenericPhysicalFloatOptions(t,"flakesDensity","flakesDensity",!1,1),this.buildGenericPhysicalFloatOptions(t,"pearlFlakesBump","pearlFlakesBump",!1,1),this.buildGenericPhysicalFloatOptions(t,"pearlFlakesDensity","pearlFlakesDensity",!1,1),this.buildGenericPhysicalFloat2Options(t,"normalScale","normalScale",!0,new e.Vector2(1,1)),this.buildGenericPhysicalFloatOptions(t,"displacement","displacement",!0,0);var r=t.displacement;if(r&&void 0!==r.MADCoefficients){var o=r.MADCoefficients;this.options.displacementScale=o[0],this.options.displacementBias=o[1]}this._endread(t,i,a)};var X=function(e,t){W.call(this,e),this.is19x=t.is19x,this.is21x=t.is21x,this.is22x=t.is22x,this.is25x=t.is25x};(X.prototype=Object.create(W.prototype)).buildGenericPhysicalMapOptions=function(t,i,a,r,o){if(void 0!==t[i]){var s=t[i];if(void 0!==s.texture){var n=s.texture,l=this.data.textures[n];if(this.options[a+"Map"]=l.texture,l.lods){const e=l.lods,t=this.model.switchLODTextureCB?this.model.switchLODTextureCB:this.switchLODTextureCB;this.options[a+"Map"].setAsLOD(t);for(var p=0;p<e.length;p++)this.options[a+"Map"].lods.push(new v(e[p].textureData,null,e[p].loadCB,e[p].format,e[p].basisUsage))}if(null!==o&&l.texture.withSubstituteTexture(o.x,o.y,o.z),!l.isSupported&&M(i,l.format),r)if(l.mapping){var u=l.mapping;if(u.uvTransform&&(this.options[a+"UvTransform"]=_(u.uvTransform)),u.operator){var c=u.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[c.type],this.options.mappingObjTransformation=new e.Matrix4,c.transform&&(this.options.mappingObjTransformation.elements=c.transform)}u.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===u.slot?2:1)}else l.uvTransform&&(this.options[a+"UvTransform"]=_(l.uvTransform))}if(void 0!==s.MADCoefficients){var h=s.MADCoefficients;this.options[a+"MulCoef"]=new e.Vector3(h[0],h[1],h[2]),this.options[a+"AddCoef"]=new e.Vector3(h[3],h[4],h[5])}void 0!==t[i+"MapFlipY"]&&(this.options[i+"MapFlipY"]=t[i+"MapFlipY"])}},X.prototype.read=function(t,i,a){this._startread(t,i,a),this.buildGenericPhysicalColorOptions(t,"albedo","diffuse",!0,(new e.Color).setRGB(1,1,1)),void 0!==t.cutoutFromAlbedoAlpha&&(this.options.useAlphaFromDiffuseMap=t.cutoutFromAlbedoAlpha,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap&&!!this.options.diffuseMap),this.buildGenericPhysicalFloatOptions(t,"metallic","metalness",!0,0),this.buildGenericPhysicalFloatOptions(t,"roughness","roughness",!0,0),this.buildGenericPhysicalFloatOptions(t,"anisotropy","anisotropy",!0,0),this.buildGenericPhysicalFloatOptions(t,"anisotropyRotation","anisotropyAngle",!0,0),this.buildGenericPhysicalFloatOptions(t,"transparency","transparency",!0,0),this.buildGenericPhysicalFloatOptions(t,"cutoutOpacity","opacity",!0,1),this.buildGenericPhysicalFloatOptions(t,"thickness","thickness",!0,0),(this.is19x||this.is21x)&&this.buildGenericPhysicalFloatOptions(t,"sheen","sheen",!0,0),this.is19x?void 0!==t.sheenMode&&(this.options.sheenMode=t.sheenMode):(this.buildGenericPhysicalFloatOptions(t,"translucency","translucency",!0,0),this.buildGenericPhysicalMapOptions(t,"displacement","displacement",!0,new e.Vector3(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"subsurfaceAnisotropy","subsurfaceAnisotropy",!1,0),this.is21x?(this.buildGenericPhysicalColorOptions(t,"sheenColor","sheenColor",!0,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"sheenRoughness","sheenRoughness",!0,.3)):(this.buildGenericPhysicalColorOptions(t,"sheenColor","sheenColor",!0,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"sheenRoughness","sheenRoughness",!0,.5),this.buildGenericPhysicalColorOptions(t,"flipFlopColor","flipFlopColor",!0,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"flipFlop","flipFlop",!0,0),void 0!==t.subtype&&(this.options._subtype=e.DSPBRSubTypes[t.subtype]),this.is22x||(void 0===t.translucencyColor?this.options.useTranslucencyColorFromAlbedo=!0:(this.options.useTranslucencyColorFromAlbedo=!1,this.buildGenericPhysicalColorOptions(t,"translucencyColor","translucencyColor",!0,(new e.Color).setRGB(0,0,0))),this.buildGenericPhysicalFloatOptions(t,"thinFilm","iridescence",!0,0),this.buildGenericPhysicalFloatOptions(t,"thinFilmThickness","iridescenceThickness",!0,.4),this.buildGenericPhysicalFloatOptions(t,"thinFilmIOR","iridescenceIoR",!1,1.3)))),this.buildGenericPhysicalFloatOptions(t,"specular","specularContribution",!0,1),this.buildGenericPhysicalColorOptions(t,"specularTint","specular",!0,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"clearcoat","clearCoat",!0,0),this.buildGenericPhysicalFloatOptions(t,"clearcoatRoughness","clearCoatRoughness",!0,0),this.buildGenericPhysicalMapOptions(t,"clearcoatNormal","clearCoatNormal",!0,new e.Vector3(.5,.5,1)),void 0!==t.orangePeel&&(this.options.orangePeel=t.orangePeel),this.buildGenericPhysicalFloatOptions(t,"orangePeelScale","orangePeelScale",!1,0),this.buildGenericPhysicalColorOptions(t,"emissionColor","emissionColor",!0,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"emissionValue","emissionValue",!1,0),this.options.emissionNormalized=!1,void 0!==t.emissionEnergyNormalization&&(this.options.emissionNormalized=t.emissionEnergyNormalization),this.options.thinWalled=!0,void 0!==t.thinWalled&&(this.options.thinWalled=t.thinWalled),this.buildGenericPhysicalFloatOptions(t,"ior","ior",!1,1.5),this.buildGenericPhysicalColorOptions(t,"attenuationColor","attenuationColor",!1,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalColorOptions(t,"subsurfaceColor","subsurfaceColor",!1,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"attenuationDistance","attenuationDistance",!1,1e6),this.buildGenericPhysicalColorOptions(t,"flakeColor","flakesColor",!0,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"flakeSize","flakesSize",!0,.5),this.buildGenericPhysicalFloatOptions(t,"flakeCoverage","flakesCoverage",!0,0),this.buildGenericPhysicalFloatOptions(t,"flakeRoughness","flakesRoughness",!0,0),this._endread(t,i,a)},X.prototype._endread=function(t,i,a){if(void 0!==t.uv0Transform){this.options.mappingType||(this.options.mappingType=0);var r=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(r[0],r[3],r[6],r[1],r[4],r[7],r[2],r[5],r[8])}};return function(t){var g=performance.now();this.mode=void 0,this.sharedBuffers=!1,this.noMeshInRAM=!1,this.baseUrl="",this.modelsToLoad={},this.loadIndex=0,this.nbModelsToLoad=0,this.extensionsRequired=new Set,this.extensionsUsed=new Set,this.globalOldFlipTexture=!1,this.SSBMinNbReps=1,this.SSBMinNbTriangles=1e3,this.capture=!1,this.warnCount=0;var v=this,x=e.MaterialUtils.createShinyFaceMaterial({side:e.DoubleSide,color:new e.Color(16777215)}),T=new e.MeshBasicMaterial({color:new e.Color(16777215)});this._zipReaders=[],this._extractInfos=!1,this.getURI=function(e,t){var i="";if("http://"===e.substring(0,7))i=e;else if("https://"===e.substring(0,8))i=e;else if("/"===e.substring(0,1))i=e;else{var a=t;if("blob:"===t.substring(0,5)||"/"===t){var r=(a=location.href).indexOf("?");-1!==r&&(a=a.substring(0,r));var o=a.lastIndexOf("/");-1!==o&&(a=a.substring(0,o+1))}i=a+e}return i},this.getEntryFile=function(e,t,i){"blob"===t?e.getData(new m.BlobWriter).then(i):"arraybuffer"===t?e.getData(new m.Uint8ArrayWriter).then(i):e.getData(new m.TextWriter).then(i)},this.createAmbience=function(t,i,a){var r=["WhiteDesign","BlueDesign","DarkDesign","Studio","PureWhite","WhiteMirror","WhiteReview","DarkMirror","DarkReview","Outdoor","Indoor","City","Road","NeoPureWhite"],o=t.ambiance,s=null;if(!o)return!0;if(i.destinationNode)for(var n=i.destinationNode,l=0;l<n._occurrences.length;l++){var p=n._occurrences[l];p.parent;p.scene3js&&(s=p.scene3js.viewer)}if(o.name&&-1===r.indexOf(o.name)&&o.directionalLights)for(l=0;l<o.directionalLights.length;l++)t.lightInstances&&t.lightInstances.length||(t.lightInstances=[]),o.directionalLights[l].castShadows=o.directionalLights[l].castShadows&&!v,o.directionalLights[l].ambianceTransform=o.transform,t.lightInstances.push(o.directionalLights[l]);if(s&&(s.setAmbientLight(0),s.setIntensityCorrection(!0),s.useDefaultLights&&(s.setTriLights(!1),s._directionalLight.setIntensity(0),s._directionalLight2.setIntensity(0)),s.renderer.ToneMappingEffect&&s.renderer.ToneMappingEffect.setToneMapping(2),o.name&&-1!==r.indexOf(o.name))){var u=s.setVisuEnvOCA(o.name,a,{from3dx:!0});return o.backgroundGeometry&&o.backgroundGeometry.size&&s.ambience.getBackgroundGeometry().setSize(o.backgroundGeometry.size),u}let c,h=null,d=null,m=null;if(o.background&&"gradient"==o.background.type){var g=o.background.colors[0];o.background.colors[0]=o.background.colors[1],o.background.colors[1]=g}o.background&&void 0!==o.background.image&&((x=i.data.images[o.background.image]).data&&(d={data:window.URL.createObjectURL(x.data),format:x.format}));var v=!1,b=a;if(o.unitScale=i.rootMatrix?i.rootMatrix.getMaxScaleOnAxis():1,o.environmentLight&&void 0!==o.environmentLight.light){var y;o.environmentLight.matrix&&(y=o.environmentLight.matrix);var x,T=i.json.lights[o.environmentLight.light],w=T.image;if((x=i.data.images[w])&&x.data)m={data:window.URL.createObjectURL(x.data),format:x.format};o.environmentLight=T,y&&(o.environmentLight.matrix=y),v=!0;var M=this.extensionsRequired.has("EXT_IBL_Preconvolved")&&this.extensionsUsed.has("EXT_IBL_Preconvolved")&&t.extensions.EXT_IBL_Preconvolved;if(M){c=e._AmbianceGenerators._dummyRoughnessTextureRGBE;var S=M.GGX,C=M.Lambert;if(!S||!C)throw"Invalid EXT_IBL_Preconvolved extension usage: missing brdf";if(C.image=i.data.images[C.image],"hdr"!==C.image.format)throw"Invalid EXT_IBL_Preconvolved extension usage: not hdr";var A={textures:[],ggxMapping:S.roughnessMapping,ggx0:S.useOriginalAsZero};if(6!==S.mips.length)throw"Invalid EXT_IBL_Preconvolved extension usage: missing mips";for(l=0;l<S.mips.length;l++){if(S.mips[l].image=i.data.images[S.mips[l].image],"hdr"!==S.mips[l].image.format)throw"Invalid EXT_IBL_Preconvolved extension usage: not hdr";A.textures.push(S.mips[l].image)}A.textures.push(C.image),b=function(){for(var t=0,i=function(){7==++t&&e._AmbianceGenerators.onViewerAvailable((e=>{h._solveSceneRoughnessMap(A,e,a)}))},r=0;r<A.textures.length;r++){var o=window.URL.createObjectURL(A.textures[r].data),s=e.ImageUtils.loadHDRTexture(o,new e.LatLongEnvMapping,i,null,!1,!1);s.minFilter=e.NearestFilter,s.magFilter=e.NearestFilter,A.textures[r]=s}}}}o.ground&&"physical"==o.ground.type&&void 0!==o.ground.material&&void 0!==i.data.materials[l]&&(o.ground.material=i.data.materials[l]);var O=o.renderSettings;return s&&O&&(void 0===O.type||"rasterizer"===O.type)&&(O.ambientOcclusion&&O.ambientOcclusion.activation&&(s.setSSAOParameters({dynamicRadius:!1,adaptativeRadius:!0,radius:O.ambientOcclusion.radius?O.ambientOcclusion.radius:100,radiusMin:.005,radiusMax:.12,minPixelRadius:14,attenuation:.984,contrast:O.ambientOcclusion.intensity?O.ambientOcclusion.intensity:1,power:1,thresholdAngle:1.32645023152}),s.setSSAO(!0)),O.reflection&&O.reflection.activation&&s.setSSLR(!0)),h=new f({viewer:s,ambiance:o,images:{background:d,environmentLight:m},from3DX:!0,doneCallback:b,roughnessMap:c}),s&&s.setAmbience(h),!h.isTextureLoading()},this.createImages=function(e,t,i,a){var r=this;if(!e||t>=e.length)a&&a(i);else{var o=e[t],s=o.format?o.format.toLowerCase():"",n=o.usage?o.usage:"NOT_BASIS";if("png"===s||"jpeg"===s||"jpg"===s||"dds"===s||"hdr"===s||"basis"===s||"ktx2"===s||""===s&&o.uid){var l="image/"+s;"dds"!==s&&"hdr"!==s&&"basis"!==s&&"ktx2"!==s||(l="arraybuffer");var p=i.json.binaries?i.json.binaries[o.binary]:null,u=i.data.chunks[o.binary];if(u){var c=u.buffer?u.buffer:u,h=u.byteOffset?u.byteOffset:0;let r=new Uint8Array(c,h+o.byteOffset,o.byteLength);var d=null;"basis"!==s&&(d=new Blob([r],{type:l}),r=null),i.data.images.push({uri:p.extUri?p.extUri:p.uri,uid:o.uid,data:d,format:s,usage:n,arrayBuffer:r}),this.createImages(e,t+1,i,a.bind(this))}else if(p){var f={uri:p.extUri?p.extUri:p.uri,width:o.width,height:o.height,format:s,usage:n};i.data.images.push(f),i.binaryCallback?i.binaryCallback(f.uri,(function(o,s){s&&(l="image/"+s,"dds"!==s&&"hdr"!==s&&"basis"!==s&&"ktx2"!==s||(l="arraybuffer"),f.format=s);var n=new Blob([o],{type:l});f.data=n,r.createImages(e,t+1,i,a.bind(this))})):this.createImages(e,t+1,i,a.bind(this))}else{f={uri:null,format:s,usage:n};if(o.uid&&i.resourcesLibrary)f.uid=o.uid;else{this.warnCount<5&&(console.warn("bad 3dx file"),this.warnCount++);var m=new Uint8Array,g=new Blob([m],{type:"image/png"});f.data=g}i.data.images.push(f),this.createImages(e,t+1,i,a.bind(this))}}}},this.createBuffers=function(e,t){if(e)for(var i=0;i<e.length;i++){var a=e[i],r=t.data.chunks[a.binary],o=r.buffer?r.buffer:r,s=r.buffer?r.byteOffset+a.byteOffset:a.byteOffset;if(a.format){if("UNSIGNED_SHORT"===a.format)u=new Uint16Array(o,s,a.byteLength/2);else if("UNSIGNED_INT"===a.format)u=new Uint32Array(o,s,a.byteLength/4);else if("UNSIGNED_BYTE"===a.format){var n=new Uint8Array(o,s,a.byteLength);u=new Uint16Array(a.byteLength);for(var l=0;l<a.byteLength;l++)u[l]=n[l]}t.data.buffers.push(u)}else if(a.attributes){var p=C[a.attributes];if(p){var u=new Float32Array(o,s,a.byteLength/4);t.data.buffers.push({attribute:p,buffer:u})}else{n=new Float32Array(o,s,a.byteLength/4);var c=[];t.data.buffers.push(c);var h=0;for(var l in C)a.attributes&l&&(h+=A[l]);var d=n.length/h;for(var l in C)if(a.attributes&l){for(var f=A[l],m=(u=new Float32Array(d*f),{attribute:C[l],buffer:u}),g=O[l],v=0;v<d;v++){for(var b=0;b<f;b++)u[v++]=n[g+b];g+=h}c.push(m)}}}else if(a.geometricType){u=new Uint32Array(o,s,a.byteLength/4);t.data.buffers.push({geometricType:a.geometricType,buffer:u})}else{u=new Uint8Array(o,s,a.byteLength);t.data.buffers.push({buffer:u})}}},this.getBuffers=function(e,t,i,a,r){if(e){var o=e[i],s=t.data.chunks[o.binary],n=s.buffer?s.buffer:s,l=s.buffer?s.byteOffset+o.byteOffset:o.byteOffset;if(o.format){if("UNSIGNED_SHORT"===o.format)c=new Uint16Array(n,l,o.byteLength/2);else if("UNSIGNED_INT"===o.format)c=new Uint32Array(n,l,o.byteLength/4);else if("UNSIGNED_BYTE"===o.format){var p=new Uint8Array(n,l,o.byteLength);c=new Uint16Array(o.byteLength);for(var u=0;u<o.byteLength;u++)c[u]=p[u]}return c}if(a){if(1==a.length){if("UNSIGNED_SHORT"===(m=a[0]).format)c=new Uint16Array(n,l,o.byteLength/2);else if("UNSIGNED_INT"===m.format)c=new Uint32Array(n,l,o.byteLength/4);else if("UNSIGNED_BYTE"===m.format){p=new Uint8Array(n,l,o.byteLength);c=new Uint16Array(o.byteLength);for(u=0;u<o.byteLength;u++)c[u]=p[u]}else c=new Float32Array(n,l,o.byteLength/4);return c}var c=new Float32Array(n,l,o.byteLength/4),h=[],d=0;for(var u in a)d+=a[u].dimension;var f=c.length/d;for(var u in a){var m=a[u];h[u]=new Float32Array(f*m.dimension)}var g=0;for(var u in a){i=0,m=a[u];for(var v=0;v<f;v++)for(var b=0;b<m.dimension;b++)h[u][i++]=c[v*d+g+b];g+=m.dimension}return h}return r?{geometricType:r,buffer:c=new Uint32Array(n,l,o.byteLength/4)}:c=new Uint8Array(n,l,o.byteLength)}},this.getGenericBuffer=function(e,t,i,a){if(e){var r,o=e[i],s=t.data.chunks[o.binary],n=s.buffer?s.buffer:s,l=s.buffer?s.byteOffset+o.byteOffset:o.byteOffset;switch(a){case"Float32":r=new Float32Array(n,l,o.byteLength/4);break;case"Uint32":r=new Uint32Array(n,l,o.byteLength/4);break;default:r=new Uint8Array(n,l,o.byteLength)}return r}},this.onImageLoaded=function(e){e.data.nbImagesToLoad--,!e.data.nbImagesToLoad&&e.onTexturesLoadedCB&&e.onTexturesLoadedCB()},this._createTemporaryMap=function(t){var i;switch(t){case"dds":case"basis":case"ktx2":i=new e.CompressedTexture;break;case"hdr":i=new e.DataTexture;break;default:i=new e.Texture}return i.loadEndStatus=e.AssetLoadingStatus.LOADING,i},this._loadGenericTexture=function(t,i,a,r,o,s,n,l){var p=n;return"dds"===t?p=e.ImageUtils.loadCompressedTexture(a,null,o(s,r?a:null),o(s,r?a:null),!0,!1,n):"hdr"===t?p=e.ImageUtils.loadHDRTexture(a,null,o(s,r?a:null),o(s,r?a:null),!0,!1,!0,!1,!1,n):"basis"===t?p=e.ImageUtils.loadBasisTexture(l||a,null,o(s,r?a:null),o(s,r?a:null),!0,e.BasisUsage[i],!1,n):"ktx2"===t?p=e.ImageUtils.loadKTX2Texture(a,null,o(s,r?a:null),o(s,r?a:null),!0,e.BasisUsage[i],!1,n):(p=e.ImageUtils.loadTexture(a,null,o(s,r?a:null),o(s,r?a:null),void 0,!s||s&&s.forcePowerOfTwo,!1,n)).flipY=!0,p},this._loadImage=function(t,i,a,r){var o,s,n,l=t.data.images[a],p=l.format,u=!1,c=null;return i?(c=l.uri,s=l.width,n=l.height):((l.uri||l.uid)&&t.resourcesLibrary&&(c=t.resourcesLibrary.getImage(l.uid?l.uid:l.uri)),c||(l.data?(o=window.URL.createObjectURL(l.data),u=!0):l.arrayBuffer||(l.uri?o=l.uri:(this.warnCount<5&&(console.warn("3DSync: uid not in cache and no binary buffer attached"),this.warnCount++),t.resourcesLibrary&&l.uid&&(c=this._createTemporaryMap(p),t.resourcesLibrary.addImageToRequest(l.uid,c,p)))),c||(c=this._loadGenericTexture(p,l.usage,o,u,r,t,void 0,l.arrayBuffer)),c._source=e.AssetSource.MATERIAL_MANAGER,(l.uri||l.uid)&&t.resourcesLibrary&&t.resourcesLibrary.addImage(l.uid?l.uid:l.uri,c))),{uri:l.uri,uid:l.uid,isSupported:"png"===p||"jpeg"===p||"jpg"===p||"dds"===p||"hdr"===p||"basis"===p||"ktx2"===p,map:c,width:s,height:n,format:p,basisUsage:l.usage?e.BasisUsage[l.usage]:-1}},this.createTextures=function(t,i){if(t){for(var a=this,r={},o=0;o<t.length;o++){if(r[(x=t[o]).image]||(r[x.image]=[],!i.imagesCallback&&i.data.images[x.image]&&i.data.nbImagesToLoad++),r[x.image].push({texture:o,lod:-1}),x.lods)for(var s=0;s<x.lods.length;s++){var n=x.lods[s];r[n]||(r[n]=[]),r[n].push({texture:o,lod:s})}}for(var l in r){var p,u,c=!0,h="",d=null,f=null,m=null,g=-1;if(i.imagesCallback)d=i.imagesCallback(x,i);else{var v=r[l][0].lod>=0,b=this._loadImage(i,v,l,(function(e,t){return function(){a.onImageLoaded(e),t&&window.URL.revokeObjectURL(t)}}));c=b.isSupported,h=b.format,d=b.map,f=b.uri,m=b.uid,p=b.width,u=b.height,g=b.basisUsage}var y=r[l];for(s=0;s<y.length;s++){var x=t[y[s].texture],T=d;if(-1===y[s].lod){var w=D[x.uWrap]||1e3,M=D[x.vWrap]||1e3,S="CLAMP_TO_BORDER"===x.uWrap||"CLAMP_TO_BORDER"===x.vWrap,C=x.anisotropy||8,A=B[x.minFilter]||1008,O=B[x.magFilter]||1006,G=x.borderColor,L=null;S&&(L=G?new e.Vector4(G[0],G[1],G[2],G[3]):new e.Vector4(0,0,0,1)),1003!==O&&1006!==O&&(O=1006);var R=x.repeat||{x:1,y:1},P=(h=i.json.images[x.image].format,"jpg"===x.format||"jpeg"===x.format);P||"jpg"!==h&&"jpeg"!==h||(P=!0);var I=e.AssetSource.MATERIAL_MANAGER,N=null;(f||m)&&i.resourcesLibrary&&(N=i.resourcesLibrary.getTexture(m||f,{wrapS:w,wrapT:M,anisotropy:C,minFilter:A,magFilter:O,borderColor:L,repeat:R,sRGB:P,source:I})),N?T=N:((f||m)&&i.resourcesLibrary?void 0===(T=d.clone()).data&&(T.needsUpdate=!1):s>0&&(T=d.clone()),T.wrapS=w,T.wrapT=M,T.anisotropy=C,T.minFilter=A,T.magFilter=O,T.borderColor=L,T.repeat=R,T.sRGB=P,T._source=I,(f||m)&&i.resourcesLibrary&&i.resourcesLibrary.addTexture(m||f,T,{wrapS:w,wrapT:M,anisotropy:C,minFilter:A,magFilter:O,borderColor:L,repeat:R,sRGB:P,source:I}));var U={isSupported:c,format:h,texture:T,mapping:x.mapping,uvTransform:x.uvTransform};i.data.textures[y[s].texture]=U}else{(U=i.data.textures[y[s].texture]).lods||(U.lods=[]),U.lods.push({textureData:{texture:T,width:p,height:u,format:h,basisUsage:g},loadCB:this.loadLODTextureCB})}}}}},this.loadLODTextureCB=function(t){var a,r=i.parseUrl(this.imageData.texture);switch(r=""===r.protocol?v.baseUrl+r.source:r.source,this.imageData.format){case"basis":a=e.ImageUtils.loadBasisTexture(r,null,null,null,!0,this.imageData.basisUsage);break;case"ktx2":a=e.ImageUtils.loadKTX2Texture(r,null,null,null,!0,this.imageData.basisUsage);default:(a=e.ImageUtils.loadTexture(r,null,void 0,void 0,!0,!0)).flipY=!0}return a._source=e.AssetSource.MATERIAL_MANAGER,t&&(a.wrapS=t.wrapS,a.wrapT=t.wrapT,a.anisotropy=t.anisotropy,a.minFilter=t.minFilter,a.magFilter=t.magFilter,a.borderColor=t.borderColor?t.borderColor.clone():null,a.repeat=t.repeat,a.sRGB=t.sRGB),a},this.switchLODTextureCB=function(t){var i=t.matrix,a=t.bSphere,r=a.radius*i.getMaxScaleOnAxis(),o=new e.Vector3;a?o.copy(a.center):o.set(0,0,0),o.applyMatrix4(i);var s,n,l=t.camera.matrixWorldInverse.elements,p=Math.abs(l[2]*o.x+l[6]*o.y+l[10]*o.z+l[14])-r,u=e.glStates.currentHeight/Math.tan(.5*t.camera.fov*Math.PI/180)*r/Math.abs(p);if(u<Math.min(t.texture.image.width,t.texture.image.height))return-1;for(s=0;s<t.lods.length&&(n=t.lods[s],!(u<Math.min(n.imageData.width,n.imageData.height)));s++);return s===t.lods.length?s-1:s},this.createMappingDescriptions=function(t,i,a){if(t)for(var r=0;r<t.length;r++){var o=t[r],s={hasOperator:!1,mappingType:I.DISABLED};if(o.uvTransform&&(s.mappingType=I.NONE,s.uvTransform=_(o.uvTransform)),o.operator){var n=o.operator;s.hasOperator=!0,s.mappingType=I[n.type],s.mappingObjTransformation=new e.Matrix4,n.transform&&(s.mappingObjTransformation.elements=n.transform)}o.slot&&(s.slot="TEX_COORD_1"===o.slot?2:1),o.uvTransformSemantic&&(s.uvTransformSemantic=e.MappingTransformSemantic[o.uvTransformSemantic]),i.mappingDescriptions[r]=s}},this.createMaterialApplications=function(t,i,a,r){if(t)for(var o=new Set,s=0;s<t.length;s++){var l=t[s],p=!1;void 0!==l.decalProjector&&(p=!0);var u=a.materials[l.material];if(!u){if(!p)continue;u=U}let O=l.layer;void 0===O&&(O=e.MaterialLayer32BitsMax);let B=l.layerHighBits;void 0===B&&(B=4294967295),O=BigInt(O)+(BigInt(B)<<32n);var c={inheritance:R[l.inheritance],layer:O},h=null;switch(u.getType()){case"SpecGloss":h=F;break;case"DSPBR19x":case"DSPBR21x":case"DSPBR22x":case"DSPBR25x":h=k;break;case"CATGraphicalMaterial":h=null;break;default:e.VisualizationTraces.info(u.getType()+" unknown material application matching")}var d=null;if(h){var f=l.mapping,m=void 0!==f,g={},v=l.textureMappings;if(!m&&v&&4===r.version){d={};for(var b=0;b<v.length;b++){var y=a.mappingDescriptions[v[b].mapping];g.mappingType=y.mappingType,y.hasOperator&&(g.mappingObjTransformation=y.mappingObjTransformation);var x=v[b].parameter,T=h[x];T?(y.slot&&(g.mappingUVSlot=y.slot),y.uvTransform&&(d[T+"UvTransform"]=y.uvTransform)):e.VisualizationTraces.info(x+" unknown attribute for material application matching")}}if(m){y=a.mappingDescriptions[f];g.mappingType=y.mappingType,y.hasOperator&&(g.mappingObjTransformation=y.mappingObjTransformation),y.slot&&(g.mappingUVSlot=y.slot),y.uvTransform&&(g.mappingUVTransformation=y.uvTransform),y.uvTransformSemantic&&(g.mappingTransformSemantic=y.uvTransformSemantic)}c.mappingOperator=g}d&&u.isPhysicalMaterial?(o.has(u)?u=u.clone():o.add(u),u.setPhysicalProperties(d)):o.add(u),c.faceMaterial=u,c.geometricalFaceMaterial=u;var w=null,M=!1;if(p&&(M=!!(w=i[l.decalProjector]).mode&&"EXPLICIT"===w.mode,c.mappingOperator?(c.mappingOperator.mappingObjTransformation=null,c.mappingOperator.mappingType=I[w.operator.type]):c.mappingOperator={mappingType:I[w.operator.type]},w.implicitScale||(w.implicitScale=[1,1]),w.implicitScale)){var S=new e.Matrix3(w.implicitScale[0],0,0,0,w.implicitScale[1],0,0,0,1);c.mappingOperator.mappingUVTransformation?c.mappingOperator.mappingUVTransformation=(new e.Matrix3).multiplyMatrices(S,c.mappingOperator.mappingUVTransformation):c.mappingOperator.mappingUVTransformation=S}var C=new n(c);if(p){var A=new e.Matrix4;w.operator.transform&&(A.elements=w.operator.transform);c={materialApplication:C,matrix:A,explicitUv:M};a.materialApplications[s]={isDecal:!0,decal:e.DecalManager.createDecal(c),apply:l.isDecalApplied,attach:l.isDecalAttached,uid:w.uid}}else a.materialApplications[s]=C}},this.createMaterialsV2=function(t,i,a){if(t)for(var r=new s,o=0;o<t.length;o++){var n=t[o],l=null;if(a.materialsCallback)l=a.materialsCallback(n,a);else{if("External"===n.type){var p={uri:n.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};a.data.modelsToLoad.push(p),i.materials[o]=p;continue}var u={visible:n.visible,force:n.force,side:n.side,transparent:n.transparent,opacity:n.opacity,depthTest:n.depthTest,depthWrite:n.depthWrite},c=!0,h="VIS"+u.visible+"S"+u.side+"T"+u.transparent;h+="O"+u.opacity,h+="DT"+u.depthTest+"DW"+u.depthWrite,n.forceSide&&(u.forceSide=n.forceSide,l+="FS"+u.forceSide),n.needTangentBinormal&&(u.needTangentBinormal=n.needTangentBinormal),n.alphaTest&&(!0===n.alphaTest?u.alphaTest=.5:u.alphaTest=n.alphaTest),n.color&&(u.color=(new e.Color).setRGB(n.color[0],n.color[1],n.color[2]),h+="C"+u.color.getStyle()),n.ambient&&(u.ambient=(new e.Color).setRGB(n.ambient[0],n.ambient[1],n.ambient[2]),h+="A"+u.ambient.getStyle()),n.emissive&&(u.emissive=(new e.Color).setRGB(n.emissive[0],n.emissive[1],n.emissive[2]),h+="E"+u.emissive.getStyle()),n.specular&&(u.specular=(new e.Color).setRGB(n.specular[0],n.specular[1],n.specular[2]),h+="SP"+u.specular.getStyle()),n.shininess&&(u.shininess=n.shininess,h+="SH"+u.shininess),n.vertexColors&&(u.vertexColors=n.vertexColors),void 0!==n.diffuseMap&&(c=!1,u.map=i.textures[n.diffuseMap].texture),void 0!==n.opacityMap&&(c=!1,u.opacityMap=i.textures[n.opacityMap].texture,u.transparent=!0),void 0!==n.normalMap&&(c=!1,u.normalMap=i.textures[n.normalMap].texture,u.needTangentBinormal=!0,void 0!==n.needTangentBinormal&&(u.needTangentBinormal=n.needTangentBinormal)),void 0!==n.normalMapScale&&(u.normalScale=new e.Vector2(n.normalMapScale.x,n.normalMapScale.y)),void 0!==n.normalMapFlipY&&(u.normalMapFlipY=n.normalMapFlipY),void 0!==n.bumpMap&&(c=!1,u.bumpMap=i.textures[n.bumpMap].texture),void 0!==n.bumpMapScale&&(u.bumpScale=n.bumpMapScale),void 0!==n.glossiness&&(u.glossiness=n.glossiness,h+="G"+u.glossiness),void 0!==n.glossinessMap&&(c=!1,u.glossinessMap=i.textures[n.glossinessMap].texture),void 0!==n.specularMap&&(c=!1,u.specularMap=i.textures[n.specularMap].texture),"Physical"===n.type&&(c=!1,void 0!==n.emissiveMap&&(u.emissiveMap=i.textures[n.emissiveMap].texture),void 0!==n.metalnessMap&&(void 0===n.metalness&&(n.metalness=1),u.metalnessMap=i.textures[n.metalnessMap].texture),void 0!==n.metalness&&(u.metalness=n.metalness),void 0!==n.coating&&(u.coating=n.coating),void 0!==n.coatingGlossiness&&(u.coatingGlossiness=n.coatingGlossiness)),void 0!==n.iterative&&(u.iterative=n.iterative),void 0!==n.sslr&&(u.sslr=n.sslr);var d=L[n.type];h="id"+h.hashCode(),c&&a.gasSharing&&(l=r.get3DXSharedGas(h)),!l&&d&&((l=new e[d](u))._source=e.AssetSource.MATERIAL_MANAGER,c&&a.gasSharing&&r.set3DXSharedGas(h,l))}i.materials[o]=l}},this.createMaterials=function(t,i,a){if(t){for(var r=new s,o=this.extensionsRequired.has("EXT_Material_PBR")||this.extensionsUsed.has("EXT_Material_PBR"),n=[],l=0;l<t.length;l++){var p=t[l],u=null,c="DSPBR"===p.type||"EVisuPBR"===p.type,h="DSPBR 2021x"===p.type||"DSPBR2021x"===p.type,d="DSPBR 2022x"===p.type,f="DSPBR 2025x"===p.type,m=c||h||d||f,g=!1;if(!m&&p.extensions&&p.extensions.EXT_Material_PBR&&((p=p.extensions.EXT_Material_PBR).type="EVisuPBR",m=o,c=!0),a.materialsCallback)u=a.materialsCallback(p,a);else{if("External"===p.type){var v={uri:p.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};a.data.modelsToLoad.push(v),i.materials[l]=v;continue}var b=null,y=L[p.type];m?b=new X(i,{is19x:c,is21x:h,is22x:d,is25x:f}):"Visu_Basic"===p.type?b=new z(i):"Physical"===p.type?b=new W(i):"PDSFX"===p.type?(b=new V(i),g=!0):b=new j(i),b.read(p,a,this.switchLODTextureCB);var x="id"+b.id.hashCode();if(b.isGAS&&a.gasSharing&&(u=r.get3DXSharedGas(x)),g&&(b.options.id=l,n.push(b.options),b.options.useBaseMaterial)){i.materials[l]=null;continue}!u&&y&&((u=new e[y](b.options))._source=e.AssetSource.MATERIAL_MANAGER,b.isGAS&&a.gasSharing&&r.set3DXSharedGas(x,u))}i.materials[l]=u}if(n.length)for(l=0;l<n.length;l++){var T=n[l];if(T.useBaseMaterial){var w=i.materials[T.baseMaterial].clone();i.materials[T.id]=w,r.getPDSFX({material:w,parameters:T.shaderParameters,name:T.shaderName,technique:T.activeTechnique})}else r.getPDSFX({material:i.materials[T.id],parameters:T.shaderParameters,name:T.shaderName,technique:T.activeTechnique})}}},this.createGeometriesV2=function(t,i){if(t)for(var r=i.data,o=0;o<t.length;o++){var s=t[o],n=new e.BufferGeometryDS;r.geometries[o]=n,n.sharedBuffers=this.sharedBuffers,n.noMeshInRAM=this.noMeshInRAM,n.vertexIndexArray=r.buffers[s.indexBuffer];for(var l=0;l<s.vertexBuffers.length;l++){var p=r.buffers[s.vertexBuffers[l]];if(p.attribute)n[p.attribute]=p.buffer;else if(p.length)for(var u=0;u<p.length;u++)n[p[u].attribute]=p[u].buffer}for(l=0;l<s.drawingGroups.length;l++){var c,h=s.drawingGroups[l],d=void 0!==h.primitives,f=void 0!==h.canonicals,m=n.vertexNormalArray?x:T,g=[],v=new a.DrawingGroup(m,null,G[h.mode],h.start,h.count,g,void 0,e.GeomTypeEnum.UNKNOWN,0);if(v.geometry=n,n.drawingGroups.push(v),void 0!==h.graphicAttributes&&r.materials[h.graphicAttributes])(c=r.materials[h.graphicAttributes]).uri?c.destinationDGforGAS.push(v):v.gas=c;if(void 0!==h.material&&r.materials[h.material])(c=r.materials[h.material]).uri?c.destinationDGforMaterial.push(v):v.material=c;if(d){var b=r.buffers[h.primitives],y=b.buffer,w=0,M=f?r.buffers[h.canonicals].buffer:null;v._geomType=e.GeomTypeEnum[b.geometricType]||e.GeomTypeEnum.UNKNOWN;for(u=0;u<y.length;u+=4){var S=new a.SGPrimitive({cgmId:y[u],group:v,start:y[u+2],count:y[u+3]});if(i.unstreamReps){var C=y[u+1],A=r.reps[C];A||(A=new a.SGRep({cgmId:C}),r.reps[C]=A),S.rep=A,A._primitives.push(S)}if(f){var O=M[w++];if(O){S.decoration=new Array;for(var B=0;B<O;B++)S.decoration.push(M[w++])}}g.push(S)}}else{S=new a.SGPrimitive({cgmId:0,group:v,start:h.start,count:h.count});g.push(S)}}}},this.getInternalDimensionBuffer=function(e,t,i){var a=t;if("POSITION"==i||"NORMAL"==i?a=t:"TEX_COORD_0"==i||"TEX_COORD_1"==i?a=3:"COLOR"==i?a=4:("TANGENT"==i||"BINORMAL"==i)&&(a=3),a==t)return e;if(t>0){var r=e.length/t,o=new Float32Array(r*a);if(t<a)for(var s=0;s<r;s++){for(var n=0;n<t;n++)o[s*a+n]=e[s*t+n];for(n=t;n<a;n++)o[s*a+n]=0}else for(s=0;s<r;s++)for(n=0;n<a;n++)o[s*a+n]=e[s*t+n];return o}return console.log("wrong definition of buffer dimension"),e},this.createGeometries=function(t,i,r,o){if(t)for(var s=o.data,n=0;n<t.length;n++){var l,p,u=t[n],c={},h=0,d=u.reps&&!(u.reps instanceof Object);if(d){var f=this.getGenericBuffer(i,o,u.reps,"Uint8");l=new Uint32Array(f.buffer,f.byteOffset);var m=4*f.byteLength/9;p=new Float32Array(f.buffer,f.byteOffset+m)}var g=r[u.vertexLayout],v=new e.BufferGeometryDS;if(v.compressedNormals=u.compressedNormals||void 0!==u.normalCompression&&"OCT_24"===u.normalCompression,v.compressedVertices=u.compressedVertices||void 0!==u.positionCompression&&"BBOX_QUANTIZATION_16_16_16"===u.positionCompression,v.compressedUVs=u.compressedUVs||void 0!==u.uvCompression&&"UV_SHORT"===u.uvCompression,v.compressedColors=u.compressedColors||void 0!==u.colorCompression&&"COLOR_BYTE"===u.colorCompression,s.geometries[n]=v,v.sharedBuffers=this.sharedBuffers,v.noMeshInRAM=this.noMeshInRAM,void 0===u.indexBuffer){if(u.drawingGroups&&u.drawingGroups[0].count){v.vertexIndexArray=new Uint32Array(u.drawingGroups[0].count);for(var b=0;b<u.drawingGroups[0].count;b++)v.vertexIndexArray[b]=b}}else v.vertexIndexArray=this.getBuffers(i,o,u.indexBuffer);if(u.boundingSphere){var y=u.boundingSphere.center,w=u.boundingSphere.radius;v.boundingSphere=new e.Sphere(new e.Vector3(y[0],y[1],y[2]),w)}if(u.boundingBox){var M=u.boundingBox.min,C=u.boundingBox.max;v.compressedVertices&&(v.quantizedVector=new e.Vector3(Math.max(C[0]-M[0],1e-6),Math.max(C[1]-M[1],1e-6),Math.max(C[2]-M[2],1e-6)),v.quantizedVector.multiplyScalar(1/65535),v.offsetVector=new e.Vector3(M[0],M[1],M[2]),v.offsetVector.x/=v.quantizedVector.x,v.offsetVector.y/=v.quantizedVector.y,v.offsetVector.z/=v.quantizedVector.z,v.offsetVector.x=Math.floor(v.offsetVector.x),v.offsetVector.y=Math.floor(v.offsetVector.y),v.offsetVector.z=Math.floor(v.offsetVector.z))}if(1===g[0].length)for(var A=0;A<u.vertexBuffers.length;A++){var O=g[A],B=this.getBuffers(i,o,u.vertexBuffers[A],O);if("POSITION"==(J=O[0]).attribute){if(v.vertexPositionArray=this.getInternalDimensionBuffer(B,J.dimension,J.attribute),v.compressedVertices){var D=v.vertexPositionArray,L=D.length/3;v.vertexPositionArray=new Float32Array(2*L);for(b=0;b<L;b++){var R=D[3*b],P=D[3*b+1],I=Math.floor(P/256),N=P%256,U=D[3*b+2];v.vertexPositionArray[2*b]=256*R+I,v.vertexPositionArray[2*b+1]=256*U+N}}}else if("NORMAL"==J.attribute){if(v.vertexNormalArray=this.getInternalDimensionBuffer(B,J.dimension,J.attribute),v.compressedNormals){var _=(j=v.vertexNormalArray).length/3;v.vertexNormalArray=new Float32Array(_);for(b=0;b<_;b++){R=j[3*b],P=j[3*b+1],U=j[3*b+2];var F=16*R+Math.floor(P/16),k=P%16*256+U;v.vertexNormalArray[b]=4096*F+k}}}else if("TEX_COORD_0"==J.attribute){if(v.vertexUvArray=this.getInternalDimensionBuffer(B,J.dimension,J.attribute),v.compressedUVs){var E=(V=v.vertexUvArray).length/3;v.vertexUvArray=new Float32Array(2*E);for(b=0;b<E;b++){R=V[3*b],P=V[3*b+1],I=Math.floor(P/256),N=P%256,U=D[3*b+2];v.vertexUvArray[2*b]=256*R+I,v.vertexUvArray[2*b+1]=256*U+N}}}else if("TEX_COORD_1"==J.attribute){if(v.vertexUv2Array=this.getInternalDimensionBuffer(B,J.dimension,J.attribute),v.compressedUVs){var V;E=(V=v.vertexUv2Array).length/3;v.vertexUv2Array=new Float32Array(2*E);for(b=0;b<E;b++){R=V[3*b],P=V[3*b+1],I=Math.floor(P/256),N=P%256,U=D[3*b+2];v.vertexUv2Array[2*b]=256*R+I,v.vertexUv2Array[2*b+1]=256*U+N}}}else if("COLOR"==J.attribute){if(v.vertexColorArray=this.getInternalDimensionBuffer(B,J.dimension,J.attribute),v.compressedColors){var j,z=(j=v.vertexColorArray).length/4;v.vertexColorArray=new Float32Array(2*z);for(b=0;b<z;b++){var W=j[4*b],X=j[4*b+1],H=j[4*b+2],q=j[4*b+3];v.vertexColorArray[2*b]=65536*W+256*X+H,v.vertexColorArray[2*b+1]=q}}}else"TANGENT"==J.attribute?v.vertexTangentArray=this.getInternalDimensionBuffer(B,J.dimension,J.attribute):"BINORMAL"==J.attribute?v.vertexBinormalArray=this.getInternalDimensionBuffer(B,J.dimension,J.attribute):v[J.attribute]=B}else{O=g[0];var Y=this.getBuffers(i,o,u.vertexBuffers[0],O);for(A=0;A<O.length;A++){var J;"POSITION"==(J=O[A]).attribute?v.vertexPositionArray=this.getInternalDimensionBuffer(Y[A],J.dimension,J.attribute):"NORMAL"==J.attribute?v.vertexNormalArray=this.getInternalDimensionBuffer(Y[A],J.dimension,J.attribute):"TEX_COORD_0"==J.attribute?v.vertexUvArray=this.getInternalDimensionBuffer(Y[A],J.dimension,J.attribute):"TEX_COORD_1"==J.attribute?v.vertexUv2Array=this.getInternalDimensionBuffer(Y[A],J.dimension,J.attribute):"COLOR"==J.attribute?v.vertexColorArray=this.getInternalDimensionBuffer(Y[A],J.dimension,J.attribute):"TANGENT"==J.attribute?v.vertexTangentArray=this.getInternalDimensionBuffer(Y[A],J.dimension,J.attribute):"BINORMAL"==J.attribute?v.vertexBinormalArray=this.getInternalDimensionBuffer(Y[A],J.dimension,J.attribute):v[J.attribute]=Y[A]}}for(A=0;A<u.drawingGroups.length;A++){var K,Z=u.drawingGroups[A],Q=void 0!==Z.repRanges,$=void 0!==Z.primitives,ee=void 0!==Z.canonicals,te=void 0!==Z.cullingData,ie=v.vertexNormalArray?x:T,ae=[],re=new a.DrawingGroup(ie,null,G[Z.mode],Z.start,Z.count,ae,void 0,e.GeomTypeEnum.UNKNOWN,0);if(re.geometry=v,re._geomType=e.GeomTypeEnum[Z.geometricType]||e.GeomTypeEnum.UNKNOWN,v.drawingGroups.push(re),void 0!==Z.graphicAttributes&&s.materials[Z.graphicAttributes])(K=s.materials[Z.graphicAttributes]).uri?K.destinationDGforGAS.push(re):re.gas=K;if(void 0!==Z.material&&s.materials[Z.material])(K=s.materials[Z.material]).uri?K.destinationDGforMaterial.push(re):re.material=K;if(te){var oe=this.getGenericBuffer(i,o,Z.cullingData.start,"Uint32"),se=this.getGenericBuffer(i,o,Z.cullingData.radius,"Float32");oe.length>0&&(re.cullingData=new a.DGCullingData);for(b=0;b<oe.length;b++)re.cullingData.get(0).push({start:oe[b],radius:se[b]})}if(Q&&!$){var ne=this.getGenericBuffer(i,o,Z.repRanges,"Uint32"),le=Z.start;for(b=0;b<ne.length;b+=2){var pe=new a.SGPrimitive({cgmId:0,group:re,start:le,count:ne[b+1]});if(le+=pe.count,o.unstreamReps&&u.reps){var ue=l[4*(ge=ne[b])];(me=s.reps[ue])||(me={rep:new a.SGRep({cgmId:l[4*ge+1],solid:l[4*ge+2],sag:p[5*ge+4]}),bsphere:[p[5*ge],p[5*ge+1],p[5*ge+2],p[5*ge+3]],nbTriangles:l[4*ge+3]},c[ge]=me,s.reps[ue]=me,h++),pe.rep=me.rep,me.rep._primitives.push(pe)}ae.push(pe)}}else if($&&o.unstreamPrimitives){var ce=this.getBuffers(i,o,Z.primitives,void 0,Z.geometricType).buffer,he=0,de=ee?this.getBuffers(i,o,Z.canonicals).buffer:null;for(b=0;b<ce.length;b+=4){var fe=new a.SGPrimitive({cgmId:ce[b],group:re,start:ce[b+2],count:ce[b+3]});if(o.unstreamReps&&u.reps){var me,ge=ce[b+1];ue=d?l[4*ge]:0;if(!(me=d?s.reps[ue]:c[ge])){if(d)me={rep:new a.SGRep({cgmId:l[4*ge+1],solid:l[4*ge+2],sag:p[5*ge+4]}),bsphere:[p[5*ge],p[5*ge+1],p[5*ge+2],p[5*ge+3]],nbTriangles:l[4*ge+3]},s.reps[ue]=me;else{var ve=u.reps[ge];me={rep:new a.SGRep({cgmId:ve.cgmId,solid:ve.solid,sag:ve.sag}),bbox:ve.bbox,nbTriangles:ve.nbTriangles}}c[ge]=me,h++}fe.rep=me.rep,me.rep._primitives.push(fe)}if(ee){var be=de[he++];if(be){fe.decoration=new Array;for(var ye=0;ye<be;ye++)fe.decoration.push(de[he++])}}ae.push(fe)}}else{fe=new a.SGPrimitive({cgmId:0,group:re,start:Z.start,count:Z.count});ae.push(fe)}}if(o.unstreamSSB&&h>this.SSBMinNbReps){var xe=performance.now(),Te=[],we=0,Me=null,Se=new e.Sphere,Ce=new e.Sphere;for(var Ae in c){var Oe=c[Ae].bsphere;Ce.center.set(Oe[0],Oe[1],Oe[2]),Ce.radius=Oe[3],Me?(Se.copy(Me),Se.mergeWithSphere(Ce,Me)):Me=Ce.clone(),c[Ae].rep.boundingSphere={center:[Ce.center.x,Ce.center.y,Ce.center.z],radius:Ce.radius},we+=c[Ae].nbTriangles,Te.push(c[Ae])}we>this.SSBMinNbTriangles&&(v.bvhCells=[],xe=performance.now(),S.indexMap=new Uint32Array(v.vertexIndexArray.length),(!S.positions||S.positions.length<v.vertexPositionArray.length)&&(S.positions=new Float32Array(v.vertexPositionArray.length)),(!S.normals||S.normals.length<v.vertexNormalArray.length)&&(S.normals=new Float32Array(v.vertexNormalArray.length)),console.log("allocate indexMap/positions/normals in "+(performance.now()-xe)+" ms."),v.bvhCells.push(this.batchBVHCell({objects:Te},v,S,Me)))}}},this.batchBVHCell=function(t,i,r,o){var s=performance.now(),n=new e.BufferGeometryDS;n.sharedBuffers=this.sharedBuffers,n.noMeshInRAM=this.noMeshInRAM,o?(n.boundingSphere=o,n.boundingBox=n.boundingSphere.getBoundingBox()):(n.boundingBox=new e.Box3(t.bbox.min,t.bbox.max),n.boundingSphere=n.boundingBox.getBoundingSphere()),n.compressedVertices=i.compressedVertices,n.compressedNormals=i.compressedNormals,n.compressedUVs=i.compressedUVs,n.compressedColors=i.compressedColors,n.quantizedVector=i.quantizedVector,n.offsetVector=i.offsetVector;var l=r.indexMap,p=r.positions,u=r.normals;performance.now()-s,s=performance.now();for(var c=0,h=0,d=[],f=0,m=0;m<t.objects.length;m++)for(var g=t.objects[m],v=0;v<g.rep.primitives.length;v++){f+=(x=g.rep.primitives[v]).count,d.push(x)}performance.now()-s,s=performance.now();var b,y,x,T=new Uint32Array(f);d.sort((function(e,t){if(e.group.glType<t.group.glType)return-1;if(e.group.glType>t.group.glType)return 1;if(e.group._geomType<t.group._geomType)return-1;if(e.group._geomType>t.group._geomType)return 1;if(e.group.gas.id<t.group.gas.id)return-1;if(e.group.gas.id>t.group.gas.id)return 1;if(e.group.material&&!t.group.material)return-1;if(!e.group.material&&t.group.material)return 1;if(e.group.material&&t.group.material){if(e.group.material.id<t.group.material.id)return-1;if(e.group.material.id>t.group.material.id)return 1}return e.rep.boundingSphere.radius>t.rep.boundingSphere.radius?-1:e.rep.boundingSphere.radius<t.rep.boundingSphere.radius?1:0})),performance.now()-s,s=performance.now();for(v=0;v<d.length;v++){(x=d[v]).group!==b&&(b=x.group,(y=new a.DrawingGroup(x.group.gas,x.group.material,x.group.glType,h,0,[],void 0,x.group._geomType,0)).geometry=n,n.drawingGroups.push(y),g=null,y.cullingData=new a.DGCullingData),x.rep!==g&&(g=x.rep,y.cullingData.get(0).push({start:h,radius:g.boundingSphere.radius}));for(var w=h,M=0;M<x.count;M++){var S=i.vertexIndexArray[x.start+M];0===l[S]&&(l[S]=c+1,i.compressedVertices?(p[2*c]=i.vertexPositionArray[2*S],p[2*c+1]=i.vertexPositionArray[2*S+1]):(p[3*c]=i.vertexPositionArray[3*S],p[3*c+1]=i.vertexPositionArray[3*S+1],p[3*c+2]=i.vertexPositionArray[3*S+2]),i.compressedNormals?u[c]=i.vertexNormalArray[S]:(u[3*c]=i.vertexNormalArray[3*S],u[3*c+1]=i.vertexNormalArray[3*S+1],u[3*c+2]=i.vertexNormalArray[3*S+2]),c++),T[h]=l[S]-1,h++}x.start=w,x.group=y,y.count+=x.count,y.primitives.push(x)}return performance.now()-s,s=performance.now(),n.vertexIndexArray=T,n.vertexPositionArray=new Float32Array(p.buffer.slice(0,4*(i.compressedVertices?2:3)*c)),n.vertexNormalArray=new Float32Array(u.buffer.slice(0,4*(i.compressedNormals?1:3)*c)),performance.now()-s,n},this.createNodes=function(t,i){if(t){i.data.children||(i.data.children=[]);for(var a=i.data,s=0;s<t.length;s++){var n=t[s],l=null;if("External"===n.type)l=new r,i.data.modelsToLoad.push({destinationNode:l,uri:n.uri});else if("Node3D"===n.type)l=new r,i.data.children[s]=n.children;else{var p=null,u=null;if(n.boundingSphere){var c=n.boundingSphere.center,h=n.boundingSphere.radius;p=new e.Sphere(new e.Vector3(c[0],c[1],c[2]),h)}if(n.boundingBox){var d=n.boundingBox.min,f=n.boundingBox.max;u=new e.Box3(new e.Vector3(d[0],d[1],d[2]),new e.Vector3(f[0],f[1],f[2]))}var m=[];if(n.geometries)for(var g=0;g<n.geometries.length;g++){var v=a.geometries[n.geometries[g]];if(v.bvhCells)for(var y=0;y<v.bvhCells.length;y++)m.push(v.bvhCells[y]);else m.push(v)}u||(m[0].computeBoundingBox(),u=m[0].boundingBox),m.boundingBox=u,p||(m[0].computeBoundingSphere(),p=m[0].boundingSphere),m.boundingSphere=p;var w=m.length&&m[0].vertexNormalArray?x:T,M=new e.Mesh(m,w);if(M.fromLoadedModel=!0,M.castShadow=void 0===n.castShadow||n.castShadow,M.receiveShadow=void 0===n.receiveShadow||n.receiveShadow,M.enableNormalDepth=void 0===n.enableNormalDepth||n.enableNormalDepth,n.lightmaps&&n.lightmaps.length){var S=a.textures[n.lightmaps[0]];M.lightMapData={lightMapLinear:!0,lightMapMode:i.lightMapAsIrradiance?1:0,lightMapUvTransform:null,lightMapUvSlot:1};var C=S.mapping;C&&(C.uvTransform&&(M.lightMapData.lightMapUvTransform=_(C.uvTransform)),C.slot&&(M.lightMapData.lightMapUvSlot="TEX_COORD_1"===C.slot?2:1)),M._programID|=e.ProgramIDs.LIGHT_MAP;for(g=0;g<n.lightmaps.length;g++)S=a.textures[n.lightmaps[g]],m[g].lightMap=S.texture}if(l=new o(M),i.accelStruct&&!b)l._occurrences[0].renderable.computeKDTree(!1)}if(i.version>=4){if(void 0!==n.materialApplication){var A=a.materialApplications[n.materialApplication];l.setMaterialApplication(A)}if(void 0!==n.decalApplications)for(s=0;s<n.decalApplications.length;s--){var O=a.materialApplications[n.decalApplications[s-1]],B=O.decal;O.apply&&B.applyOn(l),O.attach&&B.attachTo(l)}}else if(void 0!==n.material){var D=a.materials[n.material];D.uri?D.destinationNodes.push(l):l.setMaterial(D)}if(a.nodes[s]=l,n.matrix){var G=(new e.Matrix4).setFromArray(n.matrix);l.setMatrix(G)}n.name&&l.setName(n.name),i.nodeCallback&&i.nodeCallback(n,i,l)}}},this.createLayers=function(t,i){var a=i.data;for(var r in a.nodes){var o=a.nodes[r],s=t[r];for(var l in s.occurrences){var p=s.occurrences[l].index,u=s.occurrences[l];if(u.layers.length){o._occurrences[p].renderable.layer=new e.BufferLayer(o._occurrences[p].renderable);for(var c=0;c<u.layers.length;c++){var h=u.layers[c],d=a.geometries[h.geometry],f=a.materials[h.drawableInterval.material];y&&(f=new n({faceMaterial:f,inheritance:2,layer:0}));var m=new e.DrawableInterval(h.drawableInterval.layerNum,h.drawableInterval.start,h.drawableInterval.count,f);m.primitiveStart=h.drawableInterval.primitiveStart,m.primitiveCount=h.drawableInterval.primitiveCount;var g=new e.LayerInterval(d,d.drawingGroups[h.drawableGroup],m);o._occurrences[p].renderable.layer.addLayerInterval(g)}}}}},this.createlightNode=function(t,i,a){var r=null,o=t.emissionColor?t.emissionColor:t.color;if(t.energyNormalization){var s=.2126*o[0]+.7152*o[1]+.0722*o[2];o[0]=o[0]/s,o[1]=o[1]/s,o[2]=o[2]/s}var n=(new e.Color).setRGB(o[0],o[1],o[2]),d="rgb("+255*o[0]+","+255*o[1]+","+255*o[2]+")",f=void 0!==t.emissionValue?t.emissionValue:t.value;if("directional"==t.type)r=new p({color:n,intensity:f/=i*i,sceneShadow:!0});else if("point"==t.type)if(t.emissionMode&&"LUMINOUS_POWER"!=t.emissionMode||(f/=4*Math.PI),void 0!==t.profileTexture){var m=null;(m=this._loadImage(a,!1,t.profileTexture,(function(e){})).map).flipY=!1,m.wrapS=1001,m.wrapT=1001,m.anisotropy=1,m.minFilter=1006,m.magFilter=1006,m.generateMipmaps=!1,r=new h({color:n,intensity:f,physicalAttenuation:!0,attenuationScale:1e-6,texture:m})}else r=new c({color:n,intensity:f,physicalAttenuation:!0,attenuationScale:1e-6,sceneShadow:!0});else if("spot"==t.type){var g=t.cutoffAngle*Math.PI/180,v=t.falloffAngle*Math.PI/180;t.emissionMode&&"LUMINOUS_POWER"!=t.emissionMode||(f/=Math.PI*(1-Math.cos(g)+(1-Math.cos(v)))),r=new u({color:n,intensity:f,physicalAttenuation:!0,attenuationScale:1e-6,outerAngle:g,innerAngle:v,sceneShadow:!0})}else"rectangle"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.RectangleLight(d,f,t.width,t.height,e.AreaLightUnits[t.emissionMode])).color=n,r._internalScale=i,r=new l(r)):"disk"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.DiskLight(d,f,t.radius,e.AreaLightUnits[t.emissionMode])).color=n,r._internalScale=i,r=new l(r)):"sphere"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.SphereLight(d,f,t.radius,e.AreaLightUnits[t.emissionMode])).color=n,r._internalScale=i,r=new l(r)):"tube"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.TubeLight(d,f,t.radius,t.width,e.AreaLightUnits[t.emissionMode])).color=n,r._internalScale=i,r=new l(r)):r={};return r},this.applyLights=function(t,i){var a=t.json.lightInstances;if(a&&a.length){var r=null,o=t.destinationNodes?t.destinationNodes[0]:t.destinationNode;i||b||!o._occurrences[0].scene3js||((r=o._occurrences[0].scene3js.viewer).setAmbientLight(0),r.setIntensityCorrection(!0),r.useDefaultLights&&(r.setTriLights(!1),r._directionalLight.setIntensity(0),r._directionalLight2.setIntensity(0)),r.renderer.ToneMappingEffect&&r.renderer.ToneMappingEffect.setToneMapping(2));var s=1;t.rootMatrix&&(s=t.rootMatrix.getMaxScaleOnAxis()),o._updateBoundingElements();for(var n=t.json.lights,l=0;l<a.length;l++){var u=a[l];if(u){if("environment"!=n[u.light].type){var c=this.createlightNode(n[u.light],s,t);if(u.castShadows&&c.castShadows){var h=c instanceof p?null:1e4;c.castShadows(!0,{bias:-.005,darkness:1/a.length,far:h,mapWidth:1024,mapHeight:1024})}u.cameraAligned&&c.attachToViewpoint&&c.attachToViewpoint(u.cameraAligned);var d=new e.Matrix4;u.matrix&&d.setFromArray(u.matrix);var f=new e.Matrix4;u.ambianceTransform&&f.setFromArray(u.ambianceTransform),d=(new e.Matrix4).multiplyMatrices(f,d),t.rootMatrix&&(d=(new e.Matrix4).multiplyMatrices(t.rootMatrix,d)),c.setMatrix(d),t.data.lights||(t.data.lights=[]),t.data.lights.push(c),o.addChild(c)}}else console.warn("3dx badly formatted")}}},this.retrieveViewpoints=function(t,i,a,r){let o=[],s=null;if(a){if(!t.json.cameras)return o;s=[];for(let e=0;e<t.json.cameras.length;e++)s[e]={camera:e}}else if(s=t.json.renderFrames,!s||!s.length)return o;for(var n=0;n<s.length;n++){var l=s[n],p=t.json.cameras[l.camera];l.resolution;if(p.type&&"2DCamera"==p.type){let t=new e.Vector3(p.origin[0],p.origin[1],1);var u=p.zoom,c=p.zoomType,h=p.zoomRatio;(O=new d({viewer:i,projectionType:d.ORTHOGRAPHIC,defaultController:!0,inactive:r}))._set2DMode(!0,"COMBINED"),O.setNative2DZoomType(c,h),O._nativeZoom=u,O.onMove(i.render),O.moveTo({eyePosition:t})}else{var f=(new e.Matrix4).setFromArray(p.matrix),m=new e.Vector3,g=new e.Quaternion,v=new e.Vector3;f.decompose(m,g,v);var b=10,y=2500,x=1;t.rootMatrix&&(x=t.rootMatrix.getMaxScaleOnAxis()),m.multiplyScalar(x);var T=p.focusDistance?p.focusDistance*x:null;!p.autoNearFar&&p.nearFar&&(b=p.nearFar[0],y=p.nearFar[1],b*=x,y*=x);var w,M=p.sensorSize?p.sensorSize:[36,24];M[0]*=x,M[1]*=x;if(p.type&&"orthographic"==p.type)w=d.ORTHOGRAPHIC;else{w=d.PERSPECTIVE;var S=50;p.focalLength&&(S=p.focalLength,S*=x);var C=p.aperture?p.aperture:1,A=p.blades?p.blades:0}var O=new d({viewer:i,projectionType:w,near:b,far:y,defaultController:!0,inactive:r});if(w==d.PERSPECTIVE)O.camera.setLens(S,M,!0),O.camera.setAperture(C,A);else p.scale&&(M[0]*=p.scale[0],M[1]*=p.scale[1]),T=M[1]/(2*Math.tan(Math.PI*O.camera.fov/360));if(O.onMove(i.render),O.moveTo({eyePosition:m,orientation:g,distanceToTarget:T}),p.projectionDir){let t=O.getSightDirection(),i=new e.Vector3(p.projectionDir[0],p.projectionDir[1],p.projectionDir[2]),a=t.dot(i),r=i.setLength(1/a);r.sub(t),r.applyMatrix4(O.camera.matrixWorldInverse),O._nativeTranslationOffset=new e.Vector2(r.x,r.y),O.camera.updateProjectionMatrix()}}o.push(O)}return o},this.applyCamera=function(t){var i=t.destinationNodes?t.destinationNodes[0]:t.destinationNode;if(b||!i._occurrences[0].scene3js)return;var a=i._occurrences[0].scene3js.viewer,r=t.json.currentRenderFrame?t.json.currentRenderFrame:0;let o=this.retrieveViewpoints(t,a);if(0!=o.length){for(let e=0;e<o.length;e++)a.addViewpoint(o[e]);var s=t.json.renderFrames,n=t.json.cameras[s[r].camera];if(n.bloom){a.setBloom(!0);var l=a.getEffect("Bloom");l&&(l.setBloomThreshold(n.bloom.lightThreshold),l.setBloomFactor(n.bloom.intensity))}var p=a.getEffect("ToneMapping");a.renderer.renderer.resetInlinedPostProcess();var u=a.renderer.renderer.inlinedPostProcess;if(n.exposure&&(p?p.setBrightness(n.exposure):(u.activated=!0,u.brightness=n.exposure)),n.autoexposure&&p){var c=n.autoexposure,h=null;null!=c.regionOfInterest&&(h=data.textures[c.regionOfInterest].texture),p.setAutoExposure(!!c.autoexposure,h,c.clampMin,c.clampMax)}if(n.toneMapper)if("Filmic"===n.toneMapper.type)p?p.setToneMapping(4):(u.activated=!0,u.tonemapping=4);else if("Photographic"===n.toneMapper.type){var d=n.toneMapper.colorCorrection;p?p.setToneMapping(6,{crushblacks:n.toneMapper.crushBlack,burnhighlights:n.toneMapper.burnHighlight,saturation:n.toneMapper.saturation,colorCorrection:new e.Vector3(d[0],d[1],d[2])}):(u.activated=!0,u.tonemapping=6,u.crushblacks=n.toneMapper.crushBlack,u.burnhighlights=n.toneMapper.burnHighlight)}if(n.gammaCorrection&&p&&p.setGamma(n.gammaCorrection),n.vignetting){a.setVignetting(!0);let e=a.getEffect("Vignetting");null!=n.vignetting.power&&e&&e.setVignettingPower(n.vignetting.power)}if(null!=n.colorGrading&&p){var f=null,m=this._loadImage(t,!1,n.colorGrading,(function(e){return function(){p.setColorGrading(f)}}));(f=m.map).flipY=!1,f.wrapS=1001,f.wrapT=1001,f.anisotropy=1,f.minFilter=1006,f.magFilter=1006,f.generateMipmaps=!1}var g=a.getViewpoints().length-s.length;if(a.selectViewpoint(g+r),this.capture){a.ambience;!function(){var e=window._shootW?window._shootW:a.SCREEN_WIDTH,i=window._shootH?window._shootH:a.SCREEN_HEIGHT,r=function(e,t,i,a,r){return r?(t=a-t,i*Math.floor(t-1)+Math.floor(e)):i*Math.floor(t)+Math.floor(e)},o={data:null,width:e,height:i};a.renderToTarget(o,a.currentViewpoint,!1,{AntiAliasing:"FSAA"});var s=document.createElement("canvas");s.width=e,s.height=i;for(var n=s.getContext("2d"),l=n.createImageData(o.bufferWidth,o.bufferHeight),p=0;p<l.height;p++)for(var u=0;u<l.width;u++){var c=r(u,p,l.width,l.height,!1),h=r(u,p,o.bufferWidth,o.bufferHeight,!0);l.data[4*c]=o.data[4*h],l.data[4*c+1]=o.data[4*h+1],l.data[4*c+2]=o.data[4*h+2],l.data[4*c+3]=o.data[4*h+3]}createImageBitmap(l).then((a=>{n.drawImage(a,0,0,e,i);var r=document.createElement("a"),o=t.url.lastIndexOf("/"),s=t.url.lastIndexOf("."),l=window._shoot?window._shoot:t.url.substr(o+1,s-o-1);void 0!==window._currentShootIndex&&(l+="_"+window._currentShootIndex),r.download=l+".png",n.canvas.toBlob((function(e){r.href=URL.createObjectURL(e),r.click()}))}))}()}}},this.parseHeader=function(t){var i=t.json.header;if(!i||!i.version)return!1;if(2!==parseFloat(i.version)&&3!==parseFloat(i.version)&&3.1!==parseFloat(i.version)&&3.2!==parseFloat(i.version)&&4!==parseFloat(i.version))return!1;t.version=parseFloat(i.version),"material"!==i.content&&"ambiance"!==i.content&&"light"!==i.content||(t.content=i.content),"materialApplication"===i.content&&(t.content="material");var a=new e.Matrix4;return"m"===i.unit||"meter"===i.unit||"meters"===i.unit?a.makeScale(1e3,1e3,1e3):"inch"!==i.unit&&"inches"!==i.unit||a.makeScale(25.4,25.4,25.4),"Y"===i.upAxis?a.rotateX(.5*Math.PI):"X"===i.upAxis&&a.rotateY(.5*Math.PI),a.isIdentity()||(t.rootMatrix=a),!0},this.processJSON=function(e){this.parseHeader(e)&&(e.data.chunks.length||!e.json.binaries||e.json.binaries.flag?this.processChunks(e):this.getChunks(e.json.binaries.length,e,this.processChunks))},this.processChunks=function(e){g=performance.now();var t=e.json;if(void 0!==t.extensionsUsed)for(var i=0;i<t.extensionsUsed.length;i++)this.extensionsUsed.add(t.extensionsUsed[i]);if(void 0!==t.extensionsRequired)for(i=0;i<t.extensionsRequired.length;i++)this.extensionsRequired.add(t.extensionsRequired[i]);this.createImages(t.images,0,e,this.onImagesReady.bind(this))},this.onImagesReady=function(t){var i=t.json,a=this;t.ambianceLoaded=!0;var r=function(e){var i={nbTextures:0};e&&e.ambiance&&(t.results.ambiance=e.ambiance,t.ambianceLoaded=!0),t.ambianceLoaded&&t.geometryLoaded&&(i.isLast=!a.nbModelsToLoad,"ambiance"==t.content&&(i.ambiance=t.results.ambiance,t.json.ambiance&&t.json.ambiance.renderSettings&&(i.renderSettings=t.json.ambiance.renderSettings)),"light"==t.content&&(i.lights=t.results.lights),"material"===t.content&&(t.data.materials.length>0&&(i.material=t.results.materials[0],i.materials=t.results.materials.slice()),t.data.materialApplications.length>0&&(i.materialApplications=t.results.materialApplications.slice()),i.json=t.json,0==t.data.textures.length&&t.onTexturesLoadedCB&&t.onTexturesLoadedCB(null)),i.nbTextures=t.data.nbImagesToLoad||0,t.doneCallback&&t.doneCallback(i),delete a.modelsToLoad[t.loadIndex])};if(this.createTextures(i.textures,t),2===t.version?this.createMaterialsV2(i.materials,t.data,t):this.createMaterials(i.materials,t.data,t),t.version>=4&&(this.createMappingDescriptions(i.mappingDescriptions,t.data),this.createMaterialApplications(i.materialApplications,i.decalProjectors,t.data,t)),"material"!==t.content&&(t.ambianceLoaded=this.createAmbience(i,t,r),2===t.version&&this.createBuffers(i.buffers,t)),"material"!==t.content){if(void 0!==i.root){2===t.version?this.createGeometriesV2(i.geometries,t):this.createGeometries(i.geometries,i.buffers,i.vertexLayouts,t),this.createNodes(i.nodes,t),w("processed data in "+(performance.now()-g)+" ms."),g=performance.now();for(var o=0;o<t.data.nodes.length;o++){var s=t.data.nodes[o],n=t.data.children;if(n[o])for(var l=0;l<n[o].length;l++)s.addChild(t.data.nodes[n[o][l]]);if(s.__representations)for(l=0;l<s.__representations.length;l++){var p,u=[];for(p=0;p<s.__representations[l].length;p++)u.push(t.data.nodes[s.__representations[l][p]]);s._pushRepresentation(u)}}t.unstreamLayers&&this.createLayers(i.nodes,t),w("Created links between nodes in "+(performance.now()-g)+" ms."),g=performance.now();var c=t.data.nodes[i.root];if(t.rootMatrix){var h=(new e.Matrix4).multiplyMatrices(t.rootMatrix,c.getMatrix());c.setMatrix(h)}if(t.destinationNodes)for(o=0;o<t.destinationNodes.length;o++)t.destinationNodes[o].addChild(c);else t.destinationNode.addChild(c);w("Attached to scenegraph in "+(performance.now()-g)+" ms.")}else if(1===t.data.materials.length){for(o=0;o<t.destinationNodes.length;o++)t.destinationNodes[o].setMaterial(t.data.materials[0]);for(o=0;o<t.destinationDGforGAS.length;o++)t.destinationDGforGAS[o].gas=t.data.materials[0];for(o=0;o<t.destinationDGforMaterial.length;o++)t.destinationDGforMaterial[o].material=t.data.materials[0]}this.applyLights(t),this.applyCamera(t)}var d=t.data.modelsToLoad.length;if(d){var f=0;for(o=0;o<d;o++){var m=t.data.modelsToLoad[o];this.load({url:this.getURI(m.uri,t.path),destinationNode:m.destinationNode,destinationNodes:m.destinationNodes,destinationDGforGAS:m.destinationDGforGAS,destinationDGforMaterial:m.destinationDGforMaterial,zipped:!0,layers:t.unstreamLayers,reps:t.unstreamReps,doneCallback:function(){++f===d&&t.doneCallback&&t.doneCallback()}})}t.readyCallback&&t.readyCallback(),delete this.modelsToLoad[t.loadIndex]}else{if(this.nbModelsToLoad--,"material"===t.content&&t.data.materials.length>0&&(t.results.material=t.data.materials[0],t.results.materials=t.data.materials.slice()),"material"===t.content&&t.data.materialApplications.length>0&&(t.results.materialApplications=t.data.materialApplications.slice()),"light"===t.content&&(t.results.lights=t.data.lights),t.readyCallback&&t.readyCallback(),t.geometryLoaded=!0,0===this.nbModelsToLoad)for(o=0;o<this._zipReaders.length;o++)this._zipReaders[o].close();this._zipReaders=[],r()}},this.internalLoad=function(e){var t=this,i=this.modelsToLoad[e];if(g=performance.now(),i.json)"string"==typeof i.json&&(i.json=JSON.parse(i.json)),this.processJSON(i);else{var a=i.url,r=i.arrayBuffer,o="text";i.zipped&&(o="blob"),i.concat&&(o="arraybuffer");var s=function(e){if(w("file downloaded in "+(performance.now()-g)+" ms."),g=performance.now(),i.zipped){const a=new m.ZipReader(new m.BlobReader(e));t._zipReaders.push(a),a.getEntries().then((function(e){w("zip file reader created in "+(performance.now()-g)+" ms."),i.zipEntries=e;for(var a=null,r=0;r<e.length;r++)"manifest.json"===e[r].filename&&(a=e[r]);g=performance.now(),t.getEntryFile(a,"text",(function(e){w("unzipped JSON file in "+(performance.now()-g)+" ms."),g=performance.now(),i.json=JSON.parse(e),w("parsed JSON file in "+(performance.now()-g)+" ms."),t.processJSON(i)}))})).catch(i.errorCallback)}else if(i.concat){for(var a=new Uint8Array(e),r=new Uint32Array(e,0,1)[0],o=new Uint16Array(a.buffer,4,r/2),s=[],n=65535,l=0;l*n<o.length;l++)s.push(String.fromCharCode.apply(null,o.subarray(l*n,(l+1)*n)));var p=s.join("");if(w("unbinarized JSON file in "+(performance.now()-g)+" ms."),g=performance.now(),i.json=JSON.parse(p),w("parsed JSON file in "+(performance.now()-g)+" ms."),i.concatBinaries={data:a,offset:a.byteLength},t._extractInfos)return void t.getChunks(i.json.binaries.length,i,(function(){t.dlJsonAndBinaries(i)}));t.processJSON(i)}else w("JSON file downloaded in "+(performance.now()-g)+" ms."),g=performance.now(),i.json=JSON.parse(e),w("parsed JSON file in "+(performance.now()-g)+" ms."),t.processJSON(i)};if(r)s(r);else if("file:"==a.slice(0,5)){var n=new XMLHttpRequest;n.open("GET",a,!0),n.responseType=o,n.withCredentials=!0,n.onreadystatechange=function(e){4===n.readyState&&(0===n.status||200===n.status?s(n.response):i.errorCallback())},n.send(null)}else UWA.Ajax.request(a,{async:!0,cors:!0,withCredentials:!0,responseType:o,onComplete:s,onFailure:i.errorCallback})}},this.getChunks=function(e,t,i){var a=this;if(!e)return t.concatBinaries&&(t.concatBinaries.data=null),void i.call(this,t);if(e--,g=performance.now(),t.zipped){for(var r=null,o=0;o<t.zipEntries.length;o++)t.zipEntries[o].filename===t.json.binaries[e].uri&&(r=t.zipEntries[o]);r?this.getEntryFile(r,"arraybuffer",(function(r){w("unzipped binary file "+e+" in "+(performance.now()-g)+" ms."),t.data.chunks[e]=r,a.getChunks(e,t,i)})):a.getChunks(e,t,i)}else if(t.concat){g=performance.now();var s=t.json.binaries[e];if(!1===s.concatenated)return void a.getChunks(e,t,i);var n=s.byteLength;if(n%4&&(n+=4-n%4),t.concatBinaries.offset-=n,t.concatBinaries.data.buffer.slice){var l=t.concatBinaries.data.buffer.slice(t.concatBinaries.offset,t.concatBinaries.offset+s.byteLength);t.data.chunks[e]=new Uint8Array(l)}else{l=new Uint8Array(t.concatBinaries.data.buffer,t.concatBinaries.offset,s.byteLength);for(var p=new Uint8Array(s.byteLength),u=0;u<s.byteLength;u++)p[u]=l[u];t.data.chunks[e]=p}w("splitted binary file "+e+" in "+(performance.now()-g)+" ms."),a.getChunks(e,t,i)}else{var c=new XMLHttpRequest;c.open("GET",t.path+t.json.binaries[e].uri,!0),c.responseType="arraybuffer",c.withCredentials=!0,c.onreadystatechange=function(r){4===c.readyState&&(0!==c.status&&200!==c.status||(w("xhr binary file "+e+" in "+(performance.now()-g)+" ms."),t.data.chunks[e]=this.response,a.getChunks(e,t,i)))},c.send(null)}},this.setMode=function(e){this.mode=e},this._unconcat=function(){this._extractInfos=!0},this.dlJsonAndBinaries=function(e){for(var t=function(e,t){var i=document.createElement("a");i.download=t,i.href=URL.createObjectURL(e),i.click()},i=0;i<e.json.binaries.length;i++){let a="binary"+i+".bin";t(new Blob([e.data.chunks[i]],{type:"arraybuffer"}),a),e.json.binaries[i].uri=a}var a=JSON.stringify(e.json,void 0,2);t(new Blob([a],{type:"text/plain"}),"manifest.json")},this.setSharedBuffers=function(e){this.sharedBuffers=e},this.setNoMeshInRAM=function(e){this.noMeshInRAM=e},this.setBaseUrl=function(e){this.baseUrl=e},this.load=function(e){var t={version:3,content:"sceneGraph",url:e.url||null,arrayBuffer:e.arrayBuffer||null,path:e.url?i.parseUrl(e.url+".json").directoryPath:null,zipped:void 0!==e.zipped?e.zipped:void 0===this.mode||"zipped"===this.mode,concat:void 0!==e.concat?e.concat:"concat"===this.mode,json:e.json,resourcesLibrary:e.resourcesLibrary,ambianceLoaded:!1,geometryLoaded:!1,forcePowerOfTwo:void 0===e.forcePowerOfTwo||e.forcePowerOfTwo,results:{ambiance:null,material:null,materials:null,materialApplications:null,lights:null},readyCallback:e.readyCallback,progressCallback:e.progressCallback,doneCallback:e.doneCallback,errorCallback:e.errorCallback,imagesCallback:e.imageCallback,binaryCallback:e.binaryCallback,materialsCallback:e.materialCallback,nodeCallback:e.nodeCallback,switchLODTextureCB:e.switchLODTextureCallback,onTexturesLoadedCB:e.onTexturesLoadedCallback,destinationNode:e.destinationNode,destinationNodes:e.destinationNodes,destinationDGforGAS:e.destinationDGforGAS,destinationDGforMaterial:e.destinationDGforMaterial,unstreamLayers:void 0!==e.layers&&e.layers,unstreamReps:void 0!==e.reps&&e.reps,unstreamPrimitives:void 0!==e.primitives&&e.primitives,unstreamSSB:void 0!==e.ssb&&e.ssb,accelStruct:void 0!==e.accelStruct&&e.accelStruct,gasSharing:void 0!==e.gasSharing&&e.gasSharing,lightMapAsIrradiance:void 0!==e.lightMapAsIrradiance&&e.lightMapAsIrradiance,loadIndex:this.loadIndex,data:{chunks:e.chunks?e.chunks:[],header:{},nodes:[],children:[],buffers:[],geometries:[],images:[],textures:[],materials:[],mappingDescriptions:[],materialApplications:[],reps:{},modelsToLoad:[],nbImagesToLoad:0}};this.modelsToLoad[this.loadIndex]=t,this.nbModelsToLoad++,this.internalLoad(this.loadIndex),this.loadIndex++},this.loadMaterial=function(e){if(!e.json)return!1;e.zipped=!1,e.chunks=[];var t=0;if(e.json.binaries&&e.binaries)for(var i=0;i<e.json.binaries.length;i++){e.json.binaries[i].extUri||(e.chunks.push(e.binaries[t]),t++)}this.load(e)}}}));