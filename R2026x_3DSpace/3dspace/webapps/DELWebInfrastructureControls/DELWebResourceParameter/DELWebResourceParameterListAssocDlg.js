window.define&&define("DS/DELWebInfrastructureControls/DELWebResourceParameter/DELWebResourceParameterListAssocDlg",["DS/DELWebInfrastructureControls/UWAUtils","DS/DELWebInfrastructureControls/DELWebAjaxModel","DS/DELWebInfrastructureControls/DELWebResourceParameter/DELWebResourceParameterModel","DS/DELWebInfrastructureControls/DELWebResourceParameter/DELWebResourceParameterListDlg","DS/DELWebInfrastructureControls/DELWebSearchUtils","DS/Windows/Dialog","DS/Controls/Button","DS/DELWebInfrastructureControls/Mask","DS/Controls/LineEditor","DS/Controls/Editor","DS/Controls/ComboBox","DS/Controls/Popup","DS/DataGridView/DataGridView","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/CollectionView/CollectionViewStatusBar","DS/DELWebInfrastructureControls/DELWebNotifications","i18n!DS/DELWebInfrastructureControls/assets/nls/DELWebInfrastructureControls","css!DS/DELWebInfrastructureControls/DELWebInfrastructureControls.css"],(function(e,s,t,i,o,a,r,n,c,l,d,u,p,m,h,g,D,f){"use strict";var _=a.inherit({name:"DELWebResourceParameterListAssocDlg",publishedProperties:{title:{defaultValue:f.get("Associate Existing {0}",{0:f.get("Resource Parameter List")}),type:"string",category:"Appearance"},modalFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},autoCloseFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},resizableFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},activateButtonsIfActionPerformed:{defaultValue:!1,type:"boolean",category:"Behavior"},width:{defaultValue:Math.max(window.widget.body.clientWidth/2,330),type:"integer",category:"Appearance",advancedSetter:!0,recordFlag:!0},height:{defaultValue:Math.max(window.widget.body.clientHeight/5,200),type:"integer",category:"Appearance",advancedSetter:!0,recordFlag:!0},minWidth:{defaultValue:330,defaultTouchValue:330,advancedSetter:!0,type:"integer",category:"Appearance"},minHeight:{defaultValue:160,defaultTouchValue:160,advancedSetter:!0,type:"integer",category:"Appearance"}},init:function(e){e?this.options=Object.assign(this.options||{},e):this.options||(this.options={}),this._parent.apply(this,arguments)},destroy:function(){var e=this._createDlg||this.options&&this.options._createDlg;delete this._createDlg,this.options&&(delete this.options._createDlg,this.options._dndResultsDraggingStart&&window.OpenAjax.hub.unsubscribe(this.options._dndResultsDraggingStart),this.options._dndResultsDraggingStop&&window.OpenAjax.hub.unsubscribe(this.options._dndResultsDraggingStop)),this._parent.apply(this,arguments),e&&e.destroy&&e.destroy()},_postBuildView:function(){this.elements._modalDiv||(this.elements._modalDiv=this.elements.container.getParent(".wux-windows-modalDialog")),this.elements._modalDiv.addClassName("wux-ui-animation-flipable"),this._createDlg||this.options._createDlg?this.elements.container.addClassName("wux-ui-animation-flip-out"):this.elements.container.addClassName("wux-ui-animation-flip-in"),this._parent();var s=this;if(!this.immersiveFrame)if(this.options.immersiveFrame)this.immersiveFrame=this.options.immersiveFrame;else{var t=window.document.getElementsByClassName("wux-windows-immersive-frame");if(t&&t.length)for(var i=0;!this.immersiveFrame&&i<t.length;++i)t[i]&&t[i].dsModel&&(this.immersiveFrame=t[i].dsModel)}this.elements.container.addClassName(this.name+"-dlg"),this.elements.mainDiv=e.createElement("div",{class:this.name+"-maindiv"}).inject(this.elements._contentDiv||this.elements.container),this.buttons={Ok:new r({label:f.get("Create New"),onClick:function(){s.onCreateNew()}}),Save:new r({disabled:!0,onClick:function(){s.onSave()}}),Cancel:new r({onClick:function(){s.visibleFlag=!1,s.destroy()}})},this.buttons.Ok.emphasize="secondary",this.buttons.Ok.elements.button.setStyles({position:"absolute",left:"20px"}),this.elements.mainDiv.innerHTML='<div class="assoc_type"><table><tr><th>'+f.get("Filter on {0}",{0:f.get("Resource Type")})+'</th><td><div class="assoc_type_val loading"></div></td><td><div class="assoc_type_loading_icon"></div></td></tr></table></div><div class="assoc_header"><span class="assoc_title">'+f.get("Resource Parameter Lists in Factory")+'</span><span class="assoc_help wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-help"></span><span class="assoc_refresh wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-refresh"></span><span class="assoc_search"><span class="wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-drag-drop"></span> '+f.get("Drag from 3DSearch to add Resource Parameter Lists")+'</span></div><div class="assoc_table loading"></div>',this._addResourceDropDown(),this._addExistingResourceParamListTable(),this._initEventHandlers()},_addResourceDropDown:function(){var i=this;s.getServiceUrl({serviceName:"3DSpace"}).then((function(o){s.getResourceDisciplines({blnCachedOk:!0,addAdditionalDisciplines:!0}).then((function(a){s.getResourceDisciplines({blnCachedOk:!0,V_discipline:"Organizational",addAdditionalDisciplines:!0}).then((function(s){var r=a.Resource;s.Organizational&&e.each(s.Organizational,(function(e,s){s&&s.isOOTB&&["WorkCenter","ResourceNCCellTemplate","ResourcePressLine"].indexOf(s.disciplineName)<0&&r.push(s)})),a.AdditionalDisciplines&&e.each(a.AdditionalDisciplines,(function(e,s){r.push(s)}));var n=[{labelItem:f.get("All"),valueItem:""}];e.each(r,(function(s,t){if("Pool"!==t.name&&!t.isOOTB||t.Newable&&(e.String.contains(t.Newable.toUpperCase(),"NEW")||e.String.contains(t.Newable.toUpperCase(),"ALL"))){var i=null;window.Foe&&window.Foe.Model&&window.Foe.Model.Asset&&(i=window.Foe.Model.Asset._getInterfaceIconPath(t)),i||(i=o+"/webapps/"+t.IconPath),n.push({labelItem:t.nlsName,valueItem:t.disciplineName||t.name,iconItem:i})}})),n=n.sort((function(e,s){return e&&s?"__OTHER__"!==e.valueItem&&s.valueItem?"__OTHER__"!==s.valueItem&&e.valueItem&&e.labelItem>s.labelItem?1:-1:1:0})),i.elements._disciplineDropdown=new d({elementsList:n,enableSearchFlag:!1,actionOnClickFlag:!1});var c=i.elements.mainDiv.getElementsByClassName("assoc_type_val");if(c&&1===c.length&&(c=c[0]),i.elements._disciplineDropdown.inject(c),i.elements._disciplineDropdown.getContent().addEventListener("change",(function(e){i.onDisciplineDropdownChange(e)})),i.options.resource){var l=Object.assign({Minimum:["V_discipline"]},i.options.resource);t.getOneResource(l).then((function(e){e&&e.V_discipline&&("ResourceArea"===e.V_discipline?i.elements._disciplineDropdown.value="Area":"ErgoHuman"===e.V_discipline?i.elements._disciplineDropdown.value="Worker":i.elements._disciplineDropdown.value=e.V_discipline)}))}e.extendElement(c).removeClassName("loading")}))}),(function(e){D.displayNotificationMessage(e)}))}),(function(e){D.displayNotificationMessage(e)}))},hideDialog:function(){this.elements.container&&this.elements.container.addClassName("wux-ui-animation-flip-out").removeClassName("wux-ui-animation-flip-in")},showDialog:function(){this.elements.container&&this.elements.container.removeClassName("wux-ui-animation-flip-out").addClassName("wux-ui-animation-flip-in"),this.elements._modalDiv&&this.elements._modalDiv.inert&&(this.elements._modalDiv.inert=!1)},showCreateDialog:function(e){!this._createDlg&&this.options._createDlg&&(this._createDlg=this.options._createDlg),this._createDlg||((e=Object.assign(e||{},this.options))._assocDlg||(e._assocDlg=this),this._createDlg=new i(e)),this._createDlg.showDialog(e)},onCreateNew:function(){this.hideDialog(),this.showCreateDialog()},onSave:function(){var s=this;if(this.options&&this.options.resource&&this.options.resource.physicalid)if(this.elements._uwaTree&&!this.elements._uwaTree.getNodesXSO().isEmpty()){var i=[];e.each(this.elements._uwaTree.getNodesXSO().get(),(function(e,s){s&&s.dsModel&&s.dsModel.physicalid&&i.push({physicalid:s.dsModel.physicalid})})),t.associateResourceParameterList({resource:this.options.resource,resourceParameterList:{QueryList:i}}).then((function(t){var i=f.get("Resource Parameter List");t&&1===t.length&&t[0].resourceParameterList&&t[0].resourceParameterList.V_Name?i=e.String.escapeHTML(t[0].resourceParameterList.V_Name):t&&t.length>1&&(i=f.get("Resource Parameter Lists")),D.displayNotificationMessage(f.get("{0} Associated",{0:i}),{level:"success"}),s.destroy()}),(function(e){D.displayNotificationMessage(e)}))}else D.displayNotificationMessage(f.get("No {0}",{0:f.get("Resource Parameter Lists")}));else D.displayNotificationMessage(f.get("No {0}",{0:f.get("Resource")}))},onSelectChanged:function(){this.buttons.Save.disabled=!this.elements._uwaTree||this.elements._uwaTree.getNodesXSO().isEmpty(),this.buttons.Save.disabled||!this.elements._uwaTree||this.elements._uwaTree.elements.statusBar||this.elements._uwaTree.buildStatusBar([{position:"far",type:g.STATUS.NB_SELECTED_ROWS}])},onDisciplineDropdownChange:function(s){var i=this;this._paramDisciplineListLoaded||(this._paramDisciplineListLoaded={});var o=e.extendElement(this.elements.mainDiv.querySelector(".assoc_type_loading_icon")),a=null,r=i.elements._disciplineDropdown?i.elements._disciplineDropdown.value:"";if(!i._paramDisciplineListLoaded||!i._paramDisciplineListLoaded[r]){o.addClassName("loading");var n=i.options.resource.physicalid;if(i.options.root_resource&&i.options.root_resource.physicalid&&(n=i.options.root_resource.physicalid),r)a=t.getResourceParameterLists({addAdditionalDisciplines:!0,blnIncludeDescendants:!0,physicalid:n,V_discipline:r}).then((function(e){i.addRootNodesFromData(e),i._paramDisciplineListLoaded[r]=e,i.onDisciplineDropdownChange(s)}));else{var c=[];o.addClassName("loading");var l=t.getResourceParameterLists({allCached:!0,addAdditionalDisciplines:!0}).then((function(e){i.addRootNodesFromData(e)}));c.push(l),a=t.getResourceParameterLists({addAdditionalDisciplines:!0,blnIncludeDescendants:!0,physicalid:n}).then((function(e){i.addRootNodesFromData(e),i._paramDisciplineListLoaded[r]=e})),c.push(a),e.Promise.all(c).then((function(){i.onDisciplineDropdownChange(s)}))}}if(i.elements._uwaTree){i.elements._uwaTree.getNodesXSO().empty();var d=i.elements._uwaTree.getTreeDocument();if(d){var u=d.getRoots(),p=Object.values(i._paramDisciplineListLoaded[r]||{});if(u&&u.length)for(var m=u.length-1;m>=0;--m){var h=u[m],g=(!r||p.length>0)&&h&&h.options&&h.options.dsModel;if(g&&r&&p.length>0){var D=h.options.dsModel.resourceParameterList||h.options.dsModel;g=!1;for(var f=0;!g&&f<p.length;++f){var _=p[f];_&&_.resourceParameterList&&(g=_.resourceParameterList.physicalid===D.physicalid)}}g?h.show():h.hide()}}}i._paramDisciplineListLoaded&&i._paramDisciplineListLoaded[r]&&o.removeClassName("loading")},_addExistingResourceParamListTable:function(){var s=this,i=null;if(s.options.root_resource&&s.options.root_resource.physicalid&&(!s.options.root_resource.assocResourceParamLists||s.options.resource&&s.options.resource.physicalid&&!s.options.resource.assocResourceParamLists)){var o={QueryList:[{physicalid:s.options.root_resource.physicalid}]};return s.options.resource&&s.options.resource.physicalid!==s.options.root_resource.physicalid&&o.QueryList.push({physicalid:s.options.resource.physicalid}),n&&s.elements&&s.elements.mainDiv&&((i=s.elements.mainDiv.getElementsByClassName("assoc_table"))||(i=s.elements.mainDiv),n.mask(i[0])),void t.getResourceParameterLists(o).then((function(t){s.options.root_resource.assocResourceParamLists={},s.options.resource&&(s.options.resource.physicalid===s.options.root_resource.physicalid?s.options.resource.assocResourceParamLists=s.options.root_resource.assocResourceParamLists:s.options.resource.assocResourceParamLists={}),e.each(t,(function(t,i){i.resource?i&&i.resource&&i.resourceParameterList&&(i.resource.physicalid===s.options.root_resource.physicalid?s.options.root_resource.assocResourceParamLists[i.resourceParameterList.physicalid]=i.resourceParameterList:i.resource&&i.resource.physicalid===s.options.resource.physicalid&&(s.options.resource.assocResourceParamLists[i.resourceParameterList.physicalid]=i.resourceParameterList)):e.each(i,(function(e,t){t&&t.resource&&t.resourceParameterList&&(t.resource.physicalid===s.options.root_resource.physicalid?s.options.root_resource.assocResourceParamLists[t.resourceParameterList.physicalid]=t.resourceParameterList:t.resource&&t.resource.physicalid===s.options.resource.physicalid&&(s.options.resource.assocResourceParamLists[t.resourceParameterList.physicalid]=t.resourceParameterList))}))})),s._addExistingResourceParamListTable()}))}var a=[];if(s.options.resource||s.options.root_resource){var r=Object.assign({Minimum:["V_discipline"]},s.options.resource||s.options.root_resource),c=t.getOneResource(r).then((function(e){var i=t.getResourceParameterLists({addAdditionalDisciplines:!0,blnIncludeDescendants:!0,physicalid:e.physicalid,V_discipline:e.V_discipline}).then((function(e){s.addRootNodesFromData(e)}));a.push(i)}));a.push(c)}e.Promise.all(a).then((function(){var t=s.elements.mainDiv.getElementsByClassName("assoc_table");t&&1===t.length&&(t=e.extendElement(t[0])),s.elements._uwaTree||t.setText(f.get("No {0}",{0:f.get("Resource Parameter Lists")})),t.removeClassName("loading"),n&&s&&s.elements&&s.elements.mainDiv&&(!(i=s.elements.mainDiv.getElementsByClassName("assoc_table"))&&n.isMasked(s.elements.mainDiv)&&(i=s.elements.mainDiv),i&&i.length&&n.unmask(s.elements.mainDiv))}))},addTable:function(e){var s=this;return new Promise((function(t){if(s.elements._uwaTree)t(s.elements._uwaTree);else{e||(e={});var i={cellSelection:"none",enableListSelection:!0,canMultiSelect:!0,cellDragEnabledFlag:!1,enableDragAndDrop:!1,shouldAcceptDrag:function(){return!1},shouldAcceptDrop:function(){return!1},shouldBeEditable:function(){return!1},isEditable:!1,roots:[],columns:[{text:f.get("Name"),dataIndex:"tree"},{text:f.get("Description"),dataIndex:"V_description"},{text:f.get("Revision"),dataIndex:"revision",width:"61px"}]};i.treeDocument||(i.treeDocument=new m),e.container||(e.container=s.elements.mainDiv.getElementsByClassName("assoc_table"),e.container&&1===e.container.length&&(e.container=e.container[0])),s.elements._uwaTree=new p(i).inject(e.container),s.elements._uwaTree.getNodesXSO().onChange((function(){s.onSelectChanged()})),s.elements._uwaTree.getContainingImmersiveFrame&&!s.elements._uwaTree._getContainingImmersiveFrame&&(s.elements._uwaTree._getContainingImmersiveFrame=s.elements._uwaTree.getContainingImmersiveFrame,s.elements._uwaTree.getContainingImmersiveFrame=function(){var e=s._getContainingImmersiveFrame();return e||(e=s.immersiveFrame||s.options.immersiveFrame),e}),t(s.elements._uwaTree)}}))},addRootNodesFromData:function(s){if(s&&!e.Object.isEmptyObject(s)){var t=[];e.each(s,(function(e,s){var i=null;i=s.resourceParameterList?{label:s.resourceParameterList.V_Name||s.resourceParameterList.name,dsModel:s.resourceParameterList,grid:{V_description:s.resourceParameterList.V_description||"",revision:s.resourceParameterList.revision||""}}:{label:s.V_Name||s.name,dsModel:s,grid:{V_description:s.V_description||"",revision:s.revision||""}},t.push(i)})),this.addRootNodesToTable(t)}},addRootNodesToTable:function(s){var t=this;return new Promise((function(i,o){if(s&&t.options&&t.options.root_resource&&t.options.root_resource.assocResourceParamLists&&(!t.options.resource||t.options.resource.assocResourceParamLists))for(var a=s.length-1;a>=0;--a){var r=s[a];!r.dsModel.physicalid&&r.dsModel.resourceParameterList&&(r.dsModel.resource&&(r.dsModelResource||(r.dsModelResource={}),r.dsModelResource[r.dsModel.resource.physicalid]=r.dsModel.resource),r.dsModel=r.dsModel.resourceParameterList),r.dsModel.physicalid&&(t.options.resource&&t.options.resource.assocResourceParamLists?t.options.resource.assocResourceParamLists[r.dsModel.physicalid]&&s.splice(a,1):t.options.root_resource.assocResourceParamLists[r.dsModel.physicalid]&&s.splice(a,1))}!s||!Array.isArray(s)||s.length<=0?i([]):t.addTable().then((function(t){var o=t.getTreeDocument(),a=[];t.prepareUpdateView(),e.each(s,(function(s,t){var i=o.getRoots();if(i&&i.length){var r=!0;if(e.each(i,(function(e,s){return!t.dsModel.physicalid&&t.dsModel.resourceParameterList&&(t.dsModel.resource&&(t.dsModelResource||(t.dsModelResource={}),t.dsModelResource[t.dsModel.resource.physicalid]=t.dsModel.resource),t.dsModel=t.dsModel.resourceParameterList),s&&s.dsModel&&t.dsModel&&((r=s.dsModel.physicalid!==t.dsModel.physicalid)||(t.dsModelResource&&(s.options.dsModelResource?s.options.dsModelResource=Object.assign(s.options.dsModelResource,t.dsModelResource):s.options.dsModelResource=t.dsModelResource),s.show())),r})),!r)return}var n=new h(t);n.dsModel=t.dsModel,o.addRoot(n),a.push(n)})),t.reapplySortModel(),t.pushUpdateView({updateCellContent:!0,updateCellLayout:!0},!0),i(a)}),o)}))},_initEventHandlers:function(){var e=this,s=e.elements._modalDiv||e.elements.container||e.elements.mainDiv||window.widget.body;window.widget.standalone&&window.jQuery&&window.jQuery.fn&&window.jQuery.fn.droppable?(e.options._dndResultsDraggingStart=window.OpenAjax.hub.subscribe("Search.ResultsDragging.start",(function(){window.jQuery(s).addClass("ds_search_result_droppable").droppable({tolerance:"pointer",drop:function(s,t){e.onDrop(s,t)},greedy:!0,over:function(s,t){e.onDragOver(s,t)}})})),e.options._dndResultsDraggingStop=window.OpenAjax.hub.subscribe("Search.ResultsDragging.stop",(function(){window.jQuery(s).hasClass("ui-droppable")&&window.jQuery(s).droppable("destroy"),window.jQuery(s).removeClass("ds_search_result_droppable")}))):(s.addClassName("ds_search_result_droppable"),s.addEventListener("dragover",(function(s){e.onDragOver(s)})),s.addEventListener("drop",(function(s){e.onDrop(s)}))),this.elements.mainDiv.querySelector(".assoc_header .wux-ui-3ds-help").addEventListener("click",(function(s){e.onSectionHelpClicked(s)})),this.addEventListener("close",(function(){e.destroy()}))},onDragOver:function(e){e&&e.preventDefault&&(e.stopPropagation&&e.stopPropagation(),e.preventDefault())},onDrop:function(s,i){var a=this;s.stopPropagation&&s.stopPropagation(),s.preventDefault&&s.preventDefault();var r=[],n=[],c=function(s){var t={};e.each(s,(function(s,i){i&&(i.physicalid?t[i.physicalid]=i:i.resourceParameterList&&i.resourceParameterList.physicalid?t[i.resourceParameterList.physicalid]=i.resourceParameterList:e.Object.isPlainObject(i)&&e.each(i,(function(e,s){s.physicalid?t[s.physicalid]=s:s.resourceParameterList&&s.resourceParameterList.physicalid&&(t[s.resourceParameterList.physicalid]=s.resourceParameterList)})))})),a.addRootNodesFromData(t)};i&&i.draggable&&i.draggable.closest?(i.draggable.closest(".search_results_container").find('.ui-selected[data-physicalid]:not([data-what="DELResourceParameterListReference"])').each((function(){r.push({PLM_ExternalID:window.$(this).attr("data-plm_externalid"),physicalid:window.$(this).attr("data-physicalid")})})),i.draggable.closest(".search_results_container").find('.ui-selected[data-physicalid][data-what="DELResourceParameterListReference"]').each((function(){n.push({PLM_ExternalID:window.$(this).attr("data-plm_externalid"),physicalid:window.$(this).attr("data-physicalid"),Minimum:["physicalid","V_Name","V_description","revision"]})})),r.length>0&&t.getResourceParameterLists({QueryList:r,blnIncludeDescendants:!0}).then(c,(function(e){D.displayNotificationMessage(e)})),n.length>0&&e.each(n,(function(e,s){t.getOneResourceParameterList(s).then((function(e){c([e])}),(function(e){D.displayNotificationMessage(e)}))}))):o.getUnifiedSearchObjectsFromDrop({ev:s}).then((function(s){s&&!e.Object.isEmptyObject(s)&&(e.each(s,(function(e,s){s.objectType=s.plmBaseObjectType||s.type,"DELResourceParameterListReference"===s.objectType||"DELResourceParameterListReference"===s.plmObjectType?n.push(s):(s.isResource||s.V_discipline&&"VPMReference"===s.objectType)&&r.push(s)})),r.length>0&&t.getResourceParameterLists({QueryList:r,blnIncludeDescendants:!0}).then(c,(function(e){D.displayNotificationMessage(e)})),n.length>0&&e.each(n,(function(e,s){!s.physicalid&&s.id&&(s.physicalid=s.id),s.Minimum||(s.Minimum=["physicalid","V_Name","V_description","revision"]),t.getOneResourceParameterList(s).then((function(e){Array.isArray(e)||(e=[e]),c(e)}),(function(e){D.displayNotificationMessage(e)}))})))}),(function(e){D.displayNotificationMessage(e)}))},onSectionHelpClicked:function(e){e&&e.stopPropagation&&e.stopPropagation();var s=new u({target:e.target,trigger:"click"}),t=f.get("Loaded Resource Parameter Lists that are associated to Resources of the specified type are shown here.");s.setBody(t),s.show()}});return _}));