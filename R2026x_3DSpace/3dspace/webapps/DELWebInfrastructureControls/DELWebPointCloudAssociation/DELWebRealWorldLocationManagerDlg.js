window.define&&define("DS/DELWebInfrastructureControls/DELWebPointCloudAssociation/DELWebRealWorldLocationManagerDlg",["UWA/Core","DS/DELWebInfrastructureControls/DELWebPointCloudAssociation/DELWebPointCloudAssociationModel","DS/DELWebInfrastructureControls/CommonControllers/confirmationDialog","DS/DELWebInfrastructureControls/DELWebSearchUtils","DS/DELWebInfrastructureControls/Mask","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/LineEditor","DS/Controls/Editor","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/TreeModel/TreeNodeModel","DS/DELWebInfrastructureControls/DELWebNotifications","DS/VENMomentJS-2.23.0/moment-timezone","i18n!DS/DELWebInfrastructureControls/assets/nls/DELWebInfrastructureControls","css!DS/DELWebInfrastructureControls/DELWebInfrastructureControls.css"],(function(e,t,i,n,s,o,a,l,r,d,c,u,p,m,h){"use strict";var g=o.inherit({name:"DELWebRealWorldLocationManagerDlg",publishedProperties:{title:{defaultValue:h.get("Associate Real World Location Data"),type:"string",category:"Appearance"},modalFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},autoCloseFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},resizableFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},activateButtonsIfActionPerformed:{defaultValue:!1,type:"boolean",category:"Behavior"},width:{defaultValue:Math.max(window.widget.body.clientWidth/2,330),type:"integer",category:"Appearance",advancedSetter:!0,recordFlag:!0},height:{defaultValue:Math.max(window.widget.body.clientHeight/5,200),type:"integer",category:"Appearance",advancedSetter:!0,recordFlag:!0},minWidth:{defaultValue:330,defaultTouchValue:330,advancedSetter:!0,type:"integer",category:"Appearance"},minHeight:{defaultValue:160,defaultTouchValue:160,advancedSetter:!0,type:"integer",category:"Appearance"}},init:function(t){if(t&&(this.options=Object.assign(this.options||{},t)),this._parent.apply(this,arguments),t.dsModel&&(t.dsModel.label||t.dsModel.V_Name)){var i=e.String.escapeHTML(t.dsModel.label||t.dsModel.V_Name);this.title=h.get("Associate Real World Location Data to {0}",{0:i})}t.closeCallback&&(this._closeCallback=t.closeCallback),t.droppedPointCloudIds&&(this.droppedPointCloudIds=t.droppedPointCloudIds,this.openedFromDrop=!0)},_getDateTimeDisplay:function(e){var t=this;if(!e)return null;var i=null;t._momentJS=m;var n="";if(t._momentJS)n=t._momentJS(e).format("LLL");else{i=window.Configuration.dateFormat;var s=new Date(e);t._model.start.indexOf("T")>0?i+=" "+window.Configuration.timeFormat:s.setUTCMinutes(s.getUTCMinutes()+s.getTimezoneOffset()),n=s.f(i)}return n},_populateRWLTable:function(t,i){var n=this;if(t&&!e.Object.isEmptyObject(t)){var s=n.elements._uwaTree;s&&n.elements._uwaTree.prepareUpdateView();var o=[],a=t,l={label:a.name||a.V_Name,dsModel:a,grid:{description:a.description||"",createdDate:n._getDateTimeDisplay(a["ds6w:created"]),modifiedDate:n._getDateTimeDisplay(a["ds6w:modified"]),responsible:a["ds6w:responsible"]||"",status:a["ds6w:status"]||"",effectivityDisplayDate:n._getDateTimeDisplay(a.effectivityDate),operator:a.operator||""},icons:[a.thumbnail],children:[]};(a.currentAssociation||n.options&&n.options.currentAssociation&&n.options.currentAssociation.id===a.id)&&l.icons.push("link"),o.push(l),n._addRootNodesToTable(o).then((function(o){var a=null;n.elements._uwaTree&&n.elements._uwaTree.prepareUpdateView(),e.each(o,(function(s,o){if(o.dsModel.id===t.id){if(o&&o.dsModel&&o.dsModel.droppedObj&&(a=o),!o.options||!o.options.dsModel||!o.options.dsModel.id)return delete o.options.children,void o.setState({state:"noChildren"});var l=o.getChildren();if(e.each(i,(function(t,i){if(i&&i.id&&i.name){var s=!1;if(e.each(l,(function(e,o){if(s=s||o._options.dsModel.id===t,o._options.dsModel.id===t){Object.assign(o.options.dsModel,i);var l=o.getIcons()||[];n.options.currentAssociation&&n.options.currentAssociation.id===o.options.dsModel.id&&l.indexOf("link")<0&&(l.push("link"),o.setIcons(l)),i.droppedObj&&(a=o)}})),!s){var r={label:i.name,dsModel:i,icons:[i.thumbnail],grid:Object.assign({description:i.description,createdDate:n._getDateTimeDisplay(i["ds6w:created"]),modifiedDate:n._getDateTimeDisplay(i["ds6w:modified"]),responsible:i["ds6w:responsible"]||"",status:i["ds6w:status"]||"",effectivityDisplayDate:n._getDateTimeDisplay(i.effectivityDate),operator:i.operator||""},i)};(i.currentAssociation||n.options&&n.options.currentAssociation&&n.options.currentAssociation.id===i.id)&&r.icons.push("link");var d=o.addChild(r);i.droppedObj&&(a=d)}}else e.log("invalid objStateDateObj!")})),o.dsModel.droppedObj)o.setState({state:o.hasChildren()?"collapsed":"noChildren"});else if(a&&o.getChildren().length>1){var r=o.getChildren();e.each(r,(function(e,t){t._options.dsModel.id!==a._options.dsModel.id?t.hide():t.show()})),o.setState({state:o.hasChildren()?"partiallyExpanded":"noChildren"}),o.onPreExpand((function(){var t=o.getChildren();e.each(t,(function(e,t){t.show()})),setTimeout((function(){n.resize()}),25)}))}else o.setState({state:o.hasChildren()?"expanded":"noChildren"})}})),n.elements._uwaTree&&(n.elements._uwaTree.reapplySortModel(),n.elements._uwaTree.pushUpdateView({updateCellContent:!0,updateCellLayout:!0},!0)),s&&n.elements._uwaTree&&(n.elements._uwaTree.reapplySortModel(),n.elements._uwaTree.pushUpdateView({updateCellContent:!0,updateCellLayout:!0},!0)),a&&(e.each(n.elements._uwaTree.getNodesXSO().get(),(function(e,t){n.elements._uwaTree.getNodesXSO().remove(t)})),a.select(),a.dsModel&&a.dsModel.droppedObj&&delete a.dsModel.droppedObj),n.enableDisableSaveButton()}),(function(e){p.displayNotificationMessage(e)}))}},_addTable:function(e){var t=this;return new Promise((function(i){if(t.elements._uwaTree)i(t.elements._uwaTree);else{e||(e={});var n={treeDocument:new d({}),cellSelection:"none",rowDragEnabledFlag:!1,enableListSelection:!0,maxVisibleRowCount:4,cellDragEnabledFlag:!1,canMultiSelect:!1,columns:[{text:h.get("Title"),dataIndex:"tree",modelAttribute:"name"},{text:h.get("Description"),dataIndex:"description"},{text:h.get("Creation Date"),visibleFlag:!1,dataIndex:"createdDate"},{text:h.get("Modified Date"),visibleFlag:!1,dataIndex:"modifiedDate"},{text:h.get("Owner"),visibleFlag:!1,dataIndex:"responsible"},{text:h.get("Status"),visibleFlag:!1,dataIndex:"status"},{text:h.get("Effectivity Date"),dataIndex:"effectivityDisplayDate"},{text:h.get("Operator"),visibleFlag:!1,dataIndex:"operator"}]};e.container||(e.container=t.elements.mainDiv.getElementsByClassName("DELWebRealWorldLocationManagerDlg-RWLTable"),e.container&&1===e.container.length&&(e.container=e.container[0])),s.unmask(e.container),t.elements._uwaTree=new c(n).inject(e.container),t.elements._uwaTree.rowSelection="single",t.elements._uwaTree.columnSelection="none",t.elements._uwaTree.cellSelection="none",t.elements._uwaTree.getNodesXSO().onChange((function(){t.enableDisableSaveButton()})),t.elements._uwaTree.getContainingImmersiveFrame&&!t.elements._uwaTree._getContainingImmersiveFrame&&(t.elements._uwaTree._getContainingImmersiveFrame=t.elements._uwaTree.getContainingImmersiveFrame,t.elements._uwaTree.getContainingImmersiveFrame=function(){var e=t._getContainingImmersiveFrame();return e||(e=t.immersiveFrame||t.options.immersiveFrame),e}),i(t.elements._uwaTree)}}))},_addRootNodesToTable:function(t){var i=this;return new Promise((function(n,s){if(!t||!Array.isArray(t)||t.length<=0)return s(new Error("invalid rootNodeOptionsArr")),!1;i._addTable().then((function(o){if(!o)return s(new Error("invalid table")),!1;var a=o.getTreeDocument(),l=a.getRoots(),r=[],d=[];i.elements._uwaTree.prepareUpdateView(),e.each(t,(function(t,i){if(l){var n=!0;if(e.each(l,(function(e,t){return t&&t.options&&t.options.dsModel&&i.dsModel&&((n=t.options.dsModel.id!==i.dsModel.id)||Object.assign(t.options.dsModel,i.dsModel),d.push(t)),n})),!n)return}var s=new u(i);s.dsModel=i.dsModel,a.addRoot(s),r.push(s)})),i.elements._uwaTree.pushUpdateView({updateCellContent:!0,updateCellLayout:!0},!0),setTimeout((function(){i.resize()}),250),d&&d.length&&e.each(d,(function(e,t){r.push(t)})),n(r)}),s)}))},resize:function(t){var i=this.elements.mainDiv.querySelector(".DELWebRealWorldLocationManagerDlg-RWLTable"),n=!1;if(i){if(this.elements._uwaTree&&this.elements._uwaTree._getScroller()&&this.elements._uwaTree._getScroller().elements&&this.elements._uwaTree._getScroller().elements.container){i.setStyle||e.extendElement(i);var s=this.elements._uwaTree._getScroller().elements.container.scrollHeight;t?s>this.elements._uwaTree._getScroller().elements.container.clientHeight?(i.setStyle("height",s),this.elements.mainDiv.scrollHeight>this.elements.mainDiv.clientHeight&&i.setStyle("height",s-(this.elements.mainDiv.scrollHeight-this.elements.mainDiv.clientHeight))):s>100&&this.elements.mainDiv.scrollHeight>this.elements.mainDiv.clientHeight&&i.setStyle("height",Math.max(100,s-(this.elements.mainDiv.scrollHeight-this.elements.mainDiv.clientHeight))):i.setStyle("height",null)}var o=Math.max(i.clientHeight,120);this.elements._uwaTree&&this.elements._uwaTree.elements&&this.elements._uwaTree.elements.container&&(o=Math.max(o,this.elements._uwaTree.elements.container.clientHeight)),this.elements.mainDiv.clientHeight<i.offsetTop+o&&(this.height+=i.offsetTop-this.elements.mainDiv.clientHeight+o,n=!0)}else this.elements.mainDiv.clientHeight<this.elements.mainDiv.children[0].clientHeight+20&&(this.height+=this.elements.mainDiv.children[0].clientHeight-this.elements.mainDiv.clientHeight+20,n=!0);if(n){var a=this.getAbsolutePosition();this.elements.container.clientHeight<window.widget.body.clientHeight&&(a.y=(window.widget.body.clientHeight-this.elements.container.clientHeight)/2,this.setAbsolutePosition(a))}},destroy:function(){this._parent.apply(this,arguments),this._closeCallback&&this._closeCallback(),this._confDialog&&!this._confDialogDestroyed&&(this._confDialogDestroyed=!0,this._confDialog.destroy())},_postBuildView:function(){this.elements._modalDiv||(this.elements._modalDiv=this.elements.container.getParent(".wux-windows-modalDialog")),this.elements._modalDiv.addClassName("wux-ui-animation-flipable"),this.elements.container.addClassName("wux-ui-animation-flip-in"),this._parent();var t=this;if(!this.immersiveFrame){var i=window.document.getElementsByClassName("wux-windows-immersive-frame");if(i&&i.length)for(var n=0;!this.immersiveFrame&&n<i.length;++n)i[n]&&i[n].dsModel&&(this.immersiveFrame=i[n].dsModel)}this.elements.container.addClassName(this.name+"-dlg"),this.elements.mainDiv=e.createElement("div",{class:this.name+"-maindiv"}).inject(this.elements._contentDiv||this.elements.container),this.buttons={Ok:new a({label:h.get("Delete Existing Association"),onClick:function(){t.onDelete()}}),Save:new a({disabled:!0,label:h.get("Associate"),onClick:function(){t.options.associatedRepReference?t.onEditSave():t.onAssociate()}}),Cancel:new a({onClick:function(){t.visibleFlag=!1,t.destroy()}})},this.buttons.Ok.emphasize="secondary",this.buttons.Ok.elements.button.setStyles({position:"absolute",left:"20px"}),this.buttons.Ok.hide(),this.elements.mainDiv.innerHTML='<table class="'+this.name+'-table"><tr class="'+this.name+'-V_Name"><th>'+h.get("Name")+'</th><td></td></tr><tr class="'+this.name+'-V_description"><th>'+h.get("Description")+'</th><td></td></tr></table><div class="'+this.name+'-SearchDirections"><span class="wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-drag-drop"></span><span class="'+this.name+'-SearchDirectionsText">'+h.get("Search and drop a Real World Location, Location State, or a Resource that is already associated to one of those")+'</spin></div><div class="'+this.name+'-RWLTable"></div>',this.elements._inputName=new l({placeholder:h.get("required"),value:h.get("Real World Location")+"-"+(new Date).getTime(),requiredFlag:!0,autoCommitFlag:!0}).inject(this.elements.mainDiv.querySelector("tr."+this.name+"-V_Name td")),this.elements._inputDescription=new r({autoCommitFlag:!0}).inject(this.elements.mainDiv.querySelector("tr."+this.name+"-V_description td")),this.elements._inputName.addEventListener("change",(function(){t.enableDisableSaveButton()})),this.addEventListener("close",(function(){t.destroy()})),this.addEventListener("resize",(function(e){t.resize(e)})),this.resize(),this._grabRealWorldLocationInformation(),this._initDropEventHandlers(),t.options.droppedPointCloudIds&&t.onDrop()},enableDisableSaveButton:function(){var e=this,t=null;this.elements&&this.elements._uwaTree&&this.elements._uwaTree.getNodesXSO&&this.elements._uwaTree.getNodesXSO().get&&(t=this.elements._uwaTree.getNodesXSO().get()),e.elements&&e.elements._inputName&&e.elements._inputName.value&&t&&1===t.length?e.buttons.Save.disabled=!1:e.buttons.Save.disabled||(e.buttons.Save.disabled=!0)},_grabRealWorldLocationInformation:function(){var i=this;this.buttons.Save.elements.button.addClassName("loading");var n=i.elements.mainDiv.getElementsByClassName("DELWebRealWorldLocationManagerDlg-RWLTable");n&&1===n.length&&(n=n[0]),n&&s.mask(n,h.get("Loading"));var o=i.options.dsModel.ReferencePhysicalid||i.options.dsModel.physicalid,a={physicalid:o,OXID:i.options.dsModel.ReferenceOXID||i.options.dsModel.OXID};t.getPointCloudAssociationForResource(a).then((function(a){if((n=i.elements.mainDiv.getElementsByClassName("DELWebRealWorldLocationManagerDlg-RWLTable"))&&1===n.length&&(n=n[0]),a&&a[o]&&!e.Object.isEmptyObject(a[o])){var l=a[o].repReference;i.options||(i.options={}),i.options.associatedRepReference=l;var r=l.V_Name;i.elements._inputName.value=r;var d=l.V_description;i.elements._inputDescription.value=d;var c=e.String.escapeHTML(i.options.dsModel.label||i.options.dsModel.V_Name);i.title=h.get("Edit Association of Real World Location Data to {0}",{0:c}),i.buttons.Save.label=h.get("Save"),i.buttons.Ok.show();var u=l["V_PointCloudIdentifier.serviceId"]||"r2vsurvey",m=l["V_PointCloudIdentifier.objectId"];u&&m||!l.VPMPointCloudIdentifierExt||(u=u||l.VPMPointCloudIdentifierExt.serviceId||"r2vsurvey",m=m||l.VPMPointCloudIdentifierExt.objectId);var g={serviceId:u,ids:[m]};t.getStateOrFOIInfoForR2VObjects(g).then((function(o){var a=null,l=null,r=o[m];if(!r&&o&&e.each(o,(function(e,t){m===(t.cslId||t["ds6w:i3dx"])&&(r=t,m=t.resourceid)})),r.invalid_permission_r2vObject)"cslid"in r&&!r.cslid&&m?r.cslid=m:"ds6w:i3dx"in r&&!r["ds6w:i3dx"]&&m&&(r["ds6w:i3dx"]=m),i._displayNoPermissionsMessage(r);else if(e.String.contains(r.type,"Activity")||e.String.contains(r.type,"State")){e.String.contains(r.type,"State")&&p.displayNotificationMessage(h.get("The objects dropped are of a deprecated type that will be removed soon."));var d=r.featureOfInterestId;!d&&r&&r.resourceid&&(d=r.resourceid);var c={serviceId:u,ids:[d]};t.fetchFOIInfo(c).then((function(n){e.log("1 "+d),e.log("2 "+n),e.log("3 "+JSON.stringify(n)),a=n[d];var s={serviceId:u,id:a.id};t.getLocationStatesForFOI(s).then((function(t){l=t,i.openedFromDrop||l[m]&&(l[m].droppedObj=!0),l[m]&&(l[m].currentAssociation=!0,i.options.currentAssociation=e.clone(l[m])),i._populateRWLTable(a,l)}))}))}else if(e.String.contains(r.type,"Interest")){a=r,i.openedFromDrop||(a.droppedObj=!0),a.currentAssociation=!0,i.options.currentAssociation=e.clone(a);var g={serviceId:u,id:r.id};t.getLocationStatesForFOI(g).then((function(e){l=e,i._populateRWLTable(a,l)}))}else p.displayNotificationMessage(h.get("Unknown Real World Location type")),n&&s.unmask(n)}))}else i.enableDisableSaveButton(),n&&s.unmask(n);i.buttons.Save.elements.button.removeClassName("loading")}))},_displayNoPermissionsMessage:function(e){var t=this,i=t.elements.mainDiv.getElementsByClassName("DELWebRealWorldLocationManagerDlg-RWLTable");e&&e.invalid_permission_r2vObject&&e["ds6w:i3dx"]?t._associatedR2VCslId=e["ds6w:i3dx"]:e&&e.invalid_permission_r2vObject&&e.cslid&&(t._associatedR2VCslId=e.cslid),s.unmask(i[0]),t.elements.mainDiv.getElementsByClassName("DELWebRealWorldLocationManagerDlg-SearchDirections")[0].remove();var n=document.createTextNode(h.get("Real World Location data is associated to this Resource, however you do not have permissions to access it.")),o=document.createElement("p"),a=document.createElement("span");a.classList.add("icon-main");var l=window.Configuration.webappsDir+"/DELWebAssetMgmt/assets/I_StandardWarning.png";a.setAttribute("src",l),a.style.height="32px",a.style.width="auto",o.classList.add("DELWebRealWorldLocationManagerDlg-nor2vObject_warning"),o.appendChild(a),o.appendChild(n),i[0].appendChild(o)},onAssociate:function(){var i=this;if(this.elements._inputName&&this.elements._inputDescription)if((this.elements._inputName.value||"").trim())if(this.elements._uwaTree&&this.elements._uwaTree.getNodesXSO&&!this.elements._uwaTree.getNodesXSO().isEmpty())if(1===this.elements._uwaTree.getNodesXSO().get().length){var n=this.elements._uwaTree.getNodesXSO().get()[0],s={V_Name:this.elements._inputName.value.trim(),V_description:(this.elements._inputDescription.value||"").trim(),target_physicalid:this.options?this.options.dsModel.ReferencePhysicalid||this.options.dsModel.physicalid:null,"V_PointCloudIdentifier.objectId":n.options.dsModel?n.options.dsModel["ds6w:i3dx"]||n.options.dsModel.cslId:null,"V_PointCloudIdentifier.serviceId":n.options.dsModel?"r2vsurvey":null};this.buttons.Save.elements.button.addClassName("loading"),this.buttons.Save.disabled=!0,t.createPointCloudAssociationForResource(s).then((function(){var t=h.get("'{0}' successfully associated",{0:e.String.escapeHTML(n._options.dsModel.name)});p.displayNotificationMessage(t,{level:"success"}),i.destroy()}),(function(e){e||(e=h.get("Error associating Real World Location data")),p.displayNotificationMessage(e)}))}else p.displayNotificationMessage(h.get("Invalid Point Cloud Data Selection"));else p.displayNotificationMessage(h.get("Missing Point Cloud Data Selection"));else p.displayNotificationMessage(h.get("Missing Name"));else p.displayNotificationMessage("incomplete dialog!")},onDelete:function(){var e=this;(e.options.currentAssociation||e._associatedR2VCslId)&&(e.hideDialog(),e.showConfirmationDialog())},hideDialog:function(){this.elements.container&&this.elements.container.addClassName("wux-ui-animation-flip-out").removeClassName("wux-ui-animation-flip-in")},showDialog:function(){this.elements.container&&this.elements.container.removeClassName("wux-ui-animation-flip-out").addClassName("wux-ui-animation-flip-in"),this.elements._modalDiv&&this.elements._modalDiv.inert&&(this.elements._modalDiv.inert=!1)},showConfirmationDialog:function(t){var n=this;!this._confDialog&&this.options._confDialog&&(this._confDialog=this.options._confDialog),t=Object.assign(t||{},this.options),this._confDialog||(t._createDlg||(t._createDlg=this),t.onConfirm=function(){n.onDeleteConfirm()},this._confDialog=new i(t));var s=h.get("Point Cloud Data");n._associatedR2VCslId?t.confirmationMesssage=h.get("Unassociate the associated {0}?",{0:h.get(s)}):(e.String.contains(n.options.currentAssociation.type,"Interest")?s=h.get("Real World Location"):e.String.contains(n.options.currentAssociation.type,"State")&&(s=h.get("Location State")),t.confirmationMesssage=n.options.currentAssociation.name?h.get("Unassociate {0} '{1}'?",{0:h.get(s),1:e.String.escapeHTML(n.options.currentAssociation.name)}):h.get("Unassociate {0}?",{0:h.get(s)})),this._confDialog.showDialog(t)},getImmersiveFrame:function(){if(!this.immersiveFrame){var e=window.document.getElementsByClassName("wux-windows-immersive-frame");if(e&&e.length)for(var t=0;!this.immersiveFrame&&t<e.length;++t)e[t]&&e[t].dsModel&&(this.immersiveFrame=e[t].dsModel)}return this.immersiveFrame},onDeleteConfirm:function(){var e=this,i={target_physicalid:this.options?this.options.dsModel.ReferencePhysicalid||this.options.dsModel.physicalid:null,repReference_physicalid:this.options&&e.options.associatedRepReference?e.options.associatedRepReference.physicalid:null};t.deletePointCloudAssociationForResource(i).then((function(){var t=h.get("Real World Location association successfully deleted");p.displayNotificationMessage(t,{level:"success"}),e.destroy()}),(function(e){e||(e=h.get("Error deleting Real World Location association")),p.displayNotificationMessage(e)}))},onEditSave:function(){var i=this;if(this.elements._inputName&&this.elements._inputDescription)if((this.elements._inputName.value||"").trim())if(this.elements._uwaTree&&this.elements._uwaTree.getNodesXSO&&!this.elements._uwaTree.getNodesXSO().isEmpty())if(1===this.elements._uwaTree.getNodesXSO().get().length){var n=this.elements._uwaTree.getNodesXSO().get()[0],s={V_Name:this.elements._inputName.value.trim(),V_description:(this.elements._inputDescription.value||"").trim(),target_physicalid:this.options?this.options.dsModel.ReferencePhysicalid||this.options.dsModel.physicalid:null,"V_PointCloudIdentifier.objectId":n.options.dsModel?n.options.dsModel["ds6w:i3dx"]||n.options.dsModel.cslId:null,"V_PointCloudIdentifier.serviceId":n.options.dsModel?"r2vsurvey":null,repReference_physicalid:this.options&&i.options.associatedRepReference?i.options.associatedRepReference.physicalid:null};this.buttons.Save.elements.button.addClassName("loading"),this.buttons.Save.disabled=!0,t.updatePointCloudAssociationForResource(s).then((function(){var t=h.get("Association to '{0}' successfully updated",{0:e.String.escapeHTML(n._options.dsModel.name)});p.displayNotificationMessage(t,{level:"success"}),i.destroy()}),(function(e){e||(e=h.get("Error updating Real World Location association")),p.displayNotificationMessage(e)}))}else p.displayNotificationMessage(h.get("Invalid Point Cloud Data Selection"));else p.displayNotificationMessage(h.get("Missing Point Cloud Data Selection"));else p.displayNotificationMessage(h.get("Missing Name"));else p.displayNotificationMessage("incomplete dialog!")},_initDropEventHandlers:function(){var e=this,t=e.elements._modalDiv||e.elements.container||e.elements.mainDiv||window.widget.body;window.widget.standalone&&window.jQuery&&window.jQuery.fn&&window.jQuery.fn.droppable?(e.options._dndResultsDraggingStart=window.OpenAjax.hub.subscribe("Search.ResultsDragging.start",(function(){window.jQuery(t).addClass("ds_search_result_droppable").droppable({tolerance:"pointer",drop:function(t,i){e.onDrop(t,i)},greedy:!0,over:function(t,i){e.onDragOver(t,i)}})})),e.options._dndResultsDraggingStop=window.OpenAjax.hub.subscribe("Search.ResultsDragging.stop",(function(){window.jQuery(t).hasClass("ui-droppable")&&window.jQuery(t).droppable("destroy"),window.jQuery(t).removeClass("ds_search_result_droppable")}))):(t.addClassName("ds_search_result_droppable"),t.addEventListener("dragover",(function(t){e.onDragOver(t)})),t.addEventListener("drop",(function(t){e.onDrop(t)})))},onDragOver:function(e){e&&e.stopPropagation&&e.stopPropagation(),e&&e.preventDefault&&e.preventDefault()},onDrop:function(i,s){var o=this;i&&i.stopPropagation&&i.stopPropagation(),i&&i.preventDefault&&i.preventDefault();var a=o.options.droppedPointCloudIds||[],l=function(i){e.each(i,(function(i,n){var s=null,a=null;if(n&&n.type&&(e.String.contains(n.type,"Activity")||e.String.contains(n.type,"State"))){e.String.contains(n.type,"State")&&p.displayNotificationMessage(h.get("The objects dropped are of a deprecated type that will be removed soon."));var l=n.featureOfInterestId;!l&&n&&n.resourceid&&(l=n.resourceid);var r=n.id,d={serviceId:"r2vsurvey",ids:[l]};t.fetchFOIInfo(d).then((function(i){if(s=e.clone(i[l])){var d={serviceId:"r2vsurvey",id:s.id};t.getLocationStatesForFOI(d).then((function(t){(a=t)&&!e.Object.isEmptyObject(a)&&(a[r]?a[r].droppedObj=!0:e.each(a,(function(e,t){t["ds6w:i3dx"]===n["ds6w:i3dx"]&&(a[e].droppedObj=!0)}))),o._populateRWLTable(s,a)}))}}))}else if(n&&n.type&&e.String.contains(n.type,"Interest")){(s=e.clone(n)).droppedObj=!0;var c={serviceId:"r2vsurvey",id:n.id};t.getLocationStatesForFOI(c).then((function(e){a=e,o._populateRWLTable(s,a)}))}else n&&n.type&&p.displayNotificationMessage("Unknown Real World Location type")}))},r=function(e){var i={serviceId:"r2vsurvey",ids:e};delete o.options.droppedPointCloudIds,t.getStateOrFOIInfoForR2VObjects(i).then(l)};if(a.length>0){var d=[];e.each(a,(function(e,t){d.push(t.id)})),r(d)}else if(s&&s.draggable&&s.draggable.closest){var c=[];s.draggable.closest(".search_results_container").find(".ui-selected[data-physicalid]").each((function(){a.push({id:window.$(this).attr("data-physicalid")}),c.push(window.$(this).attr("data-physicalid"))})),c.length>0&&r(c)}else n.getUnifiedSearchObjectsFromDrop({ev:i}).then((function(i){if(i&&!e.Object.isEmptyObject(i)){var n=[],s=[],o=[];if(e.each(i,(function(t,i){if(i.type&&(e.String.contains(i.type,"Interest")||e.String.contains(i.type,"Activity")||e.String.contains(i.type,"State")))n.push(i.id);else if("VPMReference"===i.plmBaseObjectType&&i.interfaces){var a=!1;e.each(i.interfaces,(function(t,i){e.each(i,(function(e,t){a=a||"Resource"===t}))})),a?o.push({physicalid:i.physicalid}):s.push(i)}else s.push(i)})),s.length>0&&(1===s.length?p.displayNotificationMessage("1 dropped object is not valid"):p.displayNotificationMessage(s.length+" dropped objects are not valid")),n.length>0&&r(n),o){var a={QueryList:o,Minimum:"True"};t.getPointCloudAssociationForResource(a).then((function(t){var i=0,n=[];e.each(t,(function(s,o){if(e.Object.isEmptyObject(o))i++;else{var a=t[s].repReference,l=a["V_PointCloudIdentifier.objectId"];!l&&a.VPMPointCloudIdentifierExt&&(l=a.VPMPointCloudIdentifierExt.objectId),n.push(l)}})),i&&p.displayNotificationMessage(i>1?h.get("The {0} resources dropped do not have any real world location data associated.",{0:i}):h.get("The resource dropped does not have any real world location data associated.")),n&&n.length>0&&r(n)}))}}}))}});return g}));