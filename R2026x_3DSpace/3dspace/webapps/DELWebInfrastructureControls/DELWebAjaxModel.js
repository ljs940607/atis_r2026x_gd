self&&self.define&&define("DS/DELWebInfrastructureControls/DELWebAjaxModel",["DS/DELWebInfrastructureControls/UWAUtils","UWA/Class","UWA/Promise","DS/WAFData/WAFData","undefined"!=typeof window?"DS/PlatformAPI/PlatformAPI":"","undefined"!=typeof window?"DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices":"DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/i3DXCompassServices","undefined"!=typeof window?"DS/WidgetServices/securityContextServices/SecurityContextServices":"","undefined"!=typeof window?"DS/CoreEvents/Events":"","undefined"!=typeof window?"i18n!DS/DELWebInfrastructureControls/assets/nls/DELWebInfrastructureControls":""],(function(e,t,r,s,i,a,n,o,c){"use strict";var l={},u=self.Configuration&&self.Configuration.webroot?self.Configuration.webroot:null;c||(c={get:function(e){return e}});var d=t.singleton({init:function(t){this._parent&&this._parent.apply(this,arguments),t&&e.Object.isPlainObject(t)&&!e.Object.isEmptyObject(t)&&(this.options=Object.assign(this.options,t)),this._data=void 0!==l?l:{},this._webroot=void 0!==u?u:null,this.setupCompassConfig(),this.setupWebRoot()},setCacheObject:function(t){t&&e.Object.isPlainObject(t)&&(this._data=t)},getCacheObject:function(){return this._data},setupWebRoot:function(){if(this._webroot)return this._webroot;var t=null;if(self.widget&&self.widget.environment&&"uwa"!==self.widget.environment.name&&self.widget.getUrl?t=e.createElement("a",{href:self.widget.getUrl()}):"undefined"!=typeof window&&self===window&&(t=e.createElement("a",{href:self.location.href})),t){var r=t.pathname.indexOf("/",1);this._webroot=r<0?t.pathname:t.pathname.substring(0,r)}e.log("in DELWebResourceParameterModel: initial webroot = "+this._webroot);var s="";return t?(s=t.origin||"")||(t.protocol&&t.hostname?(s=t.protocol+"//"+t.hostname,t.port&&(s+=":"+t.port)):self.steal&&self.steal.isRhino&&(s="http://127.0.0.1")):self.COMPASS_CONFIG&&self.COMPASS_CONFIG.myAppsBaseUrl&&(this._webroot=self.COMPASS_CONFIG.myAppsBaseUrl),"/"!==this._webroot[0]&&self.Configuration&&(this._webroot="/"+self.Configuration.webroot||""),this._webroot=s+this._webroot,void 0!==u&&(u=this._webroot),this._webroot},getReferenceIconPath:function(t){var s=d;return new r((function(r,i){var a=null;s.getServiceUrl({serviceName:"3DSpace"}).then((function(n){if(t)if(t.IconPath)a=(self.Configuration&&self.Configuration.ODT_E4AllDir||n)+"/webapps/"+t.IconPath;else if(t.preview_url||t.type_icon_url)a=t.preview_url||t.type_icon_url;else if(t.iconName){a=(self.Configuration&&self.Configuration.ODT_E4AllDir||n)+"/snresources/images/icons/";var o=t.iconName;"I_VPMNavProduct"===o||"I_PPRProductionPlan"===o||"I_PPRSeqChangeover"===o?(a+="large/",o+="108x144"):a+="small/",a+=o+".png"}else{if(t.plmObjectType&&s._data.dictionaryFromType&&s._data.dictionaryFromType[t.plmObjectType]&&s._data.dictionaryFromType[t.plmObjectType].IconName)return t.iconName=s._data.dictionaryFromType[t.plmObjectType].IconName,s.getReferenceIconPath(t).then(r,i);if(t.plmBaseObjectType&&s._data.dictionaryFromType&&s._data.dictionaryFromType[t.plmBaseObjectType]&&s._data.dictionaryFromType[t.plmBaseObjectType].IconName)return t.iconName=s._data.dictionaryFromType[t.plmBaseObjectType].IconName,s.getReferenceIconPath(t).then(r,i);if(t.plmObjectTypeInternal&&s._data.dictionaryFromType&&s._data.dictionaryFromType[t.plmObjectTypeInternal]&&s._data.dictionaryFromType[t.plmObjectTypeInternal].IconName)return t.iconName=s._data.dictionaryFromType[t.plmObjectTypeInternal].IconName,s.getReferenceIconPath(t).then(r,i);if(t.physicalid&&s._data&&s._data.resource&&s._data.resource[t.physicalid]&&(s._data.resource[t.physicalid].IconName||s._data.resource[t.physicalid].iconName||s._data.resource[t.physicalid].preview_url||s._data.resource[t.physicalid].type_icon_url))return e.each(["IconName","iconName","preview_url","type_icon_url"],(function(e,r){s._data.resource[t.physicalid][r]&&!t[r]&&(t[r]=s._data.resource[t.physicalid][r])})),s.getReferenceIconPath(t).then(r,i);if(!t.forceCache){var c=[];if(t.plmBaseObjectType&&c.indexOf(t.plmBaseObjectType)<0&&c.push(t.plmBaseObjectType),t.plmObjectType&&c.indexOf(t.plmObjectType)<0&&c.push(t.plmObjectType),t.plmObjectTypeInternal&&c.indexOf(t.plmObjectTypeInternal)<0&&c.push(t.plmObjectTypeInternal),t.type&&c.indexOf(t.type)<0&&c.push(t.type),c.length){var l=self.UWA.Json.encode(c);s._data.dictionaryFromType||(s._data.dictionaryFromType={});var u=n+"/resources/dictionary/getTypeInfo?parentInfo=true";return self.Configuration&&self.Configuration.useFixtures&&window.can.fixture&&(u+="&getDictionnaryFromType"),void s.callAuthenticatedRequest(u,"json","POST",l).then((function(n){if(n&&e.Object.isPlainObject(n)&&e.each(c,(function(e,r){r&&n[r]&&n[r].IconName&&(s._data.dictionaryFromType[r]=n[r],t.iconName=n[r].IconName)})),t.iconName)return t.forceCache=!0,s.getReferenceIconPath(t).then(r,i);r&&r(a)}),i)}}}else r(a);r&&r(a)}),i)}))},setupCompassConfig:function(t){var r=d;self.COMPASS_CONFIG||(self.COMPASS_CONFIG={}),self.COMPASS_CONFIG.userId||(self.COMPASS_CONFIG.userId=self.enoviaServerCAWidget&&self.enoviaServerCAWidget.contextUser?self.enoviaServerCAWidget.contextUser:null,!self.COMPASS_CONFIG.userId&&self.Foe&&self.Foe.Model&&self.Foe.Model.Session&&(self.COMPASS_CONFIG.userId=self.Foe.Model.Session.get("user")),!self.COMPASS_CONFIG.userId&&self.widget&&!self.widget.standalone&&i&&i.getUser&&i.getUser()&&(self.COMPASS_CONFIG.userId=i.getUser().login),!self.COMPASS_CONFIG.userId&&self.top&&(self.COMPASS_CONFIG.userId=self.top.dsUserLogin),!self.COMPASS_CONFIG.userId&&self.widget&&self.widget.standalone&&r.useFixtures()&&(self.COMPASS_CONFIG.userId="foe_session_fixture")),self.COMPASS_CONFIG.lang||(self.COMPASS_CONFIG.lang=self.widget&&self.widget.lang||self.$&&self.$.jsperanto&&self.$.jsperanto.lang()),self.COMPASS_CONFIG.myAppsBaseUrl||(r._data&&r._data.platform_services&&r._data.platform_services["3DCompass"]?self.COMPASS_CONFIG.myAppsBaseUrl=r._data.platform_services["3DCompass"]:self.widget&&self.widget.standalone?r._data&&r._data.platform_services&&r._data.platform_services["3DSpace"]?self.COMPASS_CONFIG.myAppsBaseUrl=r._data.platform_services["3DSpace"]:r._webroot&&(self.COMPASS_CONFIG.myAppsBaseUrl=r._webroot):self.COMPASS_CONFIG.userId&&(t&&t.from_getServiceUrl?t&&t.from_getPlatformServices||r.getPlatformServices().then((function(e){e&&e["3DCompass"]&&(self.COMPASS_CONFIG.myAppsBaseUrl=e["3DCompass"])})):r.getServiceUrl({serviceName:"3DCompass"}).then((function(t){if(!t||"string"!=typeof t){if(!self.widget||!self.widget.standalone)return void e.log("invalid 3DCompass URL");self.COMPASS_CONFIG.myAppsBaseUrl?t=self.COMPASS_CONFIG.myAppsBaseUrl:r._data.platform_services&&r._data.platform_services["3DSpace"]&&(t=r._data.platform_services["3DSpace"])}self.COMPASS_CONFIG.myAppsBaseUrl=t}))))},getPlatformServices:function(t){var s=d;return new r((function(r,i){var n=null;if(t||(t={}),!t.platformId&&self.widget&&self.widget.data&&(t.platformId=self.widget.data.x3dPlatformId),s._data.platform_services&&!1!==t.blnCachedOk&&(e.Object.isPlainObject(s._data.platform_services)&&!e.Object.isEmptyObject(s._data.platform_services)||Array.isArray(s._data.platform_services)&&s._data.platform_services.length))return e.Object.isPlainObject(s._data.platform_services)?n=Object.assign({},s._data.platform_services):Array.isArray(s._data.platform_services)&&(n=s._data.platform_services.slice(0)),r(n),n;self.COMPASS_CONFIG&&self.COMPASS_CONFIG.userId||s.setupCompassConfig({from_getPlatformServices:!0}),u&&self.widget&&(self.widget.standalone||self.widget.environment&&"uwa"===self.widget.environment.name)&&(s._data._i3DXCompassPlatformServices_timeout=setTimeout((function(){return delete s._data._i3DXCompassPlatformServices_timeout,(!s._data.platform_services||Array.isArray(s._data.platform_services)&&!s._data.platform_services.length)&&(s._data.platform_services={"3DCompass":u,"6WTags":u,"3DSpace":u,"3DSearch":!1},e.String.contains(self.widget&&self.widget.getUrl(),"TSK9436287=1")&&s.useFixtures()&&(s._data.platform_services.orderdatamgmt=u),e.String.contains(self.widget&&self.widget.getUrl(),"TSK9232963=1")&&s.useFixtures()&&(s._data.platform_services.r2vsurvey=u)),s.getPlatformServices(t).then(r,i)}),5e3)),a.getPlatformServices({platformId:t.platformId,config:self.COMPASS_CONFIG,onComplete:function(t){s._data._i3DXCompassPlatformServices_timeout&&(clearTimeout(s._data._i3DXCompassPlatformServices_timeout),delete s._data._i3DXCompassPlatformServices_timeout);var i=t;t&&t.length&&(i=t[0]),e.String.contains(self.widget&&self.widget.getUrl(),"TSK9436287=1")&&!i.orderdatamgmt&&s.useFixtures()&&(i.orderdatamgmt=u),e.String.contains(self.widget&&self.widget.getUrl(),"TSK9232963=1")&&!i.r2vsurvey&&s.useFixtures()&&(i.r2vsurvey=u),i.r2vsurvey&&!e.String.contains(i.r2vsurvey,"/enovia")&&(i.r2vsurvey+="/enovia"),s._data.platform_services=i,e.Object.isPlainObject(i)?r(Object.assign({},i)):Array.isArray(i)&&r(i.slice(0))},onFailure:function(t){s._data._i3DXCompassPlatformServices_timeout&&(clearTimeout(s._data._i3DXCompassPlatformServices_timeout),delete s._data._i3DXCompassPlatformServices_timeout),s._data.platform_services&&e.Object.isPlainObject(s._data.platform_services)||(s._data.platform_services={"3DCompass":u,"6WTags":u,"3DSpace":u,"3DSearch":null}),i(t)}})}))},getAllCollaborativeSpaces:function(){return new r((function(e,t){self.Foe;n.getInstance().getValidSecurityContext({onSuccess:function(t){if(n&&n._assignedSecurityContextOfLoggedInUser&&n._assignedSecurityContextOfLoggedInUser.length>0){for(var r=n._assignedSecurityContextOfLoggedInUser,s={},i=0;i<r.length;i++){var a=r[i],o=(0===a.indexOf("ctx::")?a.slice(5):a).split(".");if(!(o.length<3)){var c=o[1],l=o.slice(2).join(".").trim()+"/"+a;s[c]||(s[c]={}),s[c][l]=!0}}var u={};for(var d in s)s.hasOwnProperty(d)&&(u[d]=Object.keys(s[d]));e(u)}},onFailure:function(){t(new Error("getSecurityContext"))}})}))},getServiceUrl:function(t){var s=d;return new r((function(r,i){t&&t.serviceName?s._data.platform_services&&s._data.platform_services[t.serviceName]?r(s._data.platform_services[t.serviceName]):(self.COMPASS_CONFIG&&self.COMPASS_CONFIG.userId&&self.COMPASS_CONFIG.myAppsBaseUrl||s.setupCompassConfig({from_getServiceUrl:!0}),!t.platformId&&self.widget&&self.widget.data&&(t.platformId=self.widget.data.x3dPlatformId),a.getServiceUrl({platformId:t.platformId,serviceName:t.serviceName,config:self.COMPASS_CONFIG,onComplete:function(i){var a=null;i&&i.length&&(a=1===i.length?i[0].url:i),a||(s._data.platform_services&&s._data.platform_services[t.serviceName]?a=s._data.platform_services[t.serviceName]:!self.widget||!self.widget.standalone||t.platformId&&"onpremise"!==t.platformId.toLowerCase()||("3DSpace"===t.serviceName||"r2vsurvey"===t.serviceName&&s.useFixtures()&&u.endsWith("/DELWebInfrastructure"))&&(a=u)),a&&"r2vsurvey"===t.serviceName&&!e.String.contains(a,"/enovia")&&(a+="/enovia"),(!s._data.platform_services||e.Array.isArray(s._data.platform_services)&&!s._data.platform_services.length)&&(s._data.platform_services={}),s._data.platform_services[t.serviceName]=a,r(a)},onFailure:function(a){self.widget&&self.widget.standalone&&s._data.platform_services&&!e.Object.isEmptyObject(s._data.platform_services)?(e.log("DELWebResourceParameterModel::getServiceURL - onFailure A"),s._data.platform_services[t.serviceName]||(s._data.platform_services[t.serviceName]=null,"3DSpace"!==t.serviceName||t.platformId&&"onpremise"!==t.platformId.toLowerCase()||(s._data.platform_services[t.serviceName]=u)),r(s._data.platform_services[t.serviceName])):i(a)}})):i(new Error("invalid input params"))}))},request:s.request,callAuthenticatedRequest:function(t,i,a,o,c,l,u){var f=d;return new r((function(r,u){var p=self.Foe,m=self.sec_context;f._getSecurityContext().then((function(_){if(!(m=_)&&(!self.widget||!self.widget.standalone)&&n)return n.getInstance().getSecurityContext({onSuccess:function(e){if(e&&e.SecurityContext)return self.widget?self.widget.setValue("pad_security_ctx",e.SecurityContext):self.sec_context=e.SecurityContext,f.callAuthenticatedRequest(t,i,a,o,c,l).then(r,u);u(new Error("getSecurityContext"))},onFailure:function(){u(new Error("getSecurityContext"))}});for(;m&&e.String.contains(m,"ctx::ctx::");)m=m.replace("ctx::ctx::","ctx::");self.COMPASS_CONFIG&&self.COMPASS_CONFIG.userId||f.setupCompassConfig();var y=self.COMPASS_CONFIG.userId||"";if(!y&&p&&p.Model&&p.Model.Session){if(!m)for(m=p.Model.Session.get("security_ctx");m&&e.String.contains(m,"ctx::ctx::");)m=m.replace("ctx::ctx::","ctx::"),p.Model.Session.set("security_ctx",m);y||(y=p.Model.Session.get("user"))}var g=self.COMPASS_CONFIG.lang||"";!g&&self.widget&&(g=self.widget.lang),l&&l.SecurityContext&&(m=l.SecurityContext.replace("ctx::",""));var h={Accept:"application/json","Accept-Language":g,"Content-Type":!o||o.constructor&&("FormData"===o.constructor.name||o instanceof self.FormData)?null:"application/json; charset=UTF-8",SecurityContext:m,SecurityToken:y+"|"+m+"|preferred"};f._data.platform_services&&f._data.platform_services["3DSearch"]&&0===t.indexOf(f._data.platform_services["3DSearch"])?(delete h.SecurityContext,delete h.SecurityToken):f._data.platform_services&&f._data.platform_services.orderdatamgmt&&0===t.indexOf(f._data.platform_services.orderdatamgmt)?delete h.SecurityToken:f._data.platform_services&&f._data.platform_services.r2vsurvey&&0===t.indexOf(f._data.platform_services.r2vsurvey)&&(delete h.SecurityContext,delete h.SecurityToken),l&&e.Object.isPlainObject(l)&&e.Object.assign(h,l);var v=null;self.widget&&!self.widget.standalone?v=e.Data.proxies.passport?"passport":"ajax":self.widget||(v="passport"),self.jQuery&&0==self.jQuery.active++&&self.jQuery.event.trigger("ajaxStart"),s.authenticatedRequest(t,{proxy:v,timeout:12e4,type:i,method:a,async:!0,headers:h,data:o,onComplete:function(t){var s=null;if(t&&"json"===i.toLowerCase()&&"string"==typeof t&&e.String.contains(t,"{")&&(t=JSON.parse(t)),t&&t.infos&&t.infos.sources&&1===t.infos.sources.length&&t.infos.sources[0].error&&"FS_AUTHENTICATION_ERROR__REDIRECT"===t.infos.sources[0].error.errorCode)return s=t.infos.sources[0].error.errorMessage||t.infos.sources[0].error.errorCode,u(s?new Error("Invalid auth: "+s):new Error("Invalid auth")),e.log("Invalid auth: "+s),e.log("-- Details: "+t.infos.sources[0].error.errorCode),d.publish("Auth.LoginRequired",t.infos.sources[0]),u(new Error(s)),!1;if(t&&t.error&&c&&e.Function.isFunction(c)&&"CLOUDVIEW_ERROR__SUMMARY"===t.error.errorCode&&t.error.errors&&t.error.errors.length){var a=!1;return e.each(t.error.errors,(function(e,t){return!(a=t&&"CLOUDVIEW_ERROR__INVALID_ROOTS"===t.errorCode)})),a?c(t):u(new Error(t.error)),!1}if(t&&t.error)return s=t.error.errorMessage||t.error.errorCode||"Authenticated Request Error",e.log("Authenticated Request Error: "+s),u(new Error(t.error)),!1;r(t),self.jQuery&&! --self.jQuery.active&&self.jQuery.event.trigger("ajaxStop")},onFailure:function(t,r){if(e.log("Error"),self.jQuery&&! --self.jQuery.active&&self.jQuery.event.trigger("ajaxStop"),r){if("invalid_grant"===r.error){var s=r.error_description?r.error_description:t||"";return u(s?new Error("Invalid auth: "+s):new Error("Invalid auth")),e.log("Invalid auth: "+s),t&&e.log("-- Details: "+t),d.publish("Auth.LoginRequired",r),!1}!r.message&&r.error&&e.Object.isPlainObject(r.error)&&(r.error.errorMessage?r.message=r.error.errorMessage:e.each(r.error,(function(e,t){r.message?r.message+="\n"+e+": "+t:r.message=e+": "+t})))}r&&(r.message||r.error)?u(r instanceof Error?r:new Error(r.message||r.error)):t&&(t.message||t.error)?u(t instanceof Error?t:new Error(t.message||t.error)):u(new Error(o))}})}))}))},_getSecurityContext:function(){return new r((function(e){var t=null;self.widget&&(t=self.widget.getValue("pad_security_ctx")||self.widget.getValue("collabSpace")||self.widget.getValue("Credentials")||self.Foe&&self.Foe.Model&&self.Foe.Model.Session&&self.Foe.Model.Session.get("security_ctx")),!t&&self.sec_context&&(t=self.sec_context),t&&0===t.indexOf("ctx::")&&(t=t.substring(5)),e(t)}))},publishEvent:function(e,t){self.OpenAjax&&self.OpenAjax.hub.publish(e,t);var r={event:e};t&&(r.data=t),this.options&&this.options.modelEvents?this.options.modelEvents.publish(r):o&&o.publish(r)},subscribeEvent:function(e,t){var r=e;return"object"!=typeof e&&(r={event:e}),this.options&&this.options.modelEvents?this.options.modelEvents.subscribe(r,t):o?o.subscribe(r,t):null},unsubscribeEvent:function(e){this.options&&this.options.modelEvents?this.options.modelEvents.unsubscribe(e):o&&o.unsubscribe(e)},getReference:function(t){var s=this;return new r((function(r,i){var a={R:Math.random(),class_name:t.class_name?t.class_name:"PRODUCTCFG/VPMReference",Depth:t.Depth||t.depth||0,Minimum:"Minimum"in t?t.Minimum:"True",SkipCheckingResource:!0,ClearServerCache:!!t.blnForceRefresh&&t.blnForceRefresh};e.each(["OXID","PLM_ExternalID","physicalid","search_str","startindex","endindex","class_name","Extensions","SkipCheckingResource","ClearServerCache","searchByAttribute"],(function(e,r){r in t&&(a[r]=t[r])})),a.Minimum instanceof Array&&(a.Minimum=JSON.stringify(a.Minimum)),!("searchByAttribute"in a)&&t.Discipline&&(a.searchByAttribute='{"V_discipline":"'+t.Discipline+'"}'),s.getServiceUrl({serviceName:t.serviceName||"3DSpace"}).then((function(n){var o=n+"/resources/DELWebInfrastructureLite/v0/referenceFinder";t.fixtureTag&&"string"==typeof t.fixtureTag&&(o+="?"+t.fixtureTag),s.callAuthenticatedRequest(o,"json","GET",a).then((function(n){var o=s.commonAjaxJsonResponseOK(n,i);if(!o)return o;var u="VPMReference";if(t.class_name&&(u=t.class_name.substr(t.class_name.indexOf("/")+1)),n&&n[u]){var d=n[u],f=!1,p=(t.search_str||"").replace("*","");!f&&s.useFixtures()&&p&&p.length&&(e.each(d,(function(e,r){(r.V_Name===p||r.PLM_ExternalID===p||t.search_str.indexOf("*")>0&&r.V_Name&&0===r.V_Name.indexOf(p))&&(f=r)})),f||e.each([l.resource,l.parameter_list,l.parameter],(function(r,s){e.each(s||[],(function(e,r){return r&&!r.ReferenceOXID&&!r.ReferencePhysicalid&&r.V_Name&&(r.V_Name===p?(d.unshift(r),f=r):t.search_str.indexOf("*")>0&&0===r.V_Name.indexOf(p)&&d.unshift(r)),!f}))}))),e.each(d,(function(r,i){if(s.removeNullAttributes(i),i.MatchResult&&!f&&s.useFixtures()&&t.search_str&&t.search_str.length&&!f&&("DELRmiResourceModel/Resource"===a.Extensions||a.Extensions.indexOf(i.V_discipline)>=0)&&p&&!f){var n=Object.assign({},i);n.PLM_ExternalID=p.replace("*",""),i.children&&!e.Object.isEmptyObject(i.children)&&(n.children=i.children),d.unshift(n),f=n}})),r(d)}else i(c.get("Error"))}),i)}),i)}))},getTree:function(t){var s=this;return new r((function(r,i){if(!t)return e.log("getTree: params must be specified"),void i(new Error("params must be specified"));if(!(t.PLM_ExternalID||t.physicalid||t.OXID||t.QueryList))return e.log("getTree: Either QueryList, PLM_ExternalID, physicalid or OXID must be specified inside params"),void i(new Error("Either QueryList, PLM_ExternalID, physicalid or OXID must be specified inside params"));if(t.QueryList&&(!t.QueryList.length||!(t.QueryList instanceof Array)))return e.log("getTree: QueryList Must be an array with at least one item in it"),void i(new Error("QueryList Must be an array with at least one item in it"));var a=function(e){var t=null;void 0!==e.Minimum&&(t=e.Minimum instanceof Array?e.Minimum.slice(0):e.Minimum);var r=null,i=s.FindPLMObjectInCache(e,"True");return i?(r=void 0!==t?t:["physicalid","V_Name"],i=s.FindPLMObjectInCache(e,r)):null};s.getServiceUrl({serviceName:"3DSpace"}).then((function(n){var o=n+"/resources/DELWebInfrastructureLite/v0/resource/expand?getTree",c={R:Math.random(),url:o,class_name:t.class_name?t.class_name:"PRODUCTCFG/VPMReference",Depth:t.Depth?t.Depth:"0",Minimum:t.Minimum?t.Minimum:"True",QueryList:t.QueryList?t.QueryList:void 0};e.each(["OXID","physicalid","PLM_ExternalID"],(function(){var e=this.toString();t[e]&&(c[e]=t[e])}));var l={},u=[],d=function(t){if(void 0!==t.CurrentDepth&&t.CurrentDepth>t.Depth)t.CurrentDepth-=1;else{void 0!==t.CurrentDepth?t.CurrentDepth+=1:t.CurrentDepth=0;var r=a(t);if(null!==r){if(t.CurrentDepth===t.Depth)l[r.physicalid||r.OXID]=r;else if(void 0!==r.children){var s=!0;e.each(r.children,(function(e,t){var r={physicalid:t.physicalid,OXID:t.OXID,PLM_ExternalID:t.PLM_ExternalID},i=a(r);i?a({physicalid:i.ReferencePhysicalid,OXID:i.ReferenceOXID})||(s=!1):s=!1})),s?(l[r.physicalid||r.OXID]=r,e.each(r.children,(function(e,r){var s=a(r),i=a({physicalid:s.ReferencePhysicalid,OXID:s.ReferenceOXID});if(l[s.physicalid||s.OXID]=s,i){var n={physicalid:i.physicalid,OXID:i.OXID,PLM_ExternalID:i.PLM_ExternalID,CurrentDepth:t.CurrentDepth,Depth:t.Depth?t.Depth:0};d(n)}else u.push({PLM_ExternalID:t.PLM_ExternalID,physicalid:t.physicalid,OXID:t.OXID,Depth:t.Depth?t.Depth-t.CurrentDepth:0})}))):(t.PLM_ExternalID||t.physicalid||t.OXID)&&u.push({PLM_ExternalID:t.PLM_ExternalID,physicalid:t.physicalid,OXID:t.OXID,Depth:t.Depth?t.Depth-t.CurrentDepth:0})}}else(t.PLM_ExternalID||t.physicalid||t.OXID)&&u.push({PLM_ExternalID:t.PLM_ExternalID,physicalid:t.physicalid,OXID:t.OXID,Depth:t.Depth-t.CurrentDepth});t.CurrentDepth-=1}},f=Object.assign({},c);f.QueryList?e.each(f.QueryList,(function(e,t){d(t)})):d(f);var p=function(t,a){s.callAuthenticatedRequest(t,"json","GET",a).then((function(t){var a=s.commonAjaxJsonResponseOK(t,i);if(!a)return a;if(t&&t.Data){var n=Object.assign(t.Data,l);e.each(n,(function(e,t){t.plmBaseObjectType&&("DELSCPLogisticsSiteRef"===t.plmObjectTypeInternal?t._objectType="workcenter":"DELSSerializedItem"===t.plmObjectTypeInternal||"VPMReference"===t.plmBaseObjectType&&("Ext(PLMDELMIAModeler/DELSerialNumber).V_SerialNumber"in t||"V_SerialNumber"in t)?t._objectType="execution_resource":"DELSAssetGroup"===t.plmBaseObjectType||"VPMReference"===t.plmBaseObjectType&&"WorkCenter"===t.V_discipline?t._objectType="execution_resource_group":"DELSAssetPool"===t.plmBaseObjectType||"VPMReference"===t.plmBaseObjectType&&"Pool"===t.V_discipline?t._objectType="execution_resource_pool":"DELLmiProductionSystemReference"===t.plmBaseObjectType&&"DELLmiProductionPlanReference"===t.plmObjectTypeInternal?t._objectType="execution_production_plan":"DELLmiWorkPlanSystemReference"===t.plmBaseObjectType||"DELLmiWorkPlanSystemReference"===t.plmObjectTypeInternal||"DELLmiHeaderWorkPlanReference"===t.plmBaseObjectType||"DELLmiHeaderWorkPlanReference"===t.plmObjectTypeInternal?t._objectType="workplan":"DELLmiProductionSystemReference"===t.plmBaseObjectType||"DELLmiOperationReference"===t.plmBaseObjectType?t._objectType="process":"DELFmiFunctionReference"===t.plmBaseObjectType?t._objectType="mbom":"DELResourceParameterListReference"===t.plmBaseObjectType?t._objectType="resource_parameter_list":"DELResourcePrm"===t.plmBaseObjectType||"DELResourcePrmINPUT"===t.plmBaseObjectType||"DELResourcePrmOUTPUT"===t.plmBaseObjectType||"DELResourceParameter"===t.plmBaseObjectType?t._objectType="resource_parameter":"R2V_FeatureOfInterest"===t.plmBaseObjectType||"R2V_FeatureState"===t.plmBaseObjectType?t._objectType="r2v_point_cloud_data":["ResourceWarehouseReference","ResourceWarehouseZoneReference","ResourceWarehouseLocationReference"].indexOf(t.plmBaseObjectType)>=0?t._objectType="warehouse":"VPMReference"===t.plmBaseObjectType&&(t._objectType="resource"))})),r(n)}else t&&t.error&&t.error.msg&&t.error.msg.text&&i(t.error.msg.text)}),i)},m=null;if(Object.keys(u).length>0)delete c.PLM_ExternalID,delete c.OXID,delete c.physicalid,c.Minimum&&c.Minimum.constructor===Array&&(m=c.Minimum,c.Minimum=JSON.stringify(m)),c.QueryList=JSON.stringify(u),p(o,c);else if(Object.keys(l).length>0){var _={Data:Object.assign({},l)};r(_.Data)}else{if(c.Minimum&&c.Minimum.constructor===Array&&(m=c.Minimum,c.Minimum=JSON.stringify(m)),c.QueryList&&c.QueryList instanceof Object){var y=c.QueryList;c.QueryList=JSON.stringify(y)}p(o,c)}}),i)}))},getInstance:function(t){var s=this;return new r((function(r,i){return t?t.PLM_ExternalID||t.physicalid||t.OXID||t.QueryList?!t.QueryList||t.QueryList.length&&t.QueryList instanceof Array?void s.getServiceUrl({serviceName:"3DSpace"}).then((function(a){var n=a+"/resources/DELWebInfrastructureLite/v0/instanceFinder";t.Minimum&&"string"==typeof t.Minimum&&"false"!==t.Minimum.toLowerCase()&&"true"!==t.Minimum.toLowerCase()&&(t.Minimum=[t.Minimum]),t.Minimum instanceof Array&&t.Minimum.indexOf("name")>-1&&-1===t.Minimum.indexOf("PLM_ExternalID")&&t.Minimum.push("PLM_ExternalID");var o={R:Math.random(),url:n,Minimum:"Minimum"in t?t.Minimum:"True",blnForceRefresh:"blnForceRefresh"in t?t.blnForceRefresh:"false"};e.each(["physicalid","OXID","PLM_ExternalID","QueryList"],(function(e,r){t[r]&&(o[r]=t[r])})),s.callAuthenticatedRequest(n,"json","GET",o).then((function(e){var a=s.commonAjaxJsonResponseOK(e,i);if(!a)return a;if(e&&e.Data){var n={PLMData:e.Data};t.blnForceRefresh&&s.publishEvent("Resource.refresh.done",Object.assign({},n)),r(n)}else e&&(e.error&&e.error.msg&&e.error.msg.text?i(new Error(e.error.msg.text)):i(new Error("invalid response from server")))}),i)})):(e.log("getInstance: QueryList Must be an array with at least one item in it"),void i(new Error("QueryList Must be an array with at least one item in it"))):(e.log("getInstance: Either QueryList, PLM_ExternalID, physicalid or OXID must be specified inside params"),void i(new Error("Either QueryList, PLM_ExternalID, physicalid or OXID must be specified inside params"))):(e.log("getInstance: params must be specified"),void i(new Error("params must be specified")))}))},getResourceDisciplines:function(t){var s=this;return new r((function(r,i){if(t||(t={}),s._data&&s._data.childrenArrayInterfaces&&(!("blnCachedOk"in t)||t.blnCachedOk)){var a={},n=!1;if(t.V_discipline?Array.isArray(t.V_discipline)?(n=!0,e.each(t.V_discipline,(function(e,t){return s._data.childrenArrayInterfaces[t]?a[t]=s._data.childrenArrayInterfaces[t].slice(0):n=!1,n}))):s._data.childrenArrayInterfaces[t.V_discipline]&&(a[t.V_discipline]=s._data.childrenArrayInterfaces[t.V_discipline].slice(0),n=!0):s._data.childrenArrayInterfaces.Resource&&(a.Resource=s._data.childrenArrayInterfaces.Resource.slice(0),n=!0),t.blnIncludeParent){var o=t.V_discipline||"Resource";s._data.interfaceDetails&&s._data.interfaceDetails[o]?(a[o]||(a[o]=[]),a[o].push(Object.assign({},s._data.interfaceDetails[o]))):n=!1}if(n)return t.addAdditionalDisciplines&&s._data.childrenArrayInterfaces.AdditionalDisciplines&&(a.AdditionalDisciplines=Object.assign({},s._data.childrenArrayInterfaces.AdditionalDisciplines)),void r(a)}var l={R:Math.random(),class_name:t.class_name?t.class_name:"PRODUCTCFG/VPMReference",Extensions:t.Extensions?t.Extensions:"DELRmiResourceModel/Resource"};t.blnIncludeParent&&(l.blnIncludeParent="True"),"DELRmiResourceModel/Area"!==l.Extensions&&"Area"!==t.V_discipline&&"Area"!==t.disciplineName||(l.Extensions="DELRmiResourceModel/ResourceArea");var u=t.V_discipline||t.disciplineName;Array.isArray(u)&&(u=JSON.stringify(u)),u&&(l.V_discipline=u),s.getServiceUrl({serviceName:"3DSpace"}).then((function(a){var n=a+"/resources/DELWebInfrastructure/v0/interface/getImmediateDerivative?getDisciplines";s.callAuthenticatedRequest(n,"json","GET",l).then((function(a){var n=s.commonAjaxJsonResponseOK(a,i);if(!n)return n;if(a&&a.Data){e.each(a.Data,(function(r,i){if("name"===r||!Array.isArray(i))return delete a.Data[r],!0;e.each(i,(function(e,t){t&&t.nlsName&&(t.name&&(c["V_discipline."+t.name]=t.nlsName),t.disciplineName&&(c["V_discipline."+t.disciplineName]=t.nlsName))}));var n=i.slice(0);if(s._data||(s._data={}),s._data.childrenArrayInterfaces||(s._data.childrenArrayInterfaces={}),t.blnIncludeParent){var o=-1;e.each(n,(function(e,t){return t.name===r&&(o=e),o<0})),o>=0&&n.splice(o,1)}return s._data.childrenArrayInterfaces[r]=n,s._data.interfaceDetails||(s._data.interfaceDetails={}),e.each(i,(function(e,t){if(!s._data.interfaceDetails[t.name]){if(!t.IconPath&&t.LargeIconPath)t.IconPath=t.LargeIconPath;else if(t.IconPath&&!t.LargeIconPath){var r=t.IconPath.substring(t.IconPath.lastIndexOf("/")+1,t.IconPath.lastIndexOf("."));["I_DELRMAreaSystem","I_DELRMControlDeviceSystem","I_DELRMConveyorSystem","I_DELRMIndustrialMachineSystem","I_DELRMInspectSystem","I_DELRMLogicControllerSystem","I_DELRMManufacturingSetupSystem","I_DELRMNCMachineSystem","I_DELRMOrganizationalSystem","I_DELRMRobotSystem","I_DELRMSensorSystem","I_DELRMStorageSystem","I_DELRMToolDeviceSystem","I_DELRMTransportSystem","I_DELRMUserDefinedSystem","I_DELRMWorkerSystem","I_PPRProductionPlan","I_VPMNavProduct"].indexOf(r)<0?t.LargeIconPath=t.IconPath:t.LargeIconPath=t.IconPath.substr(0,t.IconPath.lastIndexOf("/small/"+r))+"/large/"+r+"108x144.png"}s._data.interfaceDetails[t.name]=Object.assign({},t)}})),!0}));var o=Object.assign({},a.Data);return t.addAdditionalDisciplines&&s._data.childrenArrayInterfaces.AdditionalDisciplines&&(o.AdditionalDisciplines=s._data.childrenArrayInterfaces.AdditionalDisciplines),r(o),!0}}),i)}),i)}))},getExtensions:function(t){var s=this;return new r((function(i,a){t||(t={});var n={R:Math.random(),class_name:t.class_name?t.class_name:"PRODUCTCFG/VPMReference"};Array.isArray(n.class_name)&&(n.class_name=JSON.stringify(n.class_name)),"Extensions"in t&&(n.Extensions=t.Extensions?t.Extensions:"DELRmiResourceModel/Resource"),Array.isArray(n.Extensions)&&(n.Extensions=JSON.stringify(n.Extensions)),t.blnIncludeParent&&(n.blnIncludeParent="True"),"DELRmiResourceModel/Area"!==n.Extensions&&"Area"!==t.V_discipline&&"Area"!==t.disciplineName||(n.Extensions="DELRmiResourceModel/ResourceArea");var o=t.V_discipline||t.disciplineName;Array.isArray(o)&&(o=JSON.stringify(o)),o&&(n.V_discipline=o),t.blnCustoOnly&&(n.returnCustoOnly=!0),s._data||(s._data={});var c=JSON.stringify(t);if(!1!==t.blnCachedOk&&!t.blnForceRefresh&&s._data.dictionaryFromType&&s._data.dictionaryFromType["getExtensions-"+c])i&&i(Object.assign({},s._data.dictionaryFromType["getExtensions-"+c]));else{if(s._data.getExtensions_jqXHR){if(s._data.getExtensions_jqXHR[c])return s._data.getExtensions_jqXHR[c].then((function(){return new r((function(e,r){setTimeout((function(){s.getExtensions(t).then(e,r)}),500)})).then(i,a)}))}else s._data.getExtensions_jqXHR={};s.getServiceUrl({serviceName:"3DSpace"}).then((function(r){if(r&&"string"==typeof r){s._data.dictionaryFromType||(s._data.dictionaryFromType={});var o=r+"/resources/DELWebInfrastructure/v0/interface/getImmediateDerivative";s.useFixtures()&&(o+="?getExtensions",t.class_name?Array.isArray(t.class_name)&&t.class_name.length?o+="&"+t.class_name[0]:o+="&"+t.class_name:t.Extensions&&t.Extensions.substr&&(o+="&"+t.Extensions.substr(t.Extensions.lastIndexOf("/")+1))),s._data.getExtensions_jqXHR[c]=s.callAuthenticatedRequest(o,"json","GET",n).then((function(n){s&&s._data&&s._data.getExtensions_jqXHR&&s._data.getExtensions_jqXHR[c]&&delete s._data.getExtensions_jqXHR[c];var o=s.commonAjaxJsonResponseOK(n,a);if(!o)return o;if(n&&n.Data){n&&n.Data&&(n=n.Data);var l=n,u={},d={};if(e.each(l,(function(t,r){(e.Object.isPlainObject(r)||Array.isArray(r))&&(s._data.dictionaryFromType[t]||(s._data.dictionaryFromType[t]={})),r&&r.length&&"name"!==t&&e.each(r,(function(e,r){"isOOTB"in r||(r.isOOTB=r.isOOTB||!r.IsCusto||"false"===r.IsCusto&&(!r.IsSpecialization||"false"===r.IsSpecialization)),t===r.name&&(d[t]=r.nlsName,s._data.dictionaryFromType[t]=Object.assign(s._data.dictionaryFromType[t],r))}))})),t.blnCustoOnly&&e.each(l,(function(t,r){if(Array.isArray(r))for(var s=(r||[]).length-1;s>=0;--s){var i=r[s];i&&e.Object.isPlainObject(i)&&(i.IsCusto||i.isOOTB)||r.splice(s,1)}(!r||r.length<=0)&&delete l[t]})),t.blnGetProperties){s._data.dictionaryFromType[t.class_name]||(s._data.dictionaryFromType[t.class_name]={});var f={classes:Object.keys(n)},p=Object.keys(n);f.classes.indexOf("name")>=0&&(f.classes.splice(f.classes.indexOf("name"),1),p.splice(p.indexOf("name"),1)),f.classes=self.UWA.Json.encode(f.classes),f.classes.length>8e3&&(e.log("DELWebAjaxModel::fix too many lookups at once!"),f.classes=self.UWA.Json.encode(p.slice(0,10)));var m={},_=r+"/resources/DELWebInfrastructure/v0/attributesDictionary";s.useFixtures()&&(_+="?getExtensionProperties",t.class_name?_+="&"+t.class_name:t.Extensions&&t.Extensions.substr&&(_+="&"+t.Extensions.substr(t.Extensions.lastIndexOf("/")+1))),s._data.dictionaryFromType["properties-"+JSON.stringify(f)]&&!1!==t.blnCachedOk&&!t.blnForceRefresh?(s._data.dictionaryFromType["getExtensions-"+c]||(s._data.dictionaryFromType["getExtensions-"+c]=s._data.dictionaryFromType["properties-"+JSON.stringify(f)]),i&&i(Object.assign({},s._data.dictionaryFromType["properties-"+JSON.stringify(f)]))):s._data.getExtensionAttributes_jqXHR=s.callAuthenticatedRequest(_,"json","GET",f).then((function(t){s._data.getExtensionAttributes_jqXHR&&delete s._data.getExtensionAttributes_jqXHR;var r=s.commonAjaxJsonResponseOK(t,a);if(!r)return r;u={},t&&t.results&&t.results.length&&(e.each(t.results,(function(t,r){if(e.each(r.properties,(function(e,t){m[t.name]||(m[t.name]=t)})),r.name&&n[r.name]){var i={};r.name&&(i.name=r.name),i.properties=r.properties||[],n[r.name].push(i)}s._data.dictionaryFromType[r.name]&&(s._data.dictionaryFromType[r.name].name=r.name,s._data.dictionaryFromType[r.name].nlsName=r.nlsName||r.name),u[r.name]=n[r.name]})),s._data.dictionaryFromType.properties=Object.assign(s._data.dictionaryFromType.properties||{},m)),s._data.dictionaryFromType["properties-"+JSON.stringify(f)]=u,s._data.dictionaryFromType["getExtensions-"+c]=u,i(Object.assign({},u))}),a)}else e.each(l,(function(t,r){(e.Object.isPlainObject(r)||Array.isArray(r))&&(u[t]=r),r&&r.length&&"name"!==t&&d&&d[t]&&r&&(u[d[t]]=r)})),s._data.dictionaryFromType["getExtensions-"+c]=u,i(Object.assign({},u));return!0}return a(new Error("Unable to retrieve extensions!")),!1}),a)}else a(new Error("invalid 3DSpace URL"))}),a)}}))},commonAjaxJsonResponseOK:function(t,r){var s=t;s.Root&&(s=s.Root);var i=null;if(!s.auth)return(i=s.msg&&s.msg.text?s.msg.text:"")?r&&(self.$&&self.$(".ds_alert").size()>0||r!==self.alert)&&r("Invalid auth: "+i):r&&(self.$&&self.$(".ds_alert").size()>0||r!==self.alert)&&r("Invalid auth"),e.log("Invalid auth: "+i),s.msg&&s.msg.details&&e.log("-- Details: "+s.msg.details),this.publishEvent("Auth.LoginRequired"),!1;if(!s.license)return(i=s.msg&&s.msg.text?s.msg.text:"")?r&&r(i,{type:"license"}):r&&(c&&c.get?r(c.get("Valid License Required"),{type:"license"}):r("Valid License Required",{type:"license"})),e.log("License Check error: "+i),s.msg&&s.msg.details&&e.log("-- Details: "+s.msg.details),this.publishEvent("Auth.LicenseRequired"),!1;if(s.msg&&"success"!==s.msg.type){i=s.msg&&s.msg.text?s.msg.text:"";var a=s.msg&&s.msg.type?s.msg.type:"";"warning"===a&&(a="notice");var n=s.errorDetails||null;return!n&&s.msg.details&&(n={details:s.msg.details}),i?r&&r(i,n,s):r&&r("DELWebAjaxModel::commonAjaxJsonResponseOK :"+a,s.errorDetails),e.log("Error: "+i),s.msg&&s.msg.details&&e.log("-- Details: "+s.msg.details),!1}return!0},commonAjaxErrorHandler:function(e,t,r,s){var i=d;s||(s=self.alert);var a=e;a&&!a.status&&a.xhr&&a.xhr.status&&(a=a.xhr);var n=t.indexOf("abort")<0;if(504===a.status)n=!1;else if(a.responseText&&0===a.responseText.indexOf("{"))try{var o=JSON.parse(a.responseText);o&&o.error&&"invalid_grant"===o.error&&i.commonAjaxJsonResponseOK(o,s),o.error_description&&(r=o.error_description)}catch(e){}n&&s&&s("error request: "+r)},FindPLMObjectInCache:function(t,r){var s=Object.assign({},t),i=null;return e.each(l,(function(t){if("platform_services"===t||"point_cloud_assoc"===t)return!0;var a,n,o,c=l[t];if(!c||!e.Object.isPlainObject(c)||e.Object.isEmptyObject(c))return!0;if(!i&&s.physicalid&&(i=c[s.physicalid]),!i&&s.OXID&&(i=c[s.OXID]),i){if(!(r&&r instanceof Array))return!r||"string"==typeof r&&"false"===r.toLowerCase()?!0===i.AllAttributesRetrieved?i:null:i;if(a=i,n=r,o=!0,e.each(n,(function(e,t){return o&&(o=a.hasOwnProperty(t)),o})),o)return i}return!i&&void 0})),i},removeNullAttributes:function(t){return t&&e.Object.isPlainObject(t)&&!e.Object.isEmptyObject(t)&&e.each(t,(function(e,r){(null==r||"NULL"===r||!r&&["V_description","V_Description","V_discipline"].indexOf(e)>=0)&&delete t[e]})),t},getPhysicalIDForOXID:function(e){var t="";return!t&&e&&0===e.indexOf("[")&&(t=e.substring(1,e.indexOf(","))),t},useFixtures:function(){return self.Configuration&&self.Configuration.useFixtures||self.widget&&self.widget.getUrl().indexOf("useFixtures=1")>0},addFixture:function(t,r){if(self.$&&self.can&&self.can.fixture)self.can.fixture(t,r);else if(s){s._fixtureData||(s._fixtureData={}),s._fixtureData.overwrites||(s._fixtureData.overwrites=[]);var i=e.clone(t);i.fixture=r,s._fixtureData.overwrites.push(i)}}});if(d.useFixtures()){self.Configuration&&!self.Configuration.webroot&&self.widget&&!self.$&&(self.Configuration.webroot=d.setupWebRoot());var f=function(t){var r=s.request("../DELWebAssetMgmtUI.tst/fixtures/AppsMngt_services.json",{onComplete:function(s){s&&s.platforms&&s.platforms.length&&(e.each(s.platforms,(function(t,r){r&&r.services&&e.each(r.services,(function(t,r){if(r&&r.url){"3dmfgworkorder"!==r.id||e.String.contains(self.widget&&self.widget.getUrl(),"TSK7719527=1")||(r.id+="_DISABLED");var s=r.url;if(s.indexOf("/3DSpace")>0)s=u;else if(s.indexOf("://")>0){var i=s.indexOf("://"),a=s.substr(0,s.indexOf("/",i+3));s=s.replace(a,location.origin)}r.url=s}}))})),r.responseText=JSON.stringify(s)),t.complete(r,r.statusText||(r.xhr?r.xhr.statusText:"success"))},type:"json"})};d.addFixture({type:"get",url:u+"/resources/AppsMngt/api/v1/services"},f),d.addFixture({type:"GET",url:u+"/resources/AppsMngt/api/v1/services"},f),d.addFixture({type:"get",url:u+"/resources/AppsMngt/api/v1/services?cors=true"},f),d.addFixture({type:"GET",url:u+"/resources/AppsMngt/api/v1/services?cors=true"},f),d.addFixture({type:"GET",url:u+"/resources/AppsMngt/api/v1/public/services?cors=true"},f),d.addFixture({type:"get",url:u+"/resources/pno/person/getsecuritycontext"},"../DELWebAssetMgmtUI.tst/fixtures/getSecurityContext.json")}return d}));