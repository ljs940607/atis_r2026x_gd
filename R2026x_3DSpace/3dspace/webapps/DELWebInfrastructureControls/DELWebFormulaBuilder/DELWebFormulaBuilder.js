window.define&&define("DS/DELWebInfrastructureControls/DELWebFormulaBuilder/DELWebFormulaBuilder",["DS/DELWebInfrastructureControls/UWAUtils","DS/Utilities/Dom","DS/Utilities/Array","DS/Controls/SelectionChipsEditor","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Menu/Menu","DS/Utilities/Utils","i18n!DS/DELWebInfrastructureControls/assets/nls/DELWebInfrastructureControls","css!DS/DELWebInfrastructureControls/DELWebInfrastructureControls.css"],(function(e,i,t,n,o,s,l,a){"use strict";var r=["#009DDB","#FF8A2E","#9B2C98","#00AA86","#F564A3","#8DDEE4","#CC092F","#E2D5CC","#6FBC4B","#70036B","#002596","#C6C68B","#7F7F7F","#4EA8B7","#007A4C","#ADADAD","#127277","#6D2815","#000000","#4D62BA","#FEE000"];return n.inherit({name:"DELWebFormulaBuilder",publishedProperties:{formulaDocument:{defaultValue:void 0,type:"object",category:"Model"},parameterDocument:{defaultValue:void 0,type:"object",category:"Model"},elementsTree:{defaultValue:function(){var i=new o({});return this.formulaDocument&&e.each(this.formulaDocument.getRoots(),(function(e,t){if(t){t.options.nodeType||(t.options.nodeType="formula"),t.options.icons&&t.options.icons.length||(t.options.icons=["math-function"]);var n=Object.assign({originTreeNodeModel:t},t.options);i.addRoot(new s(n))}})),this.parameterDocument&&e.each(this.parameterDocument.getRoots(),(function(e,t){if(t){t.options.nodeType||(t.options.nodeType="parameter"),t.options.icons&&t.options.icons.length||(t.options.icons=["math-x-value"]);var n=Object.assign({originTreeNodeModel:t},t.options);i.addRoot(new s(n))}})),i},type:"object",category:"Model"},valueDocument:{defaultValue:new o({}),type:"object",category:"Appearance"},value:{defaultValue:void 0,type:"string",category:"Appearance"},isValid:{defaultValue:!1,type:"boolean",category:"Behavior",noNeedToApplyFlag:!0}},_postBuildView:function(){var e=this;this._parent(),this.elements.container.addClassName(this.name),this._subscribeToEvents(),this._selectionChips&&this._selectionChips.addChip&&!this._selectionChips.addChip_orig&&(this._selectionChips.addChip_orig=this._selectionChips.addChip,this._selectionChips.addChip=function(i){e.selectionChips_addChip(i)})},_subscribeToEvents:function(){var t=this;e.Element.addEvent.call(t._lineEditor.getContent(),"keyup",(function(e){t._manageDelimiterCB(e)})),this._lineEditor.addEventListener("click",(function(e){e.stopPropagation();var i=t._lineEditor.valueToCommit;i||(i=""),t._showPopup(i)})),this._lineEditor.addEventListener("blur",(function(e){e.stopPropagation()})),e.each([this.formulaDocument,this.parameterDocument],(function(e,i){if(i&&i.getModelEvents){var n=i.getModelEvents();n&&n.subscribe&&(n.subscribe({event:"addChild"},(function(){t._updateValueDocument()})),n.subscribe({event:"removeChild"},(function(){t._updateValueDocument()})))}})),this.addEventListener("uncommittedChange",(function(e){e.stopPropagation();var i=t._lineEditor.valueToCommit;i||(i=""),t._showPopup(i)})),this.addEventListener("change",(function(){for(var n=null,o=t._selectionChips.getAllChipsOptions(),l=0;l<o.length;++l){var a=null,r=o[l],p=r.value;if(p&&p.options||(r.label&&(n||(n=t.elementsTree().getRoots().concat([new s({nodeType:"openParenthesis",label:"("}),new s({nodeType:"closeParenthesis",label:")"})])),e.each(n,(function(e,n){if(r.label.toUpperCase()===n.getLabel().toUpperCase()&&(r.label=n.getLabel(),"openParenthesis"===n.options.nodeType||"closeParenthesis"===n.options.nodeType?r.value=new s(n.options):r.value=n,r.id||(r.id="_"+Math.random().toString().substring(2)),n.getIcons().length&&!r.icon&&(r.icon=n.getIcons()[0]),p=n,t._selectionChips.updateChipOptions(l,r),a=t._selectionChips._items[l].associatedChipCellView))if(a.removeClassName("error"),r.icon&&t._selectionChips._items&&t._selectionChips._items[l]){a.querySelectorAll(".wux-ui-3ds:not(.wux-chip-cell-close,.wux-ui-3ds-"+r.icon+")").forEach((function(e){e.remove()}));var o=i.generateIcon(r.icon);o&&!a.querySelector(".wux-ui-3ds-"+r.icon)&&(o.setStyles({height:"12px",width:"12px","line-height":"13px","margin-right":r.label?"":"8px"}),a.prepend(o))}else a.querySelectorAll(".wux-ui-3ds").forEach((function(e){e.remove()}));return!(p&&p.options)}))),p&&p.options)){var c=p.options.nodeType;if("formula"===c)(o.length<l+2||o[l+1].value&&"openParenthesis"!==o[l+1].value.options.nodeType)&&(t._selectionChips.addChips([{label:")",value:new s({nodeType:"closeParenthesis",parentFormula:p,parentFormulaView:t._selectionChips._items[l].associatedChipCellView}),index:l+1},{label:"(",value:new s({nodeType:"openParenthesis",parentFormula:p,parentFormulaView:t._selectionChips._items[l].associatedChipCellView}),index:l+1}]),l+1<o.length&&o.splice(l+1,o.length),o=o.concat(t._selectionChips.getAllChipsOptions().slice(l+1)),t._moveActiveInsertDivToElement(t._selectionChips.elements.container.querySelectorAll(".wux-chip-cell-container")[(l||0)+2]));else{if((a=t._selectionChips._items[l].associatedChipCellView).addClassName(c),"openParenthesis"===c||"closeParenthesis"===c){var u=a.querySelector(".wux-chip-cell-close");u&&u.remove(),i.removeAllEventsOnElement(a),a.removeAttribute("draggable")}if(l>0&&l<o.length-1){var h=a.nextElementSibling||a.nextSibling;h&&h.nodeName&&(h.hasClassName("wux-controls-activeInsertWidget-selectionChips")||"INPUT"===h.nodeName.toUpperCase()&&h.hasClassName(t.name+"-inner-input"))||(h=new e.Element("input",{type:"text",class:t.name+"-inner-input"}),a.after(h),i.addEventOnElement(t,h,"focus",(function(e){t._moveActiveInsertDivToElement(e.target)})))}var d=a.previousElementSibling||a.previousSibling;d&&d.nodeName&&"INPUT"===d.nodeName.toUpperCase()&&d.hasClassName(t.name+"-inner-input")?"openParenthesis"===c&&d.remove():"openParenthesis"!==c&&(d=new e.Element("input",{type:"text",class:t.name+"-inner-input"}),a.before(d),i.addEventOnElement(t,d,"focus",(function(e){t._moveActiveInsertDivToElement(e.target)})))}}else if("error"!==r.icon){r.icon="error",r.id||(r.id="_"+Math.random().toString().substring(2)),t._selectionChips.updateChipOptions(l,r);var m=r.id;t._selectionChips._items[l].associatedChipCellView.hide(),setTimeout((function(){for(var e=t._selectionChips._items.length-1;e>=0;--e)if(t._selectionChips._items[e]&&t._selectionChips._items[e].chipOptions&&t._selectionChips._items[e].chipOptions.id&&t._selectionChips._items[e].chipOptions.id===m){t._selectionChips._items[e].associatedChipCellView.show();break}}),250)}}t._updateValueDocument()})),this.addEventListener("onPostRemove",(function(i){if(i&&i.options&&i.options.chips&&i.options.chips.length){var n=[];e.each(i.options.chips,(function(i,o){if(o&&o.chipOptions&&o.chipOptions.value&&o.chipOptions.value.options&&"formula"===o.chipOptions.value.options.nodeType){var s=t._selectionChips.getAllChipsOptions(),l=!1;e.each(s,(function(e,i){if(!l&&i.value&&i.value.options&&"openParenthesis"===i.value.options.nodeType&&i.value.options.parentFormulaView===o.associatedChipCellView)l=i,n.push(e);else{if(l&&i.value&&i.value.options&&"closeParenthesis"===i.value.options.nodeType&&i.value.options.parentFormulaView===o.associatedChipCellView)return n.push(e),!1;l&&n.push(e)}return!0}))}})),n.length>0&&(n=n.sort((function(e,i){return e-i})).reverse(),t._selectionChips.removeChips(n)),t._selectionChips.getNumberOfChips()<=0&&(t._selectionChips.addLastWidget(t._lineEditor),t._selectionChips.elements.activeInsertDiv&&t._selectionChips.elements.activeInsertDiv.remove());var o=t.getContent().querySelectorAll("."+t.name+"-inner-input + ."+t.name+"-inner-input");o&&o.length&&o.forEach((function(e){e.remove()})),t._selectionChips.elements.activeInsertDiv&&t._selectionChips.elements.activeInsertDiv.previousElementSibling&&t._selectionChips.elements.activeInsertDiv.previousElementSibling.hasClassName(t.name+"-inner-input")&&t._selectionChips.elements.activeInsertDiv.previousElementSibling.remove(),t._updateValueDocument()}}))},_manageDelimiterCB:function(i){if(i&&i.key)switch(i.key){case" ":case"(":case")":var t=e.String.trimRight(this._lineEditor.valueToCommit,"()\\s");this._validateInput(t),""!==t&&this.focus({preventScroll:!0})}},_validateInput:function(e){function i(e){if("string"==typeof e&&e){var i=(this.value||[]).slice(0),n=!0;return this.uniqueValue?n=t.pushUnique(i,e):i.push(e),n?(this._properties.value.value=i,this._selectionChips&&this._selectionChips.addChip({label:e}),this.fire("change"),!0):(this._selectionChips&&this._selectionChips._flashEffectOnChip("ui-modified",i.indexOf(e)),!1)}}if(this._lineEditor&&(this._lineEditor.value="",this._lineEditor.valueToCommit=""),!this.customValidator)return i.call(this,e);var n=this.customValidator(e);if(!(n instanceof Promise))return i.call(this,n);n.then(function(e){i.call(this,e)}.bind(this))},_moveActiveInsertDivToElement:function(i){var t=this;i&&i.parentNode&&t._selectionChips&&(t._selectionChips.elements.activeInsertDiv||(t._selectionChips.elements.activeInsertDiv=new e.Element("div",{class:"wux-controls-activeInsertWidget-selectionChips"})),t._selectionChips.elements.activeInsertDiv.setContent(t._lineEditor),t._selectionChips.removeLastWidget(),i.before(t._selectionChips.elements.activeInsertDiv),t._lineEditor.focus())},_showPopup:function(i){var t=this,n=[],o=[];if(t.valueDocument.getRoots().length?o=this.elementsTree().getRoots():this.formulaDocument&&(o=this.formulaDocument.getRoots(),e.each(o,(function(e,i){i.options.nodeType||(i.options.nodeType="formula"),i.options.icons&&i.options.icons.length||(i.options.icons=["math-function"])}))),e.each(o,(function(e,o){o&&(!i||o.getLabel().toLowerCase().indexOf(i.toLowerCase())>=0)&&n.push({type:"PushItem",title:o.getLabel(),fonticon:{content:"wux-ui-3ds wux-ui-3ds-"+o.options.icons[0],family:"DSFontIcon"},nodeType:o.options.nodeType,action:{callback:function(){t._addFromMenu(o)}}})})),n&&n.length>0){var s=this._lineEditor.elements.container.getBoundingClientRect();const e=a.getDocumentOwner(this.elements.container);l.show(n,{display:undefined,input:"mouse",position:{x:s.left,y:s.bottom},submenu:"auto",targetDocument:e},{onShow:()=>{t.elements.container&&t.elements.container.setAttributeNode(e.createAttribute("is-displaying-menu"))},onHide:()=>{t.elements.container&&t.elements.container.removeAttribute("is-displaying-menu")}})}else l.hide()},_addFromMenu:function(e){var i=this,t=0;if(i._selectionChips.elements.activeInsertDiv&&i._selectionChips.elements.activeInsertDiv.previousElementSibling){var n=i._selectionChips.elements.activeInsertDiv.previousElementSibling;do{n.hasClassName("wux-chip-cell-container")&&(t=(t||0)+1)}while((n=n.previousElementSibling)&&n)}i._selectionChips._items.length>=t&&i._selectionChips._items[t]&&i._selectionChips._items[t].chipOptions&&("error"===i._selectionChips._items[t].chipOptions.icon&&e.getLabel().indexOf(i._selectionChips._items[t].chipOptions.label)>=0?i._selectionChips.removeChip(t):t>0&&"error"===i._selectionChips._items[t-1].chipOptions.icon&&e.getLabel().indexOf(i._selectionChips._items[t-1].chipOptions.label)>=0&&(i._selectionChips.removeChip(t-1),t--)),i._selectionChips.addChip({label:e.getLabel(),value:e,index:t,id:"_"+Math.random().toString().substring(2),icon:e.getIcons()[0]}),i._lineEditor.valueToCommit=i._lineEditor.value="",this._updateValueDocument()},_updateValueDocument:function(){var i=this;i.valueDocument.prepareUpdate(),i.valueDocument.getRoots().length&&i.valueDocument.empty();var t=[],n=i._selectionChips?i._selectionChips.getAllChipsOptions():[],o=null,l=[],a=[];if(e.each(n,(function(r,p){p.index=r;var c=p.value;if(c&&c.options){if("closeParenthesis"===c.options.nodeType){if(!c.options.parentFormula&&r>0&&n[r-1]){var u=r-1;a.length&&(u=a.pop()),n[u]&&n[u].value&&n[u].value.options&&"openParenthesis"===n[u].value.options.nodeType&&(c.options.parentFormula=n[u].value.options.parentFormula,c.options.parentFormulaView=n[u].value.options.parentFormulaView,i._selectionChips._items[r].associatedChipCellView.querySelector(".wux-chip-cell-label").setStyle("color",i._selectionChips._items[u].associatedChipCellView.querySelector(".wux-chip-cell-label").getStyle("color")))}return o&&!o.hasChildren()&&(r>1?t.push(n[r-2]):t.push(p)),void(o=o.getParent()||o)}if("openParenthesis"!==c.options.nodeType){if("formula"===c.options.nodeType||"parameter"===c.options.nodeType){var h="formula"===c.options.nodeType?i.formulaDocument:i.parameterDocument;if(h){var d=!1;if(e.each(h.getRoots(),(function(e,i){return i&&i.getLabel&&i.getLabel()&&(d=i.getLabel()===c.getLabel()),!d})),!d)return p.value=null,void l.push(p)}}var m=Object.assign({},c.options),v=new s(m);o?o.addChild(v):i.valueDocument.addRoot(v),"formula"===m.nodeType&&(o=v),i._setFunctionColor(i._selectionChips._items[r],v.getNodeDepth())}else if(a.push(r),!c.options.parentFormula&&r>0&&n[r-1]&&n[r-1].value){c.options.parentFormula=n[r-1].value,c.options.parentFormulaView=i._selectionChips._items[r-1].associatedChipCellView;var C=c.options.parentFormulaView.querySelector(".wux-ui-3ds");C&&i._selectionChips._items[r].associatedChipCellView.querySelector(".wux-chip-cell-label").setStyle("color",C.getStyle("color"))}}else l.push(p)})),i.valueDocument.pushUpdate(),i.isValid=n.length>0&&0===l.length,this.isValid)t.length>0?(i.isValid=!1,i.fire("invalid",{emptyFunctions:t})):(i.fire("valid"),n&&n.length?i._selectionChips.removeLastWidget():(i._selectionChips.addLastWidget(i._lineEditor),i._selectionChips.elements.activeInsertDiv&&i._selectionChips.elements.activeInsertDiv.remove()));else{if(l&&l.length&&i._selectionChips&&i._selectionChips._items){i.valueDocument.prepareUpdate();var r=i._selectionChips._items;e.each(l,(function(e,t){r&&r.length>t.index+1&&r[t.index].associatedChipCellView&&r[t.index].chipOptions&&t.id===r[t.index].chipOptions.id&&i._addErrorToChipCellView(r[t.index].associatedChipCellView,t)})),i.valueDocument.pushUpdate()}i.fire("invalid",{chips:l})}},_addErrorToChipCellView:function(e,t){var n=i.generateIcon("error");n&&e&&!e.querySelector(".wux-ui-3ds-error")&&(n.setStyles({height:"12px",width:"12px","line-height":"13px","margin-right":t&&t.label?"":"8px"}),e.addClassName("error"),e.prepend(n))},_setFunctionColor:function(i,t){for(var n=this,o=0;o<100&&t>=r.length-1;++o){var s="#"+Math.floor(16777215*Math.random()).toString(16).toUpperCase();"#FFFFFF"!==s&&r.indexOf(s)<0&&r.push(s)}if(i&&i.associatedChipCellView&&t<r.length){var l=i.associatedChipCellView.querySelector(".wux-ui-3ds");l&&l.setStyle("color",r[t]);var a=n._selectionChips.getAllChipsOptions(),p=!1;e.each(a,(function(e,o){var s=null;return!p&&o.value&&o.value.options&&"openParenthesis"===o.value.options.nodeType&&o.value.options.parentFormulaView===i.associatedChipCellView?(p=o,s=n._selectionChips._items[e].associatedChipCellView.querySelector(".wux-chip-cell-label")):p&&o.value&&o.value.options&&"closeParenthesis"===o.value.options.nodeType&&o.value.options.parentFormulaView===i.associatedChipCellView&&(s=n._selectionChips._items[e].associatedChipCellView.querySelector(".wux-chip-cell-label")),s&&s.setStyle("color",r[t]),!p||!s||p!==s}))}return r[t]||""},selectionChips_addChip:function(e){var i=this,t=this._selectionChips,n=[e],o=null,l="error",a=t._preventEventsCpt;if(e&&e.value&&e.value.options&&(l=e.value.options.nodeType),"formula"===l?(t._preventEventsCpt=!0,t._addMultipleChips=!0):"error"===l&&(e.id||(e.id="_"+Math.random().toString().substring(2))),!("index"in e)){var r=this.getContent().querySelector(".wux-controls-activeInsertWidget-selectionChips");for(e.index=0;r&&(r.previousElementSibling||r.previousSibling);)r.hasClassName&&r.hasClassName("wux-chip-cell-container")&&e.index++,r=r.previousElementSibling||r.previousSibling}this._lineEditor&&(this._lineEditor.value="",this._lineEditor.valueToCommit="");var p=t.addChip_orig(e);if("index"in(e=Object.assign(e,p.chipOptions))&&null!==e.index&&!isNaN(e.index)&&t._items&&t._items.length>e.index+1&&t._items[e.index].associatedChipCellView&&t._items[e.index+1].associatedChipCellView){o=i._selectionChips._items[e.index].associatedChipCellView,l&&o.addClassName(l);var c=null,u=null;if(e.index>=0&&t._items[e.index+1]&&t._items[e.index+1].associatedChipCellView){if("formula"!==l){c=t._items[e.index+1].associatedChipCellView;do{if(!((c=c.previousElementSibling||c.previousSibling)&&c.nodeName&&(c.hasClassName("wux-controls-activeInsertWidget-selectionChips")||"INPUT"===c.nodeName.toUpperCase()&&c.hasClassName(i.name+"-inner-input"))))break;u=c}while(c)}u?u.before(o):t._items[e.index+1].associatedChipCellView.before(o)}else t._items[e.index-1].associatedChipCellView.after(o)}if("formula"===l){var h=[{label:")",value:new s({nodeType:"closeParenthesis",parentFormula:e.value,parentFormulaView:t._items[e.index].associatedChipCellView}),index:(e.index||0)+1},{label:"(",value:new s({nodeType:"openParenthesis",parentFormula:e.value,parentFormulaView:t._items[e.index].associatedChipCellView}),index:(e.index||0)+1}];t.addChips(h),i._moveActiveInsertDivToElement(t.elements.container.querySelectorAll(".wux-chip-cell-container")[(e.index||0)+2]),n=n.concat(h),t._preventEventsCpt=a,t._addMultipleChips=!1}else l&&"error"!==l||(o=p?p.associatedChipCellView:null,i._addErrorToChipCellView(o,e));t._addMultipleChips||0===t._preventEventsCpt&&(t.fire("change"),t.fire("onPostAdd",{chips:n}))},setValueFromString:function(i){if(!i||"string"!=typeof i)return e.log("DELWebFormulaBuilder::setValueFromString - invalid input string = "+(i||"")),void this.fire("invalid");var t=(i=(i=(i=(i=i.replace(/\s/g,"")).replace(/\(/g," ( ")).replace(/\)/g," ) ")).replace(/  /g," ").replace(/ ,/g,",").replace(/, /g,",")).trim().split(/[\s,]/);if(t.length<1)return e.log("DELWebFormulaBuilder::setValueFromString - invalid input string = "+(i||"")),void this.fire("invalid");this.value=t},getValueAsString:function(){var i=this,t="";return this.value&&Array.isArray(this.value)&&(t="",e.each(i.value,(function(e,n){t&&[",","(",")"].indexOf(n)<0&&e>0&&[",","("].indexOf(i.value[e-1])<0&&(t+=","),t+=n}))),t}})}));