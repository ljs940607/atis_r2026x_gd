window.define&&define("DS/DELWebInfrastructureControls/DELWebResourceFactoryPlant/DELWebResourceFactoryPlantFacetSection",["DS/Controls/Abstract","UWA/Class","DS/DELWebInfrastructureControls/UWAUtils","UWA/Promise","DS/Controls/Expander","DS/EditPropWidget/facets/Common/FacetsBase","DS/EditPropWidget/buttonsBar/ButtonsBar","DS/EditPropWidget/constants/EditPropConstants","DS/DELWebInfrastructureControls/Mask","DS/DELWebInfrastructureControls/DELWebAjaxModel","DS/DELWebInfrastructureControls/DELWebResourceFactoryPlant/DELWebResourceFactoryPlantModel","DS/DELWebInfrastructureControls/DELWebResourceFactoryPlant/DELWebResourceFactoryPlantAssocDlg","DS/DELWebInfrastructureControls/DELWebNotifications","DS/DataGridView/DataGridView","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Windows/Dialog","DS/Menu/Menu","DS/i3DXCompassPlatformServices/OpenWith","DS/TransientWidget/TransientWidget","DS/Controls/Button","DS/CoreEvents/Events","DS/EditPropWidget/EditPropWidget","DS/EditPropWidget/EditPropComponent","i18n!DS/DELWebInfrastructureControls/assets/nls/DELWebInfrastructureControls","css!DS/DELWebInfrastructureControls/DELWebInfrastructureControls.css"],(function(e,t,o,n,i,s,a,l,d,c,r,u,p,w,h,m,g,f,_,b,y,v,D,M,P){"use strict";var C=e.inherit({_source_model:null,_uwaView:null,init:function(e){if(e&&e.model&&(this._source_model=e.model),!this._source_model||!o.Object.isPlainObject(this._source_model)||o.Object.isEmptyObject(this._source_model))return o.log(this.constructor.fullName+"::init - invalid model!"),void this.destroy();this._initEventHandlers(),this._parent.apply(this,arguments)},_postBuildView:function(e){var t=this;this._parent(),e||(e={}),c&&c.publishEvent&&c.publishEvent("Notification.ODT.LoadingIconShown",{panelSection:t.constructor.fullName}),t._tableObjectContents=[],t._objPlants={};var n={oid:t._source_model.oid,Minimum:["name","V_Name","physicalid","V_TimeZone","V_description"],blnForceRefresh:e.blnForceRefresh||!1};window.Foe&&window.Foe.Model&&window.Foe.Model.Asset&&window.Foe.Model.Asset.addQueryIds?n=t._source_model&&(t._source_model.ReferenceOXID||t._source_model.ReferencePhysicalid)?window.Foe.Model.Asset.addQueryIds(n,{OXID:t._source_model.ReferenceOXID,physicalid:t._source_model.ReferencePhysicalid}):window.Foe.Model.Asset.addQueryIds(n,t._source_model):t._source_model&&(t._source_model.ReferenceOXID||t._source_model.ReferencePhysicalid?(t._source_model.ReferenceOXID&&(n.OXID=t._source_model.ReferenceOXID),t._source_model.ReferencePhysicalid&&(n.physicalid=t._source_model.ReferencePhysicalid)):(t._source_model.OXID&&(n.OXID=t._source_model.OXID),t._source_model.physicalid&&(n.physicalid=t._source_model.physicalid))),r&&r.getAssociatedPlantsForFactoryLayout&&r.getAssociatedPlantsForFactoryLayout(n).then((function(e){t.elements.container.removeClassName("loading");var i=0;e&&!o.Object.isEmptyObject(e)&&e[n.physicalid]&&!o.Object.isEmptyObject(e[n.physicalid])?(i++,t.addCollectionView({success:function(){i--,o.each(e[n.physicalid],(function(e,n){var s=n?n.plant:null;s||!n||o.Object.isEmptyObject(n)||(s=n);var a={Minimum:!0,physicalid:s.physicalid};i++,r.getOne(a).then((function(e){i--,e&&e.IconPath&&(e.IconPath="/"+t._removeLeadingDots(e.IconPath)),s=Object.assign(s,e||{}),c.getServiceUrl({serviceName:"3DSpace"}).then((function(e){s.V_TimeZone||(s["Plant Time Zone"]?s.V_TimeZone=s["Plant Time Zone"]:s.attribute&&s.attribute["Plant Time Zone"]&&(s.attribute["Plant Time Zone"].value?s.V_TimeZone=s.attribute["Plant Time Zone"].value:"string"==typeof s.attribute["Plant Time Zone"]&&(s.V_TimeZone=s.attribute["Plant Time Zone"])));var o=e+"/snresources/images/icons/large/iconManufacturingPlant144.png",n={useAsyncPreExpand:!0,clickableTitle:!0,label:s["attribute.Title"]||s.Title||s.name,dsModel:s,thumbnail:o,description:s.V_description||s.description||"",subLabel:s.V_TimeZone||"",contextualMenu:["info","trash"]};window.widget.standalone||n.contextualMenu.push("open-in-a-new-window"),i++,t.addRootNodesToView([n],(function(){i--,t.editionSwitched({blnEditMode:!0})})),t._tableObjectContents||(t._tableObjectContents=[]),t._tableObjectContents.push(n)}))}))}))}}),!(i<=0)||t._uwaView||t._tableObjectContents&&t._tableObjectContents.length||t.editionSwitched({blnEditMode:!0})):(t.elements.container.removeClassName("loading"),!(i<=0)||t._uwaView||t._tableObjectContents&&t._tableObjectContents.length||t.editionSwitched({blnEditMode:!0}))}),(function(e){p.displayNotificationMessage(e)}))},editionSwitched:function(e){var t=this;(e||(e={}),this._blnEditMode=!0,e.blnEditMode)?t._uwaView||(t.elements.container.getChildren().length>0&&t.elements.container.empty(),new y({label:t._getAssociateButtonLabel(),disabled:!1,onClick:function(){t._associateButtonClicked()}}).inject(t.elements.container).elements.button.addClassName("plant_Associate"),t.elements.container.querySelector(".wux-layouts-responsivecollectionview")&&(t.elements.container.querySelector(".wux-layouts-responsivecollectionview").style.position="relative")):t._uwaView||t.editionSwitched({blnEditMode:!0})},addCollectionView:function(e){var t=this;t._uwaView?e&&e.success&&e.success():require({baseUrl:window.Configuration.webappsDir},["DS/CollectionView/ResponsiveTilesCollectionView","DS/Menu/ContextualMenu"],(function(n,i){if(t._uwaView)e&&e.success&&e.success();else{t._WUXTreeNodeModel||(t._WUXTreeNodeModel=m);t._uwaView=new n({useDragAndDrop:!0}),t._uwaView.onDragStartCell=function(e,n){var i=!1;if(n&&n.nodeModel&&n.nodeModel.options&&n.nodeModel.options.dsModel){e.dndInfos||(e.dndInfos=n);var s={protocol:"3DXContent",source:window.widget.data&&window.widget.data.appId?window.widget.data.appId:"DELFAMC_AP",version:"2.0",widgetId:window.widget.id,data:{items:[]}},a=window.widget.getValue("pad_security_ctx")||window.widget.getValue("collabSpace");if(a&&0!==a.indexOf("ctx::"))a="ctx::"+a;else for(;a&&a.indexOf("ctx::ctx::")>=0;)a=a.replace("ctx::ctx::","ctx::");var l=t._uwaView.getNodesXSO().get(),d=n.nodeModel.options.dsModel.plmObjectTypeInternal||n.nodeModel.options.dsModel.type;if(l.length>0){var r="Plant";s.data.items.push({envId:window.widget.data.x3dPlatformId||"OnPremise",serviceId:"3DSpace",contextId:a,objectId:n.nodeModel.options.dsModel.physicalid,objectType:d,displayName:n.nodeModel.options.dsModel.V_Name,displayType:r}),o.each(l,(function(e,t){t&&t.options&&t.options.dsModel&&n.nodeModel.options.dsModel.physicalid!==t.options.dsModel.physicalid&&((d=t.options.dsModel.plmObjectTypeInternal||t.options.dsModel.type)||t.isRoot()&&(d="Plant"),r="Production Plan",s.data.items.push({envId:window.widget.data.x3dPlatformId||"OnPremise",serviceId:"3DSpace",contextId:a,objectId:t.options.dsModel.physicalid,objectType:d,displayName:t.options.dsModel.V_Name,displayType:r}))}))}e.dataTransfer.setData("text",window.UWA.Json.encode(s)),e.dataTransfer.setData("text/searchitems",window.UWA.Json.encode(s)),i=s.data.items.length>0}return i&&n.nodeModel.isRoot()&&c&&c.publishEvent&&c.publishEvent("Dragging.start",{ev:e}),i},t._uwaView.onDragEndCell=function(e){c&&c.publishEvent&&c.publishEvent("Dragging.stop",{ev:e})},t.elements.container.style.position="relative",t.elements.container.style.minHeight="125px",t._uwaView.getContent().inject(t.elements.container),t._uwaView.loadApplicativeModel(new h),t._uwaView.onPostUpdateView((function(){if(this&&this._listOfRenderedCells&&this._listOfRenderedCells.size)for(var e=0;e<this._listOfRenderedCells.size;++e){var o=this._getRenderedCellAt(e);if(!o||!o.component)break;var n=o.component;n&&n.contentView&&!n.contentView.onContextMenuBuildCallback&&(n.contentView.elements.container["wux-data-contextual"]&&i.removeEventListener(n.contentView.elements.container,0),n.contentView.onContextMenuBuildCallback=function(e){return t.onContextMenuBuildCallback(this,e)})}})),e&&e.success&&e.success()}}))},_removeLeadingDots:function(e){return e.startsWith("../")?e.substring(3):e},addRootNodesToView:function(e,t,n){var i=this;if(e&&Array.isArray(e)&&!(e.length<=0))if(i._WUXTreeNodeModel||(i._WUXTreeNodeModel=m),i._uwaView){var s=i._uwaView.getTreeDocument();if(s){var a=[];o.each(e,(function(e,t){var n=t.dsModel;t.dsModelInstance?n=t.dsModelInstance:n&&n.dsModelInstance&&(n=n.dsModelInstance);var l=s.getRoots();if(n&&l&&l.length){var d=!0;if(o.each(l,(function(e,t){if(t&&t.options&&t.options.dsModel){var o=t.options.dsModel;t.options.dsModelInstance?o=t.options.dsModelInstance:o&&o.dsModelInstance&&(o=o.dsModelInstance),d=!i.checkEquality(n,o)}return d})),!d)return}if(t instanceof m){var c=t;(t=o.Object.extend(!1,{},t.options)).originTreeNodeModel=c}var r=new m(t);s.addRoot(r),a.push(r)})),t&&t(a)}else o.log(i.constructor.fullName+"::addRootNodesToView - invalid treeDocument!")}else i.addCollectionView({success:function(){i.addRootNodesToView(e,t,n)}})},checkEquality:function(e,t){return window.Foe&&window.Foe.Model&&window.Foe.Model.Asset&&window.Foe.Model.Asset.checkEquality?window.Foe.Model.Asset.checkEquality(e,t):!(!e||!t)&&(!(!e.physicalid||!t.physicalid||e.physicalid!==t.physicalid)||!(!e.OXID||!t.OXID||e.OXID!==t.OXID))},onInfoButtonClick:function(){var e=(this._uwaView?this._uwaView.getNodesXSO().get():[])[0];if(e&&e.options&&e.options.dsModel){var t={getSecurityContext:function(){return window.widget.getValue("pad_security_ctx")},getSelectedNodes:function(){return{id:e.options.dsModel.physicalid,tenant:"OnPremise",source:"3DSpace",getID:function(){return e.options.dsModel.physicalid},type:"Plant"}},isTransient:function(){return!0}},n={typeOfDisplay:l.ALL,displayType:l.STANDARD,readOnly:!0,setEditButton:!1,context:t};new D(n)}else o.log(this.constructor.fullName+"::onDeleteButtonClick - invalid treeNodeModel!")},onContextMenuBuildCallback:function(e,t){var o=this,n=[];if(t&&t.length)for(var i=0;i<t.length;i++){var s=t[i],a=s,l=s;switch(s){case"info":l=P.get("Details");break;case"trash":l=P.get("Unassociate");break;case"open-in-a-new-window":l=P.get("Open With")}n.push({type:"PushItem",title:l,icon:a,action:{this:o,context:s,callback:function(e){switch(e.context){case"info":o.onInfoButtonClick();break;case"trash":o.onDeleteButtonClick();break;case"open-in-a-new-window":o.onOpenWithClick()}}}}),i>=0&&i<t.length&&n.push({type:"SeparatorItem"})}return n},onOpenWithClick:function(){var e=this,t=e.getModel(),n=(e._uwaView?e._uwaView.getNodesXSO().get():[])[0];if(n&&n.options&&n.options.dsModel){if(t&&(t=n.options.dsModel),t){var i={protocol:"3DXContent",version:"2.0",source:window.widget.data&&window.widget.data.appId?window.widget.data.appId:"DELFAMC_AP",widgetId:window.widget.id,data:{items:[{envId:window.widget.data&&window.widget.data.x3dPlatformId?window.widget.data.x3dPlatformId:"OnPremise",serviceId:"3DSpace",contextId:window.widget.data.pad_security_ctx,objectId:t.physicalid,objectType:t.plmObjectTypeInternal,displayName:t["attribute.Title"]||t.Title||t.name,displayType:"Loading Plant"}]}},s=[];e.openWith=new _,e.openWith.set3DXContent(i),e.openWith.retrieveCompatibleApps((function(t){t.forEach((function(e){var t={type:"PushItem",title:e.text,action:{callback:e.handler}};e.icon?t.icon={iconPath:e.icon}:e.fonticon&&(t.icon={iconName:e.fonticon}),s.push(t)}));var o=e.elements.container.querySelector(".wux-controls-responsivetileview-menu").getBoundingClientRect(),n={position:{x:o.left+20,y:o.top+35}};f.show(s,n)}))}}else o.log(this.constructor.fullName+"::onDeleteButtonClick - invalid treeNodeModel!")},onDeleteButtonClick:function(){var e=this;if(this._dlg&&this._dlg.destroy)try{this._dlg.destroy()}catch(e){o.log("DELWebResourceFactoryPlantFacetSection::onRemove - _dlg.destroy = "+e.stack)}var t=(e._uwaView?e._uwaView.getNodesXSO().get():[])[0];if(t&&t.options&&t.options.dsModel){var i=P.get("Do you want to unassociate the {0} {1} from {2} {3}?",{0:P.get("Plant"),1:o.String.escapeHTML(t.options.dsModel.Title),2:P.get("Organizational Resource"),3:o.String.escapeHTML(e._source_model.V_Name)}),s={resizableFlag:!0,modalFlag:!0,title:P.get("Unassociate {0}",{0:P.get("Plant")}),immersiveFrame:this.getImmersiveFrame(),content:'<span class="icon-main wux-ui-3ds-alert"></span>'+i,buttons:{Cancel:new y({onClick:function(){e._dlg.destroy(),e._dlg=null}}),Save:new y({label:P.get("Unassociate"),disabled:!1,onClick:function(){var o=this;o.disabled=!0;var i,s=[],a={};t&&t.options&&t.options.dsModel&&(t.options.dsModel.physicalid?a.physicalid=t.options.dsModel.physicalid:t.options.dsModel.OXID&&(a.OXID=t.options.dsModel.OXID));var l={resource:{},plant:{},connection:{}};e._source_model&&e._source_model.physicalid&&(l.resource=JSON.stringify({physicalid:e._source_model.physicalid})),a&&a.physicalid&&(l.plant=JSON.stringify({physicalid:a.physicalid})),t.options.dsModel&&t.options.dsModel.connectionPhysicalid&&(l.connection=JSON.stringify({physicalid:t.options.dsModel.connectionPhysicalid})),i=r.unassociateFactoryLayoutFromPlant(l),s.push(i),n.all(s).then((function(){p.displayNotificationMessage(P.get("Unassociation Successful"),{level:"success"}),e._dlg.destroy(),e._dlg=null}),(function(e){p.displayNotificationMessage(e),o.disabled=!1}))}})}};e._dlg=new g(s)}else o.log(this.constructor.fullName+"::onDeleteButtonClick - invalid treeNodeModel!")},getImmersiveFrame:function(){if(!this.immersiveFrame){var e=window.document.getElementsByClassName("wux-windows-immersive-frame");if(e&&e.length)for(var t=0;!this.immersiveFrame&&t<e.length;++t)e[t]&&e[t].dsModel&&(this.immersiveFrame=e[t].dsModel)}return this.immersiveFrame},getTreeNodeFromDsModel:function(e,t,n){if(!e)return o.log("DELWebResourceFactoryPlantFacetSection.js::getTreeNodeFromDsModel - invalid dsModel!"),null;if(t||(t=this._tableObjectContents),!t)return o.log("DELWebResourceFactoryPlantFacetSection.js::getTreeNodeFromDsModel - invalid uwaTree!"),null;n&&o.Function.isFunction(n)||(n=this.checkEquality);var i=null,s=this._tableObjectContents;return o.each(s,(function(t,o){o&&o.dsModel&&(n(o.dsModel,e)&&(i=o));return!i})),i},_getLoadingMessage:function(){return P.get("Loading {0}",{0:P.get("Plants")})+"..."},_getNoAssociatedMessage:function(){return P.get("No {0} associated",{0:P.get("Plants")})},_getAssociateButtonLabel:function(){return P.get("Associate {0}",{0:P.get("Plant")})},_associateButtonClicked:function(e){!this._assocDlg&&this.options._assocDlg&&(this._assocDlg=this.options._assocDlg),this._assocDlg||((e=Object.assign(e||{},this.options))._createDlg||(e._createDlg=this),new u(e))},_initEventHandlers:function(){var e=this;this._eventSubscriptionTokens||(this._eventSubscriptionTokens=[]),o.each(this,(function(t,n){if(n&&o.Function.isFunction(n)&&t.endsWith(" subscribe")){var i=t.replace(" subscribe","").trim(),s=null;(s=e.options&&e.options.modelEvents?e.options.modelEvents.subscribe({event:i},(function(t){n.apply(e,[i,t])})):v.subscribe({event:i},(function(t){n.apply(e,[i,t])})))&&e._eventSubscriptionTokens.push(s)}}))},onSectionRefreshClicked:function(e){var t=this;e&&e.stopPropagation&&e.stopPropagation();var o={OXID:t._source_model.OXID,physicalid:t._source_model.physicalid,Depth:0,blnForceRefresh:!0};t._postBuildView(o)},"Plant.associated subscribe":function(e,t){var n=this;if(!t&&e&&"string"!=typeof e&&(t=e,e="Plant.associated"),t&&t.plant.physicalid&&t.connectionPhysicalid&&t.resource.physicalid){var i=n.getModel();if(!i||i._source_model.physicalid!==t.resource.physicalid)return!1;c.getServiceUrl({serviceName:"3DSpace"}).then((function(e){var o=t.plant,i=e+"/snresources/images/icons/large/iconManufacturingPlant144.png";o.V_TimeZone||(o["Plant Time Zone"]?o.V_TimeZone=o["Plant Time Zone"]:o.attribute&&o.attribute["Plant Time Zone"]&&(o.attribute["Plant Time Zone"].value?o.V_TimeZone=o.attribute["Plant Time Zone"].value:"string"==typeof o.attribute["Plant Time Zone"]&&(o.V_TimeZone=o.attribute["Plant Time Zone"])));var s={useAsyncPreExpand:!0,clickableTitle:!0,label:o["attribute.Title"]||o.Title||o.name,dsModel:o,thumbnail:i,description:o.V_description||o.description||"",subLabel:o.V_TimeZone||"",contextualMenu:["info","trash"]};window.widget.standalone||s.contextualMenu.push("open-in-a-new-window"),n.addRootNodesToView([s],(function(){}),(function(e){p.displayNotificationMessage(e)}))}))}else o.log("DELWebResourceFactoryPlantFacetSection::Plant.associated - invalid objConnection")},"Plant.unassociated subscribe":function(){this._uwaView&&this._uwaView.getTreeDocument().getNthRoot(0).remove(),this._uwaView=null,c.useFixtures()?this.editionSwitched({blnEditMode:!0}):this.onSectionRefreshClicked(null)}});return C}));