window.define&&define("DS/DELWebInfrastructureControls/DELWebResourceFactoryPlant/DELWebResourceFactoryPlantAssocDlg",["DS/DELWebInfrastructureControls/UWAUtils","DS/DELWebInfrastructureControls/DELWebAjaxModel","DS/DELWebInfrastructureControls/DELWebResourceFactoryPlant/DELWebResourceFactoryPlantModel","DS/DELWebInfrastructureControls/DELWebSearchUtils","DS/Windows/Dialog","DS/Controls/Button","DS/DELWebInfrastructureControls/Mask","DS/Controls/LineEditor","DS/Controls/Editor","DS/Controls/ComboBox","DS/Controls/Popup","DS/DataGridView/DataGridView","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/CollectionView/CollectionViewStatusBar","DS/DELWebInfrastructureControls/DELWebNotifications","i18n!DS/DELWebInfrastructureControls/assets/nls/DELWebInfrastructureControls","css!DS/DELWebInfrastructureControls/DELWebInfrastructureControls.css"],(function(e,t,n,s,a,o,i,r,l,d,c,u,m,p,h,g,f){"use strict";var v=a.inherit({name:"DELWebResourceFactoryPlantAssocDlg",publishedProperties:{title:{defaultValue:f.get("Associate {0}",{0:f.get("Plants")}),type:"string",category:"Appearance"},modalFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},autoCloseFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},resizableFlag:{defaultValue:!0,type:"boolean",category:"Behavior"},activateButtonsIfActionPerformed:{defaultValue:!1,type:"boolean",category:"Behavior"},width:{defaultValue:Math.max(window.widget.body.clientWidth/2,330),type:"integer",category:"Appearance",advancedSetter:!0,recordFlag:!0},height:{defaultValue:Math.max(window.widget.body.clientHeight/5,200),type:"integer",category:"Appearance",advancedSetter:!0,recordFlag:!0},minWidth:{defaultValue:330,defaultTouchValue:330,advancedSetter:!0,type:"integer",category:"Appearance"},minHeight:{defaultValue:160,defaultTouchValue:160,advancedSetter:!0,type:"integer",category:"Appearance"}},init:function(e){e?this.options=Object.assign(this.options||{},e):this.options||(this.options={}),this.options._createDlg._source_model&&(this.options.root_resource||(this.options.root_resource=this.options._createDlg._source_model)),this._parent.apply(this,arguments)},destroy:function(){delete this._createDlg,this.options&&delete this.options._createDlg,this._parent.apply(this,arguments)},_postBuildView:function(){this.elements._modalDiv||(this.elements._modalDiv=this.elements.container.getParent(".wux-windows-modalDialog")),this._parent();var t=this;if(!this.immersiveFrame)if(this.options.immersiveFrame)this.immersiveFrame=this.options.immersiveFrame;else{var n=window.document.getElementsByClassName("wux-windows-immersive-frame");if(n&&n.length)for(var s=0;!this.immersiveFrame&&s<n.length;++s)n[s]&&n[s].dsModel&&(this.immersiveFrame=n[s].dsModel)}this.elements.container.addClassName(this.name+"-dlg"),this.elements.mainDiv=e.createElement("div",{class:this.name+"-maindiv"}).inject(this.elements._contentDiv||this.elements.container),this.buttons={Save:new o({disabled:!0,onClick:function(){t.onSave()}}),Cancel:new o({onClick:function(){t.visibleFlag=!1,t.destroy()}})},this.elements.mainDiv.innerHTML='<div class="assoc_header"><span class="assoc_help wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-help"></span><span class="assoc_refresh wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-refresh"></span><span class="assoc_search"><span class="wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-drag-drop"></span> '+f.get("Drag from 3DSearch to add {0}",{0:f.get("Plants")})+'</span></div><div class="assoc_table loading"></div>',this._addUnassociatedPlantsTable(),this._initEventHandlers()},onSave:function(){var t=this;if(this.options&&this.options.root_resource&&this.options.root_resource.physicalid)if(this.elements._uwaTree&&!this.elements._uwaTree.getNodesXSO().isEmpty()){var s=[];e.each(this.elements._uwaTree.getNodesXSO().get(),(function(e,t){t&&t.dsModel&&t.dsModel.physicalid&&(s=t.dsModel)})),t._handleLoadingButtons(!0),n.associateFactoryLayoutToPlant({resource:this.options.root_resource,plant:s}).then((function(n){var s=f.get("Plant");n&&1===n.length&&n[0].name?s=e.String.escapeHTML(n[0].name):n&&n.length>1&&(s=f.get("Plants")),g.displayNotificationMessage(f.get("{0} Associated",{0:s}),{level:"success"}),t.destroy()}),(function(e){g.displayNotificationMessage(e),t._handleLoadingButtons(!1)}))}else g.displayNotificationMessage(f.get("No {0}",{0:f.get("Plants")}));else g.displayNotificationMessage(f.get("No {0}",{0:f.get("Resource")}))},onSelectChanged:function(){this.buttons.Save.disabled=!this.elements._uwaTree||this.elements._uwaTree.getNodesXSO().isEmpty()},_handleLoadingButtons:function(e){var t=this.buttons.Save;e?(t.iconSize="1em",t.disabled=!0,t.icon=window.Configuration.webappsDir+"/DELWebAssetMgmt/assets/loading-small.gif"):(t.icon="",t.disabled=!1)},_addUnassociatedPlantsTable:function(){var t=this,s=null;if(t.options.root_resource&&t.options.root_resource.physicalid){var a={QueryList:[{physicalid:t.options.root_resource.physicalid}]};t.options.resource&&t.options.resource.physicalid!==t.options.root_resource.physicalid&&a.QueryList.push({physicalid:t.options.resource.physicalid}),i&&t.elements&&t.elements.mainDiv&&((s=t.elements.mainDiv.getElementsByClassName("assoc_table"))||(s=t.elements.mainDiv),i.mask(s[0])),n.getUnassociatedPlants(a).then((function(n){t.options.root_resource.assocPlant={};var a={};e.each(n,(function(e,t){t&&t.physicalid&&(a[t.physicalid]=t)})),t.addRootNodesFromData(a).then((function(){var n=t.elements.mainDiv.getElementsByClassName("assoc_table");n&&1===n.length&&(n=e.extendElement(n[0])),t.elements._uwaTree||n.setText(f.get("No {0}",{0:f.get("Plants")})),n.removeClassName("loading"),i&&t&&t.elements&&t.elements.mainDiv&&(!(s=t.elements.mainDiv.getElementsByClassName("assoc_table"))&&i.isMasked(t.elements.mainDiv)&&(s=t.elements.mainDiv),s&&s.length&&i.unmask(t.elements.mainDiv))}))}))}},addTable:function(e){var t=this;return new Promise((function(n){if(t.elements._uwaTree)n(t.elements._uwaTree);else{e||(e={});var s={cellSelection:"none",rowSelection:"single",enableListSelection:!0,canMultiSelect:!1,cellDragEnabledFlag:!1,enableDragAndDrop:!1,shouldAcceptDrag:function(){return!1},shouldAcceptDrop:function(){return!1},shouldBeEditable:function(){return!1},isEditable:!1,roots:[],columns:[{text:f.get("Unassociated {0}",{0:f.get("Plants")}),dataIndex:"tree"},{text:f.get("Time Zone"),dataIndex:"V_TimeZone"}]};s.treeDocument||(s.treeDocument=new m),e.container||(e.container=t.elements.mainDiv.getElementsByClassName("assoc_table"),e.container&&1===e.container.length&&(e.container=e.container[0])),t.elements._uwaTree=new u(s).inject(e.container),t.elements._uwaTree.getNodesXSO().onChange((function(){t.onSelectChanged()})),t.elements._uwaTree.getContainingImmersiveFrame&&!t.elements._uwaTree._getContainingImmersiveFrame&&(t.elements._uwaTree._getContainingImmersiveFrame=t.elements._uwaTree.getContainingImmersiveFrame,t.elements._uwaTree.getContainingImmersiveFrame=function(){var e=t._getContainingImmersiveFrame();return e||(e=t.immersiveFrame||t.options.immersiveFrame),e}),n(t.elements._uwaTree)}}))},addRootNodesFromData:function(t){var s=this;return new Promise((function(a){if(t&&!e.Object.isEmptyObject(t)){var o=[];return e.each(t,(function(e,t){var s=null;t.V_TimeZone||(t["Plant Time Zone"]?t.V_TimeZone=t["Plant Time Zone"]:t.attribute&&t.attribute["Plant Time Zone"]&&(t.attribute["Plant Time Zone"].value?t.V_TimeZone=t.attribute["Plant Time Zone"].value:"string"==typeof t.attribute["Plant Time Zone"]&&(t.V_TimeZone=t.attribute["Plant Time Zone"]))),(s={label:t["attribute.Title"]||t.Title||t.name,dsModel:t,grid:{V_description:t.V_description||"",V_TimeZone:t.V_TimeZone||"",revision:t.revision||""}}).dsModel&&s.dsModel.IconPath&&n.getPlantIconPath(t,(function(e){e&&(s.icons=[e])})),o.push(s)})),s.addRootNodesToTable(o)}a(o)}))},addRootNodesToTable:function(t){var n=this,s=null;return new Promise((function(a,o){!t||!Array.isArray(t)||t.length<=0?a([]):n.addTable().then((function(o){var r=o.getTreeDocument(),l=[];o.prepareUpdateView(),e.each(t,(function(t,n){var s=r.getRoots();if(s&&s.length){var a=!0;if(e.each(s,(function(e,t){return!n.dsModel.physicalid&&n.dsModel.resourceParameterList&&(n.dsModel.resource&&(n.dsModelResource||(n.dsModelResource={}),n.dsModelResource[n.dsModel.resource.physicalid]=n.dsModel.resource),n.dsModel=n.dsModel.resourceParameterList),t&&t.dsModel&&n.dsModel&&((a=t.dsModel.physicalid!==n.dsModel.physicalid)||(n.dsModelResource&&(t.options.dsModelResource?t.options.dsModelResource=Object.assign(t.options.dsModelResource,n.dsModelResource):t.options.dsModelResource=n.dsModelResource),t.show())),a})),!a)return}var o=new p(n);o.dsModel=n.dsModel,r.addRoot(o),l.push(o)})),o.reapplySortModel(),o.pushUpdateView({updateCellContent:!0,updateCellLayout:!0},!0);var d=n.elements.mainDiv.getElementsByClassName("assoc_table");d&&1===d.length&&(d=e.extendElement(d[0])),n.elements._uwaTree||d.setText(f.get("No {0}",{0:f.get("Plants")})),d.removeClassName("loading"),i&&n&&n.elements&&n.elements.mainDiv&&(!(s=n.elements.mainDiv.getElementsByClassName("assoc_table")[0])&&i.isMasked(s)&&(s=n.elements.mainDiv),s&&i.unmask(n.elements.mainDiv.getElementsByClassName("assoc_table")[0])),a(l)}))}))},_initEventHandlers:function(){var e=this,t=e.elements._modalDiv||e.elements.container||e.elements.mainDiv||window.widget.body;window.widget.standalone&&window.jQuery&&window.jQuery.fn&&window.jQuery.fn.droppable?(e.options._dndResultsDraggingStart=window.OpenAjax.hub.subscribe("Search.ResultsDragging.start",(function(){window.jQuery(t).addClass("ds_search_result_droppable").droppable({tolerance:"pointer",drop:function(t,n){e.onDrop(t,n)},greedy:!0,over:function(t,n){e.onDragOver(t,n)}})})),e.options._dndResultsDraggingStop=window.OpenAjax.hub.subscribe("Search.ResultsDragging.stop",(function(){window.jQuery(t).hasClass("ui-droppable")&&window.jQuery(t).droppable("destroy"),window.jQuery(t).removeClass("ds_search_result_droppable")}))):(t.addClassName("ds_search_result_droppable"),t.addEventListener("dragover",(function(t){e.onDragOver(t)})),t.addEventListener("drop",(function(t){e.onDrop(t)}))),this.elements.mainDiv.querySelector(".assoc_header .wux-ui-3ds-help").addEventListener("click",(function(t){e.onSectionHelpClicked(t)})),this.addEventListener("close",(function(){e.destroy()}))},onDragOver:function(e){e&&e.preventDefault&&(e.stopPropagation&&e.stopPropagation(),e.preventDefault())},onDrop:function(t,a){var o=this;t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault();var i=[],r=function(t){var s=!1;n.getAssociatedFactoryLayoutForPlant({QueryList:t}).then((function(n){n=Object.values(n)[0];var a=Object.values(n)[0];s=!(!n||e.Object.isEmptyObject(n));var i={};s?g.displayNotificationMessage(f.get('"'+t[0].name+'" is already associated to the factory:"'+a.V_Name+'"')):(e.each(t,(function(e,t){t&&t.physicalid&&(i[t.physicalid]=t)})),o.addRootNodesFromData(i))}))};a&&a.draggable&&a.draggable.closest?(a.draggable.closest(".search_results_container").find('.ui-selected[data-physicalid][data-what="Plant"]').each((function(){i.push({PLM_ExternalID:window.$(this).attr("data-plm_externalid"),physicalid:window.$(this).attr("data-physicalid"),Minimum:["physicalid","V_Name","V_description","revision"]})})),i.length>0&&e.each(i,(function(e,t){n.getOne(t).then((function(e){r([e])}),(function(e){g.displayNotificationMessage(e)}))}))):s.getUnifiedSearchObjectsFromDrop({ev:t}).then((function(t){t&&!e.Object.isEmptyObject(t)&&(e.each(t,(function(e,t){t.objectType=t.plmObjectType||t.type||t.plmBaseObjectType,"Plant"===t.objectType&&i.push(t)})),i.length>0&&e.each(i,(function(e,t){!t.physicalid&&t.id&&(t.physicalid=t.id),t.Minimum||(t.Minimum=["physicalid","V_Name","V_description","revision"]),n.getOne(t).then((function(e){Array.isArray(e)||(e=[e]),r(e)}),(function(e){g.displayNotificationMessage(e)}))})))}),(function(e){g.displayNotificationMessage(e)}))},onSectionHelpClicked:function(e){e&&e.stopPropagation&&e.stopPropagation();var t=new c({target:e.target,trigger:"click"}),n=f.get("Unassociated {0} that are not associated to any {1} are shown here.",{0:f.get("Plants"),1:f.get("Resource Factory")});t.setBody(n),t.show()}});return v}));