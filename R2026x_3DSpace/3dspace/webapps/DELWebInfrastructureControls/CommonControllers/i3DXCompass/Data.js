define("DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/Data",["UWA/Core","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/Utils","UWA/Ajax","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/UWAData","DS/WebappsUtils/WebappsUtils","DS/WAFData/WAFData","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/CacheManager","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/Tools","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/Storage","DS/i3DXCompassPlatformServices/i3DXCompassRegistryClient","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/Object"],(function(e,t,s,r,o,i,n,a,l,p,c,u,m){"use strict";var g,f,d,h=e.i18n,U={root:null,saveSectionTimeout:0,initialize:function(t,s){t.myAppsBaseUrl=t.myAppsBaseUrl.replace("/resources/AppsMngt","");var r=t.myAppsBaseUrl.replace(/\/$/,"")+"/resources/AppsMngt/";if(c.initialize(r,t.lang),this.myAppsBaseUrl=r,this.getAppsUrl=r+"apps/compass",t.platform&&(this.selectedPlatform=t.platform),t.userId?(this.getAppsUrl=r+"apps/compass",this._urlCompassUri="apps/compass"):(this.getAppsUrl=r+"apps/public/compass",this._urlCompassUri="apps/public/compass"),t.addinMode){this.addinMode=t.addinMode;try{localStorage.setItem("3DCompass-addinMode",JSON.stringify(t.addinMode))}catch(e){}}else try{var o=localStorage.getItem("3DCompass-addinMode");o?this.addinMode=JSON.parse(o):l.getAddinModeURL()&&(this.addinMode=l.getAddinModeURL(),localStorage.setItem("3DCompass-addinMode",JSON.stringify(l.getAddinModeURL())))}catch(e){try{l.getAddinModeURL()&&(this.addinMode=l.getAddinModeURL(),localStorage.setItem("3DCompass-addinMode",JSON.stringify(l.getAddinModeURL())))}catch(e){}}n.setup(t.userId,t.lang),this._registryUriInfo="api/v1/public/registry/info",this._setPreferencesUri="user/setPreferences",this._getPreferencesUri="user/getPreferences",this._setFavoriteUri="user/setFavorite",this._setSectionUri="apps/compass/section",this._getProcessDetailsUri="apps/licenses",this._requestRoleUri="role/request",this._tryRoleUri="role/try",this._encryptUri="security/encrypt",this._decryptUri="security/decrypt",this._getSuggestionsUri="role/suggestions",this._getAppInfoUri="apps",this._getFeatureCompassUri="infos/feature/compass",this._preferenceUri="api/v1/compass/preference",this._getPreferencesUserUri="user/preference",this._mediaUri="media",this.setPreferencesUrl=r+"user/setPreferences",this.getPreferencesUrl=r+"user/getPreferences",this.setFavoriteUrl=r+"user/setFavorite",this.setSectionUrl=r+"apps/compass/section",this.getProcessDetailsUrl=r+"apps/licenses",this.requestRoleUrl=r+"role/request",this.tryRoleUrl=r+"role/try",this.encryptUrl=r+"security/encrypt",this.decryptUrl=r+"security/decrypt",this.getSuggestionsUrl=r+"role/suggestions",this.getAppInfoUrl=r+"apps",this.getFeatureCompass=r+"infos/feature/compass",this.preference=r+"api/v1/compass/preference",this.getPreferencesUserUrl=r+"user/preference",this.media=r+"media",t.myAppsBaseUrl&&!t.registryUrl&&this._formatRegistryUrl(t.myAppsBaseUrl),t.passportUrl&&(this.passportUrl=t.passportUrl),this.onlineInstallUrl=null,this.buildTransactionId=null,g=e.extend({},t),this.root=s,this.lang=t.lang,EventManager.dispatchEvent("onInitialized")},request:function(s){var o,a,l,p=this,u={Accept:s.Accept||"application/json","Accept-Language":g?g.lang:null},m=s.proxy;"POST"!==s.method&&"PUT"!==s.method||!s.contentType||(u["Content-Type"]=s.contentType,u["X-DS-CSRFTOKEN"]=c.getTokenCSRF()),s.headers&&(u=e.merge(u,s.headers)),l=function(e,t){e&&(e.code&&e.code.indexOf&&-1!==e.code.indexOf("CSRF")||e.indexOf&&-1!==e.indexOf("CSRF"))||t&&(t.code&&t.code.indexOf&&-1!==t.code.indexOf("CSRF")||t.indexOf&&-1!==t.indexOf("CSRF"))?(c.initialize(p.myAppsBaseUrl,p.lang),c.getOrGenerateTokenCSRF({context:p,options:s})):s.onFailure&&(t?s.onFailure(t):s.onFailure(e))},o={timeout:void 0!==s.timeout?s.timeout:15e3,cache:U._getCacheLevel(s),method:s.method||"GET",type:s.type||"json",headers:u,proxy:"none"!==m&&n._getUser()?m||"passport":null,data:s.postData,onComplete:s.onComplete,onFailure:l},s.urlParams&&(s.urlParams.debug=(void 0===d&&(d=-1!==self.location.search.indexOf("debug")),!1!==d||null));var f=e.Utils.getQueryString(self.location.href,"ticket");return f&&"passport"===o.proxy&&(s.urlParams||(s.urlParams={}),s.urlParams.ticket=f),a=s.url+(s.urlParams?"?"+t.toQueryString(s.urlParams):""),U._isCorsAvailable(s)||s.urlParams&&s.urlParams.cors?"passport"===o.proxy?i.authenticatedRequest(a,o):i.request(a,o):r.request(a,o)},_getAppsUrl:function(){return this.myAppsBaseUrl+this._urlCompassUri},_getSetPreferencesUrl:function(){return this.myAppsBaseUrl+this._setPreferencesUri},_getPreferencesUrl:function(){return this.myAppsBaseUrl+this._getPreferencesUri},_setFavoriteUrl:function(){return this.myAppsBaseUrl+this._setFavoriteUri},_setSectionUrl:function(){return this.myAppsBaseUrl+this._setSectionUri},_getProcessDetailsUrl:function(){return this.myAppsBaseUrl+this._getProcessDetailsUri},_getRegistryURLInfo:function(){return this.myAppsBaseUrl+this._registryUriInfo},_requestRoleUrl:function(){return this.myAppsBaseUrl+this._requestRoleUri},_tryRoleUrl:function(){return this.myAppsBaseUrl+this._tryRoleUri},_encryptUrl:function(){return this.myAppsBaseUrl+this._encryptUri},_decryptUrl:function(){return this.myAppsBaseUrl+this._decryptUri},_getSuggestionsUrl:function(){return this.myAppsBaseUrl+this._getSuggestionsUri},_getAppInfoUrl:function(){return this.myAppsBaseUrl+this._getAppInfoUri},_getFeatureCompass:function(){return this.myAppsBaseUrl+this._getFeatureCompassUri},_getPreferencesUserUrl:function(){return this.myAppsBaseUrl+this._getPreferencesUserUri},_mediaUrl:function(){return this.myAppsBaseUrl+this._mediaUri},_request:function(){return u.isMobileAppEnvironment()?i.authenticatedRequest:r.request},_getCacheLevel:function(e){var t=l.getBrowser(),s=0;return"internet explorer"!==t&&"edge"!==t||(s=-1),void 0!==e.cache?e.cache:s},get3DDashboardUrl:function(e){var t=this;this.dashboardUrl?e&&e(this.dashboardUrl):this._get3DDashboardUrl({},(function(s){s.length>0&&s[0].services.length>0&&(t.dashboardUrl=s[0].services[0].url),e&&e(this.dashboardUrl)}))},_get3DDashboardUrl:function(e,t){m.getServicesByPlatform({platforms:e.platform&&e.platform.length>0?e.platform:[this.selectedPlatform],services:["3DDashboard"],config:{url:this._getRegistryURL()}}).then(t,t)},getBusinessExperienceUrl:function(e,t){"dsrtv:"!==self.location.protocol?m.getServicesByPlatform({platforms:e.platform&&e.platform.length>0?e.platform:[this.selectedPlatform],services:["businessexperience"],config:{url:this._getRegistryURL()}}).then(t,t):t()},setPreferences:function(e){var t={url:U._getSetPreferencesUrl(),urlParams:e,onComplete:function(e){0===e.code?EventManager.dispatchEvent("onShowMessage",[e.message,5e3]):EventManager.dispatchEvent("onShowMessage",[e.message||h("errorsavingpreferences"),5e3])},onFailure:function(e){EventManager.dispatchEvent("onShowMessage",[e&&e.message||h("errorsavingpreferences"),5e3])}};U.request(t)},getPreferences:function(t){e.is(n._getUser())&&U.request({url:U._getPreferencesUserUrl(),type:"json",Accept:"text/plain",urlParams:t.urlParams,onComplete:function(e){t.onComplete&&t.onComplete(e)},onFailure:function(e){t.onFailure&&t.onFailure(e)}})},saveSectionStatus:function(e){clearTimeout(U.saveSectionTimeout),U.saveSectionTimeout=setTimeout((function(){U.request({method:"PUT",url:U._setSectionUrl(),contentType:"application/x-www-form-urlencoded",postData:{name:"value",value:e},cache:null})}),1100)},setPreference:function(e){var t={url:U._getSetPreferencesUrl(),urlParams:{name:e.name,value:e.value},cache:null,onComplete:function(t){t&&0===t.code?e&&e.onComplete&&e.onComplete():e&&e.onFailure&&e.onFailure()},onFailure:function(t,s){e&&e.onFailure&&e.onFailure()}};U.request(t)},getCasTgc:function(s){var r,n=this,a="ios"===l.getOs(),c={timeout:15e3,method:"GET",type:"json",onFailure:function(){s.onComplete()}},u=null,m=function(){c.onComplete=function(l){l.result?function(l){var p=t.encodeUrl(t.buildUrl(self.location,o.getWebappsBaseUrl()+"i3DXCompass/gettgc.html")),u=s.passportUrl.replace(/\/$/,"")+"/",m=t.buildUrl(u,"cas/getcastgc?userid="+g.userId+"&service=V6&ticket="+l+"&callback="+p),d=new RegExp("castgc=(.*-cas)");c.type="text",c.onComplete=function(t){if(t.data)"com.ds.compass"===(t=JSON.parse(t.data)).target&&(r.destroy(),self.removeEventListener("message",c.onComplete),"notgc"===t.castgc?s.onComplete():(a?f=t.castgc:n.storage.set("casTGC",t.castgc),s.onComplete(t.castgc)));else if(d.test(t)){e.log("CORS request succeeded");var o=d.exec(t);a?f=o[1]:n.storage.set("casTGC",o[1]),s.onComplete(o[1])}else s.onComplete()},c.onFailure=function(e){s.onComplete()},c.responseType="";try{i.request(m,c)}catch(t){e.log("CORS request failed"),self.addEventListener("message",(function(e){n.storage.set("casTGC",e),c.onComplete(e)})),r=e.createElement("iframe",{src:m,class:"tgc-frame",styles:{border:"none",width:"0px",height:"0px"}}).inject(U.root)}}(l.result):s.onComplete()},i.request(g.proxyTicketUrl+(new Date).getTime(),c)};if(this.storage||(this.storage=new p({adapter:"Object",database:"compass"})),a)if(f)s.onComplete(f);else{try{f=n.storage.get("casTGC",5e3)}catch(e){}s.passportUrl?m():s.onComplete()}else{try{u=n.storage.get("casTGC",5e3)}catch(e){}u?s.onComplete(u):s.passportUrl?m():s.onComplete()}},getCasTransientUrl:function(r){var o,i={timeout:15e3,method:"GET",type:"json",onFailure:function(){r.onComplete()}},n=r.passportUrl.replace(/\/$/,"")+"/",a=t.buildUrl(n,"api/authenticated/cas/transient");i.type="json",i.onComplete=function(t){var s;if(t)try{(t=JSON.parse(t)).x3ds_reauth_url&&(s=t.x3ds_reauth_url)}catch(t){e.log("Authentication issue"),e.log(t)}r.onComplete(s)},i.onFailure=function(){r.onComplete()};try{(o=s.getRequest(a,i)).withCredentials=!0,o.send()}catch(t){e.log("CORS FAIL: getTransientUrl"),r.onComplete("")}},fetchPassportUrlForPlatform:function(e,t){m.getServicesByPlatform({platforms:e,services:["3dpassport"],config:{url:this._getRegistryURL()}}).then(t,t)},getCasTgcAndCasTransientUrl:function(t){var s,r,o=this,i=2,n=function(o){0===--i&&(e.is(s)&&e.is(r)?t.onComplete(s,r,o):(EventManager.dispatchEvent("onShowMessage",h("sessionExpirationTitle")),a.getPlatformServices({onComplete:function(t){e.log(t)}})))};o.fetchPassportUrlForPlatform(t.platform?[t.platform]:[this.selectedPlatform],(function(t){e.log(t);var i="";t&&t[0]&&t[0].services[0]&&(i=(i=t[0].services[0].url).replace("/cas","")),o.getCasTgc({passportUrl:i,onComplete:function(e){s=e,n(i)}}),o.getCasTransientUrl({passportUrl:i,onComplete:function(e){r=e,n(i)}})}))},_isCorsAvailable:function(e){var t=U.myAppsBaseUrl;return!t&&"undefined"!=typeof COMPASS_CONFIG&&COMPASS_CONFIG.myAppsBaseUrl&&(t=COMPASS_CONFIG.myAppsBaseUrl),e.url&&e.url.indexOf&&(e.url.indexOf(t)>-1||e.url.indexOf("resources/compass/api")>-1||e.url.indexOf("-compass.")>-1)},_formatRegistryUrl:function(e){var t=this;e.indexOf("-apps.")>0||e.indexOf("-compass.")>0?U.request({url:this._getRegistryURLInfo(),onComplete:function(s){s&&s.services&&s.services.length>0?t.registryUrl=s.services[0].url:e.indexOf("-apps.")>0?t.registryUrl=e.replace("-apps.","-registry.").replace("/enovia",""):e.indexOf("-compass.")>0&&(t.registryUrl=e.replace("-compass.","-registry.").replace("/enovia",""))},onFailure:function(){e.indexOf("-apps.")>0?t.registryUrl=e.replace("-apps.","-registry.").replace("/enovia",""):e.indexOf("-compass.")>0&&(t.registryUrl=e.replace("-compass.","-registry.").replace("/enovia",""))}}):setTimeout((function(){this.registryUrl=e.replace("AppsMngt/","AppsMngtRegistry/")}),0)},_getRegistryURL:function(){return U.registryUrl}};return U}));