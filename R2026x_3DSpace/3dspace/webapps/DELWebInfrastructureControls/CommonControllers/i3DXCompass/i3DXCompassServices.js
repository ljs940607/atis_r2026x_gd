define("DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/i3DXCompassServices",["UWA/Core","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/Utils","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/Data","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/UserServiceApi","DS/DELWebInfrastructureControls/CommonControllers/i3DXCompass/CacheManager","DS/i3DXCompassPlatformServices/i3DXCompassRegistryClient"],(function(e,n,r,o,t,l){"use strict";var i,a="api/v1/public/services",s="api/v1/services",f="_public",u="_role",c={},p={},m={},d={},C={},g=function(e){return e?e+(O()?s:a):null},v=function(){var e=I();return e?e+(O()?s:a):null},I=function(){return r.myAppsBaseUrl||i},O=function(){return t._getUser()},S=function(e,n){C[n].forEach((function(r){r[e]&&setTimeout(r[e],0,c[n])})),C[n].length=0},y=function(e){return U(e)?U(e).split("@@@")[0]:null},A=function(e){return U(e)?JSON.parse(U(e).split("@@@")[1]):null},U=function(e){return t.getCache(O()+e)},b=function(e){m[e]=!0;var n=e;n&&n.indexOf(f)>-1&&"null"!==n.split(f)[0]&&(n=n.split(f)[0]),n&&n.indexOf(u)>-1&&"null"!==n.split(u)[0]&&(n=n.split(u)[0]),n=null!==n&&n&&n.indexOf&&-1===n.indexOf("null")?n:null,console.info("getCompassUrlAndfetchEnvironmentList:"+r.registryUrl),r.registryUrl&&n?l.getServicesByPlatform({platforms:[n],services:["3dcompass"],config:{url:r.registryUrl}}).then((function(n){n.length>0?D(e,g(n[0].services[0].url+"/resources/AppsMngt/")):D(e,g(I()))}),(function(){D(e,g(I()))})):D(e,g(I()))},D=function(e,n){var o=!1,l=!1,i=e;i&&i.indexOf(f)>-1&&("null"!==i.split(f)[0]&&(i=i.split(f)[0]),o=!0),i&&i.indexOf(u)>-1&&"null"!==i.split(u)[0]&&(i=i.split(u)[0]),e&&e.indexOf(u)>-1&&"null"!==e.split(u)[1]&&(l=e.split(u)[1]);var a={cache:null,urlParams:{platformId:i=null!==i&&i&&i.indexOf&&-1===i.indexOf("null")?i:null,cors:!0},url:n,headers:{"Last-Modified":y(i)},onComplete:function(n,r){if(n&&0===n.code){null,null,c[e]=n.platforms,p[e]=!0;var o=r&&(r["Last-Modified"]||r["Last-Modified".toLowerCase()]);r&&o&&c[e]&&c[e].length>0&&function(e,n,r){t.setCache(O()+e,n+"@@@"+JSON.stringify(r))}(e,o,c[i]),S("onComplete",e)}else c[e]=A(e),c[e]?(p[e]=!0,S("onComplete",e)):S("onFailure",e);m[e]=!1},onFailure:function(){c[e]=A(),c[e]?(p[e]=!0,S("onComplete",e)):S("onFailure",e),m[e]=!1}};o&&(a.urlParams.publicPlatform=!0),l&&(a.urlParams.role=l),r.request(a)},P=function(n){var r=Date.now();n.platformId||(n.platformId=null),!v()&&(n.config&&n.config.myAppsBaseUrl||"undefined"!=typeof COMPASS_CONFIG&&COMPASS_CONFIG.myAppsBaseUrl)&&(i=(i=(i=n.config&&n.config.myAppsBaseUrl?n.config.myAppsBaseUrl:COMPASS_CONFIG.myAppsBaseUrl).replace("/resources/AppsMngt","")).replace(/\/$/,"")+"/resources/AppsMngt/"),!O()&&(n.config&&n.config.userId||"undefined"!=typeof COMPASS_CONFIG&&COMPASS_CONFIG.userId)&&(n.config&&n.config.userId?t.setup(n.config.userId,n.config.lang):t.setup(COMPASS_CONFIG.userId,COMPASS_CONFIG.lang)),console.info("getEnvironmentList:",n.platformId);var o=n.platformId?3e5:216e5,l=n.platformId;n.publicPlatform&&(l+=f),n.role&&(l=l+u+n.role),p[l]&&c[l]&&(!d[l]||r-d[l]<o)?n.onComplete(e.clone(c[l])):(d[l]=r,C[l]||(C[l]=[]),C[l].push({onComplete:n.onComplete,onFailure:n.onFailure}),m[l]||(v()?b(l):EventManager.addEventOnce("onInitialized",F)))},F=function(){v()&&Object.keys(C).forEach((function(e){b("null"===e?null:e)})),EventManager.removeEvent("onInitialized",F)},E=function(e){return n.composeUrl(n.parseUrl(e))},M=function(n,r){var o={};if(r&&r.services)return r.services.forEach((function(e){(!n||n&&!0===e.public)&&(o[e.name]=E(e.url))})),e.merge({platformId:r.id,displayName:r.name},o)},h=function(e,n){var r;if(n)return(r=n[e])?{platformId:n.platformId,url:r}:{platformId:n.platformId}},N=function(n,r){return e.clone(n.map(M.bind(null,r)))},L={getUser:o.getUser,getPlatformServices:function(n){if(n&&"function"===e.typeOf(n.onComplete)){var r={platformId:n.platformId,config:n.config,onComplete:function(r){var o,t=n.platformId,l=n.caa,i=N(r,l);o=t?e.Array.detect(i,(function(e){return e.platformId===t})):i,n.onComplete(o)},onFailure:n.onFailure};n.public&&(r.publicPlatform=!0),n.role&&(r.role=n.role),P(r)}},getPlatformConfig:function(n){if(n&&"function"===e.typeOf(n.onComplete)){var r={platformId:n.platformId,config:n.config,onComplete:function(r){var o,t=n.platformId,l=n.key,i=e.clone(r);o=t?e.Array.detect(i,(function(e){return e.id===t})):i.map((function(n){var r=n.config;if(l&&e.is(r[l])){var o=r[l];(r={})[l]=o}return e.merge({platformId:n.id,displayName:n.name},r)})),t&&o&&(o=l&&e.is(o.config[l])?o.config[l]:l?void 0:o.config),n.onComplete(o)},onFailure:n.onFailure};n.public&&(r.publicPlatform=!0),n.role&&(r.role=n.role),P(r)}},getServiceUrl:function(n){if(n&&n.serviceName&&"function"===e.typeOf(n.onComplete)){var r={platformId:n.platformId,config:n.config,onComplete:function(r){var o,t,l,i=n.platformId,a=n.caa,s=N(r,a);i?(o=e.Array.detect(s,(function(e){return e.platformId===i})),(t=h(n.serviceName,o))&&(l=t.url)):l=s.map(h.bind(null,n.serviceName)),n.onComplete(l)},onFailure:n.onFailure};n.public&&(r.publicPlatform=!0),n.role&&(r.role=n.role),P(r)}},_private:{callbacks:C,fireCallbacks:S,fetchEnvironmentList:D,getEnvironmentList:P,normalizeUrl:E,extractUrls:M,extractUrl:h,reset:function(){}}};return L}));