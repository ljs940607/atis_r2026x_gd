define("DS/CAT3DWMedia/CAT3DWMediaDataService",["UWA/Class"],(function(e){"use strict";var t=e.extend({init:function(){this._parent(),this._data={},this._saveData=[]},setValue:function(e,t){return this._data[e]=t,this._data[e]},setValues:function(e){for(var t in e)this.setValue(t,e[t])},getValue:function(e){return this._data[e]},getData:function(){return JSON.parse(JSON.stringify(this._data))},setData:function(e){return this._data=JSON.parse(JSON.stringify(e)),this._data},save:function(){this._saveData.push(JSON.parse(JSON.stringify(this._data)))},forgetChg:function(){this._saveData.length<=0?console.warn("Error during forgetChg : No data has been saved"):this._data=JSON.parse(JSON.stringify(this._saveData.pop()))},clearSave:function(){this._saveData=[]}});return UWA.namespace("DS/CAT3DWMedia/CAT3DWMediaDataService",t)})),define("DS/CAT3DWMedia/CAT3DWMediaView",["UWA/Core","DS/ApplicationFrame/FrameWindowsManager","DS/CAT3DWSceneObject/CAT3DWConnectableObject","DS/CAT3DWInfra/CAT3DWLogger","DS/CAT3DWVisu/CAT3DWVisuServices","DS/Visualization/MaterialApplication","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/CAT3DWVisu/CAT3DWNode3DHyperlink"],(function(e,t,i,a,n,s,r,o,d){"use strict";var c=r.extend(i,{init:function(e,i){this._parent(e.getID()),this._media=e,this._saveMatrix=[];var a=t.getFrameWindow();this._viewer=a.getViewer(),this._viewpoint=a.getViewpoint(),i.addChild(this),this._selectionMaterialApp=new s({lineMaterial:n.getSelectionMaterial()}),this._coSelectionMaterialApp=new s({lineMaterial:n.getCoselectionMaterial()})},initialize:function(){this._viewer.render()},getMediaObj:function(){return this._media},getManipulatorsPositions:function(){return this.getCorners()},dispose:function(){this._media=null,this._saveMatrix=[]},setMatrix:function(e,t){t||a.error("CAT3DWMediaView.setMatrix is deprecated, please use setTransformation !"),this.isLocked()||this._parent(e)},applyMatrix:function(e){a.error("CAT3DWMediaView.applyMatrix is deprecated, please use setTransformation !"),this.isLocked()||this._parent(e)},getCenter:function(){var e=this.getMatrixWorld();return this._getRectangleCenter(e)},updateHyperlinkNode:function(){if(this._media.getHyperlink()||"CAT3DSKLink"===this.getType()){var e=1;if("CAT3DWVideo"===this.getType()?e=1.4:"CAT3DWText"!==this.getType()&&"CAT3DSKLink"!==this.getType()||(e=.6),this._hyperlinkNode)this._hyperlinkNode.update(this.getCorners(),this.getMatrixWorld(),e);else{this._hyperlinkNode=new d(this.getCorners(),this.getMatrixWorld(),e),this.addChild(this._hyperlinkNode);var t=this.getDepth();this._hyperlinkNode.getChildren()[0].setRenderDepth(5*t)}}else this._media.getHyperlink()||this._hyperlinkNode&&(this._hyperlinkNode.deleteNode(),this._hyperlinkNode=null,this.removeChild(this._hyperlinkNode))},save:function(){this._saveMatrix.push(JSON.parse(JSON.stringify(this.getMatrix())))},forgetChg:function(){if(this._saveMatrix.length<=0)a.warn("Error during forgetChg : No matrix has been saved");else{var e=(new o.Matrix4).copy(JSON.parse(JSON.stringify(this._saveMatrix.pop())));this.setMatrix(e),this._viewer.render()}},clearSave:function(){this._saveMatrix=[]},isAlive:function(){return this._media.isAlive()},getID:function(){return this._media.getID()},getType:function(){return this._media.getType()},lock:function(e,t){t||this._media.lock(e,!0)},unlock:function(e,t){t||this._media.unlock(e,!0)},isLocked:function(){return this._media.isLocked()},group:function(e,t){return this._media.group(e,t)},ungroup:function(e){return this._media.ungroup(e)},isGrouped:function(){if(this._media)return this._media.isGrouped()},getGroupID:function(){return this._media.getGroupID()},activateSelectionFeedback:function(e=!1){this.isGrouped()&&!e||this.getPickable()&&(this._selectionNode?this._materialType!==n.MATERIAL_TYPE.SELECTION&&(this._materialType=n.MATERIAL_TYPE.SELECTION,this._selectionNode.removeMaterialApplication(),this._selectionNode.setMaterialApplication(this._selectionMaterialApp)):(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this._materialType=n.MATERIAL_TYPE.SELECTION,this._selectionNode.setMaterialApplication(this._selectionMaterialApp),this.addChild(this._selectionNode)),this._selectionNode.setVisibility(!0))},deactivateSelectionFeedback:function(){this._selectionNode&&this._materialType===n.MATERIAL_TYPE.SELECTION&&this._selectionNode.setVisibility(!1)},activateThirdPartySelectionFeedback:function(e){this.getPickable()&&(this._selectionNode?this._selectionNode.removeMaterialApplication():(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this.addChild(this._selectionNode)),this._materialType=n.MATERIAL_TYPE.CUSTOM,this._selectionNode.setMaterialApplication(new s({lineMaterial:n.getCustomMaterial(e||new o.Color("rgb(92,92,92)"),!1,.75)})),this._selectionNode.setVisibility(!0))},deactivateThirdPartySelectionFeedback:function(){this._selectionNode&&this._materialType===n.MATERIAL_TYPE.CUSTOM&&this._selectionNode.setVisibility(!1)},activateCoselectionFeedback:function(){this.getPickable()&&(this._selectionNode?this._materialType!==n.MATERIAL_TYPE.COSELECTION&&(this._materialType=n.MATERIAL_TYPE.COSELECTION,this._selectionNode.removeMaterialApplication(),this._selectionNode.setMaterialApplication(this._coSelectionMaterialApp)):(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this._materialType=n.MATERIAL_TYPE.COSELECTION,this._selectionNode.setMaterialApplication(this._coSelectionMaterialApp),this.addChild(this._selectionNode)),this._selectionNode.setVisibility(!0))},deactivateCoselectionFeedback:function(){this._selectionNode&&this._materialType===n.MATERIAL_TYPE.COSELECTION&&this._selectionNode.setVisibility(!1)},_rebuildSelectionNode:function(){if(this._selectionNode){const e=this._selectionNode.isVisible(),t=this._selectionNode.getMaterialApplication();this.removeChild(this._selectionNode),this._selectionNode=void 0,e&&(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this.addChild(this._selectionNode),this._selectionNode.setMaterialApplication(t),this._selectionNode.setVisibility(!0))}},undoAction:function(e){return this._media.undoAction(e)},redoAction:function(e){return this._media.redoAction(e)},setTransformation:function(e,t,i){return this._media.setTransformation(e,t,i)},getCurrentTransformation:function(){return this._media.getCurrentTransformation()},setProperties:function(e,t,i){return this._media.setProperties(e,t,i)},getCurrentProperties:function(){return this._media.getCurrentProperties()},setTransientPermanent:function(){return this._media.setTransientPermanent()},_transformationUpdate:function(e){this.setMatrix(e,!0),this.updateHyperlinkNode()},_propertiesUpdate:function(){},stream:function(e){return this._media.stream(e)},getAction:function(e){return this._media.getAction(e)},setAction:function(e,t){this._media.setAction(e,t)},hasAction:function(e){return this._media.hasAction(e)},get2DPortPositions:function(){let e=new o.Vector2,t=new o.Vector2,i=new o.Vector2,a=new o.Vector2,n=this.getCorners(),s=n.topRight.clone().sub(n.topLeft).multiplyScalar(.5).add(n.topLeft),r=n.topLeft.clone().sub(n.bottomLeft);e.set(r.x,r.y).normalize();let d=n.bottomLeft.clone().sub(n.bottomRight).multiplyScalar(.5).add(n.bottomRight);t=e.clone().negate();let c=n.bottomLeft.clone().sub(n.topLeft).multiplyScalar(.5).add(n.topLeft),h=n.bottomLeft.clone().sub(n.bottomRight);i.set(h.x,h.y).normalize();let l=n.topRight.clone().sub(n.bottomRight).multiplyScalar(.5).add(n.bottomRight);return a=i.clone().negate(),{top:{pointCoordinates:new o.Vector2(s.x,s.y),normal:e},bottom:{pointCoordinates:new o.Vector2(d.x,d.y),normal:t},left:{pointCoordinates:new o.Vector2(c.x,c.y),normal:i},right:{pointCoordinates:new o.Vector2(l.x,l.y),normal:a}}}});return e.namespace("DS/CAT3DWMedia/CAT3DWMediaView",c)})),define("DS/CAT3DWMedia/CAT3DWMediaManager",["DS/ApplicationFrame/FrameWindowsManager","DS/CoreEvents/Events","UWA/Class"],(function(e,t,i){"use strict";return i.extend({init:function(){this._mediaMap=new Map,this._garbagedMediaMap=new Map,this._rootNode=null},initialize:function(){var t=e.getFrameWindow();this._viewer=t.getViewer()},createMedia:function(e,t){if(!e)return-1;e.parentNode=this._rootNode,e.viewer=this._viewer,e.creationCallback=t,e.aliveCallback=this._onMediaAlive.bind(this),e.garbagedCallback=this._onMediaGarbaged.bind(this),e.idUpdatedCallback=this._onMediaIdUpdated.bind(this);var i=this.createMediaObject(e);return this._mediaMap.set(i.getID(),i),i.initialize(e),i},createMediaObject:function(){throw new Error("'DS/CAT3DWMedia/CAT3DWMediaManager' is an abstract class. You must implement this function.")},getMedia:function(e,t=!0){let i=null;return e&&(i=this._mediaMap.get(e),i||t||(i=this._garbagedMediaMap.get(e))),i},getNbMedia:function(e=!0){return e?this._mediaMap.size:this._mediaMap.size+this._garbagedMediaMap.size},getAllMedia:function(e=!0){var t=[];return this._mediaMap.forEach((e=>{t.push(e)})),e||this._garbagedMediaMap.forEach((e=>{t.push(e)})),t},removeMedia:function(e){if(e){let t=e.getID();this._mediaMap.get(t)&&(e.isUndoable()||this._mediaMap.delete(t),e.dispose()),this._viewer.render()}},reset:function(e){this._mediaMap=new Map,this._garbagedMediaMap=new Map,this._rootNode&&(this._rootNode.removeChildren(),this._rootNode=null),t.publish({event:this.getResetEvent(),data:e})},getResetEvent:function(){return"CAT3DWMediaManagerReset"},getRootNode:function(){return this._rootNode},_onMediaAlive:function(e){if(e){const t=e.getID();this._mediaMap.get(t)||this._mediaMap.set(t,e),this._garbagedMediaMap.delete(t)}},_onMediaGarbaged:function(e){if(e){const t=e.getID();this._garbagedMediaMap.get(t)||this._garbagedMediaMap.set(t,e),this._mediaMap.delete(t)}},_onMediaIdUpdated:function(e,t){e&&t&&(this._mediaMap.get(t)===e?(this._mediaMap.delete(t),this._mediaMap.set(e.getID(),e)):this._garbagedMediaMap.get(t)===e&&(this._garbagedMediaMap.delete(t),this._garbagedMediaMap.set(e.getID(),e)))}})})),define("DS/CAT3DWMedia/CAT3DWMedia",["UWA/Core","DS/CAT3DWMedia/CAT3DWMediaDataService","DS/CAT3DWSceneObject/CAT3DWConnectableObject","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS"],(function(e,t,i,a,n){"use strict";var s=i.extend({init:function(e){this._id=e.id,this._matrix=new n.Matrix4,e.mediaOccId&&(this._mediaOccId=e.mediaOccId),this._hyperlink=e.hyperlink?e.hyperlink:null,this._parentNode=e.parentNode,this._viewer=e.viewer,this.getDataService().setValue("thirdPartyColor",null),this._mediaView=this.createMediaView(this._parentNode,e),e.matrix&&this._matrix.copy(e.matrix),this._aliveCallback=e.aliveCallback,this._garbagedCallback=e.garbagedCallback,this._idUpdatedCallback=e.idUpdatedCallback,this._onTransformationCallbacks=[],this._parent(e),this._matrix.copy(this.getCurrentTransformation()),this._mediaView.setMatrix(this._matrix,!0)},updateID:function(e){let t=this._id;this._id=e.id,e.mediaOccId&&(this._mediaOccId=e.mediaOccId),this.getDataService().setValue("updateData",e),this._idUpdatedCallback&&this._idUpdatedCallback(this,t)},getUpdateData:function(){return{id:this._id,mediaOccId:this._mediaOccId}},dispose:function(){this._parentNode.remove(this._mediaView),this._mediaView.dispose(),this._mediaView=null},subscribeTransformation:function(e){this._onTransformationCallbacks.push(e)},unSubscribeTransformation:function(e){const t=this._onTransformationCallbacks.indexOf(e);this._onTransformationCallbacks.splice(t,1)},createMediaView:function(){throw new Error("You must implement this function")},getID:function(){return this._id},getMediaOccId:function(){return this._mediaOccId},getType:function(){return"CAT3DWMedia"},select:function(){this._mediaView.activateSelectionFeedback(),this.isSelected()||(this.getDataService().setValue("selected",!0),a.publish({event:"CAT3DSKSelectMediaEvent",data:{mediaID:this.getID(),type:this.getType()}}))},deselect:function(){this._mediaView.deactivateSelectionFeedback(),this.isSelected()&&(this.getDataService().setValue("selected",!1),a.publish({event:"CAT3DSKDeselectMediaEvent",data:{mediaID:this.getID(),type:this.getType()}}))},isSelected:function(){return this.getDataService().getValue("selected")},coselect:function(){!this.isAlive()||this.isSelected()||this.isGrouped()||this._mediaView.activateCoselectionFeedback()},decoselect:function(){this._mediaView.deactivateCoselectionFeedback()},lock:function(e,t){this._parent(e),t||this.getView().lock(e,!0)},unlock:function(e,t){this._parent(e),t||this.getView().unlock(e,!0)},get2DPortPositions:function(e){return this.getView().get2DPortPositions(e)},getCenter:function(){return this.getView().getCenter()},get2DProjectedPosition:function(e,t,i,a){return this.getView().get2DProjectedPosition(e,t,i,a)},getDataService:function(){return this._mediaData||(this._mediaData=new t),this._mediaData},getMatrix:function(){return this._matrix},setHyperlink:function(e,t){let i=this.getType();if("CAT3DWImage"===i||"CAT3DWText"===i||"CAT3DWVideo"===i){this._hyperlink=t;var a=this.getCurrentProperties(),n=JSON.parse(JSON.stringify(a));n.hyperlink=this._hyperlink,this.setProperties(e,n)}},getHyperlink:function(){return this._hyperlink},deleteHyperlink:function(e){this._hyperlink&&(this._hyperlink=null);var t=this.getCurrentProperties(),i=JSON.parse(JSON.stringify(t));delete i.hyperlink,this.setProperties(e,i)},getView:function(){return this._mediaView},save:function(){this.getDataService().save(),this.getView().save()},forgetChg:function(){this.getDataService().forgetChg()},clearSavedData:function(){this.getDataService().clearSave(),this.getView().clearSave()},getInititalState:function(){let e=this._parent();return e.transformation.matrixArray=this.getMatrix().toArray(),e},isUndoable:function(){return!1},_lifecycleUpdate:function(e){this.isUndoable()&&(e.alive?(this._parentNode.add(this._mediaView),this._aliveCallback&&this._aliveCallback(this)):(this.deselect(),this.decoselect(),this._parentNode.remove(this._mediaView),this._garbagedCallback&&this._garbagedCallback(this)))},_transformationUpdate:function(e){this._matrix.copy(e),this.getView()._transformationUpdate(e);for(let e=0;e<this._onTransformationCallbacks.length;e++)this._onTransformationCallbacks[e](this)},_propertiesUpdate:function(e){this._parent(e),void 0!==e.hyperlink&&(this._hyperlink=e.hyperlink),this._mediaView.updateHyperlinkNode()},copyHistoryOfPlaceholder:function(e){const t=function(e,t){if(0===e.length)return;let i,a=!1,n=null;t.activeIndex<0?a=!0:e.activeIndex===t.activeIndex&&e[e.activeIndex].timestamp===t[t.activeIndex].timestamp||(a=!0,n=t[t.activeIndex]);for(let a=0;a<e.length;a++)i=e[a],t[a]={timestamp:i.timestamp,active:i.active,data:i.data};t.activeIndex=e.activeIndex,a&&t.onChange(t[t.activeIndex],n)},i=t=>{const i=[];let a=-1;for(const n of t)a=e._getStackNumber(n),i.push(this._getStackFromNumber(a));return i};t(e._lifecycleHistoryArray,this._lifecycleHistoryArray),t(e._transformationHistoryArray,this._transformationHistoryArray),t(e._propertiesHistoryArray,this._propertiesHistoryArray),t(e._lockHistoryArray,this._lockHistoryArray),t(e._groupHistoryArray,this._groupHistoryArray),this._actionsHistoryMap.clear(),e._actionsHistoryMap.forEach(((e,t)=>{this._actionsHistoryMap.set(t,{stacks:i(e.stacks),indexes:e.indexes})})),this._transient=e._transient,this._transientMadePermanent=e._transientMadePermanent,this._transientDiscarded=e._transientDiscarded},stream:function(e){let t=this._parent(e);t.id=this.getID(),t.mediaId=this.getDataService().getValue("mediaId"),t.locked=this.isLocked(),t.matrix=this._mediaView.getMatrix(),t.renderDepth=this._mediaView.getDepth();const i=this.getHyperlink();return i&&(t.hyperlink=i),t},thirdPartySelect:function(e){this.getView().activateThirdPartySelectionFeedback(e.color),this.getDataService().setValue("thirdPartyUserInfo",e)},thirdPartyDeselect:function(){this.getView().deactivateThirdPartySelectionFeedback(),this.getDataService().setValue("thirdPartyUserInfo",null)},isThirdPartySelected:function(){return!!this.getDataService().getValue("thirdPartyUserInfo")},getThirdPartyUserInfo:function(){return this.getDataService().getValue("thirdPartyUserInfo")},callOnMediaSaveCB:function(e){if(!e.error){this.getDataService().setValue("mediaId",e.mediaId),this.getDataService().setValue("published",e.published);var t=this.getMediaOccId();if(e.mapOfMediaOccIdToMedia)for(let i=0;i<e.mapOfMediaOccIdToMedia.get(t).length;i++)e.mapOfMediaOccIdToMedia.get(t)[i].getDataService().setValue("mediaId",e.mediaId),e.mapOfMediaOccIdToMedia.get(t)[i].getDataService().setValue("published",e.published)}this._onMediaSavedCB&&(this.getView()&&this._onMediaSavedCB(),this._onMediaSavedCB=null)},onMediaSaved:function(e){this._onMediaSavedCB=e}});return e.namespace("DS/CAT3DWMedia/CAT3DWMedia",s)}));