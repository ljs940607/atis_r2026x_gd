/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationCommands/CAT3DAnnotationOpenFavoriteCtxCmd",["DS/CATWebUXComponents/DMUStateCommand","DS/Visualization/PathElement","DS/StateCommandEngine/PathElementAgent","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CoreEvents/Events"],(function(e,t,n,i,r,o,a,l,s){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var c,u,g,d=this,f=function(){u&&(i.empty(),r.empty())},A=function(){o.get().getViewer().setDefaultPicking(!0),g&&g()},p=function(e){if(!e||!e.externalPath||!e.externalPath.length||"RootBag"!==e.externalPath[0].name)return!1;for(var n=e.externalPath.length-1;n>=0;--n){var i=e.externalPath[n];if(l.isPLMNode(i))return!!l.is3DLeaf(i)&&new t(e.externalPath.slice(0,n+1))}},C=function(e){setTimeout((function(){if(c&&c.object3D&&1===c.object3D.length){r.empty();var t=a.giveFavoriteContextManager({context:o.get()});g=t.manageFavoriteContext({path:p(c.object3D[0].pathElement),onComplete:function(){g=null,A(),o.get().getExecutionContext&&s.publish({event:d.getId()+"/END",data:d}),e()}}).cancel}}),0)};this.buildGraph=function(){var e=o.get();e.getViewer().setDefaultPicking(!1),u=!0,g=null,c=new n({agentId:"CATFavoriteContextSelAgt",frameWindow:this.options.executionContext?void 0:e.getFrameWindow(),viewer:this.options.executionContext?e.getFrameWindow().getViewer():void 0,engWithPSOHSO:!0,withPSO:!0,withHSO:!0,valuedFromCSO:!0,saveToCSO:!1,pickingMode:"rep",prePickingMode:"rep",pickingFilter:p,prePickingFilter:p});var t=this.createInitialState("InitState"),i=this.getFinalState();this.addTransition({iInitialState:t,iFinalState:i,iEvent:c,iAction:C}),this.addTransition({iInitialState:t,iFinalState:i,iCondition:function(){var t=l.getRoots(e);if(t&&1===t.length&&t[0]&&l.is3DLeaf(t[0])){var n=e.getRootBagPath();return n.addElement(t[0]),c.object3D.push({pathElement:n}),!0}},iAction:C}),setTimeout(f)},this.cancelExecute=function(){A(),this.cancel()}}})})),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmdV2",["DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext"],(function(e,t){"use strict";return class{constructor(){this.beginExecute=function(){var n=t.get(),i=e.getDataLauncherController({context:n});i&&i.setActiveState(!0)},this.destroy=function(){var n=t.get(),i=e.giveDataLauncherController({context:n});i&&i.setActiveState(!1)},this.pauseExecute=function(){var n=t.get(),i=e.giveDataLauncherController({context:n});i&&i.setActiveState(!1),this.done()},this.resumeExecute=function(){var n=t.get(),i=e.giveDataLauncherController({context:n});i&&i.setActiveState(!0),this.done()}}}})),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationInitializerComponent",["DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/PADUtils/PADContext","DS/Selection/CSOManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/CATWebUXUtils"].concat(["i18n!DS/DMUBaseUIComponents/assets/nls/DMUBaseUIComponents"]),(function(e,t,n,i,r,o,a,l,s,c){"use strict";return class{constructor(u){var g,d,f;let A,p,C=null,h={},D=!1,m="Perspective",v=!1,S="selectParentReference",P=function(e,t){var i=[],o=[],a=[];if(g._defaultContextualMenuVisibility&&void 0!==e&&void 0!==e.XmousePositionWithDevPxRatio&&void 0!==e.YmousePositionWithDevPxRatio&&g.getViewer()){var l=r.get(),u=t?{x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio}:{x:e.XmousePositionWithDevPxRatio,y:e.YmousePositionWithDevPxRatio};if(0===g.getViewer().pick({xPix:u.x,yPix:u.y},"mesh",!0).path.length)a.push({category:c.ctxMenuDisplayTitle,hdrs:s.isMobile()?["ENO3DToggleStatusBarCmd"]:["VisuQMCommand","ENO3DToggleStatusBarCmd"]},{category:c.ctxMenuAmbienceTitle,hdrs:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]});else if(l.length){let e=!1;for(let t=0;t<l.length;t++)for(var d=0;d<l[t].pathElement.externalPath.length;d++)l[t].pathElement.externalPath[d].getDMUType&&(e=!0);if(!e){o.push("ENO3DFocusOnCmd"),o.push("ENO3DReframeOnCmd");let e=!g.getController().isRootSupported||l.length>=1&&l[0].pathElement.externalPath.length>=2&&g.getController().isRootSupported(n.getNodeID(l[0].pathElement.externalPath[1]));o.push("ENO3DHideShowCmd"),o.push("ActionBar_Attributes"),e&&a.push({category:c.ctxMenuQualityTitle,hdrs:["OptimizedQualityCmd","HighQualityCmd"]})}}for(let e=0;e<o.length;e++)"ENO3DToggleStatusBarCmd"===o[e]?i.push({type:"WAfrCheckHandlerItem",handlerId:o[e]}):i.push({type:"WAfrDefaultHandlerItem",handlerId:o[e]});return a.forEach((e=>{let t={type:"PushItem",title:e.category,submenu:[]};for(let n=0;n<e.hdrs.length;n++)"ENO3DToggleStatusBarCmd"===e.hdrs[n]?t.submenu.push({type:"WAfrCheckHandlerItem",handlerId:e.hdrs[n]}):t.submenu.push({type:"WAfrDefaultHandlerItem",handlerId:e.hdrs[n]});i.push(t)})),i}return i};this.initialize=function(){return new Promise((n=>{g=i.get(),d=o.getPreferenceManager({context:g.getFrameWindow()});var r=a.getSelectionManager({context:g});r.setActiveState(!0),A={activated:g.getViewer().picking.activated,trapSelection:g.getViewer().picking.trapSelection,trapGPU:g.getViewer().picking.trapGPU},p={activated:g.getViewer().pPicking.activated},d.setUnitsPreferencesDisplayFlag(!0),d.setDisplayPreferencesDisplayFlag(!0),d.set3DSelectionPreferencesDisplayFlag(!0),d.setMeasurePreferencesDisplayFlag(!0),d.setClippingPreferencesDisplayFlag(!0),t.initPrefManager({context:g.getFrameWindow()}).then((()=>{g&&(d&&(C=d.subscribe("com.ds.mep:onPrefUpdate",(function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)for(let n=0;n<t.repositories[e].preferences.length;n++)"SelectParentReferenceOr3DShape"===t.repositories[e].preferences[n].name?(h.selectParentReferenceOr3DShape=t.repositories[e].preferences[n].value,S=h.selectParentReferenceOr3DShape):"Select3DGeometry"===t.repositories[e].preferences[n].name?(h.select3DGeometry="true"===t.repositories[e].preferences[n].value,v=h.select3DGeometry):"ProjectionType"===t.repositories[e].preferences[n].name?(h.projectionType=t.repositories[e].preferences[n].value,m=h.projectionType):"Gravity"===t.repositories[e].preferences[n].name&&(h.gravity="true"===t.repositories[e].preferences[n].value,D=h.gravity);if(g&&g.getViewer()&&g.getViewer().currentViewpoint&&g.getViewer().currentViewpoint.control){let e=h.gravity?h.gravity:D;g.getViewer().currentViewpoint.getControl().setRotationRolling(!e),g.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e)}if(g&&g.getViewer()&&g.getViewer().currentViewpoint&&g.getViewer().currentViewpoint.setProjectionType("Perspective"===(h.projectionType?h.projectionType:m)?0:1),r){let e=h.select3DGeometry?h.select3DGeometry:v;r.setPicking(e?0:1)}if(r){let e=h.selectParentReferenceOr3DShape?h.selectParentReferenceOr3DShape:S;r.selectParentReference("select3DShape"!==e)}}))),l.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]}]).then((e=>{if(!g)return;let t=e.repositories;for(let e=0;e<t.length;e++)if("VisualizationRepository"===t[e].name)D="true"===t[e].preferences[0].value;else if("FrameGeneral"===t[e].name)m=t[e].preferences[0].value;else if("SelectionRepository"===t[e].name){let n=t[e].preferences;for(let e=0;e<n.length;e++)"Select3DGeometry"===n[e].name?v="true"===n[e].value:"SelectParentReferenceOr3DShape"===n[e].name&&(S=n[e].value)}"boolean"==typeof D&&(g.getViewer().currentViewpoint.getControl().setRotationRolling(!D),g.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!D)),"Perspective"!==m&&"Parallel"!==m||g.getViewer().currentViewpoint.setProjectionType("Perspective"===m?0:1),r&&r.setPicking(v?0:1),r&&r.selectParentReference("select3DShape"!==S)})).catch((e=>{"boolean"==typeof D&&(g.getViewer().currentViewpoint.getControl().setRotationRolling(!D),g.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!D)),"Perspective"!==m&&"Parallel"!==m||g.getViewer().currentViewpoint.setProjectionType("Perspective"===m?0:1),r&&r.setPicking(v?0:1),r&&r.selectParentReference("select3DShape"!==S),window.console.warn("Could not get server value, default value set instead.",e)})),require([u.controller||"DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance"],(function(n){var i=new n({ctxViewer:g});let r=setInterval((()=>{if(!g.getExecutionContext().getTargetApp()&&(clearInterval(r),i.setActiveState(!0),e.registerAnnotationController({annotController:i,context:g}),d)){var n=t.getPreferenceDefinitions({attributePrefs:void 0!==u.controller});f=n[0].id,d.addPreferences(n),d.setPreferredPreferenceContainersOrder([f,"MeasurePreferences"])}}),10)})),g.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"CATAnnotationsContextMenu",context:g.getCommandContext(),merge:!0,onContextualMenuReady:P}),g.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),g.getViewer().setPrePicking({activated:!0}),n())}))}))},this.clean=function(){return new Promise((n=>{g=i.get(),e.unreferenceAnnotationController({context:g}),d&&(d.removePreferences([f]),C&&(d.unsubscribe(C),C=null)),a.unreferenceSelectionManager({context:g}),g.getViewer().setPicking(A),g.getViewer().setPrePicking(p),f=d=null,t.cleanPrefManager(),o.unreferencePreferenceManager({context:g.getFrameWindow()}),g.getFrameWindow().getContextualUIManager().unregister("CATAnnotationsContextMenu"),g=null,n()}))},this.destroy=function(){return new Promise((e=>{e()}))},this.canBeParallelized=function(){return!1}}}})),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/PADUtils/PADContext","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],(function(e,t,n,i,r,o,a,l){"use strict";return e.extend({init:function(e){var s=e||{};this._parent(s,{mode:"exclusive",isAsynchronous:!0});var c=r.get(),u=this,g=t.giveDataLauncherController({context:c}),d=a.getSelectionManager({context:c});d.setActiveState(!0);var f,A=o.getPreferenceManager({context:c.getFrameWindow()});let p=null,C={},h=!1,D="Perspective",m=!1,v="selectParentReference",S={activated:c.getViewer().picking.activated,trapSelection:c.getViewer().picking.trapSelection,trapGPU:c.getViewer().picking.trapGPU},P={activated:c.getViewer().pPicking.activated};A.setUnitsPreferencesDisplayFlag(!0),A.setDisplayPreferencesDisplayFlag(!0),A.set3DSelectionPreferencesDisplayFlag(!0),A.setMeasurePreferencesDisplayFlag(!0),A.setClippingPreferencesDisplayFlag(!0),i.initPrefManager({context:c.getFrameWindow()}).then((()=>{c&&(A&&(p=A.subscribe("com.ds.mep:onPrefUpdate",(function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)for(let n=0;n<t.repositories[e].preferences.length;n++)"SelectParentReferenceOr3DShape"===t.repositories[e].preferences[n].name?(C.selectParentReferenceOr3DShape=t.repositories[e].preferences[n].value,v=C.selectParentReferenceOr3DShape):"Select3DGeometry"===t.repositories[e].preferences[n].name?(C.select3DGeometry="true"===t.repositories[e].preferences[n].value,m=C.select3DGeometry):"ProjectionType"===t.repositories[e].preferences[n].name?(C.projectionType=t.repositories[e].preferences[n].value,D=C.projectionType):"Gravity"===t.repositories[e].preferences[n].name&&(C.gravity="true"===t.repositories[e].preferences[n].value,h=C.gravity);if(c&&c.getViewer()&&c.getViewer().currentViewpoint&&c.getViewer().currentViewpoint.control){let e=C.gravity?C.gravity:h;c.getViewer().currentViewpoint.getControl().setRotationRolling(!e),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e)}if(c&&c.getViewer()&&c.getViewer().currentViewpoint&&c.getViewer().currentViewpoint.setProjectionType("Perspective"===(C.projectionType?C.projectionType:D)?0:1),d){let e=C.select3DGeometry?C.select3DGeometry:m;d.setPicking(e?0:1)}if(d){let e=C.selectParentReferenceOr3DShape?C.selectParentReferenceOr3DShape:v;d.selectParentReference("select3DShape"!==e)}}))),l.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]}]).then((e=>{if(!c)return;let t=e.repositories;for(let e=0;e<t.length;e++)if("VisualizationRepository"===t[e].name)h="true"===t[e].preferences[0].value;else if("FrameGeneral"===t[e].name)D=t[e].preferences[0].value;else if("SelectionRepository"===t[e].name){let n=t[e].preferences;for(let e=0;e<n.length;e++)"Select3DGeometry"===n[e].name?m="true"===n[e].value:"SelectParentReferenceOr3DShape"===n[e].name&&(v=n[e].value)}"boolean"==typeof h&&(c.getViewer().currentViewpoint.getControl().setRotationRolling(!h),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!h)),"Perspective"!==D&&"Parallel"!==D||c.getViewer().currentViewpoint.setProjectionType("Perspective"===D?0:1),d&&d.setPicking(m?0:1),d&&d.selectParentReference("select3DShape"!==v)})).catch((e=>{"boolean"==typeof h&&(c.getViewer().currentViewpoint.getControl().setRotationRolling(!h),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!h)),"Perspective"!==D&&"Parallel"!==D||c.getViewer().currentViewpoint.setProjectionType("Perspective"===D?0:1),d&&d.setPicking(m?0:1),d&&d.selectParentReference("select3DShape"!==v),window.console.warn("Could not get server value, default value set instead.",e)})),require([s.annotControllerLib||"DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance"],(function(e){var t=new e({ctxViewer:c});if(t.setActiveState(!0),n.registerAnnotationController({annotController:t,context:c}),A){var r=i.getPreferenceDefinitions({attributePrefs:void 0!==s.annotControllerLib});f=r[0].id,A.addPreferences(r),A.setPreferredPreferenceContainersOrder([f,"MeasurePreferences"])}})),c.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),c.getViewer().setPrePicking({activated:!0}))})),this.beginExecute=function(){g&&g.setActiveState(!0)},this._endExecute=function(){g&&g.setActiveState(!1)},this.destroy=function(){this._endExecute()},this.pauseExecute=function(){g&&g.setActiveState(!1),this.done()},this.resumeExecute=function(){g&&g.setActiveState(!0),this.done()};var b=this._destroy;this._destroy=function(){b.call(u),n.unreferenceAnnotationController({context:c}),A&&(A.removePreferences([f]),p&&(A.unsubscribe(p),p=null)),a.unreferenceSelectionManager({context:c}),c.getViewer().setPicking(S),c.getViewer().setPrePicking(P),f=A=null,i.cleanPrefManager(),o.unreferencePreferenceManager({context:c.getFrameWindow()}),u=c=g=null}}})})),define("DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationPanels/CAT3DAnnotationFilterPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/DMUCommandsManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController"],(function(e,t,n,i,r,o,a,l,s,c){"use strict";var u=e.extend({init:function(e){var u=e||{};this._parent(u);var g,d,f,A,p,C,h=l.getOption("CAT3DANN_FILTER_PANEL_VER1")?1:2,D=!1,m=!1,v=this,S=u.ctxViewer,P=200,b=P,T=!1,y=[],w=[],V=[],F={},x={},R={},O={},U=0,M=new t,k=!0,W=!1,E=0,L=0,I=150,_=0,B=!0,N=!1,X=!1,G=!1;var j=function(e,t){return M.publish({event:e,data:t,context:this})},z=function(e){!N&&B&&D&&!X&&!G&&g.getActiveState()&&(e&&(W=e),E&&(clearTimeout(E),E=0),E=setTimeout((function(){v._internalRefresh(),I=150,E=0}),I))},H=c.subscribe("onPreferenceModified",(function(e){var t;if(-1!==e.preference.indexOf("CATWebUXMePreferences_SemanticAttribute_")){var n,i=e.preference.substring(e.preference.indexOf("e_")+2,e.preference.length),r=v.getAttributeTypesFiltered();for(t=0;t<w.length;t++)if(w[t].name===i){w[t].filteredByPref=!e.value,n=!0;break}n||w.push({name:i,filteredByPref:!e.value,filtered:!1});var o=v.getAttributeTypesFiltered();z();var a=o.length!==r.length;if(!a)for(t=0;t<o.length;t++)if(-1===r.indexOf(o[t])){a=!0;break}a&&j("onAttributesVisibilityModified",{attributesFiltered:o})}})),q=function(){for(var e=c.getPreference("3DAnnotAttributesOrderedList"),t=e.length-1;t>=0;t--)c.getPreference("CATWebUXMePreferences_SemanticAttribute_"+e[t])&&e.splice(t,1);return e},J=function(e){if(y&&y.length&&y[e[0]]){var t=y[e[0]];if(1===e.length)return t.path;if(t.children&&t.children[e[1]]){var n=t.children[e[1]];if(2===e.length)return n.path;if(n.path){var i=n.path.getChildrenPathes();if(i&&i.length&&i[e[2]]){var r=i[e[2]];if(3===e.length)return r;var o=i[e[2]].getChildrenPathes();if(o&&o.length&&o[e[3]])return o[e[3]]}}}}},Q=function(e){D&&(L+=!0===e?1:-1,_&&(clearTimeout(_),_=0),A&&(A.setEnableFlag(L>=0),L<0&&(_=setTimeout((function(){D&&A&&A.setEnableFlag(!0),L=0}),2e4))))},Y=function(e){E&&(clearTimeout(E),E=0),A&&(b=A.getWidth(),A.clean(),A=null),f&&f.cleanPanel(e)},K=function(){if(sessionStorage)if("true"===sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id))sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"false"),A.setWidth(P);else{var e=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id));e&&e!==P&&(sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true"),A.setWidth(e))}},Z=function(e){var t=J(e[0].idPath);V.push(o.getNodeID(t.getLastElement(!0))),d.loadFTAModel({path:t,loadChildren:!0}),A&&A.isSmallWidth()&&f&&"AnnotSetAll"===f.getCurrentAnnotationSetSection()&&A.collapsePanel()},$=function(e){N=!0;for(var t=0;t<e.length;t++){var n=J(e[t].idPath);n&&n.getLastElement(!0).setVisibility(e[t].visuFlag)}A&&A.isSmallWidth()&&f&&"AnnotSetAll"===f.getCurrentAnnotationSetSection()&&A.collapsePanel(),S.getViewer().render(),N=!1},ee=function(e){var t,n=!1,i=v.getAttributeTypesFiltered();for(t=0;t<e.length;t++){for(var r=null,o=0;o<w.length;o++)if(w[o].name===e[t].name){r=o;break}null!==r?w[r].filtered=!e[t].visuFlag:w.push({name:e[t].name,filtered:!e[t].visuFlag,filteredByPref:!1})}var a=v.getAttributeTypesFiltered();if(!(n=a.length!==i.length))for(t=0;t<a.length;t++)if(-1===i.indexOf(a[t])){n=!0;break}n&&j("onAttributesVisibilityModified",{attributesFiltered:a})};function te(){if(f){var e=!1;S.getRootBagPath().getChildrenPathes().some((function(t){return S.getController().isLargeDataStructure(o.getNodeID(t.getLastElement(!0)))&&(e=!0),e})),f.setOptionsAvailableFlag({AnnotSetAll:!e})}}for(var ne=function(e){if(f){if(e)for(var t=0;t<y.length;t++)for(var n=0;n<y[t].children.length;n++){var i=y[t].children[n].path.getLastElement(!0).toJSON();Object.assign(y[t].children[n],i)}f.updatePanel({model:y,attrTypesFilteredByPref:q(),attrTypesOrderedList:c.getPreference("3DAnnotAttributesOrderedList")})}},ie=q(),re=0;re<ie.length;re++)w.push({name:ie[re],filteredByPref:!0,filtered:!1});this._internalRefresh=function(){D&&v&&"function"==typeof p&&(W?(y.splice(0,y.length),A||function(){if(Y(),f||(f=new n({style:{version:h,semanticUI:"3DAnnotationInsight"===g.getAnnotationControllerType()}}),(O={}).onFilterPanelResized=f.subscribe("onFilterPanelResized",K),O.onAnnotationSetsLoadingRequired=f.subscribe("onAnnotationSetsLoadingRequired",Z),O.onAnnotationsVisibilityModified=f.subscribe("onAnnotationsVisibilityModified",$),O.onAttributesVisibilityModified=f.subscribe("onAttributesVisibilityModified",ee)),A)f.buildPanel(y);else{var e;"true"===sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id)&&(e=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id))),e||(e=void 0!==b?b:P),b=e;var t={id:"CAT3DAnnotFilterPanel",className:"CAT3DAnnotFilterSidePanel",showTitleFlag:!1,icon:"fonticon fonticon-annotationFilter CAT3DAnnotFilterIcon",frameWindow:S.getFrameWindow(),immersiveFrame:S.getFrameWindow().getImmersiveFrame(),closeButtonFlag:!1,viewerFrame:S.getFrameWindow().getViewerFrame(),content:f.buildPanel({model:y,attrTypesFilteredByPref:q(),attrTypesOrderedList:c.getPreference("3DAnnotAttributesOrderedList")}),minHeight:330,minWidth:P,width:e,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,onPanelResizedCB:function(e){e.currentDockArea!==WUXDockAreaEnum.RightDockArea&&e.currentDockArea!==WUXDockAreaEnum.LeftDockArea||(b=e.width,e.widthModifiedInteractively&&(sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true"),sessionStorage.setItem("CAT3DAnnotFilterWidth_"+widget.id,e.width)))}};A=new i(t)}te(),A&&y&&A.setPanelVisibilityFlag(k&&0!==y.length),A.setEnableFlag(L>=0)}(),p((function(e){if(D){for(var t,n=(y=e).length-1;n>=0;n--)t=o.getNodeID(y[n].path.getLastElement(!0)),"R2V_Activity"!==o.getNodeType(y[n].path.getLastElement(!0))?(y[n].hasBeenEntirelyLoaded=-1!==V.indexOf(t),y[n].hasBeenEntirelyLoaded&&0===y[n].children.length&&y.splice(n,1)):y.splice(n,1);ne(!1),A.setPanelVisibilityFlag(k&&0!==y.length),y.length&&A.setEnableFlag(L>=0)}}))):(ne(!0),A&&y&&A.setPanelVisibilityFlag(k&&0!==y.length)))},this.setActiveState=function(e){if(D=e,g&&d){var t;if(p||(p=g.onAdditionalInfosRequired({controller:"AnnotFilter"}).getJSONModel),L=0,D){if(!T){var n=function(){B=!0,z(!0)};X=!(g.getActiveState()&&d.getActiveState());var i=function(){g.getActiveState()&&d.getActiveState()?(X=!1,z(!0)):(Y(),X=!0)};F.onLoadingComplete=S.subscribe({event:"onLoadingComplete"},n),F.onLoadingFailure=S.subscribe({event:"onLoadingFailure"},n),F.onLoadingCanceled=S.subscribe({event:"onLoadingCanceled"},n),F.onRootAdded=S.subscribe({event:"onRootAdded"},te),F.onRootRemoved=S.subscribe({event:"onRootRemoved"},(function(){B=!0,I=0,z(!0)})),x.onAnnotControllerActiveStateChanged=g.subscribe("onAnnotControllerActiveStateChanged",i),x.onAnnotationsLinkedDataSolved=g.subscribe("onAnnotationsLinkedDataSolved",(function(e){!0===e.succeeded&&z()})),R.onAnnotModelLoaderActiveStateChanged=d.subscribe("onAnnotModelLoaderActiveStateChanged",i),R.onAnnotationVisibilityModifiedToken=d.subscribe("onAnnotationVisibilityModified",(function(e){z("tpsAnnotationSet"===e.node.getAnnotationClassType())})),R.onAnnotationSetLoadingFailedToken=d.subscribe("onAnnotationSetLoadingFailed",(function(){B=!0,Q(!0),z(!0)})),R.onAnnotationSetLoadedToken=d.subscribe("onAnnotationSetLoaded",(function(){B=!0,Q(!0),z(!0)})),R.onAnnotationSetPartiallyLoaded=d.subscribe("onAnnotationSetPartiallyLoaded",(function(){B=!0,Q(!0),z(!0)})),R.onAnnotationSetRemovedToken=d.subscribe("onAnnotationSetRemoved",(function(){B=!0,z(!0)})),R.onAnnotationSetBeginLoadToken=d.subscribe("onAnnotationSetBeginLoad",(function(){B=!1,Q(!1)})),R.onAnnotationSetLoadingCanceledToken=d.subscribe("onAnnotationSetLoadingCanceled",(function(){B=!0,Q(!0),z(!0)})),R.onNoAnnotationSetLoadedToken=d.subscribe("onNoAnnotationSetLoaded",(function(e){e&&e.loadingAlreadyStarted&&(B=!0,Q(!0)),z(!0)})),x.onViewOrCaptureDisplayedToken=g.subscribe("onViewOrCaptureDisplayed",(function(){B=!0,z()})),R.onVisuModificationToken=d.subscribe("onAnnotationParentVisibilityModified",(function(){z(!0)})),U=S.getViewer().onSwapVisibleSpace?S.getViewer().onSwapVisibleSpace((function(){G=0===S.getViewer().getVisibleSpace(),1===S.getViewer().getVisibleSpace()?z(!0):Y()})):null,G=0===S.getViewer().getVisibleSpace(),ie=q();var r=!1;for(t=0;t<ie.length;t++){for(var o=!1,l=0;l<w.length;l++)if(w[l].name===ie[t]){o=!0,w[l].filteredByPref=!0;break}o||w.push({name:ie[t],filteredByPref:!0,filtered:!1})}for(var c=0;c<w.length;c++)w[c].filtered&&(w[c].filtered=!1,r=!0);r&&j("onAttributesVisibilityModified",{attributesFiltered:v.getAttributeTypesFiltered()}),T=!0}var u=B;B=!0,z(!0),B=u}else{var h;if(f){for(h=Object.keys(O),t=0;t<h.length;t++)f.unsubscribe(O[h[t]]);f.cleanPanel(),f=null}if(O={},A&&(A.clean(),A=null),T){for(h=Object.keys(F),t=0;t<h.length;t++)S.unsubscribe(F[h[t]]);for(h=Object.keys(x),t=0;t<h.length;t++)g.unsubscribe(x[h[t]]);for(h=Object.keys(R),t=0;t<h.length;t++)d.unsubscribe(R[h[t]]);U&&S.getViewer()&&S.getViewer().unsubscribe(U),U=0,F={},x={},R={},Y(!0),T=!1}E&&(clearTimeout(E),E=0),_&&(clearTimeout(_),_=0),y.splice(0,y.length),B=!0}j("onAnnotationFilterActiveStateModified",{state:D})}else C||(C=setInterval((function(){d=s.giveAnnotationModelLoader({context:S}),(g=a.giveAnnotationController({context:S}))&&d&&(clearInterval(C),C=null,v.setActiveState(D))}),100))},this.getActiveState=function(){return D},this.setControllerEnableFlag=function(e){let t=Boolean("wafr"===require("DS/PADUtils/PADSettingsMgt").getSetting("eno3dviewer_infrastructure_version"))?"AnnotationFilter":"CAT3DAnnotationFilterHdr";var n=r.getCommandCheckHeader(t,S.getCommandContext());n&&(e?n.enable():n.disable()),m?(v.setActiveState(!0),m=!1):e||D&&(v.setActiveState(!1),m=!0,p=g=d=null)},this.setPanelVisibilityFlag=function(e){k=e,A&&y&&A.setPanelVisibilityFlag(k&&0!==y.length)},this.getPanelVisibilityFlag=function(){return k},this.clearController=function(){v.setActiveState(!1),C&&clearInterval(C),H&&c.unsubscribe(H),H=0,g=d=y=V=null,C=null,p=null,M=S=v=w=null},this.getAttributeTypesFiltered=function(){for(var e=[],t=0;t<w.length;t++)(w[t].filteredByPref||w[t].filtered)&&e.push(w[t].name);return e},this.subscribe=function(e,t){if(e&&t)return M.subscribe({event:e},t)},this.unsubscribe=function(e){M&&e&&M.unsubscribe(e)}}}),g=[];return e.singleton({init:function(){},give3DAnnotFilterController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].filterController},get3DAnnotFilterController:function(e){var t;if(e&&e.context&&!(t=this.give3DAnnotFilterController(e))){var n=new u({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return n?n.getActiveState():null},clearController:function(){n&&(n.clearController(),n=null)},getAttributeTypesFiltered:function(){return n?n.getAttributeTypesFiltered():null},setControllerEnableFlag:function(e){if(n)return n.setControllerEnableFlag(e)},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return n?n.getPanelVisibilityFlag():null},subscribe:function(e,t){return n?n.subscribe(e,t):null},unsubscribe:function(e){n&&n.unsubscribe(e)}}),g.push({context:e.context,filterController:t})}return t},unreference3DAnnotFilterController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context){g[t].filterController.clearController(),g.splice(t,1);break}}})})),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationCommands",[],(function(){})),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationFilterCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"],(function(e,t,n){"use strict";let i,r;var o=e.extend({init:function(e){this._parent(e,{});var t=this;r=n.get3DAnnotFilterController({context:i});var a=this.onStateChange((function(){t.getState()?o.OpenAnnotationFilterBrowser():o.CloseAnnotationFilterBrowser()})),l=this._destroy;this._destroy=function(){i&&n.unreference3DAnnotFilterController({context:i}),t._modelEvents.unsubscribe(a),l.call(t)},this.setState("false"!==localStorage.getItem("CAT3DAnnotationFilterCmd"),!0)},_destroy:function(){this._parent()}});return o.OpenAnnotationFilterBrowser=function(e,o){!i&&o?i=o.executionContext.getComponent("Viewer"):i||o||(i=t.get()),r=n.get3DAnnotFilterController({context:i}),r.setActiveState(!0),localStorage.setItem("CAT3DAnnotationFilterCmd","true"),require(["DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],(function(e){e._sendUsageProbe("command","CAT3DAnnotationFilterBrowserOpen")})),e&&e()},o.CloseAnnotationFilterBrowser=function(e,o){!i&&o?i=o.executionContext.getComponent("Viewer"):i||o||(i=t.get()),r||(r=n.give3DAnnotFilterController({context:i})),r&&r.setActiveState(!1),localStorage.setItem("CAT3DAnnotationFilterCmd","false"),require(["DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],(function(e){e._sendUsageProbe("command","CAT3DAnnotationFilterBrowserClose")})),e&&e()},o}));