/*!  Copyright 2025 Dassault Systemes. All rights reserved. */
define("DS/SMAXCTSimBridge/ECDSXMStreamsAccess",["UWA/Class","DS/ECStreamsAccess/ECStreamsAccessAbstract","DS/CAT3DExpModel/CAT3DXModel"],(function(e,t,a){"use strict";return t.singleton({init:function(e){},load:function(e){return new Promise(((t,i)=>{if(e&&(e.streamName||e.experienceObject)){let i;if(e.experienceObject?i=e.experienceObject._GetAsset().linkDescription:e.streamName&&(i="ExpCore://localMedia/Streams/"+e.streamName),i){a._getExpCoreLinkManager().resolveLink(i).then((e=>{t(e)}))}}}))},getMediaInformation:function(){const e=a._getExpCoreLinkManager();return new Promise(((t,a)=>{const i=e.resolveLink("ExpCore://localMedia/Streams/manifest.json");i.catch((e=>a(e))),i.then((e=>{const a=JSON.parse(e.getText());t({version:a.mediaInformation.version,requiredCapabilities:a.mediaInformation.requiredCapabilities})}))}))}})})),define("DS/SMAXCTSimBridge/LWfromDSXMFactory",["UWA/Core","DS/SPY/CATSimNavDataLWFactory"],(function(e,t){"use strict";return t.extend({init:function(){this._parent(),this.filteringOptions={categories:["Result"],excludedTypes:["CATSimNavDataFrameViewXYChart","CATSimNavData3DCamerasRoot"],types:{},noRenderingMaterial:!0}},parseXML:function(e,t,a,i,n){this._parent(e,t,a,i,n,this.filteringOptions)},createSequence:function(e,t){if(e&&e.lwDictionary&&e.ecStreamsAccess){const a=e.lwDictionary.getText();let i=(new DOMParser).parseFromString(a,"text/xml").firstChild,n={idx:e.spm.sequences.length,name:"sequence",listDD:[],listDDShared:[],ecStreamsAccess:e.ecStreamsAccess};
//!! not sure of the actors order, id of seq could be extracted from the dictionary name
e.spm.sequences[n.idx]=n,this.parseXML(i,n,e.spm,(function(e,a){t&&t.onComplete&&t.onComplete()}),(function(e){console.error("SMAXCTSimBridge - Error loading the simulation experience content datamodel")}))}}})})),define("DS/SMAXCTSimBridge/DSXMBridge",["UWA/Class","DS/CoreEvents/Events","DS/SMAXCTSimBridge/LWfromDSXMFactory","DS/SMAXCTSimBridge/ECDSXMStreamsAccess","DS/SPY/SimulationPlayerModel","DS/SPYVisuTools/SPYTexturesProcessor"],(function(e,t,a,i,n,r){"use strict";const s="SMACXP3DElementActor_Spec",o="_simulationAnimations",l="title",d="NotCreated",c="Loading",m="Loaded",u="SimulationVisuStreamsToLoad",D="SimulationLegendDescription",p="SimulationAnimationFrameUpdate";let g=e=>e&&e.getType&&"CATSimNavData3DExtremasRoot"!==e.getType()&&"CATSimNavData3DCamerasRoot"!==e.getType(),h=(e,t)=>!(!Array.isArray(t)||0===t.length)&&t.includes(e.getName()),f=(e,t,a)=>{Array.isArray(e)&&e.forEach((e=>{if(e&&g(e)&&!h(e,a)){let a,i;e.getAllLoadingDescription?(i=e.getAllLoadingDescription(),i&&i.Geometry&&(a=i.Geometry.files)):a=e.getGeometryFiles();const n=a.map((e=>e.replace(/\.[^/.]+$/,".glb")));let r={elementId:e.id?e.id:e.name,streams:n};i&&Array.isArray(i.Geometry.matrices)&&(r.matrices=i.Geometry.matrices.map((e=>e.elements))),t.push(r)}}))},A=e=>{e&&e.spm&&(e.spm.clean(),delete e.spm)};return e.singleton({LW_DM_STATE_NOTCREATED:d,LW_DM_STATE_LOADING:c,LW_DM_STATE_LOADED:m,_msrECDataModels:new Map,_getAVPComManager:function(e){return this._avpComManager||(this._avpComManager=e.GetParent()._experienceBase.getManager("CAT3DXAVPComManager")),this._avpComManager},_getVisuManager:function(e){return this._visuManager||(this._visuManager=e.GetParent()._experienceBase.getManager("CAT3DXVisuManager")),this._visuManager},_listAVPStreamsForElement:function(e,t){return new Promise(((a,i)=>{e&&t||i(new Error("invalid arguments"));const n={expObject:{pathOfIds:e.GetObject().GetID(),types:e.GetObject().GetTypes()},datasPerElement:[]};f([t],n.datasPerElement),a(n)}))},_listAVPStreamsForDataDisplay:function(e,t){return new Promise(((a,i)=>{e&&t||i(new Error("invalid arguments"));const n={pathOfIds:e.GetObject().GetID(),types:e.GetObject().GetTypes()},r={expObject:n,datasPerElement:[]},s=t.getNavData3DViewList();let o=this._exposed3DElementsMap.get(n.pathOfIds);f(s,r.datasPerElement,o),a(r)}))},_getLegendDescription:function(e,t,a,i){let n;return new Promise(((r,s)=>{if(e&&e.loaded){let o=e.spm,d=this._bridgeMap.get(t);if(!d){let e=o.findSequenceByName(t);e>=0&&(d=o.sequences[e])}if(d){let e=this._bridgeMap.get(a);if(!e){let t=o._findDataDisplay(d.idx,{name:a,allowNameComparison:!0});t>=0&&(e=o.getDataDisplayList(d.idx)[t])}if(e)if(n=e.getLegend(),n){let e=i.HasVariable(l)?i.GetValueByName(l):void 0,t=this.getActorID(i),s={title:void 0===e||""===e?n.title:e,contentName:a,unit:n.getUnit(),minValue:isNaN(n.min)?void 0:n.min,maxValue:isNaN(n.max)?void 0:n.max,userMinValue:n.getUserMin(),userMaxValue:n.getUserMax(),computedMinValues:n.localMin,computedMaxValues:n.localMax,deformationScales:n.deformationScales,scaleFactor:isNaN(n.scaleFactor)?void 0:n.scaleFactor};this._bridgeMap.set(t,s),r(s)}else s(new Error("invalid legend"));else s(new Error("invalid datadisplay"))}else s(new Error("invalid sequence"))}else s(new Error("invalid datamodel or datamodel not loaded yet"))}))},_getDataDisplay:function(e,t,a){return new Promise(((i,n)=>{let r;if(e&&e.loaded){let s=e.spm,o=this._bridgeMap.get(t);if(!o){let e=s.findSequenceByName(t);e>=0&&(o=s.sequences[e])}if(o){this._bridgeMap.set(t,o);let e=s._findDataDisplay(o.idx,{name:a,allowNameComparison:!0});e>=0&&(r=s.getDataDisplayList(o.idx)[e])}else n(new Error("invalid sequence"));r?(this._bridgeMap.set(a,r),i(r)):n(new Error("invalid datadisplay"))}else n(new Error("invalid datamodel or datamodel not loaded yet"))}))},_get3DElement:function(e,t,a,i){return new Promise(((n,r)=>{let s;e&&e.loaded?this._getDataDisplay(e,t,a).then((e=>{if(e){var t=e.getNavData3DViewList();s=t.find((e=>e.getName()===i)),s?(this._bridgeMap.set(i,s),n(s)):r(new Error("invalid 3D element"))}else r(new Error("invalid datadisplay"))})):r(new Error("invalid datamodel or datamodel not loaded yet"))}))},_getAnimSetupPromise:function(e,t){return new Promise(((a,i)=>{if(t){let n;if(e){const i=this.getAnimationInterface();e.QI(i,(e=>{e.initAnimation((()=>{t.animateAll||e.setActiveGroups(t.activeGroupsIds),e.updateActiveGroupsTimeProjection(t.duration),n=e.getFrameIndexFromPosition(t.authoringFrame),a(n)}),{renderRequest:()=>{this.requestRender()},resultActor:t.resultActor})}))}else i(new Error("animSetupPromise error"))}else a()}))},_getNodeFrom3DElement:function(e,t,a,i,n){return new Promise(((t,r)=>{let s=e.getDataDisplay();this._getAnimSetupPromise(s,n).then((n=>{e?e.QI("CATISimNavDataSpecUI",(e=>{e&&(e.node?(a.addChild(e.node),t(e.node)):e.build3D({existingNode:a,animationIndex:n,callback:e=>{i&&i.processLoadFiles("Geometry"),t(e)}}))})):r(new Error("invalid 3D element"))}))}))},_getNodeFromDataDisplay:function(e,t,a,i,n){return new Promise(((t,r)=>{this._getAnimSetupPromise(e,n).then((n=>{e?e.QI("CATISimNavDataDisplayUI",(e=>{e&&(e.node?(a.addChild(e.node),t(e.node)):e.build3D({animationIndex:n,existingNode:a,callback:e=>{t(e)},list3DViewsToFilter:i}))})):r(new Error("invalid datadisplay"))}))}))},getAnimationSetup:function(e){let t,a,i,n=e.GetType();if("SMACXPDataDisplayActor_Spec"===n)e.HasVariable(o)&&(t=e.GetValueByName(o),i=e);else if(n===s){let a=e.GetParent().QueryInterface("CATI3DExperienceObject");a.HasVariable(o)&&(t=a.GetValueByName(o),i=a)}if(Array.isArray(t)&&t.length>0){let e=t[0].GetObject().QueryInterface("CATI3DExperienceObject");a={authoringFrame:e.GetValueByName("authoringFrame"),duration:e.GetValueByName("duration"),animateAll:e.GetValueByName("animateAll"),resultActor:i},a.activeGroupsIds=[],a.animateAll||(a.activeGroupsIds=e.GetValueByName("animationScope"))}return a},init:function(e){this._ctx="EC_INTEGRATION_CONTEXT",i.getMediaInformation().then((e=>{e&&Array.isArray(e.requiredCapabilities)&&(this.isTargetXR=e.requiredCapabilities.includes("xr"))})),this._bridgeMap=new Map,this._exposed3DElementsMap=new Map},getLWDataModelState:function(e){let t=d,a=this._msrECDataModels.get(e);return a&&(t=a.loaded?m:c),t},loadDataModel:function(e){return new Promise(((r,o)=>{if(e&&e.assetId){let o=e.assetId,l={context:this._ctx,msrID:o},d=this._msrECDataModels.get(o);if(d||(d={spm:new n(l),refCount:0,loaded:!1,success:!1,errors:[],warnings:[],infos:[],addReference:function(){this.refCount++},subReference:function(){this.refCount--},isReferenced:function(){return this.refCount>0}},this._msrECDataModels.set(o,d)),d.addReference(),d.loaded)r();else{this._dmFactory||(this._dmFactory=new a);let n=e.experienceObject,l=[],c=n.QueryInterface("CATICXPActorsMgr");if(c){
//!! we could try to resolve the links for all actors once before loading the xml
let e=[];c.ListActors(e),e.forEach((e=>{const t=[];e.QueryInterface("CATICXPActorsMgr").ListActors(t),t.forEach((e=>{const t=e.QueryInterface("CATI3DExperienceObject"),a=this.getActorID(t),i=[];e.QueryInterface("CATICXPActorsMgr").ListActors(i);let n=[];i.forEach((e=>{if(e&&e.GetType()===s){const t=e.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName");n.push(t)}})),this._exposed3DElementsMap.set(a,n)}));let a=e.QueryInterface("CATI3DExperienceObject");l.push(new Promise(((e,t)=>{i.load({experienceObject:a}).then((t=>{
//!! not sure of the actors order, id of seq could be extracted from the dictionary filename
this._dmFactory.createSequence({lwDictionary:t,spm:d.spm,ecStreamsAccess:i},{onComplete:()=>{e()}})}))})))}))}Promise.all(l).then((()=>{d.loaded=!0,t.publish({event:this._ctx+"/DSXMBRIDGE/ECDM_LOADED",data:{msrId:o,ecDataModel:d}}),r()}))}}else o(new Error("invalid arguments"))}))},getDataDisplay3DNode:function(e,a){return new Promise(((i,n)=>{let r=this._getAVPComManager(e),s=this._getVisuManager(e),o=s.getViewer(),l=e.GetValueByName("_varName"),d=this.getActorID(e),c=this.getAnimationSetup(e),m=this._bridgeMap.get(l);if(m)if(r.isAVPEnabled())i();else{let e=this._exposed3DElementsMap.get(d);this._getNodeFromDataDisplay(m,o,a,e).then((e=>{i(e)}))}else{let m=e.GetParent().QueryInterface("CATI3DExperienceObject"),D=m.GetValueByName("_varName"),p=this.getParentActorID(m),g=this._msrECDataModels.get(p);
//!! temp until use of our id/name from link /Content/xxx - via ECDSXMStreamsAccess
if(g)if(g.loaded)this._getDataDisplay(g,D,l).then((t=>{if(r.isAVPEnabled())this._listAVPStreamsForDataDisplay(e,t).then((e=>{r.sendCommandToSwift(u,e),i()}));else{let e=this._exposed3DElementsMap.get(d);this._getNodeFromDataDisplay(t,o,a,e).then((e=>{i(e)}))}}));else{n(new Error("ec datamodel not loaded yet (not critical)"));let i="EC_DM_LOADED_CB_"+l;this[i]=t.subscribe({event:this._ctx+"/DSXMBRIDGE/ECDM_LOADED"},(n=>{t.unsubscribe(this[i]),this._getDataDisplay(g,D,l).then((t=>{let i=this._exposed3DElementsMap.get(this.getActorID(e));if(r.isAVPEnabled())this._listAVPStreamsForDataDisplay(e,t).then((t=>{r.sendCommandToSwift(u,t),e.QueryInterface("CATI3DGeoVisu").setReady(!0)}));else{if(this.isTargetXR){g.spm.setIsXREnabled(!0);let e=s.getglTFLoader();g.spm.setGltfLoader(e)}this._getNodeFromDataDisplay(t,o,a,i,c).then((t=>{e.QueryInterface("CATI3DGeoVisu").setReady(!0)}))}}))}))}else n(new Error("ec datamodel not found"))}}))},getLegendDescriptionFromECDM:function(e){return new Promise(((a,n)=>{let r=this._getAVPComManager(e),s=(this._getVisuManager(e).getViewer(),e.GetValueByName("_varName")),o=this.getActorID(e);const l={pathOfIds:e.GetObject().GetID(),types:e.GetObject().GetTypes()};let d=e.GetParent().QueryInterface("CATI3DExperienceObject"),c=d.GetValueByName("_varName"),m=d.GetParent().QueryInterface("CATI3DExperienceObject"),u=m.GetValueByName("_varName"),p=this.getParentActorID(m),g=this._msrECDataModels.get(p);
//!! temp until use of our id/name from link /Content/xxx - via ECDSXMStreamsAccess
if(g)if(g.loaded)this._getLegendDescription(g,u,c,e).then((t=>{r.isAVPEnabled()?(t.expObject=l,r.sendCommandToSwift(D,t),a()):i.load({experienceObject:e}).then((e=>{t.stream=e,a(t)}))}));else{let n="EC_DM_LOADED_CB_"+s;this[n]=t.subscribe({event:this._ctx+"/DSXMBRIDGE/ECDM_LOADED"},(s=>{t.unsubscribe(this[n]),this._getLegendDescription(g,u,c,e).then((n=>{r.isAVPEnabled()?(n.expObject=l,r.sendCommandToSwift(D,n),a()):i.load({experienceObject:e}).then((e=>{n.stream=e,t.publish({event:this._ctx+"/DSXMBRIDGE/ECDM_LEGEND_LOADED_"+o,data:{legendDescription:n}}),a(n)}))}))}))}else n(new Error("no ec datamodel found"))}))},get3DElement3DNode:function(e,a){return new Promise(((i,n)=>{let r=this._getAVPComManager(e),s=this._getVisuManager(e),o=s.getViewer(),l=e.GetValueByName("_varName"),d=this.getAnimationSetup(e),c=e.GetParent().QueryInterface("CATI3DExperienceObject"),m=c.GetValueByName("_varName"),D=c.GetParent().QueryInterface("CATI3DExperienceObject"),p=D.GetValueByName("_varName"),g=this.getParentActorID(D),h=this._msrECDataModels.get(g),f=this._bridgeMap.get(l);if(f)r.isAVPEnabled()?i():this._getNodeFrom3DElement(f,o,a,h.spm,d).then((e=>{i(e)}));else if(h)if(h.loaded)this._get3DElement(h,p,m,l).then((t=>{if(r.isAVPEnabled())this._listAVPStreamsForElement(e,t).then((e=>{r.sendCommandToSwift(u,e),i()}));else{if(this.isTargetXR){h.spm.setIsXREnabled(!0);let e=s.getglTFLoader();h.spm.setGltfLoader(e)}this._getNodeFrom3DElement(t,o,a,h.spm,d).then((e=>{i(e)}))}}));else{n(new Error("ec datamodel not loded (yet?)"));let i="EC_DM_LOADED_CB_"+l;this[i]=t.subscribe({event:this._ctx+"/DSXMBRIDGE/ECDM_LOADED"},(n=>{t.unsubscribe(this[i]),this._get3DElement(h,p,m,l).then((t=>{if(r.isAVPEnabled())this._listAVPStreamsForElement(e,t).then((t=>{r.sendCommandToSwift(u,t),e.QueryInterface("CATI3DGeoVisu").setReady(!0)}));else{if(this.isTargetXR){h.spm.setIsXREnabled(!0);let e=s.getglTFLoader();h.spm.setGltfLoader(e)}this._getNodeFrom3DElement(t,o,a,h.spm).then((t=>{e.QueryInterface("CATI3DGeoVisu").setReady(!0)}))}}))}))}else n(new Error("ec datamodel not found"))}))},isDataDisplayVisuLoaded:function(e,t){let a=!1,i=e.GetValueByName("_varName"),n=this._bridgeMap.get(i);if(n){const e=n.getNavData3DViewList();Array.isArray(e)&&(a=!0,e.forEach((e=>{if(e&&g(e)&&!h(e,this.elementsToFilter)&&e.getAllLoadingDescription){const a=e.getAllLoadingDescription();if(a&&a.Geometry){let e;if(isNaN(t)){const t=a.Geometry.status;e="loaded"===t[t.length-1]}else e="loaded"===a.Geometry.status[t];if(!e)return!1}}})))}return a},getAnimationInterface:function(){let e="CATISimNavDataAnimation";const t=this._getAVPComManager();return t&&t.isAVPEnabled()&&(e+="AVP"),e},_sendFrameIndexToAVP:function(e,t,a,i){return new Promise(((n,r)=>{let o=this._getAVPComManager(e);const l={expObject:{pathOfIds:e.GetObject().GetID(),types:e.GetObject().GetTypes()},frameIndex:t};o.sendCommandToSwift(a,l).then((a=>{let r=[];const l=[];e.QueryInterface("CATICXPActorsMgr").ListActors(l),l.forEach((e=>{if(e&&e.GetType()===s){const a=e.QueryInterface("CATI3DExperienceObject"),n={expObject:{pathOfIds:a.GetObject().GetID(),types:a.GetObject().GetTypes()},frameIndex:t};r.push(o.sendCommandToSwift(i,n))}})),Promise.all(r).then((()=>{n()}))}))}))},requestAVPtoLoadFrame:function(e,t){return this._sendFrameIndexToAVP(e,t,"SimulationLoadDDFrames","SimulationLoadElementFrames")},sendAnimationUpdateToAVP:function(e,t){return this._sendFrameIndexToAVP(e,t,p,p)},remove:function(e){if(this._msrECDataModels){var t=this._msrECDataModels.get(e.id);t&&(t.subReference(),t&&!t.isReferenced()&&(this._msrECDataModels.delete(e.id),A(t)),this._bridgeMap&&this._bridgeMap.clear())}},removeAll:function(){this._msrECDataModels.forEach((function(e){A(e)})),this._msrECDataModels.clear()},getDataDisplay:function(e){let t=e.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName");return this._bridgeMap.get(t)},requestRender:function(){let e=this._getAVPComManager();if(!e.isAVPEnabled()||e.isAVPEmulatedInWeb){let e=this._getVisuManager();e&&e.getViewer().render()}},getActorID:function(e){if(e){let t;return t=e._GetExpDataObject()?e.GetPathOfIds().toArray():e.GetObject().GetID().split(","),t.at(-1)}return null},getParentActorID:function(e){return e?this.getActorID(e.GetParent().QueryInterface("CATI3DExperienceObject")):null},getSceneID:function(e){let t;return t=e._GetExpDataObject()?e.GetPathOfIds().toArray():e.GetObject().GetID().split(","),t[2]},getCurrentSceneID:function(){return this._currentSceneID},setCurrentSceneID:function(e){this._currentSceneID=e}})})),define("DS/SMAXCTSimBridge/AVPDataDisplayAnimation",["UWA/Core","DS/SPYAnim/DataDisplayAnimationAbstract","DS/SMAXCTSimBridge/DSXMBridge"],(function(e,t,a){"use strict";return t.extend({isFrameLoaded:function(e){return"loaded"===this._stepsRequested.get(e)},loadFrame:function(e,t){this._ddActor&&a.requestAVPtoLoadFrame(this._ddActor,e).then((()=>{t()}))},initAnimation:function(e,t){this.implementation&&(this._parent(),t&&t.resultActor&&(this._ddActor=t.resultActor),e())},animate:function(e,t){if(this.currentStep!==e&&this.implementation)if(this.isFrameLoaded(e))a.sendAnimationUpdateToAVP(this._ddActor,e).then((()=>{})),this.currentStep=e;else{"loading"!==this._stepsRequested.get(e)&&(this._stepsRequested.set(e,"loading"),this.loadFrame(e,(()=>{this._stepsRequested.set(e,"loaded"),this.animate(e,t)})))}}})}));