define("DS/DMUReadPersistence/DMUReadPersistence",[],(function(){})),define("DS/DMUReadPersistence/DMUReadServices",["require","exports","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUContextManager"],(function(e,t,n,o){"use strict";return class{static importModel(e){if(e&&"object"==typeof e&&e.dataJson&&"object"==typeof e.dataJson&&e.dataJson.Model&&"object"==typeof e.dataJson.Model){let t=o.getReviewContext({viewer:e.viewer}),i=new n({viewer:e.viewer,experience:t,appType:e.appType,markupRepRef:e.mkpRepRef});i.importDataModel(e.dataJson,(function(t){i.postImport(),e.onImportCompleted&&e.onImportCompleted(t)}))}else e.onImportFailed&&e.onImportFailed()}}})),define("DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting",["UWA/Core","UWA/Class","UWA/Class/Options","DS/Logger/Logger","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices"],(function(e,t,n,o,i,r,a,s){"use strict";var l=t.singleton(n,{init:function(){var t=o.getLogger(l);t.log("init"),this.setOptions({navigate_opts:{timeout:2e4}});var n=this,d=!1;this.sendWebServiceCall=function(o){if(!o)return;if(!d)return s=function(){n.sendWebServiceCall(o)},l=o.onFailure,t.log("app_initialization"),void i.getPlatformServices({onComplete:function(e){n.setOption("platform_services",e),d=!0,s()},onFailure:function(){t.warn("Cannot retrieve the Platform Services"),d=!0,l()}});var s,l;if(!Array.isArray(n.getOption("platform_services")))return void(o.onFailure&&o.onFailure());var c=e.clone(o.config,!1);let u,p;c.onComplete=o.onSuccess,c.onFailure=o.onFailure,c.onTimeout=o.onFailure,c.method=c.verb,"r2vsurvey"!==o.serviceId&&(u=o.platform?o.platform.getSecurityContext():o.securityContext?o.securityContext:a.getSetting("pad_security_ctx")),c.headers={Accept:"application/json","Content-Type":"application/json","Accept-Language":o.platform?o.platform.getLang():a.getSetting("lang"),SecurityContext:u||void 0},"object"==typeof c.data&&(c.data=JSON.stringify(c.data)),"r2vsurvey"===o.serviceId?(p=o.platform?o.platform.getR2VPlatformUrl():"",""===p&&n.getPlatformURL()&&(p=n.getPlatformURL("r2vsurvey")+"/enovia")):p=o.platform?o.platform.get3DSpaceUrl():o["3DSpaceUrl"]?o["3DSpaceUrl"]:n.get3DSpaceUrl();var f=[];o.doNotSetSecurityContextInUrl||(f.push("SecurityContext"),f.push(o.platform?o.platform.getSecurityContext():o.securityContext?o.securityContext:a.getSetting("pad_security_ctx")),f.push("tenant"),f.push(o.platform?o.platform.getPlatformId():o.tenant?o.tenant:n.getOption("platform_services")[function(){var t,o=n.getOption("platform_services"),i=n.getTenant();if(e.is(i)){var r=i.value?i.value:i;if(Array.isArray(n.getOption("platform_services")))for(var a=0;a<o.length&&!e.is(t);a++)o[a].platformId===r&&(t=a)}return e.is(t)||(window.console.warn("Tenant not found => Tenant idx by default is 0"),t=0),t}()].platformId)),r.authenticatedRequest(p+"/"+o.url+function(e){if(null===e&&void 0===e)return"";var t="";if(Array.isArray(e))for(var n=e.length/2,o=0;o<n;o++)t+=0===o?"?":"&",t+=e[2*o]+"="+e[2*o+1];return encodeURI(t)}(f),c)},this.getServerContext=function(e){if(!e||"function"!=typeof e.onComplete||"function"!=typeof e.onFailure)return;let t=a.getSetting("pad_security_ctx");t?e.onComplete(t):e.onFailure()},this.get3DSpaceUrl=function(){return s.get3DSpaceUrl()},this.getTenant=function(){return a.getSetting("x3dPlatformId")},this.getPlatformURL=function(e){return s.getPlatformURL(e)}},doInitialize:function(){}});return l.doInitialize(),l})),define("DS/DMUReadPersistence/DMUPasswordDialog",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Utilities/TouchUtils","DS/Controls/LineEditor","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],(function(e,t,n,o,i,r,a){"use strict";return t.extend({init:function(t){this._parent(t);var s,l,d,c=(t||{}).ctxViewer;this.build=function(t,u){if(!s){var p=e.createElement("div",{id:"DMUPasswordDialogContent"});e.createElement("p",{id:"DMUPasswordDialogDescription",text:a.documentPasswordMessage}).inject(p);var f=e.createElement("div",{styles:{display:"flex","justify-content":"space-evenly","align-items":"center"}}).inject(p);l=new r({placeholder:a.documentPassword,selectAllOnFocus:!0,displayStyle:"password"}).inject(f);var m=new o({label:"Display Password",showLabelFlag:!1,icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"},type:"check",displayStyle:"icon"}).inject(f);m.getContent().setStyle("margin-left","10px"),d=e.createElement("p",{styles:{color:"#EA4F37",margin:"5px"}}).inject(p),m.getContent().addEventListener("change",(function(){m.checkFlag?(m.setProperties({icon:{iconName:"eye-off",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="text"):(m.setProperties({icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="password")}));var g={Ok:new o({emphasize:"primary",label:"OK",onClick:function(){l.value?(l.disabled=!0,d.innerText="",g.Ok.disabled=!0,t(l.value)):d.innerText=a.documentPasswordRequired}}),Cancel:new o({label:"Cancel",onClick:u})};l.addEventListener("uncommittedChange",(function(){d&&d.innerText&&(d.innerText="")})),s=new n({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:a.documentPasswordRequired,content:p,closeButtonFlag:!1,position:i.getTouchMode()?{my:"center bottom"}:void 0,immersiveFrame:c.getFrameWindow().getImmersiveFrame(),buttons:g})}},this.onIncorrectPassword=function(){s&&l&&(l.disabled=!1,s.buttons.Ok.disabled=!1,d.innerText=a.documentIncorrectPassword)},this.getValue=function(){return l?l.value:""},this.close=function(){c&&(s&&s.close(),c=s=null,l=null,d=null)}}})})),define("DS/DMUReadPersistence/DMUR3ExportedDocumentsController",["require","exports","DS/DMUBaseUIControllers/utils/OpenWithMenuBuilder","DS/DMUBaseExperience/EXPUtils","i18n!DS/DMUReadPersistence/assets/nls/DMUExportedDocumentFacet"],(function(e,t,n,o,i){"use strict";let r,a,s,l,d,c=0,u=0;class p{constructor(){let e=function(e,t){return new Promise(((n,o)=>{window.require(["DS/DocumentManagement/DocumentManagement","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices"],((i,r,s)=>{i.downloadDocument(e,t,!1,{tenantUrl:a||s.get3DSpaceUrl(),tenant:l||s.getPlatformId(),securityContext:r.getSetting("pad_security_ctx"),autoDownload:!0,onComplete:e=>{n(e)},onFailure:e=>{window.console.error(e),o(e)}})}))}))},t=function(){let t=r.getCellsXSO().get(),n=r.getNodesXSO().get();return n.length&&!t.length?async function(t){let n=[];for(let o=0;o<t.length;o++){let i=t[o].options.grid;i.docId?(n.push(i.revision),await e(i.docId,void 0)):i.fileId&&!n.includes(t[o].getParent().options.grid.revision)&&await e(t[o].getParent().options.grid.docId,i.fileId)}}(n):!n.length&&t.length?async function(t){for(let n=0;n<t.length;n++){let o=t[n].nodeModel.options.grid;o.docId?await e(o.docId,void 0):o.fileId&&await e(t[n].getParent().options.grid.docId,o.fileId)}}(t):t.length&&n.length?async function(t,n){let o=[];for(let e=0;e<n.length;e++){let t=n[e].options.grid;t.docId&&o.push(t.revision)}for(let e=0;e<t.length;e++){let n=t[e].nodeModel.options.grid;n.docId&&(o.includes(n.revision)||o.push(n.revision))}for(let t=0;t<n.length;t++){let i=n[t].options.grid;i.docId?await e(i.docId,void 0):i.fileId&&!o.includes(n[t].getParent().options.grid.revision)&&await e(n[t].getParent().options.grid.docId,i.fileId)}for(let i=0;i<t.length;i++){let r=t[i].nodeModel.options.grid;r.docId&&!o.includes(r.revision)?await e(r.docId,void 0):r.fileId&&!o.includes(t[i].getParent().options.grid.revision)&&await e(n[i].getParent().options.grid.docId,r.fileId)}}(t,n):void window.console.error("Nothing to download, verify your selection !")},o=function(e){if(!(e&&e.relateddata&&e.relateddata.files&&e.relateddata.files.length))return"";let t=e.relateddata.files[0];return t.dataelements&&t.dataelements.title?t.dataelements.title.includes(".pdf")?"PDF":"PNG":""};this.getExportedDocumentsRelatedData=function(e,t){return new Promise(((n,i)=>{window.require(["DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WidgetServices/securityContextServices/SecurityContextServices","DS/DocumentManagement/DocumentManagement","DS/PADUtils/PADUtilsServices"],((r,p,f,m,g)=>{let v=function(e,t,n){t.forEach((t=>{t.id===e&&("PNG"===n?u=parseInt(t.revision):c=parseInt(t.revision))}))},D=function(e){return new Promise(((n,d)=>{r.sendWebServiceCall({url:"resources/v1/dslc/versiongraph","3DSpaceUrl":a,securityContext:s,config:{verb:"POST",data:{graphRequests:[{id:e,attributes:["revision","policy"]}]}},onSuccess:i=>{if(i&&(i=JSON.parse(i)),i&&i.graphs&&i.graphs[0]&&i.graphs[0].versions&&i.graphs[0].versions.length){let r=i.graphs[0].versions,p=[new Promise(((e,t)=>{m.getDocuments([r[0].id],{tenantUrl:a||g.get3DSpaceUrl(),tenant:l||g.getPlatformId(),securityContext:s,onComplete:n=>{n&&n.data&&n.data[0]?e(n.data[0]):t(n)},onFailure:e=>{d(e)}})}))];if(r.length>1)for(let e=1;e<r.length;e++)p.push(new Promise(((t,n)=>{m.getDocuments([r[e].id],{tenantUrl:a||g.get3DSpaceUrl(),tenant:l||g.getPlatformId(),securityContext:s,onComplete:e=>{e&&e.data&&e.data[0]?t(e.data[0]):n(e)},onFailure:e=>{d(e)}})})));Promise.all(p).then((i=>{let a=[];for(let n=0;n<i.length;n++){let l=o(i[n]);if(v(e,r,l),parseInt(i[n].dataelements.revision)<=("PDF"===l?c:u)){i[n].dataelements&&(t=i[n].dataelements.title);let e={docId:i[n].id,markupTitle:t,creationDate:i[n].dataelements.originated,fileType:l,revision:parseInt(i[n].dataelements.revision),owner:i[n].relateddata.ownerInfo[0].dataelements.firstname+" "+i[n].relateddata.ownerInfo[0].dataelements.lastname,files:[]};for(let t=0;t<i[n].relateddata.files.length;t++){let o=i[n].relateddata.files[t].dataelements.title;if(o.includes(".png")){let e=o.lastIndexOf(".png");o=o.substring(0,e)}e.files.push({fileId:i[n].relateddata.files[t].id,fileTitle:o})}e.files=((s=e.files).sort(((e,t)=>parseInt(e.fileTitle.substring(0,e.fileTitle.indexOf("_")))-parseInt(t.fileTitle.substring(0,t.fileTitle.indexOf("_"))))),s),a.push(e)}}var s;!function(e){e.sort(((e,t)=>{let n=e.revision;return t.revision-n}))}(a),n(a)}))}else d(i)},onFailure:e=>{i(e)},onTimeout:e=>{i(e)}})}))};l=window.model?window.model.getTenant():g.getPlatformId(),d=window.model?window.model.get("source"):d,p.getServiceUrl({serviceName:d,platformId:l||"OnPremise",onComplete:function(t){a=t,f.getInstance({tenant:l}).getSecurityContext({onSuccess:function(t){s=t.SecurityContext,r.sendWebServiceCall({url:"resources/markup/service/getAssociatedDocumentsID","3DSpaceUrl":a,securityContext:s,config:{verb:"GET",data:`sMarkupID=${e}`},onSuccess:e=>{let t=JSON.parse(e).AssociatedDocumentID,o=[];if(""!==t){t=t.split("\n"),t.shift(),t.forEach((e=>{if(e.includes("physicalid")){let t=e.lastIndexOf("physicalid"),n=13;e=e.substring(t+n),o.push(e)}}));let e=[];for(let t=0;t<o.length;t++)e.push(D(o[t]));Promise.all(e).then((e=>{if(e){let t=[];e.forEach((e=>{e.forEach((e=>{t.push(e)}))})),n(t)}else i(new Error("Could not fetch exported documents data !"))}))}else n([])},onFailure:e=>{i(e)}})},onFailure:function(e){window.console.error(e," -- >> No security context found.")}})},onFailure:function(e){window.console.error(e)}})}))}))},this.onContextualEvent=function(e){r=e;let o=[{type:"PushItem",title:i.download,fonticon:{content:"wux-ui-3ds wux-ui-3ds-download"},tooltip:{title:i.downloadTitle,shortHelp:i.downloadTooltip},action:{callback:async function(){await t()}}}];return new Promise(((t,r)=>{let s={id:e.getCellInfosAt(e.getActiveCellID()).nodeModel.options.grid.docId||e.getCellInfosAt(e.getActiveCellID()).nodeModel.options.grid.fileId,type:"Document"};window.require(["DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices"],(function(e,l){let d,c=window.widget.getValue("appId");(!c||"ENOR3D_AP"!==c&&"ENOR3R_AP"!==c&&"ENOR3V_AP"!==c)&&(d=l.get3DSpaceUrl,l.get3DSpaceUrl=function(){return a}),n.openWithApps(s).then((function(e){let n={type:"PushItem",title:i.openWith,tooltip:{title:i.openWithTitle,shortHelp:i.openWithTooltip},fonticon:{content:"wux-ui-3ds wux-ui-3ds-forward"},submenu:e,action:{callback:()=>{}}};o.push(n),d&&(l.get3DSpaceUrl=d,d=void 0),t(o)})).catch((function(){r(new Error)}))}))}))},this.clear=function(){r=void 0}}}let f=[];return class{static getDMUR3ExportedDocumentsController(){let e;o._sendUsageProbe("facet",window.widget.getValue("appId")?window.widget.getValue("appId"):"Search",`Facet has been requested from ${window.widget.getValue("appId")?window.widget.getValue("appId"):"search"}`);for(let t=0;t<f.length;t++){f[t].counter++,e=f[t].reviewController;break}if(!e){let e=new p;f.push({reviewController:e,counter:1})}return e?Object.freeze(e):e}static giveDMUR3ExportedDocumentsController(){let e;for(let t=0;t<f.length;t++){e=f[t].reviewController;break}return e?Object.freeze(e):e}static unreferenceDMUR3ExportedDocumentsController(){for(let e=0;e<f.length;e++){f[e].counter--,f[e].counter<=0&&(f[e].reviewController.clear(),f.splice(e,1));break}}}})),define("DS/DMUReadPersistence/DMUXCADSupport",["UWA/Core","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/Logger/Logger","DS/WAFData/WAFData","DS/WebSystem/Environment","DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/ConvertV1","DS/SPAContentOptimizer/COConvertOption","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],(function(e,t,n,o,i,r,a,s,l,d){"use strict";var c={},u=o.getLogger("DS/DMUReadPersistence/DMUXCADSupport");u.log("init");var p=0;return{startLocate:function(t,n){var o=this,a=t.asset;this.located=!1,u.log("XCADSpatialSupport._startLocate");var s=t.asset.originalAsset.contextid?t.asset.originalAsset.contextid:"preferred";r.get("PreferredCredentials")&&(s=r.get("PreferredCredentials"));var l="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==t.asset.originalAsset.provider.toUpperCase()&&"3DSPACE"!==t.asset.originalAsset.provider.toUpperCase()||(l+="&SecurityContext="+encodeURIComponent(s)),"asm"===a.dataFormat&&(a.dataFormat="3dxml");var d=c[a.tenant]+l,f={specificationFilter:[{format:a.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===t.asset.originalAsset.provider.toUpperCase()?"3DSpace":t.computedInfos.provider,id:t.asset.originalAsset.physicalid,type:t.asset.originalAsset.type}]};!0===n&&(f.specificationFilter[0].notifyIfMissing=!0),i.authenticatedRequest(d,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:s},type:"json",data:JSON.stringify(f),onComplete:function(n){if(console.log("onComplete locate"),n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){p=0;var r=c[a.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+n.derivedOutputs[0].id+"/DerivedOutputFiles/"+n.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";i.authenticatedRequest(r,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(n){console.log("onComplete download ticket");var o=n.data[0].dataelements,i=o.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(o.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",r=e.clone(a);t.onConvertSuccess(e.extend(r,{provider:"FILE",filename:i,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:a.type,mimetype:a.dataFormat||a.mimetype,format:a.dataFormat||a.mimetype,type:a.dataFormat||a.mimetype})),console.log("Loading from DFA : "+i)},onFailure:function(e){console.log("onFailure download ticket"+e)}})}else if(p<=10){var s=p++<5?1e3:3e3;console.log(" restart locate in "+s+" ms"),setTimeout(o.startLocate.bind(o,t,!1),s)}else console.log("locate service is not available")},onFailure:function(e){console.log("onFailure locate"+e)}})},convertDFA:function(e){var n=this,o=e.asset;t.getServiceUrl({serviceName:"derivedformataccess",logger:u,platformId:o.tenant,onSuccess:function(t){c[o.tenant]||(c[o.tenant]=t.url),t.platformId!==o.tenant&&u.warn("DerivedFileAccess desired Tenant:",o.tenant,"got ",t.platformId),u.log("DerivedFileAccess : URL found > ",c[o.tenant]),n.startLocate(e,!0),n=null},onError:function(t){u.error("Ooops, missing Service : ",t.serviceName,"Reason : ",t.error),e.onConvertError("Missing Service"),n=null}})}}})),define("DS/DMUReadPersistence/DMUwebExportedDocumentsTab",["require","exports","UWA/Core","DS/EditPropWidget/facets/Common/FacetsBase","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/CoreEvents/Events","DS/DMUReadPersistence/DMUR3ExportedDocumentsController","i18n!DS/DMUReadPersistence/assets/nls/DMUExportedDocumentFacet"],(function(e,t,n,o,i,r,a,s,l){"use strict";let d,c,u;return class extends o{constructor(e){super(e),this.elements={},this.elements.container=n.createElement("div",{class:"exportedDocsTab"}),c=s.getDMUR3ExportedDocumentsController(),u||(u=a.subscribe({event:"onDMUExportedDocumentDone"},(()=>{this.updateFacet()}))),this.updateFacet=async function(){this.showLoader();let e,t=this,o=this.elements.container.getChildren(),a=n.createElement("div",{class:"noDataGridContainer"}),u=function(){o&&o.length&&o.forEach((e=>{t.elements.container.removeChild(e)}))};a.innerText=l.noDataGridDisplayed,a.setStyles({width:"100%","font-family":"3ds","font-size":"x-large","text-align":"center",color:"#368ec4",padding:"5%"}),c||(c=s.giveDMUR3ExportedDocumentsController());let p=this.getModel();if(!p)return;let f=p.get("objectId"),m=p.get("label");""!==m&&(d=m);try{let n=await c.getExportedDocumentsRelatedData(f,d);if(n&&n.length){let o=new i({});o.prepareUpdate(),n.forEach((function(e){let t=new r({label:e.markupTitle,grid:e,shouldBeSelected:e=>!!e.options.grid.docId});o.addRoot(t),e.files&&"PNG"===e.fileType&&e.files.forEach((function(e){let n=new r({label:e.fileTitle,grid:e});t.addChild(n)}))})),o.pushUpdate(),o.setFilterModel({fileType:{filterId:"set",filterModel:[],filterOptions:{keepChildren:!0}}});let a=[{text:l.title,dataIndex:"tree",typeRepresentation:"string",compareFunction:function(e){return e.sort(((e,t)=>parseInt(e.fileTitle.substring(0,e.fileTitle.indexOf("_")))-parseInt(t.fileTitle.substring(0,t.fileTitle.indexOf("_"))))),e},getCellValueForSort:function(e){let t=e.getChildren(),n=[];return t&&t.length&&t.forEach((e=>{n.push({fileId:e.options.grid.fileId,fileTitle:e.options.grid.fileTitle,fileType:e.options.grid.fileType})})),n}},{text:l.fileType,dataIndex:"fileType",typeRepresentation:"string",filterOptions:{getCustomFilterSetValues:function(){return["PNG","PDF"]}}},{text:l.creationDate,dataIndex:"creationDate",typeRepresentation:"date",alignment:"center"},{text:l.revision,dataIndex:"revision",typeRepresentation:"integer"},{text:l.owner,dataIndex:"owner",typeRepresentation:"user",getCellValue:function(e){if(e.nodeModel)return{label:e.nodeModel.getAttributeValue("owner")}}},{text:l.menu,dataIndex:"ContextualMenuColumn",hasCellValue:function(){return!0}}],s={identifier:"ExportedDocumentsDataGridView",treeDocument:o,columns:a,defaultColumnDef:{editableflag:!1},showContextualMenuColumnFlag:!0,onContextualEvent:async t=>{let n=[];if(t&&t.cellInfos&&t.collectionView&&t.cellInfos.cellModel&&t.cellInfos.cellModel===l.fileType){let e={pin:!1,sizeColumnToFit:!1,columnsManagement:!1,expandCollapse:!1,firstColumnsVisibility:!1};return n=t.collectionView.buildDefaultContextualMenu(t,e),n}return n=await c.onContextualEvent(e),n}};e=await new Promise(((e,t)=>{window.require(["DS/DataGridView/DataGridView"],(n=>{if(n){let t=new n(s);e(t)}else t(n)}))})),e.sortModel=[{dataIndex:"creationDate",sort:"desc"}],e.rowSelection="multiple",e.columnSelection="none",e.cellSelection="none",e.inject(t.elements.container),e.updateView(),t.hideLoader()}else u(),t.hideLoader(),a.inject(t.elements.container)}catch(e){t.hideLoader(),u(),a.innerText=l.errorWhenFetchingExportedDocuments,a.inject(t.elements.container),window.console.error(e)}},this.onRefresh=function(){this.updateFacet()}}}})),define("DS/DMUReadPersistence/DMUWebServicesUtils",["UWA/Class","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting"],(function(e,t){"use strict";return e.singleton({init:function(){},getParentTypes:function(e,n){return new Promise(((o,i)=>{t.sendWebServiceCall({url:"resources/markup/service/getParentTypes",config:{verb:"POST",data:JSON.stringify({sType:e})},platform:n,onSuccess:function(e){let t=JSON.parse(e);o(t.parentTypes)},onFailure:function(e){i(e)}})}))},getRequirementData:function(e,n){return new Promise(((o,i)=>{t.sendWebServiceCall({url:"resources/trm/streaming/structure/"+e,config:{verb:"GET"},platform:n,doNotSetSecurityContextInUrl:!0,onSuccess:function(e){let t=JSON.parse(e);o(t)},onFailure:i,onTimout:i})}))},getRequirementElementContent:function(e,n){return new Promise(((o,i)=>{t.sendWebServiceCall({url:encodeURI("resources/trm/dictionary/info?pid="+e+"&select=type,attribute[Content Data],attribute[Title],attribute[Content Text]"),config:{verb:"GET"},doNotSetSecurityContextInUrl:!0,platform:n,onSuccess:function(e){let t=JSON.parse(e);t&&"success"===t.status&&t.results[0]?o(t):i(new Error("Requirement has no content"))},onFailure:()=>{i(new Error("Requirement content Request Failed"))},onTimout:()=>{i(new Error("Requirement content Request Timeout"))}})}))},getSpecReportData:function(e,n){return new Promise(((o,i)=>{t.sendWebServiceCall({url:"resources/v1/modeler/dsspec/dsspec:PhysicalProduct/"+e+"?$mask=dsspec:SpecAndRelatedInfoObjectMask",config:{verb:"GET"},platform:n,doNotSetSecurityContextInUrl:!0,onSuccess:function(e){let t,n=JSON.parse(e);n&&n.member&&n.member.length>0&&n.member[0]&&n.member[0].specificationReport&&n.member[0].specificationReport.member&&n.member[0].specificationReport.member.length>0&&n.member[0].specificationReport.member[0]&&n.member[0].specificationReport.member[0]["@id"]&&(t={id:n.member[0].specificationReport.member[0]["@id"],type:"Specification Report"}),o(t)},onFailure:i,onTimout:i})}))},getInterferenceSimulationContext:function(e,n){return new Promise(((o,i)=>{t.sendWebServiceCall({url:"resources/pimauthoring/service/readItfSimulationContent",config:{verb:"POST",data:JSON.stringify([e])},platform:n,onSuccess:function(e){let t,n=JSON.parse(e);n&&n.result&&n.result.length>0&&n.result[0]&&n.result[0].output&&n.result[0].output.prd&&(t=n.result[0].output.prd),o(t)},onFailure:i,onTimout:i})}))},fetchAttributes:function(e){return new Promise(((n,o)=>{e&&e.platform&&e.ids&&e.ids.length>0?t.sendWebServiceCall({url:encodeURI("cvservlet/fetch/v2"),config:{verb:"POST",data:JSON.stringify({physicalid:e.ids,label:e.platform.getUserLogin()+"-"+e.platform.getWidgetAppId()+"-"+Date.now(),select_predicate:e.attributes,select_file:e.select_file})},platform:e.platform,onSuccess:function(e){let t=JSON.parse(e),o={};if(t&&t.results&&t.results.length>0)for(let e=0;e<t.results.length;e++){let n,i=t.results[e],r={};if(void 0!==i.attributes)for(let e=0;e<i.attributes.length;e++){let t=i.attributes[e];"resourceid"===t.name?n=t.value:r[t.name]=t.value}o[n]=r}n(o)},onFailure:()=>{o(new Error("fetchAttributes - Failed"))},onTimout:()=>{o(new Error("fetchAttributes - Timeout"))}}):n(new Error("fetchAttributes - No platform information"))}))},fetchR2VFeatureOfInterestAttributes:function(e){return new Promise(((n,o)=>{e&&e.platform&&e.ids&&e.ids.length>0?t.sendWebServiceCall({url:encodeURI("enovia/resources/r2v/modeler/v2/featureofinterest/fetch"),config:{verb:"POST",data:JSON.stringify({ids:e.ids})},platform:e.platform,serviceId:"r2vsurvey",doNotSetSecurityContextInUrl:!0,onSuccess:function(e){let t=JSON.parse(e),o={};if(t&&t.result&&t.result.length>0)for(let e=0;e<t.result.length;e++){let n=t.result[e],i={icon:n["ds6w:icon"],type:n["ds6w:type"],label:n["ds6w:label"]};o[n.resourceid]=i}n(o)},onFailure:()=>{o(new Error("fetchR2VAttributes - Failed"))},onTimout:()=>{o(new Error("fetchR2VAttributes - Timeout"))}}):n(new Error("fetchAttributes - No platform information"))}))},fetchR2VActivityFromR2VFeatureOfInterest:function(e){return new Promise(((n,o)=>{t.sendWebServiceCall({url:encodeURI("enovia/resources/r2v/modeler/v2/featureofinterest/"+e.ids+"/activities"),config:{verb:"GET"},platform:e.platform,serviceId:"r2vsurvey",doNotSetSecurityContextInUrl:!0,onSuccess:function(e){n(e)},onFailure:function(e){o(e)}})}))},navigate:function(e){return new Promise(((n,o)=>{e&&e.platform&&e.ids&&e.ids.length?t.sendWebServiceCall({url:encodeURI("cvservlet/navigate"),config:{verb:"POST",data:JSON.stringify({input_physical_ids:e.ids,label:e.platform.getUserLogin()+"-"+e.platform.getWidgetAppId()+"-"+Date.now(),primitives:e.primitives,patterns:e.patterns,attributes:e.attributes,fileAttributes:e.fileAttributes,version:3})},platform:e.platform,onSuccess:function(e){let t=JSON.parse(e);n(t)},onFailure:()=>{o(new Error("navigate - Failed"))},onTimout:()=>{o(new Error("navigate - Timeout"))}}):n(new Error("navigate - No platform information"))}))}})})),define("DS/DMUReadPersistence/DMUReviewPersistenceServices",["UWA/Class","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPUtils","DS/PlatformAPI/PlatformAPI","DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DocumentManagement/DocumentManagement","DS/VisuDataAccess/Ox4StreamLoader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/PADUtils/PADSettingsMgt","UWA/Utils"],(function(e,t,n,o,i,r,a,s,l,d,c){"use strict";return e.extend({init:function(){let e=!0;var u=new i;this.updateReviewAndJSONFile=function(e,t,n){r.getServerContext({onComplete:function(o){var i=e.markupName,s=e.markupType,l=(new Date).getTime(),d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(l+16*Math.random())%16|0;return l=Math.floor(l/16),("x"===e?t:3&t|8).toString(16)})),c=new Blob([JSON.stringify(e.json)],{type:"application/json"}),u=null;c&&((u=c).name=d,u.fileName=d);var p={fileInfo:{file:u,title:d,newFile:e.newFile,fileName:d},id:e.reviewPhysicalId},f={onComplete:function(e){t&&t({reviewId:e.data[0].id,reviewName:i,reviewType:s})},onFailure:function(){n&&n({reviewName:i,reviewType:s})},securityContext:o,tenant:r.getTenant(),tenantUrl:r.get3DSpaceUrl()};a.modifyDocument(p,f)},onFailure:n})},this.updateMarkupStream=function(e,t,n){var o,i=e.markupName,a=e.markupType,s=new Blob([e.json],{type:"application/json"}),l=c.getUUID().toString(),d="WebReviewContent",u="json",p=d+"."+u;(o="DMUMarkupRepReference",new Promise((function(e,t){r.sendWebServiceCall({url:"resources/markup/service/getCheckinTicket",config:{verb:"POST",data:JSON.stringify({sObjectType:o})},onSuccess:function(t){e(t?JSON.parse(t):{})},onFailure:function(e){t(e)}})}))).then((function(o){var c,f=o.checkinTicket,m=o.actionURL;f&&m&&(c={file:s,ticket:f,URL:m,correlationId:l,fileName:p},new Promise((function(e,t){var n=new FormData;n.append("__fcs__jobTicket",c.ticket),n.append("file_0",c.file,c.fileName);var o=new XMLHttpRequest;o.open("POST",c.URL,!0),o.onload=function(){200===o.status&&e(o.responseText)},o.onerror=()=>t(new Error("Network Error")),o.send(n)}))).then((function(o){var s=o;s&&function(e){return new Promise((function(t){r.sendWebServiceCall({url:"resources/markup/service/checkinStreamInfo",config:{verb:"POST",data:JSON.stringify({sObjectId:e.ObjectId,sReceipt:e.receipt,sJsonStream:e.stream,sFileName:e.fileName,sPersistencyType:e.persistencyType,sPersistencyName:e.persistencyName})},onFailure:function(e){t({error:e})},onSuccess:function(e){t(e?JSON.parse(e):{})}})}))}({ObjectId:e.reviewPhysicalId,receipt:s,stream:e.json,fileName:p,persistencyName:d,persistencyType:u}).then((function(o){o&&!o.error?t&&t({reviewId:e.reviewPhysicalId,reviewName:i,reviewType:a}):n()}))})).catch(n)})).catch(n)},this.getDnDReviewAndJSONFile=function(e,i,s){e.serverurl||(e.serverurl=r.get3DSpaceUrl()),e.tenant||(e.tenant=r.getTenant()),r.getServerContext({onComplete:function(r){var l={onComplete:function(r){!function(e,i,r){var a=e?e.MarkupReservedby:null;if(null!==a&&u){var s=e.MarkupID,l=e.MarkupType,d=e.MarkupName?e.MarkupName:e.MarkupTitle,c=e.MarkupDescription,p=e.MarkupState,f={onComplete:function(u){var f={url:u[0].downloadUrl,responseType:"json",onComplete:function(t){var r={reviewPid:s,reviewType:l,reviewName:d,reviewDescription:c,reviewState:p,jsonObj:JSON.parse(n.cleanJSONString(t)),modifiable:!a||""===a||a===o.getUser().login,fromRefresh:e.fromRefresh};i(r),window.widget&&window.widget.dispatchEvent("onDMUMarkupLoaded",s)},onFailure:r};t.request(f.url,{responseType:f.responseType,method:"GET",onComplete:f.onComplete,onFailure:f.onFailure,timeout:0})},onFailure:r};u.downloadDocuments([e.MarkupID],f)}else r()}({MarkupID:e.markupId,MarkupType:e.markupType,MarkupJsonFileID:r&&r.data&&r.data.length&&r.data[0].relateddata&&r.data[0].relateddata.files&&r.data[0].relateddata.files.length?r.data[0].relateddata.files[0].id:void 0,MarkupReservedby:r&&r.data&&r.data.length&&r.data[0].dataelements?r.data[0].dataelements.reservedby:null,MarkupName:r&&r.data&&r.data.length&&r.data[0].dataelements?r.data[0].dataelements.title:null,MarkupDescription:r&&r.data&&r.data.length&&r.data[0].dataelements?r.data[0].dataelements.description:null,MarkupState:r&&r.data&&r.data.length&&r.data[0].dataelements?r.data[0].dataelements.state:null,fromRefresh:e.fromRefresh},i,s)},onFailure:s,securityContext:r,additionalURLParams:"$include=parents",tenantUrl:e.serverurl,tenant:e.tenant,relInfo:{parentRelName:"Markup",parentDirection:"from"}};a.getDocuments([e.markupId],l)},onFailure:s})},this.getProductByMarkerId=function(e,t,n){e&&e.physicalid&&(e.serverurl||(e.serverurl=r.get3DSpaceUrl()),e.tenant||(e.tenant=r.getTenant()),r.getServerContext({onComplete:function(o){var i={onComplete:function(e){if(0===e.data.length)n(e);else{var o={MarkupContext:{}};e.data[0].relateddata.parents&&e.data[0].relateddata.parents.length?o.MarkupContext.contexts=e.data[0].relateddata.parents:e.data[0].dataelements&&e.data[0].dataelements.parentId&&(o.MarkupContext.contexts=[],o.MarkupContext.contexts.push({id:e.data[0].dataelements.parentId})),t(o)}},onFailure:n,securityContext:o,tenantUrl:e.serverurl,tenant:e.tenant,additionalURLParams:"$include=parents",relInfo:{parentRelName:"Markup",parentDirection:"from"}};a.getDocuments([e.physicalid],i)},onFailure:n}))},this.getMarkupInfos=function(t,n,o){t&&t.physicalid&&r.sendWebServiceCall({url:"resources/markup/service/getMarkup",config:{verb:"POST",data:JSON.stringify({sMarkupId:t.physicalid})},onSuccess:function(t){let o,i=JSON.parse(t);i&&i.MarkupContext&&i.MarkupContext.contextURI&&(o=i.MarkupContext.contextURI),function(e,t){return t?(n={contextURI:t},new Promise(((e,t)=>{r.sendWebServiceCall({url:"resources/r2v/modeler/v2/i3dx/fetch",serviceId:"r2vsurvey",doNotSetSecurityContextInUrl:!0,config:{verb:"POST",data:{data:[{"ds6w:i3dx":n.contextURI}]}},onSuccess:function(t){var n=JSON.parse(t);e(n)},onFailure:t,onTimeout:t})}))).then((t=>(e.MarkupContext.contextIds=[t.data[0].resourceid],e.MarkupContext.serviceID=t.data[0]["ds6w:dataSource"],e))):Promise.resolve(e);var n}(i,o).then((o=>{if(t)if(n(o),o.reservedby||"false"===o.modifyAccess){let t=o.modifyAccess;e=!t||"false"!==t}else e=!0;else n({})}))},onFailure:o})},this.getMarkupStream=function(t,i,a){var c={IRPC:!0,serverUrl:r.get3DSpaceUrl(),physicalid:t.markupId,boType:"DMUMarkupRepReference",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(o){window.console.log("getMarkupJson::success:"+o.byteLength),i({jsonObj:JSON.parse(n.cleanJSONString(o)),reviewPid:t.markupId,reviewType:t.markupType,reviewName:t.markupTitle,owner:t.markupOwner,modifiable:e,fromRefresh:t.fromRefresh})},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),a(e="NOSTREAM")}},u=o.getUser().login;l.useUWAProxy({proxymode:"passport",login:u,contextid:d.getSetting("pad_security_ctx")}),s.Load(c)}}})})),define("DS/DMUReadPersistence/DMULoadingContextController",["UWA/Class","UWA/Utils","UWA/Core","DS/Visualization/Node3D","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DocumentManagement/DocumentManagement","DS/DMUControls/EXPNotify","DS/DMUControls/panels/DMUDocumentPanel","DS/PADUtils/views/PADProgressBar","DS/DMUReadPersistence/DMUPasswordDialog","DS/DMUReadPersistence/DMUWebServicesUtils","DS/DMUBaseExperience/EXPManagerSet","DS/CoreEvents/ModelEvents","DS/CATWebUXComponents/DMUCommandsManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPToolsContext","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],(function(e,t,n,o,i,r,a,s,l,d,c,u,p,f,m,g,v,D,h,I,S,y){"use strict";let C="DS/PIMwebViewController/PIMwebItfCtrl",x="DS/CAT3DAnnotControllerForReview/CATDIFAnnotSetLoader",b="DS/SMAMpw3DMarkupImpl/SMAMpwMSRLoadCtrl",w="DS/CATSFYLoader/FMEALoaderForDesignValidation",M=e.extend({init:function(e){this._parent(e);let M,R,P,U,F,L,k,T,A,E,O,j,N,V,W=this,_=(e||{}).ctxViewer,q=null,J=null,B=!1,K={},X={},G=new f,H=null,z=null,$=!0,Q=i.getEventsController({viewer:_.getViewer()}),Z=null,Y={icon:null,title:null},ee=null,te=!0,ne=null,oe=[],ie={},re=["doc","docx","docm","dot","dotm","dotx","rtf","ppt","pptx","pot","potm","potx","pps","ppsm","ppsx","pptm"];var ae={};function se(e,t,n){R&&R.destroy(),R=new s({body:_.getFrameWindow().getUIFrame(),type:e,message:t}),"successful"===n&&W.publish("on2DDocumentLoadSuccess")}function le(e){let t;k&&(k.close(),k=null),_.removeRoots({pids:[P]}),e&&"InvalidPDFException"===e.name&&(t=y.documentNotSupported),_.displayNotification({msg:t||y.documentLoadKO,eventID:"error"}),P=null;let n=d._counter;for(let e=0;e<n;e++)d.off();W.publish("onDocumentLoadFailure")}function de(){let e=d._counter;for(let t=0;t<e;t++)d.off();se("info","Document"===(r.getNodeType(_.getRootBagPath().getChildrenPathes()[0])?r.getNodeType(_.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)):null)||"Document"===ne?y.documentLoadCancel:y.requirementLoadCancel);let t=m.getCommand("CleanAll",_.getCommandContext());t&&t.begin()}function ce(e,t){return new Promise((n=>{A&&A[e]?n(A[e]):h.authenticatedRequest(t,{proxy:"none",type:"blob",timeout:18e4,onComplete:function(t){let o=new FileReader;o.onload=function(){A||(A={}),A[e]=o.result,n(A[e])},o.readAsDataURL(t)},onFailure:function(){n(t)},onTimeout:function(){n(t)}})}))}function ue(){let e=i.giveEventsController({viewer:_.getViewer()});e&&e.fireEvent("onLoadedReviewContext",{rootType:H})}function pe(e){let t,n;n=function(o,r){d.on(),U={fileId:o,versions:r},a.downloadDocuments([r[0]],{onComplete:function(o){const a=o[0].fileName.split(".").pop().toLowerCase();let s=function(e,o){let i=p.getManager({name:"DMU2DSheetManager",context:_.getFrameWindow()});i||(i=new D({ctxViewer:_}),p.addManager({name:"DMU2DSheetManager",context:_.getFrameWindow(),manager:i})),i&&i.loadDocumentStream({documentID:P,dataBuffer:e,type:"Document",password:o,fatherNode:_.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:async function(){M&&M(),L&&await L();let e=d._counter;for(let t=0;t<e;t++)d.off();se("info",y.documentLoadOK,"successful"),ue()},onPasswordOk:function(){k&&(k.close(),k=null)},onIncorrectPassword:function(){k?k.onIncorrectPassword():(k=new c({ctxViewer:_}),k.build((function(t){s(e,t)}),(function(){if(F&&t&&n){k&&(k.close(),k=null);let e=d._counter;for(let t=0;t<e;t++)d.off();F.build(t,n,de)}else de()})))},onFailure:le})},l={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){s(e)},onFailure:le,onTimeout:le};if("pdf"===o[0].fileName.split(".").pop().toLowerCase()&&!1===B)H="PDF",h.authenticatedRequest(o[0].downloadUrl,l);else if(re.includes(a.toLowerCase())||"dxf"===a||"dwg"===a||!0===B){!0===B&&(B=!1),H=o[0].fileName.split(".").pop().toUpperCase();let t={ConversionOpts:{},dataFormat:"dxf"===a||"dwg"===a?"udl":"pdf",dtype:"Document",filename:o[0].fileName,format:o[0].fileName.split(".").pop().toLowerCase(),mimetype:o[0].fileName.split(".").pop().toLowerCase(),provider:"FILE",requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},originalAsset:{contextid:v.getSetting("pad_security_ctx"),displayname:o[0].fileName,dtype:"Document",physicalid:P,provider:"EV6",requiredAuth:"passport",serverurl:g.get3DSpaceUrl(),serviceId:"3DSpace",tenant:v.getSetting("x3dPlatformId"),type:"Document"},tenant:v.getSetting("x3dPlatformId"),type:o[0].fileName.split(".").pop().toLowerCase(),url:o[0].downloadUrl};require(["DS/DMUReadPersistence/DMUXCADSupport"],(function(n){n.convertDFA({asset:t,onConvertError:function(e){if("Missing Service"===e){se("warning",y.documentTypeNotSupported);for(let e=0;e<d._counter;e++)d.off()}else se(e)},onConvertSuccess:function(t){if("dxf"===a||"dwg"===a)!function(t){require(["DS/DibUDLWebLoader/DraftingUDLWebLoader"],(function(n){if(n){let o=new n;if(o.set3DAccuracy(.001),o.set2DAccuracy(.001),t){let n={provider:"FILE",serverurl:"",proxyurl:"none",requiredAuth:null};n.filename=t.filename;let a={serverUrl:g.get3DSpaceUrl(),securityContext:v.getSetting("pad_security_ctx"),UDLObjURL:n,onComplete:function(t){E=t;let n=_.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),a=p.getManager({name:"DMU2DSheetManager",context:_.getFrameWindow()});a||(a=new D({ctxViewer:_}),p.addManager({name:"DMU2DSheetManager",context:_.getFrameWindow(),manager:a}));let s=[];for(let n=0;n<t.sheetIDList.length;n++)s.push({modelID:t.sheetIDList[n],sheetID:"Drw."+e.phyID+"_"+t.sheetIDList[n],label:o.getSheetName(t.sheetIDList[n])});a.load2DDocument({loadedSheetInformations:t,phyID:r[0],dataType:"DXF/DWG",sheetNodes:s,parentNode:n,getSheet3DNode:function(e){let t=o.getSheetBackgroundColor(e.modelID);o.getSheet3DNode({sheetID:e.modelID,onSheetNodeCreated:function(o){n.addChild(o),_.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.sheetID)&&e.noUdlWarningMessage(),o.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),_.getViewer().render(),_.getViewpoint().reframe(),e.end();for(let e=0;e<d._counter;e++)d.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){for(let e=0;e<d._counter;e++)d.off();M&&M();let e=i.giveEventsController({viewer:_.getViewer()});e&&e.fireEvent("onDXFLoadSuccess"),L&&L(),ue()},onFailure:function(){_.removeRoots({pids:[n]}),_.displayNotification({msg:y.fileWithNoSVG,eventID:"error"}),W.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};o&&o.loadModel(a)}}}))}(t);else{let e={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){s(e)},onFailure:le,onTimeout:le};h.authenticatedRequest(t.filename,e)}}})}))}else se("error",y.documentNotSupported)}})};let o={onComplete:function(e){if(e&&e.data&&e.data[0]&&e.data[0].relateddata.files){Y.icon=e.data[0].dataelements.typeicon?e.data[0].dataelements.typeicon:null,Y.title=W.getSubContextInformations(e.data[0].id)?W.getSubContextInformations(e.data[0].id).label:e.data[0].dataelements.title?e.data[0].dataelements.title:null;let o=i.giveEventsController({viewer:_.getViewer()});o&&o.fireEvent("onGetDocumentsCompleted");let r=["pdf","dxf","dwg"].concat(re);if(q){let o,i,a,s,c={},u=[];if(q&&(o=0),e.data[0].relateddata.files.forEach((function(e){-1!==r.indexOf(e.dataelements.title.split(".").pop().toLowerCase())&&e.dataelements.title.split(".").pop().toUpperCase()===z&&(c.versions=[],c.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach((function(e){c.versions.push(e.id)})),c.fileId=e.relId,q&&q===e.relId&&(o++,i=e.dataelements.title.split(".").pop().toLowerCase(),a=e.dataelements.title,s=c.versions),c.title=e.dataelements.title,c.creationDate=new Date(e.dataelements.originated),c.modifiedDate=new Date(e.dataelements.modified),u.push(c),c={})})),!o&&e.data[0].relateddata.files.length>0)if("X3DPLAW_AP"===J)se("error",y.documentDeleted);else{T="delete";let e=d._counter;for(let t=0;t<e;t++)d.off();t={title:y.documentPanel.deleteFile,data:u,mode:"delete"},F||(F=new l({immersiveFrame:_.getFrameWindow().getImmersiveFrame()})),F.build(t,n,de)}else e.data[0].relateddata.files.length?o&&re.includes(i)&&e.data[0].relateddata.files.length>1?(_.displayNotification({msg:`${y.markupDocmultioffice} ${a}`,eventID:"error"}),de()):(T="normal",n(q,s)):(_.displayNotification({msg:y.documentNofile,eventID:"warning"}),de())}else if(1===e.data[0].relateddata.files.length||"Quality System Document"===e.data[0].type)if("Quality System Document"===e.data[0].type&&(B=!0),-1===r.indexOf(e.data[0].relateddata.files[0].dataelements.title.split(".").pop().toLowerCase())){se("warning",y.documentTypeNotSupported);let e=m.getCommand("CleanAll",_.getCommandContext());e&&e.begin()}else{let t,o=[];e.data[0].relateddata.files[0].relateddata.versions.length?(t=e.data[0].relateddata.files[0].relId,o.push(e.data[0].relateddata.files[0].id),e.data[0].relateddata.files[0].relateddata.versions.forEach((function(e){o.push(e.id)}))):(t=e.data[0].relateddata.files[0].relId,o.push(e.data[0].relateddata.files[0].id)),n(t,o)}else{let o={},i=[],r=0,a=0;e.data[0].relateddata.files.forEach((function(e){-1!==["pdf","dxf","dwg"].indexOf(e.dataelements.title.split(".").pop().toLowerCase())?(r++,o.versions=[],o.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach((function(e){o.versions.push(e.id)})),o.fileId=e.relId,o.title=e.dataelements.title,o.creationDate=new Date(e.dataelements.originated),o.modifiedDate=new Date(e.dataelements.modified),i.push(o),o={}):re.includes(e.dataelements.title.split(".").pop().toLowerCase())&&(a++,r++)})),!r&&e.data[0].relateddata.files.length>0?se("warning",y.documentTypeNotSupported):e.data[0].relateddata.files.length?a===r?se("warning",y.documentMultiOfficeNotSupported):(t={title:y.documentPanel.selectFile,data:i,mode:"select"},F||(F=new l({immersiveFrame:_.getFrameWindow().getImmersiveFrame()})),F.build(t,n,de)):se("warning",y.documentNofile)}}else le()},onFailure:le,securityContext:v.getSetting("pad_security_ctx"),tenantUrl:g.get3DSpaceUrl(),tenant:v.getSetting("x3dPlatformId"),getVersions:!0};a.getDocuments([e.phyID],o)}""!==window.location.search&&(n.extend(ae,t.parseQuery(window.location.search)),ae.widgetDomain&&n.extend(ae,t.parseQuery(ae.widgetDomain)));const fe=function(e){let t=document.createElement("textarea");return t.innerText=e,t.innerHTML};async function me(e){let t="Requirement Specification"===e.parentElement.type||"Chapter"===e.parentElement.type?[]:[e.parentElement],n=[],o=[],i=function(e){let t="";for(let o=1;o<=e&&n[o];o++)1!==o&&(t+="."),t+=n[o];return t};const r={0:e.parentElement.pathId};for(let a="Chapter"===e.parentElement.type?0:1;a<e.dataObj.length;a++){const s=e.dataObj[a];I.getParentType(s)||I.setParentType(s.type,s["type.kindof"]);const l=parseInt(s.level),d="/";a&&(r[l]=`${r[l-1]}${d}${s["physicalid[connection]"]}${d}${s.physicalid}`);let c={pathId:r[l],typeIconUrl:await ce(s["type.kindof"],s.type_icon_url),level:l};o.length-1>c.level&&(o=o.slice(0,c.level+1)),o[s.level]?o[s.level]++:o[s.level]=1;let u=s["attribute[Title]"];if(u&&(u=u.escapeHTML()),"Chapter"===s["type.kindof"])n[s.level]?n[s.level]++:n[s.level]=1,n.length-1>c.level&&(n=n.slice(0,c.level+1)),c.content=u,c.title=u,c.type=s["type.kindof"],c.chapterLevelTag=i(c.level),c.fontSize=34-2*c.level;else if("Comment"===s["type.kindof"]||"Requirement"===s["type.kindof"]){c.content=s.content,c.title=u,c.type=s["type.kindof"],"1"===s.level?c.chapterLevelTag="0":c.chapterLevelTag=i(c.level-1)||"0";let e="",t=Math.max(0,n.length-1>=c.level?c.level-1:n.length-1);for(let n=t+1;n<=c.level;n++)n!==t+1&&(e+="."),o[n]||(o[n]=1),e+=o[n];c.subLevelTag=e}t.push(c)}A=null;let a=p.getManager({name:"DMU2DSheetManager",context:_.getFrameWindow()});a&&a.loadDocumentStream({documentID:P,type:"Requirement",elementsToLoad:t,fatherNode:_.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:function(){let e=S.giveReqCompareController({context:_});e&&e.isLoading()||(M&&M(),L&&L(),se("info",y.documentLoadOK,"successful"));let t=d._counter;for(let e=0;e<t;e++)d.off();ue()},onFailure:le})}function ge(e){u.getRequirementData(e.parentElement.pathId).then((t=>{e.onComplete(t)})).catch((()=>{le()}))}function ve(e){var t;d.on(),(t=e.phyID,new Promise((function(e,n){u.getRequirementElementContent(t).then((n=>{n&&"success"===n.status&&n.results[0]?e({phyId:t,content:fe(n.results[0]["attribute[Content Data]"]||""),title:n.results[0]["attribute[Title]"],type:n.results[0].type.value}):e({phyId:t})})).catch((()=>{n(new Error("Requirement content Request Failed"))}))}))).then((function(t){let n={pathId:t.phyId,content:t.content,title:t.title.escapeHTML(),type:I.getParentType(t.type)?I.getParentType(t.type):t.type},o=S.giveReqCompareController({context:_}),i=o&&o.isRequirementCompareActive();"Requirement"===n.type||i&&"Comment"===n.type?_.getController().getAttributes({ids:[e.phyID],attributes:["type_icon_url"],callbacks:{onComplete:function(t){n.level=0,n.chapterLevelTag=0,n.subLevelTag=0,ce(n.type,t[e.phyID].type_icon_url).then((e=>{n.typeIconUrl=e,ge({parentElement:n,onComplete:function(e){O=[n.pathId],me({parentElement:n,dataObj:e})}})}))},onFailure:le}}):ge({parentElement:n,onComplete:function(e){O=[n.pathId],e.length>0&&e.forEach((e=>{O.push(e.physicalid)})),me({parentElement:n,dataObj:e})}})}))}function De(e){!function(e){let t,n;e.path&&(t=r.getNodeID(e.path.getLastElement(!0)),n=r.getNodeType(e.path.getLastElement(!0)));let o=S.giveReqCompareController({context:_}),i=o&&o.isRequirementCompareActive();"Document"===n||"Specification Report"===n||"Quality System Document"===n?pe({phyID:t}):("Requirement"===n||"Requirement Specification"===n||i&&("Comment"===n||"Chapter"===n))&&(ve({phyID:t}),H=n)}({path:e.path})}function he(e){let t=_.getRootBagPath().getChildrenPathes();if(1===t.length&&M)M();else{if($){let e=_.subscribe({event:"onRootRemoved"},(()=>{var t;_.unsubscribe(e),Z&&t&&t.id===Z.objectId?Z=null:M&&M()}))}t.forEach((function(t){if(r.getNodeID(t.getLastElement(!0))!==e){let e=S.giveReqCompareController({context:_});if("FailureModesEffectsAnalysis"===t.getLastElement(!0).userData.type){let e=_.getExecutionContext().getComponent("FMEALoaderForDesignValidation"),t=i.giveEventsController({viewer:_.getViewer()});e&&e.remove&&e.remove().then((()=>{var e=W.getLoadedFMEAInformations();t.fireEvent("onRootDataRemoved",e),i.removeReviewContext({viewer:_.getViewer()})}))}else _.removeRoots({pids:[r.getNodeID(t.getLastElement(!0))],reframe:!(e&&e.isLoading())})}}))}}function Ie(e){let t=e.data.objectType,n=e.data.objectParentType,r=e.data.loadMode,a=e.data.objectId,s=e.data.objectName,l=e.data.serviceId,c=e.data.strURI,u=window.widget;function f(){_.setAutomaticReframePolicy(!1);let e=v.getSetting("enopad3dviewer_lightNodeModel")?[{rootID:a,validForServerCall:!0,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:a,"ds6w:type":n,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part","ds6w:label":s,boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:a,"ds6w:type":n,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]},refreshDelegationCB:function(){return new Promise((function(e){e()}))}}]:[{rootID:a,validForServerCall:!0,structure:{rootId:n,results:[{attributes:[{name:"did",value:a},{name:"physicalid",value:a},{name:"ds6w:type",value:n}]},{path:[a]}]}}];_.loadJSON({data:e})}I.getParentType(t)||I.setParentType(t,n);let m=S.giveReqCompareController({context:_});if("PLMPIMMetricReference"===n||"SIMItfSimulation"===n)require([C],(function(t){let o=t.getLoaderForMarkup({context:_});function s(){if(_.getApplicativeData().getLoadedItfData&&_.getApplicativeData().getLoadedItfData().data.length){let e=_.getApplicativeData().getLoadedItfData();e.data[0].prd&&he(e.data[0].prd[0])}e.data.cbOK&&e.data.cbOK()}let l=o.subscribe("onDMUCtxtAlreadyLoaded",(function(){o.unsubscribe(l),s()})),d=o.subscribe("onDMUCtxtLoadingSuccess",(function(){l&&o.unsubscribe(l),o.unsubscribe(d),s(),ue()})),c=i.getReviewContext({context:_});c&&c.getCurrentSessionMarkup()&&"X3DPLAW_AP"!==e.data.appInfo?"SIMItfSimulation"===n?(a===P?H="ITF":Z&&Z.objectId===a&&(Z.type="ITF"),_.getApplicativeData().getLoadedItfData&&_.getApplicativeData().getLoadedItfData().data.length?(a===_.getApplicativeData().getLoadedItfData().data[0].isrID||(c.getCurrentSessionMarkup().setActiveFlag(!1),o.remove({data:{objectType:"SIMItfSimulation",objectId:_.getApplicativeData().getLoadedItfData().data[0].isrID}})),o.load({data:{isrID:[a],loadMode:r}})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),o.load({data:{isrID:[a],loadMode:r}}))):(a===P?H="ISR":Z&&Z.objectId===a&&(Z.type="ISR"),o.getIsrPointingToMetric([a]).then((function(e){let t=e[a][0];_.getApplicativeData().getLoadedItfData&&_.getApplicativeData().getLoadedItfData().data.length?(t===_.getApplicativeData().getLoadedItfData().data[0].isrID||(c.getCurrentSessionMarkup().setActiveFlag(!1),o.remove(_.getApplicativeData().getLoadedItfData().data[0].isrID)),o.load({data:{metricID:[a]},loadMode:r})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),o.load({data:{metricID:[a],loadMode:r}}))}))):"SIMItfSimulation"===n?(a===P?H="ITF":Z&&Z.objectId===a&&(Z.type="ITF"),o.load({data:{isrID:[a],loadMode:r}})):(a===P?H="ISR":Z&&Z.objectId===a&&(Z.type="ISR"),o.load({data:{metricID:[a]},loadMode:r}))}));else if("DIFLayout"===n||"DIFSheet"===n)require(["DS/DibUDLWebLoader/CATDibUDLWebLoader"],(function(n){if(n){let o=new n,i={data:{physicalid:a,dataType:t},contextViewer:_,serverUrl:g.get3DSpaceUrl(),securityContext:v.getSetting("pad_security_ctx"),onComplete:function(n){E=n;let i=p.getManager({name:"DMU2DSheetManager",context:_.getFrameWindow()});i||(i=new D({ctxViewer:_}),p.addManager({name:"DMU2DSheetManager",context:_.getFrameWindow(),manager:i}));let r=[];for(let e=0;e<n.sheetIDList.length;e++)r.push({modelID:n.sheetIDList[e],sheetID:"Drw."+a+"_"+n.sheetIDList[e],label:o.getSheetName(n.sheetIDList[e])});i.load2DDocument({loadedSheetInformations:n,phyID:a,dataType:t,sheetNodes:r,getSheet3DNode:function(e){let t=o.getSheetBackgroundColor(e.modelID);o.setDisplaySheet({sheetID:e.modelID,onSheetNodeCreated:function(){_.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.modelID)&&e.noUdlWarningMessage(),Z&&a===Z.objectId||o.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),_.getViewer().render(),Z||_.getViewpoint().reframe(),e.end();for(let e=0;e<d._counter;e++)d.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){ue();for(let e=0;e<d._counter;e++)d.off();M&&M(),e.data.cbOK&&e.data.cbOK()},onFailure:function(){_.displayNotification({msg:y.fileWithNoSVG,eventID:"error"}),W.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};o&&o.loadModel(i)}})),H="FLDiagram",Z||he(a);else if("DIFAnnotationSet"===n)require([x],(function(t){new t({context:_}).load({id:a}).then((()=>{e.data.cbOK&&e.data.cbOK()}))}));else if("DesignSight"===n)require([b],(e=>{_.getFrameWindow().options={},_._context="Default",_.getFrameWindow().options.context="Default";let t=e.getLoaderForMarkup({context:_});t&&te&&(H="MSR",a!==ee?(t.load({data:{msrID:a},onComplete:()=>{te=!0,ee=a,M&&M();let e=_.subscribe({event:"onRootRemoved"},(()=>{_.unsubscribe(e),ee&&(ee=null)}))},onFailure:()=>{te=!0}}),te=!1):_.displayNotification({msg:y.msrAlreayLoaded,eventID:"info"}))})),$=!1,he(a);else if("DELLmiWorkPlanSystemReference"===n||"DELLmiPPRHeaderProcessReferenceAbstract"===n||"DELLmiHeaderWorkPlanReference"===n)!function(e,t){var n=_.getExecutionContext();let o=i.giveEventsController({viewer:_.getViewer()});n&&o.fireEvent("onWorkplanLoadingStarted",{onComplete:function(){var n=_.getExecutionContext().getComponent("DelOERDMULoader");n&&(H=t,n.load({items:[{id:e}],onComplete:function(){_._dropZoneContainer.hide(),W.setLoadedWorkplanInformations({id:e,type:t}),o&&o.fireEvent("onWorkplanLoadSuccess",{id:e,type:t})},onFailure:function(){}}))}})}(a,n),$=!1,he(a);else if("FailureModesEffectsAnalysis"===n)!async function(e,t,n){let r=_.getExecutionContext?_.getExecutionContext():null;if(r){if(V=r.getComponent("FMEALoaderForDesignValidation"),V||(await r.switchApp(r.getSourceApp().getId(),u.data.appId+"_2DTable"),V=r.getComponent("FMEALoaderForDesignValidation")),!V)throw new Error("Loader not found")}else V=await new Promise((e=>{require([w],(function(t){let n=new t,o=n.initializeAfterRequire({frameWindow:_.getFrameWindow()});o instanceof Promise?o.then((function(){e(n)})):e(n)}))}));H=t,n&&n(V),await(async n=>{let r=i.giveEventsController({viewer:_.getViewer()}),a=_.getRootBagPath().getLastElement()?_.getRootBagPath().getLastElement(!0):null,s=new o;return s.setModelIdentification(e),s.setUserData({type:t}),a.addChild(s),r&&r.fireEvent("onBeginContextLoading"),await n.load({items:[{id:e}]}),_._dropZoneContainer.hide(),W.setLoadedFMEAInformations({id:e,type:t}),ue(),M&&M(),r&&r.fireEvent("onFMEALoadSuccess",{id:e,type:t}),{id:e,type:t}})(V)}(a,n,e.data.cbFmeaLoaderLoaded),$=!1,he(a);else if(["Document","Quality System Document","Requirement","Requirement Specification","Specification Report","DELLmiWorkPlanSystemReference","DELLmiPPRHeaderProcessReferenceAbstract"].includes(n)||m&&m.isRequirementCompareActive()&&("Chapter"===n||"Comment"===n)){if(m&&m.isLoading()||!_.getRootBagPath().getChildrenPathes().length)e.data.subContext&&e.data.subContext.id&&W.setSubContextInformations({mainContextId:e.data.objectId,subContext:e.data.subContext}),f();else{let e=_.subscribe({event:"onEndRootRemoved"},(function(t){_.unsubscribe(e),e=-1,t&&t.ids&&t.ids.includes(P)||f()})),t=i.giveEventsController({viewer:_.getViewer()});t&&t.addEvent("onRootDataRemoved",(function(e){e&&e.ids&&e.ids.includes(P)||f()}))}$=!1,(!m||m&&!m.isRequirementCompareActive())&&he(a)}else"R2V_Activity"===n&&(H="R2V_Activity",h={serviceId:l,objectId:a,strURI:c},-1===oe.findIndex((e=>e.id===h.objectId))&&function(e){return new Promise(((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(g.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/modeler/v2/activity/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":v.getSetting("lang")},data:JSON.stringify({ids:[e.objectId]}),timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})}))}(h).then((e=>{oe.push({id:h.objectId,info:e.result,strURI:h.strURI})})));var h;let R=i.giveEventsController({viewer:_.getViewer()});R&&R.fireEvent("onLoadedReviewContext",{rootType:n})}this.getLoadedID=function(){return P},this.setLoadedID=function(e){P=e},this.getIsrContext=function(e){return new Promise((function(t){require([C],(function(n){n.getLoaderForMarkup({context:_}).getIsrContext(e).then(t)}))}))},this.load=function(e){if(!j){J=e.data.appInfo,P=e.data.objectId instanceof Array?e.data.objectId[0]:e.data.objectId,L=e.data.cbOK,q=e.data.fileId;const t=e.data.serviceId;let n;e.data.documentType&&(z=e.data.documentType),ne=e.data.objectType,M=e.data.loadMarkup?e.data.loadMarkup:null,n=e.data&&e.data.subContext?e.data.subContext.label:e.data.displayName,Ie({data:{appInfo:J,objectId:P,objectType:e.data.objectType,objectParentType:e.data.objectParentType?e.data.objectParentType:e.data.objectType,objectName:n,loadMode:e.data.loadMode,cbOK:L,fileId:q,documentType:z,loadMarkup:M,serviceId:t,subContext:e.data.subContext,strURI:e.data.strURI,cbFmeaLoaderLoaded:e.data.cbFmeaLoaderLoaded}})}},this.clean=function(e){_&&(k&&(k.close(),k=null),F&&F.destroy(),J=H=F=A=E=O=null,$=!0,e&&(P=null,K.onRootAdded&&_.unsubscribe(K.onRootAdded),K.onRootAdded=null,K.widgetReresh&&_.unsubscribe(K.widgetReresh),K.widgetReresh=null),X={},Y={},_.getViewer().render())};this.getLoadMarkupDocumentMode=function(){return T},this.getLoadMarkupCtxType=function(){return H},this.getLoadedSheetInformations=()=>E,this.getTempObjectInformations=()=>Y,this.getLoadedR2VInformations=()=>oe,this.setLoadedR2VInformations=e=>{oe=e},this.updateLoadedR2VInformations=(e,t)=>{"remove"===t&&(oe=oe.filter((t=>t.id!==e)))},this.getLoadedWorkplanInformations=()=>j,this.setLoadedWorkplanInformations=e=>{j=e},this.updateLoadedWorkplanInformations=(e,t)=>{"remove"===t&&(j=void 0)},this.getLoadedFMEAInformations=()=>N,this.getLoaderInstanceForExperience=function(){return V},this.setLoadedFMEAInformations=(e,t)=>{N="remove"===t?void 0:e},this.getSubContextInformations=e=>ie[e],this.setSubContextInformations=e=>{e&&e.mainContextId&&(ie[e.mainContextId]=e.subContext)},this.removeSubContextInformations=e=>{e&&ie[e]&&(ie[e]=void 0)},this.getDocumentVersionInfos=function(){return U},this.subscribe=function(e,t){if(e&&t&&G)return G.subscribe({event:e},t)},this.unsubscribe=function(e){G&&e&&G.unsubscribe(e)},this.publish=function(e,t){G&&G.publish({event:e,data:t})},X.on2DDocumentLoadRequired=Q.addEvent("on2DDocumentLoadRequired",(e=>{e&&(Z={objectType:e.documentType,objectId:e.rootID,objectParentType:e.documentType,objectName:e.objectName},e.rootID&&(P=e.rootID),Ie({data:Z}))})),K.onRootAdded=_.subscribe({event:"onRootAdded"},De),K.onFMEALoadSuccess=_.subscribe({event:"onFMEALoadSuccess"},De),K.widgetReresh=_.subscribe({event:"widgetReresh"},(e=>{"DesignSight"!==e.objectType&&"DIFLayout"!==e.objectType&&"DIFSheet"!==e.objectType&&"FailureModesEffectsAnalysis"!==e.objectType||(e.objectParentType=e.objectParentType?e.objectParentType:e.objectType,Ie({data:e}))})),X.onGetLoadedSheetInformations=Q.addEvent("onGetLoadedSheetInformations",(e=>{e.cb&&e.cb(E)})),X.onGetLoadedReqSpecInformations=Q.addEvent("onGetLoadedReqSpecInformations",(e=>{e.cb&&e.cb(O)}))}}),R=[];return e.singleton({init:function(){},giveLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<R.length;t++)if(R[t].context===e.context)return R[t].controller},getLoadingContextController:function(e){let t;if(e&&e.context&&(t=this.giveLoadingContextController(e),!t)){let n=new M({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},getLoadedID:function(){if(n)return n.getLoadedID()},setLoadedID:function(e){if(n)return n.setLoadedID(e)},getDocumentVersionInfos:function(){if(n)return n.getDocumentVersionInfos()},getIsrContext:function(e){if(n)return n.getIsrContext(e)},clean:function(e){if(n)return n.clean(e)},getLoadMarkupDocumentMode:function(){if(n)return n.getLoadMarkupDocumentMode()},getLoadMarkupCtxType:function(){if(n)return n.getLoadMarkupCtxType()},getLoadedSheetInformations:function(){if(n)return n.getLoadedSheetInformations()},getTempObjectInformations:function(){if(n)return n.getTempObjectInformations()},setLoadedR2VInformations:function(e){if(n)return n.setLoadedR2VInformations(e)},getLoadedR2VInformations:function(){if(n)return n.getLoadedR2VInformations()},getLoadedWorkplanInformations:function(){if(n)return n.getLoadedWorkplanInformations()},setLoadedWorkplanInformations:function(){if(n)return n.setLoadedWorkplanInformations()},getLoadedFMEAInformations:function(){if(n)return n.getLoadedFMEAInformations()},getLoaderInstanceForExperience:function(){if(n)return n.getLoaderInstanceForExperience()},setLoadedFMEAInformations:function(e,t){if(n)return n.setLoadedFMEAInformations(e,t)},setSubContextInformations:function(e){if(n)return n.setSubContextInformations(e)},getSubContextInformations:function(e){if(n)return n.getSubContextInformations(e)},removeSubContextInformations:function(e){if(n)return n.removeSubContextInformations(e)},updateLoadedR2VInformations:function(e,t){if(n)return n.updateLoadedR2VInformations(e,t)},updateLoadedWorkplanInformations:function(e,t){if(n)return n.updateLoadedWorkplanInformations(e,t)}}),R.push({context:e.context,controller:t})}return t},unreferenceLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<R.length;t++)R[t].context===e.context&&(R[t].controller.clean(!0),R.splice(t,1))}})})),define("DS/DMUReadPersistence/DMUValidationReadServices",["UWA/Class","DS/DMUBaseExperience/EXPUtils","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/VisuDataAccess/Ox4StreamLoader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADSettingsMgt"],(function(e,t,n,o,i,r,a){"use strict";return e.extend({init:function(){this.getProductByValidationId=function(e,t,o){n.sendWebServiceCall({url:"resources/validation/service/getPrdIdByValidationId",config:{verb:"POST",data:{sValidationId:e}},onSuccess:function(e){var n=JSON.parse(e);t(n)},onFailure:function(){o()}})},this.getAllElementsByValidationId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getAll",config:{verb:"POST",data:{sValidationId:e.validationId}},onSuccess:function(t){var o=JSON.parse(t);let i;o.children.forEach((e=>{"DMUValidationContext"===e.type&&e.contextURI&&(i=e.contextURI)})),function(e,t){return t?(o={contextURI:t},new Promise(((e,t)=>{n.sendWebServiceCall({url:"resources/r2v/modeler/v2/i3dx/fetch",serviceId:"r2vsurvey",doNotSetSecurityContextInUrl:!0,config:{verb:"POST",data:{data:[{"ds6w:i3dx":o.contextURI}]}},onSuccess:function(t){var n=JSON.parse(t);e(n)},onFailure:t,onTimeout:t})}))).then((t=>(e.children.forEach((e=>{"DMUValidationContext"===e.type&&(e.serviceID=t.data[0]["ds6w:dataSource"],e.contextIds=[t.data[0].resourceid])})),e))):Promise.resolve(e);var o}(o,i).then((t=>{e.onSuccess(t)}))},onFailure:function(){e.onFailure()},platform:e.platform})},this.getMarkupJson=function(e,s,l,d){var c={IRPC:!0,serverUrl:n.get3DSpaceUrl(),physicalid:e.markupId,boType:"VALReview",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(n){window.console.log("getMarkupJson::success:"+n.byteLength),s({jsonObj:JSON.parse(t.cleanJSONString(n)),reviewPid:e.markupId,reviewName:e.markupName,modifiable:!0},d)},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),l(e="NOSTREAM")}};window.console.log("Loading streams");var u=r.getUser().login;i.useUWAProxy({proxymode:"passport",login:u,contextid:a.getSetting("pad_security_ctx")}),o.Load(c)},this.getValidationFromHighlightId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationFromHighlightId",config:{verb:"POST",data:{sHighlightId:e.highlightId}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})},this.getValidationsFromObjectsIds=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationsFromObjectsIds",config:{verb:"POST",data:{listHighlights:e.highlightIds,listChecks:e.checkIds,listValidations:e.validationIds}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})}}})})),define("DS/DMUReadPersistence/DMULoadMarkupServices",["UWA/Class","UWA/Utils","DS/DMUControls/EXPNotify","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUReadPersistence/DMUValidationReadServices","DS/DMUBaseWebValidation/EXPValImporter","DS/DMUBaseUI/DMUToolsUsers","DS/DMUReadPersistence/DMUReadServices","DS/CATWebUXComponents/DMUCommandsManager","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUReadPersistence/DMULoadingContextController","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUReadPersistence/DMUWebServicesUtils","DS/DMUBaseExperience/EXPToolsContext","DS/PADUtils/PADSession","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],(function(e,t,n,o,i,r,a,s,l,d,c,u,p,f,m,g,v,D,h,I,S,y,C,x){"use strict";var b=e.extend({init:function(b){var w,M,R,P,U,F,L,k=this,T=!0,A=new u,E=b.ctxViewer,O=[],j=[],N=0,V=new i,W=new r,_={};function q(e){return new Promise(((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(D.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/modeler/v2/featureofinterest/"+e.objectId+"/activities",{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":h.getSetting("lang")},timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})}))}function J(){var e=f.getReviewContext({context:E});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().setReadOnly(!0);var t=d.getCommand("DMUMarkupHdr",E.getCommandContext());t&&t.enable();var n=d.getCommand("CleanAll",E.getCommandContext());n&&n.enable()}function B(e,t){A&&A.publish({event:e,data:t,context:k})}function K(e){if(E&&e!==T){T=e;var t=f.getReviewContext({context:E});T?(E&&(O&&(O.forEach((function(e){var t=d.getCommand(e._id,E.getCommandContext());t&&(e._isEnabled?t.enable():t.disable())})),O=[]),j&&(j.forEach((function(e){var t=d.getCommandCheckHeader(e._id,E.getCommandContext());e&&(e._isEnabled?t.enable():t.disable())})),j=[])),t&&t.getNode()&&t.getNode().setPickable(c.PICKABLE)):(!function(){if(E){var e,t,n=d.getCommands(E.getCommandContext());for(e in n)n.hasOwnProperty(e)&&(t=n[e],O.push({_id:t._id,_isEnabled:t._isEnabled}));var o=d.getCommandCheckHeaders(E.getCommandContext());for(e in o)o.hasOwnProperty(e)&&(t=o[e],j.push({_id:t._id,_isEnabled:t._isEnabled}));d.disableAll(E.getCommandContext())}}(),t&&t.getNode()&&t.getNode().setPickable(c.PICKTHROUGH)),E.getViewer().render()}}function X(e,t){w&&(w.destroy(),w=null),w=new n({body:E.getFrameWindow().getUIFrame(),type:e,message:t})}function G(e){E&&(N>0&&(v.off(),N--),K(!0),e&&X("error",e),E.getWidget().dispatchEvent("onDMUMarkupLoadFailed"),B("onDMUMarkupLoadFailed"))}function H(e){if(E){N>0&&(v.off(),N--);var t=f.getReviewContext({context:E});G("Cancel"!==e?"NoMarkup"===e?x.loadNoMarkup:x.loadError:void 0),t&&t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().isReadOnly()&&J()}}async function z(e){K(!0),N>0&&(v.off(),N--);let t=L?L.getLoadMarkupCtxType():M;F||"R2V_Activity"!==t||(F=E.subscribe({event:"onR2VLoaded"},(function(){E.getSoIUsability()&&E.toggleSOITimelinesUsability(!1),E.unsubscribe(F),F=null}))),f.removeReviewContext({context:E}),await o.createReviewContext({context:E}),l.importModel({dataJson:e.jsonObj,appType:e.ID,viewer:E.getViewer(),onImportCompleted:function(n){if(!E)return;let o;t=L&&L.getLoadMarkupCtxType()?L.getLoadMarkupCtxType():M;let i=L?L.getSubContextInformations(e.contextId):void 0;o=i?{title:i.label}:L?L.getTempObjectInformations():void 0;var r=f.getReviewContext({context:E});const a=e.jsonObj&&e.jsonObj.ApplicativeContext?e.jsonObj.ApplicativeContext:null;n[0]&&n[0].setApplicativeContext&&n[0].setApplicativeContext(a);const l=n[0].getMarkupContent?n[0].getMarkupContent():n[0];l&&l.setMaturityState(e.reviewState),r.setCurrentSessionMarkup(l),r.setReviewCtxInformation({contextId:e.contextId,contextType:t,subContextId:e.subContextId,subContext:e.subContext,reviewId:e.reviewPid,reviewName:e.reviewName,reviewDescription:e.reviewDescription,reviewType:e.reviewType,owner:e.owner,modifiable:e.modifiable,tempObjectInfo:o}),m.setSlidePreferences({context:E.getFrameWindow(),preferences:{panelTitle:e.reviewName}}),f.getContextViewer({viewer:E.getFrameWindow().getViewer()}).getController().getAttributes({ids:[e.reviewPid],attributes:["ds6w:reservedBy"],callbacks:{onComplete:function(t){if(t){const o=s.getUserLogin();var n=t[e.reviewPid]["ds6w:reservedBy"];n&&o?s.getUserName(o,void 0,(function(e){e!==n&&X("info",x.ReviewReserved+" "+n)})):e.modifiable?e.fromRefresh||X("info",x.loadOK):X("info",x.ReviewNotModifiable)}},onFailure:function(){return null}}}),e.modifiable||J(),B("onDMUMarkupLoadSucceeded",{id:e.reviewPid})},onImportFailed:H})}function $(e,t){I.getParentTypes(e).then((function(n){t([e].concat(n))})).catch((function(){t([e])}))}function Q(e,t,n){return E?new Promise((function(n){"SIMItfSimulation"===t?(L||(L=g.getLoadingContextController({context:E})),L.getIsrContext(e).then((function(e){n({contextID:e&&e.length?e[0]:null})}))):n({contextID:e})})).then((function(e){var t,o,i,r=E.getRootBagPath().getChildrenPathes();if(0===r.length)n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;else for(let a=0;a<r.length;a++){if(i=p.getNodeID(r[a].getLastElement(!0)),E.getController().isFiltered(i).filterId?t=E.getController().isFiltered(i).filterId:o=i,o&&o===e.contextID){n.loadMarkupAllowed=!0;break}if(t&&i===e.contextID){n.removeFilterAllowed=!0,n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;break}}return Promise.resolve({conditions:n,sessionFilterId:t,sessionProductId:o,sessionRootId:i})})):Promise.resolve()}function Z(e,t,n,o,i,r,a,s){var l=e.conditions,d=e.sessionRootId,c=null,u=null,p={};$(i,(function(e){if(e&&e.length)if(-1!==e.indexOf("DesignSight")||-1!==e.indexOf("SIMItfSimulation")||-1!==e.indexOf("Document")||-1!==e.indexOf("Requirement Specification")||-1!==e.indexOf("Requirement")||-1!==e.indexOf("FailureModesEffectsAnalysis")||-1!==e.indexOf("Specification Report"))if(l.loadMarkupAllowed||-1!==e.indexOf("SIMItfSimulation")){let o;L||(L=g.getLoadingContextController({context:E})),o="Markup"===t.objectType?V.getDnDReviewAndJSONFile:V.getMarkupStream,o({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner,fromRefresh:t.fromRefresh},(function(o){if(o&&(o.reviewState=o.reviewState||t.currentState),o.jsonObj.Contexts){let t;-1!==e.indexOf("Document")?t="Document":-1!==e.indexOf("Specification Report")&&(t="Specification Report"),t?(o.jsonObj.Contexts[0].documentVersionInfos&&(R=o.jsonObj.Contexts[0].documentVersionInfos),p.objectId=n,p.objectType=i,p.objectParentType=t,p.displayName=a,p.fileId=R.fileId,p.versionId=R.versions[0],p.versions=R.versions,p.documentType=o.jsonObj.Contexts[0].documentType,r&&r.id&&(p.subContext=r),p.loadMarkup=function(){L.getDocumentVersionInfos().versions[0]!==R.versions[0]&&("normal"===L.getLoadMarkupDocumentMode()?X("info",x.loadMarkupWithNewVersionFile):"delete"===L.getLoadMarkupDocumentMode()&&X("info",x.loadMarkupWithNewFile)),o.contextId=n,r&&r.id&&(o.subContext=r),z(o)},l.loadProductAllowed?L.load({data:p}):l.loadMarkupAllowed&&p.loadMarkup()):-1!==e.indexOf("SIMItfSimulation")&&(c=o.jsonObj.Contexts[0].listData,u=o.jsonObj.Contexts[0].loadingInfos,c&&0!==c.length?(p.objectId=c,p.objectType="PLMPIMMetricReference",p.loadMode=u,p.loadMarkup=function(){o.contextId=n,z(o)},L.load({data:p})):(p.objectId=n,p.objectType=i,p.objectParentType="SIMItfSimulation",p.loadMode=u,p.loadMarkup=function(){o.contextId=n,z(o)},L.load({data:p})))}else-1!==e.indexOf("Requirement")||-1!==e.indexOf("Requirement Specification")?(p.objectId=n,p.objectType=i,p.displayName=a,p.objectParentType=-1!==e.indexOf("Requirement")?"Requirement":"Requirement Specification",p.loadMarkup=function(){o.contextId=n,z(o)},L.load({data:p})):-1!==e.indexOf("DesignSight")?(p.objectId=n,p.objectType=i,p.objectParentType="DesignSight",p.loadMode=u,p.loadMarkup=function(){o.contextId=n,z(o)},l.loadProductAllowed?L.load({data:p}):l.loadMarkupAllowed&&p.loadMarkup()):-1!==e.indexOf("FailureModesEffectsAnalysis")&&(p.objectId=n,p.objectType=i,p.objectParentType="FailureModesEffectsAnalysis",p.loadMode=u,p.loadMarkup=function(){o.contextId=n,z(o)},l.loadProductAllowed?L.load({data:p}):l.loadMarkupAllowed&&p.loadMarkup())}),H)}else G(x.DragAndDropError);else{if((l.removeFilterAllowed||l.removeProductAllowed)&&E.getController().removeRoots({pids:[d]}),l.loadFilterAllowed&&E.addFilter([{objectId:o}]),l.loadProductAllowed){var f=E.getAutomaticReframePolicy();E.setAutomaticReframePolicy(!1),-1!==e.indexOf("DIFLayout")||-1!==e.indexOf("DIFSheet")?(L||(L=g.getLoadingContextController({context:E})),p.objectId=n,p.objectType=i,p.objectParentType=-1!==e.indexOf("DIFLayout")?"DIFLayout":"DIFSheet",L.load({data:p})):-1!==e.indexOf("DELLmiWorkPlanSystemReference")?(L||(L=g.getLoadingContextController({context:E})),p.objectId=n,p.objectType=i,p.objectParentType="DELLmiWorkPlanSystemReference",L.load({data:p})):-1!==e.indexOf("DELLmiHeaderWorkPlanReference")?(L||(L=g.getLoadingContextController({context:E})),p.objectId=n,p.objectType=i,p.objectParentType="DELLmiHeaderWorkPlanReference",L.load({data:p})):"R2V_Activity"===i?(F=E.subscribe({event:"onR2VLoaded"},(function(){setTimeout((()=>{E.getSoIUsability()&&E.toggleSOITimelinesUsability(!1),E.unsubscribe(F),F=null}))})),function(e,t){return t?Promise.resolve(e):q({objectId:e,serviceId:"r2vsurvey"}).then((e=>e.result[0].resourceid))}(n,s).then((e=>{E.addR2Vs({objects:[{displayName:"r2vName",objectId:e,objectType:"R2V_Activity",path:[{resourceid:e,type:"R2V_Activity"}],serviceId:"r2vsurvey"}],reframe:!1,displayNotif:!0,dispatch:!0})}))):E.addRoots({objects:[{path:[n]}]}),E.setAutomaticReframePolicy(f)}let r=()=>{let e;e="Markup"===t.objectType?V.getDnDReviewAndJSONFile:V.getMarkupStream,e({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner,fromRefresh:t.fromRefresh},(function(e){e&&(e.reviewState=t.currentState),e.contextId="ENOStrRefinementSpecification"===i?o:n,z(e)}),H)};if(l.loadMarkupAllowed)if("Drawing"===i){let e=setInterval((function(){E.getViewer().get2DMode()&&(r(),clearInterval(e),e=null)}),100)}else r();else G(x.DragAndDropError)}}))}function Y(t){return new e.Promise((function(e){function n(){e({status:"KO",msg:x.loadError})}if(!t||!t.objectId||!t.objectType)return void n();let o;o="Markup"===t.objectType?V.getProductByMarkerId:V.getMarkupInfos,o({physicalid:t.objectId},(function(t){if(E){var n,o,i,r,a,s,l,d,c,u,f={loadProductAllowed:!1,removeProductAllowed:!1,loadFilterAllowed:!1,removeFilterAllowed:!1,loadMarkupAllowed:!1};if(t&&t.MarkupContext&&t.MarkupContext.contexts&&t.MarkupContext.contexts.length){if(1===t.MarkupContext.contexts.length)"R2V_FeatureState"===(n=t.MarkupContext.contexts[0].type)&&(n="R2V_Activity"),M=n;else if(t.MarkupContext.contexts.length>1)for(var m=0;m<t.MarkupContext.contexts.length;m++)"Specification Report"===t.MarkupContext.contexts[m].type?(c=t.MarkupContext.contexts[m].id,n=t.MarkupContext.contexts[m].type,M=n):d={id:t.MarkupContext.contexts[m].id,type:t.MarkupContext.contexts[m].type,label:t.MarkupContext.contexts[m].name}}else"r2vsurvey"===t.MarkupContext.serviceID?(n=M="R2V_Activity",u=t.MarkupContext.contextURI):e({status:"NoContextFound"});if(t&&t.name&&(s=t.name),t&&t.currentState&&(l=t.currentState),n&&"ENOStrRefinementSpecification"===n){var g=[i=t.MarkupContext.contexts[0].id];E.getController().getPrdIdFromFilterId(g).then((function(t){let r="OK";a=function(e,t,n){if(E){var o,i,r,a=E.getRootBagPath().getChildrenPathes();if(0===a.length)n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;else for(let s=0;s<a.length;s++){if(r=p.getNodeID(a[s].getLastElement(!0)),E.getController().isFiltered(r).filterId?o=E.getController().isFiltered(r).filterId:i=r,o&&o===e){n.loadMarkupAllowed=!0;break}if(o&&o!==e&&r===t){n.removeFilterAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}if(i&&t===i){n.removeProductAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}}return{conditions:n,sessionFilterId:o,sessionProductId:i,sessionRootId:r}}}(i,o=t,f),y.isAuthoring()&&(r="DbModeFilter"),e({status:r,mkpMaturityState:l,valMarkup:a,mkpName:s,relatedRootId:o,relatedFilterId:i,relatedObjectType:n})})).catch((function(t){window.console.log(t),e({status:"KO",msg:x.loadError})}))}else"R2V_Activity"===n?Q(o=t.MarkupContext.contextIds&&t.MarkupContext.contextIds.length>0?t.MarkupContext.contextIds[0]:t.MarkupContext.contextId,n,f).then((function(t){e({status:"OK",mkpMaturityState:l,valMarkup:t,mkpName:s,relatedRootId:o,relatedFilterId:i,relatedObjectType:n,contextURI:u})})):(o=c||t.MarkupContext.contexts[0].id,r=t.MarkupContext.contexts[0].name,Q(o,n,f).then((function(a){e({status:"OK",mkpMaturityState:l,valMarkup:a,mkpName:s,relatedRootId:o,relatedFilterId:i,relatedObjectType:n,relatedSubContext:d,relatedObjectTitle:r,mkpOwner:t.owner})})))}}),n)}))}function ee(e){W.getMarkupJson({markupId:e.markup.getPlmID(),markupName:e.markup.getName()},e.onLoadingCompleted,e.onLoadingFailed,e.markup)}function te(e){l.importModel({dataJson:e.asset.jsonObj,appType:e.asset.ID,mkpRepRef:e.asset.markupCtx,viewer:E.getViewer(),onImportFailed:e.onImportFailed,onImportCompleted:e.onImportCompleted})}""!==window.location.search&&(UWA.extend(_,t.parseQuery(window.location.search)),_.widgetDomain&&UWA.extend(_,t.parseQuery(_.widgetDomain))),this.subscribe=function(e,t){if(A&&e&&t)return A.subscribe({event:e},t)},this.unsubscribe=function(e){A&&e&&A.unsubscribe(e)},this.load=function(e){e.objectId&&E&&(v.on(x.LoadingPanel,null),N++,Y(e).then((function(t){var n;"KO"===t.status?G(x.loadError):"NoContextFound"===t.status?G(x.loadMarkupNoContext):"DbModeFilter"===t.status?(n=x.loadDbModeFilterMarkup,E&&(N>0&&(v.off(),N--),K(!0),n&&X("warning",n),E.getWidget().dispatchEvent("onDMUMarkupLoadFailed"),B("onDMUMarkupLoadFailed"))):(e.displayName=t.mkpName,e.owner=t.mkpOwner,e.currentState=t.mkpMaturityState,Z(t.valMarkup,e,t.relatedRootId,t.relatedFilterId,t.relatedObjectType,t.relatedSubContext,t.relatedObjectTitle,t.contextURI))})))},this.loadIfContextLoaded=function(e){if(E)return new Promise((function(t){Y(e).then((function(n){if(E){var o=n.valMarkup.conditions;"OK"!==n.status||o.removeFilterAllowed||o.removeProductAllowed||o.loadFilterAllowed||o.loadProductAllowed||!o.loadMarkupAllowed?t(!1):(e.currentState=n.mkpMaturityState,Z(n.valMarkup,e,n.relatedRootId,n.relatedFilterId,n.relatedObjectType,n.relatedObjectTitle),t(!0))}}))}))},this.getMarkupContextType=function(){return M},this.getDocumentVersionInfos=function(){return R},this.loadValidation=function(e){let t,n,i,r,s,l,d=0,c=["Requirement Specification","Requirement","DIFLayout","DIFSheet","Document","Specification Report","SIMItfSimulation","PLMPIMMetricReference","DesignSight","FailureModesEffectsAnalysis","DELLmiPPRHeaderProcessReferenceAbstract","DELLmiWorkPlanSystemReference"];if(L||(L=g.getLoadingContextController({context:E})),E){var u,v=f.getReviewContext({context:E});if(v&&(u=v.getValidation()),e.reviewId){var D=f.giveEventsController({viewer:E.getViewer()}),h=null,I=function(o){return new Promise((function(a){if(o){var s=o.getRepRef();s?D.fireEvent("onGetMarkupJsonEvt",{markup:s,onLoadingCompleted:function(o,s){let u=()=>{o.markupCtx=s,D.fireEvent("onImportModelEvt",{asset:o,onImportCompleted:function(e){if(e&&e[0]){var t=e[0].getMarkupContent?e[0].getMarkupContent():e[0];t&&(s.getMarkupContent()||s.setMarkupContent(t),t.getMarkupOwner()||t.setMarkupOwner(s),h&&t.setReadOnly(h.isReadOnly()||s.isReadOnly()))}a("OK")}})},p=r||n;if(-1!==c.indexOf(p))if(0!==d||E.getRoots().length)E.getRoots().length&&D.fireEvent("onLoadedReviewContext",{rootType:p}),u();else{if("FailureModesEffectsAnalysis"===p){let e=D.addEvent("onFMEALoadSuccess",(function(){D.removeEvent(e),u()}))}else if("DELLmiWorkPlanSystemReference"===p||"DELLmiPPRHeaderProcessReferenceAbstract"===p){let e=D.addEvent("onWorkplanLoadSuccess",(function(){D.removeEvent(e),u()}))}else{let e=E.subscribe({event:"onRootAdded"},(function(){E.unsubscribe(e),u()}))}d++;let r={};if(o.jsonObj.Contexts){if("Document"===p||"Specification Report"===p){if(o.jsonObj.Contexts[0].documentVersionInfos&&(R=o.jsonObj.Contexts[0].documentVersionInfos),r.objectId=t,r.objectType=n,r.objectParentType=p,r.fileId=R.fileId,r.versionId=R.versions[0],r.versions=R.versions,r.documentType=o.jsonObj.Contexts[0].documentType,r.displayName=i,l&&(r.subContext=l),L.load({data:r}),D)var m=D.addEvent("onGetDocumentsCompleted",(function(){D.removeEvent(m);let e=f.getReviewContext({context:E});if(e){let t,n=e.getReviewCtxInformation();t=l?{title:l.label}:L?L.getTempObjectInformations():void 0,n.tempObjectInfo=t,e.setReviewCtxInformation(n)}}))}else if("SIMItfSimulation"===p){let e=o.jsonObj.Contexts[0].listData,i=o.jsonObj.Contexts[0].loadingInfos;e&&0!==e.length?(r.objectId=e,r.objectType="PLMPIMMetricReference",r.loadMode=i,L.load({data:r})):(r.objectId=t,r.objectType=n,r.objectParentType="SIMItfSimulation",r.loadMode=i,L.load({data:r}))}}else{r.objectId=t,r.objectType=n,r.objectParentType=p,l&&l.id&&(r.subContext=l);let o={data:r};"FailureModesEffectsAnalysis"===p&&(o.data.cbFmeaLoaderLoaded=e.cbFmeaLoaderLoaded),L.load(o)}}else u()},onLoadingFailed:function(){a("KO")}}):a("KO")}else a("KO")}))},b=function(d){var v,b,w,M;new Promise((e=>{if(d&&d.children){L||(L=g.getLoadingContextController({context:E}));let t=0;d.children.forEach((n=>{if(n&&"DMUValidationContext"===n.type)if("r2vsurvey"===n.serviceID){const t=()=>{return n.contextURI?(e=n,new Promise(((t,n)=>{C.sendWebServiceCall({url:"resources/r2v/modeler/v2/i3dx/fetch",serviceId:"r2vsurvey",doNotSetSecurityContextInUrl:!0,config:{verb:"POST",data:{data:[{"ds6w:i3dx":e.contextURI}]}},onSuccess:function(e){var n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})}))).then((e=>e.data)):q({objectId:n.contextIds[0],serviceId:n.serviceID}).then((e=>e.result));var e};t().then((t=>{M=t[0]["ds6w:label"],n.contexts=[{id:t[0].resourceid,name:t[0]["ds6w:label"],type:t[0]["ds6w:type"],loadedR2VInfo:[{id:t[0].resourceid,info:t}]}],v=n.contexts,w=n.serviceID,d.children.forEach((e=>{e&&"DMUValidationValidated"===e.type&&(sessionStorage.getItem(e.id)||sessionStorage.setItem(e.id,"true"),"true"===sessionStorage.getItem(e.id)&&(e.validatedObjects=[{PathElements:[n.contextIds[0]],referenceName:M,instanceName:M}]))})),e()}))}else{if(v=n.contexts,n.contexts&&2===n.contexts.length){let e=n.contexts.findIndex((e=>!("Specification Report"===e.type)));n.contexts[e].subContext=!0}e()}else t++,t===d.children.length&&e()}))}})).then((async()=>{let g,C;if(E.getApplicativeData().getLoadedItfData&&E.getApplicativeData().getLoadedItfData().data.length?g=E.getApplicativeData().getLoadedItfData().data[0].isrID:E.getRootBagPath().getChildrenPathes().length>0&&(g=p.getNodeID(E.getRootBagPath().getChildrenPathes()[0].getLastElement(!0))),v)if(1===v.length)t=v[0].id,n=v[0].type,i=v[0].name;else if(2===v.length){let e=v.find((e=>"Specification Report"===e.type));e?(t=e.id,n=e.type,i=e.name):s=!0}if(E.getController().isFiltered(g).filterId&&(C=E.getController().isFiltered(g).filterId),g&&g!==t&&C!==t)X("error",x.valDragAndDropError),e.cbFailed();else{g&&u&&(f.removeReviewContext({context:E}),D&&D.fireEvent("onDMURemoveSessionReview")),(h=await o.createReviewContext({context:E,typeObject:"Review"})).setReadOnly(e.readOnly);var R=new a({viewer:E,DMUExperience:h}),F=null;P||U||(P=D.addEvent("onGetMarkupJsonEvt",ee),U=D.addEvent("onImportModelEvt",te));var k=async function(){var a=(F=R.importValidationFromJSON(d,e.editionMode)).getContext()&&F.getContext().getMainContextID()?F.getContext().getMainContextID():void 0;F.getContext()&&F.getContext().getSubContextID()&&(l={id:F.getContext().getSubContextID(),label:F.getContext().getSubContextName(),type:F.getContext().getSubContextType()});(await o.createReviewContext({context:E})).setReviewCtxInformation({reviewId:F.getPlmID(),highlightId:e.type&&"DMUValidationExposedPresentation"===e.type?e.reviewId:void 0,reviewName:e.displayName?e.displayName:F.getName(),reviewType:e.type?e.type:F.getType(),contextId:a,modifiable:!(e.readOnly?e.readOnly:F.isReadOnly()),owner:F.getOwner()}),m.setSlidePreferences({context:E.getFrameWindow(),preferences:{panelTitle:d.name}});var s=null,u=null,h=function(){e.cbRootAdded(),E.unsubscribe(s)};s=E.subscribe({event:"onRootAdded"},h);let S=f.giveEventsController({viewer:E.getViewer()});u=S.addEvent("onFMEALoadSuccess",(function(){e.cbRootAdded(),S.removeEvent(u)}));let y=!1;if(t&&g!==t&&"refreshMode"!==e.loadMode){var C=F.getContext().getJsonContextIDs();if(-1===c.indexOf(r))if("R2V_Activity"===r){var b=E.subscribe({event:"onR2VLoaded"},(function(){setTimeout((()=>{E.getSoIUsability()&&E.toggleSOITimelinesUsability(!1),E.unsubscribe(b),b=null}))}));E.addR2Vs({objects:[{displayName:M,objectId:a,objectType:"R2V_Activity",path:[{resourceid:a,type:"R2V_Activity"}],serviceId:w}],reframe:!1,displayNotif:!0,dispatch:!0})}else E.addRoots({objects:[{path:C}]})}else y=!0;var P=[],U=[],k=function(e,t){e.getReplies().forEach((function(e){t.push(e),k(e,t)}))};F.getMarkups().forEach((function(e){k(e,U),e.hasStream()&&P.push(I(e))})),U.forEach((function(e){e.hasStream()&&P.push(I(e))}));var T=function(t){var n=F.getLoadedRepRefs();if(n.length>0){if(F.setCurrentMarkup(n[0]),F.refreshNode(),E.getViewer().render(),t?X("warning",x.loadValSomeMkup):X("success",x.loadValSuccess),!v){let e=f.getReviewContext({context:E}).getValidation().getMarkups();D.fireEvent("reviewNoContextModeOn",{markups:e});let t=E.subscribe({event:"onRootAdded"},(function(e){let n=p.getNodeType(e.path.getLastElement(!0));D.fireEvent("reviewNoContextModeOff",{rootType:n}),E.unsubscribe(t)}))}D.fireEvent("OnReviewMarkupLoaded",{commentId:e.commentId?e.commentId:null}),y&&h(),e.cbOK()}else e.cbFailed()};if(P.length>0)Promise.all(P).then((function(){T()}),(function(){T(!0)}));else{if(y&&h(),!v){let e=f.getReviewContext({context:E}).getValidation().getMarkups();D.fireEvent("reviewNoContextModeOn",{markups:e});let t=E.subscribe({event:"onRootAdded"},(function(e){let n=p.getNodeType(e.path.getLastElement(!0));D.fireEvent("reviewNoContextModeOff",{rootType:n}),E.unsubscribe(t)}))}let o={};o.objectId=t,o.objectType=n,o.displayName=i,o.objectParentType=r||n;let a={data:o};"FailureModesEffectsAnalysis"===o.objectParentType&&(a.data.cbFmeaLoaderLoaded=e.cbFmeaLoaderLoaded),L.load(a),X("warning",x.loadValNoMarkup),e.cbOK()}};n&&"ENOStrRefinementSpecification"===n&&y.isAuthoring()?(X("warning",x.loadDbModeFilterRvw),e.cbFailed()):n&&t&&!s?$(n,(function(t){const o=["VPMReference","Document","Requirement","Requirement Specification","Drawing","SIMItfSimulation","Specification Report","FailureModesEffectsAnalysis","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_Activity","DELLmiWorkPlanSystemReference","DELLmiPPRHeaderProcessReferenceAbstract"];let i=!1;if(t)for(b=0;b<t.length;b++){if(o.includes(t[b])&&(i=!0,r=t[b],S.setParentType(n,r)),"PPRContext"===t[b]){i=!1;break}if("Requirement"===t[b]||"Drawing"===t[b]||"DIFSheet"===t[b]||"DIFLayout"===t[b]){if(i=!0,d.children)for(let e=0;e<d.children.length;e++)if("Markup"===d.children[e].type&&d.children[e].children){for(let t=0;t<d.children[e].children.length;t++)if("false"===d.children[e].children[t].webMarkup){i=!1;break}if(!1===i)break}if(!1===i)break}"DELLmiWorkPlanSystemReference"!==t[b]&&"DELLmiPPRHeaderProcessReferenceAbstract"!==t[b]||"X3DPLAW_AP"===E.getWidget().data.appId&&(i=!1)}if(i)k();else if(t&&-1!==t.indexOf("ENOStrRefinementSpecification")){if(d&&d.children)for(b=0;b<d.children.length;b++)if(d.children[b]&&"DMUValidationContext"===d.children[b].type){v=d.children[b].contexts;break}E.getController().getPrdIdFromFilterId([v[0].id]).then((function(){"refreshMode"!==e.loadMode&&E.addFilter([{objectId:v[0].id}]),function(e){var t=e.valImporter.importValidationFromJSON(e.jsonNode,e.editionMode);m.setSlidePreferences({context:E.getFrameWindow(),preferences:{panelTitle:e.jsonNode.name}});var n=[],o=[],i=function(e,t){e.getReplies().forEach((function(e){t.push(e),i(e,t)}))};t.getMarkups().forEach((function(t){i(t,o),n.push(e.loadMarkup(t))})),o.forEach((function(t){n.push(e.loadMarkup(t))}));var r=function(n){var o=t.getLoadedRepRefs();o.length>0?(t.setCurrentMarkup(o[0]),t.refreshNode(),E.getViewer().render(),n?X("warning",x.loadValSomeMkup):X("success",x.loadValSuccess),e.cbOK(),f.giveEventsController({viewer:E.getViewer()}).fireEvent("OnReviewMarkupLoaded")):e.cbFailed()};n.length>0?Promise.all(n).then((function(){r()}),(function(){r(!0)})):X("warning",x.loadValNoMarkup)}({jsonNode:d,editionMode:e.editionMode,valImporter:R,loadMarkup:I,cbOK:e.cbOK})}))}else e.cbFailed(),X("error",x.loadValContextError)})):g||v?(X("error",x.valMultiContextDragAndDropError),e.cbFailed()):k()}}))},w=function(){X("error",x.loadValError),e.cbFailed()};"DMUValidationValidation"===e.type&&W.getAllElementsByValidationId({validationId:e.reviewId,onSuccess:b,onFailure:w}),"DMUValidationExposedPresentation"===e.type&&W.getValidationFromHighlightId({highlightId:e.reviewId,onSuccess:function(t){t&&u&&u.getPlmID()===t.id?e.cbOK({sameReview:!0}):b(t)},onFailure:w})}else X("error",x.valDragAndDropError)}},this.clearController=function(){if(w&&w.destroy(),P&&U){var e=f.giveEventsController({viewer:E.getViewer()});e.removeEvent(P),e.removeEvent(U),P=U=null}E=w=A=V=M=null}}}),w=[];return e.singleton({init:function(){},giveLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<w.length;t++)if(w[t].context===e.context)return w[t].controller},getLoadMarkupServices:function(e){var t;if(e&&e.context&&!(t=this.giveLoadMarkupServices(e))){var n=new b({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},loadValidation:function(e,t,o){if(n)return n.loadValidation(e,t,o)},loadIfContextLoaded:function(e){if(n)return n.loadIfContextLoaded(e)},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},getMarkupContextType:function(){if(n)return n.getMarkupContextType()},clearController:function(){n&&(n.clearController(),n=null)},getDocumentVersionInfos:function(){if(n)return n.getMarkupContextType()}}),w.push({context:e.context,controller:t})}return t},unreferenceLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<w.length;t++)if(w[t].context===e.context){w[t].controller.clearController(),w.splice(t,1);break}}})}));