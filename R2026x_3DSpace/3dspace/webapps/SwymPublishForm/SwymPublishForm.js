define("DS/SwymPublishForm/script/super-modal",["UWA/Core","DS/UIKIT/SuperModal"],(function(e,t){"use strict";var o=t.extend({init:function(){return arguments.hasOwnProperty("0")&&(window.ds&&"3DD"!==ds.env?arguments[0].renderTo=window.document&&window.document.body:arguments[0].renderTo=window.widget&&window.widget.body),this._parent.apply(this,arguments)}});return o})),define("DS/SwymPublishForm/script/user-picture-view",["UWA/Core","DS/SwymUICore/script/lib/view/generic/img-view","DS/SwymUICore/script/feature/core/user/model/user-model","DS/SwymUICore/script/feature/core/sprite/sprite","DS/SwymUICore/script/utils/utils","DS/WebappsUtils/Console"],(function(e,t,o,i,n,r){var s=t.extend({_modelEventsForAutoRefresh:["onChange:user_picture_fingerprint"],_imageRenderingOptions:null,_modelClass:o,name:"user-picture-view",defaultOptions:{displayPresence:!0},_createContent:function(){var t=i.renderUserPicture(e.merge({login:this.model.get("login"),hash_key:this.model.get("hash_key"),imageUpdateTime:this.model.get("picture_update"),imageFingerprint:this.model.get("user_picture_fingerprint")},this._imageRenderingOptions||{}));return t instanceof HTMLElement&&(this.elements.image=t),t},init:function(){return this._refresh=n.getDelayedSyncTask(t.prototype._refresh),this._parent.apply(this,arguments)},setup:function(t){var i=null;return t&&(i=t.hash_key?e.merge({model:new o({hash_key:t.hash_key,login:t.hash_key,nickname:t.nickname?t.nickname:null})},t):t),this._parent.call(this,i)},destroy:function(){try{this._userPresenceView&&("function"==typeof this._userPresenceView.destroy&&this._userPresenceView.destroy(),this._userPresenceView=null)}catch(e){}return this._parent.apply(this,arguments)}});return s})),define("DS/SwymPublishForm/script/autocomplete-trigger-override",[],(()=>({addClickOnInput(e){if(window.widget)return;const t=e?.elements?.inputContainer;t?.addEvent("click",(()=>{e.onFocus()}))}}))),define("DS/SwymPublishForm/script/creation-statistics-persistence",["UWA/Core","UWA/Class/Events","DS/SwymUICore/script/lib/model/model-manager","DS/SwymUICore/script/feature/core/config/bootstrap-model","DS/SwymUICore/script/feature/core/context/context-model","DS/SwymUICore/script/feature/community/community/model/community-model","DS/SwymUICore/script/utils/localstorage-manager"],(function(e,t,o,i,n,r,s){"use strict";var a=null,l=n.getInstance(),c="creation",m="visit",u={post:[],media:[],idea:[],iquestion:[],survey:[],wiki:[],wedo:[]},d=t.extend({
//! LastPostedCommunities local storage is shared between widgets with the same tenant
_localStorageData:null,_getTenantId:function(){var e,t,o=window.widget;if(o&&o.getPreference("url"))e=o.getPreference("url").id;else{if(!(t=i.getInstance())||!t.get("config"))throw new Error("No tenant found");e=t.get("config").tenant.online_instance_id}return e},_getLocalStorageKey:function(){return[this._getTenantId(),"lastPostedCommunities"].join(":")},populateModelFromLocalStorage:function(){var e=this._getLocalStorageKey(),t=s.getItem(e);this._localStorageData=t||u,this._migrateLocalStorageData()},_saveToLocalStorage:function(){var e=this._getLocalStorageKey();s.setItem(e,this._localStorageData)},_migrateLocalStorageData:function(){var e,t=!1;for(var o in this._localStorageData)for(var i=(e=this._localStorageData[o]).length-1;i>=0;i--)"string"==typeof e[i]&&(t=!0,e.splice(i,1));t&&this._saveToLocalStorage()},_removeFromLocalStorage:function(){var e=this._getLocalStorageKey();s.removeItem(e)},_onPublishing:function(e){var t=!1,o=e.getCommunity(),i=o.get("subject6wuri"),n=e.getModelName(),r=o.isDirectMessage(),s=o.get("title",{escapeHTML:!1}),a=this._localStorageData[n];a&&!r&&(a[0]&&a[0].communityId===i&&a[0].status===c||(5===a.length&&a.pop(),(a=this._removeCommunity(a,i)).unshift({communityId:i,status:c,communityTitle:s}),t=!0),!0===t&&(this._saveToLocalStorage(),this.dispatchEvent("CommunitiesUpdated",[n])))},_onCommunityChange:function(e){if(e&&e.communityId){var t=new r({mid:e.communityId});if(t.hasBeenFetched()){var o=!1,i=t.get("subject6wuri"),n=t.get("title",{escapeHTML:!1}),s=this._localStorageData,a=!1,l=!1,u=0,d=[],h=[];for(var p in s){switch(d=s[p],p){case"post":l=t.canCreatePosts();break;case"media":l=t.canCreateMedia();break;case"idea":l=t.canCreateIdeas();break;case"iquestion":l=t.canCreateQuestions();break;case"survey":l=t.canCreateSurveys();break;case"wiki":l=t.canCreateWikiPages();break;case"wedo":l=t.canCreateWedo()}if(a=!this._areCommunitiesAllWithStatusCreation(d),d=this._removeCommunity(d,i),a&&l&&this._getStatusOfCommunityInlist(d,i)!==c){if(d.length<5)d.push({communityId:i,status:m,communityTitle:n});else{for(var g=0,f=d.length;g<f;g++)if("VISITED"===d[g].status){u=g;break}d.splice(u,0,{communityId:i,status:m,communityTitle:n}),d.pop()}s[p]=d,o=!0,h.push(p)}}if(o){this._saveToLocalStorage();for(var _=0,y=h.length;_<y;_++)this.dispatchEvent("CommunitiesUpdated",[h[_]])}}else t.addEvent("onSync",function(){this._onCommunityChange(e)}.bind(this))}},_getStatusOfCommunityInlist:function(e,t){for(var o,i=null,n=0,r=e.length;n<r;n++)if((o=e[n]).communityId===t){i=o.status;break}return i},_removeCommunity:function(e,t){for(var o=e.length-1;o>=0;o--)if(e[o]&&e[o].communityId===t){e.splice(o,1);break}return e},_areCommunitiesAllWithStatusCreation:function(e){var t=!0;if(5===e.length){for(var o=0,i=e.length;o<i;o++)if(e[o].status!==c){t=!1;break}}else t=!1;return t},clear:function(){this._localStorageData=e.clone(u)},init:function(){this._parent.apply(this,arguments),this._onPublishingBound||(this._onPublishingBound=this._onPublishing.bind(this),o.addListenerOnPublishing(this._onPublishingBound)),this._onCommunityChangeBound||(this._onCommunityChangeBound=this._onCommunityChange.bind(this),!0===l.addListener("onCommunityChange",this._onCommunityChangeBound,this,!0)&&this._onCommunityChangeBound()),this.populateModelFromLocalStorage()},getLocalStorage:function(){var e=this._getLocalStorageKey();return s.getItem(e)},getRecentCommunitiesForContentType:function(t){var o=this._localStorageData[t]||[];return e.clone(o)},removeCommunitiesForContentType:function(e,t){var o=this._localStorageData[e];t.forEach(function(e){o=this._removeCommunity(o,e.communityId)}.bind(this)),this._saveToLocalStorage(),this.dispatchEvent("CommunitiesUpdated",[e])}});return{getInstance:function(){return null===a&&(a=new d),a}}})),define("DS/SwymPublishForm/script/user-template",["require","exports","UWA/Core"],(function(e,t,o){"use strict";return function(){return function(e,t,i){e.addClassName("default-template people-search-template"),o.createElement("span",{class:"item-label",html:[{tag:"img",class:"people-search-img",src:i.preview_url},{class:"item-label",html:i.label}]}).inject(e)}}})),define("DS/SwymPublishForm/script/rtc-webservice",["require","exports","DS/SwymUICore/script/utils/compass-proxy","DS/WAFData/WAFData","UWA/Class/Promise","DS/SwymUICore/script/utils/platform-utils","DS/Logger/Logger"],(function(e,t,o,i,n,r,s){"use strict";var a="access_token",l="x3ds_service_url",c={listConv:function(e){return new Promise((function(t,n){o.getServiceUrl({platformId:e.platformId,serviceName:"3DMessaging",onComplete:function(o){i.authenticatedRequest("".concat(o,"/conversation/userConversations"),{data:{tenant:e.platformId,all:!0,login:e.currentUserLogin},method:"GET",type:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},onComplete:function(e){var o=null==e?void 0:e.userConversations.map((function(e){return m(e)}));t(o)},onFailure:n})},onFailure:n})}))},search:function(e){return new Promise((function(t,c){o.getServiceUrl({platformId:e.platformId,serviceName:"3DMessaging",onComplete:function(o){var u;new n((function(e){r.getPassportURLPromise().then((function(t){u=t+"/login?service=3DSIM",i.authenticatedRequest(u,{onComplete:function(t){var o=JSON.parse(t);o&&o[a]&&o[l]?e(o[a]):s.error("Passport error, no service ticket fetched",arguments)}})}))})).then((function(n){i.authenticatedRequest("".concat(o,"/conversation/search"),{data:{tenant:e.platformId,login:e.currentUserLogin,query:e.query,ticket:n},method:"GET",type:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},onComplete:function(e){var o=null==e?void 0:e.conversations.map((function(e){return m(e)}));t(o)},onFailure:c})}))},onFailure:c})}))},getConv:function(e){return new Promise((function(t,n){o.getServiceUrl({platformId:e.platformId,serviceName:"3DMessaging",onComplete:function(o){i.authenticatedRequest("".concat(o,"/conversation/create"),{data:JSON.stringify({tenant:e.platformId,logins:e.logins}),method:"POST",type:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},onComplete:function(e){e.uri=e.conversation.subjectUri,t(e)},onFailure:n})},onFailure:n})}))}};function m(e){return{id:e.convId.toString(),is_hidden:e.isHidden,subject_uri:null==e?void 0:e.subjectUri,topic:e.title,updated_at:e.lastModificationDate,users:e.members}}return c})),define("DS/SwymPublishForm/script/community-template",["require","exports","UWA/Core","DS/SwymUICore/script/feature/community/media/model/media-model"],(function(e,t,o,i){"use strict";return function(e){var t={recent:"fonticon-navigation-history",favorite:"fonticon-favorite-off"};return function(n,r,s){var a,l;n.addClassName("default-template"),n.addClassName("community-custom-template"),s.parent?((a=o.createElement("span",{class:"item-parent-label"})).setText(s.label),s.parentReference&&(a.setStyle("margin-left",s.parentReference.level+"em"),a.addClassName("sub-item")),a.inject(n)):((a=o.createElement("span",{class:"item-label"})).setText(s.label),s.parentReference&&a.addClassName("sub-item"),(l=o.createElement("img",{class:"item-logo"})).src=i.constructThumbnailUrl("community",s.value,"m_thumb"),l.inject(n),a.inject(n),t[e]&&o.createElement("span",{class:"fonticon item-icon "+t[e]}).inject(n),console.log("ytype",e))}}})),define("DS/SwymPublishForm/script/community-selector-autocomplete",["require","exports","DS/UIKIT/Autocomplete","DS/UIKIT/Spinner","UWA/Core"],(function(e,t,o,i,n){"use strict";function r(e,t,o){var i=new IntersectionObserver(o,{root:null,threshold:.01});return i.observe(t),i}var s="other-communities",a="recent-communities",l=o.extend({_appendItem:function(e,t,o){var i;(this._parent.apply(this,arguments),i=e.suggests||e.items,"other-communities"===e.name&&i.indexOf(t)===i.length-1)&&(o.getElement(".loading-div")||n.createElement("li",{class:"autocomplete-item default-template loading-div"})).inject(o)},loadNextSuggests:function(e,t){var o=this,r=o.getDataset(s).collection,l=o.getDataset(a)&&o.getDataset(a).items;e.forEach((function(e){e.isIntersecting&&(e.target&&!e.target.getElement(".spinner")&&(new i).inject(e.target).show(),function(e,t){var o=e.getCurrentPage(),i=null===o?1:o+1;e.fetchPage(i,n.extend({serviceName:"filter",ignoreCache:!0,reset:!1,add:!0,remove:!1},t))}(r,{data:{favorite_communities:"without",select_predicate:["title","id","resourceid"]},onComplete:function(e,t,i){var n=e.parse(t,i);if(n.length>0){var r=o.getDataset(s),a=n.flatMap((function(e){return l.find((function(t){return t.value===e.mid}))?[]:[{value:e.mid,label:e.title}]}));if(a.length>0)o.addItems(a,r),r.items.slice(0-a.length).forEach((function(e){o._appendItem(r,e,o.elements.suggests)}));e.hasNext()||o.endLoading()}else o.endLoading()}}))}))},endLoading:function(){var e=this.elements.suggests.getElement(".loading-div");e&&e.remove()},onUpdateSuggests:function(){var e=this;this._parent.apply(this,arguments),setTimeout((function(){e.observerTarget=e.elements.suggests.getElement(".loading-div"),e.observerTarget&&(e.observer=r.call(e,e.elements.suggests,e.observerTarget,e.loadNextSuggests.bind(e)))}),10)},resetUrlRootCollection:function(){this.getDataset(s).collection.resetUrlRoot()},onAppendSuggests:function(){},destroy:function(){return this.observer&&this.observer.disconnect?this.observer.disconnect():this.observer&&this.observer.unobserve&&this.observerTarget&&this.observer.unobserve(this.observerTarget),this._parent.apply(this,arguments)}});return l})),define("DS/SwymPublishForm/script/direct-message-view",["UWA/Core","DS/SwymUICore/script/lib/view/generic/swym-model-view","DS/SwymUICore/script/feature/core/config/bootstrap-model","DS/SwymUICore/script/feature/core/direct-message/model/direct-message-model","DS/SwymPublishForm/script/user-picture-view","DS/SwymUICore/script/utils/utils","DS/SwymUICore/script/feature/core/context/context-model","DS/SwymUICore/script/utils/navigation","DS/SwymUICore/script/utils/usage-tracker","DS/Logger/Logger","DS/SwymPublishForm/script/super-modal","i18n!DS/SwymPublishForm/assets/nls/direct-messages"],(function(e,t,o,i,n,r,s,a,l,c,m,u){"use strict";return t.extend({name:"direct-message-view",_modelEvents:{"onChange:last_message":"_updateLastMessage","onChange:users":"refresh"},_modelEventsForAutoRefresh:["onChange:topic"],domEvents:{"click .hide-dm-icon":"_onHideDirectMessage","click .show-dm-icon":"_onRestoreDirectMessage"},defaultOptions:{displayHideDMIcon:!0,displayCallIcons:!1,displaySecondLine:!0},_modelClass:i,setup:function(e){return this._boostrapInstance=o.getInstance(),this._context=s.getInstance(),this._parent.call(this,e)},onSetModel:function(){this._resetRTAudioVideoApi()},_updateLastMessage:function(){var t=this.container.getElement(".second-line"),o=this.model.get("last_message")&&this.model.get("last_message").message_details,i="";t&&(i=this.model.getLastUnreadContentSummary()?e.createElement("div",{html:this.model.getLastUnreadContentSummary()}).getText():"",t.setContent(i.escapeHTML()),o&&o.media_type&&e.createElement("span",{class:"fonticon fonticon-"+r.getMediaIconName(o.media_type)}).inject(t,"top"))},_onRestoreDirectMessage:function(){this.model.unhide({onComplete:function(e){c.log("is unhidden now"),a.goToDM(e.get("mid"))}.bind(this),onFailure:function(){c.log("an error occured while hiding the DM")}})},_onHideDirectMessage:function(e){e.stopPropagation(),new m({closable:!0,renderTo:window.document.body||this._widget.body}).confirm({title:u.HideDMConfirmationModalTitle,message:u.HideDMConfirmationModalMsg,callback:function(e){!0===e&&this.model.hide({onComplete:function(){this.alert("success",u.ConversationHidden),l.trackPageEvent({category:"MyConversations",label:"hideAConversation",view:"direct-message-view",event:"click"})}.bind(this),onFailure:function(){c.log("an error occured while hiding the DM")}})}.bind(this)})},_filterUserCollection:function(){var e=this,t=e.model.getAssociated("users");e._userCollectionWithoutMe=t.filter((function(t){return t.get("login")!==e._boostrapInstance.get("user").login})),e._currentUserModel=t.filter((function(t){return t.get("login")===e._boostrapInstance.get("user").login}))[0],e.listenTo(t,"onCollectionChange",e._filterUserCollection)},_getUserPictureViewWithoutMe:function(e){var t=this._userCollectionWithoutMe[e];return t?new n({displayPresence:!1,model:t}):this.createDummyView()},_getCurrentUserPictureView:function(){return this._currentUserModel?new n({displayPresence:!1,model:this._currentUserModel}):this.createDummyView()},_getIconView:function(){var e;switch(this._userCollectionWithoutMe.length){case 0:e=this.addChildView("icon-view",this._getCurrentUserPictureView());break;case 1:e=this.addChildView("icon-view",this._getUserPictureViewWithoutMe(0));break;case 2:e=[{class:"tiny-pictures two-picture-view",html:[this.addChildView("first-icon-view",this._getUserPictureViewWithoutMe(0)),this.addChildView("second-icon-view",this._getUserPictureViewWithoutMe(1))]}];break;case 3:e=[{class:"tiny-pictures three-picture-view",html:[this.addChildView("first-icon-view",this._getUserPictureViewWithoutMe(0)),this.addChildView("second-icon-view",this._getUserPictureViewWithoutMe(1)),this.addChildView("third-icon-view",this._getUserPictureViewWithoutMe(2))]}];break;case 4:e=[{class:"tiny-pictures four-picture-view",html:[this.addChildView("first-icon-view",this._getUserPictureViewWithoutMe(0)),this.addChildView("second-icon-view",this._getUserPictureViewWithoutMe(1)),this.addChildView("third-icon-view",this._getUserPictureViewWithoutMe(2)),this.addChildView("fourth-icon-view",new n({displayPresence:!1,model:this._currentUserModel}))]}];break;default:e=[{class:"tiny-pictures four-picture-view",html:[this.addChildView("first-icon-view",this._getUserPictureViewWithoutMe(0)),this.addChildView("second-icon-view",this._getUserPictureViewWithoutMe(1)),this.addChildView("third-icon-view",this._getUserPictureViewWithoutMe(2)),{class:"number-of-items",html:"+"+(this._userCollectionWithoutMe.length-2)}]}]}return e},getLabel:function(){return this._filterUserCollection(),this.model.getMembersTitle(this._boostrapInstance.get("user").login)},_resetRTAudioVideoApi:function(){this._context.isDirectMessageContext()&&this.model instanceof i&&this._rtAudioVideoApi&&(this._rtAudioVideoApi.destroy(),this._rtAudioVideoApi=null)},_createContent:function(){var e;return this._filterUserCollection(),e=this.model.getMembersTitle(this._boostrapInstance.get("user").login),[{class:"icon-section",html:this._getIconView()},{class:"other-info",html:[{class:"first-line",html:[{class:"title",html:'<span class="title-span">'+(this.model.get("topic")?this.model.get("topic"):e)+'</span><span class="rt-icons"></span>'},!1===this.getOption("displayHideDMIcon")?"":this.model.get("is_hidden")?{class:"show-dm-icon",html:'<span title = "'+u.RestoreConversation+'" class="fonticon fonticon-eye"></span>'}:{class:"hide-dm-icon",html:'<span title = "'+u.HideConversation+'" class="fonticon fonticon-eye-off"></span>'}]},!1!==this.getOption("displaySecondLine")?{class:"second-line",html:""}:""]}]},onDestroy:function(){return this._rtAudioVideoApi&&this._rtAudioVideoApi.destroy(),this._parent.apply(this,arguments)}})})),define("DS/SwymPublishForm/script/conversation-template",["require","exports","UWA/Core","DS/SwymUICore/script/feature/core/direct-message/model/direct-message-model","DS/SwymPublishForm/script/direct-message-view"],(function(e,t,o,i,n){"use strict";return function(e){var t={favorite:"fonticon-favorite-off"};return function(r,s,a){r.addClassName("default-template"),r.addClassName("conversation-custom-template");var l=a.value.split(":"),c=new i({mid:l[l.length-1]},{}),m=new n({model:c,displayHideDMIcon:!1,displaySecondLine:!1});(o.createElement("span",{class:"item-label",html:m.render()}).inject(r),t[e])&&o.createElement("span",{class:"fonticon item-icon "+t[e]}).inject(r)}}})),define("DS/SwymPublishForm/script/dm-selector-view",["UWA/Core","DS/SwymUICore/script/lib/view/generic/swym-view","DS/SwymUICore/script/feature/core/config/bootstrap-model","DS/SwymUICore/script/feature/thread/collection/thread-lite-collection","DS/SwymUICore/script/feature/core/direct-message/collection/direct-message-collection","DS/SwymPublishForm/script/community-selector-autocomplete","DS/SwymPublishForm/script/conversation-template","DS/SwymPublishForm/script/user-template","DS/SwymUICore/script/feature/core/direct-message/model/direct-message-model","DS/SwymUICore/script/utils/utils","i18n!DS/SwymPublishForm/assets/nls/dm-selector-view"],((e,t,o,i,n,r,s,a,l,c,m)=>{const u=r.extend({loadNextSuggests(){}});function d(e){const t=e.getModelName();return{value:e.get("subject6wuri")||e.get("mid"),label:"dm"===t?e.getConsolidatedTitle():e.get("ds6w:label"),modelName:t,is_favorite:e.get("is_favorite"),preview_url:e.get("preview_url",{escapeHTML:!1})||null}}function h(t){const o=this;return function(i,r){return new Promise(((s,a)=>{const l=new n([],{mode:"findConversation",urlRoot:c.getBaseUrl(),limit:50});l.fetch({data:e.merge({query:`([ds6w:type]:"swym:DirectMessage" AND (${r}) AND (NOT dm_type:private)) OR ((topicConversations:(${r})) AND (dm_type:private)) OR (personOrGroup:(${r}))`,select_predicate:["ds6w:type","ds6w:label","title","id","resourceid"]},t),reset:!0,onComplete(e){console.log("result",e);const t=o.getControl("dmSelector").getDataset(g),n=l.filter((e=>{let o=null;return o="swym:DirectMessage"===e.get("ds6w:type")?e.get("topic"):e.get("ds6w:label"),0===t.items.filter((e=>e.label===o)).length})),r={dataset:i,matchingItems:n.map(d)};s(r)},onFailure(e){a(e)}})}))}}const p="other-communities";var g="favorite-communities";return t.extend({name:"dm-selector-view",_dmSelectorCollection:null,_selectedItem:null,dmSyncComplete:!1,setup(){const e=this;this._parent.apply(this,arguments);const t=void 0===this.getOption("disabled")||this.getOption("disabled");this._dmSelectorCollection=new i([],{mode:"conversation",limit:50}),this.addControl("dmSelector",new u({placeholder:m.SelectAConversation,disabled:t,noResultsMessage:m.NoMatchFound,typeDelayBeforeSearch:400,minLengthBeforeSearch:3,showSuggestsOnFocus:!0,allowFreeInput:!0,datasets:[{name:g,items:[],configuration:{templateEngine:s("favorite")}},{name:p,items:[],collection:this._dmSelectorCollection,configuration:{templateEngine:(...e)=>"dm"===e[2].modelName?s()(...e):a()(...e)},remoteSearchEngine:h.call(this)}],events:{onSelect(t){let{value:o}=t,{label:i}=t,{modelName:n}=t;if("user"===t.modelName){const r=e.checkIfConversationExist(t);0!==r.length&&(o=r[0].value,i=r[0].label,n=r[0].modelName)}e.dispatchEvent("onDMSelectChange",[o,i,n])},onUnselect(){e.onDMUnselected()}}}))},checkIfConversationExist(e){return this.getControl("dmSelector").getItems().filter((t=>t.datasetId===e.datasetId&&t.label===e.label))},validate(){const e=this.getControl("dmSelector").getValue().length>0;return!1===e?this.container.addClassName("invalid"):this.container.removeClassName("invalid"),e},createConversation(e){const t=this,i=new l,n=o.getInstance().get("user").login;i.addChanges({users:[n,e.value]}),i.save({},{onComplete:o=>{t.dispatchEvent("onDMSelectChange",[o.get("mid"),e.label,"dm"]),t.dispatchEvent("onConversationCreated")}})},populateDMCollection(e){const t=this,o=e&&e.dmId||null;return new Promise(((o,i)=>{t._dmSelectorCollection.fetch({headers:{"X-DS-SWYM-CSRFTOKEN":e?e.csrfToken:""},urlRoot:e.urlRoot,onComplete:o,onFailure:i})})).then((()=>{t.onDMListSync({showAlert:!0,isCollectionSynced:!0,dmSelected:o})}))},onDMListSync(e){const t=[],o=[],i=this.getControl("dmSelector"),{dmSelected:n}=e;this._dmSelectorCollection.forEach((e=>{const i=e.get("is_favorite"),r=d(e);n&&r.value===n&&(r.selected=!0),i?t.push(r):o.push(r)})),o.length>0||t.length>0?(i&&(i.cleanDataset(p),i.cleanDataset(g),t.length>0&&i.addItems(t,i.getDataset(g)),o.length>0&&i.addItems(o,i.getDataset(p)),i.enable()),this.container&&this.container.removeClassName("ask-author-rights"),!0===e.isCollectionSynced&&(this.dmSyncComplete=!0,this.dispatchEvent("onDMSyncComplete"))):(this.container.addClassName("ask-author-rights"),this.dispatchEvent("disablePublishRequest"))},isDMSyncComplete(){return this.dmSyncComplete},selectDM(e){let t;const o=this.getControl("dmSelector");if(e)return t=o.getItem(e),!(!t||!t.id)&&(o.onSelect(t),!0)},reset(){const e=this.getControl("dmSelector");e.reset(),e.datasets.forEach((e=>{e.items&&e.items.length>0&&(e.items.length=0)}))},onDMUnselected(){this.dispatchEvent("onDMSelectChange",[])},enable(){const e=this.getControl("dmSelector");e&&e.enable()},disable(){const e=this.getControl("dmSelector");e&&e.disable()},isDisabled(){return this.getControl("dmSelector").isDisabled()},getDMSelected(){const e=this.getControl("dmSelector");return e?e.selectedItems[0]:null},_createContent(){return this.getControl("dmSelector")},isEmpty(){const e=this.getControl("dmSelector").getItems();return!(e&&e.length>0)},onDestroy(){const e=this.getControl("dmSelector");e&&e.destroy()}})})),define("DS/SwymPublishForm/script/community-selector-view",["UWA/Core","DS/SwymUICore/script/lib/view/generic/swym-view","DS/SwymUICore/script/feature/community/community/collection/community-collection","DS/SwymPublishForm/script/creation-statistics-persistence","DS/SwymPublishForm/script/community-template","DS/SwymPublishForm/script/community-selector-autocomplete","DS/WebappsUtils/Console","DS/SwymUICore/script/utils/utils","DS/SwymPublishForm/script/autocomplete-trigger-override","i18n!DS/SwymPublishForm/assets/nls/community-selector-view"],((e,t,o,i,n,r,s,a,l,c)=>{function m(e){return{value:`${e.get("subject6wuri")}`,label:e.get("title",{escapeHTML:!1})}}function u(t){const i=this;return function(n,r){return new Promise(((s,l)=>{const c=new o([],{mode:"findCommunity",urlRoot:a.getBaseUrl(),limit:50});c.setModel(g[i.getOption("modelParam")]),c.fetch({data:e.merge({query:r,select_predicate:["title","id","resourceid"]},t),reset:!0,onComplete(){const e=i.getControl("communitySelector").getDataset(p),t=c.filter((t=>{const o=t.get("subject6wuri");return 0===e.items.filter((e=>e.value===o)).length})),o={dataset:n,matchingItems:t.map(m)};s(o)},onFailure(e){l(e)}})}))}}const d="other-communities",h="favorite-communities";var p="recent-communities",g={post:"post",media:"media",idea:"ideation",wiki:"wikitree",wikitree:"wikitree",survey:"survey",iquestion:"iquestion","social-event":"conference",wedo:"wedo"};return t.extend({name:"community-selector-view",communityCollections:null,_contentCreationPersistence:null,communitySyncComplete:!1,_url:null,isCommunitySyncComplete(){return this.communitySyncComplete},validate(){const e=this.getControl("communitySelector").getValue().length>0;return!1===e?this.container.addClassName("invalid"):this.container.removeClassName("invalid"),e},selectCommunity(e){let t;const o=this.getControl("communitySelector");if(e)return t=o.getItem(e),t&&t.id?(o.onSelect(t),!0):(s.log("could not select community",t,t.id,e),!1)},reset(){const e=this.getControl("communitySelector");e.reset(),e.datasets.forEach((e=>{e.items.length>0&&(e.items=[])}))},resetUrlRoot(){this.getControl("communitySelector").resetUrlRootCollection()},unselectCommunity(){this.getControl("communitySelector").datasets.forEach((e=>{e.items.length>0&&(e.items.length=[])})),this.onCommunityUnselected()},onCommunityUnselected(){this.dispatchEvent("onCommunitySelectChange",[])},populateCommunityCollection(t){let o,i;const n=this.getControl("communitySelector"),r=n.getDataset(d),s=n.getDataset(h),a=!t||!e.is(t.fetchCommunityCollection)||t.fetchCommunityCollection,l=this,c=t&&t.communityId||null;o=r.collection,i=s.collection,o.setModel(g[this.getOption("modelParam")]),i.setModel(g[this.getOption("modelParam")]);if((this._contentCreationPersistence.getRecentCommunitiesForContentType(this.options?this.getOption("modelParam"):"")||[]).length>0&&l.onCommunityListSync([],[],{showAlert:!1,displayOnlyRecentCommunities:!0,isCollectionSynced:!1,communitySelected:c}),a){this.communitySyncComplete=!1;const e=new Promise((e=>{o.fetchPage(1,{headers:{"X-DS-SWYM-CSRFTOKEN":t?t.csrfToken:""},urlRoot:t.urlRoot,serviceName:"filter",ignoreCache:!0,reset:!0,data:{favorite_communities:"without",select_predicate:["title","id","resourceid"],..."instant-message"!==l.getOption("modelParam")&&{creation_granted_for:[g[l.getOption("modelParam")]]}},onComplete(){e()}})})),n=new Promise((e=>{i.fetch({headers:{"X-DS-SWYM-CSRFTOKEN":t?t.csrfToken:""},urlRoot:t.urlRoot,reset:!0,data:{favorite_communities:"only",select_predicate:["title","id","resourceid"]},onComplete(){e()}})}));Promise.all([e,n]).then((()=>{l.onCommunityListSync(o,i,{showAlert:!0,communitySelected:c,isCollectionSynced:!0})}))}else l.onCommunityListSync(o,i,{showAlert:!0,isCollectionSynced:!1,communitySelected:c})},setModelParam(e,t){this.setOption("modelParam",e),this.populateCommunityCollection(t)},checkLocalStorage(){this._contentCreationPersistence.getLocalStorage()?this._contentCreationPersistence.populateModelFromLocalStorage():this._contentCreationPersistence.clear()},setup(){const e=this;this._parent.apply(this,arguments),this._contentCreationPersistence=i.getInstance(),this._url=a.getBaseUrl();const t=void 0===this.getOption("disabled")||this.getOption("disabled");this.listenTo(this._contentCreationPersistence,"CommunitiesUpdated",(e=>{this.getOption("modelParam")===e&&this.populateCommunityCollection({fetchCommunityCollection:!1})})),this.addControl("communitySelector",new r({placeholder:c.SelectACommunity,disabled:t,noResultsMessage:c.NoMatchFound,typeDelayBeforeSearch:400,minLengthBeforeSearch:3,showSuggestsOnFocus:!0,allowFreeInput:!0,datasets:[{name:p,items:[],configuration:{templateEngine:n("recent")}},{name:h,items:[],collection:new o([],{mode:"findCommunity",limit:100,urlRoot:a.getBaseUrl(),modelParam:g[this.getOption("modelParam")]}),configuration:{templateEngine:n("favorite")},remoteSearchEngine:u.call(this,{favorite_communities:"only"})},{name:d,items:[],collection:new o([],{mode:"findCommunity",limit:50,urlRoot:a.getBaseUrl(),modelParam:g[this.getOption("modelParam")]}),configuration:{templateEngine:n()},remoteSearchEngine:u.call(this,{favorite_communities:"without"})}],events:{onSelect(t){e.dispatchEvent("onCommunitySelectChange",[t.value,t.label]),!0!==t.disabled&&e.dispatchEvent("enablePublishRequest"),require(["DS/SwymUICore/script/lib/event-manager"],(e=>{e.dispatchEvent("onCommunitySelected",[t.value,t.label],!0)}))},onUnselect(){s.log("onUnselect"),e.onCommunityUnselected()}}})),l.addClickOnInput(this.getControl("communitySelector"))},onCommunityListSync(e,t,o){const i=[],n=[],r=[],{communitySelected:s}=o,a=this.getControl("communitySelector"),l=this._contentCreationPersistence.getRecentCommunitiesForContentType(this.options?this.getOption("modelParam"):"")||[];e.forEach((e=>{const t=e.get("subject6wuri"),o=m(e);let n=[];n=l.filter((e=>e.communityId===t)),0===n.length&&(s&&o.value===s&&(o.selected=!0),i.push(o))})),t.forEach((e=>{const t=e.get("subject6wuri"),o=m(e);let i=[];i=l.filter((e=>e.communityId===t)),0===i.length&&(s&&o.value===s&&(o.selected=!0),n.push(o))})),l.length>0&&l.forEach((e=>{const t={value:`${e.communityId}`,label:e.communityTitle};s&&t.value===s&&(t.selected=!0),r.push(t)})),i.length>0||n.length>0||r.length>0?(a&&(a.cleanDataset(d),a.cleanDataset(h),a.cleanDataset(p),r.length>0&&a.addItems(r,a.getDataset(p)),n.length>0&&a.addItems(n,a.getDataset(h)),i.length>0&&a.addItems(i,a.getDataset(d)),a.enable()),this.container&&this.container.removeClassName("ask-author-rights"),!0===o.isCollectionSynced&&(this.communitySyncComplete=!0,this.dispatchEvent("onCommunitySyncComplete"))):(this.container.addClassName("ask-author-rights"),this.dispatchEvent("disablePublishRequest"))},enable(){const e=this.getControl("communitySelector");e&&e.enable()},disable(){const e=this.getControl("communitySelector");e&&e.disable()},isDisabled(){return this.getControl("communitySelector").isDisabled()},getSelectedCommunity(){const e=this.getControl("communitySelector");return e?e.getValue():null},getSelectedCommunityTitle(){const e=this.getControl("communitySelector");return e?e.getItem(e.getValue()).label:null},_createContent(){return this.getControl("communitySelector")},isEmpty(){const e=this.getControl("communitySelector").getItems();return!(e&&e.length>0)},onDestroy(){const e=this.getControl("communitySelector");e&&e.destroy()}})}));var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,o=1,i=arguments.length;o<i;o++)for(var n in t=arguments[o])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}l((i=i.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var o,i,n,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(l){return function(a){if(o)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(o=1,i&&(n=2&a[0]?i.return:a[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,a[1])).done)return n;switch(i=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(n=r.trys,(n=n.length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){r.label=a[1];break}if(6===a[0]&&r.label<n[1]){r.label=n[1],n=a;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(a);break}n[2]&&r.ops.pop(),r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e],i=0}finally{o=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},__spreadArray=this&&this.__spreadArray||function(e,t,o){if(o||2===arguments.length)for(var i,n=0,r=t.length;n<r;n++)!i&&n in t||(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))};define("DS/SwymPublishForm/script/dm-with-rt-selector-view",["require","exports","DS/SwymUICore/script/lib/view/generic/swym-view","i18n!DS/SwymPublishForm/assets/nls/dm-selector-view","UWA/Core","DS/UIKIT/Autocomplete","DS/SwymUICore/script/utils/utils","DS/SwymPublishForm/script/conversation-template","DS/SwymPublishForm/script/user-template","DS/SwymUICore/script/feature/core/config/bootstrap-model","DS/SwymUICore/script/feature/core/direct-message/model/direct-message-model","DS/SwymUICore/script/feature/core/direct-message/collection/direct-message-collection","DS/SwymPublishForm/script/rtc-webservice","DS/SwymPublishForm/script/autocomplete-trigger-override"],(function(e,t,o,i,n,r,s,a,l,c,m,u,d,h){"use strict";var p="other-communities",g="favorite-communities",f=function(e){var t;if(e.updated_at)return new Date(e.updated_at).getTime();if("string"==typeof(null===(t=e.last_message)||void 0===t?void 0:t.message_id)){var o=e.last_message.message_id.split("-");return 10*parseInt(o[0]+o[1],16)}return 0},_=function(e,t){var o,i=null!=t?t:new m(__assign(__assign({},e),{subject6wuri:e.subject_uri}),{}),n=i.getModelName();return{value:i.get("subject6wuri")||i.get("mid"),label:"dm"===n?i.getConsolidatedTitle():i.get("ds6w:label"),modelName:n,is_favorite:i.get("is_favorite"),preview_url:i.get("preview_url",{escapeHTML:!1})||null,login:"user"===n?i.get("login"):null,nbUsers:(null===(o=i.get("users"))||void 0===o?void 0:o.length)||2,selected:!1}},y=function(e,t){var o=f(e),i=f(t);return o<i?1:o===i?0:-1},C=o.extend({name:"dm-with-rt-selector-view",RTConvAPI:d,_RTConvAPIPromise:null,_convCache:new Map,findConversation:function(e){var t=this;return function(o,i){return __awaiter(t,void 0,void 0,(function(){var t,n,r,s,a,l,m,u,d,h,p=this;return __generator(this,(function(f){switch(f.label){case 0:return f.trys.push([0,2,,3]),t=c.getInstance().get("config").tenant.online_instance_id.toUpperCase(),n=this.getControl("dmSelector").getDataset(g),[4,Promise.all([this._getConversationsFromRTC({platformId:t,query:i}),this._getConversationsFromSwym({text:i,options:e})])];case 1:return r=f.sent(),s=r[0],a=r[1],l=s.map((function(e){return _(e)})),m=a.map((function(e){return _(void 0,e)})),u=new Map,l.forEach((function(e){return u.set(e.label,e)})),m=m.filter((function(e){return"user"!==e.modelName||!u.has(e.label)||u.get(e.label).value===e.value})),(d=__spreadArray(__spreadArray([],l,!0),m,!0).filter((function(e){return!(n.items.findIndex((function(t){return t.value===e.value}))>=0)}))).sort((function(e,t){if("user"===e.modelName&&"user"===t.modelName)return 0;if("user"===e.modelName)return-1;if("user"===t.modelName)return 1;if(e.nbUsers<3&&t.nbUsers>=3)return-1;if(t.nbUsers<3&&e.nbUsers>=3)return 1;var o=p._convCache.get(e.value)||{},i=p._convCache.get(t.value)||{};return y(o,i)})),[2,{dataset:o,matchingItems:d}];case 2:return h=f.sent(),console.error("Error while searching conversations in RTConvAPI",h),[2,{dataset:o,matchingItems:[]}];case 3:return[2]}}))}))}},_getConversationsFromRTC:function(e){return __awaiter(this,arguments,void 0,(function(e){var t,o,i,n,r=e.platformId,s=e.query;return __generator(this,(function(e){switch(e.label){case 0:t=c.getInstance(),o=t.get("user").login,i=[],e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.RTConvAPI.search({platformId:r,currentUserLogin:o,query:s})];case 2:return i=e.sent(),[3,4];case 3:return n=e.sent(),console.error("Error while searching conversations in RTConvAPI",n),[3,4];case 4:return[2,i]}}))}))},_getConversationsFromSwym:function(e){var t=e.text,o=e.options;return new Promise((function(e,i){var r=new u([],{mode:"findConversation",urlRoot:s.getBaseUrl(),limit:50});r.fetch({data:n.merge({query:'([ds6w:type]:"swym:DirectMessage" AND ('.concat(t,") AND (NOT dm_type:private)) OR ((topicConversations:(").concat(t,")) AND (dm_type:private)) OR (personOrGroup:(").concat(t,"))"),select_predicate:["ds6w:type","ds6w:label","topic","id","resourceid","ds6w:resourceUid","login"]},o),reset:!0,onComplete:function(){e(r.toArray())},onFailure:function(t){console.error("Error in exalead while searching conversations",t),e([])},onTimeout:function(){console.error("Timeout in exalead while searching conversations"),e([])}})}))},setup:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var o=this;this._parent.apply(this,e);var n=void 0===this.getOption("disabled")||this.getOption("disabled"),s=new r({placeholder:i.get("SelectAConversation"),disabled:n,noResultsMessage:i.get("NoMatchFound"),typeDelayBeforeSearch:400,minLengthBeforeSearch:3,showSuggestsOnFocus:!0,allowFreeInput:!0,events:{onSelect:function(e){var t=e.value,i=e.label,n=e.modelName;if("user"===e.modelName){var r=o.checkIfConversationExist(e);0!==r.length&&(t=r[0].value,i=r[0].label,n=r[0].modelName)}o.dispatchEvent("onDMSelectChange",[t,i,n])},onUnselect:function(){o.onDMUnselected()}}});h.addClickOnInput(s),s.addDataset({name:g,items:[],configuration:{templateEngine:a("favorite")}}),s.addDataset({name:p,items:[],configuration:{templateEngine:function(e,t,o){return"dm"===o.modelName?a()(e,t,o):l()(e,t,o)},remoteSearchEngine:o.findConversation()}}),this.addControl("dmSelector",s)},checkIfConversationExist:function(e){return this.getControl("dmSelector").getItems().filter((function(t){return t.datasetId===e.datasetId&&t.label===e.label}))},validate:function(){var e=this.getControl("dmSelector").getValue().length>0;return!1===e?this.container.addClassName("invalid"):this.container.removeClassName("invalid"),e},createConversation:function(e){return __awaiter(this,void 0,void 0,(function(){var t,o,i,n,r,s;return __generator(this,(function(a){switch(a.label){case 0:t=c.getInstance(),o=t.get("user").login,a.label=1;case 1:return a.trys.push([1,3,,4]),i=t.get("config").tenant.online_instance_id.toUpperCase(),n=[o,e.login],[4,this.RTConvAPI.getConv({logins:n,platformId:i})];case 2:return r=a.sent(),this.dispatchEvent("onDMSelectChange",[r.uri,e.label,"dm"]),this.dispatchEvent("onConversationCreated"),[3,4];case 3:return s=a.sent(),console.error("Error while creating conversation from RTConvAPI",s),[3,4];case 4:return[2]}}))}))},populateDMCollection:function(e){return __awaiter(this,void 0,void 0,(function(){var t,o,i,n,r,s,a,l=this;return __generator(this,(function(m){switch(m.label){case 0:t=this,o=e&&e.dmId||null,i=c.getInstance().get("config").tenant.online_instance_id.toUpperCase(),n=c.getInstance(),r=n.get("user").login,m.label=1;case 1:return m.trys.push([1,3,,4]),[4,this.RTConvAPI.listConv({platformId:i,currentUserLogin:r})];case 2:return(s=m.sent()).forEach((function(e){l._convCache.set(e.subject_uri,e)})),s.sort(y),[2,t.onDMListSync({showAlert:!0,isCollectionSynced:!0,dmSelected:o,conversations:s})];case 3:return a=m.sent(),console.error("Error while getting all conversations from RTConvAPI",a),[2,t.onDMListSync({showAlert:!0,isCollectionSynced:!0,dmSelected:o,conversations:[]})];case 4:return[2]}}))}))},onDMListSync:function(e){e.showAlert;var t=e.isCollectionSynced,o=e.dmSelected,i=e.conversations,n=[],r=[],s=this.getControl("dmSelector");i.forEach((function(e){var t=new m(__assign(__assign({},e),{subject6wuri:e.subject_uri}),{}),i=_(void 0,t),s=t.get("is_favorite");o&&i.value===o&&(i.selected=!0),s?n.push(i):r.push(i)})),r.length>0||n.length>0?(s&&(s.cleanDataset(p),s.cleanDataset(g),n.length>0&&s.addItems(n,s.getDataset(g)),r.length>0&&s.addItems(r,s.getDataset(p)),s.enable()),this.container&&this.container.removeClassName("ask-author-rights"),!0===t&&(this.dmSyncComplete=!0,this.dispatchEvent("onDMSyncComplete"))):(this.container.addClassName("ask-author-rights"),this.dispatchEvent("disablePublishRequest"))},isDMSyncComplete:function(){return this.dmSyncComplete},selectDM:function(e){var t=this.getControl("dmSelector");if(e){var o=t.getItem(e);return!(!o||!o.id)&&(t.onSelect(o),!0)}},reset:function(){var e=this.getControl("dmSelector");e.reset(),e.datasets.forEach((function(e){e.items&&e.items.length>0&&(e.items.length=0)}))},_createContent:function(){return this.getControl("dmSelector")},onDMUnselected:function(){this.dispatchEvent("onDMSelectChange",[])},enable:function(){var e=this.getControl("dmSelector");e&&e.enable()},disable:function(){var e=this.getControl("dmSelector");e&&e.disable()},isDisabled:function(){return this.getControl("dmSelector").isDisabled()},getDMSelected:function(){var e=this.getControl("dmSelector");return e?e.selectedItems[0]:null},isEmpty:function(){var e=this.getControl("dmSelector").getItems();return!(e&&e.length>0)},onDestroy:function(){var e=this.getControl("dmSelector");e&&e.destroy()}});return C})),define("DS/SwymPublishForm/script/dm-selector-util",["DS/SwymPublishForm/script/dm-selector-view","DS/SwymPublishForm/script/dm-with-rt-selector-view"],((e,t)=>({_hasRTConv:null,getRTConv(){return this._hasRTConv},setRTConv(e){return this._hasRTConv=e},checkRTConvAPI(){return new Promise((e=>{window.require(["DS/RTConvAPI/RTConvAPI"],(()=>{console.log("RTConvAPI present"),this.setRTConv(!0),e(!0)}),(()=>{console.log("RTConvAPI not present"),this.setRTConv(!1),e(!1)}))}))},async getDMSelector(){return null===this.getRTConv()&&await this.checkRTConvAPI(),this.getRTConv()?t:e}}))),define("DS/SwymPublishForm/script/publish-form-view",["UWA/Core","UWA/Utils/Client","UWA/String","DS/SwymUICore/script/feature/core/config/bootstrap-model","DS/SwymUICore/script/lib/view/generic/swym-view","DS/SwymUICore/script/utils/navigation","DS/UIKIT/Input/Button","DS/UIKIT/Input/ButtonGroup","DS/UIKIT/Input/Select","DS/UIKIT/Input/Toggle","DS/UIKIT/Tooltip","DS/UIKIT/Input/Text","DS/UIKIT/Alert","DS/SwymUICore/script/feature/core/direct-message/model/direct-message-model","DS/SwymUICore/script/feature/community/community/model/community-model","DS/SwymUICore/script/utils/compass-proxy","i18n!DS/SwymPublishForm/assets/nls/publish-form-view","DS/WAFData/WAFData","DS/SwymUICore/script/utils/i18n","DS/CKEditor/CKEditor","DS/SwymUICore/script/feature/community/media/model/media-model","DS/SwymPublishForm/script/community-selector-view","DS/SwymPublishForm/script/dm-selector-util","DS/SwymPublishForm/script/dm-selector-view","DS/SwymUICore/script/utils/utils","DS/UIKIT/Spinner","css!SwymPublishForm/SwymPublishForm"],((e,t,o,i,n,r,s,a,l,c,m,u,d,h,p,g,f,_,y,C,S,v,w,b,D,T)=>{const I=document,P="jsnotif",U="jsevent",M="automatic",E="manual",F=n.extend({_description:"",_createContent(){return{class:"content-body",html:this._description}},getDescription(){return this._description},_formatDescription(e){const t=new C.htmlParser.basicWriter,o=new C.htmlParser.fragment.fromHtml(e,void 0,!1);return new C.filter("p;h1;h2;ul;li;ol;i;u;s;strong;blockquote;em;table[*]{*};caption;ythead[*]{*};tbody[*]{*};th[*]{*};tr[*]{*};td[*]{*};br;figcaption;pre;span(marker);b;a[data-type,data-content-type,data-content-id,data-community-id,data-login,desc,url,href,target,contenteditable,data-predicate](*);figure[data-size,data-position](*){*};img[data-media-pasted-id,data-media-id,data-community-id,ds_height,width,height,data-media-type,style,class,title,longDesc,src,data-size,data-position,data-media_cid,data-new_media,data-content-thumbnail,data-deleted-media](*){*}").applyTo(o),o.writeHtml(t),this._description=t.getHtml(),this._description},setup(e){const t=this;t._description=t._formatDescription(e.description),t._parent.apply(t,arguments)}});return n.extend({name:"publish-form-view",_previousSelectedPlatform:[],_mode:"automatic",_currentType:"media",_currentThreadId:null,_currentThreadTitle:null,_communityListLoaded:!1,_platformListLoaded:!1,_config:{mode:"automatic",isDescriptionHTML:!1},_currentPlatform:null,_platformMapping:{},_currentPlatformUrl:null,_currentThreadType:null,_media_is_illustration:0,_viewReadyToBeRendered:null,_communitySelector:null,_dmSelector:null,_isDraft:null,_publishButton:null,_cancelButton:null,_isPlatformChange:null,_createContent(){const t=this;let o=null;return o=this._viewReadyToBeRendered?{class:"publish-form",html:[{class:"publish-form-body",html:[{class:"publish-form-alerts-container"},{class:"platform-select-cnt",html:t.getControl("platformSelect")},t.getControl("ctyToggle")||t.getControl("dmToggle")?{class:"thread-selector-cnt",html:[t.getControl("ctyToggle"),t.getControl("dmToggle")]}:"",t.getControl("buttonGroupType")?{class:"types-button-group-cnt",html:t.getControl("buttonGroupType")}:"",t.getChildView("communitySelector")?{class:"community-select-cnt",html:t._communitySelector}:"",t.getChildView("dmSelector")?{class:"dm-select-cnt",html:t._dmSelector}:"",{class:"alert-message alert-warning",html:f.Thereisnocommunitywhereyoucancreatethiscontent},{class:"title-input-cnt",html:t.getControl("titleInput")},t.getControl("descriptionInput")?{class:"description-input-cnt"+(!0!==t._config.isDescriptionHTML?"":" preview"),html:t.getControl("descriptionInput")}:"","media"===t._currentType?t._displayOnWhatsNew.show():t._displayOnWhatsNew.hide(),{class:"base64-image-container",html:t._config.base64image?`<img width="100%" src="${t._config.base64image}"/>`:""},!0!==t._config.isDescriptionHTML&&this.getControl("buttonGroupType")?{class:"note-cnt",html:f.Note}:""]},{class:"footer-cnt",html:[{class:"button-cnt",html:t._cancelButton},{class:"button-cnt",html:t._publishButtonGroup}]}]}:e.createElement("div",{styles:{margin:"auto","text-align":"center",height:"40px"},html:[{class:"publish-form-alerts-container"},new T({className:"msg-animation",visible:!0,animate:!0,spin:!0})]}),o},onRefresh(){const e=this.getElement(".publish-form-alerts-container");e&&(this.getControl("publish-form-persistent-alert").inject(e).show(),this.getControl("publish-form-alert").inject(e).show())},setContentTitle(t){if(!e.is(t))throw console.error("PublishFormView: No title param set"),"PublishFormView: No title param set";this.getControl("titleInput").setValue(t)},setContentDescription(t){if(!e.is(t))throw console.error("PublishFormView: No description param set"),"PublishFormView: No description param set";!0!==this._config.isDescriptionHTML&&this.getControl("descriptionInput").setValue(t)},setBase64image(e){if(!e)throw console.error("PublishFormView: No base64image param set"),"PublishFormView: No base64image param set";this._config.base64image=e,this.getElement(".base64-image-container").setHTML(`<img width="100%" src="${this._config.base64image}"/>`)},setImageTitle(e){if(!e)throw console.error("PublishFormView: No title param set"),"PublishFormView: No title param set";this._config.title=e,console.warn("PublishFormView: setImageTitle is deprecated, please use title param in the constructor")},setImageDescription(e){e&&(this._config.description=e),console.warn("PublishFormView: setImageDescription is deprecated, please use description param in the constructor")},_getContentPath(e){const t=D.getBaseUrl(),o=D.isCloud(),i=e.get("community->mid"),n=e.get("community->subject6wuri"),s=e.get("mid"),a=this._currentType,l=o?n:i,c=e.get("community->community_type");return`${t}${r.getContentURLForSwym(s,a,l,!1,c)}`},createContent(e){const t=this;require(["DS/SwymUICore/script/lib/model/generic/swym-model"],(o=>{require([o.getModuleNameFromModelName(t._currentType)],(o=>{if(t._currentThreadId&&t._currentType){let i=null;const n=function(e,o){e.save("media"===o?{}:{community_id:t._currentThreadId},{headers:{"X-DS-SWYM-CSRFTOKEN":t._bootstrapModel.getCSRFToken()},onComplete(e){t._publishButton.setDisabled(!1),t.unmask(),t.setContentTitle(""),!0!==t._config.isDescriptionHTML&&t.setContentDescription(""),"automatic"!==t._mode?t._sendEvent("ContentCreated",JSON.stringify({success:!0,containerId:e.get("community->mid"),containerType:e.get("community->community_type"),contentSubjectURI:e.get("subject6wuri"),contentId:e.get("mid"),contentUrl:t._getContentPath(e)})):t._config.onContentCreated?(t._showAlertMessage("success",y.replace(t._isDraft?f.Adraftofyourcontentwascreated:f.Yourcontenthasbeenpublishedin,{communityTitle:t._currentThreadTitle})),t._config.onContentCreated()):(t._showAlertMessage("success",y.replace(t._isDraft?f.Adraftofyourcontentwascreated:f.Yourcontenthasbeenpublishedin,{communityTitle:t._currentThreadTitle})),t.hide())},onFailure(){t._publishButton.setDisabled(!1),t.unmask(),"automatic"!==t._mode?t._sendEvent("ContentCreated",JSON.stringify({success:!1,message:f.Errorcannotsaveyourcontent})):t._showAlertMessage("error",f.Errorcannotsaveyourcontent)}})};let r=!0!==t._config.isDescriptionHTML?t.getControl("descriptionInput").getValue():t._config.contentDescription;const s=t.getControl("titleInput").getValue();switch(r&&!0!==t._config.isDescriptionHTML&&(r=r.escapeHTML(),r=`<p>${r.replace(/\n/g,"</p><p>")}</p>`),t._currentType){case"post":case"iquestion":case"idea":i=new o({},{headers:{"X-DS-SWYM-CSRFTOKEN":t._bootstrapModel.getCSRFToken()}}),e?i.addChanges("content",`${r}<p><img data-source="swym" data-media-id="${e}" width="320"></p>`):i.addChanges("content",r),i.addChanges("title",s),i.addChanges("published",t._isDraft?0:1),n(i,t._currentType);break;case"media":e&&(i=new o({id:e},{headers:{"X-DS-SWYM-CSRFTOKEN":t._bootstrapModel.getCSRFToken()},autoPopulate:!0,onPopulate(e){e.addChanges("description",r),e.addChanges("title",s),e.addChanges("is_illustration",t._media_is_illustration),e.addChanges("published",t._isDraft?0:1),n(e,t._currentType)},onFailure(){"automatic"!==t._mode?t._sendEvent("ContentCreated",JSON.stringify({success:!1,message:f.Errorcannotloadyourmedia})):t._showAlertMessage("error",f.Errorcannotloadyourmedia)}}))}}else"automatic"!==t._mode&&t._sendEvent("ContentCreated",JSON.stringify({success:!1,message:f.Errormissingparameters}))}))}))},_displayDMList(){this._dmSelector.populateDMCollection({csrfToken:this._bootstrapModel.getCSRFToken(),urlRoot:this._currentPlatformUrl,dmId:"dm"===this._currentThreadType&&this._config.threadId}),this.getControl("buttonGroupType")&&this.getControl("buttonGroupType").setDisabled(!1),this._dmSelector.isDisabled()&&this._dmSelector.enable()},_displayNoDMMessage(){this.getElement(".alert-message.alert-warning-dm").setStyle("display","block"),this.dmSelector.disable(),this.dmSelector.hide(),this._communitySelector.hide()},_createDMSelector(){const e=this;this._bootstrapModel.executeWhenReady((()=>{e.isDestroyed()||w.getDMSelector().catch((e=>(console.error(e),console.warn("Error in checking for RTConvAPI. Falling back to Swym DM selector"),b))).then((t=>{if(!e.isDestroyed()){if(e._dmSelector=e.addChildView("dmSelector",{Class:t,disabled:!1,events:{onConversationCreated(){const t=e._checkValidationForm();t?e._publishContent():e._publishButton.setDisabled(t)},onDMSelectChange(t,o,i="dm"){e._currentThreadId=t,e._currentThreadTitle=o,e._currentThreadType=i}}}),e._displayDMList(),"dm"===e._config.threadType)return e._dmSelector.show(),void e.refresh();e._dmSelector.hide(),e.refresh()}}))}))},_displayCommunityList(){this._communitySelector.setModelParam(this._currentType,{csrfToken:this._bootstrapModel.getCSRFToken(),urlRoot:this._currentPlatformUrl,communityId:"community"===this._currentThreadType&&this._config.threadId}),this._communitySelector.resetUrlRoot(),this.getControl("buttonGroupType")&&this.getControl("buttonGroupType").setDisabled(!1),this._communitySelector.isDisabled()&&this._communitySelector.enable(),this._communityListLoaded=!0,this._communityListLoaded&&this._platformListLoaded&&this.unmask()},_setCurrentPlatformURL(e){const t=this;null!=t._currentPlatformUrl&&t._previousSelectedPlatform.push(t._currentPlatformUrl),t._currentPlatformUrl=e,D.initBaseUrl(t._currentPlatformUrl),t._bootstrapModel.initialize(null,{baseUrl:t._currentPlatformUrl,publishForm:!0}).executeWhenReady((()=>{if(!t.isDestroyed())if(t._viewReadyToBeRendered=!0,t.refresh(),t._config.hideThreadDataSelectors){const e="community"===t._currentThreadType?p:h;t._thread=new e({id:t._currentThreadId}),t._thread.fetch({headers:{"X-DS-SWYM-CSRFTOKEN":t._bootstrapModel.getCSRFToken()},onComplete(){t.getElement(".alert-message").setStyle("display","none"),t._currentThreadTitle="community"===t._currentThreadType?t._thread.get("title"):t._thread.getMembersTitle(t._bootstrapModel.get("user").login),t.getControl("buttonGroupType")&&t.getControl("buttonGroupType").setDisabled(!1),t._communityListLoaded=!0,t._communityListLoaded&&t._platformListLoaded&&t.unmask()},onFailure(){throw new Error("This thread does not exist")}})}else t._communitySelector&&(t._isPlatformChange&&t._communitySelector.checkLocalStorage(),t._displayCommunityList()),t._dmSelector&&t._displayDMList()}))},_processPlatforms(e,t=!0){const o=[];let i,n,r;const s=this._config,a=this;if(this._currentPlatform=s.platformId||s.platformUrl,!(e.length>0))throw"Platform list can't be empty";if(e.filter((e=>e.url||Object.prototype.hasOwnProperty.call(e,"3DSwym"))).forEach((e=>{i=e.url?e.url:Object.prototype.hasOwnProperty.call(e,"3DSwym")&&e["3DSwym"],n=e.platformId&&e.platformId.toLowerCase()||e.id,o.push({id:n,label:e.displayName||e.label,value:i}),(a._currentPlatform&&(n===a._currentPlatform.toLowerCase()||a._currentPlatform.toLowerCase().contains(i.substring(0,i.length-1)))||!a._currentPlatform&&"catia"===a._mode&&i.contains(document.location.host))&&(r=i)})),0===o.length)throw"Platform list is empty";if(this._config.forcePlatform)t&&a._setCurrentPlatformURL(r);else{if(o.sort(((e,t)=>e.label.localeCompare(t.label))),a.getControl("platformSelect").remove(),a.getControl("platformSelect").add(o),a.getControl("platformSelect").elements.choices.removeAttribute("style"),a._platformMapping=o.reduce(((e,t)=>({...e,[t.value]:t.id})),{}),a.getControl("platformSelect").show(),r)a._isPlatformChange=!1,a.getControl("platformSelect").select(r,!0,!0),t&&a._setCurrentPlatformURL(r);else{a._isPlatformChange=!1,a.getControl("platformSelect").select(1,!0,!0);const e=a.getControl("platformSelect").getValue();e&&e[0]&&t&&a._setCurrentPlatformURL(e[0])}a.getControl("platformSelect").setDisabled(!1)}a._platformListLoaded=!0},async _getCurrentPlatformService(e){let t=!0;try{const o=await new Promise(((t,o)=>{g.getPlatformServices({forcePlatformServicesAPI:!0,public:!0,platformId:this._config.platformId,services:["3DSwym"],config:e,onComplete:t,onFailure:o})}));this._processPlatforms([o]),t=!1}finally{const o=await g.getAllPlatformIdByUserPromise(e);g.getPlatformServices({forcePlatformServicesAPI:!0,public:!0,platforms:o,services:["3DSwym"],config:e,onComplete:e=>{this._processPlatforms(e,t)},onFailure(e){throw e}})}},async _getPlatformServices(e,t){let o;const i={myAppsBaseUrl:e,userId:t};if(this._config.platformId)return this._getCurrentPlatformService({myAppsBaseUrl:e,userId:t});o=await g.getAllPlatformIdByUserPromise(i),g.getPlatformServices({forcePlatformServicesAPI:!0,public:!0,platforms:o,services:["3DSwym"],config:i,onComplete:e=>{this._processPlatforms(e)},onFailure(e){throw e}})},_fetchPlatformList(){const e=this;this._config.platforms?this._processPlatforms(this._config.platforms):"catia"===this._mode?require(["DS/SwymUICore/script/utils/platform-utils"],(t=>{t.getMyAppsURLPromise().then((t=>{e._getPlatformServices(t,i.getInstance().get("user").login)}))})):e._getPlatformServices()},_sendEvent(e,t){if(this._notifType===P&&"jsevent"!==this._secondaryMode){const o=I.createElement("textarea");let i=I.createElement("form");o.setAttribute("name",e),o.appendChild(I.createTextNode(t)),i.setAttribute("method","POST"),i.setAttribute("action","jsnotif://"),i.appendChild(o),I.documentElement.appendChild(i),i.submit(),i.parentNode.removeChild(i),i=null}else this.dispatchEvent(e,t)},_uploadImage(){const e=this,t=new S({});let o=null;o={base64_encoded:1,description:!0!==this._config.isDescriptionHTML?this.getControl("descriptionInput").getValue():this._config.contentDescription,title:this.getControl("titleInput").getValue()||this._config.title,published:this._isDraft?0:1,community_id:this._currentThreadId,userFile:this._config.base64image,fileName:`${this._config.title}.${this._config.base64imageExtension}`,is_illustration:"media"!==this._currentType?1:this._media_is_illustration},t.save(o,{onComplete(t){e.createContent(t.get("mid"))},onFailure(){e._showAlertMessage("error",f.Errorcannotsaveyourmedia),e._publishButton.setDisabled(!1),e.unmask()}})},_showAlertMessage(e,t){this.getControl("publish-form-alert").add({className:e,message:t})},_showPersistentAlertMessage(e,t){this.getControl("publish-form-persistent-alert").add({className:e,message:t})},_createThreadSelector(){const e="dm"===this._config.threadType;this._ctyToggle=this.addControl("ctyToggle",new c({name:"thread",value:"community",className:"primary "+(e?"":"checked"),label:f.Community,checked:!e})),this._dmToggle=this.addControl("dmToggle",new c({name:"thread",value:"dm",className:"primary "+(e?"checked":""),label:f.Conversation,checked:e})),this._ctyToggle.addEvent("onChange",this._onCtyToggleChange.bind(this)),this._dmToggle.addEvent("onChange",this._onDMToggleChange.bind(this))},_onCtyToggleChange(){const e=this.getControl("buttonGroupType");this._ctyToggle.isChecked()&&(this._ctyToggle.elements.container.classList.add("checked"),this._dmToggle.elements.container.classList.remove("checked"),this._dmSelector.hide(),this._dmSelector.container.hasClassName("invalid")&&this._dmSelector.container.removeClassName("invalid"),this._currentThreadType="community",this.getControl("titleInput").getContent().getAttribute("style")&&this.getControl("titleInput").getContent().removeAttribute("style"),this._communitySelector.show(),e&&e.updateOptions())},_onDMToggleChange(){const e=this.getControl("buttonGroupType");this._dmToggle.isChecked()&&(this._dmToggle.elements.container.classList.add("checked"),this._ctyToggle.elements.container.classList.remove("checked"),this._currentThreadType="dm",this._communitySelector.hide(),this._communitySelector.container.hasClassName("invalid")&&this._communitySelector.container.removeClassName("invalid"),this.getControl("titleInput").getContent().getAttribute("style")&&this.getControl("titleInput").getContent().removeAttribute("style"),this._dmSelector.show(),this.getElement(".alert-message.alert-warning").setStyle("display","none"),e&&e.updateOptions())},_createTypeSelector(e){const t=this;let o=[{modelName:"media",value:f.Media,selected:!0},{modelName:"post",value:f.Post},{modelName:"iquestion",value:f.iQuestion},{modelName:"idea",value:f.Idea}];e.availableContentTypes&&(o=o.filter((t=>e.availableContentTypes.includes(t.modelName)))),"automatic"===this._mode&&Object.prototype.hasOwnProperty.call(e,"isDescriptionHTML")&&!0===e.isDescriptionHTML&&!Object.prototype.hasOwnProperty.call(e,"base64image")&&(o.shift(),o[0].selected=!0,t._currentType=o[0].modelName);const i=this.addControl("buttonGroupType",new l({disabled:!0,placeholder:f.Selectacontenttype,options:o,events:{onChange(){const e=t.getControl("buttonGroupType");if(e&&e.getValue()&&e.getValue()[0]&&""!==e.getValue()[0]){const o=e.options.options.filter((t=>t.value===e.getValue()[0]));o[0]&&(t._currentType=o[0].modelName,"media"!==t._currentType||"dm"===t._currentThreadType?t._displayOnWhatsNew.hide():t._displayOnWhatsNew.show()),e.elements.choices.removeAttribute("style"),"community"===t._currentThreadType&&(e.setDisabled(!0),t._communitySelector.disable(),t._displayCommunityList())}else e&&(e.elements.choices.setStyle("border","1px solid #d0432b"),t._currentType=null)}}}));i.updateOptions=function(){i.remove(),"community"===t._currentThreadType?i.add(o):i.add([{modelName:"media",value:f.Media,selected:!0},{modelName:"post",value:f.Post}])}},_createCommunitySelector(){const e=this;this._bootstrapModel.executeWhenReady((()=>{e.isDestroyed()||(e._communitySelector=e.addChildView("communitySelector",{Class:v,disabled:!1,modelParam:e._currentType,events:{onCommunitySelectChange(t,o){e._currentThreadId=t,e._currentThreadTitle=o}}}),"dm"!==e._config.threadType?e._communitySelector.show():e._communitySelector.hide())}))},_onPublish(){const e=this;let t=!0;e._publishButton.setDisabled(t),e._config.hideThreadDataSelectors||"user"!==e._currentThreadType?(t=e._checkValidationForm(),t||e._publishButton.setDisabled(t)):(e._dmSelector.createConversation(e._dmSelector.getDMSelected()),t=!1),!0===t&&e._publishContent()},_publishContent(){if(this.mask(),"automatic"!==this._mode){const e=this.getControl("platformSelect"),t=this._config.forcePlatform&&this._config.platformId?this._currentPlatformUrl:e.getValue()[0],o=this._config.forcePlatform&&this._config.platformId?this._config.platformId:this._platformMapping[t];this._sendEvent("StartUpload",JSON.stringify({platform_instance:t,platformId:o,community_id:this._currentThreadId,content_type:this._currentType,isDraft:this._isDraft,platformUrl:t,threadId:this._currentThreadId,threadTitle:this._currentThreadTitle,threadType:this._currentThreadType,contentType:this._currentType}))}else this._config.base64image?this._uploadImage():this.createContent(null)},_checkValidationForm(){let e=!0;const t=this.getControl("titleInput");return this._config.hideThreadDataSelectors||("community"!==this._currentThreadType||this._communitySelector.validate()||(!this._communitySelector.container.hasClassName("invalid")&&this._communitySelector.container.addClassName("invalid"),e=!1),"dm"!==this._currentThreadType||this._dmSelector.validate()||(!this._dmSelector.container.hasClassName("invalid")&&this._dmSelectorcontainer.addClassName("invalid"),e=!1)),t&&""===t.getValue().trim()&&(t.getContent().setStyle("border","1px solid #d0432b"),e=!1),null===this._currentType&&(e=!1),e||this._showAlertMessage("warning",f.Pleasecheckyourform),e},_onCancel(){const e=this;"automatic"!==e._mode?e._sendEvent("CancelShare","Cancel share"):e._config.onCancel?e._config.onCancel():(e.hide(),e._dmSelector.destroy(),e._communitySelector.destroy())},setup(t){const n=this;let r,h=null;if(this._viewReadyToBeRendered=!1,t&&(n._config=t),t.forcePlatform&&void 0===t.platformId)throw"If the platform list option is set to true, a platformId option must be provided";if(!0===t.hideThreadDataSelectors&&t.threadType&&void 0===t.threadId)throw new Error("If hideThreadDataSelectors is set to true, a threadType and a threadId option must be provided");if(this._currentThreadType="community","dm"===t.threadType&&(this._currentThreadType="dm"),this._isPlatformChange=!1,this._isDraft=!1,"base64"===n._config.mode?(n._mode="automatic",n._config.mode=n._mode,console.warn("PublishFormView: base64 mode is deprecated, please don't define it or use 'automatic' instead")):e.is(n._config.mode)&&"automatic"!==n._config.mode&&(n._mode=n._config.mode),n._config.notifType===U||n._config.notifType===P?n._notifType=n._config.notifType:"catia"===n._mode?n._notifType=P:n.notifType=U,n._config.platformChange===M||n._config.platformChange===E?n._platformChange=n._config.platformChange:"catia"===n._mode?n._platformChange=E:n._platformChange=M,this._allowDraft=!e.is(n._config.allowDraft)||n._config.allowDraft,n._config.isDescriptionHTML=!1,Object.prototype.hasOwnProperty.call(n._config,"base64image")){if(!Object.prototype.hasOwnProperty.call(n._config,"title"))throw console.error("PublishFormView: title must be defined if base64image is set"),"PublishFormView: title must be defined if base64image is set";Object.prototype.hasOwnProperty.call(n._config,"base64imageExtension")||(n._config.base64imageExtension="png")}t.content_title&&(console.warn("PublishFormView: content_title is deprecated, please use contentTitle instead of content_title"),t.contentTitle=t.content_title),t.content_description&&(console.warn("PublishFormView: content_description is deprecated, please use contentDescription instead of content_description"),t.contentDescription=t.content_description),t.platformUrl&&console.warn("PublishFormView: platformUrl is deprecated, please use platformId instead of platformUrl"),t.platforms&&t.platforms.forEach((e=>{if(!e.id||!e.label||!e.url)throw new Error("Each plaform must contain the properties id, label and url")})),n._bootstrapModel=i.getInstance(),n._bootstrapModel.loaded=!1,n.reactTo(n._bootstrapModel,"onFailure",(()=>{if(n.isDestroyed())return;const t=n._currentPlatformUrl,i=n._previousSelectedPlatform.pop(),r=n.getControl("platformSelect");if(r){if(t){const i=e.createElement("span",{html:o.format(f.NoAccessPleaseLogin,`<a href="${t}" target="_blank">`,"</a>")});n._showPersistentAlertMessage("error",i)}else n._showAlertMessage("error",f.Lookslikeyoudonthaveaccesstothisplatform);n._currentPlatformUrl=null;const s=r.getOptions();i&&s.some((e=>e.value===i))?r.select(i):s.length&&(r.clear(),s.length>1&&(n._viewReadyToBeRendered=!0,n.refresh()))}else n._communitySelector&&n._communitySelector.hide(),n._showAlertMessage("error",f.Lookslikeyoudonthaveaccesstothisplatform);n._sendEvent("TenantChangeFailure",{old:t,new:i}),n.unmask()})),n._parent.apply(n,arguments),!0!==t.hideThreadDataSelectors?(n._createThreadSelector(),n._createCommunitySelector(),n._createDMSelector()):(n._currentThreadType=t.threadType,n._currentThreadId=t.threadId),!t.availableContentTypes||t.availableContentTypes.length>1?this._createTypeSelector(t):n._currentType=t.availableContentTypes[0],n.addControl("titleInput",new u({placeholder:f.Title,value:n._config.contentTitle||"",maxlength:255,events:{onChange(){""===this.getValue().trim()?this.getContent().setStyle("border","1px solid #d0432b"):this.getContent().removeAttribute("style")}}})),!0!==n._config.isDescriptionHTML?n.addControl("descriptionInput",new u({multiline:!0,placeholder:f.Description,value:n._config.contentDescription||""})):n._config.contentDescription&&(h=n.addControl("descriptionInput",new F({addScroller:!0,description:n._config.contentDescription})),n._config.contentDescription=h.getDescription()),this.addControl("highSemanticMediaCheckBox",new c({type:"checkbox",label:f.get("DisplayOnWhatsNew"),checked:!0,name:"displayonwhatsnew",className:"primary",events:{onChange(){n._media_is_illustration=n.getControl("highSemanticMediaCheckBox").isChecked()?0:1}}})).getContent().setStyle("display","inline-block"),r=e.createElement("span",{styles:{"margin-left":"10px"},class:"fonticon fonticon-help-circled"}),this._displayOnWhatsNew=e.createElement("div",{class:"display-on-whatsnew-section",html:[this.getControl("highSemanticMediaCheckBox"),r]}),this.addControl("helpIconTooltip",new m({trigger:"touch",target:r,body:o.format(f.get("IfSelectedTheMediaWillBeDisplayedOnTheWhatsNew"),"<b>","</b>")})),this._publishButton=this.addControl("publishButton",new s({className:"publish-share-button primary",value:f.Publish})),this._publishButton.addEvent("onClick",this._onPublish.bind(this)),n._cancelButton=n.addControl("cancelButton",new s({className:"cancel-share-button default",value:f.Cancel})),n._cancelButton.addEvent("onClick",this._onCancel.bind(this)),this._draftButton=this.addControl("draftButton",new s({className:"draft-button primary",dropdown:{className:"draft-menu",items:[{text:f.SaveAsDraft,className:"draft-item"}],renderTo:this.container},events:{onDropdownClick:()=>{this._isDraft=!0,this._onPublish()},onDropdownShow:()=>{const e=this._draftButton.dropdown.getBody();e.setStyle("top",`${parseInt(e.getStyle("top").split("px")[0],10)+43}px`)}}}));const p=[this._publishButton];this._allowDraft&&p.push(this._draftButton),this._publishButtonGroup=new a({buttons:p}),this.addControl("publish-form-persistent-alert",new d({autoHide:!1,closable:!0,className:"publish-form-persistent-alert"})),this.addControl("publish-form-alert",new d({autoHide:!0,hideDelay:3e3,className:"publish-form-alert"})),t.forcePlatform||(n.addControl("platformSelect",new l({className:"platform-combo",placeholder:f.Selectaplatform,disabled:!0,events:{onChange(){const e=n.getControl("platformSelect"),t=e.getValue()[0];e&&e.getValue()&&t&&""!==t?(e.elements.choices.removeAttribute("style"),n.mask(),n._sendEvent("PlatformChange",JSON.stringify({platform_instance:e.getValue()[0]})),"catia"===n._mode&&n._platformChange!==M||(n._communitySelector&&(n._communitySelector.disable(),n._communitySelector.reset()),n._dmSelector&&(n._dmSelector.disable(),n._dmSelector.reset()),n._bootstrapModel.loaded=!1,t!=n._currentPlatformUrl&&(n._isPlatformChange=!0),n._setCurrentPlatformURL(e.getValue()[0]))):e&&e.elements.choices.setStyle("border","1px solid #d0432b")}}})),n.getControl("platformSelect").hide()),n._fetchPlatformList()}})}));