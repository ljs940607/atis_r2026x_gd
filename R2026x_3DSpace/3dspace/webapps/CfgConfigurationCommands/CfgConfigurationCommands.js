define("DS/CfgConfigurationCommands/commands/CfgEditConfigurationContextCmd",["DS/ApplicationFrame/Command","DS/CfgTracker/CfgTracker","DS/PADUtils/PADContext","DS/CfgBaseUX/scripts/CfgController","DS/CfgBaseUX/scripts/CfgUtility","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","i18n!DS/CfgConfigurationCommands/assets/nls/CfgConfigurationCommands","i18n!DS/CfgBaseUX/assets/nls/CfgBaseUXNLS","DS/Utilities/Utils"],(function(e,t,n,o,i,s,r,a,l,c){"use strict";return e.extend({contextDialog:null,init:function(e){var t=this;this._parent(e,{mode:"exclusive",isAsynchronous:!1}),this._isConfigAvailable=0,this.enable();t=this;i.rolesAvailable((function(e){e.isCFGRoleAvail&&(t._isConfigAvailable=1),t._setStateCmd()})),void 0!==n.get&&null!==n.get()?this._SelectorManager=n.get().getPADTreeDocument().getXSO():this._SelectorManager=null,null!==this._SelectorManager&&(void 0!==this._SelectorManager.onPostAdd&&this._SelectorManager.onPostAdd(this._checkSelection.bind(this)),void 0!==this._SelectorManager.onPostRemove&&this._SelectorManager.onPostRemove(this._checkSelection.bind(this)),void 0!==this._SelectorManager.onEmpty&&this._SelectorManager.onEmpty(this._checkSelection.bind(this)));t=this;void 0!==n.get&&null!==n.get()&&n.get().addEvent("editModeModified",(function(e){!0===e?t._checkSelection():t.disable()}))},_checkSelection:c.debounce((function(){var e=this;this._SelectedID="";var t=this.getData().selectedNodes;t.length>=1&&(e._SelectedID=t[0].id||"",e._SelectedAlias=t[0].alias||"?"),e._setStateCmd()}),20),_setStateCmd:function(){var e=0;void 0!==this._SelectedID&&""!==this._SelectedID&&(e=1,0==this._isConfigAvailable&&(e=0)),void 0!==n.get&&null!==n.get()&&void 0!==n.get().getEditMode&&!0!==n.get().getEditMode()&&(e=0),1===e?this.enable():this.disable()},destroy:function(){this.contextDialog&&this.contextDialog.closeDialog()},processDialog:function(e){let n=e.getMCCInfoResponseWSResponse,o=enoviaServerFilterWidget.baseURL;if(n.contextInfo)for(let t=0;t<n.contextInfo.length;t++){const s=n.contextInfo[t],r=n.description?.[s.descId]?.results?.[0]||s.content?.results?.[0]||null;if(r){if(r.notification&&"ERROR"===r.notification.type)return e.enable(),void("unaccessible"!==r.notification.code&&"notExist"!==r.notification.code||i.showwarning(a.Error_Deleted_Model,"error"));r.type_icon_url&&-1===r.type_icon_url.indexOf(o)&&(r.type_icon_url=o+r.type_icon_url),r.type_icon_large_url&&-1===r.type_icon_large_url.indexOf(o)&&(r.type_icon_large_url=o+r.type_icon_large_url)}}if(null!=n.xRevisionContent)for(let e=0;e<n.xRevisionContent.length;e++)for(let t=0;t<n.xRevisionContent[e].attachedScopes.length;t++){let i=n.xRevisionContent[e].attachedScopes[t].attributes[0];i.type_icon_url&&-1===i.type_icon_url.indexOf(o)&&(i.type_icon_url=o+i.type_icon_url),i.type_icon_large_url&&-1===i.type_icon_large_url.indexOf(o)&&(i.type_icon_large_url=o+i.type_icon_large_url)}let s=e.configurationSettingsWSResponse,r=["Model"],l=e.getData().selectedNodes;s&&(s.CPQActivation||s.ExplicitVariantActivation)&&l&&l.length>0&&(r=l[0].xCADApps&&l[0].xCADApps.includes("SOLIDWORKS")?["Products"]:["Model","Products"]);let c={};c.xRevisionPresent=null!=n.xRevisionContent&&n.xRevisionContent.length>0,c.response=n,c.selection=l,c.pAndOAccess=e.pAndOAccess,c.typesToSearch=r,c.isAttachContextReadOnly=e.isAttachContextReadOnly,require(["DS/CfgConfigurationContextUX/CfgEditMultipleConfigurationContextDialog"],(function(n){e.contextDialog=new n(c),e.contextDialog.render(),e.enable();let o={AppId:widget&&widget.data&&widget.data.appId?widget.data.appId:"defaultAppID",AppName:widget&&widget.options&&widget.options.title?widget.options.title:"ODT Environment",CommandName:t.Labels.EDIT_CONFIGURATION_CONTEXT,CommandOperation:"Edit_Configuration_Context_Dialog_Open",ConfigMode:t.ConfigMode.CONTEXTUAL,ApplicationMode:t.ApplicationMode.DASHBOARD};i.sendConfgurationCommandsClickEventForMagicProbes(o)}))},processDialogData:async function(e){o.init(),widget.getValue("x3dPlatformId")?enoviaServerFilterWidget.tenant=widget.getValue("x3dPlatformId"):enoviaServerFilterWidget.tenant="OnPremise",await i.populate3DSpaceURL(),await i.populateSecurityContext();let t={};try{t=await i.getPAndOAccess(["GetAttachedModels","AttachModels","DetachModels"]),console.log("pno OK response : "+t)}catch(e){console.log("pno KO response : "+e)}"Granted"!=t.GetAttachedModels&&(i.showwarning(l.CfgMessageAccessRightsError,"error"),e.enable());let n=null;try{n=await i.checkDecouplingActivation()}catch(e){console.error(e)}e.configurationSettingsWSResponse=n;let c=[];const d=e.getData().selectedNodes.length;for(let t=0;t<d;t++)c.push(e.getData().selectedNodes[t].id);let g={referenceIds:c},f=null;e.isAttachContextReadOnly=!1;try{f=await i.getMultipleConfigurationContextInfo(g)}catch(t){e.enable(),window.notifs=s,r.setNotificationManager(window.notifs);var p=t.search("Incorrect type");""!==p&&p>=0?i.showwarning(a.Error_Models_Incorrect_Type,"error"):i.showwarning(a.Error_Models,"error")}if(f){if(0==e.getValidSelection(f))return void e.enable();if(e.getMCCInfoResponseWSResponse=f,e.getMCCInfoResponseWSResponse.xRevisionContent&&e.getMCCInfoResponseWSResponse.xRevisionContent.length>0&&e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes&&e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes.length>0&&e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes[0].attributes[0]&&"Model"!==e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes[0].attributes[0].type)if(e.isAttachContextReadOnly=!0,e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes[0].modelPID){let t={modelPID:e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes[0].modelPID},n=await i.processSearchData(t);const o=n.basicData.find((e=>"current"===e.name)).value,s=await i.readNLSvaluesOfAttributes(o);n.basicData.forEach((e=>{"current"===e.name&&s["ds6w:status"]&&(e.value=s["ds6w:status"][o])})),e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes[0].attributes[0].basicData=n.basicData,e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes[0].attributes[0].data=n.data}else e.getMCCInfoResponseWSResponse.xRevisionContent[0].attachedScopes=[];e.processDialog(e)}},execute:function(){var e=this;if(this.disable(),0==this._isConfigAvailable)return i.showNotifs("error",l.NoCfgRoleError,l.NoCfgRoleErrorSubTitle),void this.disable();var t=e.getData().selectedNodes;if(0===t.length)return i.showwarning(a.Error_NoObjectSelection,"error"),void this.disable();if(1===t.length)this._SelectedID=t[0].id||"",this._SelectedAlias=t[0].alias||"?";else if(t.length>1)for(let n=t.length-1;n>0;n--){if(e.getData().selectedNodes[n].xCADApps!=e.getData().selectedNodes[n-1].xCADApps)return void i.showwarning(a.Error_MixedType,"error")}console.log(t),(e=this).processDialogData(e)},getValidSelection:function(e){if(null!=e.xRevisionContent&&e.xRevisionContent.length>0){if(e.referencesInfo.length>1&&0==e.contextInfo.length)return i.showwarning(a.Error_Multiple_Reference_xRevision,"error"),!1;if(e.contextInfo.length>0)return i.showwarning(a.Error_Multiple_Reference_xRevision_And_Model,"error"),!1}let t=0,n=!1;if(e.referencesInfo){if(e.referencesInfo.length>1)for(let o=0;o<e.referencesInfo.length;o++)"NO"==e.referencesInfo[o].isConfigurable&&t++,"YES"==e.referencesInfo[o].hasConfigContext&&"Explicit"==e.referencesInfo[o].revisionMode&&(n=!0);else 1==e.referencesInfo.length&&"NO"==e.referencesInfo[0].isConfigurable&&t++;if(t>=1&&t<e.referencesInfo.length)return i.showwarning(a.Error_Incorrect_Type_Partial_Fail,"error"),!1;if(t==e.referencesInfo.length)return i.showwarning(a.Error_Incorrect_Type_Complete_Fail,"error"),!1;if(n)return i.showwarning(a.Error_Multiple_Reference_Model_Version,"error"),!1}return!0},getData:function(){var e={selectedNodes:[]};if(void 0!==n.get&&null!==n.get()){let r="3DEXPERIENCE",a="";var t,o=n.get().getSelectedNodes(),i=o.length;for(t=0;t<i;t++)if(o[t].isRoot()){var s={id:o[t].getID(),alias:o[t].getLabel()};"function"==typeof o[t].getAttribute?r=o[t].getAttribute("ds6w:cadMaster"):o[t].options.grid["ds6w:cadMaster"]&&(r=o[t].options.grid["ds6w:cadMaster"]),a=o[t].options.type,s.xCADApps=r,s.coreType=a,e.selectedNodes.push(s)}else{const n=o[t].getRealParent?o[t].getRealParent():o[t].getParent();s={id:o[t].getID(),alias:o[t].getLabel(),parentID:n.getID(),parentalias:n.getLabel()};"function"==typeof o[t].getAttribute?r=o[t].getAttribute("ds6w:cadMaster"):o[t].options.grid["ds6w:cadMaster"]&&(r=o[t].options.grid["ds6w:cadMaster"]),a=o[t].options.type,s.xCADApps=r,s.coreType=a,e.selectedNodes.push(s)}}return e}})}));