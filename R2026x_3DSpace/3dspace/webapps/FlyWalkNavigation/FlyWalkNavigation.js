define("DS/FlyWalkNavigation/NavigationRunloop",["UWA/Class"],(function(t){"use strict";return t.extend({init:function(t){this.name=t.name||"Runloop",this.running=!1,this.data=t.data,this.setRunloopCB(t.func),this.onStart=t.onStart,this.onStop=t.onStop,this.onError=t.onError,t.autoStart&&this.start()},setRunloopCB:function(t){if(t){this.func=t;var e=this,i=(new Date).getTime();this.data?this.runloop=function(){e.running&&(e.id=requestAnimationFrame(e.runloop));var t=(new Date).getTime();e.func.apply(e.data,[{time:t-e.starttime,deltaTime:t-i}]),i=t}:this.runloop=function(){e.running&&(e.id=requestAnimationFrame(e.runloop));var t=(new Date).getTime();e.func({time:t-e.starttime,deltaTime:t-i}),i=t}}},start:function(){this.runloop?(this.running=!0,this.id=requestAnimationFrame(this.runloop),this.starttime=(new Date).getTime(),this.onStart&&this.onStart()):(console.error("runloop have not loop function"),this.onError&&this.onError())},stop:function(){this.running=!1,cancelAnimationFrame(this.id),this.onStop&&this.onStop()},dispose:function(){!0===this.running&&this.stop(),this.func=null,this.data=null,this.runloop=null}})})),define("DS/FlyWalkNavigation/HoldStayCustomGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],(function(t,e,i){"use strict";var o=i.extend({init:function(){return this._parent("HoldStayCustom"),this.priority=11,this.identifier=null,this.maxTime=300,this.stayTimerTime=100,this.maxDistance=10,this.timer=null,this.stayTimer=null,this.startTime=0,this.endTime=0,this},detect:function(t){this._parent(t);var o=this;switch(this.state){case i.State.INIT:1===(n=THREEDS.VisuEventsManager.getTouchEventsByStates([e.State.BEGIN,e.State.MOVE,e.State.IDLE])).length&&(this.resetAllTimers(),1===(n=THREEDS.VisuEventsManager.getTouchEventsByStates([e.State.BEGIN],this.view)).length&&(this.identifier=n[0].identifier,this.timer=setTimeout((function(){o.events=[n[0]],o.endTime=(new Date).getTime(),o.changeState(i.State.CHANGE),o.stayTimer=setInterval((function(){o.events=[n[0]],o.endTime=(new Date).getTime(),o.changeState(i.State.CHANGE),o.execute(!0)}),o.stayTimerTime),o.execute(!0)}),this.maxTime),this.startTime=n[0].startTime,this.changeState(i.State.BEGIN)));break;case i.State.BEGIN:var n=THREEDS.VisuEventsManager.getTouchEventsByStates([e.State.BEGIN,e.State.MOVE,e.State.IDLE]),a=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);(1!==n.length||null===a||a.state===e.State.END||a.state===e.State.MOVE&&a.offsetPosition.length()>this.maxDistance)&&(this.resetAllTimers(),this.changeState(i.State.KO));break;case i.State.CHANGE:n=THREEDS.VisuEventsManager.getTouchEventsByStates([e.State.BEGIN,e.State.MOVE,e.State.IDLE,e.State.END]),a=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);1!==n.length||null===a||a.state===e.State.END?(this.resetAllTimers(),this.changeState(i.State.OK)):a.state===e.State.MOVE&&(a.offsetPosition.length()>this.maxDistance?(this.resetAllTimers(),this.changeState(i.State.KO)):this.events=[a]);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.startTime=0,this.endTime=0,this.changeState(i.State.INIT)}},resetTimer:function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)},resetStayTimer:function(){null!==this.stayTimer&&(clearInterval(this.stayTimer),this.stayTimer=null)},resetAllTimers:function(){this.resetStayTimer(),this.resetTimer()},getTouchPoint:function(){return this.getEvents().length>0?this.getEvents()[0].getCurrentPosition():null},getElapsedTime:function(){return this.getEvents().length>0?this.endTime-this.startTime:null}});return UWA.namespace("DS/FlyWalkNavigation/HoldStayCustomGesture",o)})),define("DS/FlyWalkNavigation/NavigationAnnotationUtils",["DS/Visualization/ThreeJS_DS"],(function(t){"use strict";return{onScreenProjection:function(e,i){for(var o,n=[],a=i.currentViewpoint.getCamera(),s=a.matrixWorldInverse,r=a.projectionMatrix,l=i.SCREEN_WIDTH,h=i.SCREEN_HEIGHT,c=0;c<e.length;c++)o=e[c].clone(),(o=new t.Vector4(o.x,o.y,o.z,1)).applyMatrix4(s),o.applyMatrix4(r),o.divideScalar(o.w),o.x=l/2+o.x*l/2,o.y=h/2-o.y*h/2,n.push(new t.Vector2(Math.round(o.x),Math.round(o.y)));return n}}})),define("DS/FlyWalkNavigation/NavigationClock",[],(function(){"use strict";function t(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}return t.prototype={constructor:t,start:function(){this.startTime=(performance||Date).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var t=0;if(this.autoStart&&!this.running&&this.start(),this.running){var e=(performance||Date).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}},t})),define("DS/FlyWalkNavigation/NavigationService",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/Visualization/TrackballControls","DS/FlyWalkNavigation/NavigationClock","DS/VirtualDevice/Joystick","DS/FlyWalkNavigation/NavigationRunloop","DS/FlyWalkNavigation/NavigationAnnotationUtils","DS/Core/PointerEvents","DS/ApplicationFrame/CommandsManager","DS/Visualization/PathElement","DS/FlyWalkNavigation/HoldStayCustomGesture","DS/VisuEvents/ScreenEvent","DS/Visualization/SceneGraphFactory","DS/WebappsUtils/WebappsUtils","DS/Mesh/Mesh","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/ManipulatorManager","DS/RuntimeView/NLSManager","DS/Visualization/CollisionServices","DS/Visualization/ModelLoader","DS/Visualization/Node3D","DS/Selection/PSOManager","DS/Visualization/Viewpoint","DS/FlyWalkInfra/CollisionPrefStorageCtlr","DS/CoreEvents/Events"],(function(t,e,i,o,n,a,s,r,l,h,c,u,d,v,_,p,g,m,w,y,S,f,b,V,C,T){"use strict";var D="true"===localStorage.getItem("WalkFreeFall"),M="true"===localStorage.getItem("WalkCollisionCubes"),k=localStorage.getItem("WalkCollisionPixelCulling");k=null==k?0:k;var P="true"===localStorage.getItem("WalkForcePCMode"),x=(localStorage.getItem("WalkDisableSimpleTeleport"),3),L=6,N=1,A=2,I=3,O=1,B=2,E=1,G=2,F=1,z=2,U=200,K=300,R=1e3;function H(t,e,i,o){this.linearMoveDistanceX=t,this.linearMoveDistanceY=e,this.angularMoveDistanceX=i,this.angularMoveDistanceY=o}var W=null,j=null;return t.extend({init:function(t){this._parent(t),this._webGLV6Viewer=null,this._domElement=null,this._evtTokenMouse=[],this._evtTokenTouch=[],this._evtTokenKeybd=[],this.speedSliderCB=t.speedSliderCB,this.updateHeightSlider=t.updateHeightSlider,this.navigationCtx=t.navigCtx,this.isOnCloud=t.isOnCloud,this.setSelectionCallBack=t.setSelectionCallBack,this.turnOfCollisionCB=t.turnOfCollisionCB,this.updateTopMsgCB=null,t.updateTopMsgCB&&(this.updateTopMsgCB=t.updateTopMsgCB),this.sendUsageEventsCB=null,t.sendUsageEvtCB&&(this.sendUsageEventsCB=t.sendUsageEvtCB),void 0===i._isInit&&i.init(),this._viewerFrame=this.navigationCtx.visViewerFrame,this._webGLV6Viewer=this.navigationCtx.visViewer,this._currentViewpoint=this._webGLV6Viewer.currentViewpoint,this._UIFrame_V1=this.navigationCtx.UIFrame_V1,this.bBoxViewerFrame=this.navigationCtx.visViewerFrameBox,this._domElement=void 0!==this._webGLV6Viewer?this._webGLV6Viewer.canvas:document,this._cursorPositionRel={x:0,y:0},this._picking={},this._prePicking={},this.setNavigationStates(),this.createReframe(),this.hideReframe(),this._setBBox(),this._currentUpAttribute="z",this._gravity=new e.Vector3(0,0,-1),this._groundHeight=(this.bBox.max.z+this.bBox.min.z)/2,"y"===this._currentUpAttribute&&(this._groundHeight=(this.bBox.max.y+this.bBox.min.y)/2),this.handleToNLS=null,this.NAVIGATION_MODE="Walk",this.LM_GesturesData={LM_Down_State:L,LM_Down_time:0,LM_Up_State:L,LM_Up_time:0},this.inTouchTransit=!1,i.addCustomGesture("onCustomHoldStay",u,[]),this.isTouchTeleportTransit=!1,this._downCursorPosition=null,this._cursorPosition=null,this._cursorMovement={x:0,y:0},this._teleportTransitionPossible=!1,this._teleportTransitionActive=!1,this._forwardTransitionWalkActive=!1,this._selectionTimer=null,this._teleportTimer=null,this._navigationTimer=null,this._teleportPosition=null,this._teleportGroundHeight=null,this._teleportIconNode=null,this._teleportGroundIconNode=null,this._teleportIconTextNode=null,this._teleportIconRectNode=null,this._teleportIconShown=!1,this._teleportIconOnTouch=!1,this.TeleportLabel="Release to Teleport",this.tokenReframeEndMove=null,this.contextMenuShown=!1,this.viewerState={TrapSelectionState:!0,TrackballNavigationState:!0,PreHighlightDisplay:!0,PickingCB_Activated:!0,ViewpointController:"COMBINED",ViewpointMouseInertia:!1,ViewpointTouchInertia:!1,ViewpointAngle:45,MouseWheelActiveState:!0},this.teleportUIMainContainer=null,this.teleportUIContainer=null,this.teleportUILabelMainContainer=null,this.teleportLabel=null,this._keyStateMap=new Map,this.leftJoyStickData=new H(0,0,0,0),this.rightJoyStickData=new H(0,0,0,0),this.isCollisionON=!1,this.isThirdPersonON=!1,this.isAvatarON=!1,this.isVerticalCollisionON=!0,this.isPointerLockON=!1,this.preventFreeFall=!D,this.isPointCloudMode=!1,this.isAutoSelectGround=!0,this.displayDebugCubeOOCCollision=M,this.oocPixelCulling=k,this.fakeOOCCollision=!1,this.collisionService=null,this.isCollisionHappened=!1,this.avatarNode=null,this.avatarPosition=null,this.avatarDistance=3e3,this.avatarHeight=1800,this.avatarHeightWidthFactor=5/18,this.avatarWidth=this.avatarHeight*this.avatarHeightWidthFactor,this.avatarHead=0,this.avatarFeet=400,this.collisionWidth=0,this.avatarToGround=50,this.eyePositionDueToCollision=new e.Vector3,this.viewpointMoveCBToken=null,this.isCrouched=!1,this.crouchFactor=.7,this.humanNode=null,this.safeMoveDistance=1e3,this.stepBackData={isFirstMove:!0,isValid:!1,vpInfo_T1:new function(t,e,i){this.eyePosition=t,this.sightDirection=e,this.upDirection=i,this.reset=function(){this.eyePosition=null,this.sightDirection=null,this.upDirection=null}},reset:function(){this.isValid=!1,this.vpInfo_T1.reset()}},this._loadExternalObjects()},_setBBox:function(){this.hideNodesForCollision(),this.bBox=this._webGLV6Viewer.getRootNode().bBox,this.unhideNodesAfterCollision();var t=this.bBox.max.x-this.bBox.min.x,e=this.bBox.max.y-this.bBox.min.y,i=this.bBox.max.z-this.bBox.min.z;this.bBoxRadius=Math.sqrt(t*t+e*e+i*i)},_getBbox:function(){return this.bBox||this._setBBox(),this.bBox},_isInsideBboxLimits:function(t){this.bBox||(this.bBox=this._getBbox());var e=t||.05*(this.bBox.max.x-this.bBox.min.x),i=this.bBox.max.x+e,o=this.bBox.min.x-e,n=t||.05*(this.bBox.max.y-this.bBox.min.y),a=this.bBox.max.y+n,s=this.bBox.min.y-n,r=t||.05*(this.bBox.max.z-this.bBox.min.z),l=this.bBox.max.z+r,h=this.bBox.min.z-r,c=this._currentViewpoint.getEyePosition();return this.isAvatarON&&this.avatarPosition&&(c=this.avatarPosition),o<c.x&&c.x<i&&s<c.y&&c.y<a&&h<c.z&&c.z<l},_getBboxDistance:function(){this.bBox||(this.bBox=this._getBbox());var t=new e.Vector3((this.bBox.max.x+this.bBox.min.x)/2,(this.bBox.max.y+this.bBox.min.y)/2,(this.bBox.max.z+this.bBox.min.z)/2),i=this._currentViewpoint.getEyePosition();this.isAvatarON&&this.avatarPosition&&(i=this.avatarPosition);var o=0,n=0;this.bBox.max.x<i.x?n=(i.x-this.bBox.max.x)/(i.x-t.x):i.x<this.bBox.min.x&&(n=(this.bBox.min.x-i.x)/(t.x-i.x));var a=0;this.bBox.max.y<i.y?a=(i.y-this.bBox.max.y)/(i.y-t.y):i.y<this.bBox.min.y&&(a=(this.bBox.min.y-i.y)/(t.y-i.y));var s=0;return this.bBox.max.z<i.z?s=(i.z-this.bBox.max.z)/(i.z-t.z):i.z<this.bBox.min.z&&(s=(this.bBox.min.z-i.z)/(t.z-i.z)),(o=n)<a&&(o=a),o<s&&(o=s),i.distanceTo(t)*o},_setGravity:function(){this._currentUpAttribute!==this._currentViewpoint.getWorldOrientation().upAttribute&&(this._currentUpAttribute=this._currentViewpoint.getWorldOrientation().upAttribute,"y"===this._currentUpAttribute?this._gravity=new e.Vector3(0,-1,0):this._gravity=new e.Vector3(0,0,-1))},setNavigationStates:function(){this._navigationState={pause:!1,pitch_up:!1,pitch_down:!1,yaw_right:!1,yaw_left:!1,roll_left:!1,roll_right:!1,head_rotate_mouse:!1,head_turn_mouse:!1,head_turn_keyboard:!1,move_forward_keyboard:!1,move_backward_keyboard:!1,move_forward_mouse:!1,move_backward_mouse:!1,move_forward_touch:!1,move_backward_touch:!1,mouse_active:!1,left_joystick_active:!1,right_joystick_active:!1,speed:50}},getRotationSpeed:function(t){var e=Math.PI/180*.035,i=this._getDominantDeviceForRotation();if(i===N)t===F?e*=this._cursorPositionRel.x:t===z&&(e*=this._cursorPositionRel.y);else if(i===I){var o=null;t===F?o=this.rightJoyStickData.angularMoveDistanceX:t===z&&(o=this.rightJoyStickData.angularMoveDistanceY),o&&(e=o>12?e/4*(o/12):0)}else(i!==A||!0!==this._navigationState.yaw_right&&!0!==this._navigationState.yaw_left&&!0!==this._navigationState.pitch_up&&!0!==this._navigationState.pitch_down)&&i===A&&!0===this._navigationState.head_turn_keyboard&&(e=!0===this.isPointerLockON?t===F&&this._cursorMovement.x<70?.03*e*this._cursorMovement.x:t===z&&this._cursorMovement.y<70?.03*e*this._cursorMovement.y:0:0);return e},_getDominantDeviceForRotation:function(){var t=-1;return!0===this._navigationState.right_joystick_active?t=I:!0===this._navigationState.mouse_active&&!0===this._navigationState.head_rotate_mouse?t=N:!0!==this.isKeyBoardActive()||!0!==this._navigationState.pitch_up&&!0!==this._navigationState.pitch_down&&!0!==this._navigationState.yaw_right&&!0!==this._navigationState.yaw_left?!0===this._navigationState.mouse_active&&!0===this._navigationState.head_turn_mouse?t=N:!0===this.isKeyBoardActive()&&!0===this._navigationState.head_turn_keyboard&&(t=A):t=A,t},_getTranslationSpeed:function(t){var e=this.bBoxRadius/1e4;e>3&&(e=3);var i=e;this._isInsideBboxLimits()||(i+=this._getBboxDistance()/1e3);if(i<e&&(i=e),this._navigationState.speed&&(i*=this._navigationState.speed/100),!0===this._navigationState.left_joystick_active){var o=null;t===F?o=this.leftJoyStickData.linearMoveDistanceX:t===z&&(o=this.leftJoyStickData.linearMoveDistanceY),o&&(o>12?i*=o/12:i=0)}return t===F&&(i/=4),i},_getAvatarPositionFromCamera:function(t){var e=t.clone();if(this.isAvatarON&&t){var i=this._currentViewpoint.getSightDirection();e=e.add(i.clone().multiplyScalar(this.avatarDistance))}return e},_getCameraFromAvatarPosition:function(t){var e=t.clone();if(this.isAvatarON&&t){var i=this._currentViewpoint.getSightDirection();e=e.sub(i.clone().multiplyScalar(this.avatarDistance))}return e},_onAnimationLoop:function(){this.OOCCollisionData&&this.updateTopMsg({boxLoading:this.OOCCollisionData.areBoxesLoading()}),!0!==this._navigationState.mouse_active&&!0!==this.isKeyBoardActive()||this._updatePositionForLinearAngularMove(),this._cursorMovement.x=0,this._cursorMovement.y=0},updatePositionFromTouchEvent:function(t){if(!this._webGLV6Viewer||!t)return!1;var e=(t.from&&t.from.length?t.from[0]:null).getCurrentPosition(this._domElement),i=this._webGLV6Viewer.getMousePosition(e);this._cursorPositionRel.x=i.x,this._cursorPositionRel.y=i.y,this._cursorPosition=e.clone()},updatePositionFromMouseEvent:function(t){if(!this._webGLV6Viewer||!t)return!1;var e=t.from&&t.from.length?t.from[0]:null,i=e.currentPosition,o=this._webGLV6Viewer.getMousePosition(i);this._cursorPositionRel.x=o.x,this._cursorPositionRel.y=o.y,this._cursorPosition=i.clone(),!0===this.isPointerLockON&&document.pointerLockElement?(this._cursorMovement.x=e.event.movementX,this._cursorMovement.y=-e.event.movementY):(this._cursorMovement.x=0,this._cursorMovement.y=0)},checkLookAt:function(){this.bSphere=this._webGLV6Viewer.getRootNode().bSphere;var t=r.onScreenProjection([this.bSphere.center],this._webGLV6Viewer);this.bBox||(this.bBox=this._getBbox());r.onScreenProjection(this.bBox.getPoints(),this._webGLV6Viewer),this._currentViewpoint.getEyePosition();var e=!1,i={x:50,y:50,angle:0};this.bBoxViewerFrame.left<t[0].x&&t[0].x<this.bBoxViewerFrame.right&&this.bBoxViewerFrame.top<t[0].y&&t[0].y<this.bBoxViewerFrame.bottom&&(e=!0,i.x=t[0].x%this.bBoxViewerFrame.bottom,i.y=t[0].y%this.bBoxViewerFrame.bottom);var o=this.bSphere.center.addScalar(this.bSphere.radius),n=r.onScreenProjection([o],this._webGLV6Viewer);Math.sqrt((n[0].x-t[0].x)*(n[0].x-t[0].x)+(n[0].y-t[0].y)*(n[0].y-t[0].y))/this.bBoxViewerFrame.width<.025&&(e=!1),this._isInsideBboxLimits()&&(e=!0),e?this.hideReframe():(this.bBoxViewerFrame.left<=t[0].x&&t[0].x<=this.bBoxViewerFrame.right?i.x=t[0].x:t[0].x<this.bBoxViewerFrame.left?(i.x=this.bBoxViewerFrame.left+64,i.angle=90):this.bBoxViewerFrame.right<t[0].x&&(i.x=this.bBoxViewerFrame.right-64,i.angle=-90),this.bBoxViewerFrame.top<=t[0].y&&t[0].y<=this.bBoxViewerFrame.bottom?i.y=t[0].y:t[0].y<this.bBoxViewerFrame.top?(i.y=this.bBoxViewerFrame.top+64,i.angle=180):this.bBoxViewerFrame.bottom<t[0].y&&(i.y=this.bBoxViewerFrame.bottom-64,i.angle=0),this.showReframe(i))},beginNavigation:function(t){var e=this;this._setBBox(),this.isPointCloudMode=this._isPointCloud(),this._groundHeight=C.getValue("GroundHeight"),this._originalTarget||(this._originalTarget=this._currentViewpoint.getTarget(),this._originalTarget.x=.5*(this.bBox.max.x+this.bBox.min.x),this._originalTarget.y=.5*(this.bBox.max.y+this.bBox.min.y),this._originalTarget.z=.5*(this.bBox.max.z+this.bBox.min.z)),this._setPickingForNavigation(),e.NAVIGATION_MODE="Walk",e.TOUCH_JOYSTICKS_ACTIVE=!1,e.KEYBOARD_ACTIVE=!1,this._heightConstraint=0,this._previousHeight=0,this._setKeybdEventsMap(),this.resetKeyboardStateMap(),this.subscribeViewpointMove(),this.updateWithNLSResources(),this._hideTeleportIcon(),null===this.collisionService&&(this.collisionService=y.setViewer(this._webGLV6Viewer)),this.applyCollisionPref(),this.stepBackData.reset(),this.OOCCollisionData||this.initOOCCollision(this._webGLV6Viewer._getOOCManager(),this.displayDebugCubeOOCCollision),this._animationLoopCB=new s({name:"flyWalkNavigation",data:this,func:this._onAnimationLoop}),e._animationLoopCB&&e._animationLoopCB.start(),this._currentViewpoint.onReframe((function t(){var i=e.isAvatarON;i&&(e.hideNodesForCollision(),e.isAvatarON=!1),e._currentViewpoint.onReframe(null),e._currentViewpoint.reframe(null,0),i&&(e.unhideNodesAfterCollision(),e.isAvatarON=!0,e._onThirdPersonModeChanged(!0),e._webGLV6Viewer.render()),e._currentViewpoint.onReframe(t)})),this._currentViewpoint.onCenterCamera((function(){})),this.touchMode=t.touchMode,!0===t.touchMode?this.beginTouchModeNavigation():this.beginMouseModeNavigation()},endNavigation:function(){this._currentViewpoint.onCenterCamera(null),this._currentViewpoint.onReframe(null),this.isPointCloudMode=!1,W=null,j=null,this.NAVIGATION_MODE="Walk",this.TOUCH_JOYSTICKS_ACTIVE=!1,this.KEYBOARD_ACTIVE=!1,this.endTouchModeNavigation(),this.endMouseModeNavigation(),this._unsetKeybdEventsMap(),this.resetKeyboardStateMap(),this.unsubscribeViewpointMove(),this.tokenReframeEndMove&&T.unsubscribe(this.tokenReframeEndMove),this.displayJoySticks(!1),this.destroyReframe(),this._destroyTeleportIcon(),this._animationLoopCB&&(this._animationLoopCB.stop(),this._animationLoopCB.dispose(),this._animationLoopCB=void 0),this._unsetPickingForNavigation(),this.avatarNode&&(this._onThirdPersonModeChanged(!1),this.destroyAvatarNode()),this.collisionService=null,this.endOOCCollision(),this.stepBackData.reset(),this._webGLV6Viewer.render()},_setPickingForNavigation:function(){this.storeViewerState(),this.setViewerState()},_unsetPickingForNavigation:function(){this.restoreViewerState(),this.resetStoredViewerState()},beginMouseModeNavigation:function(){this.setNavigationStates(),this._setMouseEventsMap(),this._setTouchEventsMap()},endMouseModeNavigation:function(){this.setNavigationStates(),this._unsetMouseEventsMap()},beginTouchModeNavigation:function(){this.setNavigationStates(),this.displayJoySticks(!0),this.setJoystickEventsMap(),this._setTouchEventsMap(),this.setSelectionCallBack("TouchMode",!0)},endTouchModeNavigation:function(){this.setNavigationStates(),this.unsetJoystickEventsMap(),this._unsetTouchEventsMap(),this.displayJoySticks(!1)},displayJoySticks:function(t){var e=this;if(t){e.joystickLeft=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-right-zone","pointer-events":"auto"}).inject(e._viewerFrame),e.joystickRight=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-left-zone","pointer-events":"auto"}).inject(e._viewerFrame);var i={left:{zone:document.getElementById("PlayWeb-joystick-ui-container-left-zone"),color:"black",mode:"static",position:{left:"15%",top:"75%"}},right:{zone:document.getElementById("PlayWeb-joystick-ui-container-right-zone"),color:"black",mode:"static",position:{left:"85%",top:"75%"}}};this._joystickLinearMove=new a.create(i.left),this._joystickAngularMove=new a.create(i.right),document.getElementById("PlayWeb-joystick-ui-container-left-zone").setStyle("pointer-events","auto"),document.getElementById("PlayWeb-joystick-ui-container-right-zone").setStyle("pointer-events","auto");var o=document.getElementsByClassName("front");Object.keys(o).forEach((function(t){o[t].style.background="white",o[t].style.opacity=1})),this.TOUCH_JOYSTICKS_ACTIVE=!0}else this._joystickLinearMove&&this._joystickLinearMove.destroy(),this._joystickAngularMove&&this._joystickAngularMove.destroy(),e.joystickLeft&&e.joystickRight&&(e.joystickLeft.destroy(),e.joystickRight.destroy()),e.joystickLeft=void 0,e.joystickRight=void 0,this._joystickLinearMove=void 0,this._joystickAngularMove=void 0,this.TOUCH_JOYSTICKS_ACTIVE=!1},createReframe:function(){this.reframeUIMainContainer=UWA.createElement("div",{id:"PlayWeb-reframe-ui-main-container"}).inject(this._UIFrame_V1),this.reframeUIContainer=UWA.createElement("div",{id:"PlayWeb-reframe-ui-container"}).inject(this.reframeUIMainContainer);var t=this;this.reframeUIContainer.addEvent(l.POINTERDOWN,(function(){t.lookAt()}))},destroyReframe:function(){this.reframeUIMainContainer&&(this.reframeUIContainer.removeEvent("click"),this.reframeUIMainContainer.destroy()),this.reframeUIMainContainer=void 0},showReframe:function(t){t&&(this.reframeUIContainer.setStyle("top",t.y+"px"),this.reframeUIContainer.setStyle("left",t.x+"px"),this.reframeUIContainer.style.transform="rotate("+t.angle+"deg)"),!this.reframeUIMainContainer||this.reframeUIMainContainer.show(),!this.reframeUIContainer||this.reframeUIContainer.show()},hideReframe:function(){this.reframeUIMainContainer&&(this.reframeUIMainContainer.hide(),this.reframeUIContainer.hide())},subscribeViewpointMove:function(){var t=this;this.viewpointMoveCBToken=this._currentViewpoint.onMove((function(){t._onViewpointMove()}))},unsubscribeViewpointMove:function(){this.viewpointMoveCBToken&&this._currentViewpoint.unsubscribe(this.viewpointMoveCBToken)},_onViewpointMove:function(){this.isAvatarON&&this.positionAvatarNode()},_onLeftMouseDown:function(t){var e=this;if(e._resetTimers(),t.gesture.getEvents().length>0){e.LM_GesturesData.LM_Down_State=x,e.LM_GesturesData.LM_Down_time=t.gesture.getEvents()[0].currentTime;var i=t.from&&t.from.length?t.from[0].event:null;i&&(e.LM_GesturesData.LM_Down_time=i.timeStamp)}this.updatePositionFromMouseEvent(t),this._downCursorPosition=this._cursorPosition.clone(),this._teleportIconOnTouch=!1,this._teleportPosition=null,this._teleportGroundHeight=null;var n=e._webGLV6Viewer.currentViewpoint.control.getManipulationState();n!==o.State.FORCE_ZOOM&&n!==o.State.FORCE_PAN&&n!==o.State.FORCE_ROTATE&&(e._teleportTransitionPossible=!0),e._selectionTimer=setTimeout((function(){if(!0===e._teleportTransitionPossible){e._teleportTransitionActive=!0;var t=e._getTeleportPosition(e._downCursorPosition);e._showTeleportIcon(t),e._webGLV6Viewer.setCursor("Auto",0),e._teleportTimer=setTimeout((function(){e._resetTimers(),e._teleportTransitionPossible=!1,e._teleportTransitionActive=!1,e._isInsideBboxLimits(2*e.avatarHeight)?e._forwardTransitionWalkActive=!0:e._forwardTransitionWalkActive=!1,e._hideTeleportIcon(),e._resetLeftMouseGesturesData(),e.navigate=!0,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!0),e._navigationState.move_forward_mouse=!0,e._navigationState.head_turn_mouse=!0,e._navigationState.mouse_active=!0,e.updateLoadingState(),e.setPreHighLightDisplay(!1)}),700)}}),K)},_onLeftMouseUp:function(t){var e=this;if(e._resetTimers(),t.gesture.getEvents().length>0){e.LM_GesturesData.LM_Up_State=x,e.LM_GesturesData.LM_Up_time=t.gesture.getEvents()[0].currentTime;var i=t.from&&t.from.length?t.from[0].event:null;i&&(e.LM_GesturesData.LM_Up_time=i.timeStamp)}e.updatePositionFromMouseEvent(t),!0===e._teleportTransitionActive&&(e._hideTeleportIcon(),e._teleport(this._teleportPosition,this._teleportGroundHeight)),e._teleportTransitionPossible=!1,e._teleportTransitionActive=!1,e._navigationState.move_forward_mouse=!1,e._navigationState.head_turn_mouse=!1,e._navigationState.mouse_active=!1,e.updateLoadingState(),e._teleportTransitionActive=!1,e.navigate=!1,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!1),e._resetLeftMouseGesturesData(),e._hideTeleportIcon(),e.setPreHighLightDisplay(!0)},_onRightMouseDown:function(t){var e=this;e._resetTimers(),e.updatePositionFromMouseEvent(t),this._downCursorPosition=this._cursorPosition.clone(),e._zoomTimer=setTimeout((function(){e._resetTimers(),e.navigate=!0,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!0),e._navigationState.move_backward_mouse=!0,e._navigationState.head_turn_mouse=!0,e._navigationState.mouse_active=!0,e.updateLoadingState(),e.setPreHighLightDisplay(!1)}),K)},_onRightMouseUp:function(t){var e=this;e._resetTimers(),e.updatePositionFromMouseEvent(t),e._navigationState.move_backward_mouse=!1,e._navigationState.head_turn_mouse=!1,e._navigationState.mouse_active=!1,e.updateLoadingState(),e.navigate=!1,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!1),e.setPreHighLightDisplay(!0)},_onMiddleMouseDown:function(t){var e=this;e._resetTimers(),e.updatePositionFromMouseEvent(t),this._downCursorPosition=this._cursorPosition.clone(),e._panTimer=setTimeout((function(){e._resetTimers(),e.navigate=!0,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!0),e._navigationState.head_rotate_mouse=!0,e._navigationState.mouse_active=!0,e.updateLoadingState()}),K)},_onMiddleMouseUp:function(t){var e=this;e._resetTimers(),e.checkLookAt(),e._navigationState.head_rotate_mouse=!1,e._navigationState.mouse_active=!1,e.updateLoadingState(),e.navigate=!1,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!1)},_onMouseMove:function(t){var e=this;e.updatePositionFromMouseEvent(t),e._downCursorPosition&&e._cursorPosition&&(e._downCursorPosition.x>e._cursorPosition.x+10||e._downCursorPosition.x<e._cursorPosition.x-10||e._downCursorPosition.y>e._cursorPosition.y+10||e._downCursorPosition.y<e._cursorPosition.y-10)&&(!0===e._teleportTransitionActive?(e._resetLeftMouseGesturesData(),e.navigate=!0,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!0),e._navigationState.move_forward_mouse=!0,e._navigationState.head_turn_mouse=!0,e._navigationState.mouse_active=!0,e.updateLoadingState(),e._teleportTransitionActive=!1,e._teleportTransitionPossible=!1,e._resetTimers(),e._hideTeleportIcon(),e.setPreHighLightDisplay(!1)):(e._resetLeftMouseGesturesData(),e._resetTimers()))},_onMouseWheel:function(t){var e=this;if(t.gesture){var i=t.gesture.delta,o=e.isAvatarON,n=e.avatarDistance;if(i>0?!0===e.isAvatarON&&(e.avatarDistance<=1e3?e.isAvatarON=!1:e.avatarDistance-=1e3*i):i<0&&(!1===e.isAvatarON&&e.avatarDistance<=1e3?e.isAvatarON=!0:e.avatarDistance-=1e3*i,e.avatarDistance>5e3&&(e.avatarDistance=5e3)),!0===e.isAvatarON&&(this._webGLV6Viewer.currentViewpoint.control._avatarDistance=e.avatarDistance),e.isAvatarON!==o)e._onThirdPersonModeChanged(e.isAvatarON);else if(!0===e.isAvatarON&&e.avatarDistance!==n){e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop();var a=e._currentViewpoint.getEyePosition(),s=e._currentViewpoint.getSightDirection().clone(),r=a.clone().sub(s.multiplyScalar(e.avatarDistance-n));e._currentViewpoint.setEyePosition(r)}}},_onTouchDown:function(t){var e=this;if(e._resetTimers(),t.gesture.getEvents().length>0){e.LM_GesturesData.LM_Down_State=x,e.LM_GesturesData.LM_Down_time=t.gesture.getEvents()[0].currentTime;var i=t.from&&t.from.length?t.from[0].event:null;i&&(e.LM_GesturesData.LM_Down_time=i.timeStamp)}this.updatePositionFromTouchEvent(t),this._downCursorPosition=this._cursorPosition.clone(),this._teleportIconOnTouch=!0,this._teleportPosition=null,this._teleportGroundHeight=null;var n=e._webGLV6Viewer.currentViewpoint.control.getManipulationState();n!==o.State.FORCE_ZOOM&&n!==o.State.FORCE_PAN&&n!==o.State.FORCE_ROTATE&&(e._teleportTransitionPossible=!0),e._selectionTimer=setTimeout((function(){if(!0===e._teleportTransitionPossible){e._teleportTransitionActive=!0;var t=e._getTeleportPosition(e._downCursorPosition);e._showTeleportIcon(t),e._webGLV6Viewer.setCursor("Auto",0),e._teleportTimer=setTimeout((function(){e._teleportTransitionPossible=!1,e._teleportTransitionActive=!1,e._isInsideBboxLimits(2*e.avatarHeight)?e._forwardTransitionWalkActive=!0:e._forwardTransitionWalkActive=!1,e._hideTeleportIcon(),e._resetLeftMouseGesturesData(),e._navigationTimer=setTimeout((function(){if(e._resetTimers(),e.navigationCtx.isWAFR_V2){let t=e.navigationCtx.executionContext.getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager();t&&t.hideContextualMenus()}else e.navigationCtx.frameWindow.getContextualUIManager().hideContextualMenus();e.navigate=!0,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!0),e._navigationState.move_forward_mouse=!0,e._navigationState.head_turn_mouse=!0,e._navigationState.mouse_active=!0,e.updateLoadingState(),e.setPreHighLightDisplay(!1)}),1500)}),700)}}),K)},_onTouchUp:function(t){var e=this;if(e._resetTimers(),t.gesture.getEvents().length>0){e.LM_GesturesData.LM_Up_State=x,e.LM_GesturesData.LM_Up_time=t.gesture.getEvents()[0].currentTime;var i=t.from&&t.from.length?t.from[0].event:null;i&&(e.LM_GesturesData.LM_Up_time=i.timeStamp)}this.updatePositionFromTouchEvent(t);this.LM_GesturesData.LM_Up_time,this.LM_GesturesData.LM_Down_time;!0===e._teleportTransitionActive&&(e._hideTeleportIcon(),e._teleport(this._teleportPosition,this._teleportGroundHeight)),e._teleportTransitionPossible=!1,e._teleportTransitionActive=!1,e._navigationState.move_forward_mouse=!1,e._navigationState.head_turn_mouse=!1,e._navigationState.mouse_active=!1,e.updateLoadingState(),e.navigate=!1,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!1),e._resetLeftMouseGesturesData(),e._hideTeleportIcon(),e.setPreHighLightDisplay(!0)},_onTouchMove:function(t){var e=this;this.updatePositionFromTouchEvent(t),!0!==e._navigationState.left_joystick_active&&!0!==e._navigationState.right_joystick_active&&e._downCursorPosition&&e._cursorPosition&&(e._downCursorPosition.x>e._cursorPosition.x+10||e._downCursorPosition.x<e._cursorPosition.x-10||e._downCursorPosition.y>e._cursorPosition.y+10||e._downCursorPosition.y<e._cursorPosition.y-10)&&(!0===e._teleportTransitionActive?(e._resetLeftMouseGesturesData(),e.navigate=!0,e._webGLV6Viewer.currentViewpoint.getControl().setFlyWalkState(!0),e._navigationState.move_forward_mouse=!0,e._navigationState.head_turn_mouse=!0,e._navigationState.head_turn_mouse=!0,e._navigationState.mouse_active=!0,e.updateLoadingState(),e._teleportTransitionActive=!1,e._teleportTransitionPossible=!1,e._resetTimers(),e._hideTeleportIcon(),e.setPreHighLightDisplay(!1)):(e._resetLeftMouseGesturesData(),e._resetTimers()))},_onKeybdDownForward:function(t){var e=this;e._isInsideBboxLimits(2*e.avatarHeight)?e._forwardTransitionWalkActive=!0:e._forwardTransitionWalkActive=!1,e.updateLoadingState(),e._navigationState.move_forward_keyboard=!0,!1===e._navigationState.head_turn_keyboard&&!0===this.isPointerLockON&&e._webGLV6Viewer.canvas.requestPointerLock&&(e._webGLV6Viewer.canvas.requestPointerLock(),e._navigationState.head_turn_keyboard=!0),e.setPreHighLightDisplay(!1)},_onKeybdUpForward:function(t){var e=this;e.updateLoadingState(),e._navigationState.move_forward_keyboard=!1,!1===e.isKeyBoardActive()&&(e._navigationState.head_turn_keyboard=!1,!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_onKeybdDownBackward:function(t){var e=this;e._isInsideBboxLimits(2*e.avatarHeight)?e._forwardTransitionWalkActive=!0:e._forwardTransitionWalkActive=!1,e.updateLoadingState(),e._navigationState.move_backward_keyboard=!0,!1===e._navigationState.head_turn_keyboard&&!0===this.isPointerLockON&&e._webGLV6Viewer.canvas.requestPointerLock&&(e._webGLV6Viewer.canvas.requestPointerLock(),e._navigationState.head_turn_keyboard=!0),e.setPreHighLightDisplay(!1)},_onKeybdUpBackward:function(t){var e=this;e.updateLoadingState(),e._navigationState.move_backward_keyboard=!1,!1===e.isKeyBoardActive()&&(e._navigationState.head_turn_keyboard=!1,!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_onKeybdDownLeftStrafe:function(t){var e=this;e.updateLoadingState(),e._navigationState.roll_left=!0,!1===e._navigationState.head_turn_keyboard&&!0===this.isPointerLockON&&e._webGLV6Viewer.canvas.requestPointerLock&&(e._webGLV6Viewer.canvas.requestPointerLock(),e._navigationState.head_turn_keyboard=!0),e.setPreHighLightDisplay(!1)},_onKeybdUpLeftStrafe:function(t){var e=this;e.updateLoadingState(),e._navigationState.roll_left=!1,!1===e.isKeyBoardActive()&&(e._navigationState.head_turn_keyboard=!1,!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_onKeybdDownRightStrafe:function(t){var e=this;e.updateLoadingState(),e._navigationState.roll_right=!0,!1===e._navigationState.head_turn_keyboard&&!0===this.isPointerLockON&&e._webGLV6Viewer.canvas.requestPointerLock&&(e._webGLV6Viewer.canvas.requestPointerLock(),e._navigationState.head_turn_keyboard=!0),e.setPreHighLightDisplay(!1)},_onKeybdUpRightStrafe:function(t){var e=this;e.updateLoadingState(),e._navigationState.roll_right=!1,!1===e.isKeyBoardActive()&&(e._navigationState.head_turn_keyboard=!1,!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_onKeybdDownPitchUp:function(t){var e=this;e.updateLoadingState(),e._navigationState.pitch_up=!0,!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e._navigationState.head_turn_keyboard=!1,e.setPreHighLightDisplay(!1)},_onKeybdUpPitchUp:function(t){var e=this;e.updateLoadingState(),e._navigationState.pitch_up=!1,!1===e.isKeyBoardActive()&&(e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_onKeybdDownPitchDown:function(t){var e=this;e.updateLoadingState(),e._navigationState.pitch_down=!0,e.setPreHighLightDisplay(!1),!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e._navigationState.head_turn_keyboard=!1},_onKeybdUpPitchDown:function(t){var e=this;e.updateLoadingState(),e._navigationState.pitch_down=!1,!1===e.isKeyBoardActive()&&(e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_onKeybdDownYawLeft:function(t){var e=this;e.updateLoadingState(),e._navigationState.yaw_left=!0,e.setPreHighLightDisplay(!1),!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e._navigationState.head_turn_keyboard=!1},_onKeybdUpYawLeft:function(t){var e=this;e.updateLoadingState(),e._navigationState.yaw_left=!1,!1===e.isKeyBoardActive()&&(e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_onKeybdDownYawRight:function(t){var e=this;e.updateLoadingState(),e._navigationState.yaw_right=!0,e.setPreHighLightDisplay(!1),!0===this.isPointerLockON&&document.exitPointerLock&&document.exitPointerLock(),e._navigationState.head_turn_keyboard=!1},_onKeybdUpYawRight:function(t){var e=this;e.updateLoadingState(),e._navigationState.yaw_right=!1,!1===e.isKeyBoardActive()&&(e.setPreHighLightDisplay(!0),e._currentViewpoint._viewpointAnimation&&e._currentViewpoint._viewpointAnimation.stop())},_setMouseEventsMap:function(){var t=this,e=!1;this._evtTokenMouse=[];let o=null;o=this.navigationCtx.isWAFR_V2?this._webGLV6Viewer.canvas:this._viewerFrame,this._evtTokenMouse.push(i.addEvent(o,"onLeftMouseDown",(function(i){i.gesture.getEvents().length>0&&i.gesture.getEvents()[0].getJSEvent().shiftKey?(t._onRightMouseDown(i),e=!0):t._onLeftMouseDown(i)}))),this._evtTokenMouse.push(i.addEvent(document,"onLeftMouseUp",(function(i){e?(t._onRightMouseUp(i),e=!1):t._onLeftMouseUp(i)}))),this._evtTokenMouse.push(i.addEvent(o,"onRightMouseDown",(function(i){i.gesture.getEvents().length>0&&i.gesture.getEvents()[0].getJSEvent().shiftKey?(t._onLeftMouseDown(i),e=!0):t._onRightMouseDown(i)}))),this._evtTokenMouse.push(i.addEvent(document,"onRightMouseUp",(function(i){e?(t._onLeftMouseUp(i),e=!1):t._onRightMouseUp(i)}))),this._evtTokenMouse.push(i.addEvent(o,"onMiddleMouseDown",(function(e){t._onMiddleMouseDown(e)}))),this._evtTokenMouse.push(i.addEvent(o,"onMiddleMouseUp",(function(e){t._onMiddleMouseUp(e)}))),this._evtTokenMouse.push(i.addEvent(o,"onMouseMove",(function(e){t._onMouseMove(e)}))),this._evtTokenMouse.push(i.addEvent(o,"onMouseWheel",(function(e){t._onMouseWheel(e)}))),this._evtTokenMouse.push(i.addEvent(o,"onCustomHoldStay",(function(e){if(!0!==t._navigationState.left_joystick_active&&!0!==t._navigationState.right_joystick_active){if(e.from[0].getState()===d.State.END&&t.isTouchTeleportTransit)return t._hideTeleportIcon(),t._teleport(this._teleportPosition,this._teleportGroundHeight),t.isTouchTeleportTransit=!1,void(t.contextMenuShown=!1);if(e.from[0].getState()===d.State.END)return t._hideTeleportIcon(),t.isTouchTeleportTransit=!1,void(t.contextMenuShown=!1);if(e.gesture){if(e.gesture.getElapsedTime()>K&&e.gesture.getElapsedTime()<R)return t.showTeleport(e),void(t.isTouchTeleportTransit=!0);if(e.gesture.getElapsedTime()>R)return t._hideTeleportIcon(),void(t.isTouchTeleportTransit=!1)}}})))},_unsetMouseEventsMap:function(){this._evtTokenMouse&&(this._evtTokenMouse.forEach((function(t){i.removeEventFromToken(t)})),this._evtTokenMouse=void 0)},_setTouchEventsMap:function(){var t=this;let e=null;e=this.navigationCtx.isWAFR_V2?this._webGLV6Viewer.canvas:this._viewerFrame,this._evtTokenTouch=[],this._evtTokenTouch.push(i.addEvent(e,"onTouch",(function(e){!0!==t._navigationState.left_joystick_active&&!0!==t._navigationState.right_joystick_active&&(i.getTouchEvents().length>1?t._onTouchUp(e):t._onTouchDown(e))}))),this._evtTokenTouch.push(i.addEvent(document,"onRelease",(function(e){!0!==t._navigationState.left_joystick_active&&!0!==t._navigationState.right_joystick_active&&t._onTouchUp(e)}))),this._evtTokenTouch.push(i.addEvent(e,"onSwipe",(function(e){t._onTouchMove(e)})))},_unsetTouchEventsMap:function(){this._evtTokenTouch&&(this._evtTokenTouch.forEach((function(t){i.removeEventFromToken(t)})),this._evtTokenTouch=void 0)},_setKeybdEventsMap:function(){var t=this;this._evtTokenKeybd=[],this._evtTokenKeybd.push(i.addEvent(this._viewerFrame,"onKeyDown",(function(e){switch(e.gesture.events[0].event.code||e.gesture.events[0].event.keyCode){case"KeyW":t.updateKeyboardUsage("KeyW",B),t._onKeybdDownForward(e);break;case"KeyS":t.updateKeyboardUsage("KeyS",B),t._onKeybdDownBackward(e);break;case"KeyA":t.updateKeyboardUsage("KeyA",B),t._onKeybdDownLeftStrafe(e);break;case"KeyD":t.updateKeyboardUsage("KeyD",B),t._onKeybdDownRightStrafe(e);break;case"KeyI":t.updateKeyboardUsage("KeyI",B),t._onKeybdDownPitchUp(e);break;case"KeyK":t.updateKeyboardUsage("KeyK",B),t._onKeybdDownPitchDown(e);break;case"KeyJ":t.updateKeyboardUsage("KeyJ",B),t._onKeybdDownYawLeft(e);break;case"KeyL":t.updateKeyboardUsage("KeyL",B),t._onKeybdDownYawRight(e)}switch(e.gesture.key){case 107:case 187:t.updateSpeed(5);break;case 109:case 189:t.updateSpeed(-5);break;case 37:t.updateKeyboardUsage("37",B),t._onKeybdDownLeftStrafe(e);break;case 38:t.updateKeyboardUsage("38",B),t._onKeybdDownForward(e);break;case 39:t.updateKeyboardUsage("39",B),t._onKeybdDownRightStrafe(e);break;case 40:t.updateKeyboardUsage("40",B),t._onKeybdDownBackward(e)}}))),this._evtTokenKeybd.push(i.addEvent(this._viewerFrame,"onKeyUp",(function(e){switch(e.gesture.events[0].event.code||e.gesture.events[0].event.keyCode){case"KeyW":t.updateKeyboardUsage("KeyW",O),t._onKeybdUpForward(e);break;case"KeyS":t.updateKeyboardUsage("KeyS",O),t._onKeybdUpBackward(e);break;case"KeyA":t.updateKeyboardUsage("KeyA",O),t._onKeybdUpLeftStrafe(e);break;case"KeyD":t.updateKeyboardUsage("KeyD",O),t._onKeybdUpRightStrafe(e);break;case"KeyI":t.updateKeyboardUsage("KeyI",O),t._onKeybdUpPitchUp(e);break;case"KeyK":t.updateKeyboardUsage("KeyK",O),t._onKeybdUpPitchDown(e);break;case"KeyJ":t.updateKeyboardUsage("KeyJ",O),t._onKeybdUpYawLeft(e);break;case"KeyL":t.updateKeyboardUsage("KeyL",O),t._onKeybdUpYawRight(e);break;case"KeyT":t.isThirdPersonON=!t.isThirdPersonON,C.setValue("ThirdPersonMode",t.isThirdPersonON),C.commit(),t.avatarDistance=3e3,t.isAvatarON=t.isThirdPersonON,t._onThirdPersonModeChanged(t.isAvatarON);break;case"KeyC":t.crouch();break;case"KeyR":t.stepBack();break;case"KeyP":var i=C.getValue("InitialPositionMode");C.setValue("InitialPositionMode",!i),C.commit(),T.publish({event:"VisFlyWalk/onInitPosModeChange",data:{eventChannel:"VisFlyWalk/onInitPosModeChange",eventType:"@onInitPosModeChange"}})}switch(e.gesture.key){case 37:t.updateKeyboardUsage("37",O),t._onKeybdUpLeftStrafe(e);break;case 38:t.updateKeyboardUsage("38",O),t._onKeybdUpForward(e);break;case 39:t.updateKeyboardUsage("39",O),t._onKeybdUpRightStrafe(e);break;case 40:t.updateKeyboardUsage("40",O),t._onKeybdUpBackward(e)}})))},_unsetKeybdEventsMap:function(){this._evtTokenKeybd&&(this._evtTokenKeybd.forEach((function(t){i.removeEventFromToken(t)})),this._evtTokenKeybd=void 0)},resetKeyboardStateMap:function(){this._keyStateMap.set("KeyW",0),this._keyStateMap.set("KeyS",0),this._keyStateMap.set("KeyA",0),this._keyStateMap.set("KeyD",0),this._keyStateMap.set("KeyI",0),this._keyStateMap.set("KeyK",0),this._keyStateMap.set("KeyJ",0),this._keyStateMap.set("KeyL",0),this._keyStateMap.set("37",0),this._keyStateMap.set("38",0),this._keyStateMap.set("39",0),this._keyStateMap.set("40",0)},updateKeyboardUsage:function(t,e){this._keyStateMap.set(t,e)},isKeyBoardActive:function(){var t=!1;return this._keyStateMap.forEach((function(e){e===B&&(t=!0)})),t},updateSpeed:function(t){"number"==typeof t&&this._navigationState.speed&&this._navigationState.speed+t>0&&this._navigationState.speed+t<=100&&(this._navigationState.speed+=t,this.speedSliderCB(this._navigationState.speed))},_computeModelIntersection:function(t){var e=null,i=null;this.avatarNode&&(this.avatarVisibility=this.avatarNode.isVisible(),this.avatarNode.setVisibility(!1),this._webGLV6Viewer.render());let o=this._webGLV6Viewer.pick(this._webGLV6Viewer.getMousePosition(t),"mesh",3);return o&&o.position&&o.normal&&(e=o.position.clone(),i=o.normal.clone()),this.avatarVisibility&&this.avatarNode.setVisibility(this.avatarVisibility),{intersectionPoint:e,intersectionNormal:i}},_computeModelIntersection_Precise:function(t){var e=null,i=null;this.hideNodesForCollision();var o=new THREEDS.Core.Vector3;null===this.collisionService&&(this.collisionService=y.setViewer(this._webGLV6Viewer));var n=C.getValue("EnableTransparent");n||(this.collisionService.skipTransparentItems=!1);var a=y.getPrecisePositionAtPick(this._webGLV6Viewer.getMousePosition(t),o);return n||(this.collisionService.skipTransparentItems=!0),this.unhideNodesAfterCollision(),a&&(e=a.clone(),i=o.clone()),{intersectionPoint:e,intersectionNormal:i}},_computeGroundIntersection:function(t){var i=null,o=this._currentViewpoint.getEyePosition(),n=this._currentViewpoint.camera.getLookAt(),a=this._gravity.clone().multiplyScalar(-1),s=new e.Plane(a,-this._groundHeight),r=new e.Vector3(this._webGLV6Viewer.getMousePosition(t).x,this._webGLV6Viewer.getMousePosition(t).y,.5);return(new e.Projector).unprojectVector(r,this._currentViewpoint.camera),(i=new e.Ray(o,r.clone().sub(o).normalize()).intersectPlane(s)).clone().sub(o).dot(n)<=0&&(i=null),i},_computeCursorIntersection:function(t){var i=new e.Vector3(this._webGLV6Viewer.getMousePosition(t).x,this._webGLV6Viewer.getMousePosition(t).y,.5);return(new e.Projector).unprojectVector(i,this._currentViewpoint.camera),i},_getTeleportPosition:function(t){var e=this._currentViewpoint.getEyePosition();this.isAvatarON&&this.avatarPosition&&(e=this.avatarPosition);this._currentViewpoint.camera.getLookAt();var i=null,o=(i=this.isPointCloudMode?this._computeModelIntersection(t):this._computeModelIntersection_Precise(t)).intersectionPoint,n=i.intersectionNormal,a=this._computeGroundIntersection(t),s=this._computeCursorIntersection(t),r=null,l=null,h=this._groundHeight,c=this.isWalkSimpleTeleportMode();if(c&&o)l=o.clone(),(r=o.clone()).add(this._gravity.clone().multiplyScalar(.95*-this.avatarHeight));else if(!c&&o){l=o,r=o.clone();var u=o.clone().sub(e);"Walk"===this.NAVIGATION_MODE&&u.sub(this._gravity.clone().multiplyScalar(u.clone().dot(this._gravity))),u.normalize(),u.setLength(1500);var d=h-r.dot(this._gravity.clone().multiplyScalar(-1)),v=e.dot(this._gravity.clone().multiplyScalar(-1))-r.dot(this._gravity.clone().multiplyScalar(-1));"Fly"===this.NAVIGATION_MODE?r.sub(u):"Walk"===this.NAVIGATION_MODE&&(n.normalize(),n.dot(this._gravity)<-.8&&this.isAutoSelectGround?(r.add(this._gravity.clone().multiplyScalar(.95*-this.avatarHeight)),h=r.dot(this._gravity.clone().multiplyScalar(-1))-.95*this.avatarHeight):Math.abs(v)<2e3?(r.sub(u),r.add(this._gravity.clone().multiplyScalar(-v))):Math.abs(d)<1e3?r.add(this._gravity.clone().multiplyScalar(-d-this.avatarHeight)):r.sub(u))}else if(!c&&a)r=(l=a).clone().sub(this._gravity.clone().multiplyScalar(this.avatarHeight));else if(s){e=this._currentViewpoint.getEyePosition();var _=null;(_=s.clone().sub(e)).normalize(),l=e.clone().add(_.clone().multiplyScalar(5e3)),(_=s.clone().sub(e)).normalize();var p=_.clone();"Walk"===this.NAVIGATION_MODE&&p.sub(this._gravity.clone().multiplyScalar(_.clone().dot(this._gravity))),r=e.clone().add(p.clone().multiplyScalar(5e3))}return this._teleportPosition=r,this._teleportGroundHeight=h,l},_teleport:function(t,e){if(null!==t){this._groundHeight=e;var i=t.clone(),o=this._currentViewpoint.getTargetDistance(),n=1,a=this._getCameraFromAvatarPosition(i);if(this.isAvatarON&&this.avatarPosition&&(o=this.avatarDistance,n=0),a.add(this._gravity.clone().multiplyScalar(-1).setLength(this.avatarToGround)),!1===this.isCollisionON){var s;s={eyePosition:a,distanceToTarget:o,duration:500,interpolationType:n},this._currentViewpoint.moveTo(s),this.checkLookAt()}else{this._currentViewpoint._viewpointAnimation&&this._currentViewpoint._viewpointAnimation.stop(),this._currentViewpoint.setEyePosition(a);var r=this.getGroundDistanceFromAvatar();r&&this.repositionAvatarOnGround(r)}}},compute3DTeleportLocation:function(t){this._webGLV6Viewer.currentViewpoint.getSightDirection(),this._webGLV6Viewer.currentViewpoint.getTargetDistance();var i,o=this._webGLV6Viewer.currentViewpoint.getEyePosition(),n={},a={x:0,y:0,z:0};t.from&&"Touch"===t.from[0].type?i={x:t.from[0].currentPosition.x,y:t.from[0].currentPosition.y}:i=t.from?{x:t.from[0].getJSEvent().pageX,y:t.from[0].getJSEvent().pageY}:{};var s=this._webGLV6Viewer.pick(this._webGLV6Viewer.getMousePosition(i),"mesh",!0);if(s.path.length>0){n=s.position.clone();var r=new e.Vector3(n.x-o.x,n.y-o.y,n.z-o.z),l=r.length();return r.normalize(),a.x=n.x-r.x*l*.2,a.y=n.y-r.y*l*.2,a.z=n.z-r.z*l*.15,a}return null},setJoystickEventsMap:function(){var t=this,e=0,i=0,o=!1,n=null,a=0,s=0,r=!1,l=null;this._joystickLinearMove.on("start",(function(r,l){!0!==t.mouse_active&&(t._navigationState.left_joystick_active=!0,t._webGLV6Viewer.currentViewpoint.control.setZoomActive(!1),t._webGLV6Viewer.currentViewpoint.control.setPanActive(!1),t._webGLV6Viewer.currentViewpoint.control.setTouchRotationActive(!1),t._isInsideBboxLimits(2*t.avatarHeight)?t._forwardTransitionWalkActive=!0:t._forwardTransitionWalkActive=!1,n=setInterval((function(){o&&(1!=t._navigationState.roll_left&&1!=t._navigationState.roll_right&&1!=t._navigationState.move_forward_touch&&1!=t._navigationState.move_backward_touch||(t.updateLoadingState(),t.updateJoyStickData(e,i,a,s,E),t._updatePositionForLinearAngularMove()))}),1))})),this._joystickLinearMove.on("move",(function(n,r){!0!==t.mouse_active&&r&&r.direction&&r.angle.radian&&r.distance&&(e=r.distance*Math.cos(r.angle.radian),"left"===r.direction.x&&(e=-e),i=r.distance*Math.sin(r.angle.radian),"down"===r.direction.y&&(i=-i),o=!0,t._navigationState.move_forward_touch=!1,t._navigationState.move_backward_touch=!1,t._navigationState.roll_left=!1,t._navigationState.roll_right=!1,"up"===r.direction.y&&(t._navigationState.move_forward_touch=!0),"down"===r.direction.y&&(t._navigationState.move_backward_touch=!0),"left"===r.direction.x&&(t._navigationState.roll_left=!0),"right"===r.direction.x&&(t._navigationState.roll_right=!0),t._navigationState.left_joystick_active=!0,t.updateLoadingState(),t.updateJoyStickData(e,i,a,s,E),t._updatePositionForLinearAngularMove())})),this._joystickLinearMove.on("end",(function(o,a){!0!==t.mouse_active&&(t._navigationState.move_forward_touch=!1,t._navigationState.move_backward_touch=!1,t._navigationState.roll_left=!1,t._navigationState.roll_right=!1,t._navigationState.left_joystick_active=!1,t._webGLV6Viewer.currentViewpoint.control.setZoomActive(!0),t._webGLV6Viewer.currentViewpoint.control.setPanActive(!0),t._webGLV6Viewer.currentViewpoint.control.setTouchRotationActive(!0),t.updateLoadingState(),t.updateJoyStickData(0,0,0,0,E),e=0,i=0,n&&clearInterval(n))})),this._joystickAngularMove.on("start",(function(o,n){!0!==t.mouse_active&&(t._navigationState.right_joystick_active=!0,t._webGLV6Viewer.currentViewpoint.control.setZoomActive(!1),t._webGLV6Viewer.currentViewpoint.control.setPanActive(!1),t._webGLV6Viewer.currentViewpoint.control.setTouchRotationActive(!1),l=setInterval((function(o){r&&(1!=t._navigationState.yaw_left&&1!=t._navigationState.yaw_right&&1!=t._navigationState.pitch_up&&1!=t._navigationState.pitch_down||(t.updateLoadingState(),t.updateJoyStickData(e,i,a,s,G),t._updatePositionForLinearAngularMove()))}),1))})),this._joystickAngularMove.on("move",(function(o,n){!0!==t.mouse_active&&n&&n.direction&&n.angle.radian&&n.distance&&(a=n.distance*Math.cos(n.angle.radian),"left"===n.direction.x&&(a=-a),s=n.distance*Math.sin(n.angle.radian),"down"===n.direction.y&&(s=-s),r=!0,t._navigationState.yaw_left=!1,t._navigationState.yaw_right=!1,t._navigationState.pitch_up=!1,t._navigationState.pitch_down=!1,"up"===n.direction.y&&(t._navigationState.pitch_up=!0),"down"===n.direction.y&&(t._navigationState.pitch_down=!0),"left"===n.direction.x&&(t._navigationState.yaw_left=!0),"right"===n.direction.x&&(t._navigationState.yaw_right=!0),t._navigationState.right_joystick_active=!0,t.updateLoadingState(),t.updateJoyStickData(e,i,a,s,G),t._updatePositionForLinearAngularMove())})),this._joystickAngularMove.on("end",(function(o,n){!0!==t.mouse_active&&(t._navigationState.yaw_left=!1,t._navigationState.yaw_right=!1,t._navigationState.pitch_up=!1,t._navigationState.pitch_down=!1,t._navigationState.right_joystick_active=!1,t._webGLV6Viewer.currentViewpoint.control.setZoomActive(!0),t._webGLV6Viewer.currentViewpoint.control.setPanActive(!0),t._webGLV6Viewer.currentViewpoint.control.setTouchRotationActive(!0),t.updateLoadingState(),t.updateJoyStickData(e,i,a,s,G),a=0,s=0,l&&clearInterval(l))}))},boxLoadingErrorCB(t){let e=!1;if(t&&t.errors)for(let i=0;i<t.errors.length;i++)if("UNAUTHORIZED_REQUEST"==t.errors[i].code){e=!0;break}e?this.updateTopMsg("Unauthorized_Pod"):this.updateTopMsg("Server_Error")},initOOCCollision(t,i){var o=new f;this._webGLV6Viewer.getRootNode().addChild(o),o.setPickable(p.NOPICKABLE),this.OOCCollisionData={ooc:t,unloadDistance:3,verticalSize:1e3,horizontalSize:1e4,cubes:new Map,oocBoxes:new Map,debugNode:o,showCubes:i,pcTileset:null,maxGeometricalError:200,sendUsageEvents_CB:this.sendUsageEventsCB,getCubeKey:function(t){let e=t.clone();e.x=Math.floor(e.x/this.horizontalSize),e.y=Math.floor(e.y/this.horizontalSize),e.z=Math.floor(e.z/this.verticalSize);let i=50000500005e4;return i+=e.x,i+=1e5*e.y,i+=1e10*e.z,[i,e]},getCube:function(t){let[e,i]=this.getCubeKey(t),o=this.cubes.get(e);return o||(o={id:e,pos:i,isReady:!1,isPending:!1,box:null},this.cubes.set(e,o)),o},getCubes:function(t,i,o,n){let a=Math.min(t.x,i.x)-n/2,s=Math.max(t.x,i.x)+n/2,r=Math.min(t.y,i.y)-n/2,l=Math.max(t.y,i.y)+n/2,h=Math.min(t.z,i.z)-o/2,c=Math.max(t.z,i.z)+o/2,u=[],d=Math.floor(h/this.verticalSize),v=Math.floor(c/this.verticalSize);for(let t=d;t<=v;t++){let i=t*this.verticalSize+.1;u.push(this.getCube(new e.Vector3(a,r,i))),u.push(this.getCube(new e.Vector3(a,l,i))),u.push(this.getCube(new e.Vector3(s,r,i))),u.push(this.getCube(new e.Vector3(s,l,i)))}return u},getCubesAround:function(t,i,o,n){let a=t.x-i-n/2,s=t.x+i+n/2,r=t.y-i-n/2,l=t.y+i+n/2,h=t.z-o/2,c=t.z+o/2,u=[],d=Math.floor(h/this.verticalSize),v=Math.floor(c/this.verticalSize);for(let t=d;t<=v;t++){let i=t*this.verticalSize+.1;u.push(this.getCube(new e.Vector3(a,r,i))),u.push(this.getCube(new e.Vector3(a,l,i))),u.push(this.getCube(new e.Vector3(s,r,i))),u.push(this.getCube(new e.Vector3(s,l,i)))}return u},loadCube:function(t,i,o){if(t.isPending||t.isReady)return!1;let n=4,a=4,s=[],r=[];for(let e=1;e<5;e++){let i=t.pos.clone();i.z+=e,i.x*=this.horizontalSize,i.x+=.1,i.y*=this.horizontalSize,i.y+=.1,i.z*=this.verticalSize,i.z+=.1;let o=this.getCube(i);if(o.isPending||o.isReady){n=e-1;break}s.push(o)}for(let e=1;e<5;e++){let i=t.pos.clone();i.z-=e,i.x*=this.horizontalSize,i.x+=.1,i.y*=this.horizontalSize,i.y+=.1,i.z*=this.verticalSize,i.z+=.1;let o=this.getCube(i);if(o.isPending||o.isReady){a=e-1;break}r.push(o)}n>=2&&a>=2?(n=2,a=2):n+a>4&&(n>2?n=3:a=3),n+a>4&&console.log("something went wrong : check algo");let l=new e.Vector3,h=t.pos.clone();h.z-=a;let c=n+1+a;l.add(new e.Vector3(h.x*this.horizontalSize,h.y*this.horizontalSize,h.z*this.verticalSize));let u=l.clone(),d=new e.Vector3(this.horizontalSize,this.horizontalSize,this.verticalSize*c).add(u),_={id:t.id,dims:new e.Box3(u,d),cubes:[],debugNode:null,pointCloudNodes:[]};this.oocBoxes.set(_.id,_);for(let t=a-1;t>=0;t--)_.cubes.push(r[t]),r[t].isPending=!0;_.cubes.push(t),t.isPending=!0;for(let t=0;t<n;t++)_.cubes.push(s[t]),s[t].isPending=!0;for(let t=0;t<_.cubes.length;t++)_.cubes[t].box=_;if(this.showCubes){var p=e.MaterialUtils.createMatteFaceMaterial({color:16711680,side:e.DoubleSide,opacity:.2});p.force=!0;var g=v.createCuboidNodeFromBox3(_.dims,p);_.debugNode=g,this.debugNode.addChild(g)}if(this.ooc){let t=this.ooc.getRoots();for(let e=0;e<t.length;e++){let i=this.ooc.getTileSet(t[e]);i&&i.hasType("pointCloud")&&(this.pcTileset=i)}if(this.pcTileset){let t=this.pcTileset;this.pcTileset.forceLoadTraverse({onExploreCB:(t,e)=>{let i=!1;for(let e=0;e<t.boundingBoxes.length;e++)if(t.boundingBoxes[e]&&t.boundingBoxes[e].isIntersectionBox(_.dims)){i=!0;break}i&&(t.hasContent&&(t.isLeaf||t.geometricalError<=this.maxGeometricalError)?e.forceLoad():e.exploreChildren())},onLoadedCB:o=>{for(let e=0;e<o.length;e++){let i=o[e];i.error?t.unlockNodeUnload(i.uri):_.pointCloudNodes.push(i)}i&&i();for(let t=0;t<_.cubes.length;t++)_.cubes[t].isReady=!0,_.cubes[t].isPending=!1;_.debugNode&&(_.debugNode.mesh3js.material.color=(new e.Color).setRGB(0,1,0),_.debugNode.mesh3js.material.needsUpdate=!0)},requestBoundingBox:!0})}else this.ooc.loadBox(_.dims,_.id,(t=>{let o=this.oocBoxes.get(t);if(i&&i(),o){for(let t=0;t<o.cubes.length;t++)o.cubes[t].isReady=!0,o.cubes[t].isPending=!1;o.debugNode&&(o.debugNode.mesh3js.material.color=(new e.Color).setRGB(0,1,0),o.debugNode.mesh3js.material.needsUpdate=!0)}}),((t,e)=>{let i=this.oocBoxes.get(t);if(i&&this.unloadBox(i,!1),o(e),this.ooc)try{this.ooc.releaseBox(t)}catch(t){return}}));this.sendUsageEvents_CB&&this.sendUsageEvents_CB()}else{let t=_;setTimeout((()=>{i&&i();for(let e=0;e<t.cubes.length;e++)t.cubes[e].isReady=!0,t.cubes[e].isPending=!1;t.debugNode&&(t.debugNode.mesh3js.material.color=(new e.Color).setRGB(0,1,0),t.debugNode.mesh3js.material.needsUpdate=!0)}),2e3)}return!0},unloadBoxes:function(t){let i=this.getCube(t).pos;this.oocBoxes.forEach((t=>{let o=!0;for(let n=0;n<t.cubes.length;n++){let a=t.cubes[n],s=(new e.Vector3).subVectors(a.pos,i);Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z)<this.unloadDistance&&(o=!1)}o&&this.unloadBox(t,!0)}))},unloadBox:function(t,e){if(this.ooc&&e){this.ooc.getRoots();if(this.pcTileset){for(let e=0;e<t.pointCloudNodes.length;e++)this.pcTileset.unlockNodeUnload(t.pointCloudNodes[e].uri);t.pointCloudNodes=[]}else try{this.ooc.releaseBox(t.id)}catch(t){return}}for(let e=0;e<t.cubes.length;e++)t.cubes[e].isReady=!1,t.cubes[e].isPending=!1,t.cubes[e].box=null;t.debugNode&&(this.debugNode.removeChild(t.debugNode),t.debugNode=null),t.cubes=[],this.oocBoxes.delete(t.id)},areBoxesLoading:function(){let t=!1;for(let e of this.oocBoxes.values()){for(let i=0;i<e.cubes.length;i++)if(e.cubes[i].isPending){t=!0;break}if(t)break}return t}}},endOOCCollision(){let t=this.OOCCollisionData;t&&(t.ooc&&(t.ooc.setDisableFullVP(!1),t.ooc.setFullVPScreenRadius(0)),t.oocBoxes.forEach((e=>{t.unloadBox(e,!0)})),this._webGLV6Viewer.getRootNode().removeChild(t.debugNode)),this.OOCCollisionData=null},forceOOCLoad(t,e,i){var o=this._webGLV6Viewer._getOOCManager();let n=0,a=0,s=this,r=function(){a++,a==n&&(s.navigationPausedForOOC=!1,i(),s.updateLoadingState())},l=function(t){s.boxLoadingErrorCB(t)};if(o||this.fakeOOCCollision){let i=this.OOCCollisionData.getCubesAround(t,e,this.avatarHeight,this.avatarWidth);for(let t=0;t<i.length;t++){let e=i[t];e.isReady||(this.OOCCollisionData.loadCube(e,r,l)&&n++,this.navigationPausedForOOC=!0)}}return!!n&&(o&&o.setDisableFullVP(!0),this.updateLoadingState(),!0)},manageOOCCollision(t,i){this.navigationPausedForOOC=!1;var o=this._webGLV6Viewer._getOOCManager();if(o||this.fakeOOCCollision){let n=this,a=function(t){n.boxLoadingErrorCB(t)},s=this.OOCCollisionData.getCubes(t,i,this.avatarHeight,this.avatarWidth),r=t.clone();r.x=Math.floor(r.x/this.horizontalSize),r.y=Math.floor(r.y/this.horizontalSize),r.z=Math.floor(r.z/this.verticalSize),s.sort((function(t,i){return(new e.Vector3).subVectors(t.pos,r).length()-(new e.Vector3).subVectors(i.pos,r).length()}));for(let t=0;t<s.length;t++){let e=s[t];e.isReady||(this.OOCCollisionData.loadCube(e,null,a),this.navigationPausedForOOC=!0)}this.OOCCollisionData.unloadBoxes(t),o&&(this.navigationPausedForOOC?o.setDisableFullVP(!0):(o.setDisableFullVP(!1),o.setFullVPScreenRadius(0))),this.updateLoadingState()}},_updatePositionForLinearAngularMove(){if(!this.isUpdateNotRequired()&&(this._setGravity(),this._setBBox(),!this.isCollisionON||this._isInsideBboxLimits(2*this.avatarHeight))){var t=this._currentViewpoint.getUpDirection(),i=this._currentViewpoint.getSightDirection(),o=this._currentViewpoint.getTargetDistance(),n=(this._currentViewpoint.getTarget(),this._currentViewpoint.getEyePosition()),a=new e.Vector3(0,0,0),s=this._gravity.clone();s.multiplyScalar(-1);var r,l;r=this._getTranslationSpeed(F),l=this._getTranslationSpeed(z);var h,c;h=this.getRotationSpeed(F),c=this.getRotationSpeed(z);var u=U,d=1,v=0,_=new e.Vector3(0,0,0);_.crossVectors(i,t);var p=new e.Vector3(0,0,0);if(p.crossVectors(i,s),p&&p.length()>.1&&(t.crossVectors(p,i),_.crossVectors(i,t),t.normalize(),_.normalize()),s.dot(t)<0)(b=new e.Vector3(0,0,0)).crossVectors(s,t),b.dot(_)>0?i=s.clone():b.dot(_)<0&&(i=this._gravity.clone()),i.normalize(),t.crossVectors(_,i),_.crossVectors(i,t),t.normalize(),_.normalize();if(!0===this._navigationState.roll_left||!0===this._navigationState.roll_right){v=1;var g=_.clone();1==this._navigationState.roll_left&&g.multiplyScalar(-1);var m=r*u;g.setLength(m),n.add(g),a.add(g)}if(!0===this._navigationState.move_forward_mouse||!0===this._navigationState.move_backward_mouse||!0===this._navigationState.move_forward_touch||!0===this._navigationState.move_backward_touch||!0===this._navigationState.move_forward_keyboard||!0===this._navigationState.move_backward_keyboard){v=1;var w=i.clone();m=l*u;"Walk"===this.NAVIGATION_MODE&&(_&&_.length()>.1?w.crossVectors(_,this._gravity):w=null),w&&((this._navigationState.move_backward_mouse||this._navigationState.move_backward_touch||!0===this._navigationState.move_backward_keyboard)&&w.multiplyScalar(-1),w.setLength(m),n.add(w),a.add(w))}if(!0===this._navigationState.yaw_left||!0===this._navigationState.yaw_right||!0===this._navigationState.pitch_up||!0===this._navigationState.pitch_down||!0===this._navigationState.head_rotate_mouse||!0===this._navigationState.head_turn_mouse||!0===this._navigationState.head_turn_keyboard){var y=0,S=0,f=this._getDominantDeviceForRotation();f===N&&(!0===this._navigationState.head_rotate_mouse||!0===this._navigationState.head_turn_mouse)||f===A&&!0===this._navigationState.head_turn_keyboard?(S=c*u,y=-(y=h*u)):f!==A&&I!==f||(!0===this._navigationState.yaw_right&&(y=-h*u),!0===this._navigationState.yaw_left&&(y=h*u),!0===this._navigationState.pitch_up&&(S=c*u),!0===this._navigationState.pitch_down&&(S=-c*u));var b,V=s.angleTo(t);(b=new e.Vector3(0,0,0)).crossVectors(s,t),b.dot(_)<0&&(V=-V),V+S>Math.PI/2&&(S=Math.PI/2-V),V+S<-Math.PI/2&&(S=-Math.PI/2-V),_.applyAxisAngle(s,y),i.applyAxisAngle(s,y),0!==S&&i.applyAxisAngle(_,S),t.crossVectors(_,i)}this.isAvatarON&&!this.avatarNode&&this.createAvatarNode();var C=null;if(this.isAvatarON&&this.avatarPosition&&((C=this.avatarPosition.clone()).add(a),n=C.clone().sub(i.clone().multiplyScalar(this.avatarDistance)),o=this.avatarDistance,d=0),this.isCollisionON&&1===v){if(this.isAvatarON&&this.avatarPosition?this.manageOOCCollision(this.avatarPosition,C):this.manageOOCCollision(this._currentViewpoint.getEyePosition(),n),this.navigationPausedForOOC)return;this.hideNodesForCollision(),this.isCollisionHappened=!1;var T=null;if("Walk"===this.NAVIGATION_MODE?this.computeCollisionInfos(a,s)&&(T=this.isCollision(a,s)):this.computeCollisionInfos(a,t)&&(T=this.isCollision(a,t)),!0===this.isCollisionHappened){this.isAvatarON&&this.eyePositionDueToCollision.sub(i.clone().multiplyScalar(this.avatarDistance)),u*=this.eyePositionDueToCollision.clone().sub(this._currentViewpoint.getEyePosition()).length()/m,n=this.eyePositionDueToCollision}this.unhideNodesAfterCollision(),"Walk"===this.NAVIGATION_MODE&&this.isCollisionON&&this.updateStepBackData(T),T&&this.updateTopMsg(T)}var D;D={upDirection:t,eyePosition:n,sightDirection:i,distanceToTarget:o,duration:u,interpolationType:d},this._currentViewpoint.moveTo(D),this.checkLookAt()}},computeCollisionInfos:function(t,i){if(0==t.length())return!1;this.collisionInfos||(this.collisionInfos={});let o=this.collisionInfos;if(o.stepDisplacementLength=t.length(),!this._isInsideBboxLimits(2*this.avatarHeight))return!1;var n=t.clone();n.normalize();var a=n.clone();a.multiplyScalar(-1);var s=new e.Vector3(0,0,0),r=new e.Vector3(0,0,0);s.crossVectors(n,i),s.normalize(),r.crossVectors(s,n),r.normalize(),o.upMoveDirection=r,o.moveDirection=n,o.rightMoveDirection=s;var l=r.clone();l.multiplyScalar(-1),o.collisionRadius=this.avatarWidth/2+this.collisionWidth;var h=.05*this.avatarHeight;o.virtualCameraDist=1.5*this.avatarHeight;var c=this._currentViewpoint.getEyePosition().clone();this.isAvatarON&&this.avatarPosition&&(c=this.avatarPosition.clone()),c.add(l.clone().multiplyScalar(.5*this.avatarHeight-h)),c.clone().add(l.clone().multiplyScalar(.5*this.avatarHeight)),c.clone().add(r.clone().multiplyScalar(.5*this.avatarHeight)),o.topBlue=this.avatarHeight/2+this.avatarFeet,o.topRed=this.avatarHeight/2,o.rightRed=this.avatarWidth/2,o.rightYellow=o.rightRed+o.stepDisplacementLength,o.topGreen=-this.avatarHeight/2+this.avatarFeet,o.topPurple=-this.avatarHeight/2,o.bottomPurple=o.topPurple-Math.max(2*o.stepDisplacementLength,this.avatarFeet),o.nearVerticalSize=2*Math.max(o.topBlue,-o.bottomPurple),o.nearHorizontalSize=2*o.rightYellow,o.width=100,o.height=100,o.near=o.virtualCameraDist-this.avatarWidth/2,o.far=o.virtualCameraDist+2*o.stepDisplacementLength+o.collisionRadius;var u=c.clone(),d=a.clone();u.add(d.multiplyScalar(o.virtualCameraDist));let v="front";o.collisionId=v;let _={name:v,position:u,sight:n,up:r,near:o.near,far:o.far,vfov:Math.atan(o.nearVerticalSize/2/(o.virtualCameraDist-this.avatarWidth/2))*(180/Math.PI)*2,hfov:Math.atan(o.nearHorizontalSize/2/(o.virtualCameraDist-this.avatarWidth/2))*(180/Math.PI)*2,width:o.width,height:o.height},p=[];if(this.OOCCollisionData.pcTileset){let t=this.OOCCollisionData.maxGeometricalError;for(let e of this.OOCCollisionData.oocBoxes.values())for(let i=0;i<e.pointCloudNodes.length;i++)t=Math.min(t,e.pointCloudNodes[i].geometricalError);t/=this.OOCCollisionData.pcTileset.getUnitScale(),this.OOCCollisionData.pcTileset._getRoot().traverse((e=>{if(e.geometricalError<t&&e.contentToken&&e.contentToken.mesh3D){let t=e.contentToken.mesh3D.visibilityFree,i=e.contentToken.mesh3D.visible;e.contentToken.mesh3D.setVisibilityFree(!0),e.contentToken.mesh3D.setVisibility(!1),p.push({oldVisibilityFree:t,oldVisibility:i,mesh3D:e.contentToken.mesh3D})}}))}this.collisionService||(this.collisionService=y.setViewer(this._webGLV6Viewer)),this.collisionService.computeCollision(_);for(let t=0;t<p.length;t++){let e=p[t];e.mesh3D.setVisibilityFree(e.oldVisibilityFree),e.mesh3D.setVisibility(e.oldVisibility)}return!0},isCollision:function(t,i){let o={blockedByPit:!1,forwardCollision:!1,blockedByCorner:!1,distanceToCollider:null,insideMesh:!1,verticalDisplacement:!1,blockedByHead:!1,invalid:!1},n=this.collisionInfos;if(!n)return o.invalid=!0,o;var a=n.stepDisplacementLength,s=n.upMoveDirection,r=n.rightMoveDirection,l=n.moveDirection,h=n.collisionRadius,c=n.virtualCameraDist;let u=n.topBlue,d=n.topRed,v=n.rightRed,_=n.rightYellow,p=n.topGreen,g=n.topPurple,m=n.bottomPurple;n.nearVerticalSize;var w=n.nearHorizontalSize,y=this._currentViewpoint.getEyePosition();if(this.isAvatarON&&this.avatarPosition&&(y=this.avatarPosition),1===this.collisionService.getNearest().depth)return this.preventFreeFall&&(o.blockedByPit=!0,this.eyePositionDueToCollision=y.clone(),this.isCollisionHappened=!0),o;var S=this.collisionService.getDepthData();let f=[],b=[],V=null,C=null,T=1,D=[],M=[],k=this,P=[],x=this.isVerticalCollisionON?p:g,L=d,N=g+this.crouchFactor*this.avatarHeight,A=function(t,e){k.collisionService.isInsideCylinder(t,h)&&(o.insideMesh=!0),(!f[e]||S[t]<f[e])&&(f[e]=S[t],b[e]=t,S[t]<T&&(T=S[t],V=t,C=e))},I=null,O=1;for(let t=0;t<n.width*n.height;t++){let e=t%n.width;!this.isCrouched&&this.collisionService.isDirectAsymetricCollider(t,L,N,-v,v,c)?A(t,e):this.collisionService.isDirectAsymetricCollider(t,d,x,-v,v,c)?(A(t,e),S[t]<O&&(I=t,O=S[t])):this.collisionService.isDirectAsymetricCollider(t,d,x,-_,_)&&(!D[e]||S[t]<D[e])&&(D[e]=S[t],M[e]=t)}P.push({up:L,down:N,right:v,left:-v,color:[0,1,1]}),P.push({up:d,down:x,right:v,left:-v,color:[1,0,0]}),P.push({up:d,down:x,right:_,left:-_,color:[1,1,0]});var B=this.collisionService.getCameraDepth(T);let E=n.near+2*h,G=0,F=Math.min(B,E+a)-E,z=function(t,e,i,o,n){t.sort((function(t,e){return t.p.y<e.p.y?-1:1})),e.sort((function(t,e){return t.p.y>e.p.y?-1:1}));let a=[],s=[];for(let e=0;e<t.length;e++)a.length?a[a.length-1].p.z>t[e].p.z&&a.push(t[e]):a.push(t[e]);for(let t=0;t<e.length;t++)s.length?s[s.length-1].p.z>e[t].p.z&&s.push(e[t]):s.push(e[t]);let r=0,l=null;for(let t=0;t<s.length;t++){let e=s[t].p.y-o;if(e<k.avatarToGround){r=k.avatarToGround;break}let h=i;for(let e=0;e<a.length;e++)if(!(a[e].p.z>s[t].p.z)){h=a[e].p.y;break}if(h-s[t].p.y>k.avatarHeight+k.avatarToGround){r=e+k.avatarToGround;break}l=Math.max(s[t].p.z-n,0)}return[r,l]},U=!1;if(k.isVerticalCollisionON){let t,e=[],i=[],a=2*h+F-50;for(let t=0;t<n.width*n.height;t++)this.collisionService.isDirectAsymetricCollider(t,u,d,-v,v,n.near,n.near+a)&&e.push({i:t,p:this.collisionService.getOptimized3DCameraPositionAtIndex(t)}),this.collisionService.isDirectAsymetricCollider(t,p,g,-v,v,n.near+h,n.near+a)&&(this.collisionService.isInsideCylinder(t,h)&&(o.insideMesh=!0),i.push({i:t,p:this.collisionService.getOptimized3DCameraPositionAtIndex(t)}));P.push({up:u,down:d,right:v,left:-v,near:n.near,far:n.near+a,color:[0,0,1]}),P.push({up:p,down:g,right:v,left:-v,near:n.near+h,far:n.near+a,color:[0,1,0]}),[G,t]=z(e,i,u,g,E),null!==t&&(F=t,U=!0)}var K=0;if(G<=0){let t=[],e=g+1,i=m-1,a=n.near+h,s=a+F+h;for(let o=0;o<n.width*n.height;o++)if(k.collisionService.isDirectAsymetricCollider(o,g,m,-v,v,a,s)){let n=this.collisionService.getOptimized3DCameraPositionAtIndex(o);t.push({i:o,p:n}),n.y<e&&(e=n.y),n.z>s-2*h&&n.y>i&&(i=n.y)}if(P.push({up:g,down:m,right:v,left:-v,near:a,far:s,color:[1,0,1]}),k.preventFreeFall&&0==t.length)return o.blockedByPit=!0,this.eyePositionDueToCollision=y.clone(),this.isCollisionHappened=!0,o;k.isVerticalCollisionON&&(K=i!=m-1?i-g+k.avatarToGround:e-g+k.avatarToGround)}if(this.collisionService._setDebugInfos(P),null==V&&0==G&&!U&&0==K)return;var R=function(t,e){let i=t.clone();return i.add(e),i.length()>a&&(i.normalize(),i.multiplyScalar(a)),i};let H=new e.Vector3;if(F>10){let e=s.clone();if(G>0)e.multiplyScalar(G),o.verticalDisplacement=!0;else if(K<0)e.multiplyScalar(K),o.verticalDisplacement=!0;else if(F==a)return;H=R(t.clone().normalize().multiplyScalar(F),e)}else{if(null!=I){this.collisionService.getCameraDepth(I)-E>10&&(o.blockedByHead=!0)}else this.isCrouched||(o.blockedByHead=!0);if(U){for(let t=0;t<n.width*n.height;t++){let e=t%n.width;this.collisionService.isDirectAsymetricCollider(t,p,g,-v,v,c)?(!f[e]||S[t]<f[e])&&(f[e]=S[t],b[e]=t,S[t]<T&&(T=S[t],V=t,C=e)):this.collisionService.isDirectAsymetricCollider(t,p,g,-_,_)&&(!D[e]||S[t]<D[e])&&(D[e]=S[t],M[e]=t)}B=this.collisionService.getCameraDepth(T)}let i=[1/0,1/0],m=[null,null],P=[1/0,1/0],x=[null,null],L=[null,null],N=[0,0],A=w*(B-c+n.near)/n.near;var W=function(t){let e=null,i=null,o=null,a=f[t]?f[t]:D[t]?D[t]:null;if(a){o=f[t]?1:0,i=b[t]?b[t]:M[t],e=(k.collisionService.getCameraDepth(a)-B)/(A*Math.abs(t-C)/n.width)}return[e,i,o,a]};let O=T,G=0;for(var j=C-1;j>=0;j--){let[t,e,o,n]=W(j);1===o?(t&&t<i[0]&&(i[0]=t,m[0]=e,e&&!G&&1!=n&&(P[0]=t)),n&&(O=n,G||1==n||(x[0]=e))):0===o&&(n&&(n>O+.1||n<O-.1)&&n<O&&0===G&&(G=1),G||(x[0]=e),t&&t<i[0]&&(i[0]=t,m[0]=e,e&&!G&&1!=n&&(P[0]=t),e&&G&&!L[0]&&(L[0]=e)),n&&(O=n))}N[0]=G,O=T,G=0;for(j=C+1;j<n.width;j++){let[t,e,o,n]=W(j);1===o?(t&&t<i[1]&&(i[1]=t,m[1]=e,e&&!G&&1!=n&&(P[1]=t)),n&&(O=n,G||1==n||(x[1]=e))):0===o&&(n&&(n>O+.1||n<O-.1)&&n<O&&0===G&&(G=1),G||(x[1]=e),t&&t<i[1]&&(i[1]=t,m[1]=e,e&&!G&&1!=n&&(P[1]=t),e&&G&&!L[1]&&(L[1]=e)),n&&(O=n))}N[1]=G;let F=null;if(F=C>n.width/2?0:1,i[0]>-.001&&i[0]<.001&&i[1]>-.001&&i[1]<.001||i[0]<0&&i[1]<0?F=-1:(i[0]<0||i[1]<0)&&(F=i[0]<0?1:0),-1===F){this.eyePositionDueToCollision=y.clone(),this.isCollisionHappened=!0,o.blockedByCorner=!0;let t=null,i=null;if(C>n.width/2?(x[0]&&(t=this.collisionService.get3DpositionAtIndex(x[0])),L[0]&&(i=this.collisionService.get3DpositionAtIndex(L[0])),1===N[0]&&null===i&&(i=t.clone().sub(r.clone().multiplyScalar(2.1*h)))):(x[1]&&(t=this.collisionService.get3DpositionAtIndex(x[1])),L[1]&&(i=this.collisionService.get3DpositionAtIndex(L[1])),1===N[1]&&null===i&&(i=t.clone().add(r.clone().multiplyScalar(2.1*h)))),t&&i){let n=(new e.Plane).setFromNormalAndCoplanarPoint(s,y),a=this.collisionService.get3DpositionAtIndex(V);var J=new e.Vector3(0,0,0),Y=new e.Vector3(0,0,0),q=new e.Vector3(0,0,0);if(n.projectPoint(a,J),n.projectPoint(t,Y),n.projectPoint(i,q),Y.distanceTo(q)>2*h){var Z=null,X=(tt=new e.Line3(J,Y)).closestPointToPointParameter(q,!1);X>=0&&X<=1&&(Z=tt.closestPointToPoint(q,!1));var Q=null;if(Z?Z.distanceTo(q)>2*h&&(Q=Z.clone().add(q)).multiplyScalar(.5):(Q=Y.clone().add(q)).multiplyScalar(.5),Q){var $=new e.Vector3(0,0,0);n.projectPoint(Q,$),this.eyePositionDueToCollision=$,o.blockedByCorner=!1}}}return o}let K=this.collisionService.get3DpositionAtIndex(V),vt=this.collisionService.get3DpositionAtIndex(m[F]),_t=(new e.Plane).setFromNormalAndCoplanarPoint(s,y);J=new e.Vector3(0,0,0);_t.projectPoint(K,J);let pt=new e.Vector3;_t.projectPoint(vt,pt),H.subVectors(pt,J),H.normalize();var tt,et=(tt=new e.Line3(J,J.clone().add(H))).closestPointToPoint(y,!1);if(et.distanceTo(y)>a+h)return;var it=new e.Vector3(et.x-y.x,et.y-y.y,et.z-y.z),ot=it.length()-h;it.normalize(),it.multiplyScalar(ot);var nt=(new e.Plane).setFromNormalAndCoplanarPoint(it,y.clone().add(it)),at=new e.Line3(y,y.clone().add(t)),st=nt.intersectLine(at),rt=it.clone(),lt=ot;st&&(lt=(rt=new e.Vector3(st.x-y.x,st.y-y.y,st.z-y.z)).length());var ht=Math.sqrt(Math.max(0,a*a-lt*lt));ht>0?H.multiplyScalar(ht):H.multiplyScalar(0),H.add(rt);var ct=0;if(k.isVerticalCollisionON){let t=H.dot(r);var ut,dt;0==F?(ut=-v+t,dt=-v):(ut=v,dt=v+t);let e,i=[],o=[],a=this.collisionService.getOptimized3DCameraPositionAtIndex(V),s=this.collisionService.getOptimized3DCameraPositionAtIndex(m[F]),c=(s.z-a.z)/(s.x-a.x),_=a.z-c*a.x,w=c*ut+_-50,y=c*dt+_-50;for(let t=0;t<n.width*n.height;t++)this.collisionService.isEdgingCollider(t,u,d,ut,dt,n.near,w,y)&&i.push({i:t,p:this.collisionService.getOptimized3DCameraPositionAtIndex(t)}),this.collisionService.isEdgingCollider(t,p,g,ut,dt,n.near+h,w,y)&&o.push({i:t,p:this.collisionService.getOptimized3DCameraPositionAtIndex(t)});[ct,e]=z(i,o,u,g,E),e&&(H=r.clone().multiplyScalar(H.dot(r)),H.add(l.clone().multiplyScalar(e)))}let gt=s.clone();ct>0?(o.verticalDisplacement=!0,gt.multiplyScalar(ct),H=R(H,gt)):(gt.multiplyScalar(0),H=R(H,gt))}return Math.abs(F-a)>.01&&(o.forwardCollision=!0,o.distanceToCollider=F),this.eyePositionDueToCollision=y.clone().add(H),this.isCollisionHappened=!0,o},hideNodesForCollision:function(){this.avatarNode&&(this.avatarVisibility=this.avatarNode.isVisible(),this.avatarNode.setVisibility(!1)),this.OOCCollisionData&&this.OOCCollisionData.debugNode&&this.OOCCollisionData.debugNode.setVisibility(!1)},unhideNodesAfterCollision:function(){this.avatarNode&&this.avatarVisibility&&this.avatarNode.setVisibility(this.avatarVisibility),this.OOCCollisionData&&this.OOCCollisionData.debugNode&&this.OOCCollisionData.debugNode.setVisibility(!0)},fetchDistanceToGround:function(t,i){this.hideNodesForCollision(),this.collisionService||(this.collisionService=y.setViewer(this._webGLV6Viewer));let o=this.collisionService.currentData?this.collisionService.currentData.name:null;i||(i=2*this.bBoxRadius);let n=Math.max(i/1e3,1),a=this._gravity.clone().multiplyScalar(-n).add(t),s=this._gravity.clone(),r={name:"ground",position:a,sight:s,up:(new e.Vector3).crossVectors(new e.Vector3(-this._gravity.z,this._gravity.x,-this._gravity.y),s),useOrtho:!0,near:n,far:i,left:-this.avatarWidth/2,right:this.avatarWidth/2,top:this.avatarWidth/2,bottom:-this.avatarWidth/2,width:100,height:100};this.collisionService.computeCollision(r),this.unhideNodesAfterCollision();let l=this.collisionService.getNearest().depth,h=this.collisionService.get3DpositionAtIndex(this.collisionService.getNearest().index).sub(t).dot(this._gravity);return o&&this.collisionService.setCurrentData(o),1!=l?h:null},createAvatarNode:function(){this.avatarNode=new f,this._webGLV6Viewer.getRootNode().addChild(this.avatarNode),this.avatarNode.setPickable(p.NOPICKABLE),this.avatarPosition=this._currentViewpoint.getEyePosition().clone(),this.avatarPosition.add(this._currentViewpoint.getSightDirection().clone().multiplyScalar(this.avatarDistance));var t=new f;this.avatarNode.addChild(t);var i=e.MaterialUtils.createMatteFaceMaterial({color:16777215,side:e.DoubleSide,opacity:.1});i.force=!0;var o=1e3;this.isCrouched&&(o=1e3*this.crouchFactor);var n=this.avatarWidth/2*o/this.avatarHeight,a=v.createTubeNode({bottomCenterPoint:new e.Vector3(0,0,0),extrusionVector:new e.Vector3(0,0,o),internalRadius:n-10,externalRadius:n,sag:50,material:i});if(t.addChild(a),this.humanNode)t.addChild(this.humanNode),this._webGLV6Viewer.render();else{this.humanNode=new f;var s=_.getWebappsAssetUrl("FlyWalkCommand","models/Human.cgr");if(this.isCrouched&&(s=_.getWebappsAssetUrl("FlyWalkCommand","models/HumanCrouched.cgr")),s){var r=new S,l=this;r.setOnLoadedCallback((function(){1===l.humanNode.children.length&&"Mesh3D"===l.humanNode.children[0].getNodeType()&&l.humanNode.children[0].setMaterialMode(1),t.addChild(l.humanNode),l._webGLV6Viewer.render()})),r.loadModel(s,this.humanNode)}}var h=new e.Matrix4,c=C.getValue("AvatarHeight")/1e3;h.makeBasis(new e.Vector3(0,c,0),new e.Vector3(-c,0,0),new e.Vector3(0,0,c)),h.setPosition(new e.Vector3(0,0,.95*-this.avatarHeight)),t.setMatrix(h),this.avatarNode.forceUpdate()},destroyAvatarNode:function(){this.avatarNode&&this._webGLV6Viewer.getRootNode().removeChild(this.avatarNode),this.avatarNode=null,this.avatarPosition=null},positionAvatarNode:function(){if(this.avatarNode){if(this.avatarPosition){this.avatarPosition=this._currentViewpoint.getEyePosition().clone(),this.avatarPosition.add(this._currentViewpoint.getSightDirection().clone().multiplyScalar(this.avatarDistance));var t=new e.Matrix4,i=this._currentViewpoint.getSightDirection();this._gravity.clone().dot(this._currentViewpoint.getUpDirection())>0&&i.multiplyScalar(-1);var o=this._gravity.clone();o.multiplyScalar(-1);var n=new e.Vector3(0,0,0);n.crossVectors(o,i),i.crossVectors(n,o),i.normalize(),n.normalize(),o.normalize(),t.makeBasis(i,n,o),t.setPosition(this.avatarPosition),this.avatarNode.setMatrix(t)}}else this.avatarPosition=null},unsetJoystickEventsMap:function(){this.evtTokenJoystick&&(this.evtTokenJoystick.forEach((function(t){i.removeEventFromToken(t)})),this.evtTokenJoystick=void 0),this.evtTokenJoystick=[]},levelViewpointWithVerticalAxis:function(){this._setGravity();var t=this._currentViewpoint.getUpDirection(),i=this._currentViewpoint.getSightDirection(),o=this._gravity.clone();o.multiplyScalar(-1);var n=new e.Vector3(0,0,0);n.crossVectors(i,t);var a=new e.Vector3(0,0,0);a.crossVectors(i,o),a&&a.length()>.1&&(t.crossVectors(a,i),n.crossVectors(i,t),t.normalize(),n.normalize());var s;s={upDirection:t,sightDirection:i,duration:500,interpolationType:1},this._currentViewpoint.moveTo(s)},levelViewpointWithGround:function(){var t=this;this._setGravity();var e=this._currentViewpoint.getUpDirection(),i=this._currentViewpoint.getSightDirection(),o=e.clone();if("z"===this._currentUpAttribute&&o.z<0||"y"===this._currentUpAttribute&&o.y<0){if("y"===this._currentUpAttribute){o.y*=-1;var n=o.x;o.x=o.z,o.z=n}else{o.z*=-1;n=o.x;o.x=o.y,o.y=n}var a={sightDirection:i,upDirection:o,duration:500};this._currentViewpoint.moveTo(a),setTimeout((function(){t.levelGround()}),600)}else t.levelGround()},levelGround:function(){this._setGravity();var t=this._currentViewpoint.getEyePosition();if(this.isAvatarON&&this.avatarPosition){var i=this._currentViewpoint.getSightDirection(),o=this._currentViewpoint.getUpDirection(),n=new e.Vector3(0,0,0);n.crossVectors(o,i);var a=new e.Vector3(0,0,0);a.crossVectors(this._gravity,n),t=this.avatarPosition.clone().sub(a.clone().multiplyScalar(this.avatarDistance))}var s={eyePosition:t,upDirection:this._gravity.clone().multiplyScalar(-1),duration:1200};this._currentViewpoint.moveTo(s),this.checkLookAt()},lookAt:function(){if(this.reframeNavigation(),this.hideReframe(),"Walk"===this.NAVIGATION_MODE){var t=this;this.tokenReframeEndMove=T.subscribe({event:"/VISU/"},(function(e){"@onViewpointEndMove"===e.eventType&&(t.centerToObject(),T.unsubscribe(t.tokenReframeEndMove))}))}},reframeNavigation:function(){this._webGLV6Viewer.currentViewpoint.reframe()},centerToObject:function(){this._currentViewpoint.centerCamera(this._originalTarget)},_resetLeftMouseGesturesData:function(){this.LM_GesturesData.LM_Down_State=L,this.LM_GesturesData.LM_Down_time=0,this.LM_GesturesData.LM_Up_State=L,this.LM_GesturesData.LM_Up_time=0},_resetTimers:function(){null!==this._selectionTimer&&clearTimeout(this._selectionTimer),this._selectionTimer=null,null!==this._teleportTimer&&clearTimeout(this._teleportTimer),this._teleportTimer=null,null!=this._navigationTimer&&clearTimeout(this._navigationTimer),this._navigationTimer=null,null!==this._zoomTimer&&clearTimeout(this._zoomTimer),this._zoomTimer=null,null!==this._panTimer&&clearTimeout(this._panTimer),this._panTimer=null},_createTeleportIcon:function(){if(this._webGLV6Viewer&&!this._teleportIconNode){var t=null,i=e.ImageUtils.loadTexture(_.getWebappsAssetUrl("FlyWalkCommand","images/FlyWalk_Teleport_Blue_Normal.png"));if(i){(h=new e.MeshPhongMaterial({map:i,side:e.DoubleSide,alphaTest:.05,transparent:!0})).force=!0;var o={width:46,height:46,fill:!0,fillColor:null,noEdge:!0,material:h};(t=v.createRectangleNode(o)).setNoZ(!0),t.setMatrix((new e.Matrix4).makeTranslation(-23,23,0)),t.setShadow(!0),t.setFrustumCulled(!1),t.exludeFromBounding(!0)}var n=null;(n=v.createTextNode({text:this.TeleportLabel,fontSize:14,color:new e.Color("yellow"),sdf:1})).setNoZ(!0),n.setMatrix(new e.Matrix4),n.setPickable(p.NOPICKABLE),n.name="text";var a=null;t&&n&&((a=v.createFixedSizeNode()).addChild(n),a.addChild(t));var s=null;if(a){var r={viewpoint:this._webGLV6Viewer.currentViewpoint,position:new e.Vector3,name:"Teleport 3D",type:"Spherical"};(s=new g(r)).setMatrix(new e.Matrix4),s.addChild(a)}var l=null,h=e.MaterialUtils.createMatteFaceMaterial({color:6269139,side:e.DoubleSide,forceSide:!0,transparent:!1,force:!0}),c=this.avatarWidth/2+this.collisionWidth;(l=v.createTubeNode({bottomCenterPoint:new e.Vector3(0,0,0),extrusionVector:new e.Vector3(0,0,.5),internalRadius:c-40,externalRadius:c,sag:20,material:h})).setPickable(p.NOPICKABLE),l.setMatrix(new e.Matrix4),this._teleportIconTextNode=n,this._teleportIconRectNode=t,this._teleportIconNode=s,this._teleportGroundIconNode=l,this._webGLV6Viewer.getRootNode().addChild(this._teleportIconNode),this._webGLV6Viewer.getRootNode().addChild(this._teleportGroundIconNode),this._teleportIconShown=!0}},destroyTeleport2D:function(){this.reframeUIMainContainer&&this.teleportUIMainContainer.destroy(),this.teleportUIMainContainer=void 0},_destroyTeleportIcon:function(){this._teleportIconNode&&this._webGLV6Viewer&&(this._webGLV6Viewer.getRootNode().removeChild(this._teleportIconNode),this._webGLV6Viewer.getRootNode().removeChild(this._teleportGroundIconNode),this._teleportIconTextNode=null,this._teleportIconRectNode=null,this._teleportIconNode=null,this._teleportGroundIconNode=null)},showTeleport2D:function(t){if(t){this.teleportUIContainer.setStyle("top",t.y+"px"),this.teleportUIContainer.setStyle("left",t.x+"px");var e=t.y+16,i=t.x+16;this.teleportLabel.setStyle("top",e+"px"),this.teleportLabel.setStyle("left",i+"px")}!this.teleportUIMainContainer||this.teleportUIMainContainer.show(),!this.teleportUIContainer||this.teleportUIContainer.show(),!this.teleportUILabelMainContainer||this.teleportUILabelMainContainer.show(),!this.teleportLabel||this.teleportLabel.show()},hideTeleport2D:function(){this.teleportUIMainContainer&&(this.teleportUIMainContainer.hide(),this.teleportUIContainer.hide(),this.teleportUILabelMainContainer.hide(),this.teleportLabel.hide())},_showTeleportIcon:function(t){if(t){var i=t.clone();this._createTeleportIcon();var o=this._teleportPosition.clone(),n=this._gravity.clone();n.multiplyScalar(-1);var a=n.clone().setLength(.95*this.avatarHeight);if(o.sub(a),!0===this.isCollisionON){let t=this.fetchDistanceToGround(o);var s=n.clone().setLength(-t);o.add(s)}if(this._teleportGroundIconNode&&o){var r=new e.Matrix4;r.setPosition(o),this._teleportGroundIconNode.setMatrix(r),this._teleportGroundIconNode.setVisibility(!0)}if(this._teleportIconNode&&i){var l=null,h=null;!1===this._teleportIconOnTouch?(l=(new e.Matrix4).makeTranslation(-23,0,0),h=new e.Matrix4):(l=(new e.Matrix4).makeTranslation(-23,35,0),h=(new e.Matrix4).makeTranslation(0,35,0)),this._teleportIconRectNode.setMatrix(l),this._teleportIconTextNode.setMatrix(h);var c=new e.Matrix4;c.setPosition(i),this._teleportIconNode.setMatrix(c),this._teleportIconTextNode.setNoZ(!0),this._teleportIconRectNode.setNoZ(!0),this._teleportIconNode.setVisibility(!0),this._teleportIconNode.cbChange(),this._webGLV6Viewer.render(),this._teleportIconShown=!0}}},_hideTeleportIcon:function(){this._teleportGroundIconNode&&this._teleportGroundIconNode.isVisible()&&this._teleportGroundIconNode.setVisibility(!1),this._teleportIconNode&&this._teleportIconNode.isVisible()&&(this._teleportIconTextNode.setNoZ(!1),this._teleportIconRectNode.setNoZ(!1),this._teleportIconNode.setVisibility(!1),this._teleportIconNode.cbChange(),this._webGLV6Viewer.render(),this._teleportIconShown=!1)},setPreHighLightDisplay:function(t){b.empty(),this._webGLV6Viewer.setPrePicking({activated:t,displayHL:t})},storeViewerState:function(){this.viewerState.TrapSelectionState=this._webGLV6Viewer.picking.trapSelection,this.viewerState.TrackballNavigationState=this._webGLV6Viewer.currentViewpoint.getControl().getManipulationState(),this.viewerState.PreHighlightDisplay=this._webGLV6Viewer.pPicking.displayHL,this.viewerState.PickingCB_Activated=this._webGLV6Viewer.currentViewpoint.getControl()._pickingCB,this.viewerState.ViewpointController=this._webGLV6Viewer.currentViewpoint.getDefaultController(),this.viewerState.ViewpointMouseInertia=this._webGLV6Viewer.currentViewpoint.control.mouseInertia,this.viewerState.ViewpointTouchInertia=this._webGLV6Viewer.currentViewpoint.control.touchInertia,this.viewerState.ViewpointAngle=this._webGLV6Viewer.currentViewpoint.getAngle(),this.viewerState.MouseWheelActiveState=this._webGLV6Viewer.currentViewpoint.getControl().getMouseWheelActive()},setViewerState:function(){b.empty(),this._webGLV6Viewer.setPicking({trapSelection:!1}),this._webGLV6Viewer.currentViewpoint.setDefaultController(!0,"LOOKAROUND"),this._webGLV6Viewer.currentViewpoint.getControl().setMouseWheelActive(!1),!0===this.isAvatarON?this._webGLV6Viewer.currentViewpoint.control._avatarDistance=this.avatarDistance:this._webGLV6Viewer.currentViewpoint.control._avatarDistance=0},restoreViewerState:function(){this._webGLV6Viewer.setPicking({trapSelection:this.viewerState.TrapSelectionState}),this.setPreHighLightDisplay(this.viewerState.PreHighlightDisplay),this._webGLV6Viewer.currentViewpoint.setDefaultController(!0,this.viewerState.ViewpointController),this._webGLV6Viewer.currentViewpoint.setAngle(this.viewerState.ViewpointAngle),this._webGLV6Viewer.currentViewpoint.control._avatarDistance=0,this._webGLV6Viewer.currentViewpoint.getControl().setMouseWheelActive(this.viewerState.MouseWheelActiveState)},resetStoredViewerState:function(){this.viewerState.TrapSelectionState=!0,this.viewerState.TrackballNavigationState=!0,this.viewerState.PreHighlightDisplay=!0,this.viewerState.PickingCB_Activated=!0,this.viewerState.ViewpointController="COMBINED",this.viewerState.ViewpointMouseInertia=!1,this.viewerState.ViewpointTouchInertia=!1,this.viewerState.ViewpointAngle=45,this.viewerState.MouseWheelActiveState=!0},setOCCloadingState:function(t){var e=this._webGLV6Viewer._getOOCManager();e&&e.setPauseLoading(t,"flyWalk")},updateLoadingState:function(){(!0===this.isKeyBoardActive()||this._navigationState.left_joystick_active||this._navigationState.right_joystick_active||this._navigationState.mouse_active)&&!this.navigationPausedForOOC?this.optimizeLoadingState(!0):this.optimizeLoadingState(!1)},optimizeLoadingState:function(t){this.setOCCloadingState(t);var e=!t;this._webGLV6Viewer.setManipulators({preActivate:e})},updateJoyStickData:function(t,e,i,o,n){var a=null;E===n?a=this.leftJoyStickData:G===n&&(a=this.rightJoyStickData),a&&(a.linearMoveDistanceX=t,a.linearMoveDistanceY=e,a.angularMoveDistanceX=i,a.angularMoveDistanceY=o)},isUpdateNotRequired:function(){return!(!this._webGLV6Viewer.manipulatorManager||!this._webGLV6Viewer.manipulatorManager.isInManipulation(!0))||!(!this._currentViewpoint.getControl()||!this._currentViewpoint.getControl().isFlyWalkForcedStop())},updateWithNLSResources:function(){var t=this;w.DEFAULT_LANGUAGE=widget.lang?widget.lang:widget.getValue("lang"),w.loadResource({resourceFile:"FlyWalkNavigation/FlyWalkNavigation"}),w.onResourceLoaded({resourceFile:"FlyWalkNavigation/FlyWalkNavigation",language:widget.lang?widget.lang:widget.getValue("lang")},(function(){t.handleToNLS=this,t.TeleportLabel=this.getKey({key:"Teleport.Text"}),t.TeleportLabel&&t.TeleportLabel.length>0&&(t._destroyTeleportIcon(),t._createTeleportIcon(),t._hideTeleportIcon())}))},setNavigationMode:function(t){this.NAVIGATION_MODE=t},getNavigationMode:function(){return this.NAVIGATION_MODE},setCollisionState:function(t){this.collisionService||(this.collisionService=y.setViewer(this._webGLV6Viewer)),this.isCollisionON=t},getCollisionState:function(){return this.isCollisionON},_setCollisionUIShow:function(t){},setNavigationSpeed:function(t){this._navigationState.speed&&t>0&&t<=100&&(this._navigationState.speed=t)},getNavigationSpeed:function(){return this._navigationState.speed},repositionAvatar:function(t,e){var i=t.clone(),o=this._gravity.clone();o.multiplyScalar(-1);var n=o.clone().setLength(.95*this.avatarHeight+this.avatarToGround);i.add(n);var a=this._getCameraFromAvatarPosition(i);if(e){var s={eyePosition:a,duration:400,interpolationType:0};this._currentViewpoint.moveTo(s),this.checkLookAt()}else this._currentViewpoint._viewpointAnimation&&this._currentViewpoint._viewpointAnimation.stop(),this._currentViewpoint.setEyePosition(a)},repositionAvatarOnGround:function(t,e){var i=this._currentViewpoint.getEyePosition().clone();this._gravity.clone().multiplyScalar(-1);var o=this._gravity.clone().setLength(t-this.avatarToGround);if(i.add(o),e){var n={eyePosition:i,duration:400,interpolationType:0};this._currentViewpoint.moveTo(n),this.checkLookAt()}else this._currentViewpoint._viewpointAnimation&&this._currentViewpoint._viewpointAnimation.stop(),this._currentViewpoint.setEyePosition(i)},_setCollisionPref:function(){var t=C.getValue("ThirdPersonMode"),e=C.getValue("AvatarHeight"),i=C.getValue("Gravity"),o=C.getValue("EnableTransparent"),n=C.getValue("NavigationMode"),a=C.getValue("CollisionMode");!0!==this.isOnCloud&&(a=!1);var s=C.getValue("PointerLock"),r=C.getValue("AutoSelectGround"),l=C.getValue("GroundHeight");void 0!==t&&(this.isThirdPersonON=t),void 0!==e&&(this.avatarHeight=e,this.avatarWidth=this.avatarHeight*this.avatarHeightWidthFactor),void 0!==i&&(this.isVerticalCollisionON=i),void 0!==o&&(this.collisionService.skipTransparentItems=!o),void 0!==n&&(this.NAVIGATION_MODE=n),void 0!==a&&(this.isCollisionON=a),void 0!==s&&(this.isPointerLockON=s),void 0!==r&&(this.isAutoSelectGround=r),void 0===l||r||(this._groundHeight=l)},applyCollisionPref:function(){var t=this.isThirdPersonON,e=this.avatarHeight,i=this.isAutoSelectGround;if(this._setCollisionPref(),e!==this.avatarHeight){var o=!1;if(this.avatarNode)if(o=this.avatarNode.isVisible(),this.destroyAvatarNode(),this.createAvatarNode(),this.avatarHeight<e){(n=this.getGroundDistanceFromAvatar())&&this.repositionAvatarOnGround(n)}else{var n,a=this._currentViewpoint.getEyePosition(),s=this._gravity.clone().multiplyScalar(.95*(e-this.avatarHeight)),r=a.clone().add(s);this._currentViewpoint.setEyePosition(r),(n=this.getGroundDistanceFromAvatar())&&this.repositionAvatarOnGround(n)}o&&this.avatarNode.setVisibility(!0)}t!==this.isThirdPersonON&&(this.avatarDistance=3e3,this.isAvatarON=this.isThirdPersonON,this._onThirdPersonModeChanged(this.isAvatarON)),i!==this.isAutoSelectGround&&this.isAutoSelectGround&&("y"===this._currentUpAttribute?this._groundHeight=(this.bBox.max.y+this.bBox.min.y)/2:this._groundHeight=(this.bBox.max.z+this.bBox.min.z)/2),this._webGLV6Viewer.render()},checkCollisionAround:function(t){var i={waiting:!1,status:!1,blocked:!1,left:!1,right:!1,front:!1,back:!1},o=new e.Vector3(0,0,0),n=this._currentViewpoint.getSightDirection(),a=this._currentViewpoint.getUpDirection(),s=this._gravity.clone();s.dot(a)<0&&s.multiplyScalar(-1),this.hideNodesForCollision();var r;r=this._getTranslationSpeed(F);var l=this._getTranslationSpeed(z)*U;let h=this._currentViewpoint.getEyePosition();this.isAvatarON&&this.avatarPosition&&(h=this.avatarPosition);let c=this;if(this.forceOOCLoad(h,l,(function(){c.checkCollisionAround(t)})))return i.waiting=!0,this.unhideNodesAfterCollision(),i;var u=n.clone();if("Walk"===this.NAVIGATION_MODE){var d=new e.Vector3(0,0,0);d.crossVectors(this._gravity,n),d&&d.length()>.1?(u.crossVectors(d,this._gravity),u.setLength(l)):u.multiplyScalar(0)}o.add(u);let v="Walk"===this.NAVIGATION_MODE?s:a;var _=0;let p;p=null,p=this._checkCollision(o,v),p&&p.forwardCollision&&(i.status=!0,i.front=!0),p&&p.insideMesh&&_++,o.multiplyScalar(-1),p=null,p=this._checkCollision(o,v),p&&p.forwardCollision&&(i.status=!0,i.back=!0),p&&p.insideMesh&&_++,o=new e.Vector3(0,0,0);var g=new e.Vector3(1,0,0);g.applyQuaternion(this._currentViewpoint.getControl().orientation);l=r*U;g.setLength(l),o.add(g),p=null,p=this._checkCollision(o,v),p&&p.forwardCollision&&(i.status=!0,i.right=!0),p&&p.insideMesh&&_++,o=new e.Vector3(0,0,0);var m=new e.Vector3(-1,0,0);m.applyQuaternion(this._currentViewpoint.getControl().orientation);l=r*U;return m.setLength(l),o.add(m),p=null,p=this._checkCollision(o,v),p&&p.forwardCollision&&(i.status=!0,i.left=!0),p&&p.insideMesh&&_++,this.unhideNodesAfterCollision(),i.left&&i.right&&i.front&&i.back&&(i.blocked=!0),0!==_&&(i.blocked=!0),this.isCollisionHappened=!1,t&&t(i),i},_checkCollision:function(t,e){var i=this._currentViewpoint.getEyePosition(),o=(i.clone().add(t),this._currentViewpoint.getSightDirection());if(this.isAvatarON){var n=i.clone();n.add(o.clone().multiplyScalar(this.avatarDistance)),n.add(t)}this.isCollisionHappened=!1;var a=null;return this.computeCollisionInfos(t,e)&&(a=this.isCollision(t,e)),this.isCollisionHappened=!1,a},updateStepBackData:function(t){if(!t||this.stepBackData.isFirstMove||!(t.verticalDisplacement||t.blockedByPit||t.blockedByCorner||t.insideMesh)){var e=this._currentViewpoint.getUpDirection(),i=this._currentViewpoint.getSightDirection(),o=this._currentViewpoint.getEyePosition();if(this.isAvatarON&&o.add(i.clone().multiplyScalar(this.avatarDistance)),this.stepBackData.isFirstMove)return this.stepBackData.vpInfo_T1.upDirection=e.clone(),this.stepBackData.vpInfo_T1.eyePosition=o.clone(),this.stepBackData.vpInfo_T1.sightDirection=i.clone(),this.stepBackData.isFirstMove=!1,void(this.stepBackData.vpInfo_T1.isValid=!0);var n=null;this.stepBackData.vpInfo_T1.eyePosition&&(n=o.clone().sub(this.stepBackData.vpInfo_T1.eyePosition)),n&&n.length()>this.safeMoveDistance&&(this.stepBackData.vpInfo_T1.upDirection=e.clone(),this.stepBackData.vpInfo_T1.eyePosition=o.clone(),this.stepBackData.vpInfo_T1.sightDirection=i.clone(),this.stepBackData.vpInfo_T1.isValid=!0)}},stepBack:function(){if(this.stepBackData.vpInfo_T1.isValid){var t=this._currentViewpoint.getEyePosition();if(this.isAvatarON){var e=this._currentViewpoint.getSightDirection();t=t.add(e.clone().multiplyScalar(this.avatarDistance))}var i=this.stepBackData.vpInfo_T1.eyePosition.clone();if(!(t.clone().sub(i).length()<5)){var o=null;if(this.isAvatarON){var n=this.stepBackData.vpInfo_T1.sightDirection.clone();i=i.sub(n.multiplyScalar(this.avatarDistance)),o=this.avatarDistance}else o=this._currentViewpoint.getTargetDistance();var a;a={upDirection:this.stepBackData.vpInfo_T1.upDirection,eyePosition:i,sightDirection:this.stepBackData.vpInfo_T1.sightDirection,distanceToTarget:o,duration:500,interpolationType:0},this._currentViewpoint.moveTo(a),this.checkLookAt()}}},updateTopMsg:function(t){this.updateTopMsgCB&&this.updateTopMsgCB(t)},_onThirdPersonModeChanged:function(t){var e=this._currentViewpoint.getEyePosition(),i=this._currentViewpoint.getSightDirection().clone(),o=null;this._currentViewpoint._viewpointAnimation&&this._currentViewpoint._viewpointAnimation.stop(),o=t?e.clone().sub(i.multiplyScalar(this.avatarDistance)):e.clone().add(i.multiplyScalar(this.avatarDistance)),t?this.avatarNode?this.avatarNode.setVisibility(!0):this.createAvatarNode():this.avatarNode&&this.avatarNode.setVisibility(!1),this._currentViewpoint.setEyePosition(o),!0===this.isAvatarON?this._webGLV6Viewer.currentViewpoint.control._avatarDistance=this.avatarDistance:this._webGLV6Viewer.currentViewpoint.control._avatarDistance=0,T.publish({event:"VisFlyWalk/onThirdPersonModeChange",data:{eventChannel:"VisFlyWalk/onThirdPersonModeChange",eventType:"@onThirdPersonModeChange"}})},getGroundDistanceFromAvatar:function(){let t=this.avatarPosition?this.avatarPosition.clone().add(this._gravity.clone().multiplyScalar(.95*this.avatarHeight)):this._currentViewpoint.getEyePosition().clone().add(this._gravity.clone().multiplyScalar(.95*this.avatarHeight));return this.fetchDistanceToGround(t)},getGravityVector:function(){return this._gravity.clone()},moveAvatarVertically:function(t,e){var i,o=this._currentViewpoint.getEyePosition(),n=this._gravity.clone().multiplyScalar(t);i={eyePosition:e?o.clone().sub(n):o.clone().add(n),interpolationType:0},this._currentViewpoint.moveTo(i)},crouch:function(){if(this.isCrouched=!this.isCrouched,this.isCrouched){var t=this.avatarHeight;this.avatarHeight=this.crouchFactor*this.avatarHeight,this.avatarWidth=t*this.avatarHeightWidthFactor,this.isAvatarON&&(this.destroyAvatarNode(),this.humanNode=null,this.createAvatarNode()),this.moveAvatarVertically((1-this.crouchFactor)*t,!1)}else this.avatarHeight=C.getValue("AvatarHeight"),this.avatarWidth=this.avatarHeight*this.avatarHeightWidthFactor,this.isAvatarON&&(this.destroyAvatarNode(),this.humanNode=null,this.createAvatarNode()),this.moveAvatarVertically((1-this.crouchFactor)*this.avatarHeight,!0)},updateHeightNew:function(t,e){var i=this.bBox.getPoints(),o=null,n=null;if(i){o=i[0],n=i[7];var a=null;if(this._currentUpAttribute=this._currentViewpoint.getWorldOrientation().upAttribute,a="y"===this._currentUpAttribute?n.y-o.y:n.z-o.z){var s=null;s=(e-t)/100*(a=Math.abs(a)),s=Math.abs(s),t!==e&&(t<e?this.moveAvatarVertically(s,!1):this.moveAvatarVertically(s,!0))}}},_isPointCloud:function(){if(P)return!0;var t=W,e=null;if(t&&j){var i=!1;if(e=j.get()){var o=e.getRoots().length;for(let n=0;n<o&&!(i=t.isTileSetNode(e.getRoots()[n]));n++);return i}}return!1},_updatePointCloudModeInfo:function(){this.isPointCloudMode=this._isPointCloud()},_loadExternalObjects:function(){var t=this;if(void 0!==typeof require){try{require(["DS/PADUtils/PADContext"],(function(e){j=e,t._updatePointCloudModeInfo()}))}catch(t){}try{require(["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e){W=e,t._updatePointCloudModeInfo()}))}catch(t){}}},testForAuthorization:function(t){var i=this._webGLV6Viewer._getOOCManager();let o=this,n=function(e){o.boxLoadingErrorCB(e),t&&t()};if(i||this.fakeOOCCollision){var a=void 0;if(this.bBox&&this.bBox.getPoints()&&void 0!==this.bBox.max){let t=this.bBox.max.clone();t.sub(this.bBox.min),t.normalize(),t.multiplyScalar(100),a=this.OOCCollisionData.getCube(this.bBox.max.clone().add(t))}else a=this.OOCCollisionData.getCube(new e.Vector3(100,100,100));this.OOCCollisionData.loadCube(a,null,n)}return!1},isWalkSimpleTeleportMode:function(){return this.isPointCloudMode,!1}})}));