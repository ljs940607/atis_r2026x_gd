define("DS/xModelSocialToolbar/js/ModelActionToolbarView",["DS/SocialToolbar/Views/ActionToolbarView","DS/UIKIT/DropdownMenu","DS/UIKIT/Input/Button","DS/SocialToolbar/Views/CommentCountView","DS/SocialToolbar/Controls/ResponsiveButtonTooltip","DS/SocialToolbar/Views/EndorserCountView","i18n!DS/xModelSocialToolbar/assets/nls/ModelSocialToolbar"],(function(t,e,o,n,i,s,l){"use strict";let c=UWA.Utils.Client,r=t.extend({domEvents:{"click .st-filter-btn":"onfilterCommentsClick"},onfilterCommentsClick:function(){let t=this;this.modelDropdown?this.modelDropdown.hide():this.modelDropdown=new e({items:[{text:l.ALL,id:"all"},{text:l.RESOLVED,id:"resolve"},{text:l.OPENED,id:"open"}],target:arguments[0].target,events:{onClick:function(e,o){let n=o.id,i=t._filterButton.elements.container;i.innerText=o.text,i.appendChild(t._filterButton.elements.icon),t.dispatchEvent("filter-comments-from-state",n)}}}),this.modelDropdown.show()},_createContent:function(){var t,e,r=this,m=this.model,a={},d={},h={},u="bottom",g=null,p=null;let C={class:"st-action-toolbar-buttons",html:[]};return!0===this._lightMode?this._createLightActionSection():(t=m.isEndorsed(),!1!==this.getOption("enableStateFilter")&&(this._filterButton=new o({icon:"expand-down right",className:"default st-filter-btn",value:l.OPENED}),d["filter-button"]=this._filterButton),!1!==this.getOption("enableComment")&&(d["comment-button"]=new o({icon:"comment",className:"default st-reply-btn",value:l.COMMENT}),p=new n({model:this.model,collection:this.model.getCommenters()}),a.commentCountView=p,c.Features.touchEvents||(h.commentBtnTooltip=new i({target:d["comment-button"].getContent(),position:u,body:l.COMMENT,offset:{x:0,y:5}}))),!1!==this.getOption("enableShare")&&(d["share-button"]=new o({icon:"forward",className:"default st-share-btn",value:l.SHARE,events:{onClick:function(){r.dispatchEvent("onShareButtonClick")}}}),c.Features.touchEvents||(h.shareBtnTooltip=new i({target:d["share-button"].getContent(),position:u,body:l.SHARE,offset:{x:0,y:5}}))),!1!==this.getOption("enableLike")&&(e=t?this._getUnendorseNls():this._getEndorseNls(),d["endorse-button"]=new o({icon:"thumbs-up",className:"default st-endorse-btn"+(t?" st-highlighted":"")+(this._ignoreEndorseBtnClick?" st-ignore-clicks":""),value:e}),g=new s({model:this.model,collection:this.model.getEndorsers()}),a.endorserCountView=g,c.Features.touchEvents||(h.endorseBtnTooltip=new i({target:d["endorse-button"].getContent(),position:u,body:e,offset:{x:0,y:5}}))),this.components.reset(d),this.components.addMap(a),c.Features.touchEvents||this.components.addMap(h),C.html=[d["endorse-button"]?{class:"st-btn-wrapper st-endorse-btn-wrapper",html:[d["endorse-button"],g]}:null,p?{class:"st-btn-wrapper st-reply-btn-wrapper",html:[d["comment-button"],p]}:null,d["filter-button"]?{class:"st-btn-wrapper st-filter-btn-wrapper",html:d["filter-button"]}:null,d["share-button"]?{class:"st-btn-wrapper st-share-btn-wrapper",html:d["share-button"]}:null],C)}});return r})),define("DS/xModelSocialToolbar/js/ModelCommentUtils",["UWA/String"],(function(t){"use strict";return{getCellDisplayText:function(e){return t.escapeHTML(e.columnTitle+" - "+e.rowTitle)},getCellContext:function(t){return{columnId:t.columnId,rowId:t.rowId}},encodeContext(t){let e=JSON.stringify(t);return encodeURIComponent(e)},decodeContext:t=>JSON.parse(decodeURIComponent(t))}})),define("DS/xModelSocialToolbar/js/ModelSubject",["UWA/Core","DS/SocialToolbar/Models/Subject","DS/SocialToolbar/Mixins/Endorsable","DS/SocialToolbar/Mixins/Commentable","DS/SocialToolbar/Collections/CommentCollection","DS/SocialToolbar/CallMutualizer","DS/SocialToolbar/Collections/ContributionsCollection"],(function(t,e,o,n,i,s,l){"use strict";let c=e.extend(o,n,{CommentCollection:i,init:function(){this._parent.apply(this,arguments)},fetchContributions:function(t,e,o){var n,i,c,r=this,m=this.get("subjectUri"),a=this.getSharedOptions();let d=this;this._failedToFetchContributions=!1,!0===e&&!1!==s.getContributions(m,this._storeContributionsData.bind(this),this._onContributionsFetchFailure.bind(this))||(n=r.getComments(),c=r.getCommentsTotalCount(),(!0===o||!n.hasBeenFetched()||t<=c)&&(t=50,(i=new l([],{tenantId:a.getOption("tenantId"),serviceUrl:a.getOption("serviceUrl"),subjectUris:[this.get("subjectUri")]})).setPageSize(t,{onComplete:function(t){let e=t.toJSON()[0];e.comments=e.comments.reverse();let o=e.nbComments,n=Math.floor(o/i.state.pageSize);d.fetchPreviousComments(r,i,e,o,n,e.comments)},onFailure:function(){this.dispatchEvent("onPopulate",[this]),UWA.log("Failed to retrieve contributions"),r._onContributionsFetchFailure()}.bind(this)})))},fetchPreviousComments:function(t,e,o,n,i,s){let l=this;if(t._storeContributionsData(o),l.dispatchEvent("commentsFetched",[s]),n<=o.comments.length)return void l.dispatchEvent("allCommentsFetched",[l]);let c={add:!0,data:{offset:t.getComments().toArray().length},onComplete:function(s){let c=s.toJSON()[0],r=c.comments;c.comments=o.comments.concat(c.comments.reverse()),l.fetchPreviousComments.call(l,t,e,c,n,i,r)},onFailure:function(){l.dispatchEvent("onPopulate",[l]),UWA.log("Failed to retrieve contributions"),t._onContributionsFetchFailure()},remove:!1,reset:!1};e.getNextPage(c)},_storeContributionsData:function(e){var o=this.getComments(),n=t.clone(e,!1),i=e.metas;delete n.metas,delete n.comments,this.set(e),this._populated=!0,this._failedToFetchContributions=!1,o.setTotalRecords(this.get("nbComments")),o.reset(e.comments,{parse:!0,responseHeaders:{"X-3DComment-Has-Moderation-Rights":e.metas&&e.metas["X-3DComment-Has-Moderation-Rights"]}}),o.dispatchEvent("onSync",[o,{result:e.comments},{}]);const s=i&&i["X-3DComment-Has-Guest-Access"];this._guestHasAccess="true"===s,this.dispatchEvent("onPopulate",[this])}});return c})),define("DS/xModelSocialToolbar/js/xModelCommentUtils",["UWA/Class","UWA/Core","DS/Utilities/Utils","DS/xModelSocialToolbar/js/ModelSocialToolbar","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","i18n!DS/xModelSocialToolbar/assets/nls/ModelSocialToolbar"],(function(t,e,o,n,i,s){"use strict";let l={},c={};s.COMMENTS;return t.singleton({indexIgnoreList:["commercial","tree","sequenceNumber"],typeIgnoreList:["Variant","Variability Group"],getToolbar:function(t){return l[t]},launchSocialToolbar:function(t){let o=this,i=t.currentUser;new e.Promise((function(e){o.appForcedLinkUri=t.appForcedLinkUri,o._getPlatformServices().then((function(){if(void 0===l[t.subjectID]){let e={subjectUri:"pid:"+t.subjectID,enableShare:!1,enableLike:!0,enableComment:!0,enableUpload:!1,enableStateFilter:!0,tenantId:c.platformId,commentProxyToken:{header:"X-DS-CSRFTOKEN"},appForcedLinkUri:o.appForcedLinkUri,serviceURL:c["3DSpace"]+"/resources","3DSwymUrl":c["3DSwymUrl"],commentsNumberAtInit:10,currentUser:i},s=new n(e);l[t.subjectID]={toolbar:s}}e()}),(function(){}))})).then((function(){if(o.setModelEvents(t.modelEvent,t.subjectID),o.subscribeEvents(t.subjectID),t.setDGV){o.setGridView(t.view,t.subjectID),l[t.subjectID].setDGV=!0,l[t.subjectID].view=t.view;let e=l[t.subjectID].toolbar;e.removeEvent("flag-highlight-comment-context-cell"),e.removeEvent("commentsFetched"),e.removeEvent("filtered-comments-status-update"),e.listenTo(e,"flag-highlight-comment-context-cell",o.flagAndHighlightDGView.bind(o)),e.listenTo(e,"commentsFetched",o._commentsFetched),e.listenTo(e,"filtered-comments-status-update",o._updateFilteredCommentsStatus)}if(!l[t.subjectID]||!l[t.subjectID].container){let o=new e.createElement("div",{class:"model-comment-container"});l[t.subjectID].container=o,o.setContent(l[t.subjectID].toolbar)}}))},_commentsFetched:function(t,e){l[t].modelEvent.publish({event:"xmodel-comments-fetched",data:e})},resetDGV:function(t){l[t]&&(l[t].setDGV=!1,l[t].view=null)},_updateFilteredCommentsStatus:function(t){let e=t.replace("pid:","");l[e].modelEvent.publish({event:"xmodel-comments-update-filtered-comments-status"})},updateSocialStatus:function(t){let e=t.id;l[e]&&l[e].toolbar&&l[e].toolbar.updateSocialStatus(t.dictionaryIds,t.selectedItems,t.comments)},_getPlatformServices:function(){return new e.Promise((function(t,e){0===Object.keys(c).length?i.getPlatformServices({onComplete:function(e){let o=widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",n=e[0];if(e.length>0)for(let t=0;t<e.length;t++){let i=e[t];if(i.platformId===o){n=i;break}}c=n,t()},onFailure:function(){c={},e()}}):t()}))},unselectAll:function(t){l[t].toolbar.dispatchEvent("set-comment-context",{cellsInfo:[]}),this.flagAndHighlightDGView([],t,!1,!0)},hasOpenedCommentThread:function(t,e){let o,n=!1;return l&&l[t]&&(l[t].setDGV&&(o=this.getDGVCellContext(e,t)),o.length>0&&(n=l[t].toolbar.isCommentOpened(o))),n},_getDGVCellsID:function(t,e){let o=[],n=[],i=this,s=l[e.replace("pid:","")].view,c=s.columns,r=s.getTreeDocument().getAllDescendants();for(let e=0;e<t.length;e++){let s=t[e];o.push(c.indexOf(c.find((t=>(t=i._getDeepestColNode(t)).dataIndex===s.columnId)))),n.push(r.indexOf(r.find((t=>t.isVisible()&&t.options.id===s.rowId))))}let m=[];for(let e=0;e<t.length;e++)if(-1!==o[e]&&-1!==n[e]){let t=s.layout.getCellIDFromCoordinates({rowID:n[e],columnID:o[e]});m.push(t)}return m},flagAndHighlightDGView:function(t,e,o,n){let i=l[e.replace("pid:","")].view,s=this._getDGVCellsID(t,e);n&&(i.unselectAll(),s.forEach((t=>!i.isCellSelected(t)&&i.selectCell(t,!0,!1,!0)))),o&&s.forEach((t=>{i.updateCellView(t,{updateCellAttributes:!0,updateCellContent:!0,updateCellLayout:!1})}))},updateContext:function(t,e,o){l[t]&&l[t].setDGV&&l[t].toolbar.setChangedDGVContext(e,o)},setModelEvents:function(t,e){l[e].modelEvent=t},setGridView:function(t,e){let n=this,i=t.getCellsXSO();i.onPostAdd(o.debounce((function(t){let o;n.indexIgnoreList.includes(t[0].columnDataIndex)&&(t=void 0),Array.isArray(t)&&(o=[])&&t.forEach((t=>{Object.keys(t.nodeModel.options.grid).length>0&&(!n.typeIgnoreList.includes(t.nodeModel.options.grid.type)||"Primary"===t.nodeModel.options.grid.usage)&&o.push(t)})),l[e].modelEvent.publish({event:"xmodel-social-dgv-cell-selected",data:{id:e,cellInfos:o}})}),200)),i.onPostRemove(o.debounce((function(t){l[e].modelEvent.publish({event:"xmodel-social-dgv-cell-selected",data:{id:e,cellInfos:t}})}),200))},getDgvActiveCellContexts:function(t,e){let o=this,n=l[e].view,i=n.getCellsXSO().get();i=i.filter((t=>!o.indexIgnoreList.includes(t.columnDataIndex)&&Object.keys(t.nodeModel.options.grid).length>0&&!(o.typeIgnoreList.includes(t.nodeModel.options.grid.type)&&"Primary"!==t.nodeModel.options.grid.usage)));let s=[];return t&&""!==t.cellModel&&i.forEach((t=>{s.push({columnId:t.columnDataIndex,columnTitle:t.columnDataIndex.split("-")[1]?t.columnDataIndex.split("-")[1]:n.columns.find((e=>e.dataIndex===t.columnDataIndex)).text,rowTitle:t.nodeModel.options.label,rowId:t.nodeModel.options.id})})),s},_getDeepestColNode:function(t){return t.children?this._getDeepestColNode(t.children[0]):t},getDGVCellContext:function(t,e){let o=l[e].view,n=t.columnID,i=t.rowID,s=[];if(o){let t=o.columns[n];if(t){let e=this._getDeepestColNode(t),n=o.getTreeDocument().getAllDescendants()[i];n.isVisible()&&s.push({columnId:e.dataIndex,columnTitle:e.dataIndex.split("-")[1]?e.dataIndex.split("-")[1]:e.text,rowTitle:n.options.label,rowId:n.options.id})}}return s},subscribeEvents:function(t){let e=this;e.destroyEvents(t),l[t].modelEvent.subscribe({event:"xmodel-set-social-comment-context"},(function(t){let e=t.id,o=t.context;l[e].toolbar.dispatchEvent("set-comment-context",{cellsInfo:o})})),l[t].modelEvent.subscribe({event:"xmodel-social-dgv-cell-selected"},(function(t){let o=t.cellInfos,n=e.getDgvActiveCellContexts(o,t.id);l[t.id].modelEvent.publish({event:"xmodel-set-social-comment-context",data:{id:t.id,context:n}})}))},destroyEvents:function(t){l[t].modelEvent.unsubscribe("xmodel-set-social-comment-context"),l[t].modelEvent.unsubscribe("xmodel-social-dgv-cell-selected")},getActiveSubject:function(){return this._activeSubject}})})),define("DS/xModelSocialToolbar/js/ModelCommentEditorView",["DS/SocialToolbar/Views/CommentEditorView","DS/UIKIT/Badge","DS/UIKIT/Tooltip","DS/xModelSocialToolbar/js/ModelCommentUtils"],(function(t,e,o,n){"use strict";let i=t.extend({init:function(){this._parent.apply(this,arguments),this.addEvents(),this.contextBadges=[],this.cellsInfo=[]},addEvents:function(t){this.listenTo(this,"set-comment-context",this.setContext)},onEnterEditMode:function(t,e){this.cellsInfo=t,this.cellsInfo.length&&this.renderContext(this.getElement(".st-text-editor-container")),this._handleUserPictureVisibility({hide:!0}),null==this.model.getParentComment()&&e.commentEditionOn(t)},_getMessageToDisplay:function(t){let e=this._getUnwrappedMessage(t),o=/<p>(.*?)<\/p>/.exec(e);return o=o?o[1]:"",o},_getMessageToSave:function(){let t="";if(null==this.options.parentComment){t=`<div class='comment-context ${this.model?this.model.get("state"):"open"}'>${n.encodeContext(this.cellsInfo)}</div>`}return this._removeAllContextBadges(),t+this._getEditorContent()},setContext:function(t,e){this.cellsInfo=t.cellsInfo?t.cellsInfo:[],this.renderContext(e)},renderContext:function(t){let i,s=this;if(t)i=t;else{if(!this.elements||!this.elements.textEditorContainer)return;i=this.elements.textEditorContainer.parentElement}this._removeAllContextBadges(),this.cellsInfo.forEach((t=>{let l=new e({content:n.getCellDisplayText(t),selectable:!0,cellInfo:t,className:"default comment-context",events:{onClick:function(){s.customTooltip=new o({target:l.elements.container,body:this.content})}}});i.insertBefore(l.elements.container,i.firstChild),s.contextBadges.push(l)}))},_removeAllContextBadges:function(){this.contextBadges.forEach((function(t){t.remove(),t=null})),this.contextBadges=[]}});return i})),define("DS/xModelSocialToolbar/js/ModelCommentView",["DS/SocialToolbar/Views/CommentView","DS/UIKIT/DropdownMenu","UWA/Core","DS/xModelSocialToolbar/js/ModelActionToolbarView","DS/UIKIT/Badge","DS/UIKIT/Tooltip","DS/xModelSocialToolbar/js/ModelCommentEditorView","DS/xModelSocialToolbar/js/ModelCommentUtils","i18n!DS/xModelSocialToolbar/assets/nls/ModelSocialToolbar"],(function(t,e,o,n,i,s,l,c,r){"use strict";let m=UWA.Utils.Client,a=null;require(["DS/xModelSocialToolbar/js/ModelCommentZone"],(function(t){a=t}));let d={edit:{name:"edit",text:r.EDIT,fonticon:"pencil"},resolve:{name:"resolve",text:r.MARK_RESOLVED,fonticon:"check "},open:{name:"open",text:r.REOPEN,fonticon:"reset"},delete:{name:"delete",text:r.DELETE,fonticon:"trash"},_loading:{name:"_loading",text:r.LOADING,disabled:!0},_noAvailableAction:{name:"_noAvailableAction",text:r.NOAVAILABLEACTION,disabled:!0},_errorLoadingActions:{name:"_errorLoadingActions",text:r.ERRORLOADINGACTIONS,disabled:!0}},h=function(t){if(d[t])return o.clone(d[t],!1);throw new Error('Menu item "'+t+'" is not supported!')},u=e.extend({show:function(){return this.items&&0===this.items.length&&this.addItem(h("_loading")),this._parent.apply(this,arguments)}});let g=t.extend({init:function(){this._parent.apply(this,arguments),this.contextBadges=[],this.cellsInfo=[],this.modelcommentList=arguments[0].parentComponent},_createMainSection:function(){this.model.get("commentUri")&&(this.modelcommentList.commentIdMapping[this.model.get("commentUri")]=this);let t=this._parent.apply(this,arguments),e=this.getCommentState();this.model.set("state",e);let o=this;this.container.addEventListener("click",(function(t){let e=t.target.getParents(),n=!1;for(let t=0;t<e.length;t++)if(e[t].classList.contains("st-comment-editor")){n=!0;break}n||(t.stopPropagation(),o.flagAndHighlightDGView(!1,!0))}));let n=t.html[0].html[0].html[0].html,i=t.html[0].html[0].html[1];if(null==this.model.getParentComment()){this._setStateBadge(n);let t=i.getChildren();t.length>1&&t[0].classList.contains("comment-context")&&(this.renderContext(i),t[0].remove())}let s=this.components.get("actionToolbar");return"resolve"==e?s.hide():s.show(),this.listenTo(this,"onCommentStateSuccess",this._onCommentStateSuccess),this.listenTo(this,"set-current-comment-zone-editor",this._setCurrentEditor),t},_setStateBadge:function(t){let e=this;if(this._removeStateBadge(),"resolve"==this.model.get("state")){{let t=r.RESOLVED;this.stateBadge=new i({content:t,selectable:!0,closable:!1,className:"default comment-state-context",events:{onClick:function(){e.stateTooltip=new s({target:e.stateBadge.elements.container,body:e.stateBadge.getContent().innerText})}}})}Array.isArray(t)?t.push(this.stateBadge):t.appendChild(this.stateBadge.elements.container)}},_setCurrentEditor:function(t,e){this._topLevelComponent.dispatchEvent("set-current-comment-zone-editor",[t,this,e])},getCommentContext:function(){return`<div class='comment-context ${this.model.get("state")}'>${c.encodeContext(this.cellsInfo)}</div>`},buildContextIds:function(){let t=[],e=[];for(let o=0;o<this.cellsInfo.length;o++){let n=this.cellsInfo[o].columnId;n.contains("-")&&(n=n.split("-")[0]);let i=n.split(","),s=this.cellsInfo[o].rowId;e.push([...i,s].join(",")),t=[...t,...i,s]}t=new Set(t),this.model.set("allContextIds",t),this.model.set("strCellContext",e)},updateContextBadge:function(t){this.contextBadges.forEach(((e,o)=>{t.includes(o)?e.elements.container.classList.add("broken-context"):e.elements.container.classList.remove("broken-context")}))},checkContextStatus:function(t){let e=[];this.cellsInfo.forEach(((o,n)=>{if(!t.includes(o.rowId))return void e.push(n);let i;if(o.columnId.contains("-")){i=o.columnId.split("-")[0].split(",")}else i=o.columnId.split(",");i.filter((e=>t.includes(e))).length==i.length||e.push(n)})),this.updateContextBadge(e)},_onCommentStateSuccess:function(){let t=this.model.get("state"),e=this.components.get("actionToolbar");"resolve"==t?e.hide():e.show()},renderContext:function(t,e){let o,n=this;o=e?this._getRichMessageContext():t.getChildren()[0].getText(),this.cellsInfo.length&&!e||(this.cellsInfo=c.decodeContext(o)),this.model.set("cellsInfo",this.cellsInfo),this.id=this.model.get("commentUri"),this.buildContextIds();let l=t||n.container.querySelector(".st-msg");if(n._removeAllContextBadges(),!this.cellsInfo)return;let r=[];for(let t=0;t<this.cellsInfo.length;t++){let e,o=this.cellsInfo[t],m=c.getCellDisplayText(o),a=c.getCellContext(o);r.push(a),e=new i({content:m,selectable:!0,closable:!1,cellInfo:o,className:"default comment-context",events:{onClick:function(){n.customTooltip=new s({target:e.elements.container,body:m}),n.customTooltip.show()}}}),l.insertBefore(e.elements.container,l.firstChild),n.contextBadges.push(e)}if(Array.isArray(this.modelcommentList.selectedItems)){let t=this.modelcommentList.selectedItems,e=this.model.get("allContextIds"),o=!1;o=t.find((t=>e.has(t))),o&&this.model.get("state")==this.modelcommentList.filter?this.show():this.hide()}},_removeAllContextBadges:function(){this.contextBadges.forEach((t=>{t.remove(),t=null})),this.contextBadges=[],this.customTooltip&&this.customTooltip.remove()},_removeStateBadge:function(){this.stateBadge&&this.stateBadge.remove(),this.stateTooltip&&this.stateTooltip.remove(),this.stateTooltip=null,this.stateBadge=null},_removeContext:function(){this._removeStateBadge(),this._removeAllContextBadges()},_createFooterSection:function(){var t=this.model,e=this.components.get("commentZone"),i=new n({model:t,enableLike:this.getTopLevelComponent().getOption("enableCommentLike")});return this.components.addMap({actionToolbar:i}),this.elements.showRepliesSection=o.createElement("div",{class:"st-show-replies",html:this._createShowRepliesSection()}),this._shouldFooterBeShown()?{class:"st-comment-main-section-footer",html:[i,this.elements.showRepliesSection,e]}:null},_getDropDownMenuItemFromActionList:function(t){return t.map((function(t){return h(t)}),this)},getCommentState:function(){let t,e=this.model.getParentComment();if(e)t=e.get("state");else{let e=this._getCommentAttributes();t=e.class&&e.class.includes("resolve")?"resolve":"open"}return t},_getCommentAttributes:function(){let t=this.model.get("richMessage").match(/(\w+)=["']([^"']+)["']/g),e={};return Array.isArray(t)&&t.forEach((t=>{let[o,n]=t.split("=");e[o.trim()]=n.replace(/["']/g,"")})),e},_onCancelEdition:function(){this._parent.apply(this,arguments),this._topLevelComponent.dispatchEvent("onCancelEdition")},enterEditMode:function(){var t;if(!0!==this._editMode){this.model&&((t=this.model.getSubject().getSharedOptions()).dispatchEvent("onCommentViewEnterEditMode",[this]),this.listenTo(t,"onCommentViewEnterEditMode",this.enterViewMode)),this._editMode=!0,this.container.addClassName("st-edit");let e=this.getCommentEditor();e.placeCursorAt(),e.container.isInjected(this.container)||e.inject(this.getElement(".st-comment-main-section"),"after"),e.dispatchEvent("onEnterEditMode",[this.cellsInfo,this])}},getCommentEditor:function(){let t=this.components.get("commentEditor");return t||(t=new l({model:this.model,parentComment:this.model.getParentComment(),collection:this.collection,creationMode:!1,showRteOnDOMInjection:!0}),this.components.addMap({commentEditor:t})),t},commentEditionOn:function(t){let e=this.getCommentEditor();this.flagAndHighlightDGView(!0,!0),this.dispatchEvent("set-current-comment-zone-editor",[e,t])},_createDropDownMenu:function(t,e){var n=this;let i=!1,s=this.model.getParentComment(),l=this.getCommentState();null==s&&(i=!0),e.includes("edit")&&"resolve"==l&&e.splice(0,1);let c="open"==l?"resolve":"open";i&&l&&!e.includes(c)&&e.splice(1,0,c);let r=this._getDropDownMenuItemFromActionList(e);return this.components.addMap({dropdownMenu:new u({className:"st-comment-actions-dropdown",target:t,items:r,events:{onClick:function(t,e){switch(e.name){case"edit":n.enterEditMode();break;case"delete":n.deleteComment();break;case"open":case"resolve":n.updateCommentState(e.name)}},onShow:function(){var t=this,e=n.model&&n.model.collection,l=function(e){var o=t.items&&1===t.items.length;t.removeItem("_loading"),t.removeItem("_noAvailableAction"),t.removeItem("_errorLoadingActions"),o&&e&&e.replacementItem&&t.items&&0===t.items.length&&t.addItem(e.replacementItem)},c=function(e){var o=[];if(!0===e){let e=t.items;for(let o=e.length-1;o>=0;o--)t.removeItem(e[0].id);i?"resolve"==n.model.get("state")?(o.push("open"),o.push("delete")):(o.push("edit"),o.push("resolve"),o.push("delete")):("resolve"!=s.get("state")&&o.push("edit"),o.push("delete")),o.length>0&&t.addItem(n._getDropDownMenuItemFromActionList(o)),l()}else l({replacementItem:h("_noAvailableAction")});t.updatePosition()};e&&!o.is(n._hasUserEditionRight(),"boolean")?e.getCommentModerationRights({onComplete:function(t){c(t)},onFailure:function(){l({replacementItem:h("_errorLoadingActions")})}}):c(n._hasUserEditionRight())}}})})},_onRichMessageChange:function(){var t,e=this.getElement(".st-comment-info .st-msg"),o=this.getElement(".st-comment-main-section .st-media-zone");if(e){let t=this._getMessageToDisplay(),o=/<p>(.*?)<\/p>/.exec(t),n=o?o[1]:"";e.setContent("<p>"+n+"</p>"),null==this.model.getParentComment()&&this.renderContext(e,!0)}o&&(t=this._getMediaListToDisplay(),o.setContent(t&&t.container||t))},_getRichMessageContext:function(){return this.model.get("richMessage").match("<div[^>]*>(.*?)</div>")[1]},updateCommentState:function(t){this.commentEditionOn();let e=this,o=e.model,n=o.get("state");o.set("state",t);let i=o.get("richMessage"),s=e._getMessageToSave(),l=(new Date).toISOString();o.save({richMessage:s},{onFailure:function(){let t=e.container.querySelector(".st-comment-header");var s=o.get("richMessage");require(["DS/ENOXNotificationsUtil/ENOXNotificationUtil"],(function(t){UWA.log("Comment Resolve Call Failed !!!"),t.showError(r.COMMENT_NOT_RESOLVED)})),o.set("richMessage",i),e.dispatchEvent("onCommentSaveFailure",[e,s]),o.set("state",n),e._setStateBadge(t)},onComplete:function(){let o=e.container.querySelector(".st-comment-header");e._setStateBadge(o);let n=e.model.getComments().toArray(),i=e.components.get("commentZone");if(i){let e=i.components.get("commentList").children.toArray(),o=i.components.get("commentCreator"),s=!0;n.length>0&&(n.forEach((e=>{e.set("state",t)})),e.forEach((t=>{t.dispatchEvent("onCommentStateSuccess")}))),"resolve"==t&&(s=!1),o.dispatchEvent("model-comment-editor-visibility-action",s)}e.dispatchEvent("onCommentStateSuccess"),e.dispatchEvent("onCommentEditSuccess",e)}}),o.set({modificationDate:l})},_getMessageToSave:function(){let t="";return t=this.getCommentContext(),this._removeContext(),t+this._getEditorContent()},_getEditorElement:function(){return this.elements.commentMessage},_getEditorContent:function(){var t=this._getEditorElement();return t?t.getHTML():""},_showRepliesAndReplyCreator:function(t,e){var o=this,n=function(n){if(!o.isDestroyed()){var i,s,l=o.components.get("commentZone");l||(l=new n({model:o.model,parentComment:o.model,collection:o.model.getComments(),commentToScrollTo:e&&e.commentToScrollTo}),o.components.addMap({commentZone:l}),o.listenTo(o.components,{onCommentCreateSuccess:function(t){o.dispatchEvent("onCommentCreateSuccess",[t])},onCommentDeleteSuccess:function(t){o.dispatchEvent("onCommentDeleteSuccess",[t])}}),l.inject(o.getElement(".st-comment-main-section-footer"),"bottom")),i=l.getCommentCreator(),s=i.getCommentEditor(),"open"==o.model.get("state")?(i.show(),s.show()):(i.hide(),s.hide()),l.show(),s.updateEditorContentWhenRteIsReady(),m.Platform.ios&&!0===t&&s.isInPage()&&i.focus(),s.executeWhenRteIsReady((function(){!0===t&&s.placeCursorAt(),o.dispatchEvent("onShowRepliesAndReplyCreator",[this])}))}};this.removeEvent("onShowRepliesAndReplyCreator",this._hideRepliesAndReplyCreator),a?n(a):require(["DS/xModelSocialToolbar/js/ModelCommentZone"],n),n(g),o.flagAndHighlightDGView(!1,!0)},_hasUserEditionRight:function(){return this.model.get("author").login==this._topLevelComponent.getOption("currentUser")},flagAndHighlightDGView:function(t,e){let o=this.cellsInfo,n=this.model.getParentComment(),i=this.model.get("contextBroken"),s=this.cid;n&&(o=n.get("cellsInfo"),i=n.get("contextBroken"),s=n.cid);let l=this._topLevelComponent.getOption("subjectUri");i||(this._topLevelComponent.dispatchEvent("xmodel-comment-clicked",[s]),this._topLevelComponent.dispatchEvent("flag-highlight-comment-context-cell",[o,l,t,e]))}});return g})),define("DS/xModelSocialToolbar/js/ModelCommentCreatorView",["DS/SocialToolbar/Views/CommentCreatorView","DS/xModelSocialToolbar/js/ModelCommentEditorView","DS/SocialToolbar/Utils/Sprite"],(function(t,e,o){"use strict";return t.extend({_createContent:function(){var t=this.collection.getSubject().getSharedOptions(),n=new e({parentComment:this.getOption("parentComment"),collection:this.collection});return this.components.addMap({commentEditor:n}),this.listenTo(n,"model-comment-editor-visibility-action",this.toggleEditorVisibility),this.listenTo(this,"model-comment-editor-visibility-action",this.toggleEditorVisibility),this.listenTo(this,"model-comment-editor-scroll-action",this.scrollTo),[o.renderUserPicture({cls:"st-user-picture",format:"normal",login:t.getOption("userLogin"),firstName:t.getOption("firstName"),lastName:t.getOption("lastName"),guest:t.getOption("userIsGuest"),swymUrl:t.getOption("3DSwymUrl")}),n]},toggleEditorVisibility:function(t){t?this.show():this.hide()},scrollTo:function(){this.container.scrollIntoView()}})})),define("DS/xModelSocialToolbar/js/ModelCommentListView",["DS/SocialToolbar/Views/CommentListView","DS/xModelSocialToolbar/js/ModelCommentView"],(function(t,e){"use strict";let o=t.extend({_ItemView:e,init:function(){this._parent.apply(this,arguments),this.highlightedComments=[],this.commentIdMapping={},this.state="open"},getContextMatchingComments:function(t){let e=[],o=t.cellsInfo;if(o&&o.length){let n=this.children.toArray(),i=o.length;n.forEach((o=>{if(o.cellsInfo){let n=0;t.cellsInfo.forEach((t=>{o.cellsInfo.find((e=>e.columnId===t.columnId&&e.rowId===t.rowId))&&n++})),n===i&&e.push(o.cid)}}))}return e},toggleCommentsHighlight:function(t){this.removeHighlightedComments(),t.forEach((t=>{let e=this.children.get(t);this.highlightedComments.push(e),e.container.classList.add("highlight-comment")}));let e=this.highlightedComments[0];this.selectedCommentCid&&(e=this.children.get(this.selectedCommentCid)),e&&e.container.scrollIntoView()},commentClicked:function(t){this.selectedCommentCid=t},_highlightCell:function(t){this.dispatchEvent("highlight-context-comment-cell",t)},removeHighlightedComments:function(){this.highlightedComments.forEach((t=>{t.container&&t.container.classList.remove("highlight-comment")})),this.highlightedComments=[]},updateSocialStatus:function(t,e,o,n,i){let s=this,l=[];this.selectedItems=o,l=this.filterCommentFromState(i,e,n),l.forEach((e=>{let o=s.commentIdMapping[e];o.checkContextStatus(t),this.commentIdMapping[o.model.get("commentUri")].flagAndHighlightDGView(!0,!1)}))},highlightComment:function(t,e,o){let n=this.commentIdMapping[t.get("commentUri")];n&&(this.toggleCommentsHighlight([n.cid]),n.flagAndHighlightDGView(e,o))},filterCommentFromState:function(t,e,o){let n=[],i=this;if(i.filter=t,Array.isArray(this.selectedItems)){let t=[];this.selectedItems.forEach((o=>{e[o]&&(t=[...t,...Array.from(e[o])])})),t=[...new Set(t)],n=t}else n=Object.keys(this.commentIdMapping);let s=Object.keys(this.commentIdMapping);o&&(s=o);let l=[],c=[];return s.forEach((e=>{let o=this.commentIdMapping[e];if(n.includes(e)){let n=o.model.get("state");"all"===t||t===n?l.push(e):c.push(e)}else c.push(e)})),requestAnimationFrame((()=>{l.forEach((t=>{i.commentIdMapping[t].show()})),c.forEach((t=>{i.commentIdMapping[t].hide()}))})),l}});return o})),define("DS/xModelSocialToolbar/js/ModelCommentZone",["DS/SocialToolbar/Views/CommentZoneView","DS/SocialToolbar/Views/PreviousCommentsLoaderView","DS/xModelSocialToolbar/js/ModelCommentListView","DS/xModelSocialToolbar/js/ModelCommentCreatorView"],(function(t,e,o,n){"use strict";return t.extend({_createContent:function(){this.components.reset({previousCommentsLoader:new e({model:this.model,collection:this.collection}),commentList:new o({model:this.model,collection:this.collection,commentToScrollTo:this.getOption("commentToScrollTo")}),commentCreator:new n({parentComment:this.getOption("parentComment"),collection:this.collection})});let t=this.components.get("commentCreator");return t.hide(),this.listenTo(this,{"set-comment-context":this.checkContextInfo,"filter-comments-from-state":this.filterCommentFromState}),this.listenTo(t,{onCommentSaved:this.checkForRootComment}),this.components.toArray()},toggleCommentEditorVisibility:function(t){let e=this.components.get("commentCreator");t?e.show():e.hide()},checkForRootComment:function(t){let e=!1;t.options&&t.options.parentComment&&(e=!0),this.toggleCommentEditorVisibility(e)},checkContextInfo:function(t){let e=this.components.get("commentCreator"),o=this.components.get("commentList");o.removeHighlightedComments();let n=o.getContextMatchingComments(t),i=e.components.get("commentEditor");n.length>0?o.toggleCommentsHighlight(n):o.selectedCommentCid=!1,i.dispatchEvent("set-comment-context",t),t.cellsInfo.length>0?(e.dispatchEvent("model-comment-editor-visibility-action",!0),0==o.highlightedComments.length&&e.dispatchEvent("model-comment-editor-scroll-action")):e.dispatchEvent("model-comment-editor-visibility-action",!1)},filterCommentFromState:function(t,e){this.components.get("commentList").filterCommentFromState(t,e)},_onReplyButtonClick:function(t){var e,o,n,i=t.model.getAuthor();t.model.get("parentCommentUri")&&(o=this.getCommentCreator(),n=o.getCommentEditor(),"open"==this.model.get("state")?(o.show(),n.focus()):(o.hide(),n.show()),require(["DS/SocialUserMention/SocialUserMention"],(function(t){e=t.getMention({object:{value:i.get("login"),label:i.getFullName()}}),n.resetEditorContent(e),n.placeCursorAt(),n.isInRichMode()&&!n.isRteReady()&&n.addEventOnce("onRteReady",(function(){n.isDestroyed()||n.placeCursorAt()}))})))}})})),define("DS/xModelSocialToolbar/js/ModelSocialToolbar",["DS/SocialToolbar/SocialToolbar","DS/SocialToolbar/Mixins/CompositeUI","DS/xModelSocialToolbar/js/ModelSubject","DS/xModelSocialToolbar/js/ModelCommentZone","DS/SocialToolbar/Utils/SocialToolbarSharedOptions","DS/xModelSocialToolbar/js/ModelActionToolbarView","DS/SocialToolbar/CallMutualizer","DS/SocialToolbar/Views/GuestInfoBarView","DS/xModelSocialToolbar/js/ModelCommentUtils","i18n!DS/SocialToolbar/assets/nls/social-toolbar","css!DS/xModelSocialToolbar/css/ModelSocialToolbar.css"],(function(t,e,o,n,i,s,l,c,r,m){"use strict";let a,d={},h=t.extend(e,{init:function(){this.contentContext={},this._parent.apply(this,arguments)},_filterState:"open",componentMap:{},inject:function(){this._parent.apply(this,arguments),this._previous.apply(this,arguments)},render:function(){var t,e,n=this,s=function(e){n._successFullInit=!1,t(),Core.is(e)&&UWA.log(e)};return!1===this._rendered&&(this._rendered=!0,t=this._previous.bind(this,arguments),e=new i({"3DSwymUrl":this.options["3DSwymUrl"],"3DSwymServerToken":this.options["3DSwymServerToken"],tenantId:this.options.tenantId,userLogin:this.options.userLogin,userName:this.options.userName,serviceUrl:this.options.serviceUrl,appForcedLinkUri:this.options.appForcedLinkUri}),require(["DS/UIKIT/Alert"],(function(i){a=i,e.executeWhenReady((function(){var i,s;n.isDestroyed()||(d[n.getOption("subjectUri")]?(i=d[n.getOption("subjectUri")].subject,n.listenTo(i,{onPopulate:n._onContributionsFetchSuccess,onContributionsFetchFailure:n._onContributionsFetchFailure,commentsFetched:n._filterContentContextIds}),++d[n.getOption("subjectUri")].nbUseCases,s=i.getComments(),!0===n.getOption("sendInitCallEvenIfSubjectIsInCache")||!1===s.hasBeenFetched()||s.length<n.getOption("commentsNumberAtInit")&&s.length<i.getCommentsTotalCount()?i.fetchContributions(n.getOption("commentsNumberAtInit"),n.getOption("sendInitCallInPool"),!0):!0===n.getOption("sendInitCallInPool")&&l.modifyCallWindowSizeBy(-1)):(i=new o({subjectUri:n.getOption("subjectUri"),commentToScrollToAtInit:n.getOption("commentToScrollToAtInit")},{sharedOptions:e}),n.listenTo(i,{onPopulate:n._onContributionsFetchSuccess,onContributionsFetchFailure:n._onContributionsFetchFailure,commentsFetched:n._filterContentContextIds}),d[n.getOption("subjectUri")]={subject:i,nbUseCases:1},i.fetchContributions(n.getOption("commentsNumberAtInit"),n.getOption("sendInitCallInPool"))),n._successFullInit=!0,n.model=i,t(),this.options.commentToScrollToAtInit=null,n.listenTo(e,"onUserLinkClick",n._onUserLinkClick))}),s)}))),this},_filterContentContextIds:function(t){let e=this,o=[];for(let n=0;n<t.length;n++){let i=t[n].commentUri?t[n].commentUri:t[n].get("commentUri");o.push(i);let s=t[n].richMessage?t[n].richMessage:t[n].get("richMessage"),l=/<div class="[^"]*">(.*?)<\/div>/s.exec(s)[1],c=r.decodeContext(l);for(let t=0;t<c.length;t++){let o=c[t].columnId,n=o.contains("-")?o.split("-")[0].split(","):o.split(","),s=c[t].rowId;for(let t=0;t<n.length;t++)e._pushToContext(n[t],i);e._pushToContext(s,i);let l=[...n,s].join(",");e._pushToContext(l,i)}}let n=this.getOption("subjectUri").replace("pid:","");e.dispatchEvent("commentsFetched",[n,o])},_cleanContentContextIds:function(t){let e=this,o=this.getOption("subjectUri"),n=t.get("allContextIds"),i=t.get("commentUri");n.forEach((t=>{e._popContext(t,i)}));let s=t.get("cellsInfo");s.forEach((t=>{let o=t.columnId,n=[...o.contains("-")?o.split("-")[0].split(","):o.split(","),t.rowId].join(",");e._popContext(n,i)})),delete this.components.get("commentZone").components.get("commentList").commentIdMapping[i],this.dispatchEvent("flag-highlight-comment-context-cell",[s,o,!0,!1])},_pushToContext:function(t,e){null==this.contentContext[t]&&(this.contentContext[t]=new Set),this.contentContext[t].has(e)||this.contentContext[t].add(e)},_popContext:function(t,e){this.contentContext[t]&&this.contentContext[t].delete(e)},setChangedDGVContext:function(t,e){let o=[],n=this;t.forEach((t=>{let e=n.contentContext[t];e&&e.length>0&&(o=[...o,...e])})),o=[...new Set(o)],o.length>0&&o.forEach((t=>{let o=n.components.get("commentZone").components.get("commentList").commentIdMapping[t];o&&o.checkContextStatus(e,n.contentContext)}))},_filterFromState:function(t){this.components.get("commentZone");this._filterState=t;let e=this.getOption("subjectUri");this.dispatchEvent("filtered-comments-status-update",[e])},_createContent:function(){var t=null,e=this;this.getOption("commentToScrollToAtInit");const o=new c;o.hide(),this.components.reset({guestInfoBarView:o}),this.components.addMap(this.model?{actionToolbar:new s({model:this.model,mode:this.getOption("mode"),enableShare:this.getOption("enableShare"),enableComment:this.getOption("enableComment"),enableLike:this.getOption("enableLike")})}:null),this.getOption("enableComment")&&(this.components.addMap({errorAlert:new a({closable:!0,closeOnClick:!0,visible:!1,fullWidth:!0,className:"st-error-msg",messageClassName:"primary",messages:[m.get("CommentsAreNotAvailable")],events:{onInjected:function(){!e._successFullInit||e.model&&e.model.hasFailedToFetchContributions()?this.show():this.hide()},onShow:function(){e.container&&e.container.addClassName("st-loading-error")},onHide:function(){e.container&&e.container.removeClassName("st-loading-error")}}})}),this.components.addMap({commentsNotFoundAlert:new a({closable:!0,closeOnClick:!0,visible:!1,fullWidth:!0,className:"st-error-msg",messageClassName:"primary",messages:[m.get("NoCommentFound")],events:{onInjected:function(){!e._successFullInit||e.model&&e.model.hasFailedToFetchContributions()?this.show():this.hide()},onShow:function(){e.container&&e.container.addClassName("st-loading-error")},onHide:function(){e.container&&e.container.removeClassName("st-loading-error")}}})})),this.getOption("enableComment")&&this.model&&this.getOption("mode")!==i.MODE.LIGHT&&((t=this._createCommentZone()).listenTo(this.model,{onContributionsFetchSuccess:t.show,onContributionsFetchFailure:t.hide}),this._successFullInit&&!this.model.hasFailedToFetchContributions()||t.hide());let n=this,l=this.components.get("actionToolbar");this.listenTo(l,"filter-comments-from-state",this._filterFromState),this.listenTo(this,{"set-comment-context":this._setCommentContext,"set-current-comment-zone-editor":this._setCurrentEditor,onCancelEdition:this._editionCanceled,"xmodel-comment-clicked":function(t){n.components.get("commentZone").components.get("commentList").commentClicked(t)}}),this.listenTo(t,{onCommentCreateSuccess:this._newCommentCreated,onCommentEditSuccess:this._commentEdited,onCommentDeleteSuccess:this._commentDeleted});let r=this.components.toArray(),d=r.indexOf(l);return r.splice(d,1),r.splice(1,0,l),r},_newCommentCreated:function(t){this._flagAndHighlightContext(t,!0,!0,!1)},_commentEdited:function(t){if(this._editorView){let e=this,o=t.get?t.get("commentUri"):t.model.get("commentUri");this._prevCellsInfo.forEach((t=>{let n=t.columnId.split(",");n.forEach((t=>{e._popContext(t,o)})),e._popContext(t.rowId,o);let i=[...n,t.rowId].join(",");e._popContext(i,o)}));let n=this.getOption("subjectUri");this.dispatchEvent("flag-highlight-comment-context-cell",[this._prevCellsInfo,n,!0,!1]);let i=this._editorView.elements.commentMessage;this._editorView.renderContext(i,!0),this._editorView.model.get("contextBroken")||this._flagAndHighlightContext(t,!1,!0,!1)}this._editor=null,this._editorView=null,this._prevCellsInfo=null},_commentDeleted:function(t){this._flagAndHighlightContext(t,!1,!1,!0)},_editionCanceled:function(){this._editor=null,this._editorView=null},_flagAndHighlightContext:function(t,e,o,n){let i;t.model&&(t=t.model),null==t.getParentComment()&&(i=this.components.get("commentZone").components.get("commentList"),n&&this._cleanContentContextIds(t),(o||e)&&(this._filterContentContextIds([t]),i.highlightComment(t,o)))},_setCommentContext:function(t){let e=this.components.get("commentZone");if(this._editor){let e=this._editor.elements.textEditorContainer;this._editor.dispatchEvent("set-comment-context",[t,e])}else e.dispatchEvent("set-comment-context",t)},_setCurrentEditor:function(t,e,o){if(this._editor=t,this._editorView=e,this._prevCellsInfo=Array.isArray(o)?o:[],!e.model.get("contextBroken")){this.components.get("commentZone").components.get("commentList").highlightComment(e.model)}},isCommentOpened:function(t){let e,o=this.components.get("commentZone");o&&o.components.get("commentList")&&(e=o.components.get("commentList"));let n=!1;if(e&&Object.keys(e.commentIdMapping).length>0){let o=t[0].columnId,i=[...o.contains("-")?o.split("-")[0].split(","):o.split(","),t[0].rowId].join(",");if(this.contentContext[i]){this.contentContext[i].forEach((t=>{if(!n){let o,i=e.commentIdMapping[t];if(i&&null==i.model.get("state")){let t=i.model.get("richMessage").match(/(\w+)=["']([^"']+)["']/g),e={};Array.isArray(t)&&t.forEach((t=>{let[o,n]=t.split("=");e[o.trim()]=n.replace(/["']/g,"")})),o=e.class&&e.class.includes("resolve")?"resolve":"open"}else i&&(o=i.model.get("state"));n="open"==o}}))}}return n},updateSocialStatus:function(t,e,o){let n=this.components.get("commentZone"),i=this._filterState;if(n){n.components.get("commentList").updateSocialStatus(t,this.contentContext,e,o,i)}},_createCommentZone:function(){var t=this.getOption("commentToScrollToAtInit");return this.components.addMap({commentZone:new n({model:this.model,collection:this.model.getComments(),cellSelection:this.getOption("cellSelection"),lockedDisplay:this.getOption("mode")===i.MODE.LIGHT&&!t,commentToScrollTo:t&&t.commentUri?{commentUri:t.parentCommentUri||t.commentUri,replyUri:t.parentCommentUri&&t.commentUri}:null})}).commentZone},_onContributionsFetchFailure:function(t){if(!this.isDestroyed()){this.components.get("actionToolbar"),this.components.get("commentZone");var e=this.components.get("errorAlert"),o=this.components.get("commentsNotFoundAlert");t&&t.errorcode===ContainerNotFoundException?o&&o.show():e&&e.show()}}});return h}));