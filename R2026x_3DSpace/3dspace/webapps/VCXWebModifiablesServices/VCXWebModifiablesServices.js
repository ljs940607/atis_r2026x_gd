define("DS/VCXWebModifiablesServices/VCXModifiablesChangeServices",["DS/VCXWebVisu/VCXModifiablesAccess","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebKernelCommands/VCXCmdChangeLinkedProperties","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebProperties/VCXPropertyValueMap","i18n!DS/VCXWebModifiables/assets/nls/VCXWebModifiables"],(function(e,t,r,o,i,a,n,l,s){"use strict";return{Ghost:function(r,o,i,a){var n=e.GetModifiableFromPathElement(o,r);if(!n)return!1;var l=1;return i?(l=.1,n.GetObject().setOpacity(l,!0),n.GetObject().setMaterial(null,!0)):(n.GetObject().setOpacity(null,!0),n.GetObject().setMaterial(null,!0),n.GetObject().setDirtyFlag(t.FDirty.Alpha),n.GetObject().setDirtyFlag(t.FDirty.Material)),i?n.GetObject().setPickability("IGNORED"):n.GetObject().setPickability("PICKABLE"),!0}}})),define("DS/VCXWebModifiablesServices/VCXModifiablesServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertyValueLocation","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebVisibility/VCXIVisibility"],(function(e,t,r,o,i,a,n,l){"use strict";var s=e.singleton({init:function(){},isModifiable:function(e){var t=e.QueryInterface?e.QueryInterface("VCXIModifiable"):null;return e===t},buildPropertyLocationWithTranslationInWCS:function(e,r,o=null){if(this.isModifiable(e)&&r instanceof t.Vector3){var i,a=e.GetProperty("Actor.Position").GetPropertyValue(),n=e.GetObject().getParentWorldPosition(),l=(new t.Matrix4).getInverse(n);if(null==o)i=a.GetPivot().GetValue();else if(o instanceof t.Vector3){var s=(new t.Matrix4).setPosition(o);i=(new t.Matrix4).copy(l).multiply(s)}else o instanceof t.Matrix4?i=(new t.Matrix4).copy(l).multiply(o):(console.warn("Pivot specified not compatible, using modifiable's pivot as rotation pivot"),i=a.GetPivot().GetValue());for(var u=a.GetFrame().GetValue(),c=a.GetPivot().GetValue(),p=0;p<=11;++p)u.elements[p]=parseFloat(u.elements[p]);null!=o&&(c=i.clone());var y=(new t.Matrix4).extractRotation(l),f=(new t.Vector3).copy(r).applyMatrix4(y),P=(new t.Vector3).getPositionFromMatrix(u).add(f),G=(new t.Matrix4).copy(u).setPosition(P),V=(new t.Vector3).getPositionFromMatrix(c).add(f),M=(new t.Matrix4).copy(c).setPosition(V);return this.buildPropertyLocationWithFramePivot(G,M)}console.error("A VCXModifiable and a THREE.Vector3 objects are needed !")},buildPropertyLocationWithRotationInWCS:function(e,r,o){if(this.isModifiable(e)&&r instanceof t.Matrix4){var i,a=e.GetProperty("Actor.Position").GetPropertyValue(),n=e.GetObject().getParentWorldPosition(),l=(new t.Matrix4).getInverse(n);if(null==o)i=a.GetPivot().GetValue();else if(o instanceof t.Vector3){var s=(new t.Matrix4).setPosition(o);i=(new t.Matrix4).copy(l).multiply(s)}else o instanceof t.Matrix4?i=(new t.Matrix4).copy(l).multiply(o):(console.warn("Pivot specified not compatible, using modifiable's pivot as rotation pivot"),i=a.GetPivot().GetValue());var u=(new t.Matrix4).getInverse(i),c=(new t.Matrix4).copy(u).multiply(l),p=(new t.Matrix4).extractRotation(c),y=(new t.Matrix4).getInverse(p),f=a.GetFrame().GetValue(),P=a.GetPivot().GetValue();null!=o&&(P=i.clone());var G=(new t.Matrix4).copy(p).multiply(r).multiply(y),V=(new t.Matrix4).copy(i).multiply(G).multiply(u),M=(new t.Matrix4).copy(V).multiply(f),C=(new t.Matrix4).copy(V).multiply(P);return this.buildPropertyLocationWithFramePivot(M,C)}console.error("At least a VCXModifiableOccurrence and a THREE.Matrix4 objects are needed !")},buildPropertyLocationWithFramePivot:function(e,r){if(e instanceof t.Matrix4&&r instanceof t.Matrix4){var l=new n;l.SetValue(e);var s=new n;s.SetValue(r);var u=new a;return u.SetFrame(l),u.SetPivot(s),new o(new i("Actor.Position",0),u)}console.error("2 THREE.Matrix4 objects are needed as arguments..")},GetFrameInWCSAtTime:function(e,r,o,i,a){var n="Actor.Position",l=r.GetObjectAnimation(o.GetHashing()),s=null,u=e.GetNeutrals(o.GetHashing());if(u)if(l&&l._Tracks&&l._Tracks[n]){var c=o.GetInterpolator(n);null==c&&(c=e.GetDefaultInterpolator(n)),s=c.GetInterpolatedValue(u,n,i,l._Tracks).GetFrame().GetValue()}else{var p=u.GetProperty(n);s=p&&p.GetPropertyValue().GetFrame().GetValue()}s||(s=o.GetProperty(n).GetPropertyValue().GetFrame().GetValue());var y=o.GetObject().QueryInterface("VCXIModelNavigable").getParent(),f=null;if(y&&(f=y.GetObject()),f){var P=f.QueryInterface("VCXIModifiable"),G=this.GetFrameInWCSAtTime(e,r,P,i);return(new t.Matrix4).copy(G).multiply(s)}return s},getDisplayPriority:function(e){var t=e.QueryInterface("VCXIVisibility");if(t&&t.GetVisibility()===l.EVisState.Hidden)return-10;if(e.GetObject().IsKindOf("VCXComponentHotspot")){var r=e.GetProperty("Actor.Enable");return r&&r.GetPropertyValue()&&r.GetPropertyValue().Value?10:-10}var o=e.GetProperty("Actor.Opacity");if(o&&o.GetPropertyValue()&&0===o.GetPropertyValue().Value)return-9;if(e.GetObject().IsDressup)return e.GetPropertyValue("Collab.3D.Paper.Positioning.Type")<=1e3?e.GetPropertyValue("Collab.3D.Paper.Is.Background")?1e-5*e.GetPropertyValue("Collab.3D.Paper.Depth")-5:7+1e-5*e.GetPropertyValue("Collab.3D.Paper.Depth"):e.GetPropertyValue("Actor.IsAlwaysOnTop")?5:0;var i=e.GetProperty("Actor.Priority");return i&&i.GetPropertyValue()?i.GetPropertyValue().Value:0},sortListDisplayPriority:function(e,t){return t.sort((function(t,r){var o=e.ComponentsMap.GetComponentFromID(t),i=e.ComponentsMap.GetComponentFromID(r);if(o&&i){var a=o.QueryInterface("VCXIModifiable"),n=i.QueryInterface("VCXIModifiable");if(a&&n){var l=s.getDisplayPriority(a);return s.getDisplayPriority(n)-l}}})),t},isModifiableUnderMouse:function(e,t){var r=e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer(),o=e.GetProperty("Collab.3D.Paper.Positioning.Type");if(o&&o.GetPropertyValue().Value<=1e3){t.vcxPaperPos||(t.vcxPaperPos=e.GetObject()._experienceBase.getManager("VCXPaperManager").PixelToMM2(null,t.from[0].getCurrentPosition(r.div)));var i=e.GetObject().shapeInfo;if(i&&i.center&&Math.abs(e.GetPropertyValue("Collab.3D.Paper.Paper.Position.X")+i.center.x-t.vcxPaperPos.x)<.5*i.size.x&&Math.abs(e.GetPropertyValue("Collab.3D.Paper.Paper.Position.Y")+i.center.y-t.vcxPaperPos.y)<.5*i.size.y)return!0}return!1},hasVisibleProperties:function(e){var t=e.QueryInterface("VCXIModifiableView");if(t){var r=t.getPropertyGroups();for(var o in r||console.log("No propertyGroups found for component "+e.GetObject().GetType()+"."),r)if(r.hasOwnProperty(o))for(var i=r[o].getPropertiesIDsOrderedArray(),a=0;a<i.length;++a){var n=i[a];if(e.GetProperty(n).GetPropertyInfo().IsVisible())return!0}return!1}var l=e.GetObject().GetType();console.log("Component of type "+l+" doesn't have a modifiableView.")},filterChildrenOfModsFromArray:function(e){return Array.isArray(e)&&0!==e.length?e[0].QueryInterface("VCXIModifiable")!==e[0]?e:this.filterChildrenOfCompsFromArray(e):e},filterChildrenOfCompsFromArray:function(e){if(!Array.isArray(e)||0===e.length)return e;for(var t=e,r=t.map((function(e){var t=e.QueryInterface("W3AISGNodeHolder");return t&&t.getPathElement()})),o=0;o<r.length;++o){var i=r[o];if(i)for(var a=o+1;a<r.length;++a){var n=r[a];if(n)if(i.isAParentOf(n))r[a]=null,t[a]=null;else if(n.isAParentOf(i)){r[o]=null,t[o]=null;break}}}return t.filter((function(e){return null!==e}))},getBBoxInWorldFromComponents:function(e){if(Array.isArray(e)&&0!==e.length){var r=e[0]._experienceBase.getManager("VCXContextManager"),o=r&&r.getMainViewer();if(o){for(var i=new t.Box3,a=0;a<e.length;++a){var n=e[a].QueryInterface("W3AISGNodeHolder"),l=n.getPathElement().getBoundingBox(null,o);l.isNaN()?console.log("VCXModifiablesServices#getBBoxInWorldFromComponents: The pathElement associated to component "+e[a].GetID()+" has an empty BoundingBox.\n It won't be considered in the requested union of bounding boxes."):(l.applyMatrix4(n.getWorldMatrix(o)),i.union(l))}return i}}},GetNeutralLocalMatrix:function(e,r){const o=e._experienceBase,i=o.getManager("VCXScenarioManager"),a=o.getManager("VCXContextManager").getRootComponent(),n=e.QueryInterface("VCXIModifiable"),l=n.GetHashing(),s=i.GetNeutrals(l);let u=new t.Matrix4;if(a.GetID()!==e.GetID()){const e=n.GetProperty("Actor.Position");if(e){u=r?e.GetPropertyValue().GetFrame().GetValue():e.GetPropertyValue().GetPivot().GetValue()}}if(s){const e=s.GetProperty("Actor.Position");if(e){const t=e.GetPropertyValue();return r?t.GetFrame().GetValue():t.GetPivot().GetValue()}return u}return u},GetNeutralWorldFrameMatrix:function(e){const r=e.QueryInterface("VCXIModelNavigable");return r.getParent()?(new t.Matrix4).copy(this.GetNeutralWorldFrameMatrix(r.getParent().GetObject())).multiply(this.GetNeutralLocalMatrix(e,!0)):this.GetNeutralLocalMatrix(e,!0)},GetNeutralWorldPivotMatrix:function(e){const r=e.QueryInterface("VCXIModelNavigable");return r.getParent()?(new t.Matrix4).copy(this.GetNeutralWorldPivotMatrix(r.getParent().GetObject())).multiply(this.GetNeutralLocalMatrix(e,!1)):this.GetNeutralLocalMatrix(e,!1)},GetCurrentLocalMatrix:function(e,t){const r=e.QueryInterface("VCXIModifiable").GetProperty("Actor.Position");return r?t?r.GetPropertyValue().GetFrame().GetValue():r.GetPropertyValue().GetPivot().GetValue():(console.warn("Actor.Position property not found"),null)},GetCurrentWorldMatrix:function(e,r){e._experienceBase.getManager("VCXContextManager").getMainViewer();const o=e.QueryInterface("VCXIModifiable"),i=e.getParentWorldPosition(),a=o.GetProperty("Actor.Position");if(a){const e=r?a.GetPropertyValue().GetFrame().GetValue():a.GetPropertyValue().GetPivot().GetValue();return(new t.Matrix4).copy(i).multiply(e)}return console.warn("Actor.Position property not found"),null},ComputeOriginalWorldMatrices:function(e){return{frame:this.GetNeutralWorldFrameMatrix(e),pivot:this.GetNeutralWorldPivotMatrix(e)}},ComputeOriginalLocalMatrices:function(e){return{frame:this.GetNeutralLocalMatrix(e,!0),pivot:this.GetNeutralLocalMatrix(e,!1)}},ComputeCurrentWorldMatrices:function(e){return{frame:this.GetCurrentWorldMatrix(e,!0),pivot:this.GetCurrentWorldMatrix(e,!1)}},ComputeCurrentLocalMatrices:function(e){return{frame:this.GetCurrentLocalMatrix(e,!0),pivot:this.GetCurrentLocalMatrix(e,!1)}}});return s}));