define("DS/ENOFilterExplicitWebInWin/views/filterRepairUI",["UWA/Core","UWA/Promise","UWA/Class/View","DS/TreeModel/TreeNodeModel","DS/Handlebars/Handlebars4","DS/UIKIT/SuperModal","DS/UIKIT/Mask","DS/WAFData/WAFData","DS/Controls/Accordeon","DS/Controls/TooltipModel","DS/Controls/Button","DS/CollectionView/ResponsiveLargeTilesCollectionView","i18n!DS/ENOFilterExplicitWebInWin/assets/nls/ENOStrRefinementUX.json","text!DS/ENOFilterExplicitWebInWin/template/filterRepairUITemplate.html","css!DS/ENOFilterExplicitWebInWin/ENOFilterExplicitWebInWin.css","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen"],(function(e,t,a,i,r,n,o,l,s,c,d,h,p,u,g,f,_,m,v,b){"use strict";return a.extend({setup:function(e){this._isRepairFilterLaunchedInWidget=!1,this._trackerId="isWebInWin",this.securityCtx=e.ctx,this._filteredRoot=e.filteredRoot,this._pathBeginWithInstance=0;let t=e.filteringParams;if(t){let e=t.platform_services;f.updateFilteringContext({tenant:e[0].platformId}),_.setOption("str_platformServices",e),this._rootPathId=t.rootPId,this._rootPathLogicalId=t.rootLId}this._repairBasedOnExpand=f.isActivated("RepairFilterV2")&&m.getOption("RepairFilterV2")?1:0,this._brokenPathObj="object"==typeof e.brokenPaths?e.brokenPaths:JSON.parse(e.brokenPaths),this._template=r.compile(u),this._notificationsManager=v,b.setNotificationManager(this._notificationsManager),b.setStackingPolicy(5),this._fetchURL=e.url+"/cvservlet/fetch/v2",this._getGoodVersionsIdsURL=e.url+"/resources/FilterInternal/ExplicitMgt/getGoodVersionsIds"},render:function(){var t=this;this.container.setContent(this._template({AppType:this._isRepairFilterLaunchedInWidget?"widget":"webInWin",filterNameToRepair:p.get("RepairPanelHeader")+(this._brokenPathObj.filterName?": "+this._brokenPathObj.filterName:"")})),this.container=this.container.getElement(".filter-container-widget-div"),this._ListOfTileViewCollection=[],this._accordeon=new s({touchMode:!1,style:"filled-separate"}),this._accordeon.inject(this.getElement(".repairFilter-list-accordeons"));let a=[];t._brokenPathObj.pathsPerSpec.forEach((e=>{a=a.concat(e.paths)}));let r=a.length;var o=function(e,a){var i=e.getLabel();let r;for(var n=t._ListOfTileViewCollection.length,o=0;o<n;o++){var l=t._ListOfTileViewCollection[o].model;if(l){let e=l.length;for(var s=0;s<e;s++)if(i===l[s].getLabel()){r=t._accordeon.getExpanderFromIndex(o);break}}}if(r){var c=r.customHeader.getElement(".statusRepair");c.setText("add"===a?p.get("SolvedCellName"):p.get("IgnoreCellName")),c.removeClassName("add"===a?"ignoreRemove":"ignoreAdd"),c.addClassName("add"===a?"ignoreAdd":"ignoreRemove"),r.customHeader.getElement(".ignoreRepair").setText("add"===a?p.get("IgnoreTitle"):p.get("ReactivateTitle"))}};let l=t._responseJsonObj.paths.length;for(var u=0;u<l;u++){var g=new h({height:"inherit",displayTitleTooltip:!0,displayPropertiesTooltip:!0,useDragAndDrop:!1,toggle:!0});g.selectionBehavior={unselectAllOnEmptyArea:!0,toggle:!0,canMultiSelect:!1,enableShiftSelection:!1,enableListSelection:!1,enableFeedbackForActiveCell:!0};var _=[];let n=t._responseJsonObj.paths[u],l=n.length;for(var m=0;m<l;m++){var v=n[m];if(t._checkForDeletedPath(v))if(!this._checkForReplacedPath(v,a[u])){var b=this._buildNodeFromData(v);if(b.label){var F=v.length-1,I=new i({label:b.label,subLabel:v[F].trueType,thumbnail:v[F].preview_url,data:b.data});_.push(I)}}}let s=a[u],d=_.length;if(this._ListOfTileViewCollection.push(g),d){g.model=_,g.modelProvider.selectNode(_[0]);var S=e.createElement("div",{class:"tile1 accordeon-node"});g.inject(S);var R=115*d+"px";S.setStyle("height",R);var E={header:s[s.length-1].name,content:S};let a=this._accordeon.addItem(E);var y=e.createElement("span",{class:"ignoreRepair",text:p.get("IgnoreTitle")});y.setAttribute("expander",u);var O=e.createElement("span",{class:"statusRepair",text:p.get("SolvedCellName")});let i=this._accordeon.getExpanderFromIndex(this._accordeon.getIndexFromId(a));i.customHeader||(i.customHeader=e.createElement("div",{class:"wux-controls-expander-header-container"})),O.inject(i.customHeader),y.inject(i.customHeader),i.headerTooltipInfos=new c({shortHelp:E.header,mouseRelativePosition:!0}),y.addEventListener("click",(function(e){var a=e.target.getAttribute("expander"),i=t._ListOfTileViewCollection[a],r=e.target.getText();p.get("IgnoreTitle")===r?(e.target.setText(p.get("ReactivateTitle")),i.unselectAll()):p.get("ReactivateTitle")===r&&(e.target.setText(p.get("IgnoreTitle")),i.modelProvider.selectNode(i.model[0]))}))}else if(u<r){var T=new UWA.Element("div",{text:p.get("ObjectDeleted")});E={header:s[s.length-1].name,content:T};let t=this._accordeon.addItem(E);var k=e.createElement("span",{class:"ignoreRepair deletedPath",text:p.get("Deleted")});let a=this._accordeon.getExpanderFromIndex(this._accordeon.getIndexFromId(t));a.customHeader||(a.customHeader=e.createElement("div",{class:"wux-controls-expander-header-container"})),k.inject(a.customHeader),a.headerTooltipInfos=new c({shortHelp:E.header,mouseRelativePosition:!0})}g.onSelectionAdd((function(e){o(e,"add")})),g.onSelectionRemove((function(e){o(e,"remove")}))}var P=this.getElement(".repairFilter-footer"),N=t._isRepairFilterLaunchedInWidget?"TitleOK":"TitleApply";return this.applyButton=new d({touchMode:!0,domId:"applyButton",label:p.get(N),emphasize:"secondary"}).inject(P),this._isRepairFilterLaunchedInWidget||(this.saveButton=new d({touchMode:!0,domId:"saveButton",label:p.get("TitleSave"),emphasize:"secondary"}).inject(P),this.saveButton.addEventListener("buttonclick",(function(){new n({closable:!0,renderTo:document.body,id:"superModaldialog"}).confirm(p.get("SaveWarning"),p.get("SaveWarningTitle"),(function(e){if(f.setUsageTracker(t._trackerId,"NGF-RepairFilter","save-solved-repair"),console.log("Confirm result: "+e),e){var a=t._operateModel();t._webInWinNotif("SaveButton",a.listOfList)}}))}))),this.cancelButton=new d({touchMode:!0,domId:"cancelButton",label:p.get("TitleCancel"),emphasize:"secondary"}).inject(P),this.cancelButton.addEventListener("buttonclick",(function(){if(f.setUsageTracker(t._trackerId,"NGF-RepairFilter","cancel-solved-repair"),t._isRepairFilterLaunchedInWidget){t.dispatchEvent("NGF_CancelRepairFilter",{listOfList:"CancelRepair"})}else t._webInWinNotif("CancelButton")})),this.applyButton.addEventListener("buttonclick",(function(){f.setUsageTracker(t._trackerId,"NGF-RepairFilter","apply-solved-repair");var e=t._operateModel();t._isRepairFilterLaunchedInWidget?t.dispatchEvent("NGF_RepairFilter",e):t._webInWinNotif("ApplyButton",e.listOfList)})),this},RepairFilterInWidget:function(e){this._isRepairFilterLaunchedInWidget=!0,this._trackerId=e},_buildDataForExpand:function(t,a){let i=a.configuration;i=i&&Array.isArray(i)&&i.length?i:void 0;let r=new Map,n=[];a.pathsPerSpec.forEach(((e,a)=>{let o,l,s,c=[],d=[];if(e.paths.forEach((e=>{d=[{uql:'(physicalid:"'+t+'")'}];let a=e.length,i=this._pathBeginWithInstance?0:1,n=this._pathBeginWithInstance?[this._rootPathLogicalId]:[e[0].logicalid];for(let t=i;t<a;t++)n.push(e[t].logicalid),"PLMCoreInstance"===e[t].coretype&&d.push({uql:'(logicalid:"'+e[t].logicalid+'")'});r.set(n.toString(),[]),c.push({sequence_filter:{sequence:d}})})),c.length&&(o={or:{filters:c}}),i&&i[a])try{l=JSON.parse(i[a])}catch(e){l={config_filter:i[a]}}s=o?l?[l,o]:[o]:l?[l]:[],s.length&&n.push({and:{filters:l?[l,o]:[o]}})}));let o={};o.or={filters:n};return{queryV2:{batch:{expands:[{label:"RepairFilter_Query_"+Date.now(),root:{physical_id:t},filter:o,graph:{descending_condition:{uql:"[ds6w:type]:*"}},aggregation_processors:[{truncate:e.merge({match_only_refs:1},o)}]}]},outputs:{format:"entity_relation_occurrence_label",select_object:["physicalid","logicalid","ds6w:type","ds6w:label","ds6wg:revision"],select_relation:["physicalid","logicalid","ds6w:type","ds6w:label"]}},mapBroken:r}},fetchData:function(){var e=this;this._brokenPathObj.pathsPerSpec||(this._brokenPathObj.pathsPerSpec=[],this._brokenPathObj.pathsPerSpec.push({paths:this._brokenPathObj.paths}));let a=[];this._brokenPathObj.pathsPerSpec.forEach((e=>{a=a.concat(e.paths)}));let i=a.length;return new t((function(t){const r=2*f.MAX_SELECTION_PATH;if(r<i){let a=UWA.String.format(p.get("ExceedMaximumPathToRepair"),i,r);e._setOutputOnRepairError(i,{code:-1,type:"MAX_PATH_EXCEEDED",message:a}),t("RepairFilterFetchData_SUCCESS")}else if(1===e._repairBasedOnExpand){let r=Date.now(),u=e._filteredRoot;i&&(u=a[0][0].physicalid,-1!==a[0][0].coretype.lastIndexOf("Instance")&&(u=e._rootPathId,e._pathBeginWithInstance=1));let g=e._buildDataForExpand(u,e._brokenPathObj),v=g.queryV2,b=g.mapBroken;var n=f.getProgressiveExpandUrl(f.getTenant(),"3DSpace"),s=m.getOption("timeoutExpandSynthesis")||12e4;l.authenticatedRequest(n,{label:"RepairFilter_"+Date.now(),headers:_.getRESTHeaders(e.securityCtx),method:"POST",data:JSON.stringify(v),type:"json",proxy:"passport",timeout:s,onComplete:function(a){if(f.setPerformanceTracker(e._trackerId,"NGF-RepairFilter","NGF_RepairFilter",{Fetch_duration:Date.now()-r},1),a.errors){console.log(" => Repair Filter / Expand failed : "),a.errors.forEach((function(e){console.log("     . "+e.code+": "+e.reason)}));let r=p.get("BrokenPathDeleted");e._setOutputOnRepairError(i,{code:0,type:"REPAIR_FAILED",message:r}),t("RepairFilterFetchData_SUCCESS")}else{let i=a.results;i.forEach((e=>{if(e&&e.Path){let t=[],a=[];e.Path.forEach((e=>{let r=i.find((t=>{if(t&&!t.Path)return t.resourceid===e}));r&&(t.push(r.logicalid),a.push(r))}));let r=b.get(t.toString());if(r){let e=[];a.forEach((t=>{if(t){let a,i=t["ds6w:type"];-1!==i.indexOf("RepInstance")?a="PLMCoreRepInstance":-1!==i.indexOf("Instance")?a="PLMCoreInstance":-1!==i.indexOf("RepReference")?a="PLMCoreRepReference":-1!==i.indexOf("Reference")?a="PLMCoreReference":-1!==i.indexOf("3DShape")&&(a="3DShape"),e.push({coretype:a,physicalid:t.resourceid,logicalid:t.logicalid,name:t["ds6w:label"],revision:t["ds6wg:revision"]})}else{}})),e.length&&r.push(e)}}})),e._responseJsonObj={paths:[]};for(let t of b.values())e._responseJsonObj.paths.push(t);e._responseJsonObj?e._getThumbnailAndTypeInfo().then((function(){t("RepairFilterFetchData_SUCCESS")})):t("RepairFilterFetchData_SUCCESS")}},onFailure:function(a){console.log(" => Repair Filter / Expand failure : "),console.log("   . "+a);let r=p.get("BrokenPathDeleted");e._setOutputOnRepairError(i,{code:0,type:"REPAIR_FAILED",message:r}),o.unmask(e.container),t("RepairFilterFetchData_SUCCESS")}}),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-count",value:i});var c=0,d=1/0,h=0;a.forEach((e=>{c+=e.length,d=Math.min(d,e.length),h=Math.max(h,e.length)})),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-min",value:d}),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-max",value:h}),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-average",value:c/i*1e3})}else{let r=Date.now();l.authenticatedRequest(e._getGoodVersionsIdsURL,{headers:_.getRESTHeaders(e.securityCtx),method:"POST",data:JSON.stringify({paths:a}),onComplete:function(a){f.setPerformanceTracker(e._trackerId,"NGF-RepairFilter","NGF_RepairFilter",{Fetch_duration:Date.now()-r},1);var i=JSON.parse(a);"object"==typeof i&&Array.isArray(i.paths)?e._responseJsonObj=i:e._responseJsonObj={paths:[]},e._responseJsonObj?e._getThumbnailAndTypeInfo().then((function(){t("RepairFilterFetchData_SUCCESS")})):t("RepairFilterFetchData_SUCCESS")},onFailure:function(a){console.log(" => Repair Filter / getGoodVersionsIds failed, error = "+a);let r=p.get("BrokenPathDeleted");e._setOutputOnRepairError(i,{code:a.code,type:a.type,message:r}),o.unmask(e.container),t("RepairFilterFetchData_SUCCESS")}}),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-count",value:i});c=0,d=1/0,h=0;a.forEach((e=>{c+=e.length,d=Math.min(d,e.length),h=Math.max(h,e.length)})),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-min",value:d}),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-max",value:h}),f.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-average",value:c/i*1e3})}}))},displayNotification:function(e){e.sticky=e.sticky||!1,this._notificationsManager.addNotif(e)},_checkForDeletedPath:function(e){let t=e.length;if(0===t)return!1;for(var a=0;a<t;a++)if(!e[a].name)return!1;return!0},_checkForReplacedPath:function(e,t){return e[e.length-1].logicalid!==t[t.length-1].logicalid},_buildNodeFromData:function(e){let t={},a=e.length-1;if(a>1&&e[a].name){var i=e[a-1].name+" - "+e[a].revision,r=e[a-1].coretype,n=[],o=[];e.forEach((e=>{n.push(e.physicalid),o.push(e.logicalid)})),t={label:i,subLabel:r,data:{pathOfPhysicalID:n,pathOfLogicalID:o}}}return t},_webInWinNotif:function(e,t){var a=JSON.stringify(t);console.log(a),"undefined"!=typeof CATCefSendString&&dscef.sendString(e+"="+a)},_operateModel:function(){for(var e=[],t=[],a=this._ListOfTileViewCollection.length,i=0;i<a;i++){var r=this._ListOfTileViewCollection[i],n=r.getActiveCellID();if("undefined"!==n&&r.modelProvider.isNodeSelected(r.model[n])){var o=r.getModelAt(n).options.data;e.push(o.pathOfPhysicalID),t.push(o.pathOfLogicalID)}}return{listOfList:e}},_getThumbnailAndTypeInfo:function(){var e=this;return new t((function(t){var a=e._responseJsonObj.paths,i=new Set;a.forEach((e=>{e.forEach((e=>{var t=e.length;t>0&&i.add(e[t-1].physicalid)}))})),i.size>0?(i=[...i],e._fetchTypeUrlInfo(i).then((function(e){if(e.results=e.results||[],e.results.length<=i.length){var r=[];e.results.forEach((e=>{var t,a,i;e.attributes.forEach((e=>{"resourceid"===e.name?t=e.value:"preview_url"===e.name?a=e.value:"type"===e.name&&(i=e.value)})),r.push({physicalid:t,url:a,type:i})})),a.forEach((e=>{e.forEach((e=>{var t=e.length-1;if(t>=0){var a=e[t].physicalid;r.forEach((i=>{a===i.physicalid&&(e[t].preview_url=i.url,e[t].trueType=i.type)}))}}))})),t()}}))):t()}))},_fetchTypeUrlInfo:function(e){var a=this;return new t((function(t,i){var r={headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_ExecuteFetch",physicalid:e,select_file:["icon","thumbnail_2d"],select_predicate:["type","coretype"]}),onComplete:function(e){t(e)},onFailure:function(e){i(e)}};l.authenticatedRequest(a._fetchURL,r)}))},_setOutputOnRepairError:function(e,t){let a=[];for(let t=0;t<e;t++)a.push([]);this._responseJsonObj={error:t,paths:a},this.displayNotification({level:"warning",title:p.get("RepairFilterTitle"),message:t.message})}})}));