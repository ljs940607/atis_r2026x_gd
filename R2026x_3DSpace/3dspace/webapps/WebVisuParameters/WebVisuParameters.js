define("DS/WebVisuParameters/CSICustomNodeHandler",["UWA/Class","DS/Visualization/Node3D"],(function(e,t){"use strict";return e.extend({init:function(){},handleMessage:function(e){return t()},handleUpdateMessage:function(e,t){}})})),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";return class{constructor(e){this._addedPaths=null,this._keyToPath=null,this._treeKeyToStruct=new Map,this._currentTreeKey=null,this.viewer=e,this._event="",this.highlightColor=null}_setTreeKey(e){let t=null;this._currentTreeKey=e,this._treeKeyToStruct.has(e)&&(t=this._treeKeyToStruct.get(e)),t||(t={keyToPath:new Map,addedPaths:new Map},this._treeKeyToStruct.set(e,t)),this._keyToPath=t.keyToPath,this._addedPaths=t.addedPaths}getPathFromKey(e){return this._keyToPath.get(e)}_add(t){e.publish({event:"/VISU/SELECTION/CSI_"+this._event+"_ADD",data:{eventChannel:"/VISU/SELECTION/CSI_"+this._event+"_ADD",eventType:"@CSI_"+this._event+"_ADD",path:t,parameters:{highlightColor:this.highlightColor,viewer:this.viewer}}})}add(e){const t=e.hash(),i=this._addedPaths;this._keyToPath.set(t,e),i.has(t)?i.set(t,i.get(t)+1):(i.set(t,1),this._add(e))}_remove(t){e.publish({event:"/VISU/SELECTION/CSI_"+this._event+"_REMOVE",data:{eventChannel:"/VISU/SELECTION/CSI_"+this._event+"_REMOVE",eventType:"@CSI_"+this._event+"_REMOVE",path:t,parameters:{highlightColor:this.highlightColor,viewer:this.viewer}}})}remove(e){const t=e.hash(),i=this._addedPaths;i.has(t)&&(i.set(t,i.get(t)-1),0===i.get(t)&&(i.delete(t),this._keyToPath.delete(t),this._remove(e)))}removeAll(){const e=this;this._addedPaths&&this._addedPaths.forEach((function(t,i,r){const n=e.getPathFromKey(i);if(n)for(let i=0;i<t;i++)e.remove(n)}))}}})),define("DS/WebVisuParameters/ImagePixelHelper",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/SceneGraphNodes/BillBoardNode3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/GraphicAttributeSet"],(function(e,t,i,r,n,a){"use strict";let o=new e.Vector2(0,0),s=null,l=0,d=0,c=null;const u={type:"Spherical"};let h=null;const g=1,p=2,f=3,m=function(t,i){s=e.MaterialUtils.createMatteFaceMaterial({color:16777215,side:e.DoubleSide}),s.useLighting=!1,s.transparent=!0,s.useLighting=!1,s.useGASColor=!0,s.activatePDSFX("PDSFXImagePixelHelper");s.setPDSFXVaryings({vTexCoord:{type:"v3"}});let r=new e.Vector2(1/i.x,1/i.y),n=new e.Matrix4;n.set(3/9,3/9,3/9,0,2/9,2/9,2/9,0,1/9,1/9,1/9,0,0,0,0,0);var a={textMask:{type:"t2",value:t},invSize:{type:"v2",value:r},filterWeights:{type:"m4",value:n},gamma:{type:"f",value:1}};s.setPDSFXUniforms(a);return s.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                    ${e.getVarying("vTexCoord")} = ${e.vGetAttribTexCoord0()}.xyz;\n                    `}},{ProcessFinalColor:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions,n=t=>e.getTextureUniform(t),a=t=>e.getUniform(t),o=e=>i.float(e),s=e=>i.vec2(e),l=e=>i.vec3(e),d=e=>i.vec4(e),c=i.dereference(t[0]),u=a("filterWeights"),h=a("invSize"),g=a("gamma"),p=n("textMask");return`\n                        ${d("alpha")};\n                        ${s("coord")} = ${e.getVarying("vTexCoord")}.xy;\n                        alpha.g = ${r.sample2DTexture(n(p),"coord")}.r;\n\n                        ${s("coordxm1")}  = coord + ${s()}(-${h}.x,0.0);\n                        alpha.r = ${r.sample2DTexture(n(p),"coordxm1")}.r;\n\n                        ${s("coordxp1")}  = coord + ${s()}(${h}.x,0.0);\n                        alpha.b = ${r.sample2DTexture(n(p),"coordxp1")}.r;\n\n                        ${s("coordxm2")}  = coord + ${s()}(-2.0*${h}.x,0.0);\n                        ${o("rp")} = ${r.sample2DTexture(n(p),"coordxm2")}.r;\n\n                        ${s("coordxp2")}  = coord + ${s()}(2.0*${h}.x,0.0);\n                        ${o("bn")}   = ${r.sample2DTexture(n(p),"coordxp2")}.r;\n\n                        ${s("coordxm3")}  = coord + ${s()}(-3.0*${h}.x,0.0);\n                        ${o("rpp")}   = ${r.sample2DTexture(n(p),"coordxm3")}.r;\n\n                        ${s("coordxp3")}  = coord + ${s()}(3.0*${h}.x,0.0);\n                        ${o("bnn")}   = ${r.sample2DTexture(n(p),"coordxp3")}.r;\n\n                        ${d("alpha4")};\n                        alpha4.r = dot(vec3(alpha.r, rp, alpha.g),${u}[0].xyy) + dot(${s()}(rpp,alpha.b),${u}[0].zz);\n                        alpha4.g = dot(vec3(alpha.g,alpha.r,alpha.b),${u}[1].xyy) + dot(${s()}(rp,bn),${u}[1].zz);\n                        alpha4.b = dot(vec3(alpha.b,alpha.g,bn),${u}[2].xyy) + dot(${s()}(alpha.r,bnn),${u}[2].zz);\n                        alpha4.a = (alpha.r + alpha.g + alpha.b) / 3.0;\n\n                        ${l("gamma3")} = vec3(${g});\n\n                        ${l("scolor1")}  = pow(alpha4.rgb * ${c}.a,gamma3);\n\n                        ${c}.r = pow(${c}.r,${g});\n                        ${c}.g = pow(${c}.g,${g});\n                        ${c}.b = pow(${c}.b,${g});\n                        ${c}.a = (scolor1.r + scolor1.g + scolor1.b)/3.0;\n                    `}}),s.needsUpdate=!0,s};return{createFreeTypeText:function(t,i,r,u){const h=t.point;r.magFilter=e.NearestFilter,r.minFilter=e.NearestFilter,r.wrapS=e.ClampToEdgeWrapping,r.wrapT=e.ClampToEdgeWrapping,r.generateMipmaps=!1;let v,y={x:r.image.width,y:r.image.height},S=t.freetypeTextGPInfo.format.hint;S===p?v=function(t){s=e.MaterialUtils.createMatteFaceMaterial({color:16777215,side:e.DoubleSide}),s.useLighting=!1,s.transparent=!0,s.useLighting=!1,s.useGASColor=!0,s.activatePDSFX("PDSFXImagePixelHelper"),s.setPDSFXVaryings({vTexCoord:{type:"v3"}});var i={textMask:{type:"t2",value:t}};return s.setPDSFXUniforms(i),s.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                    ${e.getVarying("vTexCoord")} = ${e.vGetAttribTexCoord0()}.xyz;\n                    `}},{ProcessFinalColor:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions,n=t=>e.getTextureUniform(t),a=i.dereference(t[0]),o=n("textMask");return`\n                        ${s="alpha",i.float(s)};\n                        ${(e=>i.vec2(e))("coord")} = ${e.getVarying("vTexCoord")}.xy;\n                        alpha = ${r.sample2DTexture(n(o),"coord")}.r;\n                        ${a}.a = alpha;\n                    `;var s}}),s.needsUpdate=!0,s}(r):S===g?(console.error("HINT_MONO not implemented using DEFAULT_HINT instead (will cause blurry freetypeText)"),v=m(r,y)):S===f?(console.error("HINT_3D_SCALABLE not implemented using DEFAULT_HINT instead (will cause blurry freetypeText)"),v=m(r,y)):v=m(r,y),v.force=!0,o=new e.Vector2(0,0),o.x=t.freetypeTextGPInfo.min.x,o.y=t.freetypeTextGPInfo.min.y,l=t.freetypeTextGPInfo.max.x-t.freetypeTextGPInfo.min.x,d=t.freetypeTextGPInfo.max.y-t.freetypeTextGPInfo.min.y;var _=n.createRectangleNode({width:l,height:d,cornerPoint:o,fill:!0,material:v});_.setMaterialMode(!0),_.setShadow(!1,!1),_.setMirror(!1);const D=_.getPrimitives();var w=new a({basic:!0,colorIndex:e.COLORMAP_INDEX.FOREGROUND,inheritance:e.GASEnum.COLOR_INHERITANCE_OFF,inheritanceCustom:e.GASEnumCustom._TYPE_FROM_PARENT});return _._setGAS([D[0]],w),c=(new e.Matrix4).setPosition(h),_.setMatrix(c),_},createImagePixel:function(r,a,s){let g=new e.Vector2(0,0),p=1;const f=r.point;g=r.imageGPInfo.offset,p=r.imageGPInfo.alpha;var m=new e.MeshBasicMaterial({color:16777215,map:s,side:e.DoubleSide,alphaTest:.1});m.transparent=!0,m.force=!0,a&&a.isNative2D()&&(new t)._setPDSFXDepthPriority(m,4,!1),l=s.image.width,d=s.image.height,o=new e.Vector2(0,0),r.imageGPInfo.is3D?(o.x=-l/2,o.y=-d/2,g&&(o.x+=g.x,o.y+=g.y)):g&&(o.x+=g.x,o.y+=g.y),r.imageGPInfo.zoomQuality&&r.pixelSizes&&r.pixelSizes.length&&(l*=r.pixelSizes[0],d*=r.pixelSizes[1]);var v=n.createRectangleNode({width:l,height:d,cornerPoint:o,fill:!0,material:m});return v.setMaterialMode(!0),r.imageGPInfo.zoomQuality||v.setRatio(1),c=(new e.Matrix4).setPosition(f),h=new i(u),h.setMatrix(c),h.addChild(v),h}}})),define("DS/WebVisuParameters/CustomDataParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientCustomDataParameter","DS/Visualization/Node3D"],(function(e,t,i){"use strict";return e.extend({init:function(e,t){this.parameter=e,this.onFinishedCB=t},getNode:function(){var e=this,t=new i;return require([this.parameter.getModule()],(function(i){if(i){var r=(new i).handleMessage(e.parameter.getData());t.addChild(r),e.onFinishedCB&&e.onFinishedCB()}}),this.onModuleError),t},modifyNode:function(e){var t=this;require([this.parameter.getModule()],(function(i){if(i){var r=new i,n=null;if(e){n=e.children[0];for(var a=e.getChildren(),o=0;o<a.length;o++)if(!a[o].getModelIdentification()){n=a[o];break}}r.handleUpdateMessage(t.parameter.getData(),n),t.onFinishedCB&&t.onFinishedCB()}}),this.onModuleError)},onModuleError:function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing.")}})})),define("DS/WebVisuParameters/CSISelectionObject",["DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject"],(function(e){return e})),define("DS/WebVisuParameters/GraphicPropertyParameterHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/GraphicAttributeSet","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/VisuLoaders/ThreeDXLoader","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/CSIViewModelWebInterfaces/CSIViewModelWebEnv","DS/CSIViewModelWebInterfaces/CSIVMClientDrawGroupParameter","DS/CSIViewModelWebInterfaces/CSIVMClientCustomPropertyParameter","DS/Visualization/PickingMode","DS/Visualization/RenderStyle","DS/Visualization/Filters/GeomTypeFilter","DS/Visualization/Filters/DoNotPickUnderFilter","DS/Visualization/Filters/LookFilter","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,n,a,o,s,l,d,c,u,h,g,p,f,m,v){"use strict";function y(e){v.begin(`GraphicPropertyParameterHelper::${e}`)}function S(e){v.end(`GraphicPropertyParameterHelper::${e}`)}var _=new a,D=new o,w=-1,T=new Map,P=new Map,C=c.prototype.geomTypeValues,I={};I[C.unknown]=t.GeomTypeEnum.UNKNOWN,void 0!==C.unknown_2D&&(I[C.unknown_2D]=t.GeomTypeEnum.FACE),I[C.edge]=t.GeomTypeEnum.EDGE,I[C.wire_Edge]=t.GeomTypeEnum.WIRE_EDGE,I[C.boundary_Edge]=t.GeomTypeEnum.BOUNDARY_EDGE,I[C.sharp_Edge]=t.GeomTypeEnum.SHARP_EDGE,I[C.smooth_Edge]=t.GeomTypeEnum.SMOOTH_EDGE,I[C.high_curvature_edge]=t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE,I[C.hidden_Seam_Edge]=t.GeomTypeEnum.HIDDEN_SEAM_EDGE,I[C.boundary_Point]=t.GeomTypeEnum.BOUNDARY_POINT,I[C.sharp_Point]=t.GeomTypeEnum.SHARP_POINT,I[C.smooth_Point]=t.GeomTypeEnum.SMOOTH_POINT,I[C.hidden_Seam_Point]=t.GeomTypeEnum.HIDDEN_SEAM_POINT,I[C.surfacic_Point]=t.GeomTypeEnum.SURFACIC_POINT,I[C.free_Point]=t.GeomTypeEnum.FREE_POINT,I[C.infinite_Face]=t.GeomTypeEnum.INFINITE_FACE,I[C.face]=t.GeomTypeEnum.FACE;var M=0,E=1,b=2,A=3,V=4,O=9;return e.extend({init:function(e,t){this.clientManager=t,this.parameter=e},applyMatAppsToElt:function(e,t,i,r,n,a){if(e){y("applyMatAppsToElt");for(var o=0;o<t.length;o++)this.applyMatAppToElt(e[t[o]],i,r,n,a);S("applyMatAppsToElt")}},removeAllMatAps:function(e){e.removeMaterialApplication();{let t=e.getChildren();for(let i=0;i<t.length;i++){let r=t[i];r._isDecal&&r.unapply(e)}}P.forEach(((t,i,r)=>{t.has(e)&&t.get(e).detach(e)}))},applyMatAppToElt:function(e,t,i,r,n){if(e){y("applyMatAppToElt");var a=e;if(a.isDecal){if(!a.decal)return;var o=a.decal,s=P.get(a.uid);s||(s=new Map,P.set(a.uid,s)),o.__shareAttachementFrom(s),a.apply&&o.applyOn(i),a.attach&&o.attachTo(i)}else t?(n.length>0&&i._setMaterialOnGeomTypes(n,a),i instanceof l?Array.isArray(r)&&r.length>0&&i.setMaterial(r,a):r.forEach((function(e){e.setMaterial&&e.setMaterial(a)}))):(i.removeMaterialApplication(),i.setMaterialApplication(a));S("applyMatAppToElt")}},applyMaterialToElt:function(e,t,i,n,a,o,s,d){if(e&&e[t]){y("applyMaterialToElt");var c=e[t];if(a){var u=new r({geometricalFaceMaterial:c,layer:i,inheritance:n});d.length>0&&o._setMaterialOnGeomTypes(d,u),o instanceof l?Array.isArray(s)&&s.length>0&&o.setMaterial(s,u):s.forEach((function(e){e.setMaterial&&e.setMaterial(u)}))}else o.removeMaterialApplication(),o.setMaterialApplication(new r({geometricalFaceMaterial:c,layer:i,inheritance:n}));S("applyMaterialToElt")}},removeTextureFromCache:function(e){_&&_.removeImage(e)},applyGP:function(e,r,a,o){if(void 0!==e&&void 0!==r){var s=this.parameter;if(void 0!==s){var d=this,c=[];Array.isArray(o)&&o.forEach((function(e){c.push(I[e])}));var g=Array.isArray(a)&&a.length>0||c.length>0,v=!1,P={},C=s.getGasStruct();void 0!==C&&Object.keys(C).length>0?(v=!0,void 0!==C.colorRGB&&Number.isInteger(C.colorRGB)&&(C.colorRGB=new t.Color(C.colorRGB)),void 0!==C.colorA&&Number.isInteger(C.colorA)&&(C.colorA/=255),void 0!==C.showFree&&(g||(P.showFree=C.showFree)),void 0!==C.noShow&&(g?C.show=!C.noShow:P.show=!C.noShow),void 0!==C.noPick&&(g||(P.pick=C.noPick?i.PICKTHROUGH:i.PICKABLE)),void 0!==s._fill&&function(e,i,r){if(1==e)return;let n=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY|t.GASEnumCustom._FORCE_COLOR_AND_OPACITY;switch(e){case 5:case 6:default:break;case 2:i.colorA=.5,i.transparent=!0,i.inheritanceCustom|=n;break;case 3:i.colorIndex=t.COLORMAP_INDEX.TRUECOLOR,i.colorA=0,i.transparent=!0,i.inheritanceCustom|=n;break;case 4:r?(i.colorIndex=t.COLORMAP_INDEX.BACKGROUND,i.colorA=1):(i.colorIndex=t.COLORMAP_INDEX.TRUECOLOR,i.colorA=0,i.transparent=!0),i.inheritanceCustom|=n}}(s._fill,C,e.isViewpoint2D())):C={};var M=s.getCustomProperty();if(M){var E=M.getValue(u.prototype.propertyTypes.InheritanceMode);void 0!==E&&(C.inheritance=E,v=!0);var b=M.getValue(u.prototype.propertyTypes.ViewMode),A=M.getValue(u.prototype.propertyTypes.ViewModeSensitivity);void 0===b&&void 0===A||this.applyRepViewMode(e,r,b,A)}if(v){y("applyGP::GAS");var V=new n.IncrementalGraphicAttributeSet(C).usingNREInit(!0);g?(c.length>0&&r._setGASOnGeomTypes(c,V),r instanceof l?Array.isArray(a)&&a.length>0&&r._setGAS(a,V):a.forEach((function(e){e._setGAS&&e._setGAS(V)}))):r._setGAS(V),S("applyGP::GAS")}var O=s.getMaterial();if(void 0!==O){if(y("applyGP::Materials"),!0===O.DefaultMaterial)g?(c.length>0&&r._setMaterialOnGeomTypes(c,null),r instanceof l?Array.isArray(a)&&a.length>0&&r.setMaterial(a,null):a.forEach((function(e){e.setMaterial&&e.setMaterial(null)}))):this.removeAllMatAps(r);else{e.id!==w&&(w=e.id,T.clear());var N=O.JSON,G=T.get(N),x=O.Buffers,R=O.Layer,H=O.Inherit,k=[0];if(O.Index?k=[O.Index]:O.Indices&&(k=O.Indices),G)G.materialApplications?this.applyMatAppsToElt(G.materialApplications,k,g,r,a,c):this.applyMaterialToElt(G.materials,k[0],R,H,g,r,a,c);else{var L=[];Array.isArray(x)&&x.length>0&&x.forEach((function(e){L.push({buffer:e.getData()})})),D.load({resourcesLibrary:_,zipped:!1,json:N,chunks:L,doneCallback:function(e){if(e.materialApplications?(T.set(e.json,{materialApplications:e.materialApplications,materials:null}),d.applyMatAppsToElt(e.materialApplications,k,g,r,a,c)):(T.set(e.json,{materialApplications:null,materials:e.materials}),d.applyMaterialToElt(e.materials,k[0],R,H,g,r,a,c)),d.clientManager){var t=_.getRequestedUids();t.length&&d.clientManager.getTexturesFromUids({node:void 0,serverNodeId:void 0,textureUids:t,onAnswer:function(e){for(var t in e.buffers){var i=_.getImageToRequest(parseInt(t)),r="image/"+i.format;"dds"!==i.format&&"hdr"!==i.format&&"basis"!==i.format||(r="arraybuffer");var n=new Blob([e.buffers[t]._data],{type:r});D._loadGenericTexture(i.format,null,window.URL.createObjectURL(n),!0,(function(){console.log("texture map updated")}),null,i.map),_.removeImageToRequest(parseInt(t))}}})}}})}}S("applyGP::Materials")}if(!g){if(y("applyGP::NodeEdit"),void 0!==P.pick&&r.setPickable(P.pick),void 0!==P.show&&r.setVisibility(P.show),void 0!==P.showFree&&r.setVisibilityFree(P.showFree),M){var F=M.getValue(u.prototype.propertyTypes.PickMode);if(void 0!==F)if(0===F)r.setPickingMode(null);else{var U=new h;U.applyToAll(i.PICK_VISIBLE),1&F&&(U.setPickingMode("Face",i.PICK_ALWAYS),U.setPickingMode("AxisSystem",i.PICK_ALWAYS),U.setPickingMode("InfiniteFace",i.PICK_ALWAYS)),2&F&&(U.setPickingMode("Edge",i.PICK_ALWAYS),U.setPickingMode("InternalSharpEdge",i.PICK_ALWAYS),U.setPickingMode("InternalSmoothEdge",i.PICK_ALWAYS),U.setPickingMode("_HighCurvatureEdge",i.PICK_ALWAYS),U.setPickingMode("BoundaryEdge",i.PICK_ALWAYS)),4&F&&U.applyToAll(i.PICK_NEVER),r.setPickingMode(U)}var B=M.getValue(u.prototype.propertyTypes.StaticPickWithChildrenAsAWhole);if(void 0!==B){var W=!!B;r.setVisuFilters({doNotPickUnderFilter:new f(W)})}let n=M.getValue(u.prototype.propertyTypes.IsIn3DBackGround);void 0!==n&&r.setIsInBackground(!!n);var z=M.getValue(u.prototype.propertyTypes.ExcludeFromBounding);"undefined"!=typeof excludeValue&&r.exludeFromBounding(!!z);var j=M.getValue(u.prototype.propertyTypes.LayerNumber);void 0!==j&&r.setLayerNumber(j);var X=M.getValue(u.prototype.propertyTypes.Filtered);void 0!==X&&r.setFiltered(!!X);var $=M.getValue(u.prototype.propertyTypes.StaticGeomType);if(void 0!==$&&""!==$){var K=t.GeomTypeEnum[$];if(void 0!==K){var J=new p(K);r.setVisuFilters({_staticGeomTypeFilter:J}),r.traverse((function(e,t){if(void 0===e)return!0;if("Mesh3D"===e.getNodeType()){var i=e.mesh3js.geometry;if(!(i&&i.length>0))return!0;i[0].drawingGroups.forEach((function(e){e._geomType!==t&&(e._initialGeomType=e._geomType),e._geomType=t}))}return!1}),K)}}var Y=M.getValue(u.prototype.propertyTypes.StaticPickPriority);void 0!==Y&&""!==Y&&r.setPickingPriorityId(Y);var Z=M.getValue(u.prototype.propertyTypes.StaticMaterial);if(void 0!==Z&&""!==Z)(Q=e.getStaticMaterial(Z))?r.setVisuFilters({lookFilter:new m(Q)}):console.error("No static material found for "+Z);var q=M.getValue(u.prototype.propertyTypes.StaticLook);if(void 0!==q&&""!==q){var Q,ee=e.getStaticLook(q);if(ee)(Q=ee.material)?r.setVisuFilters({lookFilter:new m(Q).usingShadowReceive(ee.shadowReceive).usingShadowCast(ee.shadowCast)}):console.error("No static look material found for "+q)}}S("applyGP::NodeEdit")}}}},applyRepViewMode:function(e,i,r,n){y("applyRepViewMode");var a=e.viewManager.viewer._getCSIOverrideManager(),o=a.getRepViewModeParams(i,r,n),s=o.repViewMode,l=o.viewModeSensitive;a.deleteRepViewModeOverride(i);var d=a.getRepViewModeOverride(i,l),c=!1;if(s===M)c=!0;else{var u=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.FACE|t.GeomTypeEnum.INFINITE_FACE,h=new g({faceMode:null});switch(h._displayNothingRenderMode(),h.setReplaceMask(u),s){case E:h.setRenderMode("Face",!0),h.setRenderMode("InfiniteFace",!0);break;case b:h.setRenderMode("@Edge",!0);break;case A:h.setRenderMode("Face",!0),h.setRenderMode("InfiniteFace",!0),h.setRenderMode("@Edge",!0);break;case V:h.setRenderMode("Face",!0),h.setRenderMode("InfiniteFace",!0);break;case O:h.setRepViewNothing(!0);break;default:c=!0}c||d.setRenderStyle(h)}c&&a.deleteRepViewModeOverride(i),S("applyRepViewMode")}})})),define("DS/WebVisuParameters/BoundingSphereParameterHelper",["DS/CSIViewModelWebInterfaces/CSIVMClientBoundingSphereParameter","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";var i={getBoundingSphere:function(e){if(!e)return null;var i=e.getRadius(),r=e.getRadiusMM(),n=new t.Sphere(new t.Vector3(e.getCenterX(),e.getCenterY(),e.getCenterZ()),i);return n.pixelRadius=r*t.getPixelsPerMM(),{sphere:n,isInfinite:e.getState()===e.stateValues.infinite,isEmpty:e.getState()===e.stateValues.empty,isContain:e.getState()===e.stateValues.contain}}};return i})),define("DS/WebVisuParameters/CSIModelIdPathParameter",["UWA/Class","DS/CSICommandBinder/CSICommandBinder"],(function(e,t){"use strict";var i={labels:{elementsId:"elems_id",elementsNamingContext:"elems_nc",subElements:"subelems_id"},serialize:function(e,t){var r,n,a=[],o=[];for(r=0;r<t.elements.length;r++)n=t.elements[r],a.push(n.id),o.push(n.namingContext);e.writeUint32Array(i.labels.elementsId,a),e.writeUint8Array(i.labels.elementsNamingContext,o),e.writeUint32Array(i.labels.subElements,t.subElements)},unserialize:function(e){var t,r={elements:[],subElements:[]},n=e.readUint32Array(i.labels.elementsId),a=e.readUint8Array(i.labels.elementsNamingContext),o=e.readUint32Array(i.labels.subElements);for(t=0;t<n.length;t++)r.elements.push({id:n[t],namingContext:a[t]});for(t=0;t<o.length;t++)r.subElements.push(o[t]);return r}};return t.declareType({type:"CATModelIdPath",serialize:i.serialize,unserialize:i.unserialize}),i})),define("DS/WebVisuParameters/PathElementRepNodeUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/Filters/SideFilter"],(function(e,t,i,r){function n(e){if(e.parents.length>1)throw"Wrong number of parents on linked node"}const a=new Map;class o{constructor(e,t){this.linkerMap=t,t.set(e,this),this.mainNode3D=e,this.linkedNode3Ds=null}removeMainNode3D(e){const t=this.linkerMap;if(this.linkedNode3Ds&&0!==this.linkedNode3Ds.size){if(e){const e=this;this.linkedNode3Ds.forEach(((t,i,r)=>e.removeLinkedNode3D(i))),t.delete(this.mainNode3D)}}else t.delete(this.mainNode3D)}isLinkedNode(e){return this.linkedNode3Ds&&this.linkedNode3Ds.has(e)}isIntermediateLinkedNode(e){return this.isLinkedNode(e)&&this.linkedNode3Ds.get(e)}isFinalLinkedNode(e){return this.isLinkedNode(e)&&!this.linkedNode3Ds.get(e)}createLinkedNode3D(e,t,i){const r=this.linkerMap;if(0!==t.children.length&&t._getForbidHierarchyUpdate())throw"Invalid parent node for node linking";var n=this.mainNode3D._linkingClone(null,i);this.linkedNode3Ds||(this.linkedNode3Ds=new Map),r.set(n,this),this.linkedNode3Ds.set(n,e);const a=t._getForbidHierarchyUpdate();return t._setForbidHierarchyUpdate(!1),t.addChild(n),t._setForbidHierarchyUpdate(a),n._setForbidHierarchyUpdate(!0),e||this.syncChildren(n),n}removeLinkedNode3D(e,t){const i=this.linkerMap;if(this.isLinkedNode(e)){n(e),e._setForbidHierarchyUpdate(!1);const s=e.parents[0],l=s._getForbidHierarchyUpdate();if(s._setForbidHierarchyUpdate(!1),s.removeChild(e),s._setForbidHierarchyUpdate(l),i.delete(e),this.linkedNode3Ds.get(e)||e.removeChildren(),this.linkedNode3Ds.delete(e),t){var r=Array.from(e.children);for(let e=0;e<r.length;e++){var a=r[e];if(i.has(a)){var o=i.get(a);o.removeLinkedNode3D(a,o,!0)}}}this.removeMainNode3D(!1)}}lock(e){this.isLinkedNode(e)&&(n(e),e._setForbidHierarchyUpdate(!0))}toArray(){return this.linkedNode3Ds?Array.from(this.linkedNode3Ds.keys()):[]}syncChildren(e){if(this.isFinalLinkedNode(e)){e._setForbidHierarchyUpdate(!1),e.removeChildren();for(var t=0;t<this.mainNode3D.children.length;t++)e.addChild(this.mainNode3D.children[t]);e._setForbidHierarchyUpdate(!0)}}}function s(e,t){let i=null;return a.has(e)?i=a.get(e):t&&(i=new o(e,a)),i}let l=!1;class d extends t{constructor(){super("PathElementRepNode3D")}_cleanTemp(){if(this.parents.length>0)return;0;const e=this.children[0];if(!e)return;const t=s(e,!1);t&&t.removeLinkedNode3D(e,!0)}_toExternalPathElement(){if(0===this.parents.length)return[];let e=[this.parents[0]],t=this;for(;t;){e.push(t),t=t.children[0];const i=s(t,!1);if(!i||!i.isLinkedNode(t))break}return e}addChild(e){if(!l)return!1;super.addChild(e)}insertChildAtIndex(e,t){if(!l)return!1;super.insertChildAtIndex(e,t)}}const c={set(e,i,r){if("__isProxy__"===i||"__target__"===i)throw"Do not manipulate private proxy parameters";if("children"===i||"parents"===i)throw"Do not manipulate children and parents of a proxified Node3D directly";if(e[i]instanceof Function&&t.prototype[i])throw"Don't override prototype";"_"===i[0]&&console.error("Unexpected: setting a private property manually, may not work properly in linkage - "+i);const n=s(e,!1);let a=[];n&&(n.isLinkedNode(e)||(a=n.toArray(),0===a.length&&n.removeMainNode3D(!0))),e[i]=r;for(let e=0;e<a.length;e++){a[e][i]=r}},get(e,i,r){if("__isProxy__"===i)return!0;if("__target__"===i)return e;if("children"===i||"parents"===i)throw"Do not manipulate children and parents of a proxified Node3D directly";i[0];const n=e[i];if(n instanceof Function){const r="addChild"===i||"removeChild"===i||"removeChildren"===i||"insertChildAtIndex"===i,a=s(e,!1);let o=[];return a&&(a.isLinkedNode(e)||(o=a.toArray(),0===o.length&&a.removeMainNode3D(!0))),function(...i){if(i)for(let e=0;e<i.length;e++)i[e]instanceof t&&i[e].__isProxy__&&(i[e]=i[e].__target__);var s=n.apply(e,i);for(let e=0;e<o.length;e++){const t=o[e];r?a.syncChildren(t):n.apply(t,i)}return s}}return n}};return{buildPathElementRepNode3DFromArray:function(n,a,o){l=!0;const c=new d;a.addChild(c);let u=c;for(let e=0;e<n.length;e++){let i=n[e];if(!(i instanceof t))throw"Unsupported operation, expected an array of Node3D";u=s(i,!0).createLinkedNode3D(e!==n.length-1,u,o)}if(u instanceof i&&o){const t=u.mesh3js;u.setVisuFilters({_sideFilter:new r(e.DoubleSide)}),null===t.layer&&t.initLayers();const i=o.getPrimitives();for(let e=0;e<i.length;e++)i[e]=i[e].clone();t.layer.addPrimitivesToLayers(i,1)}return l=!1,c},getProfixiedNodeIfNecessary:function(e){return e&&e instanceof t&&s(e,!1)&&!e.__isProxy__?new Proxy(e,c):e}}})),define("DS/WebVisuParameters/CSIViewParameterLabels",[],(function(){"use strict";return{viewStatus:"viewStatus",idPatterns:"idPatterns",graphicProperties:"GraphicProperties",treeUpdates:"treeUpdates",viewStatusTemporary:"temporary",viewStatusPermanent:"permanent",viewStatusCommit:"commit",viewStatusAbort:"abort",showMode:"ShowMode",staticMaterial:"SetStaticMaterial",staticPickPriority:"SetStaticPickPriority",id:"id",idSpace:"idSpace",idContext:"idContext",shared:"shared",treeKey:"treeKey",tokens:"tokens",appliedGas:"AppliedGraphicProperties",node:"Node",value:"value",localIdInt:"localId_Int",localIdString:"localId_String",idPattern:"idPattern",batchCellIdPattern:"batchCellIdPattern",parent:"parent",batchParent:"batchParent",valueAddNode:"AddNode",valueAddCustomNode:"AddCustomNode",valueModifyCustomNode:"ModifyCustomNode",valueAddExistingNode:"AddExistingNode",valueRemoveExistingNode:"RemoveExistingNode",valueAddBody:"AddBody",valueAddCells:"AddCells",valueRemoveAll:"RemoveAll",valueMesh:"mesh",valueBoundingSphere:"bs",valueBoundingBox:"bbox",valueInitializers:"inits",valueCustomData:"customdata",valueGeometry:"geometry",valueGeometries:"geometries",valueOffset:"offset",valueByteLength:"bytelength",valueBytePerElement:"bpe",valueDrawGroups:"dgs",valueStart:"start",valueCount:"count",valueGeomType:"geomType",valuePrimitives:"primitives",valueBuffer:"buffer",valueBufferPartitions:"bufferPartitions",valueBufferPartition:["vertexPositionArray","vertexIndexArray","vertexColorArray","vertexNormalArray","vertexBinormalArray","vertexTangentArray","vertexUvArray","vertexUv2Array"],valueGeomTypeValue:["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE"],glTypeFromGeomType:{EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:4,FACE:4},valueRadius:"rad",valueState:"state",valueStateValue:["EMPTY","NORMAL","INIFINITE","CONTAIN"],valueX1:"x1",valueY1:"y1",valueZ1:"z1",valueX2:"x2",valueY2:"y2",valueZ2:"z2",shortId:"shortId",idPath:"idPath",valueBinaryFormat:"binaryformat",valueClientModule:"clientmodule",valueData:"data",valueBinaryFormatValue:["Bin","Cgr"]}})),define("DS/WebVisuParameters/SceneEnvParameterItem",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t=function(e){this.container=e};t.prototype={constructor:t,areViewModesManaged:function(){return!1},getViewMode:function(){return null},getViewModeMask:function(){return 0},getViewModeAppearanceStructure:function(e){return null},getCamerasJSON:function(){return null},getCameras2DJSON:function(){return null},getChangeType:function(){return null},getViewpointsInfo:function(){return null},areCamerasManaged:function(){return!1},areLightsManaged:function(){return!1},getLightsJSON:function(){return null},areAmbiancesManaged:function(){return!1},isDefaultAmbiance:function(){return!1},getAmbianceJSON:function(){return null},getGroundGridActivation:function(){return null},getAmbianceBuffers:function(){return null},areSupportParametersManaged:function(){return!1},getHighlightRenderingData:function(){return null},getPrehighlightRenderingData:function(){return null},getColorMap:function(){return null},getFog:function(){return!1},getClippingPlane:function(){return null},getBackground3DViewMode:function(){return null},getMainViewpointUID:function(){return null},getViewerType:function(){return null},get2DMode:function(){return null},getPLMViewMode:function(){return null},getMultiViewSyncMode:function(){return null},getDynamicMode:function(){return!1},areLineTypeDefinitionsManaged:function(){return!1},getLineTypeDefinitions:function(){return null},getColorMap:function(){return null}};var i=function(e){t.call(this,e)};i.prototype=Object.create(t.prototype),Object.assign(i.prototype,{areViewModesManaged:function(){return!!this.getViewMode()},getViewMode:function(){return this.container.getViewmode?this.container.getViewmode():null},getViewModeMask:function(){var e=this.container.getViewmode();return e?e._viewMode:0},getViewModeAppearanceStructure:function(t){if(this.getViewModeMask()&t){var i=this.getViewMode();return{appearanceName:i._appearanceName,customParams:{shininess:i._shininess,opacity:i._opacity,color:(new e.Color).setRGB(i._color[0],i._color[1],i._color[2]),useColorFromGAS:i._useObjectColor}}}return null},getCamerasJSON:function(){var e=this.container.getCamerasJSON();return e?e.getJSON():null},areCamerasManaged:function(){return this.container.AreCamerasManaged&&this.container.AreCamerasManaged()},areLightsManaged:function(){return this.container.AreLightsManaged&&this.container.AreLightsManaged()},getLightsJSON:function(){var e=this.container.getLightsJSON();return e?e.getJSON():null},areAmbiancesManaged:function(){return this.container.AreAmbiancesManaged&&this.container.AreAmbiancesManaged()},isDefaultAmbiance:function(){return this.container.getIsDefaultAmbiance()},getAmbianceJSON:function(){var e=this.container.getAmbianceJSON();return e?e.getJSON():null},getAmbianceBuffers:function(){return this.container.getAmbianceBuffers()}});var r=function(i){e.__tmpIsA2X=!0,t.call(this,i)};return r.prototype=Object.create(t.prototype),Object.assign(r.prototype,{areViewModesManaged:function(){return!!this.getViewMode()},getViewMode:function(){return this.container.getViewMode()},getViewModeMask:function(){var e=this.container.getViewMode();return e?e.getViewMode():0},getViewModeAppearanceStructure:function(t){if(this.getViewModeMask()&t){var i=this.getViewMode(),r=i.getColor();return{appearanceName:i.getAppearance(),customParams:{shininess:i.getShininess(),opacity:i.getOpacity(),color:(new e.Color).setRGB(r[0],r[1],r[2]),useColorFromGAS:i.getUseObjectColor()}}}return null},getViewpoints:function(){return this.container.getViewpoints()},getCameras2DJSON:function(){if(!this.areCamerasManaged())return null;var e=this.getViewpoints().getCameras2DJSON();return e?e.getJSON():null},getCamerasJSON:function(){if(!this.areCamerasManaged())return null;var e=this.getViewpoints().getCamerasJSON();return e?e.getJSON():null},getChangeType:function(){return this.areCamerasManaged()?this.getViewpoints().getChangeType():null},getViewpointsInfo:function(){return this.areCamerasManaged()?this.getViewpoints().getViewpointsInfo():null},areCamerasManaged:function(){return!!this.getViewpoints()},areLightsManaged:function(){return!1},getLightsJSON:function(){return null},getAmbiance:function(){return this.container.getAmbiance()},areAmbiancesManaged:function(){return!!this.getAmbiance()},isDefaultAmbiance:function(){return!this.getAmbianceJSON()},getAmbianceJSON:function(){if(!this.areAmbiancesManaged())return null;var e=this.getAmbiance().getAmbianceJSON();return e?e.getJSON():null},getGroundGridActivation:function(){return this.areAmbiancesManaged()?this.getAmbiance().getGroundGridActivation():null},getAmbianceBuffers:function(){return this.areAmbiancesManaged()?this.getAmbiance().getAmbianceBuffers():null},getSupportParameters:function(){return this.container.getSupportParameters()},areSupportParametersManaged:function(){return!!this.getSupportParameters()},getHighlightRenderingData:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getHighlightRenderingData():null},getPrehighlightRenderingData:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getPrehighlightRenderingData():null},getColorMap:function(){return this.container.getColorMap()},getFog:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getFog():null},getClippingPlane:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getSupportClippingPlane():null},getBackground3DViewMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getBackground3DViewMode():null},getMainViewpointUID:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getMainViewpointUID():null},getViewerType:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getViewerType():null},get2DMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().get2DMode():null},getPLMViewMode:function(){return this.container&&this.container.getPLMViewMode()},getMultiViewSyncMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getMultiviewSyncMode():null},getDynamicMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getDynamicMode():null},areLineTypeDefinitionsManaged:function(){return void 0!==this.container.getLineDefinitions()},getLineTypeDefinitions:function(){return this.container.getLineDefinitions()}}),{VisuContextData:r,SceneEnvData:i}})),define("DS/WebVisuParameters/AbstractWebVisuUpdateTransaction",["DS/CSIViewModelWebInterfaces/CSIVMClientTransaction","DS/WebVisuParameters/PathElementRepNodeUtils","DS/Visualization/GraphicAttributeSet","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D"],(function(e,t,i,r,n,a){"use strict";var o=function(e,t,i){if(window.newMaterialInheritance=!0,this.clientManager=i,this.viewManager=e,this.treeKeyID=t.getUUID?t.getUUID():null,this.view=null,e)if(t.getViewpointUID&&0!==t.getViewpointUID()){let i=e._viewpointMap.get(t.getViewpointUID());if(i){let t=e.viewer._viewpointManager.getViewpointScenegraph(i);this.view=t?e.addView(this.treeKeyID,t.userRoot):e.getView(this.treeKeyID)}else console.error("no viewpoint correspond to this uid : "+t.getViewpointUID())}else this.view=e.getView(this.treeKeyID)};return(o.prototype=Object.create(e.prototype)).getOperatedObject=function(e){var i=e.getOperatedObject();return t.getProfixiedNodeIfNecessary(i)},o.prototype.getOperandObject=function(e){return e.getOperandObject()},o.prototype.doOperation=function(e){throw"Not implemented"},o.prototype.commit=function(){throw"Not implemented"},o.prototype.abort=function(){throw"Not implemented"},o.prototype.executeEnd=function(){throw"Not implemented"},o.prototype.executeInverse=function(){throw"Not implemented"},o._handlePathElements=function(e,i,r,n){const a=e.createIteratorOverPathElements();if(e.haveTransient){if(null===i)throw"Invalid operation in _handlePathElements, transients must have a parent";const o=e.createIteratorOverPathElementsTransient();let s=!1;for(const e of a){s=!0;let a=e.externalPath;for(const e of o){const o=n(e);let s=a.concat(e.externalPath);r(t.buildPathElementRepNode3DFromArray(s,i,o),e)}}if(!s)for(const e of o){const a=n(e),o=e.externalPath;r(t.buildPathElementRepNode3DFromArray(o,i,a),e)}}else for(const e of a)if(null===i)r(null,e);else{const a=n(e),o=e.externalPath;r(t.buildPathElementRepNode3DFromArray(o,i,a),e)}},o.MixedGPUtils={isMixedGP:function(e,t){return e instanceof n&&!(e instanceof a)&&(!t||t instanceof r.SGPrimitiveHelper)},getMesh3DForMixedGP:function(e,r){const n=e.getChildren();for(let e=0;e<n.length;e++){let i=n[e];if(i instanceof a)return[t.getProfixiedNodeIfNecessary(i),!1]}const o=new a;return o.setShadow(!0,!0),o.setFrustumCulled(!e._getNoCullingBE()),o._setPixelCullingFromParent(!0),o._setNoGASOnPrimitives(e._getNoGASOnPrimitives()),r&&e.addChild(o),o._setGAS(i.DefaultGASs.transition),o._bodyDim=e._bodyDim,[o,!0]},getExistingMesh3DForMixedGP:function(e){const t=e.getChildren();for(let e=0;e<t.length;e++){let i=t[e];if(i instanceof a)return i}return null},getExistingMesh3DFromMixedGP:function(e,t){const i=e.getChildren(),r=t.__getNodes();for(let e=0;e<i.length;e++){let t=i[e];if(r.has(t))return t}return null}},o})),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionHSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO"],(function(e,t,i){"use strict";const r=new Map;class n extends i{constructor(e,i){if(super(i),r.has(i)||r.set(i,{nonColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},multiSlotParameters:[],defaultSlotColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},currentHighlightType:"AdvancedPoliteness",advanced:!0}),this.enabled=!0,this.highlightColor=r.get(i).advanced?new t.AdvancedPoliteHighlightData(t.DefaultHighlightData.advancedpolite):new t.HaloHighlightData(t.DefaultHighlightData.halo),this.highlightColor.priority=8192,e)this.highlightColor._setData(e);else{const e=r.get(i).currentHighlightType;this.highlightColor._setData(r.get(i).defaultSlotColorParameters[e])}this._event="HIGHLIGHT",this._setData(this.highlightColor)}_setData(i){if(i){const n=this.viewer,a=r.get(n).advanced?new t.AdvancedPoliteHighlightData(this.highlightColor):new t.HaloHighlightData(this.highlightColor),o=r.get(n).currentHighlightType;a._setData(r.get(n).nonColorParameters[o]),a._setData(i),e.publish({event:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE",eventType:"@CSI_HIGHLIGHT_UPDATE",parameters:{highlightColor:this.highlightColor,newColor:a,viewer:n,advanced:r.get(n).advanced}}}),this.highlightColor=a}}}const a=new Map;let o=null;return e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE"},(function(e){const t=e.parameters.slot+1,i=e.parameters.colorParameters,s=e.parameters.viewer;o=a.get(s),o||(o=[new n(null,s)],a.set(s,o));const l=r.get(s),d=i[l.currentHighlightType];o[t]?o[t]._setData(d):o[t]=new n(d,s),l.multiSlotParameters[t-1]=i})),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION"},(function(e){const t=e.parameters.enabled,i=e.parameters.viewer;o=a.get(i),o||(o=[new n(null,i)],a.set(i,o));for(let e=1;e<o.length;e++){o[e]||(o[e]=new n({},i)),o[e].enabled=t;const a=i._getHighlightSet(o[e].highlightColor,!1,!!r.get(i).advanced);a&&a.enable(t)}})),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION"},(function(e){const t=e.parameters.enabled,i=e.parameters.viewer;o=a.get(i),o||(o=[new n(null,i)],a.set(i,o)),o[0]||(o[0]=new n({},i)),o[0].enabled=t;const s=i._getHighlightSet(o[0].highlightColor,!1,!!r.get(i).advanced);s&&s.enable(t)})),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_HIGHLIGHT_UPDATE"},(function(e){const t=e.parameters.viewer;o=a.get(t),o||(o=[new n(null,t)],a.set(t,o));const i=e.parameters.highlightType,s=r.get(t).currentHighlightType;Object.assign(r.get(t).defaultSlotColorParameters[i],e.parameters.colorParameters),o[0]._setData(r.get(t).defaultSlotColorParameters[s])})),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_NON_COLOR_UPDATE"},(function(e){const t=e.parameters.viewer;o=a.get(t),o||(o=[new n(null,t)],a.set(t,o));const i=e.parameters.highlightType;Object.assign(r.get(t).nonColorParameters[i],e.parameters.nonColorParameters);for(let e=0;e<o.length;e++)o[e]&&o[e]._setData(0===e?r.get(t).defaultSlotColorParameters[i]:r.get(t).multiSlotParameters[e-1][i])})),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_TYPE_UPDATE"},(function(e){const t=e.parameters.viewer;o=a.get(t),o||(o=[new n(null,t)],a.set(t,o));let i=e.parameters.highlightType;"AdvancedPoliteness"===i||"Basic"===i||"Halo"===i||"Politeness"===i?(r.get(t).currentHighlightType=i,r.get(t).advanced="Halo"!==i):i=r.get(t).currentHighlightType;for(let e=0;e<o.length;e++)o[e]&&o[e]._setData(0===e?r.get(t).defaultSlotColorParameters[i]:r.get(t).multiSlotParameters[e-1][i])})),e.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},(function(e){const t=e.parameters.viewer;if(a.has(t)){const e=a.get(t);for(let i=0;i<e.length;i++){const n=e[i];if(n){n._treeKeyToStruct.forEach((function(e,t,i){n._setTreeKey(t),n.removeAll()}));const e=t._getHighlightSet(n.highlightColor,!1,!!r.get(t).advanced);e&&t.removeHighlightSet(e)}}}a.delete(t),r.delete(t)})),{getXSO:function(e,t,i){if(o=a.get(t),o||(o=[new n(null,t)],a.set(t,o)),e>o.length||e<0)throw"Invalid slot";const s=o[e];if(!s)throw"Missing slot";return t.createHighlightSet(s.highlightColor,!1,!!r.get(t).advanced).enable(s.enabled),s._setTreeKey(i),s},clearMultiHighlightColorSlot:function(e){for(let t=1;t<o.length;t++){const i=o[t];i&&(i._setTreeKey(e),i.removeAll())}}}})),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionPSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO"],(function(e,t,i){"use strict";const r=new Map;class n extends i{constructor(e){super(e),r.has(e)||r.set(e,{nonColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},defaultSlotColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},currentHighlightType:"AdvancedPoliteness",advanced:!0});const i=r.get(e).currentHighlightType;this.highlightColor=r.get(e).advanced?new t.AdvancedPoliteHighlightData(t.DefaultPreHighlightData.advancedpolite):new t.HaloHighlightData(t.DefaultPreHighlightData.halo),this.highlightColor._setData(r.get(e).defaultSlotColorParameters[i]),this._event="PREHIGHLIGHT",this._setData(this.highlightColor)}_setData(i){if(i){const n=this.viewer,a=r.get(n).advanced?new t.AdvancedPoliteHighlightData(this.highlightColor):new t.HaloHighlightData(this.highlightColor),o=r.get(n).currentHighlightType;a._setData(r.get(n).nonColorParameters[o]),a._setData(i),e.publish({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE",eventType:"@CSI_PREHIGHLIGHT_UPDATE",parameters:{newColor:a,viewer:n,advanced:r.get(n).advanced}}}),this.highlightColor=a}}}const a=new Map;let o=null;return e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_PREHIGHLIGHT_UPDATE"},(function(e){const t=e.parameters.viewer;o=a.get(t),o||(o=[new n(t)],a.set(t,o));const i=e.parameters.highlightType,s=r.get(t).currentHighlightType;Object.assign(r.get(t).defaultSlotColorParameters[i],e.parameters.colorParameters),o[0]._setData(r.get(t).defaultSlotColorParameters[s])})),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_PREHIGHLIGHT_NON_COLOR_UPDATE"},(function(e){const t=e.parameters.viewer;o=a.get(t),o||(o=[new n(t)],a.set(t,o));const i=e.parameters.highlightType;Object.assign(r.get(t).nonColorParameters[i],e.parameters.nonColorParameters);for(let e=0;e<o.length;e++)o[e]&&o[e]._setData({})})),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_PREHIGHLIGHT_TYPE_UPDATE"},(function(e){const t=e.parameters.viewer;o=a.get(t),o||(o=[new n(t)],a.set(t,o));let i=e.parameters.highlightType;"AdvancedPoliteness"===i||"Basic"===i||"Halo"===i||"Politeness"===i?(r.get(t).currentHighlightType=i,r.get(t).advanced="Halo"!==i):i=r.get(t).currentHighlightType;for(let e=0;e<o.length;e++)o[e]&&o[e]._setData(0===e?r.get(t).defaultSlotColorParameters[i]:{})})),e.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},(function(e){const t=e.parameters.viewer;if(a.has(t)){const e=a.get(t);for(let t=0;t<e.length;t++)e[t]&&e[t]._treeKeyToStruct.forEach((function(i,r,n){e[t]._setTreeKey(r),e[t].removeAll()}))}a.delete(t),r.delete(t)})),{getXSO:function(e,t,i){if(o=a.get(t),o||(o=[new n(t)],a.set(t,o)),e>o.length||e<0)throw"Invalid slot";const r=o[e];if(!r)throw"Missing slot";return r._setTreeKey(i),r}}})),define("DS/WebVisuParameters/SceneEnvParameterHelper",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/WebVisuParameters/SceneEnvParameterItem","DS/Visualization/MaterialManager","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,n,a){"use strict";var o=r.SceneEnvData;r.VisuContextData;function s(e){a.begin(`SceneEnvParameterHelper::${e}`)}function l(e){a.end(`SceneEnvParameterHelper::${e}`)}var d=["WhiteDesign","BlueDesign","DarkDesign","Studio","PureWhite","WhiteMirror","WhiteReview","DarkMirror","DarkReview","Outdoor","Indoor","City","Road","NeoPureWhite"],c={VIEW_NO_DISPLAY:0,VIEW_MESH:1,VIEW_EDGE:2,VIEW_OUTLINE:4,VIEW_MATERIAL:8,VIEW_HLR:16,VIEW_HRD:32,VIEW_HIDDEN_EDGE:64,VIEW_POLYGON:128,VIEW_ISOPARS:256,VIEW_TOON:512,VIEW_TRANSPARENT:1024,VIEW_REP_OVERLOAD:2048,VIEW_WITH_HALF_SMOOTH_EDGE:4096,VIEW_WITHOUT_SMOOTH_EDGE:8192,VIEW_LINEONLINE:16384,VIEW_WITHOUT_VERTEX:32768,VIEW_COLORED_EDGES_FROM_FACES:65536,VIEW_WITHOUT_WIRES:131072,VIEW_WITHOUT_AXIS:262144,VIEW_WITHOUT_POINTS:524288,VIEW_WITHOUT_CONSTRAINTS:1048576,VIEW_RAYTRACING:2097152,VIEW_WITHOUT_SMALL_CURVATURE_STEP_EDGE:536870912,VIEW_APPEARANCE:1073741824};e.__ViewModeType__=c;var u={Basic:e.DefaultAppearanceMode.BASIC,GASLook:e.DefaultAppearanceMode.GASLOOK,Transparent:e.DefaultAppearanceMode._TRANSPARENT,Clay:e.DefaultAppearanceMode.CLAY,WhiteMatPlaster:e.DefaultAppearanceMode.WHITE_MAT_PLASTER,GreyShinyPlastic:e.DefaultAppearanceMode.GREY_SHINY_PLASTIC,CastAluminum:e.DefaultAppearanceMode.CAST_ALUMINUM,MachinedAluminum:e.DefaultAppearanceMode.MACHINED_ALUMINUM,CastSteel:e.DefaultAppearanceMode.CAST_STEEL,BrushedSteel:e.DefaultAppearanceMode.BRUSHED_STEEL,MachinedStainlessSteel:e.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL,Copper:e.DefaultAppearanceMode.COPPER,Brass:e.DefaultAppearanceMode.BRASS,GenericPlastic:e.DefaultAppearanceMode.GENERIC_PLASTIC,GenericMetal:e.DefaultAppearanceMode.GENERIC_METAL,QAAutomation:null,Count:null};e.__ViewAppearanceMap__=u;var h=new Uint32Array(1),g=new Uint8Array(h.buffer),p=1;function f(t,r,n,a,o){s("doCommonHighlightRenderingData::"+o);let d=!1,c="Halo";t.getStandardActivation()&&(c="Basic",d=!0,i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"Basic",nonColorParameters:n.Basic}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"Basic",colorParameters:a.Basic}}}));{const s=n.Halo,l=a.Halo,c=t.getHaloData();h[0]=c.color,s.haloEnabled=!!c.activation,d=d||!!c.activation,s.haloIntensity=c.intensity,s.haloThickness=c.size,l.haloColor=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255);const u=t.getScanData();h[0]=u.color,s.colorEnabled=!!u.activation,d=d||!!u.activation,s.intensity=u.intensity,l.color=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255);const p=t.getOutlineData();h[0]=p.color,s.outlineEnabled=!!p.activation,d=d||!!p.activation,l.outlineColor=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),s.outlineAlpha=g[0]/255,i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"Halo",nonColorParameters:s}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"Halo",colorParameters:l}}})}{const s=t.getAdvancedPolitnessData();{const t=n.AdvancedPoliteness,l=a.AdvancedPoliteness;t.haloIntensity=s.haloIntensity,t.outlineThickness=s.faceThickness,t.visibleAlpha=s.visibleFaceAlpha/255,t.occludedAlpha=s.occludedFaceAlpha/255,h[0]=s.color,l.color=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),h[0]=s.haloColor,l.haloColor=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),h[0]=s.outlineColor,l.outlineColor=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),t.outlineAlpha=g[0]/255,i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"AdvancedPoliteness",nonColorParameters:t}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"AdvancedPoliteness",colorParameters:l}}})}const l=t.getPolitnessData();{const t=n.Politeness,s=a.Politeness;t.haloIntensity=2,t.outlineThickness=1,t.visibleAlpha=l.meshAlpha/255,t.occludedAlpha=l.occludedMeshAlpha/255,h[0]=l.color,s.color=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),s.haloColor=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),s.haloColor=s.haloColor.clone().multiplyScalar(1/1.142),s.outlineColor=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),t.outlineAlpha=1,t.haloEnabled=!1,i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"Politeness",nonColorParameters:t}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"Politeness",colorParameters:s}}})}s.activation?(c="AdvancedPoliteness",d=!0):l.activation&&(c="Politeness",d=!0)}return i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_TYPE_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_TYPE_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_TYPE_UPDATE",parameters:{viewer:r,highlightType:c}}}),r.render(),l("doCommonHighlightRenderingData::"+o),d}var m=function(e,t){this.viewManager=e,this.viewer=this.viewManager?this.viewManager.viewer:null,this.streamingInterfaces=new Map,this.loader=t};return m.prototype={constructor:m,getSceneEnvRootForLights:function(){var e=this.viewManager._sceneEnvRootForLights;return 0===e.parents.length&&this.viewer.addNode(e),e},setViewManager:function(e){this.viewManager=e,this.viewer=this.viewManager?this.viewManager.viewer:null},getSceneEnvRootForAmbiances:function(){var e=this.viewManager._sceneEnvRootForAmbiance;return 0===e.parents.length&&this.viewer.addNode(e),e},tryUpdateAmbiance:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areAmbiancesManaged())return Promise.resolve(!1);let t;if(s("tryUpdateAmbiance"),this.getSceneEnvRootForAmbiances().removeChildren(),e.isDefaultAmbiance())this.viewer.removeAmbience(),this.viewer.setVisuEnv("None"),t=Promise.resolve(!0);else{var i=e.getGroundGridActivation(),r=e.getAmbianceJSON();if(r)if(r.ambiance)if(r.ambiance.name&&-1!==d.indexOf(r.ambiance.name))this.viewer.setVisuEnvOCA(r.ambiance.name),t=Promise.resolve(!0);else{var n=e.getAmbianceBuffers(),a=[];Array.isArray(n)&&n.length>0&&n.forEach((function(e){a.push({buffer:e.getData()})})),t=new Promise((e=>{s("tryUpdateAmbiance::Load"),this.viewer.removeAmbience();var t=this.loader.load({zipped:!1,json:r,chunks:a,destinationNode:this.getSceneEnvRootForAmbiances(),doneCallback:e.bind(null,!0)});if(l("tryUpdateAmbiance::Load"),t)return Promise.resolve(!0)})).then((()=>(null!=i&&this.viewer.setGrid(i),Promise.resolve(!0))))}else{let e=this.viewer?.ambience?.getBackgroundAlpha();this.viewer.setVisuEnvOCA("Basic"),this.viewer.setBackgroundColor(this.viewer.backgroundColor,e),t=Promise.resolve(!0)}else null!=i&&this.viewer.setGrid(i),t=Promise.resolve(!1)}return l("tryUpdateAmbiance"),t},tryUpdateLights:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areLightsManaged())return Promise.resolve(!1);var t=e.getLightsJSON();if(!t)return Promise.resolve(!1);s("tryUpdateLights"),this.viewer.useDefaultLights=!1,this.getSceneEnvRootForLights().removeChildren();return this.loader.applyLights({json:t,data:{},destinationNode:this.getSceneEnvRootForLights()}),l("tryUpdateLights"),Promise.resolve(!0)},_mergeCreatedvps(e,t,i){let r=[],n=0,a=0;for(let o=0;o<e.length;o++){let s=e[o];"Main3D"==s.getType()||"3D"==s.getType()?(r.push(t[n]),n++):(r.push(i[a]),a++)}return r},_manageViewpointInfo(e,t,i){s("_manageViewpointInfo");let r=null;var n=this.viewManager._viewpointMap;n.has(e.getUID())?r=n.get(e.getUID()):(r=t,r.createDivCSS(),r.setCsiUID(e.getUID()),n.set(e.getUID(),r),"Main3D"==e.getType()||"Main2D"==e.getType()&&"3DViewer"!=i.getViewerType()?this.viewer.currentViewpoint&&null!==this.viewer.currentViewpoint.getCsiUID()?this.viewer._viewpointManager.addMainViewpoint(r,!1):(r._setNode(this.viewer.internalSceneGraph.root),this.viewer.selectViewpoint(null,r)):this.viewer._viewpointManager.addViewpoint(r,!1)),"Main3D"!=e.getType()&&"Main2D"!=e.getType()||this.viewer.getVisibleSpace()!=e.isShowSpace()&&this.viewer.swapVisibleSpace();let a=e.getViewport();if(!a||0==a[0]&&0==a[1]&&0==a[2]&&0==a[3]?this.viewer._viewpointManager.setViewpointViewport(r,!1,0,0,1,1):this.viewer._viewpointManager.setViewpointViewport(r,!0,a[0],a[1],a[2],a[3]),this.viewer._viewpointManager.setCSIInfos(r,{type:e.getType(),hasEditor:e.hasVpEditor(),vpEditorType:e.getVpEditorType(),vpEditorMode:e.getVpEditorMode(),locks:e.getTransformationLocks(),isMultiView:e.isMultiview()}),r.setNative2DZoomLimits(e.getMinZoom(),e.getMaxZoom()),e.AaMode,e.IsStretched,e.PLMViewMode,e.IsMainDialog,e.IsV3D,"Main3D"==e.getType()||"3D"==e.getType()){let t=e.getViewpoint3DInfo();r.getControl()&&r.getControl().setNativeGravity(t.areGravityMode(),t.getGravityDirection(),t.getGravityLocked()),t.ClippingMode,t.NearValue,t.FarValue}else{let t=e.getViewpoint2DInfo();r.setNative2DClip(t.getClip(),t.getBottomLeft(),t.getTopRight()),r.setNative2DAnchor(t.getAnchor()),t.areTranslationBoundsDefined()&&r.setNative2DTranslationBounds(t.getBoundsX(),t.getBoundsY()),r.setNative2DDepthMode(t.getDepth())}l("_manageViewpointInfo")},tryUpdateCameras:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areCamerasManaged())return Promise.resolve(!1);var t=e.getCamerasJSON();if(!t)return Promise.resolve(!1);s("tryUpdateCameras");if(e instanceof o)this.loader.applyCamera({json:t,destinationNode:this.viewer.getRootNode()});else{var i=this.viewManager._viewpointMap;let r=t,n=this.loader.retrieveViewpoints({json:r},this.viewer,!0,!0),a=e.getCameras2DJSON(),o=this.loader.retrieveViewpoints({json:a},this.viewer,!0,!0),s=e.getChangeType(),l=e.getViewpointsInfo();n=this._mergeCreatedvps(l,n,o);for(let t=0;t<l.length;t++){let r=n[t],a=null;this._manageViewpointInfo(l[t],r,e),a=i.get(l[t].getUID()),r!=a?(a._nativeTranslationOffset=r._nativeTranslationOffset,a.moveTo({eyePosition:r.position,orientation:r.control.orientation,distanceToTarget:r.control.distanceToTarget}),a.control.update(),a.camera.fov=r.camera.fov,a.setProjectionType(r.getProjectionType(),null,!0),a._nativeZoomType==r._nativeZoomType&&a._nativeZoomRatio==r._nativeZoomRatio||a.setNativeZoom(r._nativeZoomType,r._nativeZoomRatio),a._nativeZoom=r._nativeZoom,r.dispose()):a.control.update()}"ViewpointListChanged"==s&&(i.size>l.length&&i.forEach(((e,t,i)=>{let r=!1;for(let e=0;e<l.length;e++)if(l[e].getUID()==t){r=!0;break}r||(this.viewer._viewpointManager.removeViewpoint(e),e.dispose(),i.delete(t))})),this.viewer._viewpointManager.setOrderCSIViewpoints(l))}return l("tryUpdateCameras"),Promise.resolve(!0)},tryUpdateViewModes:function(t){if(this.viewer){if(!t)return Promise.reject(new Error("Missing data"));if(!t.areViewModesManaged())return Promise.resolve(!1);s("tryUpdateViewModes");var i=t.getViewModeMask(),r="Wireframe";i&c.VIEW_HRD?r="ShadingIllustration":i&c.VIEW_MESH&&(r="Shading",i&c.VIEW_MATERIAL&&(r+="Material"),i&c.VIEW_EDGE&&(r+="Edges",i&c.VIEW_WITHOUT_SMOOTH_EDGE?r+="NoSmoothEdges":i&c.VIEW_WITH_HALF_SMOOTH_EDGE&&(r+="HalfSmoothEdges"),i&c.VIEW_HIDDEN_EDGE&&(r+="HiddenEdges")));var n=i&c.VIEW_REP_OVERLOAD;this.viewer._getCSIOverrideManager().setRepViewMode(n),this.viewer.setVisuShadingMode(r),this.viewer._setVisuOutlineMode((i&c.VIEW_OUTLINE)>0),this.viewer.setLinesFilter(!(i&c.VIEW_WITHOUT_WIRES)),this.viewer.setVerticesFilter(!(i&c.VIEW_WITHOUT_VERTEX)),this.viewer.setPointsFilter(!(i&c.VIEW_WITHOUT_POINTS)),this.viewer.setAxisFilter(!(i&c.VIEW_WITHOUT_AXIS)),this.viewer.setSmallCurvatureEdgesFilter(!(i&c.VIEW_WITHOUT_SMALL_CURVATURE_STEP_EDGE));var a=t.getViewModeAppearanceStructure(c.VIEW_APPEARANCE);if(a){var o=u[a.appearanceName];void 0!==o&&(this.viewer.setVisuAppearanceMode(o),o!==e.DefaultAppearanceMode.GENERIC_PLASTIC&&o!==e.DefaultAppearanceMode.GENERIC_METAL||this.viewer.setCustomMaterialModeParameters(a.customParams))}else this.viewer.setVisuAppearanceMode(u.Basic);return l("tryUpdateViewModes"),Promise.resolve(!0)}},tryUpdateSupportParameters:function(t,r){var n=Promise.resolve(!0);if(!t)return Promise.reject(new Error("Missing data"));if(!t.areSupportParametersManaged())return Promise.resolve(!1);s("tryUpdateSupportParameters");var a=t.getHighlightRenderingData();a&&function(t,r){s("doHighlightRenderingData::MultiHL");for(var n=t.getMultiColorData(),a=n.highlightSlots,o=0;o<a.length;o++){h[0]=a[o];var d=(new e.Color).setRGB(g[3]/255,g[2]/255,g[1]/255),c=d,u=d.clone().multiplyScalar(1.142);u.r=Math.max(Math.min(u.r,1),0),u.g=Math.max(Math.min(u.g,1),0),u.b=Math.max(Math.min(u.b,1),0);var p={colorEnabled:!0,color:d,haloColor:c,outlineColor:u,priority:4095+o},m={Basic:p,Halo:p,AdvancedPoliteness:p,Politeness:p};i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",eventType:"@CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",parameters:{slot:o,colorParameters:m,viewer:r}}})}l("doHighlightRenderingData::MultiHL"),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",eventType:"@CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",parameters:{viewer:r,enabled:!!n.activation}}});var v=f(t,r,{Halo:{colorEnabled:e.DefaultHighlightData.halo.colorEnabled,intensity:e.DefaultHighlightData.halo.intensity,haloEnabled:e.DefaultHighlightData.halo.haloEnabled,haloIntensity:e.DefaultHighlightData.halo.haloIntensity,haloThickness:e.DefaultHighlightData.halo.haloThickness,outlineEnabled:e.DefaultHighlightData.halo.outlineEnabled,outlineAlpha:e.DefaultHighlightData.halo.outlineAlpha,outlineThickness:e.DefaultHighlightData.halo.outlineThickness},Basic:{colorEnabled:e.DefaultHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultHighlightData.advancedpolite.outlineThickness},AdvancedPoliteness:{colorEnabled:e.DefaultHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultHighlightData.advancedpolite.outlineThickness},Politeness:{colorEnabled:e.DefaultHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultHighlightData.advancedpolite.outlineThickness}},{Halo:{color:e.DefaultHighlightData.halo.color,outlineColor:e.DefaultHighlightData.halo.outlineColor,haloColor:e.DefaultHighlightData.halo.haloColor},Basic:{color:e.DefaultHighlightData.advancedpolite.color,outlineColor:e.DefaultHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultHighlightData.advancedpolite.haloColor},AdvancedPoliteness:{color:e.DefaultHighlightData.advancedpolite.color,outlineColor:e.DefaultHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultHighlightData.advancedpolite.haloColor},Politeness:{color:e.DefaultHighlightData.advancedpolite.color,outlineColor:e.DefaultHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultHighlightData.advancedpolite.haloColor}},"HIGHLIGHT");i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION",eventType:"@CSI_CONTEXT_HIGHLIGHT_ACTIVATION",parameters:{viewer:r,enabled:v}}}),r.internalSceneGraph.selectionHL.enable(v)}(a,this.viewer);var o=t.getPrehighlightRenderingData();o&&function(t,i){var r={Halo:{colorEnabled:e.DefaultPreHighlightData.halo.colorEnabled,intensity:e.DefaultPreHighlightData.halo.intensity,haloEnabled:e.DefaultPreHighlightData.halo.haloEnabled,haloIntensity:e.DefaultPreHighlightData.halo.haloIntensity,haloThickness:e.DefaultPreHighlightData.halo.haloThickness,outlineEnabled:e.DefaultPreHighlightData.halo.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.halo.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.halo.outlineThickness},Basic:{colorEnabled:e.DefaultPreHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultPreHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultPreHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultPreHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultPreHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultPreHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultPreHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.advancedpolite.outlineThickness},AdvancedPoliteness:{colorEnabled:e.DefaultPreHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultPreHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultPreHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultPreHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultPreHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultPreHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultPreHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.advancedpolite.outlineThickness},Politeness:{colorEnabled:e.DefaultPreHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultPreHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultPreHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultPreHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultPreHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultPreHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultPreHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.advancedpolite.outlineThickness}},n={Halo:{color:e.DefaultPreHighlightData.halo.color,outlineColor:e.DefaultPreHighlightData.halo.outlineColor,haloColor:e.DefaultPreHighlightData.halo.haloColor},Basic:{color:e.DefaultPreHighlightData.advancedpolite.color,outlineColor:e.DefaultPreHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultPreHighlightData.advancedpolite.haloColor},AdvancedPoliteness:{color:e.DefaultPreHighlightData.advancedpolite.color,outlineColor:e.DefaultPreHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultPreHighlightData.advancedpolite.haloColor},Politeness:{color:e.DefaultPreHighlightData.advancedpolite.color,outlineColor:e.DefaultPreHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultPreHighlightData.advancedpolite.haloColor}};i.internalSceneGraph.selectionPreHL.enable(f(t,i,r,n,"PREHIGHLIGHT"))}(o,this.viewer);const d=t.getBackground3DViewMode();if(null!==d){const t=(1&d)>0,i=(2&d)>0,r=(4&d)>0,n=(8&d)>0,a=(16&d)>0,o=(32&d)>0;this.viewer.setBackgroundViewMode(i?e.BackgroundViewMode.NO_DISPLAY:a?e.BackgroundViewMode.GHOST:t?e.BackgroundViewMode.LOWLIGHT:n?e.BackgroundViewMode.FOG:e.BackgroundViewMode.NORMAL),this.viewer.invertNodeBackgroundView(o),this.viewer.pickNodeBackgroundView(!r),this.viewer.render()}const c=t.get2DMode();if(c){let t,i;if(c._plane){const i=(new e.Vector3).copy(c._plane._firstDirection),r=(new e.Vector3).copy(c._plane._secondDirection),n=i.cross(r);t=new e.Plane(n,-n.dot(c._plane._origin))}switch(c._mode){case 1:i=e.PlaneViewMode.NO_DISPLAY;break;case 2:i=e.PlaneViewMode.LOWLIGHT;break;case 3:i=e.PlaneViewMode.NO_PICK;break;case 4:i=e.PlaneViewMode.LOWLIGHT_NO_PICK;break;default:i=e.PlaneViewMode.NORMAL}this.viewer.setPlaneViewMode({mode:i,plane:t})}else this.viewer.setPlaneViewMode({mode:e.PlaneViewMode.NORMAL});var u=t.getClippingPlane();u&&this.updateClippingPlane(u);let p=t.getMainViewpointUID();if(null==p);else{let e=this.viewManager._viewpointMap.get(p);e?this.viewer._viewpointManager.setManipulatedViewpoint(e):console.error("no viewpoint with provided UID exists")}let m=t.getMultiViewSyncMode();return null!=m&&this.viewer._viewpointManager.setMultiViewSyncMode(m),this.viewer._forcedDynamicModeFromServer=!!t.getDynamicMode(),l("tryUpdateSupportParameters"),n},tryUpdatePLMViewMode:function(e,t){s("tryUpdatePLMViewMode");var i,r=e.getViewpointsInfo();if(r)for(i=0;i<r.length;i++)this.viewer._setViewpointPLMViewMode(r[i]._uid,r[i]._plmViewMode);var n=e.getPLMViewMode();let a;return a=n?this.viewer._updatePLMViewMode(n,t):Promise.resolve(!0),l("tryUpdatePLMViewMode"),a},updateClippingPlane:function(t){var i,r;s("updateClippingPlane");var n=this.viewer.getRootNode();if(n){var a=n.clippingContext,o=a&&a.planes.concat([]);if(o)for(i=0;i<o.length;i++)n.enableClippingPlane(o[i],!1)}var d,c,u,h=t._normal,g=t._point,f=0;for(i=0;i<t._nbPlanes;i++)(d=new e.Vector3(h[f],h[f+1],h[f+2])).normalize(),c=new e.Vector3(g[f],g[f+1],g[f+2]),(r=new e.Plane).setFromNormalAndCoplanarPoint(d,c),n.enableClippingPlane(r,!0),u=t._flags[i],n.clippingContext.setPlaneParams(r,{capping:!!(u&p)}),f+=3;l("updateClippingPlane")},tryUpdateContextData:function(t){if(!t)return Promise.reject(new Error("Missing data"));var r=t.container&&t.container.getVisContextData&&t.container.getVisContextData();if(!r)return Promise.resolve(!1);if(r.VisuStreaming){s("tryUpdateContextData::VisuStreaming");let t,n=this.streamingInterfaces.get(this.viewer),a=r.VisuStreaming._commonData,o=r.VisuStreaming._objectsData;if(0==Object.keys(a).length||0==Object.keys(o).length)this.viewer.setupRemoteRender(),n&&(i.unsubscribe(n.vpSubscriptionToken),this.vpSubscriptionToken=null,n.destroy(),this.streamingInterfaces.set(this.viewer,null)),t=Promise.resolve(!0);else{let o=this,s=this.viewer,l=function(e,t,i){switch(a.streamProtocol){case"JPEG":if(e){var r=e.readBuffer("colorImgBuffer"),n=new Uint8Array(r),o=new Blob([n],{type:"image/jpeg"});s._onRemoteImageReceived({data:o,format:"blob"},i)}else s._onRemoteImageReceived({data:null,format:null},i);break;case"A2X":case"H264":case"HEVC":case"H264DATACHANNEL":case"HEVCDATACHANNEL":s.setRemoteVideoDecoderTexture(t,i,false);break;default:s.setRemoteVideoDecoderTexture(t,i,false),console.warn("unsupported streaming protocol : "+a.streamProtocol)}},d=function(e){void 0===e.connected||e.connected||l(null,null,e.identifier)};n?(n.update(r.VisuStreaming,l),t=Promise.resolve(!0)):t=new Promise((function(t){require(["DS/VisuStreamingA2X/VisuStreamingInterface","DS/VisuStreamingTypes/VisCSICamera","DS/VisuStreamingTypes/VisCSIVector3"],(function(n,a,c){s.setupRemoteRender(!0);let u=new n(r.VisuStreaming,l,d);o.streamingInterfaces.set(s,u);let h=function(e){return new c({x:e.x,y:e.y,z:e.z})};u.vpSubscriptionToken=i.subscribe({event:"/VISU/"},(function(t){if("@onViewpointChange"===t.eventType){let i=t.viewpoint,r=i.viewer,n=o.streamingInterfaces.get(r);if(n){let r=n.connections.get(i.getCsiUID());if(r){let n=(new e.Vector3).subVectors(t.cameraTarget,t.cameraEye),o=n.length(),s=new a({orthogonal:1==i.projectionType,position:h(t.cameraEye),direction:h(n.normalize()),upDirection:h(t.cameraUp),focusDistance:o,angle:i.camera.fov/2,aperture:i.camera.aperture});try{r.connection.updateCamera(s)}catch(e){console.error("error while trying to send viewpoint informations to streaming server :"),console.error(e)}}}}})),t.bind(null,!0)}))}))}return l("tryUpdateContextData::VisuStreaming"),t}return Promise.resolve(!1)},tryUpdateLineDefinitions:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areLineTypeDefinitionsManaged())return Promise.resolve(!1);var t=new n,i=e.getLineTypeDefinitions();i&&(s("tryUpdateLineDefinitions"),i=JSON.parse(i),t.setLineTypes(i),this.viewer.renderer.resetGSSOCache(),this.viewer.render(),l("tryUpdateLineDefinitions"))},tryUpdateColorMap:function(t,r){var n=Promise.resolve(!1),a=t.getColorMap();if(a){s("tryUpdateColorMap");for(var o=[],d=0;d<a.length;d+=3){var c=(new e.Color).setRGB(a[d],a[d+1],a[d+2]);o.push(c)}i.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{colorMap:o,viewer:this.viewer}}}),n=this.viewer._refreshPLMViewMode(r),this.viewer.renderer.resetGSSOCache(),this.viewer.render(),l("tryUpdateColorMap")}return n},tryUpdateSceneEnv:function(e,t){var i=this.tryUpdateAmbiance(e),r=this.tryUpdateLights(e),n=this.tryUpdateCameras(e),a=this.tryUpdateViewModes(e),o=this.tryUpdateSupportParameters(e),s=this.tryUpdatePLMViewMode(e,t),l=this.tryUpdateContextData(e),d=this.tryUpdateLineDefinitions(e),c=this.tryUpdateColorMap(e,t);return Promise.all([i,r,n,a,o,s,l,d,c]).then((function(e){return Promise.resolve({ambianceUpdated:e[0],lightsUpdated:e[1],cameraUpdated:e[2],viewModesUpdated:e[3],supportParametersUpdated:e[4],lineDefinitionsUpdated:e[7],colorMapUpdated:e[8]})}))}},m})),define("DS/WebVisuParameters/WebVisuUpdateTransactionHighlight",["DS/WebVisuParameters/AbstractWebVisuUpdateTransaction","DS/CoreEvents/Events","DS/EKEventsWeb/EKEvents","DS/Visualization/ThreeJS_DS","DS/CSIViewModelWebInterfaces/CSIVMClientCATVizBasePathElementRep","DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteDrawGroupParameter","DS/WebVisuParameters/PathElementRepNodeUtils","DS/Visualization/PathElement","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,n,a,o,s,l,d){"use strict";var c=o.prototype.infiniteGeomTypeValues,u=new Map,h=null,g=function(){this._idObject=null,this._pathes=[],this._order=0};g.prototype.setIdentificationObject=function(e){this._idObject=e},g.prototype.getIdentificationObject=function(){return this._idObject},g.prototype._addPath=function(e,t,i){this._pathes.push({key:e,slot:t,linkedRoot:i})};var p=function(t,i,r,n,a){e.call(this,t,i,r),this.multiSelection=!!n,this._transientHighlightRoot=t._sceneEnvRootForTransientHighlight,0===this._transientHighlightRoot.parents.length&&this.viewManager.viewer.addNode(this._transientHighlightRoot),this.transactionUtils=a};return(p.prototype=Object.create(e.prototype))._getCSISelection=function(e){this.multiSelection||(e=0);var t=this.viewManager.viewer;(h=u.get(t))||(h=new Map,u.set(t,h)),this._csiXSO=this.transactionUtils.getXSO(e,t,this.treeKeyID)},p.prototype._updateOrder=function(){var e=this;h.forEach((function(t,i,r){if(t.length){t.sort(((e,t)=>e.node._order-t.node.order));for(var n=0;n<t.length;n++){var a=t[n].slot;e._getCSISelection(a),(o=e._csiXSO.getPathFromKey(i))&&e._csiXSO._remove(o)}var o,s=t[t.length-1].slot;e._getCSISelection(s),(o=e._csiXSO.getPathFromKey(i))&&e._csiXSO._add(o)}else r.delete(i)}))},p.prototype._insertPathElement=function(e,t,i,r){this._csiXSO.add(t),e._addPath(t.hash(),i,r),this.multiSelection&&(h.has(t.hash())?h.get(t.hash()).push({slot:i,node:e}):h.set(t.hash(),[{slot:i,node:e}]),this._updateOrder())},p.prototype.doOperation=function(t){if(!this.transactionUtils)return;r._NREGASOnNodeInit=!0;var a=i.Trace.traceStart("techno_webvisu","message_to_highlight");const o=t.getType();switch(d.begin("WebVisuParameters::WebVisuUpdateTransactionHighlight "+o),o){case t.OperationType.RemoveAll:this.multiSelection?this.transactionUtils.clearMultiHighlightColorSlot(this.treeKeyID):this._csiXSO&&this._csiXSO.removeAll(),h&&h.clear();break;case t.OperationType.CreateRoot:case t.OperationType.AddNode:case t.OperationType.AddBody:var s=new g;t.setCreatedObject(s);break;case t.OperationType.AddCells:if(!(s=this.getOperatedObject(t)))return;var u=t.getGeometricalData(),p=!!u&&u.hasInfiniteGeometry(),f=u?u.getGeometries():null;if(!p||!f){i.Log.error("Unexpected or missing data in Highlight transaction AddCells");break}for(var m=0;m<f.length;m++){var v=f[m],y=v.getInfiniteDrawGroups();if(y&&y.length){if(y[0].getInfiniteGeomType()===c.path_element){const t=v.getAdditionalDataAsUint8Array(),i=new n(t);if(!i.isValid())continue;const r=this.multiSelection?i.multiColorHighlightSlot+1:0;this._getCSISelection(r);const a=this;e._handlePathElements(i,i.haveTransient?this._transientHighlightRoot:null,((e,t)=>{if(e){const i=new l;i.setFromArray(e._toExternalPathElement(),t.internalPath),a._insertPathElement(s,i,r,e)}else a._insertPathElement(s,t,r,null)}),(e=>null))}}else i.Log.error("Missing getInfiniteDrawGroups in Highlight transaction AddCells")}break;case t.OperationType.RemoveExistingNode:if(!(s=this.getOperandObject(t)))return;for(m=0;m<s._pathes.length;m++){var S=s._pathes[m];this._getCSISelection(S.slot);var _=this._csiXSO.getPathFromKey(S.key);if(_&&(this._csiXSO.remove(_),S.linkedRoot&&this._transientHighlightRoot.removeChild(S.linkedRoot),h.has(_.hash())&&this.multiSelection)){var D=h.get(_.hash()),w=D.findLastIndex((e=>e.node===s&&e.slot===S.slot));-1!==w&&(D.splice(w,1),this._updateOrder())}}s._pathes=[];break;case t.OperationType.ApplyGP:break;default:i.Log.error("Unexpected operation token in Highlight transaction "+o)}r._NREGASOnNodeInit=!1,this.viewManager.viewer.render(),d.end("WebVisuParameters::WebVisuUpdateTransactionHighlight "+o),a.End()},p.prototype.commit=function(){},p.prototype.abort=function(){},p.prototype.executeEnd=function(){},p.prototype.executeInverse=function(){},p})),define("DS/WebVisuParameters/InfiniteGeometryParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteDrawGroupParameter","DS/CSIViewModelWebInterfaces/CSIVMClientGraphicPropertyParameter","DS/CSIViewModelWebInterfaces/CSIVMClientImagePixel","DS/CSIViewModelWebInterfaces/CSIVMClientLight","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/FixedSizePlaneNode","DS/SceneGraphNodes/SimpleArrowNode","DS/SceneGraphNodes/RectangleWithCornersNode","DS/SceneGraphNodes/DynamicLeaderNode","DS/SceneGraphNodes/ArrowSymbolNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/GeometryHelper","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/TextNode","DS/SceneGraphNodes/RefPlaneNode","DS/Visualization/GraphicAttributeSet","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/Visualization/FontUtils","DS/Visualization/Filters/GASInheritFilter","DS/SceneGraphNodes/AnnotationText","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject","DS/CSIViewModelWebInterfaces/CSIVMClientCATVizBasePathElementRep","DS/Visualization/MaterialManager","DS/WebVisuParameters/PathElementRepNodeUtils","DS/WebVisuParameters/ImagePixelHelper","DS/VisualizationProfiler/VisuProfiler","DS/WebVisuParameters/AbstractWebVisuUpdateTransaction","DS/CSIViewModelWebInterfaces/CSIVMClientCAT2DRectangleWithCornersGPParameter","DS/CSIViewModelWebInterfaces/CSIVMClientVis3DDynamicLeaderGPParameter"],(function(e,t,i,r,n,a,o,s,l,d,c,u,h,g,p,f,m,v,y,S,_,D,w,T,P,C,I,M,E,b,A,V,O,N,G,x,R){"use strict";var H=!1,k=i.prototype.infiniteGeomTypeValues,L=1/g.getPixelsPerMM(),F=w.DefaultGASs.transition,U=w.DefaultGASs.edge.clone().setParameters({colorIndex:g.COLORMAP_INDEX.BLACK});let B=new T;var W=new g.Color(0),z=new g.Vector3(1,0,0),j=new g.Vector3(0,0,1),X=new Map;function $(e,t,i){for(var r=0;r<e.children.length;r++){var n=e.children[r];n._setGAS(t),$(n,t,i)}e.mesh3js&&i&&e.mesh3js.geometry[0].drawingGroups.forEach((function(e){var t=i.triangle;0===e.glType?t=i.point:1===e.glType&&(t=i.line),e.gas&&e.gas._inheritance===g.GASEnum._FORCE_COLOR||(e.gas=t)}))}function K(e,t){e.traverse((function(e){if(void 0===e)return!0;if("Mesh3D"===e.getNodeType()){e.mesh3js.geometry[0].drawingGroups.forEach((e=>e._geomType=t))}return!1}),t)}const J={json_additional:(e,t)=>({properties:JSON.parse(new TextDecoder("utf-8").decode(t)),itemReadAdditional:t.length}),light_deserializer:(e,t)=>new a(t,0),reference_plane(e,t){let i=0,r=0;const n=e[i++],a=e[i++],o=new g.Vector3(e[i++],e[i++],e[i++]),s=new g.Vector3(e[i++],e[i++],e[i++]),l=new g.Vector3(e[i++],e[i++],e[i++]),d=1===t[r++],c=1===t[r++],u=t[r++];let h="";const p=t[r++];if(p>0){const e=[];for(let i=0;i<p;++i)e.push(String.fromCharCode(t[r++]));h=e.join("")}const f=t[r++];let m=null;if(f){m=function(e){const t={},i=e[0];i>>3==0&&(t._wireframeMode=!!(4&i),t._labelVisibility=!!(2&i),t._orientationVisibility=!!(1&i),t._frontColorR=e[1],t._frontColorG=e[2],t._frontColorB=e[3],t._backColorR=e[4],t._backColorG=e[5],t._backColorB=e[6],t._opacity=e[7]);return t}(t.subarray(r,r+=f))}return{properties:{lengthU:n,lengthV:a,origin:o,dirU:s,dirV:l,fixedSize:d,label:h,rendering:m,incLengthBy5PercentIfZoomable:c,rangeScale:u},itemReadGeom:11,itemReadAdditional:r}},canonical_cuboid(e,t){let i=0;return{properties:{corner:[e[i++],e[i++],e[i++]],firstAxis:[e[i++],e[i++],e[i++]],secondAxis:[e[i++],e[i++],e[i++]],thirdLength:e[i++]},itemReadGeom:10}},canonical_sphere(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],radius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:5,itemReadAdditional:1}},canonical_partialsphere(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],firstAxis:[e[i++],e[i++],e[i++]],secondAxis:[e[i++],e[i++],e[i++]],meridianStartAngle:e[i++],meridianEndAngle:e[i++],parallelStartAngle:e[i++],parallelEndAngle:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:14,itemReadAdditional:1}},canonical_cylinder(e,t){let i=0,r=0;return{properties:{bottomCenter:[e[i++],e[i++],e[i++]],topCenter:[e[i++],e[i++],e[i++]],radius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:8,itemReadAdditional:1}},canonical_cone(e,t){let i=0,r=0;return{properties:{bottomCenter:[e[i++],e[i++],e[i++]],topCenter:[e[i++],e[i++],e[i++]],bottomRadius:e[i++],topRadius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:9,itemReadAdditional:1}},canonical_torus(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],planeNormal:[e[i++],e[i++],e[i++]],minorRadius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:8,itemReadAdditional:1}},canonical_partialtorus(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],firstAxis:[e[i++],e[i++],e[i++]],secondAxis:[e[i++],e[i++],e[i++]],minorRadius:e[i++],majorAngle:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:12,itemReadAdditional:1}},canonical_curvedpipe(e,t){let i=0,r=0;const n=e[i++],a=[];for(let t=0;t<3*n;t++)a.push(e[i++]);return{properties:{centers:a,startNormal:[e[i++],e[i++],e[i++]],endNormal:[e[i++],e[i++],e[i++]],radius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:i,itemReadAdditional:1}}};class Y{static create(e,t,i){throw new Error("Not implemented")}static update(e,t,i){throw new Error("Not implemented")}}class Z extends Y{static create(e,t,i){20===t.lengthU&&(t.lengthU=16.5),20===t.lengthV&&(t.lengthV=16.5);const{params:r,matrix:n}=Z.getParams(t),a=new m;let o=Z.getNode(r);return a.addChild(o),a.setMatrix(n),K(a,g.GeomTypeEnum.INFINITE_FACE),e.addChild(a),o.cbChange&&o.cbChange(),{CSINode:a,noZ:!1,alreadyAdded:!0}}static update(e,t,i){const{params:r,matrix:n}=Z.getParams(t);let a=e.children[0];if(e.setMatrix(n),a.parents.length>1)e.removeChild(a),a=Z.getNode(r),e.addChild(a),K(e,g.GeomTypeEnum.INFINITE_FACE);else{const e=Z.refPlaneHash.get(a),t=Z.getHash(r);Z.refPlaneMap.get(e)===a&&Z.refPlaneMap.delete(e),void 0===Z.refPlaneMap.get(t)&&Z.refPlaneMap.set(t,a),Z.refPlaneHash.set(a,t),a.setNewLook(r.newLook),a.setParameters(r)}a.cbChange&&a.cbChange()}static getParams(e){let{lengthU:t,lengthV:i}=e;const{origin:r,dirU:n,dirV:a,fixedSize:o,label:s,incLengthBy5PercentIfZoomable:l,rangeScale:d}=e,c=e.rendering||{};0===t&&0!==i&&(t=i),0===i&&0!==t&&(i=t),0===t&&0===i&&(t=i=35),o&&(t*=1/L,i*=1/L),!o&&l&&(t*=1.1,i*=1.1);const u=(new g.Vector3).crossVectors(n,a),h=new g.Matrix4;h.makeBasis(n,a,u),h.setPosition(r);const p=!c||!c._wireframeMode,f=!!c&&c._orientationVisibility,m=!c||c._labelVisibility,v=c?c._opacity/255:.075,y=c?(new g.Color).setRGB(c._frontColorR/255,c._frontColorG/255,c._frontColorB/255):new g.Color("#005686"),S=c?(new g.Color).setRGB(c._backColorR/255,c._backColorG/255,c._backColorB/255):new g.Color("#a3c8dc");return{params:{name:"refPlane",fill:!0,newLook:p,orientationArrow:f,fixedSize:o,size:new g.Vector2(t,i),planeAttributes:{front:{color:y,opacity:v},back:{color:S,opacity:v}},borderAttributes:{front:{color:y,opacity:.8,width:1},back:{color:S,opacity:.8,width:1}},textAttributes:{front:{data:m?s:"",color:y,opacity:.8,size:14},back:{data:m?s:"",color:S,opacity:.8,size:14}}},matrix:h}}static getHash(e){let t=e.newLook?"NL_":"";e.orientationArrow&&(t+="OA_"),e.fixedSize&&(t+="FS_"),t+=e.size.x.toFixed(3)+"_",t+=e.size.y.toFixed(3)+"_";let i=e.planeAttributes;return i&&(i.front&&(i.front.opacity&&(t+="O_",t+=i.front.opacity.toFixed(3)),i.front.color&&(t+="FC_",t+=i.front.color.getHexString())),i.back&&i.back.color&&(t+="BC_",t+=i.back.color.getHexString())),e.textAttributes&&e.textAttributes.front&&(t+="T_",t+=e.textAttributes.front.data),t}static getNode(e){const t=Z.getHash(e);let i=Z.refPlaneMap.get(t);return i||(i=new D(e),$(i,new w.IncrementalGraphicAttributeSet({type:g.GASTypeEnum._SKIN}).usingNREInit(!0),null),i.setPickParent(!0),Z.refPlaneMap.set(t,i),Z.refPlaneHash.set(i,t)),i}}Z.refPlaneMap=new Map,Z.refPlaneHash=new WeakMap;class q{static create(e,t,i){const r={lights:[]};i.threeDXLoader.applyLights({json:t.lightJson,chunks:t.lightBuffers,data:t.lightJson,destinationNode:e},!0);const n=0!==r.lights.length;return{CSINode:n?r.lights[0]:null,alreadyAdded:!!n||void 0}}}function Q(e){const t=new v(e);return $(t,F,{triangle:F,line:U,point:F}),{CSINode:t,noZ:!1}}class ee{static create(e,t,i){return Q(f.createCuboidMesh({corner:t.corner,firstAxis:t.firstAxis,secondAxis:t.secondAxis,thirdLength:t.thirdLength},F))}}class te{static create(e,t,i){return Q(f.createCustomSphereMesh({parallelStart:-Math.PI/2,parallelEnd:Math.PI/2,meridianStart:0,meridianEnd:2*Math.PI,center:t.center,firstAxis:[t.radius,0,0],secondAxis:[0,1,0],sag:{sag:t.sag,sagMode:t.sagMode}},F))}}class ie{static create(e,t,i){return Q(f.createCustomSphereMesh({parallelStart:t.parallelStartAngle,parallelEnd:t.parallelEndAngle,meridianStart:t.meridianStartAngle,meridianEnd:t.meridianEndAngle,center:t.center,firstAxis:t.firstAxis,secondAxis:t.secondAxis,sag:{sag:t.sag,sagMode:t.sagMode}},F))}}class re{static create(e,t,i){return Q(f.createCustomCylinderMesh({bottomCenter:t.bottomCenter,topCenter:t.topCenter,bottomRadius:t.radius,topRadius:t.radius,sag:{sag:t.sag,sagMode:t.sagMode}},F))}}class ne{static create(e,t,i){return Q(f.createCustomCylinderMesh({bottomCenter:t.bottomCenter,topCenter:t.topCenter,bottomRadius:t.bottomRadius,topRadius:t.topRadius,sag:{sag:t.sag,sagMode:t.sagMode}},F))}}class ae{static create(e,t,i){return Q(f.createTorusMesh({center:t.center,planeNormal:t.planeNormal,minorRadius:t.minorRadius,sag:{sag:t.sag,sagMode:t.sagMode}},F))}}class oe{static create(e,t,i){return Q(f.createPartialTorusMesh({center:t.center,firstAxis:t.firstAxis,secondAxis:t.secondAxis,minorRadius:t.minorRadius,majorAngle:t.majorAngle,sag:{sag:t.sag,sagMode:t.sagMode}},F))}}class se{static create(e,t,i){return Q(f.createCurvedPipeMesh({centers:t.centers,radius:t.radius,startN:t.startNormal,endN:t.endNormal,sag:{sag:t.sag,sagMode:t.sagMode}},F))}}function le(e){switch(e){case k.reference_plane:return Z;case k.light:return q;case k.canonical_cuboid:return ee;case k.canonical_sphere:return te;case k.canonical_partialsphere:return ie;case k.canonical_cylinder:return re;case k.canonical_cone:return ne;case k.canonical_torus:return ae;case k.canonical_partialtorus:return oe;case k.canonical_curvedpipe:return se;default:return null}}function de(e){switch(e){case k.reference_plane:return J.reference_plane;case k.light:return J.light_deserializer;case k.canonical_cuboid:return J.canonical_cuboid;case k.canonical_sphere:return J.canonical_sphere;case k.canonical_partialsphere:return J.canonical_partialsphere;case k.canonical_cylinder:return J.canonical_cylinder;case k.canonical_cone:return J.canonical_cone;case k.canonical_torus:return J.canonical_torus;case k.canonical_partialtorus:return J.canonical_partialtorus;case k.canonical_curvedpipe:return J.canonical_curvedpipe;default:return null}}return e.extend({init:function(e,t){this.parameter=e,this._threeDXLoader=t,this._sagInfos={sag:.2,sagMode:1},this._options={threeDXLoader:t}},updateInfiniteGeometry:function(e,t){const i=this.parameter.getInfiniteDrawGroups(),r=this.parameter.getInfiniteGeometryAsFloat32Array(),n=this.parameter.getAdditionalDataAsUint8Array();if(r)for(let e=0;e<i.length;e++){const a=i[e],o=a.getInfiniteGeomType(),s=new Uint32Array(this.parameter.getBuffer(),a.getStart(),3*a.getCount());for(let e=0;e<a.getCount();++e){const i=s[3*e];let a=s[3*e+1],l=s[3*e+2];const d=t.getChildById(i),c=le(o),u=de(o);if(!u||!c)continue;const{properties:h,itemReadGeom:g,itemReadAdditional:p}=u(r.subarray(a),n.subarray(l));c.update(d,h)}}},getInfiniteGeometry:function(e,t){N.begin("InfiniteGeometryParameterHelper::getInfiniteGeometry");var i=this.parameter.getInfiniteDrawGroups(),a=[],s=[],l=this.parameter.getInfiniteGeometryAsFloat32Array();if(!l)return{geometry:[],primitiveIDs:[]};for(var p=this.parameter.getAdditionalDataAsUint8Array(),v=!1,T=0;T<i.length;T++){var E=i[T],A=E.getInfiniteGeomType();if(A===k.path_element){const e=new b(p);if(!e.isValid())continue;G._handlePathElements(e,t,((e,t)=>{s.push(e),a.push(e.name+e.id)}),(e=>e.getLastElement(!1,!0)))}else for(var V=new Uint32Array(this.parameter.getBuffer(),E.getStart(),3*E.getCount()),U=0;U<E.getCount();++U){var X,K=V[3*U],J=V[3*U+1],Y=V[3*U+2],Z=!0;switch(A){case k.origin:var q=[l[J++],l[J++],l[J++]];(ae=p[Y++])>8&&(ae=f.PointSymbolEnum.UNKNOWN);var Q={positions:q,number:1,color:W};X=new m;var ee=h.createPointsNode(Q),te=new g.Sphere(new g.Vector3(q[0],q[1],q[2]));te.pixelRadius=1,ee.forceBoundingSphere(te),ee.setPickParent(!0),X.addChild(ee),X.traverse(this._CBOnTraversal,g.GeomTypeEnum.FREE_POINT),$(X,F,{triangle:F,line:F,point:F.clone().setParameters({symbolType:ae})});break;case k.points:for(var ie=l[J++],re=[],ne=0;ne<3*ie;++ne)re.push(l[J++]);var ae;(ae=p[Y++])>8&&(ae=f.PointSymbolEnum.UNKNOWN);Q={positions:re,number:ie,color:new g.Color("black")};X=new m,(ee=h.createPointsNode(Q)).setPickParent(!0),X.addChild(ee),X.traverse(this._CBOnTraversal,g.GeomTypeEnum.FREE_POINT),$(X,F,{triangle:F,line:F,point:F.clone().setParameters({symbolType:ae})});break;case k.arrow:var oe=new g.Vector3(l[J++],l[J++],l[J++]),se=new g.Vector3(l[J++],l[J++],l[J++]),ce=new g.Vector3(l[J++],l[J++],l[J++]),ue=l[J++],he=l[J++],ge=l[J++],pe="";if((Se=p[Y++])>0){var fe=[];for(ne=0;ne<Se;++ne)fe.push(String.fromCharCode(p[Y++]));pe=fe.join("")}X=new m;Q={name:"simplearrow",pickable:!0,color:new g.Color("black"),begin:oe,direction:se,normal:ce,length:ue,headHeight:he,baseLength:ge,globalSelection:!0};var me=this.getSimpleArrowNode(Q,{text:pe,length:Se});X.addChild(me.arrow),X.addChild(me.label),X.traverse(this._CBOnTraversal,g.GeomTypeEnum.AXIS_SYSTEM),$(X,F,{triangle:F,line:F,point:F});break;case k.axis:U<E.getCount()-1&&!H&&(H=V[3*(U+1)+1]-J==10);var ve=l[J++];ve*=1/L;q=new g.Vector3(l[J++],l[J++],l[J++]),se=new g.Vector3(l[J++],l[J++],l[J++]);var ye=l[J++];ye*=1/L,((He=l[J++])<0||He>.5*Math.PI)&&(He=.1974),0===He&&(ye=0);ge=H?l[J++]:0;ge*=1/L;var Se;pe="";if((Se=p[Y++])>0){for(fe=[],ne=0;ne<Se;++ne)fe.push(String.fromCharCode(p[Y++]));pe=fe.join("")}X=new m;var _e=Math.abs(se.z)<.999?j:z,De=(new g.Vector3).crossVectors(_e,se);De.normalize();var we=(new g.Vector3).crossVectors(se,De),Te=new g.Matrix4;Te.makeBasis(De,we,se),Te.setPosition(q),X.setMatrix(Te);Q={name:"arrow",pickable:!0,color:new g.Color("black"),head:ye>0?o.types.ARROW:o.types.NONE,baseLength:ge,arrowLength:ve,arrowWidth:1,headLength:ye,headWidthToHeightRatio:2*Math.tan(He),globalSelection:!0};var Pe=this.getAxisNode(Q,{text:pe,length:Se});X.addChild(Pe.axis),X.addChild(Pe.label),X.traverse(this._CBOnTraversal,g.GeomTypeEnum.AXIS_SYSTEM),$(X,F,{triangle:F,line:F,point:F});break;case k.infinite_plane:ue=l[J++];ue*=1/L;q=new g.Vector3(l[J++],l[J++],l[J++]);var Ce=new g.Vector3(l[J++],l[J++],l[J++]),Ie=new g.Vector3(l[J++],l[J++],l[J++]);if(p[Y++]){(X=h.createFixedSizeNode({name:"CSIFixedSizeHalfPlaneNode",ratio:1})).setMatrix((new g.Matrix4).setPosition(q));var Me=Ce.clone().add(Ie).normalize().multiplyScalar(1.4142136*ue/2),Ee=q.clone().add(Me),be=Ee.clone().add(Ce.multiplyScalar(ue/2)),Ae=Ee.clone().add(Ie.multiplyScalar(ue/2)),Ve=h.createLineNode({points:[be,Ee,Ae],color:new g.Color("black")});Ve.setMaterialMode(!1),Ve.setPickParent(!0),Ve.setMatrix((new g.Matrix4).setPosition(q.negate())),X.addChild(Ve),$(X,F,{triangle:F,line:F,point:F})}else{var Oe=(new g.Vector3).crossVectors(Ce,Ie);(Re=new g.Matrix4).makeBasis(Ce,Ie,Oe),Re.setPosition(q);Q={name:"refPlane",fill:!0,fixedSize:!0,size:new g.Vector2(ue,ue),planeAttributes:{front:{color:new g.Color("#005686"),opacity:.075},back:{color:new g.Color("#a3c8dc"),opacity:.075}},borderAttributes:{front:{color:new g.Color("#005686"),opacity:.8,width:1},back:{color:new g.Color("#a3c8dc"),opacity:.8,width:1}},textAttributes:{fixedSize:!0,front:{data:"",color:new g.Color("#005686"),opacity:1,size:30},back:{data:"",color:new g.Color("#a3c8dc"),opacity:1,size:30}}};Z=!1,$(X=new D(Q),new w.IncrementalGraphicAttributeSet({type:g.GASTypeEnum._SKIN}).usingNREInit(!0),null),X.setMatrix(Re)}X.traverse(this._CBOnTraversal,g.GeomTypeEnum.INFINITE_FACE);break;case k.text:q=new g.Vector3(l[J++],l[J++],l[J++]);var Ne=l[J++],Ge=[];for(ne=0;ne<4;++ne)Ge.push(p[Y++]);ue=function(e){if(Array.isArray(e)){var t=new ArrayBuffer(e.length),i=new DataView(t);return e.forEach((function(e,t){i.setUint8(t,e)})),i}}(Ge.reverse()).getUint32(0),pe="";if(ue>0){for(fe=[],ne=0;ne<ue;++ne)fe.push(String.fromCharCode(p[Y++]));pe=fe.join("")}var xe=new _("CSIText");xe.setPrimitivePicking(!1),xe.textMaterial.side=2,xe.addText({string:pe,anchor:new g.Vector3(q.x,q.y,0),color:new g.Color(0),size:Ne,lineLength:500,up:new g.Vector3(0,1,0),right:new g.Vector3(1,0,0)}),xe.setPickParent(!0),(X=new m).addChild(xe),$(X,F,{triangle:F,line:F,point:F});break;case k.path_element:break;case k.annotation_text:const i=JSON.parse(new TextDecoder("utf-8").decode(p)),a=i.anchor;if(!i.box)break;const s=i.point,T=i.box.height,b=i.box.width,N=i.box.descent;let G=T,K=s.x,Ue=s.y,Be=0,We=0;void 0!==a&&(a!=g.AnchorPoint.BOTTOM_CENTER&&a!=g.AnchorPoint.BASE_CENTER&&a!=g.AnchorPoint.TOP_CENTER||(Be-=.5*b),a!=g.AnchorPoint.BOTTOM_RIGHT&&a!=g.AnchorPoint.BASE_RIGHT&&a!=g.AnchorPoint.TOP_RIGHT||(Be-=b),a!=g.AnchorPoint.BOTTOM_LEFT&&a!=g.AnchorPoint.BOTTOM_CENTER&&a!=g.AnchorPoint.BOTTOM_RIGHT||(We+=N),a!=g.AnchorPoint.TOP_LEFT&&a!=g.AnchorPoint.TOP_CENTER&&a!=g.AnchorPoint.TOP_RIGHT||(We+=N-T)),We-=N,K+=Be,Ue+=We;const ze=i.font;let je,Xe=0,$e=!0;ze&&(Xe=ze.font),X=new m,je=$e?new y({ratio:3.8}):new m;const Ke={type:"Spherical"};je.setVisuFilters({gasInheritFilter:(new C).usingColorInherit(null,!1).usingASMColorInherit(null,!1)});let Je=new S(Ke);Je.addChild(je);var Re=(new g.Matrix4).setPosition({x:s.x,y:s.y,z:0});Je.setMatrix(Re),X.addChild(Je);const Ye=function(e){for(var t=0;t<e.length;++t){var i=e[t];je.addChild(i),i.setPickParent(!0)}};let Ze=h.createRectangleNode({width:b,height:G,delta:new g.Vector2(Be,We),fill:!0,color:new f.Color(.5,.5,.2,1)});if(i.contour){const t=i.contour1;if(t&&t.set&&t.rgba){let i=new r(t.set,t.rgba),n=h.createLineNode({points:[new g.Vector3(Be,We,0),new g.Vector3(Be,We+G,0),new g.Vector3(Be+b,We+G,0)]});new M(i,e.clientManager).applyGP(this,n),n.setPickParent(!0),je.addChild(n)}const n=i.contour2;if(n&&n.set&&n.rgba){let t=new r(n.set,n.rgba),i=h.createLineNode({points:[new g.Vector3(Be,We,0),new g.Vector3(Be+b,We,0),new g.Vector3(Be+b,We+G,0)]});new M(t,e.clientManager).applyGP(this,i),i.setPickParent(!0),je.addChild(i)}}Ze.setGAS(new w({basic:!0,colorIndex:g.COLORMAP_INDEX.FOREGROUND,inheritance:g.GASEnum.COLOR_INHERITANCE_ON})),Ze.setPickParent(!0),je.addChild(Ze);const qe=3==Xe||4==Xe,Qe=2==Xe||4==Xe;let et={text:i.text,bbox:[Be,Be+b,We,We+G],fontName:"3ds Regular.ttf",color:{r:0,g:0,b:0},colorIndex:g.COLORMAP_INDEX.BACKGROUND,bold:Qe,italic:qe,width:b,orientationAngle:0,_noZPriority:4,viewer:e.viewManager.viewer};P.createTexts([et],{},Ye);break;case k.image_pixel:const tt=new n(p,Y);if(0===tt.nbImages)break;const it=e.viewManager.viewer;if(Z=!1,tt.imageGPInfo||tt.freetypeTextGPInfo){const t=new m;X=t;const i=tt.textureJson,r=tt.imagesBuffer;new Promise(((e,n)=>{this._threeDXLoader.load({zipped:!1,json:i,chunks:r,destinationNode:t,doneCallback:e,resourcesLibrary:B,forcePowerOfTwo:!1})})).then((()=>{const i=function(i){if(tt.imageGPInfo){let e=it&&it.currentViewpoint&&it.currentViewpoint,r=O.createImagePixel(tt,e,i);t.addChild(r)}if(tt.freetypeTextGPInfo){let r=it&&it.currentViewpoint&&it.currentViewpoint,n=O.createFreeTypeText(tt,r,i,e.isViewpoint2D());t.addChild(n)}$(t,F,{triangle:F,line:F,point:F})};Object.values(B.refImages)[0].values().next().value;if(tt.textureJson&&tt.textureJson.images&&tt.textureJson.images[0]){const e=tt.textureJson.images[0].uid,t=B.refImages[e].values().next().value;if(t instanceof g.Texture){if(t.loadEndStatus!==g.AssetLoadingStatus.READY)return void t.onLoadCallbacks.push(i);i(t)}}}))}else if(tt.annotationGPInfo){const t=new I({point:tt.point,anchor:tt.annotationGPInfo.anchor,isDepthTestEnabled:tt.annotationGPInfo.isDepthTestEnabled,height:tt.annotationGPInfo.height,contour:tt.annotationGPInfo.contour,contour1:tt.annotationGPInfo.contour1,contour2:tt.annotationGPInfo.contour2,viewer:e.viewManager.viewer,descent:tt.annotationGPInfo.descent,gasTransition:F});$(t,F,{triangle:F,line:F,point:F}),X=t;const i=tt.textureJson,r=tt.imagesBuffer;new Promise(((e,n)=>{this._threeDXLoader.load({zipped:!1,json:i,chunks:r,destinationNode:t,doneCallback:e,resourcesLibrary:B,forcePowerOfTwo:!1})})).then((()=>{let e=[];for(var i=0;i<tt.textureJson.images.length;i++){var r=tt.textureJson.images[i].uid;const t=B.refImages[r].values().next();e.push(t.value)}t.setMipmaps(e)}))}break;case k.rectangle_with_corners:let rt=x.deserialize(l,p),nt={bottomLeftCorner:new g.Vector2(rt.leftBottom[0],rt.leftBottom[1]),topRightCorner:new g.Vector2(rt.topRight[0],rt.topRight[1]),squaredCorners:0===rt.type,brightColor:rt.brightColor,darkColor:rt.darkColor,frameColor:rt.frameColor};if(X=new d(nt),rt.matrix){let e=new g.Matrix4;e.elements=rt.matrix,e.elements[10]=1,e.elements[15]=1,X.setMatrix(e)}$(X,F,{triangle:F,line:F,point:F});break;case k.symbol_arrow:oe=new g.Vector3(l[J++],l[J++],0);(se=new g.Vector3(l[J++],l[J++],0)).normalize();var He=l[J++],ke=l[J++],Le=l[J++];ke||(Le/=L);var Fe=l[J++];Q={name:"arrowSymbol",direction:se,semiAngle:He,symbol:u.CSITypes[Fe],size:Le,zoom:ke,color:new g.Color("black"),pickable:!0,globalSelection:!0};X=new u(Q),(Re=new g.Matrix4).setPosition(oe),X.setMatrix(Re),X.traverse(this._CBOnTraversal,g.GeomTypeEnum.AXIS_SYSTEM),$(X,F,{triangle:F,line:F,point:F});break;case k.dynamic_leader:let at=R.deserialize(l.subarray(J));J+=20;let ot=new g.Vector3(at.data.target[0],at.data.target[1],at.data.target[2]),st=at.data.box,lt=new g.Vector3(st.pos[0],st.pos[1],st.pos[2]),dt=at.data.arrowHead,ct=null;0===at.type?ct="simple":0===at.type&&(ct="snappable",J+=2);let ut={target:ot,xmin:st.xmin,xmax:st.xmax,ymin:st.ymin,ymax:st.ymax,angle:st.angle,boxAnchorPoint:lt,arrowHead:dt,type:ct,centroidMode:at.data.centroidMode};$(X=new c(ut),F,{triangle:F,line:F,point:F});break;default:const ht=de(A),gt=le(A),pt=ht(l.subarray(J),p?p.subarray(Y):null);J+=pt.itemReadGeom,Y+=pt.itemReadAdditional;const ft=gt.create(t,pt.properties,this._options);X=ft.CSINode,void 0!==ft.noZ&&(Z=ft.noZ),void 0!==ft.alreadyAdded&&(v=ft.alreadyAdded)}X&&(Z&&X.setNoZ(!0),v||t.addChild(X),s.push(X),X.persistentId=K,a.push(K))}}return N.end("InfiniteGeometryParameterHelper::getInfiniteGeometry"),{geometry:s,primitiveIDs:a}},_CBOnTraversal:function(e,t){if(void 0===e)return!0;"Mesh3D"===e.getNodeType()&&e.mesh3js.geometry[0].drawingGroups.forEach((function(e){e._geomType=t}));return!1},getAxisNode:function(e,t){var i="BL_"+e.baseLength;i+="AL_"+e.arrowLength,i+="HL_"+e.arrowHeadLength,i+="SA_"+e.headWidthToHeightRatio,i+="T_"+t.text;var r=X.get(i);if(!r){var n=new o(e);n.setPickParent(!0);var a=new _("myText",!0,{billboard:!0,billboardAxis:!1,fixedSize:!0,allocSize:t.length});a.setPickParent(!0),a.textMaterial.refreshUniforms=function(e,t){this.updatePDSFXUniform("invSize",new g.Vector2(1/e.getViewportSize().width,1/e.getViewportSize().height))},a.addText({string:t.text,anchor:new g.Vector3,offset:new g.Vector3(-5,-5,0),color:new g.Color(16777215),size:20*(g.getDevicePixelRatio()||1),lineLength:500,up:new g.Vector3(0,0,1),right:new g.Vector3(0,1,0)}),a.setPrimitivePicking(!1),a.setRatio(1),a.setFixedSizeCenter(new g.Vector3(0,0,8+e.baseLength+e.arrowLength),1),r={axis:n,label:a},X.set(i,r)}return r},getSimpleArrowNode:function(e,t){var i=new l(e);i.setPickParent(!0);var r=new _("myText",!0,{billboard:!0,billboardAxis:!1,fixedSize:!0,allocSize:t.length});r.setPickParent(!0),r.textMaterial.refreshUniforms=function(e,t){this.updatePDSFXUniform("invSize",new g.Vector2(1/e.getViewportSize().width,1/e.getViewportSize().height))},r.addText({string:t.text,anchor:new g.Vector3,offset:new g.Vector3(-20,-20,0),color:new g.Color(16777215),size:20*(g.getDevicePixelRatio()||1),lineLength:500,up:new g.Vector3(0,0,1),right:new g.Vector3(0,1,0)}),r.setPrimitivePicking(!1),r.setRatio(1);var n=(new g.Matrix4).setPosition(i.getTopHead());return r.setMatrix(n),{arrow:i,label:r}}})})),define("DS/WebVisuParameters/GeometryParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientDrawGroupParameter","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/GraphicAttributeSet","DS/GPUFormats/VertexAttribute","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/Visualization/Node3D","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,n,a,o,s,l,d){"use strict";var c=i.prototype.geomTypeValues,u=[0];const h={[c.unknown]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[c.unknown_0D]:{glType:0,geomType:r.GeomTypeEnum.UNKNOWN},[c.unknown_1D]:{glType:1,geomType:r.GeomTypeEnum.UNKNOWN},[c.unknown_2D]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[c.unknown_3D]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[c.edge]:{glType:1,geomType:r.GeomTypeEnum.EDGE},[c.wire_Edge]:{glType:1,geomType:r.GeomTypeEnum.WIRE_EDGE},[c.boundary_Edge]:{glType:1,geomType:r.GeomTypeEnum.BOUNDARY_EDGE},[c.sharp_Edge]:{glType:1,geomType:r.GeomTypeEnum.SHARP_EDGE},[c.smooth_Edge]:{glType:1,geomType:r.GeomTypeEnum.SMOOTH_EDGE},[c.high_curvature_edge]:{glType:1,geomType:r.GeomTypeEnum.SMOOTH_EDGE|r.GeomTypeEnum._HIGH_CURVATURE_EDGE},[c.hidden_Seam_Edge]:{glType:1,geomType:r.GeomTypeEnum.HIDDEN_SEAM_EDGE},[c.boundary_Point]:{glType:0,geomType:r.GeomTypeEnum.BOUNDARY_POINT},[c.sharp_Point]:{glType:0,geomType:r.GeomTypeEnum.SHARP_POINT},[c.smooth_Point]:{glType:0,geomType:r.GeomTypeEnum.SMOOTH_POINT},[c.hidden_Seam_Point]:{glType:0,geomType:r.GeomTypeEnum.HIDDEN_SEAM_POINT},[c.surfacic_Point]:{glType:0,geomType:r.GeomTypeEnum.SURFACIC_POINT},[c.free_Point]:{glType:0,geomType:r.GeomTypeEnum.FREE_POINT},[c.infinite_Face]:{glType:4,geomType:r.GeomTypeEnum.INFINITE_FACE},[c.face]:{glType:4,geomType:r.GeomTypeEnum.FACE}};var g=a.DefaultGASs.defaultGAS,p=a.DefaultGASs.transition;const f=4294967295;function m(e,t,i,r){const n=new Uint32Array(t,e.getOffset(),e.getByteLength()/e.getBytePerElement()),a=4+(i?1:0)+(r?1:0),o=[];for(let e=0;e<n.length;e+=a)o.push({offset:n[e],count:n[e+1],cgmId:n[e+2],csiId:n[e+3],isIndexed:!i||n[e+4],deco:r?n[e+(i?5:4)]:void 0});return o}class v{constructor(e,t){this.parameter=e,this.version=t.version,this.hasGeomDecorations=t.hasGeomDecorations}getGeometry(e,t,i){d.begin("GeometryParameterHelper::getGeometry");var a=e.getDefaultMaterials(),o=(a.volume,a.surface,a.line,a.point,new r.BufferGeometryDS),s=!1;let l=!1;var f,v=[],y=0;for(var S in this.parameter.bufferPartitionValues){var _=this.parameter.bufferPartitionValues[S],D=this.parameter.getBufferPartition(_);if(D)if(_===this.parameter.bufferPartitionValues.vertexIndexArray){l=4===D.getBytePerElement();const e=D.getByteLength()/D.getBytePerElement();f=l?new Uint32Array(this.parameter.getBuffer(),D.getOffset(),e):new Uint16Array(this.parameter.getBuffer(),D.getOffset(),e),1===this.version&&(o[S]=f)}else if(_===this.parameter.bufferPartitionValues.primitiveDecorationArray)this.hasGeomDecorations&&(o.decorations=new Uint8Array(this.parameter.getBuffer(),D.getOffset(),D.getByteLength()));else{var w=new Float32Array(this.parameter.getBuffer(),D.getOffset(),D.getByteLength()/D.getBytePerElement());if(_===this.parameter.bufferPartitionValues.vertexUv2Array){for(var T=new Float32Array(3*w.length/2),P=0;P<w.length/2;P++)T[3*P]=w[2*P],T[3*P+1]=w[2*P+1],T[3*P+2]=0;w=T}o[S]=w}}var C=new n.SGRep({solid:t}),I=this.parameter.getDrawGroups(),M=[];for(P=0;P<I.length;P++){var E=I[P],b=E.getPrimitives();b=new Uint32Array(this.parameter.getBuffer(),b.getOffset(),b.getByteLength()/b.getBytePerElement());var A=h[E.getGeomType()],V=A.glType,O=A.geomType;E.getGeomType()===c.unknown_2D&&(s=!0);var N=[],G=[],x=new n.DrawingGroup(i?p:g,null,V,2===this.version?y:E.getStart(),E.getCount(),N,void 0,O,0);if(x.geometry=o,o.drawingGroups.push(x),2===this.version){var R=E.isEdge(),H=4+(R?1:0)+(L=this.hasGeomDecorations?1:0);const e=m(E.getPrimitives(),this.parameter.getBuffer(),R,this.hasGeomDecorations);for(let t=0;t<e.length;t++){const i=e[t],r=y;if(i.isIndexed)for(var k=i.offset;k<i.offset+i.count;k++)v[y]=f[k],v[y]>65535&&(l=!0),y++;else for(k=0;k<i.count-1;k++)v[y]=i.offset+k,v[y+1]=i.offset+k+1,(v[y]>65535||v[y+1]>65535)&&(l=!0),y+=2;const a=i.count>0?2*(i.count-1):0,o=new n.SGPrimitive({start:r,count:i.isIndexed?i.count:a,cgmId:i.cgmId,rep:C,group:x});void 0!==i.deco&&(4294967294===i.deco?o.decoration=u:4294967295!==i.deco&&(o.decoration=i.deco)),N.push(o),G.push(i.csiId),C._primitives.push(o)}}else{H=4+(L=this.hasGeomDecorations?1:0);for(var L,F=0;F<b.length;F+=H){var U=new n.SGPrimitive({start:b[F],count:b[F+1],cgmId:b[F+2],rep:C,group:x});if(L){var B=b[F+3+L];4294967294===B?U.decoration=u:4294967295!==B&&(U.decoration=B)}N.push(U),G.push(b[F+3]),C._primitives.push(U)}}M.push(G)}if(2===this.version&&(o.vertexIndexArray=l?new Uint32Array(v):new Uint16Array(v)),!o.boundingBox){var W=[0,0,0],z=[0,0,0],j=o.vertexPositionArray;if(j){var X=j.length;if(X>=3){W=[j[0],j[1],j[2]],z=[j[0],j[1],j[2]];for(var $=0;$<X;$+=3)j[$]<W[0]&&(W[0]=j[$]),j[$+1]<W[1]&&(W[1]=j[$+1]),j[$+2]<W[2]&&(W[2]=j[$+2]),j[$]>z[0]&&(z[0]=j[$]),j[$+1]>z[1]&&(z[1]=j[$+1]),j[$+2]>z[2]&&(z[2]=j[$+2])}}W=new r.Vector3(W[0],W[1],W[2]),z=new r.Vector3(z[0],z[1],z[2]),o.boundingBox=new r.Box3(W,z),o.boundingSphere=new r.Sphere(z.clone().add(W).multiplyScalar(.5),z.clone().sub(W).multiplyScalar(.5).length())}return d.end("GeometryParameterHelper::getGeometry"),{geometry:o,primitiveIDs:M,is2Din3D:s}}updateGeometry(e){if(e){var t=e.getPrimitives();if(Array.isArray(t)&&0!==t.length){var i,r={},n=0;t.forEach((function(e){(i=e.getIdentificationObject())&&void 0!==(n=i.getLocalId())&&(r[n]=e)}));for(var a=e._occurrences[0].renderable.geometry,o=0;o<a.length;o++)a[o].needsUpdate=!0;var s=a[0],l=s.vertexIndexArray,d=s.vertexPositionArray;if(l&&d){var c,u,h,g={};for(var p in this.parameter.bufferPartitionValues)if(u=this.parameter.bufferPartitionValues[p],(c=this.parameter.getBufferPartition(u))&&u!==this.parameter.bufferPartitionValues.vertexIndexArray){h=new Float32Array(this.parameter.getBuffer(),c.getOffset(),c.getByteLength()/c.getBytePerElement()),g[p]=h;for(o=0;o<a.length;o++){var f=a[o];(d=f.vertexPositionArray)&&!f[p]&&(f[p]=new Float32Array(d.length))}}var m,v=this.parameter.getDrawGroups();if(Array.isArray(v)&&1===v.length&&(m=v[0]),m){var y=m.getPrimitives();if(y){var S,_,D,w,T,P,C,I,M,E;y=new Uint32Array(this.parameter.getBuffer(),y.getOffset(),y.getByteLength()/y.getBytePerElement());for(var b=0;b<y.length;b+=3)if(n=y[b],_=y[b+1],D=y[b+2],(S=r[n])&&S.sgNode){l=(E=S.sgNode.getGroup().geometry).vertexIndexArray,d=E.vertexPositionArray;w=S.sgNode.getStart(),T=S.sgNode.getCount(),I=C=l[w];for(o=1;o<T;++o)(P=l[o+w])<C?C=P:P>I&&(I=P);if(M=3*(I-C+1),D&&D!==d.length||(D=M),M&&M===D)for(var p in g)for(o=0;o<D;++o)E[p][o+3*C]=g[p][o+_]}}}}}}}}const y={vis_vertex_components:{0:"position",1:"normal",2:"color",3:"uv",4:"uv2",5:"texcoord3",6:"texcoord4",7:"texcoord5",8:"texcoord6",9:"texcoord7",10:"texcoord8",11:"user0"},vis_data_type:{0:"uint8",1:"uint16",2:"uint32",3:"sint8",4:"sint16",5:"sint32",6:"float32",7:"float64",8:"uint8x2",9:"uint16x2",10:"uint32x2",11:"sint8x2",12:"sint16x2",13:"sint32x2",14:"float32x2",15:"float64x2",16:"uint8x3",17:"uint16x3",18:"uint32x3",19:"sint8x3",20:"sint16x3",21:"sint32x3",22:"float32x3",23:"float64x3",24:"uint8x4",25:"uint16x4",26:"uint32x4",27:"sint8x4",28:"sint16x4",29:"sint32x4",30:"float32x4",31:"float64x4",32:"<unsupported FLOAT_9>",33:"<unsupported DOUBLE_9>",34:"<unsupported MATRIX_3x3>",35:"<unsupported FLOAT_16>",36:"<unsupported DOUBLE_16>",37:"<unsupported MATRIX_4x4>",38:"<unsupported RAWBUFFER_PTR>"},vis_connectivity_type:{1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:2,256:3,512:5,1024:6},type_mapping_simple:{1:1,2:2,4:2,8:2,16:16,32:16,64:16,128:2,256:2,512:16,1024:16},rawbuffers_by_id(e){if(!e)return{};const t={};for(let i=0;i<e.length;i++){const r=e[i];t[r.id]={id:r.id,data:r.data,type:null}}return t},check_same_vertex_number(e){const t=e.map((e=>e.getNbVertices()));1!==new Set(t).size&&console.error(`SGV6: components have different number of vertices: [${t.join(", ")}]`)},compute_vertex_layout(e){const t={};for(let i=0;i<e.length;i++){const r=e[i],n=y.vis_data_type[r.getType()];if(void 0===n)throw new Error("Malformed vertex components description: unknown component type");let a=y.vis_vertex_components[r.getComponentType()];if(void 0===a)throw new Error("Malformed vertex components description: unknown component name");t[a]={name:a,type:n,offset:r.getOffset(),stride:r.getStride()||o[n].size,bufferId:r.getRawBufferId(),num_vertices:r.getNbVertices()}}return t},get_num_vertices(e){for(let t in e)return e[t].num_vertices;return 0},compute_vertex_buffer_views(e,t){let i=[];for(let t in e){const r=e[t],n=r.offset,a=r.offset+r.stride*(r.num_vertices-1)+o[r.type].size;i.push([n,a,r.bufferId])}i.sort(((e,t)=>e[2]===t[2]?e[0]-t[0]:e[2]-t[2]));let r=0;for(let e=1;e<i.length;e++)i[e][0]<i[r][1]&&i[e][2]===i[r][2]?i[r][1]=Math.max(i[r][1],i[e][1]):++r!==e&&(i[r]=i[e]);i.length=r+1;const n=[];for(let e=0;e<i.length;e++){let[r,a,o]=i[e];const s=t[o].data;r=Math.min(r,s.byteLength),a=Math.min(a,s.byteLength),n[e]=new Uint8Array(s,r,a-r)}for(let t in e){const r=e[t],n=r.offset,a=r.offset+r.stride*(r.num_vertices-1)+o[r.type].size;for(let e=0;e<i.length;e++)if(i[e][2]===r.bufferId&&!(i[e][0]>n||a>i[e][1])){r.bufferId=e;break}r.offset=n-i[r.bufferId][0]}return{layout:e,vertices:n}},compute_vertex_buffers(e,t){y.check_same_vertex_number(e.getComponents());const i=y.compute_vertex_layout(e.getComponents());return y.compute_vertex_buffer_views(i,t)},split_indice_descriptions(e,t){let i=[];for(let r=0;r<e.length;r++){const n=e[r],a=t[n.getId()],s=y.vis_data_type[n.getType()];let l=null;for(let e=0;e<i.length;e++)if(i[e].rawbuffer===a&&i[e].itype===s){l=i[e];break}l||(l={rawbuffer:a,itype:s,descriptions:[],stride:o[s].size,offset:0},i.push(l)),l.descriptions.push(n)}return i},compute_indices_view(e,t){var i=e.descriptions?e.descriptions.length:0;if(!e.rawbuffer){if(1===i){let i=e.descriptions[0],r=i.getConnectivityType();if(1===r||2===r||16===r)return null;let n=0,a=0;switch(r){case 4:a=2*(t-1);break;case 8:a=2*t;break;case 32:case 64:a=3*(t-2)}let o=a>65536?new Uint32Array(a):new Uint16Array(a);switch(r){case 4:for(let e=1;e<t;e++)o[n++]=e-1,o[n++]=e;break;case 8:for(let e=1;e<t;e++)o[n++]=e-1,o[n++]=e;o[n++]=t-1,o[n++]=0;break;case 32:for(let e=0;e<t-2;e++)e%2?(o[n++]=e,o[n++]=e+2,o[n++]=e+1):(o[n++]=e,o[n++]=e+1,o[n++]=e+2);break;case 64:for(let e=0;e<t-2;e++)o[n++]=0,o[n++]=e+1,o[n++]=e+2}return e.rawbuffer=o,i._rawbuffer=o,i._connectivityType=y.type_mapping_simple[r],i._nbIndices=a,o}return null}const r=2===e.stride?Uint16Array:4===e.stride?Uint32Array:null;if(!r)return console.warn(`SGV6: unsupported ${e.itype} indices`),null;let n=!0;for(let t=0;t<e.descriptions.length;t++){const i=e.descriptions[t].getConnectivityType();if(1!==i&&2!==i&&16!==i){n=!1;break}}if(!n){let t=[];let i=new r(e.rawbuffer.data),n=0;for(let r=0;r<e.descriptions.length;r++){const a=e.descriptions[r];let o=a.getOffset()/e.stride,s=a.getNbIndices(),l=0;const d=a.getConnectivityType();switch(a._offset=n*e.stride,d){case 1:case 2:case 16:for(let e=0;e<s;e++)t[n++]=i[o++];break;case 4:for(let e=1;e<s;e++)t[n++]=i[o+e-1],t[n++]=i[o+e],l+=2;break;case 8:for(let e=1;e<s;e++)t[n++]=i[o+e-1],t[n++]=i[o+e],l+=2;t[n++]=i[o+s-1],t[n++]=i[o],l+=2;break;case 32:for(let e=0;e<s-2;e++)e%2?(t[n++]=i[o+e],t[n++]=i[o+e+2],t[n++]=i[o+e+1]):(t[n++]=i[o+e],t[n++]=i[o+e+1],t[n++]=i[o+e+2]),l+=3;break;case 64:for(let e=0;e<s-2;e++)t[n++]=i[o],t[n++]=i[o+e+1],t[n++]=i[o+e+2],l+=3;break;case 128:if(s<2||i[o]===f)break;for(let e=1;e<s;e++){let r=i[o+e];r!==f?(t[n++]=i[o+e-1],t[n++]=r,l+=2):e++}break;case 256:if(s<2||i[o]===f)break;for(let e=1;e<s;e++){let r=i[o+e];r!==f?(t[n++]=i[o+e-1],t[n++]=r,l+=2):e++}t[n++]=i[o+s-1],t[n++]=i[o],l+=2;break;case 512:if(s<3||i[o]===f||i[o+1]===f||i[o+2]===f)break;let e=0;for(let r=0;r<s-2;r++){let a=i[o+r+2];a!==f?(e%2?(t[n++]=i[o+r],t[n++]=a,t[n++]=i[o+r+1]):(t[n++]=i[o+r],t[n++]=i[o+r+1],t[n++]=a),e++,l+=3):(r+=2,e=0)}break;case 1024:if(s<3||i[o]===f||i[o+1]===f||i[o+2]===f)break;let r=i[o];for(let e=0;e<s-2;e++){let a=i[o+e+2];a!==f?(t[n++]=r,t[n++]=i[o+e+1],t[n++]=a,l+=3):(r=i[o+e+3],e+=2)}}a._connectivityType=y.type_mapping_simple[d],a._nbIndices=l}let a=new r(n);for(let e=0;e<n;e++)a[e]=t[e];return a}let a=1/0,o=-1/0;for(let t=0;t<e.descriptions.length;t++){const i=e.descriptions[t],r=i.getOffset(),n=i.getNbIndices()*e.stride;a=Math.min(a,r),o=Math.max(o,r+n)}e.offset=a;return new r(e.rawbuffer.data,a,(o-a)/e.stride)},create_drawing_groups(e,t){const i=[];for(let a=0;a<e.descriptions.length;a++){const o=!!e.rawbuffer,s=e.descriptions[a];let l=s.getNbIndices();o||(l=l||t);let d=s.getOffset();o&&(d=(s.getOffset()-e.offset)/e.stride);const c=new n.SGPrimitive({start:d,count:l}),u=y.vis_connectivity_type[s.getConnectivityType()],h=r.GeomTypeEnum.UNKNOWN,g=i[a]=new n.DrawingGroup(null,null,u,d,l,[c],void 0,h);g.nonIndexed=!o,c.group=g}return i},create_geometry({layout:e,vertices:t,indices:i}){const n=new r.BufferGeometryDS;let a=y.get_num_vertices(e);return n.vertexIndexArray=y.compute_indices_view(i,a),n.buffers=t,n.layout.set(e),n._updateAccessors(),n.drawingGroups=y.create_drawing_groups(i,a),n.drawingGroups.forEach((e=>e.geometry=n)),n},create_primitive_geometries(e,t,i,r){let{layout:n,vertices:a}=y.compute_vertex_buffers(e,r),o=y.split_indice_descriptions(t,r);if(i)for(var s in i)a.push(i[s]),n[s]={name:s,type:"float32x4",offset:n.position.offset,stride:16,bufferId:a.length-1,num_vertices:n.position.num_vertices};let l=[];for(let e=0;e<o.length;e++){const t=y.create_geometry({layout:n,vertices:a,indices:o[e]});l.push(t)}return l},compute_gas(e,t){if(!e)return g;const i=new l;new s(e,null).applyGP(t,i);const r=i._gas;return r._inheritanceInternal=0,r},resolve_gas(e,t){const i=Object.assign({},e),r=y.compute_gas(e.GAS,t);return void 0!==i.POINT_TYPE&&(r._symbolType=i.POINT_TYPE),void 0!==i.POINT_SIZE&&(r._lineWidth=i.POINT_SIZE),r},resolve_instancing(e){const t=e.NUM_INSTANCES,i=e.INSTANCES_RAWBUFFERPTR;return void 0!==t&&void 0!==i?{count:t,buffer:i}:null},createSkinningPosture(e,t){let i=new r.SkinningTransformations;return i.setSkinningMatrices(e,t),i},addSGV6Primitive(e,t,i,a,o){const s=o.mesh3js,l=s.geometry,d=y.rawbuffers_by_id(a);for(let e in d)l._buffersMap[e]=d[e];let c=null;for(let e=0;e<l.length;e++){let t=l[e];for(let e=0;e<t.drawingGroups.length;e++){let i=t.drawingGroups[e];if(i._primitives.length>0){c=i._primitives[0].rep;break}}if(c)break}c||(c=new n.SGRep);const u=i.getAttribute().asProperties(),h=y.resolve_gas(u,e),g=y.create_primitive_geometries(i.getVerticesDescription(),i.getIndicesDescription(),null,d),p=new Map;const f=i.getId(),m=new n.SelectionGroup;let v=0;for(let e of g){for(let t of e.drawingGroups)t.gas=h,t._primitives[0].rep=c,c._primitives.push(t._primitives[0]),v++,m.addPrimitive(t._primitives[0]),p.set(f,t._primitives[0]);for(let t=0;t<o._occurrences.length;t++){let i=o._occurrences[t].renderable;i.addGeometry(e,!0),i.layer&&i._initLayersForGeometry(1,e)}e.layout&&e.layout.get("color")&&o.setVertexColors(r.VertexColorType.RGBA)}v>1&&s.addSelectionGroup(m),p.forEach(((e,i)=>t.addCreatedObjectWithID(e,i)))}},S={updateBuffers(e,t){const i=e._buffersMap;let r=null;for(var n=0;n<t.length;n++){let e=i[t[n].id];if(!e)continue;let o=e.data;if("skinTransfo"===e.type&&(r=e),o){let e=new Uint8Array(o),i=new Uint8Array(t[n].data);for(var a=0;a<i.length;a++)e[a]=i[a]}}return r},addSkeleton(e,t,i,r){const n=y.rawbuffers_by_id(r);if(e._buffersMap)for(var a in n)e._buffersMap[a]=n[a];let o=t?new Float32Array(n[t].data):null,s=i?new Float32Array(n[i].data):null;for(var l=0;l<e.length;l++){const r=e[l].layout;let n=e[l].buffers,a=r.clone(),d=r.getNames();if(t)if(d.includes("skinIndex")){n[r.get("skinIndex").bufferId]=o}else n.push(o),a.setAttribute({name:"skinIndex",type:"float32x4",offset:r.get("position").offset,stride:16,bufferId:n.length-1,num_vertices:r.get("position").num_vertices});if(i)if(d.includes("skinWeight")){n[r.get("skinWeight").bufferId]=s}else n.push(s),a.setAttribute({name:"skinWeight",type:"float32x4",offset:r.get("position").offset,stride:16,bufferId:n.length-1,num_vertices:r.get("position").num_vertices});e[l].layout=a,e[l].needsUpdate=!0}},removeSkeleton(e){for(var t=0;t<e.length;t++){const n=e[t].layout;let a=e[t].buffers,o=n.clone(),s=n.getNames();if(s.includes("skinIndex")){a[n.get("skinIndex").bufferId]=null,o.remove("skinIndex")}if(s.includes("skinWeight")){a[n.get("skinWeight").bufferId]=null,o.remove("skinWeight")}for(var i=[],r=0;r<a.length;r++)a[r]&&i.push(a[r]);e[t].buffers=i,e[t].layout=o,e[t].needsUpdate=!0}},createSkinningPosture(e,t,i,r){const n=y.rawbuffers_by_id(r);if(e._buffersMap)for(var a in n)e._buffersMap[a]=n[a];return n[t].type="skinTransfo",y.createSkinningPosture(new Float32Array(n[t].data),i)},createGeometryBuffersV6(e,t){if(!t)return null;d.begin("GeometryParameterHelper::createGeometryBuffersV6");const i=y.rawbuffers_by_id(t.rawBuffers),r=t.visPrimitives,a=r.map((e=>e.getAttribute().asProperties()));let o=null,s=null,l=-1;const c=t.skeletonSkinning;if(c){o={};const e=c.getBoneIdsBufferId(),t=c.getBoneWeightsBufferId();if(l=c.getBoneMatricesBufferId(),e){let t=new Int32Array(i[e].data);o.skinIndex=new Float32Array(t.length);for(let e=0;e<t.length;e++)o.skinIndex[e]=t[e]}t&&(o.skinWeight=new Uint8Array(i[t].data)),l&&(i[l].type="skinTransfo",s=y.createSkinningPosture(new Float32Array(i[l].data),c.getNbBones()))}const u=r.map(((t,i)=>y.resolve_gas(a[i],e))),h=r.map((e=>y.create_primitive_geometries(e.getVerticesDescription(),e.getIndicesDescription(),o,i))),g=new n.SGRep,p=[],f=new Map,m=[];for(let e=0;e<r.length;e++){const t=h[e],o=u[e],s=r[e].getId(),l=y.resolve_instancing(a),d=new n.SelectionGroup;let c=0;for(let e of t){for(let t of e.drawingGroups){if(l){let e="f",r=i[l.buffer].data;if(r&&(r=r.getData()),r){const t=r.byteLength/l.count;t%64==0?e="m4":t%16==0?e="v4":t%12==0?e="v3":t%8==0&&(e="v2")}t.setInstancingParameters(l.count,{isFlattened:!1,type:e,data:r,attribName:"sgv6"},"mesh")}t.gas=o,t._primitives[0].rep=g,g._primitives.push(t._primitives[0]),c++,d.addPrimitive(t._primitives[0]),f.set(s,t._primitives[0])}p.push(e)}c>1&&m.push(d)}return p._buffersMap=i,d.end("GeometryParameterHelper::createGeometryBuffersV6"),{geometry:p,ids:f,selection_groups:m,skinningPosture:s,boneMatricesBufferId:l}},updateSGV6Primitive(e,t,i,r,n){if(i.getVerticesDescription())y.addSGV6Primitive(e,t,i,r,n);else{const t=i.getObject(),r=i.getAttribute().asProperties(),n=y.resolve_gas(r,e);t.group.gas=n}}};return Object.assign(v,S),v})),define("DS/WebVisuParameters/WebVisuUpdateTransaction",["DS/WebVisuParameters/AbstractWebVisuUpdateTransaction","DS/CSIViewModelWebInterfaces/CSIVMClientVisRepViewModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisClippingFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisAnnotation","DS/CSIViewModelWebInterfaces/CSIVMClientVisAnnotationValue","DS/CSIViewModelWebInterfaces/CSIVMClientVisCircularScissorFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisLayerFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisGASInheritFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisPolygonOffsetFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisPolygonalScissorFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisCurveClippingFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisZModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisFurtiveFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisDynamicModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisHighlightFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVis2DModeFilter","DS/Visualization/MaterialManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SceneGraphNodes/FixedSizeNodeA2X","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/ProjectionNode3D","DS/Visualization/CGRNode","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/VisuLoaders/ThreeDXLoader","DS/WebVisuParameters/BoundingSphereParameterHelper","DS/WebVisuParameters/CustomDataParameterHelper","DS/WebVisuParameters/GeometryParameterHelper","DS/WebVisuParameters/InfiniteGeometryParameterHelper","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/WebVisuParameters/SceneEnvParameterHelper","DS/WebVisuParameters/SceneEnvParameterItem","DS/Mesh/MeshUtils","DS/Visualization/GraphicAttributeSet","DS/Visualization/ClippingContext","DS/Visualization/RenderStyle","DS/EKEventsWeb/EKEvents","DS/Visualization/Filters/GeomTypeFilter","DS/Visualization/Filters/GASInheritFilter","DS/Visualization/Filters/PolygonOffsetFilter","DS/Visualization/Filters/ZModeFilter","DS/Visualization/Filters/DynamicModeFilter","DS/Visualization/Filters/NoHighlightFilter","DS/Visualization/Filters/FurtiveFilter","DS/Visualization/Filters/LODNodeFilter","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CoreEvents/Events","DS/SceneGraphOverrides/GenericOverride","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,n,a,o,s,l,d,c,u,h,g,p,f,m,v,y,S,_,D,w,T,P,C,I,M,E,b,A,V,O,N,G,x,R,H,k,L,F,U,B,W,z,j,X,$,K,J,Y){"use strict";var Z=null,q=null,Q={volume:v.MaterialUtils.createShinyFaceMaterial({side:v.FrontSide,color:new v.Color(16777215)}),surface:v.MaterialUtils.createShinyFaceMaterial({side:v.DoubleSide,color:new v.Color(16777215)}),line:new v.LineBasicMaterial({color:new v.Color(0)}),point:new v.ParticleBasicMaterial({size:1,color:new v.Color(0),blending:v.NormalBlending,depthTest:!1,sizeAttenuation:!1,transparent:!1})};Q.volume.line=Q.line,Q.volume.point=Q.point,Q.surface.line=Q.line,Q.surface.point=Q.point;var ee=new I,te=new O(null,ee),ie=1,re=2,ne=4,ae=8,oe=32,se=64,le=4096,de=8192,ce=32768,ue=131072,he=262144,ge=524288,pe=536870912;const fe=536870912,me=536870913,ve=536870914,ye=[0,0],Se=[1,1.1],_e=[3,2.2],De=0,we=1,Te=2,Pe=e.MixedGPUtils;var Ce={},Ie=function(e,t){if(t)for(var i=0;i<e.meshList.length;i++){var r=e.meshList[i]._occurrence.node;if(r&&2===r._bodyDim)return}for(i=0;i<e.drawingGroups.length;i++){var n=e.drawingGroups[i];n.gas,n.material;4===n.glType&&(n.getPrimitivesCount()&&(n.getPrimitiveRep(0).solid=t))}},Me=function(e){return e?e.children[0]instanceof S?e.children[0]:e.children[1]:null},Ee=function(e){return e?e.children[0]instanceof S?e.children[1]:e.children[0]:null},be=function(e){var t=null;if(e)switch(e.getType()){case 1:case 2:default:t=new L(-1);break;case 3:t=new L(v.GeomTypeEnum.AXIS_SYSTEM);break;case 4:t=new L(v.GeomTypeEnum.WIRE_EDGE);break;case 5:t=new L(v.GeomTypeEnum.FREE_POINT)}return t};function Ae(e,t){for(let i of e){const e=i.layout.get("uv");if(!e)continue;const r=i.getVertexCount(),n=new DataView(i.buffers[e.bufferId].buffer,e.offset),a=new v.Vector4(0,0,0,1);let o=0;switch(e.type){case"float32":o=1;break;case"float32x2":o=2;break;case"float32x3":o=3;break;case"float32x4":o=4}for(let i=0;i<r;i++){const r=i*e.stride;a.set(0,0,0,1);for(let e=0;e<o;e++)a.setComponent(e,n.getFloat32(r+4*e,!0));a.applyMatrix4(t);for(let e=0;e<o;e++)n.setFloat32(r+4*e,a.getComponent(e),!0)}}}var Ve=function(t,i,r){e.call(this,t,i,r),this._dialogBag=null,this._onTopBag=null,this._furtiveBag=null,this._transientBag=null,this.annotationFilters=[],this.nodesToRemove=[],this.renderingModeToApply=[],this.nodesToOptimize={},this.inverseAction={adds:[],removes:[],overrides:{}},this.commitAction={adds:[],removes:[]}};function Oe(e,t,i){function r(e){e&&e.hasInfiniteGeometry()?i(e):t(e)}const n=e.getGeometricalData(),a=e.getInfiniteGeometricalData();a?(r(n),r(a)):r(n)}(Ve.prototype=Object.create(e.prototype)).getParentNode=function(e){var t=this.getOperatedObject(e);let i=e.getTreeKey();if(!t&&i){switch(i.getView3DType()){case i.View3DType.View3D_Dialog:this._dialogBag||(this._dialogBag=new y,this.view.addChild(this._dialogBag),this._dialogBag.setAsNativeDialog(!0)),t=this._dialogBag;break;case i.View3DType.View3D_OnTop:this._onTopBag||(this._onTopBag=new y,this.view.addChild(this._onTopBag),this._onTopBag.setAsNativeOnTop(!0)),t=this._onTopBag;break;case i.View3DType.View3D_Furtive:this._furtiveBag||(this._furtiveBag=new y,this.view.addChild(this._furtiveBag),this._furtiveBag.setAsNativeFurtive(!0)),t=this._furtiveBag;break;case i.View3DType.View3D_Transient:this._transientBag||(this._transientBag=new y),t=this._transientBag;break;case i.View3DType.View3D_Highlight:case i.View3DType.View3D_MultiColorHighlight:case i.View3DType.View3D_PreHighlight:case i.View3DType.View3D_Unknown:case i.View3DType.View3D_Main:default:t=this.view}}return t},Ve.prototype.doOperation=function(e){v._NREGASOnNodeInit=!0;const t=e.getType();var i=k.Trace.traceStart("techno_webvisu","message_to_scenegraph");Y.begin("WebVisuParameters::WebVisuUpdateTransaction "+t),this.setDefaultMaterials(this.viewManager.getDefaultMaterials()),q!==this&&(q&&q.executeInverse(),q=this);var r=this;switch(t){case e.OperationType.RemoveTextureFromCache:var n=e.getTextureUids();if(n.length>0)for(var a=new V(void 0,this.clientManager),o=0;o<n.length;o++)a.removeTextureFromCache(n[o]);break;case e.OperationType.RemoveAll:this.view&&this.view.removeChildren();break;case e.OperationType.AddNode:case e.OperationType.AddBody:case e.OperationType.CreateRoot:var s=null,l=null,d=e.getAttributes(),c=null;let i=null;var u=null,h=(W=this.getParentNode(e))instanceof T,g=W instanceof y&&!h,p=e.getGeometricalData(),f=e.getInfiniteGeometricalData();const k=e.getVisData();var m=null,_=null;let Y=null,q=!1,Le=null,Fe=null,Ue=null,Be=null,We=null,ze=null;if(this.viewManager.viewer._sgOrder&&(ze=e.getIndex()),d){let e=d.getISOData();_=d.get2DTo3DData(),e&&(m=e.getDrawLayer()),c=d.getPositionMatrix(),c=this.unstreamMatrix(c),u=d.getFilters&&d.getFilters(),Y=d.getFixedSizeData(),Le=d.getBillboardData(),Fe=d.get3DProjectionData(),l={matrix:c||void 0},Ue=be(d.getSemanticData()),We=d.getLodData(),We=We&&We.getLodData()&&We.getLodData().length?We.getLodData():null,Be=d.getVis3DGroupeNodeRepData(),Be&&(Y=Be.getFixedSizeData(),q=!0)}if(t===e.OperationType.AddNode||t===e.OperationType.CreateRoot)if(g)s=Y?this.nodeFromFixedSizeData(Y,null,q):_?this.createNodeFromData2Dto3D(_):Le?this.nodeFromBillboardData(Le):Fe?this.nodeFromProjectionData(Fe):new y,Ue&&s.setVisuFilters({geomTypeFilter:Ue}),We&&s.setVisuFilters({LOD:new X(We)}),Be&&void 0!==Be.getRenderingMode()&&this.renderingModeToApply.push([s,Be.getRenderingMode()]);else{s=new G.SGBag(l);var D=h?W.internalSceneGraph:W;s.parents.push(D),D.children.push(s)}else if(g)f||p&&p.hasInfiniteGeometry()?s=new y:(!0,(s=new S).setShadow(!0,!0),s.mesh3js.fromLoadedModel=!0,s._occurrences[0].renderable.fromLoadedModel=!0,s.mesh3js.geometry=s._occurrences[0].renderable.geometry);else{s=p&&p.hasInfiniteGeometry()?new G.SGBag(l):new G.SGRep(l);D=h?W.internalSceneGraph:W;s.parents.push(D),D.children.push(s)}if(!s)break;if(e.setCreatedObject(s),Be){i=new v.Matrix4;let e=Be.getTextureMatrix();e&&e.length&&(i.setFromArray(e),s._textureMatrix=i)}var w=null;if(g&&(d&&c&&s.setMatrix(c),w=p?M.getBoundingSphere(p.getBoundingSphere()):null,this.applyBEToBody(s,w),null!=m&&s.setAsNativeIsoBag(m),_&&this.apply2DTo3DData(s,_),null!=ze?W.insertChildAtIndex(s,ze):W.addChild(s),u&&this.setFilters(s,u),p)){if(p.getDimension){s._bodyDim=p.getDimension();for(var P=0;P<s._occurrences.length;P++){(L=s._occurrences[P].renderable)&&(L._bodyDim=s._bodyDim)}}p.getTerminalRepWithPrimitivesWithoutGas()&&s._setNoGASOnPrimitives(!!p.getTerminalRepWithPrimitivesWithoutGas()),p.getUseParentForPixelCulling()&&s._setPixelCullingFromParent(!!p.getUseParentForPixelCulling())}if(k){const t=s.mesh3js.geometry.boundingBox,i=s.mesh3js.geometry.boundingSphere,{geometry:r,ids:n,selection_groups:a,skinningPosture:l,boneMatricesBufferId:d}=b.createGeometryBuffersV6(this,k);for(o=0;o<r.length;o++)r[o].layout&&r[o].layout.get("color")&&s.setVertexColors(v.VertexColorType.RGBA);if(s.mesh3js.geometry=r,s.mesh3js.geometry.boundingBox=t,s.mesh3js.geometry.boundingSphere=i,a.forEach((e=>s.mesh3js.addSelectionGroup(e))),n.forEach(((t,i)=>e.addCreatedObjectWithID(t,i))),l&&(s.mesh3js.setSkinningTransformations(l),d)){let e=Ce[d];e||(e={nodes:[]},Ce[d]=e),e.nodes.push(s)}{let e=s,t=e._textureMatrix;for(;!t&&e;)t=e._textureMatrix,e=e.parents[0];Ae(s.mesh3js.geometry,t)}}var C=p?p.getInitializers():null;if(C&&C.length)for(o=0;o<C.length;o++){var I=C[o];if(I instanceof S){if(!I||!I._occurrences[0].renderable){console.warn("Error during initializers of AddBody operation");continue}for(var O=I._occurrences[0].renderable,x=0;x<O.geometry.length;x++){var R=O.geometry[x],H=O.layer?O.layer.getIntervals(R,null,!0):null;for(P=0;P<s._occurrences.length;P++)s._occurrences[P].renderable.addGeometry(R,!w,H);s._bodyDim&&Ie(R,3===s._bodyDim)}if(ge=O.selectionGroups)for(P=0;P<s._occurrences.length;P++)for(var L=s._occurrences[P].renderable,F=0;F<ge.length;F++)L.addSelectionGroup(ge[F].clone())}else if(I instanceof y){var U=I.getChildren();for(x=0;x<U.length;x++)s.addChild(U[x])}}if(w)for(P=0;P<s._occurrences.length;P++){var B=s._occurrences[P].renderable;this.applyBEToRenderable(B,s)}this.inverseAction.removes.push({parentNode:W,node:s}),s&&d&&d.getPLMData()&&this.viewManager.viewer._setNodePLMViewMode(s,d.getPLMData(),e.getTreeKey().getViewpointUID());break;case e.OperationType.AddCustomNode:s=null;if((z=new E(e.getCustomData(),(function(){r.viewManager._publishVisuAnswer(!1)})))&&(s=z.getNode()),!s)break;if(e.setCreatedObject(s),d=e.getAttributes()){c=d.getPositionMatrix();(c=this.unstreamMatrix(c))&&s.setMatrix(c)}var W=this.getParentNode(e);let je=null;this.viewManager.viewer._sgOrder&&(je=e.getIndex()),null!=je?W.insertChildAtIndex(s,je):W.addChild(s),this.inverseAction.removes.push({parentNode:W,node:s});break;case e.OperationType.ModifyCustomNode:s=this.getOperatedObject(e);var z=new E(e.getCustomData(),(function(){r.viewManager._publishVisuAnswer(!1)}));s&&z.modifyNode(s);break;case e.OperationType.AddExistingNode:case e.OperationType.RemoveExistingNode:if(!(s=this.getOperandObject(e)))break;(h=(W=this.getParentNode(e))instanceof T)&&(W=W.internalSceneGraph);var j=e.getBatchParentObject(),$=e.getBatchParentSharedObject();if(W instanceof G.SGBag){if(!j)break;this.addExistingNode($,j,W,s)}else{if(t===e.OperationType.AddExistingNode){let t=null;this.viewManager.viewer._sgOrder&&(t=e.getIndex()),null!=t?W.insertChildAtIndex(s,t):W.addChild(s)}else this.nodesToRemove.push({parentNode:W,node:s});t===e.OperationType.AddExistingNode?this.inverseAction.removes.push({parentNode:W,node:s}):this.inverseAction.adds.push({parentNode:W,node:s})}break;case e.OperationType.AddExistingCells:var K=this.getOperatedObject(e),J=(j=e.getBatchParentObject(),e.getBatchParentCellObject()),Z=e.ExistingCells._noContext;if(void 0===e.getOperandSubElements)break;var Q=e.getOperandSubElements(),ie=this.addExistingCells(j,J,Z,K,Q);(K instanceof S||K instanceof y)&&ie&&K.show(Q);break;case e.OperationType.RemoveExistingCells:K=this.getOperatedObject(e);if(void 0===e.getOperandSubElements)break;Q=e.getOperandSubElements();this.removeExistingCells(K,Q);break;case e.OperationType.RemoveExistingCell:K=this.getOperatedObject(e);if(void 0===(xe=this.getOperandObject(e)))break;this.removeExistingCell(K,xe);break;case e.OperationType.AddCells:this.AddCells(e);break;case e.OperationType.ApplyGP:var re=e.getGraphicProperties();if(!re)break;s=this.getOperatedObject(e),j=e.getBatchParentObject();if(!s&&!j)break;var ne=s&&s instanceof G.SGBag,ae=s&&s instanceof G.SGRep,oe=function(e){var t=[];if(e instanceof G.SGRep)return t.push(e),t;for(var i=0;i<e.children.length;i++)for(var r=oe(e.children[i]),n=0;n<r.length;n++)t.push(r[n]);return t};if(!s||(ae||ne)){var se=Ee(j),le=Me(j),de=e.getOperatedSubElements(),ce=de&&de.length?de.slice():[];if(ne){var ue=oe(s);for(o=0;o<ue.length;o++)ce.push(ue[o])}else ae&&ce.push(s);var he=function(e,t){for(var i=e.children.length,r=[],n=[],a=0;a<t.length;a++){var o=t[a];if(o instanceof G.SGPrimitiveHelper)n.push(o);else if(o instanceof G.SGRep){var s,l=o.getIdentificationObject().getLocalId();for(s=0;s<i;s++){var d=e.children[s];if(l===d.persistentId){r.push(d);break}}if(s===i)for(var c=0;c<o.getPrimitivesCount();c++){var u=new G.SGPrimitiveHelper;u.set(o,c),n.push(u)}}}return{finiteSubElements:n,infiniteSubElements:r}}(se,ce);a=new V(re,this.clientManager);he.finiteSubElements.length>0&&a.applyGP(this,le,he.finiteSubElements,e.getOperatedGeomTypes&&e.getOperatedGeomTypes()),he.infiniteSubElements.length>0&&a.applyGP(this,se,he.infiniteSubElements,e.getOperatedGeomTypes&&e.getOperatedGeomTypes())}else{(a=new V(re,this.clientManager)).applyGP(this,s,e.getOperatedSubElements(),e.getOperatedGeomTypes&&e.getOperatedGeomTypes())}break;case e.OperationType.ApplyAttributes:if(!((s=this.getOperatedObject(e))&&s instanceof y))break;if(d=e.getAttributes()){let e=d.getISOData();e&&(m=e.getDrawLayer(),s.setAsNativeIsoBag(m)),(c=d.getPositionMatrix())&&(c=this.unstreamMatrix(c))&&s.setMatrix(c),(u=d.getFilters&&d.getFilters())&&this.setFilters(s,u),(_=d.get2DTo3DData())&&this.apply2DTo3DData(s,_);const t=d.getFixedSizeData();t&&this.nodeFromFixedSizeData(t,s);const i=d.getBillboardData();i&&this.nodeFromBillboardData(i,s);const r=d.get3DProjectionData();r&&this.nodeFromProjectionData(r,s);let n=be(d.getSemanticData());n&&s.setVisuFilters({geomTypeFilter:n});let a=d.getLodData();a=a&&a.getLodData()&&a.getLodData().length?a.getLodData():null,a&&s.setVisuFilters({LOD:new X(a)});let o=d.getVis3DGroupeNodeRepData();if(o){let e=new v.Matrix4,t=o.getTextureMatrix();t&&16===t.length&&e.setFromArray(t),s.traverse((t=>!!(t&&t.mesh3js&&t.mesh3js.geometry)&&(Ae(t.mesh3js.geometry,e),!0))),void 0!==o.getRenderingMode()&&this.renderingModeToApply.push([s,o.getRenderingMode()])}}d.getPLMData()&&this.viewManager.viewer._setNodePLMViewMode(s,d.getPLMData(),e.getTreeKey().getViewpointUID());break;case e.OperationType.AddGroups:if(!(s=this.getOperatedObject(e)))break;if(s instanceof T||s instanceof G.SGRep)(j=e.getBatchParentObject())&&2===j.children.length&&(s=Me(j));if(!(s instanceof S))break;p=e.getGeometricalData();var ge=e.getSelectionGroups();for(o=0;o<ge.length;o++){var pe=ge[o].getGroupedElements(),fe=new G.SelectionGroup;for(x=0;x<pe.length;x++)fe.addPrimitive(pe[x]);for(x=0;x<s._occurrences.length;x++){(B=s._occurrences[x].renderable).addSelectionGroup(fe)}}break;case e.OperationType.ModifyBody:this.ModifyBody(e);break;case e.OperationType.ModifyBatch:if(!((s=this.getOperatedObject(e))&&s instanceof T))break;if(!(p=e.getGeometricalData()))break;var me={version:De};if(Pe=p?p.getGeometries():void 0){var ve=Me(s);for(o=0;o<Pe.length;o++){var ye=new b(Pe[o],me);R=ye.getGeometry(this,!0,ve&&ve._getNoGASOnPrimitives());ye.updateGeometry(ve)}}break;case e.OperationType.AddBatchNode:case e.OperationType.CreateRootBatch:c=null,l=null;if(d=e.getAttributes()){c=d.getPositionMatrix();l={matrix:(c=this.unstreamMatrix(c))||void 0}}var Se=new G.SGBag(l);(s=new T(Se)).productType="3DSyncBatch";p=e.getGeometricalData(),f=e.getInfiniteGeometricalData();var _e=!!p&&p.hasGeomDecorations(),De=p?p.getVersion():null,we=new S;we.setShadow(!0,!0),we.mesh3js.fromLoadedModel=!0,we._occurrences[0].renderable.fromLoadedModel=!0,we.mesh3js.geometry=we._occurrences[0].renderable.geometry;w=p?M.getBoundingSphere(p.getBoundingSphere()):null;if(this.applyBEToBody(we,w),p&&p.getDimension)we._bodyDim=p.getDimension(),(L=we._occurrences[0].renderable)&&(L._bodyDim=we._bodyDim);var Te=new y;d&&c&&s.setMatrix(c),e.setCreatedObject(s);W=this.getParentNode(e);var Pe=p?p.getGeometries():void 0,Ve=f?f.getGeometries():void 0;me={version:De,hasGeomDecorations:_e};if(Pe)for(o=0;o<Pe.length;o++){var Oe=(He=new b(Pe[o],me).getGeometry(this,!0,we._getNoGASOnPrimitives())).geometry,Ne=He.primitiveIDs;(B=we._occurrences[0].renderable).addGeometry(Oe,!1),B.geometry.boundingSphere.copy(Oe.boundingSphere),B.geometry.boundingBox.copy(Oe.boundingBox);var Ge=Oe.drawingGroups;for(x=0;x<Ge.length;x++)for(P=0;P<Ge[x].getPrimitivesCount();P++){var xe;(xe=new G.SGPrimitiveHelper).set(Ge[x],P),e.addCreatedObjectWithID(xe,Ne[x][P])}}if(w){B=we._occurrences[0].renderable;this.applyBEToRenderable(B,we)}if(Ve){var Re=function(e){var t=[];if(e instanceof S)t=e.getPrimitives();else if(e instanceof y)for(var i=0;i<e.children.length;i++)for(var r=Re(e.children[i]),n=0;n<r.length;n++)t.push(r[n]);return t};for(o=0;o<Ve.length;o++){var He;for(Oe=(He=new A(Ve[o],ee).getInfiniteGeometry(this,Te)).geometry,Ne=He.primitiveIDs,x=0;x<Oe.length;x++){for(Q=Re(Oe[x]),P=0;P<Q.length;P++)Q[P]=Q[P].sgNode._getSGPrimitive(!0);if(Q.length){var ke=new G.SGRep({primitives:Q});for(P=0;P<Q.length;P++)Q[P].rep=ke;e.addCreatedObjectWithID(ke,Ne[x])}else{ke=new G.SGRep({});e.addCreatedObjectWithID(ke,Ne[x])}}}}s.addChild(we),s.addChild(Te);let Xe=null;this.viewManager.viewer._sgOrder&&(Xe=e.getIndex()),null!=Xe?W.insertChildAtIndex(s,Xe):W.addChild(s),this.inverseAction.removes.push({parentNode:W,node:s});break;case e.OperationType.VisuContextUpdate:te.setViewManager(this.viewManager);const $e=e.getVisuContext();te.tryUpdateSceneEnv(new N.VisuContextData($e),this.clientManager);const Ke=$e.getSupportParameters()?.getViewModeAnnotation();Ke&&this.annotationFilters.push({filter:Ke,sceneId:$e.getSceneId()});break;case e.OperationType.ModifyBoundingElement:s=this.getOperatedObject(e),w=(p=e.getGeometricalData())?M.getBoundingSphere(p.getBoundingSphere()):null,this.applyBEToBody(s,w);break;case e.OperationType.AddCGRNode:let Je=this.getParentNode(e);e.getDirectNode()&&(Je.addChild(e.getDirectNode()),e.getDirectNode().parents.push(Je),e.setCreatedObject(e.getDirectNode()))}v._NREGASOnNodeInit=!1,Y.end("WebVisuParameters::WebVisuUpdateTransaction "+t),i.End()},Ve.prototype.commit=function(){this.executeInverse({commits:!0,overrides:!0,optimize:!0}),q=null,this.executeEnd()},Ve.prototype.abort=function(){this.executeInverse({inverses:!0,overrides:!0}),q=null,this.executeEnd()},Ve.prototype.executeEnd=function(){this.setAnnotationFilters(),this.annotationFilters=[];for(let[e,t]of this.renderingModeToApply)this.addViewModeFilter(e,t,!0);this.renderingModeToApply=[];for(var e=0;e<this.nodesToRemove.length;e++){var t=this.nodesToRemove[e];t.parentNode.removeChild(t.node)}this.nodesToRemove=[],this.optimizeMeshes(),this.viewManager._publishVisuAnswer(!0)},Ve.prototype.executeInverse=function(e){if(e){if(e.inverses){for(var t=0;t<this.inverseAction.adds.length;t++){(o=this.inverseAction.adds[t]).parentNode.addChild(o.node)}for(t=0;t<this.inverseAction.removes.length;t++){var i=(o=this.inverseAction.removes[t]).parentNode,r=o.node;if(i instanceof y)i.removeChild(r);else{var n=i instanceof T?i.internalSceneGraph:i,a=n.children.indexOf(r);-1!==a&&n.children.splice(a,1)}}}if(e.commits)for(t=0;t<this.commitAction.removes.length;t++){var o;(o=this.commitAction.removes[t]).parentNode.removeChild(o.node)}if(e.optimize&&this.optimizeMeshes(),e.overrides){var s=this.getDefaultMaterials();for(var l in this.inverseAction.overrides){var d=this.inverseAction.overrides[l];d.node.setMaterial(s.face),d.node.setPickable(G.PICKTHROUGH),d.node.setNoZ(!1)}}}},Ve.prototype.optimizeMeshes=function(){for(var e in this.nodesToOptimize)this.nodesToOptimize[e];this.nodesToOptimize={}},Ve.prototype.applyBEToBody=function(e,t){e&&t&&(t.isInfinite||t.isEmpty?(e.exludeFromBounding(!0),e._setNoCullingBE(!0)):t.isContain?(e.exludeFromBounding(!1),e._setNoCullingBE(!0)):(e.exludeFromBounding(!1),e._setNoCullingBE(!1)),e.forceBoundingElements(!0,{sphere:t.sphere,box:t.sphere.getBoundingBox()},null))},Ve.prototype.applyBEToRenderable=function(e,t){e&&(e.boundingSphere.copy(t.bSphere),e.boundingBox.copy(t.bBox),e.geometry&&(e.geometry.boundingSphere=e.boundingSphere,e.geometry.boundingBox=e.boundingBox))},Ve.prototype.unstreamMatrix=function(e){if(!e)return null;var t=e.getArray(1);if(!t)return null;var i=new v.Matrix4;return i.set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],0,0,0,1),i},Ve.prototype.getStaticMaterial=function(e){return this.viewManager?this.viewManager.getStaticMaterial(e):null},Ve.prototype.getStaticLook=function(e){return this.viewManager?this.viewManager.getStaticLook(e):null},Ve.prototype.isViewpoint2D=function(){return this.viewManager?this.viewManager.viewer.currentViewpoint.isNative2D():null},Ve.prototype.setDefaultMaterials=function(e){if(e.surface||e.face){var t=e.surface?e.surface:e.face;Q.surface=t}e.volume?Q.volume=e.volume:e.face&&(Q.volume=e.face),e.line&&(Q.line=e.line,Q.surface.line=Q.surface.line,Q.volume.line=Q.volume.line),e.point&&(Q.point=e.point,Q.surface.point=Q.surface.point,Q.volume.point=Q.volume.point)},Ve.prototype.getDefaultMaterials=function(){return Q},Ve.prototype.getMaterialManager=function(){return Z||(Z=new m),Z},Ve.prototype.findAssociatedInfiniteNode3D=function(e,t){var i=e.persistentId;if(i&&i===t)return e;for(var r=e.children,n=0;n<r.length;n++){var a=this.findAssociatedInfiniteNode3D(r[n],t);if(a)return a}return null},Ve.prototype.addExistingNode=function(e,t,i,r){if(i.children.push(r),r.parents.push(i),!e||t===e)return!0;var n=Me(e),a=function(e){var t=[];if(e instanceof G.SGRep){for(var i=0;i<e.getPrimitivesCount();i++){var r=new G.SGPrimitiveHelper;r.set(e,i),t.push(r)}return t}for(i=0;i<e.children.length;i++)for(var n=a(e.children[i]),o=0;o<n.length;o++)t.push(n[o]);return t},o=a(r);this.addPrimitivesToMesh3D(o,n,e)&&n.show(o)},Ve.prototype.AddCells=function(e){const t=this.getOperatedObject(e);if(!t)return;this.nodesToOptimize[t.id]=t;const i=this;Oe(e,(function(r){const n=r&&r.getGeometries();if(!n)return;let a=!1,o=t;Pe.isMixedGP(o,null)&&([o,a]=Pe.getMesh3DForMixedGP(o,!1));const s=3===o._bodyDim,l={version:r.getVersion(),hasGeomDecorations:r.hasGeomDecorations()};for(let t=0;t<n.length;t++){const r=new b(n[t],l).getGeometry(i,s,o._getNoGASOnPrimitives()),a=r.geometry,d=r.primitiveIDs;if(!a)continue;o.__applyOnOccurrences((function(e){const t=e.renderable;if(t.addGeometry(a,!1),r.is2Din3D&&(t.fromLoadedModel=!1),o.bSphere){const e=t.geometry;e.boundingSphere||(e.boundingSphere=new v.Sphere,e.boundingBox=new v.Box3),e.boundingSphere.copy(o.bSphere),e.boundingBox.copy(o.bBox)}}));const c=a.drawingGroups;for(let t=0;t<c.length;t++)for(let i=0;i<c[t].getPrimitivesCount();i++){const r=new G.SGPrimitiveHelper;r.set(c[t],i),e.addCreatedObjectWithID(r,d[t][i])}}a&&t.addChild(o)}),(function(r){const n=r&&r.getGeometries();if(!n)return;for(let r=0;r<n.length;r++){const a=new A(n[r],ee).getInfiniteGeometry(i,t),o=a.geometry,s=a.primitiveIDs;for(let t=0;t<o.length;t++)e.addCreatedObjectWithID(o[t],s[t])}}))},Ve.prototype.ModifyBody=function(e){const t=this.getOperatedObject(e);if(!t)return;const i=e.getVisData(),r=t.mesh3js;if(i&&r){const a=i.rawBuffers,o=i.skeletonSkinning;if(o){if(o.getIsRemoveSkeleton())b.removeSkeleton(r.geometry);else if(o.getIsRemoveAnimation())r.setSkinningTransformations(null);else if(o.getBoneIdsBufferId()&&o.getBoneWeightsBufferId())b.addSkeleton(r.geometry,o.getBoneIdsBufferId(),o.getBoneWeightsBufferId(),a);else if(o.getBoneMatricesBufferId()){let e=b.createSkinningPosture(r.geometry,o.getBoneMatricesBufferId(),o.getNbBones(),a);r.setSkinningTransformations(e)}}else{const o=b.updateBuffers(r.geometry,a);let s=!0;if(o&&r._skinningData&&r._skinningData.skinning){let e=new Float32Array(o.data),t=r._skinningData.skinning;t.setSkinningMatrices(e),r.setSkinningTransformations(t)}else for(var n=0;n<r.geometry.length;n++)r.geometry[n].needsUpdate=!0;if(i.visPrimitives){s=!1;for(let r=0;r<i.visPrimitives.length;r++){let n=i.visPrimitives[r];b.updateSGV6Primitive(this,e,n,a,t)}}if(!s){r._flagAsGSSOInvalidated();for(let e=0;e<r.geometry.length;e++)r.geometry[e].needsUpdate=!0}}return}const a=this;Oe(e,(function(e){const i=e&&e.getGeometries();if(!i)return;let r=t;if(Pe.isMixedGP(r,null)&&(r=Pe.getExistingMesh3DForMixedGP(r),!r))return;const n={version:e.getVersion()};for(let e=0;e<i.length;e++){new b(i[e],n).updateGeometry(r)}}),(function(e){const i=e&&e.getGeometries();if(!i)return;for(let e=0;e<i.length;e++)new A(i[e],ee).updateInfiniteGeometry(a,t)}))},Ve.prototype.addExistingCells=function(e,t,i,r,n){if(!r)return!1;if(r instanceof G.SGRep){for(var a=0;a<n.length;a++)if(n[a]instanceof G.SGPrimitiveHelper){var o=n[a]._getSGPrimitive(),s=n[a].index;n[a].container._primitives[s].rep=r,r._primitives.push(o)}if(i)return!0;if(e===t)return!0;r=Me(e)}else if(r instanceof G.SGBag){for(a=0;a<n.length;a++){if(n[a]instanceof y&&!i)return console.warn("Primitives can't come from a non batched body"),!1;n[a]instanceof G.SGRep&&(n[a].parents.push(r),r.children.push(n[a]))}if(i)return!0;if(e===t)return!0;var l=Ee(e),d=Ee(t);for(a=0;a<n.length;a++){null!=(c=this.findAssociatedInfiniteNode3D(d,n[a].modelIdentification.getLocalId()))&&l.addChild(c)}return!0}if(!r.getNodeType||"Mesh3D"!==r.getNodeType()){for(a=0;a<n.length;a++)if(n[a])if(n[a]instanceof y)r.addChild(n[a]);else if(Pe.isMixedGP(r,n[a])){let t=Pe.getMesh3DForMixedGP(r,!0)[0];this.addPrimitivesToMesh3D([n[a]],t,e)&&t.show([n[a]])}else{var c;d=Ee(t);(c=this.findAssociatedInfiniteNode3D(d,n[a].getIdentificationObject().getLocalId()))&&r.addChild(c)}return!1}return this.addPrimitivesToMesh3D(n,r,e)},Ve.prototype.addPrimitivesToMesh3D=function(e,t,i){for(var r=[],n=0;n<e.length;n++)e[n]instanceof G.SGPrimitiveHelper&&r.push(e[n]);if(!r.length)return!1;var a={},o=[];for(n=0;n<r.length;n++){var s=r[n].getGroup(),l=s.geometry;if(l){var d=a[l.id];if(d)d.hasFace=d.hasFace||4===s.glType;else{var c={geometry:l,hasFace:4===s.glType};o.push(c),a[l.id]=c}}}this.nodesToOptimize[t.id]=t;for(var u=t._occurrences[0].renderable,h=[],g=0;g<o.length;g++){var p=!0,f=o[g].geometry;for(n=0;n<u.geometry.length;n++)if(f===u.geometry[n]){p=!1;break}p&&h.push(o[g])}var m=3===t._bodyDim;for(n=0;n<h.length;n++)h[n].hasFace&&Ie(h[n].geometry,m);if(h.length)for(var v=0;v<t._occurrences.length;v++){(u=t._occurrences[v].renderable).initLayers(1);for(g=0;g<h.length;g++)u.addGeometry(h[g].geometry,!!i),u._initLayersForGeometry(0,h[g].geometry);i&&(t.bSphere.copy(u.geometry.boundingSphere),t.bBox.copy(u.geometry.boundingBox))}return!0},Ve.prototype.addExistingCell=function(e,t){if(!e)return!1;if(!t)return!1;if(e instanceof y&&t instanceof y)return e.addChild(t),!1;if(!(e instanceof S&&t instanceof G.SGPrimitiveHelper))return!1;var i=t.getGroup().geometry;if(!i)return!1;this.nodesToOptimize[e.id]=e;for(var r=e._occurrences[0].renderable,n=!0,a=0;a<r.geometry.length;a++)if(i===r.geometry[a]){n=!1;break}if(t.getGroup()&&4===t.getGroup().glType){var o=3===e._bodyDim;Ie(i,o)}if(n)for(var s=0;s<e._occurrences.length;s++)(r=e._occurrences[s].renderable).initLayers(1),r.addGeometry(i),r._initLayersForGeometry(0,i);return!0},Ve.prototype.removeExistingCells=function(e,t){if(!e)return!1;if("Mesh3D"!==e.getNodeType()){for(let i=0;i<t.length;i++){let r=t[i];r&&(r instanceof y?parent.removeChild(r):Pe.isMixedGP(e,r)&&this.removeExistingCell(e,r))}return!1}for(var i=[],r=0;r<t.length;r++)t[r]instanceof G.SGPrimitiveHelper&&i.push(t[r]);if(!i.length)return!1;this.nodesToOptimize[e.id]=e;for(var n=0;n<e._occurrences.length;n++){var a=e._occurrences[n].renderable;a.removePrimitives(i);for(var o=0;o<i.length;o++)a.removeSelectionGroup(i[o])}return!0},Ve.prototype.removeExistingCell=function(e,t){if(!e)return!1;if(!t)return!1;if(Pe.isMixedGP(e,t)&&!(e=Pe.getExistingMesh3DFromMixedGP(e,t)))return!1;if(e instanceof y&&t instanceof y)return e.removeChild(t),!1;if(!(e instanceof S))return!1;this.nodesToOptimize[e.id]=e;for(var i=0;i<e._occurrences.length;i++){var r=e._occurrences[i].renderable;r.removePrimitives([t]),r.removeSelectionGroup(t)}return!0},Ve.prototype.nodeFromFixedSizeData=function(e,t=null,i){const r=this.viewManager.viewer.currentViewpoint.getMMInSupportUnit(),n=.5*(e.getMinSize()+e.getMaxSize())*r,a=e.getInvariantPoint(),o=e.getMutablePositionMatrix(),s=!i;return t?(t.setMutablePositionMatrix&&t.setMutablePositionMatrix(!0),t.setRatio&&t.setRatio(n),t.setInvariantPoint&&t.setInvariantPoint(a)):t=new _({ratio:n,invariantPoint:a,mutablePositionMatrix:o,is2D:s}),t},Ve.prototype.nodeFromBillboardData=function(e,t=null){const i=e.getType(),r=i===e.BillboardTypes.Cylindrical?"Cylindrical":(e.BillboardTypes.Spherical,"Spherical"),n=e.getCylindricalAxis(),a=new v.Vector3(n[0],n[1],n[2]);return t?t.setBillboardType&&t.setBillboardType(r):t=new D({type:r,constraintAxis:a,hack_NRE:!0}),t},Ve.prototype.nodeFromProjectionData=function(e,t=null){e.leftRatio,e.topRatio,e.scale;return t?t instanceof w&&(t.setFromPositionRatio(e.leftRatio,e.topRatio),t.setOnScreenScale(e.scale)):t=new w(e),t},Ve.prototype.createNodeFromData2Dto3D=function(e){const t=e.getStaticMode();if(1===t){var i=e.getAttachPoint(),r=e.getSphericalMode(),n=new D({type:r?"Spherical":"cylindrical",hack_NRE:!0});if(void 0!==i){var a=(new v.Matrix4).setPosition(i);n.applyMatrix(a)}return n}return t&&console.warn("3DSync not supported StaticMode > 1"),new y},Ve.prototype.apply2DTo3DData=function(e,t){var i=t.getAdvancedPriority(),r=t.getZDepthMode();i&&e.setAdvancedPriority(i),r&&e.setZDepthMode(r)},Ve.prototype.setFilters=function(e,n){if(!n)return;this.removeAllFilters(e);let m={planes:[],params:[]};for(let S=0;S<n.length;S++){const _=n[S];if(_ instanceof i){const e=_.getClippingPlane(),t=e.getFlags(),i=e.getSectionning(),r=e.getPoint(),n=e.getNormal();this.addClippingPlaneData(m,r,n,t,i)}else if(_ instanceof t){const t=_.getRepViewMode();this.addViewModeFilter(e,t)}else if(_ instanceof r)this.annotationFilters.push({filter:_,node:e});else if(_ instanceof a){const t=_.getRadius(),i=_._origin,r=_.getDirectionX(),n=_.getDirectionY(),a=_.getCenter(),o=_.getBoundariesVisible(),s=_.getGas();this.addScissorFilter(e,t,a,i,r,n,o,s)}else if(_ instanceof o){const t=_.getMode();e.setLayerFilter(_._layers,t)}else if(_ instanceof s){const t=new F,i=(_.getColorInheritance()&v.GASEnum.COLOR_INHERITANCE_ON)>0||!((_.getColorInheritance()&v.GASEnum.COLOR_INHERITANCE_OFF)>0)&&null,r=(_.getAsmInheritance()&v.GASEnum.ASMCOLOR_INHERITANCE_ON)>0||!((_.getColorInheritance()&v.GASEnum.COLOR_INHERITANCE_OFF)>0)&&null,n=_.getGas();let a=null;if(n){let e=new y;new V(n,this.clientManager).applyGP(this,e),a=e._gas,a._inheritanceInternal=0}e.setVisuFilters({gasInheritFilter:t.usingColorInherit(a,i).usingASMColorInherit(a,r)})}else if(_ instanceof l){let t=1,i=1;switch(_.getPolygonOffsetMode()){case fe:[t,i]=ye;break;case me:[t,i]=Se;break;case ve:[t,i]=_e;break;default:continue}e.setVisuFilters({polygonOffsetFilter:new U(i,t)})}else if(_ instanceof d)this.addPolygonalScissorFilter(e,_);else if(_ instanceof c)this.addCurveClippingFilter(e,_);else if(_ instanceof u)e.setVisuFilters({zModeFilter:new B(!!_.getZMode())});else if(_ instanceof h)_._skipDrawFurtive?e.setVisuFilters({furtiveFilter:new j(!0)}):e.setVisuFilters({furtiveFilter:null});else if(_ instanceof g){let t=null;switch(_.getWebDynamicMode()){case De:t=new W(!0,!0);break;case we:t=new W(!0,!1);break;case Te:t=new W(!1,!1)}t&&e.setVisuFilters({dynamicModeFilter:t})}else if(_ instanceof p){const t=_.getSkipDrawHighlight()>0,i=_.getSkipDrawPreHighlight()>0;e.setVisuFilters({noHighlightFilter:new z(t,i)})}else if(_ instanceof f){let t,i;if(_._plane){const e=(new v.Vector3).copy(_._plane._firstDirection),i=(new v.Vector3).copy(_._plane._secondDirection),r=e.cross(i);t=new v.Plane(r,-r.dot(_._plane._origin))}switch(_._mode){case 1:i=v.PlaneViewMode.NO_DISPLAY;break;case 2:i=v.PlaneViewMode.LOWLIGHT;break;case 3:i=v.PlaneViewMode.NO_PICK;break;case 4:i=v.PlaneViewMode.LOWLIGHT_NO_PICK;break;default:i=v.PlaneViewMode.NORMAL}e.setPvmFilter({mode:i,plane:t})}}m.planes.length>0&&this.addClippingPlaneFilter(e,m)},Ve.prototype.removeAllFilters=function(e){e.setVisuFilters({gasInheritFilter:null,polygonOffsetFilter:null,zModeFilter:null,furtiveFilter:null,dynamicModeFilter:null,noHightlightFilter:null,planeViewModeFilter:null}),this.viewManager.viewer._getCSIOverrideManager().deleteViewModeFilterOverride(e),e.setClippingCylinder(null),e.setScissoringPolyLine(null),this.viewManager.viewer._setOutlineNode(e,!1,null),e.setClippingProfile(null);var t=e.getDirectChildByName("__ScissorBoundary__");t&&e.removeChild(t);var i=e.getOverrideSetManager();if(!i)return;var r=i.getSceneGraphOverrideSetsByPrefix("__3DSyncFilters__");let n;for(n=0;n<r.length;n++)i.removeSceneGraphOverrideSet(r[n])},Ve.prototype.setAnnotationFilters=function(){if(0!==this.annotationFilters.length)for(var e=this.viewManager.viewer._getCSIOverrideManager(),t=0;t<this.annotationFilters.length;t++){var i=this.annotationFilters[t].filter,n=this.annotationFilters[t].node;let u=this.annotationFilters[t].sceneId;var a=i.getMode(),o=i.getAnnotationPaths();if(o)if(o.length>0)for(var s=0;s<o.length;s++){var l=o[s].getPaths(),d=o[s].getValue();void 0===n&&void 0!==u&&l.length>0&&(n=l[0].externalPath[0],e.viewToNodeMap.set(this.view,n));var c=this.truncatePaths(l,n);this.addAnnotationFilter(n,c,d,t,a)}else void 0!==u?(n=e.viewToNodeMap.get(this.view))&&(this.removeAllFilters(n),e.viewToNodeMap.delete(this.view)):a!==r.Mode.ModeInvertInvisibilityAndNoPick&&a!==r.Mode.ModeInvertNoPick||this.addAnnotationFilter(n,[],null,t,a)}},Ve.prototype.truncatePath=function(e,t){var i=!1,r=[t];if(void 0!==e&&(e.externalPath.forEach((function(e){i&&r.push(e),e===t&&(i=!0)})),1!==r.length))return e.externalPath=r,e},Ve.prototype.truncatePaths=function(e,t){var i=[];return e.forEach((e=>{if(void 0===e||0===e.getLength())console.warn("[Annotation] A path is not valid");else{e.getElement(0)!==t&&e.concatenatePathes(new C([t]),e),i.push(e)}})),i},Ve.prototype._createOverride=function(e,t,i,n){var a=e.createOverrideSetManager();if(a){var o=null;o=t?"__3DSyncFilters__annot"+i:"__3DSyncFilters__";var s=a.getSceneGraphOverrideSetByName(o);if(!s){var l=null;n&&(n===r.Mode.ModeNormal?l=$.normal:n===r.Mode.ModeForceShow?l=$.forceShow:n===r.Mode.ModeInvertInvisibilityAndNoPick?l=$.invert:n===r.Mode.ModeInvertNoPick&&(l=$.invertPick)),s=a.createSceneGraphOverrideSet({name:o,mode:l,asmInherit:!1,materialModeSensitive:!0,noOpacityOnLines:!0}),a.pushSceneGraphOverrideSet(s)}return t?s.createOverride({pathes:t,depthPriority:!0}):s.createOverride({pathes:[new C([e])],depthPriority:!0})}},Ve.prototype.addAnnotationFilter=function(e,t,i,a,o){var s=this._createOverride(e,t,a,o);if(i&&s){if(i.isRGBOverloaded()){var l=i.GetRGBA(),d=w(i.getRGBInheritance()),c=(new v.Color).setRGB(l.R/255,l.G/255,l.B/255);s.setColorAttribute({value:c,inheritance:d})}if(i.isAlphaOverloaded()){l=i.GetRGBA(),d=w(i.getAlphaInheritance());s.setOpacityAttribute({value:l.A/255,inheritance:d})}if(i.isInvisibilityOverloaded()){var u=!i.isInvisible();s.setVisibility(u)}else o!==r.Mode.ModeForceShow&&o!==r.Mode.ModeInvertInvisibilityAndNoPick||s.setVisibility(!0);if(i.isNoPickOverloaded()){var h=!i.isNotPickable();s.setPickability(h?"PICKABLE":"IGNORED")}if(i.isUncutOverloaded()){i.isUncutEnabled(),d=i.getUncutInheritance()===n.AnnotationInheritanceMode.ModeForceInherit;var g=new R;console.log("[TODO] Filter isUncutOverloaded not fully supported."),s.setClippingContext(g)}if(i.isViewModeOverloaded()){d=w(i.getViewModeInheritance());var p=new H({combineRenderMode:"REPLACE",faceMode:null});p.setRenderMode("Face",i.isViewMeshEnabled()),p.setRenderMode("@Edge",i.isViewEdgeEnabled()),p.setRenderMode("WireEdge",!i.isViewWithoutWiresEnabled()),p.setRenderMode("AxisSystem",!i.isViewWithoutAxisEnabled());var f=!i.isViewWithoutPointsEnabled();p.setRenderMode("BoundaryPoint",f),p.setRenderMode("SharpPoint",f),p.setRenderMode("SmoothPoint",f),p.setRenderMode("Outline",!i.isViewWithoutOutlineEnabled()),s.setRenderStyleAttribute({value:p,inheritance:d})}if(i.isMaterialOverloaded()&&i.getMaterial()){var m=i.getMaterial(),y=m.getMaterialJSON()._json,S=m.getMaterialBuffers(),_=(d=w(i.getMaterialInheritance()),new I),D=[];Array.isArray(S)&&S.length>0&&S.forEach((function(e){D.push({buffer:e.getData()})})),_.load({json:y,zipped:!1,chunks:D,doneCallback:e=>{var t=e.materialApplications[0];s.setMaterialAttribute({value:t,inheritance:d})}})}if(i.isMatrixOverloaded()&&i.getMatrix()){const e=new v.Matrix4;e.setFromArray(i.getMatrix()),s.setPosition(e)}}function w(e){var t=[J.InheritMode.INHERIT,J.InheritMode.FORCE_INHERIT,J.InheritMode.GRAPH_SCENE];return t[e]||t[0]}},Ve.prototype.addViewModeFilter=function(e,t,i){var r=this.viewManager.viewer._getCSIOverrideManager();if(t){var n=i?r.getVisRenderingModeOverride(e):r.getViewModeFilterOverride(e),a=new H({combineRenderMode:"REPLACE",faceMode:null});a.setFaceMode("COLOR"),a.setMaterialMode(t&ae),a.setRenderMode("Face",t&ie),a.setRenderMode("Outline",t&ne),t&oe&&(a.setRenderMode("Face",!0),a.setRenderMode("Outline",!0),a.setFaceMode("BACKGROUND")),a.setRenderMode("@Edge",t&re),a.setRenderMode("InternalSmoothEdge",!(t&de)),a.setRenderMode("_HighCurvatureEdge",!(t&de)),t&pe&&a.setRenderMode("InternalSmoothEdge",!1),a.setRenderMode("WireEdge",!(t&ue));var o=!(t&ce);a.setRenderMode("BoundaryPoint",o),a.setRenderMode("SharpPoint",o),a.setRenderMode("SmoothPoint",o),a.setRenderMode("FreePoint",!(t&ge));var s=t&le;a.setHalfVisibleSmoothEdges(s?1:0);var l=t&se;a.setHiddenEdges(l?1:0);var d=!(t&he);a.setRenderMode("AxisSystem",d),a.setRenderMode("InfiniteFace",d),n.setRenderStyle(a,!0)}else i?r.deleteVisRenderingModeOverride(e):r.deleteViewModeFilterOverride(e)},Ve.prototype.addClippingPlaneData=function(e,t,i,r,n){for(var a=0;a<t.length/3;a++){var o=new v.Plane;o.setFromNormalAndCoplanarPoint(new v.Vector3(i[3*a],i[3*a+1],i[3*a+2]),new v.Vector3(t[3*a],t[3*a+1],t[3*a+2])),e.planes.push(o),e.params.push({capping:!!(r[a]&Ne.fCapping),sectionLines:!!n[a]})}},Ve.prototype.addClippingPlaneFilter=function(e,t){var i=this._createOverride(e),r=t.planes,n=new R;n.setPlanes(r),n._setUseLocalCoordinates();for(var a=0;a<r.length;a++)n.setPlaneParams(r[a],t.params[a]);i.setClippingContext(n)},Ve.prototype.addScissorFilter=function(e,t,i,r,n,a,o,s){var l=new v.Vector3(r.x,r.y,r.z);if(i&&(l.x+=i.x*n.x+i.y*a.x,l.y+=i.x*n.y+i.y*a.y,l.z+=i.x*n.z+i.y*a.z),e.setClippingCylinder({center:l,axisU:new v.Vector3(t*n.x,t*n.y,t*n.z),axisV:new v.Vector3(t*a.x,t*a.y,t*a.z),clipOutside:!0}),o){var d=P.createCircleNode({radius:t,segments:32,fill:!1});d.name="__ScissorBoundary__";var c=new v.Vector3(n.x,n.y,n.z),u=new v.Vector3(a.x,a.y,a.z);c.normalize(),u.normalize();var h=new v.Vector3;h.crossVectors(c,u);var g=(new v.Matrix4).makeBasis(c,u,h);g.setPosition(l),d.setMatrix(g),e.addChild(d),new V(s,this.clientManager).applyGP(this,d),d.setGAS(new x.IncrementalGraphicAttributeSet({inheritance:v.GASEnum.RGBA_INHERITANCE_ON|v.GASEnum.LINEWIDTH_INHERIT|v.GASEnum.LINETYPE_INHERIT}))}},Ve.prototype.addPolygonalScissorFilter=function(e,t){var i,r=[],n=[],a=t.getNbVertex(),o=t.getVertices();for(i=0;i<a.length;i++)r.push(a[i]);for(i=0;i<o.length;i++)n.push(o[i]);e.setScissoringPolyLine({nbPolygon:t.getNbPolygon(),nbVertices:r,vertices:n,point:new v.Vector3(t.getPoint().x,t.getPoint().y,t.getPoint().z),dirX:new v.Vector3(t.getDirectionX().x,t.getDirectionX().y,t.getDirectionX().z),dirY:new v.Vector3(t.getDirectionY().x,t.getDirectionY().y,t.getDirectionY().z)});var s=null;if(t.getBoundariesVisible()){var l,d,c,u=t.getGas(),h=[],g=0,p=e.clippingContext._scissor.polyLines[0].points3D;for(l=0;l<t.getNbPolygon();l++){for(c=g,d=0;d<r[l]-1;d++)h.push(p[g]),h.push(p[g+1]),g++;h.push(p[g]),h.push(p[c])}var f=(s=P.createLineNode({points:h})).createOverrideSetManager(),m=f.createSceneGraphOverrideSet();f.pushSceneGraphOverrideSet(m);var y=m.createOverride(new C([s])),S=new R([]);S.setUncut(!0),y.setClippingContext(S),s.setNoZ(!0),s.name="outlineNode",new V(u,this.clientManager).applyGP(this,s),s.setGAS(new x.IncrementalGraphicAttributeSet({inheritance:v.GASEnum.RGBA_INHERITANCE_ON|v.GASEnum.LINEWIDTH_INHERIT|v.GASEnum.LINETYPE_INHERIT}))}this.viewManager.viewer._setOutlineNode(e,t.getBoundariesVisible(),s)},Ve.prototype.addCurveClippingFilter=function(e,t){e.setClippingProfile({csiParams:{curveCount:t.getCurveCount(),vertexCounts:t.getVertexCounts(),vertices:t.getVertices(),normals:t.getNormals(),transform:t.getTransformFromVertices()}})};var Ne={fCapping:1,fHiddenElements:4,fPriority:8,fNonZParticipants:16,fFurtive:32,fUncutting:64,fDefault:0},Ge=null;return K.subscribe({event:"/VISU/AFTER_GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE"},(e=>{var t=e.viewer.getRenderer(),i=Ge?Ge.get(t):null;if(i){var r,n=x.getLowLightColor(t);for(r=0;r<i.length;r++)i.setColor(n,!1)}})),Ve})),define("DS/WebVisuParameters/WebVisuSceneGraphUpdater",["DS/CSIViewModelWebInterfaces/CSIVMClientDelegateInterface","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey","DS/WebVisuParameters/WebVisuUpdateTransaction","DS/WebVisuParameters/WebVisuUpdateTransactionHighlight","DS/Visualization/ViewManager","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/CGRNode","DS/Visualization/PathElement","DS/Visualization/SubElement","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionHSO","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionPSO","DS/VisualizationProfiler/VisuProfiler"],(function(e,t,i,r,n,a,o,s,l,d,c,u,h,g){"use strict";function p(e,t){var i,r=e.persistentId;if(r&&r===t&&(i=[e]),!i)for(var n=e.children,a=0;a<n.length;a++){var o=p(n[a],t);if(o){(i=o).unshift(e);break}}return i}var f=function(e){this.viewManager=new n(e),e&&!e._perfoStartToken&&(e._perfoStartToken=e.onPreRenderFrame((()=>{g.begin("CSIViewer::RenderFrame")})),e._perfoEndToken=e.onPostRender((()=>{g.end("CSIViewer::RenderFrame")})))};return(f.prototype=Object.create(e.prototype)).createTransaction=function(e){if(e.getViewType()!=t.prototype.ViewType.View3D)return console.warn("Unsupported view type"),new i(this.viewManager,e,this.getManager&&this.getManager());switch(e.getView3DType()){case t.prototype.View3DType.View3D_Highlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!1,u);case t.prototype.View3DType.View3D_MultiColorHighlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!0,u);case t.prototype.View3DType.View3D_PreHighlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!1,h);default:return new i(this.viewManager,e,this.getManager&&this.getManager())}},f.prototype.createPathElement=function(e,t){if(!e||!e.length)return null;var i=e[0];if(!(i instanceof o))return null;var r,n=i,u=!1,h=n instanceof l,g=h?n:void 0,f=[n],m=[];if(!t){if(n.parents.length>1){for(var v=0;v<n.parents.length;v++)if(!n.parents[v].notAllowedInPathElement)return null;u=!0}if(!u)for(var y=n.parents[0];y&&!(n=y).notAllowedInPathElement;){if(f.unshift(n),n.parents.length>1){for(v=0;v<n.parents.length;v++)if(!n.parents[v].notAllowedInPathElement)return null;break}y=n.parents[0]}}var S=null;for(r=1;r<e.length&&((n=e[r])instanceof l&&(h=!0,g=n),n instanceof o);r++)f.push(n),n instanceof s&&(S=n._occurrences[0].renderable);for(var _=r;_<e.length;_++){var D=e[_];if(D instanceof a.SGPrimitiveHelper){var w=D;if(S){var T=S.getSelectionGroup(D);T&&(w=T)}m.push(c.getFromSGNode(w))}else h&&(D instanceof a.SGBag||D instanceof a.SGRep)&&m.push(c.getFromSGNode(D))}if(h&&m.length>0){var P=m[m.length-1].sgNode,C=!1;if(P instanceof a.SGRep&&(C=!0),P instanceof a.SGBag){var I=P.children;1===I.length&&I[0]instanceof a.SGRep&&(P=I[0],C=!0)}if(C){var M=p(g.children[1]instanceof o?g.children[1]:g.children[0],P.modelIdentification.getLocalId());M&&(f=f.concat(M))}}var E=new d;return E.setFromArray(f,m),E},f.prototype.createIdentifiedObjectsArray=function(e){if(!e)return null;for(var t=[],i=0;i<e.externalPath.length;i++){var r=e.externalPath[i];r&&r.getIdentificationObject()&&t.push(r)}for(i=0;i<e.internalPath.length;i++){var n=e.internalPath[i];n&&n.sgNode&&n.sgNode.getIdentificationObject()&&t.push(n.sgNode)}return t},f}));