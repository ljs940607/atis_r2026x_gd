define("DS/ENODOManagementCmdsLight/commands/GenericDOGenerationCmd",["UWA/Core","UWA/Controls/Abstract","DS/PlatformAPI/PlatformAPI","i18n!DS/ENODOManagementCmdsLight/assets/nls/DOGeneratorCmd","DS/ENODOUtilsServices/DOServices","text!DS/ENODOUtilsServices/assets/enodo_webservices.json"],(function(e,t,r,o,i,a){"use strict";var s=JSON.parse(a);let n=["CATPart","SLDPRT","PRT","IPT"],l=["DWG","SLDDRW","CATDrawing"];return t.extend({jsonObjects:[],init:function(e){if(this._parent(e),UWA.is(e.data.context)&&(this.context=e.data.context),UWA.is(e.data)&&UWA.is(e.data.selections||0===e.data.selections.length)){this.selectionMessage=e.data.selections,this.leaves=e.data.leaves;var t=UWA.is(e.data.filter)?e.data.filter:null;this._initializeFormatList(t)}else i._displayNotification("error",o.error.title,o.error.noSelection),this.destroy()},_buildModel:function(e,t){this.model={format:e,rules:t,selection:[],updateSelection:function(e){e.length<=this.format.length&&(this.selection=e)},updateFormatList:function(e){this.format=e,this.selection=[]},getSelectedFormats:function(){for(var e=[],r=0;r<this.selection.length;r++){var o=this.selection[r];if(o<t.length){var i=t[o];e.push(i)}}return e}}},_initializeFormatList:function(e){var t=this,r={data:{ruleType:"ONDEMAND"},webService:{url:s.retrieveFormats.url,verb:s.retrieveFormats.verb},callback:{onComplete:function(r){var a=UWA.is(r,"string")?JSON.parse(r):r;if(UWA.is(a.derivedOutputRules)&&0!==a.derivedOutputRules.length){for(var s=[],d=[],c=0;c<a.derivedOutputRules.length;c++){var p=a.derivedOutputRules[c];if(p.hasOwnProperty("target")&&p.hasOwnProperty("category")&&p.hasOwnProperty("source")&&p.hasOwnProperty("parameters")){var u=!1;if(null!==e&&(e.hasOwnProperty("CADMaster")&&null!==e.CADMaster&&e.CADMaster.toLowerCase()!==p.category.toLowerCase()&&(u=!0),e.hasOwnProperty("type")&&e.type.length>0&&("Drawing"===e.type&&-1===l.indexOf(p.source)||"Part"===e.type&&-1===n.indexOf(p.source))&&(u=!0),e.hasOwnProperty("Type")&&null!==e.Type&&e.Type.toLowerCase()!==p.sourceType.toLowerCase()&&(u=!0)),null===e&&"OfficeDocumentConverter"===p.converter&&(u=!0),!u){for(var f="",y=p.parameters,v=0;v<y.length;v++){var m=y[v];if(m.hasOwnProperty("name")&&m.hasOwnProperty("value"))f+=(m.hasOwnProperty("displayName")?m.displayName:m.name)+" = "+(m.hasOwnProperty("displayValue")?m.displayValue:m.value)+", "}f.length>0&&(f=f.substring(0,f.length-2));var h=p.hasOwnProperty("converter")?p.converter:"",g=p.source,O=g;p.hasOwnProperty("sourceToDisplay")?O=p.sourceToDisplay:o.type.hasOwnProperty(g.toLowerCase())&&(O=o.type[g.toLowerCase()]);var w=p.hasOwnProperty("outputStreamId")?p.outputStreamId:C,C=p.target;p.hasOwnProperty("targetToDisplay")&&(C=p.targetToDisplay);var _=p.hasOwnProperty("activation")?p.activation:"defaultinactive";if(p.hasOwnProperty("forceUpdate"))var S=p.forceUpdate;var D={format:C,connector:p.category,type:O,parameter:f,converter:h,activationType:_,outputStreamId:w,forceUpdate:S};s.push(D),d.push(p)}}}0===s.length?(i._displayNotification("error",o.error.title,o.warning.noFormat),t._destroyCmd()):(t._buildModel(s,d),t._createView())}else 0===a.derivedOutputRules.length&&i._displayNotification("error",o.error.title,o.warning.noFormat),t._destroyCmd()},onFailure:function(e){i._displayNotification("error",o.error.title,o.replace(o.error.jobFailed,{oMsg:e})),t._destroyCmd()}}};i.SendServerRequest(r)},_createView:function(){var e=this;require(["DS/ENODOManagementCmdsLight/views/_DOGeneratorView"],(function(t){var r=new t({_command_id:e.options.ID,model:e.model,controller:e});e.view=r}))},_generateDO:function(){var e=this;UWA.is(this.view)&&this.view.destroy();var t={data:{selections:e.selectionMessage,formatList:this.model.getSelectedFormats(),context:this.context},webService:{url:s.navigateAndGenerateJobs.url,verb:s.navigateAndGenerateJobs.verb},callback:{onComplete:function(t){var a=UWA.is(t,"string")?JSON.parse(t):t;if(UWA.is(a.jobsCreated)){var s=a.jobsCreated;if(0===s?i._displayNotification("info",o.info.title,o.info.noJobCreated):1===s?i._displayNotification("info",o.info.title,o.info.jobCreated):i._displayNotification("info",o.info.title,o.replace(o.info.jobsCreated,{oJobs:s})),"ENOWSES_AP"===e.context){var n={operation:"OnDemandDOGeneration",content:a};r.publish("webinwin:web:notification",JSON.stringify(n))}}e._destroyCmd()},onTimeout:function(e){i._displayNotification("warning",o.warning.title,o.error.doCreationTimeout)},onFailure:function(t){var r;if(t.message&&t.message.indexOf("Error:")&&t.message.indexOf("ResponseCode")){var a=t.message.substring(t.message.indexOf("ResponseCode")).split('"')[1];"500"===a?"ENOWSES_AP"===e.context?(i._displayNotification("error",o.error.title,o.error.wrongSelection,""),e._destroyCmd()):(i._displayNotification("error",o.error.expandIssue.Title,"",o.error.expandIssue.Subtitle),e._destroyCmd()):"400"===a?(i._displayNotification("error",o.error.code400.Title,o.error.code400.Message,o.error.code400.Subtitle),e._destroyCmd()):"401"===a?(i._displayNotification("error",o.error.code401.Title,"",o.error.code401.Subtitle),e._destroyCmd()):null==a?(r="Gateway Timeout error",i._displayNotification("error",o.error.title,o.replace(o.error.jobFailed,{oMsg:r}),""),e._destroyCmd()):(r="Error processing request",i._displayNotification("error",o.error.title,o.replace(o.error.jobFailed,{oMsg:r}),""),e._destroyCmd())}}}};i.SendServerRequest(t)},_destroyCmd:function(){UWA.is(this.view)&&this.view.destroy(),this.destroy()}})}));