define("DS/RenderingMaterial3DSI/TextureLoader",["DS/WAFData/WAFData"],(function(e){const t="true"===localStorage.getItem("XCT_AC_LOG_ENABLE");return class{constructor(e){this._cachedMimeTypeRequests=new Map,this._cachedBufferRequests=new Map,this._queuedBufferRequests=new Array,this._retryBufferRequestCounts=new Map,this._securityParameters=e?.securityParameters??null,this._textureFetchTimeout=e?.bufferFetchTimeout??6e4,this._maxBufferRetries=e?.maxBufferFetchRetries??3,this._maxBufferRequests=e?.maxBufferFetchRequests??100,this._pendingBufferRequests=0}SetSecurityParameters(e){this._securityParameters=e}FreeCachedMimeTypeRequests(){this._cachedMimeTypeRequests.clear()}FreeCachedBufferRequests(){this._cachedBufferRequests.clear()}async FetchTextureMimeType(e){const t=e;if(this._cachedMimeTypeRequests.has(t))return this._cachedMimeTypeRequests.get(t);const r=this._FetchTextureMimeTypeInternal(e);return this._cachedMimeTypeRequests.set(t,r),r}async FetchTextureBuffer(e,r){const a=e+"/"+r;if(this._cachedBufferRequests.has(a))return this._cachedBufferRequests.get(a);let n=null;return this._pendingBufferRequests>=this._maxBufferRequests?(t&&console.debug(`[AC][TextureLoader] Request queued (boid=${e} file=${r})`),n=new Promise(((t,a)=>{this._queuedBufferRequests.push({pid:e,filename:r,resolve:t,reject:a})}))):(t&&console.debug(`[AC][TextureLoader] Fetch texture buffer (boid=${e} file=${r})`),n=this._FetchTextureBufferInternal(e,r)),this._cachedBufferRequests.set(a,n),n}_FetchTextureMimeTypeInternal(t){const r="ds6wg:plmdmtdocument.v_primarymimetype";if(!this._securityParameters)throw new Error("Missing security parameters");const a=`${this._securityParameters.userLogin}fetch-${t}`,n=`${`${this._securityParameters.service3DSpaceUrl}/cvservlet/fetch/v2`}?tenant=${this._securityParameters.tenant}`;return new Promise(((i,s)=>{e.authenticatedRequest(n,{method:"POST",proxy:"passport",type:"json",responseType:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},data:JSON.stringify({label:a,physicalid:[t],locale:"en",tenant:this._securityParameters.tenant,select_predicate:[r,"plmtdoc.stream.name"]}),onComplete:e=>{const t=e?.results?.[0]?.attributes.find((({name:e})=>e===r));i(t?.value??"png")},onFailure:e=>{s(e)},onTimeout:()=>{s(new Error("Requests timed out while fetching texture mime type"))}})}))}_FetchTextureBufferInternal(t,r){const a={format:1,boid:t,filename:r};if(!this._securityParameters)throw new Error("Missing security parameters");const n=`${`${this._securityParameters.service3DSpaceUrl}/resources/fcsservices/fcs/mediaURL`}?${Object.keys(a).map((e=>`${e}=${a[e]}`)).join("&")}`;return++this._pendingBufferRequests,new Promise(((a,i)=>{e.authenticatedRequest(n,{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:this._textureFetchTimeout,onComplete:e=>{a(e),--this._pendingBufferRequests,this._FlushRetryCount(t,r),this._ProcessBufferRequestQueue()},onFailure:e=>{i(e),--this._pendingBufferRequests,this._FlushRetryCount(t,r),this._ProcessBufferRequestQueue()},onTimeout:()=>{--this._pendingBufferRequests,this._FlushRetryCount(t,r),this._IsRetryAllowed(t,r)?this._FetchTextureBufferInternal(t,r).then(a).catch(i):(i(new Error("Request timed out wile fetching texture buffer")),this._ProcessBufferRequestQueue())}})}))}_IsRetryAllowed(e,r){const a=e+"/"+r,n=this._retryBufferRequestCounts.get(a)??0;this._retryBufferRequestCounts.set(a,n+1);const i=n<this._maxBufferRetries;return t&&i&&console.debug(`[AC][TextureLoader] Request timed out, retry ${n}/${this._maxBufferRetries} (boid=${e} file=${r})`),i}_FlushRetryCount(e,t){const r=e+"/"+t;this._retryBufferRequestCounts.delete(r)}_ProcessBufferRequestQueue(){if(this._queuedBufferRequests.length>0){const e=this._queuedBufferRequests.shift();t&&console.debug(`[AC][TextureLoader] Process queue entry (boid=${e.pid} file=${e.filename})`),this._FetchTextureBufferInternal(e.pid,e.filename).then(e.resolve).catch(e.reject)}}}})),define("DS/RenderingMaterial3DSI/RenderingMaterial3DSIParser",["DS/Visualization/ThreeJS_DS","DS/VisuLoaders/ThreeDXLoader","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/RenderingMaterialLib/MaterialMappingCoreServices","DS/RenderingMaterialLib/VisuConversionHelpers","DS/RenderingMaterial3DSI/TextureLoader"],(function(e,t,r,a,n,i){const s=["PLANAR","SPHERICAL","FINITE_CYLINDRICAL","CUBIC","None","None","None","None","INFINITE_CYLINDRICAL"],o=["CLAMP_TO_EDGE","REPEAT"],c=["CLAMP_TO_BORDER","REPEAT"],u="true"===localStorage.getItem("XCT_AC_LOG_ENABLE"),p="true"===localStorage.getItem("XCT_AC_TEXTURE_FALLBACK_DISABLE"),l=parseInt(localStorage.getItem("XCT_AC_TEXTURE_FETCH_TIMEOUT_MS")??6e4),m=parseInt(localStorage.getItem("XCT_AC_TEXTURE_FETCH_RETRY_COUNT")??3),f=parseInt(localStorage.getItem("XCT_AC_TEXTURE_FETCH_MAX_REQUEST_COUNT")??100),d="true"===localStorage.getItem("XCT_AC_TEXTURE_FETCH_LOD_ENABLE"),h=e=>{if(!e)return!1;let t=e;return"materialReferenceType"in e?t=e.materialReferenceType:"isKindOf"in e&&(t=e.isKindOf),("string"==typeof t||t instanceof String)&&t.toLowerCase().includes("decal")},g=["exr","tif","tiff"],_=new r,y=e=>{let t=Number(e.slice(0,2));t-=50;let r=e.slice(2,6);return r=Number(r[0]+"."+r.slice(1)),r*Math.pow(10,t)},x=e=>{var t={};if(null==e)return t;if(e.repeat&&(e.repeat[0]=parseFloat(e.repeat[0]),e.repeat[1]=parseFloat(e.repeat[1]),0!=e.repeat[0]&&(t.repeat_u=1==Math.abs(e.repeat[0])),0!=e.repeat[1]&&(t.repeat_v=1==Math.abs(e.repeat[1])),0!=e.repeat[0]&&(t.flip_u=e.repeat[0]<0),0!=e.repeat[1]&&(t.flip_v=e.repeat[1]<0)),e.offset&&(e.offset[0]=parseFloat(e.offset[0]),e.offset[1]=parseFloat(e.offset[1]),0!=e.offset[0]&&(t.offset_u=1e3*e.offset[0]),0!=e.offset[1]&&(t.offset_v=1e3*e.offset[1])),e.scale&&(e.scale=parseFloat(e.scale),0!=e.scale)){const r=(e=>{if(e<0){const t=Math.abs(e).toString(),r=8;return{scale:y(t.slice(0,r)),ratio:y(t.slice(r,2*r))}}{const t=1e6,r=1e3,a=e%t,n=Math.floor(e/t);return{scale:a,ratio:n>0?n/r:1}}})(e.scale);t.scale_u=r.scale,t.scale_v=r.scale/r.ratio}return e.angle&&(e.angle=parseFloat(e.angle),0!=e.angle&&(t.angle=e.angle)),e.matrix&&(t.object_transform=e.matrix.map((function(e){return parseFloat(e)}))),e.mapType&&(e.mapType=parseInt(e.mapType),0!=e.mapType&&(t.type=e.mapType-1)),e.mapFocus&&(e.mapFocus=parseInt(e.mapFocus),0!=e.mapFocus&&(t.mapFocus=e.mapFocus-1)),t},T=e=>{let t={};return t.repeat_u=e.referenceMapping?.repeat_u,t.repeat_v=e.referenceMapping?.repeat_v,t.offset_u=e.referenceMapping?.offset_u,t.offset_v=e.referenceMapping?.offset_v,t.angle=e.referenceMapping?.angle,t.flip_u=e.referenceMapping?.flip_u,t.flip_v=e.referenceMapping?.flip_v,t.scale_u=e.referenceMapping?.scale_u,t.scale_v=e.referenceMapping?.scale_v,t.type=e.referenceMapping?.type,t.mapFocus=e.referenceMapping?.behavior,a.ResolveReferenceMappingInfo(t)},M=(e,t)=>({reference:T(t),connection:x(e),channels:t.texturesInfo,mappingSemantic:t.mappingSemantic,isDecal:h(e)||h(t),metricDimU:t.metricDimU,metricDimV:t.metricDimV}),b=e=>{null!=e&&null!=e.binaries&&(e.binaries.flag="3DPlay",e.binaries.forEach((function(e,t){null!=e.uri&&(delete e.uri,null!=e.byteLength&&delete e.byteLength,null==e.extUri&&(e.extUri="0"))})))},A=e=>{null!=e&&null!=e.dxm&&(null==e.jsonVersion&&(e.jsonVersion=1,e.IsSubstance&&(e.dxm=null)),e.jsonVersion<=2&&(e.texturesSize&&(e.texturesInfo=e.texturesSize,delete e.texturesSize),e.dxm&&e.dxm.textures?Array.isArray(e.texturesInfo)&&(e.texturesInfo.length=e.dxm.textures.length):Array.isArray(e.texturesInfo)&&delete e.texturesInfo),null!=e.mappingSemantics?(e.mappingSemantic=e.mappingSemantics,delete e.mappingSemantics):null!=e.decoupledMapping&&(e.mappingSemantic=a.CATMappingSemantic.DecoupledMapping,delete e.decoupledMapping),null==e.mappingSemantic&&(e.mappingSemantic=a.CATMappingSemantic.LegacyMapping),b(e.dxm))},P=(e,t)=>{if(!Array.isArray(e.textures)||0===e.textures.length)return;const r=t.connection,a=t.reference,n=t.channels,i=t.isDecal?c:o;for(let t=0;t<e.textures.length;t++){const s=n?.[t]?.mapping??{},o=r.repeat_u??s.repeat_u??a.repeat_u??!0,c=r.repeat_v??s.repeat_v??a.repeat_v??!0,u=e.textures[t];u.uWrap=i[o?1:0],u.vWrap=i[c?1:0],"CLAMP_TO_BORDER"!==u.uWrap&&"CLAMP_TO_BORDER"!==u.vWrap||(u.borderColor=[0,0,0,0])}e.header.generator+=" / Rma3DSIParser"},I=e=>{(new t).loadMaterial({destinationNode:null,json:e.dxm,resourcesLibrary:_,binaryCallback:(t,r)=>{e?.onBeforeTextureFetchCallback?.(t),e.onLoadTexture(t,r).then((e=>{u&&console.debug(`[AC][RenderingMaterial3DSIParser] Load texture: ${t} | Size: ${e.buffer.byteLength} | Type: ${e.mimeType}`),r(e.buffer,e.mimeType)})).catch((e=>{u?console.warn(`[AC][RenderingMaterial3DSIParser] (PID:${t}): ${e.message}`,e):console.warn("[Rendering Material] Failed to load texture"),p||r(null,null)}))},doneCallback:t=>{const r=t.material;null!=r?e.onSuccess(r):e.onError(new Error("Loaded material is null"))},errorCallback:()=>e.onError(new Error("Failed to load material"))})};return new class{constructor(){this._textureLoader=new i({bufferFetchTimeout:l,maxBufferFetchRetries:m,maxBufferFetchRequests:f}),this.textureDataMap=new Map,this.textureDomainMap=new Map}async CreateMaterial(e){const t=this.ProcessIndexAttributes(e.visAppearanceAttribute,e.cnxIndexAttributes);if(t.mappingInfo.isDecal)throw new Error("Expected Material index, received Decal index.");return this.ImportMaterial({dxm:t.dxm,mappingInfo:t.mappingInfo,domainId:t.domainId,securityParameters:e.securityParameters,onBeforeTextureFetchCallback:e.onBeforeTextureFetchCallback})}async CreatePreviewMaterial(e){const t=this.ProcessIndexAttributesForPreview(e.visAppearanceAttribute,e.cnxIndexAttributes);return this.ImportMaterial({dxm:t.dxm,mappingInfo:t.mappingInfo,domainId:null,securityParameters:e.securityParameters,onBeforeTextureFetchCallback:e.onBeforeTextureFetchCallback})}FreeCache(){this._textureLoader.FreeCachedMimeTypeRequests(),this._textureLoader.FreeCachedBufferRequests()}ProcessIndexAttributes(t,r){if(A(t),null==t||null==t.dxm)throw new Error("Invalid visAppearanceAttribute");const n=M(r,t),i=t.dxm,p=t.domainID;u&&null!=i.binaries&&(null==n.reference&&console.warn("[AC][RenderingMaterial3DSIParser] We have textures but missing reference mapping values. VisAppearanceAttribut generation problem?"),null==n.channels&&console.warn("[AC][RenderingMaterial3DSIParser] We have textures but missing texture infos. VisAppearanceAttribut generation problem?")),n.mappingType=n.connection.type??n.reference.type??-1;const l="true"===localStorage.getItem("XCT_AC_LEGACY_MAPPING_COMPUTATION_ENABLE"),m=(e=>{let t=e.dxm;if(!t||!t.textures||!e.texturesInfo)return!1;const r=t.materials[0];if(!r.type.startsWith("DSPBR"))return!1;if(e.jsonVersion>=4)return!0;let a=t.textures.length;const n=Object.keys(r);for(let i of n){const n=r[i];if("object"==typeof n&&"texture"in n){const r=n.texture,s=t.textures[r].image,o=t.images[s].binary;if(e.texturesInfo[o].id||(e.texturesInfo[o].id=i),0==--a)break}}return 0===a})(t);return l||!m?(u&&console.debug("[AC][RenderingMaterial3DSIParser] Apply mapping by modifying 3DXM (legacy)"),((t,r)=>{const n=r.connection,i=r.reference,p=r.channels,l=r.mappingSemantic;if(!i||!p||!t.textures)return;!u||t.header&&"3.2"==t.header.version||console.warn("[AC][RenderingMaterial3DSIParser] Unsupported 3DXM version in VisAppearanceAttribute.");const m=a.computeApplicationMapping(i,n,l),f=r.isDecal?c:o;t.textures.forEach((function(t,r){let o=null;null!=p[r]&&null!=p[r].mapping&&(o=p[r].mapping);const c=a.computeChannelMapping(i,n,o,p[r],l),u=a.combineMappingResults(m,c,l);t.uWrap=f[u.repeat_u?1:0],t.vWrap=f[u.repeat_v?1:0],"CLAMP_TO_BORDER"!==t.uWrap&&"CLAMP_TO_BORDER"!==t.vWrap||(t.borderColor=[0,0,0,0]);const d=u.uv_transform.elements;null==t.mapping&&(t.mapping={}),t.mapping.slot=null,t.mapping.uvTransform=new Array(16),new e.Matrix4(d[0],d[3],0,d[6],d[1],d[4],0,d[7],0,0,1,0,0,0,0,1).flattenToArray(t.mapping.uvTransform),t.mapping.operator={},t.mapping.operator.type=s[u.type],u.object_transform&&(t.mapping.operator.transform=new Array(16),u.object_transform.flattenToArray(t.mapping.operator.transform)),delete t.uvTransform})),t.header.generator+=" / Rma3DSIParser"})(i,n),n.applyAfterImport=!1):(P(i,n),n.applyAfterImport=!0),{dxm:i,mappingInfo:n,domainId:p}}ProcessIndexAttributesForPreview(e,t){if(u&&console.info("[AC][PLMMaterialParser] Create Preview Material"),A(e),null==e||null==e.dxm)throw new Error("Invalid visAppearanceAttribute");const r=M(t,e),a={header:{content:"material",generator:"Rma3DSIParser",version:"3.2"},materials:[{type:"DSPBR 2025x",subtype:"Basic",metallic:{value:0},roughness:{value:.3}}]},n=e.dxm.materials?.[0]?.type??"";let i=null;if(n.startsWith("DSPBR"))i=e.dxm.materials?.[0]?.albedo;else{if("Physical"!==n)throw new Error("Unsupported type for preview");i=e.dxm.materials?.[0]?.diffuse}if(!i)return r.channels=[],{dxm:a,mappingInfo:r};if(null!=i.value)r.channels=[],a.materials[0].albedo=i;else{if(null==i.texture)throw new Error("Unexpected albedo parameter format in visAppearanceAttribute");{const t=e.dxm.textures[i.texture],n=e.dxm.images[t.image],s=e.dxm.binaries[n.binary],o=r?.channels?.[n.binary]??{};s.extUri&&"0"!=s.extUri?(i.texture=0,t.image=0,n.binary=0,o.id="albedo",a.materials[0].albedo=i,a.textures=[t],a.images=[n],a.binaries=[s],r.channels=[o]):u&&console.warn("[AC][PLMMaterialParser] Invalid PhysicalID for base color texture. Update the VisAppearanceAttribute!")}}return b(a),u&&null!=a.binaries&&(null==r.reference&&console.warn("[AC][PLMMaterialParser] We have textures but missing reference mapping values. Update the VisAppearanceAttribute!"),null==r.channels&&console.warn("[AC][PLMMaterialParser] We have textures but missing texture infos. Update the VisAppearanceAttribute!")),r.mappingType=r.connection.type??r.reference.type??-1,P(a,r),r.applyAfterImport=!0,{dxm:a,mappingInfo:r}}async ImportDecal(t){return this._textureLoader.SetSecurityParameters(t.securityParameters),new Promise(((r,i)=>{t.dxm?.textures?.length>0&&!t.securityParameters?i(new Error("Missing security parameters")):I({...t,onSuccess:i=>{const s=(t=>{let r={},i={},s={},o={};s.projectionMatrix=a.computeDecalProjectorMatrix(t.connection);const c=[t.metricDimU??t.channels?.[0]?.Width/1e3,t.metricDimV??t.channels?.[0]?.Height/1e3],p=a.computeDecalMappingTransform(t.connection,c);s.implicitScale=p.implicitScale,o.mappingUVTransformation=p.uvTransform;let l=t.connection.type;switch(t.connection.type){case a.CATMappingType.UV:l=a.CATMappingType.Planar;break;case a.CATMappingType.InfCylindrical:l=a.CATMappingType.Conical}o.mappingType=n.GetVisMappingType(l);const m=t.connection.type==a.CATMappingType.UV;let f=!1,d=!1;if(t.channels)for(let r of t.channels){const t=n.GetVisParamDesc(r.id);t?(t.hasUvTransform()&&!m&&(i[t.uvTransformId]=new e.Matrix3),"diffuse"===t.id?(f=!0,d=!0):"opacity"===t.id&&(f=!0,d=!1)):u&&console.warn("[AC][RenderingMaterial3DSIParser] Invalid ID for texture")}return r.alphaTest=f?.5:0,i.useAlphaFromDiffuseMap=d,{coreParameters:r,materialParameters:i,materialApplication:o,decalProjector:s}})(t.mappingInfo);for(const e in s?.coreParameters)i[e]=s.coreParameters[e];s?.materialParameters&&i.setPhysicalProperties(s.materialParameters),r({material:i,matrix:s?.decalProjector?.projectionMatrix??new e.Matrix4,decalImplicitScaleU:s?.decalProjector?.implicitScale?.x??1,decalImplicitScaleV:s?.decalProjector?.implicitScale?.y??1,decalProjector:s?.materialApplication?.mappingType??e.MappingType.CUBIC,decalUVTransform:s?.materialApplication?.mappingUVTransformation})},onError:e=>i(e),onLoadTexture:(e,t)=>this._LoadTexture(e,t)})}))}async ImportMaterial(t){if(this._textureLoader.SetSecurityParameters(t.securityParameters),d&&t.dxm?.binaries?.length>0&&t.dxm?.binaries?.length==t.mappingInfo?.channels?.length){const e=t.mappingInfo.channels,a=t.dxm.binaries;for(var r=0;r<a.length;r++)this.textureDataMap.set(a[r].extUri,e[r]),this.textureDomainMap.set(a[r].extUri,t.domainId),e[r]?.textureData?.streamKey?.startsWith("texLoD_")&&(t.dxm.images[r].format="ktx2",t.dxm.images[r].usage="RGB")}return new Promise(((r,i)=>{t.dxm?.textures?.length>0&&!t.securityParameters?i(new Error("Missing security parameters")):I({...t,onSuccess:i=>{const s=(t=>{if(null==t.channels)return null;if(!t?.applyAfterImport)return null;u&&console.debug("[AC][RenderingMaterial3DSIParser] Apply mapping directly on material");const r=a.computeApplicationMapping(t.reference,t.connection,t.mappingSemantic);let i={},s={};s.mappingType=n.GetVisMappingType(r.type),r.object_transform&&(s.mappingObjTransformation=r.object_transform),s.mappingUVTransformation=new e.Matrix3;for(let e of t.channels){const s=a.computeChannelMapping(t.reference,t.connection,e.mapping,e,t.mappingSemantic),o=a.combineMappingResults(r,s,t.mappingSemantic),c=n.GetVisParamDesc(e.id);c&&c.hasUvTransform()?i[c.uvTransformId]=o.uv_transform:u&&console.warn("[AC][RenderingMaterial3DSIParser] Invalid ID for texture")}return{coreParameters:{},materialParameters:i,materialApplication:s}})(t.mappingInfo);for(const e in s?.coreParameters)i[e]=s.coreParameters[e];s?.materialParameters&&i.setPhysicalProperties(s.materialParameters),s?.materialApplication&&i.setMappingOperator(s.materialApplication.mappingType,s.materialApplication.mappingObjTransformation,s.materialApplication.mappingUVTransformation,!0),r(i)},onError:e=>i(e),onLoadTexture:(e,t)=>this._LoadTexture(e,t)})}))}ParseMaterialFromIndex(e){if(!e)return null;const t=e["bo.dsc_matref_rep_rendering.visappearance"];if(!t)return null;let r=JSON.parse(t);return r.materialReferenceType=e["ds6w:type"],r}ParseConnectionFromIndex(e){if(!e)return null;const t=e;return{matrix:[t["ds6wg:catmatconnection.v_matrix_1"],t["ds6wg:catmatconnection.v_matrix_2"],t["ds6wg:catmatconnection.v_matrix_3"],0,t["ds6wg:catmatconnection.v_matrix_4"],t["ds6wg:catmatconnection.v_matrix_5"],t["ds6wg:catmatconnection.v_matrix_6"],0,t["ds6wg:catmatconnection.v_matrix_7"],t["ds6wg:catmatconnection.v_matrix_8"],t["ds6wg:catmatconnection.v_matrix_9"],0,t["ds6wg:catmatconnection.v_matrix_10"],t["ds6wg:catmatconnection.v_matrix_11"],t["ds6wg:catmatconnection.v_matrix_12"],1],mapType:t["bo.catmatconnection.v_mappingtype"],scale:t["bo.catmatconnection.v_scaleratio"],mapFocus:t["bo.catmatconnection.v_focusmode"],offset:[t["bo.catmatconnection.v_offsetu"],t["bo.catmatconnection.v_offsetv"]],repeat:[t["bo.catmatconnection.v_repeatu"],t["bo.catmatconnection.v_repeatv"]],angle:t["bo.catmatconnection.v_angle2d"],layer:t["bo.catmatconnection.v_layer"],isKindOf:t["ds6w:type"],matpen:t["matPen.jsonstreamstorage"]}}async _LoadTexture(e,t){if("0"===e)throw new Error("Invalid Physical ID");let r=null,a=null;try{const t="Substance_",n=this.textureDataMap.get(e),i=this.textureDomainMap.get(e);if(d&&n?.textureData?.streamKey&&i){r="ktx2";const e=encodeURIComponent(`${i}_'EXTENDED'.1=${n.textureData.streamKey}`).replace("%3D","=");a=await this._textureLoader.FetchTextureBuffer(i,e)}else if(e.includes(t)){const n=t.length,i=e.indexOf("_",n),s=e.substring(n,i),o=e.substr(i+1);r="png";const c=encodeURIComponent(`${s}_'EXTENDED'.1=${o}`).replace("%3D","=");a=await this._textureLoader.FetchTextureBuffer(s,c)}else{if(r=await this._textureLoader.FetchTextureMimeType(e),g.includes(r))return console.warn("[Rendering Material] Unsupported texture type : "+r),{buffer:null,mimeType:null};const t=encodeURIComponent(`${e}_''.1`);a=await this._textureLoader.FetchTextureBuffer(e,t)}}catch(e){throw new Error("Failed to load texture",{cause:e})}return{buffer:a,mimeType:r}}IsDecalReferenceType(e){return h(e)}}})),define("DS/RenderingMaterial3DSI/RenderingMaterial3DSIServices",["DS/WAFData/WAFData","DS/RenderingMaterial3DSI/RenderingMaterial3DSIParser"],(function(e,t){return new class{constructor(){}async FetchMaterialFromIndex(e){if(!e.physicalid)throw new Error("Missing physicalid");if(!e.securityParameters)throw new Error("Missing security parameters");const r=await this.FetchMaterialAttributesFromIndex({physicalid:e.physicalid,attributeNames:["ds6w:type","bo.dsc_matref_rep_rendering.visappearance"],securityParameters:e.securityParameters}),a=t.ParseMaterialFromIndex(r);if(!a)throw new Error("Missing VisAppearanceAttribute");return e.createPreview?t.CreatePreviewMaterial({visAppearanceAttribute:a,securityParameters:e.securityParameters}):t.CreateMaterial({visAppearanceAttribute:a,securityParameters:e.securityParameters})}async FetchMaterialAttributesFromIndex(t){if(!t.physicalid)throw new Error("Missing physicalid");if(!t.securityParameters)throw new Error("Missing security parameters");if(!t.attributeNames)throw new Error("Missing attribute names");const r=`${t.securityParameters.userLogin}-RenderingMaterial-${(new Date).getTime()}`,a=`${`${t.securityParameters.service3DSpaceUrl}/cvservlet/fetch/v2`}?tenant=${t.securityParameters.tenant}`;return new Promise(((n,i)=>{e.authenticatedRequest(a,{method:"POST",proxy:"passport",type:"json",responseType:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},data:JSON.stringify({label:r,physicalid:[t.physicalid],locale:"en",tenant:t.securityParameters.tenant,select_predicate:t.attributeNames}),onComplete:e=>{let t={};for(const r of e?.results?.[0]?.attributes)t[r.name]=r.value;n(t)},onFailure:e=>{i(e)},onTimeout:()=>{i(new Error("Requests timed out while fetching material attribues"))}})}))}}}));