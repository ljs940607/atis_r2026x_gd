var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebDocManager/VCXERessourceURLAsset",["require","exports","DS/VCXWebComponents/WebExtensionBaseExperience"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{async getURL(){let e=this.QueryInterface("CATI3DXURLResourceAsset");if(!e)throw new Error("Invalid extension");return await e.getURL()}async updateAsset(e,t){var r=this.GetObject()?._experienceBase.getManager("VCXContextManager").getRootComponent(),a=r?.QueryInterface("CATICXPResourcesMgr");a&&await a.UpdateURLResource(this,e)}}return a})),define("DS/VCXWebDocManager/VCXIRessourceAsset",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebDocManager/VCXERessourceKeyFramerAsset",["require","exports","DS/VCXWebComponents/WebExtensionBaseExperience"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{async getURL(){let e=this.QueryInterface("CATI3DXKeyframerResourceAsset");if(!e)throw new Error("Invalid extension");return await e.getKey()}async updateAsset(e,t){var r=this.GetObject()?._experienceBase.getManager("VCXContextManager").getRootComponent(),a=r?.QueryInterface("CATICXPResourcesMgr");a&&await a.UpdateURLResource(this,e)}}return a})),define("DS/VCXWebDocManager/VCXDocManager",["DS/CoreEvents/Events","UWA/Class","DS/VCXWebProperties/VCXPropertyValuePath","DS/VCXWebProperties/VCXPropertyValueInt","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebProperties/VCXPropertyValueLink","DS/VCXWebProperties/VCXPropertyValueDocId","DS/VCXWebProperties/VCXPropertyValueHyperlinkId","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties","DS/VCXWebExperienceBase/VCXComponentCreationHelper"],(function(e,t,r,a,n,i,s,o,c,u,l){"use strict";var p=t.extend({initialize:function(){this._map=[],this._defaultImageIdx=-1,this.actorDocManager=null,this._initializingResMan=!1,this._promisesMap={},this._unInitialize=!1},_addUrl:function(e,t){var s=new r,o=0;if(-1!=e.search("KeyFramer://")&&(e=e.substring(12)),-1!=e.search("play://"))o=0;else if(-1!=e.search("scenario://"))o=0;else if(-1!=e.search("GoToScenario://")){o=1;var u=e.substring(15);(l=new i).SetValue(u),s.SetValueLink(l),e=""}else if(-1!=e.search("PlayFromMarker://")){o=2;u=e.substring(17);(l=new i).SetValue(u),s.SetValueLink(l),e=""}else if(-1!=e.search("PlayScenario://")){o=2;u=e.substring(15);(l=new i).SetValue(u),s.SetValueLink(l),e=""}else if(-1!=e.search("GoToMarker://")){o=3;u=e.substring(13);(l=new i).SetValue(u),s.SetValueLink(l),e=""}else if(-1!=e.search("PlayUntilMaker://[Current position]"))o=4,e="[Current position]";else if(-1!=e.search("PlayMakerSequence://")){o=4;u=e.substring(20);(l=new i).SetValue(u),s.SetValueLink(l),e=""}else if(-1!=e.search("PlayScenarioUntilMaker://")){o=4;var l;u=e.substring(25);(l=new i).SetValue(u),s.SetValueLink(l),e=""}var p=new a;p.SetValue(o),s.SetPathType(p);var g=new c;g.SetValue(!0),s.SetValueBool(g);var f=new n;f.SetValue(e),s.SetValueURL(f),this.AddOrModifyDoc(s,void 0,parseInt(t))},addResourcesFromResManager:async function(e){const t=e.QueryInterface("CATI3DExperienceObject");if(!t)throw new Error("ERROR : CATI3DExperienceObject for resource");{const r=t.GetValueByName("_varName");if(isNaN(parseInt(r)))return;let a=e.QueryInterface("VCXIRessourceAsset");if(!a)throw new Error("Illegal Argument");const n=await a.getURL();this._addUrl(n,r)}},initFromResourcesManager:async function(){this._initializingResMan=!0,console.log("Initialization of DocManager from ResourceManager");var e=[],t=this._experienceBase.getManager("VCXContextManager").getRootComponent().QueryInterface("CATICXPResourcesMgr");if(t){var r=t.ListResources();console.log("NbRes in ResManager :"+r.length);for(var a=0;a<r.length;a++)e.push(this.addResourcesFromResManager(r[a]))}else console.log("CATICXPResourcesMgr FAILED");await UWA.Promise.allSettled(e),this._initializingResMan=!1},initActorDocManager:async function(){this.actorDocManager||(console.log("First creation a ActorDocManager"),this._experienceBase.getManager("VCXContextManager").IsLocalMode()||(this.actorDocManager=await l.CreateComponent(this._experienceBase,"VCXActorDocManager",void 0),this.actorDocManager.QueryInterface("VCXIModifiable").GetProperties()))},unInitialize:function(){this._map=[],this._defaultImageIdx=-1,this._initializingResMan=!1,this._promisesMap={},this._unInitialize=!0},postInitialize:function(){},SetDefaultImageIndex:function(e){this._defaultImageIdx=e},GetDefaultImageIndex:function(){return this._defaultImageIdx},AddOrModifyDoc:function(t,r,a,n){if(null!==t){var i=this.AddOrModifyDocInt(t,r,a,n),o=new s;return o.SetValue(i),e.publish({event:"VCX_DOC_ADDED",data:{docID:i}}),o}console.log("DocManager::AddOrModifyDoc vcxPropPath NULL !!")},AddOrModifyDocInt:function(e,t,r,a){var n=this.HasDocInt(e),i=0;if(n>=0)i=n;else{if(void 0!==r&&r>=0)i=r;else for(;this._map[i];)i++;this._map[i]=e}if(this.actorDocManager)if(this._experienceBase.getManager("VCXContextManager").IsLocalMode()||!this._experienceBase.getManager("VCXContextManager").getUseResourcesManager())this.actorDocManager.AddDocToBase64Map(i,e,t);else if(!this._initializingResMan){if(a)return this.UpdatePersistentResourcesToEMS().then((function(){return i}));this.UpdatePersistentResourcesToEMS()}return a?UWA.Promise.resolve(i):i},RemoveDocument:function(e){delete this._map[e],this.actorDocManager&&this.actorDocManager.RemoveDocument(e)},AddOrModifyHyperlink:function(t){var r=new o;if(null!==t){var a=this.AddOrModifyDocInt(t);r.SetValue(a),e.publish({event:"VCX_DOC_ADDED",data:{docID:a}})}else r.SetValue(-1);return r},HasDocInt:function(e){for(var t=-1,r=!1,a=0;a<this._map.length&&!r;a++){var n=this._map[a];e&&e.IsEqualTo(n)&&(r=!0,t=a)}return t},GetPropPath:function(e){return this._map[e]},IsEmpty:function(){return!(this._map.length>0)},NumberOfDoc:function(){return this._map.length},BuildPathFromString:function(e,t){if("string"==typeof e){var i=new r,s=new a;s.SetValue(0),i.SetPathType(s);var o=new n;if(o.SetValue(e),i.SetValueURL(o),e.indexOf("blob:")>=0){t||(t="");var c=new n;c.SetValue(t),i.SetFileName(c)}return i}console.log("DocManager: strData is empty !!")},BuildPathFromLink:function(e,t){var n=null;if(!e)return n;var s=new i;s.SetValue(e);var o=new a,c=1;return t&&(c=t),o.SetValue(c),(n=new r).SetPathType(o),n.SetValueLink(s),n},AddFileNameToDoc:function(e,t){if("undefined"!==e&&t){t.indexOf(".")<0&&(t="."+t);var r=e+t,a=this._map[e],i=a.GetFileName();i||(i=new n),i.SetValue(r),a.SetFileName(i)}},GetDocMapClone:function(){var e={};for(var t in this._map)if(this._map.hasOwnProperty(t)){var r=this._map[t];e[t]=r.Clone()}return e},_updateResourceToEMS:async function(e,t){var r=this._experienceBase.getManager("VCXContextManager").getRootComponent().QueryInterface("CATICXPResourcesMgr");if(t.GetValueBool().GetValue()){var a="";t.GetFileName()&&(a=t.GetFileName().GetValue());var n,i=a.split(".").pop();""==i&&(i="jpg"),i=i.toLowerCase();var s=t.GetValueURL().GetValue();if(s.indexOf("blob:")>=0)n="CXPPictureResource_Spec";else{var o=t.GetPathType().GetValue();if(0==o)(-1!=(s=t.GetValueURL().GetValue()).search("play://")||-1!=s.search("scenario://"))&&(s="KeyFramer://"+s);else if(1==o)s="KeyFramer://GoToScenario://"+t.GetValueLink().GetValue();else if(2==o){var c=t.GetValueLink().GetValue();(u=this._experienceBase.ComponentsMap.GetComponentFromID(c))?s="VCXComponentMarker"==u.GetType()?"KeyFramer://PlayFromMarker://"+c:"KeyFramer://PlayScenario://"+c:console.log("warning : scenario or marker unknown")}else if(3==o)s="KeyFramer://GoToMarker://"+t.GetValueLink().GetValue();else if(4==o){var u;if(""==(c=t.GetValueLink().GetValue()))s="KeyFramer://PlayUntilMaker://[Current position]";else(u=this._experienceBase.ComponentsMap.GetComponentFromID(c))?s="VCXComponentMarker"==u.GetType()?"KeyFramer://PlayMakerSequence://"+c:"KeyFramer://PlayScenarioUntilMaker://"+c:console.log("warning : scenario or marker unknown")}n=-1!=s.search("KeyFramer://")?"CXPKeyframerResource_Spec":"CXPURLResource_Spec"}var l=e.toString(),p=r.GetResourceByName(l);if(p&&p.GetType()!=n&&(await r.DeleteResource(p),p=null),p){let e=p.QueryInterface("VCXIRessourceAsset");if(!e)throw new Error("Illegal Argument");await e.getURL()!==s&&await e.updateAsset(s,i)}else await this.CreateRessouce(n,l,s,i)}},UpdateResoucesToEMS:async function(e){var t=this.GetPropPath(e);t&&(this._promisesMap[e]=!0,await this._updateResourceToEMS(e,t),delete this._promisesMap[e])},CreateRessouce:async function(e,t,r,a){var n=this._experienceBase.getManager("VCXContextManager").getRootComponent().QueryInterface("CATICXPResourcesMgr");try{if("CXPPictureResource_Spec"===e)await n.CreateBinaryResource(t,r,a,!0);else await n.CreateURLResource(t,r)}catch(r){throw console.log("CreateResource FAIL: "+e+" "+t),r}},RemoveResourcesFromResMan:function(){for(var e=[],t=this._experienceBase.getManager("VCXContextManager").getRootComponent().QueryInterface("CATICXPResourcesMgr"),r=t.ListResources(),a=0;a<r.length;a++){var n=r[a],i=n.QueryInterface("CATI3DExperienceObject");if(i){var s=i.GetValueByName("_varName"),o=parseInt(s);this.GetPropPath(o)||e.push(t.DeleteResource(n))}}return UWA.Promise.allSettled(e)},UpdateResourcesManagerToEMS:async function(){if(this._experienceBase.getManager("VCXContextManager").getRootComponent().QueryInterface("CATICXPResourcesMgr")){console.log("updating resource manager"),await this.RemoveResourcesFromResMan();for(var e=[],t=this.NumberOfDoc(),r=0;r<t;r++)this._promisesMap[r]||e.push(this.UpdateResoucesToEMS(r));return UWA.Promise.allSettled(e)}var a=new Error("No ResourceManager !! CATICXPResourcesMgr failed : check your dictionnary");return console.error(a),UWA.Promise.reject(a)},RemoveActorDocManagerNeutrals:function(){var e=this.actorDocManager;if(e){var t=e.QueryInterface("VCXIModifiable");console.log("capturing neutral properties of actorDocManager"),this._experienceBase.getManager("VCXContextManager").IsLocalMode()||!this._experienceBase.getManager("VCXContextManager").getUseResourcesManager()||this._experienceBase.getManager("VCXScenarioManager").RemoveNeutrals(t.GetHashing());var r=new u(this._experienceBase);r.CaptureNeutralProperties(t),r.Do()}},UpdatePersistentResourcesToEMS:async function(){if(this._experienceBase.getManager("VCXContextManager").getUseResourcesManager()){var e=this.QueryInterface("VCXIReadiness");if(this.updateFunction)return this.updateFunction;this.updateFunction=new Promise((async(e,t)=>{try{if(!this._experienceBase.isValid)return void e();if(await this.UpdateResourcesManagerToEMS(),!this._experienceBase.isValid)return void e();this.RemoveActorDocManagerNeutrals()}catch(e){return void t(e)}e()})),e&&e.registerPromise(this.updateFunction),await this.updateFunction,this.updateFunction=null}}});return Object.defineProperty(p.prototype,"componentType",{enumerable:!0,get:function(){return"VCXDocManager"}}),p})),define("DS/VCXWebDocManager/VCXInteractableObjectsManager",["UWA/Class","DS/VCXWebModifiablesServices/VCXModifiablesServices","DS/VCXWebModifiables/VCXModelChangeListener","DS/VCXWebVisibility/VCXIVisibility"],(function(e,t,r,a){"use strict";var n=e.extend({initialize:function(){this._registredInteractableObjects=[],this._bActiveInteraction=!1,this._dirty=!1,this._sorted=!1},GetActiveInteraction:function(){if(this._experienceBase.getManager("VCXModelChangeListener")&&this._dirty){this._dirty=!1,this._sorted=!1,this._bActiveInteraction=!1;for(var e=0;e<this._registredInteractableObjects.length;e++){var t=this._experienceBase.ComponentsMap.GetComponentFromID(this._registredInteractableObjects[e]);if(t)if("VCXComponentHotspot"===t.GetType()){if(t.QueryInterface("VCXIModifiable").GetProperty("Actor.Enable").GetPropertyValue().GetValue()){this._bActiveInteraction=!0;break}}else{var r=t.QueryInterface("VCXIVisibility");if(r&&r.GetVisibility()!==a.EVisState.Hidden){var n=t.QueryInterface("VCXIModifiable").GetProperty("Actor.Opacity");if(n&&n.GetPropertyValue()&&n.GetPropertyValue().Value){this._bActiveInteraction=!0;break}}}}}return this._bActiveInteraction},update:function(e){var t=this._experienceBase.getManager("VCXModelChangeListener");t&&t.hasChanged(r.FChangeFlag.Visibility)&&(this._sorted=!1,this._dirty=!0)},RegisterInteractableObject:function(e){this._registredInteractableObjects.push(e.GetID()),this._sorted=!1,this._dirty=!0},UnRegisterInteractableObject:function(e){var t=this._registredInteractableObjects.indexOf(e.GetID());t>-1&&(this._registredInteractableObjects.splice(t,1),this._dirty=!0)},GetSortedInteractableObjects:function(){return this._sorted||(this._registredInteractableObjects=t.sortListDisplayPriority(this._experienceBase,this._registredInteractableObjects),this._sorted=!0),this._registredInteractableObjects}});return Object.defineProperty(n.prototype,"componentType",{enumerable:!0,get:function(){return"VCXInteractableObjectsManager"}}),n}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebDocManager/VCXERessourcePictureAsset",["require","exports","DS/VCXWebComponents/WebExtensionBaseExperience"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{async getURL(){let e=this.QueryInterface("CATI3DXPictureResourceAsset");if(!e)throw new Error("Invalid extension");return(await e.getPicture()).src}async updateAsset(e,t){var r=this.GetObject()?._experienceBase.getManager("VCXContextManager").getRootComponent(),a=r?.QueryInterface("CATICXPResourcesMgr");if(a)try{await a.UpdateBinaryResource(this,e,t,!0)}catch(e){console.log(e)}}}return a})),define("DS/VCXWebDocManager/VCXHyperlinkManagerBase",["DS/VCXWebDocManager/VCXInteractableObjectsManager","DS/VisuEvents/EventsManager","DS/VCXWebVisu/VCXModifiablesAccess"],(function(e,t,r){"use strict";var a=e.extend({init:function(){this._strEventToListen=""},initialize:function(){this._parent()},postInitialize:function(){var e=this;this.onVisuEvent=function(t){if(e.GetActiveInteraction()){var a=r.GetModifiableFromEvent(t,e._experienceBase);if(a){var n=a.GetObject().GetID();e._experienceBase.getManager("VCXAPIManager").ActivateHyperlink(n)}}},this._strEventToListen&&t.addEvent(this._experienceBase.getManager("VCXContextManager").getMainViewer().div,this._strEventToListen,this.onVisuEvent)},unInitialize:function(){this._parent();let e=this._experienceBase.getManager("VCXContextManager");e&&e.getMainViewer()&&t.removeEvent(this._experienceBase.getManager("VCXContextManager").getMainViewer().div,this._strEventToListen,this.onVisuEvent),this._strEventToListen=""},OpenHyperlink:function(e){},_getHyperlinkInfos:function(e){var t=null;e&&(t=this._getPropertyPathFromModifiable(e));var r={};return t&&(r=this._getHyperlinkInfosFromProperty(t)),r},_getPropertyPathFromModifiable:function(e){if(e){var t=null,r=-1,a=e.GetProperty("Actor.Hyperlink"),n=!1;if(a){var i=a.GetPropertyValue();(r=parseInt(i.GetValue(),10))>=0&&(n=!0)}if(n){var s=this._experienceBase.getManager("VCXDocManager");s&&(t=s.GetPropPath(r))}return t}},_getHyperlinkInfosFromProperty:function(e){var t={},r=-1;e&&(r=e.GetPathType().GetValue());0===r&&(t={url:e.GetValueURL().GetValue(),filename:e.GetFileName().GetValue()});return t},BuildPropertyForHyperlink:function(e,t){var r=-1,a="";t.indexOf("blob:")<0?r=0:a=t.toLowerCase(),a.indexOf("http")>=0&&(r=0);var n=!1;if(0===r){n=!0;var i=this._experienceBase.getManager("VCXDocManager").BuildPathFromString(t,"");t=this._experienceBase.getManager("VCXDocManager").AddOrModifyHyperlink(i).GetValue()}return n||(t=e.GetProperty("Actor.Hyperlink").GetPropertyValue().GetValue()),t}});return Object.defineProperty(a.prototype,"componentType",{enumerable:!0,get:function(){return"VCXHyperlinkManagerBase"}}),a}));