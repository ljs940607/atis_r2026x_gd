define("DS/3DPlayRequirementExperience/3DPlayRequirementExperience",["require","exports","DS/3DPlayExperienceModule/PlayExperience3D","DS/CATWebUXComponents/DMUCommandsManager","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/CATWebUXUtils","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/3DPlay/3DPlay","DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/WebDocumentVisualization/WebDocumentBookmarksController"],(function(e,t,n,i,o,a,r,l,s,u,d,c,p,m,y,h){"use strict";let D;return class extends n{constructor(e){e.commandApplication=!1,e.workbenchs=e.workbenchs||[],e.options.pad3DViewer||e.workbenchs.push({name:"3DPlayRequirementExperience",module:"3DPlayRequirementExperience"}),super(e);let t,n,g,C,f,b,w,S,v,x,P,V=this,A=!0,R=!1,E={};function T(){if(R)return;R=!0;let e=function(){var e,n;let o=i.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",V.pad3DViewer.getCommandContext());o&&(t&&(null===(e=t.getDocumentBookmarks())||void 0===e?void 0:e.length)?o.enable():o.disable(),"false"!==localStorage.getItem("DMUBookmarksPanelDisplayed")&&(null===(n=null==t?void 0:t.getDocumentBookmarks())||void 0===n?void 0:n.length)&&o.setState(!0));let a=null==t?void 0:t.getDocumentLength();o=i.getCommand("WebDocumentNextPageCmdHdr",V.pad3DViewer.getCommandContext()),o&&(a&&a>1?o.enable():o.disable()),o=i.getCommand("WebDocumentPreviousPageCmdHdr",V.pad3DViewer.getCommandContext()),o&&(a&&a>1?o.enable():o.disable()),R=!1},n={lastCommand:[],currentCommand:null,defaultCommand:null},o=V.pad3DViewer.getCommandContext();o?i._commandsState[o]=n:i._commandsState=n,i.resetDefaultCommand(o),i._isCommandEnding=!1,i._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach((function(e){let t=o&&i[e]?i[e][o]:i[e];t&&Object.keys(t).forEach((function(e){let n=t[e];n&&n._destroy&&n._destroy(),delete t[e]}))}));let a=V.pad3DViewer.getFrameWindow().getActionBar(),r=a.onActionBarReady((function(){a.removeCallback(r),setTimeout(e,500)}));V.pad3DViewer.loadActionBar({file:"3DPlayRequirementExperience.xml",module:"3DPlayRequirementExperience"})}function I(){m.displayFatalError({ctx:V.ctx,msg:"It does not contain any element"},{name:"ReqSpecEmpty"}),V.clearView()}function W(e){if(e){let t=e.visibleElements[0].title;f.displaySlideInformation({fontIcon:"wux-ui-3ds-docs",message:t,secondary:""})}}function k(e){t&&t.isADocumentDisplayed()&&(t.centerViewpointAtNextOrPreviousElement("next"===e),W(t.getElementsVisualizationData()))}function q(){if(!f){let e;f=r.getSlideShowController({context:V.pad3DViewer.getFrameWindow(),id:"3DPlayRequirementExpSlideShow"}),f.setListOfCommandsAllowed(["WebDocumentFitAllInCmdHdr","WebDocumentFitWidthCmdHdr","WebDocumentPreviousPageCmdHdr","WebDocumentNextPageCmdHdr"]),S={onPreviousSlideCB:f.subscribe("onPreviousSlideCB",(function(){k("previous")})),onNextSlideCB:f.subscribe("onNextSlideCB",(function(){k("next")})),onActiveStateModified:f.subscribe("onActiveStateModified",(function(i){if(t)if(A=!i.state,n&&n.setPanelVisibilityFlag(!i.state),t.enableTextSelection(!i.state),i.state){i.onBeginSlideShow(!0),l.empty(),s.empty(),u.empty();let n=V.pad3DViewer.getViewer();e={activated:n.getManipulators(),preActivate:n.manipulatorManager.preActivation},n.setManipulators({activated:!1,preActivate:!0}),W(t.getElementsVisualizationData()),b=t.subscribe("onCurrentElementChange",(function(){t&&W(t.getElementsVisualizationData())}))}else b&&t.unsubscribe(b),b=null,V.pad3DViewer.getViewer().setManipulators(e)}))}}}function O(e,t){return new Promise((n=>{C&&C[e]?n(C[e]):d.authenticatedRequest(t,{proxy:"none",type:"blob",timeout:18e4,onComplete:function(t){let i=new FileReader;i.onload=function(){C||(C={}),C[e]=i.result,n(C[e])},i.readAsDataURL(t)},onFailure:function(){n(t)},onTimeout:function(){n(t)}})}))}function _(e){return new Promise(((t,n)=>{d.authenticatedRequest(c.get3DSpaceUrl()+"/resources/trm/streaming/structure/"+e.phyId,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e.securityContext},timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})}))}D=null;const M=function(e){let t=document.createElement("textarea");return t.innerText=e,t.innerHTML};async function L(e){let i=e.parentElement?[e.parentElement]:[],o=[],a=[],r=function(e){let t="";for(let n=1;n<=e&&o[n];n++)1!==n&&(t+="."),t+=o[n];return t};const l={0:e.phyId};for(let t=1;t<e.dataObj.length;t++){const n=e.dataObj[t],s=parseInt(n.level),u="/";l[s]=`${l[s-1]}${u}${n["physicalid[connection]"]}${u}${n.physicalid}`,E[n.type]||(E[n.type]=n["type.kindof"]);let d={pathId:l[s],typeIconUrl:await O(n["type.kindof"],n.type_icon_url),level:s,type:n["type.kindof"],title:"",chapterLevelTag:"",subLevelTag:""};if(a.length-1>d.level&&(a=a.slice(0,d.level+1)),a[n.level]?a[n.level]++:a[n.level]=1,"Chapter"===n["type.kindof"])o[n.level]?o[n.level]++:o[n.level]=1,o.length-1>d.level&&(o=o.slice(0,d.level+1)),d.content=n["attribute[Title]"],d.title=n["attribute[Title]"],d.type=n["type.kindof"],d.chapterLevelTag=r(d.level),d.fontSize=34-2*d.level;else if("Comment"===n["type.kindof"]||"Requirement"===n["type.kindof"]){d.content=n.content,d.title=n["attribute[Title]"].escapeHTML(),d.type=n["type.kindof"],"1"===n.level?d.chapterLevelTag="0":d.chapterLevelTag=r(d.level-1)||"0";let e="",t=Math.max(0,o.length-1>=d.level?d.level-1:o.length-1);for(let n=t+1;n<=d.level;n++)n!==t+1&&(e+="."),a[n]||(a[n]=1),e+=a[n];d.subLevelTag=e}i.push(d)}i.length?t&&t.loadDocumentStream({type:"Requirement",phyId:e.phyId,fatherNode:V.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),elementsToLoad:i,onComplete:()=>{!w&&t&&(w=t.subscribe("onElementSelection",(function(e){e&&i.length>1&&x!==e&&(x=void 0,P&&P.select({paths:[e.split("/")]}))}))),T(),q(),n||(n=h.getWebDocumentBookmarksController({context:V.pad3DViewer}))},onFailure:I}):I()}function U(e){var t,n;(t=e,n=p.getSetting("pad_security_ctx"),new Promise((function(e,i){let o=encodeURI(`${c.get3DSpaceUrl()}/resources/trm/dictionary/info?pid=${t}&select=type,attribute[Content Data],attribute[Title]`);d.authenticatedRequest(o,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:n},timeout:6e4,onComplete:function(n){let o=JSON.parse(n);o&&"success"===o.status&&o.results[0]?e({phyId:t,connectionId:o.results[0]["physicalid[connection]"],content:M(o.results[0]["attribute[Content Data]"]||""),title:o.results[0]["attribute[Title]"].escapeHTML(),type:o.results[0].type.value}):i(new Error("Requirement has no content"))},onFailure:function(){i(new Error("Requirement content Request Failed"))},onTimeout:function(){i(new Error("Requirement content Request Timeout"))}})}))).then((function(t){"Requirement"===t.type||E&&"Requirement"===E[t.type]?V.pad3DViewer.getController().getAttributes({ids:[e],attributes:["type_icon_url"],callbacks:{onComplete:function(n){O("Requirement",n[e].type_icon_url).then((e=>{let n={pathId:t.phyId,content:t.content,title:t.title,type:"Requirement",typeIconUrl:e,level:0,chapterLevelTag:"0",subLevelTag:"0"};n.typeIconUrl=e,_({phyId:t.phyId,securityContext:p.getSetting("pad_security_ctx")}).then((e=>{L({phyId:t.phyId,parentElement:n,dataObj:e,securityContext:p.getSetting("pad_security_ctx")})}),I)}))},onFailure:I}}):_({phyId:t.phyId,securityContext:p.getSetting("pad_security_ctx")}).then((e=>{L({phyId:t.phyId,dataObj:e,securityContext:p.getSetting("pad_security_ctx")})}),I)}),I)}function F(e){if(e.path){let t=window.require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices");if(t){let n=e.path.getLastElement(!0),i=t.getNodeID(n)||n&&"string"==typeof n.persistentId&&n.persistentId||n&&n.getID&&n.getID(),o=t.getNodeType(n)||n&&n.getType&&n.getType();"Requirement"!==o&&"Requirement Specification"!==o||U(i)}}}this.internalLoad=function(e){var n;e&&(P||window.require(["DS/PADUtils/PADCommandProxy"],(e=>{P=e.create({events:{onSelect:function(e){if(t&&e&&e.paths&&e.paths.length&&e.paths[0].length){let n=e.paths[0]?e.paths[0].join("/"):void 0;n&&(x=n,t.setCurrentElement({elementID:n,duration:200}))}}}})})),(n=e.asset.dtype,new Promise(((e,t)=>{let i={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":p.getSetting("lang"),SecurityContext:p.getSetting("pad_security_ctx")},data:JSON.stringify({sType:n}),onComplete:t=>{let n=JSON.parse(t);e(n.parentTypes)},onFailure:t},o=encodeURI(`securityContext=${p.getSetting("pad_security_ctx")}&tenant=${c.getPlatformId()}`);d.authenticatedRequest(`${c.get3DSpaceUrl()}/resources/markup/service/getParentTypes?${o}`,i)}))).then((n=>{const i=["Requirement","Requirement Specification"];let o=e.asset.dtype;if(i.some((e=>{let t=n.indexOf(e);if(-1!==t)return o=n[t],!0})),i.includes(o)){if(E[e.asset.dtype]||(E[e.asset.dtype]=o),v={id:e.asset.physicalid,type:o},v.id){g=V.pad3DViewer.subscribe({event:"onRootAdded"},F),t||(t=y.getWebDocumentVisualizationController({context:V.pad3DViewer}));let e=v.type,n=v.id;V.pad3DViewer.setAutomaticReframePolicy(!1);let i=V.pad3DViewer.options.visuProgressiveTileModel?[{rootID:n,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:n,"ds6w:type":e,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:n,"ds6w:type":e,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]}}]:[{rootID:n,structure:{rootId:e,results:[{attributes:[{name:"did",value:n},{name:"physicalid",value:n},{name:"ds6w:type",value:e}]},{path:[n]}]}}];V.pad3DViewer.loadJSON({data:i})}}else I()}),I))},this.internalClear=function(e){if(P&&(P.destroy(),P=null),V.pad3DViewer&&g&&V.pad3DViewer.unsubscribe(g),S){Object.keys(S).forEach((e=>{f&&S&&f.unsubscribe(S[e])}))}f&&r.unreferenceSlideShowController({context:V.pad3DViewer.getFrameWindow(),id:"3DPlayRequirementExpSlideShow"}),e&&(t&&y.unreferenceWebDocumentVisualizationController({context:V.pad3DViewer}),n&&h.unreferenceWebDocumentBookmarksController({context:V.pad3DViewer})),f=t=n=g=null},this.internalDispose=function(e){w&&t&&t.unsubscribe(w),w=null,V.frmWindow.getContextualUIManager().unregister("3DPlayRequirementExperience"),V.internalClear&&V.internalClear("ENOR3D_AP"!==e),v=null},this.internalRefresh=function(){v&&(V.internalClear(!0),V.internalLoad({asset:{physicalid:v.id,dtype:v.type}}))},this.internalPostCreate=function(){V.frmWindow.getContextualUIManager().register({subscriberId:"3DPlayRequirementExperience",workbenchName:"3DPlayRequirementExperience",context:V.pad3DViewer.getCommandContext(),cmdPrefix:"",fileName:"3DPlayRequirementExperience.xml",module:"3DPlayRequirementExperience",onContextualMenuReady:function(e,t){let n=[];if(A&&t&&t.XmousePosition){let e=new o.Vector2(t.XmousePosition,t.YmousePosition),i=V.frmWindow.getViewer().getMousePosition(e);0===V.frmWindow.getViewer().pick(i,"mesh",!0).path.length&&(a.isMobile()||(n=[{line:1,name:"3DPlayReqExpDisplaySubMenu",resourceFile:"WebDocumentVisualizationCommands/WebDocumentVisualizationCommands",hdr_list:["VisuQMCommand"]}]),n=n.concat([{line:1,name:"3DPlayReqExpAmbiencesSubMenu",resourceFile:"WebDocumentVisualizationCommands/WebDocumentVisualizationCommands",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]))}return{cmdList:n}}})},this.subscribe("ASSET/LOADINGFINISHED",(function(){q(),t||(t=y.giveWebDocumentVisualizationController({context:V.pad3DViewer})||null),n||(n=h.giveWebDocumentBookmarksController({context:V.pad3DViewer})||null),g||(g=V.pad3DViewer.subscribe({event:"onRootAdded"},F)),T()}),!0)}clearView(){this.internalClear&&this.internalClear(!0),super.clearView()}onPostCreate(){window.widget.setMetas({helpPath:"3DPlayRequirementExperience/assets/help"}),window.widget.dispatchEvent("onPlayExperienceReady",[{pad3DViewer:this.pad3DViewer}]),this.internalPostCreate&&this.internalPostCreate()}dispose(e){window.widget.setMetas({helpPath:void 0}),this.internalDispose&&this.internalDispose(D||""),D=null,super.dispose(e)}refresh(){return this.internalRefresh&&this.internalRefresh(),!0}loadAsset(e){e&&e.asset&&e.asset.physicalid&&this.internalLoad&&(this.clearView(),this.internalLoad(e))}acceptSwitch(e){let t=!1;return e&&e.options&&e.options.id&&(D=e.options.id,"ENOR3D_AP"===D&&(t=!0)),t}}}));