define("DS/DocumentWebEdition/Actions/OfficeWebEditorSave",["UWA/Core","i18n!DS/DocumentWebEdition/assets/nls/DocumentWebEdition"],(function(e,t){"use strict";var o=function(e){return{id:"editorsave",dataElements:{typeRepresentation:"functionIcon",icon:{iconName:"floppy",fontIconFamily:1},label:t.get("WebEditorSave"),tooltip:t.get("WebEditorSave"),position:"far",category:"stable area",value:function(t){t.options=e,o.execute(t)},visibleFlag:!0},execute:function(){o.execute({options:e})},updateForSelection:function(t,o){t({visibleFlag:1==e.getSelectedNodes().length})}}};return o.execute=function(e){e.options.ctrl.saveOfficeEditorFile()},o})),define("DS/DocumentWebEdition/Actions/OfficeWebEditorClose",["DS/UIKIT/Modal","DS/DocumentCommands/Helper","i18n!DS/DocumentWebEdition/assets/nls/DocumentWebEdition"],(function(e,t,o){"use strict";var i=function(e){return{id:"OfficeWebEditorClose",dataElements:{docV2Preview:!0,typeRepresentation:"functionIcon",icon:{iconName:"close",fontIconFamily:1},label:o.get("Close"),tooltip:o.get("Close"),position:"far",category:"stable area",priority:10,value:function(t){t.options=e,i.execute(t)},visibleFlag:!0},execute:function(){i.execute({options:e})},updateForSelection:function(t,o){t({visibleFlag:1==e.getSelectedNodes().length})}}};return i.execute=function(n){var s=n.options.ctrl;n.options.events.publish({event:"close-webeditor"});var a=n.options.getDocumentKeyToUse();""!=a?t.IsWebEditionDocumentSessionActive(n.options.platformUrls.platformId,a).then((t=>{if(t&&t.is_modified){var l='<div style="display: flex;"><span class="fonticon fonticon-attention text-warning fonticon-2x"></span><p style="margin-left: 10px; white-space: pre-line">'+o.get("WebEditorConfirmMessageOnClose")+"</p></div>",r=new e({className:"site-reset",header:o.get("SaveDocument"),body:l,footer:'<button type="button" value="save" class="btn btn-primary">'+o.get("WebEditorSave")+'</button> <button type="button" value="closewithoutsave" class="btn btn-default">'+o.get("WebEditorCloseWithoutSave")+'</button><button type="button" value="cancel" class="btn btn-default">'+o.get("Cancel")+"</button>",animate:!0,resizable:!0,autocenter:!0,visible:!0,limitParent:!0,overlay:!0,closable:!1});r.show(),r.elements.container.setStyle("z-index","50000"),r.inject(widget.body),r.getContent().getElements(".btn").forEach((function(e){"save"===e.value?e.addEvent("click",(function(){r.hide(),r.destroy(),s.saveOfficeEditorFile().then((()=>{i.CloseSessionNDeleteInterfaceIfSessionIsLast(s,n.options.platformUrls.platformId,a)}))})):"closewithoutsave"===e.value?e.addEvent("click",(function(){r.hide(),r.destroy(),i.CloseSessionNDeleteInterfaceIfSessionIsLast(s,n.options.platformUrls.platformId,a)})):"cancel"===e.value&&e.addEvent("click",(function(){r.hide(),r.destroy()}))}))}else i.CloseSessionNDeleteInterfaceIfSessionIsLast(n.options.ctrl,n.options.platformUrls.platformId,a)})):s.close()},i.CloseSessionNDeleteInterfaceIfSessionIsLast=function(e,o,i){e.close(),t.IsWebEditionDocumentSessionActive(o,i).then((t=>{t&&0==t.opened&&e.closeOfficeEditorFile()}))},i})),define("DS/DocumentWebEdition/OfficeWebEditorToolbar",["UWA/Core","DS/Tweakers/GeneratedToolbar","DS/DocumentWebEdition/Actions/OfficeWebEditorClose","DS/DocumentWebEdition/Actions/OfficeWebEditorSave"],(function(e,t,o,i){"use strict";return e.Class.extend({init:function(n,s){var a=this;let l;var r={fetchSecurityContext:function(){return n.options.securityContext},getSelectedNodes:function(){return[n.options.nodeModel]},getDocumentKeyToUse:function(){return null!=n.options.file?"docm_"+n.options.file.dataelements.name.replace(/[!^@&\/\\#, +()$~%.'":*?<>{}]/g,"_"):""},getOrigin:function(){return{source:e.is(widget.data.appId)?widget.data.appId:widget.environment.data._data._x_appId,widgetId:widget.id,component:"ODEtoolbar"}},platformUrls:n.options.platformUrls,events:n.events,ctrl:n};a.commands={OfficeWebEditorClose:new o(r),OfficeWebEditorSave:new i(r)};var c={entries:[a.commands.OfficeWebEditorSave,a.commands.OfficeWebEditorClose]};l=a.FixedToolbarTreeDocument=t.prototype.createTreeDocument(c),(a.FixedToolbar=new t({overflowManagement:"dropdown",direction:"horizontal",items:l})).inject(s)}})})),define("DS/DocumentWebEdition/OfficeWebEditorTopbar",["UWA/Core","DS/DocumentWebEdition/OfficeWebEditorToolbar"],(function(e,t){"use strict";return function(o){var i={ctrl:void 0,build:function(t){this.ctrl=t,this.container=e.createElement("div",{class:t.getClassNames("-topbar")}),this.container.inject(t.elements.content),this.imgDiv=e.createElement("div",{class:"topbar-image-container"}).inject(this.container),this.img=e.createElement("div",{class:"topbar-image"}).inject(this.imgDiv),this.titleDiv=e.createElement("div",{class:"topbar-title-container",text:t.options.title}).inject(this.container),t.topBar=i},setTitleText:function(e){this.titleDiv.setText(e),this.titleDiv.title=e},fillData:function(){this.setTitleText(o.options.title),this.img.style.backgroundImage="url("+o.options.icon+")",this.recreateToolbar()},recreateToolbar:function(){var e=this;null==e.ODEToolbar&&(e.ODEToolbar=new t(e.ctrl,e.container))},resize:function(e){this.recreateToolbar()}};return i.build(o),i}})),define("DS/DocumentWebEdition/OfficeWebEditorComponent",["UWA/Core","DS/CoreEvents/ModelEvents","DS/DocumentWebEdition/OfficeWebEditorTopbar","DS/UIKIT/Mask","DS/DocumentManagement/DocumentManagement","DS/Notifications/NotificationsManagerUXMessages","DS/OfficeDocumentEditorClient/Editor","DS/WAFData/WAFData","DS/DocumentCommands/Helper","DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","UWA/Promise","DS/DocumentCommonInfra/components/UploadFileDialog","DS/DocumentCommonInfra/Utils/GetWidgetConfiguration","i18n!DS/DocumentCommands/assets/nls/DocumentCommands","i18n!DS/DocumentWebEdition/assets/nls/DocumentWebEdition","css!DS/DocumentWebEdition/DocumentWebEdition.css"],(function(e,t,o,i,n,s,a,l,r,c,d,f,m,u,p,v){"use strict";return e.Controls.Abstract.extend({name:"document-webedition",options:{className:""},init:function(e){this._parent(e);var o=e.file;this.events=e.modelEvents||new t,this.notificationManager=s,this.buildSkeleton();let i=e.documentId,n=this.getDocumentKeyToUse(e);this.openDocument(i,o.id,n)},getDocumentKeyToUse:function(e){return null!=e.file?"docm_"+e.file.dataelements.name.replace(/[!^@&\/\\#, +()$~%.'":*?<>{}]/g,"_"):""},renderEditor:function(e,t,o,i){this.finishLoading();var n=this;a.init({title:e,ext:t,url:o,docKeyToUse:i,readOnly:!1,rootElem:n.elements.viewer,platformId:n.options.platformUrls.platformId}).catch((e=>{n.showNotification("error","",e.message,"",!1,!1)}))},buildSkeleton:function(){this.elements.container=e.createElement("div",{class:this.getClassNames()}),this.elements.content=e.createElement("div",{class:this.getClassNames("-content")}),this.elements.content.inject(this.elements.container),this.startLoading(),new o(this),this.topBar.fillData(),this.elements.detail=e.createElement("div",{class:this.getClassNames("-detail")}),this.elements.detail.inject(this.elements.content),this.elements.viewer=e.createElement("div",{class:this.getClassNames("-viewer")}),this.elements.viewer.inject(this.elements.detail),this.elements.container.addEvent("resize",this.resize.bind(this))},startLoading:function(e){i.mask(this.elements.content,e)},finishLoading:function(){i.unmask(this.elements.content)},resize:function(e,t,o){var i=this.elements.container.getSize();this.topBar.resize(i),i.width<550?this.elements.info.isHidden()||this.elements.viewer.setStyles({opacity:0}):this.elements.viewer.setStyles({opacity:1})},saveOfficeEditorFile:function(){var e=this;return new d((function(t){n.getDocuments([e.options.documentId],{tenant:e.options.platformUrls.platformId,securityContext:e.options.securityContext,tenantUrl:e.options.platformUrls["3DSpace"],additionalURLParams:"$fields=files.fileinterface",onComplete:function(o){if(o.success){if(!Array.isArray(o.data))return void console.error("no data received in DocumentManagement.getDocuments");var i=o.data[0].relateddata.files;const n=i.findIndex((t=>t.dataelements.title==e.options.file.dataelements.title));if(-1==n)return e.showNotification("error","",u.get("objectcontainsnofile"),"",!1,!1),t();e.options.file=i[n],e.uploadFilesDialog(e.options,e.options.file,o.csrf)}else console.error("Issue in getDocuments() in saveOfficeEditorFile")},onFailure:function(t){e.showNotification("error","","You do not have access anymore.","",!1,!1)}})}))},uploadFilesDialog:async function(t,o,i){var n=this;n.uploadFileDialog&&n.uploadFileDialog.myDialog&&(n.uploadFileDialog.immersiveFrame&&n.uploadFileDialog.immersiveFrame.destroy(),n.uploadFileDialog.myDialog.destroy(),n.uploadFileDialog.myDialog=void 0);var s={securityContext:t.securityContext,platformUrls:t.platformUrls},a=await m.getcommentAsMandtoryConfigValue(s).promise;n.options.mandatoryCommentConfigSetting=a;var l=n.options.file.dataelements.fileinterface.contains("DocumentCreatedFromWebEditor"),c={events:n.options.events,dialogCustomizations:{defaultPrimaryButtonLabel:p.get("Save"),fileUploader:"disabled",defaultPrimaryDialogLabel:u.get("Update"),defaultCommentValue:l?n.options.file.dataelements.comments:""},mandatoryCommentValueConfiguartionSetting:n.options.mandatoryCommentConfigSetting,platformUrls:e.clone(n.options.platformUrls,!0),files:[{file:o,name:o.dataelements.title}],onUploadFile:function(e){n.options.comments=e.context.myForm.getModelItem("comments").value;let t=n.getDocumentKeyToUse(n.options);""!=t&&r.IsWebEditionDocumentSessionActive(n.options.platformUrls.platformId,t).then((e=>{e.is_modified?n.EditorSave(n.options,i,n.options.nodeModel).then((()=>{resolve()})):n.showNotification("info","",p.get("FileContentIsNotChanged"),!1,!1)}))}};n.uploadFileDialog=new f(c)},closeOfficeEditorFile:function(){var t=this;l.authenticatedRequest(t.options.platformUrls["3DSpace"]+"/resources/v1/application/E6WFoundation/CSRF",e.extend({},{method:"GET",type:"json",onComplete:function(e){var o=t.options.platformUrls["3DSpace"]+"/resources/v1/modeler/documents/deleteInterfaceOnWebEditorSessionClose?fileId="+t.options.file.id,i={tenant:t.options.platformUrls.platformId,securityContext:encodeURIComponent(t.options.securityContext)??void 0,onComplete:function(e){console.log("web editor interface interfaces removed ")},onFailure:function(e,t){console.error("Issue in deleting web editior interface")},url:o,type:"json",data:JSON.stringify({csrf:e.csrf}),headers:t.getHeaderInfo(t.options),method:"PUT"};l.authenticatedRequest(i.url,i)}}))},getHeaderInfo:function(t){let o={},i=c.get();var n=e.is(i)&&e.is(i.change.id)?i.change.id:null;return o=""!=n?{Accept:"application/json","Content-Type":"application/json",SecurityContext:encodeURIComponent(t.securityContext)??void 0,"DS-Change-Authoring-Context":"pid:"+n}:{Accept:"application/json","Content-Type":"application/json",SecurityContext:encodeURIComponent(t.securityContext)??void 0},o},showNotification:function(e,t,o,i,n,s){this.events.publish({event:"docv2-show-notification",data:{level:e,title:t,subtitle:o,message:i,sticky:n,allowUnsafeHTML:s}})},EditorSave:function(e,t,o){var i=this;return new d((function(n,s){i.startLoading(p.get("SaveInProgress")),i.isFileLocked=""!=e.file.dataelements.locker?"true":"false";var r=e.platformUrls["3DSpace"]+"/resources/v1/modeler/documents/files/CheckinTicket";r+="?tenant="+e.platformUrls.platformId;var c={method:"PUT",headers:i.getHeaderInfo(e),type:"json",onComplete:function(r){var c=r;a.save({callbackUrl:c.data[0].dataelements.ticketURL,platformId:e.platformUrls.platformId,params:{"file-name":e.file.dataelements.title,"file-title":e.file.dataelements.title,"file-description":e.file.dataelements.title,__fcs__jobTicket:c.data[0].dataelements.ticket},headers:{},filenameForUpload:"file_0"}).catch((e=>{s(),i.finishLoading(),i.showNotification("error",p.get("WebEditionSaveFailed"),e.message,"",!1,!1)})).then((a=>{if(a&&200==a.endpoint_status_code){var r={data:JSON.stringify({csrf:t,data:[{id:e.documentId,dataelements:{title:e.file.dataelements.title},relateddata:{files:[{dataelements:{keepLocked:i.isFileLocked,title:e.file.dataelements.title,receipt:a.endpoint_body,comments:null==i.options.comments?"":i.options.comments},id:e.file.id,updateAction:"REVISE"}]},updateAction:"NONE"}]}),headers:i.getHeaderInfo(e),onComplete:function(t){n(),i.finishLoading();var s=t.data[0],a=e.file.id;e.file=s.relateddata.files[0],i.showNotification("success","",p.get("OfficeWebEditorSuccessfulSave"),"",!1,!1),"document"==e.actionInitiatedAt?e.modelEvents.publish({event:"docv2-update-complete",data:{nodeModel:o}}):"file"==e.actionIntiatedAt&&(e.modelEvents.publish({event:"enox-docfiles-update-complete",data:{nodeModel:o,updatedFile:s.relateddata.files[0]}}),require(["DS/PlatformAPI/PlatformAPI"],(function(t){t.publish("docm-file-updated-to-document",{platformId:e.platformUrls.platformId,documentId:e.documentId,oldFileId:a,updatedFile:e.file})})))},onFailure:function(e,t){s(),i.finishLoading();let o=t.message?t.message:t.error;i.showNotification("error","",o,"",!1,!1)},method:"PUT",type:"json",url:e.platformUrls["3DSpace"]+"/resources/v1/modeler/documents?initiatedFromODE=true"};l.authenticatedRequest(r.url,r)}else s(),console.error("savePromise response is not successful")}))},onFailure:function(e,t){s(),i.showNotification("error","",t.message,"",!1,!1)},data:JSON.stringify({csrf:t})};l.authenticatedRequest(r,c)}))},openDocument:function(t,o,i){var n=this.options,s=this,a={};s.addInterface=!0,r.IsWebEditionDocumentSessionActive(n.platformUrls.platformId,i).then((r=>{r&&r.opened&&(s.addInterface=!1),l.authenticatedRequest(n.platformUrls["3DSpace"]+"/resources/v1/application/E6WFoundation/CSRF",e.extend(a,{method:"GET",type:"json",onComplete:function(e){var a=n.platformUrls["3DSpace"]+"/resources/v1/modeler/documents/"+t+"/files/"+o+"/DownloadTicket?fileStream=true&addInterface="+s.addInterface,r={tenant:n.platformUrls.platformId,securityContext:n.securityContext,onComplete:function(e){if(e){let t=e.data[0].dataelements.fileName,o=t.lastIndexOf("."),n=t.substring(o+1,t.length);s.renderEditor(t,n,e.data[0].dataelements.ticketURL,i)}},onFailure:function(e,t){s.showNotification("error","",t.message,"",!1,!1)},url:a,type:"json",data:JSON.stringify({csrf:e.csrf}),headers:s.getHeaderInfo(n),method:"PUT"};l.authenticatedRequest(r.url,r)}}))})).catch((e=>{console.error("Error in state promise")}))}})}));