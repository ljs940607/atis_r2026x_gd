/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationAttributeController/CAT3DAnnotationAttributeController",["UWA/Class","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationPanels/CAT3DAnnotationAttrListTable","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXComponents/DMUCommandsManager","DS/PADUtils/views/PADAlert","i18n!DS/CAT3DAnnotationAttributeController/assets/nls/CAT3DAnnotationAttributeController","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesSubTypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationTypes"],(function(e,t,n,i,r,a,o,l,s,c,u,p,h,d,g,f,A,m,y,b){"use strict";var v={},D={},C=e.extend({init:function(e){this._parent(e);var C,S,T,k,P,U,w,I=this,E=[],F={},M=[],L=!1,x=!1,R=!0,V=(e||{}).ctxViewer,B=!1,O={},_={},W={},N=0,X={},q=!1,j=150,H=0,Z=0,J=0,z=!1,G=[],K=c.getPreference("3DAnnotAttributesOrderedList"),Q=new i,Y=[],$=!1,ee=!1,te=!1;let ne=null;var ie=!0;let re=!1;var ae={6:[{type:4,state:!1},{type:5,state:!0},{type:6,state:!1}]},oe={6:5};function le(e,t){Q.publish({event:e,data:t})}function se(e){var t=e.split("&#xA;"),n=[];t.forEach((function(e){n=n.concat(e.split("&#10;"))}));var i=[];return n.forEach((function(e){i=i.concat(e.split(/(\r\n|\n|\r)/gm))})),n}function ce(e){var t,n,i,r=[];if(Array.isArray(e))for(t=0;t<e.length;t++){if(i=e[t].Magnitude,!(n=e[t].Value)||!e[t].Name)continue;i&&i.toLowerCase&&(i=i.toLowerCase());var a=!1;let o=c.getPreference("CATWebUXMePreferences_Units");p.isMagnitudeSupported(i)?(n=p.convertUnitValueToString(e[t].Value,i.charAt(0).toUpperCase()+i.slice(1),o[i.charAt(0).toUpperCase()+i.slice(1)],o[i.charAt(0).toUpperCase()+i.slice(1)+"CalcDisplay"],o.TrailingZeros,{displaySymbol:!1}),a=!0):"boolean"===i?n=("1"===n).toString():"string"===i&&(n=se(n)),r.push({colID:e[t].Name,title:e[t].Name+(a?" ("+c.getUnitDetails(i,o).symbol+")":""),value:n,hidden:e[t].Hidden})}else if(e){var o=e.split(/(\r\n|\n|\r)/gm);for(t=0;t<o.length;t++)if(10!==o[t].charCodeAt(0)){var l=o[t].indexOf("=");-1===l&&(l=o[t].indexOf(":")),-1!==l?r.push({colID:o[t].substring(0,l),title:o[t].substring(0,l),value:o[t].substring(l+1,o[t].length)}):r.push({colID:"otherParams",title:A.otherParams,value:o[t]})}}return r}function ue(e,t,n){var i,r,a,o,l,s=b[e.type];if(n){if(i={},e.hyperlink.hyperlinksAndComments?(i.hyperlinksAndComments=e.hyperlink.hyperlinksAndComments,r=!0):e.hyperlink&&e.hyperlink.requirements&&(i.navReq=e.hyperlink.requirements,r=!0),r)return{uuid:e.uuid,idPath:t.slice(),isAStructuralItem:e.isRootAttr,name:e.name,type:e.type,attrType:e.type,activeState:e.activeState,icon:e.icon,attributes:i}}else{var u;if(i=[],47===e.type){r=!0,s=e.attrType&&y[e.category]&&y[e.category][e.attrType]?y[e.category][e.attrType]:void 0;var h=ce(e.param);h&&h.length&&(i=i.concat(h)),u=e.pointedAttrs}else if(47!==e.type){if(r=!0,e.noaText&&i.push({colID:"noaText",title:A.noaText,value:e.noaText}),e.noaType&&i.push({colID:"noaType",title:A.noaType,value:e.noaType}),e.text&&i.push({colID:"text",title:A.text,value:se(e.text)}),e.generalTolerance||e.tabulatedLimit&&e.toleranceLimits){let t=c.getPreference("CATWebUXMePreferences_Units");var d=37===e.type||13===e.type?"angle":"length",g=" ("+c.getUnitDetails(d,t).symbol+")",f="length"===d?"mm":"deg",m="length"===d?"m":"rad";if(e.generalTolerance){if(i.push({colID:"generalToleranceName",title:A.generalToleranceName,value:e.generalTolerance.name}),(o=e.generalTolerance.variation.split(" / ")).length){for(var v=0;v<o.length;v++)o[v]=o[v].replace("°","");a=p.convert(o[0],d,f,m),l="",isNaN(a)||(l+=p.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1}),l+=" / ",a=p.convert(o[1],d,f,m),l+=p.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})),i.push({colID:"generalToleranceVariation",title:A.generalToleranceVariation+g,value:l})}}else i.push({colID:"tabulatedLimit",title:A.tabulatedLimit,value:e.tabulatedLimit}),a=p.convert(e.toleranceLimits.min,d,f,m),i.push({colID:"toleranceLimitMin",title:A.toleranceLimitMin+g,value:p.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})}),a=p.convert(e.toleranceLimits.max,d,f,m),i.push({colID:"toleranceLimitMax",title:A.toleranceLimitMax+g,value:p.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})})}e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.hiddenText&&i.push({colID:"hiddenText",title:A.hiddenText,value:se(e.hyperlink.hyperlinksAndComments.hiddenText)}),e.hyperlink&&e.hyperlink.failureModes&&e.hyperlink.failureModes.length&&i.push({colID:"failureModes",title:A.failureModes,value:e.hyperlink.failureModes}),e.hyperlink&&e.hyperlink.requirements&&i.push({colID:"navReq",title:A.navReq,value:e.hyperlink.requirements}),e.hyperlink&&e.hyperlink.relatedDocs&&i.push({colID:"relatedDocs",title:A.relatedDocs,value:e.hyperlink.relatedDocs}),e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.urls&&e.hyperlink.hyperlinksAndComments.urls.length&&i.push({colID:"urls",title:A.urls,value:e.hyperlink.hyperlinksAndComments.urls})}if(r)return{uuid:e.uuid,attrType:e.type,attrSubtype:e.attrType,pointedUuids:u,idPath:t,isAStructuralItem:e.isRootAttr,name:e.name,type:s,activeState:e.activeState,icon:e.icon,attributes:i}}}function pe(e){var t=[];return e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.hiddenText&&t.push({colID:"hiddenText",title:A.hiddenText,value:se(e.hyperlink.hyperlinksAndComments.hiddenText)}),e.hyperlink&&e.hyperlink.failureModes&&e.hyperlink.failureModes.length&&t.push({colID:"failureModes",title:A.failureModes,value:e.hyperlink.failureModes}),e.hyperlink&&e.hyperlink.requirements&&t.push({colID:"navReq",title:A.navReq,value:e.hyperlink.requirements}),e.hyperlink&&e.hyperlink.relatedDocs&&t.push({colID:"relatedDocs",title:A.relatedDocs,value:e.hyperlink.relatedDocs}),e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.urls&&e.hyperlink.hyperlinksAndComments.urls.length&&t.push({colID:"urls",title:A.urls,value:e.hyperlink.hyperlinksAndComments.urls}),t}function he(e,t,n){var i,r,a,o,l,s,u=[],h=!1,d=b[e.type];if(47===e.type&&e.category===n){h=!0,d=e.attrType&&y[e.category]&&y[e.category][e.attrType]?y[e.category][e.attrType]:void 0;var g=ce(e.param);g&&g.length&&(u=u.concat(g)),l=e.pointedAttrs,"6"===n&&1===e.attrType&&g&&g.length&&g.some((function(e){if("VisuMode"===e.colID)return oe[6]=parseFloat(e.value),!0}))}else if("3DAnnotations"===n&&47!==e.type){if(h=!0,e.noaText&&u.push({colID:"noaText",title:A.noaText,value:e.noaText}),e.noaType&&u.push({colID:"noaType",title:A.noaType,value:e.noaType}),e.text&&u.push({colID:"text",title:A.text,value:se(e.text)}),e.generalTolerance||e.tabulatedLimit&&e.toleranceLimits){let t=c.getPreference("CATWebUXMePreferences_Units");var f=37===e.type||13===e.type?"angle":"length",m=" ("+c.getUnitDetails(f,t).symbol+")",v="length"===f?"mm":"deg",D="length"===f?"m":"rad";if(e.generalTolerance){if(u.push({colID:"generalToleranceName",title:A.generalToleranceName,value:e.generalTolerance.name}),(a=e.generalTolerance.variation.split(" / ")).length){for(var C=0;C<a.length;C++)a[C]=a[C].replace("°","");r=p.convert(a[0],f,v,D),o="",isNaN(r)||(o+=p.convertUnitValueToString(r,f.charAt(0).toUpperCase()+f.slice(1),t[f.charAt(0).toUpperCase()+f.slice(1)],t[f.charAt(0).toUpperCase()+f.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1}),o+=" / ",r=p.convert(a[1],f,v,D),o+=p.convertUnitValueToString(r,f.charAt(0).toUpperCase()+f.slice(1),t[f.charAt(0).toUpperCase()+f.slice(1)],t[f.charAt(0).toUpperCase()+f.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})),u.push({colID:"generalToleranceVariation",title:A.generalToleranceVariation+m,value:o})}}else u.push({colID:"tabulatedLimit",title:A.tabulatedLimit,value:e.tabulatedLimit}),r=p.convert(e.toleranceLimits.min,f,v,D),u.push({colID:"toleranceLimitMin",title:A.toleranceLimitMin+m,value:p.convertUnitValueToString(r,f.charAt(0).toUpperCase()+f.slice(1),t[f.charAt(0).toUpperCase()+f.slice(1)],t[f.charAt(0).toUpperCase()+f.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})}),r=p.convert(e.toleranceLimits.max,f,v,D),u.push({colID:"toleranceLimitMax",title:A.toleranceLimitMax+m,value:p.convertUnitValueToString(r,f.charAt(0).toUpperCase()+f.slice(1),t[f.charAt(0).toUpperCase()+f.slice(1)],t[f.charAt(0).toUpperCase()+f.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})})}u=u.concat(pe(e))}if(e.children&&e.children.length){var S;s=[];for(var T=0;T<e.children.length;T++)(S=he(e.children[T],t.concat([T]),n))&&s.push(S)}return h&&(i={idPath:t,pointedUuids:l,attrType:e.type,attrSubtype:e.attrType,uuid:e.uuid,isAStructuralItem:e.isRootAttr,name:e.name,type:d,displayFlag:e.displayFlag,activeState:e.activeState,icon:e.icon,attributes:u,children:s}),i}function de(e,t,n){var i=[];if("3DAnnotations"===n&&e.hyperlink){var r=[];(r=r.concat(pe(e))).length&&i.push({uuid:e.uuid,idPath:t.slice(),isAStructuralItem:e.isRootAttr,name:e.name,type:b[e.type],attrType:e.type,displayFlag:e.displayFlag,activeState:e.activeState,icon:e.icon,attributes:r})}for(var a=0;a<e.children.length;a++){var o=e.children[a];if("RootViews"!==o.type&&"RootCaptures"!==o.type)for(var l=0;l<o.children.length;l++){var s=he(o.children[l],[t[0],t[1],a,l],n);s&&i.push(s)}}return i}function ge(){var e,t,n=Object.keys(F);for(e=0;e<n.length;e++)F[n[e]].splice(0,F[n[e]].length);if(F={},$){if(F.result=[],E&&E.length)for(e=0;e<E.length;e++){var i=E[e].getLastElement(!0);for(t=i;t&&t.getAnnotationClassType&&"tpsAnnotationSet"!==t.getAnnotationClassType();)t=t.parents[0];if(t.isVisible()){var r=ue(i.toJSON(),[e],i===t);r&&(F.result[0]||F.result.push({elements:[]}),F.result[0].elements.push(r))}}}else if(E&&E.length)for(e=0;e<E.length;e++)for(var a=0;a<E[e].children.length;a++)if((t=E[e].children[a]).isVisible)for(var o=0;o<K.length;o++)if(null===G||G&&-1===G.indexOf(K[o])){var l={elements:de(t,[e,a],K[o]),section:{idPath:[e,a],name:t.referenceLabel+" / "+t.name,icon:t.referenceIcon}};l.elements.length&&(F[K[o]]||(F[K[o]]=[]),F[K[o]].push(l))}}var fe=function(){J&&(clearTimeout(J),J=0),M&&M.length&&(M.forEach((function(e){e.panel.clean();for(var t=Object.keys(e.tokensBrowserPanel),n=0;n<t.length;n++)e.attrUI.unsubscribe(e.tokensBrowserPanel[t[n]]);e.attrUI.destroy(),e.attrUI=null})),M.length=0)},Ae=function(){!L||z?fe():(J&&(clearTimeout(J),J=0),J=setTimeout((function(){L&&I&&(I._internalRefresh(),j=150,J=0)}),j))},me=function(e){L&&(H+=!0===e?1:-1,Z&&(clearTimeout(Z),Z=0),M.length&&(M.forEach((function(e){e.panel.setEnableFlag(H>=0)})),H<0&&(Z=setTimeout((function(){L&&M&&M.forEach((function(e){e.panel.setEnableFlag(!0)})),H=0}),2e4))))},ye=function(e){var t;if(E&&E.length){var n,i,r;t=[];for(var a=0;a<E.length;a++){if($){if(e.isEqual(E[a])){t=[a];break}}else if(E[a].path.isAParentOf(e)){t.push(a);for(var o=0;o<E[a].children.length;o++)if((r=E[a].children[o].path).isAParentOf(e))for(t.push(o);!r.isEqual(e);){i=!1,n=r.getChildrenPathes();for(var l=0;l<n.length;l++)if(n[l].isAParentOf(e)||n[l].isEqual(e)){t.push(l),r=n[l],i=!0;break}if(!i)return}}}}return t},be=function(e,t,n){e&&e.length&&e.forEach((function(e){var i=e.pathElement,r={path:i.clone(),attributes:[]},a=[],o=i.getLastElement(!0);if(o&&o.getAnnotationClassType){var l=ye(i);if(l&&(a.push({idPath:l,infos:t}),t.displayFlag&&o.getAttributeCategory)){const e=o.getAttributeCategory();v[e]||(v[e]=[]),v[e].push({pathElement:i})}}else{var s=S.getPontingAnnotations(i,!0);if(s&&s.length)for(var u=0;u<s.length;u++)"tpsAttribute"===s[u].getLastElement(!0).getAnnotationClassType()&&(a.push({idPath:ye(s[u]),infos:t}),r.attributes.push(s[u].clone()))}a.length&&M.forEach((function(e){(n||!e.attrUI.getDiscipline()||"display"!==c.getPreference("CAT3DAnnotAttrRowSelection_"+e.attrUI.getDiscipline()))&&e.attrUI.setAdditionalInformations(a)}))}))},ve=function(e){q||z||be(e,{activeState:!0,displayFlag:!0})},De=function(e){q||z||be(e,{activeState:!1})},Ce=function(){q||z||M&&M.length&&M.forEach((function(e){if(!e.attrUI.getDiscipline()||e.attrUI.getDiscipline()&&"display"!==c.getPreference("CAT3DAnnotAttrRowSelection_"+e.attrUI.getDiscipline())){var t=e.attrUI.getDisplayedIDPaths(!0);t&&t.length&&e.attrUI.setAdditionalInformations(t.map((function(e){return{idPath:e,infos:{activeState:!1}}})))}}))},Se=function(e){if(e&&E&&E.length&&E[e[0]]){if($)return E[e[0]];if(E[e[0]].children&&E[e[0]].children[e[1]]){if(2===e.length)return E[e[0]].children[e[1]].path;if(E[e[0]].children[e[1]].path){for(var t,n=E[e[0]].children[e[1]].path.getChildrenPathes(),i=2;i<e.length;i++)n&&n[e[i]]&&(n=(t=n[e[i]]).getChildrenPathes());return t}}}};function Te(e){e&&le("onCommentSelected",{path:Se(e.idPath)})}var ke,Pe=function(e){if(!q){var i;if(q=!0,$)t.empty(),n.empty();else{var r=v[e.discipline];r&&r.length&&(t.remove(r),n.remove(r),r.length=0),v[e.discipline]=[]}var a=[],o=[],l=e.currentSelection;for(i=0;i<l.length;i++){var s=Se(l[i].idPath);s&&(l[i].activeState?($||v[e.discipline].push({pathElement:s}),a.push({pathElement:s,filterOpts:ae})):l[i].activeState||o.push({pathElement:s}),s.getLastElement(!0).setDisplayFlag(!!l[i].activeState||s.getLastElement(!0).getDisplayFlag()))}a.length&&n.add(a),o.length&&n.add(o),q=!1}};function Ue(){ke&&clearTimeout(ke),ke=setTimeout((function(){if(ke=null,S)if(L){var e=[];Object.keys(D).forEach((function(t){e=e.concat(D[t]),$||be(D[t],{activeState:!0,displayFlag:!0},!0)})),S.isolatePaths({paths:e.map((function(e){return e.pathElement})),opts:ae})}else S.isolatePaths({paths:[],opts:ae})}))}var we=function(e){if(!q){q=!0;var t=e.currentSelection;D[e.discipline]=[];for(var n=0;n<t.length;n++){var i=Se(t[n].idPath);i&&t[n].activeState&&(D[e.discipline].push({pathElement:i}),i.getLastElement(!0).setDisplayFlag(!0))}Ue(),q=!1}},Ie=function(e){var t=Se(e.idPath);t&&t.getLastElement(!0).getDisplayFlag&&t.getLastElement(!0).getDisplayFlag()!==e.flag&&t.getLastElement(!0).setDisplayFlag(e.flag)};function Ee(e){e.state,c.setPreference("CAT3DAnnotColumnSort_"+e.discipline,e.state)}function Fe(e){var t=[];"display"===e.state?(c.setPreference("CAT3DAnnotAttrRowSelection_"+e.discipline,e.state),t=v[e.discipline]?v[e.discipline].slice():null,D[e.discipline]=v[e.discipline]?v[e.discipline].slice():[],v[e.discipline]=[],t&&t.length&&(q=!0,n.remove(t),q=!1),Ue()):(t=D[e.discipline]?D[e.discipline].slice():null,v[e.discipline]=D[e.discipline]?D[e.discipline].slice():[],D[e.discipline]=[],Ue(),t&&t.length&&(t.forEach((function(e){e.filterOpts=ae})),q=!0,n.add(t),q=!1),c.setPreference("CAT3DAnnotAttrRowSelection_"+e.discipline,e.state))}function Me(e){v[e.discipline]&&v[e.discipline].length?(q=!0,n.remove(v[e.discipline].slice()),q=!1,v[e.discipline].length=0):D[e.discipline]&&(D[e.discipline]=[],Ue()),c.setPreference("CAT3DAnnotAttrAttrDisplay_"+($?"result":e.discipline),e.state)}function Le(e){if(ae[e.discipline]=e.state,"display"===c.getPreference("CAT3DAnnotAttrRowSelection_"+e.discipline))Ue();else{var t=v[e.discipline]?v[e.discipline].slice():null;t&&t.length&&(q=!0,t.forEach((function(e){e.filterOpts=ae})),n.remove(t),n.add(t),q=!1)}}function xe(e){var t,i;for(i=0;i<M.length;i++)if(M[i].discipline===e.discipline){t=M[i];break}var r=[];if(n.get().forEach((function(t){var n=t.pathElement.getLastElement(!0);n.getAnnotationClassType&&("3DAnnotations"===e.discipline&&47!==n.getAnnotationType()||n.getAttributeCategory&&e.discipline===n.getAttributeCategory())&&r.push(n)})),t){var a=function(e){if(e.setDisplayFlag(!1),e.children&&e.children.length&&e.children[0].setDisplayFlag)for(var t=0;t<e.children.length;t++)a(e.children[t])},o=T.getLoadedAnnotationSets();for(i=0;i<o.length;i++)for(var l=o[i].children,s=0;s<l.length;s++){var c=l[s];if("RootCaptures"!==c.getAnnotationType()&&"RootViews"!==c.getAnnotationType())for(var u,p=l[s].children,h=0;h<p.length;h++)u=p[h],("3DAnnotations"===e.discipline&&47!==u.getAnnotationType()||u.getAttributeCategory&&e.discipline===u.getAttributeCategory())&&-1===r.indexOf(u)&&a(u)}f.displayNotification({eventID:"info",msg:A.DisplayHistorySuccessfulLbl})}}function Re(e){var t,n;if($)t=M[0];else for(n=0;n<M.length;n++)if(M[n].discipline===e.discipline){t=M[n];break}if(t){var i,r=t.attrUI.getDisplayedIDPaths(!0);if(r.length){var a,o=[];for(n=0;n<r.length;n++)(a=Se(r[n]))&&(o.push(a),(i=S.getAllRelatedPaths(a))&&i.length&&(o=o.concat(i)));o.length&&V.getViewer().currentViewpoint.reframeOn(400,o,{reframeSpace:"visibleSpace",withInternalSceneGraph:!0})}}M[0].panel&&M[0].panel.isSmallWidth()&&M[0].panel.collapsePanel()}function Ve(e){if(ie&&e&&e.discipline&&M){var t=V.getRootBagPath().getChildrenPathes().map((function(e){return{node:e.getLastElement(!0),id:h.getNodeID(e.getLastElement(!0))}}));if(t&&t.length){var n=function(n){for(var i="",r=0;r<t.length;r++)r>0&&(i+="_"),i+=n[t[r].id]["ds6w:label"];M.some((function(t){if(t.discipline===e.discipline){var n=t.attrUI.exportAsCSV(e);if(n){var r=new Blob([n],{type:"text/csv"}),a=window.URL.createObjectURL(r),o=document.createElement("a");o.style.display="none",o.download=i+"_"+m[t.discipline]+".csv",o.href=a,document.body.appendChild(o),window.__karma__&&window.__karma__.config?le("onAttributeTableExported",{fileName:i+"_"+m[t.discipline]+".csv",content:n}):o.click(),window.URL.revokeObjectURL(a),document.body.removeChild(o),h._sendUsageProbe("command",e.onlySelectedRows?"ExportSelectedTechnologicalAttrToCSV":"ExportVisibleTechnologicalAttrToCSV")}return!0}}))};if("3DXML"===h.getLoadedAssetType()){for(var i,r=0;r<t.length;r++){var a=h.getNodeInfos(t[r].node);i[t[r].id]={},i[t[r].id]["ds6w:label"]=a.name}n(i)}else V.getController().getAttributes({ids:t.map((function(e){return e.id})),attributes:["ds6w:label"],callbacks:{onComplete:n,onFailure:n}})}}}function Be(e){if(L&&M&&M.length){var t=[],n={};e&&e.length&&e.forEach((function(e){if(e&&e.getLastElement(!0).getAttributeCategory){var i=e.getLastElement(!0).getAttributeCategory();-1===t.indexOf(i)&&t.push(i),n[i]||(n[i]=[]),n[i].push({pathElement:e})}})),t.forEach((function(e){M.some((function(t){if(t.attrUI.getDiscipline()===e)return"display"===c.getPreference("CAT3DAnnotAttrRowSelection_"+e)?I.setDisplayedElementPaths(n[e]):I.setSelectedElementPaths(n[e]),!0}))}))}Y=e}function Oe(e){e.colIdx&&M[0].panel&&M[0].panel.isSmallWidth()&&M[0].panel.collapsePanel()}let _e=["dragenter","dragover","drop"];function We(e){e.stopPropagation()}function Ne(){const e=V.getViewer().canvas,t=V.getFrameWindow().getImmersiveFrame();return _e.forEach((n=>{e.addEventListener(n,We),t.addEventListener(n,We)})),!0}function Xe(){const e=V.getViewer().canvas,t=V.getFrameWindow().getImmersiveFrame();return _e.forEach((n=>{e.removeEventListener(n,We),t.addEventListener(n,We)})),!0}var qe=function(e,t){for(var n,i=0;i<M.length;i++)if(M[i].discipline===e){n=M[i];break}n||(n={discipline:e},M.push(n)),n&&n.attrUI&&n.attrUI.cleanPanel(),n.attrUI=new r,n.tokensBrowserPanel={},n.tokensBrowserPanel.onAttrActiveStateModified=n.attrUI.subscribe("onAttrActiveStateModified",Pe),n.tokensBrowserPanel.onAttrDisplayStateModifiedCB=n.attrUI.subscribe("onAttrDisplayStateModified",we),n.tokensBrowserPanel.onAttrDisplayFlagModified=n.attrUI.subscribe("onAttrDisplayFlagModified",Ie),n.tokensBrowserPanel.onDeleteDisplayHistory=n.attrUI.subscribe("onDeleteDisplayHistory",xe),n.tokensBrowserPanel.onSwitchEnableColumnSort=n.attrUI.subscribe("onSwitchEnableColumnSort",Ee),n.tokensBrowserPanel.onSwitchRowSelectionMode=n.attrUI.subscribe("onSwitchRowSelectionMode",Fe),n.tokensBrowserPanel.onSwitchAttributeDisplayMode=n.attrUI.subscribe("onSwitchAttributeDisplayMode",Me),n.tokensBrowserPanel.onSwitchMultiRepDisplayMode=n.attrUI.subscribe("onSwitchMultiRepDisplayMode",Le),n.tokensBrowserPanel.onReframeOn=n.attrUI.subscribe("onReframeOn",Re),n.tokensBrowserPanel.onExportToCSVRequired=n.attrUI.subscribe("onExportToCSVRequired",Ve),n.tokensBrowserPanel.onAttributeClicked=n.attrUI.subscribe("onAttributeClicked",(function(e){S&&S.solveAttributeLink(e)})),n.tokensBrowserPanel.onCommentClicked=n.attrUI.subscribe("onCommentClicked",Te),n.tokensBrowserPanel.onDSpointerhit=n.attrUI.subscribe("onDSpointerhit",Oe);var o=c.getPreference("CAT3DAnnotAttrRowSelection_"+e);o=o||"highlight";var l=c.getPreference("CAT3DAnnotAttrAttrDisplay_"+e);l=l||"columns";var s=c.getPreference("CAT3DAnnotColumnSort_"+e);s=s||"disabled";var p=n.attrUI.buildPanel({model:t,discipline:e,disciplineNls:m[e],rowSelectionCurrentState:o,columnSortCurrentState:s,attributeDisplayCurrentState:l,representationMode:ae[e],multiRepDefaultMode:oe[e],allowExport:!1!==ie,onDragStartColumnHeader:Ne,onDragEndColumnHeader:Xe});if(p)if(n.panel)n.panel.content=p;else{var h=u.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");"3DAnnotations"===e?h+="I_W3DAnnot_NodeAnnotationSet.png":"0"===e?h+="I_W3DAnnot_MechanicalAttribute.png":"1"===e?h+="I_W3DAnnot_ElectricalAttribute.png":"2"===e?h+="I_W3DAnnot_KnowledgeAttribute.png":"3"===e?h+="I_W3DAnnot_StructureAttribute.png":"4"===e?h+="I_W3DAnnot_CompositeAttribute.png":"5"===e?h+="I_W3DAnnot_GeometricalAttribute.png":"6"===e?h+="I_W3DAnnot_LayeredPrdAttribute.png":"7"===e&&(h+="I_W3DAnnot_PathwayAttribute.png"),n.panel=new a({id:"CAT3DAnnotAttrBrowserPanel"+e,className:"CAT3DAnnotAttrBrowserPanel",title:m[e],icon:h,immersiveFrame:V.getFrameWindow().getImmersiveFrame(),viewerFrame:V.getFrameWindow().getViewerFrame(),closeButtonFlag:!1,content:p,minHeight:50,minWidth:180,height:180,snappableFlag:!0,allowMaximizeFlag:!0,maximizeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea,currentDockArea:WUXDockAreaEnum.BottomDockArea})}n&&n.panel.setPanelVisibilityFlag(R&&0!==n.attrUI.getDisplayedIDPaths().length)};this.setResultRepresentationModeFlag=function(e){e!==ee&&(ee=e,$?I.hideAttributeResultTable():(fe(),Ae()))},this.getResultRepresentationModeFlag=function(){return ee},this.displayAttributeResultTable=function(e){E.length=0;for(var t=0;t<e.length;t++)E.push(e[t].clone());$=!0,Ae()},this.hideAttributeResultTable=function(){$&&(E.length=0,fe(),$=!1,Ae())},this._internalRefresh=function(){if(ee&&!$||!ee&&$)fe();else if(!L||z)fe();else{var e,t,i,o=n.get().slice();if($){if(ge(),M)for(e=M.length-1;e>=0;e--){for(M[e].panel&&(M[e].panel.clean(),M[e].panel=null),i=Object.keys(M[e].tokensBrowserPanel),t=0;t<i.length;t++)M[e].attrUI.unsubscribe(M[e].tokensBrowserPanel[i[t]]);M[e].attrUI.cleanPanel(),M.splice(e,1)}if(!F.result.length||!F.result[0].elements||!F.result[0].elements.length)return;!function(){M&&M.length&&M[0].attrUI&&M[0].attrUI.cleanPanel(),M&&M.length||(M=[{}]),M[0].attrUI=new r,M[0].tokensBrowserPanel={},M[0].tokensBrowserPanel.onAttrActiveStateModified=M[0].attrUI.subscribe("onAttrActiveStateModified",Pe),M[0].tokensBrowserPanel.onReframeOn=M[0].attrUI.subscribe("onReframeOn",Re),M[0].tokensBrowserPanel.onDeleteDisplayHistory=M[0].attrUI.subscribe("onDeleteDisplayHistory",xe),M[0].tokensBrowserPanel.onSwitchAttributeDisplayMode=M[0].attrUI.subscribe("onSwitchAttributeDisplayMode",Me),M[0].tokensBrowserPanel.onAttributeClicked=M[0].attrUI.subscribe("onAttributeClicked",(function(e){S&&S.solveAttributeLink(e)})),M[0].tokensBrowserPanel.onDSpointerhit=M[0].attrUI.subscribe("onDSpointerhit",Oe);var e=c.getPreference("CAT3DAnnotAttrAttrDisplay_result");e=e||"columns";var t=M[0].attrUI.buildPanel({model:F.result,attributeDisplayCurrentState:e,onDragStartColumnHeader:Ne,onDragEndColumnHeader:Xe});t&&(M[0].panel?M[0].panel.content=t:M[0].panel=new a({id:"CAT3DAnnotResultAttrBrowserPanel",className:"CAT3DAnnotAttrBrowserPanel CAT3DAnnotResultAttrBrowserPanel",title:A.resultAttrPanelTitle,icon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attributes",immersiveFrame:V.getFrameWindow().getImmersiveFrame(),viewerFrame:V.getFrameWindow().getViewerFrame(),closeButtonFlag:!1,content:t,minHeight:50,minWidth:180,height:180,snappableFlag:!0,allowMaximizeFlag:!0,maximizeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea,currentDockArea:WUXDockAreaEnum.BottomDockArea})),M&&M.length&&M[0].panel.setPanelVisibilityFlag(0!==M[0].attrUI.getDisplayedIDPaths().length)}(),M.length&&(M.forEach((function(e){e.panel.setEnableFlag(H>=0)})),be(o,{activeState:!0}),Ue(),Y.length&&Be(Y),Y.length=0)}else P||(P=S.onAdditionalInfosRequired({controller:"AnnotAttrBrowser"}).getJSONModel),E.splice(0,E.length),P((function(n){E=n,G=C?C.getAttributeTypesFiltered():null,ge();var r=Object.keys(F);for(e=M.length-1;e>=0;e--)if(-1===r.indexOf(M[e].discipline)){for(M[e].panel.clean(),i=Object.keys(M[e].tokensBrowserPanel),t=0;t<i.length;t++)M[e].attrUI.unsubscribe(M[e].tokensBrowserPanel[i[t]]);M[e].attrUI.cleanPanel(),M.splice(e,1)}for(e=r.length-1;e>=0;e--)qe(r[e],F[r[e]]);M&&M.length&&(M.forEach((function(e){e.panel.setPanelVisibilityFlag(R),e.panel.setEnableFlag(H>=0),e.attrUI.forceCommentColumnVisibilityFlag(te),e.attrUI.setCommentInformation(U)})),be(o,{activeState:!0})),Ue(),Y.length&&Be(Y),Y.length=0}))}},this.setDisplayedElementPaths=function(e,t){if(L){D={},t&&(ae=t);var n=[],i={};e&&e.length&&e.forEach((function(e){if(e.pathElement&&e.pathElement.getLastElement(!0).getAttributeCategory){var t=e.pathElement.getLastElement(!0).getAttributeCategory();D[t]||(D[t]=[]),D[t].push(e),-1===n.indexOf(t)&&n.push(t),i[t]||(i[t]=[]),i[t].push(ye(e.pathElement))}})),n.forEach((function(e){c.setPreference("CAT3DAnnotAttrRowSelection_"+e,"display"),M.some((function(t){if(t.attrUI.getDiscipline()===e){t.attrUI.setRowSelectionMode("display"),ae&&ae[e]&&t.attrUI.setMultiRepOption(ae[e]);for(var n=t.attrUI.getDisplayedIDPaths(!0)||[],r=i[e].slice(),a=r.length-1;a>=0;a--){for(var o=!1,l=n.length-1;l>=0;l--)if(JSON.stringify(r[a])===JSON.stringify(n[l])){n.splice(l,1),o=!0;break}o&&r.splice(a,1)}var s=n.map((function(e){return{idPath:e,infos:{activeState:!1}}}));return(s=s.concat(r.map((function(e){return{idPath:e,infos:{activeState:!0,displayFlag:!0}}})))).length&&t.attrUI.setAdditionalInformations(s),!0}}))})),Ue()}},this.setSelectedElementPaths=function(e,t){var i=[],r=[];e&&e.length&&e.forEach((function(e){if(e.pathElement&&e.pathElement.getLastElement(!0).getAttributeCategory){var t=e.pathElement.getLastElement(!0).getAttributeCategory();-1===i.indexOf(t)&&i.push(t)}r.push({pathElement:e.pathElement.clone(),filterOpts:ae})})),L&&(t&&(ae=t),i.forEach((function(e){c.setPreference("CAT3DAnnotAttrRowSelection_"+e,"highlight"),M.some((function(t){if(t.attrUI.getDiscipline()===e)return t.attrUI.setRowSelectionMode("highlight"),!0}))}))),n.add(r)},this.getDisplayedElementPaths=function(){if(L){var e=[];return Object.keys(D).forEach((function(t){e=e.concat(D[t])})),e}},this.getDisplayedElementsFilteringOpts=function(){return ae},this.setActiveState=function(e){var t;if(L=e,S&&T&&re)if(L)B||(X.onPostAdd=n.onPostAdd(ve),X.onPostRemove=n.onPostRemove(De),X.onEmpty=n.onEmpty(Ce),C=s.give3DAnnotFilterController({context:V}),(w=d.getPreferenceManager({context:V.getFrameWindow()}))&&(ne=w.subscribe("com.ds.mep:onPrefUpdate",(function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)if("cke"===t.repositories[e].name)for(let n=0;n<t.repositories[e].preferences.length;n++){let i=t.repositories[e].preferences;["TrailingZeros","Length","LengthDisplay","LengthCalcDisplay","Angle","AngleDisplay","AngleCalcDisplay","Volume","VolumeDisplay","VolumeCalcDisplay","Area","AreaDisplay","AreaCalcDisplay","Mass","MassDisplay","MassCalcDisplay"].includes(i[n].name)&&Ae()}}))),C&&(O.onAnnotationFilterActiveStateModified=C.subscribe("onAnnotationFilterActiveStateModified",(function(){var e=C.getAttributeTypesFiltered(),n=!1;if((!G&&e&&e.length||!e&&G&&G.length||e&&G&&e.length!==G.length)&&(n=!0),!n)for(t=0;t<e.length;t++)if(e[t]!==G[t]){n=!0;break}n&&Ae()})),O.onAttributesVisibilityModified=C.subscribe("onAttributesVisibilityModified",Ae)),_.onAnnotControllerActiveStateChanged=S.subscribe("onAnnotControllerActiveStateChanged",(function(e){e.state?Ae():fe()})),_.onFeatureFocusRequired=S.subscribe("onFeatureFocusRequired",(function(e){e&&e.paths&&Be(e.paths)})),_.onAnnotationsLinkedDataSolved=S.subscribe("onAnnotationsLinkedDataSolved",(function(e){!0===e.succeeded&&Ae()})),_.onBeginDisplayViewOrCapture=S.subscribe("onBeginDisplayViewOrCapture",(function(e){if(e&&(e.path||e.uuid)){let e=c.getPreference("CATWebUXMePreferences_KeepSelectedFeatures");Object.keys(D).forEach((function(t){"3DAnnotations"!==t&&e||(be(D[t],{activeState:!1},!0),delete D[t])})),e||n.empty(),Ue()}})),W.onAnnotModelLoaderActiveStateChanged=T.subscribe("onAnnotModelLoaderActiveStateChanged",(function(e){e.state?Ae():fe()})),W.onAnnotationVisibilityModifiedToken=T.subscribe("onAnnotationVisibilityModified",(function(e){e&&e.node&&e.node.getAnnotationClassType&&"tpsAnnotationSet"===e.node.getAnnotationClassType()&&(e.node.isVisible()||(Object.keys(D).forEach((function(t){if(D[t]&&D[t].length)for(var n=D[t].length-1;n>=0;n--)(!D[t][n]||D[t][n]&&e.path.isAParentOf(D[t][n]))&&D[t].splice(n,1)})),D={},Ue()),Ae())})),W.onAnnotationSetLoadedToken=T.subscribe("onAnnotationSetLoaded",(function(){me(!0),Ae()})),W.onAnnotationSetPartiallyLoaded=T.subscribe("onAnnotationSetPartiallyLoaded",(function(){me(!0),Ae()})),W.onAnnotationSetRemovedToken=T.subscribe("onAnnotationSetRemoved",(function(){var e;j=0,(e=T.getOrderedAnnotationSetPaths())&&e.length&&(e=e.map((e=>e.annotSetPath))),Object.keys(D).forEach((function(t){for(var n=D[t].length-1;n>=0;n--){var i=!1;if(e&&e.length)for(var r=e.length-1;r>=0;r--)if(D[t][n]&&D[t][n].pathElement&&e[r].isAParentOf(D[t][n].pathElement)){i=!0;break}i||D[t].splice(n,1)}})),Ae()})),W.onAnnotationSetBeginLoadToken=T.subscribe("onAnnotationSetBeginLoad",(function(){me(!1)})),W.onAnnotationSetLoadingFailedToken=T.subscribe("onAnnotationSetLoadingFailed",(function(){me(!0)})),W.onNoAnnotationSetLoadedToken=T.subscribe("onNoAnnotationSetLoaded",(function(e){e&&e.loadingAlreadyStarted&&me(!0)})),W.onAnnotationSetLoadingCanceledToken=T.subscribe("onAnnotationSetLoadingCanceled",(function(){me(!0)})),W.onVisuModificationToken=T.subscribe("onAnnotationParentVisibilityModified",(function(){Ae()})),N=V.getViewer().onSwapVisibleSpace?V.getViewer().onSwapVisibleSpace((function(){z=0===V.getViewer().getVisibleSpace(),1===V.getViewer().getVisibleSpace()?Ae():fe()})):null,z=0===V.getViewer().getVisibleSpace(),B=!0),Ue(),Ae();else{if(B){n.unsubscribe(X.onPostAdd),n.unsubscribe(X.onPostRemove),n.unsubscribe(X.onEmpty);var i=Object.keys(O);if(C)for(t=0;t<i.length;t++)C.unsubscribe(O[i[t]]);for(w&&(ne&&(w.unsubscribe(ne),ne=null),d.unreferencePreferenceManager({context:V.getFrameWindow()}),w=null),i=Object.keys(_),t=0;t<i.length;t++)S.unsubscribe(_[i[t]]);for(i=Object.keys(W),t=0;t<i.length;t++)T.unsubscribe(W[i[t]]);N&&V.getViewer()&&V.getViewer().unsubscribe(N),Ue(),N=0,O={},W={},_={},X={},fe(),Y.length=0,B=!1}re&&(c.cleanPrefManager(),re=!1)}else k||(k=setInterval((function(){T=l.giveAnnotationModelLoader({context:V}),(S=o.giveAnnotationController({context:V}))&&T&&(clearInterval(k),k=null,re?I.setActiveState(L):c.initPrefManager({context:V.getFrameWindow()}).then((()=>{re=!0,I.setActiveState(L)})))}),100))},this.getActiveState=function(){return L},this.setControllerEnableFlag=function(e){let t=Boolean("wafr"===require("DS/PADUtils/PADSettingsMgt").getSetting("eno3dviewer_infrastructure_version"))?"AnnotationSemanticBrowser":"CAT3DAnnotSemanticAttrBrowserHdr";var n=g.getCommandCheckHeader(t,V.getCommandContext());n&&(e?n.enable():n.disable()),x?(I.setActiveState(!0),x=!1):e||L&&(I.setActiveState(!1),x=!0,P=S=T=null)},this.setPanelVisibilityFlag=function(e){R=e,!$&&M&&M.length&&M.forEach((function(e){e.panel.setPanelVisibilityFlag(R&&0!==e.attrUI.getDisplayedIDPaths().length)}))},this.getPanelVisibilityFlag=function(){return R},this.forceCommentColumnVisibilityFlag=function(e){te!==e&&(te=e,M.forEach((function(e){e.attrUI.forceCommentColumnVisibilityFlag(te)})))},this.updateCommentColumn=function(e){JSON.stringify(U)!==JSON.stringify(e)&&(U=e,M.forEach((function(e){e.attrUI.setCommentInformation(U)})))},this.clearController=function(){this.setActiveState(!1),k&&clearInterval(k),M=E=null,C=S=T=G=null,P=null,Q=V=I=null},this.allowTableExportInCSV=function(e){ie=e},this.subscribe=function(e,t){return e&&t?Q.subscribe({event:e},t):void 0},this.unsubscribe=function(e){Q&&e&&Q.unsubscribe(e)}}}),S=[];return e.singleton({init:function(){},give3DAnnotAttrBrowserController:function(e){if(e&&e.context)for(var t=0;t<S.length;t++)if(S[t].context===e.context)return S[t].attrCtrl},get3DAnnotAttrBrowserController:function(e){var t=this.give3DAnnotAttrBrowserController(e);if(e&&e.context&&!t){var n=new C({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},setResultRepresentationModeFlag:function(e){n&&n.setResultRepresentationModeFlag(e)},getResultRepresentationModeFlag:function(){if(n)return n.getResultRepresentationModeFlag()},setDisplayedElementPaths:function(e,t){n&&n.setDisplayedElementPaths(e,t)},getDisplayedElementsFilteringOpts:function(){return n?n.getDisplayedElementsFilteringOpts():null},setSelectedElementPaths:function(e,t){n&&n.setSelectedElementPaths(e,t)},getDisplayedElementPaths:function(){if(n)return n.getDisplayedElementPaths()},setControllerEnableFlag:function(e){n&&n.setControllerEnableFlag(e)},displayAttributeResultTable:function(e){n&&n.displayAttributeResultTable(e)},hideAttributeResultTable:function(){n&&n.hideAttributeResultTable()},forceCommentColumnVisibilityFlag:function(e){n&&n.forceCommentColumnVisibilityFlag(e)},updateCommentColumn:function(e){n&&n.updateCommentColumn(e)},clearController:function(){n&&(n.clearController(),n=null)},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return!!n&&n.getPanelVisibilityFlag()},allowTableExportInCSV:function(e){n&&n.allowTableExportInCSV(e)},subscribe:function(e,t){return n?n.subscribe(e,t):void 0},unsubscribe:function(e){n&&n.unsubscribe(e)}}),S.push({context:e.context,attrCtrl:t,counter:1})}else if(e&&e.context)for(var i=0;i<S.length;i++)if(S[i].context===e.context){S[i].counter++;break}return t},unreference3DAnnotAttrBrowserController:function(e){if(e&&e.context)for(var t=0;t<S.length;t++)if(S[t].context===e.context){S[t].counter--,S[t].counter<=0&&(S[t].attrCtrl.clearController(),S.splice(t,1));break}}})}));