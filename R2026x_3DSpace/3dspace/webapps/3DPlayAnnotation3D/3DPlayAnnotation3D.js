define("DS/3DPlayAnnotation3D/Annotation3DCommand",["UWA/Class","DS/Mesh/MeshUtils","DS/3DPlayAnnotationUtils/AnnotationSettings"],(function(t,e,n){"use strict";return t.extend({init:function(t){this._parent(t),this.frameWindow=t.frameWindow,this.annotationManager=t.annotationManager,this.hideTools=t.hideTools,this.viewer=this.frameWindow.getViewer(),this._isRunning=!1,this._pickingTrapSelection=this.viewer.picking.trapSelection,this._pickingActivate=this.viewer.picking.activated,this._pickingHL=this.viewer.picking.displayHL,this.drawSettings=new n},begin:function(t){this._isRunning=!0,this.frameWindow.experience.NRMgr&&this.frameWindow.experience.NRMgr.disableManipulator()},end:function(t){this._isRunning=!1,this.frameWindow.experience.NRMgr&&this.frameWindow.experience.NRMgr.enableManipulator()},isRunning:function(){return this._isRunning},destroy:function(){this.annotationManager=void 0,this.viewer=void 0,this.frameWindow=void 0,this.hideTools=void 0,this._isRunning=void 0,this._pickingTrapSelection=void 0,this._pickingActivate=void 0,this._pickingHL=void 0,this._pickingSmallTarget=!1},hideUI:function(){this.hideTools&&this.hideTools()},setViewer:function(t){if(this.viewer){if(this._pickingSmallTarget=this.viewer.renderer.smallTargetPicking,this.viewer.setSmallRenderTargetPicking(!1),!t.control){var n=this.viewer.currentViewpoint.getDefaultController?this.viewer.currentViewpoint.getDefaultController():this.viewer.currentViewpoint.control._mode;"CATIA"!==n&&(this.savedControl=n,this.viewer.currentViewpoint.setDefaultController(!0,"CATIA")),this.touchRotationState=!1,this.viewer.currentViewpoint.control.getTouchRotationActive&&(this.touchRotationState=this.viewer.currentViewpoint.control.getTouchRotationActive()),this.viewer.currentViewpoint.control.setTouchRotationActive&&this.viewer.currentViewpoint.control.setTouchRotationActive(!1)}if(t.highlight||(this._pickingActivate=this.viewer.picking.activated,this._pickingTrapSelection=this.viewer.picking.trapSelection,this._pickingHL=this.viewer.picking.displayHL,this.viewer.setPicking({activated:!1,trapSelection:!1,displayHL:!1}),this.viewer.setPrePicking({activated:!1,displayHL:!1})),!t.pickable)for(var i=this.annotationManager.getAnnotationBag(),o=0;o<i.children.length;o++){i.children[o].getChildByName("Annotation_Representation").setPickable(e.NOPICKABLE)}}},unsetViewer:function(){if(this.viewer){for(var t=this.annotationManager.getAnnotationBag(),n=0;n<t.children.length;n++){t.children[n].getChildByName("Annotation_Representation").setPickable(e.PICKABLE)}this.viewer.setPicking&&this.viewer.setPicking({activated:this._pickingActivate,trapSelection:this._pickingTrapSelection,displayHL:this._pickingHL}),this.viewer.setPrePicking&&this.viewer.setPrePicking({activated:this._pickingActivate,displayHL:this._pickingHL}),this.savedControl&&(this.viewer.currentViewpoint.setDefaultController(!0,this.savedControl),delete this.savedControl),this.viewer.currentViewpoint.control.setTouchRotationActive&&this.viewer.currentViewpoint.control.setTouchRotationActive(!this.touchRotationState),this.viewer.setSmallRenderTargetPicking(this._pickingSmallTarget),this.viewer.render()}}})}));var deps=["DS/WebUtils/ContextedSingleton"];window.localStorage["3DPlay.UseExplodeCompatibleAnnotationManager"]?deps.push("DS/3DPlayAnnotation3D/AnnotationExplodeManager"):deps.push("DS/3DPlayAnnotation3D/AnnotationManager"),define("DS/3DPlayAnnotation3D/AnnotationManagerUtils",deps,(function(t,e){"use strict";return{getAnnotationManager:function(n,i){var o=t.get(n,"ANNOTATION_MANAGER");return o||(i?(o=new e({frameWindow:i,context:n}),t.add(n,"ANNOTATION_MANAGER",o)):console.error("noframwindow")),o},deleteAnnotationManager:function(e){t.get(e,"ANNOTATION_MANAGER")&&t.remove(e,"ANNOTATION_MANAGER")}}})),define("DS/3DPlayAnnotation3D/AnnotationUtils",["DS/Visualization/ThreeJS_DS","DS/WebUtils/GeometryUtils","DS/Mesh/MeshUtils","DS/3DPlayAnnotationUtils/ShapeUtils"],(function(t,e,n,i){"use strict";return{getBarycenter2DPixel:function(e){let n=new t.Vector2,i=e.length;for(let t=0;t<i;t++)n.x+=e[t].xPix,n.y+=e[t].yPix;return n.x/=i,n.y/=i,n},scaleMousePositions:function(n,i){function o(){this.x=0,this.y=0,this.xPix=0,this.yPix=0}for(var a,r,s,l=e.getBarycenter2D(n),h=new t.Vector2(l.x,l.y),d=this.getBarycenter2DPixel(n),c=[],u=n.length,p=0;p<u;p++)a=new o,(r=new t.Vector2).x=n[p].x,r.y=n[p].y,r.sub(h),r.multiplyScalar(i),r.add(h),(s=new t.Vector2).x=n[p].xPix,s.y=n[p].yPix,s.sub(d),s.multiplyScalar(i),s.add(d),a.x=Math.round(r.x),a.y=Math.round(r.y),a.xPix=Math.round(s.x),a.yPix=Math.round(s.y),c.push(a);return c},pixelToNormalizedCoord:function(t,e,n){var i=[];for(let o=0,a=t.length;o<a;o++)i.push({x:(t[o].x-e/2)/(e/2),y:-(t[o].y-n/2)/(n/2),xPix:t[o].x*window.devicePixelRatio,yPix:t[o].y*window.devicePixelRatio});return i},areSameNormals:function(e){var n=e.length;if(n>1){function o(e,n=.001){let i=e.lengthSq();return i<n?new t.Vector3(0,0,0):Math.abs(i-1)>n?e.clone().divideScalar(Math.sqrt(i)):e}var i=o(e[0]);for(let a=1;a<n;a++){let r=o(e[a]);if(i.clone().cross(r).length()>.35)return!1;i=r}}return!0},isHeightDifferenceOK:function(t){if(t.length>2){var e=t[0],n=t[1],i=e.distanceTo(n);for(let e=2,o=t.length;e<o;e++){let o=t[e],a=n.distanceTo(o);if(0!=i&&0!=a&&a>20*i)return!1;n=o,i=a}}return!0},compute2DBoundingboxFrom3D:function(n,o,a,r){var s=i.onScreenProjection(n,o),l=e.boundingBoxCompute(e.convexHullCompute(s));if(null!=r&&r>1&&(l=this.scaleShape2D(l,r)),"line"!=a&&"unknownOpen"!=a){var h=e.getBarycenter2D(l),d=new t.Vector2(h.x,h.y);l=this.createCirclePointArray(d,l[0].distanceTo(l[2])/2)}return l},screenToWorldPlaneProjection:function(e,n,o,a){var r=o.projectionMatrix,s=(new t.Matrix4).getInverse(r);!0===a&&(e=i._interpolate2D(e));for(var l=e.length,h=0;h<l;h++)o instanceof t.PerspectiveCamera&&(e[h].x*=-n,e[h].y*=-n,e[h].z?e[h].z*=-n:e[h].z=0),e[h]=new t.Vector4(e[h].x,e[h].y,e[h].z,-n).applyMatrix4(s),e[h].z=n,e[h]=new t.Vector4(e[h].x,e[h].y,e[h].z,1).applyMatrix4(o.matrixWorld),e[h]=new t.Vector3(e[h].x,e[h].y,e[h].z);return e},getCameraNearestZPoint:function(e,n){var i=new t.Vector3(0,0,-9999999);let o=e.length;for(var a=0;a<o;a++){let t=e[a].clone().applyMatrix4(n.matrixWorldInverse);t.z>i.z&&(i=t.clone())}return i},isWireframe:function(t){var e=t.getRenderer();e.getRenderLineMode();return 0===e.renderFaceMode},nearestAnnotToText:function(n,o,a,r){var s,l=!1,h=n;if(1!==(a=a||1)){var d=(n[3].y-n[2].y)/2,c=(n[2].x-n[1].x)/2,u={x:n[1].x+c,y:n[1].y+d},p=c*a,g=d*a;h=[new t.Vector2(u.x-p,u.y+g),new t.Vector2(u.x-p,u.y-g),new t.Vector2(u.x+p,u.y-g),new t.Vector2(u.x+p,u.y+g)]}for(var w=0;w<o.length;w++)if(o[w].points.length>0&&!0!==o[w].onModel){var m=e.boundingBoxCompute(e.convexHullCompute(i.onScreenProjection(o[w].points,r)));if(e.isIntersect(m,h))if(!0===l&&1!==a)!0===e.isIntersect(m,n)&&(s=o[w].repBag.children[0],l=!0);else s=o[w].repBag.children[0],l=!0}return s},setNodePickable:function(t,e){t&&t.setPickable&&(!0===e?t.setPickable(n.PICKABLE):t.setPickable(n.NOPICKABLE))},getUniquePointsFromPointsArray:function(t,e){for(var n=[],i=0,o=t.length;i<o;i++){for(var a=!0,r=0;r<n.length;r++)if(t[i].equals(n[r])){a=!1;break}if(a&&(n.push(t[i]),e&&n.length===e))break}return n},_areAlmostSameViewpoints:function(t,e){return!!this._areAlmostSameBasicViewpoints(t,e)&&(!(t.upDirection.angleTo(e.upDirection)*(180/Math.PI)>.001)&&!(t.sightDirection.angleTo(e.sightDirection)*(180/Math.PI)>.001))},_areAlmostSameBasicViewpoints:function(t,e){return t.eyePosition.distanceToSquared(e.eyePosition)<.01}}})),define("DS/3DPlayAnnotation3D/AnnotationTour",["DS/3DPlayWAFRMigration/Command","DS/WebInfraUI/NavigationArrows","DS/3DPlayAnnotation3D/AnnotationManagerUtils","DS/CoreEvents/Events","DS/WebUtils/Tracker","DS/3DPlayAnnotation3D/AnnotationUtils","DS/3DPlayWAFRMigration/CommandsManager"],(function(t,e,n,i,o,a,r){"use strict";return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),this._exp=this.getFrameWindow().experience,r.isAFR2()||this.disable(),this._exp&&this._exp.registerCollabAction&&(this._exp.registerCollabAction("StartAnnotationTour",this.beginExecute.bind(this)),this._exp.registerCollabAction("StopAnnotationTour",this.endExecute.bind(this)))},beginExecute:function(){o.startCommand(this.getId());var t=n.getAnnotationManager(this._ctx);t.updateViewPoint?this.navigationArrows=new e({arrowCB:{left:function(){t&&t.updateViewPoint({direction:"left"})},right:function(){t&&t.updateViewPoint({direction:"right"})}}},{container:this.getFrameWindow().getUIFrame(),frmWindow:this.getFrameWindow()}):this.tourNavigationForDrawings(t),this._exp&&this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("StartAnnotationTour"),i.publish({event:"3DPLAY/SPECTREE/DISABLE",data:{}}),i.publish({event:"3DPLAY/UDLLEFTPANEL/DISABLE",data:{}})},tourNavigationForDrawings:function(t){let n=this._exp.frmWindow.getViewpoint(),i={eyePosition:n.getEyePosition(),targetDistance:n.getTargetDistance()},o=this._exp.getCurrentSheet(),r=this._exp.sheets,s=[],l=!1;for(let t=0;t<r.length;t++){let e=r[t].annotVpList;for(let n=0;n<e.length;n++)s.push({sheetIndex:r[t].index,viewPoint:e[n]}),a._areAlmostSameBasicViewpoints(e[n],i)&&o.index==s[s.length-1].sheetIndex&&(this.indexPointer=s.length-1)}if(null==this.indexPointer&&o.annotVpList.length>0)for(let t=0;t<s.length;t++)if(s[t].sheetIndex==o.index){this.indexPointer=t,l=!0;break}this.navigationArrows=new e({arrowCB:{left:function(){if(!1===l)if(void 0!==this.indexPointer)this.indexPointer--,this.indexPointer<0&&(this.indexPointer=s.length-1);else{for(let t=s.length-1;t>0;t--)if(s[t].sheetIndex<o.index){this.indexPointer=t;break}null==this.indexPointer&&(this.indexPointer=s.length-1)}t.setSheetViewpointFromInfo(s[this.indexPointer].sheetIndex,void 0,s[this.indexPointer].viewPoint),l=!1}.bind(this),right:function(){if(!1===l)if(void 0!==this.indexPointer)this.indexPointer++,this.indexPointer>s.length-1&&(this.indexPointer=0);else{for(let t=0;t<s.length-1;t++)if(s[t].sheetIndex>o.index){this.indexPointer=t;break}null==this.indexPointer&&(this.indexPointer=0)}t.setSheetViewpointFromInfo(s[this.indexPointer].sheetIndex,void 0,s[this.indexPointer].viewPoint),l=!1}.bind(this)}},{container:this.getFrameWindow().getUIFrame(),frmWindow:this.getFrameWindow()})},endExecute:function(){o.endCommand(this.getId()),this.navigationArrows.dispose(),this.navigationArrows=null,this.indexPointer=void 0,this._exp&&this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("StopAnnotationTour");var t=this.getFrameWindow();if(t){var e=t.getMAB();e&&!1===e.state.visible&&(i.publish({event:"3DPLAY/SPECTREE/ENABLE",data:{}}),i.publish({event:"3DPLAY/UDLLEFTPANEL/ENABLE",data:{}}))}this.AFR2_Done()},_destroy:function(){this._exp=void 0,this._parent()}})})),define("DS/3DPlayAnnotation3D/AnnotationShapes",["UWA/Class","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/Visualization/ThreeJS_DS","DS/CATCreaDesWebUIServices/CATCrDWebUIServices","DS/Visualization/Node3D","DS/3DPlayAnnotationUtils/ShapeUtils","DS/Visualization/SceneGraphFactory","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/WebSystem/Settings"],(function(t,e,n,i,o,a,r,s,l,h){"use strict";var d=h.get("3DPlay.Annotation.PerformanceMode"),c=t.extend({init:function(t,e){this.drawSettings=new l,this.frameWindow=t.frameWindow,this.viewer=this.frameWindow.getViewer(),this.annotationManager=t.annotationManager,this.id=Date.now(),this.type=e,this.geometry={},this.graphicalProp={color:null,opacity:null,thickness:null},this.points=[],this.normals=[],this.onModel=!1,this.vpOrient=new i.Vector3,this.model=this.annotationManager.getModel(),this.onSectionPlane=!1},dispose:function(){this.drawSettings=null,this.frameWindow=null,this.viewer=null,this.annotationManager=null,this.id=null,this.type=null,this.geometry=null,this.graphicalProp=null,this.points=null,this.normals=null,this.onModel=null,this.vpOrient=null,this.model=null,this.onSectionPlane=null},_checkSectionPlane:function(t){for(var e=t.path,n=0;n<e.length;n++){var i=e[n];if(i.getLastElement&&i.getLastElement().getParents)for(var o=i.getLastElement().getParents(),a=0;a<o.length;a++)if(o[a].name&&"Section plane"===o[a].name){this.onSectionPlane=!0;break}}},_getPickPointsAndNormals:function(t,e,i){var o=this.frameWindow.getViewer(),a=[],r=[],s=[],l=[];n.setNodePickable(this.model,!0);for(var h=0;h<t.length;h++){var d=o.pick(t[h],e,!0);d.path.length>0&&(!this.onSectionPlane&&i&&this._checkSectionPlane(d),s.push(d.position.clone()),l.push(d.normal.clone())),a.push(d.position.clone()),r.push(d.normal.clone())}return n.setNodePickable(this.model,!1),{pickPoints:a,pickNormals:r,onModel:{points:s,normals:l}}},_getIntermediatePointsOfLineOnModel:function(t,e,n,o){for(var a=(new i.Vector3).subVectors(n,e),s=a.length()/o,l=a.clone().normalize(),h=(this.viewer.currentViewpoint.getEyePosition(),[]),d=0;d<o;d++){var c=(new i.Vector3).addVectors(e,l.clone().multiplyScalar(s*d));h.push(c)}for(var u=r.onScreenProjection(h,this.viewer),p=[],g=0;g<u.length;g++)p.push(this.viewer.getMousePosition(u[g]));var w=this._getPickPointsAndNormals(p,"mesh",!0);return{points:[].concat(w.onModel.points),normals:[].concat(w.onModel.normals)}},_getThickness:function(t,e,n){var o=new i.Box2;o.setFromPoints(t);for(var a=o.max.distanceTo(o.min),r=new i.Box3,s=1/0,l=new i.Vector3,h=0;h<e.length;h++){var d=n.distanceTo(e[h]);d<s&&(s=d,l.copy(e[h]))}var c=l.clone(),u=n.clone().sub(c).normalize(),p=new i.Plane;p.setFromNormalAndCoplanarPoint(u,c);var g=[];for(h=0;h<e.length;h++){var w=(new i.Vector3).subVectors(e[h],n).normalize(),m=new i.Ray(n,w);g.push(m.intersectPlane(p))}r.setFromPoints(g);var v=r.max.distanceTo(r.min),f=this.drawSettings.getThickness();return f*=v/a,f*=window.devicePixelRatio},_saveLastPos:function(t){var n,i=this.frameWindow.getViewerFrame().getDimensions(),o=i.height,a=i.width,r=t.path,s=t.shapeType;if(("line"==s||"unknownOpen"===s)&&r.length>=3)r[(l=r.length)-1].x-r[l-3].x>=0?n={y:r[l-1].y/o,x:r[l-1].x/a}:r[l-1].x-r[l-3].x<0&&(n={y:r[l-1].y/o,x:(r[l-1].x-90)/a});else if("arrow"===s&&r.length>=3){t.arrowType;var l=r.length,h=t.vertices;n=r[l-1].x-r[l-3].x>=0||r[l-1].x-r[l-3].x<0?{y:h[1].y/o,x:(h[1].x-125)/a}:{y:h[1].y/o,x:h[1].x/a}}else{for(var d=e.boundingBoxCompute(e.convexHullCompute(r)),c=d[0].x,u=d[0].y,p=1;p<d.length;p++)d[p].x<=c&&(c=d[p].x),d[p].y>=u&&(u=d[p].y);n={y:u/o,x:c/a}}this.drawSettings.setLastPosition(n)},createFromMousePositions:function(t,o){for(var a=this.frameWindow.getViewer(),r=a.currentViewpoint,s=r.getCamera(),l=(i.OrthographicCamera,new i.Vector3(0,0,-1).applyQuaternion(s.quaternion).normalize()),h=r.getEyePosition(),c=n.isWireframe(a),u=[],p=[],g=[],w=0;w<t.length;w++)g.push(new i.Vector2(t[w].xPix,t[w].yPix));var m=this._getPickPointsAndNormals(t,"mesh",!0),v=!1,f=m.onModel.points.length;if(t.length===f&&!this.onSectionPlane&&!c&&n.areSameNormals(m.onModel.normals)&&n.isHeightDifferenceOK(m.onModel.points)&&(v=!0),v){for(w=0;w<m.onModel.points.length;w++)u.push(m.onModel.points[w].add(m.onModel.normals[w].clone().normalize().multiplyScalar(.5)));p=m.onModel.normals.slice(0)}else{var D=1;if(0<f)D=n.getCameraNearestZPoint(m.onModel.points,s).z;else{var x=n.scaleMousePositions(t,.35),y=this._getPickPointsAndNormals(x,"mesh");if(y.onModel.points.length>0)D=n.getCameraNearestZPoint(y.pickPoints,s).z;else{var P=this.annotationManager.getCurrentAnnotViewpoint();if(P&&P.annotList.length>0){var A,S,_=e.getBarycenter2D(e.boundingBoxCompute(e.convexHullCompute(g))),C=1/0;for(w=0;w<P.annotList.length;w++)if(A=n.compute2DBoundingboxFrom3D(P.annotList[w].points,a,"line"),M=e.getBarycenter2D(A),(S=_.distanceTo(M))<C){C=S;var M,b=e.getBarycenter(P.annotList[w].points);D=(M=new i.Vector3(b.x,b.y,b.z)).applyMatrix4(s.matrixWorldInverse).z}}else D=this.model.getBoundingBox().center().clone().applyMatrix4(this.model.parents[0].getMatrixWorld()).applyMatrix4(s.matrixWorldInverse).z}}var V=!1;d&&("circle"!==this.type&&"ellipse"!==this.type||(V=!0)),u=n.screenToWorldPlaneProjection(t.slice(0),D,s,V);var T=(new i.Matrix4).getInverse(this.model.parents[0].getMatrixWorld());for(w=0;w<u.length;w++)u[w]=new i.Vector4(u[w].x,u[w].y,u[w].z,1).applyMatrix4(T),u[w]=new i.Vector3(u[w].x,u[w].y,u[w].z);for(w=0;w<u.length;w++)p.push(l.clone().negate())}this.points=u.slice(0),this.normals=p.slice(0),this.onModel=v,this.vpOrient.copy(l),this.graphicalProp={color:this.drawSettings.getColor(),opacity:this.drawSettings.getOpacity(),thickness:this._getThickness(g,u,h)},this._saveLastPos({shapeType:this.type,path:g})},createFromMousePositionsquick:function(t){var e,o=this.frameWindow.getViewer(),a=this.viewer.currentViewpoint,r=a.getCamera(),s=(i.OrthographicCamera,new i.Vector3(0,0,-1).applyQuaternion(r.quaternion).normalize()),l=(a.getEyePosition(),n.isWireframe(o),[]),h=[];e=this.model.getBoundingBox().center().clone().applyMatrix4(r.matrixWorldInverse).z;l=n.screenToWorldPlaneProjection(t.slice(0),e,r,!1);for(var d=0;d<l.length;d++)h.push(s.clone().negate());this.points=l.slice(0),this.normals=h.slice(0),this.onModel=!1,this.vpOrient.copy(s)},draw:function(){this.viewer.currentViewpoint.getCamera();var t,e=o.createMaterial(new i.Color(this.graphicalProp.color),this.graphicalProp.opacity,1);(t=o.createPencilGP(this.points,this.normals,this.graphicalProp.thickness,e)).setShadow(!1),t.name="Annotation_Representation",t.annotID=this.id,this.repBag=new a("3DPlay_Sketch_Annotation"),this.repBag.add(t),this.onModel?this.repBag.setNoZ(!1):this.repBag.setNoZ(!0)},drawOnModel:function(t){for(var e=[],n=[],o=0;o<t.geometry.points.length;o++){var a=t.geometry.points[o],r=t.geometry.normals[o];e.push(new i.Vector3(a.x,a.y,a.z)),n.push(new i.Vector3(r.x,r.y,r.z))}this.points=e,this.normals=n},getJSON:function(){if(this.json)return this.json;var t=this.onModel?{points:this.points,normals:this.normals}:this.get3DGeometry(this.points);return{id:this.id,type:this.type,onModel:this.onModel,geometry:t,graphicalProp:this.graphicalProp,pointsCount:this.points.length,annotPlaneNormal:this.normals[0],annotStartPoint:this.points[0]}},setJSON:function(t){this.id=t.id,this.type=t.type,this.onModel=t.onModel,this.graphicalProp=t.graphicalProp,this.json=t},get3DGeometry:function(t){console.log("To be implemented by derived class")},createFromJSON:function(t){console.log("To be implemented by the derived class")}});return{line:c.extend({init:function(t){this._parent(t,"line")},createFromJSON:function(t){if(this.setJSON(t),t.onModel)this.drawOnModel(t);else{var e=[],n=[],o=new i.Vector3(t.annotPlaneNormal.x,t.annotPlaneNormal.y,t.annotPlaneNormal.z),a=(t.geometry.length,t.pointsCount,new i.Vector3(t.geometry.startPoint.x,t.geometry.startPoint.y,t.geometry.startPoint.z)),r=new i.Vector3(t.geometry.endPoint.x,t.geometry.endPoint.y,t.geometry.endPoint.z);e.push(a,r),n.push(o,o),this.points=e,this.normals=n}},get3DGeometry:function(t){return{startPoint:t[0],endPoint:t[t.length-1],length:t[0].distanceTo(t[t.length-1])}}}),circle:c.extend({init:function(t){this._parent(t,"circle")},createFromJSON:function(t){this.setJSON(t);var e=[],n=[];if(t.onModel)this.drawOnModel(t);else{for(var o=new i.Vector3(t.annotPlaneNormal.x,t.annotPlaneNormal.y,t.annotPlaneNormal.z),a=new i.Vector3(t.annotStartPoint.x,t.annotStartPoint.y,t.annotStartPoint.z),r=new i.Vector3(t.geometry.center.x,t.geometry.center.y,t.geometry.center.z),s=t.geometry.radius,l=(new i.Vector3).subVectors(a,r).normalize(),h=(new i.Vector3).crossVectors(l,o).normalize(),d=2*Math.PI/t.pointsCount,c=0;c<2*Math.PI;c+=d){var u=r.x+s*Math.cos(c)*l.x+s*Math.sin(c)*h.x,p=r.y+s*Math.cos(c)*l.y+s*Math.sin(c)*h.y,g=r.z+s*Math.cos(c)*l.z+s*Math.sin(c)*h.z;e.push(new i.Vector3(u,p,g)),n.push(o)}this.points=e,this.normals=n}},get3DGeometry:function(t){for(var e=0,n=new i.Vector3,o=1;o<t.length-1;o++){var a=t[0].distanceTo(t[o]);a>e&&(e=a,n.copy(t[o]))}return{center:(new i.Vector3).addVectors(t[0],n).multiplyScalar(.5),radius:e/2}}}),ellipse:c.extend({init:function(t){this._parent(t,"ellipse")},createFromJSON:function(t){if(this.setJSON(t),t.onModel)this.drawOnModel(t);else{for(var e=[],n=[],o=new i.Vector3(t.annotPlaneNormal.x,t.annotPlaneNormal.y,t.annotPlaneNormal.z),a=(new i.Vector3(t.annotStartPoint.x,t.annotStartPoint.y,t.annotStartPoint.z),new i.Vector3(t.geometry.center.x,t.geometry.center.y,t.geometry.center.z)),r=new i.Vector3(t.geometry.majorAxis.dir.x,t.geometry.majorAxis.dir.y,t.geometry.majorAxis.dir.z),s=new i.Vector3(t.geometry.minorAxis.dir.x,t.geometry.minorAxis.dir.y,t.geometry.minorAxis.dir.z),l=t.geometry.majorAxis.length,h=t.geometry.minorAxis.length,d=2*Math.PI/t.pointsCount,c=0;c<2*Math.PI;c+=d){var u=a.x+l*Math.cos(c)*r.x+h*Math.sin(c)*s.x,p=a.y+l*Math.cos(c)*r.y+h*Math.sin(c)*s.y,g=a.z+l*Math.cos(c)*r.z+h*Math.sin(c)*s.z;e.push(new i.Vector3(u,p,g)),n.push(o)}this.points=e,this.normals=n}},get3DGeometry:function(t){for(var e=[],n=[],o=0;o<t.length-1;o++){for(var a,r=0,s=1;s<t.length;s++){var l=t[o].distanceTo(t[s]);l>r&&(r=l,a=t[s])}e.push(r),n.push(a)}for(var h=e.indexOf(Math.max.apply(null,e)),d=t[h],c=n[h],u=(new i.Vector3).addVectors(d,c).multiplyScalar(.5),p=(new i.Vector3).subVectors(c,d),g=(new i.Vector3).crossVectors(p,(new i.Plane).setFromCoplanarPoints(t[0],t[1],t[2]).normal),w=1/0,m=0;m<t.length;m++){var v=t[m].distanceTo(u);v<w&&(w=v)}return{center:u,majorAxis:{length:p.length()/2,dir:p.normalize()},minorAxis:{length:w,dir:g.normalize()}}}}),rectangle:c.extend({init:function(t){this._parent(t,"rectangle"),this.frameWindow=t.frameWindow},createFromJSON:function(t){if(this.setJSON(t),t.onModel)this.drawOnModel(t);else{var e=[],n=[],o={A:new i.Vector3(t.geometry.vertices[0].x,t.geometry.vertices[0].y,t.geometry.vertices[0].z),B:new i.Vector3(t.geometry.vertices[1].x,t.geometry.vertices[1].y,t.geometry.vertices[1].z),C:new i.Vector3(t.geometry.vertices[2].x,t.geometry.vertices[2].y,t.geometry.vertices[2].z),D:new i.Vector3(t.geometry.vertices[3].x,t.geometry.vertices[3].y,t.geometry.vertices[3].z)},a=new i.Vector3(t.annotPlaneNormal.x,t.annotPlaneNormal.y,t.annotPlaneNormal.z);e.push(o.A,o.B,o.C,o.D,o.A),n.push(a,a,a,a,a),this.points=e,this.normals=n}},get3DGeometry:function(t){for(var e=0,n=new i.Vector3,o=0,a=0;a<t.length;a++){(u=t[0].distanceTo(t[a]))>e&&(e=u,n.copy(t[a]),o=a)}t.slice(o);var r=t[0].clone(),s=n.clone(),l=(new i.Vector3).addVectors(r,s).multiplyScalar(.5),h=(r.distanceTo(l),(new i.Vector3).subVectors(r,s).normalize()),d=new i.Vector3,c=0;for(a=0;a<t.length/2;a++){var u,p=(new i.Vector3).subVectors(t[a],s);(u=(new i.Vector3).crossVectors(h,p).length())>c&&(d.copy(t[a]),c=u)}return{vertices:[r,d,s,(new i.Vector3).subVectors(l.multiplyScalar(2),d)]}}}),triangle:c.extend({init:function(t){this._parent(t,"triangle")},createFromJSON:function(t){if(this.setJSON(t),t.onModel)this.drawOnModel(t);else{var e=[],n=[],o=new i.Vector3(t.annotPlaneNormal.x,t.annotPlaneNormal.y,t.annotPlaneNormal.z),a=new i.Vector3(t.geometry.vertexA.x,t.geometry.vertexA.y,t.geometry.vertexA.z),r=new i.Vector3(t.geometry.vertexB.x,t.geometry.vertexB.y,t.geometry.vertexB.z),s=new i.Vector3(t.geometry.vertexC.x,t.geometry.vertexC.y,t.geometry.vertexC.z);(new i.Vector3).subVectors(r,a),(new i.Vector3).subVectors(s,r),(new i.Vector3).subVectors(a,s);e.push(a,r,s,a),n.push(o,o,o,o),this.points=e,this.normals=n}},get3DGeometry:function(t){let e=0,n={},o=[];for(var a=1;a<t.length;a++){let i=t[0].distanceTo(t[a]);i>e&&(e=i,n={A:t[0],B:t[a]})}let r=(new i.Vector3).subVectors(n.B,n.A).normalize();for(a=1;a<t.length;a++){(new i.Vector3).subVectors(t[a],t[0]).normalize().equals(r)||o.push(t[a])}let s=0,l=new i.Vector3;for(a=0;a<o.length;a++){let t=this.getFootOfPerpendicularOnLineFromPoint(n,o[a]).distanceTo(o[a]);t>s&&(s=t,l.copy(o[a]))}return{vertexA:n.A,vertexB:n.B,vertexC:l}},getFootOfPerpendicularOnLineFromPoint:function(t,e){let n,o,a,r,s,l,h,d,c,u;return n=t.B.x-t.A.x,o=t.B.y-t.A.y,a=t.B.z-t.A.z,s=t.A.x,l=t.A.y,h=t.A.z,d=e.x,c=e.y,u=e.z,r=((d-s)*n+(c-l)*o+(u-h)*a)/(n*n+o*o+a*a),new i.Vector3(r*n+s,r*o+l,r*a+h)}}),unknownOpen:c.extend({init:function(t){this._parent(t,"unknownOpen"),this.frameWindow=t.frameWindow},createFromJSON:function(t){if(this.setJSON(t),t.onModel)this.drawOnModel(t);else{for(var e=[],n=[],o=(new i.Vector3(t.annotStartPoint.x,t.annotStartPoint.y,t.annotStartPoint.z),new i.Vector3(t.annotPlaneNormal.x,t.annotPlaneNormal.y,t.annotPlaneNormal.z)),a=0;a<t.geometry.points.length;a++){var r=new i.Vector3(t.geometry.points[a].x,t.geometry.points[a].y,t.geometry.points[a].z);e.push(r),n.push(o)}this.points=e,this.normals=n}},get3DGeometry:function(t){return{points:t}}}),text:c.extend({init:function(t){this._parent(t,"text")},dispose:function(){this.text=null,this.width=null,this.height=null,this.scale=null,this.shapePoints=null,this.offsetHeight=null,this._parent()},getJSON:function(){return{id:this.id,type:this.type,onModel:this.onModel,geometry:this.get3DGeometry(),graphicalProp:this.graphicalProp,text:this.text}},get3DGeometry:function(){return{scale:this.scale,width:this.width,height:this.height,vertices:this.points,offsetHeight:this.offsetHeight}},createFromMousePositions:function(t){this.text=t.text,this.width=t.w,this.height=t.h,this.scale=t.scale,this.offsetHeight=t.offsetHeight;var o=t.x,a=t.y;if(""!==this.text){var s=-1/0,l=!1,h=[new i.Vector2(t.x,t.y),new i.Vector2(t.x+t.w,t.y),new i.Vector2(t.x+t.w,t.y+t.h),new i.Vector2(t.x,t.y+t.h)],d=this.annotationManager.getCurrentAnnotViewpoint();if(d){var c=d.annotList;if(c){var u=e.boundingBoxCompute(e.convexHullCompute(h)),p=n.nearestAnnotToText(u,c,1.2,this.viewer);p&&p.localNearestZ&&(s=p.localNearestZ,l=!0)}}var g=this.viewer.currentViewpoint.getCamera(),w=this.frameWindow.getViewerFrame().getDimensions(),m=w.width,v=w.height,f=r._interpolateStraightLineLow([new i.Vector2(o,a),new i.Vector2(o+this.width,a)]),D=r._interpolateStraightLineLow([new i.Vector2(o+this.width,a),new i.Vector2(o+this.width,a+this.height)]),x=r._interpolateStraightLineLow([new i.Vector2(o+this.width,a+this.height),new i.Vector2(o,a+this.height)]),y=r._interpolateStraightLineLow([new i.Vector2(o,a+this.height),new i.Vector2(o,a)]),P=r._interpolateStraightLineLow([new i.Vector2(o,a),new i.Vector2(o+this.width,a+this.height)]),A=r._interpolateStraightLineLow([new i.Vector2(o,a+this.height),new i.Vector2(o+this.width,a)]),S=[].concat(f,D,x,y,P,A),_=n.pixelToNormalizedCoord(S,m,v),C=this._getPickPointsAndNormals(_,"mesh",!0),M=!1;if(C.onModel.points.length>0&&(M=!0),M)for(var b=0;b<C.onModel.points.length;b++){var V=C.onModel.points[b].clone().applyMatrix4(g.matrixWorldInverse).z;V>s&&(s=V)}else s===-1/0&&!1===l&&(s=this.model.getBoundingBox().center().clone().applyMatrix4(g.matrixWorldInverse).z);var T=n.pixelToNormalizedCoord([new i.Vector2(o,a+this.height)],m,v)[0],W=n.pixelToNormalizedCoord([new i.Vector2(o,a)],m,v)[0],B=n.pixelToNormalizedCoord([new i.Vector2(o+this.width,a)],m,v)[0],k=n.pixelToNormalizedCoord([new i.Vector2(o+this.width,a+this.height)],m,v)[0];this.points.push(n.screenToWorldPlaneProjection([T],s,g)[0]),this.points.push(n.screenToWorldPlaneProjection([W],s,g)[0]),this.points.push(n.screenToWorldPlaneProjection([B],s,g)[0]),this.points.push(n.screenToWorldPlaneProjection([k],s,g)[0]),this.graphicalProp={fontSize:t.fontSize,fontWeight:100*(this.drawSettings.getThickness()-3),color:t.color}}},draw:function(){var t=this.viewer.currentViewpoint.getCamera(),n=new i.Vector3(0,0,-1).applyQuaternion(t.quaternion).normalize(),o=(this.graphicalProp.fontWeight,e.wrapText({text:this.text,width:this.width/this.scale,height:this.height/this.scale,font:" "+this.graphicalProp.fontSize+'px "3ds"'}));this.text=o.wrappedLines;var r=document.createElement("canvas"),l=r.getContext("2d");r.width=this.width,r.height=this.height,l.font=" "+this.graphicalProp.fontSize*this.scale+'px "3ds"',l.fillStyle=this.graphicalProp.color,l.textAlign="center";for(var h=o.wrappedLines,d=0;d<h.length;d++)l.fillText(h[d],this.width/2,(this.graphicalProp.fontSize-4)*this.scale+this.offsetHeight*this.scale*d);var c=new i.Texture(r);c.needsUpdate=!0,r.remove&&r.remove(),r=void 0;var u=new i.MeshBasicMaterial({color:this.graphicalProp.color,map:c,side:i.DoubleSide,transparent:!0});u.force=!0;var p=s.createRectangleNode({height:this.points[0].distanceTo(this.points[1]),width:this.points[1].distanceTo(this.points[2]),fill:!0,layerNb:1,material:u});p.setMatrix((new i.Matrix4).lookAt(this.points[0],this.points[0].clone().add(n),t.up.clone()).setPosition(this.points[0])),p.setShadow(!1),p.name="Annotation_Representation",p.annotID=this.id,this.repBag=new a("3DPlay_Text_Annotation"),this.repBag.add(p)},createFromJSON:function(t){this.id=t.id;for(var e=t.text,n="",o=0;o<e.length;o++)n+=e[o],o!==e.length-1&&(n+="\n");this.text=n,this.scale=parseFloat(t.geometry.scale),this.width=parseFloat(t.geometry.width),this.height=parseFloat(t.geometry.height),this.points=[];for(var a=t.geometry.vertices,r=0;r<a.length;r++)this.points.push(new i.Vector3(a[r].x,a[r].y,a[r].z));this.offsetHeight=t.geometry.offsetHeight,this.graphicalProp=t.graphicalProp}})}})),define("DS/3DPlayAnnotation3D/AnnotationManager",["UWA/Class","DS/CoreEvents/Events","DS/3DPlayAnnotation3D/AnnotationShapes","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/3DPlayAnnotationUtils/AnnotationAbbreviations"],(function(t,e,n,i,o,a,r,s){"use strict";var l="#A9A9A9";return t.extend({init:function(t){this._frameWindow=t.frameWindow,this._frameWindow.experience?this._rootNode=this._frameWindow.experience.getRootBag():this._rootNode=this._frameWindow.getViewer().getRootNode(),this.AnnotationAbbreviations=new s,this._annotViewpointList=[],this.viewpointChangedToken=e.subscribe({event:"/VISU/"},function(t){"@onViewpointEndMove"!=t.eventType&&"@onViewpointChange"!=t.eventType||this._refreshAnnotations(this._annotViewpointList)}.bind(this)),this._frameWindow.experience&&this._frameWindow.experience.registerCollabAction&&(this._frameWindow.experience.registerCollabAction("annot3DDraw",this.drawAnnotationsFromJSON.bind(this)),this._frameWindow.experience.registerCollabAction("annot3DDelete",this.deleteAnnotationWithID.bind(this)))},_createAnnotViewpoint:function(t,e,n){var o=e||Date.now(),a=t||this._getCurrentViewpointInfo();let r={id:o,eyePosition:a.eyePosition instanceof i.Vector3?a.eyePosition:new i.Vector3(a.eyePosition.x,a.eyePosition.y,a.eyePosition.z),upDirection:a.upDirection instanceof i.Vector3?a.upDirection:new i.Vector3(a.upDirection.x,a.upDirection.y,a.upDirection.z),sightDirection:a.sightDirection instanceof i.Vector3?a.sightDirection:new i.Vector3(a.sightDirection.x,a.sightDirection.y,a.sightDirection.z),targetDistance:a.targetDistance,annotList:a.annotList||[],onModelAnnotCount:0};return this._annotViewpointList.push(r),r},_getCurrentViewpointInfo:function(){var t=this._frameWindow.getViewer().currentViewpoint;if(t)return{eyePosition:t.getEyePosition(),upDirection:t.getUpDirection(),sightDirection:t.getSightDirection(),targetDistance:t.getTargetDistance()}},_refreshAnnotations:function(t){if(t.length){var e=this._getCurrentViewpointInfo();t.forEach((function(t){var n=t.opacity||1;if(r._areAlmostSameViewpoints(e,t))n=1;else{var i=e.eyePosition.distanceTo(t.eyePosition),o=t.targetDistance*(2/3);n=i>o?.1:Math.abs(o-i)/o}t.opacity=n,t.annotList.forEach((function(t){t.onModel||(n>.1?("text"===t.type?t.repBag.children[0].mesh3js.material.setValues({opacity:n}):t.repBag.children[0].mesh3js.material.updatePDSFXUniform("Opacity",n),t.repBag.children[0].setPickable(a.PICKABLE),t.repBag.children[0].setVisibility(!0)):(t.repBag.children[0].setPickable(a.NOPICKABLE),t.repBag.children[0].setVisibility(!1),t.repBag.children[0].setNoZ(!0)))}))})),this._frameWindow.getViewer().render()}},_setAnnotViewpointFromInfo:function(t,e){var n=t;e&&(n.duration=e),n.distanceToTarget=n.targetDistance,this._frameWindow.getViewer().currentViewpoint.moveTo(n),this._frameWindow.getViewer().render()},getVisibleAndOnModelAnnotationGroups:function(){let t=[];for(let e=0;e<this._annotViewpointList.length;e++)if(this._annotViewpointList[e].opacity>.1)t.push(this._annotViewpointList[e]);else if(this._annotViewpointList[e].onModelAnnotCount>0){let n={id:this._annotViewpointList[e].id,eyePosition:this._annotViewpointList[e].eyePosition,upDirection:this._annotViewpointList[e].upDirection,sightDirection:this._annotViewpointList[e].sightDirection,targetDistance:this._annotViewpointList[e].targetDistance,annotList:[],onModelAnnotCount:this._annotViewpointList[e].onModelAnnotCount},i=this._annotViewpointList[e].annotList;for(let t=0;t<i.length;t++)!0===i[t].onModel&&n.annotList.push(i[t]);t.push(n)}return t},getAnnotationBag:function(){return null!=this._annotGroupNode&&null!=this._annotGroupNode||(this._annotGroupNode=new o("annotGroupNode"),this._rootNode&&this._rootNode.add&&this._rootNode.add(this._annotGroupNode)),this._annotGroupNode},getModel:function(){if(!this._model&&this._rootNode&&this._rootNode.children)for(var t=0;t<this._rootNode.children.length;t++)"annotGroupNode"!==this._rootNode.children[t].name&&(this._model=this._rootNode.children[t]);return this._model},deleteAllAnnotations:function(){for(var t=0;t<this._annotViewpointList.length;t++)for(var e=this._annotViewpointList[t].annotList,n=0;n<e.length;n++){var i=this.getAnnotationBag();i&&i.remove(e[n].repBag),e[n].dispose()}this._annotViewpointList=[],this._frameWindow.experience&&this._frameWindow.experience.publish("3DPLAY/ANNONATION/SESSION",!1)},dispose:function(){e.unsubscribe(this.viewpointChangedToken),this.deleteAllAnnotations(),this._annotGroupNode&&this._rootNode&&this._rootNode.remove&&this._rootNode.remove(this._annotGroupNode),this._model=void 0,this._annotGroupNode=void 0,this._rootNode=void 0,this.viewpointChangedToken=null},updateViewPoint:function(t){var e=-1,n=this._annotViewpointList.length;if(n>0){for(var i=this._getCurrentViewpointInfo(),o=0;o<n;++o){var a=this._annotViewpointList[o];if(r._areAlmostSameViewpoints(a,i)){if("right"==t.direction){(e=o+1)==n&&(e=0);break}if("left"==t.direction){(e=o-1)<0&&(e=n-1);break}}}-1===e&&("right"==t.direction?e=0:"left"==t.direction&&(e=n-1))}this._setAnnotViewpointFromInfo(this._annotViewpointList[e],400)},updateViewPointOfInputAnnotation:function(t,e=200){for(var n=0;n<this._annotViewpointList.length;n++)for(var i=this._annotViewpointList[n],o=0;o<i.annotList.length;o++){if(i.annotList[o].id==t)return void this._setAnnotViewpointFromInfo(i,e)}},compareAnnotViewpointWithCurrent:function(t){for(var e=this._getCurrentViewpointInfo(),n=0;n<this._annotViewpointList.length;n++)for(var i=this._annotViewpointList[n],o=0;o<i.annotList.length;o++){if(i.annotList[o].id==t&&r._areAlmostSameViewpoints(i,e))return!0}return!1},setLowlightAnnotationID:function(t){for(var e=0;e<this._annotViewpointList.length;e++)for(var n=this._annotViewpointList[e],o=0;o<n.annotList.length;o++){var a=n.annotList[o];if(a.id==t)return void("text"===a.type?a.repBag.children[0].mesh3js.material.setValues({color:l}):a.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new i.Color(l)))}},repaintAnnotation:function(t,e){for(var n=0;n<this._annotViewpointList.length;n++)for(var o=this._annotViewpointList[n],a=0;a<o.annotList.length;a++){var r=o.annotList[a];if(r.id==t){let t=e?"#00BFFF":r.graphicalProp.color;return"text"===r.type?r.repBag.children[0].mesh3js.material.setValues({color:new i.Color(t)}):r.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new i.Color(t)),void this._frameWindow.experience.publish("3DPLAY/ANNONATION/UPDATE",{})}}},deleteAnnotationWithID:function(t){for(var e=!1,n=0;n<this._annotViewpointList.length;n++){for(var i=this._annotViewpointList[n],o=0;o<i.annotList.length;o++){var a=i.annotList[o];if(a.id==t){this.getAnnotationBag().remove(a.repBag),i.annotList.splice(o,1),e=!0,a.onModel&&i.onModelAnnotCount--,a.dispose();break}}if(0==i.annotList.length&&this._annotViewpointList.splice(n,1),this._frameWindow.experience&&(0===this._annotViewpointList.length?this._frameWindow.experience.publish("3DPLAY/ANNONATION/SESSION",!1):this._frameWindow.experience.publish("3DPLAY/ANNONATION/REMOVE",{})),e)return}},getAnnotationWithID:function(t){for(var e=0;e<this._annotViewpointList.length;e++){let i=this._annotViewpointList[e].annotList;for(var n=0;n<i.length;n++)if(i[n].id==t)return i[n]}},getAnnotationTypeWithID:function(t){let e=this.getAnnotationWithID(t);return e?e.type:""},changeAnnotPropertyWithID:function(t,e){if(e.color){let n=this.getAnnotationWithID(t);n&&(n.graphicalProp.color=e.color)}},getAnnotColorWithID:function(t){let e=this.getAnnotationWithID(t);if(e)return e.graphicalProp.color},addToAnnotGroupNode:function(t){let e=null;for(var n=0;n<this._annotViewpointList.length;n++)if(t.viewpointId===this._annotViewpointList[n].id){e=this._annotViewpointList[n];break}e||(e=this.getCurrentAnnotViewpoint()),e.annotList.push(t),this.getAnnotationBag().addChild(t.repBag),t.onModel&&e.onModelAnnotCount++,this._frameWindow.experience&&(1===this._annotViewpointList.length&&this._annotViewpointList[0].annotList&&1===this._annotViewpointList[0].annotList.length&&this._frameWindow.experience.publish("3DPLAY/ANNONATION/SESSION",!0),this._frameWindow.experience.publish("3DPLAY/ANNONATION/ADD",{})),this._refreshAnnotations(this._annotViewpointList)},getCurrentAnnotViewpoint:function(){for(var t=this._getCurrentViewpointInfo(),e=null,n=0;n<this._annotViewpointList.length;n++)if(r._areAlmostSameViewpoints(this._annotViewpointList[n],t)){e=this._annotViewpointList[n];break}return e||(e=this._createAnnotViewpoint()),e},saveAnnotationsToJSON:function(t,e){for(var n={ver:"1.0",explodeStates:[{id:0,viewpoints:[]}]},i=n.explodeStates[0].viewpoints,o=0;o<this._annotViewpointList.length;o++){var a=[];this._annotViewpointList[o].annotList.forEach((function(e){t&&t!==e.id||a.push(e.getJSON())})),a.length>0&&i.push({id:this._annotViewpointList[o].id,annotList:a,viewpointInfo:{eyePosition:this._annotViewpointList[o].eyePosition.clone(),upDirection:this._annotViewpointList[o].upDirection.clone(),sightDirection:this._annotViewpointList[o].sightDirection.clone(),targetDistance:this._annotViewpointList[o].targetDistance}})}var r=this.AnnotationAbbreviations.processJSON(n,"minify");return e||(r=JSON.stringify(r)),r},drawAnnotationsFromJSON:function(t,e){e&&this.deleteAllAnnotations();var i="string"==typeof t?JSON.parse(t):t;if(i.ver){var o,a=this.AnnotationAbbreviations.processJSON(i,"expand").explodeStates;this._frameWindow.experience&&(o=this._frameWindow.experience.getCurrentViewpoint());for(var r=0;r<a.length;r++)if(0===a[r].id)for(var s=a[r].viewpoints,l=0;l<s.length;l++){for(var h=(v=s[l]).id,d=v.viewpointInfo,c=v.annotList,u={frameWindow:this._frameWindow,annotationManager:this,viewpointId:h},p=0;p<this._annotViewpointList.length;p++)if(this._annotViewpointList[p].id===h){f=this._annotViewpointList[p];break}void 0===f&&(f=this._createAnnotViewpoint(d,h,c)),this._setAnnotViewpointFromInfo(f),f=void 0;for(var g=null,w=0;w<c.length;w++){switch(c[w].type){case"circle":g=new n.circle(u);break;case"ellipse":g=new n.ellipse(u);break;case"line":g=new n.line(u);break;case"rectangle":case"square":g=new n.rectangle(u);break;case"triangle":g=new n.triangle(u);break;case"unknownOpen":default:g=new n.unknownOpen(u);break;case"text":g=new n.text(u);break;case"arrow":g=new n.arrow(u);break;case"curvedArrow":g=new n.curvedArrow(u);break;case"doubleHeadedArrow":g=new n.doubleHeadedArrow(u);break;case"curvedDoubleHeadedArrow":g=new n.curvedDoubleHeadedArrow(u)}g.createFromJSON(c[w]),g.draw(),this.addToAnnotGroupNode(g)}}o&&(this._frameWindow.experience.setCurrentViewpoint(o),this._frameWindow.getViewer().currentViewpoint.getControl().update())}else if(i.Annotations){var m=t.replace(/arrowHead/g,"arrowhead");for(s=(i=JSON.parse(m)).Annotations,l=0;l<s.length;l++){var v,f;for(h=(v=s[l]).id,d=v.viewpointInfo,c=v.annotList,u={frameWindow:this._frameWindow,annotationManager:this,viewpointId:h},p=0;p<this._annotViewpointList.length;p++)if(this._annotViewpointList[p].id===h){f=this._annotViewpointList[p];break}void 0===f&&(f=this._createAnnotViewpoint(d,h,c)),this._setAnnotViewpointFromInfo(f),f=void 0;for(g=null,w=0;w<c.length;w++){switch(c[w].type){case"circle":g=new n.circle(u);break;case"ellipse":g=new n.ellipse(u);break;case"line":g=new n.line(u);break;case"rectangle":case"square":g=new n.rectangle(u);break;case"triangle":g=new n.triangle(u);break;case"unknownOpen":default:g=new n.unknownOpen(u);break;case"text":g=new n.text(u);break;case"arrow":g=new n.arrow(u);break;case"curvedArrow":g=new n.curvedArrow(u);break;case"doubleHeadedArrow":g=new n.doubleHeadedArrow(u);break;case"curvedDoubleHeadedArrow":g=new n.curvedDoubleHeadedArrow(u)}g.createFromJSON(c[w]),g.draw(),this.addToAnnotGroupNode(g)}}}else console.log("3DPlay: Invalid annotation JSON!")}})})),define("DS/3DPlayAnnotation3D/Annotation3DText",["DS/3DPlayAnnotation3D/Annotation3DCommand","DS/3DPlayAnnotationUtils/AnnotationText","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/3DPlayAnnotation3D/AnnotationShapes","DS/WebSystem/Environment","DS/Core/PointerEvents","DS/WebUtils/ContextedSingleton","DS/WebUtils/Tracker","DS/3DPlayAnnotation3D/AnnotationManagerUtils","DS/3DPlayWAFRMigration/WAFR2Utils"],(function(t,e,n,i,o,a,r,s,l,h){"use strict";var d;return t.extend({init:function(t){this._parent(t),d=this,t.previousCommand&&(this.previousCommand=t.previousCommand),t.endCommandCB&&(this.endCommandCB=t.endCommandCB),this._exp=this.frameWindow.experience,this.drawSettings=new n,this._exp&&this._exp.registerCollabAction&&this._exp.registerCollabAction("annotTextEnd",this.end.bind(this)),t.isMobile||h.isAFR2()?this.mab=!0:this.mab=!1},begin:function(t){this._parent(t),this.setViewer({control:!1,highlight:!1,pickable:!0}),this.viewer=this.frameWindow.getViewer(),this.currentView=this.viewer.currentView?this.viewer.currentView:0,this.viewerFrame=this.frameWindow.getViewerFrame(),t&&t.data&&(this.data=this.annotationManager.saveAnnotationsToJSON(t.data.annotationData.id)),this._createTextControl(t),t&&t.data&&this.textControl.setTextControlPosForEdit(t.data)},end:function(t){if(t.isCommandcancelled&&this.data){var e=l.getAnnotationManager(this.frameWindow.experience.ctx);e&&e.drawAnnotationsFromJSON(this.data),this.data=void 0}this.listnerContainer.removeEventListener(a.POINTERDOWN,this.pointerDown),this.listnerContainer.removeEventListener(a.POINTERMOVE,this.pointerMove),this.listnerContainer.removeEventListener(a.POINTERUP,this.pointerUp),this.listnerContainer.removeEventListener("mouseleave",this.mouseleave),this._exp&&this._exp.registerCollabAction("annotTextEnd"),this._refresh=void 0,this._destroyTextControl(),this.unsetViewer(),this._parent(t)},destroy:function(){this.drawSettings=void 0,d=null,this._parent()},_onWidgetResize:function(){setTimeout((function(){var t=d.textControl.getFieldText();d._destroyTextControl(),d._createTextControl(),d.viewerFrame=d.frameWindow.getViewerFrame();d.viewerFrame.getDimensions();t&&d.textControl.setFieldText(t),d.textControl.enable(),d.textControl.setFocus(),d.textControl.showControls()}),100)},widgetResize:function(t){d.currentTextControl.onTypeTextMab()},performForceValidate:function(){d.textControl&&d.textControl.validate()},_onValidate:function(t){s.command("Annotation3DText"),this._createAnnotation(t),this.textControl.clearTextField(),this.endCommandCB(this.previousCommand)},_createAnnotation:function(t){if(!this._exp||!1!==this._exp.collabMode){var e=new i.text({frameWindow:this.frameWindow,drawSettings:this.drawSettings,annotationManager:this.annotationManager});void 0!==t.ox&&(t.x=t.ox),e.createFromMousePositions(t),e.draw(),this.annotationManager.addToAnnotGroupNode(e);var n=this.frameWindow.experience;n&&!0===n.collabMode&&n.notifyAction&&this.frameWindow.experience.notifyAction("annot3DDraw",[this.annotationManager.saveAnnotationsToJSON(e.id)])}},_createTextControl:function(t){var n;t&&t.data&&(n=t.data),this.listnerContainer=this.frameWindow.getViewerFrame(),this.separate=function(t,e){void 0!==t.clientX?t.clientX:t.touches[0].clientX,void 0!==t.clientY?t.clientY:t.touches[0].clientY;this.textControl[e](t)},this.pointerDown=function(t){d.textControl.pointerDown(t)},this.pointerMove=function(t){d.separate(t,"pointerMove")},this.pointerUp=function(t){d.separate(t,"pointerup")},this.mouseleave=function(t){d.textControl.mouseleave(t)},this.listnerContainer.addEventListener(a.POINTERDOWN,this.pointerDown),this.listnerContainer.addEventListener(a.POINTERMOVE,this.pointerMove),this.listnerContainer.addEventListener(a.POINTERUP,this.pointerUp),this.listnerContainer.addEventListener("mouseleave",this.mouseleave);var i=this.frameWindow.getViewerFrame();this.textControl=new e({mode:"3D",mab:this.mab,listnerContainer:this.listnerContainer,floatingBarContainer:d.frameWindow.getViewerFrame(),viewerFrame:i,experience:this._exp,viewer:this.viewer,frameWindow:this.frameWindow,onOk:function(t){d._onValidate(t)},onCancel:function(){d.textControl.clearTextField(),d.endCommandCB(this.previousCommand)},onTypeStartCB:function(t){d.hideUI()},data:n,floatingbarCallback:this.floatingbarCallback});i.getDimensions();this.textControl.enable(),this.textControl.setTextControlPos(i.getBoundingClientRect())},_destroyTextControl:function(){this.textControl&&(this.textControl.destroy(),this.textControl=void 0),this.canvasViewer=void 0,this.viewerFrame=void 0},floatingbarCallback:function(t){"Delete3DPlay"==t.id?d.endCommandCB({command:d.previousCommand}):"Color3DPlay"==t.id&&d.drawSettings.setColor(t.color)}})})),define("DS/3DPlayAnnotation3D/AnnotationCommandText",["DS/3DPlayWAFRMigration/Command","DS/3DPlayAnnotation3D/AnnotationManagerUtils","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayAnnotation3D/AnnotationUtils","DS/CoreEvents/Events","DS/3DPlayAnnotation3D/Annotation3DText","DS/WebUtils/Tracker","DS/WebSystem/BrowserInfos","DS/3DPlayAnnotationUtils/ShapeUtils","DS/WebUtils/GeometryUtils","DS/Visualization/ThreeJS_DS","DS/3DPlayWAFRMigration/3DPlayCommandsTools"],(function(t,e,n,i,o,a,r,s,l,h,d,c,u,p,g,w){"use strict";var m;return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),this._exp=this.getFrameWindow().experience},beginExecute:function(){m=this,n.empty(),i.empty(),o.empty(),this.frameWindow=this.getFrameWindow();var t=this.frameWindow.getActionBar();t&&w.isActionBarOpen(t)&&t.toggle();let a=this.frameWindow.getMAB();if(a.state&&a.state.open&&a.toggleMainView(),t)var r=t.onActionBarOpen((function(){t.removeCallback(r),m.data&&m.Text3D?m.Text3D.performForceValidate():m.end()}));this.annotationManager=e.getAnnotationManager(this._ctx,this.frameWindow),s.setNodePickable(this.annotationManager.getModel(),!1),m._exp&&m._exp.notifyAction&&!0===m._exp.collabMode&&m._exp.notifyAction("annotBeginExecute"),m.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize),m.frameWindow.experience&&m.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_ACTIVATED",{}),l.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!0}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!1,"FLY_WALK"),this.data=m.frameWindow.getViewer().shapeEditionData,this.AFR2_Execute()},execute:function(){var t;if(d.startCommand(this.getId()),this.Text3D=new h({isMobile:c.isMobile(),frameWindow:this.frameWindow,annotationManager:this.annotationManager,hideTools:function(){m._removeTools()},data:this.data,mode:"edition",endCommandCB:this.endCommandCB}),this.data&&(t=this.annotationManager.getAnnotationWithID(this.data.id)),t){var e=l.subscribe({event:"/VISU/"},(function(n){if("@onViewpointEndMove"==n.eventType){let n=m.frameWindow.getViewer(),o=t.get3DGeometry(t.points),a=[],r=[];a=u.onScreenProjection(o.vertices,n),r.push(p.boundingBoxCompute(p.convexHullCompute(a)));let h=20,d=r[0][1].x,c=r[0][1].y,w=r[0][3].x,v=r[0][3].y,f=m.frameWindow.getViewerFrame().getBoundingClientRect(),D=f.top,x=f.left,y=f.right,P=f.bottom;if(d<x||c<D||w>y||v>P){var i=new g.Vector3;D>c&&(i.y=D-c+h),x>d&&(i.x=-(x-d+h)),y<w&&(i.x=w-y+h),P<v&&(i.x=-(v-P+h));let e=new g.Vector3,o=n.currentViewpoint,a=o.getCamera(),r=n.getMousePosition(new g.Vector2(i.x,i.y)),l=n.getMousePosition(new g.Vector2(e.x,e.y)),u=s.screenToWorldPlaneProjection([r,l],t.points[0].z,a);i.setLength(u[0].distanceTo(u[1])),i.applyQuaternion(o.control.orientation);let p=o.target.clone().add(i),m=o.control.distanceToTarget;o.moveTo({eyePosition:(new g.Vector3).addVectors(p,o.getCamera().getLookAt().clone().normalize().multiplyScalar(-m)),duration:0})}else m.Text3D.begin({data:{annotationData:t}}),m.annotationManager.deleteAnnotationWithID(m.data.id),m.getFrameWindow().getViewer().render(),l.unsubscribe(e)}}));this.annotationManager.updateViewPointOfInputAnnotation(m.data.id)}else this.Text3D.begin()},endExecute:function(){d.endCommand(this.getId()),l.unsubscribe(this.MBAShow),l.unsubscribe(this.MBAHide),this.frameWindow.getViewerFrame().removeEvent("resize",this._onWidgetResize),this._endCommands(),m.frameWindow.experience&&m.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_DEACTIVATED",{}),this.annotationToolsMenu&&(this.annotationToolsMenu.dispose(),this.annotationToolsMenu=void 0),this.contextualMenu&&this.contextualMenuToken&&(this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenuToken=void 0,this.contextualMenu=void 0),this.Text3D&&(this.Text3D.destroy(),this.Text3D=void 0),n.empty(),i.empty(),o.empty(),s.setNodePickable(this.annotationManager.getModel(),!0);var t=this.frameWindow.getActionBar();t?w.isActionBarOpen(t)||t.toggle():this.frameWindow.getMAB().showFlyout(0),this.frameWindow.getViewer().shapeEditionData=void 0,this.frameWindow=void 0,l.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!1}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!0,"FLY_WALK"),m=null,this.AFR2_Done()},_endCommands:function(){this.annotationToolsMenu&&this.annotationToolsMenu.colorPaletteVisible&&this._hideColorPalette();var t=!1;this.isCanceled()&&(t=!0),this.Text3D&&this.Text3D.isRunning()&&this.Text3D.end({isCommandcancelled:t})},endCommandCB:function(t){m.end()},refreshAnnotations:function(){},_startCommand:function(t,e){this._newMenuStartCommand(t,e)},_newMenuStartCommand:function(t,e){this._hideColorPalette(),"3DDelete"===t.id&&m.end()},_buildUI:function(){this.contextualMenu=new a({frameWindow:this.frameWindow});var t={type:this.contextualMenu.Button.Check,id:"3DDelete",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(t){m._startCommand(t)}};this.contextualMenuToken=this.contextualMenu.addButtons([t],{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.annotationToolsMenu=new r({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:!0}),this.annotationToolsMenu.addToolsButton(),this.contextualMenu.panel.container.style.cursor="pointer",this._hideColorPalette()},_removeTools:function(){this._hideColorPalette()},_hideColorPalette:function(){this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()},_onWidgetResize:function(t){c.isMobile()||m&&m.frameWindow&&m.cancel()},_destroy:function(){this._parent()}})})),define("DS/3DPlayAnnotation3D/Annotation3DErase",["DS/3DPlayAnnotation3D/Annotation3DCommand","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/3DPlayAnnotationUtils/ShapeUtils","DS/Core/PointerEvents","DS/WebUtils/Vector2","DS/WebappsUtils/WebappsUtils","DS/3DPlayAnnotationUtils/CursorManager","DS/WebSystem/Environment"],(function(t,e,n,i,o,a,r,s,l,h,d,c){"use strict";var u;return t.extend({init:function(t){this._parent(t),this.exp=t.frameWindow.experience,u=this,this._hideTools=t.hideTools},begin:function(t){this._parent(t),e.empty(),n.empty(),i.empty(),this.setViewer({control:!1,highlight:!1,pickable:!0}),this._prevMousePos=null,this._currMousePos=null,this._annot2D=[],this._annotIDDelList=[],this.mousePosition=[],this._erase=function(t){var e=void 0;if(u.exp&&!1!==u.exp.collabMode){var n=t.pathElement.externalPath;if(n.length>0){var i=n[n.length-1];"Annotation_Representation"==i.name&&(e=i.annotID)}}else u.exp&&!1===u.exp.collabMode&&(e=t);if(void 0!==e){u.annotationManager.deleteAnnotationWithID(e);for(var o=0;o<u._annot2D.length;o++)u._annot2D[o].id===e&&u._annot2D.splice(o,1);u.exp&&!0===u.exp.collabMode?u.exp.notifyAction&&u.exp.notifyAction("annot3DErase",[e]):u.exp&&!1===u.exp.collabMode&&u.viewer.render()}},this.exp&&this.exp.registerCollabAction&&this.exp.registerCollabAction("annot3DErase",this._erase.bind(this)),this._CSOAddToken=e.onAdd(this._erase),this._build2DBB(),this._activateManipulators()},end:function(t){this._deleteListedAnnotations(),e.unsubscribe(this._CSOAddToken),this._CSOAddToken=null,this._disableManipulators(),this._prevMousePos=null,this._currMousePos=null,this._annot2D=null,this.mousePosition=[],this._deactivateCustomCursor(),this.unsetViewer(),e.empty(),this._parent(t)},destroy:function(){u=null,this._parent()},_getSmallerBoundingBoxes:function(t){for(var e=[],n=1,i=[],a=0;a<t.length;a++)++n>10&&(e.push(o.boundingBoxCompute(o.convexHullCompute(i))),n=1,i=[]),i.push(t[a]);return e.push(o.boundingBoxCompute(o.convexHullCompute(i))),e},_build2DBB:function(){let t=this.annotationManager.getVisibleAndOnModelAnnotationGroups();for(var e=0;e<t.length;e++)for(var n=t[e].annotList,i=0;i<n.length;i++){var s=n[i],l=[];if("text"==s.type){var h=s.get3DGeometry(s.points);l=r.onScreenProjection(h.vertices,this.viewer)}else l=r.onScreenProjection(s.points,this.viewer);let t=!0;if(s.onModel){let e=this.annotationManager.getModel();a.setNodePickable(e,!0),t=!1;for(let e=0;e<l.length;e++){let n=this.viewer.getMousePosition(l[e]),i=this.viewer.pick(n,"mesh",!0);if(i.path.length>0){let e=i.path[0].externalPath;for(let n=0;n<e.length;n++)if("Annotation_Representation"===e[n].name||void 0!==e[n].annotId){t=!0;break}}}a.setNodePickable(e,!1)}if(t){for(var d=o.convexHullCompute(l),c=[],u=[],p=0;p<d.length;++p)c.push(d[p].x),u.push(d[p].y);c.sort((function(t,e){return t-e})),u.sort((function(t,e){return t-e}));var g=c.length-1,w=[{x:c[0],y:u[0]},{x:c[g],y:u[0]},{x:c[g],y:u[g]},{x:c[0],y:u[g]}];this._annot2D.push({id:s.id,boundingBox:w,point2D:l,type:s.type})}}},_activateManipulators:function(){this.draw=!1,this.proxyEventTarget=this.frameWindow.getViewerFrame(),u._activateCustomCursor(),this.proxyEventTarget.addEvent(s.POINTERDOWN,(function(t){if(0==t.button&&!0!==u.viewer.currentViewpoint.isMoving()){if(u._build2DBB(),u._annotIDDelList=[],u._hideTools&&u._hideTools(),u.draw=!0,t.touchFlag&&u.cursorManager){var e=u.frameWindow.getUIFrame().getBoundingClientRect();u.cursorManager.setTouchCursor({position:[t.clientX-e.left,t.clientY-e.top],container:u.frameWindow.getUIFrame(),drawSettings:u.drawSettings})}u._deleteRepFromPick(t)}})),this.proxyEventTarget.addEvent(s.POINTERMOVE,(function(t){if(0==t.button&&1==u.draw&&!0!==u.viewer.currentViewpoint.isMoving()){if(t.touchFlag&&u.cursorManager){var e=u.frameWindow.getUIFrame().getBoundingClientRect();u.cursorManager.setTouchCursor({position:[t.clientX-e.left,t.clientY-e.top],container:u.frameWindow.getUIFrame(),drawSettings:u.drawSettings})}u._deleteRepFromPick(t)}})),this.proxyEventTarget.addEvent(s.POINTERUP,(function(t){0==t.button&&1==u.draw&&!0!==u.viewer.currentViewpoint.isMoving()&&(u._deleteRepFromPick(t),u.drawSettings.setEraserThickness(30),u._setMouseCursor("custom_eraser"),u.mousePosition=[],u.draw=!1,u._prevMousePos=null,u._currMousePos=null,u._deleteListedAnnotations())}))},_disableManipulators:function(){this.proxyEventTarget.removeEvent(s.POINTERDOWN),this.proxyEventTarget.removeEvent(s.POINTERMOVE),this.proxyEventTarget.removeEvent(s.POINTERUP),this.proxyEventTarget=void 0},_deleteRepFromPick:function(t){var e=this.viewer.canvas.getBoundingClientRect(),n=new l(t.clientX-e.left,t.clientY-e.top);if(c.isSet("3DPlay.EraserWithSpeed")){var i={x:t.clientX,y:t.clientY};if(this.mousePosition.push(i),this.mousePosition.length>10){var a=Math.abs(i.x-this.mousePosition[this.mousePosition.length-10].x),r=Math.abs(i.y-this.mousePosition[this.mousePosition.length-10].y),s=Math.sqrt(a*a+r*r);s<=50?this.drawSettings.setEraserThickness(30):s>50&&s<=70?this.drawSettings.setEraserThickness(40):s>70&&s<=90?this.drawSettings.setEraserThickness(50):s>90&&s<=110?this.drawSettings.setEraserThickness(60):s>110&&s<=130?this.drawSettings.setEraserThickness(70):s>130&&s<=150?this.drawSettings.setEraserThickness(80):this.drawSettings.setEraserThickness(90),this._setMouseCursor("custom_eraser")}}if(this._currMousePos){for(var h=this.drawSettings.getEraserThickness()/2,d=n.x,p=n.y,g=2*Math.PI/10,w=[],m=0;m<2*Math.PI;m+=g)w.push({x:d+h*Math.cos(m),y:p+h*Math.sin(m)});this._prevMousePos=this._currMousePos,this._currMousePos=new l(n.x,n.y);var v=o.boundingBoxCompute(o.convexHullCompute([this._prevMousePos,this._currMousePos])),f=this._annot2D.filter((function(t,e,n){var i=!1;if("text"==t.type)o.isIntersect(v,t.boundingBox)&&(u.annotationManager.setLowlightAnnotationID(t.id),u._annotIDDelList.push(t.id),i=!0,u.exp&&!0===u.exp.collabMode&&u.exp.notifyAction&&u.exp.notifyAction("annot3DErase",[t.id]));else{let e=o.boundingBoxCompute(o.convexHullCompute(t.point2D)),n=e[0].distanceTo(e[2]),r=2*h;if("unknownopen"===t.type.toLowerCase()&&n<=r){for(var a=0;a<t.point2D.length-1;++a)if(o._isInsidePolygon(t.point2D[a],w)){u.annotationManager.setLowlightAnnotationID(t.id),u._annotIDDelList.push(t.id),i=!0,u.exp&&!0===u.exp.collabMode&&u.exp.notifyAction&&u.exp.notifyAction("annot3DErase",[t.id]);break}}else o.isIntersect(w,t.point2D)&&(u.annotationManager.setLowlightAnnotationID(t.id),u._annotIDDelList.push(t.id),i=!0,u.exp&&!0===u.exp.collabMode&&u.exp.notifyAction&&u.exp.notifyAction("annot3DErase",[t.id]))}return!i}));this._annot2D=f}else this._currMousePos=new l(n.x,n.y);this.viewer.render()},_deleteListedAnnotations:function(){for(var t=0;t<this._annotIDDelList.length;++t)this.annotationManager.deleteAnnotationWithID(this._annotIDDelList[t]);this.viewer.render(),this._annotIDDelList=[]},_activateCustomCursor:function(){this.cursorManager=new d,u._setMouseCursor("custom_eraser")},_setMouseCursor:function(t){this.cursorManager&&this.cursorManager.setMouseCursor({container:this.viewer.canvas,caller:"2D",type:t,drawSettings:this.drawSettings})},_deactivateCustomCursor:function(){this.cursorManager&&(this.drawSettings.setEraserThickness(30),this._setMouseCursor("auto"),this.cursorManager.deleteTouchCursor(),this.cursorManager.dispose(),this.cursorManager=null)}})})),define("DS/3DPlayAnnotation3D/Annotation3DEditPreview",["UWA/Class","UWA/Core","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/3DPlayAnnotationUtils/CursorManager","DS/Core/PointerEvents","DS/WebUtils/Vector2","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/WebSystem/Environment","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotationUtils/ShapeUtils","DS/3DPlayAnnotationUtils/AnnotationShapeManipulator","DS/3DPlayAnnotation3D/AnnotationShapes","DS/3DPlayAnnotation3D/AnnotationUtils","DS/Visualization/ThreeJS_DS","DS/WebRunloop/Runloop","DS/3DPlayAnnotationUtils/CanvasShapes","DS/3DPlayAnnotationUtils/AnnotationUtilities"],(function(t,e,n,i,o,a,r,s,l,h,d,c,u,p,g,w,m,v){"use strict";var f;return t.extend({init:function(t){this._parent(t),f=this,this.frameWindow=t.frameWindow,this.hideUICB=t.hideUICB,this.strokeCompleteCB=t.strokeCompleteCB,this.annotationManager=t.annotationManager,this.editCB=t.editCB,this.endCB=t.endCB,this.drawSettings=new n,this.viewerPoints=[],this.viewerLineThickness=[],f.annotationEdit=[],f.annotationData=void 0,f.editStarted=!1,f.draw=!1,f.gesture=!1,f.editStartbbox=[],f.annot2DPoints=[],f.viewPointShiftNeeded=!1,this.mode=t.mode,this.data=t.data},begin:function(t){this._createCanvas(),this.viewer=this.frameWindow.getViewer(),this.cursorContainer=this.viewer.canvas,this.cursorManager=new i,this.mode&&"edition"==this.mode&&this.data||this._setMouseCursor("custom"),this.runloop=new w({data:this,func:this._runloopFunc}),this.runloop.start(),this._build2DBB(),f.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize),f.viewerFrameDimensions={height:f.frameWindow.getViewerFrame().clientHeight,width:f.frameWindow.getViewerFrame().clientWidth},this.tokenSettingsChanged=r.subscribe({event:"3DPlay.Annotation.SettingsChanged"},(function(t){f.exp&&!0===f.exp.collabMode&&f.exp.notifyAction&&f.exp.notifyAction("annotChangeSettings",[t]),f.mode&&"edition"==f.mode&&f.data||f._setMouseCursor("custom"),1==f.editStarted&&f.annotationEdit.length&&f.annotationData&&(f.annotationManager.changeAnnotPropertyWithID(f.annotationEdit[0],{color:f.drawSettings.getColor()}),f.annotationManager.repaintAnnotation(f.annotationEdit[0],!1),f.viewer.render())})),this.viewpointChangedToken=r.subscribe({event:"/VISU/"},(function(t){if(("@onViewpointEndMove"==t.eventType||"@onViewpointChange"==t.eventType)&&(f._build2DBB(),1==f.viewPointShiftNeeded)){var e;f.viewPointShiftNeeded=!1;for(var n=0;n<f._annot3D.length;n++){if(f._annot3D[n].id==f.selectedshiftID){e=f._annot3D[n].point2D;break}}if(e&&e.length){var i=e[0],o=f.viewer.canvas.getBoundingClientRect();f._onClick({clientX:i.x+o.left,clientY:i.y+o.top},!0)}}})),s.addEvent(this.frameWindow.getViewerFrame(),"onKeyDown",this._keyboardcallback),this._activateManipulators(),this.mode&&"edition"==this.mode&&this.data&&f._onClick({clientX:this.data.point.x,clientY:this.data.point.y},!0)},end:function(t){f.annotationEdit.length&&f.annotationData&&f.viewer&&(f.annotationManager.repaintAnnotation(f.annotationEdit[0],!1),f.annotationEdit=[],f.annotationData=void 0,f.editStartbbox=[],f.annot2DPoints=[],f.editStarted=!1,f.manipulators.cleanManipulators(),f.viewer.render()),f.editStartbbox=[],f.annot2DPoints=[],r.unsubscribe(this.tokenSettingsChanged),r.unsubscribe(this.viewpointChangedToken),s.removeEvent(this.frameWindow.getViewerFrame(),"onKeyDown",this._keyboardcallback),this._disableManipulators(),this.cursorManager&&(this._setMouseCursor("auto"),this.cursorManager.dispose(),this.cursorManager=null),f.frameWindow.getViewerFrame().removeEvent("resize",this._onWidgetResize),this._destroyCanvas(),this.drawSettings=void 0,this.cursorContainer=void 0,this.viewer=void 0,this._annot3D=null,f.runloop&&(f.runloop.stop(),f.runloop.dispose(),f.runloop=null)},destroy:function(){this.viewerPoints=[],this.viewerLineThickness=[],this.frameWindow=void 0,this.hideUICB=void 0,this.strokeCompleteCB=void 0,this.editCB=void 0,f=null},_onWidgetResize:function(t){var e=f.frameWindow.getViewerFrame().getDimensions();f.viewerFrameDimensions.height==e.height&&f.viewerFrameDimensions.width==e.width||(f.viewerFrameDimensions.height=e.height,f.viewerFrameDimensions.width=e.width,f._createCanvas())},_build2DBB:function(){this._annot3D=[];for(var t=this.annotationManager.getVisibleAndOnModelAnnotationGroups(),e=0;e<t.length;e++)for(var n=t[e].annotList,i=0;i<n.length;i++){var o=n[i],a=[];if("text"==o.type){var r=o.get3DGeometry(o.points);a=d.onScreenProjection(r.vertices,f.viewer)}else a=d.onScreenProjection(o.points,f.viewer);for(var s=h.convexHullCompute(a),l=[],c=[],u=0;u<s.length;++u)l.push(s[u].x),c.push(s[u].y);l.sort((function(t,e){return t-e})),c.sort((function(t,e){return t-e}));var p=l.length-1,g=[{x:l[0],y:c[0]},{x:l[p],y:c[0]},{x:l[p],y:c[p]},{x:l[0],y:c[p]}];f._annot3D.push({id:o.id,boundingBox:g,annotationData:o,point2D:a,type:o.type})}},_setMouseCursor:function(t){this.cursorManager&&this.cursorManager.setMouseCursor({container:this.cursorContainer,caller:"3D",type:t,drawSettings:this.drawSettings})},_createCanvas:function(){this._destroyCanvas();var t=this.frameWindow.getUIFrame();this.canvas=new e.Element("canvas",{id:"annotPreviewCanvas",styles:{zindex:"2000",pointerEvents:"none"}}).inject(t);var n=this.frameWindow.getViewerFrame().getDimensions();this.canvas.width=n.width,this.canvas.height=n.height,this.canvasContext=this.canvas.getContext("2d")},_destroyCanvas:function(){this.canvasContext=void 0,this.canvas&&(this.canvas.remove(),this.canvas=void 0)},_setStrokeStyle:function(){this.canvasContext.strokeStyle=""+this.drawSettings.getColor(),this.canvasContext.fillStyle=""+this.drawSettings.getColor(),this.canvasContext.globalAlpha=1,this.canvasContext.lineCap="round",this.canvasContext.lineJoin="round",this.canvasContext.lineWidth=this.drawSettings.getThickness()},_getPosition:function(t){var e=this.canvas.getBoundingClientRect(),n=this.viewer.getMousePosition(new g.Vector2(t.clientX,t.clientY));return new a(n.xPix/window.devicePixelRatio-e.left,n.yPix/window.devicePixelRatio-e.top)},_beginMove:function(t){if(1==f.editStarted&&f.annotationEdit.length)f.annotationManager.repaintAnnotation(f.annotationEdit[0],!1),f.annotationEdit=[],f.annotationData=void 0,f.editStartbbox=[],f.annot2DPoints=[],f.editStarted=!1,f.manipulators.cleanManipulators(),f.viewer.render(),f.mode&&"edition"==f.mode&&f.endCB&&f.endCB();else{f._onClick(t,!1,!0)}},_onClick:function(t,e,n){if(f.hideUICB(),1==n){if(f.annotationEdit.length)f.annotationManager.repaintAnnotation(f.annotationEdit[0],!1),f.annotationEdit=[],f.annotationData=void 0,f.editStartbbox=[],f.annot2DPoints=[],f.editStarted=!1,f.manipulators.cleanManipulators(),f.viewer.render();f.draw=!0,f.viewerPoints=[],f.startPt=void 0,f.currentScreenPt=void 0,f.viewerLineThickness=[];var i=f._getPosition(t);f.startPt=new a(t.clientX,t.clientY),f.currentScreenPt=new a(t.clientX,t.clientY),f.viewerPoints.push(i),f.hideUICB(),f._setStrokeStyle(),f.canvasContext.beginPath(),f.canvasContext.moveTo(i.x,i.y)}else{t.clientX,t.clientY;var o,r=[],s=void 0,l=f._checkRepFromPick(t);if(l&&l.annotIDDelList&&l.annotIDDelList.length)r=l.annotIDDelList,s=l.annotationData,o=l.bBox,f.annotSelectedForEditJson=f.annotationManager.saveAnnotationsToJSON(r[0]);else if(this.mode&&"edition"==this.mode&&this.data&&f.endCB)return void f.endCB();1==e&&0==f.annotationEdit.length&&r.length&&(f.annotationEdit=r,s&&"text"==s.type||(f.annotationData=s,f.editStartbbox=o,f.annotationManager.repaintAnnotation(f.annotationEdit[0],!1),f.viewer.render()));var h=!1;if(f.annotationEdit.length==r.length)for(var c=0;c<f.annotationEdit.length&&!(0>r.indexOf(f.annotationEdit[c]));c++)c==f.annotationEdit.length-1&&(h=!0);if(1==r.length&&1==h)if(s&&"text"==s.type)f.editCB(l);else if(0==f.editStarted)if(0==f.annotationManager.compareAnnotViewpointWithCurrent(r[0])&&(f.viewPointShiftNeeded=!0,f.selectedshiftID=r[0]),1==f.viewPointShiftNeeded)f.annotationManager.repaintAnnotation(f.annotationEdit[0],!1),f.annotationEdit=[],f.annotationData=void 0,f.editStartbbox=[],f.annot2DPoints=[],f.editStarted=!1,f.viewer.render(),f.annotationManager.updateViewPointOfInputAnnotation(r[0],0);else{let t,e,n,i;f.editStarted=!0;let a,r=20,l=this.canvas.getBoundingClientRect();for(let t in f._annot3D)if(f._annot3D[t].id==f.annotationEdit[0]){a=t;break}if(e=f._annot3D[a].boundingBox[0].x,t=f._annot3D[a].boundingBox[0].y,n=f._annot3D[a].boundingBox[2].y,i=f._annot3D[a].boundingBox[2].x,i-e>l.right-l.left||n-t>l.bottom-l.top)f.frameWindow._viewpoint.reframe(void 0,0,f.annotationData.repBag._bsShow);else if(t<l.top||e<l.left||i>l.right||n>l.bottom){var u=new g.Vector3;t<l.top&&(u.y=l.top-t+r),e<l.left&&(u.x=-(l.left-e+r)),n>l.bottom&&(u.y=-(n-l.bottom+r)),i>l.right&&(u.x=i-l.right+r);let o=new g.Vector3,a=this.frameWindow.getViewer(),h=this.viewer.currentViewpoint.getCamera(),d=a.getMousePosition(new g.Vector2(u.x,u.y)),c=a.getMousePosition(new g.Vector2(o.x,o.y)),w=p.screenToWorldPlaneProjection([d,c],s.points[0].z,h);u.setLength(w[0].distanceTo(w[1])),u.applyQuaternion(f.frameWindow._viewpoint.control.orientation);let m=f.frameWindow._viewpoint.target.clone().add(u),v=f.frameWindow._viewpoint.control.distanceToTarget;f.frameWindow._viewpoint.moveTo({eyePosition:(new g.Vector3).addVectors(m,f.frameWindow._viewpoint.getCamera().getLookAt().clone().normalize().multiplyScalar(-v)),duration:0})}let h=d.onScreenProjection(f.annotationData.points,f.viewer);f._deleteSelectedAnnotationAndRedraw(h);for(let t in f._annot3D)if(f._annot3D[t].id==f.annotationEdit[0]){a=t;break}o=f._annot3D[a].boundingBox,f.manipulators.createManipulators({bbox:o,color:f.annotationManager.getAnnotColorWithID(f.annotationEdit[0]),container:f.frameWindow.getViewerFrame()})}}},_move:function(t){if(1==f.gesture&&(f.draw=!1),1==f.draw&&!0!==f.viewer.currentViewpoint.isMoving()){var e=f._getPosition(t),n={position:e,isShiftKeyDown:t.shiftKey&&l.isSet("3DPlay.ActivateShiftStraightLineAnnotation"),direction:f.direction,viewerPoints:f.viewerPoints};f.direction=v._addPositionToViewerPoints(n),f.currentScreenPt=new a(t.clientX,t.clientY),f.viewerLineThickness.push(f.canvasContext.lineWidth),f.canvasContext.lineTo(e.x,e.y),f.canvasContext.stroke(),f.canvasContext.beginPath(),f.canvasContext.moveTo(e.x,e.y)}},_endMove:function(t){if(1==f.draw&&0==f.gesture&&!0!==f.viewer.currentViewpoint.isMoving()){var e=f._getPosition(t);if(1==f.viewerPoints.length&&f.viewerPoints[0].x==e.x&&f.viewerPoints[0].y==e.y);else{var n={position:e,isShiftKeyDown:t.shiftKey&&l.isSet("3DPlay.ActivateShiftStraightLineAnnotation"),direction:f.direction,viewerPoints:f.viewerPoints};if(f.direction=v._addPositionToViewerPoints(n),void 0!==f.direction){var i=d.shapeEval(f.viewerPoints).shape,o={color:f.drawSettings.getColor(),thickness:parseInt(f.drawSettings.getThickness()),transparency:1};f.recognizedshapeData=m.createShape({shapeData:i,settings:o})}f.direction=void 0}var a=!1;if(f.recognizedshapeData)a=!0;else try{i=d.filterAndSmoothPoints(f.viewerPoints,!0);f.viewerPoints=i}catch(t){console.log("error in shapeUtil")}f.strokeCompleteCB(f.viewerPoints,void 0,a),f.viewerPoints=[],f.startPt=void 0,f.currentScreenPt=void 0,f.viewerLineThickness=[],f.canvasContext.clearRect(0,0,f.canvas.width,f.canvas.height),f._build2DBB()}f.draw=!1,f.gesture=!1},_runloopFunc:function(t){if(f.draw&&this.canvas)if(null==f.stationaryPos)f.stationaryPos=f.currentScreenPt,f.starttime=t.deltaTime,f.recognizedshapeData=void 0;else if(f.currentScreenPt.distanceTo(f.stationaryPos)<5){if(f.starttime=f.starttime+t.deltaTime,300<f.starttime){var e=d.shapeEval(f.viewerPoints).shape;if("unknownOpen"!=e.type&&"unknownClosed"!=e.type){var n={color:f.drawSettings.getColor(),thickness:parseInt(f.drawSettings.getThickness()),transparency:1};f.recognizedshapeData=m.createShape({shapeData:e,settings:n}),(a=f.canvas.getContext("2d")).clearRect(0,0,f.canvas.width,f.canvas.height),a.globalAlpha=1,m.drawShape({shape:JSON.parse(JSON.stringify(f.recognizedshapeData)),canvas:f.canvas,scale:1,angle:0}),a.globalAlpha=.3,a.beginPath();var i=f.viewerPoints.length;a.moveTo(f.viewerPoints[0].x,f.viewerPoints[0].y);for(var o=1;o<i;++o)a.lineTo(f.viewerPoints[o].x,f.viewerPoints[o].y);a.stroke()}}}else{if(f.recognizedshapeData){var a;f.stationaryPos=f.currentScreenPt,f.starttime=t.deltaTime,f.recognizedshapeData=void 0,(a=f.canvas.getContext("2d")).clearRect(0,0,f.canvas.width,f.canvas.height),a.globalAlpha=1;i=f.viewerPoints.length;a.moveTo(f.viewerPoints[0].x,f.viewerPoints[0].y);for(o=1;o<i;++o)a.lineTo(f.viewerPoints[o].x,f.viewerPoints[o].y);a.stroke()}f.stationaryPos=f.currentScreenPt,f.starttime=t.deltaTime}},_startShapeEdit:function(t){f.currDeltaType=t.deltaType,f.annot2DPoints=[],f.annot2DPoints=d.onScreenProjection(f.annotationData.points,f.viewer)},_editShape:function(t){var e=f.editStartbbox[2].y-f.editStartbbox[1].y,n=f.editStartbbox[1].x-f.editStartbbox[0].x,i={x:(f.editStartbbox[3].x+f.editStartbbox[1].x)/2,y:(f.editStartbbox[3].y+f.editStartbbox[1].y)/2};if("BothWithCenter"==t.deltaType)for(var o=0;o<f.annot2DPoints.length;o++)f.annot2DPoints[o]=new a(f.annot2DPoints[o].x+t.deltaX,f.annot2DPoints[o].y+t.deltaY);else if("BottomWithCenter"==t.deltaType&&0!=e){var r=(g=e+t.deltaY)-e,s=f.editStartbbox[1].y;if(0<g)for(o=0;o<f.annot2DPoints.length;o++)f.annot2DPoints[o]=new a(f.annot2DPoints[o].x,f.annot2DPoints[o].y+(f.annot2DPoints[o].y-s)/e*r)}else if("TopWithCenter"==t.deltaType&&0!=e){r=(g=e-t.deltaY)-e;var l=f.editStartbbox[2].y;if(0<g)for(o=0;o<f.annot2DPoints.length;o++)f.annot2DPoints[o]=new a(f.annot2DPoints[o].x,f.annot2DPoints[o].y+(f.annot2DPoints[o].y-l)/e*r)}else if("LeftWithCenter"==t.deltaType&&0!=n){var d=(p=n-t.deltaX)-n,c=f.editStartbbox[1].x;if(0<p)for(o=0;o<f.annot2DPoints.length;o++)f.annot2DPoints[o]=new a(f.annot2DPoints[o].x=f.annot2DPoints[o].x+(f.annot2DPoints[o].x-c)/n*d,f.annot2DPoints[o].y)}else if("RightWithCenter"==t.deltaType&&0!=n){d=(p=n+t.deltaX)-n;var u=f.editStartbbox[0].x;if(0<p)for(o=0;o<f.annot2DPoints.length;o++)f.annot2DPoints[o]=new a(f.annot2DPoints[o].x=f.annot2DPoints[o].x+(f.annot2DPoints[o].x-u)/n*d,f.annot2DPoints[o].y)}else if("LeftWithTop"==t.deltaType){var p=n-t.deltaX,g=e-t.deltaY;d=p-n,c=f.editStartbbox[1].x,r=g-e,l=f.editStartbbox[2].y;if(0==n&&(d=0),0==e&&(r=0),0<p&&0<g)for(o=0;o<f.annot2DPoints.length;o++){var w=f.annot2DPoints[o].x,m=f.annot2DPoints[o].y;d&&(w=f.annot2DPoints[o].x+(f.annot2DPoints[o].x-c)/n*d),r&&(m=f.annot2DPoints[o].y+(f.annot2DPoints[o].y-l)/e*r),f.annot2DPoints[o]=new a(w,m)}}else if("RightWithBottom"==t.deltaType){p=n+t.deltaX,g=e+t.deltaY,d=p-n,u=f.editStartbbox[0].x,r=g-e,s=f.editStartbbox[1].y;if(0==n&&(d=0),0==e&&(r=0),0<p&&0<g)for(o=0;o<f.annot2DPoints.length;o++){w=f.annot2DPoints[o].x,m=f.annot2DPoints[o].y;d&&(w=f.annot2DPoints[o].x+(f.annot2DPoints[o].x-u)/n*d),r&&(m=f.annot2DPoints[o].y+(f.annot2DPoints[o].y-s)/e*r),f.annot2DPoints[o]=new a(w,m)}}else if("LeftWithBottom"==t.deltaType){p=n-t.deltaX,g=e+t.deltaY,d=p-n,c=f.editStartbbox[1].x,r=g-e,s=f.editStartbbox[1].y;if(0==n&&(d=0),0==e&&(r=0),0<p&&0<g)for(o=0;o<f.annot2DPoints.length;o++){w=f.annot2DPoints[o].x,m=f.annot2DPoints[o].y;d&&(w=f.annot2DPoints[o].x+(f.annot2DPoints[o].x-c)/n*d),r&&(m=f.annot2DPoints[o].y+(f.annot2DPoints[o].y-s)/e*r),f.annot2DPoints[o]=new a(w,m)}}else if("RightWithTop"==t.deltaType){p=n+t.deltaX,g=e-t.deltaY,d=p-n,u=f.editStartbbox[0].x,r=g-e,l=f.editStartbbox[2].y;if(0==n&&(d=0),0==e&&(r=0),0<p&&0<g)for(o=0;o<f.annot2DPoints.length;o++){w=f.annot2DPoints[o].x,m=f.annot2DPoints[o].y;d&&(w=f.annot2DPoints[o].x+(f.annot2DPoints[o].x-u)/n*d),r&&(m=f.annot2DPoints[o].y+(f.annot2DPoints[o].y-l)/e*r),f.annot2DPoints[o]=new a(w,m)}}else if("Rotate"==t.deltaType)for(o=0;o<f.annot2DPoints.length;o++){var v=new a(f.annot2DPoints[o].x,f.annot2DPoints[o].y);v.rotateAround(i,t.deltaAngle),f.annot2DPoints[o]=v}for(var D=h.convexHullCompute(f.annot2DPoints),x=[],y=[],P=0;P<D.length;++P)x.push(D[P].x),y.push(D[P].y);x.sort((function(t,e){return t-e})),y.sort((function(t,e){return t-e}));var A=x.length-1;f.editStartbbox=[{x:x[0],y:y[0]},{x:x[A],y:y[0]},{x:x[A],y:y[A]},{x:x[0],y:y[A]}],f._deleteSelectedAnnotationAndRedraw(f.annot2DPoints),"Rotate"==t.deltaType?f.manipulators.moveRotateManipulators({x:t.finalX,y:t.finalY}):f.manipulators.moveManipulators({bbox:f.editStartbbox})},_deleteSelectedAnnotationAndRedraw:function(t){var e=d.shapeEval(t);if(e&&e.shape){var n=f.frameWindow.getViewerFrame().getDimensions(),i=p.pixelToNormalizedCoord(e.shape,n.width,n.height),o=null,a={frameWindow:f.frameWindow,annotationManager:f.annotationManager};switch(e.shape.type){case"circle":o=new u.circle(a);break;case"ellipse":o=new u.ellipse(a);break;case"line":o=new u.line(a);break;case"rectangle":case"square":o=new u.rectangle(a);break;case"triangle":o=new u.triangle(a);break;case"unknownOpen":o=new u.unknownOpen(a)}o||(o=new u.unknownOpen(a)),o.createFromMousePositionsquick(i),o.graphicalProp=f.annotationData.graphicalProp,o.draw(),o.id=f.annotationEdit[0],f.annotationData=o,f.annotationManager.deleteAnnotationWithID(f.annotationEdit[0]),f.annotationManager.addToAnnotGroupNode(o),f.annotationManager.repaintAnnotation(f.annotationEdit[0],!1),f.viewer.render(),f._build2DBB()}},_endShapeEdit:function(t){var e;f._deleteSelectedAnnotationAndRedraw(f.annot2DPoints),f.currDeltaType="";for(var n=0;n<f._annot3D.length;n++){var i=f._annot3D[n];if(i.id==f.annotationEdit[0]){e=i.boundingBox;break}}f.editStartbbox=e,f.manipulators.createManipulators({bbox:e,color:f.annotationManager.getAnnotColorWithID(f.annotationEdit[0]),container:f.frameWindow.getViewerFrame()})},_activateManipulators:function(){this.pointerOut=function(t){0==t.button&&!0!==f.viewer.currentViewpoint.isMoving()&&(console.log("Outside the border"),f.direction=void 0,f.draw?(f.draw=!1,f.gesture=!1,f.canvasContext.clearRect(0,0,f.canvas.width,f.canvas.height),f.viewerPoints=[],f.startPt=void 0,f.currentScreenPt=void 0,f.viewerLineThickness=[],f.cursorManager&&f._setMouseCursor("auto")):1==f.editStarted&&f.annotationEdit.length&&f.annotationData&&f.viewer&&f.currDeltaType&&(f.manipulators.manipulation=!1,f.manipulators.manipulatorType="",f._endShapeEdit()))},this.onPinch=function(t){"begin"===t.state&&(console.log("pinch is started"),f.gesture=!0)},this.manipulators=new c({eventTarget:this.frameWindow.getViewerFrame(),floatingBarContainer:f.frameWindow.getViewerFrame(),frameWindow:this.frameWindow,viewer:f.viewer,beginMove:this._beginMove,move:this._move,onTap:this._onTap,endMove:this._endMove,startShapeEdit:this._startShapeEdit,editShape:this._editShape,endShapeEdit:this._endShapeEdit,mouseLeave:this.pointerOut,coordinateScaling:this.coordinateScaling,floatingbarCallback:this.floatingbarCallback}),s.addEvent(document,"onPinch",this.onPinch)},coordinateScaling:function(t){var e=f.frameWindow.getViewerFrame().getBoundingClientRect().top,n=f.frameWindow.getViewerFrame().getBoundingClientRect().left;return{x:t.clientX-n,y:t.clientY-e}},_keyboardcallback:function(t){"Delete"==t.gesture.events[0].event.code&&f.cleanCurrentAnnotation()},floatingbarCallback:function(t){"Delete3DPlay"==t.id?f.cleanCurrentAnnotation():"Color3DPlay"==t.id&&f.drawSettings.setColor(t.color)},cleanCurrentAnnotation:function(){f.annotationEdit.length&&f.editStarted&&f.annotationManager&&f.viewer&&(f.annotationManager.deleteAnnotationWithID(f.annotationEdit[0]),f.annotationEdit=[],f.annotationData=void 0,f.editStartbbox=[],f.annot2DPoints=[],f.editStarted=!1,f.manipulators.cleanManipulators(),f.draw=!1,f.gesture=!1,f.viewer.render(),f._build2DBB()),f.mode&&"edition"==f.mode&&f.endCB&&f.endCB()},_checkRepFromPick:function(t){for(var e,n,i=[],o=[],r=[],s=f.viewer.canvas.getBoundingClientRect(),l=new a(t.clientX-s.left,t.clientY-s.top),c=new a(l.x,l.y),u=l.x,p=l.y,g=2*Math.PI/10,w=[],m=0;m<2*Math.PI;m+=g)w.push({x:u+5*Math.cos(m),y:p+5*Math.sin(m)});for(var v=0;v<f._annot3D.length;v++){var D=this._annot3D[v];"text"==D.type?h._isInsidePolygon(c,D.boundingBox)&&(i.push(D.id),o.push(D.annotationData),r.push(D.boundingBox)):h.isIntersect(w,D.point2D)&&(i.push(D.id),o.push(D.annotationData),r.push(D.boundingBox))}if(0<i.length){var x,y=0;for(v=0;v<i.length;v++){var P=0;if(o[v].points.length){for(var A=d.onScreenProjection(o[v].points,f.viewer),S=0;S<A.length;S++){var _=new a(A[S].x,A[S].y);P+=c.distanceTo(_)}P/=A.length}0==v?(x=P,y=0):P<x&&(x=P,y=v)}i=[i[y]],e=o[y],n=r[y]}return{annotationData:e,annotIDDelList:i,bBox:n}},_disableManipulators:function(){this.manipulators&&(this.manipulators.destroy(),this.manipulators=void 0),s.removeEvent(document,"onPinch",this.onPinch)}})})),define("DS/3DPlayAnnotation3D/Annotation3DEdit",["DS/3DPlayAnnotation3D/Annotation3DCommand","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/3DPlayAnnotationUtils/ShapeUtils","DS/Core/PointerEvents","DS/WebUtils/Vector2","DS/WebUtils/Tracker","DS/3DPlayAnnotation3D/Annotation3DEditPreview","DS/CoreEvents/Events","DS/3DPlayAnnotation3D/AnnotationShapes"],(function(t,e,n,i,o,a,r,s,l,h,d,c,u){"use strict";var p;return t.extend({init:function(t){this._parent(t),p=this,t.startCommandCB&&(this.startCommandCB=t.startCommandCB),t.endCommandCB&&(this.endCommandCB=t.endCommandCB),t.data&&(this.data=t.data),t.mode&&(this.mode=t.mode)},begin:function(t){h.command("Annotation3DEdit"),e.empty(),n.empty(),i.empty(),this._parent(t),this.setViewer({control:!1,highlight:!1,pickable:!1}),this._createPreview()},end:function(t){this._destroyPreview(),this.unsetViewer(),e.empty(),this._parent(t)},destroy:function(){p=null,this._parent()},_createPreview:function(){this.drawPreview=new d({frameWindow:this.frameWindow,hideUICB:function(){p.hideUI()},strokeCompleteCB:function(t,e,n){p._strokeComplete(t,e,n)},annotationManager:this.annotationManager,data:this.data,mode:this.mode,editCB:function(t){if(t.annotIDDelList&&t.annotIDDelList.length){var e=c.subscribe({event:"/VISU/"},(function(n){"@onViewpointEndMove"==n.eventType&&(p.startCommandCB&&p.startCommandCB({command:{id:"3DText"},data:{annotationData:t.annotationData}}),p._deleteListedAnnotations(t.annotIDDelList),c.unsubscribe(e))}));p.annotationManager.updateViewPointOfInputAnnotation(t.annotIDDelList[0])}},endCB:function(t){p._endCommand(t)}}),this.drawPreview.begin()},_deleteListedAnnotations:function(t){for(var e=0;e<t.length;++e)this.annotationManager.deleteAnnotationWithID(t[e]);this.viewer.render()},_endCommand:function(t){this.endCommandCB&&this.endCommandCB()},cleanCurrentAnnotation:function(){this.drawPreview&&this.drawPreview.cleanCurrentAnnotation()},_destroyPreview:function(){this.drawPreview&&(this.drawPreview.end(),this.drawPreview.destroy(),this.drawPreview=void 0)},_strokeComplete:function(t,e,n){var i;if((i=n?r.shapeEval(t):r.shapeUnEval(t))&&i.shape){var o=this.frameWindow.getViewerFrame().getDimensions(),s=a.pixelToNormalizedCoord(i.shape,o.width,o.height),l=null,h={frameWindow:this.frameWindow,annotationManager:this.annotationManager};a.getUniquePointsFromPointsArray(i.shape);switch(i.shape.type){case"circle":l=new u.circle(h);break;case"ellipse":l=new u.ellipse(h);break;case"line":l=new u.line(h);break;case"rectangle":case"square":l=new u.rectangle(h);break;case"triangle":l=new u.triangle(h);break;case"unknownOpen":l=new u.unknownOpen(h);break;case"text":l=new u.text(h)}l||(l=new u.unknownOpen(h)),l.createFromMousePositions(s,undefined),l.draw(),this.annotationManager.addToAnnotGroupNode(l)}}})})),define("DS/3DPlayAnnotation3D/AnnotationCommandEditShape",["DS/3DPlayWAFRMigration/Command","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayAnnotation3D/AnnotationUtils","DS/CoreEvents/Events","DS/3DPlayAnnotation3D/AnnotationManagerUtils","DS/3DPlayAnnotation3D/Annotation3DText","DS/3DPlayAnnotation3D/Annotation3DErase","DS/3DPlayAnnotation3D/Annotation3DEdit","DS/WebUtils/Tracker","DS/WebSystem/Environment","DS/WebSystem/BrowserInfos"],(function(t,e,n,i,o,a,r,s,l,h,d,c,u,p,g){"use strict";var w;return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"})},beginExecute:function(){if(this.frameWindow=this.getFrameWindow(),this._exp=this.frameWindow.experience,this.actionBar=this.frameWindow.getActionBar(),this.MAB=this.frameWindow.getMAB(),w=this,e.empty(),n.empty(),i.empty(),this.actionBar){this.actionBar.close();var t=this.actionBar.onActionBarOpen((function(){w.actionBar.removeCallback(t),w.end()}))}this.MAB&&this.MAB.state&&this.MAB.state.open&&this.MAB.toggleMainView(),this.annotationManager=l.getAnnotationManager(this._ctx),r.setNodePickable(this.annotationManager.getModel(),!1),w._exp&&w._exp.notifyAction&&!0===w._exp.collabMode&&w._exp.notifyAction("annotBeginExecute"),w.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize),w.frameWindow.experience&&w.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_ACTIVATED",{}),s.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!0}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!1,"FLY_WALK"),this.data=w.frameWindow.getViewer().shapeEditionData,this.AFR2_Execute()},execute:function(){u.startCommand(this.getId()),this.Draw3D=new c({frameWindow:this.frameWindow,annotationManager:this.annotationManager,hideTools:function(){w._removeTools()},data:this.data,mode:"edition",endCommandCB:this.endCommandCB}),this.Draw3D.begin()},endExecute:function(){u.endCommand(this.getId()),s.unsubscribe(this.MBAShow),s.unsubscribe(this.MBAHide),this.frameWindow.getViewerFrame().removeEvent("resize",this._onWidgetResize),this._endCommands(),w.frameWindow.experience&&w.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_DEACTIVATED",{}),this.annotationToolsMenu&&(this.annotationToolsMenu.dispose(),this.annotationToolsMenu=void 0),this.contextualMenu&&this.contextualMenuToken&&(this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenuToken=void 0,this.contextualMenu=void 0),this.Draw3D&&(this.Draw3D.destroy(),this.Draw3D=void 0),e.empty(),n.empty(),i.empty(),r.setNodePickable(this.annotationManager.getModel(),!0),this.actionBar&&this.actionBar.open(),this.MAB.showFlyout(0),this.frameWindow.getViewer().shapeEditionData=void 0,this.frameWindow=void 0,this.actionBar=void 0,this.MAB=void 0,s.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!1}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!0,"FLY_WALK"),w=null,this.AFR2_Done()},_endCommands:function(){this.annotationToolsMenu&&this.annotationToolsMenu.colorPaletteVisible&&this._hideColorPalette(),this.Draw3D&&this.Draw3D.isRunning()&&this.Draw3D.end()},endCommandCB:function(t){w.end()},refreshAnnotations:function(){},_startCommand:function(t,e){this._newMenuStartCommand(t,e)},_newMenuStartCommand:function(t,e){this._hideColorPalette(),"3DDelete"===t.id&&this.Draw3D.cleanCurrentAnnotation()},_buildUI:function(){this.contextualMenu=new o({frameWindow:this.frameWindow});var t={type:this.contextualMenu.Button.Check,id:"3DDelete",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(t){w._startCommand(t)}};this.contextualMenuToken=this.contextualMenu.addButtons([t],{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.annotationToolsMenu=new a({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:!0}),this.annotationToolsMenu.addToolsButton(),this.contextualMenu.panel.container.style.cursor="pointer",this._hideColorPalette()},_removeTools:function(){this._hideColorPalette()},_hideColorPalette:function(){this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()},_onWidgetResize:function(t){if(w&&w.frameWindow){var e=w.frameWindow.getActionBar();e&&e.open()}},cancel:function(){this.Draw3D.annotationManager.deleteAnnotationWithID(this.Draw3D.drawPreview.annotationEdit[0]),this.Draw3D.annotationManager.drawAnnotationsFromJSON(this.Draw3D.drawPreview.annotSelectedForEditJson,!1),this._parent()}})})),define("DS/3DPlayAnnotation3D/AnnotationCommands",["DS/3DPlayWAFRMigration/Command","DS/WebUtils/ContextedSingleton","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayAnnotation3D/AnnotationUtils","DS/CoreEvents/Events","DS/3DPlayAnnotation3D/AnnotationManagerUtils","DS/3DPlayAnnotation3D/Annotation3DText","DS/3DPlayAnnotation3D/Annotation3DErase","DS/3DPlayAnnotation3D/Annotation3DEdit","DS/WebUtils/Tracker","DS/WebSystem/Environment","DS/WebSystem/BrowserInfos","DS/3DPlayWAFRMigration/CommandsManager","DS/3DPlayWAFRMigration/3DPlayCommandsTools"],(function(t,e,n,i,o,a,r,s,l,h,d,c,u,p,g,w,m,v){"use strict";var f;return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),f=this,this._exp=this.getFrameWindow().experience,this.disposeAnnotationManager=function(){f.annotationManager&&(h.deleteAnnotationManager(f._ctx),f.annotationManager=void 0)},this._exp&&(this.newAssetLoadedToken=this._exp.subscribe("ASSET/LOADINGSTARTED",this.disposeAnnotationManager),this._exp.registerCollabAction&&(this._exp.registerCollabAction("annotBeginExecute",this.beginExecute.bind(this)),this._exp.registerCollabAction("annotExecute",this.execute.bind(this)),this._exp.registerCollabAction("annotEndExecute",this.endExecute.bind(this)),this._exp.registerCollabAction("annotStartCommand",this._startCommand.bind(this)))),g.isSet("3DPlay.OldAnnotMenu")?this.newToolsUI=!1:this.newToolsUI=!0},beginExecute:function(){n.empty(),i.empty(),o.empty(),this.frameWindow=this.getFrameWindow();var t,e=this.frameWindow.getActionBar();v.isActionBarOpen(e)&&e.toggle(),e&&(t=e.onActionBarOpen((function(){e.removeCallback(t),f.end()}))),this.annotationManager=h.getAnnotationManager(this._ctx,this.frameWindow),s.setNodePickable(this.annotationManager.getModel(),!1),f._exp&&f._exp.notifyAction&&!0===f._exp.collabMode&&f._exp.notifyAction("annotBeginExecute"),f.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize),f.frameWindow.experience&&f.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_ACTIVATED",{}),l.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!0}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!1,"FLY_WALK"),this.AFR2_Execute()},execute:function(){p.startCommand(this.getId()),this.Draw3D=new u({frameWindow:this.frameWindow,annotationManager:this.annotationManager,hideTools:function(){f._removeTools()},startCommandCB:this.startCommandCB}),this.Erase3D=new c({frameWindow:this.frameWindow,annotationManager:this.annotationManager,hideTools:function(){f._removeTools()}}),this._buildUI(),f._exp&&!0===f._exp.collabMode&&f._exp.notifyAction&&f._exp.notifyAction("annotExecute")},endExecute:function(){p.endCommand(this.getId()),l.unsubscribe(this.MBAShow),l.unsubscribe(this.MBAHide),this.frameWindow.getViewerFrame().removeEvent("resize",this._onWidgetResize),this._endCommands(),f.frameWindow.experience&&f.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_DEACTIVATED",{}),this.annotationToolsMenu&&(this.annotationToolsMenu.dispose(),this.annotationToolsMenu=void 0),this.contextualMenu&&this.contextualMenuToken&&(this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenuToken=void 0,this.contextualMenu=void 0),this.Draw3D&&(this.Draw3D.destroy(),this.Draw3D=void 0),this.Erase3D&&(this.Erase3D.destroy(),this.Erase3D=void 0),n.empty(),i.empty(),o.empty(),this.annotationManager&&s.setNodePickable(this.annotationManager.getModel(),!0);let t=this.frameWindow.getActionBar(),e=this.frameWindow.getMAB();e&&e.showFlyout(0),t&&!v.isActionBarOpen(t)&&t.toggle(),this.frameWindow=void 0,this._exp&&!0===this._exp.collabMode&&this._exp.notifyAction&&this._exp.notifyAction("annotEndExecute"),l.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!1}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!0,"FLY_WALK"),this.AFR2_Done()},_endCommands:function(){this.annotationToolsMenu&&this.annotationToolsMenu.colorPaletteVisible&&this._hideColorPalette(),this.Draw3D&&this.Draw3D.isRunning()&&this.Draw3D.end(),this.Erase3D&&this.Erase3D.isRunning()&&this.Erase3D.end()},startCommandCB:function(t){var e=void 0,n=void 0;t&&(e=t.command,n=t.data),void 0===e&&(e={id:"3DDrawing"}),f._endCommands(),f._startCommand(e,n),f.setSelected&&!1===f.setSelected(e)&&f.refreshAnnotations()},refreshAnnotations:function(){},_startCommand:function(t,e){this.newToolsUI?this._newMenuStartCommand(t,e):this._oldMenuStartCommand(t)},_newMenuStartCommand:function(t,e){this._hideColorPalette(),"3DDrawing"===t.id?this.Draw3D.begin():"3DErase"===t.id&&this.Erase3D.begin(),this._exp&&!0===this._exp.collabMode&&this._exp.notifyAction&&this._exp.notifyAction("annotStartCommand",[t])},_oldMenuStartCommand:function(t){this._endCommands(),this.annotationToolsMenu.removeToolsButton(),"3DDrawing"===t.id?(this.Draw3D.begin(),this.annotationToolsMenu.addToolsButton()):"3DErase"===t.id&&(this.Erase3D.begin(),this.annotationToolsMenu.removeToolsButton()),this._exp&&!0===this._exp.collabMode&&this._exp.notifyAction&&this._exp.notifyAction("annotStartCommand",[t])},_buildUI:function(){var t,e=this.frameWindow.getMAB();t=(g.isSet("3DPlay.oldAnnotationUI")&&e&&e.state.visible,[{id:"3DDrawing",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:!0},{id:"3DErase",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}]),this.contextualMenu=new a({frameWindow:this.frameWindow});var n=[{type:this.contextualMenu.Button.Radio,content:t,onclickCB:function(t){f.setSelected=t.setSelected,f._endCommands(),f.newToolsUI||f.annotationToolsMenu.removeToolsButton(),f._startCommand(t)}},{type:this.contextualMenu.Button.Master,id:"ExitAnnotation",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(){let t=f.getFrameWindow().getActionBar();t?v.isActionBarOpen(t)||t.toggle():f.end()}}];this.contextualMenuToken=this.contextualMenu.addButtons(n,{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.annotationToolsMenu=new r({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:this.newToolsUI}),this.annotationToolsMenu.addToolsButton(),this.newToolsUI&&(this.contextualMenu.panel.container.style.cursor="pointer",this._hideColorPalette()),this.Draw3D.begin()},_removeTools:function(){this.newToolsUI?this._hideColorPalette():this.annotationToolsMenu&&this.annotationToolsMenu.removeTools()},_hideColorPalette:function(){this&&this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()},_onWidgetResize:function(t){w.isMobile()||f&&f.frameWindow},_getRunningCommand:function(){return this.Draw3D&&this.Draw3D.isRunning()?this.Draw3D:this.Erase3D&&this.Erase3D.isRunning()?this.Erase3D:void 0},_destroy:function(){this._exp&&this.newAssetLoadedToken&&(this._exp.unsubscribe(this.newAssetLoadedToken),this.newAssetLoadedToken=void 0,this._exp=void 0),!this.AFR2_isRunning()&&this.disposeAnnotationManager&&(this.disposeAnnotationManager(),this.disposeAnnotationManager=void 0),f=void 0,this._parent()}})}));