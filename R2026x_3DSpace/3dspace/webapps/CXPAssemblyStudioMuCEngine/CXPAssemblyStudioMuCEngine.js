define("DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManager",["DS/StuCore/StuManager","DS/StuRenderEngine/StuSubProductActor"],(function(t,e){"use strict";var o=function(){t.call(this),this.name="MoveUnderConstraintsManager",this._count=1,this._cdsJson=null,this._grabbedActor=null,this._solver=null};return(o.prototype=new t).constructor=o,o.prototype.onInitialize=function(){t.prototype.onInitialize.call(this)},o.prototype.onDispose=function(){t.prototype.onDispose.call(this)},o.prototype.fixActorTemporarily=function(t,e){},o.prototype.storeActorInitialPositions=function(){},o.prototype.resetPosition=function(){},o.prototype.setGrabbedActor=function(t){},o.prototype.computePositionOfActors=function(t){},o.prototype.getRootActor=function(t){let o=null;if(t){let n=t.getParentActor();o=n instanceof e?this.getRootActor(n):n}return o},o.prototype.ComputeCoG=function(t){let e=[];if(t){let o=t.getBoundingSphere("Parent");if(o&&void 0!==o.center){let n=this.getRootActor(t);if(n){let t=n.getSceneTransform(),r=n.getTransform(t);o.center.applyTransformation(r),e.push(o.center.x),e.push(o.center.y),e.push(o.center.z)}}}return e},o.prototype.IsPathSame=function(t,e){let o=!1;if(t&&e&&t.length===e.length)for(let n=0;n<t.length;n++){if(o=!1,t[n]!==e[n])break;o=!0}return o},STU.registerManager(o),STU.MoveUnderConstraintsManager=o,o})),define("CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManager",["DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManager"],(function(t){"use strict";return t})),define("DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManagerNA",["DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManager","DS/StuCore/StuManager"],(function(t,e){"use strict";return t.prototype.onInitialize=function(){e.prototype.onInitialize.call(this)},t.prototype.onDispose=function(){e.prototype.onDispose.call(this)},t.prototype.fixActorTemporarily=function(t,e){},t.prototype.storeActorInitialPositions=function(){},t.prototype.resetPosition=function(){},t.prototype.setGrabbedActor=function(t){if(t){let e=(new StuMoveUnderConstraintsManager).build();e&&e.setGrabbedActor(t.CATI3DExperienceObject)}},t.prototype.computePositionOfActors=function(t){},t})),define("DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManagerNA",["DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManagerNA"],(function(t){"use strict";return t})),define("DS/CXPAssemblyStudioMuCEngine/CXPAssemblyStudioMuCEngineDefine",["DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManager","DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManagerNA"],(function(){})),define("DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManagerWeb",["DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManager","DS/StuCore/StuManager","DS/CATSolverCDSWeb/CATSolverCDSSolver","DS/CAT3DExpModel/CAT3DXModel","DS/MathematicsES/MathsDef","DS/StuCore/StuContext","DS/StuRenderEngine/StuActor3D","DS/StuRenderEngine/StuSubProductActor","DS/StuSound/StuSoundPlayerStartedEvent"],(function(t,e,o,n,r,i,s,a){"use strict";return t.prototype.onInitialize=function(){console.log("StuMoveUnderConstraintsManagerWeb : onInitialize "),this._SoundPlayCount=0,this._solver=new o,this._mapActorIDAndPosition=new Map,this._awaitCDSJsonLoad(),e.prototype.onInitialize.call(this)},t.prototype.onDispose=function(){e.prototype.onDispose.call(this)},t.prototype.fixActorTemporarily=function(t,e){let o=!1;if(t){let n=[];n=this._getPathOfActor(t);let r=n.join("\\u0005");r.length&&(o=this._solver.fixRigidSet(r,e))}return o},t.prototype.storeActorInitialPositions=function(){let t=null,e=i.Experience.getCurrent().currentScene.getAllActors();for(let o of e)if(o instanceof s&&this._isALeafActor(o)){o.CATI3DExperienceObject.GetValueByName("_varName");let e=this._getPathOfActor(o);if(t){let n=new r.Transformation;n=o.getTransform(t),this._mapActorIDAndPosition.set(e,n)}else t=this.getRootActor(o)}},t.prototype._isALeafActor=function(t){let e=!1;if(t){0===t.getSubActors().length&&(e=!0)}return e},t.prototype.resetPosition=function(){for(const[t,e]of this._mapActorIDAndPosition){let o=this._getActorFromID(t);if(o){let t=this.getRootActor(o);if(t){let n=new r.Transformation;this._setActorPosition(t,o,e,n)}}}this._cdsJson&&(this._solver.clean(),this._solver=null,this._solver=new o,this._solver.initialize(this._cdsJson),this._solver.load())},t.prototype.setGrabbedActor=function(t,e){if(t){this._grabbedActor=t;let o=[];o=this._getPathOfActor(this._grabbedActor);let n=o.join("\\u0005");if(n.length){let t=this._getLocalPickingPoint(this._grabbedActor,e);t&&this._solver.setMovingEntity(n,t)}}},t.prototype.computePositionOfActors=function(t){if(this._grabbedActor instanceof s&&this._grabbedActor){this._solver.setMoveType("movebytransfo"),this._solver.setTarget(t);let e=this._solver.run();e&&this._processSolverResults(e.results)}},t.prototype._processSolverResults=function(t){if(0<t.length){this._SoundPlayCount=0;for(let e of t){let t=e.transfo;if(this._isTransfoValid(t)){let o=e.path.split("\\u0005");this._applyTransfoToActorPosition(o,t)}}}else if(++this._SoundPlayCount,this._SoundPlayCount>4){let t=this.getRootActor(this._grabbedActor);t&&this._playSound(t),this._SoundPlayCount=0}},t.prototype._applyTransfoToActorPosition=function(t,e){let o=this._getActorFromID(t);if(o){let t=this.getRootActor(o);if(t){let n=new r.Transformation;n=o.getTransform(t),this._setActorPosition(t,o,n,e)}}},t.prototype._setActorPosition=function(t,e,o,n){if(t&&e&&o&&n){n.multiply(o,!1);let i=e.getParentActor();if(i){let o=new r.Transformation;o=i.getTransform(t);let s=o.inverse().multiply(n,!1);e.setTransform(s,i)}}},t.prototype._GetTransfoFromActorPosition=function(t){let e=new r.Transformation;if(t){let o=t.CATI3DExperienceObject.GetValueByName("_varposition");e=this._GetTransfoFromPosition(o)}return e},t.prototype._GetTransfoFromPosition=function(t){let e=new r.Transformation;return t&&e.setFromArray([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]),e},t.prototype._GetTransfoFromPoint=function(t){let e=new r.Transformation;return t&&e.setFromArray([1,0,0,0,1,0,0,0,1,t[0],t[1],t[2]]),e},t.prototype._getActorFromID=function(t){let e=null,o=i.Experience.getCurrent().currentScene.getAllActors();for(let n=0;n<o.length;n++){o[n].CATI3DExperienceObject.GetValueByName("_varName");const r=this._getPathOfActor(o[n]);this.IsPathSame(r,t)&&(e=o[n])}return e},t.prototype._isTransfoValid=function(t){let e=!0,o=t.getArray();for(let t=o.length-1;t>=0;t--){let n=o[t];isFinite(n)&&!isNaN(n)||(e=!1)}return e},t.prototype._isEqual=function(t,e){let o=!1,n=t.getInverse().multiply(e);return n.isIdentity()&&0==n.vector.x&&0==n.vector.y&&0==n.vector.z&&(o=!0),o},t.prototype._awaitCDSJsonLoad=async function(){const t=n._getExpCoreLinkManager();let e=await t.resolveLink("ExpCore://localMedia/Streams/ProductCDS.json");if(e){const t=e.getText();t&&this._solver&&(this._cdsJson=t,this._solver.initialize(t),this._solver.load())}},t.prototype._getIDOfActor=function(t){let e="";if(t){let o=t.CATI3DExperienceObject._modelObject.GetID();if(o){let t=o.split(",");e=t[t.length-1]}}return e},t.prototype._getPathOfActor=function(t){let e=[];if(t){let o=t.getParentActor();if(o instanceof a){let t=[];t=this._getPathOfActor(o),e=t}let n=this._getIDOfActor(t);e.push(n)}return e},t.prototype._playSound=function(t){if(t){let e=t.getBehaviors();for(let t=0;t<e.length;t++){let o=e[t];"SoundPlayer"==o.name&&(1!=o.isPlaying()?o.play():o.stop())}}},t.prototype._getLocalPickingPoint=function(t,e){let o=[],n=this.getRootActor(this._grabbedActor);if(n&&t){let i=t.getParentActor();if(i){let s=new r.Transformation;s=i.getTransform(n);let a=s.inverse();if(e){let t=this._GetTransfoFromPoint(e);if(t){let e=a.multiply(t,!1);e&&(o.push(e.getArray()[9]),o.push(e.getArray()[10]),o.push(e.getArray()[11]))}}else o=this.ComputeCoG(t)}}return o},t})),define("DS/CXPAssemblyStudioMuCEngine/extensions/StuEMoveUnderConstraintsPrototypeBuild",["UWA/Core","DS/XCTWebExperienceAppPlay/extensions/StuEExperienceBasePrototypeBuild","DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManagerWeb"],(function(t,e){"use strict";return e.extend({})}));