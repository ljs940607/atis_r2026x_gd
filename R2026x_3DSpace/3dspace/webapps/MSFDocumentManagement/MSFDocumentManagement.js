define("DS/MSFDocumentManagement/MSFDocumentClient",["UWA/Core","UWA/Promise","UWA/Utils/InterCom","DS/WAFData/WAFData","i18n!DS/MSFDocumentManagement/assets/nls/MSFDocumentManagement"],(function(e,t,n,o,i){"use strict";var s=!1,a={},r=void 0,l={MSF_NOT_AVAILABLE_RESPONSE:7,MSF_CALL_SUCCESS_RESPONSE:1,isMSFDocServerInitialized:!1,msfLocalCacheCollection:{},MSFResponse:void 0,MSFDocumentServer:null,onConnectWithMSF:function(t,n,o,i,s,a){var r=this;e.Utils.Client.Platform.windows&&require(["DS/MSFDocumentManagement/MSFDocumentServer"],(function(e){try{e&&(r.isMSFDocServerInitialized=!0,r.MSFDocumentServer=e,r.MSFDocumentServer.onConnectWithMSF(t,n,o,i,s,a))}catch(e){console.log(e)}}))},isConnectedToMSFClient:function(){return this.MSFDocumentServer.isConnectedWithMSF()},initializeMSFInterComClient:function(){(a=new n.Socket("SocketClient")).subscribeServer("uwa.embedded"),a.addListener("getResponse",this.getMSFResponse.bind(this)),s=!0},downloadDocumentFromMSF:function(t,n,o,i){var s=this,a=i.onComplete,r=i.onFailure,l=e.clone(i||{},!1);l.documentId=t,l.fileId=n,l.Checkout=o,l.onComplete=function(t){t.onComplete=a,t.onFailure=r,s.MSFResponse.MSFResult===s.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==s.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(s.MSFResponse.ErrorMessage),this.MSFResponse=void 0},!1===o?s.downloadDocument(l):s.checkoutDocument(l)},creatDocumentFromMSF:function(t,n){var o=this,i=n.onComplete,s=n.onFailure,a=e.clone(n||{},!1);a.onComplete=function(t){t.onComplete=i,t.onFailure=s,o.MSFResponse&&(o.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==o.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(o.MSFResponse.ErrorMessage)),o.MSFResponse=void 0},t.id?t.fileInfo&&t.fileInfo.file&&(t.fileInfo.fileId||!t.fileInfo.newFile?o.checkIn(t,a):o.addFiles(t,a)):!t.fileInfo||t.fileInfo.file instanceof window.File||!t.fileInfo.file.FileToUpload||o.createNew(t,a)},MSFUploadObjectList:function(t,n){var o=this,i=n._options;i.onComplete=function(i){l.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?n.model.add(t,l.MSFResponse.RequestData.MSFFileFormatDetails,i):5===l.MSFResponse.MSFResult?l.MSFResponse=void 0:""!==l.MSFResponse.ErrorMessage&&e.is(i.onFailure,"function")&&i.onFailure(l.MSFResponse.ErrorMessage)},this.selectFiles(i)},MSFCallCheckout:function(e,t,n,o,s,a,r,l){this.ConfirmWebEditorSessionActiveFromService(t,a,r).then((c=>{c.filter((e=>"true"==e.toString().toLowerCase())).length>0?alert(i.get("BlockActionAsWebEditionIsOn")):this.proceedForCheckout(e,t,n,o,s,a,r,l)}))},proceedForCheckout(e,t,n,o,i,s,a,r){var l,c,d=JSON.parse("{}");d.RequestType=e,d.DocumentID=t,d.PartId=n,d.DocumentType=o,d.parentOID=i,l=s?s.split(","):t.split(",");for(var S=0;S<l.length;S++)0===S&&(c=JSON.parse('{"MSFFileFormatDetails":[{"FileName": "", "Format" : "", "VersionId": ""}]}')),a&&(c.MSFFileFormatDetails[S].FileName=a,c.MSFFileFormatDetails[S].Format=r),l[S]&&(0===S?c.MSFFileFormatDetails[S].VersionId=l[S]:c.MSFFileFormatDetails.push({FileName:a,Format:r,VersionId:l[S]}));d.MSFFileFormatDetails=c.MSFFileFormatDetails,this.sendMessage(d)},getMSFResponse:function(t){var n,o=t.RequestData?t.RequestData.RequestId:t.RequestId,i=o?this.msfLocalCacheCollection[o]:null;if(void 0!==t.ResultData&&""!==t.ResultData&&(n=JSON.parse(t.ResultData),i.data=n.data),o&&delete this.msfLocalCacheCollection[o],i)if(window.widget)this.MSFResponse=t,e.is(i.onComplete,"function")&&i.onComplete(i);else try{t.MSFResult!==this.MSF_CALL_SUCCESS_RESPONSE||"checkout"!==t.RequestData.RequestType&&"CheckIn"!==t.RequestData.RequestType&&"AddFiles"!==t.RequestData.RequestType||this.refreshFrameWindow(i.Window)}catch(e){console.log("inside getMSFResponse: "+e)}},refreshFrameWindow:function(e){if(null==window.__karma__){var t=findFrame(e,"detailsDisplay");null!=(t=null==(t=null==t?findFrame(e,"listDisplay"):t)?findFrame(e,"content"):t)?t.location.href=t.location.href:e.location.href=e.location.href}},downloadDocument:function(e){var t=JSON.parse("{}");t.RequestType="download",this.processDownload(e,t)},checkoutDocument:function(e){var t=JSON.parse("{}");t.RequestType="checkout",this.processDownload(e,t)},viewDocument:function(e){var t=JSON.parse("{}");t.RequestType="view",this.processDownload(e,t)},processDownload:function(e,t){t.DocumentID=e.documentId,t.Options=e,this.sendMessage(t)},checkIn:function(e,t){var n=JSON.parse("{}");t.DocumentInfo=e,n.RequestType="CheckIn",n.DocumentID=e.id?e.id:"";var o=[];o.push({FileName:e.fileInfo.file.name,Format:"",VersionId:""}),n.MSFFileFormatDetails=o,n.Options=t,this.sendMessage(n)},createNew:function(e,t){var n=JSON.parse("{}");t.DocumentInfo=e,n.RequestType="CreateNew",n.DocumentType=e.type?e.type:"Document",n.RelName=e.relInfo?e.relInfo.parentRelName:null,n.parentId=e.relInfo?e.relInfo.parentId:null,n.CollabSpace=e.collabspace?e.collabspace:"",n.Options=t,n.MSFFileFormatDetails=[e.fileInfo.file],this.sendMessage(n)},selectFiles:function(e){var t=JSON.parse("{}");t.RequestType="SelectFiles",t.Options=e,this.sendMessage(t)},addFiles:function(e,t){var n=JSON.parse("{}");t.DocumentInfo=e,n.RequestType="AddFiles",n.DocumentType=e.type?e.type:"Document",n.RelName=e.relInfo?e.relInfo.parentRelName:"Reference Document",n.DocumentID=e.id?e.id:"",n.Options=t,this.sendMessage(n)},generateNewGuid:function(){var e=new Date;return Math.random()+"."+e.getFullYear()+"."+e.getMonth()+"."+e.getDate()+"."+e.getHours()+"."+e.getSeconds()+"."+e.getMilliseconds()},isConnectedWithMSF:function(){return sessionStorage.msfConnection?String("true"==sessionStorage.msfConnection):"false"},sendMessage:function(t){if(!1===this.isMSFDocServerInitialized){var n=t.Options;if(n&&(this.MSFResponse={},this.MSFResponse.MSFResult=this.MSF_NOT_AVAILABLE_RESPONSE,e.is(n.onComplete,"function")))return void n.onComplete(n)}if(t.RequestId=this.generateNewGuid(),window.widget&&window.widget.id)(!1===s||!0===s&&sessionStorage.MSFWidget&&sessionStorage.MSFWidget!==window.widget.id)&&(this.initializeMSFInterComClient(),sessionStorage.MSFWidget=window.widget.id),this.msfLocalCacheCollection[t.RequestId]=t.Options,a.dispatchEvent("MSFProcessMessage",t);else{var o=this;try{for(r=getTopWindow();r&&r.opener&&-1==r.location.href.indexOf("emxNavigator.jsp");)r=r.opener.getTopWindow()}catch(e){console.log("inside sendMessage: "+e)}var i={};i.Window=window,this.msfLocalCacheCollection[t.RequestId]=i,require(["UWA/Utils/InterCom"],(function(e){(a=new e.Socket("MSFIntercomClientSocket")).subscribeServer("enovia.bus.server",r),a.addListener("getResponse",o.getMSFResponse.bind(o)),a.dispatchEvent("MSFProcessMessage",t)}))}},ConfirmWebEditorSessionActiveFromService:function(n,o,i){var s=getTopWindow().location.search.match(/[?&]tenant=([^&]*)?/),a=null!=(s=null==s?void 0:s[1]||void 0)&&"onpremise"!=s.toLowerCase(),r=this,l=void 0;return new e.Promise((function(e,s){if(1==a){var c=null==o?"":o.split(","),d=i.split(","),S=[];if(null!=o&&o.includes(","))for(var u=0;u<c.length-1;u++)l=r.checkforEachObjectWebEditionCall(n,c[u],d[u]),S.push(l);else l=r.checkforEachObjectWebEditionCall(n,c,d),S.push(l);t.all(S).then((function(t){e(t)}))}else e([!1])}))},checkforEachObjectWebEditionCall:function(e,n,i){return new t((function(t,s){require(["DS/PlatformAPI/PlatformAPI"],(function(a){var r=a.getTenant();require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(a){a.getServiceUrl({serviceName:"3DSpace",platformId:r,onComplete:function(a){var r=a+"/resources/v1/modeler/documents/IsOnlineWebEditorSessionActive?documentId="+e+"&fileId="+n+"&fileName="+i;o.authenticatedRequest(r,{method:"GET",type:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:function(e){if(e.success){if(!Array.isArray(e.data))return;var n="true"==e.data[0].dataelements.WEB_EDITOR_SESSION_ACTIVE;t(n)}else s(e)},onFailure:function(e){s(e)}})}})}))}))}))}};return l})),define("DS/MSFDocumentManagement/MSFDocumentServer",["UWA/Core","DS/i3DXCompass/Data","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","UWA/Utils/InterCom","DS/WAFData/WAFData"],(function(e,t,n,o,i,s){"use strict";var a,r={},l=void 0;return{isConnectedWithMSF:function(){try{window.widget||(a=top.window.msfWebSocket)}catch(e){return!1}return null!=a&&1===a.readyState},initializeMSFInterCom:function(){r=new i.Socket("MSFIntercomServerSocket"),window.widget?r.subscribeServer("uwa.embedded"):r.subscribeServer("enovia.bus.server",getTopWindow()),r.addListener("MSFProcessMessage",this.sendMessage.bind(this))},onConnectWithMSF:function(t,i,a,r,l,c){if(!this.isConnectedWithMSF()){this.initializeMSFInterCom(),null==sessionStorage.ClientId&&(sessionStorage.ClientId=this.generateNewGuid()),window.widget&&(t=n.getUser().login);var d=this;o.getPlatformServices({onComplete:function(n){var o=void 0;if(void 0!==n){if(1==n.length)o=n[0];else if(n.length>1){var l=window.tenantId;for(var c in window.widget&&(l=window.widget.data.x3dPlatformId),n)if(n[c].platformId==l){o=n[c];break}}else console.log("---may return wrong tenant information---"),o=n[0];i=e.is(o["3DSpace"],"string")?o["3DSpace"]:"",a=e.is(o.platformId,"string")?o.platformId:"",r=e.is(o["3DPassport"],"string")?o["3DPassport"]:""}if(r&&""!==r){"/"!=(r=r.replace("/cas","")).substr(-1)&&(r+="/");var S=e.Utils.buildUrl(r,"api/authenticated/cas/transient");s.authenticatedRequest(S,{method:"GET",type:"json",onComplete:function(e){e&&(e.access_token?d.connectWithMSF('{"ClientId": "'+sessionStorage.ClientId+'", "UserName": "'+t+'", "ServerUrl": "'+i+'", "TenantId": "'+a+'", "TransientURL": "'+e.x3ds_reauth_url+'"}'):d.connectWithMSF('{"ClientId": "'+sessionStorage.ClientId+'", "UserName": "'+t+'", "ServerUrl": "'+i+'", "TenantId": "'+a+'"}'))},onFailure:function(){console.error("failed to get transient token")}})}else d.connectWithMSF('{"ClientId": "'+sessionStorage.ClientId+'", "UserName": "'+t+'", "ServerUrl": "'+i+'", "TenantId": "'+a+'"}')},onFailure:function(){console.error("Fail to connect to MSF")}})}},generateNewGuid:function(){var e=new Date;return Math.random()+"."+e.getFullYear()+"."+e.getMonth()+"."+e.getDate()+"."+e.getHours()+"."+e.getSeconds()+"."+e.getMilliseconds()},connectWithMSF:function(e){if(e){var t=decodeURIComponent(e);e=JSON.parse(e),l="ws://localhost:2012/MSFServiceSocket?MSFClientInfo="+t,sessionStorage.ClientId=e.ClientId}this.initSocket(l)},initSocket:function(e){var t=this;a=new WebSocket(e),window.widget||(top.window.msfWebSocket=a),a.onerror=function(){},a.onopen=function(){t.isConnectedWithMSF()&&(sessionStorage.msfConnection=!0)},a.onmessage=function(e){var n=JSON.parse(e.data);t.getMSFResponse(n)},a.onclose=function(t){a=1005!==t.code&&1006!==t.code&&1e3!==t.code?new WebSocket(e):null,sessionStorage.msfConnection=!1}},getMSFResponse:function(e){"Connect"===e.RequestType&&"True"===e.Connection?(!0,sessionStorage.msfConnection=!0):"False"===e.Connection&&(a=null,sessionStorage.msfConnection=!1),r.dispatchEvent("getResponse",e)},sendMessage:function(e){this.isConnectedWithMSF()?void 0!==e&&e.RequestType&&(e.ClientId=sessionStorage.ClientId,a.send(JSON.stringify(e))):(e.MSFResult=7,r.dispatchEvent("getResponse",e))}}})),define("DS/MSFDocumentManagement/WidgetIntegration",["UWA/Core","UWA/Json","DS/WAFData/WAFData","DS/i3DXCompass/Data","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(e,t,n,o,i,s){"use strict";return{MSF_NOT_AVAILABLE_RESPONSE:7,MSF_CALL_SUCCESS_RESPONSE:1,Operations:{View:"view",Download:"download",CheckOut:"checkout",CreateNew:"CreateNew",SelectFiles:"SelectFiles",CheckIn:"CheckIn",AddFiles:"AddFiles",GetAttributeDefinitions:"GetAttributeDefinitions",Connect:"Connect"},msfRequestCache:{},clientId:null,msfWebSocket:null,isMSFClientSignedIn:!1,ConnectWidgetWithMSF:function(t){null!=t&&(t.MSFDocumentClient=this);var n=this;!n.isConnectedWithMSF()&&e.Utils.Client.Platform.windows&&(null==sessionStorage.MSFSessionId&&(sessionStorage.MSFSessionId=n.generateUniqueID()),e.is(window)&&e.is(window.widget)?n.clientId=sessionStorage.MSFSessionId+"."+i.getUser().login+"."+window.widget.id:n.clientId=sessionStorage.MSFSessionId+"."+i.getUser().login+".Search",n.prepareWebsocketUrlAndConnect(n.clientId))},IsConnectedToMSFClient:function(){return this.isConnectedWithMSF()&&this.isMSFClientSignedIn},DownloadViaMSF:function(t,n){var o=this;this.isConnectedWithMSF()?t.forEach((function(t){var i=n.onComplete,s=n.onFailure,a=e.clone(n||{},!1);if(t.id){a.onMSFComplete=function(t){t.onComplete=i,t.onFailure=s,t.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==t.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(t.MSFResponse.ErrorMessage)},a.documentId=t.id,a.fileId=t.fileid;var r=o.Operations.Download;!0===t.checkout?r=o.Operations.CheckOut:!0===t.open&&(r=o.Operations.View);var l=[];a.fileId&&(l=[{VersionId:a.fileId}]);var c={DocumentID:t.id,Options:a,RequestType:r,MSFFileFormatDetails:l};o.sendMessageAcrossWebsocket(c)}else s("document.id is invalid")})):n.onFailure("Widget is not connected to MSF Client")},prepareWebsocketUrlAndConnect:function(e){if(e){var t="ws://localhost:2012/MSFServiceSocket?ClientId="+encodeURIComponent(e);this.initWebsocket(t)}},initWebsocket:function(e){var t=this;t.msfWebSocket=new WebSocket(e),t.msfWebSocket.onerror=function(){},t.msfWebSocket.onopen=function(){console.log("Connected to MSFClient, Waiting for MSFClient to Sign In")},t.msfWebSocket.onmessage=function(e){if(""!==e.data){var n=JSON.parse(e.data);t.receiveMsgAcrossWebsocket(n)}},t.msfWebSocket.onclose=function(n){1005!==n.code&&1006!==n.code&&1e3!==n.code?t.msfWebSocket=new WebSocket(e):t.msfWebSocket=null}},isConnectedWithMSF:function(){return null!=this.msfWebSocket&&1===this.msfWebSocket.readyState},sendCredentialMessage:function(e){e.RequestType=this.Operations.Connect,this.sendMessageAcrossWebsocket(e)},sendCredentials:function(t){var o,a,r,l=this,c=i.getUser().login;s.getPlatformServices({onComplete:function(i){var s;if(void 0!==i){if(1==i.length)s=i[0];else if(i.length>1){var d=window.tenantId;for(var S in window.widget&&(d=window.widget.data.x3dPlatformId),i)if(i[S].platformId==d){s=i[S];break}}else console.log("---may return wrong tenant information---"),s=i[0];o=e.is(s["3DSpace"],"string")?s["3DSpace"]:"",a=e.is(s.platformId,"string")?s.platformId:"",r=e.is(s["3DPassport"],"string")?s["3DPassport"]:""}if(r&&""!==r)if("/"!=(r=r.replace("/cas","")).substr(-1)&&(r+="/"),t){var u=e.Utils.buildUrl(r,"api/authenticated/cas/transient");n.authenticatedRequest(u,{method:"GET",type:"json",onComplete:function(e){e&&(e.access_token?l.sendCredentialMessage({ClientId:l.clientId,UserName:c,ServerUrl:o,TenantId:a,TransientURL:e.x3ds_reauth_url}):l.sendCredentialMessage({ClientId:l.clientId,UserName:c,ServerUrl:o,TenantId:a}))},onFailure:function(){console.error("failed to get transient token")}})}else l.sendCredentialMessage({ClientId:l.clientId,UserName:c,ServerUrl:o,TenantId:a,IsDelayedCASTGC:!0});else l.sendCredentialMessage({ClientId:l.clientId,UserName:c,ServerUrl:o,TenantId:a})},onFailure:function(){console.error("Fail to connect to MSF")}})},receiveMsgAcrossWebsocket:function(t){if(t.RequestType===this.Operations.Connect&&"True"===t.Connection)this.isMSFClientSignedIn=!0,console.log("MSFClient Signed In");else if(t.RequestType===this.Operations.Connect&&"False"===t.Connection)this.isMSFClientSignedIn=!1,this.msfWebSocket=null,console.log("MSFClient SignIn Failed");else{if(t.RequestType===this.Operations.Connect&&"GetCASTGC"===t.Connection)return this.isMSFClientSignedIn=!1,void this.sendCredentials(!0);if(t.RequestType===this.Operations.Connect&&"GetCredentials"===t.Connection)return this.isMSFClientSignedIn=!1,void this.sendCredentials(!1);if(null!=t.RequestData&&t.RequestData.RequestType===this.Operations.Connect&&"Connected"===t.ResultData)this.isMSFClientSignedIn=!0,console.log("MSFClient Signed In");else if(null!=t.RequestData&&t.RequestData.RequestType===this.Operations.Connect&&"Cancelled"===t.ResultData)this.isMSFClientSignedIn=!1,this.msfWebSocket=null,console.log("MSFClient SignIn Failed");else if(null!=t.RequestData&&t.RequestData.RequestType===this.Operations.Connect&&"GetCASTGC"===t.ResultData)return this.isMSFClientSignedIn=!1,void this.sendCredentials(!0)}var n=t.RequestData?t.RequestData.RequestId:t.RequestId,o=n?this.msfRequestCache[n]:null;if(null!=o){var i;if(void 0!==t.ResultData&&""!==t.ResultData&&o)try{i=JSON.parse(t.ResultData),o.data=i.data}catch(e){i=t.ResultData}n&&delete this.msfRequestCache[n],o&&(o.MSFResponse=t,e.is(o.onMSFComplete,"function")&&o.onMSFComplete(o))}else console.log("Not Found RequestId: "+n)},sendMessageAcrossWebsocket:function(n){if(window.__karma__&&n.RequestType!==this.Operations.Connect){var o=n.Options;if(o&&(o.MSFResponse={},e.is(o.onMSFComplete,"function")))return void o.onMSFComplete(o)}n.RequestId=this.generateUniqueID(),this.msfRequestCache[n.RequestId]=n.Options,this.isConnectedWithMSF()?void 0!==n&&n.RequestType&&(n.ClientId=this.clientId,this.msfWebSocket.send(JSON.stringify(t.prune(n)))):n.RequestType===this.Operations.Connect&&null!=this.msfWebSocket&&1===this.msfWebSocket.readyState?(n.ClientId=this.clientId,this.msfWebSocket.send(JSON.stringify(t.prune(n)))):(n.MSFResult=this.MSF_NOT_AVAILABLE_RESPONSE,this.receiveMsgAcrossWebsocket(n))},generateUniqueID:function(){var e=new Date;return Math.random()+"."+e.getFullYear()+"."+e.getMonth()+"."+e.getDate()+"."+e.getHours()+"."+e.getSeconds()+"."+e.getMilliseconds()}}}));