/*!  Copyright 2019 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXTIC/CATWebUXTICCmdAdapt",["DS/CATWebUXComponents/DMUCommand","DS/PlatformAPI/PlatformAPI"],(function(e,t){"use strict";var n,s,i,a,r,o,c,l,u,d,p,m,f,D,g,C,A,S,h;function I(e){if(d)!g.setTenant&&window.enoviaServerCAWidget&&(window.enoviaServerCAWidget.tenant=require("DS/PADUtils/PADUtilsServices").getPlatformId()),e();else{require(["DS/WAFData/WAFData","DS/ENOChgActionCMDs/scripts/CAActionBarController","DS/ENOChangeActionUX/scripts/CreateCAForm"],(function(t,n,s){d=t,g=n,C=s,I(e)}))}}function v(e){if(m)f.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},f.getTenant=function(){return require("DS/PADUtils/PADUtilsServices").getPlatformId()},e();else{require(["DS/IssueManagementWebInWin/ENOIssueGenerationWebPanel","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","DS/IssueManagementWebInWin/ENOIssueFromTemplateGenerationWebPanel"],(function(t,n,s,i,a){p=t,A=a,f=s,D=i,(m=n).add("widget",window.widget),f.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},f.getTenant=function(){return require("DS/PADUtils/PADUtilsServices").getPlatformId()},f.initPlatformServices().then((function(){e()}))}))}}require(["i18n!DS/CATWebUXTIC/assets/nls/CATWebUXTICCmdAdapt"],(function(e){n=e.caOK,s=e.caKO,i=e.caAttached,a=e.caNotAttached,r=e.taskOK,o=e.taskKO,c=e.taskAttached,l=e.taskNotAttached}));var b=e.extend({init:function(e){var d,m=this,f=null,b=null,y=null,P=e.pad3DViewer;function U(e){new Promise((function(t){if(e.fromIssue)t([e.fromIssue]);else{var n=require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/navigate",s=require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx"),i="&tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId();require("DS/WAFData/WAFData").authenticatedRequest(n+"?SecurityContext="+s+i,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:s},data:JSON.stringify({input_physical_ids:e.attachments,label:"ParentIssue"+Date.now(),primitives:[{navigate_from_rel:{id:1,filter:{bo_type:["Issue"]}}}],patterns:{issue:[{id:1}]},fileAttributes:[],attributes:[],version:3}),onComplete:function(e){var n=e?JSON.parse(e):null;if(n&&n.result&&n.result.length){var s=[];n.result.forEach((function(e){if(e.outputs&&e.outputs.issue&&1===e.outputs.issue.length){var t=e.outputs.issue[0].physicalid;-1===s.indexOf(t)&&s.push(t)}})),t(s)}else t()},onFailure:t,onTimeout:t})}})).then((function(t){t&&0!==t.length&&v((function(){D.related.update({data:{objects:t.map((function(t){return{physicalId:t,resolvedBy:[{physicalId:e.id,objectType:e.objectType,envId:require("DS/PADUtils/PADUtilsServices").getPlatformId(),serviceId:e.serviceId}]}}))},onComplete:function(){P.displayNotification({msg:e.okMsg,eventID:"success"})},onFailure:function(){P.displayNotification({msg:e.koMsg,eventID:"error"})}})}))}))}function T(e){I((function(){if(e.status&&"ticCancel"===e.status)m.cancel();else if(m.isRunning()){var t=e.fromIssue;delete e.fromIssue,g.clearObjects(),g.addTitle(e.title),g.addDescription(e.description),g.addContext(e.contexts),g.addReferential(e.attachments),g.addSeverity&&g.addSeverity(e.priority),g.setTenant&&g.setTenant(require("DS/PADUtils/PADUtilsServices").getPlatformId()),g.setSecurityContext&&g.setSecurityContext(require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")),new Promise((function(n){t?v((function(){D.issues.retrieve({data:{objects:[{physicalId:t}]}}).then((function(e){n(),(e=e.results)&&1===e.length&&e[0]&&e[0].body&&(g.addProposed((e[0].body.reportedAgainst||[]).map((function(e){return e.physicalId}))),g.addFollower([e[0].body.owner.user]),g.addAssignee((e[0].body.assignees||[]).map((function(e){return e.user}))))}))})):(g.addProposed(e.reportedAgainst),e.assignees&&g.addAssignee(e.assignees),n())})).then((function(){C.createCAFromActionBar(g.getJSON(),o,r).then((function(){(y=C.CACreateModal).elements.content.parentElement.parentElement.setStyle("z-index","1000000"),y.options.escapeToClose=!1}))}))}function r(){e.onCancel&&e.onCancel(),m.cancel()}function o(r){if(P.displayNotification({msg:r.changeaction?n:s,eventID:r.changeaction?"success":"error"}),r.changeaction){var o=r.changeaction.id.replace("pid:",""),c=e.title,l=r.changeaction.attributes;if(l&&l.length)for(let e=0;e<l.length;e++)"attribute_Synopsis"===l[e].name&&(c=l[e].value);e.onComplete&&e.onComplete({attachmentIDs:e.attachments,title:c,ticID:o}),U({fromIssue:t,attachments:e.attachments,id:o,okMsg:i,koMsg:a,objectType:"Change Action",serviceId:e.serviceID})}m.cancel()}}))}function w(e){var t;t=function(){var t=e.fromIssue;if(delete e.fromIssue,e.status&&"ticCancel"===e.status)m.cancel();else if(m.isRunning()){var n=[];e.assignees.forEach((function(e){n.push(function(e){return new Promise((function(t){var n=require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/resources/modeler/pno/person/"+e,s={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")},onComplete:function(e){var n=JSON.parse(e),s=n&&n.pid?n.pid:"";t(s)},onFailure:function(){t()}};require("DS/WAFData/WAFData").authenticatedRequest(n,s)}))}(e))})),Promise.all(n).then((function(t){new Promise((function(t){var n=[];require("DS/WAFData/WAFData").authenticatedRequest(require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/fetch/v2?tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId(),{method:"POST",timeout:6e4,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")},data:JSON.stringify({physicalid:e.attachments,label:"TICRecentFetch"+Date.now(),select_predicate:["ds6w:label","type_icon_url"]}),onComplete:function(s){var a=JSON.parse(s);if(Array.isArray(a.results)&&a.results.length===e.attachments.length)t(a);else if(Array.isArray(a.results)){var r=a.results.map((function(e){return i(e)})).reduce((function(e,t){return e.push(t.id),e}),[]);n=e.attachments.filter((function(e){return-1===r.indexOf(e)}))}else n=e.attachments;require("DS/WAFData/WAFData").authenticatedRequest(require("DS/PADUtils/PADUtilsServices").get3DSearchUrl()+"/recent?tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId()+"&_="+Date.now(),{method:"POST",timeout:6e4,headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify({tenant:require("DS/PADUtils/PADUtilsServices").getPlatformId(),label:"TICAttachmentFetch"+Date.now(),select_predicate:["ds6w:label","type_icon_url"],select_file:["icon","thumbnail_2d"],login:{"3dspace":{SecurityContext:require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")}}}),onComplete:function(e){var s=e?JSON.parse(e):null;if(Array.isArray(s.results)){var r=require("UWA/Core").clone(a);Array.isArray(r.results)||(r.results=[]);for(var o=0;o<s.results.length;o++){var c=i(s.results[o]);-1!==n.indexOf(c.id)&&(r.results.push(s.results[o]),r.infos.nhits++,r.infos.nresults++)}t(r)}else t(a)},onFailure:function(){t()}})},onFailure:function(){t()}})})).then((function(n){var i=[];void 0!==n&&n.results&&Object.keys(n.results).length&&n.results.forEach((function(t){if(void 0!==t&&t.attributes&&Object.keys(t.attributes).length)var n={};t.attributes.forEach((function(e){e&&("resourceid"===e.name&&(n.id=e.value),"ds6w:label"===e.name&&(n.title=e.value),"type_icon_url"===e.name&&(n.imageURL=e.value))})),i.push({id:n.id,title:n.title,image:n.imageURL,serviceId:e.serviceID,tenant:require("DS/PADUtils/PADUtilsServices").getPlatformId()})})),b=new S({title:e.title,description:e.description,taskType:h.SIMPLE_TASK,onCompleteCallback:s,onFailureCallback:()=>{e.onClose&&e.onClose(),m.cancel()},onExecuteCreateTask:()=>{e.onClose&&e.onClose(),m.cancel()},onCancelCallback:()=>{e.onClose&&e.onClose(),m.cancel()},attachments:i,deliverables:e.reportedAgainst,scopes:e.contexts&&e.contexts.length>0?e.contexts[0].physicalId:"",assignees:t}),b.renderAsDialog({enableRepeat:void 0}).dialog.addEventListener("close",(()=>{e.onClose&&e.onClose(),m.cancel()}))}))}))}function s(n){if(P.displayNotification({msg:n?r:o,eventID:n?"success":"error"}),n){var s=n.id,i=e.title;e.onComplete&&e.onComplete({attachmentIDs:e.attachments,title:i,ticID:s,type:"Task"}),U({fromIssue:t,attachments:e.attachments,id:s,okMsg:c,koMsg:l,objectType:"Task",serviceId:e.serviceID})}m.cancel()}function i(e){if(!require("UWA/Core").is(e,"object")||!require("UWA/Core").is(e.attributes,"array"))return{};for(var t={owner:{}},n=0;n<e.attributes.length;n++){var s=e.attributes[n];"ds6w:label"===s.name&&(t.title=s.value),"resourceid"===s.name&&(t.id=s.value),"ds6w:type"===s.name&&(t.type=s.value,t.dispType=s.dispValue),"type_icon_url"===s.name&&(t.iconUrl=s.value),"ds6w:responsible"===s.name&&(t.owner.fullName=s.value),"owner"===s.name&&(t.owner.user=s.value)}return t}},require(["DS/CollabComponents/CreateTask","DS/E6WCommonApps/ScheduleConstants"],(function(e,n){S=e,h=n,t()}))}this.options=e,e.executionContext?"PIMWebUXGenerateIssueHdr"===e.ID?d="Issue":"PIMWebUXGenerateIssueTemplateHdr"===e.ID?d="IssueTemplate":"PIMWebUXGenerateCAHdr"===e.ID?d="CA":"PIMWebUXGenerateTaskHdr"===e.ID?d="Task":"CATWebUXGenerateIssueHdr"===e.ID?d="Issue":"CATWebUXGenerateIssueTemplateHdr"===e.ID?d="IssueTemplate":"CATWebUXGenerateTaskHdr"===e.ID?d="Task":"CATWebUXGenerateCAHdr"===e.ID&&(d="CA"):"CATWebUXGenerateIssueHdr"===e.ID?d="Issue":"CATWebUXGenerateIssueTemplateHdr"===e.ID?d="IssueTemplate":"CATWebUXGenerateTaskHdr"===e.ID?d="Task":"CATWebUXGenerateCAHdr"===e.ID&&(d="CA"),delete e.pad3DViewer,e.mode="exclusive",e.isAsynchronous=!0,this._parent(e),this.getParameters=function(e){e.onFailure("Must be implemented by children")},this.beginExecute=function(){m.getParameters({cmdType:d,onComplete:function(e){var n;u=Object.assign({},e),"Issue"===d?(require(["DS/CATWebUXComponents/CATWebUXUtils"],(function(e){e._sendUsageProbe("command","GenerateIssue")})),n=e,v((function(){if(n.assignees=void 0,delete n.fromIssue,n.status&&"ticCancel"===n.status)m.cancel();else if(m.isRunning()){var e=document.getElementsByClassName("wux-windows-modalDialog");e.length&&e[0].setStyles({display:"none"});const t=[],s=n.reportedAgainst.filter((e=>!t.includes(e.physicalId)&&(t.push(e.physicalId),!0)));n.reportedAgainst=s,f=new p({data:n,htmlContainer:window.widget.body,onClose:e=>{n.onClose&&e&&n.onClose(),m.cancel()}})}}))):"IssueTemplate"===d?(require(["DS/CATWebUXComponents/CATWebUXUtils"],(function(e){e._sendUsageProbe("command","GenerateIssueTemplate")})),function(e){v((function(){if(e.assignees=void 0,delete e.fromIssue,e.status&&"ticCancel"===e.status)m.cancel();else if(m.isRunning()){var t=document.getElementsByClassName("wux-windows-modalDialog");t.length&&t[0].setStyles({display:"none"}),f=new A({data:e,htmlContainer:window.widget.body,onClose:t=>{e.onClose&&t&&e.onClose(),m.cancel()}})}}))}(e)):"Task"===d?(require(["DS/CATWebUXComponents/CATWebUXUtils"],(function(e){e._sendUsageProbe("command","GenerateTask")})),w(e)):(require(["DS/CATWebUXComponents/CATWebUXUtils"],(function(e){e._sendUsageProbe("command","GenerateCA")})),T(e)),m.platFormIssueSubscription=t.subscribe("DS/Object/create",(function(e){u.onComplete&&u.onComplete({attachmentIDs:u.attachments,name:u.title,ticID:e.data.paths[0][0],type:"Issue"})}))},onCancel:function(e){(u=Object.assign({},e))&&u.onCancel&&u.onCancel(),m.cancel.bind(m)},onFailure:function(e){window.console.error(e),m.done()}})},this.pauseExecute=function(){this.cancel()},this.cancelExecute=function(){f&&(f.destroy(),f=null),y&&y.hide(),m.platFormIssueSubscription&&t.unsubscribe(m.platFormIssueSubscription);var e=document.getElementsByClassName("wux-windows-modalDialog");e.length&&e[0].destroy(),this.done()},this._destroy=function(){m=P=null;var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)},this.onClose=function(){f=null,this.cancel()},this.disable&&!this.options.executionContext&&this.disable()}});return b}));