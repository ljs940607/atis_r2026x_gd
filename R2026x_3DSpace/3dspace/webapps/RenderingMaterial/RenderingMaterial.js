define("DS/RenderingMaterial/CachedRequest",[],(function(){return class{constructor(e,t){this._physicalID=e,this._callbacks=[],this._processCallbacksOnFail=!t,this._status=0,this._result={data:null,type:null}}requiresRetry(){return-1===this._status}setResult(e,t){this._result.data=e,this._result.type=t}getResult(){return this._result}processCallback(e){switch(this._status){case 0:this._callbacks.push(e);break;case 1:e(this._result.data,this._result.type);break;case-2:this._processCallbacksOnFail&&e(null,null);break;case-1:break;default:throw new Error(`Unexpected state (${this._status}) for : ${this._physicalID}`)}}onTimeout(){this._status=-1}onFailure(){this._status=-2,this.setResult(null,null),this._processCallbacksOnFail&&this._processQueuedCallbacks()}onSuccess(e,t){this._status=1,this.setResult(e,t),this._processQueuedCallbacks()}_processQueuedCallbacks(){for(;0!==this._callbacks.length;){this._callbacks.pop()(this._result.data,this._result.type)}}}})),define("DS/RenderingMaterial/MaterialRequestBuilder",[],(function(){"use strict";return{getAggregatedProcessor:()=>JSON.parse('{"materials":{ "uql" : "bo_46_plmentity_46_plm_95_externalid:\\"Applied%20Material\\""}}'),getMaterialAttributes:()=>["ds6w:type","ds6wg:catmatconnection.v_matrix_1","ds6wg:catmatconnection.v_matrix_2","ds6wg:catmatconnection.v_matrix_3","ds6wg:catmatconnection.v_matrix_4","ds6wg:catmatconnection.v_matrix_5","ds6wg:catmatconnection.v_matrix_6","ds6wg:catmatconnection.v_matrix_7","ds6wg:catmatconnection.v_matrix_8","ds6wg:catmatconnection.v_matrix_9","ds6wg:catmatconnection.v_matrix_10","ds6wg:catmatconnection.v_matrix_11","ds6wg:catmatconnection.v_matrix_12","bo.catmatconnection.v_mappingtype","bo.catmatconnection.v_scaleratio","bo.catmatconnection.v_focusmode","bo.catmatconnection.v_offsetu","bo.catmatconnection.v_offsetv","bo.catmatconnection.v_repeatu","bo.catmatconnection.v_repeatv","bo.catmatconnection.v_angle2d","bo.catmatconnection.v_layer","bo.dsc_matref_rep_rendering.visappearance","matPen.jsonstreamstorage"],getAggregationProcessors:()=>({materials:{uql:'bo_46_plmentity_46_plm_95_externalid:"Applied%20Material"'}})}})),define("DS/RenderingMaterial/PLMMaterialFactory",["DS/Visualization/MaterialConnection","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/MaterialApplication","DS/Visualization/InternalSceneGraph","DS/Visualization/PLMMaterialConnectionFactory","DS/Visualization/PLMMaterialServicesItf","DS/Visualization/SceneGraphUtils","DS/VisuLoaders/ThreeDXLoader","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/WAFData/WAFData","DS/RenderingMaterialLib/MaterialMappingCoreServices","DS/RenderingMaterialLib/VisuConversionHelpers","DS/RenderingMaterial/CachedRequest","DS/RenderingMaterial3DSI/RenderingMaterial3DSIParser"],(function(e,t,a,n,r,o,i,l,s,c,p,u,m,d,f,g){"use strict";const h=["PLANAR","SPHERICAL","FINITE_CYLINDRICAL","CUBIC","None","None","None","None","INFINITE_CYLINDRICAL"],_=["CLAMP_TO_EDGE","REPEAT"],y="true"===localStorage.getItem("XCT_AC_LOG_ENABLE");var M=new Map,b=new Map,v=new Map,I=new Map,x=new Map;i.setParams({loadAppearanceCB:async(e,t,a)=>{try{const a=I.get(e.appearanceId);t(e,await a)}catch(t){y&&console.error(`[AC][PLMMaterialFactory] Await load 3DXML: ${t.message}`),a(e)}},loadDecalCB:async(e,t,a)=>{try{const a=x.get(e.decalId);let n=await a;e.decalProjector=n.decalProjector,t(e,n)}catch(t){y&&console.error(`[AC][PLMMaterialFactory] Await load 3DXML: ${t.message}`),a(e)}}});var A=new Map,C=new Array,P=new Map,F=0;const w=["exr","tif","tiff"];var T=new p,S=1,L=e=>{let t=null,a=null,n=null;if(e){const r=JSON.parse(e),o=r.proxy;o[0]&&(t=o[0].value),o[1]&&(a=o[1].value,r.version<=2&&0!=a||r.version>2?o[2]&&(n=o[2].value):a=null)}return{internalPath:t,cgmIdRep:a,cgmIdPrimitive:n}},R=(e,t)=>{let a={visAppAttr:null,cnxAttr:null,materialReferenceType:null,matPen:null};if(M[e])if(1==S){if(M[e].domains&&M[e].domains[0]){const t=M[e].domains[0];if(t.default_key&&t.default_key.visappearance){let e=t.default_key.visappearance;a.visAppAttr=JSON.parse(e)}a.materialReferenceType=M[e].isKindOf}}else 2==S&&(a.visAppAttr=M[e],a.materialReferenceType=b[t].isKindOf,a.matPen=b[t].matpen);return a.cnxAttr=b[t],a},D=function(e){var t={};if(e.repeat&&(e.repeat[0]=parseFloat(e.repeat[0]),e.repeat[1]=parseFloat(e.repeat[1]),0!=e.repeat[0]&&(t.repeat_u=1==Math.abs(e.repeat[0])),0!=e.repeat[1]&&(t.repeat_v=1==Math.abs(e.repeat[1])),0!=e.repeat[0]&&(t.flip_u=e.repeat[0]<0),0!=e.repeat[1]&&(t.flip_v=e.repeat[1]<0)),e.offset&&(e.offset[0]=parseFloat(e.offset[0]),e.offset[1]=parseFloat(e.offset[1]),0!=e.offset[0]&&(t.offset_u=1e3*e.offset[0]),0!=e.offset[1]&&(t.offset_v=1e3*e.offset[1])),e.scale&&(e.scale=parseFloat(e.scale),0!=e.scale))if(e.scale<0){const a=6,n=2,r=e=>{let t=Number(e.slice(0,n));t-=50;let r=e.slice(n,a);return r=Number(r[0]+"."+r.slice(1)),r*Math.pow(10,t)},o=Math.abs(e.scale).toString(),i=a+n,l=r(o.slice(0,i)),s=r(o.slice(i,2*i));t.scale_u=l,t.scale_v=l/s}else{const a=1e6,n=1e3;t.scale_u=e.scale%a;const r=Math.floor(e.scale/a),o=r>0?r/n:1;t.scale_v=t.scale_u/o}return e.angle&&(e.angle=parseFloat(e.angle),0!=e.angle&&(t.angle=e.angle)),e.matrix&&(t.object_transform=e.matrix.map((function(e){return parseFloat(e)}))),e.mapType&&(e.mapType=parseInt(e.mapType),0!=e.mapType&&(t.type=e.mapType-1)),e.mapFocus&&(e.mapFocus=parseInt(e.mapFocus),0!=e.mapFocus&&(t.mapFocus=e.mapFocus-1)),t},E=function(e){let t={};return t.repeat_u=e.referenceMapping.repeat_u,t.repeat_v=e.referenceMapping.repeat_v,t.offset_u=e.referenceMapping.offset_u,t.offset_v=e.referenceMapping.offset_v,t.angle=e.referenceMapping.angle,t.flip_u=e.referenceMapping.flip_u,t.flip_v=e.referenceMapping.flip_v,t.scale_u=e.referenceMapping.scale_u,t.scale_v=e.referenceMapping.scale_v,t.type=e.referenceMapping.type,t.mapFocus=e.referenceMapping.behavior,t},k=function(e,t){return{reference:E(t),connection:D(e),channels:t.texturesInfo,mappingSemantic:t.mappingSemantic}},V=function(e){null!=e&&null!=e.dxm&&(null==e.jsonVersion&&(e.jsonVersion=1,e.IsSubstance&&(e.dxm=null)),e.jsonVersion<=2&&(e.texturesSize&&(e.texturesInfo=e.texturesSize,delete e.texturesSize),e.dxm&&e.dxm.textures?e.texturesInfo.length=e.dxm.textures.length:Array.isArray(e.texturesInfo)&&delete e.texturesInfo),null!=e.mappingSemantics?(e.mappingSemantic=e.mappingSemantics,delete e.mappingSemantics):null!=e.decoupledMapping&&(e.mappingSemantic=m.CATMappingSemantic.DecoupledMapping,delete e.decoupledMapping),null==e.mappingSemantic&&(e.mappingSemantic=m.CATMappingSemantic.LegacyMapping),N(e.dxm))},N=function(e){null!=e&&null!=e.binaries&&(e.binaries.flag="3DPlay",e.binaries.forEach((function(e,t){null!=e.uri&&(delete e.uri,null!=e.byteLength&&delete e.byteLength,null==e.extUri&&(e.extUri="0"))})))},$=function(e,a){const n=a.connection,r=a.reference,o=a.channels,i=a.mappingSemantic;if(!r||!o||!e.textures)return;!y||e.header&&"3.2"==e.header.version||console.warn("[AC][PLMMaterialFactory] Unsupported 3DXM version in VisAppearanceAttribute.");const l=m.computeApplicationMapping(r,n,i);e.textures.forEach(function(e,a){let s=null;null!=o[a]&&null!=o[a].mapping&&(s=o[a].mapping);const c=m.computeChannelMapping(r,n,s,o[a],i),p=m.combineMappingResults(l,c,i);e.uWrap=_[p.repeat_u?1:0],e.vWrap=_[p.repeat_v?1:0];const u=p.uv_transform.elements;null==e.mapping&&(e.mapping={}),e.mapping.slot=null,e.mapping.uvTransform=new Array(16);new t.Matrix4(u[0],u[3],0,u[6],u[1],u[4],0,u[7],0,0,1,0,0,0,0,1).flattenToArray(e.mapping.uvTransform),e.mapping.operator={},e.mapping.operator.type=h[p.type],p.object_transform&&(e.mapping.operator.transform=new Array(16),p.object_transform.flattenToArray(e.mapping.operator.transform)),delete e.uvTransform}.bind(this))},O=function(e,t){if(!Array.isArray(e.textures))return;const a=t.connection,n=t.reference,r=t.channels;for(let t=0;t<e.textures.length;t++){const o=null!=r[t].mapping?r[t].mapping:{};let i=!0;null!=a.repeat_u?i=a.repeat_u:null!=o.repeat_u?i=o.repeat_u:null!=n.repeat_u&&(i=n.repeat_u);let l=!0;null!=a.repeat_v?l=a.repeat_v:null!=o.repeat_v?l=o.repeat_v:null!=n.repeat_v&&(l=n.repeat_v);const s=e.textures[t];s.uWrap=_[i?1:0],s.vWrap=_[l?1:0]}},j=function(e){if(null==e.channels)return null;const a=m.computeApplicationMapping(e.reference,e.connection,e.mappingSemantic);let n={},r={};r.mappingType=d.GetVisMappingType(a.type),a.object_transform&&(r.mappingObjTransformation=a.object_transform),r.mappingUVTransformation=new t.Matrix3;for(let t of e.channels){const r=m.computeChannelMapping(e.reference,e.connection,t.mapping,t,e.mappingSemantic),o=m.combineMappingResults(a,r,e.mappingSemantic),i=d.GetVisParamDesc(t.id);i&&i.hasUvTransform()?n[i.uvTransformId]=o.uv_transform:y&&console.warn("[AC][PLMMaterialFactory] Invalid ID for texture")}return{matRefParams:n,matAppParams:r}},U=function(e){let t=e.dxm;if(!t||!t.textures||!e.texturesInfo)return!1;const a=t.materials[0];if(!a.type.startsWith("DSPBR"))return!1;if(e.jsonVersion>=4)return!0;let n=e.dxm.textures.length;const r=Object.keys(a);for(let o of r){const r=a[o];if("object"==typeof r&&"texture"in r){const a=r.texture,i=t.textures[a].image,l=t.images[i].binary;if(e.texturesInfo[l].id||(e.texturesInfo[l].id=o),0==--n)break}}return 0===n},B=function(e,t,a){this.messageFromIndex=e,this.getNodeFromID=t,this.getSecurityParams=a};return B.prototype.flushCache=function(){M=new Map,b=new Map,v=new Map,I.clear(),x.clear(),P.clear(),A.clear(),C.length=0,g.FreeCache()},B.prototype.onRemovedRoot=function(e){for(const t of I.keys())t.includes(e)&&(I.delete(t),i.removeMaterialConnection(t));for(const t of x.keys())t.includes(e)&&(x.delete(t),i.removeDecal(t))},B.prototype.setParams=function(e){null==e.rootId&&(e.rootId=0);var t=1;null!=e.jsonVersion&&(t=e.jsonVersion),2==t?(S=2,function(e,t){const a=e?.materials??[];for(const e of a){const t=e.resourceid;null!=t&&null==M[t]&&(M[t]=g.ParseMaterialFromIndex(e))}const n=e?.connections??[];for(const e of n){const t=e.resourceid;null!=t&&null==b[t]&&(b[t]=g.ParseConnectionFromIndex(e))}const r=e?.materials_overload??[];for(const e of r){const a={path:e.path,material:e.material,connection:e.connection};var o=!1;if(null!=v[t])for(const e in v[t])if(a.path.length===v[t][e].path.length&&a.material===v[t][e].material&&a.connection===v[t][e].connection){var i=!0;for(const n in a.path)if(a.path[n]!==v[t][e].path[n]){i=!1;break}i&&(o=!0)}o||(null==v[t]&&(v[t]=new Array),v[t].push(a))}}(e.messageFromIndex,e.rootId)):(this.messageFromIndex=e.messageFromIndex||null,function(e,t){if(e){var a=e.materials;if(a){var n=Object.keys(a);for(var r in n)(l=Object.keys(a[n[r]])[0])&&((c=null!=M[l])||(M[l]=a[r][l]))}for(var r in n=Object.keys(e))if("materials"!=n[r]){var o=e[n[r]];for(var i in o){var l,s={path:n[r].split(","),material:o[i].material,connection:o[i].connection};if(s){var c=!1;if(null!=v[t])for(var p in v[t])if(s.path.length===v[t][p].path.length&&s.material===v[t][p].material&&s.connection===v[t][p].connection){var u=!0;for(var m in s.path)if(s.path[m]!==v[t][p].path[m]){u=!1;break}u&&(c=!0)}c||(null==v[t]&&(v[t]=new Array),v[t].push(s))}s.connection&&(l=s.connection)&&((c=null!=b[l])||(b[l]=o[i]))}}}}(this.messageFromIndex,e.rootId)),this.getNodeFromID=e.getNodeFromID||null,this.retrieveIRPathFromIIPath=e.retrieveIRPathFromIIPath||null,this.retrieveRIRPathFromIIPath=e.retrieveRIRPathFromIIPath||this.retrieveIRPathFromIIPath,this.getSecurityParams=e.getSecurityParamsCB||null,i.setParams({getNodeFromIdCB:this.getNodeFromID})},B.prototype.computeMaterials=function(e){if("true"!==localStorage.getItem("XCT_AC_MATERIAL_PARSER_DISABLE"))return this.computeMaterialsV2(e);y&&console.warn("[AC][PLMMaterialFactory] Use of deprecated method computeMaterials");const t="true"!==localStorage.getItem("XCT_AC_TEXTURE_CACHE_DISABLE"),n="true"===localStorage.getItem("XCT_AC_LEGACY_MAPPING_COMPUTATION_ENABLE"),o="true"===localStorage.getItem("XCT_AC_TEXTURE_FALLBACK_DISABLE");var l=function(e,a){let n=function(){if(--F,C.length){let e=C.pop();s(e.physicalID,e.doneCB)}};if("0"===e)return y&&console.debug("[AC][PLMMaterialFactory] physicalID === 0, this means it is probably an old material where substance does not work. You can try to update the VisAppearanceAttribut"),a(null,null),void n();var r,i=null;if(t){let t=!0;A.has(e)?t=(i=A.get(e)).requiresRetry():(i=new f(e,o),A.set(e,i));try{i.processCallback(a)}catch(e){y&&console.error(`[AC][PLMMaterialFactory] Cached request failed with: ${e.message}`)}if(!t)return void n()}this.getSecurityParams&&(r=this.getSecurityParams());var l="Substance_";if(e.includes(l)){var c=e.indexOf("_",10),p=e.substring(10,c),m=e.substr(c+1);u.authenticatedRequest(`${r.service3DSpaceUrl}/resources/fcsservices/fcs/mediaURL?boid=${p}&format=1&filename=${p}_%27EXTENDED%27.1=${m}`,{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(r,o){y&&console.debug(`[AC][PLMMaterialFactory] Load Substance texture : ${e} | Size: ${r.byteLength}`),P.delete(e),t?i.onSuccess(r,"png"):a(r,"png"),n()}.bind(this),onFailure:function(a,r,o){y?console.warn("[AC][PLMMaterialFactory] Failed to get Substance texture : "+e):console.warn("[Rendering Material] Failed to get Substance texture"),P.delete(e),t&&i.onFailure(),n()}.bind(this),onTimeout:function(){P.has(e)||P.set(e,0);let r=P.get(e);r<3?(P.set(e,r+1),y&&console.warn(`[AC][PLMMaterialFactory] Timeout when trying to load Substance texture: ${e} => Trying again. (${r})`),t&&i.onTimeout(),s(e,a)):(y?console.warn(`[AC][PLMMaterialFactory] Timeout when trying to load Substance texture : ${e} => Max number of timeout reached. (${P.get(e)})`):console.warn("[Rendering Material] Timeout while loading texture."),P.delete(e),t&&(i.onFailure(),n()))}.bind(this)})}else u.authenticatedRequest(r.service3DSpaceUrl+"/cvservlet/fetch/v2?tenant="+r.tenant,{method:"POST",proxy:"passport",type:"json",responseType:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},data:JSON.stringify({label:r.userLogin+"fetch-"+e,physicalid:[e],locale:"en",tenant:r.tenant,select_predicate:["ds6wg:plmdmtdocument.v_primarymimetype","plmtdoc.stream.name"]}),onComplete:function(o,l){var c="png";if(o&&o.results&&o.results[0].attributes)for(var p=0;p<o.results[0].attributes.length;++p)"ds6wg:plmdmtdocument.v_primarymimetype"==o.results[0].attributes[p].name&&(c=o.results[0].attributes[p].value);if(w.includes(c))return console.warn("[Rendering Material] Unsupported texture type : "+c),t&&i.onFailure(),void n();u.authenticatedRequest(`${r.service3DSpaceUrl}/resources/fcsservices/fcs/mediaURL?boid=${e}&format=1&filename=${e}_%27%27.1`,{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(r,o){y&&console.debug(`[AC][PLMMaterialFactory] Load texture: ${e} | Size: ${r.byteLength}`),P.delete(e),t?i.onSuccess(r,c):a(r,c),n()}.bind(this),onFailure:function(a,r,o){y?console.warn("[AC][PLMMaterialFactory] Failed to get texture : "+e):console.warn("[Rendering Material] Failed to load texture."),P.delete(e),t&&i.onFailure(),n()}.bind(this),onTimeout:function(){P.has(e)||P.set(e,0);let r=P.get(e);r<3?(P.set(e,r+1),y&&console.warn("[AC][PLMMaterialFactory] Timeout when trying to load texture :"`${e} => Trying again. (${r})`),t&&i.onTimeout(),s(e,a)):(y?console.warn(`[AC][PLMMaterialFactory] Timeout when trying to load texture: ${e} => Max number of timeout reached. (${P.set(e)})`):console.warn("[Rendering Material] Timeout while loading texture."),P.delete(e),t&&(i.onFailure(),n()))}.bind(this)})}.bind(this),onFailure:function(e,a,r){y?console.warn("[AC][PLMMaterialFactory] Failed to load CATIPLMDmtDocument stream."):console.warn("[Rendering Material] Failed to load texture."),t&&i.onFailure(),n()},onTimeout:function(){y?console.warn("[AC][PLMMaterialFactory] Timeout when trying to load CATIPLMDmtDocument stream."):console.warn("[Rendering Material] Timeout while loading texture."),t&&(i.onFailure(),n())}})}.bind(this),s=function(e,t){F>100?(C.unshift({physicalID:e,doneCB:t}),y&&console.debug("[AC][PLMMaterialFactory] Maximum number of requests reached, queue in request pool: ",e)):(++F,l(e,t))}.bind(this),p=0;null!=e&&(p=e.rootId),null==p&&(p=0);const d=v[p];for(var g=d.length,h=0;h<d.length;++h){const t=d[h],o=t.material,l=t.connection;let u=R(o,l),f=u.visAppAttr,b=u.materialReferenceType,v=u.matPen;const x=u.cnxAttr;if(!b.toLowerCase().includes("covering")&&!b.toLowerCase().includes("core")){e&&null!=e._onIndexErrorCallback&&e._onIndexErrorCallback(l),y&&console.warn("[AC][PLMMaterialFactory] Reference Type not supported: ",b);continue}if(!f){e&&null!=e._onIndexErrorCallback&&e._onIndexErrorCallback(l);continue}if(V(f),null==f||null==f.dxm){console.error("[Rendering Material] Invalid material information."),e&&null!=e._onIndexErrorCallback&&e._onIndexErrorCallback(l);continue}let C=t.path;if(!C){e&&null!=e._onIndexErrorCallback&&e._onIndexErrorCallback(l);continue}const P=k(x,f),F=f.dxm;null!=F.binaries&&(null==P.reference&&y&&console.warn("[AC][PLMMaterialFactory] We have textures but missing reference mapping values. VisAppearanceAttribut generation problem?"),null==P.channels&&y&&console.warn("[AC][PLMMaterialFactory] We have textures but missing texture infos. VisAppearanceAttribut generation problem?"));let w=null!=P.reference.type?P.reference.type:-1;P.connection.type&&(w=P.connection.type);const S=U(f),L=n||!S;L?(y&&console.debug(`[AC][PLMMaterialFactory] Apply mapping by modifying 3DXM (legacy) for cnx: ${l}`),$(F,P)):O(F,P);var _=function(e,t,a,n,r){let o=null,l=null,s=null;if(r){const e=JSON.parse(r),t=e.proxy;t[0]&&(o=t[0].value),t[1]&&(l=t[1].value,e.version<=2&&0!=l||e.version>2?t[2]&&(s=t[2].value):l=null)}const c=this.retrieveIRPathFromIIPath(e);i.addMaterialConnection(e[0],{idPath:c,appearanceId:t,type:a,vLayer:n,internalPath:o,cgmIdRep:l,cgmIdPrimitive:s?s[0]:null,cgmIdPrimitives:s,legacyUV:w==m.CATMappingType.UV})}.bind(this),M=function(){--g<=0&&(y&&console.debug("[AC][PLMMaterialFactory] Cleanup texture cache"),A.clear())}.bind(this);const D=new r({faceMaterial:null}),E="APP#"+p+h;I.set(E,new Promise(((t,n)=>{e&&null!=e._load3dxmBegin&&e._load3dxmBegin(l,F);const r=new c,o=new a;r.loadMaterial({destinationNode:o,json:F,resourcesLibrary:T,binaryCallback:function(t,a){return e&&null!=e._load3dxmBinCallback&&e._load3dxmBinCallback(t),s(t,a)},doneCallback:function(a,r){M();const o=r.material;if(o&&a){if(!L){y&&console.debug(`[AC][PLMMaterialFactory] Apply mapping directly on material for cnx: ${l}`);const e=j(P);e&&(o.setPhysicalProperties(e.matRefParams),o.setMappingOperator(e.matAppParams.mappingType,e.matAppParams.mappingObjTransformation,e.matAppParams.mappingUVTransformation,!0))}a.setParameters({faceMaterial:o,enableDepth:!0}),e&&null!=e._load3dxmDoneCallback&&e._load3dxmDoneCallback(l,a,o),t(a)}else n(new Error(`Loaded material is null for cnx: ${l}`))}.bind(this,D),errorCallback:function(){M(),e&&null!=e._load3dxmErrorCallback&&e._load3dxmErrorCallback(l),n(new Error(`Failed to load material for cnx: ${l}`))}.bind(this)})})));_(C,E,b.toLowerCase().includes("covering")?i.COVERAGE_MATERIAL:i.CORE_MATERIAL,parseInt(x.layer),v)}},B.prototype.computeMaterialsV2=function(e){const t=e?.rootId??0,a=v[t];for(var n=0;n<a.length;++n){const o=a[n],l=o.material,s=o.connection,c=R(l,s);if(!c.visAppAttr){e?._onIndexErrorCallback?.(s);continue}const p=o.path;if(!p){e?._onIndexErrorCallback?.(s);continue}let u={};try{u=g.ProcessIndexAttributes(c.visAppAttr,c.cnxAttr)}catch(t){y&&console.error(t),e?._onIndexErrorCallback?.(s);continue}if(g.IsDecalReferenceType(c)){const a="DCL#"+t+n;x.set(a,new Promise((async(t,a)=>{e?._load3dxmBegin?.(s,u.dxm);const n=await g.ImportDecal({dxm:u.dxm,mappingInfo:u.mappingInfo,domainId:u.domainId,securityParameters:this.getSecurityParams(),onBeforeTextureFetchCallback:e?._load3dxmBinCallback}).catch((t=>{e?._load3dxmErrorCallback?.(s),a(t)}));e?._load3dxmDoneCallback?.(s,n,n.visMaterial),t(n)})));const r=p[0],o=this.retrieveRIRPathFromIIPath(p),l=parseInt(c.cnxAttr.layer),d=u.mappingInfo.mappingType==m.CATMappingType.UV;i.addDecal(r,{idPath:o,decalId:a,vLayer:l,decalMode:d?1:0,inheritanceMaterial:1})}else{const a="APP#"+t+n,o=new r({faceMaterial:null});I.set(a,new Promise((async(t,a)=>{e?._load3dxmBegin?.(s,u.dxm);const n=await g.ImportMaterial({dxm:u.dxm,mappingInfo:u.mappingInfo,domainId:u.domainId,securityParameters:this.getSecurityParams(),onBeforeTextureFetchCallback:e?._load3dxmBinCallback}).catch((t=>{e?._load3dxmErrorCallback?.(s),a(t)}));o.setParameters({faceMaterial:n,enableDepth:!0}),e?._load3dxmDoneCallback?.(s,o,n),t(o)})));const l=c.materialReferenceType.toLowerCase().includes("covering")?i.COVERAGE_MATERIAL:i.CORE_MATERIAL,d=p[0],f=this.retrieveIRPathFromIIPath(p),h=parseInt(c.cnxAttr.layer),_=u.mappingInfo.mappingType==m.CATMappingType.UV,y=L(c.matPen);i.addMaterialConnection(d,{idPath:f,appearanceId:a,type:l,vLayer:h,internalPath:y.internalPath,cgmIdRep:y.cgmIdRep,cgmIdPrimitive:y.cgmIdPrimitive?.[0]??null,cgmIdPrimitives:y.cgmIdPrimitive,legacyUV:_})}}this.settleAllMaterialComputations().then((()=>g.FreeCache()))},B.prototype.settleAllMaterialComputations=async function(){return Promise.allSettled(I.values()).then(Promise.allSettled(x.values()))},new B}));