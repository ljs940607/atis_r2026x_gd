define("DS/ENOAttachmentsWebInWin/Attachments",["DS/ENOXAttachmentsAndSpecificationsUX/AttachmentsAndSpecifications","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/EditPropWidget/EditPropWidget","DS/EditPropWidget/constants/EditPropConstants","DS/EditPropWidget/models/EditPropModel","DS/WAFData/WAFData","i18n!DS/ENOXAttachmentsUX/assets/nls/ENOXAttachmentsUX","css!DS/ENOAttachmentsWebInWin/assets/css/ENOAttachmentsWebInWin.css"],(function(e,t,n,a,c,i,s){"use strict";var o=null,r="DOCUMENTS",d=function(e){1!=e.data.length||e.PLMDMTDocumentTypes&&(!e.PLMDMTDocumentTypes||e.PLMDMTDocumentTypes.includes(e.data[0].type))||e.contextMenu.addItem({title:s.get("PREVIEW"),name:"Preview",text:s.get("PREVIEW"),fonticon:"eye",handler:function(){var t=[];e.data.forEach((e=>{e.relateddata&&e.relateddata.files&&e.relateddata.files.length>1?e.relateddata.files.forEach((e=>{t.push({docId:e.id,docType:r,docName:e.dataelements.title})})):t.push({docId:e.id,docType:r,docName:e.dataelements.name})})),l(t)}})},l=function(e){var t="";e.forEach((e=>{t+=e.docId+"&name="+e.docName+"&documentType="+e.docType+";"})),dscef.sendString("ObjectSelect="+t)},p={modelEvents:null,attachmentsAndSpecifications:null,InitWebInWin:function(t){var c=this;o=t.user;var i={};p._getWebInWinParameters((function(s){i=s||null,c.hideAttachments="true"===t.hideAttachments,c.hideSpecifications="true"===t.hideSpecifications,p._populate3DSpaceURL(i).then((function(t){var i=UWA.createElement("div",{id:"AttachmentsWebInWinProperty"});i.inject(widget.body);var s={className:"editTaskProperties",setEditButton:!1,readOnly:!0,typeOfDisplay:a.ONLY_IDENTITY_CARD,multiselection:!1,collapseTabs:!1,context:widget,actions:[]};c.prop=new n(s),c.prop.elements.container.inject(i);var o=t;if(1==t.length)o=t[0];else for(var r=p._getTenantId(),d=0;d<t.length;d++)if(r==t[d].platformId){o=t[d];break}var l=o&&o["3DSpace"]?o["3DSpace"]:"",f=(o&&o["3DDashboard"]&&o["3DDashboard"],o&&o.platformId?o.platformId:"");widget.data.x3dPlatformId=f,widget.data.appId="ENXWDOC_AP",c.getSecurityContexts(l,f).then((function(t){var n={connectorOptions:{fetchSecurityContext:function(){return t.securityContext},platformUrls:o,getWorkUnderHeaders:function(){console.log("Before SetChangeActionID"),dscef.sendString("FetchChangeActionID =1");for(var e=new Date,t=e;t-e<2e3&&(null==c.changeID||""==c.changeID);)t=new Date;return console.log("After SetChangeActionID"),null!=c.changeID&&""!=c.changeID?{"DS-Change-Authoring-Context":"pid:"+c.changeID}:{}}},webinwin:!0};c.hideAttachments&&(n.hideAttachments=c.hideAttachments),c.hideSpecifications&&(n.hideSpecifications=c.hideSpecifications),c.attachmentsAndSpecifications=new e(n),c.hideAttachments||(c.attachmentsModelEvents=c.attachmentsAndSpecifications.attachmentsPane.modelEvents),c.hideSpecifications||(c.specificationsModelEvents=c.attachmentsAndSpecifications.specificationsPane.modelEvents),c.subscribeToTasks();var a=UWA.createElement("div",{id:"AttachmentsWebInWin"});a.inject(widget.body),c.attachmentsAndSpecifications.inject(a),dscef.sendString("FetchChangeActionID=1"),dscef.sendString("SetInitialParentObjectID=1")}))}),(function(e){return console.log("Populate 3DSpace URL failed"),Promise.reject(e)}))}))},_getTenantId:function(){return dscef.getEnv("MX_ONLINE_INSTANCE")},_getWebInWinParameters:function(e){window.COMPASS_CONFIG&&window.COMPASS_CONFIG.myAppsBaseUrl?e(window.COMPASS_CONFIG):p._getAppsUrl((function(t){window.COMPASS_CONFIG||(window.COMPASS_CONFIG={}),t&&(window.COMPASS_CONFIG.myAppsBaseUrl=t,window.COMPASS_CONFIG.userId||(window.COMPASS_CONFIG.userId=o),window.COMPASS_CONFIG.lang||(window.COMPASS_CONFIG.lang=widget.lang)),e(window.COMPASS_CONFIG)}))},_getAppsUrl:function(e){"function"==typeof dscef.getMyAppsURL?dscef.getMyAppsURL().then((function(t){console.log("MyApps URL",t),e(t)})).catch((function(t){console.error("Failed to fetch MyApps URL: "+t),e(null)})):e(null,null)},_populate3DSpaceURL:function(e){return new Promise((function(n,a){var c=null;e&&((c={}).myAppsBaseUrl=e.myAppsBaseUrl,c.userId=e.userId,c.lang=e.lang),t.getPlatformServices({config:c,platformId:dscef.getEnv("MX_ONLINE_INSTANCE"),onComplete:function(e){n(e)},onFailure:a})}))},subscribeToTasks:function(){var e=this;e.attachmentsModelEvents&&(e.attachmentsModelEvents.subscribe({event:"open-3dsearch-for-add-existing"},(function(t){e.SearchOpenedFrom="attachments",dscef.sendString("SelectFromSearch="+t.precond)})),e.attachmentsModelEvents.subscribe({event:"context-menu-requested"},d),e.attachmentsModelEvents.subscribe({event:"attach-attachment-complete"},(function(e){dscef.sendString("RefDocAttachComplete="+e.parentObject.parentId+":"+e.document.id)})),e.attachmentsModelEvents.subscribe({event:"upload-attachment-complete"},(function(e){for(var t="",n=0;n<e.documents.length;n++)t=t+e.documents[n].id+",";dscef.sendString("RefDocUploadComplete="+e.parentObject.parentId+":"+t)})),e.attachmentsModelEvents.subscribe({event:"detach-attachment-complete"},(function(e){dscef.sendString("RefDocDetachComplete="+e.parentObject.parentId+":"+e.id)}))),e.specificationsModelEvents&&(e.specificationsModelEvents.subscribe({event:"open-3dsearch-for-add-existing"},(function(t){e.SearchOpenedFrom="specifications",dscef.sendString("SelectFromSearch="+t.precond)})),e.specificationsModelEvents.subscribe({event:"context-menu-requested"},d),e.specificationsModelEvents.subscribe({event:"attach-attachment-complete"},(function(e){dscef.sendString("SpecDocAttachComplete="+e.parentObject.parentId+":"+e.document.id)})),e.specificationsModelEvents.subscribe({event:"upload-attachment-complete"},(function(e){for(var t="",n=0;n<e.documents.length;n++)t=t+e.documents[n].id+",";dscef.sendString("SpecDocUploadComplete="+e.parentObject.parentId+":"+t)})),e.specificationsModelEvents.subscribe({event:"detach-attachment-complete"},(function(e){dscef.sendString("SpecDocDetachComplete="+e.parentObject.parentId+":"+e.id)})))},SelectFrom3DDone:function(e,t,n){if("undefined"!==e){this.attachmentsAndSpecifications.setParentObject({parentId:e},t,n);var a=[new c({metatype:"Task",objectId:e})];this.prop.initDatas(a)}else this.attachmentsAndSpecifications.setParentObject(),this.prop.initDatas([])},SelectFromSearchDone:function(e){for(var t=e.split(","),n=[],a=0;a<t.length;a++)n.push(t[a]);"attachments"==this.SearchOpenedFrom?this.attachmentsAndSpecifications.attachmentsPane.attachAttachments(n):"specifications"==this.SearchOpenedFrom&&this.attachmentsAndSpecifications.specificationsPane.attachSpecifications(n)},SetChangeActionID:function(e){this.changeID=e,console.log("SetChangeActionID "+e)},SetInitialParentID:function(e,t,n){this.SelectFrom3DDone(e,t,n),console.log("SetInitialParentID "+e)},getSecurityContexts:function(e,t){var n={method:"GET"};return n.headers={Accept:"application/json","Content-Type":"application/json","Accept-Language":widget.lang?widget.lang:widget.getValue("lang")},n.cache=-1,new Promise((function(a,c){n.onComplete=function(e){a(JSON.parse(e))},n.onFailure=function(e,t){var n=null;try{n=JSON.parse(t)}catch(e){}null===n&&(n=t),c(n)};var s=t;i.authenticatedRequest(e+"/resources/modeler/pno/person?tenant="+s+"&current=true&select=preferredcredentials&select=collabspaces",n)})).then((function(e){var t=function(e,t,n){return"ctx::"+n+"."+t+"."+e},n=function(e,t,n){return""===t?e+" ● "+n:e+" ● "+t+" ● "+n},a=function(e){var t="",n="",a="";for(var c in e)if(e.hasOwnProperty(c)){var i=e[c];switch(c){case"organization":t=i.name;break;case"role":n=i.name,a=i.nls?i.nls:n}}return{org:t,role:n,roleNls:a}},c="ctx:",i=e.pid,s=[],o="",r="",d="";for(var l in e.preferredcredentials)if(e.preferredcredentials.hasOwnProperty(l)){var p=e.preferredcredentials[l];switch(l){case"collabspace":o=p.name;break;case"organization":r=p.name;break;case"role":d=p.name}}c=t(o,r,d);var f=[];for(var h in e.collabspaces)if(e.collabspaces.hasOwnProperty(h))for(var u=e.collabspaces[h],m=0;m<u.couples.length;m++){var S=a(u.couples[m]);f.push(S.org)}var g=f.every((function(e,t,n){return e===n[f.length-1]}));for(var v in e.collabspaces)if(e.collabspaces.hasOwnProperty(v))for(var I=e.collabspaces[v],A=0;A<I.couples.length;A++){var D=a(I.couples[A]),b=t(I.name,D.org,D.role),O=I.title?I.title:I.name,C={csName:O,label:n(O,g?"":D.org,D.roleNls),value:b};c===b&&(C.isDefault=!0),s.push(C)}return""!==o&&""!==r&&""!==d||s.length>0&&(c=s[0].value),widget.addPreference({name:"credentials",defaultValue:c,type:"list",label:"Credentials",options:s}),{userId:i,securityContext:c,cspaces:s}}))}};return p}));