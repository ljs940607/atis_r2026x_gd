define("DS/SocialGlobe/Globals",["DS/Visualization/ThreeJS_DS","UWA/Utils/Client","DS/Visualization/Detector","DS/WebappsUtils/WebappsUtils","UWA/Promise","DS/WAFData/WAFData","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],(function(e,t,i,o,a,r,s){"use strict";var n={path:"./",defaultTheme:"satellite",theme:void 0,sendMessage:void 0};return n.defaultMaterial=new e.MeshLambertMaterial({color:16777215}),n.tilespath=o.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/satellite/tiles/"),n.tileExtension=".basis",n.localTilesMaxLevel=7,n.countries=null,n.downloadWithCors=function(e,t){var i=!0;for(var o in n.credentials)-1!==e.indexOf(o)&&(i=n.credentials[o]);return UWA.Data.request(e,{cors:i,async:!0,onComplete:t})},n.latlonToXYZ=function(t,i,o){var a,r,s,n=1;return o&&o>0&&(n=1+o/6371e3),a=n*Math.cos(-t*Math.PI/180)*Math.cos(-i*Math.PI/180),r=-n*Math.sin(-t*Math.PI/180),s=n*Math.cos(-t*Math.PI/180)*Math.sin(-i*Math.PI/180),new e.Vector3(a,r,s)},n.XYZToLatlon=function(t){var i,o=new e.Vector3(t.x,0,t.z);return o.normalize(),0,i=180*(o.z>0?-1:1)*Math.acos(o.x)/Math.PI,{lat:-180*Math.asin(-t.y)/Math.PI,lon:i}},n.tile2lon=function(e,t){return t/Math.pow(2,e)*360-180},n.tile2lat=function(e,t){var i=Math.PI-2*Math.PI*t/Math.pow(2,e);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},n.lon2tileFlt=function(e,t){return(e+180)/360*Math.pow(2,t)},n.lat2tileFlt=function(e,t){return(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t)},n.loadTextureCube=function(t,i){var a=[o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_E."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_W."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_N."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_S."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_F."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_B."+i];return e.ImageUtils.crossOrigin="use-credentials",e.ImageUtils.loadTextureCube(a)},n.toHex=function(e){return e=parseInt(255*e,10),isNaN(e)?"00":(e=Math.max(0,Math.min(e,255)),"0123456789ABCDEF".charAt((e-e%16)/16)+"0123456789ABCDEF".charAt(e%16))},n.rgbToHtml=function(e){return e?"#"+n.toHex(e[0])+n.toHex(e[1])+n.toHex(e[2]):"#FFFFFF"},n.htmlToRGB=function(e){return[parseInt(e.substring(1,3),16)/255,parseInt(e.substring(3,5),16)/255,parseInt(e.substring(5,7),16)/255]},n.convertColorCode=function(e){var t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c","indigo ":"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]?t[e.toLowerCase()]:e},n.isBrowserSupported=function(){return i.webgl},n.getBrowserErrorMsg=function(){return"<center><img src='assets/textures/COMPASS_Blue.jpg' width='200px'><br><br>This browser is not supported. <a href='http://get.webgl.org/troubleshooting/' target=_blank>More information here.</a></center>"},n.buttonStyle={"font-family":'"3dsweblight",Helvetica,Arial,sans-serif',color:"#77797c","font-size":"1em","font-weight":"normal","white-space":"nowrap",padding:".625em 1em",border:"1px solid #b4b6ba","-webkit-box-shadow":"none","-moz-box-shadow":"none","-o-box-shadow":"none","-ms-box-shadow":"none","box-shadow":"none",cursor:"pointer",zIndex:"51000"},n.createCurvePath=function(t,i,o,a){var r=void 0!==t[2]?t[2]:10,s=void 0!==i[2]?t[2]:10,l=(r+s)/2+o,d=n.latlonToXYZ(t[1],t[0],r),c=n.latlonToXYZ(i[1],i[0],s),h=n.latlonToXYZ((t[1]+i[1])/2,(t[0]+i[0])/2,l);null!==a&&a&&(d=n.latlonToXYZ(t[0],t[1],r),c=n.latlonToXYZ(i[0],i[1],s),h=n.latlonToXYZ((t[0]+i[0])/2,(t[1]+i[1])/2,l));var u=new e.QuadraticBezierCurve3(d,h,c),g=new e.CurvePath;return g.add(u),g},n.isCountriesLoaded=function(){return!(null===n.countries)},n.loadCountries=function(){return new a((function(e,t){if(n.countries)e(n.countries);else{var i=o.getWebappsAssetUrl("SocialGlobe","data/countries-light-properties.geojson"),a={method:"GET",type:"json",onComplete:function(t){if(t&&t.features){var i=[];n.countries={};for(var o=0;o<t.features.length;o++){var a=t.features[o];a&&a.properties&&a.properties.ISO3&&-1===i.indexOf(a.properties.ISO3)&&(n.countries[a.properties.ISO3]=s.get("GlobeViewer.Countries.ISO3."+a.properties.ISO3),i.push(a.properties.ISO3))}}e(n.countries)},onFailure:t};r.authenticatedRequest(i,a)}}))},n})),define("DS/SocialGlobe/Disposer",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D"],(function(e,t,i){return e.SceneGraphUtils={traverseV6:function(t,i,o){if(!0===o(t,i))for(var a=0,r=t.children.length;a<r;a++)t.children[a]!=t&&e.SceneGraphUtils.traverseV6(t.children[a],i,o)},dispose:function(o,a,r){if(!o)return console.error("Error in disposer: element null"),!1;if(o instanceof Array)for(var s=0;s<o.length;s++)this.dispose(o[s],a,r);if(o.observers)for(var n=o.observers.length;n--;)o.observers[n](o);if(!0!==a&&void 0!==o.shared&&o.shared>0)return!1;var l=!1;if(o instanceof e.Texture||o instanceof e.DataTexture)o.dispatchEvent({type:"dispose"}),o.img=null;else if(o instanceof i){var d=o.mesh3js;void 0!==d.material&&this.dispose(d.material,a),void 0!==d.geometry&&this.dispose(d.geometry,a)}else o.dispose&&(o.dispose(),void 0!==o.needsUpdate&&(o.needsUpdate=!0));return o instanceof t&&(l=!0),l},disposeV6:function(e,t){this.traverseV6(e,t,this.dispose.bind(this))}},e.SceneGraphUtils})),define("DS/SocialGlobe/PlanarQuadTree",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t=function(e,t,i,o){this.levelMax=0,this.base={I:0,J:0},this.P={X:0,Y:0},this.levelMin=e,this.leafOnly=t,this.earlyCulled=0,this.horizonCulled=0,this.circular=!1,this.quads=[{LOD:0,I:0,J:0,X:0,Y:0,Size:1,Stitching_North:!1,Stitching_West:!1,Stitching_South:!1,Stitching_East:!1}],this.cropBox=i,this.cropIJBox={},this.lod=2,this.isCircular=o};return t.prototype={build:function(e,t,i,o){var a,r,s,n,l,d,c,h=this.getBaseIJ(t,i,o);this.P={X:i,Y:o},this.base=h,this.quads.length=0,this.earlyCulled=0,this.horizonCulled=0;for(var u,g=1,p=0,m=1,f=0;t>=this.levelMin;){h=this.getBaseIJ(t,i,o),0,c=(u=1<<t)-1,m<f&&(m===c&&(m-=c,f-=c),0===f&&(m+=c,f+=c)),this.leafOnly?h.J=Math.min(Math.max(h.J,2),c-3):h.J=Math.min(Math.max(h.J,1),c-1),l=(l=h.I-Math.min(2,Math.floor(c/2)))%2!=0?l-1:l,this.isCircular||(l=Math.max(l,0)),d=(d=h.I+Math.min(2,Math.floor(c/2)))%2==0?d+1:d,d=this.isCircular?Math.min(d,l+c):Math.min(d,c);var v=void 0,b=void 0;if(b=this.leafOnly?(v=Math.max(h.J-2,0))+5:(v=Math.max(h.J-this.lod,0))+2*this.lod+1,b=Math.min(b,c),void 0!==this.cropBox){this.cropBox.getIJBox(t,this.cropIJBox);var w=Math.max(l,this.cropIJBox.IMin),x=Math.min(d,this.cropIJBox.IMax),y=Math.max(v,this.cropIJBox.JMin),C=Math.min(b,this.cropIJBox.JMax)}for(s=l;s<=d;s+=1)for(n=v;n<=b;n+=1)a=(s+u)%u,r=n,void 0!==this.cropBox&&(a<w||r<y||a>x||r>C)||this.leafOnly&&s>=m&&s<=f&&n>=g&&n<=p||this.addQuad(t,a,r,n===b,s===l,n===v,s===d,Math.abs(a-h.I)+Math.abs(r-h.J),void 0!==this.cropBox&&(a===w||r===y||a===x||r===C));1,2,t-=1,m=Math.floor(l/2),g=Math.floor(v/2),f=Math.floor(d/2),p=Math.floor(b/2)}return!0},getBaseIJ:function(e,t,i){var o=1<<e,a={I:Math.floor(t*o),J:Math.floor(i*o)};return this.leafOnly&&(a.J=2*Math.floor(a.J/2)),a},getXY:function(t,i,o){return new e.Vector2((i+.5)/t,(o+.5)/t)},getXYVector:function(e,t,i,o){o.set((t+.5)/e,(i+.5)/e)},addQuad:function(e,t,i,o,a,r,s,n,l){var d=1/(1<<e);this.quads.push({LOD:e,I:t,J:i,X:t*d,Y:i*d,Size:d,Length:n,Stitching_North:o,Stitching_West:a,Stitching_South:r,Stitching_East:s,intersectCropBox:l})}},t})),define("DS/SocialGlobe/Matrix4d",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t,i,o,a,r,s;e.Matrix4d=function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m){var f=this.elements=new Float64Array(16);f[0]=void 0!==e?e:1,f[4]=t||0,f[8]=i||0,f[12]=o||0,f[1]=a||0,f[5]=void 0!==r?r:1,f[9]=s||0,f[13]=n||0,f[2]=l||0,f[6]=d||0,f[10]=void 0!==c?c:1,f[14]=h||0,f[3]=u||0,f[7]=g||0,f[11]=p||0,f[15]=void 0!==m?m:1},e.Matrix4d.prototype={constructor:e.Matrix4d,set:function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m){var f=this.elements;return f[0]=e,f[4]=t,f[8]=i,f[12]=o,f[1]=a,f[5]=r,f[9]=s,f[13]=n,f[2]=l,f[6]=d,f[10]=c,f[14]=h,f[3]=u,f[7]=g,f[11]=p,f[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]),this},setRotationFromEuler:function(e,t){var i=this.elements,o=e.x,a=e.y,r=e.z,s=Math.cos(o),n=Math.sin(o),l=Math.cos(a),d=Math.sin(a),c=Math.cos(r),h=Math.sin(r);if(void 0===t||"XYZ"===t){var u=s*c,g=s*h,p=n*c,m=n*h;i[0]=l*c,i[4]=-l*h,i[8]=d,i[1]=g+p*d,i[5]=u-m*d,i[9]=-n*l,i[2]=m-u*d,i[6]=p+g*d,i[10]=s*l}else if("YXZ"===t){var f=l*c,v=l*h,b=d*c,w=d*h;i[0]=f+w*n,i[4]=b*n-v,i[8]=s*d,i[1]=s*h,i[5]=s*c,i[9]=-n,i[2]=v*n-b,i[6]=w+f*n,i[10]=s*l}else if("ZXY"===t){f=l*c,v=l*h,b=d*c,w=d*h;i[0]=f-w*n,i[4]=-s*h,i[8]=b+v*n,i[1]=v+b*n,i[5]=s*c,i[9]=w-f*n,i[2]=-s*d,i[6]=n,i[10]=s*l}else if("ZYX"===t){u=s*c,g=s*h,p=n*c,m=n*h;i[0]=l*c,i[4]=p*d-g,i[8]=u*d+m,i[1]=l*h,i[5]=m*d+u,i[9]=g*d-p,i[2]=-d,i[6]=n*l,i[10]=s*l}else if("YZX"===t){var x=s*l,y=s*d,C=n*l,S=n*d;i[0]=l*c,i[4]=S-x*h,i[8]=C*h+y,i[1]=h,i[5]=s*c,i[9]=-n*c,i[2]=-d*c,i[6]=y*h+C,i[10]=x-S*h}else if("XZY"===t){x=s*l,y=s*d,C=n*l,S=n*d;i[0]=l*c,i[4]=-h,i[8]=d*c,i[1]=x*h+S,i[5]=s*c,i[9]=y*h-C,i[2]=C*h-y,i[6]=n*c,i[10]=S*h+x}return this},setRotationFromQuaternion:function(e){var t=this.elements,i=e.x,o=e.y,a=e.z,r=e.w,s=i+i,n=o+o,l=a+a,d=i*s,c=i*n,h=i*l,u=o*n,g=o*l,p=a*l,m=r*s,f=r*n,v=r*l;return t[0]=1-(u+p),t[4]=c-v,t[8]=h+f,t[1]=c+v,t[5]=1-(d+p),t[9]=g-m,t[2]=h-f,t[6]=g+m,t[10]=1-(d+u),this},lookAt:(i=new e.Vector3,o=new e.Vector3,a=new e.Vector3,function(e,t,r){var s=this.elements;return a.subVectors(e,t).normalize(),0===a.length()&&(a.z=1),i.crossVectors(r,a).normalize(),0===i.length()&&(a.x+=1e-4,i.crossVectors(r,a).normalize()),o.crossVectors(a,i),s[0]=i.x,s[4]=o.x,s[8]=a.x,s[1]=i.y,s[5]=o.y,s[9]=a.y,s[2]=i.z,s[6]=o.z,s[10]=a.z,this}),multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var i=e.elements,o=t.elements,a=this.elements,r=i[0],s=i[4],n=i[8],l=i[12],d=i[1],c=i[5],h=i[9],u=i[13],g=i[2],p=i[6],m=i[10],f=i[14],v=i[3],b=i[7],w=i[11],x=i[15],y=o[0],C=o[4],S=o[8],M=o[12],D=o[1],_=o[5],k=o[9],P=o[13],T=o[2],A=o[6],V=o[10],F=o[14],L=o[3],G=o[7],I=o[11],E=o[15];return a[0]=r*y+s*D+n*T+l*L,a[4]=r*C+s*_+n*A+l*G,a[8]=r*S+s*k+n*V+l*I,a[12]=r*M+s*P+n*F+l*E,a[1]=d*y+c*D+h*T+u*L,a[5]=d*C+c*_+h*A+u*G,a[9]=d*S+c*k+h*V+u*I,a[13]=d*M+c*P+h*F+u*E,a[2]=g*y+p*D+m*T+f*L,a[6]=g*C+p*_+m*A+f*G,a[10]=g*S+p*k+m*V+f*I,a[14]=g*M+p*P+m*F+f*E,a[3]=v*y+b*D+w*T+x*L,a[7]=v*C+b*_+w*A+x*G,a[11]=v*S+b*k+w*V+x*I,a[15]=v*M+b*P+w*F+x*E,this},multiplyToArray:function(e,t,i){var o=this.elements;return this.multiplyMatrices(e,t),i[0]=o[0],i[1]=o[1],i[2]=o[2],i[3]=o[3],i[4]=o[4],i[5]=o[5],i[6]=o[6],i[7]=o[7],i[8]=o[8],i[9]=o[9],i[10]=o[10],i[11]=o[11],i[12]=o[12],i[13]=o[13],i[14]=o[14],i[15]=o[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),e.applyProjection(this)},multiplyVector4:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:(t=new e.Vector3,function(e){for(var i=0,o=e.length;i<o;i+=3)t.x=e[i],t.y=e[i+1],t.z=e[i+2],t.applyProjection(this),e[i]=t.x,e[i+1]=t.y,e[i+2]=t.z;return e}),rotateAxis:function(e){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(t){var i=this.elements,o=new e.Vector4;return o.x=i[0]*t.x+i[4]*t.y+i[8]*t.z+i[12]*t.w,o.y=i[1]*t.x+i[5]*t.y+i[9]*t.z+i[13]*t.w,o.z=i[2]*t.x+i[6]*t.y+i[10]*t.z+i[14]*t.w,o.w=t.w?i[3]*t.x+i[7]*t.y+i[11]*t.z+i[15]*t.w:1,o},determinant:function(){var e=this.elements,t=e[0],i=e[4],o=e[8],a=e[12],r=e[1],s=e[5],n=e[9],l=e[13],d=e[2],c=e[6],h=e[10],u=e[14];return e[3]*(+a*n*c-o*l*c-a*s*h+i*l*h+o*s*u-i*n*u)+e[7]*(+t*n*u-t*l*h+a*r*h-o*r*u+o*l*d-a*n*d)+e[11]*(+t*l*c-t*s*u-a*r*c+i*r*u+a*s*d-i*l*d)+e[15]*(-o*s*d-t*n*c+t*s*h+o*r*c-i*r*h+i*n*d)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},flattenToArrayOffset:function(e,t){var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e},getPosition:function(){var t=new e.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var e=this.elements;return t.set(e[12],e[13],e[14])}}(),setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var i=this.elements,o=e.elements,a=o[0],r=o[4],s=o[8],n=o[12],l=o[1],d=o[5],c=o[9],h=o[13],u=o[2],g=o[6],p=o[10],m=o[14],f=o[3],v=o[7],b=o[11],w=o[15];i[0]=c*m*v-h*p*v+h*g*b-d*m*b-c*g*w+d*p*w,i[4]=n*p*v-s*m*v-n*g*b+r*m*b+s*g*w-r*p*w,i[8]=s*h*v-n*c*v+n*d*b-r*h*b-s*d*w+r*c*w,i[12]=n*c*g-s*h*g-n*d*p+r*h*p+s*d*m-r*c*m,i[1]=h*p*f-c*m*f-h*u*b+l*m*b+c*u*w-l*p*w,i[5]=s*m*f-n*p*f+n*u*b-a*m*b-s*u*w+a*p*w,i[9]=n*c*f-s*h*f-n*l*b+a*h*b+s*l*w-a*c*w,i[13]=s*h*u-n*c*u+n*l*p-a*h*p-s*l*m+a*c*m,i[2]=d*m*f-h*g*f+h*u*v-l*m*v-d*u*w+l*g*w,i[6]=n*g*f-r*m*f-n*u*v+a*m*v+r*u*w-a*g*w,i[10]=r*h*f-n*d*f+n*l*v-a*h*v-r*l*w+a*d*w,i[14]=n*d*u-r*h*u-n*l*g+a*h*g+r*l*m-a*d*m,i[3]=c*g*f-d*p*f-c*u*v+l*p*v+d*u*b-l*g*b,i[7]=r*p*f-s*g*f+s*u*v-a*p*v-r*u*b+a*g*b,i[11]=s*d*f-r*c*f-s*l*v+a*c*v+r*l*b-a*d*b,i[15]=r*c*u-s*d*u+s*l*g-a*c*g-r*l*p+a*d*p;var x=o[0]*i[0]+o[1]*i[4]+o[2]*i[8]+o[3]*i[12];if(0==x){var y="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(y);return console.warn(y),this.identity(),this}return this.multiplyScalar(1/x),this},extractPosition:function(e){var t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this},extractRotation:function(){var t=new e.Vector3;return function(e){var i=this.elements,o=e.elements,a=1/t.set(o[0],o[1],o[2]).length(),r=1/t.set(o[4],o[5],o[6]).length(),s=1/t.set(o[8],o[9],o[10]).length();return i[0]=o[0]*a,i[1]=o[1]*a,i[2]=o[2]*a,i[4]=o[4]*r,i[5]=o[5]*r,i[6]=o[6]*r,i[8]=o[8]*s,i[9]=o[9]*s,i[10]=o[10]*s,this}}(),translate:function(e){var t=this.elements,i=e.x,o=e.y,a=e.z;return t[12]=t[0]*i+t[4]*o+t[8]*a+t[12],t[13]=t[1]*i+t[5]*o+t[9]*a+t[13],t[14]=t[2]*i+t[6]*o+t[10]*a+t[14],t[15]=t[3]*i+t[7]*o+t[11]*a+t[15],this},rotateX:function(e){var t=this.elements,i=t[4],o=t[5],a=t[6],r=t[7],s=t[8],n=t[9],l=t[10],d=t[11],c=Math.cos(e),h=Math.sin(e);return t[4]=c*i+h*s,t[5]=c*o+h*n,t[6]=c*a+h*l,t[7]=c*r+h*d,t[8]=c*s-h*i,t[9]=c*n-h*o,t[10]=c*l-h*a,t[11]=c*d-h*r,this},rotateY:function(e){var t=this.elements,i=t[0],o=t[1],a=t[2],r=t[3],s=t[8],n=t[9],l=t[10],d=t[11],c=Math.cos(e),h=Math.sin(e);return t[0]=c*i-h*s,t[1]=c*o-h*n,t[2]=c*a-h*l,t[3]=c*r-h*d,t[8]=c*s+h*i,t[9]=c*n+h*o,t[10]=c*l+h*a,t[11]=c*d+h*r,this},rotateZ:function(e){var t=this.elements,i=t[0],o=t[1],a=t[2],r=t[3],s=t[4],n=t[5],l=t[6],d=t[7],c=Math.cos(e),h=Math.sin(e);return t[0]=c*i+h*s,t[1]=c*o+h*n,t[2]=c*a+h*l,t[3]=c*r+h*d,t[4]=c*s-h*i,t[5]=c*n-h*o,t[6]=c*l-h*a,t[7]=c*d-h*r,this},rotateByAxis:function(e,t){var i=this.elements;if(1===e.x&&0===e.y&&0===e.z)return this.rotateX(t);if(0===e.x&&1===e.y&&0===e.z)return this.rotateY(t);if(0===e.x&&0===e.y&&1===e.z)return this.rotateZ(t);var o=e.x,a=e.y,r=e.z,s=Math.sqrt(o*o+a*a+r*r),n=(o/=s)*o,l=(a/=s)*a,d=(r/=s)*r,c=Math.cos(t),h=Math.sin(t),u=1-c,g=o*a*u,p=o*r*u,m=a*r*u,f=o*h,v=a*h,b=r*h,w=n+(1-n)*c,x=g+b,y=p-v,C=g-b,S=l+(1-l)*c,M=m+f,D=p+v,_=m-f,k=d+(1-d)*c,P=i[0],T=i[1],A=i[2],V=i[3],F=i[4],L=i[5],G=i[6],I=i[7],E=i[8],U=i[9],O=i[10],N=i[11];return i[0]=w*P+x*F+y*E,i[1]=w*T+x*L+y*U,i[2]=w*A+x*G+y*O,i[3]=w*V+x*I+y*N,i[4]=C*P+S*F+M*E,i[5]=C*T+S*L+M*U,i[6]=C*A+S*G+M*O,i[7]=C*V+S*I+M*N,i[8]=D*P+_*F+k*E,i[9]=D*T+_*L+k*U,i[10]=D*A+_*G+k*O,i[11]=D*V+_*I+k*N,this},scale:function(e){var t=this.elements,i=e.x,o=e.y,a=e.z;return t[0]*=i,t[4]*=o,t[8]*=a,t[1]*=i,t[5]*=o,t[9]*=a,t[2]*=i,t[6]*=o,t[10]*=a,t[3]*=i,t[7]*=o,t[11]*=a,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],o=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(i,o)))},makeTranslation:function(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var i=Math.cos(t),o=Math.sin(t),a=1-i,r=e.x,s=e.y,n=e.z,l=a*r,d=a*s;return this.set(l*r+i,l*s-o*n,l*n+o*s,0,l*s+o*n,d*s+i,d*n-o*r,0,l*n-o*s,d*n+o*r,a*n*n+i,0,0,0,0,1),this},makeScale:function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this},makeFrustum:function(e,t,i,o,a,r){var s=this.elements,n=2*a/(t-e),l=2*a/(o-i),d=(t+e)/(t-e),c=(o+i)/(o-i),h=-(r+a)/(r-a),u=-2*r*a/(r-a);return s[0]=n,s[4]=0,s[8]=d,s[12]=0,s[1]=0,s[5]=l,s[9]=c,s[13]=0,s[2]=0,s[6]=0,s[10]=h,s[14]=u,s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this},makePerspective:function(t,i,o,a){var r=o*Math.tan(e.Math.degToRad(.5*t)),s=-r,n=s*i,l=r*i;return this.makeFrustum(n,l,s,r,o,a)},makeOrthographic:function(e,t,i,o,a,r){var s=this.elements,n=t-e,l=i-o,d=r-a,c=(t+e)/n,h=(i+o)/l,u=(r+a)/d;return s[0]=2/n,s[4]=0,s[8]=0,s[12]=-c,s[1]=0,s[5]=2/l,s[9]=0,s[13]=-h,s[2]=0,s[6]=0,s[10]=-2/d,s[14]=-u,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this},clone:function(){var t=this.elements;return new e.Matrix4d(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])}},e.extend(e.Matrix4d.prototype,{compose:(r=new e.Matrix4,s=new e.Matrix4,function(e,t,i){var o=this.elements;return r.identity(),r.setRotationFromQuaternion(t),s.makeScale(i.x,i.y,i.z),this.multiplyMatrices(r,s),o[12]=e.x,o[13]=e.y,o[14]=e.z,this}),decompose:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,a=new e.Matrix4d;return function(r,s,n){var l=this.elements;return t.set(l[0],l[1],l[2]),i.set(l[4],l[5],l[6]),o.set(l[8],l[9],l[10]),r=r instanceof e.Vector3?r:new e.Vector3,s=s instanceof e.Quaternion?s:new e.Quaternion,(n=n instanceof e.Vector3?n:new e.Vector3).x=t.length(),n.y=i.length(),n.z=o.length(),r.x=l[12],r.y=l[13],r.z=l[14],a.copy(this),a.elements[0]/=n.x,a.elements[1]/=n.x,a.elements[2]/=n.x,a.elements[4]/=n.y,a.elements[5]/=n.y,a.elements[6]/=n.y,a.elements[8]/=n.z,a.elements[9]/=n.z,a.elements[10]/=n.z,s.setFromRotationMatrix(a),[r,s,n]}}()})})),define("DS/SocialGlobe/CmdAdvanced",["UWA/Core","DS/ApplicationFrame/Command","DS/Usage/TrackerAPI"],(function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.initialTmsUrl=this.widget.widget.getValue("tilemapserver"),this.initialTmsLvl=this.widget.widget.getValue("tilemapserver-max"),this.initialExtensionName=this.widget.widget.getValue("tileextension"),this.widget.widget.getValue("tilemapserver")&&""!==this.widget.widget.getValue("tilemapserver")&&this.widget.tmsInput.setValue(this.widget.widget.getValue("tilemapserver")),this.widget.widget.getValue("tileextension")&&""!==this.widget.widget.getValue("tileextension")&&this.widget.tileextensionInput.setValue(this.widget.widget.getValue("tileextension")),this.widget.widget.getValue("tilemapserver-max")&&""!==this.widget.widget.getValue("tilemapserver-max")&&(6!=this.widget.widget.getValue("tilemapserver-max")?this.widget.tmsmaxlevelInput.setValue(this.widget.widget.getValue("tilemapserver-max")):this.widget.tmsmaxlevelInput.setValue("")),this.widget.widget.getValue("cors-exception")&&""!==this.widget.widget.getValue("cors-exception")&&this.widget.corsserverInput.setValue(this.widget.widget.getValue("cors-exception")),this.widget.widget.getValue("mapNavActive",!0)&&this.widget.mapnavButton?this.widget.mapnavButton.checkFlag=!0:this.widget.customButton&&(this.widget.customButton.checkFlag=!0),this.widget.showAdvancedPanel(!0)},execute:function(){},endExecute:function(){if(this.widget.showAdvancedPanel(!1),this.initialTmsUrl!=this.widget.widget.getValue("tilemapserver")){let e=this.widget.globe.globe.use2D?"2D":"3D";i.trackPageEvent({eventCategory:"GlobeViewer:Advanced",eventAction:"AdvancedOptionsIsClosed",eventLabel:"TmsUrl",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:e,pd2:this.widget.widget.getValue("tilemapserver")},scope:"Dashboard"})}if(this.initialTmsLvl!=this.widget.widget.getValue("tilemapserver-max")){let e=this.widget.globe.globe.use2D?"2D":"3D";i.trackPageEvent({eventCategory:"GlobeViewer:Advanced",eventAction:"AdvancedOptionsIsClosed",eventLabel:"TmsLvl",eventValue:parseInt(this.widget.widget.getValue("tilemapserver-max")),appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:e},scope:"Dashboard"})}if(this.initialExtensionName!=this.widget.widget.getValue("tileextension")){let e=this.widget.globe.globe.use2D?"2D":"3D";i.trackPageEvent({eventCategory:"GlobeViewer:Advanced",eventAction:"AdvancedOptionsIsClosed",eventLabel:"ExtensionName",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:e,pd2:this.widget.widget.getValue("tileextension")},scope:"Dashboard"})}}});return e.namespace("SocialGlobe/CmdAdvanced",o)})),define("DS/SocialGlobe/Renderer",["UWA/Class"],(function(e){"use strict";return e.extend({init:function(e){this.renderContext=e},switchToProjection:function(e){},setSwitchProjectionModeCB:function(e){}})})),define("DS/SocialGlobe/RenderPassManager",["UWA/Class","DS/CoreEvents/Events","DS/Plugins/ClearPass"],(function(e,t,i){"use strict";return e.extend({init:function(e){this._passes={},this._passesID=[],this._mainComposer=e;var t="ClearDepthPass",o=new i(t);o.defaults.clear=!1,o.defaults.doClearDepth=!0,this.addPass(t,o,{post:!0})},addPass:function(e,i,o,a){if(void 0!==i)if(void 0===this._passes[e]){var r;if(void 0!==o)if(void 0!==o.before){if(void 0===(r=this.getPass(o.before))||void 0!==a&&a!==o.before)return void t.subscribeOnce({event:"/RenderPassManager/onNewPassAdded"},this.addPass.bind(this,e,i,o));this._mainComposer.insertCustomPassBefore(i,r)}else if(void 0!==o.after){if(void 0===(r=this.getPass(o.after))||void 0!==a&&a!==o.after)return void t.subscribeOnce({event:"/RenderPassManager/onNewPassAdded"},this.addPass.bind(this,e,i,o));this._mainComposer.insertCustomPassAfterPass(i,r)}else o.pre?this._mainComposer.insertCustomPassBefore(i):this._mainComposer.insertCustomPassAfterPass(i);else this._mainComposer.insertCustomPassAfterPass(i);this._mainComposer.updateComposerContexts(),this._passesID.push(e),this._passes[e]=i,t.publish({event:"/RenderPassManager/onNewPassAdded",data:e})}else console.warn("A pass with ID '"+e+"' is already defined");else console.warn("Undefined pass: '"+e+"'")},enablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,o=this._mainComposer.contexts.length;for(i=0;i<o;++i)this._mainComposer.contexts[i].enablePass(t,!0)}},disablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,o=this._mainComposer.contexts.length;for(i=0;i<o;++i)this._mainComposer.contexts[i].enablePass(t,!1)}},getPass:function(e){return this._passes[e]},getPassList:function(){return this._passesID}})})),define("DS/SocialGlobe/CmdDisplayHelp",["UWA/Core","DS/ApplicationFrame/Command"],(function(e,t){"use strict";var i=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.globe=this.getFrameWindow().globe},execute:function(){window.open("http://apps.uwglobe.com/Docs/GlobeViewer/index.html","_blank"),this.end()},endExecute:function(){}});return UWA.namespace("SocialGlobe/CmdDisplayHelp",i)})),define("DS/SocialGlobe/CmdTheme",["UWA/Core","DS/ApplicationFrame/Command","DS/Usage/TrackerAPI"],(function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.widget.showThemePanel(!0),this.initialGlobeSkin=this.widget.widget.getValue("theme"),this.initialBackGround=this.widget.widget.getValue("backcolor"),"satellite"===this.widget.widget.getValue("theme")?this.widget.satelliteThemeButton.checkFlag=!0:"minimal"===this.widget.widget.getValue("theme")?this.widget.minimalThemeButton.checkFlag=!0:this.widget.naturalThemeButton.checkFlag=!0,""!==this.widget.widget.getValue("backcolor")&&(this.widget.themecolorPicker.value=this.widget.widget.getValue("backcolor").replace("#",""),this.widget.backgroundcolorButton.checkFlag=!0)},execute:function(){},endExecute:function(){this.widget.widget.getValue("theme");if(this.widget.showThemePanel(!1),this.initialGlobeSkin!=this.widget.widget.getValue("theme")&&i.trackPageEvent({eventCategory:"GlobeViewer:Theme",eventAction:"ThemeOptionsIsClosed",eventLabel:"GlobeSkinSelection",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:"3D",pd2:this.widget.widget.getValue("theme")},scope:"Dashboard"}),this.initialBackGround!=this.widget.widget.getValue("backcolor")){let e=""==this.widget.widget.getValue("backcolor")?-1:1;i.trackPageEvent({eventCategory:"GlobeViewer:Theme",eventAction:"ThemeOptionsIsClosed",eventLabel:"BackgroundColor",eventValue:e,appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:"3D"},scope:"Dashboard"})}}});return e.namespace("SocialGlobe/CmdTheme",o)})),define("DS/SocialGlobe/PolylineMaker",["UWA/Class"],(function(e){"use strict";return e.extend({init:function(e){this.scene=e}})})),define("DS/SocialGlobe/TerminatorLineManager",["UWA/Class","SocialGlobe/assets/leaflet/leaflet","css!SocialGlobe/assets/leaflet/leaflet.css","SocialGlobe/assets/leaflet/leaflet-markercluster","css!SocialGlobe/MarkerCluster.css"],(function(e){"use strict";return e.extend({init:function(e){this.globe=e,this.map=e.map,this.R2D=180/Math.PI,this.D2R=Math.PI/180,this.terminatorLineLayer},showLine:function(){this.terminatorLineLayer.addTo(this.map)},hideLine:function(){void 0!==this.terminatorLineLayer&&this.map.removeLayer(this.terminatorLineLayer)},setDate:function(e){this.date=e,this.actualUTC=(new Date).getHours()-(new Date).getUTCHours()},sunDecli:function(e){return-23.44*Math.cos(360/365*(e+10)*this.D2R)},hourAngle:function(e){return 180*(e/12-1)},sunAlt:function(e,t,i){return Math.asin(Math.sin(e*this.D2R)*Math.sin(t*this.D2R)+Math.cos(e*this.D2R)*Math.cos(t*this.D2R)*Math.cos(i*this.D2R))*this.R2D},realHour:function(e,t){let i=0;if(t<0)for(;t<0;)t+=.5,i-=.033;else for(;t>.5;)t-=.5,i+=.033;var o=e+i;return o<0?o+=24:o>24&&(o-=24),o},date2NumberOfDay:function(e){var t=[31,28,31,30,31,30,31,31,30,31,30,31],i=0;for(let o=0;o<e.getMonth();o+=1)i+=t[o];return i+=e.getDate()},terminatorLineCreation:function(){var e=new L.LayerGroup;void 0===this.date&&this.setDate(new Date);var t=this.date2NumberOfDay(this.date),i=this.date.getMinutes()/60+this.date.getHours()-this.actualUTC,o=[],a=[],r=[],s=[],n=[];for(let e=-180;e<=180;e+=.5)for(let u=-90;u<=90;u+=.5){var l=this.realHour(i,e),d=this.sunDecli(t),c=this.hourAngle(l),h=this.sunAlt(d,u,c);h<.1&&h>-.1&&o.push([u,e]),-180==e&&h<0?a.push([u,e]):180==e&&h<0?r.push([u,e]):90==u&&h<0?s.push([u,e]):-90==u&&h<0&&n.push([u,e])}for(let e=0;e<3;e+=1)for(let e=0;e<o.length-1;e+=1)o[e][0]=(o[e][0]+o[e+1][0])/2,o[e][0]=(o[e][1]+o[e+1][1])/2,o.splice(e,1);var u=[];for(let e=0;e<o.length-1;e+=1){var g=[],p=[];g.push(3/4*o[e][0]+1/4*o[e+1][0]),p.push(1/4*o[e][0]+3/4*o[e+1][0]),g.push(3/4*o[e][1]+1/4*o[e+1][1]),p.push(1/4*o[e][1]+3/4*o[e+1][1]),u.push(g),u.push(p)}o=u;var m=[];0==n.length?m=(m=(m=(m=m.concat(a.reverse())).concat(o)).concat(r)).concat(s.reverse()):0==s.length&&(m=(m=(m=(m=m.concat(a)).concat(o)).concat(r.reverse())).concat(n.reverse())),L.polygon(m,{color:"",fillColor:"#253C6C",fillOpacity:.5,notSave:!0}).addTo(e),this.terminatorLineLayer=e,this.terminatorLineLayer.options.notSave=!0}})})),define("DS/SocialGlobe/ShaderTools",["UWA/Class","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";var i=e.singleton({init:function(){this.animationMaterials={},this.sslrHacked=!1},initialize:function(e){void 0!==e&&e.webglViewer&&(this._GLMaxTextureUnits=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_TEXTURE_IMAGE_UNITS),this._GLStandardDerivatives=void 0!==e.webglViewer.getRenderer().supportsStandardDerivatives(),this._usePhysical=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_VERTEX_UNIFORM_VECTORS)>128&&e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_FRAGMENT_UNIFORM_VECTORS)>128)},enableAnimations:function(e){this._noAnimation=!e},disableAnimations:function(){this.enableAnimations(!1)},updateSingleUniform:function(e,t,i){e.isPDSFX()?e.updatePDSFXUniform(t,i):e.uniforms&&e.uniforms[t]&&(e.uniforms[t].value=i)},parsePDSFXShader:function(e,i){if(e instanceof Array)for(var o=0;o<e.length;++o)this.parsePDSFXShader(e[o],i);if(e.depends){var a,r=e.depends.length;for(o=0;o<r;++o)a=e.depends[o],this.parsePDSFXShader(a,i)}if(-1===i.shaderList.indexOf(e.name)||void 0===e.name){for(var s in i.shaderList.push(e.name),e.attributes)i.attributes[s]=e.attributes[s];var n=t.UniformsUtils.clone(e.uniforms);for(var s in n)i.uniforms[s]=n[s];for(var s in e.varyings)i.varyings[s]=e.varyings[s];for(var s in e.VS_global_code&&i.VS_global_code.push(e.VS_global_code),e.FS_global_code&&i.FS_global_code.push(e.FS_global_code),e.VS_overridableFunctions)i.VS_overridableFunctions[s]?i.VS_overridableFunctions[s]+="\n"+e.VS_overridableFunctions[s]:i.VS_overridableFunctions[s]=e.VS_overridableFunctions[s];for(var s in e.FS_overridableFunctions)i.FS_overridableFunctions[s]?i.FS_overridableFunctions[s]+="\n"+e.FS_overridableFunctions[s]:i.FS_overridableFunctions[s]=e.FS_overridableFunctions[s]}},getPDSFXMaterial:function(e,i,o){var a;(a="physical"===i?new t.PhysicalMaterial({force:!0}):"specGloss"===i?new t.PhysicalMaterial({force:!0,specGloss:!0}):"line"===i?new t.LineBasicMaterial({force:!0,lineWidth:10}):"phong"===i?new t.MeshPhongMaterial({force:!0}):"basic"===i?new t.MeshBasicMaterial({force:!0}):new t.PhysicalMaterial({force:!0})).metalness=0,a.roughness=1,a.textureBlending=t.TextureBlendOperations.MODULATE,a.activatePDSFX();var r={ComputeCommonValues:"void ComputeCommonValues() {",ComputeObjectPosition:"vec3 ComputeObjectPosition() {",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() {",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition() {",ComputeObjectNormal:"vec3 ComputeObjectNormal() {",ComputeObjectTexCoord0:"vec4 ComputeObjectTexCoord0() {",ComputeObjectTexCoord1:"vec4 ComputeObjectTexCoord1() {",ComputeObjectTexCoord2:"vec4 ComputeObjectTexCoord2() {",ComputeObjectTangent:"vec3 ComputeObjectTangent() {",ComputeObjectBinormal:"vec3 ComputeObjectBinormal() {",ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {",ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) {",ComputePointSize:"float ComputePointSize()",ComputeVaryingValues:"void ComputeVaryingValues() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLineDistance:"void ProcessLineDistance(inout vec2 lineDistance) {"},s={ComputeCommonValues:"}",ComputeObjectPosition:"}",ComputeObjectFollowingPosition:"}",ComputeObjectPreviousPosition:"}",ComputeObjectNormal:"}",ComputeObjectTexCoord0:"}",ComputeObjectTexCoord1:"}",ComputeObjectTexCoord2:"}",ComputeObjectTangent:"}",ComputeObjectBinormal:"}",ProcessViewTangentSpace:"}",ProcessClipSpacePosition:"}",ComputePointSize:"}",ComputeVaryingValues:"}",ComputeHalfWidth:"}"},n={ComputeCommonValues:"void ComputeCommonValues() {",ComputeDiscard:"bool ComputeDiscard() {",ComputeAlbedo:"vec3 ComputeAlbedo() {",_ComputeDiffuseTexel:"vec4 _ComputeDiffuseTexel() {",ComputeViewPosition:"vec3 ComputeViewPosition() {",ComputeViewNormal:"vec3 ComputeViewNormal() {",ComputeSpecularReflectance:"vec3 ComputeSpecularReflectance() {",ComputeRoughness:"float ComputeRoughness() {",ComputeTransparency:"float ComputeTransparency() {",ComputeEmissive:"vec3 ComputeEmissive() {",ComputeOpacity:"float ComputeOpacity() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLinePattern:"void ProcessLinePattern(inout float patternValue, in float currentPixelDistance) {",ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) {"},l={ComputeCommonValues:"}",ComputeDiscard:"}",ComputeAlbedo:"return cAlbedo;}",_ComputeDiffuseTexel:"}",ComputeViewPosition:"}",ComputeViewNormal:"}",ComputeSpecularReflectance:"}",ComputeRoughness:"}",ComputeTransparency:"}",ComputeEmissive:"}",ComputeOpacity:"return cOpacity;}",ComputeHalfWidth:"}",ProcessLinePattern:"}",ProcessFinalColor:"}"},d={attributes:{},uniforms:{},varyings:{},VS_global_code:[],FS_global_code:["vec3 cAlbedo = vec3(1.0);","float cOpacity = 1.0;"],VS_overridableFunctions:{},FS_overridableFunctions:{},shaderList:[]};for(var c in this.parsePDSFXShader(e,d),d.VS_global_code=d.VS_global_code.join("\n"),d.FS_global_code=d.FS_global_code.join("\n"),d.VS_overridableFunctions)d.VS_overridableFunctions[c]=r[c]+d.VS_overridableFunctions[c]+s[c];for(var c in d.FS_overridableFunctions)d.FS_overridableFunctions[c]=n[c]+d.FS_overridableFunctions[c]+l[c];for(var c in d.uniforms&&a.setPDSFXUniforms(d.uniforms),d.varyings&&a.setPDSFXVaryings(d.varyings),(d.VS_global_code||d.FS_global_code)&&a.setPDSFXGlobalShaderCode(d.VS_global_code,d.FS_global_code),(d.VS_overridableFunctions||d.FS_overridableFunctions)&&a.setPDSFXOverridableFunctions(d.VS_overridableFunctions,d.FS_overridableFunctions),d.attributes)a[c]=d.attributes[c];var h=[];if(a._PDSFXData.pdsfxUniforms)for(var u,g=Object.keys(a._PDSFXData.pdsfxUniforms),p=g.length,m=0;m<p;m++)u=g[m],void 0!==a._PDSFXData.pdsfxUniforms[u].animation&&h.push({uniform:u,animation:a._PDSFXData.pdsfxUniforms[u].animation});if(h.length>0){for(m=0;m<h.length;++m){var f=h[m];this.registerAnimationUniforms(a,f.uniform,f.animation)}a.cloneWithAnim=function(e){for(var t=a.clone(),i=0;i<h.length;++i){var o=h[i];this.registerAnimationUniforms(t,o.uniform,o.animation)}return t}.bind(this,a)}return a.clone=function(){return this.__proto__.clone.bind(a)()},a},setPDSFXMaterial:function(e,i,o,a){if(!e)return null;e.isPDSFX&&e.isPDSFX()||e.activatePDSFX();var r={ComputeCommonValues:"void ComputeCommonValues() {",ComputeObjectPosition:"vec3 ComputeObjectPosition() {",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() {",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition() {",ComputeObjectNormal:"vec3 ComputeObjectNormal() {",ComputeObjectTexCoord0:"vec4 ComputeObjectTexCoord0() {",ComputeObjectTexCoord1:"vec4 ComputeObjectTexCoord1() {",ComputeObjectTexCoord2:"vec4 ComputeObjectTexCoord2() {",ComputeObjectTangent:"vec3 ComputeObjectTangent() {",ComputeObjectBinormal:"vec3 ComputeObjectBinormal() {",ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {",ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) {",ComputePointSize:"float ComputePointSize()",ComputeVaryingValues:"void ComputeVaryingValues() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLineDistance:"void ProcessLineDistance(inout vec2 lineDistance) {"},s={ComputeCommonValues:"}",ComputeObjectPosition:"}",ComputeObjectFollowingPosition:"}",ComputeObjectPreviousPosition:"}",ComputeObjectNormal:"}",ComputeObjectTexCoord0:"}",ComputeObjectTexCoord1:"}",ComputeObjectTexCoord2:"}",ComputeObjectTangent:"}",ComputeObjectBinormal:"}",ProcessViewTangentSpace:"}",ProcessClipSpacePosition:"}",ComputePointSize:"}",ComputeVaryingValues:"}",ComputeHalfWidth:"}"},n={ComputeCommonValues:"void ComputeCommonValues() {",ComputeDiscard:"bool ComputeDiscard() {",ComputeAlbedo:"vec3 ComputeAlbedo() {",_ComputeDiffuseTexel:"vec4 _ComputeDiffuseTexel() {",ComputeViewPosition:"vec3 ComputeViewPosition() {",ComputeViewNormal:"vec3 ComputeViewNormal() {",ComputeSpecularReflectance:"vec3 ComputeSpecularReflectance() {",ComputeRoughness:"float ComputeRoughness() {",ComputeTransparency:"float ComputeTransparency() {",ComputeEmissive:"vec3 ComputeEmissive() {",ComputeOpacity:"float ComputeOpacity() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLinePattern:"void ProcessLinePattern(inout float patternValue, in float currentPixelDistance) {",ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) {"},l={ComputeCommonValues:"}",ComputeDiscard:"}",ComputeAlbedo:"return cAlbedo;}",_ComputeDiffuseTexel:"}",ComputeViewPosition:"}",ComputeViewNormal:"}",ComputeSpecularReflectance:"}",ComputeRoughness:"}",ComputeTransparency:"}",ComputeEmissive:"}",ComputeOpacity:"return cOpacity;}",ComputeHalfWidth:"}",ProcessLinePattern:"}",ProcessFinalColor:"}"},d={attributes:{},uniforms:{},varyings:{},VS_global_code:[],FS_global_code:["vec3 cAlbedo = vec3(1.0);","float cOpacity = 1.0;"],VS_overridableFunctions:{},FS_overridableFunctions:{},shaderList:[]};for(var c in this.parsePDSFXShader(i,d),d.VS_global_code=d.VS_global_code.join("\n"),d.FS_global_code=d.FS_global_code.join("\n"),d.VS_overridableFunctions)d.VS_overridableFunctions[c]=r[c]+d.VS_overridableFunctions[c]+s[c];for(var c in d.FS_overridableFunctions)d.FS_overridableFunctions[c]=n[c]+d.FS_overridableFunctions[c]+l[c];if(d.uniforms){var h={},u=["mapCity","useMapCity","mapCityLoaded","diffuseCity","alphaTestCity","opacityCity"];for(var g in d.uniforms)null===e.getPDSFXUniform(g)&&(h[g]=d.uniforms[g]);for(g=0;g<u.length;++g)null!==e.getPDSFXUniform(u[g])&&(h[u[g]]=e._PDSFXData.pdsfxUniforms[u[g]]);e._PDSFXData.pdsfxUniforms=null,e._PDSFXData.pdsfxUniformsCode={common:"",vertex:"",fragment:""},e.setPDSFXUniforms(h)}for(var c in d.varyings&&e.setPDSFXVaryings(d.varyings),(d.VS_global_code||d.FS_global_code)&&e.setPDSFXGlobalShaderCode(d.VS_global_code,d.FS_global_code),(d.VS_overridableFunctions||d.FS_overridableFunctions)&&e.setPDSFXOverridableFunctions(d.VS_overridableFunctions,d.FS_overridableFunctions),d.attributes)e[c]=d.attributes[c];e.metalness=0,e.roughness=1,e.textureBlending=t.TextureBlendOperations.MODULATE;var p=[];if(e._PDSFXData.pdsfxUniforms)for(var m,f=Object.keys(e._PDSFXData.pdsfxUniforms),v=f.length,b=0;b<v;b++)m=f[b],void 0!==e._PDSFXData.pdsfxUniforms[m].animation&&p.push({uniform:m,animation:e._PDSFXData.pdsfxUniforms[m].animation});if(p.length>0){for(b=0;b<p.length;++b){var w=p[b];this.registerAnimationUniforms(e,w.uniform,w.animation)}e.cloneWithAnim=function(t){var i=e.clone();i.reflectionCoef=t.reflectionCoef;for(var o=0;o<p.length;++o){var a=p[o];this.registerAnimationUniforms(i,a.uniform,a.animation)}return i}.bind(this,e)}return e.clone=function(){return this.__proto__.clone.bind(e)()},e}});i.ColorParams=["color","specular","ambient","oceanColor","oceanColorDetection","diffuse"],i.BoolParams=["forceSide","transparent","wireframe","depthTest","depthWrite","enableClipPlanes","generateMipmaps","dynamicUpdate","showOcean"],i.FloatParams=["opacity","alphaTest","reflectivity","refractionRatio","reflectionCoef","opacityFactor","minOpacity","oceanAlpha","oceanRangeDetection"],i.IntParams=["shininess","wireframeLinewidth","r_mode","minWidth","minDist","maxDist","lineWidth"],i.TexParams=["map","wallTextures","roofTextures","envMap","lightMap","normalMap","specularMap","oceanTexture","roadTexture"],i.StringParams=["extrusionHeight"],i.WrapParams=["wrapS","wrapT"],i.FilterParams=["minFilter","magFilter"],i.PdsfxParams=[["map","mapCity"],["diffuse","diffuseCity"],["ambient","ambientCity"],["specular","specularCity"],["opacity","opacityCity"],["alphaTestCity","alphaTestCity"],["dashPattern","dashPatternCity"]],i.commonParams=i.BoolParams.concat(i.FloatParams,i.IntParams,i.FilterParams,i.WrapParams,"blending","side"),i.whiteMap=new t.DataTexture(new Float32Array([1,1,1,1]),1,1,t.RGBAFormat,t.FloatType),i.whiteMap.name="DefaultWhiteTexture",i.whiteMap.flipY=!1,i.whiteMap.minFilter=t.NearestFilter,i.whiteMap.magFilter=t.NearestFilter,i.whiteMap.generateMipmaps=!1,i.whiteMap.needsUpdate=!0,i.whiteMap.shared=1,i.whiteMap.loadEndStatus="complete",i.common={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,t.ShaderChunk.defaultnormal_vertex,"vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * objectNormal;","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(objectNormal, 0.0)));"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), opacity );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")},i.commonWithoutOpacity={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,t.ShaderChunk.defaultnormal_vertex,"vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * objectNormal;","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(objectNormal, 0.0)));"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), 1.0 );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")},i.commonNoNormal={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,"vec3 mvNormal = vec3(0.0,0.0,1.0);"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), opacity );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")};var o={};return o.lines_vertex=["#ifdef USE_DASHEDLINE","   float worldToPixel = abs(projectionMatrix[0][0]/gl_Position.w)*0.5/pixelSize.x;","   vLineDistance = scale * modelMatrix[0][0] * lineDistance * worldToPixel;","#endif","#ifdef USE_WIDELINE","   mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));","   vec4 mvPositionPrec = viewMatrix * (modelMatrix * vec4(previousPos.xyz, 1.0));","   vec4 mvPositionSuiv = viewMatrix * (modelMatrix * vec4(followingPos.xyz, 1.0));","   vec4 pmvPosition = projectionMatrix * mvPosition;","   vec4 pmvPositionPrec = projectionMatrix * mvPositionPrec;","   vec4 pmvPositionSuiv = projectionMatrix * mvPositionSuiv;","","   vec3 eps = vec3(0.0000001);","   bool bPrecCurr = !all(lessThan(abs(pmvPosition.xyz - pmvPositionPrec.xyz), eps));","   bool bCurrNext = !all(lessThan(abs(pmvPositionSuiv.xyz - pmvPosition.xyz), eps));","","   vec3 testClip = vec3(sign(pmvPositionPrec.w + pmvPositionPrec.z), sign(pmvPosition.w + pmvPosition.z), sign(pmvPositionSuiv.w + pmvPositionSuiv.z));","   if (bPrecCurr && testClip.x * testClip.y < 0.0 ){","       float a = (pmvPositionPrec.w + pmvPositionPrec.z)/((pmvPositionPrec.w + pmvPositionPrec.z) - (pmvPosition.w + pmvPosition.z));","       if (testClip.x < 0.0) {","           pmvPositionPrec = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","       } else if (mod(sideExtrusion,2.0) == 1.0) {","           pmvPosition = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","           pmvPositionSuiv = pmvPosition;","           bCurrNext = false;","       }","   }","   if (bCurrNext && testClip.y * testClip.z < 0.0 ){","       float a = (pmvPosition.w + pmvPosition.z)/((pmvPosition.w + pmvPosition.z) - (pmvPositionSuiv.w + pmvPositionSuiv.z));","       if (testClip.z < 0.0) {","           pmvPositionSuiv = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","       } else if (mod(sideExtrusion,2.0) == 0.0){","           pmvPosition = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","           pmvPositionPrec = pmvPosition;","           bPrecCurr = false;","       }","   }","","   pmvPosition.y *= pixelSize.x/pixelSize.y;","   pmvPositionPrec.y *= pixelSize.x/pixelSize.y;","   pmvPositionSuiv.y *= pixelSize.x/pixelSize.y;","   pmvPosition /= abs(pmvPosition.w);","   pmvPositionPrec /= abs(pmvPositionPrec.w);","   pmvPositionSuiv /= abs(pmvPositionSuiv.w);","","   float offset = l_fHalfWidth  * pixelSize.x;","   vec2 pos, posPrecCurr, posCurrNext;","   vec2 dirPrecCurr, dirCurrNext;","","   if (bPrecCurr){","       dirPrecCurr = pmvPosition.xy - pmvPositionPrec.xy;","       dirPrecCurr = normalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * sign(sideExtrusion) * vec2(-dirPrecCurr.y, dirPrecCurr.x);","   } else if (bCurrNext) {","       dirPrecCurr = pmvPosition.xy - pmvPositionSuiv.xy;","       dirPrecCurr = normalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * dirPrecCurr.xy;","   }","","   if (bCurrNext){ //avoid null vector problems","       dirCurrNext = pmvPositionSuiv.xy - pmvPosition.xy;","       dirCurrNext = normalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * sign(sideExtrusion) * vec2(-dirCurrNext.y, dirCurrNext.x);","   } else if (bPrecCurr) {","       dirCurrNext = pmvPosition.xy - pmvPositionPrec.xy;","       dirCurrNext = normalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * dirCurrNext.xy;","   }","","   vec2 dir = normalize(dirCurrNext.xy - dirPrecCurr.xy);","   if ( bPrecCurr && bCurrNext){","       if (abs(dirCurrNext.x - dirPrecCurr.x) < 0.01 && abs(dirCurrNext.y - dirPrecCurr.y) < 0.01){","           dir = vec2(-dirCurrNext.y, dirCurrNext.x);","       }","       float sinAlpha = dir.y * dirPrecCurr.x - dir.x * dirPrecCurr.y;","       if (sign(sinAlpha) == -sign(sideExtrusion) && asin(abs(sinAlpha)) < radians(45.0)) {","           if (mod(sideExtrusion,2.0) == 0.0){","               pos = posCurrNext - offset * dirCurrNext;","           } else {","               pos = posPrecCurr + offset * dirPrecCurr;","           }","       } else {","           float distPoints = min(distance(pmvPosition.xy, pmvPositionPrec.xy), distance(pmvPosition.xy, pmvPositionSuiv.xy)) + offset;","           float dist = offset/ sinAlpha;","           if (max(distPoints, offset) < abs(dist)){","               dist = max(distPoints - offset, offset)*sign(sinAlpha);","               if (sign(sinAlpha) == sign(sideExtrusion)&& asin(abs(sinAlpha)) < radians(45.0/2.0)){","                   if (mod(sideExtrusion,2.0) == 0.0){","                       pos = posCurrNext + dist * dirCurrNext*sign(sideExtrusion);","                   } else {","                       pos = posPrecCurr - dist * dirPrecCurr *sign(sideExtrusion);","                   }","               } else {","                   pos = pmvPosition.xy + dir * max(distPoints, offset) *sign(sinAlpha) *sign(sideExtrusion);","               }","           } else {","               pos = pmvPosition.xy + dir * dist *sign(sideExtrusion);","           }","       }","   } else if(bPrecCurr || bCurrNext) {","       pos = (posCurrNext - pmvPosition.xy)  + posPrecCurr;","   } else {","       pos = pmvPosition.xy + offset;","   }","   #ifdef USE_DASHEDLINE","       vPointAlt = pmvPosition.xy /pixelSize;","       if (sideExtrusion == -2.0){","           vVertexId = vec4(1.0, 1.0, 1.0, 0.0);","       } else if (sideExtrusion == 2.0){","           vVertexId = vec4(0.0, 1.0, 1.0, 1.0);","       } else if (sideExtrusion == -1.0){","           vVertexId = vec4(1.0, 0.0, 1.0, 1.0);","       } else if (sideExtrusion == 1.0){","           vVertexId = vec4(1.0, 1.0, 0.0, 1.0);","       }","       vec4 mvpPositionPrec = projectionMatrix * mvPositionPrec; ","       vec4 mvpPosition = projectionMatrix * mvPosition;","       vec4 mvpPositionSuiv = projectionMatrix * mvPositionSuiv;","       worldToPixel =  modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPosition.w)*0.5/pixelSize.x;","       float worldToPixelPrec = modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPositionPrec.w)*0.5/pixelSize.x;","       float worldToPixelSuiv = modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPositionSuiv.w)*0.5/pixelSize.x;","       if (abs(sideExtrusion) == 1.0 && bPrecCurr){","           vLineDistanceAlt = vLineDistance.y;","           vPointPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","           vPointCurr = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","           vLineDistance.x = scale * lineDistance.x * worldToPixelPrec;","           vLineDistance.y = scale * lineDistance.y * worldToPixel;","       } else if (abs(sideExtrusion) == 2.0 && bCurrNext) {","           vLineDistanceAlt = vLineDistance.x;","           vPointPrec = (mvpPosition.xy / mvpPosition.w  + 1.0)/ pixelSize;","           vPointCurr = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","           vLineDistance.x = scale * lineDistance.x * worldToPixel;","           vLineDistance.y = scale * lineDistance.y * worldToPixelSuiv;","       }","   #endif","","   gl_Position = vec4(pos.x, pos.y* pixelSize.y/pixelSize.x, pmvPosition.zw);","#endif"].join("\n"),i.line={attributes:{blending:t.NormalBlending,transparent:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lines,{l_uInfoTexture:{type:"t",value:void 0},l_uUseOpacityFactor:{type:"f",value:0}}]),vertex_pars:[t.ShaderChunk.lines_pars_vertex,"uniform sampler2D l_uInfoTexture;","uniform float l_uUseOpacityFactor;","varying vec4 l_vColor;","varying float l_fHalfWidth;","varying float l_vOpacity;","varying float l_vOpacityFactor;","varying float v_index;","varying float v_nbLine;","varying float l_vPercent;","vec4 getColor(sampler2D texture, float nbColumn, float nbLines, float indice){","vec4 color = vec4(0,0,0,1);","color.r = texture2D( texture, vec2( 0.5/nbColumn, indice/nbLines ) ).x;","color.g = texture2D( texture, vec2( 1.5/nbColumn, indice/nbLines ) ).x;","color.b = texture2D( texture, vec2( 2.5/nbColumn, indice/nbLines ) ).x;","return color;","}"].join("\n"),vertex:[" float l_fpixPerRow = texture2D( l_uInfoTexture, vec2( 0.0, 0.0 ) ).x;"," float l_fnbLines = texture2D( l_uInfoTexture, vec2( 1.5/l_fpixPerRow, 0.0 ) ).x + 1.0;"," float l_fscale = texture2D( l_uInfoTexture, vec2( 2.5/l_fpixPerRow, 0.0 ) ).x;"," float l_findice = (color.r + 1.5);","v_index = l_findice;","v_nbLine = l_fnbLines;"," l_vColor = getColor(l_uInfoTexture, l_fpixPerRow, l_fnbLines, l_findice);"," l_fHalfWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x / 2.0;"," l_vOpacity = texture2D( l_uInfoTexture, vec2( 4.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;"," l_vOpacityFactor = texture2D( l_uInfoTexture, vec2( 5.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;"," float minDist = texture2D( l_uInfoTexture, vec2( 15.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float maxDist = texture2D( l_uInfoTexture, vec2( 16.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float lineWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float minWidth = texture2D( l_uInfoTexture, vec2( 17.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));"," float dist = length(mvPosition);"," if ( dist < minDist ) { dist = minDist; }"," else if ( dist > maxDist ) { dist = maxDist; }"," float altitudeFactor = (1.0 - min(1.0, (dist - minDist) / (maxDist - minDist)));"," //l_fHalfWidth = floor(lineWidth * altitudeFactor + minWidth * (1.0-altitudeFactor)) / 2.0;",o.lines_vertex," l_vPercent = color.w;"].join("\n"),fragment_pars:[" uniform vec3 diffuse;"," uniform float l_uUseOpacityFactor;"," varying vec4 l_vColor;"," varying float l_vOpacity;"," varying float l_vOpacityFactor;","varying float v_index;","varying float v_nbLine;"," varying float l_vPercent;"].join("\n"),fragment:[t.ShaderChunk.lines_fragment," float l_fmatImgOpacity;"," if(l_uUseOpacityFactor > 0.5){","l_fmatImgOpacity = opacity * l_vOpacity * l_vOpacityFactor;"," }else{","l_fmatImgOpacity = opacity * l_vOpacity;"," }"," gl_FragColor.a = l_fmatImgOpacity;"," #ifdef GAMMA_INPUT","   gl_FragColor.rgb *= l_vColor.rgb * l_vColor.rgb;"," #else","   gl_FragColor.rgb = l_vColor.rgb;"," #endif"].join("\n")},i.clipPlanes={attributes:{},uniforms:t.UniformsLib.clipPlanes,vertex_pars:t.ShaderChunk.clip_pars_vertex,vertex:t.ShaderChunk.clip_vertex,fragment_pars:t.ShaderChunk.clip_pars_fragment,fragment:t.ShaderChunk.clip_fragment},i.alphaTest={attributes:{alphaTest:.5,transparent:!0},uniforms:{alphaTest:{type:"f",value:.5}},vertex_pars:"",vertex:"",fragment_pars:"",fragment:[t.ShaderChunk.alphatest_fragment,"gl_FragColor.a = (opacity);"].join("\n")},i.vertexInformation={uniforms:{},vertex_pars:["varying vec4 vertex_position;","varying vec4 vertex_wPosition;","varying vec4 vertex_vPosition;","varying vec4 vertex_normal;","varying vec4 vertex_wNormal;","varying vec4 vertex_vNormal;","varying vec4 vertex_viewdir;","varying vec4 vertex_vViewdir;","varying float vertex_camDist;"].join("\n"),vertex:["vertex_position = vec4(position, 1.0);","vertex_wPosition = modelMatrix * vertex_position;","vertex_vPosition = viewMatrix * vertex_wPosition;","vertex_normal = normalize(vec4(objectNormal, 0.0));","vertex_wNormal = normalize(modelMatrix * vertex_normal);","if (use_normal_matrix) {","vertex_vNormal = vec4(normalize(normalMatrix * vertex_normal.xyz), 0.0);","} else {","vertex_vNormal = normalize(viewMatrix * vertex_wNormal);","}","vertex_viewdir = vec4(cameraPosition - vertex_wPosition.xyz, 0.0);","vertex_vViewdir = -vertex_vPosition;","vertex_camDist = length(vertex_viewdir);"].join("\n"),fragment_pars:["varying vec4 vertex_position;","varying vec4 vertex_wPosition;","varying vec4 vertex_vPosition;","varying vec4 vertex_normal;","varying vec4 vertex_wNormal;","varying vec4 vertex_vNormal;","varying vec4 vertex_viewdir;","varying vec4 vertex_vViewdir;","varying float vertex_camDist;"].join("\n"),fragment:""},i.vertexColor={attributes:{vertexColors:!0},uniforms:{},vertex_pars:t.ShaderChunk.color_pars_vertex,vertex:t.ShaderChunk.color_vertex,fragment_pars:t.ShaderChunk.color_pars_fragment,fragment:t.ShaderChunk.color_fragment},i.map={attributes:{},uniforms:{map:{type:"t",value:i.whiteMap}},vertex_pars:t.ShaderChunk.map_pars_vertex,vertex:t.ShaderChunk.map_vertex,fragment_pars:t.ShaderChunk.map_pars_fragment,fragment:[t.ShaderChunk.uvmapping_fragment,t.ShaderChunk.map_fragment,"#define USE_UV_MAPS","vec2 maps_UVcoord = vec2(0.0);","#ifdef USE_MAP","maps_UVcoord = vUv;","#endif"].join("\n")},i.mapDebug={depends:[i.map],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = texelColor;","return;"].join("\n")},i.normalMap={attributes:{normalMap:i.whiteMap},uniforms:{normalMap:{type:"t",value:void 0},use_normalMap:{type:"i",value:0}},vertex_pars:"",vertex:"",fragment_pars:["uniform sampler2D normalMap;","uniform int use_normalMap;","vec3 value_normalMap;"].join("\n"),fragment:["#ifdef USE_UV_MAPS","#define USE_NORMAL_MAP","if( use_normalMap > 0 ) {","value_normalMap = normalize( texture2D( normalMap, maps_UVcoord ).rgb * 2.0 - 1.0 );","} else {","value_normalMap = vec3(0.0,0.0,0.0);","}","#endif"].join("\n")},i.normalMapDebug={depends:[i.normalMap],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(value_normalMap, 1.0);","return;"].join("\n")},i.specularMap={attributes:{specularMap:i.whiteMap},uniforms:{specularMap:{type:"t",value:void 0},use_specularMap:{type:"i",value:0}},vertex_pars:"",vertex:"",fragment_pars:["uniform sampler2D specularMap;","uniform int use_specularMap;","vec3 value_specularMap;"].join("\n"),fragment:["#ifdef USE_UV_MAPS","#define USE_SPECULAR_MAP","if( use_specularMap > 0 ) {","value_specularMap = texture2D( specularMap, maps_UVcoord ).rgb;","} else {","value_specularMap = specular;","}","#endif"].join("\n")},i.specularMapDebug={depends:[i.specularMap],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(value_specularMap, 1.0);","return;"].join("\n")},i.urbanLights={depends:[i.vertexInformation],attributes:{lights:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lights,{shininess:{type:"f",value:2},specular:{type:"c",value:new t.Color(16777215)},ambient:{type:"c",value:new t.Color(16777215)}}]),vertex_pars:"",vertex:"",fragment_pars:[t.ShaderChunk.lights_lambert_pars_vertex,"uniform float shininess;","uniform vec3 specular;","vec3 diffuse_value = diffuse;","vec3 ambient_value = ambient;","float opacity_value = opacity;"].join("\n"),fragment:["vec3 tmp = vec3(0.0);","vec3 light_t = vec3(0.0);","vec3 light_b = vec3(0.0);","vec3 light_dir = vec3(0.0);","vec3 light_viewdir = vec3(0.0);","vec3 light_diffuse = vec3(0.0);","vec3 light_specular = vec3(0.0);","float light_shininess = shininess == 0.0 ? 1.0 : shininess;","vec3 light_normal_value = vertex_wNormal.xyz;","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","light_normal_value = value_normalMap;","vec3 light_c1 = cross(vertex_wNormal.xyz, vec3(0.0, 0.0, 1.0));","vec3 light_c2 = cross(vertex_wNormal.xyz, vec3(0.0, 1.0, 0.0));","if( length(light_c1)>length(light_c2) )","light_t = normalize( light_c1 );","else","light_t = normalize( light_c2 );","light_b = normalize( cross(vertex_wNormal.xyz, light_t) );","}","#endif","vec3 light_specular_value = specular;","#ifdef USE_SPECULAR_MAP","light_specular_value = value_specularMap;","#endif","light_viewdir = normalize(vertex_viewdir.xyz);","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( vertex_viewdir.xyz, light_t );","tmp.y = dot( vertex_viewdir.xyz, light_b );","tmp.z = dot( vertex_viewdir.xyz, vertex_wNormal.xyz );","light_viewdir = normalize( tmp );","}","#endif","#if MAX_DIR_LIGHTS > 0","light_dir = normalize( directionalLightDirection[0] );","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( light_dir, light_t );","tmp.y = dot( light_dir, light_b );","tmp.z = dot( light_dir, vertex_wNormal.xyz );","light_dir = normalize( tmp );","}","#endif","light_diffuse += directionalLightColor[0] * diffuse_value * max( dot( light_dir, light_normal_value ), 0.0);","light_specular += directionalLightColor[0] * light_specular_value * pow( max( 0.0, dot( reflect(-light_dir, light_normal_value ), light_viewdir ) ), light_shininess );","vec3 totalDiffuse = vec3( dot( light_dir, light_normal_value ),0.0,0.0) ;","#endif","#if MAX_POINT_LIGHTS > 0","light_dir = normalize( pointLightPosition[ 0 ] - vertex_wPosition.xyz );","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( light_dir, light_t );","tmp.y = dot( light_dir, light_b );","tmp.z = dot( light_dir, vertex_wNormal.xyz );","light_dir = normalize( tmp );","}","#endif","light_diffuse += pointLightColor[0] * diffuse_value * max( dot( light_dir, light_normal_value ), 0.0);","light_specular += pointLightColor[0] * light_specular_value * pow( max(0.0, dot( reflect(-light_dir, light_normal_value ), light_viewdir ) ), light_shininess );","#endif","gl_FragColor.rgb = light_specular + gl_FragColor.rgb * clamp(ambientLightColor*ambient_value+light_diffuse, 0.0, 2.0);","gl_FragColor.a = opacity_value;"].join("\n")},i.urbanLightsDebugDiffuse={depends:[i.urbanLights],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(light_diffuse, 1.0);","return;"].join("\n")},i.urbanLightsDebugSpecular={depends:[i.urbanLights],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(light_specular, 1.0);","return;"].join("\n")},i.xCityLights={depends:[i.vertexInformation],attributes:{lights:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lights,{shininess:{type:"f",value:30},specular:{type:"c",value:new t.Color(16777215)},emissive:{type:"c",value:new t.Color(0)},ambient:{type:"c",value:new t.Color(16777215)}}]),vertex_pars:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",t.ShaderChunk.lights_phong_pars_vertex].join("\n"),vertex:["vNormal = vertex_vNormal.xyz;","vViewPosition = vertex_vViewdir.xyz;","worldPosition = vertex_wPosition;",t.ShaderChunk.lights_phong_vertex].join("\n"),fragment_pars:["uniform vec3 diffuse;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","float specularStrength = 1.0;",t.ShaderChunk.lights_phong_pars_fragment].join("\n"),fragment:["float shininessValue = shininess;",t.ShaderChunk.lights_phong_fragment].join("\n")},i.xCityEnvMap={depends:[i.xCityLights],attributes:{envMap:!0},uniforms:{},vertex_pars:t.ShaderChunk.envmap_pars_vertex,vertex:[t.ShaderChunk.envmap_vertex,"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","#ifdef DOUBLE_SIDED","vReflect = vertex_wPosition.xyz;","#endif","#endif"].join("\n"),fragment_pars:t.ShaderChunk.envmap_pars_fragment,fragment:["vec3 vWorldPosition = vertex_wPosition.xyz;","#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","reflectVec = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else { ","reflectVec = reflect( cameraToVertex, worldNormal );","}","#else","reflectVec = vReflect;","#endif","reflectVec = vec3(-reflectVec.x, reflectVec.zy);","vec3 flipReflectVec;","#ifdef DOUBLE_SIDED","float flipNormal = 1.0;","flipReflectVec = flipNormal * reflectVec;","#else","flipReflectVec = reflectVec;","#endif","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_LIGHTPROBEMAP","flipReflectVec = vec3(flipReflectVec.y, flipReflectVec.z, flipReflectVec.x);","float probeR = INV_PI * acos( flipReflectVec.z ) / length(flipReflectVec.xy);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = texture2DBilinearFromRGBE( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = texture2D( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0) );","#endif","#else","float phi = atan(flipReflectVec.y, flipReflectVec.x) + offsetPhi;","float theta = acos(flipReflectVec.z);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = envMapExposure * texture2DBilinearFromRGBE( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = envMapExposure * texture2D( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta) );","#endif","#endif","#else","vec4 cubeColor = textureCube( envMap, flipReflectVec );","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n")},i.shadowMapCustom={depends:[],attributes:{},uniforms:t.UniformsLib.shadowmap,vertex_pars:t.ShaderChunk.shadowmap_pars_vertex,vertex:["#ifdef USE_SHADOWMAP","#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 oldPosition = skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( position, 1.0 );","#endif","#endif","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[i]*oldPosition;// + 5.5*vec4(normal,1.0));","}","#endif"].join("\n"),fragment_pars:t.ShaderChunk.shadowmap_pars_fragment,fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","bvec2 inFrustumAndZVec = bvec2(inFrustum, shadowCoord.z <= 1.0);","bool inFrustumAndZ = all(inFrustumAndZVec);","inFrustumCount += int( inFrustumAndZ );","bvec2 frustumTestVec = bvec2( inFrustumAndZ, inFrustumCount == 1 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias[ i ];","float dv = 1.0;","#if MAX_DIR_LIGHTS > 0","#ifdef PHONG","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","dv =  abs(dot(  dirVector, normal ));","#else","dv = abs(totalDiffuse.x);","#endif","#endif","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( depthKernel[0][0] < shadowCoord.z ) shadowKernel[0][0] = 0.25;","else shadowKernel[0][0] = 0.0;","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( depthKernel[0][1] < shadowCoord.z ) shadowKernel[0][1] = 0.25;","else shadowKernel[0][1] = 0.0;","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( depthKernel[0][2] < shadowCoord.z ) shadowKernel[0][2] = 0.25;","else shadowKernel[0][2] = 0.0;","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( depthKernel[1][0] < shadowCoord.z ) shadowKernel[1][0] = 0.25;","else shadowKernel[1][0] = 0.0;","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( depthKernel[1][1] < shadowCoord.z ) shadowKernel[1][1] = 0.25;","else shadowKernel[1][1] = 0.0;","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( depthKernel[1][2] < shadowCoord.z ) shadowKernel[1][2] = 0.25;","else shadowKernel[1][2] = 0.0;","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( depthKernel[2][0] < shadowCoord.z ) shadowKernel[2][0] = 0.25;","else shadowKernel[2][0] = 0.0;","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( depthKernel[2][1] < shadowCoord.z ) shadowKernel[2][1] = 0.25;","else shadowKernel[2][1] = 0.0;","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( depthKernel[2][2] < shadowCoord.z ) shadowKernel[2][2] = 0.25;","else shadowKernel[2][2] = 0.0;","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if (  directionalLightDirection[ 0 ].z < 0.0 || dv < 0.1 || fDepth < shadowCoord.z )","   shadowColor =  vec3( 1.0 -  shadowDarkness[ i ]);","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( frustumTest ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor = sqrt( shadowColor );","#endif","#if !defined(IGNORE_SHADOW_COEFF)","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif","#endif"].join("\n")},i.shadowMap={attributes:{},uniforms:t.UniformsLib.shadowmap,vertex_pars:t.ShaderChunk.shadowmap_pars_vertex,vertex:t.ShaderChunk.shadowmap_vertex,fragment_pars:t.ShaderChunk.shadowmap_pars_fragment,fragment:t.ShaderChunk.shadowmap_fragment},i.shadowMapDebug={depends:[i.shadowMapCustom],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4( shadowColor, 1.0 );","return;"].join("\n")},i.tileMapping={depends:[i.vertexInformation,i.map],attributes:{},uniforms:{bbox_min:{type:"v2",value:new t.Vector2(0,0)},bbox_max:{type:"v2",value:new t.Vector2(0,0)}},vertex_pars:["uniform vec2 bbox_min;","uniform vec2 bbox_max;"].join("\n"),vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ROUGHNESSMAP )","   float u = clamp((vertex_wPosition.x - bbox_min.x)/(bbox_max.x - bbox_min.x),0.0,1.0);","   float v = clamp((vertex_wPosition.y - bbox_min.y)/(bbox_max.y - bbox_min.y),0.0,1.0);","   vUv = vec2(u, v);","#endif"].join("\n"),fragment_pars:"",fragment:""},i.atlas_PDSFX={name:"atlas_PDSFX",attributes:{vertexColors:!0},uniforms:{mapCity:{type:"t2",value:i.whiteMap},roadTexture:{type:"t2",value:i.whiteMap}},varyings:{vertexPos_world:{type:"v2"},vertexColorR:{type:"f"},vertexColorG:{type:"f"},vertexColorB:{type:"f"}},VS_overridableFunctions:{ComputeObjectTexCoord0:["return vGetAttribTexCoord0();"].join("\n"),_ComputeObjectTexCoord1:["vec4 tCoord1 = vec4(vertexPos_world.x, vertexPos_world.y, 0.0, 0.0);","return tCoord1;"].join("\n"),ComputeVaryingValues:["vertexPos_world = vec3(modelMatrix * vec4(ComputeObjectPosition(), 1.0)).xy;","vertexColorR = vGetAttribColor().r;","vertexColorG = vGetAttribColor().g;","vertexColorB = vGetAttribColor().b;"].join("\n")},FS_global_code:["vec4 _texelCity;","#define CITY_HACK_VERTEXCOLOR 1","float atlas_size = 2048.0;","float atlas_borderSize = 5.0;","vec2 atlas_getStartOffset(float posX, float posY) {","return vec2(posX + (atlas_borderSize / atlas_size), posY + (atlas_borderSize / atlas_size));","}","float atlas_getSizeInAtlas(float size) {","return (size - (2.0 * (atlas_borderSize / atlas_size)));","}"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["vec3 vertexColor = vec3(vertexColorR, vertexColorG, vertexColorB);","vec3 hdRoad_color = vec3(0.0);","#if defined (ATLAS_ROAD)","hdRoad_color = atlas_road(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_ROAD_MARKING)","hdRoad_color = atlas_road_marking(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_LAWN)","hdRoad_color = atlas_lawn(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_FOOTPATH)","hdRoad_color = atlas_footpath(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_SIDEWALKEDGES)","hdRoad_color = atlas_sidewalkedges(hdRoad_color, vertexColor);","#endif","_texelCity = vec4(hdRoad_color, 1.0);",""].join("\n"),ComputeAlbedo:["return sqrt(_texelCity.xyz);"].join("\n"),__ComputeRoughness:["return 1.0;"].join("\n"),__ProcessFinalColor:["ioFinalColor.xyz = ComputeAlbedo();"].join("\n")}},i.atlas_RoadArea_PDSFX={name:"atlas_RoadArea_PDSFX",depends:[i.atlas_PDSFX],FS_global_code:["#define ATLAS_ROAD","vec3 atlas_road(vec3 color, vec3 vertexColor) {","float ra_colorDiff = length(vertexColor.rgb - vec3(0.0, 0.0, 1.0));","vec3 ra_color = color;","if (abs(ra_colorDiff) < 0.1) {","vec2 ra_startOffset = atlas_getStartOffset(0.5, 0.5);","float ra_texSize = atlas_getSizeInAtlas(0.5);","vec4 ra_noiseColor = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.05, ra_texSize) + ra_startOffset);","float ra_noise = clamp((mix(-40.0, 40.0, ra_noiseColor.r) + length(vGetViewPosition()) - 20.0) / 40.0, 0.0, 1.0);","ra_startOffset = atlas_getStartOffset(0.0, 0.25);","ra_texSize = atlas_getSizeInAtlas(0.25);","vec4 ra_mixteColor005 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.05, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor025 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.25, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor050 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.50, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor200 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 2.00, ra_texSize) + ra_startOffset);","float ra_mul = pow(pow(ra_mixteColor025.r * ra_mixteColor050.r, 0.5) * ra_mixteColor005.g, 0.5);","vec3 ra_mix1 = mix(vec3(0.07), vec3(0.4), ra_mul);","vec3 ra_mix2 = mix(vec3(0.07), vec3(0.4), ra_mul * ra_mixteColor200.b);","ra_color = mix(ra_mix2, ra_mix1, ra_noise);","//ra_color = vec3(0.0,0.0,1.0);","}","return ra_color;","}"].join("\n")},i.atlas_RoadMarking_PDSFX={name:"atlas_RoadMarking_PDSFX",depends:[i.atlas_PDSFX],FS_global_code:["#define ATLAS_ROAD_MARKING","vec3 atlas_road_marking(vec3 color, vec3 vertexColor) {","float rm_colorDiff1 = length(vertexColor.rgb - vec3(1.0, 0.0, 0.0));","float rm_colorDiff2 = length(vertexColor.rgb - vec3(0.0, 1.0, 0.0));","vec3 rm_color = color;","if ((abs(rm_colorDiff1) < 0.1) || (abs(rm_colorDiff2) < 0.1)) {","if (abs(rm_colorDiff1) < 0.1) {","rm_color = vec3(0.9);","} else if (abs(rm_colorDiff2) < 0.1) {","rm_color = vec3(0.985, 0.673, 0.136);","}","vec2 rm_startOffset = atlas_getStartOffset(0.25, 0.25);","float rm_texSize = atlas_getSizeInAtlas(0.25);","rm_color *= texture2D(mapCity, mod(vertexPos_world.xy * rm_texSize * 0.50, rm_texSize) + rm_startOffset).rgb;","rm_color *= texture2D(mapCity, mod(vertexPos_world.xy * rm_texSize * 0.25, rm_texSize) + rm_startOffset).rgb;","//rm_color = vec3(1.0,0.0,0.0);","}","return rm_color;","}"].join("\n")},i.atlas_LawnArea_PDSFX={name:"atlas_LawnArea_PDSFX",depends:[i.atlas_PDSFX],FS_global_code:["#define ATLAS_LAWN","vec3 atlas_lawn(vec3 color, vec3 vertexColor) {","vec3 lawn_color = color;","float la_colorDiff = length(vertexColor.rgb - vec3(1.0, 1.0, 0.0));","if (abs(la_colorDiff) < 0.1) {","vec2 la_startOffset = atlas_getStartOffset(0.5, 0.5);","float la_texSize = atlas_getSizeInAtlas(0.5);","vec4 la_noiseColor = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.05, la_texSize) + la_startOffset);","float la_noise = clamp((mix(-40.0, 40.0, la_noiseColor.r) + length(vGetViewPosition()) - 20.0) / 40.0, 0.0, 1.0);","la_startOffset = atlas_getStartOffset(0.0, 0.0);","la_texSize = atlas_getSizeInAtlas(0.25);","vec4 la_herb_Color_g = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.25, la_texSize) + la_startOffset);","vec4 la_herb_Color = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.05, la_texSize) + la_startOffset);","#ifdef GAMMA_INPUT","la_herb_Color_g *= la_herb_Color_g;","la_herb_Color *= la_herb_Color;","#endif","la_startOffset = atlas_getStartOffset(0.0, 0.5);","la_texSize = atlas_getSizeInAtlas(0.5);","float la_varColor1 = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.003, la_texSize) + la_startOffset).r;","float la_varColor2 = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.0025, la_texSize) + la_startOffset).r;","#ifdef GAMMA_INPUT","la_varColor1 *= la_varColor1;","la_varColor2 *= la_varColor2;","#endif","vec4 la_mul_Dead = vec4(0.9, 0.7, 0.3, 1) * la_herb_Color_g.g;","vec4 la_mul_Base = vec4(0.4, 0.45, 0.25, 3) * la_herb_Color_g;","vec4 la_mixColor = mix(la_herb_Color, vec4(0.02, 0.04, 0.01,1), 0.7);","vec4 la_mix1 = mix(la_mul_Dead, la_mul_Base, clamp(mix(0.25, 2.0, la_varColor1), 0.0, 1.0));","vec4 la_mix2 = mix(la_mix1, la_mixColor, la_varColor2);","lawn_color = mix(la_mix1, la_mix2, la_noise).xyz;","//lawn_color = vec3(0.0,1.0,0.0);","}","return lawn_color;","}"].join("\n")},i.atlas_FootPaths_PDSFX={name:"atlas_FootPaths_PDSFX",depends:[i.atlas_PDSFX],FS_global_code:["#define ATLAS_FOOTPATH","vec3 atlas_footpath(vec3 color, vec3 vertexColor) {","float fp_colorDiff = length(vertexColor.rgb - vec3(1.0, 0.0, 1.0));","vec3 fp_color = color;","if (abs(fp_colorDiff) < 0.1) {","float marge = 66.0/2048.0;","vec2 fp_startOffset = atlas_getStartOffset(0.5+marge, 0.0+marge);","float fp_texSize = atlas_getSizeInAtlas(0.25-(marge*2.0));","vec3 fp_texColor1 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize, fp_texSize) + fp_startOffset).rgb;","vec3 fp_texColor2 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.5, fp_texSize) + fp_startOffset).rgb;","#ifdef GAMMA_INPUT","fp_texColor1 *= fp_texColor1;","fp_texColor2 *= fp_texColor2;","#endif","float fp_varColor1 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.8, fp_texSize)+ fp_startOffset).w;","fp_startOffset = atlas_getStartOffset(0.0, 0.5);","fp_texSize = atlas_getSizeInAtlas(0.5);","float fp_varColor2 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.015, fp_texSize) + fp_startOffset).r;","fp_color = mix(4.0, 4.0, fp_varColor1) * mix(0.9, 1.3, fp_varColor2) * fp_texColor1 * fp_texColor2;","//fp_color = vec3(1.0,0.0,1.0);","}","return fp_color;","}"].join("\n")},i.atlas_SideWalkEdges_PDSFX={name:"atlas_SideWalkEdges_PDSFX",depends:[i.atlas_PDSFX],FS_global_code:["#define ATLAS_SIDEWALKEDGES","vec3 atlas_sidewalkedges(vec3 color, vec3 vertexColor) {","float swe_colorDiff = length(vertexColor.rgb - vec3(1.0, 1.0, 1.0));","vec3 swe_color = color;","if (abs(swe_colorDiff) < 0.1) {","vec2 swe_startOffset = atlas_getStartOffset(0.5, 0.375);","vec2 swe_texSize = vec2(atlas_getSizeInAtlas(0.5), atlas_getSizeInAtlas(0.125));","swe_color = texture2D(mapCity, mod((vGetTexCoord0().xy * swe_texSize) / vec2(2.0, 1.0), swe_texSize) + swe_startOffset).rgb;","#ifdef GAMMA_INPUT","swe_color *= swe_color;","#endif","}","return swe_color;","}"].join("\n")},i.chunkOcean_PDSFX={name:"chunkOcean_PDSFX",nbTexture:1,uniforms:{mapCity:{type:"t2",value:i.whiteMap},oceanTexture:{type:"t2",value:i.whiteMap},oceanColor:{type:"c",value:new t.Color("rgb(47,64,140)")},landcoverTimer:{type:"f",value:0,animation:function(e){return e.animatedTime}},showOcean:{type:"b",value:!0},specularOcean:{type:"c",value:new t.Color("rgb(255,255,255)")}},varyings:{vertexPos_world:{type:"v3"}},FS_global_code:["#ifndef TERRAIN_SHADER","#define TERRAIN_SHADER","bool computeWaves = true && showOcean;","#endif","// generate a layer of waves","float OceanPI = 3.14;","vec3 generateWavesFromNoises(sampler2D wt, vec2 texCoords, float time, float s, float bs)","{","float sinAngle, cosAngle;","const int nbDirections = 5;","float spread = OceanPI*2.0*s;","vec3 currentLayer = vec3(0.0,0.0,0.0);","float uNormalize = 0.50;","float uBumpStrength = bs; ","for (int i=0; i<nbDirections; i++)","{","float angle = spread * float(i)/float(nbDirections);","cosAngle = cos(angle); ","sinAngle = sin(angle);","vec2 diri =  vec2( cosAngle, sinAngle ); ","vec2 UV = texCoords + time * diri ;","vec3 normal = texture2D(wt, UV).rgb;","vec3 clt = 2.0*(normal - vec3(uNormalize, uNormalize, 0.0));","clt.xy *= uBumpStrength;","currentLayer += normalize(clt); ","}","currentLayer /= float(nbDirections);","return currentLayer.xyz;","}","// combine wave layers","vec3 combineWaves(vec3 worldPos)","{","vec2 uvWater =  5.0*0.001*worldPos.xy;","float waterSpeed = 0.01*landcoverTimer;","vec3 pwave1  =  generateWavesFromNoises(oceanTexture, 0.4*uvWater,  0.5*waterSpeed, 0.6, 1.0);","vec3 cameraToVertex = normalize( worldPos - cameraPosition );","vec3 rwave1 = reflect( cameraToVertex, pwave1 );","if (rwave1.z < 0.0) { pwave1 = vec3(0.0,0.0,1.0); };","vec3 pwave2  = generateWavesFromNoises(oceanTexture, 3.0*uvWater, 0.6*waterSpeed, 0.7, 1.5);","vec3 rwave2 = reflect( cameraToVertex, pwave2 );","if (rwave2.z < 0.0) { pwave2 = vec3(0.0,0.0,1.0); };","vec3 pwave3  = generateWavesFromNoises(oceanTexture, 10.0*uvWater, 0.7*waterSpeed, 1.0, 3.0);","vec3 rwave3 = reflect( cameraToVertex, pwave3 );","if (rwave3.z < 0.0) { pwave3 = vec3(0.0,0.0,1.0); };","vec3 pwave =  normalize((pwave1 + pwave2 + pwave3));","vec3 ppwave =  normalize((pwave1));","return pwave;","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["vec3 vertexPos_worldXYZ = vec3(modelMatrix * vec4(ComputeObjectPosition(), 1.0));","vertexPos_world = vertexPos_worldXYZ.xyz;"].join("\n"),ComputeObjectNormal:["return vec3(0.0,0.0,1.0);"].join("\n")},FS_overridableFunctions:{ComputeCommonValues:["if (computeWaves) {","}",""].join("\n"),ComputeAlbedo:["if (computeWaves) {","return oceanColor;","}","cAlbedo = oceanColor;",""].join("\n"),ComputeViewNormal:["if (computeWaves) {","float coefDist = clamp(length(vGetViewPosition())/50000.0,0.0,1.0);","vec3 combiwaves = combineWaves(vertexPos_world);","vec3 waveNormal = coefDist * vec3(0.0,0.0,1.0) + (1.0-coefDist) * combiwaves; ","vec3 vNormal = vec3(vGetViewMatrix() * vec4(normalize(waveNormal), 0.0));","return vNormal;","}","else {","return vGetViewNormal();","}"].join("\n"),ComputeSpecularReflectance:["if (computeWaves) {","return specularOcean*0.02777777;","}","else {","return vec3(0.02777777,0.02777777,0.02777777);","}"].join("\n"),ComputeRoughness:["if (computeWaves) {","return 0.1;","}","else {","return 1.0;","}"].join("\n"),_ProcessFinalColor:["ioFinalColor.rgb = ComputeViewNormal().xyz;"].join("\n")}},i.chunkLandcover_unvisibleSource_PDSFX={name:"chunkLandcover_unvisibleSource_PDSFX",nbTexture:1,depends:[],attributes:{},vertex_attributes:{},uniforms:{landcover:{type:"t2",value:void 0},landcoverOffset:{type:"v4",value:new t.Vector4(0,0,1,1)},oceanRangeDetection:{type:"f",value:.1},oceanColorDetection:{type:"c",value:new t.Color("rgb(0,0,255)")}},varyings:{uvslandcover:{type:"v2"}},VS_overridableFunctions:{ComputeCommonValues:["if (uv.xy != vec2(-1.0) ) {","uvslandcover = ComputeObjectTexCoord0_Cropped().xy * landcoverOffset.z + landcoverOffset.xy;","} else {","uvslandcover = vec2(-1.0);","}"].join("\n")},FS_overridableFunctions:{ComputeCommonValues:["vec4 _landcover;","if (uvslandcover != vec2(-1.0)) {","_landcover = texture2D(landcover, uvslandcover);","} else {","_landcover = vec4(0.0);","}","computeWaves = (length(_landcover.rgb - oceanColorDetection) < oceanRangeDetection);"].join("\n")}},i.chunkLandcover_visibleSource_PDSFX={name:"chunkLandcover_visibleSource_PDSFX",nbTexture:0,depends:[],attributes:{},vertex_attributes:{},uniforms:{landcoverIndex:{type:"f",value:-1},oceanRangeDetection:{type:"f",value:.1},oceanColorDetection:{type:"c",value:new t.Color("rgb(0,0,255)")}},varyings:{},VS_overridableFunctions:{ComputeCommonValues:[].join("\n")},FS_global_code:["vec4 _landcover;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["","#ifdef MULTIPLE_RASTER_TERRAIN","#if MULTIPLE_RASTER_TERRAIN >= 2","if (landcoverIndex > -0.5 && landcoverIndex < 0.5) {","_landcover = texture2D(raster[0], uvsraster[0]);","}","else if (landcoverIndex > 0.5 && landcoverIndex < 1.5) {","_landcover = texture2D(raster[1], uvsraster[1]);","}","#endif","#if MULTIPLE_RASTER_TERRAIN >= 3","else if (landcoverIndex > 1.5 && landcoverIndex < 2.5) {","_landcover = texture2D(raster[2], uvsraster[2]);","}","#endif","#if MULTIPLE_RASTER_TERRAIN >= 4","else if (landcoverIndex > 2.5 && landcoverIndex < 3.5) {","_landcover = texture2D(raster[3], uvsraster[3]);","}","#endif","#else","_landcover = texture2D(raster, uvsraster);","#endif","computeWaves = (length(_landcover.rgb - oceanColorDetection) < oceanRangeDetection);","//computeWaves = true;"].join("\n"),_ProcessFinalColor:["ioFinalColor = _landcover;"].join("\n")}},i.drawZasRGB={name:"zRenderAsRGB_PDSFX",nbTexture:0,uniforms:{minMaxZ:{type:"v2",value:new t.Vector2(0,1e4)}},varyings:{zValue:{type:"f"}},VS_overridableFunctions:{ComputeVaryingValues:["vec4 worldPos = modelMatrix * vec4(vGetAttribPosition(), 1.0);","float zWorld = worldPos.z;","if (zWorld < minMaxZ.x) {","zValue = 0.0;","} else if (zWorld > minMaxZ.y) {","zValue = 1.0;","} else {","zValue = (zWorld - minMaxZ.x) / (minMaxZ.y - minMaxZ.x);","}"].join("\n")},FS_global_code:["vec3 cityPackRGB( const in float value ) {","const vec3 bit_shift = vec3(255.0 * 255.0, 255.0, 1.0 );","const vec3 bit_mask  = vec3( 0.0, 1.0 / 255.0, 1.0 / 255.0 );","vec3 res = value * bit_shift;","res -= floor(res);","res -= res.xxy * bit_mask;","return res;","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb = cityPackRGB(zValue);","ioFinalColor.a = 1.0;"].join("\n")}},i.drawZasRGBA={name:"zRenderAsRGBA_PDSFX",nbTexture:0,uniforms:{minMaxZ:{type:"v2",value:new t.Vector2(0,1e4)}},varyings:{zValue:{type:"f"}},VS_overridableFunctions:{ComputeVaryingValues:["vec4 worldPos = modelMatrix * vec4(vGetAttribPosition(), 1.0);","float zWorld = worldPos.z;","if (zWorld < minMaxZ.x) {","zValue = 0.0;","} else if (zWorld > minMaxZ.y) {","zValue = 1.0;","} else {","zValue = (zWorld - minMaxZ.x) / (minMaxZ.y - minMaxZ.x);","}"].join("\n")},FS_global_code:["vec4 cityPackRGBA( const in float value ) {","const vec4 bit_shift = vec4( 255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0 );","vec4 res = value * bit_shift;","res -= floor(res);","res -= res.xxyz * bit_mask;","return res;","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgba = cityPackRGBA(zValue);"].join("\n")}},i})),define("DS/SocialGlobe/Vector2",["UWA/Class"],(function(e){"use strict";var t=e.extend({init:function(e,t){this.x=e,this.y=t},normalize:function(e){var t=Math.sqrt(this.x*this.x+this.y*this.y);return t>e&&(this.x/=t,this.y/=t,!0)}});return t.AB=function(e,i){return new t(i.x-e.x,i.y-e.y)},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.dist=function(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))},t.isTriangleDirect=function(e,t,i){var o=t.x-e.x,a=t.y-e.y,r=i.x-e.x;return o*(i.y-e.y)-a*r>=0},t.isLoopClockwise=function(e){var t,i,o=0,a=0;for(a=0;a<e.length;a++)t=e[a],o+=((i=e[(a+1)%e.length]).x-t.x)*(i.y+t.y);return o>=0},t.toClockwise=function(e,t){return t!==this.isLoopClockwise(e)?e.reverse():e},t.lineIntersect=function(e,t,i,o){var a,r,s=(t.x-e.x)*(o.y-i.y)-(t.y-e.y)*(o.x-i.x);return!(Math.abs(s)<1e-8)&&(a=((e.y-i.y)*(o.x-i.x)-(e.x-i.x)*(o.y-i.y))/s,r=((e.y-i.y)*(t.x-e.x)-(e.x-i.x)*(t.y-e.y))/s,a<=1&&a>=0&&r<=1&&r>=0)},t})),define("DS/SocialGlobe/OffscreenCanvas2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],(function(e,t,i,o){"use strict";var a=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture;var o=this.canvasNodeTexture._getCanvas2DTexture(),r=new e.MeshBasicMaterial({transparent:!0,side:e.DoubleSide,depthTest:!1,force:!0});this.canvas2DMaterial=r,r.activatePDSFX();var s={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},canvas2DTexture:{type:"t2",value:o},highlight:{type:"b",value:!1,stage:e.FragmentStage},angle:{type:"f",value:t.angle||0}};r.setPDSFXUniforms(s);r.setPDSFXVaryings({_uv:{type:"v2"},screenPosition:{type:"v2"}});var n={ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) { ","  _uv = vGetAttribTexCoord0().xy;","  float dx, dy;","  dx = ioPosition.w * (pixelSize.x*(-hotspot.x + _uv.x*size.x));","  dy = ioPosition.w * (pixelSize.y*(-hotspot.y + _uv.y*size.y));;","  float ratio = pixelSize.x / pixelSize.y;","  ioPosition.x += cos(angle)*dx - sin(angle)*dy*ratio;","  ioPosition.y += sin(angle)*dx/ratio + cos(angle)*dy;","}"].join("\n")},l={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = ioFinalColor * texture2D(canvas2DTexture, _uv);","if (highlight) {","  float norm = length(ioFinalColor.xyz);","  ioFinalColor.xyz = (norm/1.73205)*vec3(0.0, 0.6, 1.0);","}","}"].join("\n")};r.setPDSFXOverridableFunctions(n,l),this.rectangle=a._createRectangle(r,i);this.rectangle._occurrences[0].renderable;r._refreshPDSFXUniforms_private=function(t,i){var o;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)o=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var a=2*t._gpuPickingTolerance+1;o=new e.Vector2(2/a,2/a)}if(this.updatePDSFXUniform("pixelSize",o),window.activateCanvas2DSuperHighlight){var r=i._occurrence.node._occurrences.length>1;this.updatePDSFXUniform("highlight",!(r||!i.highlight))}},this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),this.exludeFromBounding(!0);var d=this;return this.rectangle._setBeforeRenderCB((function(e,t){o.redrawRequested&&d.canvasNodeTexture._redrawCanvas2DTexture()})),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setHotspot:function(e){e&&this.canvas2DMaterial.updatePDSFXUniform("hotspot",e.clone())},getHotspot:function(){return this.canvas2DMaterial.getPDSFXUniform("hotspot").value.clone()},setAngle:function(e){this.canvas2DMaterial.updatePDSFXUniform("angle",e)},getAngle:function(){return this.canvas2DMaterial.getPDSFXUniform("angle").value}});return a._createRectangle=function(e,t){var i,a,r,s,n,l,d,c,h,u,g,p,m,f,v;for(10,(i=new o.PrimitiveGroup).fillAttr=new o.FillAttributes,i.lineAttr=new o.LineAttributes,i.pointAttr=new o.PointAttributes,(a=new o.Buffer).size=12,a.component=o.VertexComponentEnum.POSITION,a.format=o.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(r=new o.Buffer).size=3,r.component=o.VertexComponentEnum.NORMAL,r.format=o.DataTypeEnum.FLOAT,r.dimension=3,r.data=new Float32Array(r.size),(s=new o.Buffer).size=12,s.component=o.VertexComponentEnum.TEX_COORD_0,s.format=o.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(n=new o.Buffer).indexBuffer=!0,n.size=4,n.format=o.DataTypeEnum.UINT,n.dimension=1,n.data=new Uint16Array(n.size),(l=new o.Buffer).indexBuffer=!0,l.size=4,l.format=o.DataTypeEnum.UINT,l.dimension=1,l.data=new Uint16Array(l.size),(d=new o.Buffer).indexBuffer=!0,d.size=4,d.format=o.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(d.size),i.addBuffer(0,a),i.addBuffer(1,r),i.addBuffer(2,n),i.addBuffer(3,l),i.addBuffer(4,s),i.addBuffer(5,d),m=0,(v=n.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=l.data,m=0,f=0;f<1;f++)v[m++]=f,v[m++]=f,v[m++]=f,v[m++]=f;for(m=0,(v=d.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=a.data,m=0,m=0;m<12;m++)v[m]=0;for(m=0,(v=r.data)[m++]=0,v[m++]=0,v[m++]=1,m=0,(v=s.data)[m++]=0,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,f=0;f<1;f++)(c=new o.Primitive).nbIndices=4,c.connectivity=o.ConnectivityTypeEnum.TRIANGLE_STRIP,c.attr={fill:new o.FillAttributes(new o.Color(1-f/6,0,f/6,1),1),line:new o.LineAttributes,point:new o.PointAttributes},(h=new o.VertexComponent).component=o.VertexComponentEnum.POSITION,h.nbVertices=4,h.nbValuesPerVertex=3,h.format=o.DataTypeEnum.FLOAT,h.cardinality=0,h.bufferId=0,h.indices=new o.IndexArray,h.indices.format=o.DataTypeEnum.UINT,h.indices.bufferId=2,h.indices.offset=4*f,(u=new o.VertexComponent).component=o.VertexComponentEnum.NORMAL,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=o.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=1,u.indices=new o.IndexArray,u.indices.format=o.DataTypeEnum.UINT,u.indices.bufferId=3,u.indices.offset=4*f,(g=new o.VertexComponent).component=o.VertexComponentEnum.TEX_COORD_0,g.nbVertices=4,g.nbValuesPerVertex=3,g.format=o.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=4,g.indices=new o.IndexArray,g.indices.format=o.DataTypeEnum.UINT,g.indices.bufferId=5,g.indices.offset=0,c.addVertexComponent(h),c.addVertexComponent(u),c.addVertexComponent(g),i.addPrimitive(c);return(p=t.createMeshNode(i,e)).setShadow(!1),p},a})),define("DS/SocialGlobe/GlobeNotifications",["UWA/Core","DS/WebappsUtils/Console","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen"],(function(e,t,i,o){"use strict";var a={notificationsManager:null,handleSuccess:function(e,t){a.display({level:"success",title:e,subtitle:t})},handleError:function(t,i,o){var r={};r.subtitle=i,r.title=t,r.message="";var s=e.typeOf(o);"error"===s?r.message=o.message:"object"===s&&o.response&&(r.message=e.is(o.response,"string")?o.response:o.response.data),a.display({level:"error",title:r.title,subtitle:r.subtitle,message:r.message})},display:function(r){if(null===a.notificationsManager&&(a.notificationsManager=i,o.setNotificationManager(a.notificationsManager),o.setStackingPolicy(9)),!e.is(r.level,"string")||"success"!==r.level&&"error"!==r.level&&"warning"!==r.level&&"info"!==r.level)throw new Error("Invalid input argument in options.level (GlobeNotifications.display).");if(!e.is(r.title,"string")||!e.is(r.subtitle,"string")||""===r.title||""===r.subtitle)throw new Error("Invalid input argument in options.[sub]title (GlobeNotifications.display).");if(r.message&&(!e.is(r.message,"string")||""===r.message))throw new Error("Invalid input argument in options.message (GlobeNotifications.display).");"error"===r.level&&t.error("Globe Viewer Error: "+r.message);var s={level:r.level,title:r.title,subtitle:r.subtitle,message:r.message?r.message:"",sticky:"error"===r.level,action:r.action,category:"3DXCity"};a.notificationsManager.addNotif(s)},clearAll:function(){o.removeNotifications()},displayWithAction:function(t){if(null===a.notificationsManager&&(a.notificationsManager=i,o.setNotificationManager(a.notificationsManager),o.setStackingPolicy(0)),!e.is(t.level,"string")||"success"!==t.level&&"error"!==t.level&&"warning"!==t.level&&"info"!==t.level)throw new Error("Invalid input argument in options.level (GlobeNotifications.display).");if(!e.is(t.title,"string")||""===t.title)throw new Error("Invalid input argument in options.[sub]title (GlobeNotifications.display).");if(!e.is(t.action,"object")||t.action==={})throw new Error("Invalid input argument in options.[sub]title (GlobeNotifications.display).");var r={level:t.level,title:t.title,action:t.action,sticky:!0,category:"3DXCity"};a.notificationsManager.addNotif(r)}};return a})),define("DS/SocialGlobe/views/GlobeUWALoaderView",["DS/Controls/Button","DS/Utilities/Dom","UWA/Class","UWA/Controls/Input"],(function(e,t,i,o){return new(i.extend({mode3DButton:null,mode2DButton:null,mode2Doptions:null,optionsContainer:null,is2D:null,tmsInputDisplayed:!1,tms:null,load:null,init(){this.handleClickWithoutTms.bind(this)},setLoad(e){this.load=e},setTms(e){this.tms=e},handleClickMode3D(){this.mode3DButton.addEventListener("click",(()=>{this.is2D=!1,this.load(this.is2D)}))},handleClickMode2D(){this.tms||this.createOptions(),this.mode2DButton.addEventListener("click",(()=>{this.is2D=!0,this.tms?this.load(this.is2D):this.handleClickWithoutTms()}))},handleClickWithoutTms(){this.tmsInputDisplayed||(this.tmsInputDisplayed=!0,this.mode2Doptions.grab(this.optionsContainer))},createOptions(){this.optionsContainer=new UWA.Element("div",{id:"options-container"}),new UWA.Element("p",{content:"Please enter a TMS (Tile Map Service) url to use:"}).inject(this.optionsContainer),widget.tmsInput=new o.Text({attributes:{id:"globeviewer-tms-input",placeholder:"https://the.path.before/Z/Y/X.ext"}}).inject(this.optionsContainer);var t=new e({label:"OK",icon:{fontIconFamily:WUXManagedFontIcons.Font3DS}}).inject(this.optionsContainer);t.getContent().addClassName("globe-homepage-button-options");var i=new e({label:"Cancel",icon:{fontIconFamily:WUXManagedFontIcons.Font3DS}}).inject(this.optionsContainer);i.getContent().addClassName("globe-homepage-button-options"),t.addEventListener("click",(e=>{var t=widget.tmsInput.getValue();widget.setValue("tilemapserver",t),this.load(this.is2D)})),i.addEventListener("click",(e=>{this.optionsContainer.remove(),this.tmsInputDisplayed=!1}))},render(){widget.getValue("MapMode")&&widget.getValue("use2D")&&this.load(!0),!1===widget.getValue("use2D")&&this.load(!1);var i=new UWA.Element("div",{id:"container"});i.inject(widget.body),widget.body.classList.add("globe-viewer");var o=new UWA.Element("div",{id:"globe-homepage"}).inject(i),a=new UWA.Element("div",{class:"globe-header"}).inject(o);new UWA.Element("h1",{class:"globe-title",text:"Globe Viewer"}).inject(a);var r=new UWA.Element("div",{class:"globe-main"}).inject(o),s=new UWA.Element("div",{class:"globe-mode"}).inject(r),n=new UWA.Element("div",{class:"globe-mode"}).inject(r);this.mode2Doptions=new UWA.Element("div",{class:"globe-2doptions"}).inject(r),this.mode2DButton=new e({label:"Map Mode",icon:{iconName:"map",fontIconFamily:WUXManagedFontIcons.Font3DS}}).inject(s),this.mode2DButton.getContent().addClassName("globe-homepage-button"),this.mode3DButton=new e({label:"3D Mode",icon:{iconName:"globe",fontIconFamily:WUXManagedFontIcons.Font3DS}}).inject(n),this.mode3DButton.getContent().addClassName("globe-homepage-button");var l=new UWA.Element("div",{class:"globe-footer"}).inject(o),d=new UWA.Element("div",{class:"globe-link"}).inject(l);t.generateIcon("i-question").inject(d),new UWA.Element("a",{class:"globe-footer-button",text:"User Assistance",href:"https://help.3ds.com/2022x/english/dsdoc/X3dglobUserMap/x3dglob-c-ov.htm?contextscope=cloud&id=f8f14bc27f2140ddb9a0afd647cb0971",target:"_blank"}).inject(d),o.inject(i),this.handleClickMode2D(),this.handleClickMode3D()}}))})),define("DS/SocialGlobe/Utils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/SocialGlobeServices/MapNavigator/MapNavigatorServices","UWA/Data"],(function(e,t,i){"use strict";var o=null;function a(){if(null!==o)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.loadTexture=this.loadTexture.bind(this),this.initialize()}return a.prototype={initialize:function(){this.nbImages=20,this.tenantId=void 0,this.conccurentTextureLoading=0,this.images=new Array(this.nbImages),this.current=0;for(var e=0;e<this.nbImages;e++)this.images[e]=new Image},loadShader:function(e,t,i){if(void 0!==this[t])return this[t];var o=i;void 0!==e.baseURL&&"http"!==i.substring(0,4)&&(o=e.baseURL+i);var a="",r=this;return UWA.Data.request(o,{cors:!0,async:!0,onComplete:function(e){var i=document.createElement("div");i.innerHTML=e,a=i.firstChild.firstChild.data,r[t]=a},onFailure:function(e){alert("Unable to load config file")}}),a},loadTexture:function(t,a,r,s,n,l,d){o.conccurentTextureLoading++;var c=r;if(void 0!==t.baseURL&&"http"!==r.substring(0,4)&&(c=t.baseURL+r),o.current===o.nbImages-1){o.current=0;for(var h=0;h<o.nbImages;h++)o.images[h]=new Image}var u=o.images[o.current];o.current++;var g=new e.Texture(u,void 0),p=e.ImageUtils,m=function(e){o.conccurentTextureLoading--,g.image=e.image,g.needsUpdate=!0,a(g,!0)},f=function(e){o.conccurentTextureLoading--,a(void 0,!1)},v=t.credentials.default,b=Object.keys(t.credentials);h=0;for(h=0;h<b.length;h++){var w=b[h];-1!==r.indexOf(w)&&(v=t.credentials[w])}p.crossOrigin="use-credentials",c.contains(".basis")?g=p.loadBasisTexture(c,void 0,m,f,v,e.BasisUsage.RGBA):c.contains("globe_")&&c.contains("map")?(c=i.addTenantId(c,d),c+=`&appid=${this.getAppId("GlobeViewerDefault")}`,p.loadTexture(c,void 0,m,f,"use-credentials"),g.sourceFile=c):(p.loadTexture(c,void 0,m,f),g.sourceFile=c)},setTenantId:function(e){this.tenantId=e},getTenantId:function(){return this.tenantId},getAppId:function(e){try{return widget&&widget.getValue("appId")?widget.getValue("appId"):e}catch(t){return e}}},a.getInstance=function(){return null===o&&(o=new a),o},a.getInstance()})),define("DS/SocialGlobe/Renderable",["UWA/Class","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";return e.extend({init:function(e){this.scene=e}})})),define("DS/SocialGlobe/TerminatorLineUI",["UWA/Class","DS/Controls/Toggle","DS/Controls/TimePicker","DS/Controls/Slider","DS/Controls/Calendar","DS/Controls/Button","DS/Windows/ImmersiveFrame","DS/Windows/Panel"],(function(e,t,i,o,a,r,s,n){"use strict";return e.extend({init:function(e,t,i){this.globe=i,this._cmdEndExecute=t,this._parent(e,{isAsynchronous:!0}),this.intervalID,this.initSkeleton(),this.buildSkeleton()},initSkeleton:function(){void 0!==this.globe.widget.getValue("dateTL")?this.date=new Date(this.globe.widget.getValue("dateTL")):this.date=new Date,void 0!==this.globe.widget.getValue("toggleTL")&&this.globe.globe.terminatorLineManagerITF(this.date,this.globe.widget.getValue("toggleTL")),void 0!==this.globe.widget.getValue("toggleUpdate")&&this.updateForever();var e=(new s).inject(document.body);this.myPanel=new n({immersiveFrame:e,title:"Date & Hour",autoCloseFlag:!1,position:{my:"center",at:"center",of:e}});var r=document.createElement("div");r.setAttribute("id","TerminatorPanel");var l=document.createElement("div");l.setAttribute("id","TimerDiv"),this.myPanel.content=r,this.myToggleButton=new t({type:"switch",label:"Day/Night line",value:!1}).inject(r),this.myToggleUpdate=new t({type:"switch",label:"Auto update to actual date",value:!1}).inject(r),this.myCalendar=new a({domId:"Calendar",value:this.date}).inject(r),this.myCalendar.elements.todayButton.label="Now",r.appendChild(l),this.mySlider=new o({value:60*this.date.getHours()+this.date.getMinutes(),domId:"Slider",minValue:0,maxValue:1439,stepValue:10}).inject(l),this.mySlider.getTextFromValue=function(){},this.myTime=new i({domId:"TimePicker",value:this.date}).inject(l),document.getElementById("TerminatorPanel").style.height="100%",document.getElementById("TerminatorPanel").style.width="190px",document.getElementById("Calendar").style.width="100%",document.getElementById("Calendar").style.marginTop="10px",document.getElementById("TimerDiv").style.alignItems="center",document.getElementById("TimePicker").style.width="60px",document.getElementById("TimePicker").style.display="inline-block",document.getElementById("TimePicker").style.float="left",document.getElementById("Slider").style.width="130px",document.getElementById("Slider").style.display="inline-block",document.getElementById("Slider").style.float="left",void 0!==this.globe.widget.getValue("toggleTL")&&(this.myToggleButton.value=this.globe.widget.getValue("toggleTL"),this.myToggleButton.checkFlag=this.myToggleButton.value),void 0!==this.globe.widget.getValue("toggleUpdate")&&(this.myToggleUpdate.value=this.globe.widget.getValue("toggleUpdate"),this.myToggleUpdate.checkFlag=this.myToggleUpdate.value,1==this.myToggleUpdate.value&&(this.myCalendar.disabled=!0,this.mySlider.disabled=!0,this.myTime.disabled=!0))},buildSkeleton:function(){this.myToggleButton.addEventListener("change",function(){0==this.myToggleButton.value?this.myToggleButton.value=!0:this.myToggleButton.value=!1,this.update()}.bind(this)),this.myToggleUpdate.addEventListener("change",function(){0==this.myToggleUpdate.value?(this.myToggleUpdate.value=!0,this.globe.widget.setValue("toggleUpdate",!0),this.myCalendar.disabled=!0,this.mySlider.disabled=!0,this.myTime.disabled=!0):(this.myToggleUpdate.value=!1,this.globe.widget.setValue("toggleUpdate",!1),this.myCalendar.disabled=!1,this.mySlider.disabled=!1,this.myTime.disabled=!1),this.update()}.bind(this)),this.myCalendarEvent=function(){0!=this.myCalendar.value.getHours()&&0!=this.myCalendar.value.getMinutes()?(this.myCalendar.value.setHours(this.myCalendar.value.getHours()),this.myCalendar.value.setMinutes(this.myCalendar.value.getMinutes())):(this.myCalendar.value.setHours(this.date.getHours()),this.myCalendar.value.setMinutes(this.date.getMinutes())),this.date=this.myCalendar.value,this.update()}.bind(this),this.mySliderEvent=function(){let e=this.mySlider.value,t=Math.floor(e/60),i=e-60*t;this.myCalendar.value.setHours(t),this.myCalendar.value.setMinutes(i),this.date=this.myCalendar.value,this.update()}.bind(this),this.myTimeEvent=function(){this.date.setHours(this.myTime.getHours()),this.date.setMinutes(this.myTime.getMinutes()),this.update()}.bind(this),this.myPanel.addEventListener("close",function(e){this.endExecute()}.bind(this)),this.update()},update:function(){this.myCalendar.removeEventListener("change",this.myCalendarEvent),this.mySlider.removeEventListener("change",this.mySliderEvent),this.myTime.removeEventListener("change",this.myTimeEvent),this.myCalendar.value=this.date,this.myTime.value=new Date,this.myTime.value=this.date,this.mySlider.value=60*this.date.getHours()+this.date.getMinutes(),this.globe.globe.terminatorLineManagerITF(this.date,this.myToggleButton.value),this.globe.widget.setValue("dateTL",this.date),this.globe.widget.setValue("toggleTL",this.myToggleButton.value),this.globe.widget.getValue("toggleUpdate")?void 0===this.intervalID&&(this.intervalID=this.setTheInterval()):void 0!==this.intervalID&&(clearInterval(this.intervalID),delete this.intervalID),this.myCalendar.addEventListener("change",this.myCalendarEvent),this.mySlider.addEventListener("change",this.mySliderEvent),this.myTime.addEventListener("change",this.myTimeEvent)},setTheInterval:function(){return setInterval(function(){this.updateForever()}.bind(this),1e3)},updateForever:function(){this.globe.widget.getValue("toggleUpdate")&&(this.globe.globe.terminatorLineManagerITF(new Date,this.globe.widget.getValue("toggleTL")),this.globe.widget.setValue("dateTL",new Date),void 0!==this.myCalendar&&(this.myCalendar.value=this.globe.widget.getValue("dateTL")))},endExecute:function(){this._cmdEndExecute()}})})),define("DS/SocialGlobe/CmdInteraction",["UWA/Core","DS/ApplicationFrame/Command","UWA/Controls/ToolTip","DS/Usage/TrackerAPI"],(function(e,t,i,o){"use strict";var a=t.extend({init:function(t){this._parent(t,{isAsynchronous:!0}),this.widget=this.getFrameWindow().globe,this.widget.coordinatesInput.setValue(this.widget.widget.getValue("initGeoloc")),this.flagCheck=!1;var o=e.extendElement(this.widget.coordinatesInput.getInputElement());o.oninput||(o.oninput=function(e){e.checkLatLon(this)}.bind(o,this)),this.coordinatesInputToolTip=new i(o,"Should be at (lat,lon) format",{showOver:!1})},beginExecute:function(){this.widget.showInteractionPanel(!0),this.initialLockZoom=this.widget.widget.getValue("allowZoom"),this.widget.globe.globe.use2D?this.initalInitZoom=this.widget.widget.getValue("initDistance2D"):(this.initialRotationSpeed=this.widget.widget.getValue("autoTurn"),this.initialInertia=this.widget.widget.getValue("inertia"),this.initalInitZoom=this.widget.widget.getValue("initDistance"))},execute:function(){this.checkLatLon(this.widget.coordinatesInput.getInputElement())},endExecute:function(){if(this.flagCheck&&this.enableIcon(),this.widget.showInteractionPanel(!1),this.initialLockZoom!=this.widget.widget.getValue("allowZoom")){let e="true"==this.widget.widget.getValue("allowZoom")?1:-1,t=this.widget.globe.globe.use2D?"2D":"3D";o.trackPageEvent({eventCategory:"GlobeViewer:Interaction",eventAction:"InteractionOptionsIsClosed",eventLabel:"LockZoom",eventValue:e,appID:"X3DGLOB_AP",tenant:this.widget.widget.data.x3dPlatformId,persDim:{pd1:t},scope:"Dashboard"})}let e=this.widget.globe.globe.use2D?this.widget.widget.getValue("initDistance2D"):this.widget.widget.getValue("initDistance");if(this.initalInitZoom!=e){let t=this.widget.globe.globe.use2D?e:100*e,i=this.widget.globe.globe.use2D?"2D":"3D";o.trackPageEvent({eventCategory:"GlobeViewer:Interaction",eventAction:"InteractionOptionsIsClosed",eventLabel:"InitialZoom",eventValue:t,appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:i},scope:"Dashboard"})}this.widget.globe.globe.use2D||(this.initialRotationSpeed!=this.widget.widget.getValue("autoTurn")&&o.trackPageEvent({eventCategory:"GlobeViewer:Interaction",eventAction:"InteractionOptionsIsClosed",eventLabel:"RotationSpeed",eventValue:100*parseFloat(this.widget.widget.getValue("autoTurn")),appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:"3D"},scope:"Dashboard"}),this.initialInertia!=this.widget.widget.getValue("inertia")&&o.trackPageEvent({eventCategory:"GlobeViewer:Interaction",eventAction:"InteractionOptionsIsClosed",eventLabel:"Inertia",eventValue:parseInt(this.widget.widget.getValue("inertia")),appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:"3D"},scope:"Dashboard"}))},disableIcon:function(){var e=this;WUX.Events.publish({event:e._evtID+"/DISABLE",data:e}),WUX.Events.publish({event:e._globalEvtID+"/DISABLE",data:e}),e.flagCheck=!0},enableIcon:function(){var e=this;WUX.Events.publish({event:e._evtID+"/ENABLE",data:e}),WUX.Events.publish({event:e._globalEvtID+"/ENABLE",data:e}),e.flagCheck=!1,this.coordinatesInputToolTip.hide()},checkLatLon:function(e){""!==e.value?/^-?\d{1,2}(\.\d+)?,(-?\d{1,3}(\.\d+)?)$/i.test(e.value)?(e.removeClassName("input-coordinates-warning"),this.enableIcon(),this.coordinatesInputToolTip.hide()):(e.addClassName("input-coordinates-warning"),this.disableIcon(),this.coordinatesInputToolTip.show({x:"right",y:"top"},!1)):(e.removeClassName("input-coordinates-warning"),this.enableIcon(),this.coordinatesInputToolTip.hide())}});return e.namespace("SocialGlobe/CmdInteraction",a)})),define("DS/SocialGlobe/CmdSave",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Usage/TrackerAPI"],(function(e,t,i,o,a){"use strict";var r=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.saveAll();console.log(e),console.log(this.widget.widget.getValue("context")),i.handleSuccess(o.get("GlobeViewer.Save.Notification.Save"),o.get("GlobeViewer.Save.Notification.DataSaveSuccessfully"));var t=0,r=0;e.features.map((function(e){"Point"==e.geometry.type?t+=1:"Polygon"==e.geometry.type&&(r+=1)}));let s=this.widget.globe.globe.use2D?"2D":"3D";a.trackPageEvent({eventCategory:"GlobeViewer:Data",eventAction:"ClickOnSaveCommand",eventLabel:"SaveCommand",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:s},persVal:{pv1:t,pv2:r},scope:"Dashboard"}),this.end()}});return e.namespace("SocialGlobe/CmdSave",r)})),define("DS/SocialGlobe/Mesh",["DS/SocialGlobe/Renderable","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],(function(e,t,i,o){"use strict";var a=e.extend({init:function(e,t,i,o){this.scene=e,this.texCoords=[],this.texDim=[],this._parent(e),this.vertexTmp=[],this.normalTmp=[],this.texCoordsTmp=[],this.facesTmp=[],this.clue=t,this.passID=o,this.pickIndex=i>=0?i:-1},setMaterial:function(e){this.threeMaterial=e||new t.MeshLambertMaterial({color:65280})},setPickMaterial:function(e){this.threePickMaterial=e},setVisibility:function(e){this.v6Node.setVisibility(e)},setColorRGB:function(e,i){this.threeMaterial.updatePDSFXUniform(e,new t.Vector4(i[0],i[1],i[2],1)),this.threeMaterial.force=!0},setColorRGBA:function(e,i){this.threeMaterial.updatePDSFXUniform(e,new t.Vector4(i[0],i[1],i[2],1)),this.threeMaterial.force=!0},addVertex:function(e,t,i,o,a,r,s){var n;if(0===this.vertexTmp.length&&s)for(n=0;n<s.length;n++)this.texDim.push(s[n].length);this.vertexTmp.push([e,t,i]),this.normalTmp.push([o,a,r]),this.texCoordsTmp.push(s)},addFace:function(e){this.facesTmp.push(e)},endMesh:function(e){if(this.threeMaterial){if(this.v6Node=this.buildMesh(this.scene.v6SceneGraph,this.threeMaterial),e.pickable)switch(e.pickable){case"pickable":this.v6Node.setPickable(o.PICKABLE);break;case"occulting":this.v6Node.setPickable(o.NOPICKABLE);break;default:this.v6Node.setPickable(o.PICKTHROUGH)}else this.v6Node.setPickable(o.PICKTHROUGH);this.clue&&(this.v6Node.clue=this.clue),this.passID&&this.v6Node.setRenderPasses([this.passID]),this.v6Node.DSSocialGlobeMesh=this}},buildMesh:function(e,t){var r,s,n,l,d,c,h,u,g,p,m,f,v,b,w,x;for((r=new o.PrimitiveGroup).fillAttr=new o.FillAttributes,r.lineAttr=new o.LineAttributes,r.pointAttr=new o.PointAttributes,(s=new o.Buffer).size=3*this.vertexTmp.length,s.component=o.VertexComponentEnum.POSITION,s.format=o.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(n=new o.Buffer).indexBuffer=!0,n.size=3*this.facesTmp.length,n.format=o.DataTypeEnum.UINT,n.dimension=1,n.data=new Uint16Array(n.size),(l=new o.Buffer).size=3*this.texCoordsTmp.length,l.component=o.VertexComponentEnum.TEX_COORD_0,l.format=o.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(l.size),(d=new o.Buffer).indexBuffer=!0,d.size=3*this.facesTmp.length,d.format=o.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(d.size),(c=new o.Buffer).size=3*this.vertexTmp.length,c.component=o.VertexComponentEnum.NORMAL,c.format=o.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(s.size),(h=new o.Buffer).indexBuffer=!0,h.size=3*this.facesTmp.length,h.format=o.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(d.size),g=0,p=0,m=0,m=0;m<this.vertexTmp.length;m++)c.data[g]=this.normalTmp[m][0],s.data[g++]=this.vertexTmp[m][0],c.data[g]=this.normalTmp[m][1],s.data[g++]=this.vertexTmp[m][1],c.data[g]=this.normalTmp[m][2],s.data[g++]=this.vertexTmp[m][2],l.data[p++]=this.texCoordsTmp[m][0][0],l.data[p++]=this.texCoordsTmp[m][0][1],l.data[p++]=0;for(u=0,m=0;m<this.facesTmp.length;m++)d.data[u]=this.facesTmp[m][0],h.data[u]=this.facesTmp[m][0],n.data[u++]=this.facesTmp[m][0],d.data[u]=this.facesTmp[m][1],h.data[u]=this.facesTmp[m][1],n.data[u++]=this.facesTmp[m][1],d.data[u]=this.facesTmp[m][2],h.data[u]=this.facesTmp[m][2],n.data[u++]=this.facesTmp[m][2];return r.addBuffer(0,s),r.addBuffer(1,l),r.addBuffer(2,n),r.addBuffer(3,d),r.addBuffer(4,c),r.addBuffer(5,h),(f=new o.Primitive).nbIndices=3*this.facesTmp.length,f.connectivity=o.ConnectivityTypeEnum.TRIANGLES,0,(v=new o.VertexComponent).component=o.VertexComponentEnum.POSITION,v.nbVertices=this.vertexTmp.length,v.nbValuesPerVertex=3,v.format=o.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=0,v.indices=new o.IndexArray,v.indices.format=o.DataTypeEnum.UINT,v.indices.bufferId=2,v.indices.offset=0,(b=new o.VertexComponent).component=o.VertexComponentEnum.TEX_COORD_0,b.nbVertices=this.texCoordsTmp.length,b.nbValuesPerVertex=3,b.format=o.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new o.IndexArray,b.indices.format=o.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,(w=new o.VertexComponent).component=o.VertexComponentEnum.NORMAL,w.nbVertices=this.vertexTmp.length,w.nbValuesPerVertex=3,w.format=o.DataTypeEnum.FLOAT,w.cardinality=0,w.bufferId=4,w.indices=new o.IndexArray,w.indices.format=o.DataTypeEnum.UINT,w.indices.bufferId=5,w.indices.offset=0,f.addVertexComponent(v),f.addVertexComponent(b),f.addVertexComponent(w),r.addPrimitive(f),(x=i.createMeshNode(r,t)).name="DSSocialglobeMesh"+a.nameCounter,a.nameCounter++,x},onMouseOver:function(){this.threeMesh.material=this.threeMaterial_highlight},onMouseOut:function(){this.threeMesh.material=this.threeMaterial},updateMaterial:function(e,t){if(this.threeMaterial.uniforms)this.updateMaterialOriginal(e,t);else{var i="uMixProj",o=this.threeMaterial.getPDSFXUniform(i),a="uZoom",r="uAspectRatio";o&&this.threeMaterial.updatePDSFXUniform(i,e),(o=this.threeMaterial.getPDSFXUniform(a))&&this.threeMaterial.updatePDSFXUniform(a,this.scene.camera.getZoomCoeff()),(o=this.threeMaterial.getPDSFXUniform(r))&&this.threeMaterial.updatePDSFXUniform(r,t)}},dispose:function(){this.threeMaterial.uniform.OSMTexture&&this.threeMaterial.uniform.OSMTexture.dispatchEvent({type:"dispose"}),this.threeMaterial.dispose()}});return a.nameCounter=0,a})),define("DS/SocialGlobe/Marker",["UWA/Class","DS/SocialGlobe/Globals","marked/marked","DS/SocialGlobe/assets/purify/purify.min"],(function(e,t,i,o){"use strict";return e.extend({init:function(e,i,o,a,r,s,n,l,d,c){this.setPositionFromLatLon(e,i,o),this.level=n,this.fid=d,this.color=t.convertColorCode(a),this.colorBackup=t.convertColorCode(a),this.colorOverride=void 0,this.title=r,this.point_count=l,this.description=s,this.popup=void 0,this.image=void 0,this.onclick=void 0,this.ondoubleclick=void 0,this.onmouseover=void 0,this.html=void 0,this.link=void 0,this.width=void 0,this.height=void 0,this.persist=!1,this.uuid=void 0,c?(c.popup&&(this.popup=c.popup),c.image&&(this.image=c.image),c.onclick&&(this.onclick=c.onclick),c.ondoubleclick&&(this.ondoubleclick=c.ondoubleclick),c.onmouseover&&(this.onmouseover=c.onmouseover),c.html&&(this.html=c.html),c.link&&(this.link=c.link),c.width&&(this.width=c.width),c.height&&(this.height=c.height),c.descriptionType?this.descriptionType=c.descriptionType:this.link?this.descriptionType="html":this.descriptionType="text",c.persist&&(this.persist=c.persist),c.uuid&&(this.uuid=c.uuid)):this.descriptionType="text",this.position=t.latlonToXYZ(e,i,o),this.id=-1},type:"Marker",getID:function(e){return this.id},setId:function(e){this.id=e},getTitle:function(){return this.title},getDescription:function(){return this.description},htmlContent:function(){if("marked"===this.descriptionType)return this.htmlEncode(i(this.description));if(void 0!==this.html)return this.htmlEncode(this.html);var e=(void 0!==this.title&&""!==this.title?"<b>"+this.title+"</b><br>":"")+this.description;return this.htmlEncode(e)},htmlDefined:function(){return void 0!==this.html},htmlEncode:function(e){return o.sanitize(e)},textToHTML:function(e){var t=function(){if(!window.DOMParser)return!1;var e=new DOMParser;try{e.parseFromString("x","text/html")}catch(e){return!1}return!0}();if(t)return(new DOMParser).parseFromString(e,"text/html").body.innerHTML;var i=document.createElement("div");return i.innerHTML=e,i},overrideHtmlColor:function(e){return this.colorOverride=e,this._manager&&!this._manager._clustering&&this._manager.refresh(this),this},setColor:function(e){return this.color=e,this._manager&&!this._manager._clustering&&this._manager.refresh(this),this},setImage:function(e){return this.image=e,this._manager&&!this._manager._clustering&&this._manager.refresh(this),this},getCurrentColor:function(){return this.colorOverride?this.colorOverride:this.color},setPositionFromLatLon:function(e,i,o){this.lat=e,this.lon=i,this.altitude=o,this.position=t.latlonToXYZ(e,i,o)},isValidContent:function(){return void 0!==this.link&&""!==this.link||void 0!==this.title&&""!==this.title||void 0!==this.description&&""!==this.description}})})),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIMarkerCountryCreator",["UWA/Class","DS/SocialGlobe/Globals","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],(function(e,t,i){"use strict";return e.extend({init:function(e,t){this._parent(t),this.options=t,this.enable=!1,this.manager=e,this.arraySelectName=[],this.selection=[],this.container=this.buildSkeleton(),this._evtID="/SG/UICE/CMD/"+t.ID},buildSkeleton:function(){var e;this.options;switch(this.options.ID){case"ColorMarker":a=i.get("GlobeViewer.Marker.Create.Notification.Title"),e=i.get("GlobeViewer.Marker.Create.Notification.Action.Label");break;case"ColorArea":a=i.get("GlobeViewer.Areas.Create.Notification.Title"),e=i.get("GlobeViewer.Areas.Create.Notification.Action.Label")}this.container=new UWA.Element("div",{class:"globe-select-dialog"});var t=new UWA.Element("ul",{class:"wux-notification-screen"}).inject(this.container),o=new UWA.Element("div",{class:"wux-notification-container"}).inject(t),a=new UWA.Element("div",{class:"wux-notification-title",html:a}).inject(o);return this.label=new UWA.Element("a",{class:"wux-notification-action",html:e,target:"_blank",events:{click:this.options.showSelectorUI.bind(this)}}).inject(o),this.container},setCountry:function(e){e&&this.options.cmdEndSelect&&this.options.cmdEndSelect(e)},setMarker:function(e){e&&this.options.cmdEndSelect&&this.options.cmdEndSelect(e)}})})),define("DS/SocialGlobe/CmdTerminatorLine",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/TerminatorLineUI","DS/SocialGlobe/UIMarkerCountryCreator","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/CoreEvents/Events","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Usage/TrackerAPI"],(function(e,t,i,o,a,r,s,n,l,d){"use strict";var c=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this.widget=this.getFrameWindow().globe},beginExecute:function(){},execute:function(){this.TerminatorLineUI?this.TerminatorLineUI.myPanel.show():this.createUI()},createUI:function(){this.TerminatorLineUI=new i({ID:"CustoCountry2D"},this.end.bind(this),this.widget)},endExecute:function(){this.TerminatorLineUI.myPanel.hide()}});return e.namespace("SocialGlobe/CmdEditArea2D",c)})),define("DS/SocialGlobe/MarkerInfo",["UWA/Class","DS/SocialGlobe/Globals","UWA/Controls/Web","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Usage/TrackerAPI"],(function(e,t,i,o,a,r){"use strict";return e.extend({init:function(e,t){this.markerPanelDisplayed=!1,this.markerPanel=new UWA.Element("div",{styles:{position:"absolute",zIndex:5e4,display:"none",overflow:"hidden"},events:{resize:this.resize.bind(this)}}).inject(e,"top"),this.panelDimensions=t},resize:function(){!this.markerPanel.isHidden()&&this.control&&(this.control.getIFrame().width=this.markerPanel.style.width,this.control.getIFrame().height=this.markerPanel.style.height,this.control.width=this.markerPanel.style.width,this.control.height=this.markerPanel.style.height)},show:function(e,t,i,o=!1,a=!0){if(this.markerPanelDisplayed=e,this.markerPanel.empty(),e&&t&&t.isValidContent()){if(a&&this.isValidLink(t)&&t.persist)return;var s=new UWA.Element("div",{html:t.htmlContent(),class:"marked"===t.descriptionType?"remove-uwa-styles":""});this.markerPanel.addContent(s);var n=t.width?t.width+"px":"100%",l=t.height?t.height+"px":"100%",d=t&&t.width?t.width+"px":"",c=t&&t.height?t.height+"px":"";void 0===t.ID?r.trackPageEvent({eventCategory:"GlobeViewer:Marker/Area",eventAction:"ClickOnMarkerInView",eventLabel:"SelectMarkerInView",appID:"X3DGLOB_AP",tenant:this.actualTenantUWA,persDim:{pd1:"3D"},scope:"Dashboard"}):"number"==typeof t.ID&&r.trackPageEvent({eventCategory:"GlobeViewer:Marker/Area",eventAction:"ClickOnAreaInView",eventLabel:"SelectAreaInView",appID:"X3DGLOB_AP",tenant:this.actualTenantUWA,persDim:{pd1:"3D"},scope:"Dashboard"}),this.panelDimensions&&void 0!==this.panelDimensions.width&&void 0!==this.panelDimensions.height&&(d=n=this.panelDimensions.width-10+"px",c=l=this.panelDimensions.height-10+"px"),this.isValidLink(t)&&(this.markerPanel.empty(),this.control=new UWA.Controls.Web({url:t.link,width:d,height:c,withMessage:!0}),this.controlMarker=t,o||this.markerPanel.setStyle("resize","both"),this.control.elements.loadingMessage.hide(),this.markerPanel.addContent(this.control),this.markerPanel.style.height=l,this.markerPanel.style.width=n,this.markerPanel.style.left="0",this.markerPanel.style.top="0",this.markerPanel.style.display="block"),t.htmlDefined()?(this.markerPanel.style.height=l,this.markerPanel.style.width=n,this.markerPanel.style.left="0",this.markerPanel.style.top="0",this.markerPanel.style.display="block"):(this.markerPanel.style.height=c,this.markerPanel.style.width=d,this.markerPanel.style.left=i[0]+"px",this.markerPanel.style.top=i[1]+"px",this.markerPanel.style.display="block"),"marked"===t.descriptionType&&(this.markerPanel.setStyle("resize","both"),this.markerPanel.setStyle("overflow","auto"))}else this.markerPanel.style.display="none",this.control=null,this.markerPanel.setStyle("resize","none"),this.markerPanel.setStyle("overflow","hidden")},changeSkin:function(e,t){this.markerPanel.className="natural"},getID:function(e){return this.id},setId:function(e){this.id=e},isValidLink:function(e){return"html"===e.descriptionType&&e.link&&UWA.Utils.isValidUrl(e.link)}})})),define("DS/SocialGlobe/MarkerInfoManager",["UWA/Core","UWA/Class","DS/SocialGlobe/MarkerInfo","DS/Windows/ImmersiveFrame","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],(function(e,t,i,o,a,r){"use strict";return t.singleton({init:function(t){this._parent(t),this.markerInfos={},this.immersiveFrame=new o({identifier:"WebUIImmersiveFrame_MarkerInfoManager"}),this.frmWindow=void 0,this.widget=void 0,this.highlightedObject=void 0,this.webUXMarkerIdentifier="WUXPanel_Marker"+Math.round(1e5*Math.random()),this.webUXCountryIdentifier="WUXPanel_Country"+Math.round(1e5*Math.random()),this.container=new e.Element("div"),this.immersiveFrame.inject(this.container)},setFrameWindow:function(e){this.frmWindow=e;var t=this.frmWindow.getUIFrame();this.container.inject(t,"top")},getFrameWindow:function(){return this.frmWindow},setWidget:function(e){this.widget=e},getWidget:function(e){return this.widget},isValidLink:function(t){return"html"===t.descriptionType&&t.link&&e.Utils.isValidUrl(t.link)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},createMarker:function(t,o,r){var s=this,n=new e.Element("div",{styles:{width:r.width?r.width+"px":"100%",height:r.height?r.height+"px":"100%"}});r.uuid=r.uuid?r.uuid:this.uuidv4();var l=r.width?parseInt(r.width)+10:0,d=r.height?parseInt(r.height)+10:0,c=r.uuid,h=new a({title:t,immersiveFrame:this.immersiveFrame,content:n,width:l,height:d,resizableFlag:!0,movableFlag:!0,floatableFlag:!0,collapsibleFlag:!1,pinnedFlag:!1,closeButtonFlag:!1,snappableFlag:!1,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,identifier:c});if(this.hasNoPanelPreference(h)){var u=this.frmWindow.globe.getPanelPreference(c);this.updatePanelOptions(h,u)}var g={width:h.width,height:h.height},p=new i(n,g);return h.addEventListener("close",this.removeMarkerInfo.bind(this,o,!0)),h.addEventListener("resize",(function(e){var t=e.dsModel.width-10,i=e.dsModel.height-10;p.markerPanel.style.width=t+"px",p.markerPanel.style.height=i+"px",p.resize(),s.updatePanelPreferences(c,e.dsModel)})),h.addEventListener("stopWindowDrag",(function(e){s.updatePanelPreferences(c,e.dsModel)})),h.addEventListener("stopResize",(function(e){var t=e.dsModel.width-10,i=e.dsModel.height-10;s.updateMarkerDimensions(r,t,i)})),h.addEventListener("mousedown",(function(e){s.highlightFrame(r),s.frmWindow.globe.getGlobe().setSelection([r])})),h.windowGroup&&h.windowGroup.addEventListener("mousedown",(function(e){var t=e.path[0].innerText,i=s.getMarkerInfoByName(t);i&&(s.highlightFrame(i.controlMarker),s.frmWindow.globe.getGlobe().setSelection([i.controlMarker]))})),{id:o,immersiveFrame:this.immersiveFrame,panelContent:n,panel:h,container:this.container,markerInfo:p}},addMarkerInfo:function(e,t=!1){e.uuid=e.uuid?e.uuid:this.uuidv4();var i=e.uuid;this.removeMarkerInfo(i);var o=e.title;t&&(o=r.get("GlobeViewer.Countries.ISO3."+o));var a=this.createMarker(o,i,e);return a.markerInfo.setId(i),a.markerInfo.show(!0,e,[0,0],!0,!1),this.markerInfos[i]=a,a},removeMarkerInfo:function(e,t){if(this.markerInfos[e]){var i=this.getMarkerPanelId(this.markerInfos[e]);this.frmWindow.globe.removePanelPreference(i),this.markerInfos[e].markerInfo.show(!1,void 0,null),this.markerInfos[e].markerInfo.markerPanel.empty(),t||this.markerInfos[e].panel.close(),this.highlightedObject&&this.highlightedObject.id===e&&(this.highlightedObject=void 0),delete this.markerInfos[e]}},highlightFrame:function(e){if(this.clearHighlight(),e){var t=e.uuid?e.uuid:e.getID(),i=this.markerInfos[t];i.panel.elements.container.addClassName("highlight-container"),i.panel.windowGroup&&i.panel.windowGroup.elements.container.addClassName("highlight-container"),i.panel.ensureVisible(),i.panel.bringToFront(),this.highlightedObject=i}},clearHighlight:function(){this.highlightedObject&&(this.highlightedObject.panel.elements.container.removeClassName("highlight-container"),this.highlightedObject.panel.windowGroup&&this.highlightedObject.panel.windowGroup.elements.container.removeClassName("highlight-container"))},getMarkerInfoByName:function(e){for(var t in this.markerInfos)if(this.markerInfos.hasOwnProperty(t)&&this.markerInfos[t]&&this.markerInfos[t].markerInfo.controlMarker.title===e)return this.markerInfos[t].markerInfo},getMarkerPanelId:function(e){return e.panel.identifier},resetAll:function(){for(var e in this.markerInfos)this.markerInfos.hasOwnProperty(e)&&this.markerInfos[e]&&this.removeMarkerInfo(e,!1)},updateMarkerDimensions:function(e,t,i){e&&(e.width=t,e.height=i,this.frmWindow.globe.saveMarker(e))},updatePanelPreferences:function(e,t){if(t){var i=t.position.offsetX,o=t.position.offsetY,a={id:e,width:t.width,height:t.height,offsetX:i,offsetY:o};this.frmWindow.globe.updatePanelPreference(e,a)}},updatePanelOptions:function(e,t){t&&(e.position.offsetX=t.offsetX,e.position.offsetY=t.offsetY,e.width=t.width,e.height=t.height,e.fire("move"))},hasNoPanelPreference:function(e){return void 0===e._getPositionFromPreferences()&&void 0===e._getDimensionsFromPreferences()}})})),define("DS/SocialGlobe/CmdReset",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/MarkerInfoManager","DS/Usage/TrackerAPI"],(function(e,t,i,o,a,r){"use strict";var s=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.globe=this.getFrameWindow().globe},execute:function(){this.globe.helpDisplayed&&this.globe.displayHelp(!1),this.globe.options.use2D?(this.globe.clearGeoJSONData(),this.globe.clearGeoJSONFieldsPref(),this.globe.clearGeoJSONInput(),this.globe.getGlobe().unclusteredLayerGroup=null):(this.globe.clearCountries(),this.globe.clearMarkers(),a.resetAll()),this.globe.clearDrivePreferences(),this.globe.removeAllPanelPreferences(),i.handleSuccess(o.get("GlobeViewer.Reset.Notification.Reset"),o.get("GlobeViewer.Reset.Notification.DataResetSuccessfully"));let e=this.globe.globe.globe.use2D?"2D":"3D";r.trackPageEvent({eventCategory:"GlobeViewer:Data",eventAction:"ClickOnResetCommand",eventLabel:"ResetCommand",appID:"X3DGLOB_AP",tenant:this.globe.actualTenantUWA,persDim:{pd1:e},scope:"Dashboard"}),this.end()}});return e.namespace("SocialGlobe/CmdReset",s)})),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIMarkerSelector",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/CoreEvents/Events","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/GlobeNotifications","DS/Controls/ColorPicker","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/MarkerInfoManager"],(function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m,f,v,b){"use strict";return t.extend({init:function(e,t){this._parent(t),this.options=t,this.enable=!1,this.globe=e,this.container=this.buildSkeleton(),this.noContainerRemove=!0,this.globe&&this.globe.markerAdditionOnClick&&this.globe.markerAdditionOnClick(!1),this._evtID="/SG/UICE/CMD/"+t.ID},buildSkeleton:function(){this.options;return this.panelContent=new UWA.Element("div",{class:"globe-panel-select",styles:{width:"100%",height:"100%"}}),this.buildLatLonInputs(this.panelContent),this.panel=new n({immersiveFrame:b.immersiveFrame,title:l.get("GlobeViewer.Marker.Create.Select.title"),content:this.panelContent,allowedDockAreas:0,identifier:"WUXPanel_MarkerSelector_"+b.webUXMarkerIdentifier}),this.addButtons(this.panelContent),this.panel.addEventListener("close",this.options.cmdEndExecute),b.container},buildLatLonInputs:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Latitude"),styles:{width:"50px"}}).inject(t),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(t));this.leLatitude=new UWA.Controls.Input.Text({attributes:{type:"number",min:"-85.0",max:"85.0"}}).inject(i);var o=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),a=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Longitude"),styles:{width:"50px"}}).inject(o),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(o));this.leLongitude=new UWA.Controls.Input.Text({attributes:{type:"number",min:"-180.0",max:"180.0"}}).inject(a)},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new v({label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i)},validateInputs:function(){var e=this.leLatitude.getValue(),t=this.leLongitude.getValue();return void 0===e||""===e||isNaN(e)||parseFloat(e)<-85||parseFloat(e)>85?{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLatitude"))}:void 0===t||""===t||isNaN(t)||parseFloat(t)<-180||parseFloat(t)>180?{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLongitude"))}:{ok:!0}},apply:function(){var e=this.validateInputs();if(e.ok){var t={lat:parseFloat(this.leLatitude.getValue()),lon:parseFloat(this.leLongitude.getValue())};return this.options.cmdEndSelect(t,!0),globe.use2D&&this.globe.flyToLatLon(t.lat,t.lon),this.options.cmdEndExecute(),this.panel.close(),!0}var i=e.error;return i.title=l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InputError"),i.subtitle=l.get("GlobeViewer.Marker.Create.Select.Notification.Error.ContentAdditionError"),d.display({level:"error",title:i.title,subtitle:i.subtitle,message:i.message}),!1}})})),define("DS/SocialGlobe/CmdAddMarker",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UIMarkerSelector","DS/SocialGlobe/UIMarkerCountryCreator","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker"],(function(e,t,i,o,a,r,s){"use strict";var n="/SG/UICE/CMD/",l=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},showSelectorUI:function(){this.widget.topBars.MarkerSelector=new i(this.widget.getGlobe(),{ID:"SelectMarker",cmdEndExecute:this.end.bind(this),cmdEndSelect:this.widget.getGlobe().use2D?this.editMarker2D.bind(this):this.editMarker.bind(this)}),this.widget.setTopBar("MarkerSelector")},editMarker:function(e){var t=this.widget.addMarker(e.lat,e.lon,0,"#ff0000","","",{});this.widget.getGlobe().setSelection([t]),this.done(),this.end(),WUX.Events.publish({event:n+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},editMarker2D:function(e){var t=this.widget.addMarker2D(e);this.done(),this.end(),WUX.Events.publish({event:n+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},addMarker:function(e){var t=this.widget.addMarker(e);this.done(),this.end(),WUX.Events.publish({event:n+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},addMarker2D:function(e){var t=this.widget.addMarker2D(e);this.done(),this.end(),WUX.Events.publish({event:n+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.widget.getGlobe().use2D?(this.widget.getGlobe().markerAdditionOnClick(!0),console.log("toggling polygon and marker popup to false"),this.widget.getGlobe().polygonPopupOnClick(!1),this.widget.getGlobe().markerPopupOnClick(!1)):this.widget.getGlobe().clearSelection(),this.widget.topBars.Marker=new o(this.widget.getGlobe(),{ID:"ColorMarker",cmdEndExecute:this.end.bind(this),cmdEndSelect:this.widget.getGlobe().use2D?this.editMarker2D.bind(this):this.editMarker.bind(this),showSelectorUI:this.showSelectorUI.bind(this)}),this._topBar=this.widget.topBars.Marker},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.getGlobe();this.widget.setTopBar("Marker");var t=this;if(this.widget.getGlobe().use2D)e.map.on("click",(function(i){e.map.markerAdditionOnClick&&(e.markerAdditionOnClick(!1),e.markerDetailsOnClick(!1),t.addMarker2D(i.latlng))}));else{e.clearMouseOver();e.markerBag;var i={onMouseMove:function(t,i,o){t.length?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseOut:function(){},onMouseDoubleClick:function(e,t,i){},onMouseClick:function(e,i,o){if(e.length)t._topBar.setMarker(e[0]),t.widget.getGlobe().setSelection(e);else{var s=t.getFrameWindow().getViewerFrame(),n={lat:0,lon:0};if(t.widget.mode2d){var l=.97*s.clientWidth,d=360*((i-s.clientWidth/2)/s.clientWidth),c=l/1.5,h=((c-s.clientHeight)/2+o-c/2)/c,u=0;0!==h&&(u=-h/Math.abs(h)*this.computeLatWithYclick(Math.abs(h))),n={lat:u,lon:d}}else{var g=new a.Projector,p=new a.Vector3(i/s.clientWidth*2-1,-o/s.clientHeight*2+1,0),m=g.pickingRay(p,t.widget.getGlobe().camera.threeCamera).ray,f=m.origin,v=m.direction,b=new a.Vector3(0,0,0).sub(f),w=b.dot(v);b.copy(v).multiplyScalar(w).add(f);var x=b.lengthSq();if(x>1)return;var y=w-Math.sqrt(1-x),C=v.clone().multiplyScalar(y).add(f);n=r.XYZToLatlon(C)}t.editMarker(n)}},computeLatWithYclick:function(e){return e<.089655?20*e/.089655:e<.189655?20+20*(e-.089655)/.1:e<.327585?40+20*(e-.189655)/.13793:60+15*(e-.327585)/.172415},onClearCountries:function(){}};this.widget.setMouseOverCountryManager(),this.widget.setMouseOverMarkersManager(i);var o=t.widget.getGlobe().getSelection();o.length&&"Marker"===o[0].type&&t._topBar.setMarker(o[0]),e.markerInfo.show(!1,void 0,null)}},endExecute:function(){this.widget.getGlobe().use2D?(globe.markerAdditionOnClick(!1),globe.markerPopupOnClick(!0),globe.polygonPopupOnClick(!0)):(this.widget.getGlobe().clearMouseOver(),this.widget.getGlobe().clearSelection()),this.widget.setTopBar()}});return e.namespace("SocialGlobe/CmdAddMarker",l)})),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIMarkerEditor",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/CoreEvents/Events","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Controls/ColorPicker","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/GlobeNotifications","DS/Controls/Popup","DS/SocialGlobe/UIMarkerSelector","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/assets/purify/purify.min","DS/Usage/TrackerAPI"],(function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m,f,v,b,w,x,y,C){"use strict";return t.extend({init:function(e,t,i,o,a,r){this._parent(t),this.options=t,this.enable=!1,this.globe=e,this.arraySelectName=[],this.selection=[],this.deleteMode={marker:!0,country:!1},this._cmdEndExecute=i,this._cmdSelectArea=o,this._runByCreatedMarkerCmd=r,this.container=this.buildSkeleton(),this._evtID="/SG/UICE/CMD/"+t.ID,this.noContainerRemove=!0,this.selectedMarker=a,this.globe.use2D?(this.draggingEnabled=!1,this.applyOnClose=!1,void 0!==a?(this.initialLat=a._latlng.lat,this.initialLong=a._latlng.lng):(this.initialLat=-1,this.initialLong=-1)):void 0!==a?(this.initialLat=a.lat,this.initialLong=a.lon):(this.initialLat=-1,this.initialLong=-1),this.setMarker(a)},buildSkeleton:function(){this.options;this.panelContent=new UWA.Element("div",{styles:{width:"100%",height:"100%"}});var e=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.panelContent),t=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Color"),styles:{width:"5em"}}).inject(e),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-color"}).inject(e));this.globe.use2D?(this.leMarkerColor=new d({value:"143E5A",styles:{background:"#143E5A"}}).inject(t),this.leMarkerColor.addEventListener("liveChange",function(e){var t=this.selectedMarker.options.uuid;document.getElementById(t).setAttribute("fill","#"+e.dsModel.value)}.bind(this))):this.leMarkerColor=new d({value:"ffffff"}).inject(t);var i=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.panelContent),o=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Edit.Name"),styles:{width:"5em"}}).inject(i),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(i));return this.leName=new UWA.Controls.Input.Text({id:"markername"}).inject(o),this.buildLatLonInputs(this.panelContent),this.buildDescriptionSkeletun(this.panelContent),this.panel=new n({immersiveFrame:x.immersiveFrame,title:l.get("GlobeViewer.Marker.Edit.title"),content:this.panelContent,allowedDockAreas:0,snappableFlag:!1,identifier:"WUXPanel_MarkerEditor_"+x.webUXMarkerIdentifier}),this.panel.bringToFront(),this.addButtons(this.panelContent),this.globe.use2D&&this.panel.addEventListener("close",function(){if([...document.querySelectorAll('[wux-identifier^="WUXPanel_MarkerEditor_"]')].length<2&&(this.globe.openedEditMarker=!1),!this.applyOnClose&&!this._runByCreatedMarkerCmd){var e=this.selectedMarker.options.uuid;document.getElementById(e).setAttribute("fill",this.selectedMarker.style_properties.color)}}.bind(this)),this._runByCreatedMarkerCmd&&(this.panel.addEventListener("close",this._cmdEndExecute),this.globe.use2D&&this.panel.addEventListener("close",function(){this.validateInputs().ok&&this.applyOnClose?this.selectedMarker&&this.selectedMarker.dragging.disable():this.globe.map.removeLayer(this.selectedMarker)}.bind(this))),x.container},buildLatLonInputs:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block"}}).inject(e),i=new UWA.Element("li",{class:"wux-controls-switch-label",styles:{width:"5em"}}).inject(t);new UWA.Element("b",{html:l.get("GlobeViewer.Marker.Edit.Geolocation")}).inject(i);if(this.globe.use2D){var o=new c({type:"switch",label:"Edit coordinates by dragging",checkFlag:this.draggingEnabled}).inject(t);o.addEventListener("change",function(e){this.draggingEnabled=o.checkFlag,this.draggingEnabled?this.selectedMarker.dragging.enable():this.selectedMarker.dragging.disable()}.bind(this))}var a=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),r=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Latitude"),styles:{width:"5em"}}).inject(a),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(a));this.globe.use2D?this.leLatitude=new UWA.Controls.Input.Text({id:"latitude",attributes:{type:"number",min:"-85.0",max:"85.0"},events:{onChange:function(e){var t=new L.LatLng(parseFloat(e.target.value),parseFloat(this.leLongitude.getValue()));this.selectedMarker.setLatLng(t)}.bind(this)}}).inject(r):this.leLatitude=new UWA.Controls.Input.Text({id:"latitude",attributes:{type:"number",min:"-85.0",max:"85.0"}}).inject(r);var s=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),n=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Longitude"),styles:{width:"5em"}}).inject(s),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(s));this.globe.use2D?this.leLongitude=new UWA.Controls.Input.Text({id:"longitude",attributes:{type:"number",min:"-180.0",max:"180.0"},events:{onChange:function(e){var t=new L.LatLng(parseFloat(this.leLatitude.getValue()),parseFloat(e.target.value));this.selectedMarker.setLatLng(t)}.bind(this)}}).inject(n):this.leLongitude=new UWA.Controls.Input.Text({id:"longitude",attributes:{type:"number",min:"-180.0",max:"180.0"}}).inject(n)},addTextInputs:function(e){this.textDiv=new UWA.Element("div").inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.textDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Text"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(t));this.leMarkerDesc=new UWA.Controls.Input.Text({id:"markerdescription",attributes:{placeholder:"Desc..."}}).inject(i);new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","min-height":"50px"}}).inject(this.textDiv)},addMarkedInputs:function(e){this.markedDiv=new UWA.Element("div",{styles:{display:"None"}}).inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.markedDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.TextArea"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(t));this.leMarkerMarkdown=new UWA.Element("textarea",{styles:{resize:"vertical",width:"14.7em","min-height":"83px"},attributes:{placeholder:"Desc..."}}).inject(i)},addHtmlInputs:function(e){this.htmlDiv=new UWA.Element("div",{styles:{display:"None"}}).inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.htmlDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.URL"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-help"}).inject(t));this.htmlURLText=new UWA.Controls.Input.Text({id:"markerurl",attributes:{placeholder:"URL...",type:"url"}}).inject(i);var o=new UWA.Element("span",{html:"",class:"uwa-input-button display-help-button",styles:{background:"url("+u.getWebappsAssetUrl("SocialGlobe","icons/32/I_CFHelp.png")+")"}}).inject(i);this.buildHelpSkeletun(o);var a=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","min-height":"50px"}}).inject(this.htmlDiv),r=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{"padding-bottom":"10px",display:"inline-block","max-width":"14em"}}).inject(a),s=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Width"),styles:{width:"4em"}}).inject(r),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-inline-double"}).inject(r));this.leWidthDesc=new UWA.Controls.Input.Text({id:"iframe-width",attributes:{type:"number",step:"1"},value:"300"}).inject(s);var n=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{"padding-bottom":"10px",display:"inline-block","max-width":"14em"}}).inject(a),d=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Height"),styles:{width:"4em"}}).inject(n),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-inline-double"}).inject(n));this.leHeightDesc=new UWA.Controls.Input.Text({id:"iframe-height",attributes:{type:"number",step:"1"},value:"300"}).inject(d);var h=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.htmlDiv);this.persistToggle=new c({type:"switch",label:l.get("GlobeViewer.Marker.Edit.PersistFrame"),checkFlag:!1}),this.persistToggle.inject(h)},buildHelpSkeletun:function(e){var t=new UWA.Element("div",{class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}),i=l.get("GlobeViewer.Areas.Edit.Help.URL");new UWA.Element("p",{html:i,class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(t);return new b({target:e,trigger:"click"}).setBody(t)},buildDescriptionSkeletun:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block"}}).inject(e),i=new UWA.Element("li",{class:"wux-controls-switch-label",styles:{width:"5em"}}).inject(t),o=(new UWA.Element("b",{html:l.get("GlobeViewer.Areas.Editor.Description.Group")}).inject(i),new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e)),a=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type"),styles:{width:"5em"}}).inject(o),new UWA.Element("li").inject(o));this.descriptionTypeButtonGroup=new h({type:"radio"}).inject(a);var r=new c({type:"radio",class:"country-inline",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Text"),value:0,checkFlag:!0});r.elements.container.classList.add("country-inline");var s=new c({type:"radio",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Html"),value:1});s.elements.container.classList.add("country-inline");var n=new c({type:"radio",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Marked"),value:2});n.elements.container.classList.add("country-inline"),this.descriptionTypeButtonGroup.addChild(r),this.descriptionTypeButtonGroup.addChild(s),this.descriptionTypeButtonGroup.addChild(n),this.descriptionTypeButtonGroup.addEventListener("change",function(e){var t=e.dsModel.value[0];1==t?(this.textDiv.hide(),this.markedDiv.hide(),this.htmlDiv.show()):2==t?(this.textDiv.hide(),this.htmlDiv.hide(),this.markedDiv.show()):(this.markedDiv.hide(),this.htmlDiv.hide(),this.textDiv.show())}.bind(this)),this.addTextInputs(e),this.addHtmlInputs(e),this.addMarkedInputs(e)},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new f({domId:"apply-button",label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i),new f({label:l.get("GlobeViewer.Areas.Editor.Remove"),emphasize:"secondary",onClick:this.remove.bind(this)}).inject(i)},setMarker:function(e){if(this.globe.use2D&&e.on("drag",function(){this.leLatitude.setValue(e._latlng.lat.toFixed(5)),this.leLongitude.setValue(e._latlng.lng.toFixed(5))}.bind(this)),e){switch(this.selectedMarker=e,this.leName.setValue(e.title?e.title:""),this.globe.use2D?(this.leLatitude.setValue(e._latlng.lat.toFixed(5)),this.leLongitude.setValue(e._latlng.lng.toFixed(5))):(this.leLatitude.setValue(e.lat.toFixed(5)),this.leLongitude.setValue(e.lon.toFixed(5))),e.descriptionType){case"text":this.descriptionTypeButtonGroup.selectIndex(0);break;case"html":this.descriptionTypeButtonGroup.selectIndex(1);break;case"marked":this.descriptionTypeButtonGroup.selectIndex(2)}"text"===e.descriptionType?this.leMarkerDesc.setValue(e.description?e.description:""):"marked"===e.descriptionType&&(this.leMarkerMarkdown.value=e.description?e.description:""),this.htmlURLText.setValue(e.link?e.link:""),this.leWidthDesc.setValue(e.width?e.width:"300"),this.leHeightDesc.setValue(e.height?e.height:"300");void 0!==o.theme?o.theme:o.defaultTheme;var t=e.image;if(t||(t=u.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/natural/marker/markerBack128.png")),this.globe.use2D){var i="#143E5A";e&&e.style_properties.color&&(i=e.style_properties.color)}else{i="#ff0000";e&&e.color&&(i=e.color)}this.leMarkerColor.value=i.replace("#",""),this.persistToggle.checkFlag=e.persist}else this.selectedMarker=void 0,this.leName.setValue(""),this.leLatitude.setValue(""),this.leLongitude.setValue(""),this.leMarkerDesc.setValue(""),this.htmlURLText.setValue(""),this.leWidthDesc.setValue("300"),this.leHeightDesc.setValue("300"),this.leMarkerMarkdown.value="",this.persistToggle.checkFlag=!1},remove:function(){this.globe.use2D?(this.selectedMarker&&(this.selectedObject=this.selectedMarker,this.objectType="marker"),this.globe.map.removeLayer(this.selectedObject),0==this.globe.getMarkersNb()&&this._cmdEndExecute()):(this.selectedMarker.persist&&x.removeMarkerInfo(this.selectedMarker.uuid,!1),this.globe.getDataModel().deleteSelection([this.selectedMarker],this.deleteMode),this.clearDescriptionInputs(),0===this.globe.markerBag.getMarkersSize()&&this._cmdEndExecute()),this.panel.close();let e=this.globe.use2D?"2D":"3D";C.trackPageEvent({eventCategory:"GlobeViewer:Marker/Area",eventAction:"ClickOnRemoveCommand",eventLabel:"RemoveCommand",appID:"X3DGLOB_AP",tenant:this.globe.actualTenantGlobe,persDim:{pd1:e,pd2:"Marker"},scope:"Dashboard"})},validateInputs:function(){if(this.selectedMarker){var e=this.leLatitude.getValue(),t=this.leLongitude.getValue();if(void 0===e||""===e||isNaN(e)||parseFloat(e)<-85||parseFloat(e)>85)return{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLatitude"))};if(void 0===t||""===t||isNaN(t)||parseFloat(t)<-180||parseFloat(t)>180)return{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLongitude"))}}if(!this.htmlEncode(this.leName.getValue()))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidName"))};var i=this.descriptionTypeButtonGroup;if(1==i.value[0]){var o=this.htmlEncode(this.htmlURLText.getValue()),a=this.htmlEncode(this.leWidthDesc.getValue()),r=this.htmlEncode(this.leHeightDesc.getValue());this.htmlEncode(this.leName.getValue());if(void 0!==o&&!UWA.Utils.isValidUrl(o)||!o&&(""!==a||""!==r))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidLink"))};if(void 0!==a&&isNaN(a))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidWidth"))};if(void 0!==r&&isNaN(r))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidHeight"))}}else if(2==i.value[0]){var s=this.leMarkerMarkdown.value;if(void 0!==s&&!UWA.is(s,"string"))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidDescription"))};if(void 0!==(n=this.htmlEncode(s))&&!UWA.is(n,"string"))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidDescription"))};this.leMarkerMarkdown.value=n}else{var n=this.leMarkerDesc.getValue();if(void 0!==(n=this.htmlEncode(n))&&!UWA.is(n,"string"))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidDescription"))}}return{ok:!0}},apply:function(){var e=this.validateInputs();if(this.selectedMarker&&(this.selectedObject=this.selectedMarker,this.objectType="marker"),e.ok){if(this.selectedObject){if(this.globe.use2D){if(this.selectedObject.style_properties.color="#"+this.leMarkerColor.value,this.currentUuid=this.selectedObject.options.uuid,"marker"===this.objectType)document.getElementById(this.currentUuid).setAttribute("fill",this.selectedObject.style_properties.color)}else this.selectedMarker.setColor("#"+this.leMarkerColor.value);this.selectedObject.title=this.htmlEncode(this.leName.getValue());var t=this.descriptionTypeButtonGroup;if(1===t.value[0]?(this.selectedObject.descriptionType="html",this.selectedObject.link=this.htmlEncode(this.htmlURLText.getValue()),this.selectedObject.width=this.leWidthDesc.getValue(),this.selectedObject.height=this.leHeightDesc.getValue()):2===t.value[0]?(this.selectedObject.descriptionType="marked",this.selectedObject.description=this.leMarkerMarkdown.value,this.selectedObject.width=void 0,this.selectedObject.height=void 0):(this.selectedObject.descriptionType="text",this.selectedObject.description=this.htmlEncode(this.leMarkerDesc.getValue()),this.selectedObject.width=void 0,this.selectedObject.height=void 0),this.globe.use2D){if(this.selectedObject.getPopup()?this.globe.editPopup(this.selectedObject):this.globe.setBehavior(this.selectedObject),"marker"===this.objectType){var i=new L.LatLng(parseFloat(this.leLatitude.getValue()),parseFloat(this.leLongitude.getValue()));this.selectedObject.setLatLng(i)}this.applyOnClose=!0,this.selectedObject.dragging.disable()}else this.selectedMarker.setPositionFromLatLon(parseFloat(this.leLatitude.getValue()),parseFloat(this.leLongitude.getValue())),this.selectedObject.persist&&x.removeMarkerInfo(this.selectedObject.uuid,!1),this.selectedObject.persist=this.persistToggle.checkFlag,this.selectedObject.isEdited=!0,1===this.descriptionTypeButtonGroup.value[0]&&this.persistToggle.checkFlag&&x.addMarkerInfo(this.selectedObject)}if(void 0!==this.selectedMarker){let e=this.globe.use2D?"2D":"3D",i=this.initialLat.toFixed(5)==this.leLatitude.getValue()&&this.initialLong.toFixed(5)==this.leLongitude.getValue()?0:1,o=void 0===this.selectedObject.width?0:parseInt(this.selectedObject.width),a=void 0===this.selectedObject.height?0:parseInt(this.selectedObject.height);C.trackPageEvent({eventCategory:"GlobeViewer:Marker/Area",eventAction:"ClickOnApplyCommand",eventLabel:"ApplyCommand",eventValue:t.value[0]+1,appID:"X3DGLOB_AP",tenant:this.globe.actualTenantGlobe,persDim:{pd1:e,pd2:"Marker",pd3:this.selectedObject.descriptionType},persVal:{pv1:o,pv2:a,pv3:i},scope:"Dashboard"})}this.panel.close()}else{var o=e.error;o.title=l.get("GlobeViewer.Marker.Edit.Notification.Error.InputError"),o.subtitle=l.get("GlobeViewer.Areas.Edit.Notification.Error.ContentAdditionError"),v.display({level:"error",title:o.title,subtitle:o.subtitle,message:o.message})}return e.ok},clearDescriptionInputs:function(){this.descriptionTypeButtonGroup.selectIndex(0),this.htmlURLText.setValue(void 0),this.leWidthDesc.setValue(void 0),this.leHeightDesc.setValue(void 0),this.leMarkerDesc.setValue(void 0),this.persistToggle.checkFlag=!1,this.leMarkerMarkdown.value=""},clearSelection:function(){var e=this;this.selection.map((function(t){-1===e.manager.getSelectedCountries().indexOf(t)&&t.setHtmlColor(null)})),this.selection=[]},getColor:function(){return this.leMarkerColor.value},htmlEncode:function(e){return y.sanitize(e)}})})),define("DS/SocialGlobe/CmdEditMarker",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UIMarkerEditor","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/CoreEvents/Events","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/GlobeNotifications","DS/Usage/TrackerAPI"],(function(e,t,i,o,a,r,s,n,l){"use strict";var d=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this.runByCreatedMarkerCmd=!1,this.widget=this.getFrameWindow().globe;var t=this;WUX.Events.subscribe({event:"/SG/UICE/CMD//ColorMarker/EDIT"},(function(e){if(!t.widget.getGlobe().use2D){if(!e||!e.marker)return;t.widget.getGlobe().setSelection([e.marker])}e.fromCreateMarker?(t.runByCreatedMarkerCmd=!0,t.createUI(e.marker),t.begin()):t.widget.getGlobe().use2D&&t.createUI(e.marker)}))},selectArea:function(e){this.widget.getGlobe().setSelection([e])},createUI:function(e){var t=this.widget.getGlobe();this.widget.topBars.MarkerEditor=new i(t,{ID:"EditMarker"},this.end.bind(this),this.selectArea.bind(this),e,this.runByCreatedMarkerCmd),this._topBar=this.widget.topBars.MarkerEditor,t.openedEditMarker=!0},beginExecute:function(){var e=this.widget.getGlobe();if(e.use2D){var t=e.getMarkersNb();if(e.markerDetailsOnClick(!0),e.markerPopupOnClick(!1),e.polygonPopupOnClick(!1),!this.runByCreatedMarkerCmd)if(!t)(i=new Error(s.get("GlobeViewer.Marker.Info.Edit.NoDataError"))).title=s.get("GlobeViewer.Marker.Info.Edit.CreateDataError"),i.subtitle=s.get("GlobeViewer.Marker.Info.Edit.NoSelectedError"),n.display({level:"info",title:i.title,subtitle:i.subtitle,message:i.message}),this.end(),this.done()}else{var i;t=e.markerBag.getMarkersSize();if(!this.runByCreatedMarkerCmd&&!t)(i=new Error(s.get("GlobeViewer.Marker.Info.Edit.NoDataError"))).title=s.get("GlobeViewer.Marker.Info.Edit.CreateDataError"),i.subtitle=s.get("GlobeViewer.Marker.Info.Edit.NoSelectedError"),n.display({level:"info",title:i.title,subtitle:i.subtitle,message:i.message}),this.end(),this.done();this.runByCreatedMarkerCmd&&(this.runByCreatedMarkerCmd=!1)}},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.getGlobe();e.clearMouseOver(),this.widget.setTopBar("MarkerEditor");var t=this;if(!e.use2D){e.markerBag;var i={onMouseMove:function(t,i,o){t.length?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseOut:function(){},onMouseDoubleClick:function(e,t,i){},onMouseClick:function(e,i,o){e.length&&(t.createUI(e[0]),t.widget.setTopBar("MarkerEditor"),t._topBar.setMarker(e[0]),t.widget.getGlobe().setSelection(e),l.trackPageEvent({eventCategory:"GlobeViewer:Marker/Area",eventAction:"ClickOnEditCommand",eventLabel:"EditCommand",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:"3D",pd2:"Marker"},scope:"Dashboard"}))}.bind(this),computeLatWithYclick:function(e){return e<.089655?20*e/.089655:e<.189655?20+20*(e-.089655)/.1:e<.327585?40+20*(e-.189655)/.13793:60+15*(e-.327585)/.172415},onClearCountries:function(){}};this.widget.setMouseOverCountryManager(),this.widget.setMouseOverMarkersManager(i);var o=t.widget.getGlobe().getSelection();o.length&&"Marker"===o[0].type&&t._topBar&&t._topBar.setMarker(o[0]),e.markerInfo.show(!1,void 0,null)}},endExecute:function(){var e=this.widget.getGlobe();e.use2D?(e.markerDetailsOnClick(!1),e.markerPopupOnClick(!0),e.polygonPopupOnClick(!0)):(e.clearMouseOver(),e.clearSelection()),this.widget.setTopBar(),this.runByCreatedMarkerCmd&&(this.runByCreatedMarkerCmd=!1)}});return e.namespace("SocialGlobe/CmdEditMarker",d)})),define("DS/SocialGlobe/CmdPublish",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UIMarkerEditor","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker"],(function(e,t,i,o,a,r){"use strict";var s=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.widget.widget.setValue("editMode","false")},execute:function(){},endExecute:function(){this.widget.widget.setValue("editMode","true")}});return e.namespace("SocialGlobe/CmdPublish",s)})),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIFieldsChoice",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/CoreEvents/Events","UWA/Controls/Input","DS/Windows/ImmersiveFrame","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/GlobeNotifications","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/assets/purify/purify.min"],(function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m,f){"use strict";return t.extend({init:function(e,t,i,o,a){this._parent(i),this.options=i,this.enable=!1,this.widget=e,this.globe=t,this.validated=!1,this._cmdEndExecute=o,this.geojson=a,this.container=this.buildSkeleton(),this.noContainerRemove=!0},buildSkeleton:function(){this.options;this.fieldsContainer=new UWA.Element("div"),console.log(this.widget),this.frmWindow=this.widget.frmWindow;var e=this.frmWindow.getUIFrame();return this.fieldsContainer.inject(e,"top"),this.immersiveFrame=new s({}),this.immersiveFrame.inject(this.fieldsContainer),this.panelContent=new UWA.Element("div",{class:"globe-panel-select",styles:{width:"100%",height:"100%"}}),this.buildTitleDescriptionInputs(this.panelContent),this.panel=new n({immersiveFrame:this.immersiveFrame,title:"GeoJSON Fields Chooser",content:this.panelContent,position:{my:"center",at:"center"},allowedDockAreas:0,identifier:"WUXPanel_FieldsChooser_"+m.webUXMarkerIdentifier}),this.addButtons(this.panelContent),this.panel.addEventListener("close",function(){this.onFieldsChooserClose()}.bind(this)),this.fieldsContainer},buildTitleDescriptionInputs:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Title",styles:{width:"50px","padding-right":"15px"}}).inject(t),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(t));this.arraySelectTitle=new u;for(var o=Object.keys(this.geojson.features[0].properties).sort(),a=0;a<o.length;a++){(n=o[a])&&this.arraySelectTitle.addChild(new g({label:n,value:n}))}this.arraySelectTitle.expandAll(),this.titleField=new h({enableSearchFlag:!0,elementsTree:this.arraySelectTitle,displayStyle:"normal",selectedIndex:-1!=this.options.titleIndex?this.options.titleIndex:0}).inject(i);var r=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),s=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Description",styles:{width:"50px","padding-right":"15px"}}).inject(r),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(r));this.arraySelectDesc=new u;for(o=Object.keys(this.geojson.features[0].properties).sort(),a=0;a<o.length;a++){var n;(n=o[a])&&this.arraySelectDesc.addChild(new g({label:n,value:n}))}this.arraySelectDesc.expandAll(),this.descriptionField=new h({enableSearchFlag:!0,elementsTree:this.arraySelectDesc,displayStyle:"normal",selectedIndex:-1!=this.options.descIndex?this.options.descIndex:0}).inject(s)},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new p({label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i)},validateInputs:function(){this.chosenTitle=this.htmlEncode(this.titleField.value),this.chosenDescription=this.htmlEncode(this.descriptionField.value);var e=this.chosenTitle,t=this.chosenDescription;return void 0===e||""===e?{ok:!1,error:new Error("Please choose a field for features title")}:void 0===t||""===t?{ok:!1,error:new Error("Please choose a field for features description")}:{ok:!0}},onFieldsChooserClose:function(){this._cmdEndExecute?this._cmdEndExecute:this.validated||widget.setValue("3DDriveGeoJSONManagement","")},apply:function(){var e=this.validateInputs();if(e.ok){if(this.globe.use2D){this._cmdEndExecute?(this._cmdEndExecute(),this.from3DDrive=!1):this.from3DDrive=!0,this.chosenFields={chosenTitle:this.chosenTitle,chosenDescription:this.chosenDescription,from3DDrive:this.from3DDrive};var t=widget.getPreference("jsonFieldsPrefURL").value,i=widget.getPreference("jsonFieldsPref3DDrive").value;0==this.from3DDrive?t=this.chosenFields:i=this.chosenFields,widget.setValue("jsonFieldsPrefURL",t),widget.setValue("jsonFieldsPref3DDrive",i),0==this.from3DDrive?this.loadOptions=widget.getPreference("jsonFieldsPrefURL").value:this.loadOptions=widget.getPreference("jsonFieldsPref3DDrive").value,this.globe.loadGeoJSON(this.geojson,!0,this._current6wtags,this.globe._taggerProxy,this.loadOptions)}else this.globe.loadGeoJSON(this.geojson,!0,this._current6wtags,this.globe._taggerProxy);return this.from3DDrive&&d.display({level:"success",title:l.get("GlobeViewer.DragAndDrop.Notification.DragAndDropSuccess"),subtitle:l.get("GlobeViewer.DragAndDrop.Notification.DragAndDropSuccessfulLoad",{name:this.options.name}),message:l.get("GlobeViewer.AddContent.Notification.GeojsonSuccessfulload")}),this.validated=!0,this.panel.close(),!0}var o=e.error;return o.title="Field Selector Error",o.subtitle=l.get("GlobeViewer.Marker.Create.Select.Notification.Error.ContentAdditionError"),d.display({level:"error",title:o.title,subtitle:o.subtitle,message:o.message}),!1},htmlEncode:function(e){return f.sanitize(e)}})})),define("DS/SocialGlobe/CmdImportFile",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/UIFieldsChoice"],(function(e,t,i,o){"use strict";var a=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0});var t=this;WUX.Events.subscribe({event:"/SG/UICE/CMD//Geojson/IMPORT"},(function(e){e.geojson&&t.createChoiceUI(e.geojson)}))},createChoiceUI:function(e){var t=Object.keys(e.features[0].properties).sort().indexOf("title"),i=Object.keys(e.features[0].properties).sort().indexOf("description");this.widget.topBars.FieldsChoice=new o(this.widget,this.widget.getGlobe(),{ID:"GeojsonFieldsChoice",titleIndex:t,descIndex:i},this.end.bind(this),e),this._topBar=this.widget.topBars.FieldsChoice},beginExecute:function(){this.widget=this.getFrameWindow().globe,console.log(this.widget),this.widget.widget.getValue("feedUrl")&&""!==this.widget.widget.getValue("feedUrl")&&this.widget.georssInput.setValue(this.widget.widget.getValue("feedUrl")),this.widget.widget.getValue("jsonFile")&&""!==this.widget.widget.getValue("jsonFile")&&(this.widget.geojsonInput.setValue(this.widget.widget.getValue("jsonFile")),this.widget.getGlobe().use2D||this.widget.georssInput.setDisabled(!0)),this.widget.showLoadDataPanel(!0)},execute:function(){console.log("import file")},endExecute:function(){this.widget.showLoadDataPanel(!1)},resetManualData:function(){this.widget.clearCountries(),this.widget.clearMarkers(),this.widget.clearDrivePreferences(),i.resetAll(),this.widget.removeAllPanelPreferences(),this.widget.saveAll()}});return e.namespace("SocialGlobe/CmdImportFile",a)})),define("DS/SocialGlobe/MessageDispatcher",["UWA/Class","DS/SocialGlobe/Globals","UWA/Class/Listener"],(function(e,t,i){"use strict";return e.extend(i,{init:function(e,t,i,o){this.globe=e,this.dispatch=i,this.listen=o,this.widget=t,this.globe.getGlobe().addEvent("zoomEvent",this.emitZoom.bind(this)),this.globe.getGlobe().camera.addEvent("cameraMoveStart",this.emitCameraMoveStart.bind(this)),this.globe.getGlobe().camera.addEvent("cameraMoveEnd",this.emitCameraMoveEnd.bind(this)),this.globe.getGlobe().addEvent("emitMessage",this.emitMessage.bind(this)),this.listen.addListener("GlobeViewer.Marker.add",this.addMarkerEvent.bind(this)),this.listen.addListener("GlobeViewer.Marker.clear",this.clearMarkersEvent.bind(this)),this.listen.addListener("GlobeViewer.Country.add",this.addCountryEvent.bind(this)),this.listen.addListener("GlobeViewer.Country.clear",this.clearCountriesEvent.bind(this)),this.listen.addListener("GlobeViewer.Camera.move",this.cameraMoveEvent.bind(this)),this.listen.addListener("GlobeViewer.loadJSON",this.loadJSONEvent.bind(this))},addMarkerEvent:function(e){var t=e.text.split(",");this.globe.addMarker(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),t[3],t[4],t[5])},clearMarkersEvent:function(e){this.globe.clearMarkers()},addCountryEvent:function(e){var t=e.text.split(","),i=this.globe.getCountryManager().get(this.globe.getCountryManager().getIndexFromISO3(t[0]));i.setHtmlColor(t[1]),i.description=t[2]},clearCountriesEvent:function(e){this.globe.clearCountries()},cameraMoveEvent:function(e){var t=e.text.split(",");3===t.length&&this.globe.turnGlobeToLatLon(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))},loadJSONEvent:function(e){this.globe.displayJSONData(!0,e.text)},emitZoom:function(){var e=this.globe.getGlobe().getBBox(),t=e.point.lat+" "+e.point.lon+" "+e.distance+" "+this.globe.getGlobe().camera.level+" "+this.globe.getGlobe().camera.dist;this.sendMessage("Globe.Camera.Zoom",t)},emitCameraMoveStart:function(){var e=this.globe.getGlobe().getBBox(),t=e.point.lat+" "+e.point.lon+" "+e.distance+" "+this.globe.getGlobe().camera.level;this.sendMessage("Globe.Camera.MoveStart",t)},emitCameraMoveEnd:function(){var e=this.globe.getGlobe().getBBox(),t=e.point.lat+" "+e.point.lon+" "+e.distance+" "+this.globe.getGlobe().camera.level;this.sendMessage("Globe.Camera.MoveEnd",t)},emitMessage:function(e){this.sendMessage(e.key,e.text)},sendMessage:function(e,t){void 0!==this.widget.environment.socket&&this.widget.environment.socket.dispatchEvent(e,{widgetID:this.widget.id,text:t})}})})),define("DS/SocialGlobe/Camera",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Vector2"],(function(e,t,i){"use strict";return e.extend({init:function(e,o){this.lat=0,this.lon=0,this.renderer=e,this.camPosition=new i(t.lon2tileFlt(this.lon,0),t.lat2tileFlt(this.lat,0)),this.minlevel=2,this.maxlevel=o?t.localTilesMaxLevel:17,this.level=0,this.dist=8,this.mindist=1.0001,this.maxdist=15,this.zoomCoeff=.3,this.deltaXCamera=0,this.deltaYCamera=0,this.lastTime=-1,this.autoTurn=0,this.moveToStart=null,this.moveToVector=null,this.moveToDistance=null,this.moveToStartTime=-1,this.moveToDuration=500,this.zoomAllowed=!0,this.changed=!1},moveToLatLon:function(e,t){this.moveToStartTime=(new Date).getTime(),this.moveToStart={lat:this.lat,lon:this.lon,dist:this.dist};var i=e.lon-this.lon;i>180?i-=360:i<-180&&(i+=360),t&&(t=Math.max(t,this.mindist),this.moveToDistance=t-this.dist),this.moveToVector={deltaLat:e.lat-this.lat,deltaLon:i}},correctLon:function(e){return(e%=360)<-180?e+360:e>180?e-360:e},correctLat:function(e){return(e%=360)<-180?e+360:e>180?e-360:e},autoMove:function(){var e,o,a=(new Date).getTime(),r=!1;this.autoTurn&&(e=this.lastTime>0?a-this.lastTime:0,this.lon-=360*this.autoTurn*e/6e4,this.lon=this.correctLon(this.lon),r=!0),this.moveToVector&&((e=a-this.moveToStartTime)>=this.moveToDuration?(e=this.moveToDuration,this.lat=this.moveToStart.lat+this.moveToVector.deltaLat,this.lon=this.moveToStart.lon+this.moveToVector.deltaLon,this.dist=this.moveToStart.dist+this.moveToDistance,this.moveToStart=null,this.moveToVector=null,this.moveToDistance=null,this.moveToStartTime=-1):(o=Math.sin(Math.PI/2*e/this.moveToDuration),this.lat=this.moveToStart.lat+o*this.moveToVector.deltaLat,this.lon=this.moveToStart.lon+o*this.moveToVector.deltaLon,null!==this.moveToDistance&&(this.dist=this.moveToStart.dist+this.moveToDistance*e/this.moveToDuration)),this.lon=this.correctLon(this.lon),r=!0),r&&(this.camPosition=new i(t.lon2tileFlt(this.lon,0),t.lat2tileFlt(this.lat,0)),this.updateCamera()),this.lastTime=a},setDelta:function(e,t){this.deltaXCamera=e,this.deltaYCamera=t,this.updateCamera()},getMoveFactor:function(){return 1},allowZoom:function(e){this.zoomAllowed=e},zoom:function(e,t){this.zoomAllowed&&(this.dist=t?1+(this.dist-1)*(1+e):1+(this.dist-1)*(1+e/Math.abs(e)*this.zoomCoeff),this.dist=Math.max(this.mindist,this.dist),this.dist=Math.min(this.maxdist,this.dist),this.changed=!0)},getTileTab:function(){var e,i=[];for(e=0;e<20;e++)i.push({tx:t.lon2tileFlt(this.lon,e),ty:t.lat2tileFlt(this.lat,e)});return i}})})),define("DS/SocialGlobe/Halo3D",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/SocialGlobe/ShaderTools"],(function(e,t,i,o,a,r){"use strict";return e.extend({init:function(e){this.scene=e,this.color="#efefff",this.intensity=.12;var i=t.htmlToRGB(this.color);this.haloShader_PDSFX={attributes:{},uniforms:{uColor:{type:"v4",value:new o.Vector4(i[0],i[1],i[2],1)},uIntensity:{type:"f",value:this.intensity},uMixProj:{type:"f",value:.5}},varyings:{vTextureCoord:{type:"v3"}},VS_overridableFunctions:{ComputeObjectPosition:["vec4 texCoord = vGetAttribTexCoord0();","mat4 mvMat = vGetViewMatrix() * modelMatrix;","vec3 up = vec3(mvMat[0][0], mvMat[1][0], mvMat[2][0]);","    vec3 right = vec3(mvMat[0][1], mvMat[1][1], mvMat[2][1]);","    vec3 posi = 2.0*texCoord.xy.x*right + 2.0*texCoord.xy.y*up;","    vTextureCoord = posi;","return posi;"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["   vec3 cameraPos = vGetWorldEyePos();","   vec3 vdir  = vTextureCoord.xyz - cameraPos;","   float d = length(cross(cameraPos, vdir))/length(vdir) - 1.0;","    bool neg = d < 0.0;","    ","    float uStartRadius = 1.0;","    float uEndRadius = 1.05;","   float sigma = uEndRadius - uStartRadius;","    float ddd = (neg ? 2.0 : 1.0)*(1.0+d - uStartRadius)/sigma;","    float k = 0.75*exp(-0.5*ddd*ddd)*uIntensity;","    ","   ioFinalColor = vec4(uColor.rgb, (1.0-sqrt(uMixProj))*k);"].join("\n")}}},createMesh:function(){var e=new i(this.scene,"halo"),t=this.createHaloMaterial();return e.setMaterial(t),e.setPickMaterial(new o.MeshBasicMaterial({color:16711935})),e.addVertex(0,0,0,0,0,0,[[-1,-1,0]]),e.addVertex(0,0,0,0,0,0,[[1,-1,0]]),e.addVertex(0,0,0,0,0,0,[[1,1,0]]),e.addVertex(0,0,0,0,0,0,[[-1,1,0]]),e.addFace([0,2,1]),e.addFace([3,2,0]),e.endMesh({depth:1,pickable:"invisible"}),e},createHaloMaterial:function(){var e=r.getPDSFXMaterial([this.haloShader_PDSFX],"physical");return e.depthTest=!1,e.transparent=!0,e.side=o.FrontSide,e.forceSide=!0,e.force=!0,e}})})),define("DS/SocialGlobe/Renderer3D",["DS/SocialGlobe/Globals","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Renderer","DS/Visualization/WebGLV6Viewer","DS/Visualization/Node3D","DS/Visualization/OccurrencePath","DS/SocialGlobe/RenderPassManager"],(function(e,t,i,o,a,r,s){"use strict";return i.extend({init:function(e,t,i,r,n){this._parent(e,t,i,r,n),this.pickCanvas=n,this.wantedProjection=!1,this.started=!1,this.meshes=[],this.visibleMeshes=[],this.switchToProjection(!1),this.lastProjection=!1,this.mixProjA=0,this.mixProjASpeed=Math.PI/500,this.mixProj=Math.cos(this.mixProjA),this.lastTime=-1,this.v6Viewer=new o({div:t,antiAliasing:"FSAA",useShadowMap:!1,infinitePlane:!1,displayGrid:!1,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1,autoUpdateFrustum:!1,backgroundAlpha:0}),this.canvas=this.v6Viewer.canvas,this.v6Viewer.setVignetting(!1),this.v6Viewer.setToneMapping({enable:!0,gamma:1}),this.v6Viewer.setPicking({activated:!1}),this.v6Viewer.setPrePicking({activated:!1,displayHL:!0,gpu:!0,computeNormalDepth:!1,primitive:!1}),this.v6Viewer.usePostProcessing=!0,this.v6Viewer.usePicking=!1,this.v6SceneGraph=new a(this.v6Viewer.getWebGLContext()),this.v6Viewer.addNode(this.v6SceneGraph),this.renderPassManager=new s(this.v6Viewer.renderer.mainComposer)},switchToProjection:function(e){},setSwitchProjectionModeCB:function(e){this.switchProjectionModeCB=e},setCamera:function(e){this.camera=e,this.v6Viewer.addViewpoint(e.v6Viewpoint)},addClusterNode:function(e){this.visibleMeshes.indexOf(e)<0&&(this.visibleMeshes.push(e),this.v6SceneGraph.add(e))},addObject:function(e){this.visibleMeshes.indexOf(e)<0&&(this.visibleMeshes.push(e),e.v6Node&&(e.v6Node.setVisibility(!0),this.dbgAddRemove&&UWA.log("adding object "+e.clue),this.v6SceneGraph.add(e.v6Node)))},setBackgroundColor:function(e,t){this.v6Viewer.setBackgroundColor(e,t)},pickCountryIndex:function(e,i,o){var a=new t.Vector2(e,i),r=this.v6Viewer.getMousePosition(a),s=this.v6Viewer.pick(r,"mesh",!1);return s&&s.path.length>0&&s.path[0].getLastElement().DSSocialGlobeMesh?s.path[0].getLastElement().DSSocialGlobeMesh.pickIndex:-1},removeClusterNode:function(e){var t=this.visibleMeshes.indexOf(e);t>=0&&(this.visibleMeshes.splice(t,1),this.v6SceneGraph.remove(e))},removeObject:function(e){var t=this.visibleMeshes.indexOf(e);t>=0&&(this.visibleMeshes.splice(t,1),e.v6Node&&(e.v6Node.setVisibility(!1),this.dbgAddRemove&&UWA.log("removing object "+e.clue),this.v6SceneGraph.remove(e.v6Node)))},render:function(){var e,t=(new Date).getTime(),i=(this.lastTime>0&&this.lastTime,this.getCanvas()),o=i.width/i.height;for(this.lastTime=t,this.camera.autoMove(),this.camera.updateCamera(),this.mixProj=1-.5*(1+Math.cos(this.mixProjA)),e=0;e<this.visibleMeshes.length;e++)this.visibleMeshes[e].updateMaterial&&this.visibleMeshes[e].updateMaterial(this.mixProj,o);this.v6Viewer.render()},getCanvas:function(){return this.v6Viewer.canvas},getMarkerSize:function(){return.0125*this.canvas.height},getRenderPassManager:function(){return this.renderPassManager},computeMarkerPositionOnScreen:function(i){var o,a,r,s=this.v6Viewer.SCREEN_WIDTH/this.v6Viewer.SCREEN_HEIGHT;i.screenPosition=null,this.mixProj<1e-4?i.position.dot(this.camera.threeCamera.position)>0&&((o=new t.Vector4(i.position.x,i.position.y,i.position.z,1)).applyMatrix4(this.camera.totalTransfo),a=this.camera.dist-1,(r=new t.Vector2(o.x/o.w,o.y/o.w+1/(a*a))).normalize(),i.screenPosition={x:this.v6Viewer.SCREEN_WIDTH*(.5+.5*o.x/o.w+.02625*r.x/s),y:this.v6Viewer.SCREEN_HEIGHT*(.5-.5*o.y/o.w-.02625*r.y)}):this.mixProj>.9999&&(i.screenPosition={x:this.canvas.width*e.lon2tileFlt(i.lon,0),y:.5*this.canvas.height*.9475-.5*this.canvas.width+this.canvas.width*e.lat2tileFlt(i.lat,0)})}})})),define("DS/SocialGlobe/TileBag",["UWA/Class","DS/SocialGlobe/Globals"],(function(e,t){"use strict";return e.extend({init:function(e){this.scene=e,this.tileMap={},this.imageMap={},this.beingLoadedImageMap={},this.currentlyLoading=[],this.imageQueue=[],this.firstToDelete=null,this.lastToDelete=null,this.maxLoadingImages=10,this.nbLoadingImages=0,this.imageCounter=0,this.numToDelete=0,this.maxNumToDelete=256}})}));var dataGlobal,clusterFactory=null;define("DS/SocialGlobe/ClusterFactory",["UWA/Class","DS/WAFData/WAFData","DS/SocialGlobe/Globals","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/SocialGlobe/OffscreenCanvas2DNode","DS/SceneGraphNodes/CanvasNodeTexture"],(function(e,t,i,o,a,r,s,n,l,d){"use strict";var c=UWA.Class.extend({init:function(){this.drawing=new Image;var e=void 0!==i.theme?i.theme:i.defaultTheme,t=o.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/"+e+"/marker/");this.drawing.src=t+"markerColor.png",this.drawing.onload=function(){console.log("loaded")}},measure:function(e){var t=document.createElement("canvas").getContext("2d"),i=this.wrapText(t,e,.5*e.style.maxWidth,e.fontHeight);return i.height+=20,i},wrapText:function(e,t,i,o){e.font=t.style.font,e.textAlign=t.style.textAlign;var a=t.fontHeight,r=t.name;return e.strokeText(r,i,30),e.fillText(r,i,30),{width:e.measureText(r).width,height:a}},wrapText2:function(e,t,i,o){e.font=t.style.font,e.textAlign=t.style.textAlign;for(var a=t.fontHeight,r=t.name.split(" "),s="",n=t.style.maxWidth,l=!1,d=0;d<r.length;d++){var c=s+r[d]+" ",h=e.measureText(c).width;n=h,h>t.style.maxWidth&&d>0?(l=!0,e.strokeText(s,i,o),e.fillText(s,i,o),s=r[d]+" ",o+=a):s=c}return e.strokeText(s,i,o),e.fillText(s,i,o),l&&(n=t.style.maxWidth),{width:n,height:o}},build:function(e){e.name;var t=e.pos,i=e.style,o=(e.size,this);var s=new d({width:e.size.width,height:e.size.height,drawCB:function(t,a,r){a.font=i.font,a.textAlign=i.textAlign;var s=t.width,n=t.height;a.fillStyle=i.fillStyle,a.globalAlpha=1,a.strokeStyle="#5d97c1",a.lineWidth=2,a.fillStyle=i.fillStyle;var l,d,c,h=Math.max(25*e.name.length/4,14);l=.5*s,d=.5*n,c=h,a.beginPath(),a.fillStyle="#005685",a.arc(l,d,c,0,2*Math.PI,!1),a.fill(),a.lineWidth=3,a.strokeStyle="#dddddd",a.stroke(),a.strokeStyle="#5d97c1",a.fillStyle=i.fillStyle,o.wrapText(a,e,.5*e.size.width,.5*e.fontHeight)},alphaTest:.02}),c=new l({canvasNodeTexture:s},n);c.setHotspot(new a.Vector2(e.size.width/2,e.size.height/2));var h=new r;h.addChild(c);var u=new a.Matrix4;return u.setPosition(t),h.setMatrix(u),h}});return c.getInstance=function(){return null===clusterFactory&&(clusterFactory=new c),clusterFactory},c.getInstance()})),define("DS/SocialGlobe/GeocodingAndReverse",["UWA/Core","UWA/Class/View","DS/Controls/LineEditor","DS/Controls/ComboBox","DS/Controls/Button","DS/Controls/Loader","DS/Controls/ModalContainer","DS/Controls/TooltipModel","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Tree/TreeListView","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/SocialGlobe/Utils","DS/WAFData/WAFData","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],(function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m){"use strict";function f(e){return e.dsModel?e.dsModel.value:e.currentTarget.dsModel.value}return t.extend({tagName:"div",elements:{},_config:{},_listenWorldClick:!1,_processUserInputTimeout:void 0,_treeDocument:void 0,_worldClickPointLayer:void 0,_addressResultLayer:void 0,_prevValues:{},setup:function(e){this._config={renderID:e.renderID||"",folder:e.folder,domId:e.domId},this._treeDocument=new l({useAsyncPreExpand:!0,shouldAcceptDrag:function(e){return e}}),this._createUIElements(),this._renderUI(),this._setListeners()},_createUIElements:function(){this.elements.title=new e.Element("div",{class:"xct-title",html:"Geocoding / Reverse Geocoding"}),this.elements.inputFreeForm=new i({domId:"xct-geocoding-input",placeholder:"Enter address or coordinates",autoCommitFlag:!0,sizeInCharNumber:34,selectAllOnFocus:!0}),this.elements.loadingIndicator=new r,this.elements.comboInputType=new o({elementsList:[],mainElementVisibleFlag:!1}),this.elements.btnLocator=new a({domId:"locator",type:"check",emphasize:"secondary",showLabelFlag:!1,displayStyle:"icon",iconSize:"1x",icon:{iconName:"location",fontIconFamily:WUXManagedFontIcons.Font3DS}}),this.elements.btnLocator.tooltipInfos=new n({shortHelp:"Locate and get address",longHelp:"Click to toggle then click on desired location on map to get nearest address"}),this.elements.inputComponents=[],this.elements.datagrid=new e.Element("div",{styles:{position:"relative","min-height":"150px"}})},_renderUI:function(t){this.elements.title.inject(this.container);var i=new e.Element("div",{class:"xct-parameter",html:[this.elements.inputFreeForm,new e.Element("i",{class:"xct-geocoding-input-icon wux-ui-3ds wux-ui-3ds-search"})]});this.elements.addressFreeFormContainer=i;var o=new e.Element("div",{domId:"addressComponents",styles:{display:"none"}});this.elements.addressComponentsContainer=o;var a=new e.Element("div",{styles:{display:"flex"},html:[{tag:"div",class:"xct-geocoding-controls",html:[i,o]},{tag:"div",styles:{display:"flex","align-items":"center",height:"24px"},html:[this.elements.comboInputType,new e.Element("div",{class:"xct-separator-vertical"}),this.elements.btnLocator]}]}).inject(this.container);this.elements.controlsContainer=a,new e.Element("div",{class:"xct-separator"}).inject(this.container),this.elements.datagrid.inject(this.container)},_setListeners:function(){this.elements.btnLocator.addEventListener("buttonclick",this._onLocateButtonClick.bind(this)),this.elements.inputFreeForm.addEventListener("click",this._onInputFieldClick.bind(this)),this.elements.inputFreeForm.addEventListener("change",this._onFreeFormInputValueChange.bind(this)),this.elements.comboInputType.addEventListener("change",this._onComboInputTypeChange.bind(this))},_onInputFieldClick:function(e){f(e);this._listenWorldClick=!1,this.elements.btnLocator.checkFlag=!1},_onFreeFormInputValueChange:function(e){var t=f(e).trim();(function(e){return isNaN(e)?e.trim().length>=3:e.length>0})(t)&&(clearTimeout(this._processUserInputTimeout),this._clearAddressResultPoints(),this._processUserInputTimeout=setTimeout(this._processFreeFormUserInput.bind(this,t),1e3))},_onLocateButtonClick:function(e){this._listenWorldClick?(this.elements.btnLocator.checkFlag=!1,this._listenWorldClick=!1):(this.elements.btnLocator.checkFlag=!0,this._listenWorldClick=!0,this._launchClicks())},_onComboInputTypeChange:function(e){switch(f(e)){case"free-form":this.elements.addressFreeFormContainer.show(),this.elements.addressComponentsContainer.hide();break;case"components":this.elements.addressFreeFormContainer.hide(),this.elements.addressComponentsContainer.show()}},_locatorReverseGeocode:function(e){if(this._listenWorldClick){this.elements.datagrid.empty(),this._toggleLoading(!0),this._clearAddressResultPoints(),e.lat=parseFloat(e.lat.toFixed(1)),e.lon=parseFloat(e.lon.toFixed(1)),this.elements.inputFreeForm.disabled=!0,this.elements.inputFreeForm.value=e.lat+", "+e.lon,this.elements.inputFreeForm.disabled=!1;this._reverseGeocodeNominatimPromise(e,{limit:10}).then(this._processReverseGeocodingResponse.bind(this,e),this._displayError.bind(this,"3DXCity.GeocodingAndReverse.Error.Generic"))}},_inputReverseGeocode(e){this._toggleLoading(!1),this.elements.datagrid.empty(),e={x:parseFloat(e[0]),y:parseFloat(e[1]),z:parseFloat(e[2]||0)}},_processReverseGeocodingResponse:function(e,t){e.lat=parseFloat(e.lat.toFixed(1)),e.lon=parseFloat(e.lon.toFixed(1)),this._prevValues=e,this._listenWorldClick=!1,this.elements.btnLocator.checkFlag=!1,this._toggleLoading(!1),this._populateAddressResults(!1,t)},_processFreeFormUserInput:function(e){var t;if((e=e.replace(/\s+/g," ").trim()).contains(",")?t=e.split(","):e.contains(" ")&&(t=e.split(" ")),t&&!t.some(isNaN)){if(t.indexOf("")>0||t.length>3)return void this._displayError("3DXCity.GeocodingAndReverse.Error.InputInvalidOrContainsError");this._inputReverseGeocode(t)}else this._geocode(e)},_geocode:function(e){this.elements.datagrid.empty(),this._toggleLoading(!0);var t=this;t._geocodeNominatimPromise(e,{limit:10}).then((function(i){i=t._filterOnPointsOnly(i),t._prevValues=e,t._populateAddressResults(!0,i)}),this._displayError.bind(this,"3DXCity.GeocodingAndReverse.Error.Generic"))},_displayError:function(e){this.elements.datagrid.innerHTML=m.get(e)},_toggleLoading:function(e){e?(s.createModal(this.elements.datagrid,this.elements.loadingIndicator.elements.container),this.elements.loadingIndicator.on("Searching...")):(this.elements.loadingIndicator.off(),s.removeModal(this.elements.datagrid))},_populateAddressResults:function(e,t){this._toggleLoading(!1),this.elements.datagrid.empty(),e||(t=[t]),this._treeDocument.empty();for(var i=0;i<t.length;i++){var o=t[i],a=new d({label:o.display_name,grid:{tree:o.display_name,address:o.display_name,x:o.lat,y:o.lon,score:100*o.importance,feature:o}});this._treeDocument.addChild(a)}var r={treeDocument:this._treeDocument,show:{rowHeaders:!1,columnHeaders:!0},selection:{toggle:!1,canMultiSelect:!1},apiVersion:2,columns:[{text:"Actions",dataIndex:"tree",width:60,onCellRequest:this._resultLocateButton.bind(this)},{text:"Address",dataIndex:"address",width:"auto"},{text:"Scoring",dataIndex:"score",width:70,onCellRequest:this._customScoreCell.bind(this)}]};this.listView=new c(r),this.listView.onNodeClick(this._onNodeClick.bind(this)),this.listView.inject(this.elements.datagrid),this.listView.getRoots()[0].select(),this._visualizeAddressResultPoint(t[0],this._config)},_resultLocateButton:function(e){var t=new a({showLabelFlag:!1,displayStyle:"lite",iconSize:"1x",icon:{iconName:"location-arrow",fontIconFamily:WUXManagedFontIcons.FontAwesome}});if(t.tooltipInfos=new n({shortHelp:"Move to Location"}),t.addEventListener("buttonclick",function(){var t=e.nodeModel.options.grid;parseFloat(t.x),parseFloat(t.y);this.globe.turnGlobeToLatLon(parseFloat(t.x),parseFloat(t.y),4)}.bind(this)),e.nodeModel&&e.nodeModel.options){var i=e.cellView.getContent();i.style.textAlign="center",i.setContent(t)}},_customScoreCell:function(t){if(t.nodeModel&&t.nodeModel.options){var i,o=t.cellView.getContent(),a="white",r=t.nodeModel.options.grid.score;r>=75?i="mediumseagreen":r>=50?(i="#fde000",a="black"):i=r>=25?"darkorange":"orangered";var s=e.createElement("span",{text:r+" %",styles:{color:a,"background-color":i,"border-radius":"4px",padding:"4px"}});o.setContent(s)}},_onNodeClick:function(e){this._clearAddressResultPoints();var t=e.nodeModel.getAttributeValue("feature");this._visualizeAddressResultPoint(t,this._config)},_clearAddressResultPoints:function(){this._geolocMarker&&this.globe.markerBag.removeMarkers([this._geolocMarker])},_visualizeAddressResultPoint:function(e){e&&(this._clearAddressResultPoints(),this._geolocMarker=this.globe.addMarker(parseFloat(e.lat),parseFloat(e.lon),0,"#ff0000","Geocoding result",e.display_name))},_geocodeNominatimPromise:function(e,t={}){var i=this;return new Promise((function(o,a){i._geocodeNominatim(e,t,o,a,0)}))},_geocodeNominatim:function(e,t,i,o,a){var r,s=this.odtUrl?this.odtUrl:this.url+"/search",n="q="+e;n+="&polygon_geojson=1&format=jsonv2";var l={method:"GET",type:"json",data:n+="&tenant="+g.getTenantId(),headers:{"Content-Type":"application/json"},onComplete:function(e){i(e)},onFailure:function(s){429==r.xhr.status&&a<5?setTimeout(_geocode.bind(this,e,t,i,o,++a),1e3):o(s)}};r=p.authenticatedRequest(s,l)},_filterOnPointsOnly:function(e){var t,i=[];for(t=0;t<e.length;t++){var o=e[t];"Point"==o.geojson.type&&i.push(o)}return i},_reverseGeocodeNominatimPromise:function(e,t={}){var i=this;return new Promise((function(o,a){i._reverseGeocodeNominatim(e,t,o,a,0)}))},_reverseGeocodeNominatim:function(e,t,i,o,a){var r,s=this.url+"/reverse",n="lat="+e.lat+"&lon="+e.lon+"&zoom=18";n+="&format=jsonv2";var l={method:"GET",type:"json",data:n+="&tenant="+g.getTenantId(),headers:{"Content-Type":"application/json"},onComplete:function(e){i(e)},onFailure:function(e){429==r.xhr.status&&a<5?setTimeout(_geocode.bind(this,address,t,i,o,++a),1e3):o(e)}};r=p.authenticatedRequest(s,l)},_filterOnPointsOnly:function(e){return e},_launchClicks:function(){this.globe.clearMouseOver();this.globe.markerBag;var e=this,t={onMouseMove:function(e,t,i){},onMouseOut:function(){},onMouseDoubleClick:function(e,t,i){},onMouseClick:function(t,i,o){var a,r=e.frmWindow.getViewerFrame(),s=new h.Projector,n=new h.Vector3(i/r.clientWidth*2-1,-o/r.clientHeight*2+1,0),l=s.pickingRay(n,e.globe.camera.threeCamera).ray,d=l.origin,c=l.direction,g=new h.Vector3(0,0,0).sub(d),p=g.dot(c);g.copy(c).multiplyScalar(p).add(d);var m=g.lengthSq();if(!(m>1)){var f=p-Math.sqrt(1-m),v=c.clone().multiplyScalar(f).add(d);a=u.XYZToLatlon(v),this._locatorReverseGeocode(a)}}.bind(this),computeLatWithYclick:function(e){return e<.089655?20*e/.089655:e<.189655?20+20*(e-.089655)/.1:e<.327585?40+20*(e-.189655)/.13793:60+15*(e-.327585)/.172415},onClearCountries:function(){}};this.globe.mouseOverCountryManager=void 0,this.globe.mouseOverMarkersManager=t}})})),define("DS/SocialGlobe/GlobeLoader",["UWA/Class","DS/SocialGlobe/Globals","DS/WebappsUtils/WebappsUtils"],(function(e,t,i){"use strict";return e.extend({init:function(){this.countryColors=[],this.defaultColor=null,this.randomize=!1,this.randomAmplitude=.1,this.randomTable=[],this.colorsHaveChanged=!1},loadBinaryFile:function(e){this.request=function(){try{return new XMLHttpRequest}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("Could not create HTTP request object.")}(),this.request.open("GET",i.getWebappsAssetUrl("SocialGlobe","data/dssocialglobe.bin"),!0),this.request.responseType="arraybuffer";var t=this;this.request.onload=function(){t.onLoad(),e.getDataModel()&&e.getDataModel().refresh()},this.request.send()},setDefaultColor:function(e,i,o){this.defaultColor=t.htmlToRGB(e),this.randomize=i,this.randomAmplitude=o,this.dirty=!0},getCountryColor:function(e){var t,i,o=this.countryColors[e];if(!o&&this.defaultColor)if(this.randomize){for(;!this.randomTable[e];)this.randomTable[e]=Math.random()-.5;for(o=[],t=0;t<3;t++)i=this.defaultColor[t]+this.randomAmplitude*this.randomTable[e],o[t]=i>=0?i<=1?i:1:0}else o=this.defaultColor;else o||(o=null);return o},refresh:function(){this.dirty&&(this.refreshColors_internal(),this.dirty=!1)},onLoad:function(){function e(e){return 2*Math.PI*e/Math.pow(2,16)}var t,i,o,a,r,s,n,l,d,c,h,u,g,p,m,f,v,b=this.request.response,w=new Uint16Array(b),x=0,y=w[x++];for(t=0;t<y;t++){for(this.newCountryMesh(t),i=w[x++],o=0;o<i;o++)a=Math.PI/2-e(w[x++]),r=e(w[x++])+Math.PI,this.addCountryVertex(a,r,t);for(x++,s=w[x++],n=0,n=0;n<s;n++)d=w[x++],c=w[x++],h=w[x++],this.addCountryFace([d,c,h]);for(u=w[x++],g=0,g=0;g<u;g++)for(this.newCountryPolygon(),m=w[x++],p=0;p<m;p++)for(this.startCountryPolygonLoop(0===p),v=w[x++],f=0;f<v;f++)l=w[x++],this.addCoutryPolygonLoopVertex(l),a=Math.PI/2-e(w[x++]),r=e(w[x++])+Math.PI;this.endCountryMesh()}this.endLoad(),this.dirty=!0},endLoad:function(){}})})),define("DS/SocialGlobe/GlobeLoader3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/GlobeLoader","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/SocialGlobe/ShaderTools"],(function(e,t,i,o,a,r,s,n){"use strict";return t.extend({init:function(e,t){this._parent(),this.scene=e;var i="CountryClearDepthPass",a=new s(i);if(a.defaults.clear=!1,a.defaults.doClearDepth=!0,this.scene.getRenderPassManager().addPass(i,a,{post:!0}),this._Globe3DPassID="CountryPassID",void 0===this.scene.getRenderPassManager().getPass(this._Globe3DPassID)){var n=new r(null,null,void 0,!0,!0,!1,this._Globe3DPassID);n.idString=this._Globe3DPassID,n.setDisableBackFaceCulling(!1),this.scene.getRenderPassManager().addPass(this._Globe3DPassID,n,{after:i})}this.globeShader_PDSFX={attributes:{},uniforms:{uFlip:{type:"i"},uNormalize:{type:"i"},uMixProj:{type:"f",value:0},uDz2D:{type:"f"},uOSMMode:{type:"i"},uAspectRatio:{type:"f",value:1},offset:{type:"v3",value:new o.Vector3(0,0,1)},uColor:{type:"v4",value:this.planetColor}},varyings:{vTextureCoord:{type:"v3"},vNormal:{type:"v3"},vTangent:{type:"v3"},vBinormal:{type:"v3"}},VS_global_code:["const float PI = 3.14159;"].join("\n"),VS_overridableFunctions:{ComputeObjectPosition:["   // Move vertex to proper world position (initial geometry is a cube)","   vec3 OP =  vec4(position,1.0).xyz;","   vec3 VP;","   float radius = 1.0;","   float dz = 0.0;","   if(uNormalize == 1)","   {","//     radius = 0.985;","       radius = 0.998;","       VP = normalize(OP);","       vTextureCoord = VP;","        //vTextureCoord.xy = VP.xy*offset.z + offset.xy;","       vNormal = VP;","       vTangent = normalize(cross(vec3(0,1,0), vNormal));","       vBinormal = normalize(cross(vTangent, vNormal));","   }","   else","   {","       VP = OP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       //vec3 P2 =  normalize( (uMBWMatrix * vec4(position,1.0)).xyz );","       vec3 P2 =  VP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       vTextureCoord = vec3(uv.xy, 1.0);","       vTextureCoord.xy = offset.z * uv.xy + offset.xy;","       vNormal = position;","       vTangent = normalize(cross(vec3(0,1,0), VP));","       vBinormal = normalize(cross(vTangent, VP));","   }","   vec3 projP = vec3(VP.x, 0.0, VP.z);","   if(length(projP) < 0.001)","   {","       projP = vec3(1.0, 0.0, 1.0);","   }","   vec3 normalizedProjP = normalize(projP);","   float sign = 0.0;","   if(normalizedProjP.z > 0.0)","       sign = -1.0;","   else","       sign = 1.0;","   float angle = sign*acos(normalizedProjP.x);","    if (normalizedProjP.x > 0.99999)","        angle = 0.0;","    if (normalizedProjP.x < -0.99999)","        angle = 0.0;","   if(uFlip != 0 && angle > 0.0)","   {","       angle -= 2.0*PI;","   }","   float x = angle / PI;","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   // Final position in projected view space","   vec4 pre_gl_Position_3d;","   vec4 pos = ( vGetViewMatrix() * modelMatrix * vec4(radius*VP, 1.0) );","   pre_gl_Position_3d = vGetProjectionMatrix() * pos;","   vec4 pre_gl_Position_2d;","   float yangle = asin(VP.y);","   float minangle = 1.31;","   if(yangle < -minangle)","   {","       yangle = -minangle;","   }","   else","   {","       if(yangle > minangle)","       {","           yangle = minangle;","       }","   }","   float y2d = uAspectRatio*log(tan(PI/4.0+yangle*0.5))/ PI;","   pre_gl_Position_2d = vec4(x, y2d, uDz2D, 1.0);","   //gl_Position = pre_gl_Position_3d;","   return (MixProj*pre_gl_Position_2d + (1.0 - MixProj)*pre_gl_Position_3d).xyz;"].join("\n")},FS_global_code:["precision lowp float;"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor = uColor;"].join("\n")}},this.countryMeshes=[],this.polylineMeshes=[],this.loadBinaryFile(t),this.dirty=!0},incrementShadersLoaded:function(e,t){t},createPlanetMaterial:function(e,t,i){this.planetColor=new o.Vector4(e,t,i,1);var a=n.getPDSFXMaterial([this.globeShader_PDSFX],"physical");return a.transparent=!0,a.side=o.FrontSide,a.forceSide=!0,a.force=!0,a},newCountryMesh:function(e){var t=this.createPlanetMaterial(e/255,e/255,e/255),o=new i(this.scene,"country_"+e,e,this._Globe3DPassID);o.setMaterial(t),this.countryMeshes.push(o)},addCountryVertex:function(e,t){var i=Math.cos(-e)*Math.cos(-t),o=-Math.sin(-e),a=Math.cos(-e)*Math.sin(-t),r=(t+Math.PI)/Math.PI,s=(e+Math.PI)/(2*Math.PI);this.countryMeshes[this.countryMeshes.length-1].addVertex(i,o,a,i,o,a,[[r,s]])},addCountryFace:function(e){this.countryMeshes[this.countryMeshes.length-1].addFace(e)},endCountryMesh:function(){var e=this.countryMeshes[this.countryMeshes.length-1];e.endMesh({depth:300,pickable:"pickable"}),this.scene.addObject(e),e.setVisibility(!0),e.setColorRGBA("uColor",[0,0,0,0])},refreshCountry:function(e){var t=e.color;e.colorOverride&&(t=e.colorOverride);var i=this.countryMeshes[e.ID];i&&(t?(i.setVisibility(!0),i.setColorRGB("uColor",t)):(i.setVisibility(!0),i.setColorRGBA("uColor",[0,0,0,0]))),this.dirty=!0},refreshColors_internal:function(){},newCountryPolygon:function(){},startCountryPolygonLoop:function(e){},addCoutryPolygonLoopVertex:function(e){}})})),define("DS/SocialGlobe/PoleCreator3D",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Utils","DS/WebappsUtils/WebappsUtils","DS/Plugins/RenderPass","DS/SocialGlobe/ShaderTools"],(function(e,t,i,o,a,r,s,n){"use strict";return e.extend({init:function(e,t,i){if(this.skin=i,this.scene=e,this._PolePassID="PolePassID",void 0===this.scene.getRenderPassManager().getPass(this._PolePassID)){var a=new s(null,null,void 0,!0,!0,!1,this._PolePassID);a.idString=this._PolePassID,a.setDisableBackFaceCulling(!1),this.scene.getRenderPassManager().addPass(this._PolePassID,a,{pre:!0})}this.shaderFromTileBag=t.tileBagShader_PDSFX,this.vertShader=t.vertShader,this.fragShader=t.fragShader,this.earthShadow=t.earthShadow,this.reflection=t.reflection,this.showMeridians=!0,this.whitetexture=new o.DataTexture(new Float32Array([1,1,1,1]),1,1,o.RGBAFormat,o.FloatType),this.whitetexture.flipY=!1,this.whitetexture.minFilter=o.LinearFilter,this.whitetexture.magFilter=o.LinearFilter,this.whitetexture.generateMipmaps=!1,this.whitetexture.needsUpdate=!0},createMesh:function(e){var a,s,n=r.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/"+this.skin+"/poles/"),l=new i(this.scene,"pole",void 0,this._PolePassID),d=10,c=.09,h=e?1:-1,u=c,g=e?n+"NE2_HR_LC_SR_W_cm_N"+t.tileExtension:n+"NE2_HR_LC_SR_W_cm_S"+t.tileExtension;"tms-user"===this.skin&&e?g=t.tilespath+"2/0/0"+t.tileExtension:"tms-user"!==this.skin||e||(g=t.tilespath+"2/2/3"+t.tileExtension);var p=this.createPoleMaterial(l,g,e);for(l.setMaterial(p),a=0;a<=d;a++)for(s=0;s<=d;s++){var m=new o.Vector3(.018*a-.09,h,.018*s-.09);m.normalize(),e?l.addVertex(m.x,m.y,m.z,m.x,m.y,m.z,[[.545-u*s/d,.545-u*a/d]]):l.addVertex(m.z,m.y,m.x,m.z,m.y,m.x,[[.545-u*a/d,.455+u*s/d]])}for(a=0;a<d;a++)for(s=0;s<d;s++)l.addFace([11*(a+1)+s,11*a+s,11*a+s+1]),l.addFace([11*(a+1)+s+1,11*(a+1)+s,11*a+s+1]);return l.endMesh({depth:0,pickable:"occulting"}),l},createPoleMaterial:function(e,i,r){var s=this.shaderFromTileBag;s.uniforms={...this.shaderFromTileBag.uniforms,uShadowSampler:{type:"tc",value:this.earthShadow},uOSMSampler:{type:"t2",value:this.whitetexture},uReflection:{type:"tc",value:this.reflection},uNormalize:{type:"i"},uMixProj:{type:"f",value:.5},uAspectRatio:{type:"f",value:1},offset:{type:"v3",value:new o.Vector3(0,0,1)},externalFactor:{type:"f",value:r?1.07:1},externalAlpha:{type:"f",value:r?1/255:1},externalThickness:{type:"f",value:this.showMeridians?1:0}};var l=n.getPDSFXMaterial([s],"physical"),d={};d.credentials=t.credentials;a.loadTexture(d,(function(t){e.loaded=!0,l.updatePDSFXUniform("uOSMSampler",t),l.needsUpdate=!0}),i);return l.depthTest=!1,l.depthWrite=!1,l.force=!0,l.side=o.FrontSide,l.forceSide=!0,l}})})),define("DS/SocialGlobe/MarkerCluster",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker","DS/Supercluster/supercluster.min"],(function(e,t,i,o){"use strict";return e.extend({init:function(e){this.index=new o({radius:50,maxZoom:e})},load:function(e){for(var t=0;t<e.length;t++)e[t].properties.fid=t;this.index.load(e)},getClusters:function(e,t){return this.index.getClusters(e,t)}})})),define("DS/SocialGlobe/Feature",["UWA/Class","DS/SocialGlobe/Globals"],(function(e,t){"use strict";return e.extend({init:function(e,t,i){this.geometry=e,this.properties=t,this.featureType=i}})})),define("DS/SocialGlobe/MarkerBag",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/ClusterFactory"],(function(e,t,i,o,a){"use strict";return e.extend({init:function(e){this.renderer=e,this.markerMaker=e.renderContext.buildMarkerMaker(e),this.markerTiles={},this.meshes={},this.clusters={},this.clusterLevel=0,this.maxLevel=18,this.allMarkers=[],this.markers=[],this._clustering=!1,this.allMarkersByLevel=[],this.allMarkersNodeByLevel=[];for(var t=0;t<this.maxLevel;t++)this.markers.push(new Array),this.allMarkersByLevel.push(new Array),this.allMarkersNodeByLevel.push(new Array);this.markerSkins={},this.somethingHasChanged=!1,this.needClearMeshes=!0,this.needClearClusters=!0},createCluster:function(e,t,o,a,r,s,n,l,d,c=!1){var h=new i(e,t,o,a,r,s,l,d,n);return h._manager=this,c&&(h.readOnly=c),this.addCluster(h),h},createMarker:function(e,t,o,a,r,s,n,l,d,c=!1){var h=new i(e,t,o,a,r,s,l,-1,d,n);return h._manager=this,c&&(h.readOnly=c),!0===this._clustering?this.addMarker2(h):this.addMarker(h),h},getMarkerRep:function(e,t,i,o){this.needClearMeshes&&(this.meshes={},this.needClearMeshes=!1);var a=[],r=[],s=[];if(!this.markerMaker)return null;var n,l=e+"/"+t+"/"+i;if(!this.meshes[l]&&(n=this.markerTiles[e+"/"+t+"/"+i])){for(var d=0;d<n.length;d++){var c=n[d];if(void 0!==c[0].image)r.push(c);else if(!0===o){for(var h=[],u=0;u<c.length;u++)c[u].level===this.clusterLevel&&h.push(c[u]);a.push(h)}else a.push(c)}for(u=0;u<r.length;u++){var g=r[u];void 0===this.markerSkins[g[0].image]&&(this.markerSkins[g[0].image]=this.markerMaker.createMarkerCustomMaterials(g[0].image));var p=this.markerMaker.createRenderable([g],this.markerSkins[g[0].image],this._clustering);s=s.concat(p)}a.length>0&&(void 0===this.markerSkins.default&&(this.markerSkins.default=this.markerMaker.createMarkerMaterials()),this.meshes[l]=this.markerMaker.createRenderable(a,this.markerSkins.default,this._clustering))}return this.meshes[l]?this.meshes[l]=this.meshes[l].concat(s):s.length>0&&(this.meshes[l]=s),this.meshes[l]},getMarkerRep2:function(e,t){void 0===this.markerSkins.default&&(this.markerSkins.default=this.markerMaker.createMarkerMaterials());for(var i=[],o=0;o<this.markers[e].length;o++){var a=this.markers[e][o];a.lat>t.point.lat-t.distance&&a.lat<t.point.lat+t.distance&&a.lon>t.point.lon-t.distance&&a.lon<t.point.lon+t.distance&&i.push(a)}return this.markerMaker.createRenderable(i,this.markerSkins.default,this._clustering)},getClusterRep:function(e,t){for(var i=[],o=[],r=0;r<this.allMarkersByLevel[e].length;r++){var s=this.allMarkersByLevel[e][r];if(s.lat>t.point.lat-t.distance&&s.lat<t.point.lat+t.distance&&s.lon>t.point.lon-t.distance&&s.lon<t.point.lon+t.distance){i.push(s);var n=this.allMarkersNodeByLevel[e][r];if(null==n){var l={uuid:0,name:""+s.point_count,style:{fillStyle:"#FFFFFF",font:"bold 14px Arial",maxWidth:200,strokeStyle:"#000000",textAlign:"center"},fontHeight:14,size:{width:53,height:53},pos:s.position};n=a.build(l),this.allMarkersNodeByLevel[e][r]=n}o.push(n)}}return o},updateMaterialBeforeDraw:function(){if(this.markerMaker)for(var e in this.markerMaker.updateMaterialBeforeDraw(),this.markerSkins){var t=this.markerSkins[e];this.markerMaker.updateMaterialUniforms(t.material),this.markerMaker.updateMaterialUniforms(t.pickMaterial)}},getAllMarkersWithOnScrenPosition:function(e,t,i){var o,a=e+"/"+t+"/"+i,r=this.markerTiles[a];if(r)for(o=0;o<r.length;o++)this.renderer.computeMarkerPositionOnScreen(r[o][0]);return r},getAllMarkersWithOnScrenPosition2:function(e){var t=this.markers[e];if(t)for(var i=0;i<t.length;i++)this.renderer.computeMarkerPositionOnScreen(t[i]);return t},addCluster:function(e){return this.allMarkersByLevel[e.level].push(e),e.id=this.allMarkersByLevel[e.level].length,e},addMarker2:function(e){return this.somethingHasChanged=!0,this.needClearMeshes=!0,e.id=e.fid,this.markers[e.level].push(e),e},addMarker:function(e){if(e.id<0){this.somethingHasChanged=!0,this.needClearMeshes=!0;var i,o,a,r,s,n,l=0;for(l=0;l<this.maxLevel;l++)if(i=.05/Math.pow(2,l),o=l+"/"+Math.floor(t.lon2tileFlt(e.lon,l))+"/"+Math.floor(t.lat2tileFlt(e.lat,l)),a=this.markerTiles[o]){for(r=!1,s=0,s=0;s<a.length&&!r;s++)n=a[s],e.position.distanceTo(n[0].position)<i&&(n.push(e),r=!0);r||a.push([e])}else a=[],this.markerTiles[o]=a,a.push([e]);return e.id=this.allMarkers.length,this.allMarkers.push(e),e}},removeMarkers:function(e){var t,i,o;for(o=this.allMarkers,this.clearMarkers(),t=0;t<o.length;t++)o[t].id=-1;for(t=0;t<e.length;t++)(i=o.indexOf(e[t]))>=0&&o.splice(i,1);for(t=0;t<o.length;t++)this.addMarker(o[t])},updateMarkerPosition:function(e){this.removeMarkers(e),this.addMarker(e)},getMarker:function(e){return this.allMarkers[e]},get:function(e){return this.allMarkers[e]},clearMarkers:function(){this.somethingHasChanged=!0,this.needClearMeshes=!0,this.markerTiles={},this.allMarkers=[],this.markers=[],this.allMarkersByLevel=[],this.allMarkersNodeByLevel=[],this.needClearClusters=!0;for(var e=0;e<this.maxLevel;e++)this.markers.push(new Array),this.allMarkersByLevel.push(new Array),this.allMarkersNodeByLevel.push(new Array)},refresh:function(e){this.removeMarkers(e);for(var t=0;t<e.length;t++)this.addMarker(e[t])},getMarkersSize:function(){return this.allMarkers.length}})})),define("DS/SocialGlobe/TileBag3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/SocialGlobe/TileBag","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/SocialGlobe/ShaderTools"],(function(e,t,i,o,a,r){"use strict";return i.extend({init:function(t){this._parent(t),this.earthShadow=e.loadTextureCube("shadow","png"),this.reflection=e.loadTextureCube("R","png"),this.whitetexture=new o.DataTexture(new Float32Array([1,1,1,.5]),1,1,o.RGBAFormat,o.FloatType),this.whitetexture.flipY=!1,this.whitetexture.minFilter=o.LinearFilter,this.whitetexture.magFilter=o.LinearFilter,this.whitetexture.generateMipmaps=!0,this.whitetexture.needsUpdate=!0,this.tileBagShader_PDSFX={attributes:{},uniforms:{uFlip:{type:"i"},uNormalize:{type:"i"},uMixProj:{type:"f",value:0},uDz2D:{type:"f"},uOSMMode:{type:"i"},uAspectRatio:{type:"f",value:1},offset:{type:"v3",value:new o.Vector3(0,0,1)},uShadowSampler:{type:"tc",value:this.earthShadow},uOSMSampler:{type:"t2",value:this.whitetexture},uReflection:{type:"tc",value:this.reflection}},varyings:{vTextureCoord:{type:"v3"},vNormal:{type:"v3"},vTangent:{type:"v3"},vBinormal:{type:"v3"}},VS_overridableFunctions:{ComputeObjectPosition:["vTextureCoord = vGetAttribTexCoord0().xyz;","if(offset.z != 0.0) {","vTextureCoord.xy = offset.z * vTextureCoord.xy;","}","if(offset.x != 0.0 || offset.y != 0.0) {","vTextureCoord.xy = vTextureCoord.xy + offset.xy;","}","vNormal = vGetAttribPosition();","vTangent = normalize(cross(vec3(0,1,0), vGetAttribPosition()));","vBinormal = normalize(cross(vTangent, vGetAttribPosition()));","vec3 posi = vGetAttribPosition();","return posi;"].join("\n")},FS_global_code:["precision highp float;","float uRefraction = 0.95;","float Eta = 1.0/uRefraction;","const float FresnelPower2 = 2.0;","float F = ((1.0 - Eta) * (1.0 - Eta)) / ((1.0 + Eta) * (1.0 + Eta));"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["float uLinesThickness = 1.0;","float uOccultancy = 1.0;","float uMixProj = 0.0;","vec3 ttt = vec3(-vNormal.z, vNormal.y, vNormal.x);","vec4 OSMColor = texture2D(uOSMSampler, vTextureCoord.xy);","vec3 ocean = vec3(181.0/255.0, 208.0/255.0, 208.0/255.0);","OSMColor.a = 0.1 + 0.9*OSMColor.a;","vec4 shadow;","shadow = vec4(1.0, 1.0, 1.0, 1.0);","vec3 bump = vNormal; //vTextureCoord.xyz;","vec3 ecPosition3  = vNormal.xyz - cameraPosition;","vec3 i = normalize(ecPosition3);","vec3 n = bump;","float vRatio2 = F + (1.0 - F)*pow(1.0-clamp(dot(-i, n), 0.0, 1.0), FresnelPower2);","vec3 vReflect = reflect(i, n);","vec3 vRefract = refract(i,n,Eta);","float k = -2.0*dot(vRefract, vNormal);","vec3 vRR = k*vRefract + vNormal;","vRefract = vRR;","vec3 ttt1 = vec3(-vReflect.z, vReflect.y, vReflect.x);","vec4 reflection2 = vec4(vRatio2*textureCube(uReflection, ttt1).rgb, 0);","vRefract = normalize(vRefract);","vec4 diffuse2;","diffuse2 = textureCube(uShadowSampler, vec3(-vRefract.z, vRefract.y, vRefract.x));","diffuse2.a = 1.0 - diffuse2.r;","if(uLinesThickness > 0.0) {","float distance = 0.4*sqrt(length(cameraPosition)-1.0);","float lat = 180.0*acos(vRefract.y)/3.1459;","float lon = 180.0*asin(vRefract.z/sqrt(vRefract.z*vRefract.z + vRefract.x*vRefract.x))/3.1459;","if(vRefract.x < 0.0) {","lon = 180.0 - lon;","}","float modlat = mod(360.0+lat+10.0, 20.0);","float modlon = mod(360.0+lon, 20.0);","if(abs(modlat) < 0.25*uLinesThickness*distance || abs(modlon) < 0.5*uLinesThickness*distance ) {","diffuse2.a = 1.0;","}","lat = 180.0*acos(vNormal.y)/3.1459;","lon = 180.0*asin(vNormal.z/sqrt(vNormal.z*vNormal.z + vNormal.x*vNormal.x))/3.1459;","if(vNormal.x < 0.0) {","lon = 180.0 - lon;","}","modlat = mod(360.0+lat+10.0, 20.0);","modlon = mod(360.0+lon, 20.0);","if(abs(modlat) < 0.25*uLinesThickness*distance|| abs(modlon) < 0.5*uLinesThickness*distance ) {","OSMColor = OSMColor.a * OSMColor + (1.0 - OSMColor.a)*vec4(1.0, 1.0, 1.0, 1.0);","}","}","vec4 reflection;","vec4 diffuse1 = vec4(0.0*vec3(77.0/255.0,132.0/255.0,175.0/255.0), 0.7);//k/uOccultancy);","reflection = reflection2;","if (diffuse2.a > 0.5) diffuse2 = vec4(0.2,0.2,0.2,1);","else diffuse2 = vec4(0,0,0,0.0);","vec4 tmpCol;","tmpCol.rgb = (1.0-uMixProj)*1.5*reflection.rgb + diffuse1.a*diffuse1.rgb + (1.0-diffuse1.a)*diffuse2.rgb;","tmpCol.a = max(diffuse1.a, diffuse2.a);","float kk = 0.5;","ioFinalColor.rgb = OSMColor.rgb;","ioFinalColor.a = 1.0;"].join("\n")}},this.showMeridians=!0},getTileInfo:function(t,i,o){var a=t+"/"+i+"/"+o,r=this.tileMap[a];return r?r.tileInfo.pos:{center:e.latlonToXYZ(e.tile2lat(t,o+.5),e.tile2lon(t,i+.5)),ULcorner:e.latlonToXYZ(e.tile2lat(t,o+1),e.tile2lon(t,i)),LLcorner:e.latlonToXYZ(e.tile2lat(t,o),e.tile2lon(t,i)),URcorner:e.latlonToXYZ(e.tile2lat(t,o+1),e.tile2lon(t,i+1)),LRcorner:e.latlonToXYZ(e.tile2lat(t,o),e.tile2lon(t,i+1))}},getTile:function(i,a,r){var s,n,l,d,c,h,u,g,p,m,f,v,b,w=i+"/"+a+"/"+r,x=this.tileMap[w];if(x)return x;for(s=n=Math.max(2,64/(1<<i)),(l=new t(this.scene,"tile:"+i+"/"+a+"/"+r)).loaded=!0,l.setMaterial(this.createPlanetMaterial()),l.setPickMaterial(new o.MeshBasicMaterial({color:16711935})),d=0;d<=s;d++)for(u=a+(h=d/s),g=e.tile2lon(i,u),c=0;c<=n;c++)m=r+(p=c/n),f=e.tile2lat(i,m),v=e.latlonToXYZ(f,g),b=[h,1-p],l.addVertex(v.x,v.y,v.z,v.x,v.y,v.z,[b]);for(d=0;d<s;d++)for(c=0;c<n;c++)l.addFace([(s+1)*(d+1)+c,(s+1)*d+c,(s+1)*d+c+1]),l.addFace([(s+1)*(d+1)+c+1,(s+1)*(d+1)+c,(s+1)*d+c+1]);return l.endMesh({depth:i,pickable:"invisible"}),l.tileKey=w,l.tileInfo={level:i,tx:a,ty:r,pos:this.getTileInfo(i,a,r)},this.tileMap[w]=l,l},createPlanetMaterial:function(){var e=r.getPDSFXMaterial([this.tileBagShader_PDSFX],"physical");return e.side=o.FrontSide,e.forceSide=!0,e.force=!0,e},loadTexture:function(e,t,i,a){var r=new o.Texture,s=function(e){e.needsUpdate=!0,a(e)}.bind(this,r);return r.image=this.getTileImage(e,t,i,s),r.counter=this.textureCounter,r},destroyTile_internal:function(e){e.dispose(),this.destroyTileImage_internal(e)},unloadTextures:function(){var e;for(e in this.tileMap){this.tileMap[e].threeMaterial.updatePDSFXUniform("uOSMSampler",this.whitetexture)}}})})),define("DS/SocialGlobe/VisuStore",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Disposer","DS/SocialGlobe/Globals","DS/SocialGlobe/Utils"],(function(e,t,i,o,a,r){"use strict";return e.extend(t,{init:function(e){this.stores=[],this.params={},this.params.baseUrl=e,this.params.credentials=a.credentials,this.vqt=void 0,this.dlSize=0,this.inProcessDL=0,this.maxAllowedDL=6,this.DLQueue=[],this.inProcess=!0,this.buildSize=0,this.inProcessBuild=0,this.maxAllowedBuild=1,this.buildQueue=[],this.timeStamp=0,this.cleanupTime=0,this.numGetOrDownload=0,this.cleanlodBias=-100,this.frameCleanUp=0,this.loadBind=this.load.bind(this),this.buildBind=this.build.bind(this)},makeStore:function(e,t,i,o,a,r,s,n,l,d,c){var h={storeId:e,url:t,loader:o,builder:a,loadedCount:0,type:i,toClean:!1,priority:r,priorityOffset:0,limit:s,childCanUseParent:n,childNeedParent:l,levelMin:d,levelMax:Number.MAX_VALUE,levelMinCache:d,data:{}};return this[e]=h,this.stores.push(this[e]),this[e].size=0,this[e].lodBias=0,void 0!==c&&(this[e].levelMax=c),n&&0==h.levelMin&&this.addToDLQueue(e,0,0,0,void 0,100,100),h},makeStoreByJSON:function(e,t,i,o,a,r){var s={storeId:e,url:t.url,loader:i,builder:o,priority:2,priorityOffset:0,cache:200,childCanUseParent:a,childNeedParent:r,levelMin:0,levelMax:Number.MAX_VALUE,size:0,lodBias:0,loadedCount:0,invertY:!1,toClean:!1,levelMinCache:0,data:{}};for(var n in s)s.hasOwnProperty(n)&&void 0!==t[n]&&(s[n]=t[n]);return this[e]=s,this.stores.push(this[e]),a&&0==s.levelMin&&this.addToDLQueue(e,0,0,0,void 0,100,100),s},getData:function(e,t,i,o){var a,r=this[e];if(null!=r){if(r.invertY&&(o=(1<<t)-1-o),void 0!==(a=r.data[t+"_"+i+"_"+o])&&void 0!==a.data)return this.touch(a);if(r.childCanUseParent){var s,n=2,l=i,d=o;for(s=t-1;s>=0;s-=1){if(l=Math.floor(i/n),d=Math.floor(o/n),void 0!==(a=r.data[s+"_"+l+"_"+d])&&void 0!==a.data)return this.touch(a),{data:a.data,LOD:s,scale:1/n,offset:{x:i/n-l,y:o/n-d},isLeaf:s===Math.max(0,r.levelMax-r.lodBias)};n*=2}}}else console.log("Error store unknow: "+e)},updateTimeStamp:function(e,t,i,o){var a=this[e];this.touch(a.data[t+"_"+i+"_"+o])},getOrDownloadData:function(e,t,i,o,a,r){this.numGetOrDownload++,void 0===r&&(r=0);var s=this[e];if(null!=s){!0===s.invertY&&(o=(1<<t)-1-o);var n,l=t,d=i,c=o,h=1,u=s.lodBias;l-s.levelMax>u&&(u=l-s.levelMax),u>0&&(l-=u=Math.min(l,u),h=1<<u,d=Math.floor(i/h),c=Math.floor(o/h));var g=l+"_"+d+"_"+c,p=void 0;if(void 0!==(n=this.touch(s.data[g]))){if(void 0!==n.data)return u>0?{data:n.data,LOD:l,I:d,J:c,scale:1/h,offset:{x:i/h-d,y:!0!==s.invertY?1-1/h-(o/h-c):1-1/h-o/h-c}}:n;void 0!==n.lodParentTest&&(p=n.lodParentTest)}var m=void 0,f=void 0,v=l-1;if(s.childCanUseParent){x=2*h;var b=i,w=o;for(v=l-1;v>=s.levelMin&&void 0===m;v-=1)b=Math.floor(i/x),w=Math.floor(o/x),void 0!==(f=s.data[v+"_"+b+"_"+w])&&(this.touch(f),void 0!==f.data?m={data:f.data,LOD:v,I:b,J:w,scale:1/x,offset:{x:i/x-b,y:!0!==s.invertY?1-1/x-(o/x-w):o/x-w},isLeaf:f.isLeaf||p&&p.LOD==v}:p&&(f.lodParentTest&&f.lodParentTest.LOD<=p.LOD?(p.LOD=f.lodParentTest.LOD,f.lodParentTest=p):p.LOD=v-1)),x*=2}if(s.childNeedParent){if(void 0!==n&&void 0===n.data)return n;if(l===s.levelMin)this.addToDLQueue(e,l,d,c,a,l+r,0);else{var x=2*h;b=d,w=c;for(v=l-1;v>=s.levelMin;v-=1){b=Math.floor(i/x),w=Math.floor(o/x);var y=s.data[v+"_"+b+"_"+w];if(v===l-1&&void 0!==y&&void 0!==y.data&&!0!==y.isLeaf)return this.addToDLQueue(e,l,d,c,a,l+r,0),m;if(void 0!==y&&(void 0===y.data||!0===y.isLeaf))return n;x*=2}}}else{var C=!1,S=4*Math.floor(l/4);if(p&&(S=4*Math.floor(p.LOD/4)),l>S+1)for(var M=S;M>v+1&&!1===C;M-=4){var D=Math.floor(1*d/(1<<l-M)),_=Math.floor(1*c/(1<<l-M));void 0===s.data[M+"_"+D+"_"+_]&&(C=!0,this.addToDLQueue(e,M,D,_,a,l+r,l-v))}0==C&&(void 0===n?this.addToDLQueue(e,l,d,c,a,l+r,l-v):m&&p&&p.LOD>m.LOD&&this.addToDLQueue(e,p.LOD,Math.floor(1*d/(1<<l-p.LOD)),Math.floor(1*c/(1<<l-p.LOD)),a,l+r,l-v))}return m}console.log("Error store unknow: "+e)},addToDLQueue:function(e,t,i,o,a,r,s){var n=e+"_"+t+"_"+i+"_"+o,l=this.DLQueue[n];if(void 0!==l)return this.touch(l),void(l.priority=Math.max(l.priority,this[e].priority*r+this[e].priorityOffset*s));var d=this.buildQueue[n];void 0===d?this.DLQueue[n]={storeId:e,LOD:t,I:i,J:o,timeStamp:this.timeStamp,priority:this[e].priority*r+this[e].priorityOffset*s,isPending:!1}:this.touch(d)},load:function(e,t,i,o){this.inProcessDL+=1;var a=this[e].url.replace("%l",t).replace("%x",i).replace("%y",o),s=e+"_"+t+"_"+i+"_"+o,n=this;this[e].loader(this.params,(function(r,l,d){if(n.inProcessDL-=1,!n.DLQueue[s].disabled){var c=t+"_"+i+"_"+o;204===d||r&&(0==r.byteLength||0==r.size||""===r)?n[e].data[c]=n.touch({data:void 0,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:!0,lodParentTest:{LOD:t-1}}):void 0!==r&&!0===l?(r.url=a,void 0!==n[e].builder?n.buildQueue[s]=n.touch({storeId:e,file:r,LOD:t,I:i,J:o,isPending:!1,priority:n.DLQueue[s].priority,isLeaf:207===d||t===Math.max(0,n[e].levelMax-n[e].lodBias)}):n[e].data[c]=n.touch({data:r,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:207===d||t===Math.max(0,n[e].levelMax-n[e].lodBias)})):n[e].data[c]=n.touch({data:void 0,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:!0,lodParentTest:{LOD:t-1}})}delete n.DLQueue[s]}),a,t,i,o,r.getTenantId())},build:function(e,t,i,o){this.inProcessBuild+=1;var a=t+"_"+i+"_"+o,r=e+"_"+a,s=this;this[e].builder((function(n,l,d){s.inProcessBuild-=1,!0!==s.buildQueue[r].disabled&&(!0===l||!1===l&&void 0===n)&&(void 0===s.buildQueue[r]||(s[e].data[a]=s.touch({data:n,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:d||s.buildQueue[r].isLeaf}))),delete s.buildQueue[r]}),this.buildQueue[r].file,t,i,o)},pollQueues:function(){var e=this.dlSize>0||this.buildSize>0;this.inProcessDL<this.maxAllowedDL&&(this.dlSize=this.pollQueue(this.DLQueue,this.inProcessDL,this.maxAllowedDL,this.loadBind)),this.inProcessBuild<this.maxAllowedBuild&&(this.buildSize=this.pollQueue(this.buildQueue,this.inProcessBuild,this.maxAllowedBuild,this.buildBind)),e=e||this.inProcessDL>0||this.inProcessBuild>0,this.inProcess!==e&&(this.inProcess=e,this.dispatchEvent("onProcess",e))},pollQueue:function(e,t,i,o){var a=[],r=[];for(var s in e){var n=e[s];!1===n.isPending&&(void 0!==n.timeStamp&&n.timeStamp>=this.timeStamp||0===n.LOD?a.push(e[s]):r.push(s))}for(var l=0;l<r.length;l++)delete e[r[l]];var d=a.length;a.sort((function(e,t){return e.priority-t.priority}));var c=Math.min(a.length,i-t);for(l=a.length-1;l>=a.length-c;l--)a[l].isPending=!0,o(a[l].storeId,a[l].LOD,a[l].I,a[l].J);return d},touch:function(e){return void 0!==e&&(e.timeStamp=this.timeStamp,e.data&&e.data.update&&e.data.update(this.timeStamp)),e},cleanupStores:function(){if(this.frameCleanUp%60==0){this.frameCleanUp=0;for(var e=Date.now(),t=0;t<this.stores.length;t++)this.cleanupStore(this.stores[t]);this.cleanupTime=Date.now()-e}this.frameCleanUp++},traverse:function(e,t){var i=this[e];for(var o in i.data){var a=i.data[o];a.data&&t(a.data)}},clearBuild:function(e){for(var t in this.buildQueue)t.split("_")[0]===e&&(this.buildQueue[t].disabled=!0)},cleanupStore:function(e){var t=[],i=0;for(var o in e.data){(l=e.data[o]).LOD>e.levelMinCache&&(this.timeStamp>l.timeStamp&&null==l.shared&&(l.name=o,t.push(l)),i++)}if(e.size=i,!(i<=e.cache)){var a=this.cleanlodBias;t.sort((function(e,t){return t.timeStamp-e.timeStamp+a*(t.LOD-e.LOD)}));for(var r=Math.max(0,Math.min(t.length,i-Math.floor(.75*e.cache))),s=t.length-r,n=t.length;s<n;s++){var l;null!==(l=t[s]).data&&this.dispose(l.data),l.data=void 0,delete e.data[l.name],t[s]=void 0}}},dispose:function(e){void 0!==e&&o.disposeV6(e)},clean:function(e){if(e){var t=this[e];this.clearBuild(e),this.traverse(e,this.dispose),t.data={}}else for(var i in this.stores)this.clearBuild(i),this.traverse(i,this.dispose),this.stores[i].data={}},_debug:function(e){var t="DL queue : "+this.dlSize+"<br />Build queue : "+this.buildSize+"<br />Cleanup time : "+this.cleanupTime+"<br />Poll time: "+this.pollTime;this.numGetOrDownload=0;for(var i=0;i<this.stores.length;i++)t+="<br />- "+this.stores[i].storeId+": "+this.stores[i].size+" / "+this.stores[i].cache,this.stores[i].nodeClean=0;return t},_cleanupTime:function(e){var t=this.cleanupTime;return this.cleanupTime=0,t},_getStoreLength:function(){for(var e=0,t=0;t<this.stores.length;t++)e+=Object.keys(this.stores[t]).length;return e}})})),define("DS/SocialGlobe/GeoJSONItem",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Vector2","DS/SocialGlobe/Marker","DS/SocialGlobe/Feature"],(function(e,t,i,o,a){"use strict";return e.extend({init:function(){this.features=[]},build:function(e){this.handleNode(e)},handleNode:function(e,i){switch(e.type){case"FeatureCollection":this.handleFeatureCollection(e);break;case"Feature":this.handleFeature(e);break;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":this.features.push(new a(e,i,e.type));break;default:t.alert("Unknown GeoJSON node type")}},handleFeatureCollection:function(e){var t,i=e.features;for(t=0;t<i.length;t++)this.handleNode(i[t])},handleFeature:function(e){this.handleNode(e.geometry,e.properties)},addToRenderer:function(e){var t=0;for(t=0;t<this.markers.length;t++)this.markerBag.addMarker(this.markers[t]);for(t=0;t<this.objects.length;t++)e.addObject(this.objects[t])},removeFromRenderer:function(e){this.markerBag.removeMarkers(this.markers);var t=0;for(t=0;t<this.objects.length;t++)e.removeObject(this.objects[t])},floatsToVectors:function(e){var t=0,o=[];for(t=0;t<e.length;t++){var a=0;e[t][2]&&(a=e[t][2]),o.push(new i(e[t][0],e[t][1],a))}return o},getFeatures:function(){return this.features}})})),define("DS/SocialGlobe/PolylineMaker3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/SocialGlobe/PolylineMaker","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils"],(function(e,t,i,o,a){"use strict";return i.extend({init:function(e){this._parent(e),this.vertShader=["///attribute vec3 position;","//attribute vec2 uv;","uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","uniform float uAspectRatio;","uniform vec3 offset;","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","void main()","{","/*            gl_Position =   projectionMatrix *","                        viewMatrix *","                        modelMatrix *","                        vec4(position,1.0);","    return;*/","   // Move vertex to proper world position (initial geometry is a cube)","   vec3 OP =  vec4(position,1.0).xyz;","   vec3 VP;","   float radius = 1.0;","   float dz = 0.0;","   if(uNormalize == 1)","   {","//     radius = 0.985;","       radius = 0.998;","       VP = normalize(OP);","       vTextureCoord = VP;","        //vTextureCoord.xy = VP.xy*offset.z + offset.xy;","       vNormal = VP;","       vTangent = normalize(cross(vec3(0,1,0), vNormal));","       vBinormal = normalize(cross(vTangent, vNormal));","   }","   else","   {","       VP = OP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       //vec3 P2 =  normalize( (uMBWMatrix * vec4(position,1.0)).xyz );","       vec3 P2 =  VP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       vTextureCoord = vec3(uv, 1.0);","        vTextureCoord.xy = offset.z * uv + offset.xy;","       vNormal = position;","       vTangent = normalize(cross(vec3(0,1,0), VP));","       vBinormal = normalize(cross(vTangent, VP));","   }","   vec3 projP = vec3(VP.x, 0.0, VP.z);","   if(length(projP) < 0.001)","   {","       projP = vec3(1.0, 0.0, 1.0);","   }","   vec3 normalizedProjP = normalize(projP);","   float sign = 0.0;","   if(normalizedProjP.z > 0.0)","       sign = -1.0;","   else","       sign = 1.0;","   float angle = sign*acos(normalizedProjP.x);","    if (normalizedProjP.x > 0.99999)","        angle = 0.0;","    if (normalizedProjP.x < -0.99999)","        angle = 0.0;","   if(uFlip != 0 && angle > 0.0)","   {","       angle -= 2.0*PI;","   }","   float x = angle / PI;","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   // Final position in projected view space","   vec4 pre_gl_Position_3d;","   vec4 pos = ( viewMatrix  * modelMatrix * vec4(radius*VP, 1.0) );","   pre_gl_Position_3d = projectionMatrix * pos;","   vec4 pre_gl_Position_2d;","   float yangle = asin(VP.y);","   float minangle = 1.31;","   if(yangle < -minangle)","   {","       yangle = -minangle;","   }","   else","   {","       if(yangle > minangle)","       {","           yangle = minangle;","       }","   }","   float y2d = uAspectRatio*log(tan(PI/4.0+yangle*0.5))/ PI;","   pre_gl_Position_2d = vec4(x, y2d, uDz2D, 1.0);","   gl_Position = MixProj*pre_gl_Position_2d + (1.0 - MixProj)*pre_gl_Position_3d;","   //gl_Position = pre_gl_Position_3d;","}",""].join("\n"),this.fragShader=["precision lowp float;","uniform vec4 uColor;","void main() ","{  ","   gl_FragColor = uColor;","   return;","}",""].join("\n"),this.material=this.createPolylineMaterial()}})})),define("DS/SocialGlobe/VisuPatchGround",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SocialGlobe/Matrix4d"],(function(e,t,i,o,a){"use strict";var r=e.extend({init:function(e,i,o){this._parent(),this.tileBag=e,this.quad=void 0,this._mesh=void 0,this.store=i,this.scene=o,this.raster={},this.worldSize=1,this.updated=!1,this.prepareMatrix=new t.Matrix4d,this.matrix=this.prepareMatrix,this.matrixCulling=this.prepareMatrix,this.scale=1,this.halfLength=0,this.normalizedLevel=0,this.scaleXYZ=new t.Vector3(0,0,0),this.pos=new t.Vector3(0,0,0),this.halfHeight=0,this.bc=new t.Color(1,1,1),this.frameId=-1},clone:function(){return new r(this.patchInstance,this.store,this.scene)},update:function(e){this.quad=e,this.normalizedLevel=this.quad.LOD/20;var i=e.Size*this.worldSize;this.halfLength=.5*i,this.pos.x=(e.X+e.Size/2)*this.worldSize,this.pos.y=(e.Y+e.Size/2)*this.worldSize,this.pos.z=0,this.halfHeight=.5*Number.MAX_VALUE,this.prepareMatrix.identity(),this.prepareMatrix.setPosition(this.pos),this.scale=this.halfHeight,this.prepareMatrix.scale(new t.Vector3(this.scale,this.scale,1)),this.updated=!0},display:function(e){if(this.updated&&(this._mesh=this.tileBag.getTile(this.quad.LOD,this.quad.I,this.quad.J),this.scene.addObject(this._mesh),this.updated=!1),!0!==this.done){var i=this.store.getOrDownloadData("ortho",this.quad.LOD,this.quad.I,this.quad.J,e);if(void 0!==i&&((i.LOD===this.quad.LOD||i.isLeaf)&&(this.done=!0),this.raster=i,i.data)){var o=this._mesh.threeMaterial;const e="uOSMSampler";o.updatePDSFXUniform(e,i.data);const a="offset";o.updatePDSFXUniform(a,new t.Vector3(i.offset.x,i.offset.y,i.scale)),o.needsUpdate=!0,o.force=!0}}else this.store.updateTimeStamp("ortho",this.raster.LOD,this.raster.I,this.raster.J);return!0},clear:function(){this.scene.removeObject(this._mesh),this.done=!1,void 0!==this._mesh&&this._mesh.threeMaterial,this.quad={}},updateTimeStamp:function(e){this.raster&&this.store.updateTimeStamp("ortho",this.raster.LOD,this.raster.I,this.raster.J)},updateBound:function(){return!0}});return r})),define("DS/SocialGlobe/PolygonMaker",["UWA/Class","DS/SocialGlobe/Vector2"],(function(e,t){"use strict";var i=e.extend({init:function(){},removeSmallEdges:function(e,i){var o,a,r,s,n,l=0,d=0,c=[];for(c.push(e[0]),o=e[0],l=1;l<e.length;l++)a=e[d],r=e[l],s=t.dist(a,r),n=t.dist(o,r),s>i&&n>i&&(c.push(r),d=l);return c},reduceLoop:function(e,t){var i,o=[];for(i=0;i<e.length;i+=t)o.push(e[i]);return o}});return i.maxDeltaAngle=5,i.minDeltaAngle=.001,i})),define("DS/SocialGlobe/VisuQuadTree",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Disposer","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SocialGlobe/VisuPatchGround"],(function(e,t,i,o,a,r){"use strict";return e.extend({init:function(e,i,o){this.qt=e,this.tilebag=o.tileBag,this.camera=o.camera.threeCamera,this.scene=o.renderer,this.visuStore=o.visuStore,this.levelMax=o.camera.maxlevel,this.projMat=new t.Matrix4,this.frustum=new t.Frustum,this.frameId=0,this.size=1,this.maxNbPatches=i,this.patches={},this.patchReserve=[],this.nbVisiblePatches=0,this.nbPatches=0,this.heightUnderCamera=0,this.boxCulling=0,this.screenBoundingBox=new Array(8),this.boundingBox=[];for(var a=0;a<8;a++)this.boundingBox[a]=new t.Vector4(0,0,0,1);this.outsideFrustum=new Array(5),this.cameraPositionVec4=new t.Vector4(0,0,0,1),this.center=new t.Vector3(0,0,0),this.build()},build:function(){for(var e=0;e<this.maxNbPatches;e++)this.patchReserve.push(this.createPatch())},createPatch:function(){return new r(this.tilebag,this.visuStore,this.scene)},dispose:function(){for(var e in this.patches)this.patches[e].clear(),i.disposeV6(this.patches[e],!0);for(var t=0;t<this.patchReserve.length;t++)i.disposeV6(this.patchReserve[t],!0)},isQuadVisible:function(e){return!0},update:function(e){this.frameId++;var t,i,o,a;this.frameId;for(this.faceCulling=0,this.frustrumCulling=0,t=0,i=this.qt.quads.length;t<i;t++)(o=this.qt.quads[t]).LOD<=this.levelMax&&this.isQuadVisible(o)&&(r=o.LOD+"_"+o.I+"_"+o.J,void 0===(s=this.patches[r])?(void 0===(a=this.patchReserve.pop())&&(a=this.createPatch(),this.maxNbPatches++),a.frameId=this.frameId,a.update(o),this.patches[r]=a):(s.frameId=this.frameId,!0===e&&(s.clear(),s.update(o))));for(var r in this.patches){var s;(s=this.patches[r]).frameId<this.frameId&&(this.patchReserve.push(s),s.clear(),delete this.patches[r])}},traverse:function(e){for(var t in this.patches)e(this.patches[t])},clear:function(){for(var e in this.patches)this.patchReserve.push(this.patches[e]),this.patches[e].clear(),delete this.patches[e]},display:function(e){this.projMat.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.frustum.setFromMatrix(this.projMat),this.nbVisiblePatches=0,this.boxCulling=0;var t=this.camera.position;for(var i in this.cameraPositionVec4.set(t.x,t.y,t.z,1),this.nbPatches=this.maxNbPatches-this.patchReserve.length,this.patches){if(this.patches.hasOwnProperty(i))this.patches[i].display(e)&&this.nbVisiblePatches++}}})})),define("DS/SocialGlobe/PolygonMaker3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/PolygonMaker","DS/SocialGlobe/Mesh","DS/SocialGlobe/Vector2","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils"],(function(e,t,i,o,a,r){"use strict";return t.extend({init:function(e){this._parent(),this.scene=e,this.vertShader=["///attribute vec3 position;","//attribute vec2 uv;","uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","uniform float uAspectRatio;","uniform vec3 offset;","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","void main()","{","/*            gl_Position =   projectionMatrix *","                        viewMatrix *","                        modelMatrix *","                        vec4(position,1.0);","    return;*/","   // Move vertex to proper world position (initial geometry is a cube)","   vec3 OP =  vec4(position,1.0).xyz;","   vec3 VP;","   float radius = 1.0;","   float dz = 0.0;","   if(uNormalize == 1)","   {","//     radius = 0.985;","       radius = 0.998;","       VP = normalize(OP);","       vTextureCoord = VP;","        //vTextureCoord.xy = VP.xy*offset.z + offset.xy;","       vNormal = VP;","       vTangent = normalize(cross(vec3(0,1,0), vNormal));","       vBinormal = normalize(cross(vTangent, vNormal));","   }","   else","   {","       VP = OP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       //vec3 P2 =  normalize( (uMBWMatrix * vec4(position,1.0)).xyz );","       vec3 P2 =  VP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       vTextureCoord = vec3(uv.xy, 1.0);","        vTextureCoord.xy = offset.z * uv.xy + offset.xy;","       vNormal = position;","       vTangent = normalize(cross(vec3(0,1,0), VP));","       vBinormal = normalize(cross(vTangent, VP));","   }","   vec3 projP = vec3(VP.x, 0.0, VP.z);","   if(length(projP) < 0.001)","   {","       projP = vec3(1.0, 0.0, 1.0);","   }","   vec3 normalizedProjP = normalize(projP);","   float sign = 0.0;","   if(normalizedProjP.z > 0.0)","       sign = -1.0;","   else","       sign = 1.0;","   float angle = sign*acos(normalizedProjP.x);","    if (normalizedProjP.x > 0.99999)","        angle = 0.0;","    if (normalizedProjP.x < -0.99999)","        angle = 0.0;","   if(uFlip != 0 && angle > 0.0)","   {","       angle -= 2.0*PI;","   }","   float x = angle / PI;","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   // Final position in projected view space","   vec4 pre_gl_Position_3d;","   vec4 pos = ( viewMatrix  * modelMatrix * vec4(radius*VP, 1.0) );","   pre_gl_Position_3d = projectionMatrix * pos;","   vec4 pre_gl_Position_2d;","   float yangle = asin(VP.y);","   float minangle = 1.31;","   if(yangle < -minangle)","   {","       yangle = -minangle;","   }","   else","   {","       if(yangle > minangle)","       {","           yangle = minangle;","       }","   }","   float y2d = uAspectRatio*log(tan(PI/4.0+yangle*0.5))/ PI;","   pre_gl_Position_2d = vec4(x, y2d, uDz2D, 1.0);","   gl_Position = MixProj*pre_gl_Position_2d + (1.0 - MixProj)*pre_gl_Position_3d;","   //gl_Position = pre_gl_Position_3d;","}",""].join("\n"),this.fragShader=["precision lowp float;","uniform vec4 uColor;","void main() ","{  ","   gl_FragColor = uColor;","   return;","}",""].join("\n")}})})),define("DS/SocialGlobe/MarkerMaker3D",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/SocialGlobe/ShaderTools"],(function(e,t,i,o,a,r,s,n){"use strict";return e.extend({init:function(e){this.scene=e;var t=a.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/natural/marker/");this.back=o.ImageUtils.loadTexture(t+"markerBack128.png",void 0,(function(){}),void 0,!0),this.color=o.ImageUtils.loadTexture(t+"markerColor.png",void 0,(function(){}),void 0,!0),this.pickBack=o.ImageUtils.loadTexture(t+"markerBack64.png",void 0,(function(){}),void 0,!0);var i="MakerClearDepthPass",n=new s(i);if(n.defaults.clear=!1,n.defaults.doClearDepth=!0,this.scene.getRenderPassManager().addPass(i,n,{after:"CountryPassID"}),this._Maker3DPassID="noz",void 0===this.scene.getRenderPassManager().getPass(this._Maker3DPassID)){var l=new r(null,null,void 0,!0,!0,!1,this._Maker3DPassID);l.idString=this._Maker3DPassID,this.scene.getRenderPassManager().addPass(this._Maker3DPassID,l,{after:i})}this.markerShader_PDSFX={attributes:{},uniforms:{uFlip:{type:"i"},uNormalize:{type:"i",value:this.intensity},uMixProj:{type:"f",value:.5},uAspectRatio:{type:"f",value:1},uOSMMode:{type:"i"},uMarkerScale:{type:"f",value:1},uDz2D:{type:"f"},uBackSampler:{type:"t2",value:this.back},uColorSampler:{type:"t2",value:this.color}},varyings:{vTextureCoord:{type:"v3"},vNormal:{type:"v3"},vTangent:{type:"v3"},vBinormal:{type:"v3"},testpos:{type:"v3"}},VS_global_code:["const float PI = 3.14159;"].join("\n"),VS_overridableFunctions:{ProcessClipSpacePosition:["   // Move vertex to proper world position (initial geometry is a cube)","vec4 texCoord = vGetAttribTexCoord0();","   vec3 OP =  vGetAttribPosition();  ","   vec3 VP;","   float radius = 1.0;","       VP = OP;","       vTextureCoord = vec3(vec2(0.5+0.5*texCoord.x, 0.5+0.5*texCoord.y), 1.0);    ","       vNormal = vGetAttribNormal();","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   vec4 pre_gl_Position_3d;"," vec4 pos = vGetProjectionMatrix() * vGetWorldViewMatrix() * vec4(radius*VP, 1.0);","   pre_gl_Position_3d = pos;","   vec2 posOnScreen = (1.0/pre_gl_Position_3d.w)*pre_gl_Position_3d.xy;","   vec3 cameraPos = vGetWorldEyePos();","   float distanceToGround = length(cameraPos) - 1.0;","   vec2 dp = vec2(posOnScreen.x, posOnScreen.y+1.0/(distanceToGround*distanceToGround));","   vec2 vy = uMarkerScale*0.04*normalize(vec2(dp.x, dp.y));","   vec2 vx = uMarkerScale*0.04*normalize(vec2(dp.y, -dp.x));","    if(dot(cameraPos, VP) > 0.0)","    {","        pre_gl_Position_3d += pre_gl_Position_3d.w*vec4((texCoord.x*vx.x+(1.0+texCoord.xy.y)*vy.x)/uAspectRatio, texCoord.x*vx.y+(1.0+texCoord.y)*vy.y, 0,0);","}","   ","ioPosition = pre_gl_Position_3d;",""].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["   vec4 back = texture2D(uBackSampler, vTextureCoord.xy);","   vec4 colorIntensity = texture2D(uColorSampler, vTextureCoord.xy);","   ioFinalColor = vec4(colorIntensity.a * colorIntensity.r * vNormal.r + (1.0 - colorIntensity.a) * back.r,","       colorIntensity.a * colorIntensity.g * vNormal.g + (1.0 - colorIntensity.a) * back.g,","       colorIntensity.a * colorIntensity.b * vNormal.b + (1.0 - colorIntensity.a) * back.b,","       back.a);","   if(ioFinalColor.a < 0.5) discard;"].join("\n")}},this.materials=this.createMarkerMaterials(),this.customMarkerMaterials=[]},incrementShadersLoaded:function(e,t){t},createRenderable:function(e,o,a){var r,s,n=new i(this.scene,"MarkerMaker",void 0,this._Maker3DPassID);for(r=0;r<e.length;r++)if(void 0!==(s=!0===a?e[r]:e[r][0])){var l=t.htmlToRGB(s.getCurrentColor());n.addVertex(s.position.x,s.position.y,s.position.z,l[0],l[1],l[2],[[-1,-1]]),n.addVertex(s.position.x,s.position.y,s.position.z,l[0],l[1],l[2],[[-1,1]]),n.addVertex(s.position.x,s.position.y,s.position.z,l[0],l[1],l[2],[[1,1]]),n.addVertex(s.position.x,s.position.y,s.position.z,l[0],l[1],l[2],[[1,-1]]),n.addFace([1+4*r,4*r,2+4*r]),n.addFace([2+4*r,4*r,3+4*r])}return o?(n.setMaterial(o.material),n.setPickMaterial(o.pickMaterial)):(n.setMaterial(this.materials.material),n.setPickMaterial(this.materials.pickMaterial)),n.endMesh({depth:0,pickable:"occulting"}),[n]},createMarkerMaterials:function(){var e=this.scene.canvas;if(this.shadersLoaded<4)return{material:t.defaultMaterial,pickMaterial:t.defaultMaterial};var i=n.getPDSFXMaterial([this.markerShader_PDSFX],"physical");i.force=!0,i.transparent=!0,i.side=o.DoubleSide,i.forceSide=!0;var a=JSON.parse(JSON.stringify(this.markerShader_PDSFX));a.uniforms.uAspectRatio={type:"f",value:e.width/e.height},a.uniforms.uBackSampler={type:"t2",value:this.pickBack},a.FS_overridableFunctions={ProcessFinalColor:["   vec4 back = texture2D(uBackSampler, vTextureCoord.xy);","   vec4 colorIntensity = texture2D(uColorSampler, vTextureCoord.xy);","   ioFinalColor = vec4(colorIntensity.a * colorIntensity.r * vNormal.r + (1.0 - colorIntensity.a) * back.r,","       colorIntensity.a * colorIntensity.g * vNormal.g + (1.0 - colorIntensity.a) * back.g,","       colorIntensity.a * colorIntensity.b * vNormal.b + (1.0 - colorIntensity.a) * back.b,","       back.a);","   if(ioFinalColor.a < 0.5) discard;"].join("\n")};var r=n.getPDSFXMaterial([a],"physical");return r.depthTest=!1,r.force=!0,{material:i,pickMaterial:r}},createMarkerCustomMaterials:function(e){var i=this.scene.canvas;if(this.shadersLoaded<4)return{material:t.defaultMaterial,pickMaterial:t.defaultMaterial};var a=o.ImageUtils.loadTexture(e,void 0,(function(){}),void 0,!1),r=JSON.parse(JSON.stringify(this.markerShader_PDSFX));r.FS_overridableFunctions={ProcessFinalColor:["    ioFinalColor = texture2D(uBackSampler, vTextureCoord.xy);"].join("\n")},r.uniforms.uAspectRatio={type:"f",value:i.width/i.height},r.uniforms.uBackSampler={type:"t2",value:a};var s=n.getPDSFXMaterial([r],"physical");s.depthTest=!1,s.force=!0,s.transparent=!0;var l=JSON.parse(JSON.stringify(this.markerShader_PDSFX));l.uniforms.uAspectRatio={type:"f",value:1},l.uniforms.uBackSampler={type:"2",value:a};var d=n.getPDSFXMaterial([l],"physical");return d.depthTest=!1,d.force=!0,{material:s,pickMaterial:d}},updateMaterialUniforms:function(e){if(e._PDSFXData&&e._PDSFXData.PDSFX){var t=this.scene.canvas,i="uAspectRatio";e.updatePDSFXUniform(i,t.width/t.height),e.getPDSFXUniform("uMarkerScale")&&e.updatePDSFXUniform("uMarkerScale",.25*(this.scene.camera.level>6?6:this.scene.camera.level+1))}else{t=this.scene.canvas,i="uAspectRatio";e.uniforms[i].value=t.width/t.height,e.uniforms&&e.uniforms.uMarkerScale&&(e.uniforms.uMarkerScale.value=.25*(this.scene.camera.level>6?6:this.scene.camera.level+1)),e.needsUpdate=!0}},updateMaterialBeforeDraw:function(){this.updateMaterialUniforms(this.materials.material),this.updateMaterialUniforms(this.materials.pickMaterial)}})})),define("DS/SocialGlobe/Camera3D",["UWA/Class/Events","DS/SocialGlobe/Globals","DS/SocialGlobe/Camera","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/Gestures/MouseDownGesture","DS/Gestures/MouseUpGesture","DS/Gestures/MouseMoveGesture","DS/Gestures/MouseOutGesture","DS/Gestures/MouseWheelGesture","DS/Gestures/DoubleClickGesture","DS/Gestures/ClickGesture","DS/Gestures/TouchGesture","DS/Gestures/PinchGesture","DS/Gestures/ReleaseGesture","DS/Gestures/PanGesture"],(function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m,f,v){"use strict";return i.extend(e,{init:function(e,t){this._parent(e,t),this.viewAngle=25,this.near=9e-5,this.far=25,this.lookAt=new o.Vector3(0,0,0),this.moving=!1,this.unzoomButton=null;var i,p=e.getCanvas();i=p.width/p.height,this.v6Viewpoint=new a({viewer:e.v6Viewer}),this.threeCamera=new o.PerspectiveCamera(this.viewAngle,i,this.near,this.far),this.v6Viewpoint.camera=this.threeCamera,this.control=this.v6Viewpoint.control,r.addGestureRecognizer(new d),r.addGestureRecognizer(new h),r.addGestureRecognizer(new c),r.addGestureRecognizer(new n(s.MouseButton.LEFT)),r.addGestureRecognizer(new n(s.MouseButton.RIGHT)),r.addGestureRecognizer(new n(s.MouseButton.WHEEL)),r.addGestureRecognizer(new n(s.MouseButton.MIDDLE)),r.addGestureRecognizer(new l(s.MouseButton.LEFT)),r.addGestureRecognizer(new l(s.MouseButton.RIGHT)),r.addGestureRecognizer(new l(s.MouseButton.MIDDLE)),r.addGestureRecognizer(new m);var f=new g(s.MouseButton.LEFT),v=new u(s.MouseButton.LEFT);v.requireGesture(f),v.maxTime=400,r.addGestureRecognizer(f),r.addGestureRecognizer(v),this.updateCamera()},updateCamera:function(){if(Math.abs(this.deltaXCamera)>1e-4||Math.abs(this.deltaYCamera)>1e-4){var e=.005*(this.dist-1);this.camPosition.x-=this.deltaXCamera*e,this.camPosition.y=Math.min(1,Math.max(0,this.camPosition.y-this.deltaYCamera*e)),this.lat=t.tile2lat(0,this.camPosition.y),this.lon=t.tile2lon(0,this.camPosition.x),this.lon=this.correctLon(this.lon),this.deltaXCamera-=.1*this.deltaXCamera,this.deltaYCamera-=.1*this.deltaYCamera,this.changed=!0,this.moving||(this.dispatchEvent("cameraMoveStart",["null"]),this.moving=!0)}else this.deltaXCamera=0,this.deltaYCamera=0,this.moving&&(this.moving=!1,this.dispatchEvent("cameraMoveEnd",["null"]));null!==this.unzoomButton&&this.dist<6?this.unzoomButton.style.display="block":null!==this.unzoomButton&&(this.unzoomButton.style.display="none");var i=this.level,a=this.getLevel(256,this.maxlevel,0,this.dist-1);!isNaN(a)&&this.minlevel<=a?this.level=a:this.level=this.minlevel,this.level!=i&&(this.levelChanged=!0,this.changed=!0);var r=.25*(this.level>6?6:this.level+1);this.level<=6?this.near=.01/r:this.near=9e-5/(r/4e-6),this.threeCamera.near=this.near,this.updateSingleThreeCamera(this.threeCamera),this.threeCamera.updateProjectionMatrix(),this.threeCamera.projectionMatrixInverse.getInverse(this.threeCamera.projectionMatrix),this.threeCamera.updateMatrixWorld(),this.threeCamera.matrixWorldInverse.getInverse(this.threeCamera.matrixWorld),this.totalTransfo=new o.Matrix4,this.totalTransfo.multiplyMatrices(this.threeCamera.projectionMatrix,this.threeCamera.matrixWorldInverse)},getLevel:function(e,t,i,o){var a=this.minlevel;if(0===this.renderer.mixProj)for(var r=Math.min(5,Math.ceil(Math.max(this.renderer.getCanvas().width,this.renderer.getCanvas().height)/e)),s=r/(1<<a-1),n=2*Math.tan(this.threeCamera.fov/2*Math.PI/180)*o;s>n&&a<this.maxlevel;)s=r/(1<<++a-1);return a},updateSingleThreeCamera:function(e){var i=t.latlonToXYZ(this.lat,this.lon);i.multiplyScalar(this.dist),e.position=i,e.lookAt(this.lookAt)},getTilesToDisplay:function(){var e=2+Math.ceil(Math.max(this.renderer.getCanvas().width,this.renderer.getCanvas().height)/256);return{xtile0:Math.max(0,Math.floor(t.lon2tileFlt(this.lon,this.level-1))-Math.floor(e/2)),ytile0:Math.max(0,Math.floor(t.lat2tileFlt(this.lat,this.level-1))-Math.floor(e/2)),size:Math.min(e,1<<this.level-1),level:this.level-1}},getZoomCoeff:function(){return(this.maxdist-1)/(this.dist-1)},computeDist:function(e,i,o,a,r,s){var n=360*Math.pow(2,-o),l=t.latlonToXYZ(0,0-.5*n),d=t.latlonToXYZ(0,0+.5*n),c=l.distanceTo(d),h=Math.PI*r/180;return 400*c/(2*s*Math.tan(h/2))}})})),define("DS/SocialGlobe/CountryManager",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Utils","DS/SocialGlobe/Globals","marked/marked","DS/SocialGlobe/assets/purify/purify.min"],(function(e,t,i,o,a,r){"use strict";var s=e.extend({init:function(e,t,i){this._manager=e,this.ID=t,this.ISO3=i,this.title=i,this.infos=null,this.color=null,this.colorOverride=null,this.initDescription(),this.isEdited=!1,this.persist=!1},initDescription:function(){this.descriptionType="text",this.description="",this.link=void 0,this.width=void 0,this.height=void 0},getID:function(e){return this.ID},type:"Country",getTitle:function(){return this.ISO3},getDescription:function(){return this.description},htmlDefined:function(){return!1},htmlContent:function(){var e=this.description;return"marked"===this.descriptionType&&(e=a(this.description),e=this.htmlEncode(e)),o.countries?(void 0!==this.title&&""!==this.title?"<b>"+o.countries[this.title]+"</b><br>":"")+e:(void 0!==this.title&&""!==this.title?"<b>"+this.title+"</b><br>":"")+e},setColor:function(e){return this.color=e,this._manager&&this._manager.refreshCountry(this.ID),this},overrideHtmlColor:function(e){return this.colorOverride=e?o.htmlToRGB(e):null,this._manager&&this._manager.refreshCountry(this.ID),this},getHtmlColor:function(){return this.color?o.rgbToHtml(this.color):""},setHtmlColor:function(e){return this},isValidContent:function(){return void 0!==this.title&&""!==this.title||void 0!==this.description&&""!==this.description||void 0!==this.link&&""!==this.link},htmlEncode:function(e){return r.sanitize(e)}});return e.extend({init:function(e){this._scene=e,this.countries=[],this.selectedCountries=[],this.ISO3Table={ABW:0,AFG:1,AGO:2,AIA:3,ALB:4,ALA:5,ARE:7,ARG:8,ATF:10,ATG:11,AUS:12,AUT:13,AZE:14,BDI:15,BEL:16,BEN:17,BFA:18,BGD:19,BGR:20,BHR:21,BHS:22,BIH:23,BLM:24,BLR:25,BLZ:26,BMU:27,BOL:28,BRA:29,BRB:30,BRN:31,BTN:32,BWA:33,CAF:34,CHE:35,CHN:36,CIV:37,CMR:38,COD:39,COG:40,COK:41,COL:42,COM:43,CPV:44,CRI:45,CUB:46,CUW:47,CYM:48,CYP:50,CZE:51,DEU:52,DJI:53,DMA:54,DNK:55,DOM:56,DZA:57,EGY:58,ERI:59,ESP:60,EST:61,ETH:62,FIN:63,FJI:64,FLK:65,FRA:66,FRO:67,FSM:68,GAB:69,GBR:71,GEO:72,GHA:73,GIN:74,GMB:75,GNB:76,GNQ:77,GRC:78,GRD:79,GRL:80,GTM:81,GUM:82,GUY:83,HKG:84,HMD:85,HND:86,HRV:87,HTI:88,HUN:89,IDN:90,IMN:91,IND:92,IOT:94,IRL:95,IRN:96,IRQ:97,ISL:98,ISR:99,ITA:100,JAM:101,JEY:102,JOR:103,JPN:104,KAZ:105,KEN:106,KGZ:107,KHM:108,KIR:109,KNA:110,KOR:111,KWT:113,LAO:114,LBN:115,LBR:116,LBY:117,LCA:118,LIE:119,LKA:120,LSO:121,LTU:122,LUX:123,LVA:124,MAF:125,MAR:126,MDA:127,MDG:128,MDV:129,MEX:130,MHL:131,MKD:132,MLI:133,MLT:134,MMR:135,MNE:136,MNG:137,MNP:138,MOZ:139,MRT:140,MSR:141,MUS:142,MWI:143,MYS:144,NAM:145,NCL:146,NER:147,NGA:148,NIC:149,NIU:150,NLD:151,NOR:152,NPL:153,NRU:154,NZL:155,OMN:156,PAK:157,PAN:158,PCN:159,PER:160,PHL:161,PLW:162,PNG:163,POL:164,PRI:165,PRK:166,PRT:167,PRY:168,PYF:169,QAT:170,ROU:171,RUS:232,RWA:173,SAU:174,SDN:175,SEN:177,SSD:176,SGS:178,SHN:179,SJM:180,SLB:181,SLE:182,SLV:183,SOM:184,SPM:185,SRB:186,STP:187,SUR:188,SVK:189,SVN:190,SWE:191,SWZ:192,SXM:193,SYC:194,SYR:195,TCA:196,TCD:197,TGO:198,THA:199,TJK:200,TKM:201,TLS:202,TON:203,TTO:204,TUN:205,TUR:206,TWN:207,TZA:208,UGA:209,UKR:210,URY:211,USA:212,UZB:213,VCT:214,VNM:217,VUT:218,WLF:220,WSM:221,YEM:222,ZMB:223,ZWE:224,ZAF:225,VEN:226,CAN:227,GGY:230,CHL:229,ECU:230,SOM2:231,RUS2:235,"":219}},getIndexFromISO3:function(e){var t=this.ISO3Table[e];return null!==t?t:-1},getISO3FromIndex:function(e){var t=this.ISO3Table;return Object.keys(t).filter((function(i){return t[i]==e}))},getCountries:function(){for(var e=[],t=0;t<this.countries.length;t++)this.countries[t]&&(this.countries[t].color||this.countries[t].description)&&e.push(this.countries[t]);return e},get:function(e){var t=this.countries[e];return t||(t=new s(this,e,this.getISO3FromIndex(e)),this.countries[e]=t),t},setColor:function(e,t){this.get(e).setColor(t);return this},getColor:function(e){var t=this.countries[e];return t?t.color:null},clear:function(){this.clearColors(),this.countries=[]},clearColors:function(){for(var e=0;e<this.countries.length;e++)this.countries[e]&&this.countries[e].color&&(this.countries[e].color=null,this._renderer&&this._renderer.refreshCountry(this.countries[e]))},setRenderer:function(e){this._renderer=e;for(var t=0;t<this.countries.length;t++)this.countries[t]&&this._renderer&&this._renderer.refreshCountry(this.countries[t])},refreshCountry:function(e){this._renderer&&this._renderer.refreshCountry(this.countries[e])},refresh:function(){for(var e in this.countries)this.countries[e].color&&this._renderer&&this._renderer.refreshCountry(this.countries[e])},getSelectedCountries:function(){return this.selectedCountries}})})),define("DS/SocialGlobe/RenderContext",["UWA/Class","DS/SocialGlobe/TileBag3D","DS/SocialGlobe/PolygonMaker3D","DS/SocialGlobe/PolylineMaker3D","DS/SocialGlobe/MarkerMaker3D","DS/SocialGlobe/Renderer3D","DS/SocialGlobe/Camera3D","DS/SocialGlobe/GlobeLoader3D"],(function(e,t,i,o,a,r,s,n){"use strict";return e.extend({init:function(e){this.type=e},buildTileBag:function(e){var i=new t(e);return i.renderContext=this,i},buildMarkerMaker:function(e){var t=new a(e);return t&&(t.renderContext=this),t},buildPolylineMaker:function(e){var t=new o(e);return t&&(t.renderContext=this),t},buildPolygonMaker:function(e){var t=new i(e);return t&&(t.renderContext=this),t},buildGlobeLoader:function(e,t){var i=new n(e,t);return i&&(i.renderContext=this),i},buildRenderer3D:function(e,t,i){return new r(this,e,t,i)},buildCamera:function(e,t){var i=new s(e,t);return i.renderContext=this,i}})})),define("DS/SocialGlobe/DataModel",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/MarkerBag","DS/SocialGlobe/CountryManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/GeometryHelper","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/MarkerCluster"],(function(e,t,i,o,a,r,s,n,l,d,c){"use strict";return e.extend({init:function(e){this.globe=e,this.globe.use2D?this.layersToLoop=[]:(this.markerBag=new i(this.globe.renderer),this.countryManager=new o(this.globe.renderer),this._selections=[],this._lastSelectedCountry=null,this.tagsSet=!1,this._loadedFeatures=null,this._filteredFeatures=[],this._markerCluster=null,this._clustering=!1,this.maxLevel=10)},build:function(e,i,o,r){if(this._loadedFeatures=new Map,this.globe.use2D){this.firstLaunch=!0;for(l=0;l<e.length;l++){if((c=e[l]).geometry&&("Point"==c.geometry.type||"Polygon"==c.geometry.type)){h=c.properties;u=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)));if(h.tags){m="";for(g=0;g<h.tags.length;g++){m+=JSON.stringify({tagName:h.tags[g].tagName,tagValue:h.tags[g].tagValue})}(p=this._loadedFeatures.get(m))?p.push(c):p=[c],this._loadedFeatures.set(m,p)}else this._loadedFeatures.set(u,[c])}}r&&(console.log("update loaded data 2d"),this.updateLoadedData2D(r,!1))}else{this.inverseLatLon=i;for(var l=0;l<e.length;l++){var c;if((c=e[l]).geometry)switch(c.geometry.type){case"Point":var h=c.properties;c.properties.color&&(c.properties.colorBackup=c.properties.color);var u=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)));if(h.tags){var g,p,m="";for(g=0;g<h.tags.length;g++){m+=JSON.stringify({tagName:h.tags[g].tagName,tagValue:h.tags[g].tagValue})}(p=this._loadedFeatures.get(m))?p.push(c):p=[c],this._loadedFeatures.set(m,p)}else this._loadedFeatures.set(u,[c]);break;case"LineString":var f=c.geometry.coordinates,h=c.properties;if(f){var v=this.globe.renderer.v6SceneGraph,b=h.color,w=h.altitude,x=(h.tesselate&&h.tesselate,h.altitudeScale?h.altitudeScale:1);if("clamptoground"===w||"auto"===w)for(var y=0;y<f.length-1;y++){var C=f[y],S=f[y+1],M=0;"auto"===w&&(M=2e6*x);var D=t.createCurvePath(C,S,M,i);(P=new a.LineBasicMaterial({color:b,linewidth:40})).force=!0;var _=(new n).createLine(D.createPointsGeometry(40).vertices),k=s.createMeshNode(_,P);v.add(k)}else if("relative"===w){var P=new a.LineBasicMaterial({color:b,linewidth:40});_=(new n).createLine(f),k=s.createMeshNode(_,P);v.add(k)}}break;case"Polygon":h=c.properties;var T=this.globe.getCountryManager().get(this.globe.getCountryManager().getIndexFromISO3(h.ISO3));T.setHtmlColor(h.color),h.descriptionType?T.descriptionType=h.descriptionType:h.link&&(options.descriptionType="html"),T.description=h.description,T.link=h.link,T.width=h.width,T.height=h.height,T.persist=h.persist,T.uuid=h.uuid,T&&"html"===T.descriptionType&&T.persist&&d.addMarkerInfo(T,!0)}}r?this.updateLoadedData(r,!1):this.buildFeatures(e,this.inverseLatLon)}},saveToGeoJSON:function(){return this.exportToFeatures()},exportToFeatures:function(){var e=[],t={type:"FeatureCollection",features:e};if(this.globe.use2D)this.globe.map.eachLayer((function(t){if(!t.external&&(t instanceof L.Marker&&(console.log(t.style_properties.color),e.push({type:"Feature",properties:{title:t.title,description:t.description,link:t.link,image:t.image,descriptionType:t.descriptionType,width:t.width,height:t.height,persist:t.persist,uuid:t.options.uuid,saved:!0},style_properties:{color:t.style_properties.color},geometry:{type:"Point",coordinates:[t._latlng.lng,t._latlng.lat]}})),t instanceof L.Polygon&&void 0===t.options.notSave&&1!=t.options.notSave)){var i=t.toGeoJSON().geometry;e.push({type:"Feature",properties:{title:t.title,color:t.color,strokeColor:t.strokeColor,description:t.description,link:t.link,image:t.image,descriptionType:t.descriptionType,width:t.width,height:t.height,persist:t.persist,uuid:t.options.uuid,saved:!0},geometry:i})}}));else{for(var i=this.markerBag.allMarkers,o=0;o<i.length;o++){var a=i[o];a.readOnly||e.push({type:"Feature",properties:{title:a.title,color:a.color,altitude:a.alt,description:a.description,link:a.link,image:a.image,descriptionType:a.descriptionType,width:a.width,height:a.height,persist:a.persist,uuid:a.uuid},geometry:{type:"Point",coordinates:[a.lat,a.lon]}})}var r=this.countryManager.getCountries();for(o=0;o<r.length;o++){var s=r[o];s.readOnly||e.push({type:"Feature",properties:{color:s.getHtmlColor(),ISO3:s.ISO3,description:s.description,descriptionType:s.descriptionType,link:s.link,width:s.width,height:s.height,persist:s.persist,uuid:s.uuid},geometry:{type:"Polygon"}})}}return t},getMarkerManager:function(){return this.markerBag},getCountryManager:function(){return this.countryManager},getPolylineManager:function(){},refresh:function(){this.countryManager.refresh()},addMarker:function(e,t,i,o,a,r,s,n,l,d=!1){return this.markerBag.createMarker(e,t,i,o,a,r,s,n,l,d)},addCluster:function(e,t,i,o,a,r,s,n,l,d=!1){return this.markerBag.createCluster(e,t,i,o,a,r,s,n,l,d)},deleteSelection:function(e,t){var i=[];if(t.marker){for(var o=0;o<e.length;o++)"Marker"===e[o].type&&(e[o].overrideHtmlColor(),i.push(e[o]));i.length&&this.markerBag.removeMarkers(i)}if(t.country)for(o=0;o<e.length;o++)"Country"===e[o].type&&(e[o].setColor(),e[o].overrideHtmlColor());this.globe.markerInfo.show(!1)},getSelection:function(){return this._selections},setSelection:function(e){for(var t=0;t<this._selections.length;t++)this._selections[t].overrideHtmlColor();this._selections=e;for(t=0;t<e.length;t++)e[t].overrideHtmlColor("#006699")},getLastSelectedCountry:function(){return this._lastSelectedCountry},setLastSelectedCountry:function(e){this._lastSelectedCountry=e},clearSelection:function(){for(var e=0;e<this._selections.length;e++)this._selections[e].overrideHtmlColor();this._selections=[]},hover:function(e){e?(this.elementHovered&&e.getID()===this.elementHovered.getID()||(!this.elementHovered||this._selections.length&&this._selections[0].getID()===this.elementHovered.getID()||this.elementHovered.overrideHtmlColor(),this._selections.length&&this._selections[0].getID()===e.getID()||e.overrideHtmlColor("#3399cc")),this.elementHovered=e):this.elementHovered&&(this._selections.length&&this._selections[0].getID()===this.elementHovered.getID()||this.elementHovered.overrideHtmlColor(),this.elementHovered=void 0)},addMarkerInfosFrames:function(){for(var e=this.markerBag.allMarkers,t=0;t<e.length;t++){var i=e[t];i&&"html"===i.descriptionType&&i.persist&&d.addMarkerInfo(i)}},updateLoadedData:function(e,t,i){this._filteredFeatures=[];var o=0,a=0,r=[];if(e){if(r=e.getCurrentFilter().allfilters,this.myTags=new Map,this._loadedFeatures&&this._loadedFeatures.forEach(function(e,t,i){if(r&&Object.keys(r).length>0){var s=!0;for(var n in t=t.replace("[","").replace("]",""),r)if(r.hasOwnProperty(n)){var d=l.get("GlobeViewer.TagsReverse."+n);d=d.contains("GlobeViewer.TagsReverse.")?n:d;var c=JSON.stringify({tagName:d,tagValue:r[n][0].object});c=c.replace("[","").replace("]","").replace("}",""),s=s&&t.includes(c)}if(s){for(h=0;h<e.length;h++)this._filteredFeatures.push(e[h]),o+=e[h].geometry.coordinates[1],a+=e[h].geometry.coordinates[0];if(e.length>0&&e[0].properties.tags){for(u=0;u<e[0].properties.tags.length;u++){g=JSON.stringify({tagName:e[0].properties.tags[u].tagName,tagValue:e[0].properties.tags[u].tagValue}),(p=this.myTags.get(g))?p+=e.length:p=e.length,this.myTags.set(g,p)}}}}else{var h;for(h=0;h<e.length;h++)this._filteredFeatures.push(e[h]),o+=e[h].geometry.coordinates[1],a+=e[h].geometry.coordinates[0];if(e.length>0&&e[0].properties.tags){var u;for(u=0;u<e[0].properties.tags.length;u++){var g,p;g=JSON.stringify({tagName:e[0].properties.tags[u].tagName,tagValue:e[0].properties.tags[u].tagValue}),(p=this.myTags.get(g))?p+=e.length:p=e.length,this.myTags.set(g,p)}}}}.bind(this)),i&&(i=i.toLowerCase(),this._filteredFeatures=this._filteredFeatures.filter((function(e){var t,r=!1;if(e.properties)for(t in Object.keys(e.properties)){var s=Object.keys(e.properties)[t];r=(r=r||s.toLowerCase().contains(i))||JSON.stringify(e.properties[s]).toLowerCase().contains(i)}return r||(a-=e.geometry.coordinates[0],o-=e.geometry.coordinates[1]),r}))),this._filteredFeatures.length>0&&t&&(this.inverseLatLon?this.globe.turnGlobeToLatLon(o/this._filteredFeatures.length,a/this._filteredFeatures.length,4):this.globe.turnGlobeToLatLon(a/this._filteredFeatures.length,o/this._filteredFeatures.length,4)),e){var s=[];this.myTags.forEach((function(e,t,i){var o=JSON.parse(t),a=o.tagName,r=o.tagValue,n=e,d=l.get("GlobeViewer.Tags."+a),c={sixw:d=d.contains("GlobeViewer.Tags.")?a:d,object:r,count:n,field:"implicit",dispValue:r};""!=c.dispValue&&s.push(c)})),e.setTags(void 0,s),this.tagsSet=!0}!0===this._clustering?(this._markerCluster=new c(this.maxLevel),this._markerCluster.load(this._filteredFeatures),this.buildClusters(this._filteredFeatures,this.inverseLatLon)):this.buildFeatures(this._filteredFeatures,this.inverseLatLon)}this.globe.loadingInfo.hide()},updateLoadedData2D:function(e,t,i,o){t?this.saved3DSearch=i?null:t:i&&(this.saved3DSearch=null),this._filteredFeatures=[];var a=[];if(e){if(a=e.getCurrentFilter().allfilters,this.myTags=new Map,this._loadedFeatures){if(this.firstLaunch)this._loadedFeatures.forEach(function(e,t,i){if(a&&Object.keys(a).length>0){var o=!0;for(var r in t=t.replace("[","").replace("]",""),a)if(a.hasOwnProperty(r)){var s=l.get("GlobeViewer.TagsReverse."+r);s=s.contains("GlobeViewer.TagsReverse.")?r:s;var n=JSON.stringify({tagName:s,tagValue:a[r][0].object});n=n.replace("[","").replace("]","").replace("}",""),o=o&&t.includes(n)}if(o){for(d=0;d<e.length;d++)this._filteredFeatures.push(e[d]);if(e.length>0&&e[0].properties.tags){for(c=0;c<e[0].properties.tags.length;c++){h=JSON.stringify({tagName:e[0].properties.tags[c].tagName,tagValue:e[0].properties.tags[c].tagValue}),(u=this.myTags.get(h))?u+=e.length:u=e.length,this.myTags.set(h,u)}}}}else{var d;for(d=0;d<e.length;d++)this._filteredFeatures.push(e[d]);if(e.length>0&&e[0].properties.tags){var c;for(c=0;c<e[0].properties.tags.length;c++){var h,u;h=JSON.stringify({tagName:e[0].properties.tags[c].tagName,tagValue:e[0].properties.tags[c].tagValue}),(u=this.myTags.get(h))?u+=e.length:u=e.length,this.myTags.set(h,u)}}}}.bind(this)),this.firstLaunch=!1;else{var r=0,s=0;this.layersToLoop=[],o?this.layersToLoop=this.unclusteredLayerGroup:this.globe.map.eachLayer(function(e){this.layersToLoop.push(e),e._latlng&&(r+=e._latlng.lat,s+=e._latlng.lng)}.bind(this));for(var n=this.layersToLoop.length,d=0;d<this.layersToLoop.length;d++){if((C=this.layersToLoop[d])instanceof L.Marker||C instanceof L.Polygon){var c=C.feature_properties;([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)));if(c.tags){var h="";for(w=0;w<c.tags.length;w++){h+=v=JSON.stringify({tagName:c.tags[w].tagName,tagValue:c.tags[w].tagValue})}C.feature_properties.tagKeys=h}else C.feature_properties.tagKeys="";if(a&&Object.keys(a).length>0){var u=C.feature_properties.tagKeys,g=!0;for(var p in u=u.replace("[","").replace("]",""),a)if(a.hasOwnProperty(p)){var m=l.get("GlobeViewer.TagsReverse."+p);m=m.contains("GlobeViewer.TagsReverse.")?p:m;var f=JSON.stringify({tagName:m,tagValue:a[p][0].object});f=f.replace("[","").replace("]","").replace("}",""),g=g&&u.includes(f)}if(g||(this.globe.hideLayer(C),n-=1,r-=C._latlng.lat,s-=C._latlng.lng,C instanceof L.Marker?C.tagFiltered=!1:C instanceof L.Polygon&&(C._path.tagFiltered=!1)),g&&(C instanceof L.Marker?(C.tagFiltered=!0,(!this.saved3DSearch||this.saved3DSearch&&C.searchFiltered)&&this.globe.showLayer(C)):C instanceof L.Polygon&&(C._path.tagFiltered=!0,(!this.saved3DSearch||this.saved3DSearch&&C._path.searchFiltered)&&this.globe.showLayer(C)),C&&C.feature_properties.tags)){h="";for(w=0;w<C.feature_properties.tags.length;w++){h+=v=JSON.stringify({tagName:C.feature_properties.tags[w].tagName,tagValue:C.feature_properties.tags[w].tagValue}),(b=this.myTags.get(v))?b+=1:b=1,this.myTags.set(v,b)}}}else if(C instanceof L.Marker?(C.tagFiltered=!0,C._icon&&"none"!=C._icon.style.display||!C.searchFiltered||this.globe.showLayer(C)):C instanceof L.Polygon&&(C._path.tagFiltered=!0,C._path.classList.contains("hidden-layer")&&C._path.searchFiltered&&this.globe.showLayer(C)),C&&C.feature_properties.tags){h="";for(w=0;w<C.feature_properties.tags.length;w++){var v,b;h+=v=JSON.stringify({tagName:C.feature_properties.tags[w].tagName,tagValue:C.feature_properties.tags[w].tagValue}),(b=this.myTags.get(v))?b+=1:b=1,this.myTags.set(v,b)}}}}}if(t||this.saved3DSearch){if(t)t=t.toLowerCase();else t=this.saved3DSearch.toLowerCase();for(d=0;d<this.layersToLoop.length;d++){var w,x=!1;if((C=this.layersToLoop[d]).feature_properties)for(w in Object.keys(C.feature_properties)){var y=Object.keys(C.feature_properties)[w];x=(x=x||y.toLowerCase().contains(t))||JSON.stringify(C.feature_properties[y]).toLowerCase().contains(t)}else C.title&&(x=C.title.toString().toLowerCase().contains(t)),C.description&&(x=x||C.description.toString().toLowerCase().contains(t));x?C instanceof L.Marker?(console.log(C),C._icon&&"none"!=C._icon.style.display||!C.tagFiltered||this.globe.showLayer(C),C.searchFiltered=!0):C instanceof L.Polygon&&C._path.classList.contains("hidden-layer")&&C._path.tagFiltered&&this.globe.showLayer(C):(C instanceof L.Marker?C.searchFiltered=!1:C instanceof L.Polygon&&(C._path.searchFiltered=!1),n-=1,r-=C._latlng.lat,s-=C._latlng.lng,this.globe.hideLayer(C))}}else for(d=0;d<this.layersToLoop.length;d++){var C;(C=this.layersToLoop[d])instanceof L.Polygon?(C._path.searchFiltered=!0,C._path.tagFiltered&&C._path.searchFiltered&&this.globe.showLayer(C)):C instanceof L.Marker&&(C.searchFiltered=!0,C.tagFiltered&&C.searchFiltered&&this.globe.showLayer(C))}}if(n>0){var S=4;n===this.layersToLoop.length&&(S=2),this.globe.flyToLatLon(r/n,s/n,S)}if(e){var M=[];this.myTags.forEach((function(e,t,i){var o=JSON.parse(t),a=o.tagName,r=o.tagValue,s=e,n=l.get("GlobeViewer.Tags."+a),d={sixw:n=n.contains("GlobeViewer.Tags.")?a:n,object:r,count:s,field:"implicit",dispValue:r};""!=d.dispValue&&M.push(d)})),e.setTags(void 0,M),this.tagsSet=!0}}},saveClusteredMarker:function(e){console.log(e),this.savedClusteredMarkers||(this.savedClusteredMarkers=[]),this.savedClusteredMarkers.push(e),console.log(this.savedClusteredMarkers)},colorize:function(e,t){var i,o=[];for(i=0;i<this._filteredFeatures.length;i++){var a,r=this._filteredFeatures[i];if(r.properties.color=r.properties.colorBackup||"#3399cc",r.properties&&r.properties.tags)for(a=0;a<t.tagColors.length;a++){var s,n=t.tagColors[a];for(s=0;s<r.properties.tags.length;s++){var d=r.properties.tags[s];if(d.tagName&&d.tagName){var h=l.get("GlobeViewer.Tags."+d.tagName);(h=h.contains("GlobeViewer.Tags.")?d.tagName:h)===n.predicate&&d.tagValue&&(d.tagValue===n.dispValue||d.tagValue.includes(n.dispValue))&&(r.properties.color=n.color)}}}o.push(r)}!0===this._clustering?(this._markerCluster=new c(this.maxLevel),this._markerCluster.load(o),this.buildClusters(o,this.inverseLatLon)):this.buildFeatures(o,this.inverseLatLon),this.globe.loadingInfo.hide()},colorize2D:function(e,t,i){console.log("colorize 2D"),this.layersToColorize=[],i?this.layersToColorize=this.unclusteredLayerGroup:this.globe.map.eachLayer(function(e){this.layersToColorize.push(e)}.bind(this));for(var o=0;o<this.layersToColorize.length;o++){var a,r=this.layersToColorize[o];if(!i&&r instanceof L.Marker&&"none"!=r._icon.style.display||r instanceof L.Polygon&&!r._path.classList.contains("hidden-layer")||i)if(r.feature_properties&&r.feature_properties.tags)for(console.log(r),a=0;a<t.tagColors.length;a++){var s,n=t.tagColors[a];for(s=0;s<r.feature_properties.tags.length;s++){var d=r.feature_properties.tags[s];if(d.tagName&&d.tagName){var c=l.get("GlobeViewer.Tags."+d.tagName);if((c=c.contains("GlobeViewer.Tags.")?d.tagName:c)===n.predicate&&d.tagValue&&(d.tagValue===n.dispValue||d.tagValue.includes(n.dispValue)))if(r.style_properties.color=n.color,r._icon){var h=r.options.uuid;document.getElementById(h).setAttribute("fill",r.style_properties.color)}else r instanceof L.Polygon&&r.setStyle({fillColor:r.style_properties.color})}}}}},unColorize:function(e){var t;for(t=0;t<this._filteredFeatures.length;t++){var i=this._filteredFeatures[t];null!=i.properties.colorBackup?i.properties.color=i.properties.colorBackup:i.properties.color="#3399cc"}!0===this._clustering?(this._markerCluster=new c(this.maxLevel),this._markerCluster.load(this._filteredFeatures),this.buildClusters(this._filteredFeatures,this.inverseLatLon)):this.buildFeatures(this._filteredFeatures,this.inverseLatLon),this.globe.loadingInfo.hide()},unColorize2D:function(e,t){this.layersToColorize=[],t?this.layersToColorize=this.unclusteredLayerGroup:this.globe.map.eachLayer(function(e){this.layersToColorize.push(e)}.bind(this));for(var i=0;i<this.layersToColorize.length;i++){var o=this.layersToColorize[i];if((!t&&o instanceof L.Marker&&"none"!=o._icon.style.display||o instanceof L.Polygon&&!o._path.classList.contains("hidden-layer")||t)&&o.feature_properties&&o.feature_properties.tags)if(null!=o.style_properties.colorBackup&&(o.style_properties.color=o.style_properties.colorBackup),o._icon){var a=o.options.uuid;document.getElementById(a).setAttribute("fill",o.style_properties.color)}else o instanceof L.Polygon&&o.setStyle({fillColor:o.style_properties.color})}},buildClusters:function(e,t,i){for(var o=0;o<=this.maxLevel+1;o++)for(var a=this._markerCluster.getClusters([-180,-90,180,90],o),r=0;r<a.length;r++){var s=a[r];if(s.geometry&&"Point"===s.geometry.type){var n=s.geometry.coordinates,l=s.properties;if(n){var c=0,h="#3399cc",u="",g=0,p="";n[2]&&(c=parseFloat(n[2])),l.color&&(h=l.color),l.title&&(u=l.title),l.point_count&&(g=l.point_count),l.description&&(p=l.description);var m={};if(l.popup&&""!==l.popup&&(m.popup=l.popup),l.image&&""!==l.image&&(m.image=l.image),l.html&&""!==l.html&&(m.html=l.html),l.link&&""!==l.link&&(m.link=l.link),l.descriptionType&&""!==l.descriptionType?m.descriptionType=l.descriptionType:l.link&&(m.descriptionType="html"),l.width&&""!==l.width&&(m.width=l.width),l.height&&""!==l.height&&(m.height=l.height),l.persist&&""!==l.persist&&(m.persist=l.persist),l.uuid&&""!==l.uuid&&(m.uuid=l.uuid),l.onclick&&""!==l.onclick){var f;if(m.onclick=l.onclick,"message"===(f=l.onclick.split(";"))[0]){var v={key:f[1],text:f[2]};m.onclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[v])}if("turnTo"===f[0]){var b=f[1].split(";");m.onclick=this.globe.turnGlobeToLatLon.bind(this.globe,parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]))}}if(l.ondoubleclick&&""!==l.ondoubleclick)if(m.ondoubleclick=l.ondoubleclick,"message"===(f=l.ondoubleclick.split(";"))[0]){v={key:f[1],text:f[2]};m.ondoubleclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[v])}if(l.onmouseover&&""!==l.onmouseover)if(m.onmouseover=l.onmouseover,"message"===(f=l.onmouseover.split(";"))[0]){v={key:f[1],text:f[2]};m.onmouseover=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[v])}var w,x=!1;l.is3DDriveContent&&(x=l.is3DDriveContent);var y=n[0],C=n[1];null!==t&&t&&(y=n[1],C=n[0]),(w=g>0?this.addCluster(y,C,c,h,u,p,m,o,g,x):this.addMarker(y,C,c,h,u,p,m,o,0,x))&&"html"===w.descriptionType&&w.persist&&d.addMarkerInfo(w)}}}},buildFeatures:function(e,t,i){for(var o=0;o<e.length;o++){var a=e[o];if(a.geometry&&"Point"===a.geometry.type){var r=a.geometry.coordinates,s=a.properties;if(r){var n=0,l="#3399cc",c="",h="";r[2]&&(n=parseFloat(r[2])),s.color&&(l=s.color),s.title&&(c=s.title),s.description&&(h=s.description);var u={};if(s.popup&&""!==s.popup&&(u.popup=s.popup),s.image&&""!==s.image&&(u.image=s.image),s.html&&""!==s.html&&(u.html=s.html),s.link&&""!==s.link&&(u.link=s.link),s.descriptionType&&""!==s.descriptionType?u.descriptionType=s.descriptionType:s.link&&(u.descriptionType="html"),s.width&&""!==s.width&&(u.width=s.width),s.height&&""!==s.height&&(u.height=s.height),s.persist&&""!==s.persist&&(u.persist=s.persist),s.uuid&&""!==s.uuid&&(u.uuid=s.uuid),s.onclick&&""!==s.onclick){var g;if(u.onclick=s.onclick,"message"===(g=s.onclick.split(";"))[0]){var p={key:g[1],text:g[2]};u.onclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[p])}if("turnTo"===g[0]){var m=g[1].split(";");u.onclick=this.globe.turnGlobeToLatLon.bind(this.globe,parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]))}}if(s.ondoubleclick&&""!==s.ondoubleclick)if(u.ondoubleclick=s.ondoubleclick,"message"===(g=s.ondoubleclick.split(";"))[0]){p={key:g[1],text:g[2]};u.ondoubleclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[p])}if(s.onmouseover&&""!==s.onmouseover)if(u.onmouseover=s.onmouseover,"message"===(g=s.onmouseover.split(";"))[0]){p={key:g[1],text:g[2]};u.onmouseover=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[p])}var f,v=!1;s.is3DDriveContent&&(v=s.is3DDriveContent),(f=null!==t&&t?this.addMarker(r[1],r[0],n,l,c,h,u,-1,-1,v):this.addMarker(r[0],r[1],n,l,c,h,u,-1,-1,v))&&"html"===f.descriptionType&&f.persist&&d.addMarkerInfo(f)}}}}})})),define("DS/SocialGlobe/Globe",["UWA/Class","UWA/Class/Events","UWA/Utils/Client","UWA/Controls/Web","DS/WAFData/WAFData","DS/Visualization/ThreeJS_DS","DS/Visualization/Detector","DS/SocialGlobe/RenderContext","DS/SocialGlobe/DataModel","DS/SocialGlobe/MarkerInfo","DS/SocialGlobe/GlobeLoader3D","DS/SocialGlobe/Vector2","DS/SocialGlobe/Halo3D","DS/SocialGlobe/PoleCreator3D","DS/SocialGlobe/GeoJSONItem","DS/SocialGlobe/Globals","DS/CoreEvents/Events","DS/SocialGlobe/PlanarQuadTree","DS/SocialGlobe/VisuQuadTree","DS/SocialGlobe/VisuStore","DS/SocialGlobe/Utils","DS/Visualization/Mesh3D","DS/WebappsUtils/WebappsUtils","DS/SocialGlobe/MarkerInfoManager","DS/Controls/Button","marked/marked","DS/SocialGlobe/TerminatorLineManager","DS/SocialGlobeServices/MapNavigator/MapNavigatorServices","DS/Utilities/Dom","DS/Usage/TrackerAPI","DS/Web3DXCityFoundation/StringProvider","SocialGlobe/assets/leaflet/leaflet","css!SocialGlobe/assets/leaflet/leaflet.css","SocialGlobe/assets/leaflet/leaflet-markercluster","css!SocialGlobe/MarkerCluster.css","css!SocialGlobe/style.css"],(function(e,t,o,a,r,s,n,l,d,c,h,u,g,p,m,f,v,b,w,x,y,C,S,M,D,_,k,P,T,A,V){"use strict";return e.extend(t,{init:function(e,t,i,o,a){if(window.globe=this,this.version="2018.02.06",this.div=e,this.use2D=o,this.use2D)this.dataModel=new d(this);else{this.renderContext=new l("3D"),this.renderer=this.renderContext.buildRenderer3D(e,t,i),this.camera=this.renderContext.buildCamera(this.renderer,a),this.renderer.setCamera(this.camera),this.started=!1,this.globeLoader=this.renderContext.buildGlobeLoader(this.renderer,this),this.tileBag=this.renderContext.buildTileBag(this.renderer),f.credentials={default:!0},this.visuStore=new x(f.tilespath),this.params={type:"texture",levelMax:this.camera.maxlevel,levelMinCache:2,cache:50,url:f.tilespath+"%l/%x/%y"+f.tileExtension,credentials:f.credentials},this.loader=y.loadTexture,this.builder=function(e,t){t.generateMipmaps=!0,t.magFilter=s.LinearFilter,t.minFilter=s.LinearFilter,t.anisotropy=4,t.wrapS=s.ClampToEdgeWrapping,t.wrapT=s.ClampToEdgeWrapping,e(t,!0)},this.visuStore.makeStoreByJSON("ortho",this.params,this.loader,this.builder,!0,!1),this.planarQT=new b(0,!0,void 0,!0),this.visuQT=new w(this.planarQT,128,this),this.visuStore.vqt=this.visuQT,this.eventTokenList=[];var r=this.camera.threeCamera.position.clone().negate();this.planarQT.build(r,this.camera.level,f.lon2tileFlt(this.camera.lon,0),f.lat2tileFlt(this.camera.lat,0)),this.visuQT.update(!0),this.skin="satellite",this.countrySelectionActivated=!0,this.haloMaker=new g(this.renderer),this.poleMaker=new p(this.renderer,this.tileBag,this.skin),this.polygonMaker=this.renderContext.buildPolygonMaker(this.renderer),this.stop=!1,this.oldTiles=[],this.toLoadTiles=[],this.loadedTiles=[],this.visibleTiles=[],this.permanentTiles=[],this.camera.levelChanged=!1,this.markerMeshes=[],this.invalidateTiles=!0,this.clusterLevel=0,this.clusterMeshes=[],this.dataModel=new d(this),this.markerBag=this.dataModel.getMarkerManager(),this.countryManager=this.dataModel.getCountryManager(),this.countryManager.setRenderer(this.globeLoader),this.overlayDisplayed=!1,this.inertia=10,this.countryJsonObject=null,this.setHalo("#66ccff",.5),this.setBackgroundColor("#00163C",1),this.editMode=!1,this.markerInfo=new c(this.div),this.deleteMode={marker:!1,country:!1},this.setDefaultMarkerMouseOver()}},getDataModel:function(){return this.dataModel},getCountryManager:function(){return this.countryManager},getCountryIndexFromISO3:function(e){return this.countryManager.getIndexFromISO3(e)},loadGeoJSON:function(e,t,i,o,a){if(e&&0!==e.features.length){if(this.use2D){n=o||null;(s=new m).build(e),this.dataModel.build(s.getFeatures(),t,i,n);let l=0;s.getFeatures().forEach((e=>{"Point"===e.featureType&&(l+=1)}));let d=this.use2D?"2D":"3D";var r;A.trackPageEvent({eventCategory:"GlobeViewer:Data",eventAction:"InputGeoJSONUrl",eventLabel:"GeoJSONUrl",appID:"X3DGLOB_AP",tenant:y.getTenantId(),persDim:{pd1:d},persVal:{pv1:l},scope:"Dashboard"}),r=!!a;const c=L.layerGroup();return L.geoJSON(e,{onEachFeature:function(e,t){0;var i=t.feature.properties;if(t instanceof L.Marker)if(i.saved)o=this.addMarkerSaved(t,!0);else var o=this.addMarker2D(t._latlng);else if(t instanceof L.Polygon)if(i.saved)o=this.addPolygonSaved(t,!0);else var o=this.addPolygon(t,r);else 0;if(o&&(o.feature_properties=i),o instanceof L.Marker){o.feature_properties.color?o.style_properties.color=o.feature_properties.color:o.style_properties.color||(o.style_properties.color="#143E5A");var s=o.options.uuid;document.getElementById(s).setAttribute("fill",o.style_properties.color)}else o instanceof L.Polygon&&(o.feature_properties.color?o.style_properties.color=o.feature_properties.color:o.style_properties.color="#448FAB");if(o){if(o.external=r,!i.saved&&a&&a.chosenTitle&&a.chosenDescription){var n=i[a.chosenTitle],l=i[a.chosenDescription];o.title=n||"Unnamed",o.description=l||""}else o.title=i.title?i.title:"",o.description=i.description?i.description:"";a&&(a.from3DDrive?o.fromURL=!1:o.fromURL=!0),o.descriptionType=o.descriptionType?o.descriptionType:"text",this.setBehavior(o),this.clustering&&(this.unclusteredLayerGroup||(this.unclusteredLayerGroup=L.layerGroup()),this.unclusteredLayerGroup.addLayer(o),this.map.removeLayer(o)),o.feature=e,c.addLayer(o)}}.bind(this)}),this.clustering&&(this.allMarkersCluster&&this.map.removeLayer(this.allMarkersCluster),this.allMarkersCluster=L.markerClusterGroup({maxClusterRadius:80,showCoverageOnHover:!1,removeOutsideVisibleBounds:!1,iconCreateFunction:function(e){return L.divIcon({html:e.getChildCount(),className:"customCluster",iconSize:L.point(40,40)})}}),this.allMarkersCluster.addLayers(this.unclusteredLayerGroup),this.map.addLayer(this.allMarkersCluster)),c}{var s,n=o||null;(s=new m).build(e),this._loadedFeatures=s.getFeatures(),this.dataModel.build(s.getFeatures(),t,i,n);let a=0;s.getFeatures().forEach((e=>{"Point"===e.featureType&&(a+=1)}));let r=this.use2D?"2D":"3D";A.trackPageEvent({eventCategory:"GlobeViewer:Data",eventAction:"InputGeoJSONUrl",eventLabel:"GeoJSONUrl",appID:"X3DGLOB_AP",tenant:y.getTenantId(),persDim:{pd1:r},persVal:{pv1:a},scope:"Dashboard"})}}},getCountry:function(e){return this.countryManager.get(e)},clearGeoJSONData:function(){this.map.eachLayer(function(e){e.toGeoJSON&&this.map.removeLayer(e)}.bind(this)),this.allMarkersCluster=null,this.dataModel.layersToLoop=[]},clearGeoJSONFromURL:function(){this.map.eachLayer(function(e){this.clustering?this.clustering&&(this.allMarkersCluster&&this.allMarkersCluster.eachLayer(function(e){e.toGeoJSON&&e.fromURL&&this.allMarkersCluster.removeLayer(e)}.bind(this)),this.unclusteredLayerGroup&&this.unclusteredLayerGroup.eachLayer(function(e){e.toGeoJSON&&e.fromURL&&this.unclusteredLayerGroup.removeLayer(e)}.bind(this))):e.toGeoJSON&&e.fromURL&&this.map.removeLayer(e)}.bind(this)),this.dataModel.layersToLoop=[]},hideExternalMarkers2D:function(){this.map.eachLayer((function(e){e.external&&e instanceof L.Marker&&(e._icon.style.display="none")}))},showExternalMarkers2D:function(){this.map.eachLayer((function(e){e.external&&e instanceof L.Marker&&(e._icon.style.display="block")}))},hideLayer:function(e){console.log(e),this.clustering?e instanceof L.Marker?this.allMarkersCluster.removeLayer(e):e instanceof L.Polygon&&e._path.classList.add("hidden-layer"):e instanceof L.Marker?e._icon.style.display="none":e instanceof L.Polygon&&e._path.classList.add("hidden-layer")},showLayer:function(e){this.clustering?e instanceof L.Marker?(console.log(e),this.allMarkersCluster.addLayer(e)):e instanceof L.Polygon&&e._path.classList.add("hidden-layer"):e instanceof L.Marker?e._icon.style.display="block":e instanceof L.Polygon&&e._path.classList.remove("hidden-layer")},clearCountries:function(){var e=this.getSelection();e.length>0&&(e[0].lat||(this.clearSelection(),this.markerInfo.show(!1,void 0,null)));return this.countryManager.clear(),this},clearMarkers:function(e){var t=this.getSelection();t.length>0&&(t[0].lat&&(this.clearSelection(),this.markerInfo.show(!1,void 0,null)));this.markerBag.clearMarkers(),this.mouseOverMarkersManager&&this.mouseOverMarkersManager.onClearMarkers&&this.mouseOverMarkersManager.onClearMarkers(),this._taggerProxy&&e&&this._taggerProxy.unsetTags()},setCursor:function(e,t){this.renderer.camera.control._setCursor(e,t)},getSelection:function(){return this.getDataModel().getSelection()},setSelection:function(e){for(var t=0;t<e.length;t++)if(e[t].ID&&99===e[t].ID){var i=this.countryManager.get(219);e.push(i)}if(e.length>0&&e[0].ID&&219===e[0].ID){var o=this.countryManager.get(99);e.unshift(o);var a=[0,0];this.lastCoords&&(a=this.lastCoords),this.markerInfo.show(!0,o,a)}this.deleteMode.marker||this.deleteMode.country?this.getDataModel().deleteSelection(e,this.deleteMode):this.getDataModel().setSelection(e)},clearSelection:function(){this.getDataModel().clearSelection()},clearMouseOver:function(){this.mouseOverCountryManager=void 0,this.mouseOverMarkersManager=void 0,this.setDefaultMarkerMouseOver()},setCountryColor:function(e,t){console.log("Globe:setCountryColor",e,t),this.getCountryManager().get(e).setHtmlColor(t)},showFrontiers:function(e){},setCountrySelection:function(e){this.countrySelectionActivated=e,this.setDefaultMarkerMouseOver(),e||(this.clearSelection(),this.markerInfo.show(!1,void 0,null))},getCanvas:function(){return this.renderer.getCanvas()},areTilesRangeEqual:function(e,t){return e.level===t.level&&e.xtile0===t.xtile0&&e.ytile0===t.ytile0&&e.size===t.size},allowZoom:function(e){this.camera.allowZoom(e)},enableZoom:function(e){this.use2D?e?this.map.scrollWheelZoom.enable():this.map.scrollWheelZoom.disable():this.camera.allowZoom(e)},setZoomDistance:function(e,t){this.use2D?(t||this.map.setZoom(e),this.updateUnzoomButton(e)):this.turnGlobeToLatLon(this.camera.lat,this.camera.lon,e)},updateUnzoomButton:function(e){this.unzoomButton&&(this.unzoomButton.style.display=e>2.5?"block":"none")},setFragShader:function(e){f.downloadWithCors(e,this.setTileBagShader.bind(this)),f.downloadWithCors(e,this.setPoleMakerShader.bind(this))},setTileBagShader:function(e){this.tileBag.fragShader=e},setPoleMakerShader:function(e){this.poleMaker.fragShader=e},updateShader:function(e){this.setFragShader(e),this.poleN.threeMaterial.fragmentShader=this.tileBag.fragShader,this.poleN.threeMaterial.needsUpdate=!0,this.poleS.threeMaterial.fragmentShader=this.tileBag.fragShader,this.poleS.threeMaterial.needsUpdate=!0;for(var t=0;t<this.loadedTiles.length;t++)this.loadedTiles[t].threeMaterial.fragmentShader=this.tileBag.fragShader,this.loadedTiles[t].threeMaterial.needsUpdate=!0},setEditMode:function(e){this.editMode=e},addMarker:function(e,t,i,o,a,r,s){return this.markerBag.createMarker(e,t,i,o,a,r,s)},addMarkerSaved:function(e){console.log("add saved marker"),console.log(e);var t=e.feature.properties,i=e.feature.style_properties,o=L.divIcon({html:'\n\t\t\t\t<svg width="19.3" height="29.3" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1">\n\t\t\t\t<g>\n\t\t\t\t\t<path fill="#D8D8D8" d="m9.61934,0.58429c-3.33513,0 -6.46574,1.89953 -8.02178,4.84767c-0.80586,1.52762 -1.15571,3.27655 -1.00801,4.99773c0.18707,2.16894 1.17771,3.79277 2.44755,5.48663c2.79341,3.72497 4.51054,8.14451 6.16326,12.47658c0.237,0.62102 0.62163,0.62047 0.85856,-0.00055c1.61862,-4.23707 3.30036,-8.53327 5.97273,-12.22171c1.13433,-1.56591 2.16718,-2.98116 2.51359,-4.94212c0.32326,-1.83174 0.07191,-3.74872 -0.72177,-5.43161c-1.48237,-3.14448 -4.72542,-5.21262 -8.20412,-5.21262l0,0l0,-0.00001l-0.00001,0.00001zm0,11.76232c-1.5653,0 -2.87223,-1.30753 -2.87223,-2.87283c0,-1.56585 1.30692,-2.87278 2.87223,-2.87278c1.56591,0 2.87344,1.30692 2.87344,2.87278c-0.00006,1.5653 -1.30759,2.87283 -2.87344,2.87283z" id="svg_3" stroke="#9e9e9b"/>\n\t\t\t\t\t<ellipse id="'+t.uuid+'" stroke="#9e9e9b" stroke-width="0.4" fill="'+i.color+'" cx="9.58535" cy="9.39305" id="svg_19" rx="4.34928" ry="4.34928"/>\n\t\t\t\t</g>\n\n\t\t\t\t</svg>',className:"",iconSize:[19.3,29.3],iconAnchor:[9.65,29.3]}),a=new L.marker(e._latlng,{icon:o,pmIgnore:!0});return a.title=t.title,a.description=t.description,a.descriptionType=t.descriptionType,a.style_properties=i,a.width=t.width,a.height=t.height,a.link=t.link,a.image=t.image,a.options.uuid=t.uuid,console.log(a),a.addTo(this.map),a},addMarker2D:function(e,t){var i=this.uuidv4(),o=L.divIcon({html:this.generate2DMarker(i,t),className:"",iconSize:[32,32],iconAnchor:[16,32]}),a=new L.marker(e,{icon:o,uuid:i,pmIgnore:!0});return a.feature_properties={},a.style_properties={},a.addTo(this.map),a},addPolygon:function(e,t){var i=new L.polygon(e._latlngs,{fillColor:"#448FAB",fillOpacity:.7,color:"#006698",pmIgnore:!0}).addTo(this.map);return i.style_properties={},t||this.setBehavior(i),i},addPolygonSaved:function(e){var t=e.feature.properties,i=new L.polygon(e._latlngs,{fillColor:t.color,color:t.strokeColor,fillOpacity:.7,pmIgnore:!0});return i.title=t.title,i.description=t.description,i.descriptionType=t.descriptionType,i.color=t.color,i.strokeColor=t.strokeColor,i.width=t.width,i.height=t.height,i.link=t.link,i.image=t.image,i.uuid=t.uuid,i.addTo(this.map),i},setBehavior:function(e){var t,i={offset:L.point(0,-1)},o=e.width?e.width+"px":"100%",a=e.height?e.height+"px":"100%";"text"===e.descriptionType&&(t="<b>"+e.title+"</b><br>"+e.description),"marked"===e.descriptionType?t="<div style='overflow:auto'><b>"+e.title+"</b><br>"+_(e.description)+"</div>":"html"===e.descriptionType&&(t="<iframe id='iframe' style='width:"+o+"; height:"+a+"' src="+e.link+"></iframe>",i.maxWidth=o),e.bindPopup(t,i),e.on("click",function(t){if(!this.map.markerPopupOnClick||!this.map.polygonPopupOnClick){if(e.getPopup(),e.closePopup(),e instanceof L.Marker&&this.map.markerDetailsOnClick){this.openMarkerDetails(e);var i=e.options.uuid;document.getElementById(i).setAttribute("fill",e.style_properties.color)}e instanceof L.Polygon&&this.map.polygonDetailsOnClick&&this.openPolygonDetails(e),e instanceof L.Polygon&&this.map.markerAdditionOnClick&&(this.map.fireEvent("click",{latlng:t.latlng}),this.polygonPopupOnClick(!1),this.markerPopupOnClick(!1))}if(!this._selectFromAPI&&this._onSelectCallback&&t.sourceTarget&&t.sourceTarget.title){var o=[t.sourceTarget.title];this._onSelectCallback(o)}}.bind(this)),e.on("mouseover",function(){if(e instanceof L.Marker&&!this.openedEditMarker){var t=e.options.uuid;document.getElementById(t).setAttribute("fill","#368ec4")}}.bind(this)),e.on("mouseout",function(){if(e instanceof L.Marker&&!this.openedEditMarker){var t=e.options.uuid;document.getElementById(t).setAttribute("fill",e.style_properties.color)}}.bind(this))},editPopup:function(e){var t,i=e.getPopup(),o=e.width?e.width+"px":"100%",a=e.height?e.height+"px":"100%";"text"===e.descriptionType&&(t="<b>"+e.title+"</b><br>"+e.description),"marked"===e.descriptionType?t="<div style='overflow:auto'><b>"+e.title+"</b><br>"+_(e.description)+"</div>":"html"===e.descriptionType&&(t="<iframe id='iframe' style='width:"+o+"; height:"+a+"' src="+e.link+"></iframe>",i.options.maxWidth=o),i.setContent(t)},markerPopupOnClick:function(e){this.map.markerPopupOnClick=e},markerDetailsOnClick:function(e){this.map.markerDetailsOnClick=e},markerAdditionOnClick:function(e){this.map.markerAdditionOnClick=e},polygonAdditionOnClick:function(e){this.map.polygonAdditionOnClick=e},polygonPopupOnClick:function(e){this.map.polygonPopupOnClick=e},polygonDetailsOnClick:function(e){this.map.polygonDetailsOnClick=e},openMarkerDetails:function(e){this.map.markerDetailsOnClick&&WUX.Events.publish({event:"/SG/UICE/CMD//ColorMarker/EDIT",data:{fromCreateMarker:!1,marker:e}})},openPolygonDetails:function(e){this.map.polygonDetailsOnClick&&WUX.Events.publish({event:"/SG/UICE/CMD//ColorArea/EDIT",data:{fromCreateArea:!1,polygon:e}})},turnGlobeToLatLon:function(e,t,i){this.camera.moveToLatLon({lat:e,lon:t},i)},flyToLatLon:function(e,t,i){this.map.flyTo(new L.LatLng(e,t),i,{animate:!0,duration:2.5})},getGeobjectsNb:function(){var e=0;return this.map.eachLayer((function(t){(t instanceof L.Marker||t instanceof L.Polygon)&&(e+=1)})),e},getMarkersNb:function(){var e=0;return this.map.eachLayer((function(t){t instanceof L.Marker&&!t.middleMarker&&(e+=1)})),e},getPolygonsNb:function(){var e=0;return this.map.eachLayer((function(t){t instanceof L.Polygon&&(e+=1)})),e},_getEvent:function(e){return e.from&&e.from.length?e.from[0].event:null},relMouseCoords:function(e,t){t.touches&&t.touches.length>0&&(t=t.touches[0]);var i=0,o=0,a=e;do{i+=a.offsetLeft,o+=a.offsetTop,a=a.offsetParent}while(a);return{x:t.pageX-i,y:t.pageY-o}},handleMouseDown:function(e){var t=this._getEvent(e);if(this.mouseMoved=!1,!(t.path&&t.path[0]!==this.renderer.canvas||t.target&&t.target!==this.renderer.canvas)){this.mouseDown=!0,this.mouseMove=!1;var i=this.relMouseCoords(this.renderer.canvas,t);this.lastMouseX=i.x,this.lastMouseY=i.y,this.mouseDownX=i.x,this.mouseDownY=i.y,this.markerInfo.show(!1,void 0,null)}},handleMouseRightDown:function(e){this.setCursor("Auto")},handleMouseClick:function(e){var t=this._getEvent(e);if(this.overlayDisplayed)this.displayHelp(!1);else if(!(t.path&&t.path[0]!==this.renderer.canvas||t.target&&t.target!==this.renderer.canvas)){var i=this.relMouseCoords(this.renderer.canvas,t);"@onTapEvent"===e.eventType&&(i.x=parseInt(e.gesture.events[0].startPosition.x),i.y=parseInt(e.gesture.events[0].startPosition.y)),this.pickAndInvoke(i,t,"onMouseClick")}},handleMouseDoubleClick:function(e){var t=this._getEvent(e),i=this.relMouseCoords(this.renderer.canvas,t);this.pickAndInvoke(i,t,"onMouseDoubleClick")},handleMouseUp:function(e){this.setCursor("Auto");this._getEvent(e);this.mouseDown=!1,this.mouseMove=!1,this.mouseMoved=!1},handleMouseOut:function(e){this._getEvent(e);this.mouseOverMarkersManager&&this.mouseOverMarkersManager.onMouseOut&&this.mouseOverMarkersManager.onMouseOut(),this.mouseOverCountryManager&&this.mouseOverCountryManager.onMouseOut&&this.mouseOverCountryManager.onMouseOut()},handleMouseMove:function(e){if(!this.overlayDisplayed){var t=this._getEvent(e);if(t.path&&t.path[0]!==this.renderer.canvas)return;if(t.target&&t.target!==this.renderer.canvas)return;var i=this.relMouseCoords(this.renderer.canvas,t);(Math.abs(i.x-this.mouseDownX)>10||Math.abs(i.y-this.mouseDownY)>10)&&(this.mouseMoved=!0);var o,a,r,s=i.x,n=i.y;this.mouseDown?(this.mouseMove=!0,this.renderer.camera.changed=!0,this.setCursor("Pan",0),a=(o=this.renderer.camera.getMoveFactor())*(s-this.lastMouseX)/this.inertia,r=o*(n-this.lastMouseY)/this.inertia,0===a&&0===r||this.renderer.camera.setDelta(a,r),this.tilesRange=this.renderer.camera.getTilesToDisplay(),this.lastMouseX=s,this.lastMouseY=n):(this.pickAndInvoke(i,t,"onMouseMove"),this.setCursor("Auto"))}},handleKeyDown:function(){},handleMouseWheel:function(e){this.setCursor("Auto",0);var t=1;if("@onMouseDownEvent"!=e.eventType)t=e.gesture.initDistance>e.gesture.lastDistance?1:-1;else{var i=this._getEvent(e);if(i.target&&i.target!==this.renderer.canvas)return;i.wheelDelta?t=-i.wheelDelta/10:i.detail&&(t=.3*i.detail)}"@onPinchEvent"===e.eventType?(t=.0345*parseFloat(t),this.renderer.camera.zoom(t,!0)):this.renderer.camera.zoom(t),this.tilesRange=this.renderer.camera.getTilesToDisplay(),this.dispatchEvent("zoomEvent",["null"])},pickMarkers:function(e,t){this.tilesRange=this.renderer.camera.getTilesToDisplay();var i,o,a,r,s,n,l=e.x,d=e.y,c=this.tilesRange.size,h=this.tilesRange.xtile0,u=this.tilesRange.ytile0,g=this.tilesRange.level,p=this.renderer.getMarkerSize(),m=p*p,f=[];for(i=h;i<h+c;i++)for(o=u;o<u+c;o++)if(r=this.markerBag.getAllMarkersWithOnScrenPosition(g,i,o))for(a=0;a<r.length;a++)if((s=r[a]&&r[a].length>0?r[a][0]:null).screenPosition){var v=(this.renderer.camera.level+1)/3;((n=(l-s.screenPosition.x)*(l-s.screenPosition.x)+(d-s.screenPosition.y)*(d-s.screenPosition.y))<m*v||n<25)&&(f=f.concat(r[a]))}return f},pickMarkers2:function(e,t){var i,o,a,r=e.x,s=e.y,n=this.renderer.getMarkerSize(),l=n*n,d=[];if(this.tilesRange=this.renderer.camera.getTilesToDisplay(),o=this.markerBag.getAllMarkersWithOnScrenPosition2(this.clusterLevel))for(i=0;i<o.length;i++)if((a=o[i])&&a.screenPosition){var c,h=(this.renderer.camera.level+1)/3;((c=(r-a.screenPosition.x)*(r-a.screenPosition.x)+(s-a.screenPosition.y)*(s-a.screenPosition.y))<l*h||c<25)&&(d=d.concat(o[i]))}return d},pickCountry:function(e,t){e.x,e.y;var i=this.renderer.pickCountryIndex(e.x,e.y,t);return i>=0?[this.countryManager.get(i)]:[]},pickAndInvoke:function(e,t,i){var o;if((!t.path||t.path[0]===this.renderer.canvas)&&(this.lastCoords=e,o=globe.dataModel._clustering?this.pickMarkers2(e,t):this.pickMarkers(e,t),this.mouseOverMarkersManager&&this.mouseOverMarkersManager[i]&&this.mouseOverMarkersManager[i](o,e.x,e.y),0===o.length&&this.mouseOverCountryManager&&this.mouseOverCountryManager[i])){var a=this.pickCountry(e,t);this.mouseOverCountryManager[i](a,e.x,e.y)}},subscribeToEvent:function(e){if(e)0!==this.eventTokenList.length&&this.subscribeToEvent(!1),this.eventTokenList.push(v.subscribe({event:"/VISU/onMouseDown"},this.handleMouseWheel.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onLeftMouseDown"},this.handleMouseDown.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onRightMouseDown"},this.handleMouseRightDown.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onLeftMouseUp"},this.handleMouseUp.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onMouseMove"},this.handleMouseMove.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onMouseOut"},this.handleMouseOut.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onTouch"},this.handleMouseDown.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onRelease"},this.handleMouseUp.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onPan"},this.handleMouseMove.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onSwipe"},this.handleMouseMove.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onPinch"},this.handleMouseWheel.bind(this)));else{var t;for(t=0;t<this.eventTokenList.length;++t)v.unsubscribe(this.eventTokenList[t]);this.eventTokenList=[]}},switchToProjection:function(e){},changeSkin:function(e,t){if(this.use2D){var i={};this.map&&(this.map.eachLayer(function(e){e._tiles&&this.map.removeLayer(e)}.bind(this)),L.tileLayer(e,{maxNativeZoom:18,maxZoom:18,noWrap:!0,bounds:[[-90,-180],[90,180]]}).addTo(this.map))}else{(i={}).credentials=f.credentials;var o=S.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/"+e+"/");if(t?(f.theme=e,this.skin=e,f.tilespath=o+"tiles/",this.markerInfo.changeSkin(e)):(f.tilespath=e,this.markerInfo.changeSkin(f.defaultTheme)),this.markerBag&&this.markerBag.markerSkins&&this.markerBag.markerSkins.default){var a=this.markerBag,r=function(e){a.markerSkins.default.material.updatePDSFXUniform("uBackSampler",e)};y.loadTexture(i,r,S.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/")+"natural/marker/markerBack128.png");r=function(e){a.markerSkins.default.material.updatePDSFXUniform("uColorSampler",e)};y.loadTexture(i,r,S.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/")+"natural/marker/markerColor.png")}if(this.visuStore.params.baseUrl=f.tilespath,this.visuStore.ortho.url=f.tilespath+"%l/%x/%y"+f.tileExtension,this.tileBag.unloadTextures(),this.visuStore.clean("ortho"),t&&void 0!==this.poleN){this.skin=e;var s=this.poleN,n=(r=function(e){s.threeMaterial.updatePDSFXUniform("uOSMSampler",e)},y.loadTexture(i,r,o+"poles/NE2_HR_LC_SR_W_cm_N"+f.tileExtension),this.poleS),l=function(e){n.threeMaterial.updatePDSFXUniform("uOSMSampler",e)};y.loadTexture(i,l,o+"poles/NE2_HR_LC_SR_W_cm_S"+f.tileExtension)}else if(t)this.skin=e,void 0!==this.poleMaker&&(this.poleMaker.skin=e);else if(void 0!==this.poleN)r=function(e){this.poleN.threeMaterial.updatePDSFXUniform("uOSMSampler",e)},y.loadTexture(i,r.bind(this),e+"2/0/0"+f.tileExtension),l=function(e){this.poleS.threeMaterial.updatePDSFXUniform("uOSMSampler",e)},y.loadTexture(i,l.bind(this),e+"2/2/3"+f.tileExtension);else void 0!==this.poleMaker&&(this.poleMaker.skin="tms-user");this.visuQT.clear()}},changeTileExtension:function(e){f.tileExtension=e,this.use2D||(this.visuStore.ortho.url=f.tilespath+"%l/%x/%y"+f.tileExtension,this.tileBag.unloadTextures(),this.visuStore.clean("ortho"),this.visuQT.clear())},showMeridians:function(e){this.tileBag.showMeridians=e,this.poleMaker.showMeridians=e;var t=0;e&&(t=1),this.poleN.threeMaterial.externalThickness=t,this.poleN.threeMaterial.needsUpdate=!0,this.poleS.threeMaterial.externalThickness=t,this.poleS.threeMaterial.needsUpdate=!0;for(var i=0;i<this.loadedTiles.length;i++)this.loadedTiles[i].threeMaterial.uniforms.externalThickness.value=t,this.loadedTiles[i].threeMaterial.needsUpdate=!0},setBackgroundColor:function(e,t){this.renderer.setBackgroundColor(e,t)},setDefaultMarkerMouseOver:function(){var e=this,t={onMouseMove:function(t,i,o){t.length?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseClick:function(t,i,o){if(M.clearHighlight(),t.length>0){var a=[i,o],r=t[0];M.isValidLink(r)&&r.persist&&M.highlightFrame(r),e.markerInfo.show(!0,r,a,!1,!0),void 0!==t[0].onclick&&t[0].onclick(),e.setSelection(t)}else e.markerInfo.show(!1,void 0,null),e.setSelection([])},onMouseDoubleClick:function(e,t,i){e.length>0&&void 0!==e[0].ondoubleclick&&(e[0].ondoubleclick(),console.log("double click manager",e[0]))},onMouseOut:function(){},onClearMarkers:function(){}};this.mouseOverMarkersManager=t;var i={onMouseClick:function(e,t,i){},onMouseOut:function(){},onClearMarkers:function(){}};this.countrySelectionActivated&&(i={onMouseClick:function(t,i,o){if(M.clearHighlight(),t.length>0&&e.dataModel.getLastSelectedCountry(t)!==t[0]){var a=[i,o];e.markerInfo.show(!0,t[0],a),void 0!==t[0].onclick&&t[0].onclick(),e.setSelection(t),e.dataModel.setLastSelectedCountry(t[0]),M.isValidLink(t[0])&&t[0].persist&&M.highlightFrame(t[0])}else e.markerInfo.show(!1,void 0,null),e.setSelection([]),e.dataModel.setLastSelectedCountry(null)},onMouseOut:function(){},onClearMarkers:function(){}}),this.mouseOverCountryManager=i},setHalo:function(e,t){this.haloMaker&&(this.haloMaker.color=e,this.haloMaker.intensity=t,this.halo&&(this.renderer.removeObject(this.halo),this.halo=this.haloMaker.createMesh(),this.renderer.addObject(this.halo)))},updateCluster:function(){var e=globe.camera.threeCamera.position.length(),t=1-(Math.max(Math.min(e,5),1.015)-1.015)/(5-1.015),o=Math.pow(t,13),a=Math.floor(11*o);for(a=Math.max(1,a),this.clusterLevel=a,this.markerBag.clusterLevel=this.clusterLevel,i=0;i<this.clusterMeshes.length;i++)this.renderer.removeClusterNode(this.clusterMeshes[i]);this.clusterMeshes=[];var r=this.markerBag.getClusterRep(a,globe.getBBox());if(r)for(var s=0;s<r.length;s++)this.clusterMeshes.push(r[s]),this.renderer.addClusterNode(r[s])},updateMarkerRep:function(e){var t,i,o,a,r,s,n=e.size,l=e.xtile0,d=e.ytile0,c=e.level,h=Math.pow(2,c);for(t=0,i=0,t=0;t<this.markerMeshes.length;t++)this.renderer.removeObject(this.markerMeshes[t]);for(this.markerMeshes=[],t=l;t<l+n;t++)for(i=d;i<d+n;i++)if((o=t%h)<0&&(o+=h),a=i%h,r=this.markerBag.getMarkerRep(c,o,a,globe.dataModel._clustering))for(s=0;s<r.length;s++)this.markerMeshes.push(r[s]),this.renderer.addObject(r[s])},updateMarkerRep2:function(e){for(var t=this.clusterLevel,i=0;i<this.markerMeshes.length;i++)this.renderer.removeObject(this.markerMeshes[i]);this.markerMeshes=[];var o=this.markerBag.getMarkerRep2(t,globe.getBBox());if(o)for(var a=0;a<o.length;a++)this.markerMeshes.push(o[a]),this.renderer.addObject(o[a])},setDeleteMode:function(e,t){this.deleteMode[e]=t},setInertia:function(e){this.inertia=e},setMaxLevel:function(e){console.log("set max level"),this.use2D?(Object.values(this.map._layers)[0].options.maxNativeZoom=e,console.log(Object.values(this.map._layers)[0].options.maxNativeZoom)):(this.visuStore.ortho.levelMax=e,this.visuQT.levelMax=e,this.camera.maxlevel=e)},getBBox:function(){var e=90,t=Math.PI*this.camera.viewAngle/180;if(Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist<1){var i=(this.camera.dist-1)/this.camera.dist*Math.asin(Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist);e=Math.min(90,1.5*i*180/Math.PI)}return{point:{lat:this.camera.lat,lon:this.camera.lon},distance:e}},getBBox2:function(){var e=90,t=Math.PI*this.camera.viewAngle/180,i=Math.PI-t-Math.asin(1/this.camera.dist*Math.sin(t));(i=180*i/Math.PI,Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist<1)&&(e=180*((this.camera.dist-1)/this.camera.dist*Math.asin(Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist))/Math.PI);return{point:{lat:this.camera.lat,lon:this.camera.lon},distance:e}},start:function(){if(!this.started){if(this.use2D){var e;e=this.initialGeoloc?new L.latLng(this.initialGeoloc.split(",")[0],this.initialGeoloc.split(",")[1]):[27.25,2.52];var t=this.initialTileMapValue,i=this.initialMaxLevel,o=this.initialZoomLevel,a=this.initialGeoJSON,r=L.map(this.div,{zoomControl:!1,maxBounds:[[-90,-180],[90,180]],maxZoom:i,maxBoundsViscosity:1}).setView(e,o);r.createPane("backgroundflows"),r.getPane("backgroundflows").style.zIndex=201,r.on("zoomend",function(e){var t=r.getZoom();0!=l-t&&this.updateUnzoomButton(t),l=t}.bind(this)),r.on("click",(e=>{"function"==typeof this._onClickCallback&&e.latlng&&this._onClickCallback(e.latlng.lat,e.latlng.lng)})),L.DomUtil.addClass(r._container,"crosshair-cursor-enabled");var s,n=L.tileLayer("",{maxNativeZoom:20,maxZoom:20,noWrap:!0});(s=t?L.tileLayer(t,{maxNativeZoom:20,maxZoom:20,noWrap:!0,bounds:[[-90,-180],[90,180]]}):n).on("tileerror",function(e){this.mapServiceAvailable&&this.connectMapServiceAgain()}.bind(this)),r.addLayer(s),this.map=r,this.markerDetailsOnClick(!1),this.markerPopupOnClick(!0),this.polygonDetailsOnClick(!1),this.polygonPopupOnClick(!0),this.loadGeoJSON(a);var l=this.map.getZoom();return r}{this.mapServiceAvailable&&setInterval(this.connectMapServiceAgain,3e5);var d=this.renderer,c=this,h=(d.getCanvas(),d.camera),u=null;this.mouseMoved=!1,this.mouseDown=!1,this.mouseMove=!1,this.mouseDownX=-1,this.mouseDownY=-1,this.lastMouseX=null,this.lastMouseY=null,this.haloMaker&&this.haloMaker.intensity>0&&(this.halo=this.haloMaker.createMesh(),this.renderer.addObject(this.halo)),this.poleMaker&&(this.poleN=this.poleMaker.createMesh(!0),this.renderer.addObject(this.poleN),this.poleS=this.poleMaker.createMesh(!1),this.renderer.addObject(this.poleS)),this.started=!0;function g(){if(c.visuStore.pollQueues(),c.visuStore.cleanupStores(),c.visuStore.timeStamp=Date.now(),u&&d.onMouseOver(u),c.camera.threeCamera){var e=c.camera.threeCamera.position.clone().negate();c.planarQT.build(e,c.camera.level,f.lon2tileFlt(c.camera.lon,0),f.lat2tileFlt(c.camera.lat,0)),c.visuQT.update(),c.camera.changed=!1}c.visuQT.display(),c.markerBag.updateMaterialBeforeDraw(),c.tilesRange=h.getTilesToDisplay(),!0===c.dataModel._clustering?(c.updateCluster(),c.updateMarkerRep2(c.tilesRange)):c.updateMarkerRep(c.tilesRange),c.globeLoader&&c.globeLoader.refresh(),d.render()}function p(){c.stop||requestAnimationFrame(p),g()}this.subscribeToEvent(!0),v.subscribe({event:"/VISU/onLeftClick"},this.handleMouseClick.bind(this)),v.subscribe({event:"/VISU/onLeftDoubleClick"},this.handleMouseDoubleClick.bind(this)),v.subscribe({event:"/VISU/onTap"},this.handleMouseClick.bind(this)),v.subscribe({event:"/VISU/onDoubleTap"},this.handleMouseDoubleClick.bind(this)),p(),this.dispatchEvent("onGlobeReady",!0)}}},terminatorLineManagerGlobe:function(e,t){void 0===this.terminatorLineManager&&(this.terminatorLineManager=new k(this)),this.terminatorLineManager.hideLine(),this.terminatorLineManager.setDate(e),t&&(this.terminatorLineManager.terminatorLineCreation(),this.terminatorLineManager.showLine())},onFilterChange:function(){this.loadingInfo.show(),this.clearMarkers(),M.resetAll(),this.dataModel.updateLoadedData(this._taggerProxy,!0)},onFilterChange2D:function(){var e=this.clustering;this.dataModel.updateLoadedData2D(this._taggerProxy,!1,!1,e)},onSearch:function(e){this.loadingInfo.show(),this.clearMarkers(),M.resetAll(),this.dataModel.updateLoadedData(this._taggerProxy,!0,e)},onSearch2D:function(e){var t=this.clustering;this.dataModel.updateLoadedData2D(this._taggerProxy,e,!1,t)},onResetSearch:function(){this.loadingInfo.show(),this.clearMarkers(),M.resetAll(),this.dataModel.updateLoadedData(this._taggerProxy,!0)},onResetSearch2D:function(){var e=this.clustering;this.dataModel.updateLoadedData2D(this._taggerProxy,null,!0,e)},onColorize:function(e){this.loadingInfo.show(),this.clearMarkers(),M.resetAll(),this.dataModel.colorize(this._taggerProxy,e)},onColorize2D:function(e){console.log("colorize"),this.dataModel.colorize2D(this._taggerProxy,e,this.clustering)},onUnColorize:function(){this.loadingInfo.show(),this.clearMarkers(!1),M.resetAll(),this.dataModel.unColorize(this._taggerProxy)},onUnColorize2D:function(){console.log("uncolorize"),console.log(this.clustering),this.dataModel.unColorize2D(this._taggerProxy,this.clustering)},setClustering:function(e){if(globe.dataModel._clustering=e,globe.markerBag._clustering=e,!0===e)this.clearMarkers(),M.resetAll();else{var t;for(t=0;t<this.clusterMeshes.length;t++)this.renderer.removeClusterNode(this.clusterMeshes[t]);this.clusterMeshes=[]}},setClustering2D:function(e){if(e){this.clustering=!0,console.log(this.clustering),console.log("setclustering2D"),this.unclusteredLayerGroup=L.layerGroup(),this.allMarkersCluster=L.markerClusterGroup({maxClusterRadius:80,showCoverageOnHover:!1,removeOutsideVisibleBounds:!1,iconCreateFunction:function(e){return L.divIcon({html:e.getChildCount(),className:"customCluster",iconSize:L.point(40,40)})}}),this.map.eachLayer(function(e){e instanceof L.Marker&&(this.unclusteredLayerGroup.addLayer(e),this.map.removeLayer(e))}.bind(this)),this.allMarkersCluster.addLayers(this.unclusteredLayerGroup),this.dataModel.unclusteredLayerGroup=this.unclusteredLayerGroup.getLayers(),this.map.addLayer(this.allMarkersCluster),console.log(this.allMarkersCluster._featureGroup._layers);for(const[e,i]of Object.entries(this.allMarkersCluster._featureGroup._layers))if(i instanceof L.Marker&&!i.hasOwnProperty("_markers")){var t=i.options.uuid;document.getElementById(t).setAttribute("fill",i.style_properties.color)}this.map.on("layeradd",function(e){if(this.clustering&&e.layer instanceof L.Marker&&!e.layer.hasOwnProperty("_markers")){var t=e.layer.options.uuid;document.getElementById(t).setAttribute("fill",e.layer.style_properties.color)}}.bind(this))}else this.clustering=!1,this.map.hasLayer(this.allMarkersCluster)&&(this.map.removeLayer(this.allMarkersCluster),this.map.addLayer(this.unclusteredLayerGroup)),this.allMarkersCluster=null,this.unclusteredLayerGroup&&this.unclusteredLayerGroup.eachLayer((function(e){e.getElement().getElementsByTagName("ellipse")[0].setAttribute("fill",e.style_properties.color)}))},uuidv4:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))},setTrademark2D:function(e){var t=V.getOsmTrademark();this.use2D&&(e?(this.map.attributionControl.addAttribution(t),this.map.attributionControl._container.classList.add("trademark"),this.map.attributionControl.setPrefix(!1)):this.map.attributionControl.removeAttribution(t))},connectMapServiceAgain:function(){var e=y.getTenantId();P.retrieveMapUrl(e)},generate2DMarker:function(e,t){var i="<div class='marker2d'>",o="";return o='<div class="gv-marker"><svg x="0px" y="0px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1">\n\t\t <g>\n\t\t\t\t\t<path fill="#F1F1F1" d="M22.4,7.6c-1.9-1.5-4.1-2.1-6.4-2.1c-2.2,0-4.5,0.7-6.4,2.1c-4.6,3.5-5.5,10.1-2,14.7l6.8,8.8\n\t\t\t\t\t\t\t c0.4,0.5,1,0.8,1.6,0.8c0.6,0,1.2-0.3,1.6-0.8l6.8-8.8C27.9,17.8,27,11.2,22.4,7.6z M16,22c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6\n\t\t\t\t\t\t\t S19.3,22,16,22z"/>\n\t\t\t\t\t<g>\n\t\t\t\t\t\t\t <path fill="#77797C" d="M16,6.5c2.1,0,4.1,0.7,5.8,1.9c4.2,3.2,5,9.2,1.8,13.3l-6.8,8.8C16.6,30.9,16.3,31,16,31\n\t\t\t\t\t\t\t\t\t\tc-0.3,0-0.6-0.1-0.8-0.4l-6.8-8.8c-3.2-4.2-2.4-10.1,1.8-13.3C11.9,7.2,13.9,6.5,16,6.5L16,6.5 M16,23c3.9,0,7-3.1,7-7s-3.1-7-7-7\n\t\t\t\t\t\t\t\t\t\ts-7,3.1-7,7S12.1,23,16,23 M16,5.5C16,5.5,16,5.5,16,5.5C16,5.5,16,5.5,16,5.5c-2.2,0-4.5,0.7-6.4,2.1c-4.6,3.5-5.5,10.1-2,14.7\n\t\t\t\t\t\t\t\t\t\tl6.8,8.8c0.4,0.5,1,0.8,1.6,0.8c0.6,0,1.2-0.3,1.6-0.8l6.8-8.8c3.5-4.6,2.6-11.2-2-14.7C20.5,6.2,18.2,5.5,16,5.5L16,5.5z M16,22\n\t\t\t\t\t\t\t\t\t\tc-3.3,0-6-2.7-6-6c0-3.3,2.7-6,6-6s6,2.7,6,6C22,19.3,19.3,22,16,22L16,22z"/>\n\t\t\t\t\t</g>\n\t\t </g>',i+=o+='<circle id="'+e+'" fill="'+(t&&t.color?t.color:"#ffffff")+'" cx="16" cy="16" r="6"/></svg></div>',i+="</div>"}})})),define("DS/SocialGlobe/GlobeItf",["UWA/Class","DS/SocialGlobe/Globe","DS/SocialGlobe/Marker","DS/SocialGlobe/Globals"],(function(e,t,i,o){"use strict";var a=e.extend({init:function(e){this.globe=e,this.debugMsg=!1},getCountryManager:function(){return this.globe.getCountryManager()},addMarker:function(e,t,i,o,a,r,s){return this.globe.addMarker(e,t,i,o,a,r,s)},addMarker2D:function(e){return console.log("add marker 2D globeitf"),this.globe.addMarker2D(e)},getMarker:function(e){return this.globe.markerBag.getMarker(e)},clearMarkers:function(){this.globe.clearMarkers()},setMouseOverMarkersManager:function(e){this.globe.mouseOverMarkersManager=e},getCountryIndexFromISO3:function(e){return this.globe.getCountryIndexFromISO3(e)},setMouseOverCountryManager:function(e){this.globe.mouseOverCountryManager=e},setCountryColor:function(e,t){this.globe.setCountryColor(e,t)},clearCountries:function(){this.globe.clearCountries()},clearGeoJSONData:function(e){this.globe.clearGeoJSONData()},clearGeoJSONFromURL:function(){this.globe.clearGeoJSONFromURL()},showFrontiers:function(e){this.globe.showFrontiers(e)},setCountrySelection:function(e){this.globe.setCountrySelection(e)},getCountryObject:function(e){return this.globe.getCountry(e)},setDefaultColor:function(e,t,i){this.globe.globeLoader.setDefaultColor(e,t,i)},setBackgroundColor:function(e,t){this.globe.setBackgroundColor(e,t)},setHalo:function(e,t){this.globe.setHalo(e,t)},go:function(){this.globe.start()},terminatorLineManagerITF:function(e,t){this.globe.terminatorLineManagerGlobe(e,t)},destroy:function(){this.clearMarkers(),this.clearCountries(),this.globe.stop=!0},turnGlobeToLatLon:function(e,t,i){this.globe.turnGlobeToLatLon(e,t,i)},flyToLatLon:function(e,t,i){this.globe.flyToLatLon(e,t,i)},autoTurn:function(e){this.globe.camera.autoTurn=e},loadJSONData:function(e,t){UWA.Data.request(e,{type:"",onComplete:this.displayJSONData.bind(this,t)})},displayJSONData:function(e,t){if(!this.use2D){this.clearCountries(),this.clearMarkers();var i=JSON.parse(t)}this.loadGeoJSON(i,e),this.use2D||this.globe.setDefaultMarkerMouseOver()},loadGeoJSON:function(e,t,i,o){return this.globe.loadGeoJSON(e,t,null,i,o)},allowZoom:function(e){this.enableZoom(e)},enableZoom:function(e){this.globe.enableZoom(e)},setZoomDistance:function(e,t){this.globe.setZoomDistance(e,t)},setFragShader:function(e){this.globe.setFragShader(e)},updateShader:function(e){this.globe.updateShader(e)},changeSkin:function(e,t){this.globe.changeSkin(e,t)},changeTileExtension:function(e){this.globe.changeTileExtension(e)},showMeridians:function(e){this.globe.showMeridians(e)},log:function(e){this.debugMsg&&UWA.log("GLOBE: "+e)},setInertia:function(e){this.globe.setInertia(e)},setEditMode:function(e){this.globe.setEditMode(e)},setMaxLevel:function(e){this.globe.setMaxLevel(e)}});return a.create=function(e,i,r){if(o.isBrowserSupported()){var s=new t(e,null,null,i,r);return new a(s)}return e.innerHTML=o.getBrowserErrorMsg(),e.style.backgroundColor="white",null},a})),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/GlobeUWA",["UWA/Core","UWA/Controls/Abstract","UWA/Controls/ToolTip","DS/SocialGlobe/GlobeItf","DS/SocialGlobe/Globals","DS/CoreEvents/Events","UWA/Utils/InterCom","DS/SocialGlobe/MessageDispatcher","DS/ApplicationFrame/FrameWindow","DS/WebappsUtils/WebappsUtils","DS/Controls/Toggle","DS/Controls/Timeline","DS/Controls/TileView","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/TagNavigatorProxy/TagNavigatorProxy","DS/WAFData/WAFData","DS/SocialGlobeServices/i3DDashboard/i3DDriveServices","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Controls/ColorPicker","DS/Controls/Popup","DS/Controls/Button","DS/Windows/ImmersiveFrame","DS/Windows/Panel","DS/Controls/ProgressBar","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/UIFieldsChoice","DS/SocialGlobe/GeocodingAndReverse","DS/SocialGlobeServices/MapNavigator/MapNavigatorServices","DS/SocialGlobe/Utils","DS/Usage/TrackerAPI","DS/Web3DXCityFoundation/StringProvider"],(function(e,t,i,o,a,r,s,n,l,d,c,h,u,g,p,m,f,v,b,w,x,y,C,S,M,D,_,k,P,T,A,V,F){"use strict";const L="URL",G="Extension",I="MaxLevel",E="CorsException";return t.extend({defaultOptions:{path:"./"},init:function(e,t){if(void 0!==t.baseUrlRedefined&&d.setWebappsBaseUrl(t.baseUrlRedefined),this._parent(t),this.widgetHeight=t.height,this.fullscreenMode=!1,this.widget=e,this.options.use2D?(e.addEvent("onSearch",this.onSearch2D.bind(this)),e.addEvent("onResetSearch",this.onResetSearch2D.bind(this))):(e.addEvent("onSearch",this.onSearch.bind(this)),e.addEvent("onResetSearch",this.onResetSearch.bind(this))),e.hasPreference("terminatorLine")||e.addPreference({name:"terminatorLine",type:"hidden",label:"Terminator Line",defaultValue:!1}),e.hasPreference("toggleTL")||e.addPreference({name:"toggleTL",type:"hidden",label:"Toggle Terminator Line",defaultValue:!0}),e.hasPreference("toggleUpdate")||e.addPreference({name:"toggleUpdate",type:"hidden",label:"Toggle Update Terminator Line",defaultValue:!0}),e.hasPreference("dateTL")||e.addPreference({name:"dateTL",type:"hidden",label:"Date Terminator Line",defaultValue:(new Date).valueOf()}),e.hasPreference("3DDriveGeoJSONManagement")||e.addPreference({name:"3DDriveGeoJSONManagement",type:"hidden",label:"3DDrive GeoJSON Management",defaultValue:""}),e.hasPreference("wuxPanelManagement")||e.addPreference({name:"wuxPanelManagement",type:"hidden",label:"WUXPanel Management",defaultValue:"",value:""}),this.options.use2D?e.endEdit=this.endEdit2D.bind(this):e.endEdit=this.loadPreferences.bind(this),e.onEdit=this.onEdit.bind(this),e.onRefresh=this.onRefresh.bind(this),this.buildSkeleton(),this.actualTenantUWA=void 0!==this.widget.data.x3dPlatformId?this.widget.data.x3dPlatformId:"",this.globe.globe.actualTenantGlobe=this.actualTenantUWA,!this.options.use2D){a.sendMessage=this.send,this.sockets={},this.sockets.dispatch=new s.Socket("Globe.Dispatch"+e.id),this.sockets.listen=new s.Socket("Globe.Listen"+e.id);var i=e.getValue("uwaServer");""===i&&(i="uwa.embedded"),this.sockets.dispatch.subscribeServer(i),this.sockets.listen.subscribeServer(i),this.msgDispatcher=new n(this,this.widget,this.sockets.dispatch,this.sockets.listen)}this.widget.id&&(this.getGlobe()._taggerProxy=m.createProxy({widgetId:this.widget.id,filteringMode:"FilteringOnServer",colorize:!0,events:{addFilterChangeListener:this.onFilterChange.bind(this)}}),this.options.use2D?(this.getGlobe()._taggerProxy.addEvent("colorize",this.onColorize2D.bind(this)),this.getGlobe()._taggerProxy.addEvent("unColorize",this.onUnColorize2D.bind(this))):(this.getGlobe()._taggerProxy.addEvent("colorize",this.onColorize.bind(this)),this.getGlobe()._taggerProxy.addEvent("unColorize",this.onUnColorize.bind(this)))),this._current6wtags=[],this.widget.body.addEventListener("drop",this.onDrop.bind(this),!1),this.widget.body.addEventListener("dragover",this.onDragOver,!1),"high-tech"==e.getValue("theme")&&(this.setTheme("satellite"),b.display({level:"warning",title:w.get("GlobeViewer.DisplaySettings.Theme.ThemeUpdate.Title"),subtitle:w.get("GlobeViewer.DisplaySettings.Theme.ThemeUpdate.Subtitle"),message:w.get("GlobeViewer.DisplaySettings.Theme.ThemeUpdate.Message")}))},onDragOver:function(e){e.preventDefault()},buildSkeleton:function(){var t=this.options,r=this.options.use2D;t.canvas?this.elements.container=t.div:this.elements.container=e.createElement("div",{id:"map",styles:{position:"relative",backgroundColor:"transparent",width:"100%",height:"100%"}}),a.isBrowserSupported()?this.globe=o.create(this.elements.container,t.use2D,!0):this.elements.container.innerHTML=a.getBrowserErrorMsg(),this.helpDisplayed=!1,this.customPanelDisplayed=!1,this.markersManager=void 0,this.editMode=!1,this.helpPanel=new UWA.Element("div",{styles:{width:"100%",height:"100%",position:"absolute",background:"rgba(0,0,0,0.5)",zIndex:5e4,display:"none",color:"white"}}),this.customPanel=new UWA.Element("div",{styles:{position:"absolute",background:"rgba(0,0,0,0.5)",padding:"5px",zIndex:5e4,display:"none",color:"white"}}),this.infoPanel=new UWA.Element("div",{html:"this is the content",styles:{position:"absolute",background:"rgba(0,0,0,0)",width:"50%",height:"50px",zIndex:52e3,color:"white",bottom:"-25px",left:"25%"}}),this.mapPanel=new UWA.Element("div",{styles:{position:"absolute",background:"rgba(0,0,0,0)",zIndex:52e3,color:"white",bottom:"-25px",right:"15px"}}),this.unzoomPanel=new UWA.Element("div",{styles:{position:"absolute",background:"rgba(0,0,0,0)",zIndex:52e3,color:"white",bottom:"-25px",left:"15px"}}),this.unzoomButton=new UWA.Element("button",{html:"",styles:{width:32,height:32,border:"none",color:"white",background:"url("+d.getWebappsAssetUrl("SocialGlobe","icons/32/icon_pov.png")+")"}}).inject(this.unzoomPanel),r?(this.unzoomButton.addEventListener("click",this.unzoomAll2D.bind(this)),this.unzoomPanel.style.display="none",this.globe.globe.unzoomButton=this.unzoomPanel):(this.unzoomButton.onclick=this.unzoomAll.bind(this),this.unzoomButton.addEvent("touchstart",this.unzoomAll.bind(this)),this.globe.globe.camera.unzoomButton=this.unzoomPanel);new i(this.unzoomButton,"Zoom out",{width:"90px",offsetX:10,offsetY:0}),new UWA.Element("div",{html:"<br>THIS IS THE HELP CONTENT."}).inject(this.helpPanel);this.topBars={},this.panelDiv=new UWA.Element("div",{styles:{position:"absolute",zIndex:52e3,bottom:"32px",left:"0px",right:"0px",overflow:"auto"}}),this.globe.globe.loadingInfo=new UWA.Element("div",{styles:{position:"absolute",zIndex:51e3,bottom:"50%",right:"50%",transform:"translate(50%, 50%)","pointer-events":"none"}});new UWA.Element("span",{html:"Loading data...",styles:{padding:"10px"}}).inject(this.globe.globe.loadingInfo);if(new D({displayStyle:"lite"}).inject(this.globe.globe.loadingInfo).show().infiniteFlag=!0,this.globe.globe.loadingInfo.hide(),this.interactionPanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto","min-width":"500px","max-width":"600px",margin:"0 auto"}}).inject(this.panelDiv),this.interactionPanel.hide(),this.themePanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto",margin:"0 auto","max-width":"400px"}}).inject(this.panelDiv),this.themePanel.hide(),this.advancedPanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto",margin:"0 auto","max-width":"500px"}}).inject(this.panelDiv),this.advancedPanel.hide(),this.loaddataPanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto",margin:"0 auto","max-width":"500px"}}).inject(this.panelDiv),this.loaddataPanel.hide(),this.allowZoomButton=new c({domId:"enable-zoom-toggle",label:"Enable zoom",internalLabelsFlag:!0,type:"switch",checkFlag:!!r||""}),this.allowZoomButton.inject(this.interactionPanel),this.allowZoomButton.addEventListener("change",function(){this.enableZoom(this.allowZoomButton.checkFlag)}.bind(this)),!r){var s=new UWA.Element("div",{styles:{position:"absolute"}});this.interactionPanel.addContent(s);var n=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),l=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Auto-rotation speed",styles:{height:"42px","margin-top":"15px"}}).inject(n),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{}}).inject(n));this.rotationspeedButton=new h({domId:"rotation-speed-slider",minValue:0,maxValue:2,value:0,stepValue:.1,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"OFF",value:0},{label:"Low",value:.5},{label:"Medium",value:1},{label:"Fast",value:2}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(l),this.rotationspeedButton.addEventListener("change",function(){this.autoTurn(this.rotationspeedButton.getValue())}.bind(this));var u=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),p=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Globe inertia",styles:{height:"42px","margin-top":"15px"}}).inject(u),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{}}).inject(u));this.interactionspeedButton=new h({domId:"interaction-speed-slider",minValue:10,maxValue:180,value:70,stepValue:5,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"Low",value:10},{label:"Medium",value:75},{label:"High",value:180}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(p),this.interactionspeedButton.addEventListener("change",function(){this.setInertia(this.interactionspeedButton.getValue())}.bind(this))}var m=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),f=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Initial zoom level",styles:{height:"42px","margin-top":"15px"}}).inject(m),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{}}).inject(m));this.initialzoomButton=r?new h({domId:"initial-zoom-slider",minValue:2.3,maxValue:20,value:2,stepValue:1,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"World",value:2.3},{label:"Continent",value:5},{label:"Country",value:6.5},{label:"Town",value:12},{label:"Building",value:20}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC",firstLaunch:!0}).inject(f):new h({domId:"initial-zoom-slider",minValue:1.01,maxValue:7,value:7,stepValue:.01,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"Town",value:1.01},{label:"Country",value:1.8},{label:"Continent",value:3.9},{label:"Planet",value:6}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(f),this.globe.globe.initialZoomButton=this.initialzoomButton,this.initialzoomButton.addEventListener("change",function(){this.initialzoomButton.firstLaunch?(this.setZoomDistance(this.initialzoomButton.getValue(),!0),this.initialzoomButton.firstLaunch=!1):this.setZoomDistance(this.initialzoomButton.getValue(),!1)}.bind(this));var v=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),b=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Initial coordinates (lat,lon)"}).inject(v),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{height:"20px"}}).inject(v));if(this.coordinatesInput=new g.Text({attributes:{id:"coordinates-input",placeholder:"Ex: 48.857617,2.334014"}}).inject(b),this.globe.globe.initialCoordinates=this.initialCoordinates,this.coordinatesInput.addEvent("onChange",function(){this.setInitialCoordinates(this.coordinatesInput.getValue())}.bind(this)),!r){var y=new UWA.Element("div",{id:"satellite-preview",styles:{"background-image":"url("+d.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/prev-satellite.jpg")+")",width:"100%",height:"40px","padding-top":"10px"}}).inject(this.themePanel);this.satelliteThemeButton=new c({label:" ",internalLabelsFlag:!0,type:"switch"}).inject(y),this.satelliteThemeButton.addEventListener("change",function(){this.satelliteThemeButton.checkFlag&&(this.setTheme("satellite"),this.naturalThemeButton.checkFlag=!1)}.bind(this));var C=new UWA.Element("div",{id:"natural-preview",styles:{"background-image":"url("+d.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/prev-natural.jpg")+")",width:"100%",height:"40px","padding-top":"10px"}}).inject(this.themePanel);this.naturalThemeButton=new c({label:" ",internalLabelsFlag:!0,type:"switch"}).inject(C),this.naturalThemeButton.addEventListener("change",function(){this.naturalThemeButton.checkFlag&&(this.setTheme("natural"),this.satelliteThemeButton.checkFlag=!1)}.bind(this)),this.naturalThemeButton.elements.container.style.textAlign="right",this.satelliteThemeButton.elements.container.style.textAlign="right",this.naturalThemeButton.addEvent("change",function(e){this.naturalThemeButton.checkFlag&&(this.satelliteThemeButton.checkFlag=!1)}.bind(this)),this.satelliteThemeButton.addEvent("change",function(e){this.satelliteThemeButton.checkFlag&&(this.naturalThemeButton.checkFlag=!1)}.bind(this)),this.backgroundcolorButton=new c({domId:"background-color-toggle",label:"Override background color",internalLabelsFlag:!0,type:"switch"}).inject(this.themePanel),this.backgroundcolorButton.addEventListener("change",function(){if(this.backgroundcolorButton.checkFlag){this.widget.setValue("backcolor","#"+this.themecolorPicker.value),this.setBackgroundColor("#"+this.themecolorPicker.value,1);try{this.backgroundColor.show()}catch(e){console.log("Cannot hide element")}}else{if(this.setTheme(this.currentTheme),this.themecolorPicker){this.themecolorPicker.value="005685";try{this.backgroundColor.hide()}catch(e){console.log("Cannot hide element")}}this.widget.setValue("backcolor","")}}.bind(this)),this.backgroundColor=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"none"}}).inject(this.themePanel);var S=new UWA.Element("li",{class:"wux-controls-abstract wux-controls-toggle wux-controls-switch"}).inject(this.backgroundColor);new UWA.Element("label",{html:w.get("GlobeViewer.DisplaySettings.Text.BackgroundColor"),class:"display-background-label"}).inject(S);this.themecolorPicker=new x({domId:"background-color-picker",value:"005685"}).inject(S),this.themecolorPicker.elements.container.setStyles({left:"5px"}),this.themecolorPicker.addEventListener("change",function(){this.backgroundcolorButton.checkFlag&&(this.widget.setValue("backcolor","#"+this.themecolorPicker.value),this.setBackgroundColor("#"+this.themecolorPicker.value,1))}.bind(this))}if(this.widget.getValue("mapNavAvailable")){var M=new UWA.Element("div",{id:"mapnav-settings",styles:{"background-image":"url("+d.getWebappsAssetUrl("SocialGlobe","textures/prev_3ds_map.jpg")+")",width:"400px",height:"40px","padding-top":"10px"}}).inject(this.advancedPanel);this.mapnavButton=new c({label:" ",internalLabelsFlag:!0,type:"switch"}).inject(M),this.mapnavButton.addEventListener("change",function(){this.mapnavButton.checkFlag?(this.customSettingsDiv.style.display="none",this.customButton.checkFlag=!1,this.setMapNavigatorActive()):(this.clearAll(),this.setMapNavigatorInactive())}.bind(this)),this.mapnavButton.elements.container.style.textAlign="right"}var _=new UWA.Element("div",{id:"custom-tms-settings",styles:{"background-image":"url("+d.getWebappsAssetUrl("SocialGlobe","textures/prev_custom.jpg")+")",width:"400px",height:"40px","padding-top":"10px"}}).inject(this.advancedPanel);this.widget.getValue("mapNavAvailable")&&(this.customButton=new c({label:" ",internalLabelsFlag:!0,type:"switch"}).inject(_),this.customButton.addEventListener("change",function(){this.customButton.checkFlag?(this.customSettingsDiv.style.display="block",this.mapnavButton.checkFlag=!1,this.widget.setValue("mapNavActive",!1)):this.clearAll()}.bind(this)),this.customButton.elements.container.style.textAlign="right"),this.customSettingsDiv=new UWA.Element("div",{id:"custom-settings-div"}).inject(this.advancedPanel);var k=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.customSettingsDiv),P=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"TMS (Tile Map Service) URL"}).inject(k),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(k)),T=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.customSettingsDiv),A=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Tile extension (default .basis)"}).inject(T),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(T)),F=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.customSettingsDiv),U=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"TMS max level"}).inject(F),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(F)),O=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.customSettingsDiv),N=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"CORS exception servers"}).inject(O),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(O));this.tmsInput=new g.Text({attributes:{id:"tms-input",placeholder:"Ex: https://the.path.before/Z/Y/X.ext"}}).inject(P),this.addHelpPopup(P,L);var z=widget.getValue("tilemapserver"),W=widget.getValue("tileextension");if(this.tmsInput.addEvent("onChange",function(){(z=this.tmsInput.getValue(),r)?""!==z?(W?z.includes("{z}/{x}/{y}")?this.changeSkin(z+W,!1):this.changeSkin(z+"{z}/{x}/{y}"+W,!1):z.includes("{z}/{x}/{y}")?this.changeSkin(z+".png",!1):this.changeSkin(z+"{z}/{x}/{y}.png",!1),this.widget.setValue("tilemapserver",z)):(W&&""!=W?this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}"+W,!1):this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}.png",!1),this.widget.setValue("tilemapserver","")):""!==z?(this.changeSkin(z,!1),""===widget.getValue("cors-exception")&&(this.setCorsExceptions(z),this.widget.setValue("tilemapserver",z))):(this.changeSkin(this.currentTheme,!0),this.widget.setValue("tilemapserver",z))}.bind(this)),this.tileextensionInput=new g.Text({attributes:{id:"tile-extension-input",placeholder:"Ex: .jpg - Default: .png"}}).inject(A),this.addHelpPopup(A,G),this.tileextensionInput.addEvent("onChange",function(){if(W=this.tileextensionInput.getValue(),r){var e=this.tmsInput.getValue();""!==W?(this.changeTileExtension(W),e?e.includes("{z}/{x}/{y}")?this.changeSkin(e+W,!1):this.changeSkin(e+"{z}/{x}/{y}"+W,!1):this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}"+W,!1),this.widget.setValue("tileextension",W)):e?e.includes("{z}/{x}/{y}")?this.changeSkin(e+".png"):this.changeSkin(e+"{z}/{x}/{y}.png"):this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}.png",!1)}else""!==W?(this.changeTileExtension(W),this.widget.setValue("tileextension",W)):(this.changeTileExtension(".basis"),this.widget.setValue("tileextension",""))}.bind(this)),this.tmsmaxlevelInput=new g.Text({attributes:{id:"tms-max-level-input",placeholder:"Ex: 12 - Default: 18"}}).inject(U),this.addHelpPopup(U,I),this.tmsmaxlevelInput.addEvent("onChange",function(){var e=this.tmsmaxlevelInput.getValue();""!==e&&""!==this.tmsInput.getValue()?(this.setMaxLevel(parseInt(e)),this.widget.setValue("tilemapserver-max",e)):r?(this.setMaxLevel(20),this.widget.setValue("tilemapserver-max",20)):(this.setMaxLevel(6),this.widget.setValue("tilemapserver-max",6))}.bind(this)),this.corsserverInput=new g.Text({attributes:{id:"cors-server-input",placeholder:"Ex: https://the.path.before/"}}).inject(N),this.addHelpPopup(N,E),this.corsserverInput.addEvent("onChange",function(){var e=this.corsserverInput.getValue(),t=this.tmsInput.getValue();""!==e||"https://tile.openstreetmap.org/"===t&&""===e?(this.setCorsExceptions(e),this.widget.setValue("cors-exception",e)):this.widget.setValue("cors-exception","")}.bind(this)),!r)var j=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.loaddataPanel),R=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"GeoRSS feed url"}).inject(j),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(j));var B=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.loaddataPanel),X=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"GeoJSON data url"}).inject(B),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(B));return r||(this.georssInput=new g.Text({attributes:{id:"georss-input",placeholder:"GeoRSS feed"}}).inject(R),this.georssInput.addEvent("onChange",function(){var e=this.georssInput.getValue();this.widget.setValue("feedUrl",this.georssInput.getValue()),""!==e?(UWA.log("... loading "+e),this.loadRSSData(e),V.trackPageEvent({eventCategory:"GlobeViewer:Data",eventAction:"InputGeoRSSUrl",eventLabel:"GeoRSSUrl",appID:"X3DGLOB_AP",tenant:this.actualTenantUWA,persDim:{pd1:"3D"},scope:"Dashboard"})):(this.clearCountries(),this.globe.clearMarkers())}.bind(this))),this.geojsonInput=new g.Text({attributes:{id:"geojson-input",placeholder:"JSON data url"}}).inject(X),this.geojsonInput.addEvent("onChange",function(){var e=this.geojsonInput.getValue(),t=e.split(".");!e.contains(".")||"json"!=t[t.length-1]&&"geojson"!=t[t.length-1]?console.error("File type not supported."):(this.widget.setValue("jsonFile",this.geojsonInput.getValue()),""!==e?(UWA.log("... loading "+e),r?UWA.Data.request(e,{type:"",onComplete:this.clearAndLoad2D.bind(this,e)}):this.loadJSONData(e,!0)):r?(this.globe.clearGeoJSONFromURL(),this.widget.setValue("jsonFile",""),this.widget.setValue("jsonFieldsPrefURL","")):(this.clearCountries(),this.globe.clearMarkers()))}.bind(this)),this.widget.getValue("GeocodingTool")&&this.createGeocodingPanel(),this.elements.container},clearAndLoad2D:function(e,t){var i=JSON.parse(t);this.globe.globe.jsonUrlContent=JSON.parse(t);var o=Object.keys(i.features[0].properties).sort().indexOf("start_city"),a=Object.keys(i.features[0].properties).sort().indexOf("end_city");-1!=o&&-1!=a||this.globe.clearGeoJSONFromURL(),this.loadJSONData(e,!0)},send:function(e){var t={widgetID:this.widget.id,text:e};this.sockets.dispatch.dispatchEvent("Globe.NewMessage",t)},tagging6w:function(e){e.hasFiltersTEMP?this._current6wtags=e.filteredSubjectList:this._current6wtags=[];var t=this.widget.getValue("feedUrl"),i=widget.getValue("jsonFile");""!==i?this.loadJSONData(i,!1):""!==t&&this.loadRSSData(t)},onFilterChange:function(e){this.options.use2D?(console.log("filter change"),this.getGlobe().onFilterChange2D(e)):this.getGlobe().onFilterChange(e)},onSearch:function(e){WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable(),this.getGlobe().onSearch(e)},onSearch2D:function(e){WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable(),WUX.AFR.CommandsManager.getCommand("CreateArea").disable(),WUX.AFR.CommandsManager.getCommand("EditArea").disable(),this.getGlobe().onSearch2D(e)},onResetSearch:function(){widget.getValue("clustering")||(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable()),WUX.AFR.CommandsManager.getCommand("Reset").enable(),this.getGlobe().onResetSearch()},onResetSearch2D:function(){widget.getValue("clustering")?WUX.AFR.CommandsManager.getCommand("Reset").enable():(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable(),WUX.AFR.CommandsManager.getCommand("Reset").enable(),WUX.AFR.CommandsManager.getCommand("CreateArea").enable(),WUX.AFR.CommandsManager.getCommand("EditArea").enable()),this.getGlobe().onResetSearch2D()},onColorize:function(e){this.getGlobe().onColorize(e),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable()},onColorize2D:function(e){console.log("colorize"),this.getGlobe().onUnColorize2D(),this.getGlobe().onColorize2D(e),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable(),WUX.AFR.CommandsManager.getCommand("CreateArea").disable(),WUX.AFR.CommandsManager.getCommand("EditArea").disable()},onUnColorize:function(){console.log("uncolorize"),this.getGlobe().onUnColorize(),widget.getValue("clustering")||(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable()),WUX.AFR.CommandsManager.getCommand("Reset").enable()},onUnColorize2D:function(){this.getGlobe().onUnColorize2D(),widget.getValue("clustering")||(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable(),WUX.AFR.CommandsManager.getCommand("CreateArea").enable(),WUX.AFR.CommandsManager.getCommand("EditArea").enable()),WUX.AFR.CommandsManager.getCommand("Reset").enable()},setTopBar:function(e){if(this._topbar&&!this._topbar.noContainerRemove&&this._topbar.container.remove(),this._topbar=this.topBars[e],this._topbar&&!this._topbar.noContainerRemove){var t=this.frmWindow.getUIFrame();this._topbar.container.inject(t,"top")}},getCountryManager:function(){return this.globe.getCountryManager()},getGlobe:function(){return this.globe.globe},addMarker:function(e,t,i,o,a,r,s){return console.log("add marker 3D"),V.trackPageEvent({eventCategory:"GlobeViewer:Marker/Area",eventAction:"ClickOnAddCommand",eventLabel:"AddCommand",appID:"X3DGLOB_AP",tenant:this.actualTenantUWA,persDim:{pd1:"3D",pd2:"Marker"},scope:"Dashboard"}),this.globe.addMarker(e,t,i,o,a,r,s)},addMarker2D:function(e){return console.log("add marker 2D"),V.trackPageEvent({eventCategory:"GlobeViewer:Marker/Area",eventAction:"ClickOnAddCommand",eventLabel:"AddCommand",appID:"X3DGLOB_AP",tenant:this.actualTenantUWA,persDim:{pd1:"2D",pd2:"Marker"},scope:"Dashboard"}),this.globe.addMarker2D(e)},getMarker:function(e){return this.globe.getMarker(e)},clearMarkers:function(){this.globe.clearMarkers()},setMouseOverMarkersManager:function(e){this.globe.setMouseOverMarkersManager(e)},getCountryIndexFromISO3:function(e){return this.globe.getCountryIndexFromISO3(e)},setMouseOverCountryManager:function(e){this.globe.setMouseOverCountryManager(e)},setCountryColor:function(e,t){this.globe.setCountryColor(e,t)},clearCountries:function(){this.globe.clearCountries()},clearGeoJSONData:function(){this.globe.clearGeoJSONData()},clearGeoJSONFieldsPref:function(){widget.hasPreference("jsonFieldsPrefURL")&&widget.setValue("jsonFieldsPrefURL",""),widget.hasPreference("jsonFieldsPref3DDrive")&&widget.setValue("jsonFieldsPref3DDrive","")},clearGeoJSONInput:function(){this.geojsonInput.setValue(""),this.widget.setValue("jsonFile","")},showFrontiers:function(e){this.globe.showFrontiers(e)},setCountrySelection:function(e){this.globe.setCountrySelection(e),this.widget.setValue("countrySelection",e.toString()),a.isCountriesLoaded()||a.loadCountries().then((function(){console.info("Countries load success.")}),(function(e){throw console.error(e),e}))},getCountryObject:function(e){return this.globe.getCountryObject(e)},setDefaultColor:function(e,t,i){this.globe.setDefaultColor(e,t,i)},setBackgroundColor:function(e,t){this.globe.setBackgroundColor(e,t)},setHalo:function(e,t){this.globe.setHalo(e,t)},go:function(){this.globe.go(),this.widget.getValue("mapNavActive")&&this.setTrademark(!0);let e,t=this.options.use2D?"2D":"3D",i="",o=this.widget.getValue("autoTurn"),a=this.widget.getValue("inertia"),r="true"===this.widget.getValue("allowZoom")?1:0,s=this.widget.getValue("initGeoloc")?parseInt(this.widget.getValue("initGeoloc").split(",")[0]):0,n=this.widget.getValue("initGeoloc")?parseInt(this.widget.getValue("initGeoloc").split(",")[1]):0,l=this.widget.getValue("jsonFile")?1:0,d=this.widget.getValue("feedUrl")?1:0,c=this.widget.getValue("context")?this.widget.getValue("context").features.length:0,h=this.widget.getValue("clustering")?"Activated":"Desactivated",u=this.widget.getValue("terminatorLine")?"Activated":"Desactivated";i=/map\/resources\/map\/tms\/\d\.\d\.\d\/globe_[32]d/.test(this.widget.getValue("tilemapserver"))?"3DSMap":""!==this.widget.getValue("tilemapserver")?"ExternalTMS":this.options.use2D&&""===this.widget.getValue("tilemapserver")?"none":this.widget.getValue("theme"),this.options.use2D?(o=-1,a=-1,e=this.widget.getValue("initDistance2D")):e=this.widget.getValue("initDistance"),V.trackPageEvent({eventCategory:"GlobeViewer:Global",eventAction:"LoadWidget",eventLabel:"OnLoad",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:t,pd2:i,pd3:h,pd4:u},persVal:{pv1:c,pv2:l,pv3:d,pv4:r,pv5:s,pv6:n,pv7:e,pv8:a,pv9:o},scope:"Dashboard"})},destroy:function(){this.globe.destroy()},flyToLatLon:function(e,t,i){this.globe.flyToLatLon(e,t,i)},turnGlobeToLatLon:function(e,t,i){this.globe.turnGlobeToLatLon(e,t,i)},autoTurn:function(e){this.globe.autoTurn(e),this.rotationspeedButton.getValue()!=e&&this.rotationspeedButton.setValue(e),this.widget.setValue("autoTurn",e)},loadGeoJSON:function(e,t,i,o){return this.globe.loadGeoJSON(e,t,i,o)},enableZoom:function(e){this.globe.enableZoom(e),this.allowZoomButton.checkFlag!==e&&(this.allowZoomButton.checkFlag=e),this.widget.setValue("allowZoom",e.toString())},setZoomDistance:function(e,t){this.globe.setZoomDistance(e,t),this.options.use2D?this.widget.setValue("initDistance2D",parseFloat(e)):this.widget.setValue("initDistance",parseFloat(e))},setInitialCoordinates:function(e){var t=e,i=null;/^-?\d{1,2}(\.\d+)?,(-?\d{1,3}(\.\d+)?)$/i.test(t)&&(i=t.split(",")),null!==i&&2===i.length&&(parseFloat(i[0])<-85&&(i[0]=-85),parseFloat(i[0])>85&&(i[0]=85),Math.abs(parseFloat(i[1]))>180&&(i[1]%=180),this.options.use2D?this.flyToLatLon(i[0],parseFloat(i[1]),this.initialzoomButton.getValue()):this.turnGlobeToLatLon(i[0],parseFloat(i[1]),this.initialzoomButton.getValue()),this.widget.setValue("initGeoloc",i[0]+","+i[1])),""==t&&this.widget.setValue("initGeoloc","")},setTheme:function(e){this.currentTheme=e,this.widget.setValue("theme",e),""!==e&&""===this.widget.getValue("tilemapserver")&&this.changeSkin(e,!0),"satellite"==e?(this.setHalo("#0d324e",.8),this.backgroundcolorButton.checkFlag||this.setBackgroundColor("#005686",1)):"minimal"==e?(this.setHalo("#828282",.15),this.backgroundcolorButton.checkFlag||this.setBackgroundColor("#ffffff",1)):(this.setHalo("#40a5de",.3),this.backgroundcolorButton.checkFlag||this.setBackgroundColor("#005686",1))},setFragShader:function(e){this.globe.setFragShader(e)},updateShader:function(e){this.globe.updateShader(e)},changeSkin:function(e,t){this.globe.changeSkin(e,t)},changeTileExtension:function(e){this.globe.changeTileExtension(e)},showMeridians:function(e){this.globe.showMeridians(e)},displayHelp:function(e){this.helpDisplayed=e,this.helpDisplayed?(this.helpPanel.style.display="block",this.globe.globe.overlayDisplayed=!0):(this.helpPanel.style.display="none",this.globe.globe.overlayDisplayed=!1)},displayCustomPanel:function(e,t,i){this.customPanelDisplayed=e,this.globe.globe.overlayDisplayed=e,this.customPanelDisplayed?(this.customPanel.style.left=t.toString()+"px",this.customPanel.style.top=i.toString()+"px",this.customPanel.style.display="block"):this.customPanel.style.display="none"},resetCustomPanel:function(){this.customPanel.empty()},addContentToCustomPanel:function(e){this.customPanel.addContent(e)},loadJSONData:function(e,t){this.options.use2D||this.resetManualData(),f.authenticatedRequest(e,{method:"GET",onComplete:this.displayJSONData.bind(this,t),onFailure:()=>{f.request(e,{method:"GET",onComplete:this.displayJSONData.bind(this,t),onFailure:t=>{console.log("Failed to load",e,t)}})}})},loadRSSData:function(e){this.resetManualData(),UWA.Data.request(e,{timeout:15e3,method:"GET",type:"feed",proxy:"feed",cache:900,auth:{disable_passport:1},onComplete:this.displayRSSData.bind(this),onFailure:function(t){console.log("Failed to load",e,t)}})},displayRSSData:function(e){this.getGlobe()._taggerProxy&&this.getGlobe()._taggerProxy.setSubjectsTags(e.tagData),this.clearCountries(),this.clearMarkers();for(var t=!1,i=0;i<e.items.length;i++){var o=e.items[i];if(this._current6wtags&&0===this._current6wtags.length||this._current6wtags.indexOf(o.id)>-1)if(o.geo&&o.geo.geometry&&"Point"===o.geo.geometry.type){t=!0;var a="#ff0000";if(o.geo.properties&&o.geo.properties.relationshipTag&&o.geo.properties.relationshipTag.length>0&&(a=o.geo.properties.relationshipTag[0].replace("color=","")),o.geo.geometry&&"Point"===o.geo.geometry.type){var r=o.geo.geometry.coordinates;this.addMarker(r[1],r[0],0,a,o.title,o.content,null)}}else if(o.geo&&o.geo.properties&&o.geo.properties.featureTypeTag&&"country"===o.geo.properties.featureTypeTag[0]){!0;var s="#ff0000";if(o.geo.properties&&o.geo.properties.relationshipTag&&o.geo.properties.relationshipTag.length>0){var n=this.getCountryManager(),l=o.geo.properties.relationshipTag[0].split("/"),d=l[0].replace("countrycode=",""),c=n.getIndexFromISO3(d);s=l[1].replace("color=","");var h=n.get(c);h.title=o.title,h.description=o.description,h.setHtmlColor(s)}}}t&&this.globe.globe.setDefaultMarkerMouseOver()},displayJSONData:function(e,t){console.log("display json data");var i=JSON.parse(t);if(this.options.use2D)if(""!=widget.getPreference("jsonFieldsPrefURL").value&&(this.loadOptions=widget.getPreference("jsonFieldsPrefURL").value),this.jsonUrlFromPref)console.log("json url from pref"),this.globe.globe.jsonUrlContent=JSON.parse(t),this.globe.globe.loadGeoJSON(i,!0,this._current6wtags,this.globe._taggerProxy,this.loadOptions),this.jsonUrlFromPref=!1,widget.getValue("clustering")&&""==widget.getPreference("3DDriveGeoJSONManagement").value&&(this.getGlobe().setClustering2D(!0),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("CreateArea").disable(),WUX.AFR.CommandsManager.getCommand("EditArea").disable());else{WUX.Events.publish({event:"/SG/UICE/CMD//Geojson/IMPORT",data:{geojson:i}})}else this.clearCountries(),this.clearMarkers(),this.globe.globe.loadGeoJSON(i,!0,this._current6wtags,this.getGlobe()._taggerProxy),this.globe.globe.setDefaultMarkerMouseOver()},unzoomAll:function(){this.turnGlobeToLatLon(this.globe.globe.camera.lat,this.globe.globe.camera.lon,8),this.unzoomPanel.style.display="none",setTimeout(function(){this.globe.globe.dispatchEvent("zoomEvent",["null"])}.bind(this),750),V.trackPageEvent({eventCategory:"GlobeViewer:Interaction",eventAction:"ClickOnZoomOutCommand",eventLabel:"ZoomOutCommand",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:"3D"},scope:"Dashboard"})},unzoomAll2D:function(e){this.setZoomDistance(2,!1),V.trackPageEvent({eventCategory:"GlobeViewer:Interaction",eventAction:"ClickOnZoomOut",eventLabel:"ZoomOutCommand",appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:"2D"},scope:"Dashboard"})},setInertia:function(e){this.globe.setInertia(e),this.interactionspeedButton.getValue()!=e&&this.interactionspeedButton.setValue(e),this.widget.setValue("inertia",e)},setEditMode:function(e){this.editMode=e,this.globe.setEditMode(e)},setMaxLevel:function(e){this.globe.setMaxLevel(e)},setCorsExceptions:function(e){"none"===e&&(a.credentials={});for(var t=e.split(" "),i=0;i<t.length;i++)a.credentials[t[i]]=!1},createFrameWindow:function(e){this.widget.setValue("webafr_IsActionBarCollapsed",!0),console.log("Globe Viewer v"+this.globe.globe.version),this.options.use2D?this.frmWindow=new l({workbench:"GlobeViewer2D.xml",workbenchModule:"SocialGlobe",viewer:"none",minHeight:"200",height:"100%"}):this.frmWindow=new l({workbench:"GlobeViewer.xml",workbenchModule:"SocialGlobe",viewer:"none",minHeight:"200",height:"100%"}),this.frmWindow.inject(this.widget.body);var t=this.frmWindow.getUIFrame(),i=this.frmWindow.getViewerFrame();this.elements.container.inject(i),t.onclick=function(e){e.stopPropagation()},this.helpPanel.inject(t,"top"),this.customPanel.inject(t,"top"),this.mapPanel.inject(t,"top"),this.unzoomPanel.inject(t,"top"),this.panelDiv.inject(t,"top"),this.globe.globe.loadingInfo.inject(this.widget.body,"top"),this.actionBar=this.frmWindow._actionBar,this.actionBar.onActionBarClose((function(){WUX.AFR.CommandsManager.endAll()})),this.actionBar.onSectionChange((function(){WUX.AFR.CommandsManager.endAll()}));widget.getValue("editMode"),widget.body.clientHeight>105&&widget.body.clientWidth;this.frmWindow.globe=this;var o=this.actionBar;if(this.options.use2D)a=o.onActionBarReady(function(){o.close(),o.removeCallback(a),this.widget.getPreference("terminatorLine").value&&(o.loadModel({file:"GlobeViewer2D_TerminatorLine.xml",module:"SocialGlobe",merge:!0}),this.globe.terminatorLineManagerITF(new Date(this.widget.getValue("dateTL")),this.widget.getValue("toggleTL")))}.bind(this));else var a=o.onActionBarReady((function(){o.close(),o.removeCallback(a),widget.getValue("clustering")?(WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable()):(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable())}));_.setFrameWindow(this.frmWindow),this.widget.getValue("GeocodingTool")&&(this.GeocodingAndReverse.frmWindow=this.frmWindow);var r=this.widget.getValue("context");r&&(this.options.use2D?this.globe.globe.initialGeoJSON=r:this.getGlobe().getDataModel().build(r.features,!1,null,this.getGlobe()._taggerProxy))},endEdit2D:function(){this.geojsonReload2D=!1,this.loadPreferences.bind(this)},loadPreferences:function(){var e=this.options.use2D,t=this.widget;this.globe.globe.initialMaxLevel=18;var i=t.getValue("widgetTitle");if(t.setTitle(i),t.getValue("mapNavActive")&&(this.mapNavActive=!0),!e){var o=parseFloat(t.getValue("autoTurn"));this.autoTurn(o);this.setCountrySelection(!1);var r="true"===t.getValue("showFrontiers");this.showFrontiers(r);var s=parseFloat(t.getValue("inertia"));this.setInertia(s);var n="true"===t.getValue("allowZoom");this.enableZoom(n)}if(""!==(d=t.getValue("tilemapserver")))if(e){d+="{z}/{x}/{y}";var l=t.getValue("tileextension");this.globe.globe.initialTileMapValue=""!==l?d+l:d+".png",this.widget.getValue("mapNavActive")&&(this.globe.globe.initialTileMapValue=T.addTenantId(this.globe.globe.initialTileMapValue,this.widget.data.x3dPlatformId),this.globe.globe.initialTileMapValue+=`&appid=${A.getAppId("GlobeViewerDefault")}`),this.changeSkin(this.globe.globe.initialTileMapValue,!1)}else{this.changeSkin(d,!1),""===(h=t.getValue("cors-exception"))&&this.setCorsExceptions(d)}if(!e){var d,c=t.getValue("theme");if("minimal"==c&&(c="satellite",t.setValue("theme","satellite")),""!==c&&(this.globe.globe.skin=c,a.theme=c,this.currentTheme=c),""!==(d=t.getValue("tilemapserver")))this.changeSkin(d,!1),""===(h=t.getValue("cors-exception"))&&this.setCorsExceptions(d);""!==(l=t.getValue("tileextension"))&&this.changeTileExtension(l);var h,u=t.getValue("tilemapserver-max");""!==u&&""!==d&&this.setMaxLevel(parseInt(u)),""!==(h=t.getValue("cors-exception"))&&this.setCorsExceptions(h),""!==c&&""===d&&this.changeSkin(c,!0),"satellite"==c?(this.setHalo("#0d324e",.8),this.setBackgroundColor("#005686",1)):"minimal"==c?(this.setHalo("#828282",.15),this.setBackgroundColor("#ffffff",1)):(this.setHalo("#40a5de",.3),this.setBackgroundColor("#005686",1));var g=t.getValue("backcolor");""!==g&&this.setBackgroundColor(g,1)}if(e){var p=t.getValue("initDistance2D");""!==p&&(this.globe.globe.initialZoomLevel=p,this.initialzoomButton.firstLaunch=!0,this.initialzoomButton.setValue(this.globe.globe.initialZoomLevel));var m=t.getValue("initGeoloc");""!==m&&(this.globe.globe.initialGeoloc=m)}else{var f=parseFloat(t.getValue("initDistance"));this.setZoomDistance(f);var v=t.getValue("initGeoloc"),b=null;""!==v&&(b=v.split(",")),null!==b&&2===b.length&&this.turnGlobeToLatLon(parseFloat(b[0]),parseFloat(b[1]),parseFloat(t.getValue("initDistance")))}var w=t.getValue("feedUrl");""!==w&&(UWA.log("... loading "+w),this.loadRSSData(w));var x=t.getValue("jsonFile");e?""!==x&&!1!==this.geojsonReload2D&&(UWA.log("... loading "+x),this.jsonUrlFromPref=!0,this.loadJSONData(x,!0)):""!==x&&(UWA.log("... loading "+x),this.jsonUrlFromPref=!0,this.loadJSONData(x,!0));t.getValue("widgetHeight").toString();var y="true"===t.getValue("editMode");this.setEditMode(y);var C,S=t.getValue("3DDriveGeoJSONManagement");""!==S&&(e?!1!==this.geojsonReload2D&&(C=0)<(S=JSON.parse(S)).length&&this.addGeoJsonDroppedFiles(this,C,S,!0):(C=0)<(S=JSON.parse(S)).length&&this.addGeoJsonDroppedFiles(this,C,S,!0));t.addPreference({name:"clustering",type:"boolean",label:"Activate Clustering",defaultValue:!1}),e?t.getValue("clustering")&&(this.getGlobe().clustering=!0):this.getGlobe().setClustering(t.getValue("clustering"))},onEdit:function(){this.preferencesOpened=!0,this.options.use2D,this.initialPrefClustering=this.widget.getPreference("clustering").value},onRefresh:function(){var e=this.options.use2D;if(this.preferencesOpened){let o=e?"2D":"3D";if(this.initialPrefClustering!=widget.getPreference("clustering").value&&V.trackPageEvent({eventCategory:"GlobeViewer:Preferences",eventAction:"ClusteringPreferencesIsChange",eventLabel:"ClusteringIsActivate",eventValue:widget.getPreference("clustering").value?1:-1,appID:"X3DGLOB_AP",tenant:this.widget.actualTenantUWA,persDim:{pd1:o},scope:"Dashboard"}),e){this.actionBar.loadModel({file:"GlobeViewer2D.xml",module:"SocialGlobe",merge:!1});i=(t=this.actionBar).onActionBarReady(function(){t.close(),t.removeCallback(i),widget.getPreference("terminatorLine").value&&(t.loadModel({file:"GlobeViewer2D_TerminatorLine.xml",module:"SocialGlobe",merge:!0}),this.globe.terminatorLineManagerITF(new Date(widget.getValue("dateTL")),widget.getValue("toggleTL")))}.bind(this));widget.getValue("clustering")?(this.getGlobe().setClustering2D(!0),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable()):(this.getGlobe().setClustering2D(!1),WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable())}else{this.actionBar.loadModel({file:"GlobeViewer.xml",module:"SocialGlobe",merge:!1});var t=this.actionBar,i=t.onActionBarReady((function(){t.close(),t.removeCallback(i),widget.getValue("clustering")?(WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable()):(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable())}))}}else;this.preferencesOpened=!1},updateHeight:function(e,t,i){},showInteractionPanel:function(e){e?(this.panelDiv.show(),this.interactionPanel.show()):this.interactionPanel.hide()},showThemePanel:function(e){e?(this.panelDiv.show(),this.themePanel.show()):(this.panelDiv.hide(),this.themePanel.hide())},showAdvancedPanel:function(e){e?(this.panelDiv.show(),this.advancedPanel.show()):(this.panelDiv.hide(),this.advancedPanel.hide())},showLoadDataPanel:function(e){e?(this.panelDiv.show(),this.loaddataPanel.show()):(this.panelDiv.hide(),this.loaddataPanel.hide())},onDrop:function(e){if(e.stopPropagation(),e.preventDefault(),""!=widget.getValue("3DDriveGeoJSONManagement")){var t=new Error(w.get("GlobeViewer.DragAndDrop.Notification.DocumentIdErrorMessage"));return t.title=w.get("GlobeViewer.DragAndDrop.Notification.NoMoreFileTitle"),t.subtitle=w.get("GlobeViewer.DragAndDrop.Notification.NoMoreFileSubtitle"),void b.display({level:"error",title:t.title,subtitle:t.subtitle})}try{var i=e.dataTransfer;if(0===i.types.length)throw new Error(w.get("GlobeViewer.DragAndDrop.Notification.DropUnknownTypeErrorMessage"));if("Files"===i.types[0])throw new Error(w.get("GlobeViewer.DragAndDrop.Notification.DropFileErrorMessage"));var o=i.getData("text"),a=JSON.parse(o);0<a.data.items.length&&this.addGeoJsonDroppedFiles(this,0,a.data.items)}catch(t){throw t instanceof SyntaxError&&(t.message=w.get("GlobeViewer.DragAndDrop.Notification.InvalidJsonContentErrorMessage")),new Error(t.message)}},addGeoJsonDroppedFiles:function(e,t,i,o=!1){var a=i[t];if(!UWA.is(a,"object"))throw new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidJsonContentErrorMessage"));var r=a.envId,s=a.objectId;if(!UWA.is(s,"string")||""===s){var n=new Error(w.get("GlobeViewer.DragAndDrop.Notification.DocumentIdErrorMessage"));throw n.title=w.get(o?"GlobeViewer.DragAndDrop.Notification.ReloadError":"GlobeViewer.DragAndDrop.Notification.DragAndDropError"),n.subtitle=w.get("GlobeViewer.DragAndDrop.Notification.InvalidContentErrorMessage",{name:a.displayName}),b.display({level:"error",title:n.title,subtitle:n.subtitle,message:n.message}),new Error(n.message)}v.retrieve3DDriveUrl(r).then((function(e){return Promise.resolve(e)})).then((function(e){return v.retrieveDocumentTypes(e,a.objectId,r)})).then((function(e){if("GEOJSON"!==e.extension.toUpperCase()){var t=new Error(w.get("GlobeViewer.AddContent.Notification.UnsupportedFileTypeErrorMessage",{format:e.extension.toUpperCase()}));throw t.title=w.get(o?"GlobeViewer.DragAndDrop.Notification.ReloadError":"GlobeViewer.DragAndDrop.Notification.DragAndDropError"),t.subtitle=w.get("GlobeViewer.AddContent.Notification.ContentAdditionError",{name:a.displayName}),b.display({level:"error",title:t.title,subtitle:t.subtitle,message:t.message}),new Error(t.message)}return v.retrieveDocumentURL(e.driveUrl,a.objectId,r)})).then((function(e){return v.retrieveDocumentContent(e,r)})).then((function(r){e.addGeoJSONContent(r,a,o);++t<i.length&&b.display({level:"warning",title:w.get("GlobeViewer.AddContent.Notification.OnlyOneFile.Title"),subtitle:w.get("GlobeViewer.AddContent.Notification.OnlyOneFile.Subtitle"),message:w.get("GlobeViewer.AddContent.Notification.OnlyOneFile.Message")})})).catch(function(e){console.log(e),(e=new Error(w.get("GlobeViewer.AddContent.Notification.UnaccessibleData"))).title=w.get("GlobeViewer.AddContent.Notification.DataAccessError"),e.subtitle=w.get("GlobeViewer.AddContent.Notification.ContentAdditionError",{name:a.displayName}),b.display({level:"error",title:e.title,subtitle:e.subtitle,message:e.message}),this.globe.globe.loadingInfo.hide()}.bind(this))},checkGeojsonContent:function(e){try{var t;if(UWA.is(e,"string"))t=JSON.parse(e);else{if(!UWA.is(e,"object"))return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))};t=e}if("FeatureCollection"!==t.type)return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))};if(0===t.features.length)return{ok:!1,error:new Error(w.get("GlobeViewer.AddContent.Notification.EmptyGeojsonFile"))};for(var i=0;i<t.features.length;i++){var o=t.features[i];if(!o.geometry)return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))};if(this.options.use2D){if("Point"!==o.geometry.type&&"Polygon"!==o.geometry.type&&"MultiPolygon"!==o.geometry.type&&"LineString"!==o.geometry.type)return{ok:!1,error:new Error(w.get("GlobeViewer.AddContent.Notification.UnsupportedFeatureTypeErrorMessage",{type:o.geometry.type}))}}else{if("Point"!==o.geometry.type)return{ok:!1,error:new Error(w.get("GlobeViewer.AddContent.Notification.UnsupportedFeatureTypeErrorMessage",{type:o.geometry.type}))};o.properties&&void 0===o.properties.is3DDriveContent&&(o.properties.is3DDriveContent=!0)}}return{ok:!0,content:t}}catch(e){return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))}}},addGeoJSONContent:function(e,t,i=!1){var o=this.checkGeojsonContent(e);if(!o.ok){var a=o.error;return a.title=w.get(i?"GlobeViewer.DragAndDrop.Notification.ReloadError":"GlobeViewer.DragAndDrop.Notification.DragAndDropError"),a.subtitle=w.get("GlobeViewer.AddContent.Notification.ContentAdditionError",{name:t.displayName}),b.display({level:"error",title:a.title,subtitle:a.subtitle,message:a.message}),o}if(this.options.use2D)if(i)this.loadOptions=widget.getPreference("jsonFieldsPref3DDrive").value,b.display({level:"success",title:w.get(i?"GlobeViewer.DragAndDrop.Notification.ReloadSuccess":"GlobeViewer.DragAndDrop.Notification.DragAndDropSuccess"),subtitle:w.get("GlobeViewer.DragAndDrop.Notification.DragAndDropSuccessfulLoad",{name:t.displayName}),message:w.get("GlobeViewer.AddContent.Notification.GeojsonSuccessfulload")}),this.loadGeoJSON(o.content,!0,this.getGlobe()._taggerProxy);else{var r=Object.keys(o.content.features[0].properties).sort().indexOf("title"),s=Object.keys(o.content.features[0].properties).sort().indexOf("description");new k(this,this.globe.globe,{ID:"GeojsonFieldsChoice",name:t.displayName,titleIndex:r,descIndex:s},null,o.content),this.addGeoJSONFileToPreference(t)}else b.display({level:"success",title:w.get(i?"GlobeViewer.DragAndDrop.Notification.ReloadSuccess":"GlobeViewer.DragAndDrop.Notification.DragAndDropSuccess"),subtitle:w.get("GlobeViewer.DragAndDrop.Notification.DragAndDropSuccessfulLoad",{name:t.displayName}),message:w.get("GlobeViewer.AddContent.Notification.GeojsonSuccessfulload")}),this.loadGeoJSON(o.content,!0,this.getGlobe()._taggerProxy),i||this.addGeoJSONFileToPreference(t);return o},addGeoJSONFileToPreference:function(e){var t=widget.getPreference("3DDriveGeoJSONManagement").value;this.use2D?(t=e,widget.setValue("3DDriveGeoJSONManagement",JSON.stringify(t))):-1===(t=""!==t?JSON.parse(t):[]).map((function(e){return e.objectId})).indexOf(e.objectId)&&(t.push(e),widget.setValue("3DDriveGeoJSONManagement",JSON.stringify(t)));console.log(widget.getPreference("3DDriveGeoJSONManagement").value)},clearDrivePreferences:function(){widget.hasPreference("3DDriveGeoJSONManagement")&&widget.setValue("3DDriveGeoJSONManagement","")},addHelpPopup:function(e,t){var i=new UWA.Element("span",{html:"",class:"uwa-input-button display-help-button",styles:{background:"url("+d.getWebappsAssetUrl("SocialGlobe","icons/32/I_CFHelp.png")+")"}}).inject(e),o=new UWA.Element("div",{class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}});switch(t){case L:case G:case I:case E:var a=w.get("GlobeViewer.DisplaySettings.TMS.help."+t);new UWA.Element("p",{html:a,class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(o)}if(t===L){var r=new UWA.Element("div",{html:"<br/> <br/>"+w.get("GlobeViewer.DisplaySettings.TMS.TilesPoliciesRespect"),class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(o);new UWA.Element("a",{html:w.get("GlobeViewer.DisplaySettings.TMS.link"),class:"wux-controls-switch-container inner-width",href:"https://wiki.openstreetmap.org/wiki/Tile_servers",target:"_blank"}).inject(r),new UWA.Element("p",{html:w.get("GlobeViewer.DisplaySettings.TMS.help.URLCors"),class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(o)}return new y({target:i,trigger:"click"}).setBody(o)},clearAll:function(){this.tmsInput.setValue(""),this.tileextensionInput.setValue(""),this.tmsmaxlevelInput.setValue(""),this.corsserverInput.setValue(""),this.tmsInput.events.input.change(),this.tileextensionInput.events.input.change(),this.tmsmaxlevelInput.events.input.change(),this.corsserverInput.events.input.change()},saveAll:function(){var e=this.getGlobe().getDataModel().saveToGeoJSON();return this.widget.setValue("context",e),e},saveMarker:function(e){if(e){var t=this.widget.getValue("context"),i=UWA.clone(t);if(i&&i.features&&i.features.length){for(var o=0;o<i.features.length;o++){var a=i.features[o];a&&a.properties&&a.properties.descriptionType===e.descriptionType&&a.properties.link===e.link&&(a.properties.title&&a.properties.title===e.title||a.properties.ISO3&&a.properties.ISO3[0]===e.title[0])&&a.properties.persist===e.persist&&(a.properties.width=e.width,a.properties.height=e.height)}this.widget.setValue("context",i)}}},updatePanelPreference:function(e,t){var i,o=this.widget.getPreference("wuxPanelManagement").value;(i=""!==o?JSON.parse(o):{})[e]=t,this.widget.setValue("wuxPanelManagement",JSON.stringify(i))},removePanelPreference:function(e){var t=this.widget.getPreference("wuxPanelManagement").value;if(""!==t){var i=JSON.parse(t);delete i[e],this.widget.setValue("wuxPanelManagement",JSON.stringify(i))}},removeAllPanelPreferences:function(){this.widget.setValue("wuxPanelManagement","")},getPanelPreference:function(e){var t=this.widget.getPreference("wuxPanelManagement").value;if(""!==t)return JSON.parse(t)[e]},resetManualData:function(){this.options.use2D||(this.clearCountries(),this.clearMarkers(),this.clearDrivePreferences(),_.resetAll(),this.removeAllPanelPreferences(),this.saveAll())},createGeocodingPanel:function(){new Date;var e=new UWA.Element("div",{html:""});this.geocodingImmersiveFrame=new S({identifier:"WebUIImmersiveFrame_Geocoding"}),this.geocodingImmersiveFrame.inject(this.widget.body),this.GeocodingAndReverse=new P({domId:"origin",renderID:"defaultCityRenderingGeocodingMarker",folder:{id:"geocoding-folder",name:"to be deifned"}}).inject(e),this.GeocodingAndReverse.globe=this.getGlobe(),null!=widget.getValue("GeocodingServerUrl")&&""!=widget.getValue("GeocodingServerUrl")?this.GeocodingAndReverse.url=widget.getValue("GeocodingServerUrl"):b.display({level:"error",title:"Geocoding issue",subtitle:"Invalid Geocoding server url",message:"Please define a correct server url using 'GeocodingServerUrl' preference"}),this.geocodingPanel=new M({immersiveFrame:this.geocodingImmersiveFrame,title:"Geocoding",content:e})},setMapNavigatorActive:function(){if(!this.mapNavActive){this.mapNavActive=!0;var e="";this.options.use2D?(e=T.get2dTmsUrl(this.widget.getValue("mapServiceUrl"),this.widget.data.x3dPlatformId)+"{z}/{x}/{y}.png",e=T.addTenantId(e,this.widget.data.x3dPlatformId)):e=T.get3dTmsUrl(this.widget.getValue("mapServiceUrl"),this.widget.data.x3dPlatformId),this.setTrademark(!0),this.changeTileExtension(".png"),this.setMaxLevel(18),this.changeSkin(e,!1),this.widget.setValue("tileextension",".png"),this.widget.setValue("tilemapserver",e),this.widget.setValue("tilemapserver-max",18),this.widget.setValue("mapNavActive",!0)}},setMapNavigatorInactive:function(){this.mapNavActive=!1,this.setTrademark(!1),this.widget.setValue("tileextension",""),this.widget.setValue("tilemapserver",""),this.widget.setValue("tilemapserver-max",""),this.widget.setValue("mapNavActive",!1)},setTrademark:function(e){this.options.use2D?this.globe.globe.setTrademark2D(e):(null==this.trademark3d&&(this.trademark3d=new UWA.Element("div",{html:F.getOsmTrademark(),domId:"trademark",class:"trademark trademark3d"}),this.trademark3d.inject(this.frmWindow.getUIFrame(),"top")),this.trademark3d.style.display=e?"block":"none")}})})),define("DS/SocialGlobe/GlobeUWALoader",["require","exports","DS/SocialGlobe/GlobeUWA","DS/SocialGlobeServices/MapNavigator/MapNavigatorServices","DS/SocialGlobe/views/GlobeUWALoaderView","DS/SocialGlobe/Utils","DS/i3DXCompassServices/i3DXCompassServices"],(function(e,t,i,o,a,r,s){"use strict";return function(){function e(e){var t=this;this.mapNavigatorTms=null,this.mapNavigatorAvailable=!1,this.loadGlobeViewer=function(e){t.widget.body.empty(),t.widget.getValue("mapNavAvailable")||(t.widget.setValue("mapNavAvailable",t.mapNavigatorAvailable),e?(t.widget.setValue("mapNavActive",!0),t.widget.getValue("tilemapserver")&&""!=t.widget.getValue("tilemapserver")||(t.widget.setValue("tilemapserver",t.mapNavigatorTms),t.widget.setValue("tilemapserver-max",18),t.widget.setValue("tileextension",".png"))):t.widget.setValue("mapNavActive",!1));var o="".concat(t.widget.getValue("widgetHeight").toString(),"px");t.globe||(t.globe=new i(t.widget,{container:t.widget.body,use2D:e,height:o}),console.log("New GlobeUWA is2D: ".concat(e))),t.globe.createFrameWindow(o),t.widget.setValue("use2D",e),t.globe.loadPreferences(),t.globe.globe.globe.mapServiceAvailable=!0,t.globe.go()},this.widget=e,r.setTenantId(this.widget.data.x3dPlatformId),a.setLoad(this.loadGlobeViewer),this.callMapNavigator().then((function(e){a.render()})).catch((function(e){console.log("Promise Catch"),console.log(e),a.render()}))}return e.prototype.getMapNavigatorUrl=function(){console.log("I3DXCOMPASSSERVICE = ",s),s.getPlatformServices({onComplete:function(e){console.log(e)}}),this.mapNavigatorTms=null},e.prototype.callMapNavigator=function(){var e=this;return o.retrieveMapUrl(r.getTenantId(),r.getAppId("GlobeViewerDefault")).then((function(t){return e.mapNavigatorAvailable=!0,e.mapNavigatorTms=o.get2dTmsUrl(t,r.getTenantId()),a.setTms(e.mapNavigatorTms),e.widget.setValue("mapServiceUrl",t),Promise.resolve(t)}))},e}()}));