define("DS/WebDocumentVisualization/WebDocumentVisualizationServices",["require","exports","DS/SceneGraphNodes/CSS3DNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/Selection/CSOManager","DS/Selection/PSOManager","UWA/Core","DS/Controls/ProgressBar","css!./WebDocumentVisualization.css"],(function(e,t,n,o,i,a,r,l,s,c,d,u,m,g){"use strict";let f,h,p;const v=96/72,E=210,y=25.4,P=17.4,b=5,D=3,w=["iframe.css","patch.css","UIKIT.css","Menu.css","views.css","views_default.css","WebDocumentVisualization.css","bundle-min.css"];let x,C,S=[],I=1/0,T=[],M=[],k="#CC092F",R="#6FBC4B";function A(e){let t=document.createElement("textarea");return t.innerHTML=e,t.value}class V{static getMMPerPixelRatio(e){if(e){let t=e.currentViewpoint;return(t.camera.top-t.camera.bottom)/e.SCREEN_HEIGHT}return 25.4/96}static setCompareReqIDList(e,t){T=e,M=t}static setCompareColor(e,t){k=e,R=t}static getRequirementElements(e){return h=0,p=1,S.length=0,new Promise((function(t){(async()=>{let n=new Map,o=0,i=V.getMMPerPixelRatio();S.length=0;const a=function(e){if(this.canvas){let t=V.getMMPerPixelRatio(),n=this.canvas.getContext("2d");if(n){n.fillStyle="white",n.fillRect(0,0,20.4/t,this.height/t),this.selected?n.fillStyle="#368ec4":this.hovered?n.fillStyle="#77797c":n.fillStyle=e||"#f1f1f1";let o=this.pathId===S[0]?(y+b)/t:b/t,i=this.pathId===S[S.length-1]?(y+D)/t:D/t;n.fillRect(P/t,o,5,this.height/t-o-i)}}this.canvasTexture.needsUpdate=!0},r=function(){d.empty(),this.selected=!0,this.pathElement&&d.add({pathElement:this.pathElement})};for(let t=0;t<e.length;t++){let l=e[t];const u=l.pathId;if(void 0!==l.content){let f,h=m.createElement("div",{id:"WebDocReqElem-"+u,class:"WebDocRequirementsMainDiv"}),p=m.createElement("div",{class:"WebDocRequirementsMainContainer",styles:{width:E/i+"px","padding-top":0===n.size?y/i+"px":0,"padding-right":y/i+"px","padding-bottom":t===e.length-1?y/i+"px":0,"padding-left":y/i+"px"}}).inject(h);if("Chapter"===l.type){let e=m.createElement("div",{class:"WebDocRequirementChapterMainDiv",html:l.chapterLevelTag+" - "+(l.content||""),styles:{"font-size":l.fontSize+"px"}});p.appendChild(e)}else if("Comment"===l.type){let e=m.createElement("div",{class:"WebDocRequirementCommentMainDiv"}),t=m.createElement("div",{class:"WebDocRequirementCommentHeaderDiv"}).inject(e);m.createElement("span",{class:"WebDocRequirementChapterIndex",text:l.chapterLevelTag+" - "}).inject(t),m.createElement("span",{class:"WebDocRequirementCommentIndex",text:l.subLevelTag}).inject(t),l.typeIconUrl&&(f=m.createElement("img",{class:"WebDocRequirementCommentHeaderIconDiv",src:l.typeIconUrl,events:{error:function(){f.remove()}}}).inject(t)),m.createElement("div",{class:"WebDocRequirementCommentHeaderTitleDiv",html:l.title||""}).inject(t),m.createElement("div",{class:"WebDocRequirementCommentContentDiv",html:l.content?A(l.content):""}).inject(e),p.appendChild(e)}else if("Requirement"===l.type){let e=m.createElement("div",{class:"WebDocRequirementMainDiv"}),t=m.createElement("div",{class:"WebDocRequirementHeaderDiv"}).inject(e);m.createElement("span",{class:"WebDocRequirementChapterIndex",text:l.chapterLevelTag+" - "}).inject(t),m.createElement("span",{class:"WebDocRequirementIndex",text:l.subLevelTag}).inject(t),l.typeIconUrl&&(f=m.createElement("img",{class:"WebDocRequirementHeaderIconDiv",src:l.typeIconUrl,events:{error:function(){f.remove()}}}).inject(t)),m.createElement("div",{class:"WebDocRequirementHeaderTitleDiv",html:l.title||""}).inject(t),m.createElement("div",{class:"WebDocRequirementContentDiv",html:l.content?A(l.content):""}).inject(e),p.appendChild(e)}const v=h.querySelectorAll("img:not(.WebDocRequirementHeaderIconDiv)");v.length&&await new Promise((e=>{let n=0;const o=i=>{if(i instanceof ErrorEvent&&window.console.error(`Some images on element: ${t+1}, type: ${l.type} were not correctly loaded`),n++,n===v.length){for(let e=0;e<v.length;e++){const t=v[e];t.removeEventListener("load",o),t.removeEventListener("error",o)}e()}};for(let e=0;e<v.length;e++){const t=v[e];t.src&&t.src.startsWith("http")?fetch(t.src).then((e=>e.blob())).then((e=>{const n=new FileReader;n.onload=function(e){var n;t.addEventListener("load",o),t.addEventListener("error",o),t.src=null===(n=e.target)||void 0===n?void 0:n.result},n.onerror=o,n.readAsDataURL(e)})).catch(o):t.complete?o():(t.addEventListener("load",o),t.addEventListener("error",o))}}));const w=e=>{var t;for(let n=0;n<e.length;n++){const o=e[n],i=o.tagName&&o.tagName.toLowerCase();if(i&&(i.startsWith("v:")||i.startsWith("w:"))){const e=Array.from(o.children);for(let n=0;n<e.length;n++){const i=e[n];null===(t=o.parentNode)||void 0===t||t.insertBefore(i,o)}o.remove(),w(e)}else o.children.length>0&&w(Array.from(o.children))}};w([h]),document.body.appendChild(h);let x=h.firstChild.getSize().height*i;document.body.removeChild(h);let C=o;o-=x;let I=h.cloneNode(!0);I.id=I.id+"Clone";let T=new g({infiniteFlag:!0,displayStyle:"lite",shape:"circular",height:30,emphasize:"info"});S.push(u);let M={pathId:u,type:"requirement",relType:l.type,html:h,title:l.displayTitle?A(l.displayTitle):l.title?A(l.title):"",content:I,height:x,selected:!1,hovered:!1,marginTop:0===n.size?y:0,marginBottom:t===e.length-1?y:0,progressBar:T,width:E,scale:0,coordinates:{top:C,bottom:C-x,left:-105,right:105},setAsCurrent:r,updateSelectionStatus:a};n.set(u,M);let k=m.createElement("div",{class:"WebDocRequirementsStatusDiv",styles:{left:P/i+"px",top:0===n.size?(y+b)/i+"px":b/i+"px",bottom:t===e.length-1?(y+D)/i+"px":D/i+"px"}}).inject(h);k.setAttribute("data-html2canvas-ignore","true"),k.setAttribute("draggable","true"),k.ondragstart=e=>{M.pathElement&&!d.isIn({pathElement:M.pathElement})&&(e.ctrlKey||d.empty(),d.add({pathElement:M.pathElement}));let t=d.get(),n=[];for(let e=0;e<t.length;e++){let o=t[e].pathElement.getLastElement(!0);if(o.getReqInfo){let{id:e,type:t}=o.getReqInfo();n.push({envId:s.getPlatformId(),serviceId:"3DSpace",contextId:c.getSetting("pad_security_ctx"),objectId:e,objectType:t})}}if(e.dataTransfer&&(e.dataTransfer.setData("text",JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:n},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0})),l.typeIconUrl)){const t=new Image;t.src=l.typeIconUrl,e.dataTransfer.setDragImage(t,10,10)}};let R=m.createElement("div",{class:"WebDocPageLoadingProgressBar"}).inject(h);R.setAttribute("data-html2canvas-ignore",!0),T.inject(R)}}if(!x){let e="";const t=document.styleSheets;for(let n=0;n<t.length;n++){const o=t[n].href;if(o){let t=o.split("/");if(t=t?t[t.length-1].split("?"):void 0,t&&w.includes(t[0]))try{let t=document.styleSheets[n].cssRules;for(let n=0;n<t.length;n++)t[n].cssText&&(e+=t[n].cssText+"\n")}catch(t){try{e+=await fetch(o,{headers:{"Content-Type":"text/css",Accept:"text/css,*/*;q=0.1"}}).then((e=>e.text()))+"\n"}catch(e){window.console.error(e)}}}}const n="http://www.w3.org/2000/svg";x=document.createElementNS(n,"svg");const o=document.createElementNS(n,"foreignObject");x.setAttributeNS(null,"width",(E/i).toString()),o.setAttributeNS(null,"width","100%"),o.setAttributeNS(null,"height","100%"),o.setAttributeNS(null,"externalResourcesRequired","true"),o.appendChild(document.createElement("body"));let a=document.createElement("style");"sstyleSheet"in a?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e)),x.appendChild(a),x.style.setProperty("--first-ReqCompare-Color",R),x.style.setProperty("--second-ReqCompare-Color",k),x.appendChild(o)}t(n)})()}))}static getRequirementBookmarks(e){const t=[],n={1:t};return e.forEach((e=>{if(e.level>0){let t={pointedId:e.pathId,title:e.displayTitle?A(e.displayTitle):e.title?A(e.title):"",iconUrl:e.typeIconUrl,items:[]};n[e.level].push(t),n[e.level+1]=t.items}})),t}static renderElement(e,t,r){var l;if(e&&e.content&&x){let s=V.getMMPerPixelRatio();if(e.isRendering)return e.needsUpdate=!0,void t();e.isRendering=!0;const c=I/Math.floor(e.width/s),d=I/Math.floor(e.height/s),u=Math.min(e.scale*window.devicePixelRatio,5,c,d);if(e.canvas||(e.canvas=m.createElement("canvas")),e.canvas.width=Math.floor(e.width/s*u),e.canvas.height=Math.floor(e.height/s*u),!e.node){e.canvasTexture=new i.Texture(e.canvas,void 0,i.ClampToEdgeWrapping,i.ClampToEdgeWrapping,i.NearestFilter,i.NearestFilter),e.canvasTexture.needsUpdate=!0,e.canvasMaterial=new i.MeshBasicMaterial({force:!0,transparent:!0,map:e.canvasTexture}),e.node=o.createRectangleNode({width:e.width,height:e.height,fill:!0,noEdge:!0,material:e.canvasMaterial}),e.node.setName("WebDocElementNode"),e.node.getReqInfo=function(){return{id:e.pathId?e.pathId.split("/").pop():"",pathId:e.pathId,type:e.relType}},e.node.excludeFromHighlight(!0,!0);let t=new n(e.html,s,"WebDocRequirementContentNode");t.setPickability(!0),t.setPickable(a.PICKTHROUGH),t.setMatrix((new i.Matrix4).makeTranslation(e.width/2,e.height/2,0)),e.node.setMatrix((new i.Matrix4).makeTranslation(-e.width/2,e.coordinates.top-e.height,0)),e.node.addChild(t)}let g=this;x.setAttributeNS(null,"height",(e.height/s).toString());const f=null===(l=x.lastElementChild)||void 0===l?void 0:l.firstElementChild;null==f||f.appendChild(e.content);const h=new Image(e.canvas.width,e.canvas.height);h.onload=()=>{var n;if(!e.canvas)return;const o=e.canvas.getContext("2d");let i;o.scale(u,u),T&&T.length&&T.indexOf(e.pathId)>=0?i=k:M&&M.length&&M.indexOf(e.pathId)>=0&&(i=R),o.fillStyle="#ffffff",o.fillRect(0,0,e.canvas.width,e.canvas.height),o.drawImage(h,0,0),e&&e.canvasTexture&&e.updateSelectionStatus(i),null===(n=e.html.firstElementChild)||void 0===n||n.classList.add("loaded"),e.isRendering=!1,e.onError=!1,e.needsUpdate?(e.needsUpdate=!1,g.renderElement(e,t,r)):t()},h.onerror=()=>{e.isRendering=!1,e.needsUpdate=!1,e.onError?r&&r():(e.onError=!0,g.renderElement(e,t,r))},h.src=`data:image/svg+xml;charset=utf-8,${encodeURIComponent((new XMLSerializer).serializeToString(x))}`,null==f||f.removeChild(e.content)}}static renderDocumentElements(e){if(!(e&&e.elements&&e.currentElement&&e.viewpoint&&e.onComplete))return e.onFailure?e.onFailure():void 0;if(I===1/0){const t=e.viewpoint.viewer.getWebGLContext();I=t.getParameter(t.MAX_TEXTURE_SIZE)}let t=e.scale||1,n=e.currentElement,o=e.viewpoint.getEyePosition().y+e.viewpoint.getCamera().bottom,i=0,a=0,r=this,l=0,s=function(){l--,0===l&&e.onComplete()};x&&(x.style.setProperty("--first-ReqCompare-Color",R),x.style.setProperty("--second-ReqCompare-Color",k)),function c(){if(n===e.elements.size+1&&(a++,n=e.currentElement-a,i=p),n<1||n>e.elements.size)return;let d=!1,u=S[n-1],m=e.elements.get(u);m&&(m.node||(d=!0),(!m.scale||Math.abs(m.scale-t)>.01)&&(d=!0,m.scale=t),m.visible=n>=e.currentElement,m.toLoad=!0,d&&(l++,"requirement"===m.type?r.renderElement(m,s,e.onFailure):r.renderPage(m,s,e.onFailure)),o>m.coordinates.top&&(m.visible=!1,i++),i<p?(n++,c()):a<p&&(m.visible=!1,a++,n=e.currentElement-a,c()))}(),0===l&&e.onComplete()}static computeCurrentElement(e,t,n,o=!1){let i=n||1;if(e&&t&&t.size&&i){let n=h||2e-4,a=e.getEyePosition().y+e.getCamera().top,r=!1,l=t.get(S[i-1]);if(l){if(a-l.coordinates.top>n/2)r=!0;else if(a-l.coordinates.bottom>n/2)return i>1&&o?this.computeCurrentElement(e,t,i-1,o):i;for(let e=r?i-2:i;r?e>=0:e<S.length;r?e--:e++)if(S[e]){let o=t.get(S[e]);if(o&&o.coordinates&&a-o.coordinates.bottom>n/2&&a-o.coordinates.top<=n/2)return e+1}if(r)return 1}}return i||1}static updateElementsToLoad(e,t,n){if(!e||!n)return;let o=n.getEyePosition().y+n.getCamera().bottom,i=0,a=e.values();for(let n=0;n<e.size;n++){let e=a.next().value;e&&("selected"in e&&e.selected?e.toLoad=!0:n+1<t-p?e.toLoad=!1:o>e.coordinates.top?(i++,e.toLoad=i<=p):e.toLoad=!0)}}static cleanRequirementElements(e){var t;let n=e.values();for(let o=0;o<e.size;o++){let e=n.next().value;e&&e.canvas&&(null===(t=e.canvas)||void 0===t||t.destroy(),e.html&&e.html.destroy(),e.canvasTexture&&e.canvasTexture.dispose(),e.canvasMaterial&&e.canvasMaterial.dispose(),e.progressBar&&e.progressBar.destroy(),e.node&&e.node.removeChildren())}e.clear(),x&&(x.remove(),x=null),S.length=0}static getZoomLevel(e){let t=V.getMMPerPixelRatio(e);return parseInt((V.getMMPerPixelRatio()/t*100).toFixed(0))||100}static updateNodesInSession(e,t,n=!1){if(!e||!t||!t.size)return;let o=t.values();for(let i=0;i<t.size;i++){let i=o.next().value;if(i&&i.node)if(n&&!i.toLoad&&i.loaded)i.loaded=!1,i.visible=!1,e.removeChild(i.node),"requirement"===i.type&&i.html.removeEvents();else if(i.toLoad&&!i.loaded&&(i.loaded=!0,e.addChild(i.node),"requirement"===i.type)){if(!i.pathElement){let e=[],t=i.node;for(;t&&!t.notAllowedInPathElement;)e.unshift(t),t=t.parents[0];i.pathElement=new l(e)}i.html.addEvents({mouseover:()=>{"requirement"!==i.type||u.isIn({pathElement:i.pathElement})||(u.empty(),u.add({pathElement:i.pathElement}))},click:e=>{if("requirement"===i.type){if(e.shiftKey&&C){let e=S.indexOf(i.pathId),n=S.indexOf(C);if(-1!==e&&-1!==n){let o=[];for(let i=Math.min(e,n);i<=Math.max(e,n);i++){let e=t.get(S[i]);e&&"requirement"===e.type&&o.push({pathElement:e.pathElement})}d.add(o)}}C=i.selected?i.pathId:null}}}),i.selected&&d.add({pathElement:i.pathElement})}}}static getElementIdAtIndex(e){return S[e]}static getElementIndexById(e){return S.indexOf(e)}static getPdfDocument(e){e&&e.dataBuffer&&e.onComplete||!e.onFailure?(window.PDFJS_VERSION="2.13.216",window.require(["DS/PDFjs/PDFjs"],(t=>{f=t,h=4,p=2,f.getDocument({cMapPacked:t.cMapPacked,cMapUrl:t.cMapUrl,data:e.dataBuffer,password:e.password}).promise.then((function(t){t?e.onComplete(t):e.onFailure&&e.onFailure()}),(function(t){"PasswordException"===t.name?t.code!==f.PasswordResponses.NEED_PASSWORD&&t.code!==f.PasswordResponses.INCORRECT_PASSWORD||!e.onIncorrectPassword?e.onFailure&&e.onFailure(t):e.onIncorrectPassword():e.onFailure&&e.onFailure(t)}))}))):e.onFailure()}static getPdfPages(e,t){return new Promise((function(n,o){e||o(new Error("The PDF Document is undefined"));let i=new Map,a=0,r=function(t){e.getPage(t.number).then((function(r){if(r){t.pageObj=r;let o=t.pageObj.getViewport({scale:v}),l=V.getMMPerPixelRatio(),s=o.width/2*l,c=i.get((t.number-1).toString()),d=t.number>1&&c?c.coordinates.bottom-h:0;t.coordinates.top=d,t.coordinates.bottom=d-o.height*l,t.coordinates.left=-s,t.coordinates.right=s,t.height=t.coordinates.top-t.coordinates.bottom,t.width=t.coordinates.right-t.coordinates.left,t.pageLayer=m.createElement("div",{id:"WebDocPageLayerPage"+t.number,class:"WebDocPageLayer"}),a++,a===e.numPages&&n(i)}else o(new Error("Page "+t.number+" not finded"))}),o)};S.length=0;for(let n=0;n<e.numPages;n++){let e=n+1,o={type:"page",number:e,scale:t,rotationAngle:0,height:0,width:0,coordinates:{top:0,bottom:0,right:0,left:0}};S.push(e.toString()),i.set(e.toString(),o),r(o)}}))}static getPdfCommentsFromPages(e){return new Promise((function(t,n){const o={Completed:"processed",Cancelled:"withdrawn",Accepted:"accepted",Rejected:"rejected"};e||n(new Error("Pages are Undefined"));let a=[],r=new Map,l=new Map;e.size||t(a);let s=0;e.forEach((function(n){n.pageObj&&n.pageObj.getAnnotations().then((function(c){if(n.pageObj){let e=null,t=null,a=n.pageObj.getViewport({scale:n.scale*v});for(let s=0;s<c.length;s++)if(c[s].inReplyTo&&c[s].state&&c[s].stateModel)l.set(c[s].inReplyTo,o[c[s].state]);else if("Popup"!==c[s].subtype)e=c[s].id,t=c[s].rect;else if(c[s].contentsObj&&c[s].contentsObj.str&&c[s].parentId&&c[s].parentId===e&&t){let o=null,l=V.getMMPerPixelRatio(),d=new i.Vector3(l*t[0]*v,l*-(a.viewBox[3]-t[3])*v,0);t&&t.length&&(o={position:d,width:l*(t[2]-t[0])*v,height:l*(t[3]-t[1])*v}),r.set(e||c[s].id,{owner:{name:c[s].titleObj.str},content:c[s].contentsObj.str.split(/(?:\r\n|\r|\n)/g),isReadOnly:!0,pointedPage:n.number,pointedPosition:d,rect:o}),e=null,t=null}}s++,s===e.size&&(r.forEach(((e,t)=>{l.has(t)?e.status=l.get(t):e.status="",a.push(e)})),t(a))}))}))}))}static getPdfLinksFromPages(e,t){return new Promise((function(n,o){t||o(new Error("Pages are Undefined"));let a=[];t.size||n(a);let r=0;t.forEach((function(o){o.pageObj&&o.pageObj.getAnnotations().then((function(l){let s=l.filter((function(e){return"Link"===e.subtype}));if(s&&s.length&&o.pageObj){let t=o.pageObj.getViewport({scale:o.scale*v}),n=m.createElement("div",{id:"WebDocAnnotationLayerPage"+o.number,class:"WebDocAnnotationLayer"}).inject(o.pageLayer);o.updateAnnotationScale=function(e){n.setStyle("transform","scale("+e/t.scale*v+")")},s.forEach((function(o){let r=m.createElement("section",{class:"WebDocLinkAnnotation"}).inject(n);r.setStyle("transform","scale("+t.scale+")");let l,s=o.rect;if(r.setStyles({"transform-origin":-s[0]+"px "+-(t.viewBox[3]-s[3])+"px 0px",left:s[0]+"px",top:t.viewBox[3]-s[3]+"px",width:s[2]-s[0]+"px",height:s[3]-s[1]+"px"}),o.url||o.unsafeUrl)l=m.createElement("a",{href:o.url?o.url:o.unsafeUrl}).inject(r),a.push({div:l,content:m.createElement("p",{text:o.url||o.unsafeUrl,styles:{margin:"2px",padding:0,userSelect:"text"}})});else if(o.dest){let t,n,s,c,d,u,g,f;l=m.createElement("a").inject(r);let h=V.getMMPerPixelRatio();Array.isArray(o.dest)?(u="object"==typeof o.dest[1]?o.dest[1].name:null,g=o.dest[2]?h*o.dest[2]*v:null,f=o.dest[3]?h*o.dest[3]*v:null,s="FitH"===u,c="FitV"===u||"Fit"===u,d=o.dest[4]||null,n=null!==g&&null!==f?new i.Vector3(g||0,f||0,0):null,"number"==typeof o.dest[0]?t=o.dest[0]+1:"object"==typeof o.dest[0]&&e.getPageIndex(o.dest[0]).then((function(e){t=e+1}))):"string"==typeof o.dest&&e.getDestination(o.dest).then((function(o){o&&o.length&&(u="object"==typeof o[1]?o[1].name:null,g=o[2]?h*o[2]*v:null,f=o[3]?h*o[3]*v:null,s="FitH"===u,c="FitV"===u||"Fit"===u,d=o[4]||null,n=null!==g&&null!==f?new i.Vector3(g||0,f||0,0):null,e.getPageIndex(o[0]).then((function(e){t=e+1})))})),a.push({addClickListener:function(e){l.addEvent("click",(function(){e({pointedPosition:n,pointedPage:t,fitAllIn:c,fitWidth:s,scale:d})}))},remove:function(){l.removeEvents(),r.remove()}})}}))}r++,r===t.size&&n(a)}))}))}))}static getPdfBookmarks(e){return new Promise((function(t,n){e||n(new Error("The PDF Document is undefined")),e.getOutline().then((function(o){let a=[],r=0;if(o&&o.length){let l=function(){r--,0===r&&t(a)},s=function(t){let o=[];if(t&&t.length){let a=function(e,t){let n="object"==typeof t[1]?t[1].name:null,o=V.getMMPerPixelRatio(),a=t[2]?o*t[2]*v:null,r=t[3]?o*t[3]*v:null;e.fitWidth="FitH"===n,e.fitAllIn="FitV"===n||"Fit"===n,e.pointedPosition=null!==a&&null!==r?new i.Vector3(a||0,r||0,0):null};t.forEach((function(t){let i={title:unescape(t.title),bold:t.bold,italic:t.italic,items:s(t.items)};Array.isArray(t.dest)?(a(i,t.dest),"number"==typeof t.dest[0]?i.pointedPage=t.dest[0]+1:t.dest[0]&&"object"==typeof t.dest[0]&&(r++,e.getPageIndex(t.dest[0]).then((function(e){i.pointedPage=e+1,l()})).catch((()=>{i.pointedPage=void 0,l()})))):"string"==typeof t.dest&&(r++,e.getDestination(t.dest).then((function(t){t&&t.length&&(a(i,t),"number"==typeof t[0]?(i.pointedPage=t[0]+1,l()):e.getPageIndex(t[0]).then((function(e){i.pointedPage=e+1,l()})).catch((()=>{i.pointedPage=void 0,l()})))}),n)),o.push(i)}))}return o};a=s(o),0===r&&t(a)}else t(a)}),n)}))}static getMaxWidth(e,t){let n=e.values().next().value;if(!n)return 0;let o=n.coordinates.right-n.coordinates.left;for(let i=t;i<e.size&&(n=e.get((i+1).toString()),n&&n.visible);i++)o=Math.max(o,n.coordinates.right-n.coordinates.left);return o}static getDocumentSize(e){let t=0,n=0;return e.forEach((e=>{t+=e.height+h,n=Math.max(n,e.width)})),t-=h,{height:t,width:n}}static renderPage(e,t,l){let s=this;if(f&&e&&e.pageObj){if(e.isRendering)return e.needsUpdate=!0,void t();e.isRendering=!0;let c=e.pageObj.getViewport({scale:e.scale*v});e.canvas||(e.canvas=m.createElement("canvas"),e.canvas.id="PDFcanvasPage"+e.number),e.canvas.height=c.height,e.canvas.width=c.width;let d=e.canvas.getContext("2d");if(d&&(d.fillStyle="white",d.fillRect(0,0,e.canvas.width,e.canvas.height)),!e.node){let t=e.width,l=e.height,s=e.coordinates.bottom;e.canvasTexture=new i.Texture(e.canvas),e.canvasTexture.needsUpdate=!0,e.canvasMaterial=new i.MeshBasicMaterial({force:!0,transparent:!0,map:e.canvasTexture});let d=o.createRectangleNode({width:t,height:l,fill:!0,noEdge:!0,material:e.canvasMaterial});d.setName("WebDocMeshPage"+e.number),d.setPickable(a.PICKTHROUGH),e.node=new r("WebDocNodePage"+e.number),e.node.addChild(d);let u=m.createElement("div",{id:"WebDocTextLayerPage"+e.number,class:"WebDocTextLayer"}).inject(e.pageLayer),h=new n(e.pageLayer,V.getMMPerPixelRatio()/e.scale,"WebDocLayerNodePage"+e.number);e.updateAnnotationScale&&e.updateAnnotationScale(e.scale),h.setPickability(!0),h.setMatrix((new i.Matrix4).makeTranslation(.5*t,.5*l,0)),h.setPickable(a.PICKTHROUGH),e.node.addChild(h);let p=(new i.Matrix4).makeRotationZ(e.rotationAngle),v=Math.abs(e.height*Math.cos(e.rotationAngle)-e.width*Math.sin(e.rotationAngle)),E=Math.abs(e.height*Math.sin(e.rotationAngle)+e.width*Math.cos(e.rotationAngle)),y=new i.Vector3(-e.width/2,-e.height/2,0).applyMatrix4(p);y.add(new i.Vector3(e.coordinates.left+E/2,s+v/2,0)),e.node.setMatrix((new i.Matrix4).setPosition(y).multiply(p));let P=m.createElement("div",{class:"WebDocPageLoadingProgressBar"}).inject(e.pageLayer),b=new g({infiniteFlag:!0,displayStyle:"lite",shape:"circular",height:80,emphasize:"info"}).inject(P);e.cssNode=h,e.destroyProgressBar=function(){var t;P.setStyle("display","none"),b.destroy(),null===(t=e.pageLayer)||void 0===t||t.removeChild(P)},e.pageObj.getTextContent().then((function(t){f.renderTextLayer({textContent:t,container:u,viewport:c,enhanceTextSelection:!0}),e.pageLayer&&e.canvas&&(e.pageLayer.style.left=e.canvas.offsetLeft+"px",e.pageLayer.style.top=e.canvas.offsetTop+"px",e.pageLayer.style.height=e.canvas.height+"px",e.pageLayer.style.width=e.canvas.width+"px")}))}if(d){e.pageObj.render({canvasContext:d,viewport:c,enableWebGL:!0}).promise.then((function(){e&&e.canvasTexture&&(e.canvasTexture.needsUpdate=!0),e.destroyProgressBar&&(e.destroyProgressBar(),e.destroyProgressBar=null),e.isRendering=!1,e.needsUpdate?(e.needsUpdate=!1,s.renderPage(e,t,l)):t()}),(function(){l&&l()}))}}}static cleanPdfPages(e){var t;let n=e.values();for(let o=0;o<e.size;o++){let e=n.next().value;e&&e.canvas&&(null===(t=e.canvas)||void 0===t||t.destroy(),e.canvasTexture&&e.canvasTexture.dispose(),e.canvasMaterial&&e.canvasMaterial.dispose(),e.progressBar&&e.progressBar.destroy(),e.node&&e.node.removeChildren())}e.clear(),S.length=0}}return V})),define("DS/WebDocumentVisualization/WebDocumentVisualizationController",["require","exports","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/WebDocumentVisualization/WebDocumentVisualizationServices","DS/WebDocumentVisualizationUI/WebDocumentScroller","DS/CoreEvents/ModelEvents"],(function(e,t,n,o,i,a,r,l,s,c){"use strict";class d{constructor(e){let t,d,u,m,g,f,h,p,v,E,y,P,b,D,w,x,C,S,I,T,M,k,R,A,V=this,L=null,W=e.context.getViewer(),q=e.context.getViewpoint(),z=e.context.getFrameWindow(),F=!0,B=!0,U=!1,O=!1,N=!0,j=!1,H={left:0,right:0,bottom:0},Z=0,_=!0,X=new c,G="#FF8A2E",K="#009ddb",J=[],$=[],Y={width:0,height:0};function Q(e){if(!e)return;if(e.includes("/")||E.has(e))return E.get(e);const t=E.keys();for(let n=0;n<E.size;n++){const n=t.next().value;if(n&&n.endsWith(e))return E.get(n)}}function ee(e,t){X.publish({event:e,data:t})}function te(){let e=S?S.pages:E;l.updateElementsToLoad(e,y,q),l.updateNodesInSession(L,e,!0),W.render()}function ne(e){e.from[0].event instanceof TouchEvent&&(U||"Hold"===e.gesture.name&&(W.setPicking({showDivTrap:!0}),V.setTouchPanActive(!1)))}function oe(e){if(e.from[0].event instanceof TouchEvent&&!U&&N&&"Touch"===e.from[0].type)if("touchstart"===e.from[0].event.type||"begin"===e.state)W.divCssElement.setStyle("display","none"),W.manipulatorManager.setActivate(!1),W.setDefaultPicking(!1),x=q.getEyePosition(),w=e.from[0].getCurrentPosition(W.canvas),C=l.getMMPerPixelRatio(W);else if("touchmove"===e.from[0].event.type){let t=w.clone().sub(e.from[0].getCurrentPosition(W.canvas));q.moveTo({eyePosition:new i.Vector3(x.x+t.x*C,x.y-t.y*C,x.z),duration:0})}else"touchend"!==e.from[0].event.type&&"end"!==e.state||(W.manipulatorManager.setActivate(!0),W.setDefaultPicking(!0),W.divCssElement.setStyle("display","block"))}let ie=!1,ae=null;function re(e){let t=q.getEyePosition(),n=0,a=0,r=0,l=e.from[0].event;if(l.ctrlKey){if(!ie){let e={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:q,cameraEye:q.camera.position,cameraUp:q.camera.up};o.publish({event:"/VISU/",data:e}),ie=!0}ae&&clearTimeout(ae),ae=setTimeout((()=>{let e={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:q,cameraEye:q.camera.position,cameraUp:q.camera.up};o.publish({event:"/VISU/",data:e}),ie=!1,ae=null}),500),l.preventDefault(),r=25*e.gesture.delta;const s=1-r/t.z;return q.setEyePosition(new i.Vector3(t.x-n,t.y+a,t.z*s)),void q.setTargetDistance(q.getTargetDistance()*s)}l.shiftKey?n=25*e.gesture.delta:a=25*e.gesture.delta,q.moveTo({eyePosition:new i.Vector3(t.x-n,t.y+a,t.z),duration:0})}function le(){var e;if(j||!S&&!E)return;let t=q.getCamera(),n=l.getMMPerPixelRatio(W),o=H.left*n,a=H.right*n,r=H.bottom*n,s=t.top,c=t.bottom+r,d=t.left+o,u=t.right-a,m=(a-o)/2,f=q.getEyePosition(),h=(S?l.getMaxWidth(S.pages,y-1):null===(e=E.values().next().value)||void 0===e?void 0:e.width)||0,p=f.x,v=f.y,P=f.z;f.x!==m&&(u-d>h?p=m:f.x+u>h/2?p=h/2-u:f.x+d<-h/2&&(p=-h/2-d));let b=S?S.pages:E,D=b.size;if(U){let e=l.getElementIdAtIndex(y-1),t=b.get(e);t&&(g||(g=t.coordinates.top-(f.y+s)),Math.abs(t.coordinates.top-(f.y+s)-g)>1e-5&&(v=t.coordinates.top-s-g))}let w=b.get(l.getElementIdAtIndex(D-1)),x=b.get(l.getElementIdAtIndex(0));w&&x&&(s-c>x.coordinates.top-w.coordinates.bottom?v=w.coordinates.bottom/2:v+s>0?v=-s:v+c<w.coordinates.bottom&&(v=w.coordinates.bottom-c));let C=l.getZoomLevel(W),I=q.getTargetDistance();C>500?(P+=I*C/500-I,q.setTargetDistance(I*C/500)):C<9.1&&(P+=I*C/9.1-I,q.setTargetDistance(I*C/9.1)),p===f.x&&v===f.y&&P===f.z||q.setEyePosition(new i.Vector3(p,v,P))}function se(){if(!E&&!S)return;let e=S?S.pages:E,t=l.computeCurrentElement(q,e,y,Boolean(S&&T));l.renderDocumentElements({elements:e,currentElement:t,viewpoint:q,scale:l.getZoomLevel(W)/100,onComplete:function(){setTimeout((()=>{if(A){const e=l.getMMPerPixelRatio(W);A.setContentSize({height:Y.height/e,width:Y.width/e})}})),W&&W.render()}}),t!==y&&(y=t,ee("onCurrentElementChange",{value:y})),l.updateNodesInSession(L,e)}let ce=null;function de(){if(!z)return;let e=z.getImmersiveFrame(),t=0,n=0,o=e.getDockingElement(WUXDockAreaEnum.RightDockArea),i=e.getDockingElement(WUXDockAreaEnum.LeftDockArea),a=o.getContainedVisibleWindows().length>0,r=i.getContainedVisibleWindows().length>0;(a||o.interactiveDockAreaVisibleFlag)&&(t=o._collapserSize,o.collapseDockingZoneFlag||(t+=o.dockingZoneSize)),(r||i.interactiveDockAreaVisibleFlag)&&(n=i._collapserSize,i.collapseDockingZoneFlag||(n+=i.dockingZoneSize)),H.right=t,H.left=n,H.bottom=0,le(),A&&A.setOffset({right:t,bottom:0,left:n}),ce&&clearTimeout(ce),ce=setTimeout((()=>{se(),ce=null}),100)}function ue(){if(!S)return;let e,t=q.getCamera(),n=l.getMMPerPixelRatio(W),o=H?H.left*n:0,a=H?H.right*n:0,r=H?H.bottom*n:0,s=(t.top,t.bottom,t.left+o),c=t.right-a-s,d=0,u=[],m=function(e){return d+=e,d===e||(d+=4,!!(T&&u.length<2&&d<c)||(d-=e+4,!1))},g=0,f=0,h=0,p=S.pages,v=p.get("1");if(v){let t=(new i.Matrix4).makeRotationZ(v.rotationAngle),n=p.values();for(let o=0;o<p.size;o++){let a=n.next().value;if(!a)continue;let r=a.coordinates.right-a.coordinates.left;if(m(r))h=Math.max(h,a.coordinates.top-a.coordinates.bottom),u.push(o);else{g-=h,f=-d/2;for(let n=0;n<u.length;n++){let o=p.get((u[n]+1).toString());if(o){let n=o.coordinates.top-o.coordinates.bottom,a=o.coordinates.right-o.coordinates.left;o.coordinates.bottom=g+(h-n)/2,o.coordinates.top=o.coordinates.bottom+n,o.coordinates.left=f,o.coordinates.right=o.coordinates.left+a,o.node&&(e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t),e.add(new i.Vector3(f+a/2,g+h/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))),f+=a+4}}g-=4,u.length=0,u.push(o),d=r,h=a.coordinates.top-a.coordinates.bottom}}if(u.length){g-=h,f=-d/2;for(let n=0;n<u.length;n++){let o=p.get((u[n]+1).toString());o&&(o.coordinates.top=g+o.coordinates.top-o.coordinates.bottom,o.coordinates.right=f+o.coordinates.right-o.coordinates.left,o.coordinates.bottom=g,o.coordinates.left=f,o.node&&(e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t),e.add(new i.Vector3(f+(o.coordinates.right-o.coordinates.left)/2,g+h/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))),f+=o.coordinates.right-o.coordinates.left+4)}}}}function me(e){if(!E&&!S)return;let t=e.eventType||e.event;if("@onViewpointBeginMove"===t)O=!0,ee("onScrollChange",{type:"start"});else if("@onViewpointChange"===t&&O)m.z!==e.viewpoint.position.z?U?(T&&ue(),ee("onZoomChange",{type:"change",value:l.getZoomLevel(W)})):(V.enableTextSelection(!1),ee("onZoomChange",{type:"start",value:l.getZoomLevel(W)}),U=!0):se(),le(),ee("onScrollChange",{type:"change"});else if("@onViewpointEndMove"===t){if(O=!1,U&&(T&&ue(),m=q.getEyePosition(),ee("onZoomChange",{type:"end",value:l.getZoomLevel(W)}),U=!1,g=null,V.enableTextSelection(!0)),j=!1,le(),se(),A){const t=l.getMMPerPixelRatio(W),n=-W.SCREEN_HEIGHT/2*t,o=(W.SCREEN_WIDTH/2-H.left)*t-Y.width/2,i=n-e.viewpoint.position.y,a=e.viewpoint.position.x-o;A.updateScroll({top:i/t,left:a/t})}ee("onScrollChange",{type:"end"}),ee("onCurrentElementChange",{value:y,endMove:!0}),"requestIdleCallback"in window?(b&&(window.cancelIdleCallback(b),b=null),b=window.requestIdleCallback(te)):(P&&(clearTimeout(P),P=null),setTimeout(te,3e3))}else"onSwapVisibleSpace"===t&&V.enableTextSelection(Boolean(W.getVisibleSpace()))}function ge(e){let t,n=e.target;!S&&!E||n&&("P"===n.tagName||"textarea"===n.type||"input"===n.type||n.isContentEditable)||("End"===e.key||35===e.keyCode?V.setCurrentElement({elementID:S?S.document.numPages:l.getElementIdAtIndex(E.size-1)}):"Home"===e.key||36===e.keyCode?V.setCurrentElement({elementID:S?1:l.getElementIdAtIndex(0)}):T||("ArrowUp"===e.key||38===e.keyCode?(t=q.getEyePosition(),q.moveTo({eyePosition:new i.Vector3(t.x,t.y+20,t.z),duration:100})):"ArrowDown"===e.key||40===e.keyCode?(t=q.getEyePosition(),q.moveTo({eyePosition:new i.Vector3(t.x,t.y-20,t.z),duration:100})):e.ctrlKey||"ArrowRight"!==e.key&&39!==e.keyCode?e.ctrlKey||"ArrowLeft"!==e.key&&37!==e.keyCode?"PageUp"===e.key||33===e.keyCode?(t=q.getEyePosition(),q.moveTo({eyePosition:new i.Vector3(t.x,t.y+150,t.z),duration:200})):"PageDown"!==e.key&&34!==e.keyCode||(t=q.getEyePosition(),q.moveTo({eyePosition:new i.Vector3(t.x,t.y-150,t.z),duration:200})):V.centerViewpointAtNextOrPreviousElement(!1):V.centerViewpointAtNextOrPreviousElement(!0)))}function fe(e){var t;F&&B||(e.preventDefault(),null===(t=window.getSelection())||void 0===t||t.removeAllRanges())}function he(e){W.getDefaultPicking()&&("@onPrimaryPointerDownUniqueEvent"===e.eventType&&e.from[0].view.id&&e.from[0].view.id.includes("WebDocPageLayer")||e.from[0].view===W.canvas?W.setPicking({showDivTrap:!0}):"@onPrimaryPointerUpUniqueEvent"===e.eventType&&(W.setPicking({showDivTrap:!1}),V.setTouchPanActive(!0)))}function pe(){W.set2DMode(!0,"CATIA"),t=W.antiAliasing,W.setAntiAliasing("NoAA"),d={showDivTrap:W.picking.showDivTrap},W.setPicking({showDivTrap:!1}),q.setEyePosition(new i.Vector3(0,0,100)),q.setTargetDistance(100),m=q.getEyePosition(),A||(A=new s({uiFrame:z.getUIFrame()}),A.onScroll((({scrollTop:e,scrollLeft:t})=>{const n=q.getEyePosition(),o=l.getMMPerPixelRatio(W),a=-W.SCREEN_HEIGHT/2*o,r=(W.SCREEN_WIDTH/2-H.left)*o-Y.width/2,s=e*o,c=t*o;q.moveTo({eyePosition:new i.Vector3(r+c,a-s,n.z),duration:0})})))}function ve(e){if(!e.target.hasClassName||!e.target.hasClassName("WebDocRequirementsStatusDiv"))return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1}function Ee(e){return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1}function ye(e){let t=document.createElement("textarea");return t.innerHTML=e,t.value}function Pe(e){if(e&&e.pointedPage&&F&&_&&S){if(e.scale){let t=l.getZoomLevel(W)/100,n=q.getTargetDistance(),o=q.getEyePosition(),a=n*t/e.scale-n;q.setTargetDistance(n*t/e.scale),q.setEyePosition(new i.Vector3(o.x,o.y,o.z+a))}if(e.pointedPosition){let t=S.pages.get(e.pointedPage.toString());if(t){let n=t.coordinates;V.centerViewpointAtElementPosition({elementID:e.pointedPage,position:new i.Vector3(e.pointedPosition.x,e.pointedPosition.y-(n.top-n.bottom),0),duration:0,centerAtTopLeft:!0})}}else V.setCurrentElement({elementID:e.pointedPage});(e.fitAllIn||e.fitWidth)&&setTimeout((function(){V.fitCurrentElement(e.fitWidth)}))}}function be(){var e,t;!function(){let e=q.getEyePosition();q.setEyePosition(new i.Vector3(e.x,0,e.z)),q.onCenterCamera((()=>{})),f=o.subscribe({event:"/VISU/"},me),document.addEventListener("selectionchange",fe),document.addEventListener("selectstart",fe),document.addEventListener("keyup",ge),W.divCssElement.addEventListener("dragstart",ve),W.divCssElement.addEventListener("contextmenu",Ee),n.addEvent(W.divCssElement,"onMouseWheel",re),n.addEvent(W.canvas,"onMouseWheel",re),n.addEvent(W.divCssElement,"onPrimaryPointerDownUnique",he),n.addEvent(W.canvas,"onPrimaryPointerDownUnique",he),n.addEvent(W.divCssElement,"onPrimaryPointerUpUnique",he),n.addEvent(W.canvas,"onPrimaryPointerUpUnique",he),n.addEvent(W.divCssElement,"onSwipe",oe),n.addEvent(W.canvas,"onSwipe",oe),n.addEvent(W.divCssElement,"onHold",ne),n.addEvent(W.canvas,"onHold",ne),z.getImmersiveFrame().addEventListener("freeZoneResize",de),v=W.onSwapVisibleSpace((function(){me({eventType:"onSwapVisibleSpace"})})),V.setTextSelectionFlag(!0),de(),le(),"requestIdleCallback"in window?(b&&(window.cancelIdleCallback(b),b=null),b=window.requestIdleCallback(te)):(P&&(clearTimeout(P),P=null),setTimeout(te,3e3))}();let a=q.getCamera(),r=l.getMMPerPixelRatio(W),s=H.left*r,c=H.right*r,d=H.bottom*r,u=(a.top,a.bottom,a.left+s),m=a.right-c,g=q.getEyePosition(),h=(S?null===(e=S.pages.get("1"))||void 0===e?void 0:e.width:null===(t=E.get(l.getElementIdAtIndex(0)))||void 0===t?void 0:t.width)||0;h*=2,q.moveTo({eyePosition:new i.Vector3((c-s)/2,0,g.z*h/(m-u)),distanceToTarget:q.getTargetDistance()*h/(m-u),duration:0}),se(),Z--}this.loadDocumentStream=function(t){if("Requirement"===t.type){if(!t.elementsToLoad||!t.elementsToLoad.length)return t.onFailure(new Error("No elements to load"));if(R=t.elementsToLoad,h="Requirement",u=t.phyId,Z++,pe(),!k){const t=()=>{var e;let t=a.get(),n=J.slice();J.length=0,n.forEach((e=>{let t=Q(e);if(t){let n;t.hovered=!1,M&&M.firstReqData&&M.firstReqData.length&&M.firstReqData.indexOf(e)>=0?n=G:M&&M.secondReqData&&M.secondReqData.length&&M.secondReqData.indexOf(e)>=0&&(n=K),t.updateSelectionStatus(n)}}));for(let n=0;n<t.length;n++){let o=null===(e=t[n].pathElement)||void 0===e?void 0:e.getLastElement(!0);if(o&&o.getReqInfo){let{pathId:e}=o.getReqInfo(),t=Q(e);if(t){let n;t.hovered=!0,J.push(e),M&&M.firstReqData&&M.firstReqData.length&&M.firstReqData.indexOf(e)>=0?n=G:M&&M.secondReqData&&M.secondReqData.length&&M.secondReqData.indexOf(e)>=0&&(n=K),t.updateSelectionStatus(n)}}}W.render()};let n=!1;const o=()=>{n=!1;let t=r.get(),o=$.slice();$.length=0,o.forEach((e=>{let t=Q(e);t&&(t.selected=!1,t.updateSelectionStatus())}));let i=!1;for(let e=0;e<t.length;e++){let o,a=t[e].pathElement.getLastElement(!0);if(a.getReqInfo){let{pathId:e}=a.getReqInfo();o=Q(e)}else if(1===E.size){let e=E.values().next().value;e&&e.node&&a===e.node.getParents()[0]&&(o=e,n=!0)}o&&($.push(o.pathId),o.selected=!0,o.updateSelectionStatus(),o.loaded||(o.toLoad=!0,i=!0))}!n&&$.length&&(e.context.lockSelectionBroadcast(!0),ee("onElementSelection",$[$.length-1])),i&&l.updateNodesInSession(L,E),W.render()};k={onPSOEmpty:a.onEmpty(t),onPSORemove:a.onRemove(t),onPSOAdd:a.onAdd(t),onCSOEmpty:r.onEmpty(o),onCSORemove:r.onRemove(o),onCSOAdd:r.onAdd(o)}}l.getRequirementElements(t.elementsToLoad).then((function(e){t.elementsToLoad&&(E=e,D=l.getRequirementBookmarks(t.elementsToLoad),Y=l.getDocumentSize(E),y=1,L=t.fatherNode,l.renderDocumentElements({elements:E,currentElement:y,viewpoint:q,scale:l.getZoomLevel(W)/100,onFailure:t.onFailure,onComplete:function(){be(),t.onComplete()}}),l.updateNodesInSession(L,E),W.render())}))}else"Document"===t.type&&t.dataBuffer?(h="Document",u=t.phyId,Z++,pe(),l.getPdfDocument({dataBuffer:t.dataBuffer,password:t.password,onComplete:async function(e){if(t.password&&t.onPasswordOk&&t.onPasswordOk(),e)try{l.getMMPerPixelRatio();let n=1,o=await l.getPdfPages(e,n);L=t.fatherNode,y=1,Y=l.getDocumentSize(o);let[i,a,r]=await Promise.all([l.getPdfCommentsFromPages(o),l.getPdfLinksFromPages(e,o),l.getPdfBookmarks(e)]);!S&&t.dataBuffer&&(S={buffer:t.dataBuffer,document:e,pages:o,externalComments:i,links:a,bookmarks:r}),S&&S.links&&S.links.length&&S.links.forEach((function(e){e.addClickListener&&e.addClickListener(Pe)})),be(),await t.onComplete(),l.updateNodesInSession(L,o),W.render()}catch(e){window.console.error(e),Z--,u=null,t.onFailure(e)}else Z--,u=null,t.onFailure()},onIncorrectPassword:function(){Z--,u=null,t.onIncorrectPassword?t.onIncorrectPassword():t.onFailure()},onFailure:function(e){Z--,u=null,t.onFailure(e)}})):t.onFailure(new Error("Data type not supported"))},this.isLoading=function(){return Z>0},this.getSelectedElementIDs=function(){return $&&$.length?$:[]},this.removeDocument=function(){A&&A.destroy(),ae&&clearTimeout(ae),b&&(window.cancelIdleCallback(b),b=null),P&&(clearTimeout(P),P=null),document.removeEventListener("selectstart",fe),document.removeEventListener("selectionchange",fe),document.removeEventListener("keyup",ge),W.divCssElement.removeEventListener("dragstart",ve),W.divCssElement.removeEventListener("contextmenu",Ee),n.removeEvent(W.divCssElement,"onMouseWheel",re),n.removeEvent(W.canvas,"onMouseWheel",re),n.removeEvent(W.divCssElement,"onPrimaryPointerDownUnique",he),n.removeEvent(W.canvas,"onPrimaryPointerDownUnique",he),n.removeEvent(W.divCssElement,"onPrimaryPointerUpUnique",he),n.removeEvent(W.canvas,"onPrimaryPointerUpUnique",he),v&&(W.unsubscribe(v),v=null),n.removeEvent(W.divCssElement,"onSwipe",oe),n.removeEvent(W.canvas,"onSwipe",oe),n.removeEvent(W.divCssElement,"onHold",ne),n.removeEvent(W.canvas,"onHold",ne),z.getImmersiveFrame().removeEventListener("freeZoneResize",de),d&&W.setPicking(d),t&&W.antiAliasing!==t&&"MSAA"===W.antiAliasing&&W.setAntiAliasing(t),W.get2DMode()&&W.set2DMode(!1),q.onCenterCamera(null),W.render(),f&&o.unsubscribe(f),k&&(a.unsubscribe(k.onPSOEmpty),a.unsubscribe(k.onPSORemove),a.unsubscribe(k.onPSOAdd),r.unsubscribe(k.onCSOEmpty),r.unsubscribe(k.onCSORemove),r.unsubscribe(k.onCSOAdd),k=void 0),E&&l.cleanRequirementElements(E),S&&(S.links&&S.links.length&&S.links.forEach((function(e){e.remove&&e.remove()})),l.cleanPdfPages(S.pages)),L&&L.removeChildren(),Z=0,Y.height=0,Y.width=0,U=!1,O=!1,N=!1,ie=!1,F=!0,B=!0,L=t=D=w=m=d=null,A=ae=g=f=x=S=u=null},this.clean=function(){V.removeDocument(),W=q=z=null},this.isADocumentDisplayed=function(){return Boolean("Requirement"===h&&E&&E.size||"Document"===h&&S&&S.pages.size)},this.getDocumentRotationAngle=function(){if(S&&S.pages){let e=S.pages.get("1");return e?e.rotationAngle:0}},this.getDocumentType=function(){return h},this.getDocumentBuffer=function(){if(S)return S.buffer},this.getDocumentLoadedID=function(){return u||void 0},this.getExternalComments=function(){if(S)return S.externalComments},this.getPDFHyperlinks=function(){if(S&&S.links)return S.links.filter((function(e){return e.div&&e.content}))},this.setTouchPanActive=function(e){N=e},this.getTouchPanActive=function(){return N},this.forceElementsLoad=function(e){if(!e||!E)return;let t=!1;e.forEach((e=>{let n=Q(e);n&&(t=!0,n.node||l.renderElement(n,(()=>{})),n.pathElement&&n.loaded||(n.toLoad=!0))})),t&&l.updateNodesInSession(L,E)},this.getElementsVisualizationData=function(){let e=S?S.pages:E,t=e.get(l.getElementIdAtIndex(0)),n={visibleElements:[],current:y,elementLength:e.size,type:t?t.type:"page"};for(let t=y-1;t<e.size;t++){let o=e.get(l.getElementIdAtIndex(t));o&&o.visible&&n.visibleElements.push({number:o.number,title:ye(o.title)})}return n},this.setMultiPageVisibility=function(e){e!==T&&(T=e,de(),ue(),V.setCurrentElement({elementID:y}))},this.getMultiPageVisibility=function(){return T},this.getElementInfo=function(e){if(!e||!E)return;const t=Q(e);return t?{id:e,title:ye(t.title),index:l.getElementIndexById(t.pathId)+1,pathElement:t.pathElement}:void 0},this.getElementMatrix=function(e){if(!E&&!S||!e)return null;if("string"==typeof e&&E){let t=Q(e);if(t){let e=new i.Vector3(t.coordinates.left,t.marginTop?t.coordinates.top-t.marginTop:t.coordinates.top,0);return(new i.Matrix4).setPosition(e)}}else if("number"==typeof e&&S&&S.pages&&e>=1&&e<=S.document.numPages){let t=S.pages.get(e.toString());if(t){let e=Math.abs(t.height*Math.cos(t.rotationAngle)-t.width*Math.sin(t.rotationAngle)),n=Math.abs(t.height*Math.sin(t.rotationAngle)+t.width*Math.cos(t.rotationAngle)),o=(new i.Matrix4).makeRotationZ(t.rotationAngle),a=new i.Vector3(-t.width/2,t.height/2,0).applyMatrix4(o);return a.add(new i.Vector3(t.coordinates.left+n/2,t.coordinates.top-e/2,0)),(new i.Matrix4).setPosition(a).multiply(o)}}return null},this.getPageRotation=function(e){if(!S||!S.pages||!e||e<1||e>S.document.numPages)return;let t=S.pages.get(e.toString());return t?t.rotationAngle:void 0},this.getPointedElemIDAtPosition=function(e){if(!E&&!S||!e)return;let t=S?S.pages:E,n=1,o=t.size;for(;n<=o;){let i=Math.floor((n+o)/2),a=l.getElementIdAtIndex(i-1),r=t.get(a);if(!r)break;{let t=r.coordinates;if(t.top>e.y&&t.bottom<e.y)return t.left<e.x&&t.right>e.x?S?i:a:void 0;t.top<e.y?o=i-1:n=i+1}}},this.enableTextSelection=function(e){B!==e&&(W.divCssElement.setStyle("display",e?"block":"none"),B=e)},this.setTextSelectionFlag=function(e){if(F!==e){if(F=e,e){let e=".WebDocTextLayer > span:not(.WebDocPageLoadingProgressBar):hover{ cursor: text}",t=document.createElement("style");t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),p=t}else p&&document.getElementsByTagName("head")[0].removeChild(p);V.setLinkActivationFlag(e)}},this.setLinkActivationFlag=function(e){if(_!==e)if(_=e,e)I&&document.getElementsByTagName("head")[0].removeChild(I);else{let e=".WebDocLinkAnnotation { display: none }",t=document.createElement("style");t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),I=t}},this.centerViewpointAtElementPosition=function(e){if(!S&&!E||!e.position)return;let t=e.offsetYPix||0,n=q,o=n.getEyePosition(),a=V.getElementMatrix(e.elementID);if(a){let r=(new i.Vector3).getPositionFromMatrix(a),s=new i.Vector3(e.position.x,e.position.y,0).applyMatrix4(a.setPosition(new i.Vector3)),c=n.getCamera(),d=l.getMMPerPixelRatio(W),u={left:H.left*d,right:H.right*d,bottom:(H.bottom-t)*d},m=s.x+r.x+(u.right-u.left)/(e.centerAtTopLeft?1:2),g=s.y+r.y+u.bottom;e.centerAtTopLeft&&(m+=c.right,g+=c.bottom),n.moveTo({eyePosition:new i.Vector3(m,g,o.z),duration:void 0===e.duration?200:e.duration})}},this.centerViewpointAtNextOrPreviousElement=function(e){if(!S&&!E)return;let t=1,n=S?S.pages:E;if(T&&S&&y<n.size){let e=n.get(l.getElementIdAtIndex(y-1)),o=n.get(l.getElementIdAtIndex(y));if(e&&o){let n=e.coordinates,i=o.coordinates;Math.abs(n.top-i.top)<1e-5&&t++}}let o=y+(e?t:-t);o=o<1?1:o<=n.size?o:n.size;let i=l.getElementIdAtIndex(o-1);V.setCurrentElement({elementID:S?o:i,duration:100})},this.getCurrentElementId=function(){return S?y:l.getElementIdAtIndex(y-1)},this.getElementCoordinates=function(e){if("number"==typeof e){let t=S&&S.pages.get(e.toString());return t?t.coordinates:void 0}if("string"==typeof e){let t=Q(e);return t?t.coordinates:void 0}},this.setCurrentElement=function(e){let t,n=q.getEyePosition();if("number"==typeof e.elementID&&e.elementID>=1&&S){let o=S&&S.pages.get(e.elementID.toString());o&&(t=new i.Vector3(n.x,o.coordinates.top-q.getCamera().top,n.z))}else if("string"==typeof e.elementID){let o=Q(e.elementID);if(!o)return;t=new i.Vector3(n.x,o.coordinates.top-q.getCamera().top,n.z),o.setAsCurrent()}q.moveTo({eyePosition:t,duration:e.duration||0})},this.renderDocument=function(){se()},this.reframeOnElements=function(e){if(!S&&!E)return;let t=q.getCamera(),n=q.getEyePosition(),o=l.getMMPerPixelRatio(W),a=H.left*o,r=H.right*o,s=H.bottom*o,c=t.top,d=t.bottom+s,u=t.left+a,m=t.right-r,g=-1/0,f=1/0,h=1/0,p=-1/0,v=!1;if(e.forEach((e=>{var t,n;let o=S?null===(t=S.pages.get(e))||void 0===t?void 0:t.coordinates:null===(n=Q(e))||void 0===n?void 0:n.coordinates;o&&(v=!0,g=Math.max(g,o.top),f=Math.min(f,o.bottom),h=Math.min(h,o.left),p=Math.max(p,o.right))})),v){let e,t,o,l=(r-a)/2;Math.abs((m-u)/(p-h))<Math.abs((c-d)/(g-f))?(t=g-(c-d)/2*((p-h)/(m-u)),e=n.z*(p-h)/(m-u),o=q.getTargetDistance()*(p-h)/(m-u)):(t=(g+f)/2,e=n.z*(g-f)/(c-d),o=q.getTargetDistance()*(g-f)/(c-d)),j=!0,q.moveTo({eyePosition:new i.Vector3(l,t,e),distanceToTarget:o,duration:400})}},this.fitCurrentElement=function(e=!1){var t;if(S||E)if(e){let e=q.getCamera(),n=l.getMMPerPixelRatio(W),o={left:H.left*n,right:H.right*n,bottom:H.bottom*n},a={top:e.top,bottom:e.bottom+o.bottom,left:e.left+o.left,right:e.right-o.right},r=q.getEyePosition(),s=(S?l.getMaxWidth(S.pages,y-1):null===(t=E.get(l.getElementIdAtIndex(0)))||void 0===t?void 0:t.width)||0;q.moveTo({eyePosition:new i.Vector3((o.right-o.left)/2,r.y,r.z*s/(a.right-a.left)),distanceToTarget:q.getTargetDistance()*s/(a.right-a.left),duration:400})}else{let e=l.getElementIdAtIndex(y-1);V.reframeOnElements([e])}},this.setDocumentRotationAngle=function(e){if(!S||!S.pages)return;let t=(new i.Matrix4).makeRotationZ(e),n=0;S.pages.forEach((function(o){o.rotationAngle=e;let a=Math.abs(o.height*Math.cos(e)-o.width*Math.sin(e)),r=Math.abs(o.height*Math.sin(e)+o.width*Math.cos(e));if(o.coordinates.top=n,o.coordinates.bottom=n-a,o.coordinates.right=r/2,o.coordinates.left=-r/2,n-=a+4,o.node){let e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t);e.add(new i.Vector3(0,o.coordinates.bottom+a/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))}})),W.render(),V.setCurrentElement({elementID:y}),ee("onDocumentRotationAngleChange",{rotationAngle:e})},this.getDocumentBookmarks=function(){return(S?S.bookmarks:D)||[]},this.getDocumentLength=function(){return S?S.document.numPages:E?E.size:0},this.getLoadedReqElement=function(){return R},this.setRequirementCompareData=function(e){M={firstReqData:e.firstReqData,secondReqData:e.secondReqData},e&&e.firstReqData&&e.secondReqData&&l.setCompareReqIDList(e.firstReqData,e.secondReqData),W&&W.render()},this.setCompareColor=function(e,t){G=e,K=t,l.setCompareColor(G,K)},this.subscribe=function(e,t){return e&&t?X.subscribe({event:e},t):""},this.unsubscribe=function(e){null!=e&&X.unsubscribe(e)}}}let u=[];return class{static getWebDocumentVisualizationController(e={context:null}){let t;for(let n=0;n<u.length;n++)if(u[n].context===e.context)return t=u[n].controller,u[n].count++,t;let n=new d(e);return t=Object.freeze({isLoading:()=>!!n&&n.isLoading(),loadDocumentStream:e=>{if(n)return n.loadDocumentStream(e)},enableTextSelection:e=>{if(n)return n.enableTextSelection(e)},forceElementsLoad:e=>{n&&n.forceElementsLoad(e)},getDocumentType:()=>n?n.getDocumentType():null,getElementInfo:e=>{if(n)return n.getElementInfo(e)},getElementMatrix:e=>{if(n)return n.getElementMatrix(e)},getPageRotation:e=>{if(n)return n.getPageRotation(e)},getPointedElemIDAtPosition:e=>{if(n)return n.getPointedElemIDAtPosition(e)},getDocumentLoadedID:()=>{if(n)return n.getDocumentLoadedID()},getElementsVisualizationData:()=>{if(n)return n.getElementsVisualizationData()},getDocumentBookmarks:()=>{if(n)return n.getDocumentBookmarks()},getDocumentRotationAngle:()=>{if(n)return n.getDocumentRotationAngle()},getExternalComments:()=>{if(n)return n.getExternalComments()},getPDFHyperlinks:()=>{if(n)return n.getPDFHyperlinks()},getTouchPanActive:()=>{if(n)return n.getTouchPanActive()},setTouchPanActive:e=>{if(n)return n.setTouchPanActive(e)},setDocumentRotationAngle:e=>{if(n)return n.setDocumentRotationAngle(e)},getMultiPageVisibility:()=>{if(n)return n.getMultiPageVisibility()},setMultiPageVisibility:e=>{if(n)return n.setMultiPageVisibility(e)},getCurrentElementId:()=>{if(n)return n.getCurrentElementId()},getElementCoordinates:e=>{if(n)return n.getElementCoordinates(e)},setCurrentElement:e=>{if(n)return n.setCurrentElement(e)},setTextSelectionFlag:e=>{if(n)return n.setTextSelectionFlag(e)},setLinkActivationFlag:e=>{if(n)return n.setLinkActivationFlag(e)},isADocumentDisplayed:()=>!!n&&n.isADocumentDisplayed(),getDocumentBuffer:()=>{if(n)return n.getDocumentBuffer()},getDocumentLength:()=>{if(n)return n.getDocumentLength()},getLoadedReqElement:()=>{if(n)return n.getLoadedReqElement()},setRequirementCompareData:e=>{if(n)return n.setRequirementCompareData(e)},setCompareColor:(e,t)=>{if(n)return n.setCompareColor(e,t)},centerViewpointAtElementPosition:e=>{if(n)return n.centerViewpointAtElementPosition(e)},centerViewpointAtNextOrPreviousElement:e=>{if(n)return n.centerViewpointAtNextOrPreviousElement(e)},fitCurrentElement:e=>{if(n)return n.fitCurrentElement(e)},reframeOnElements:e=>{if(n)return n.reframeOnElements(e)},renderDocument:()=>{if(n)return n.renderDocument()},subscribe:(e,t)=>n?n.subscribe(e,t):"",unsubscribe:e=>{if(n)return n.unsubscribe(e)},removeDocument:()=>{if(n)return n.removeDocument()},getSelectedElementIDs:()=>n?n.getSelectedElementIDs():[],clean:()=>{n&&(n.clean(),n=null)}}),t&&u.push({context:e.context,controller:t,count:1}),t}static giveWebDocumentVisualizationController(e){if(e&&e.context)for(let t=0;t<u.length;t++)if(u[t].context===e.context)return u[t].controller}static unreferenceWebDocumentVisualizationController(e){if(e&&e.context)for(let t=0;t<u.length;t++)if(u[t].context===e.context){u[t].count--,0===u[t].count&&(u[t].controller.clean(),u.splice(t,1));break}}}})),define("DS/WebDocumentVisualization/WebDocumentBookmarksController",["require","exports","DS/CATWebUXComponents/CATWebUXPanel","DS/Visualization/ThreeJS_DS","DS/WebDocumentVisualizationUI/WebDocumentBookmarksPanel","DS/WebDocumentVisualization/WebDocumentVisualizationController"],(function(e,t,n,o,i,a){"use strict";class r{constructor(e){let t,r,l,s,c,d=e.context;function u(){let e=a.giveWebDocumentVisualizationController({context:d});if(e&&t&&!l){let n=e.getCurrentElementId();if("number"==typeof n){let o=e.getElementCoordinates(n);o&&t.highlightBookmark({pageNumber:n,yCoordinate:d.getViewpoint().getEyePosition().y+d.getViewpoint().getCamera().top-o.bottom})}else"string"==typeof n&&t.highlightBookmark({elementId:n})}}this.displayBookmarksPanel=function(){let e=a.giveWebDocumentVisualizationController({context:d});if(e){if(c=e.subscribe("onScrollChange",(function(e){"start"!==e.type&&(u(),"end"===e.type&&(l=!1))})),t||(t=new i,r||(r={onBookmarkSelected:t.subscribe("onBookmarkSelected",(function(t){if(t&&t.target&&e){if(l=!0,t.target.pointedPosition){let n=e.getElementCoordinates(t.target.pointedPage);n&&e.centerViewpointAtElementPosition({elementID:t.target.pointedPage,position:new o.Vector3(t.target.pointedPosition.x,t.target.pointedPosition.y-(n.top-n.bottom),0),duration:0,centerAtTopLeft:!0})}else e.setCurrentElement({elementID:t.target.pointedPage||t.target.pointedId});(t.target.fitAllIn||t.target.fitWidth)&&setTimeout((function(){l=!0,e&&e.fitCurrentElement(t.target.fitWidth)})),s.isSmallWidth()&&s.collapsePanel()}})),onBookmarkExpanded:t.subscribe("onBookmarkExpanded",u)})),!s){let o=e.getDocumentBookmarks();if(o){let e=t.buildPanel(o);const i=300,a=160,r=250;s=new n({id:"WebDocBookmarksPanel",className:"WebDocBookmarksPanel",showTitleFlag:!1,autoCloseFlag:!1,closeButtonFlag:!1,icon:"fonticon wux-ui-3ds-bookmark",immersiveFrame:d.getFrameWindow().getImmersiveFrame(),viewerFrame:d.getFrameWindow().getViewerFrame(),content:e,minWidth:r,width:i,minHeight:a,height:a,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea}),s.ensureVisible()}}u()}},this.setPanelVisibilityFlag=function(e){s&&e!==s.getPanelVisibilityFlag()&&s.setPanelVisibilityFlag(e)},this.destroyBookmarksPanel=function(){if(c){let e=a.giveWebDocumentVisualizationController({context:d});e&&e.unsubscribe(c)}if(t&&r){Object.keys(r).forEach((function(e){t&&r&&t.unsubscribe(r[e])})),t.cleanPanel()}s&&(s.setPanelVisibilityFlag(!1),s.clean()),t=s=r=c=null},this.clean=function(){this.destroyBookmarksPanel(),d=null}}}let l=[];return class{static getWebDocumentBookmarksController(e){let t;for(let n=0;n<l.length;n++)if(l[n].context===e.context)return t=l[n].controller,l[n].count++,t;let n=new r(e);return t=Object.freeze({displayBookmarksPanel:()=>{n&&n.displayBookmarksPanel()},setPanelVisibilityFlag:e=>{n&&n.setPanelVisibilityFlag(e)},destroyBookmarksPanel:()=>{n&&n.destroyBookmarksPanel()},clean:()=>{n&&(n.clean(),n=null)}}),l.push({context:e.context,controller:t,count:1}),t}static giveWebDocumentBookmarksController(e){let t;if(e&&e.context)for(let n=0;n<l.length;n++)if(l[n].context===e.context)return t=l[n].controller,t}static unreferenceWebDocumentBookmarksController(e){if(e&&e.context)for(let t=0;t<l.length;t++)l[t].context===e.context&&(l[t].count--,0===l[t].count&&(l[t].controller.clean(),l.splice(t,1)))}}}));