define("DS/3DPlay360Experiences/MediaLoader",["UWA/Class"],(function(t){"use strict";return t.extend({init:function(t){this._parent(t)},dispose:function(){},img:function(t){var i=null;return t&&t.format&&t.path&&(i=new Promise(function(i,e){var n=document.createElement("img");n.crossOrigin="use-credentials",n.onload=function(){var e={format:t.format,fullPanoWidthPixels:n.width,fullPanoHeightPixels:n.height},o={width:n.width,height:n.height};i({img:n,imgData:e,size:o,projection:t.projectionType})}.bind(this),n.onerror=function(t){e({error:t})}.bind(this),t.dataBuffer?n.src=URL.createObjectURL(new Blob([t.dataBuffer],{type:"image/jpeg"})):n.src=t.path}.bind(this))),i},video:function(t){var i=null;return t&&t.format&&t.path&&(i=new Promise(function(i,e){var n=document.createElement("video");n.crossOrigin="use-credentials",n.src=t.path,i({video:n})}.bind(this))),i}})})),define("DS/3DPlay360Experiences/DirectionIndicatorSwitch",["UWA/Class","css!DS/3DPlay360Experiences/Img360CurvedLayout.css","DS/3DPlayAnnotationUtils/CurvedLayout","DS/Core/PointerEvents","text!DS/3DPlay360Experiences/assets/templates/directionIndicator.hbs"],(function(t,i,e,n,o){"use strict";var a,r=null,s=[];return t.extend({init:function(t){a=this,s=t.directionIndicatorArray,r=t.directionIndicatorArray.length,this.UIFrame=t.frmWindow.getUIFrame(),this.mainDiv=null,this._createMainDiv(),t.iData&&this._setSwitchCB(t.iData),r>1&&this._createCurvedUI(t.frmWindow),this._injectDiUi()},_injectDiUi:function(){this.mainDiv.innerHTML=o},_createMainDiv:function(){this.mainDiv=new UWA.Element("div",{class:"direction-indicator-main-div"}).inject(a.UIFrame),this.mainDiv.addEvent("click",(function(){a._showCurvedUI()}))},_setProjectionType:function(t){s.forEach((function(i){i.id&&i.id.toString()===t&&a._projTypeChangeCB&&(a._projTypeChangeCB(i.id),a._hideCurvedUI())}))},_showCurvedUI:function(){a.curvedUIOuterDiv&&(a.curvedUIOuterDiv.style.transition="right 0.6s ease",a.curvedUIOuterDiv.style.right="0px")},_hideCurvedUI:function(){a.curvedUIOuterDiv.style.transition="right 0.6s ease",a.curvedUIOuterDiv.style.right=-a.curvedUIOuterDiv.clientWidth+"px",a.curvedUIOuterDiv.style.left=""},_createCurvedUI:function(t){var i=function(){a._setProjectionType(this.id),a._hideCurvedUI()};a.curvedUIOuterDiv=new UWA.Element("div",{class:"i360-curved-ui-outer-div"}).inject(a.UIFrame);var o=new UWA.Element("div",{id:"curvedUI",class:"i360-curved-ui"}).inject(a.curvedUIOuterDiv);return setTimeout((function(){for(var h=new e({childCount:r,containerElement:o,layoutOpts:{containerHeight:o.clientHeight,containerWidth:o.clientWidth,offsetX:10,offsetY:0}}),l=0;l<s.length;++l){var c=UWA.createElement("img",{src:s[l].icon,id:s[l].id,class:"i360-curved-ui-element"}).inject(h.contentArray[l]);c.addEvent("click",i),c.addEvent("touchstart",i),a.mainDiv?a.curvedUIOuterDiv.style.top=a.mainDiv.offsetTop-a.mainDiv.offsetHeight+"px":a.curvedUIOuterDiv.style.top="100px",a._hideCurvedUI()}this.proxyEventTarget=t.getViewerFrame(),this.proxyEventTarget.addEvent(n.POINTERDOWN,(function(t){"i360-curved-ui-element"===t.srcElement.className&&"i360-curved-ui-element"===t.target.className||a._hideCurvedUI()}))}),0),a.curvedUIOuterDiv},resetCurvedUIDiv:function(t){a.mainDiv&&a.curvedUIOuterDiv&&(a.curvedUIOuterDiv.style.top=a.mainDiv.offsetTop-a.mainDiv.offsetHeight+"px",a.curvedUIOuterDiv.style.transition="top .2s ease-in")},_setSwitchCB:function(t){this._projTypeChangeCB=t.func},_removeSwitchCB:function(){this._projTypeChangeCB=null},destroy:function(){this.curvedUIOuterDiv&&(this.curvedUIOuterDiv.remove(),this.curvedUIOuterDiv=void 0),this.mainDiv.remove(),this.mainDiv=void 0,this._removeSwitchCB(),this.projType=void 0,this.UIFrame=void 0,r=void 0,s=void 0,a=void 0}})})),define("DS/3DPlay360Experiences/MediaAbstractViewerController",["UWA/Class","DS/Visualization/WebGLV6Viewer","DS/Visualization/Node3D","DS/Visualization/Viewpoint"],(function(t,i,e,n){"use strict";return t.extend({init:function(t){this._trackball=null,this._directionIndicator=null,this._viewer=null,this._viewpoint=null,this._node=null,this.initViewer(t.viewer,t.div)},dispose:function(){this.stoptrackBall(),this.cleanViewer(),this._trackball.dispose(),this._trackball=null,this._directionIndicator=null,this._viewer=null,this._viewpoint=null,this._node=null},viewer:function(){return this._viewer},viewpoint:function(){return this._viewpoint},trackBall:function(){return this._trackball},directionIndicator:function(){return this._directionIndicator},createTrackball:function(){return null},reframe:function(){return null},_createNode:function(){return null},activate:function(t){this.activateTrackball({iViewer:this.viewer(),iViewpoint:this.viewpoint(),imgSize:t}),this.showIndicator&&this.showIndicator(),this.reframe()},initViewer:function(t,i){if(this._viewer=t||null,!this._viewer){var e=this.createViewer(i);this._viewer=e.viewer}this._viewer&&(this._viewpoint=this._viewer.currentViewpoint),this._viewer&&this._viewpoint&&this.customizeViewer(this._viewer,this._viewpoint)},cleanViewer:function(){this.cleanNodes(),this._viewer=null,this._viewpoint=null},createViewer:function(t){var o=new i({div:t,mobile:!0,useShadowMap:!1,infinitePlane:!1,displayGrid:!1,backgroundColor:16777215});o.setRenderMode("@Edge",!0);var a=new e;o.addNode(a);var r=new n(o);return r.onMove(o.render),o.addViewpoint(r),{viewer:o,viewpoint:r}},customizeViewer:function(t,i){if(t&&i){t.displayGrid=!1,t.infinitePlane=!1,t.setBackgroundColor(16777215),t.setShadow(!1),i.setProjectionType(0),t.setDefaultPicking(!1),t.setPicking({activated:!1},!1),t.setPrePicking({activated:!1},!1),t.setManipulators({activated:!1,preActivate:!1});var e=i.getControl();e&&(e.lockZ=!0,e.setRotationInertia({mouse:!0,touch:!0}),e.setZoomActive(!0),e.setPanActive(!0)),t.setReferenceAxisSystem(!0),t.setReferenceAxisSystem(!1),t.setCursor("Grab",0,!1)}},activateTrackball:function(t){t.iViewer&&t.iViewpoint&&(this._trackball||(this._trackball=this.createTrackball(t.imgSize)),this._trackball&&this._trackball.activate(t.iViewpoint))},_deactivateTrackball:function(){this._trackball&&this._trackball.deactivate()},stoptrackBall:function(){this._trackball&&this._trackball.stop()},node:function(){return this._node||(this._node=this._createNode(),this.viewer().getRootNode().addChild(this._node)),this._node},cleanNodes:function(){this._node&&(this.viewer().getRootNode().remove(this._node),this._node=null)}})})),define("DS/3DPlay360Experiences/shaderFactory360",["UWA/Class","DS/Visualization/ThreeJS_DS"],(function(t,i){"use strict";return t.extend({init:function(t){this._parent(t)},getFlippedTextureMaterial:function(t){var e=new i.MeshBasicMaterial({force:!0,side:i.DoubleSide,forceSide:!0});e.activatePDSFX();var n={uSampler:{type:"t2",value:t}};e.setPDSFXUniforms(n);e.setPDSFXVaryings({vUV:{type:"v2"}});var o={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vUV =vec2(1.0-_uv.x,1.0-_uv.y);","}"].join("\n")},a={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","ioFinalColor = vec4(1.0,0.0,0.0,1.0)","}"].join("\n")};return e.setPDSFXOverridableFunctions(o,a),e},getEdgeMaterial:function(t){return this.getTextureForFilterMaterial(t,{kernel:[-1,-1,-1,-1,8,-1,-1,-1,-1],kernelDim:3})},getBlurMaterial:function(t){return this.getTextureForFilterMaterial(t,{kernel:[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],kernelDim:3,effectRadius:10})},getTextureForFilterMaterial:function(t,e){var n=e.kernel||null,o=e.kernelDim||null,a=Math.floor((o-1)/2),r=e.effectRadius||10,s=e.applyOnAllImage||!1,h=new i.MeshBasicMaterial({force:!0,side:i.DoubleSide,forceSide:!0});h.activatePDSFX();var l={uSampler:{type:"t2",value:t},fullPanoWidthPixels:{type:"f",value:1},fullPanoHeightPixels:{type:"f",value:1},croppedAreaImageWidthPixels:{type:"f",value:1},croppedAreaImageHeightPixels:{type:"f",value:1},croppedAreaLeftPixels:{type:"f",value:0},croppedAreaTopPixels:{type:"f",value:0},kernelMatrix:{type:"fv1",value:n,length:o*o},effectRadius:{type:"f",value:r},applyEffect:{type:"f",value:0}};h.setPDSFXUniforms(l);h.setPDSFXVaryings({vUV:{type:"v2"}});var c={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vec2 uvF=vec2(1.0-_uv.x,1.0-_uv.y);","mat2 scale2Inv=mat2(fullPanoWidthPixels/croppedAreaImageWidthPixels, 0.0, 0.0, fullPanoHeightPixels/croppedAreaImageHeightPixels);","vec2 trans2=vec2((croppedAreaLeftPixels/fullPanoWidthPixels), ((fullPanoHeightPixels-croppedAreaTopPixels-croppedAreaImageHeightPixels)/fullPanoHeightPixels));","vUV=scale2Inv*(uvF-trans2);","}"].join("\n")},u={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","float x=vUV.x;","float y=vUV.y;","float tx=100.0/fullPanoWidthPixels;","float ty=100.0/fullPanoHeightPixels;","float minDX=min(vUV.x-tx, (1.0-tx)-vUV.x);","float minDY=min(vUV.y-ty, (1.0-ty)-vUV.y);","float minD=min(minDX, minDY);","if(applyEffect>0.0 && (minD<0.0 || "+s+"))","{","vec2 uvToUse=vUV;","float blurRadius="+(s?"effectRadius;":"effectRadius*(min(-minD/max(tx,ty),1.0));"),"float hStep=blurRadius/fullPanoWidthPixels;","float vStep=blurRadius/fullPanoHeightPixels;","vec4 sum = vec4( 0.0 );","for(int j=0; j<"+o+"; j++)","{","for(int i=0;i<"+o+";i++)","{","sum += kernelMatrix[i*"+o+"+j]*texture2D( uSampler, vec2( uvToUse.x - (float(i-"+a+"))*hStep, uvToUse.y - (float(j-"+a+"))*vStep ));","}","}","sum.a = 1.0;","ioFinalColor = sum;","}","else","{","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","}","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","}"].join("\n")};return h.setPDSFXOverridableFunctions(c,u),h},getTextureForTilesMaterial:function(t,e){var n=new i.MeshBasicMaterial({force:!0,side:i.DoubleSide,forceSide:!0});n.activatePDSFX();var o={uSampler:{type:"t2",value:t},fullPanoWidthPixels:{type:"f",value:1},fullPanoHeightPixels:{type:"f",value:1},croppedAreaImageWidthPixels:{type:"f",value:1},croppedAreaImageHeightPixels:{type:"f",value:1},croppedAreaLeftPixels:{type:"f",value:0},croppedAreaTopPixels:{type:"f",value:0}};n.setPDSFXUniforms(o);n.setPDSFXVaryings({vUV:{type:"v2"}});var a={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vec2 uvF=vec2(1.0-_uv.x,1.0-_uv.y);","mat2 scale2Inv=mat2(fullPanoWidthPixels/croppedAreaImageWidthPixels, 0.0, 0.0, fullPanoHeightPixels/croppedAreaImageHeightPixels);","vec2 trans2=vec2((croppedAreaLeftPixels/fullPanoWidthPixels), ((fullPanoHeightPixels-croppedAreaTopPixels-croppedAreaImageHeightPixels)/fullPanoHeightPixels));","vUV=scale2Inv*(uvF-trans2);","}"].join("\n")},r={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","}"].join("\n")};return n.setPDSFXOverridableFunctions(a,r),n}})})),define("DS/3DPlay360Experiences/DirectionIndicatorAbstract",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Rsc","text!DS/3DPlay360Experiences/assets/templates/directionIndicator.hbs","css!DS/3DPlay360Experiences/directionIndicator.css"],(function(t,i,e,n,o,a,r){"use strict";return t.extend({init:function(t){var i=this;this._view=null,this._angle=0,this._height=0,this._radius=0,this._light=null,this._viewpointChangeToken=null,this._viewpoint=null,this.id=t.id,o.rsc("3DPlay360Experiences/3DPlay360Experiences",{iconName:this.iconName,iconSize:"Normal"},(function(e){i.icon=e,t.callback()}))},getDirectionIndicatorData:function(){return{id:this.id,icon:this.icon}},show:function(){this._getView(),this.showIndicator()},hide:function(){this._detachVP(),this._hideIndicator()},_getView:function(){if(null===this._view){var t=document.createElement("div");this._view=t}return this._view&&this._view.classList.add("directionIndicator"),this._view},_getLight:function(){return this._light||this._getView()&&(this._light=document.querySelector("#light")),this._light},_getOuterContainer:function(){return this._outerContainer||this._getView()&&(this._outerContainer=document.querySelector("#indicatorOuterContainer")),this._outerContainer},_getContainer:function(){return this._container||this._getView()&&(this._container=document.querySelector("#indicatorContainer")),this._container},_getNorth:function(){return this._north||this._getView()&&(this._north=document.querySelector("#north")),this._north},getAngle:function(){return this._angle},setAngle:function(t){t&&(this._angle=t)},getHeight:function(){return this._height},setHeight:function(t){t&&(this._height=t)},getWidth:function(){return this._width},setWidth:function(t){t&&(this._width=t)},radius:function(){return this._radius},setRadius:function(t){t&&(this._radius=t)},attachTo:function(t){t&&t!==this._viewpoint&&(this._detachVP(),this._viewpoint=t),this._addVPChangeListener()},_detachVP:function(){this._removeVPChangeListener(),this._viewpoint=null},_addVPChangeListener:function(){null===this._viewpointChangeToken&&(this._viewpointChangeToken=i.subscribe({event:"/VISU/"},this._viewpointChangeCB.bind(this)))},_removeVPChangeListener:function(){this._viewpointChangeToken&&(i.unsubscribe(this._viewpointChangeToken),this._viewpointChangeToken=null)},_viewpointChangeCB:function(t){if(t&&"@onViewpointChange"===t.eventType&&t.viewpoint&&t.viewpoint==this._viewpoint){var i=t.viewpoint.getSightDirection().clone(),e=t.viewpoint.getCamera().height/t.viewpoint.viewer.SCREEN_HEIGHT*100,o=t.viewpoint.getCamera().width/t.viewpoint.viewer.SCREEN_WIDTH*100;i.normalize(),i.projectOnPlane(new n.Vector3(0,0,1));var a=i.length(),r=new n.Vector3(1,0,0).length()*a,s=Math.acos(i.x/r);i.y<0&&(s=2*Math.PI-s),this.setAngle(s),this.setRadius(a),this.setHeight(e),this.setWidth(o);var h=t.viewpoint.getCamera().x/t.viewpoint.getCamera().fullWidth*100,l=t.viewpoint.getCamera().y/t.viewpoint.getCamera().fullHeight*100;this._updateLight(h,l)}},destroy:function(){this._view=null,this._angle=null,this._radius=null,this._light=null,this._viewpointChangeToken=null,this._viewpoint=null,this.id=null,this.icon=null}})})),define("DS/3DPlay360Experiences/mathUtils360",["UWA/Class","DS/Visualization/ThreeJS_DS"],(function(t,i){"use strict";return t.extend({init:function(t){this._parent(t)},getSPhericalCoordinates:function(t){var i=null,e=null,n=null;t&&((i=t.length())>0&&(e=Math.acos(t.z),n=Math.atan2(t.y,t.x)));return{r:i,theta:n,phi:e}},getSPhericalFromCartesian:function(t){var i;return{r:i=Math.sqrt(t.x*t.x+t.y*t.y+t.z+t.z),theta:Math.atan(t.y/t.x),phi:Math.acos(t.z/i)}},getCartesianCoord:function(t){var e=t.r>0?t.r:0,n=t.theta,o=t.phi;return new i.Vector3(e*Math.sin(o)*Math.cos(n),e*Math.sin(o)*Math.sin(n),e*Math.cos(o))},ur:function(t){var e=t.theta,n=t.phi;return new i.Vector3(1*Math.sin(n)*Math.cos(e),1*Math.sin(n)*Math.sin(e),1*Math.cos(n))},uTheta:function(t){var e=t.theta;t.phi;return new i.Vector3(-1*Math.sin(e),1*Math.cos(e),0)},uPhi:function(t){var e=t.theta,n=t.phi;return new i.Vector3(1*Math.cos(n)*Math.cos(e),1*Math.cos(n)*Math.sin(e),-1*Math.sin(n))}})})),define("DS/3DPlay360Experiences/ImgData",["UWA/Class","DS/Visualization/ThreeJS_DS"],(function(t,i){"use strict";return t.extend({init:function(t){this._src=null,this._img=null,this._imgGeomData=null,this._isReady=!1,this._parent(t)},setImg:function(t){this._img=t},img:function(){return this._img},setGeomData:function(t){t&&(this._imgGeomData=t,this._imgGeomData.croppedAreaImageWidthPixels=t.fullPanoWidthPixels,this._imgGeomData.croppedAreaImageHeightPixels=t.fullPanoHeightPixels,this._imgGeomData.croppedAreaLeftPixels=null!==t.croppedAreaLeftPixels?t.croppedAreaLeftPixels:.5*(t.fullPanoWidthPixels-t.croppedAreaImageWidthPixels),this._imgGeomData.croppedAreaTopPixels=null!==t.croppedAreaTopPixels?t.croppedAreaTopPixels:.5*(t.fullPanoHeightPixels-t.croppedAreaImageHeightPixels))},geomData:function(){return this._imgGeomData?this._imgGeomData:null},readyCB:function(t){this._readyCB=t},isReady:function(){return this._isReady},activate:function(){return this._isReady?Promise.resolve(this):this._checkImg(this._img).then(function(t){return this._isReady=!0,Promise.resolve(this)}.bind(this)).catch((function(t){console.log(t)}))},dispose:function(){this.reset()},reset:function(){this._isReady=!1,this._readyCB=null,this._src=null,this._img=null,this._imgGeomData=null},thetaPhiForPixel:function(t){var i=this.geomData(),e=null,n=null;if(t&&i){var o=t.x,a=t.y;i.fullPanoWidthPixels>0&&i.fullPanoHeightPixels>0&&(e=2*Math.PI/i.fullPanoWidthPixels*o-Math.PI,n=-Math.PI/i.fullPanoHeightPixels*a+Math.PI)}return{theta:e,phi:n}},pixelForThetaPhi:function(t){var i=this.geomData(),e=null,n=null;if(t&&i){var o=t.theta,a=t.phi;i.fullPanoWidthPixels>0&&i.fullPanoHeightPixels>0&&(e=i.fullPanoWidthPixels/(2*Math.PI)*(o+Math.PI),n=i.fullPanoHeightPixels/-Math.PI*(a-Math.PI))}return{px:e,py:n}},computeImgRangeInSphericalCoord:function(){var t=this.geomData(),i=null;if(t){var e=t.croppedAreaLeftPixels,n=t.croppedAreaLeftPixels+t.croppedAreaImageWidthPixels,o=t.fullPanoHeightPixels-t.croppedAreaTopPixels-t.croppedAreaImageHeightPixels,a=t.fullPanoHeightPixels-t.croppedAreaTopPixels;(i={}).thetaMax=this.thetaPhiForPixel({x:n,y:0}).theta+.75,i.thetaMin=this.thetaPhiForPixel({x:e,y:0}).theta-.75,i.phiMin=this.thetaPhiForPixel({x:0,y:a}).phi+.9,i.phiMax=this.thetaPhiForPixel({x:0,y:o}).phi-.9}return i},computeMiddlePointSphericalCoord:function(){var t=this.geomData(),e=null;if(t){var n=t.croppedAreaLeftPixels,o=t.croppedAreaLeftPixels+t.croppedAreaImageWidthPixels,a=t.fullPanoHeightPixels-t.croppedAreaTopPixels-t.croppedAreaImageHeightPixels,r={x:n+(o-n)/2,y:a+(t.fullPanoHeightPixels-t.croppedAreaTopPixels-a)/2},s=this.thetaPhiForPixel(r,t);e=new i.Vector2(s.theta,s.phi)}return e},_checkImg:function(t){return new Promise(function(i,e){t?(t.complete&&i(t),t.onload=function(){i(t)}):e("_checkImg")}.bind(this))}})})),define("DS/3DPlay360Experiences/TrackballAbstractControl",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/WebSystem/Environment"],(function(t,i,e,n,o,a,r,s,h){"use strict";var l;return t.extend({init:function(t){this._userExpConfig={inertia:{minVelocity:.1,tau:.3,toleranceAngle:5,dtStationary:.1},rotation:{speedRadius:1e3,toleranceAngle:50},zoom:{minFovDeg:0,maxFovDeg:130,toleranceAngle:5,rightClickScalingAcceleration:.015},elasticReturn:{animDuration:75}},this.checkSize(t.size),this._viewpoint=null,this._animation=null,this._VisuEventsManagerTokens=null,this._basicEventToken=null,this._kinematicConstraints=null,this._applyKinematicConstraints=!t||void 0===t.applyKinematicConstraints||t.applyKinematicConstraints,this._inertianAnim=null,this._inertia=!t||void 0===t.inertia||t.inertia,this._currT=-1,this._angularVelocity={vTheta:null,vPhi:null},this._velocity={x:null,y:null},l=this;var e=void 0!==window.devicePixelRatio?window.devicePixelRatio:1;this.viewerHeight=i.glStates.currentHeight/e,this.viewerWidth=i.glStates.currentWidth/e,h.isSet("3DPlay.GyroscopeEvents")&&(this._gyroInfo={activated:!1,supported:!!window.DeviceOrientationEvent&&window.DeviceOrientationEvent,alpha:null,beta:null,gamma:null,get orientation(){return l.getDeviceOrientation()}}),this._zoomCoeff=null,this._onZoomCB=null,t&&(this._viewpoint=t.viewpoint||null),this._parent(t)},dispose:function(){this.clear(),this._userExpConfig=null,this._viewpoint=null,this._animation=null,this._VisuEventsManagerTokens=null,this._basicEventToken=null,this._kinematicConstraints=null,this._applyKinematicConstraints=null,this._inertianAnim=null,this._inertia=null,this._currT=null,this._angularVelocity=null,this._gyroInfo=null,this._zoomCoeff=null,this._onZoomCB=null,this._viewpoint=null,l=null,this._parent()},checkSize:function(t){"object"==typeof t.imgSize?t.imgSize.height>1024&&t.imgSize.width>2048?this.defaultZoom=!0:this.defaultZoom=!1:0!=t.imgSize&&t.imgSize<100?this.defaultZoom=!1:this.defaultZoom=!0},setApplyConstraints:function(t){!0===t&&!1===this._applyKinematicConstraints&&this._kinematicConstraints&&(this._applyKinematicConstraints=!0,this._animateBackToBestViewpointCompliantWithConstraints()),this._applyKinematicConstraints=t},applySphericalConstraints:function(){return this._applyKinematicConstraints},clear:function(){this.stop(),this._onZoomCB=null,this._animation=null,this._basicEventToken=null,this._kinematicConstraints=null,this._viewpoint=null,this._applyKinematicConstraints=!0,this._inertia=!0,this._currT=-1,this._angularVelocity={vTheta:null,vPhi:null},l=null},activate:function(t){l=this,t&&(this._setViewpoint(t),this.overloadScreenControls(),this.subscribeToUserInteractions(),h.isSet("3DPlay.GyroscopeEvents")&&this.activateGyro())},deactivate:function(){this.stopAnimation(),this.stopInertia(),h.isSet("3DPlay.GyroscopeEvents")&&this.stopGyro();var t=this._viewpoint.getControl();this.resetScreenControls(t),this.unsubscribeFromUserInteractions()},stop:function(){this.stopAnimation(),this.stopInertia(),h.isSet("3DPlay.GyroscopeEvents")&&this.stopGyro(),this._setViewpoint(null),this.resetScreenControls(),this.unsubscribeFromUserInteractions()},onZoomCB:function(t){this._onZoomCB=t},_setViewpoint:function(t){this._viewpoint=t},viewpoint:function(){return this._viewpoint},inertia:function(){return this._inertia},setInertia:function(t){!1!==t&&this.stopInertia(),this._inertia=t},computeMaxHFovGivenConstraints:function(){var t=null;if(this._applyKinematicConstraints){var i=this._kinematicConstraints,e=i.thetaMax-i.thetaMin,n=i.phiMax-i.phiMin;e=Math.min(e,this.hFov(n));var o=this._userExpConfig.zoom.toleranceAngle;t=180*e/Math.PI-o}return t},activateGyro:function(){this._gyroInfo.alpha=null,this._gyroInfo.beta=null,this._gyroInfo.gamma=null,this._gyroInfo.supported?(console.log("browser Supported"),window.top.addEventListener("deviceorientation",l.onDeviceOrientationEvent,!0),window.top.addEventListener("devicemotion",l.onDeviceMotionEvent,!0),window.top.addEventListener("MozOrientation",(function(t){console.log(t),console.log(50*orientation.x,50*orientation.y)}),!0)):console.log("Gyroscope not supported on this browser version")},stopGyro:function(){this._gyroInfo.alpha=null,this._gyroInfo.beta=null,this._gyroInfo.gamma=null,this._gyroInfo.supported&&window.top.removeEventListener("deviceorientation",l.onDeviceOrientationEvent,!0)},getDeviceOrientation:function(){var t=null;switch(window.matchMedia("(orientation: portrait)").matches&&console.log("you're in PORTRAIT mode"),window.matchMedia("(orientation: landscape)").matches&&console.log("you're in LANDSCAPE mode"),void 0!==window.orientation?t=window.orientation:console.log("This browser does not support device orientation"),window.orientation){case 0:console.log("UP");break;case 90:case-90:break;case 180:console.log("DOWN")}return t},onDeviceOrientationEvent:function(t){if(console.log("onDeviceOrientationEvent"),t){console.log(event.gamma),console.log(event.target.screen.orientation.type,event.target.screen.orientation.angle);var e=Math.PI/180,n=event.alpha*e,o=-event.beta*e,a=event.gamma*e,r=new i.Vector3(1,0,0),h=new s,c=null;if(null!=l._gyroInfo.alpha&&null!=l._gyroInfo.beta&&null!=l._gyroInfo.gamma){var u=new i.Vector3(l._gyroInfo.alpha,l._gyroInfo.beta,l._gyroInfo.gamma,"ZXY"),p=(new i.Quaternion).setFromEuler(u),d=r.clone().applyQuaternion(p);c=h.getSPhericalCoordinates(d)}var g=new i.Vector3(n,o,a),v=(new i.Quaternion).setFromEuler(g),m=r.clone().applyQuaternion(v),f=h.getSPhericalCoordinates(m);if(c)f.theta,c.theta,f.phi,c.phi;l._gyroInfo.alpha=n,l._gyroInfo.beta=o,l._gyroInfo.gamma=a}},onDeviceMotionEvent:function(t){if(t.acceleration&&null!=t.acceleration.x&&0!=t.acceleration.x&&null!=t.acceleration.y&&0!=t.acceleration.y){console.log(t),console.log(t.acceleration);var e=new i.Vector3(1,0,0),n=new s,o=new i.Vector3(2*t.acceleration.x,2*t.acceleration.y,0),a=(new i.Quaternion).setFromEuler(o),r=e.clone().applyQuaternion(a),h=n.getSPhericalFromCartesian(r),c=n.getSPhericalCoordinates(l._viewpoint.getSightDirection().clone().normalize());if(c){var u=c.theta-h.theta,p=c.phi-h.phi;console.log(h);var d={x:h.r*Math.sin(h.phi)*Math.cos(h.theta),y:h.r*Math.sin(h.phi)*Math.sin(h.theta),z:h.r*Math.cos(h.phi)};console.log(d),l.setViewpointForRotation({dTheta:u,dPhi:p})}else console.log("no recoard found")}else console.log("no acceleration")},onUserEndScreenInteraction:function(t){t.from[0].view.className.includes("indicator")||t.from[0].view.className.includes("curved")||this._inertia&&this.applyInertia.call(this)},onUserStartScreenInteraction:function(){this.stopInertia()},subscribeToUserInteractions:function(){this._VisuEventsManagerTokens=[],this._VisuEventsManagerTokens.push(o.addEvent(document,"onLeftMouseUp",this.onUserEndScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onRelease",this.onUserEndScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onTap",this.onUserEndScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onLeftMouseDown",this.onUserStartScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onRightMouseDown",this.onUserStartScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onTouch",this.onUserStartScreenInteraction.bind(this)))},unsubscribeFromUserInteractions:function(){if(this._VisuEventsManagerTokens){for(var t=this._VisuEventsManagerTokens.length,i=0;i<t;i++)o.removeEventFromToken(this._VisuEventsManagerTokens[i]);this._VisuEventsManagerTokens=null}},overloadScreenControls:function(t){if(this._viewpoint){this._viewpoint.onReframe((function(){})),this._viewpoint.onCenterCamera((function(){}));var i=this._viewpoint.getControl();i&&(i.onPan(function(t){t.defaultBehavior=!1,console.log("onpan")}.bind(this)),i.onZoom(this.zoomFun),i.onRotate(this.rotateFun))}},resetScreenControls:function(t){t&&(t.onPan(null),t.onZoom(null),t.onRotate(null))},setViewpointForSphericalCoord:function(t){if(t&&void 0!==t.theta&&void 0!==t.phi){var i=this.computeViewpointForSphericalCoord({theta:t.theta,phi:t.phi});this._viewpoint.setEyePosition(i.eyePosition),this._viewpoint.setSightDirection(i.sightDirection),this._viewpoint.setUpDirection(i.upDirection)}},setViewpointForRotation:function(t){if(t&&void 0!==t.dTheta&&void 0!==t.dPhi){var i=this._computeViewpointForRotation({dTheta:t.dTheta,dPhi:t.dPhi});this._viewpoint.setEyePosition(i.eyePosition),this._viewpoint.setSightDirection(i.sightDirection),this._viewpoint.setUpDirection(i.upDirection)}},computeAngleForScalingFactor:function(t){console.log(t);var i=null;if(null!==t&&0!==t&&1!==t){var e=this.computeFieldOfViews(this.viewpoint());e&&e.vFov&&(i=2*Math.atan(1/t*Math.tan(e.vFov/2))*180/Math.PI)}return i},computeViewpointForSightDir:function(t){var i=new s,e=i.getSPhericalCoordinates(t),n=this._viewpoint.getSightDirection(),o=i.getSPhericalCoordinates(n),a=e.theta-o.theta,r=e.phi-o.phi;return this._computeViewpointForRotation({dTheta:a,dPhi:r})},computeViewpointForSphericalCoord:function(t){var i=this._viewpoint.getSightDirection(),e=(new s).getSPhericalCoordinates(i),n=t.theta-e.theta,o=t.phi-e.phi;return this._computeViewpointForRotation({dTheta:n,dPhi:o})},_computeViewpointForRotation:function(t){var i=null,e=null,n=null;if(t&&null!==t.dTheta&&null!==t.dPhi){var o=t.dTheta,a=t.dPhi,r=new s,h=r.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize()),l={r:1,theta:h.theta+o,phi:h.phi+a},c={min:.05,max:Math.PI-.05};l.phi=l.phi<c.min?c.min:l.phi,l.phi=l.phi>c.max?c.max:l.phi,n=this._viewpoint.getEyePosition(),i=r.getCartesianCoord(l),e=r.uPhi(l).multiplyScalar(-1)}return{eyePosition:n,sightDirection:i,upDirection:e}},computeFieldOfViews:function(t){var i=null,e=null;if(t){var n=t.getCamera();if(n){e=n.fov*Math.PI/180;var o=n.aspect;i=2*Math.atan(o*Math.tan(e/2))}}return{hFov:i,vFov:e}},vFov:function(t){var i=null;if(t){var e=this.viewpoint().getCamera();if(e){var n=e.aspect;n&&(i=2*Math.atan(1/n*Math.tan(t/2)))}}return i},hFov:function(t){var i=null;if(t){var e=this.viewpoint().getCamera();if(e){var n=e.aspect;n&&(i=2*Math.atan(n*Math.tan(t/2)))}}return i},getRotationSphericalAngleForScreenDisplacement:function(t){var i=null,e=null;if(t&&void 0!==t.dx&&void 0!==t.dy){var n=this.computeFieldOfViews(this.viewpoint()),o=n.hFov?n.hFov:0,a=n.vFov?n.vFov:0;i=o/this.viewerWidth*t.dx,e=-a/this.viewerHeight*t.dy}return{dTheta:i,dPhi:e}},getDt:function(){var t=0,i=Date.now();return this._currT>0&&(t=(i-this._currT)/1e3),t},updateT:function(){this._currT=Date.now()},stopInertia:function(){this._inertianAnim&&(this._inertianAnim.stop(),this._inertianAnim=null)},applyInertia:function(){this.stopInertia();var t=new i.Vector2;t.x=this._angularVelocity.vTheta,t.y=this._angularVelocity.vPhi;var o=this,a=0,r=new e(0,0,1e3);r.setInterpolator((function(i){var e=o._userExpConfig.inertia.tau,n=(i=1e3*i/1e3)-a;a=i;var r=t,h=r.x,l=r.y,c=h*Math.exp(-i/e),u=l*Math.exp(-i/e),p=new s,d=o._viewpoint.getSightDirection().clone().normalize(),g=p.getSPhericalCoordinates(d);return{theta:g.theta+c*n,phi:g.phi+u*n}}));var h={me:this,setOrientation:function(t){this.me.setViewpointForSphericalCoord({theta:t.theta,phi:t.phi})}};this._inertianAnim=new n(h,"setOrientation",r),this._inertianAnim.start()},viewpointAnimationCB:function(t){t&&t.viewpoint&&t.sightDir&&(t.viewpoint.setEyePosition(t.eyePosition),t.viewpoint.setSightDirection(t.sightDir))},stopAnimation:function(){this._basicEventToken&&(a.unsubscribe(this._basicEventToken),this._basicEventToken=null),this._animation&&(this._animation.stop(),this._animation=null)},zoomFun:function(t){t.defaultBehavior=!1;var e=t.evt,n=t.factor,o=t&&t.gesture?t.gesture.getEvents():null,a=t&&t.gesture&&t.gesture.view.length>0&&t.gesture.view[0]?t.gesture.view[0]:null;if(o&&2==o.length){var s,h;if(s=o[0],h=o[1],s&&h&&a){var c=1,u=s.currentPosition,p=h.currentPosition,d=s.lastPosition,g=h.lastPosition,v=new i.Vector2(p.x-u.x,p.y-u.y),m=new i.Vector2(g.x-d.x,g.y-d.y),f=v.length();if(0!=(w=m.length())&&(c=f/w),(P=l.computeFieldOfViews(this.viewpoint))&&P.vFov&&c&&0!=c&&1!=c){var _=2*Math.atan(1/c*Math.tan(P.vFov/2))*180/Math.PI;l._setZoomForAngle(_),this.viewer.render()}}}else if(o&&1==o.length){if((e=o[0])&&null!=e.event)if(e.event.button===r.MouseButton.RIGHT){e.currentPosition,e.lastPosition,c=1,u=e.startPosition,p=e.currentPosition,d=e.startPosition,g=e.lastPosition,v=new i.Vector2(0,p.y-u.y),m=new i.Vector2(0,g.y-d.y),f=v.length();var w=m.length();0!=f&&(c=w/f);_=this.computeAngleForScalingFactor(c);this._setZoomForAngle(_),this.viewer.render()}}else if(null!=n&&0!=n){var P,D=this._viewpoint?this._viewpoint:this.viewpoint,y=180*((P=l.computeFieldOfViews(D)).vFov?P.vFov:0)/Math.PI-n;l._setZoomForAngle(y),this.viewer?this.viewer.render():this._viewpoint.viewer.render()}},rotateFun:function(t){if(console.log("onRotate"),t.defaultBehavior=!1,t&&t.gesture.events&&t.gesture.view&&t.gesture.view.length&&this){l.stopInertia();var i=t.gesture.events,e=t.gesture.view[0],n=i[0].getCurrentPosition?i[0].getCurrentPosition(e):i[0].currentPosition,o=i[0].getLastPosition?i[0].getLastPosition(e):i[0].lastPosition;if(n&&o){var a=n.x-o.x,r=n.y-o.y,s=l.getRotationSphericalAngleForScreenDisplacement({dx:a,dy:r}),h=s.dTheta,c=s.dPhi,u=l.getDt();u>0&&(l._angularVelocity.vTheta=h/u,l._angularVelocity.vPhi=c/u),l.updateT(),l.setViewpointForRotation({dTheta:h,dPhi:c})}l.lastLockZState=this._state}},reframe:function(){},setKinematicConstraints:function(){},startAnimation:function(){}})})),define("DS/3DPlay360Experiences/ImgAbstractViewerController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/MediaAbstractViewerController"],(function(t,i,e){"use strict";return e.extend({init:function(t){this._parent(t),t.size&&t.size.height&&t.size.width&&(this.nodeDim={height:t.size.height,width:t.size.width}),this._imgData=null},dispose:function(){this._parent()},reframe:function(t){this._reframeOnInitialView(t),this._trackball.reframe()},setImgData:function(t){this._imgData=t},getImgData:function(){return this._imgData},getDirectionIndicatorData:function(){return this._directionIndicator.getDirectionIndicatorData()},hide:function(){this.setDefaultVP(),this._hideNode(),this._deactivateTrackball(),this._hideIndicator()},_hideIndicator:function(){this._directionIndicator.hide()},showIndicator:function(){this._directionIndicator&&this._directionIndicator.show()},_hideNode:function(){this.createdNode&&this.createdNode.setVisibility(!1)},displayDirIndicator:function(){this.viewpoint()&&this._directionIndicator.attachTo(this.viewpoint())},showNode:function(){this.createdNode&&this.createdNode.setVisibility(!0)},build:function(t){var i=this;this._imgMaterial||(console.log("MATERIAL"),this._imgMaterial=this.createMaterial()),this._imgMaterial.setImgData(this.getImgData()).then((function(e){return console.time("[360 perfos] - node Creation"),console.log("NODE : "+i.node().name),console.timeEnd("[360 perfos] - node Creation"),console.time("[360 perfos] - apply material and render"),i.node().setMaterial(e.material()),i.viewer().render(),console.timeEnd("[360 perfos] - apply material and render"),t(),Promise.resolve()}))},applyKinematicConstraints:function(){},removeKinematicConstraints:function(){},_computeInitialView:function(){},_reframeOnInitialView:function(){},_getVisiblePixelCoord:function(){},setDefaultVP:function(){}})})),define("DS/3DPlay360Experiences/ImgMaterialAbstract",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/shaderFactory360","DS/3DPlay360Experiences/ImgData"],(function(t,i,e,n){"use strict";return t.extend({init:function(){this._imgData=null,this._src=null,this._img=null,this._imgMaterial=null},setImgData:function(t){return this._imgData=t,this.activate()},imgData:function(){return this._imgData},material:function(){return this._imgMaterial},activate:function(){return this.imgData().activate().then(function(t){return this._createimgTexture(t.img())}.bind(this)).then(function(t){return this._imgMaterial?this._imgMaterial&&this._updateMaterial(this._imgData,this._imgMaterial,t):this._imgMaterial=this._createimgMaterial(this.imgData(),t),Promise.resolve(this)}.bind(this)).catch((function(t){console.log(t)}))},dispose:function(){this.reset()},reset:function(){this._imgMaterial=null,this._src=null,this._img=null,this._imgData=null},_createimgTexture:function(t){return new Promise(function(e,n){var o=null;if(t){var a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0);var r=a.toDataURL("image/png");(o=i.ImageUtils.loadTexture(r,void 0,null,null,i.ImageUtils.crossOriginPolicy)).minFilter=i.LinearFilter,o.needsUpdate=!0,o.anisotropy=1024,a=void 0,r=void 0,e(o)}else n("_createimgTexture");o=null}.bind(this))},_createimgMaterial:function(t,n){var o=(new e).getBlurMaterial(n);return o.side=i.BackSide,o.forceSide=!0,o.force=!0,this._updateMaterial(t,o,n),o}})})),define("DS/3DPlay360Experiences/DirectionIndicatorSpherical",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorSpherical.css"],(function(t,i,e,n,o,a,r){"use strict";return a.extend({init:function(t){this.iconName="Spherical",this._parent(t),this._moveLightCB=this._moveLight.bind(this),this._downLightCB=this._onPointerDownOnLight.bind(this),this._upLightCB=this._onPointerUpOnLight.bind(this)},_hideIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.remove("indicatorOuterContainerSpherical"),this._getContainer().classList.remove("directionIndicatorSpherical"),this._getLight().classList.remove("lightSpherical"),this._getNorth().classList.add("hide"),this._getOuterContainer().removeEventListener("pointerdown",this._downLightCB),this._getOuterContainer().removeEventListener("pointerup",this._upLightCB),this._getOuterContainer().removeEventListener("pointerleave",this._upLightCB))},showIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.add("indicatorOuterContainerSpherical"),this._getContainer().classList.add("directionIndicatorSpherical"),this._getOuterContainer().addEventListener("pointerdown",this._downLightCB),this._getOuterContainer().addEventListener("pointerup",this._upLightCB),this._getOuterContainer().addEventListener("pointerleave",this._upLightCB),this._getLight().classList.add("lightSpherical"),this._getNorth().classList.remove("hide"),"white"!==this._getLight().style.backgroundColor&&(this._getLight().style.backgroundColor="white",this._getLight().style.border="2px solid black"),this._getLight().style.height="16px",this._getLight().style.width="16px")},_updateLight:function(){var t=this._getLight();if(t){var i=.6*this._radius,e=this._angle,n=50-50*(i*Math.cos(e)),o=50-50*(i*Math.sin(e));t.style.top=n+"%",t.style.left=o+"%"}},_onPointerDownOnLight:function(t){this._pointerDown=!0,this._moveLight(t),this._getOuterContainer().addEventListener("pointermove",this._moveLightCB)},_onPointerUpOnLight:function(t){this._pointerDown=!1,this._getOuterContainer().removeEventListener("pointermove",this._moveLightCB)},_moveLight:function(t){if(this._pointerDown){t.stopPropagation();var i=t.target.getBoundingClientRect(),e=Math.ceil(t.clientX-i.left),o=Math.ceil(t.clientY-i.top),a=i.width,r=i.height,s=this._toRange(e,{a:0,b:a},{a:-1,b:1}),h=this._toRange(o,{a:0,b:r},{a:-1,b:1}),l=Math.max(.001,.2*(1-Math.sqrt(s*s+h*h))-.1),c=new n.Vector3(-h,-s,l);this._viewpoint.setSightDirection(c);var u=new n.Vector3(-c.y,c.x,0);u.normalize(),c.normalize();var p=(new n.Vector3).crossVectors(c,u);this._viewpoint.setUpDirection(p)}},_toRange:function(t,i,e){return(t-i.a)*(e.b-e.a)/(i.b-i.a)+e.a}})})),define("DS/3DPlay360Experiences/ImgMaterialPlaner",["DS/3DPlay360Experiences/ImgMaterialAbstract"],(function(t){"use strict";return t.extend({init:function(t){this._parent(t)},_updateMaterial:function(t,i,e){if(t&&t.isReady){e&&i.updatePDSFXUniform("uSampler",e);var n=t.geomData();n&&i&&(i.updatePDSFXUniform("fullPanoWidthPixels",n.fullPanoWidthPixels),i.updatePDSFXUniform("fullPanoHeightPixels",n.fullPanoHeightPixels),i.updatePDSFXUniform("croppedAreaImageWidthPixels",n.fullPanoWidthPixels),i.updatePDSFXUniform("croppedAreaImageHeightPixels",n.fullPanoHeightPixels),i.updatePDSFXUniform("croppedAreaLeftPixels",0),i.updatePDSFXUniform("croppedAreaTopPixels",0),i.updatePDSFXUniform("applyEffect",-1)),i.needsUpdate=!0,n=void 0}}})})),define("DS/3DPlay360Experiences/ImgMaterialSpherical",["DS/3DPlay360Experiences/ImgMaterialAbstract"],(function(t){"use strict";return t.extend({init:function(t){this._parent(t)},_updateMaterial:function(t,i,e){if(t&&t.isReady){e&&i.updatePDSFXUniform("uSampler",e);var n=t.geomData();n&&i&&(i.updatePDSFXUniform("fullPanoWidthPixels",n.fullPanoWidthPixels),i.updatePDSFXUniform("fullPanoHeightPixels",n.fullPanoHeightPixels),i.updatePDSFXUniform("croppedAreaImageWidthPixels",n.fullPanoWidthPixels),i.updatePDSFXUniform("croppedAreaImageHeightPixels",n.fullPanoHeightPixels),i.updatePDSFXUniform("croppedAreaLeftPixels",0),i.updatePDSFXUniform("croppedAreaTopPixels",0),i.updatePDSFXUniform("applyEffect",1))}}})})),define("DS/3DPlay360Experiences/DirectionIndicatorCylindrical",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorCylindrical.css"],(function(t,i,e,n,o,a,r){"use strict";return a.extend({init:function(t){this.iconName="Cylindrical",this._parent(t)},_hideIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.remove("indicatorOuterContainerCylindrical"),this._getContainer().classList.remove("directionIndicatorCylindrical"),this._getLight().classList.remove("lightCylindrical"),this._getLight().style.backgroundColor="white",this._getLight().style.border="2px solid black",this._getNorth().classList.remove("hide"))},showIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.add("indicatorOuterContainerCylindrical"),this._getContainer().classList.add("directionIndicatorCylindrical"),this._getLight().classList.add("lightCylindrical"),this._getNorth().classList.add("hide"),this._getLight().style.height="25px",this._getLight().style.width="13px")},_updateLight:function(){var t=this._getLight();if(t){var i=.6*this._radius,e=this._angle,n=50-50*(i*Math.cos(e));t.style.left=n+"%","50%"!==t.style.top&&(t.style.top="50%"),e<3?(t.style.backgroundColor="black",t.style.border="2px solid white"):e>3&&(t.style.backgroundColor="white",t.style.border="2px solid black")}}})})),define("DS/3DPlay360Experiences/TrackballControlPlane",["DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],(function(t,i,e,n,o,a,r,s){"use strict";var h=null;return r.extend({init:function(t){t.onDeviceOrientationEvent=this.onDeviceOrientationEvent,this._parent(t),this._applyKinematicConstraints=!1,this._userExpConfig.translation={toleranceDistance:100},h=this},dispose:function(){this._applyKinematicConstraints=null,this._parent(),h=null},setKinematicConstraints:function(t){this._kinematicConstraints={origin:t.origin,width:t.width,height:t.height}},_viewerRect:function(){void 0!==window.devicePixelRatio&&window.devicePixelRatio;return{origin:new s.Vector2(0,0),width:this.viewerHeight,height:this.viewerWidth}},_visibleRect:function(){void 0!==window.devicePixelRatio&&window.devicePixelRatio;var t=this.viewpoint(),i=this.viewerHeight,e=this.viewerWidth,n=void 0!==t.getCamera().width?t.getCamera().width:e,o=void 0!==t.getCamera().height?t.getCamera().height:i,a=void 0!==t.getCamera().x?t.getCamera().x:0,r=void 0!==t.getCamera().y?t.getCamera().y:0;return{origin:new s.Vector2(a,r),width:n,height:o}},_convertVect:function(t,i,e){var n=new s.Vector2;if(t&&i&&e&&i.width>0&&i.height>0&&e.width>0&&e.height>0){var o=e.width/i.width,a=e.height/i.height;(n=t).x=n.x*o,n.y=n.y*a}return n},_interpolatedRect:function(t,i,e,n){var o={origin:i.origin.clone(),width:i.width,height:i.height},a=i.origin.x-t.origin.x,r=i.origin.y-t.origin.y;if(t&&i&&e&&n>0&&0!==a&&0!==r){var s,h=n,l=e.origin.x,c=e.origin.x+e.width,u=e.origin.y,p=e.origin.y+e.height;if(a<0&&t.origin.x+a<l){var d=Math.abs(l-t.origin.x);s=Math.abs(1-d/h),o.origin.x=t.origin.x+a*s}if(r<0&&t.origin.y+r<u){var g=Math.abs(u-t.origin.y);s=Math.abs(1-g/h),o.origin.y=t.origin.y+r*s}if(a>0&&t.origin.x+t.width+a>c){var v=Math.abs(c-(t.origin.x+t.width));s=Math.abs(1-v/h),o.origin.x=t.origin.x+a*s}if(r>0&&t.origin.y+t.height+r>p){var m=Math.abs(p-(t.origin.y+t.height));s=Math.abs(1-m/h),o.origin.y=t.origin.y+r*s}}return o},maxRectInContainer:function(t){var i=null;if(this._kinematicConstraints&&t){if(i={origin:t.origin.clone(),width:t.width,height:t.height},this._kinematicConstraints.width<t.width||this._kinematicConstraints.height<t.height){var e=Math.min(this._kinematicConstraints.width/t.width,this._kinematicConstraints.height/t.height);i.width*=e,i.height*=e}var n=this._kinematicConstraints.origin.x,o=this._kinematicConstraints.origin.x+this._kinematicConstraints.width,a=this._kinematicConstraints.origin.y,r=this._kinematicConstraints.origin.y+this._kinematicConstraints.height;i.origin.x<n&&(i.origin.x=n),i.origin.y<a&&(i.origin.y=a),i.origin.x+i.width>o&&(i.origin.x=o-i.width),i.origin.y+i.height>r&&(i.origin.y=r-i.height)}return i},offsetRectForScreenDisplacement:function(t){var i=null;if(t){var e=this._visibleRect(),n=this._viewerRect(),o=this._convertVect(t,n,e);i={origin:new s.Vector2(e.origin.x-o.x,e.origin.y-o.y),width:e.width,height:e.height}}return i},_zoomRectForScaleWithCenter:function(t){var i=null;if(t&&null!=t.scalingFactor&&1!=t.scalingFactor&&null!=t.center){var e=t.scalingFactor,n=this._visibleRect(),o=this._viewerRect(),a=this._convertVect(t.center,o,n).clone().multiplyScalar(1-e);i={origin:new s.Vector2(n.origin.x+a.x,n.origin.y+a.y),width:e*n.width,height:e*n.height}}return i},zoomToRect:function(t,i){if(t){void 0!==window.devicePixelRatio&&window.devicePixelRatio;var e=this.viewpoint(),n=this.viewerHeight,o=this.viewerWidth,a=void 0!==e.getCamera().width?e.getCamera().width:o,r=void 0!==e.getCamera().height?e.getCamera().height:n,h=void 0!==e.getCamera().x?e.getCamera().x:0,l=void 0!==e.getCamera().y?e.getCamera().y:0,c=t;c.width=void 0!==t.width&&t.width>0?t.width:a,c.height=void 0!==t.height&&t.height>0?t.height:r,c.origin=void 0!==t.origin?t.origin:s.Vector2(h,l),i&&i.ignoreConstraints||!this._applyKinematicConstraints||!this._kinematicConstraints||(c=i&&i.useResistence?this._interpolatedRect(this._visibleRect(),c,this._kinematicConstraints,this._userExpConfig.translation.toleranceDistance):this.maxRectInContainer(c));c.origin.x,c.origin.y;this._kinematicConstraints&&(c.width>this._kinematicConstraints.width&&(c.width=this._kinematicConstraints.width),c.height>this._kinematicConstraints.height&&(c.height=this._kinematicConstraints.height)),e.setViewOffset({width:c.width,height:c.height,x:c.origin.x,y:c.origin.y})}},_animateBackToBestViewpointCompliantWithConstraints:function(){if(this._applyKinematicConstraints&&this._kinematicConstraints)new s.Vector3(200,100,-50),new s.Vector3(200,-100,-50),new s.Vector3(200,100,50)},applyInertia:function(){this.stopInertia();this._velocity;if(Math.abs(this._velocity.x)<0&&Math.abs(this._velocity.y)<0||this.getDt()>this._userExpConfig.inertia.dtStationary)this._animateBackToBestViewpointCompliantWithConstraints();else{new a;var e=this,n=0,o=new t(0,0,1e3);o.setInterpolator((function(t){var i=e._userExpConfig.inertia.tau,o=(t=1e3*t/1e3)-n;n=t;var a=e._velocity,r=a.x,s=a.y;return{dx:r*Math.exp(-t/i)*o,dy:s*Math.exp(-t/i)*o}}));var r={me:this,setOrientation:function(t){var i=t.dx,e=t.dy,n=this.me.offsetRectForScreenDisplacement(new s.Vector2(i,e));if(this.me._applyKinematicConstraints&&this.me._kinematicConstraints){var o=this.me._kinematicConstraints,a=o.origin.x,r=o.origin.x+o.width,h=o.origin.y,l=o.origin.y+o.height;n.origin.x<a&&(this.me._velocity.x=this.me._velocity.x>0?-this.me._velocity.x:this.me._velocity.x),n.origin.y<h&&(this.me._velocity.y=this.me._velocity.y>0?-this.me._velocity.y:this.me._velocity.y),n.origin.x+n.width>r&&(this.me._velocity.x=this.me._velocity.x<0?-this.me._velocity.x:this.me._velocity.x),n.origin.y+n.height>l&&(this.me._velocity.y=this.me._velocity.y<0?-this.me._velocity.y:this.me._velocity.y)}this.me.zoomToRect(n,{ignoreConstraints:!0})}};this._inertianAnim=new i(r,"setOrientation",o),this._inertianAnim.start()}},startAnimation:function(t){if(this.stopInertia(),this.stopAnimation(),null===this._basicEventToken&&(this._basicEventToken=n.subscribe({event:"/VISU/onBasicEvent"},function(t){if(t)for(var i=0;i<t.from.length;i++){var e=t.from[i],n=e.getType(),a=e.getState();e instanceof o&&"Keyboard"!==n&&a===o.State.BEGIN&&this.stopAnimation()}}.bind(this))),null===this._animation){var e=new function(t){this._nbLoops=void 0!==t.animationData.nbLoops?t.animationData.nbLoops:5,this._duration=void 0!==t.animationData.duration?t.animationData.duration:1e4,this._T=this._duration/this._nbLoops,this._rotVect=t.viewpointData.rotVect,this._rotAngle=t.viewpointData.rotAngle,this._sightDir_t0=t.viewpointData.sightDir,this.duration=function(){return this._duration},this.valueAt=function(i){var e=i%this._T/this._T,n=new s.Matrix4;n.makeRotationAxis(this._rotVect,e*this._rotAngle);var o=this._sightDir_t0.clone();return o.applyMatrix4(n),{viewpoint:t.viewpointData.viewpoint,sightDir:o,eyePosition:new s.Vector3(0,0,0)}}}({animationData:{nbLoops:1,duration:1e5},viewpointData:{viewpoint:t,sightDir:new s.Vector3(1,0,0),rotVect:new s.Vector3(0,0,1),rotAngle:-2*Math.PI}});this._animation=new i(this,"viewpointAnimationCB",e)}},zoomFun:function(t){t.defaultBehavior=!1;var i=t.evt,e=-1*t.factor;if(Math.abs(e)>=1){e*=1/40}var n=1+e,o=i._currentPosition,a=h._zoomRectForScaleWithCenter({center:o,scalingFactor:n});a&&a.origin.x&&h.zoomToRect(a)},rotateFun:function(t){if(t.defaultBehavior=!1,t&&t.gesture.events&&t.gesture.view&&t.gesture.view.length){h.stopInertia();var i=t.gesture.events,e=t.gesture.view[0],n=i[0].getCurrentPosition?i[0].getCurrentPosition(e):i[0].currentPosition,o=i[0].getLastPosition?i[0].getLastPosition(e):i[0].lastPosition;if(n&&o){var a=n.x-o.x,r=n.y-o.y,l=h.getDt();l>0&&(h._velocity.x=a/l,h._velocity.y=r/l),h.updateT();var c=h.offsetRectForScreenDisplacement(new s.Vector2(a,r));h.zoomToRect(c,{useResistence:!1})}}},onDeviceOrientationEvent:function(){console.log("Deactivated in Flat mode!")}})})),define("DS/3DPlay360Experiences/TrackballControlCylindrical",["UWA/Class","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],(function(t,i,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(t){this._parent(t);var i=Math.min(this.viewerHeight,t.size.imgSize.height),e=Math.min(this.viewerWidth,t.size.imgSize.width),n=i/e*2*180/Math.PI;this._userExpConfig.zoom.maxFovDeg=n||125,this._userExpConfig.rotation.toleranceAngle=e/i*10,this},dispose:function(){this._applyKinematicConstraints=null,this._parent(),null},setKinematicConstraints:function(t){this._kinematicConstraints={thetaMin:t.thetaMin,thetaMax:t.thetaMax,phiMin:t.phiMin,phiMax:t.phiMax}},_computeSightDirRangeGivenConstraints:function(){var t=this._kinematicConstraints,i=this.computeFieldOfViews(this._viewpoint),e=i.hFov?i.hFov:0,n=i.vFov?i.vFov:0;return{thetaMin:t.thetaMin+e/2,thetaMax:t.thetaMax-e/2,phiMin:t.phiMin+n/2,phiMax:t.phiMax-n/2}},_computeMaxVFovGivenConstraints:function(){var t=null,i=this._kinematicConstraints;if(i){var e=i.phiMax-i.phiMin,n=this._userExpConfig.zoom.toleranceAngle;t=180*e/Math.PI-n}return t},_animateBackToBestViewpointCompliantWithConstraints:function(){var t=this.computeFieldOfViews(this.viewpoint()),i=180*(t.vFov?t.vFov:0)/Math.PI,e=this._computeMaxVFovGivenConstraints();i>e&&this._setZoomForAngle(e);var n=new r,o=this._viewpoint.getSightDirection().clone().normalize(),a=n.getSPhericalCoordinates(o),s=a.theta,h=a.phi,l=this._computeSightDirRangeGivenConstraints(),c=a.theta-l.thetaMin,u=a.theta-l.thetaMax,p=a.phi-l.phiMin,d=a.phi-l.phiMax;c<0&&(s=l.thetaMin),u>0&&(s=l.thetaMax),p<0&&(h=l.phiMin),d>0&&(h=l.phiMax);var g={r:1,theta:s,phi:h},v=n.getCartesianCoord(g),m=n.uPhi(g).multiplyScalar(-1);this._viewpoint.moveTo({eyePosition:this._viewpoint.getEyePosition(),sightDirection:v,upDirection:m,duration:this._userExpConfig.elasticReturn.animDuration})},_setZoomForAngle:function(t){if(t){var i=t,e=this._computeMaxVFovGivenConstraints();(i=i>e?e:i)&&i>=this._userExpConfig.zoom.minFovDeg&&i<=this._userExpConfig.zoom.maxFovDeg&&(this.viewpoint().setAngle(i),this._onZoomCB&&this._onZoomCB())}},_computeViewpointForRotation:function(t){var i=null,e=null,n=null;if(t&&null!==t.dTheta&&null!==t.dPhi){var o=t.dTheta,a=t.dPhi,s=new r,h=s.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize()),l={r:1,theta:h.theta+o,phi:h.phi+a};if(this._kinematicConstraints){var c=this._computeSightDirRangeGivenConstraints(),u=l.theta-c.thetaMin,p=l.theta-c.thetaMax,d=l.phi-c.phiMin,g=l.phi-c.phiMax,v=this._userExpConfig.rotation.toleranceAngle*(Math.PI/180);u<0&&(o*=1-Math.abs(u)/v),p>0&&(o*=1-Math.abs(p)/v),d<0&&(a*=1-Math.abs(d)/v),g>0&&(a*=1-Math.abs(g)/v),l={r:1,theta:h.theta+o,phi:h.phi+a}}var m={min:.05,max:Math.PI-.05};l.phi=l.phi<m.min?m.min:l.phi,l.phi=l.phi>m.max?m.max:l.phi,n=this._viewpoint.getEyePosition(),i=s.getCartesianCoord(l),e=s.uPhi(l).multiplyScalar(-1)}return{eyePosition:n,sightDirection:i,upDirection:e}},startAnimation:function(t){if(this.stopInertia(),this.stopAnimation(),null===this._basicEventToken&&(this._basicEventToken=o.subscribe({event:"/VISU/onBasicEvent"},function(t){if(t)for(var i=0;i<t.from.length;i++){var e=t.from[i],n=e.getType(),o=e.getState();e instanceof a&&"Keyboard"!==n&&o===a.State.BEGIN&&this.stopAnimation()}}.bind(this))),null===this._animation){var i=new function(t){this._nbLoops=void 0!==t.animationData.nbLoops?t.animationData.nbLoops:5,this._duration=void 0!==t.animationData.duration?t.animationData.duration:1e4,this._T=this._duration/this._nbLoops,this._rotVect=t.viewpointData.rotVect,this._rotAngle=t.viewpointData.rotAngle,this._sightDir_t0=t.viewpointData.sightDir,this.duration=function(){return this._duration},this.valueAt=function(i){var e=i%this._T/this._T,n=new h.Matrix4;n.makeRotationAxis(this._rotVect,e*this._rotAngle);var o=this._sightDir_t0.clone();return o.applyMatrix4(n),{viewpoint:t.viewpointData.viewpoint,sightDir:o,eyePosition:new h.Vector3(0,0,0)}}}({animationData:{nbLoops:1,duration:1e5},viewpointData:{viewpoint:t,sightDir:new h.Vector3(1,0,0),rotVect:new h.Vector3(0,0,1),rotAngle:-2*Math.PI}});this._animation=new e(this,"viewpointAnimationCB",i)}this._animation&&(this._animation.setLoop(1),this._animation.start())},reframe:function(){var t,i=this.computeFieldOfViews(this.viewpoint()),e=i.vFov?i.vFov:0;t=this.defaultZoom?180*e/Math.PI:this._userExpConfig.zoom.maxFovDeg,this._setZoomForAngle(t),this.viewer&&this.viewer.render()}})})),define("DS/3DPlay360Experiences/DirectionIndicatorPlaner",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorPlaner.css"],(function(t,i,e,n,o,a,r){"use strict";return a.extend({init:function(t){this.iconName="Planer",this._parent(t)},_hideIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.remove("indicatorOuterContainerPlaner"),this._getContainer().classList.remove("directionIndicatorPlaner"),this._getLight().classList.remove("lightPlaner"),this._getNorth().classList.remove("hide"))},showIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.add("indicatorOuterContainerPlaner"),this._getContainer().classList.add("directionIndicatorPlaner"),this._getLight().classList.add("lightPlaner"),this._getNorth().classList.add("hide"))},_updateLight:function(t,i){var e=this._getLight();if(e){var n=this.getHeight(),o=this.getWidth();e.style.height=20+n+"%",e.style.width=5+o+"%",e.style.top=i-10+"%",e.style.left=t+"%"}},setOrigin:function(t){this._origin=t}})})),define("DS/3DPlay360Experiences/ImgMaterialCylindrical",["DS/3DPlay360Experiences/ImgMaterialAbstract"],(function(t){"use strict";return t.extend({init:function(t){this._parent(t)},_updateMaterial:function(t,i,e){if(t&&t.isReady){e&&i.updatePDSFXUniform("uSampler",e);var n=t.geomData();n&&i&&(i.updatePDSFXUniform("fullPanoWidthPixels",n.fullPanoWidthPixels),i.updatePDSFXUniform("fullPanoHeightPixels",n.fullPanoHeightPixels),i.updatePDSFXUniform("croppedAreaImageWidthPixels",n.croppedAreaImageWidthPixels),i.updatePDSFXUniform("croppedAreaImageHeightPixels",n.croppedAreaImageHeightPixels),i.updatePDSFXUniform("croppedAreaLeftPixels",n.croppedAreaLeftPixels),i.updatePDSFXUniform("croppedAreaTopPixels",n.croppedAreaTopPixels),i.updatePDSFXUniform("applyEffect",-1)),i.needsUpdate=!0,n=void 0}}})})),define("DS/3DPlay360Experiences/ImgFlatViewerController",["DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/TrackballControlPlane","DS/3DPlay360Experiences/DirectionIndicatorPlaner","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialPlaner"],(function(t,i,e,n,o,a,r){"use strict";return a.extend({init:function(t){this._parent(t),this._planeData={width:200,height:100,distance:150},this.nodeDim&&this.nodeDim.width&&this.nodeDim.height&&(this._planeData.width=this.nodeDim.width,this._planeData.height=this.nodeDim.height,this._planeData.distance=this.nodeDim.width+this.nodeDim.height/2),this._userExpConfig={zoom:{defaultFOV:45}},this._directionIndicator=new o({id:t.id,callback:t.callback})},dispose:function(){this._planeData=null,this._parent()},createTrackball:function(t){return new n({applyKinematicConstraints:!1,inertia:!0,size:t})},createMaterial:function(){return new r},_createNode:function(){var t=this._planeData.width,n=this._planeData.height,o=new i.PlaneGeometry(t,n);o.applyMatrix((new i.Matrix4).makeBasis(new i.Vector3(0,-1,0),new i.Vector3(0,0,-1),new i.Vector3(1,0,0)));var a=new i.Mesh(o,new i.MeshPhongMaterial,!0),r=e.createNodeFromTHREEMesh(a);return r.setMatrix((new i.Matrix4).setPosition(new i.Vector3(30,0,0))),r.name="planeNode",this.createdNode=r,r},applyKinematicConstraints:function(){var t=this.trackBall().offsetRectForScreenDisplacement(new i.Vector2(0,0)),e=this.trackBall();e&&(e.setKinematicConstraints(t),e.setApplyConstraints(!0)),this._directionIndicator&&this._directionIndicator.setOrigin(t.origin)},removeKinematicConstraints:function(){var t=this.trackBall();t&&t.setApplyConstraints(!1)},_reframeOnInitialView:function(t){var e=t?1e3:0,n=(this._planeData&&this._planeData.distance&&this._planeData.distance,this.viewer());n&&(n.setShadow(!1),n.setGrid(!1),n.setMirror(!1,!1),n.displayInfinitePlane(!1),n.setPrePicking({activated:!1,displayHL:!1},!0),n.setPicking({activated:!1,displayHL:!1},!0)),this.defaultOffsetRect=this.trackBall().offsetRectForScreenDisplacement(new i.Vector2(0,0)),this.setDefaultVP(e)},setDefaultVP:function(t){t=t||1e3,this.viewpoint().moveTo({eyePosition:new i.Vector3(-this._planeData.distance,0,0),upDirection:new i.Vector3(0,0,1),sightDirection:new i.Vector3(1,0,0),duration:t}),this.viewpoint().setAngle(this._userExpConfig.zoom.defaultFOV),this.trackBall().zoomToRect(this.defaultOffsetRect,{useResistence:!1})}})})),define("DS/3DPlay360Experiences/ImgCylindricalViewerController",["UWA/Class","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballControlCylindrical","DS/3DPlay360Experiences/DirectionIndicatorCylindrical","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialCylindrical"],(function(t,i,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(t){this._parent(t),this._directionIndicator=new r({id:t.id,callback:t.callback})},dispose:function(){this._parent()},createTrackball:function(t){return new a({applyKinematicConstraints:!1,inertia:!0,size:t})},createMaterial:function(){return new h},_createNode:function(){var t=100,i=200;this.nodeDim&&(t=this.nodeDim.width/(2*Math.PI),i=this.nodeDim.height);var o={bottomCenterPoint:new e.Vector3(0,0,-i),topCenterPoint:new e.Vector3(0,0,i),bottomRadius:t,topRadius:t,bottomCap:!1,topCap:!1},a=n.createCylinderCustomNode(o);return a.name="imgCylinderNode",a.setMatrix((new e.Matrix4).setPosition(new e.Vector3(0,0,0))),this.createdNode=a,a},applyKinematicConstraints:function(){var t=this.getImgData().computeImgRangeInSphericalCoord(),i=this.trackBall();i&&t&&(i.setKinematicConstraints(t),i.setApplyConstraints(!0))},removeKinematicConstraints:function(){var t=this.trackBall();t&&t.setApplyConstraints(!1)},_computeInitialView:function(t){var i=null,e=null;if(t){var n=t.computeMiddlePointSphericalCoord(),a=new o;i=a.ur({r:1,theta:n.x,phi:n.y}),e=a.uPhi({r:1,theta:n.x,phi:n.y}).multiplyScalar(-1)}return{sight:i,up:e}},_reframeOnInitialView:function(t){var i=this.getImgData();if(i&&i._img&&i._imgGeomData){var n=this._computeInitialView(i);n&&n.sight&&n.up&&this.viewpoint()&&this.viewpoint().moveTo({eyePosition:new e.Vector3,sightDirection:n.sight,upDirection:n.up,duration:t?500:0})}},_getVisiblePixelCoord:function(t){t=this.getImgData();var i=null,e=null,n=null,a=this.trackBall();if(a){var r=a.computeFieldOfViews(this.viewpoint()),s=r.hFov?r.hFov:0,h=r.vFov?r.vFov:0,l=this.viewpoint().getSightDirection(),c=(new o).getSPhericalCoordinates(l),u=c.theta-s/2,p=c.theta+s/2,d=c.phi-h/2,g=c.phi+h/2,v={theta:u,phi:g},m={theta:p,phi:g},f={theta:u,phi:d};i=t.pixelForThetaPhi(v),e=t.pixelForThetaPhi(m),n=t.pixelForThetaPhi(f)}return{bottomLeftPixel:i,bottomRightPixel:e,topLeftPixel:n}}})})),define("DS/3DPlay360Experiences/TrackballControlSpherical",["UWA/Class","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],(function(t,i,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(t){this._parent(t),this._applyKinematicConstraints=!1,this},dispose:function(){this._applyKinematicConstraints=null,this._parent(),null},setKinematicConstraints:function(){},_animateBackToBestViewpointCompliantWithConstraints:function(){},_setZoomForAngle:function(t){if(t){var i=t;i&&i>=this._userExpConfig.zoom.minFovDeg&&i<=this._userExpConfig.zoom.maxFovDeg&&(this.viewpoint().setAngle(i),this._onZoomCB&&this._onZoomCB())}},_computeViewpointForRotation:function(t){var i=null,e=null,n=null;if(t&&null!==t.dTheta&&null!==t.dPhi){var o=t.dTheta,a=t.dPhi,s=new r,h=s.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize()),l={r:1,theta:h.theta+o,phi:h.phi+a},c={min:.05,max:Math.PI-.05};l.phi=l.phi<c.min?c.min:l.phi,l.phi=l.phi>c.max?c.max:l.phi,n=this._viewpoint.getEyePosition(),i=s.getCartesianCoord(l),e=s.uPhi(l).multiplyScalar(-1)}return{eyePosition:n,sightDirection:i,upDirection:e}},startAnimation:function(t){if(this.stopInertia(),this.stopAnimation(),null===this._basicEventToken&&(this._basicEventToken=o.subscribe({event:"/VISU/onBasicEvent"},function(t){if(t)for(var i=0;i<t.from.length;i++){var e=t.from[i],n=e.getType(),o=e.getState();e instanceof a&&"Keyboard"!==n&&o===a.State.BEGIN&&this.stopAnimation()}}.bind(this))),null===this._animation){var i=new function(t){this._nbLoops=void 0!==t.animationData.nbLoops?t.animationData.nbLoops:5,this._duration=void 0!==t.animationData.duration?t.animationData.duration:1e4,this._T=this._duration/this._nbLoops,this._rotVect=t.viewpointData.rotVect,this._rotAngle=t.viewpointData.rotAngle,this._sightDir_t0=t.viewpointData.sightDir,this.duration=function(){return this._duration},this.valueAt=function(i){var e=i%this._T/this._T,n=new h.Matrix4;n.makeRotationAxis(this._rotVect,e*this._rotAngle);var o=this._sightDir_t0.clone();return o.applyMatrix4(n),{viewpoint:t.viewpointData.viewpoint,sightDir:o,eyePosition:new h.Vector3(0,0,0)}}}({animationData:{nbLoops:1,duration:1e5},viewpointData:{viewpoint:t,sightDir:new h.Vector3(1,0,0),rotVect:new h.Vector3(0,0,1),rotAngle:-2*Math.PI}});this._animation=new e(this,"viewpointAnimationCB",i)}this._animation&&(this._animation.setLoop(1),this._animation.start())},reframe:function(){var t,i=this.computeFieldOfViews(this.viewpoint()),e=i.vFov?i.vFov:0;t=this.defaultZoom?180*e/Math.PI:this._userExpConfig.zoom.maxFovDeg,this._setZoomForAngle(t),this.viewer&&this.viewer.render()}})})),define("DS/3DPlay360Experiences/ImgSphericalViewerController",["UWA/Class","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballControlSpherical","DS/3DPlay360Experiences/DirectionIndicatorSpherical","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialSpherical"],(function(t,i,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(t){this._parent(t),this._directionIndicator=new r({id:t.id,callback:t.callback})},dispose:function(){this._parent()},createTrackball:function(t){return new a({applyKinematicConstraints:!1,inertia:!0,size:t})},createMaterial:function(){return new h},_createNode:function(){var t={matrix:(new e.Matrix4).makeBasis(new e.Vector3(-1,0,0),new e.Vector3(0,-1,0),new e.Vector3(0,0,1)),radius:100},i=n.createSphereNode(t);return i.name="imgSphereNode",i.setMatrix((new e.Matrix4).setPosition(new e.Vector3(0,0,0))),this.createdNode=i,i},applyKinematicConstraints:function(){},removeKinematicConstraints:function(){var t=this.trackBall();t&&t.setApplyConstraints(!1)},_computeInitialView:function(t){var i=null,e=null;if(t){var n=t.computeMiddlePointSphericalCoord(),a=new o;i=a.ur({r:1,theta:n.x,phi:n.y}),e=a.uPhi({r:1,theta:n.x,phi:n.y}).multiplyScalar(-1)}return{sight:i,up:e}},_reframeOnInitialView:function(t){var i=this.getImgData();if(i&&i._img&&i._imgGeomData){var n=this._computeInitialView(i);n&&n.sight&&n.up&&this.viewpoint()&&this.viewpoint().moveTo({eyePosition:new e.Vector3,sightDirection:n.sight,upDirection:n.up,duration:t?500:0})}},_getVisiblePixelCoord:function(t){t=this.getImgData();var i=null,e=null,n=null,a=this.trackBall();if(a){var r=a.computeFieldOfViews(this.viewpoint()),s=r.hFov?r.hFov:0,h=r.vFov?r.vFov:0,l=this.viewpoint().getSightDirection(),c=(new o).getSPhericalCoordinates(l),u=c.theta-s/2,p=c.theta+s/2,d=c.phi-h/2,g=c.phi+h/2,v={theta:u,phi:g},m={theta:p,phi:g},f={theta:u,phi:d};i=t.pixelForThetaPhi(v),e=t.pixelForThetaPhi(m),n=t.pixelForThetaPhi(f)}return{bottomLeftPixel:i,bottomRightPixel:e,topLeftPixel:n}}})})),define("DS/3DPlay360Experiences/ProjectionTypeManager",["UWA/Class","DS/3DPlay360Experiences/ImgFlatViewerController","DS/3DPlay360Experiences/ImgSphericalViewerController","DS/3DPlay360Experiences/ImgCylindricalViewerController"],(function(t,i,e,n){"use strict";return t.extend({init:function(t){this.PROJECTION_TYPE={CYLINDRICAL:1,EQUIRECTANGULAR:2,PLANER:3},this.imgData=null,this._metadataProjection=t.projection,this._defaultProjType=this.decideDefault(t.size),this._currentProjType=this._defaultProjType,this.viewerControllerEnum={CYLINDRICAL:null,EQUIRECTANGULAR:null,PLANER:null},this._createImgViewerControllers(t)},decideDefault:function(t){if(this._metadataProjection&&"equirectangular"==this._metadataProjection)return this.PROJECTION_TYPE.EQUIRECTANGULAR;var i=this.PROJECTION_TYPE.EQUIRECTANGULAR;t&&t.height&&t.width&&(t.width/t.height>2&&(console.log("CYLINDRICAL"),i=this.PROJECTION_TYPE.CYLINDRICAL));return i},getdirectionIndicatorArray:function(){var t=[this.viewerControllerEnum.EQUIRECTANGULAR.getDirectionIndicatorData()];return this._metadataProjection&&"equirectangular"==this._metadataProjection||t.unshift(this.viewerControllerEnum.CYLINDRICAL.getDirectionIndicatorData()),t},dispose:function(){this.viewerControllerEnum={CYLINDRICAL:null,EQUIRECTANGULAR:null,PLANER:null},this._currentProjType=null,this.imgData=null,this._metadataProjection=null,this.PROJECTION_TYPE=null},getCurrProjeType:function(){return this._currentProjType},getProjeTypeList:function(){return this.PROJECTION_TYPE},getDefaultProjeType:function(){return this._defaultProjType},getDefaultVC:function(){return this.PROJECTION_TYPE.CYLINDRICAL===this._defaultProjType?this.viewerControllerEnum.CYLINDRICAL:this.PROJECTION_TYPE.EQUIRECTANGULAR===this._defaultProjType?this.viewerControllerEnum.EQUIRECTANGULAR:this.PROJECTION_TYPE.PLANER===this._defaultProjType?this.viewerControllerEnum.PLANER:null},checkProjectionType:function(t){return this._currentProjType||(this._currentProjType=this._defaultProjType),this.PROJECTION_TYPE[t]==this._currentProjType},changeProjType:function(t){return this._currentProjType=this.PROJECTION_TYPE[t],this._imgViewerController=this.viewerControllerEnum[t],this._imgViewerController},_createImgViewerControllers:function(t){for(var o=Object.keys(this.PROJECTION_TYPE),a={CYLINDRICAL:n,EQUIRECTANGULAR:e,PLANER:i},r=0;r<o.length;r++){var s=o[r];t.id=s,this.viewerControllerEnum[s]=new a[s](t),this.viewerControllerEnum[s].name=s}},getAllVCs:function(){return[this.viewerControllerEnum.EQUIRECTANGULAR,this.viewerControllerEnum.CYLINDRICAL,this.viewerControllerEnum.PLANER]}})})),define("DS/3DPlay360Experiences/Img360",["UWA/Class","DS/3DPlay360Experiences/ImgData","DS/3DPlay360Experiences/ProjectionTypeManager","DS/3DPlay360Experiences/DirectionIndicatorSwitch"],(function(t,i,e,n){"use strict";var o;return t.extend({init:function(t){o=this,this.countForDiIcon=0,this.countForImgVC=0,this.frmWindow=t.frmWindow,this._view=null,this._imgData=null,this._imgMaterial=null,this._directionIndicator=null,this._projectionTypeManager=this._createProjectionTypeManager({viewer:t.frmWindow.getViewer(),div:this._getView(),callback:this.callbackDiIcon,size:t.size,projection:t.projection}),this.frmWindow.getViewerFrame().addEvent("resize",this._onResize.bind(this))},_getView:function(){return this._view||(this._view=document.createElement("div"),this._view.style.width="100%",this._view.style.height="100%",this._view.className="img360"),this._view},setImg:function(t){if(t&&t.img){let e;this._imgData&&(this._imgData.dispose(),this._imgData=null);try{const i=t.canvas.getContext("webgl");if(e=i.getParameter(i.MAX_TEXTURE_SIZE),!e)throw new Error("No WebGL MAX_TEXTURE_SIZE parameter found")}catch(t){console.warn("Img 360 : Cannot check for WebGL max image size",t)}(t.img.width>e||t.img.height>e)&&(console.warn("Image's width or height greater than WebGL MAX_TEXTURE_SIZE. It will be resized to 50%."),this._resizeImage(t)),this._imgData=new i,this._imgData.setImg(t.img),this._imgData.setGeomData(t),this.iData={size:t.size}}else console.error("Image Data Not Found! "),console.log("Data : "+t)},_displayDefault:function(){this._imgViewerController=this._projectionTypeManager.getDefaultVC(),this._display(this._imgViewerController)},_getImgData:function(){return this._imgData},readyCB:function(t){this._readyCB=t},_readyVCForDisplay:function(t){t&&(console.log("IMG DATA"),console.time("[360 perfos] - Img Data Activation"),this._getImgData().activate().then(function(){return console.log("VIEWER CONTROLLER"),console.timeEnd("[360 perfos] - Img Data Activation"),t.setImgData(this._getImgData()),t.applyKinematicConstraints(),t.build(this.callbackImgVC.bind(this)),t.name}.bind(this)).then(function(t){return this._readyCB&&this._readyCB(t),Promise.resolve()}.bind(this)).catch((function(t){console.log(t)})))},callbackImgVC:function(){o.countForImgVC++,3===o.countForImgVC&&(o.hideAllVC(),o._displayDefault(),o.countForImgVC=0)},callbackDiIcon:function(){if(o.countForDiIcon++,3===o.countForDiIcon)var t=setInterval((function(){o._projectionTypeManager&&(clearInterval(t),o._projectionTypeSwitch=o._createSwitch(o.frmWindow),o._readyAllVCForDisplay({imgSize:o.iData.size}))}),100)},_display:function(t){t.activate(),t.trackBall().startAnimation(t.viewpoint()),this._displayOrientationIndicator(t),t.showNode()},_readyAllVCForDisplay:function(t){for(var i=this._projectionTypeManager.getAllVCs(),e=0;e<i.length;e++){var n=i[e];n&&(n.activate(t),this._readyVCForDisplay(n))}},hideAllVC:function(){for(var t=this._projectionTypeManager.getAllVCs(),i=0;i<t.length;i++){var e=t[i];e&&e.hide()}},_createProjectionTypeManager:function(t){return new e(t)},_createSwitch:function(){var t={func:this.changeImageViewerController.bind(this)},i=this._projectionTypeManager.getdirectionIndicatorArray();return new n({iData:t,frmWindow:this.frmWindow,directionIndicatorArray:i,defaultProjType:this._projectionTypeManager.getDefaultProjeType()})},changeImageViewerController:function(t){this._projectionTypeManager.checkProjectionType(t)||(this._imgViewerController&&this._imgViewerController.hide(),this._imgViewerController=this._projectionTypeManager.changeProjType(t),this._display(this._imgViewerController))},_cleanImgViewer:function(){this._imgViewerController&&(this._imgViewerController.dispose(),this._imgViewerController=null)},_displayOrientationIndicator:function(t){t&&t.displayDirIndicator()},dispose:function(){this._projectionTypeSwitch.destroy(),this._projectionTypeSwitch=null,this._readyCB=null,this._cleanImgViewer(),this._imgViewerController=null,this._imgMaterial&&(this._imgMaterial.dispose(),this._imgMaterial=null),this._imgData&&(this._imgData.dispose(),this._imgData=null),this._directionIndicator&&(this._directionIndicator.dispose(),this._directionIndicator=null),this._projectionTypeManager&&(this._projectionTypeManager.dispose(),this._projectionTypeManager=null),this._view=null,o&&(o=void 0)},_onResize:function(){console.log(this),this._projectionTypeSwitch&&this._projectionTypeSwitch.resetCurvedUIDiv(this._projectionTypeManager._currentProjType)},_sampleImgData:function(){this.PROJECTION_TYPE.EQUIRECTANGULAR;return{projectionType:this.PROJECTION_TYPE.CYLINDRICAL,croppedAreaImageWidthPixels:5200,croppedAreaImageHeightPixels:1760,fullPanoWidthPixels:10400,fullPanoHeightPixels:3520,croppedAreaLeftPixels:null,croppedAreaTopPixels:null}},_resizeImage:function(t){const i=document.createElement("canvas"),e=i.getContext("2d");i.width=t.img.width/2,i.height=t.img.height/2,e.drawImage(t.img,0,0,i.width,i.height),t.img.src=i.toDataURL("image/jpeg"),t.fullPanoWidthPixels=i.width,t.fullPanoHeightPixels=i.height,t.size.width=i.width,t.size.height=i.height,i.remove()}})})),define("DS/3DPlay360Experiences/3DPlay360Experience",["DS/3DPlayExperienceModule/PlayExperience3D","DS/WebSystem/App","DS/3DPlay360Experiences/Img360","DS/3DPlay360Experiences/MediaLoader"],(function(t,i,e,n){"use strict";return t.extend({init:function(t){this.ERROR_TYPE={unsupportedFormat:1,imageSize:2,loadingError:3},t.commandApplication=!1,t.workbenchs=[],this._filePath=null,this._img360=null,t&&t.options&&(t.options.splashscreen=t.options.splashscreen||{},t.options.splashscreen.waitloading=!0),this._parent(t),i.is3DPlay()&&this._hasLightbox&&t.workbenchs.push({name:"EnopadRightPanel_LightboxMode",module:"3DPlay"}),this.autoReframe=!1,this.showSplashBetweenLoad=!0,this.refreshImage360()},dispose:function(){this.refreshImage360(),this._parent()},img360:function(){return this._img360},onPreCreate:function(){},onPostCreate:function(){this.frmWindow&&(this._viewer=this.frmWindow.getViewer(),this._viewpoint=this.frmWindow.getViewpoint(),i.is3DPlay()&&this._hasLightbox&&this.frmWindow.getActionBar()&&this.frmWindow.getActionBar().hide())},_step:function(){},loadModel:function(t,i,n){if(t&&t.asset&&(t.asset.url||t.asset.filename)&&t.asset.format){this.refreshImage360();var o=t.asset.url?t.asset.url:t.asset.filename,a=void 0===n||n;this.onModelLoadingStarted(a),this.loadAndCheckImage({format:t.asset.format,path:o,dataBuffer:t.asset.dataBuffer,requestsOptions:t.asset.requestsOptions,projectionType:t.asset.projectionType}).then(function(t){t&&t.img&&t.imgData&&(this._img360||(this._img360=new e({frmWindow:this.frmWindow,size:t.size,projection:t.projection})),this.progress.updateProgression(50),this.img360().readyCB(function(t){this.modelName=t,this.onModelLoadingCompleted(),a&&this.onModelLoadingProgression({loaded:100,total:100}),Promise.resolve("Success")}.bind(this)),this.img360().setImg({img:t.img,projectionType:t.imgData.projectionType,fullPanoWidthPixels:t.imgData.fullPanoWidthPixels,fullPanoHeightPixels:t.imgData.fullPanoHeightPixels,croppedAreaImageWidthPixels:null,croppedAreaImageHeightPixels:null,croppedAreaLeftPixels:null,croppedAreaTopPixels:null,size:t.size?t.size:0,canvas:this._viewer.canvas}))}.bind(this)).catch(function(i){console.log(i),i&&i.errorType&&this.onError({error:{errorType:i.errorType,errorData:i.error},input:{format:t.asset.format,path:o}}),this.getPhaseProgress().hideProgressBar()}.bind(this))}},onError:function(t){var i=t;if(i&&i.error&&i.error.errorType)switch(i.error.errorType){case this.ERROR_TYPE.unsupportedFormat:case this.ERROR_TYPE.imageSize:this.onModelLoadingError({type:"FORMAT",url:"dummy."+i.input.format})}},loadAndCheckImage:function(t){return new Promise(function(i,e){if(t&&t.format&&t.path)if("jpg"===t.format||"jpeg"===t.format?t.format:null){console.time("[360 perfos] - Load img");var o=new n;o&&o.img(t).then(function(t){console.timeEnd("[360 perfos] - Load img"),i(t)}.bind(this)).catch(function(t){e({errorType:this.ERROR_TYPE.loadingError,error:t})}.bind(this))}else e({errorType:this.ERROR_TYPE.unsupportedFormat,error:t.format})}.bind(this))},refreshImage360:function(){this._img360&&(this._img360.dispose(),this._img360=null)}})}));