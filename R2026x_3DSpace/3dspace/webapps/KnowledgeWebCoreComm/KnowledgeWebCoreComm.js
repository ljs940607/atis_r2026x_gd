define("DS/KnowledgeWebCoreComm/comm",["DS/ExperienceKernel/ExperienceKernel","DS/KnowledgeWebUtils/Listenable","DS/KnowledgeWebCore/context","DS/KnowledgeWebUtils/Utils","DS/KnowledgeWebUtils/KnowledgeWebTrace","DS/UIKIT/Mask","i18n!DS/KnowledgeWebCoreComm/assets/nls/KnowledgeWebCoreComm.json","css!DS/KnowledgeWebCoreComm/assets/Style/comm.css"],(function(e,t,n,i,o,r,a){"use strict";const s=new t;function u(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/[\u00A0-\u9999]/gim,(function(e){return"&#"+e.charCodeAt(0)+";"})):e}function l(e){let t=null;if(window.ActiveXObject)t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(e);else{t=(new DOMParser).parseFromString(e,"text/xml")}return t}function c(...e){const t=n.getValue("Kconsole");t&&t.log&&t.log(...e)}var d={ids:[],cbs:[],add:function(e,t){0===this.ids.length&&s.notify("isWaitingForAnswer",!0),this.ids.push(e),this.cbs.push(t)},remove:function(e){var t=this.ids.indexOf(e);t>-1&&(this.cbs.splice(t,1),this.ids.splice(t,1)),0===this.ids.length&&s.notify("isWaitingForAnswer",!1)},get:function(e){var t,n=this.ids.indexOf(e);return n>-1&&(t=this.cbs[n]),t},getIndex:function(e){return this.cbs[e]},isWaitingForAnswer:function(){return this.ids.length>0}};Object.defineProperty(d,"length",{get:function(){return this.ids.length},set:function(){}});var h,f,g={},m={},p=new Map,v=new Map,y="",b="",C={status:!1,cb:[],check:function(){var e,t=!1;for(e=0;e<d.length&&!t;e++)d.cbs[e].displayWP&&(t=!0);if(C.status!==t)for(C.status=t,e=0;e<C.cb.length;e++)C.cb[e](C.status)}},x=/END:(\d*)/,w=null,A=[];function L(e){if(void 0!==e.notification){var t=e.notification.getAttr("name"),n="";if(""!==e.notification.getAttr("modeler")&&(n=e.notification.getAttr("modeler")),v.has(n))v.get(n).forEach((function(t){var n=t(e);void 0!==n&&(e=n)}));if(v.has("ALL"))v.get("ALL").forEach((function(t){var n=t(e);void 0!==n&&(e=n)}));if(void 0!==g[t]){for(var o=0;o<g[t].length;o++)b=t,i.isFunction(g[t][o])&&g[t][o](e);b="",g[r=t]&&g[r].length&&-1!==g[r].indexOf(null)&&(g[r]=g[r].filter(i.exists))}}var r;return e}function T(e,t){var n=x.exec(e);if(null!==n&&2===n.length)d.remove(parseInt(n[1])),w=null,null;else{var o=q(l(e));if(void 0!==o.notification){var r=o.notification.getAttr("name");c(e," > Notification : "+r,t),s.notify("io",{label:" > Notification : "+r,text:e}),o=L(o)}else{var a,u,h,f="",g="ALL";if(void 0!==o&&void 0!==o.response&&void 0!==o.response.cmdReturn){w=parseInt(o.response.getAttr("id")),(h=d.get(w))&&(u=h.obj);var v=[];o.response.cmdReturn.forEach((function(e,t){v.push(e.getAttr("name"))}));var b=[];o.response.cmdReturn.forEach((function(e,t){b.push(e.getAttr("modeler"))})),c(e," > Response id : "+w+" - modeler : "+b.join(", ")+" -> "+v.join(", "),t),s.notify("io",{label:" > Response id : "+w+" - modeler : "+b.join(", ")+" -> "+v.join(", "),text:e}),o.response.cmdReturn.forEach((function(e,n){f=e.getAttr("name"),""!==e.getAttr("modeler")&&(g=e.getAttr("modeler"));var r,s={};(s.response={},s.response["@attr"]=o["@attr"],s.response.getAttr=S.prototype.getAttr,s.response.cmdReturn=e,p.has(g))&&p.get(g).forEach((function(e){var t=e(s,u,w);void 0!==t&&(s=t)}));p.has("ALL")&&p.get("ALL").forEach((function(e){var t=e(s,u,w);void 0!==t&&(s=t)}));if(0===n?a=s:1===n?a=[a,s]:a.push(s),""!==f&&void 0!==m[f]){for(var l=0;l<m[f].length;l++)y=f,i.isFunction(m[f][l])&&m[f][l](s,u,w,t);y="",m[r=f]&&m[r].length&&-1!==m[r].indexOf(null)&&(m[r]=m[r].filter(i.exists))}}))}else c(e," > Empty or invalid message !",t),s.notify("io",{label:" > Empty or invalid message !",text:e});h&&h.onText&&h.onText(a,u,w)}}return C.check(),!0}function j(t){if(w){var n=d.get(w);if(c("cannot display binary"," > binary received for "+w),s.notify("io",{label:" > binary received for "+w,text:"cannot display binary"}),void 0!==n&&void 0!==n.onBinary){var i=new e.BinaryReader(t).dataView.buffer;n.onBinary(i)}}return!0}function N(e){o.log("KillGraphViewer"),o.log("onClose"),e||r.mask(document.body,a.ConnectionLost)}function S(e){this.tagName=e,this.children=[],this.objectType="MessageNode"}function q(e){var t,n,i,o,r,a,s,u=new S;if(1===e.nodeType){if(u.tagName=e.tagName,u["@attr"]={},e.attributes.length>0)for(n=0;n<e.attributes.length;n++)i=e.attributes.item(n),u["@attr"][i.nodeName]=i.value}else if(3===e.nodeType)u=e.nodeValue;else if(9===e.nodeType&&(u["@attr"]={},e.documentElement.attributes.length>0))for(n=0;n<e.documentElement.attributes.length;n++)i=e.documentElement.attributes[n],u["@attr"][i.name]=i.value;if(e.hasChildNodes())for(t=0;t<e.childNodes.length;t++)void 0===u[r=(o=e.childNodes.item(t)).nodeName]?(a=q(o),u[r]=a,u.children.push(a)):(void 0===u[r].push&&(s=u[r],u[r]=[],u[r].push(s)),a=q(o),u[r].push(a),u.children.push(a));return u}function V(e){return this.bName=e,this.content=[],this.modeler="",this}function D(){V.call(this,"request");var e=this;return this.id=Date.now(),this.toXml=function(){for(var t="<request id='"+e.id+"' modeler='"+e.modeler+"'>",n=0;n<e.content.length;n++)t+=e.content[n].toXml();return t+="</request>"},this}function O(e){V.call(this,"command");var t=this;return this.name=e,this.id=null,this.toXml=function(){for(var e="<command name='"+t.name+"'"+(t.id?" id='"+t.id+"'":"")+(t.requestsManager?" modeler='"+t.requestsManager.getModeler()+"'":"")+" >",n=0;n<t.content.length;n++)e+=t.content[n].toXml()+"";return e+="</command>"},this}function W(e){V.call(this,"value");var t=this;return this.name=e.name,this.type=e.type,this.value=e.value,this.unit=e.unit,this.channels=e.channels,this.toXml=function(){var e="<value";if(void 0!==t.name&&(e+=" name='"+t.name+"'"),void 0!==t.type&&(e+=" type='"+t.type+"'",this.unit&&(e+=" unit='"+t.unit+"'")),e+=">",void 0!==t.value&&0===t.content.length)e+=u(t.value)+"";else if(t.content.length>0)for(var n=0;n<t.content.length;n++)e+=t.content[n].toXml()+"";return e+="</value>"},this.toJSON=function(){if("List"===this.type){for(var e="[",t=0;t<this.content.length;t++)t>0&&(e+=", "),e+=this.content[t].toJSON();return e+="]"}return this.value},this}n.addListener((function(){n.getValue("CustomCommunicationChannel")&&(A&&A.length&&A.forEach((function(e){M.send(e.request,e.onText?e.onText:function(){},e.onBinary?e.onBinary:function(){},e.displayWP,e.obj)})),A=[])}),"CustomCommunicationChannelChanged"),S.prototype.get=function(e,t){var n;if(void 0!==this[e])if(this[e]instanceof Array){for(var i=0;i<this[e].length;i++)if(this[e][i].getAttr("name")===t){n=this[e][i];break}}else this[e].getAttr("name")===t&&(n=this[e]);return n},S.prototype.getAttr=function(e){return this["@attr"][e]},S.prototype.forEach=function(e){if(void 0!==this)if(this instanceof Array)for(var t=0;t<this.length;t++)e(this[t],t);else e(this,0)},V.prototype.add=function(e){this.content.push(e),e.requestsManager&&e.requestsManager.getModeler&&(this.modeler=e.requestsManager.getModeler())},V.prototype._streamSelectionReducer=function(e,t){return i.exists(t.channels[channelId])?e+JSON.stringify(t.channels[channelId]):i.isFunction(t.streamChannel)?e+t.streamChannel(channelId):e},V.prototype.streamChannel=function(e){let t=null;for(let n=0;n<this.content.length&&null===t;n++){let o=this.content[n];i.exists(o)&&(i.exists(o.channels)&&i.exists(o.channels[e])?t=o.channels[e]:i.isFunction(o.streamChannel)&&(t=o.streamChannel(e)))}return t},D.prototype=Object.create(V.prototype,{constructor:{value:D,enumerable:!1}}),D.prototype.getCommandsName=function(){for(var e=[],t=0;t<this.content.length;t++)e.push(this.content[t].name);return e},D.prototype.getCommands=function(){for(var e=[],t=0;t<this.content.length;t++){for(var n=this.content[t].name+"(",i=0;i<this.content[t].content.length;i++)i>0&&(n+=", "),n+=this.content[t].content[i].toJSON();n+=")",e.push(n)}return e},D.prototype.isReadOnly=function(){for(var e=!0,t=0;t<this.content.length&&e;t++)!0!==this.content[t].readonly&&(e=!1);return e},Object.defineProperty(D.prototype,"requireUpdate",{get:function(){for(var e=!1,t=0;t<this.content.length&&!e;t++)!0===this.content[t].requireUpdate&&(e=!0);return e},set:function(){}}),Object.defineProperty(D.prototype,"noAnswerDiffusion",{get:function(){return this.content.reduce(((e,t)=>e&&!!t.noAnswerDiffusion),!0)},set:function(){}}),O.prototype=Object.create(V.prototype,{constructor:{value:O,enumerable:!1}}),W.prototype=Object.create(V.prototype,{constructor:{value:W,enumerable:!1}});var M={popUpErrors:function(e){var t=e.response.cmdReturn.param;if(void 0!==t){var n=[];t instanceof Array||"Errors"===t.getAttr("name")&&(n=t.value.value);for(var i=0;i<n.length;i++){var o=/Line \d* : Evaluation error in relation [^\s]* (.*)/.exec(n[i]["#text"].replace("\n"," "));2===o.length?n[i]=o[1]:n[i]=n[i]["#text"]}}},addWaitingStatusCB:function(e){C.cb.push(e)},removeWaitingStatusCB:function(e){var t=C.cb.indexOf(e);t>-1&&C.cb.splice(t,1)},sendText:function(e,t,i,o,r,a,u){var l,g;void 0===r&&(r=!1),"EKCommunication"===n.getValue("CommunicationContext")?(t&&d.add(t,{onText:i,onBinary:o,displayWP:r,obj:a}),l=" < Request id : "+t,u&&(l+=" -> "+u.join(", ")),c(e,l),s.notify("io",{label:l,text:e}),h.sendText(f,e),C.check()):n.getValue("CustomCommunicationChannel")?(g=n.getValue("CustomCommunicationChannel"),t&&d.add(t,{onText:i,onBinary:o,displayWP:r,obj:a}),l=" < Request id : "+t,u&&(l+=" -> "+u.join(", ")),c(e,l),s.notify("io",{label:l,text:e}),g.sendText({text:e,readOnly:!1,requireUpdate:!0}),C.check()):(l=" < Request id : "+t,u&&(l+=" -> "+u.join(", ")),A.push({cbid:t,display:l,message:e,onText:i,onBinary:o,displayWP:r,obj:a}))},send:function(e,t,i,o,r){function a(e,t,n,i,o){var r="";if("object"==typeof e){var a=e.id;r=e.toXml();var u=e.getCommands(),l=" < Request id : "+a+" - modeler : "+e.modeler;a&&d.add(a,{onText:t,onBinary:n,displayWP:i,obj:o}),u&&(l+=" -> "+u.join(", ")),c(r,l),s.notify("io",{label:l,text:r})}else"string"==typeof e&&(r=e);return r}if(void 0===o&&(o=!1),"EKCommunication"===n.getValue("CommunicationContext")){var u=a(e,t,i,o,r);h.sendText(f,u),C.check()}else if("GenUXCommunication"===n.getValue("CommunicationContext")){u=a(e,t,i,o,r);let s=n.getValue("GraphMainManager");s&&s.sendMessage(e),C.check()}else if(n.getValue("CustomCommunicationChannel")){var l=n.getValue("CustomCommunicationChannel");u=a(e,t,i,o,r);void 0!==l.send&&"object"==typeof e?l.send(e):l.sendText(u),C.check()}else A.push({request:e,onText:t,onBinary:i,displayWP:o,obj:r})},startLongTransaction:function(e){const t=n.getValue("CustomCommunicationChannel");return t&&"function"==typeof t.startLongTransaction?t.startLongTransaction(e):Promise.reject()},endLongTransaction:function(e){const t=n.getValue("CustomCommunicationChannel");return t&&"function"==typeof t.endLongTransaction?t.endLongTransaction(e):Promise.reject()},addNotificationCallback:function(e,t){void 0===g[e]&&(g[e]=[]),g[e].push(t)},addAllNotificationCallback:function(e,t="ALL"){var n;v.has(t)?(n=v.get(t)).has(e)||n.add(e):(n=new Set([e]),v.set(t,n))},removeAllNotificationCallback:function(e,t="ALL"){if(v.has(t)){var n=v.get(t);n.has(e)&&n.delete(e),v.set(t,n)}},removeNotificationCallback:function(e,t){if(g&&e&&void 0!==g[e]){var n=g[e].indexOf(t);n>-1&&(b===e?g[e][n]=null:g[e].splice(n,1))}},addCommandCallback:function(e,t){void 0===m[e]&&(m[e]=[]),m[e].push(t)},removeCommandCallback:function(e,t){if(m&&e&&void 0!==m[e]){var n=m[e].indexOf(t);n>-1&&(y===e?m[e][n]=null:m[e].splice(n,1))}},addAllCommandCallback:function(e,t="ALL"){var n;p.has(t)?(n=p.get(t)).has(e)||n.add(e):(n=new Set([e]),p.set(t,n))},removeAllCommandCallback:function(e,t="ALL"){if(p.has(t)){var n=p.get(t);n.has(e)&&n.delete(e),p.set(t,n)}},getWaitingStatus:function(){return C.status}};return M.xmlEscape=u,M.MessageNode=S,M.Request=D,M.Command=O,M.Value=W,M.stringtoXML=l,M.xml2json=q,M.createNode=function(t,n){var i;i=void 0!==n?n:2097;var o=(h=new e.Node({onText:T,onBinary:j,onHypervisorDisconnect:N,hypervisorIp:t,webSocketPort:i,pool:"KnowledgeGraphClientPool"})).connect("KnowledgeGraphServerPool");return f=o.select(),h.sendTextOnDisconnection(f,"DISCONNECT"),h.subscribe(f,"Notification"),{id:f,createdNode:h}},M.onText=T,M.onBinary=j,M.listenable=s,M.onCommunicationConnect=function(){let e=document.body;if(r.isMasked(e)){e.getElement(" > .mask .text").innerText===a.ConnectionLost&&r.unmask(e)}},M.onCommunicationDisconnect=N,n.setValue("GraphCommunicationNode",M),n.setValue("KnowledgewareCommunicationNode",M),M})),define("DS/KnowledgeWebCoreComm/ToValueInterface",[],(function(){function e(){}return e.prototype.toValue=function(){return{name:"undefined",type:"undefined",value:"undefined"}},e})),define("DS/KnowledgeWebCoreComm/AppRequests",["DS/KnowledgeWebCoreComm/comm","DS/KnowledgeWebCoreComm/ToValueInterface","DS/KnowledgeWebUtils/Utils","DS/KnowledgeWebCore/KnowledgeMagnitudeServices"],(function(e,t,n,i){"use strict";class o{constructor(e){this._modeler=e.modeler,this._grouping={activated:!1,commands:[],textCBs:[],binCBs:[],textCB:function(){var e=this.textCBs;return this.textCBs=[],function(t,n,i){for(var o=0;o<e.length;o++)e[o]&&e[o](t,n,i)}},binCB:function(){}}}static buildRequest(t,n){var i;t instanceof Array||(t=[t]);var o=new e.Request;for(n&&(o.modeler=n),o.waiting=!1,i=0;i<t.length;i++)o.add(t[i]),o.waiting=o.waiting||t[i].waiting;return o}send(t,n,i,r){var a;t instanceof Array||(t=[t]);const s=t.filter((e=>e.isValid()));if(t.length!==s.length&&console.warn(t.length-s.length+" invalid resquests have been filtered."),!this._grouping.activated){const t=o.buildRequest(s,this._modeler);return e.send(t,n,i,t.waiting||r),t.id}for(a=0;a<s.length;a++)this._grouping.commands.push(s[a]),this._grouping.textCBs.push(n),this._grouping.binCBs.push(i)}sendAndWait(e,t,n,i,o){return new Promise((r=>{this._grouping.activated&&console.warn('Requests grouping activated but ignored because sendAndWait can not be grouped (from command "'+e+'")');var a=new this[e](t,o);i?this.send(a,null,r,n):this.send(a,r,null,n)}))}startGroup(){this._grouping.activated||(this._grouping.activated=!0,this._grouping.commands=[])}endGroup(e,t){this._grouping.textCBs.push(e),this._grouping.binCBs.push(t),this._grouping.activated&&(this._grouping.activated=!1,this._grouping.commands.length>0?this.send(this._grouping.commands,this._grouping.textCB(),t):n.isFunction(e)&&this._grouping.textCB()())}cancelGroup(){this._grouping.activated&&(this._grouping.activated=!0,this._grouping.commands=[])}endGroupAndWait(){return new Promise((e=>{this.endGroup(e)}))}endGroupAndDump(){let e=null;return this._grouping.activated&&(this._grouping.activated=!1,this._grouping.commands.length>0&&(e=o.buildRequest(this._grouping.commands))),e}static startLongTransaction(t){return e.startLongTransaction(t)}static endLongTransaction(t){return e.endLongTransaction(t)}getModeler(){return this._modeler}createCommand(e,i,o){const r=this;var s,u,l,c;o&&(s=o.waiting,u=o.readonly,l=o.requireUpdate,c=!!o.noAnswerDiffusion),r[e]=function(o,s){a.call(this,e,r),n.isObject(s)&&(n.isBoolean(s.requireUpdate)&&(this.requireUpdate=s.requireUpdate),this.noAnswerDiffusion=!!s.noAnswerDiffusion),o instanceof Array||(o=[o]);for(var u=0,l=0;l<i.length&&u<o.length;l++){var c=i[l].name,d=i[l].type,h=i[l].value,f=null;if(!(o[u]instanceof Object)||o[u]instanceof Array||n.implement(o[u],t)||(void 0!==o[u].name&&(c=o[u].name),void 0!==o[u].type&&(d=o[u].type),void 0!==o[u].value&&(h=o[u].value),void 0!==o[u].unit&&(f=o[u].unit),u++),void 0===c&&(c=o[u++]),void 0===d&&u<o.length&&(d=o[u++]),void 0===h&&u<o.length&&(void 0===(h=o[u++])?(h=null,d="NULL"):n.isObject(h)&&n.exists(h.value)&&n.exists(h.unit)&&(f=h.unit,h=h.value)),void 0!==c&&void 0!==d&&void 0!==h)if(i[l].repeatable&&h instanceof Array)for(var g=0;g<h.length;g++)this.addValue(c,d,h[g],f);else this.addValue(c,d,h,f)}return this},n.inherits(r[e],a),r[e].prototype.addParam=function(e,t){for(var n,o=0;o<i.length&&void 0===n;o++)i[o].name===e&&(n=i[o]);this.addValue(n.name,n.type,t)},r[e].prototype.waiting=s,u&&(r[e].prototype.readonly=u),r[e].prototype.requireUpdate=l,r[e].prototype.noAnswerDiffusion=c,r["send"+e]=function(t,n,i,o,a){var s=new r[e](t,a);return void 0!==o&&(s.waiting=o),r.send(s,n,i)}}}function r(o){var a,s,u,l,c={};o instanceof Object&&(o instanceof Array?(a="listError",s="String",u="cannot be treated without a type",l=void 0):(a=o.name,o.value instanceof Object?o.value instanceof Array?(s="List",l=o.value,u=void 0):n.implement(o.value,t)?(s=(o=o.value.toValue()).type,u=o.value):"Selection"===o.type&&(c.selection=o.value,s="Feature",u="Selection"):(s=o.type,u=o.value)));var d={name:a,type:s,value:u,channels:c};if(s&&i.isAMagnitude(s)&&(o.unit?d.unit=o.unit?.Name??i.getUnitFromLabel(s,o.unit).Name:d.unit=i.getUnitToDisplay(s).Name),e.Value.call(this,d),void 0===u&&void 0!==l&&l instanceof Array)for(var h=0;h<l.length;h++)this.add(new r({name:a+"."+h,type:o.type,value:l[h]}));return this}function a(t,n){return this.requestsManager=n,e.Command.call(this,t),this}return n.inherits(r,e.Value),Object.defineProperty(r.prototype,"valid",{get:function(){return this.content.reduce(((e,t)=>e&&!1!==t.valid),!0)&&n.exists(this.type)&&n.isString(this.type)&&""!==this.type}}),n.inherits(a,e.Command),a.prototype.addValue=function(e,t,n,i){this.add(new r({name:e,type:t,value:n,unit:i}))},a.prototype.addValues=function(e){for(var t=0;t<e.length;t++)e[t].name&&e[t].type&&e[t].value&&this.addValue(e[t].name,e[t].type,e[t].value)},a.prototype.send=function(e,t){this.requestsManager.send(this,e,t)},a.prototype.isValid=function(){return this.content.reduce(((e,t)=>e&&!1!==t.valid),!0)},o}));