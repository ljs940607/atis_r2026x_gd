var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebEWS/VCXEWSManagerBase",["require","exports","DS/CAT3DExpModel/XCTEWSObjectModeler","DS/CAT3DExpModel/CAT3DXModel","DS/VCXWebIO/VCXLogServices","DS/CoreEvents/Events","i18n!DS/VCXWebEWS/assets/nls/VCXWebEWS","DS/VCXWebSystem/VCXTimeOutPromise","DS/VCXWebComponents/VCXWebComponentBaseExperience"],(function(e,t,r,a,i,n,o,s,c){"use strict";c=__importDefault(c);class l extends c.default{constructor(){super(),this._physicalID=null,this.tokens={}}IsExperienceEWSReady(){let e=this._experienceBase.GetActiveChild();return!!this._ews&&e?.isValid&&!!this.GetCAT3DXModel().GetExperience()}async IsExperienceStarted(){const e=i.generateUUID();let t;i.memoryLog("IsExperienceStarted",!0,e);try{t=await s.resolveWithTimeout(2e4,await this.GetCAT3DXModel().IsExperienceStarted())}catch(e){throw new Error("Failed to check if experience is started")}return i.memoryLog("IsExperienceStarted",!1,e),t}GetExperience(){return this.GetCAT3DXModel().GetExperience()}GetCAT3DXModel(){return a}getExperiencePhysicalProduct(){return this._physicalID}set experiencePhysicalProduct(e){this._physicalID=e}async InsertProduct(e,t,r,a){return await this.GetCAT3DXModel().InsertProduct(e,t,r,a)}async UpdateStateCollection(e,t,r){}async CreateStateCollection(e,t){}async CreateState(e,t,r,a){}async UpdateState(e,t,r,a){}async DeleteState(e,t){}SaveExperience(e){return e?this.GetCAT3DXModel().SaveExperienceAsNew(e):this.GetCAT3DXModel().SaveExperience()}async CloseExperience(){if(this.GetCAT3DXModel().GetExperience())return this.GetCAT3DXModel().CloseExperience()}SendCommand(e){throw new Error("Not implemented here")}SendFunction(e){throw new Error("Not implemented here")}async initialize(){await this._initializeEws(),this.tokens["VCX/EXP/CREATE"]=n.subscribe({event:"VCX/EXP/CREATE"},(()=>{this._updateExpBase()})),this.tokens["VCX/EXP/CLOSE"]=n.subscribe({event:"VCX/EXP/CLOSE"},(()=>{this._updateExpBase()}))}_updateExpBase(){this._ews?.setExperienceBase(this._experienceBase.GetActiveChild())}async unInitialize(){if(Object.values(this.tokens).forEach((e=>n.unsubscribe(e))),this.tokens={},this._ews){try{await this._ews.dispose(),this._physicalID=null}catch(e){console.warn(e),console.warn("EWS UNINIT FAILED.")}delete this._ews}}async _initializeEws(){try{let e=await this.GetFactory(),t=new C;await t.initialize({experienceBase:this._experienceBase,factory:e,interfacesTable:this.GetEWSInterfacesTable(),componentsTable:this.GetEWSComponentsTable(),managersTable:this.GetEWSManagersTable()}),this._ews=t}catch(e){console.error(e),this._experienceBase.getManager("VCXNotificationManager").addNotification({level:"error",title:o["Notification.Error"],message:o["Notification.EWS.Message"]})}}GetEWSInterfacesTable(){return{CATIAlias:"DS/CAT3DExpModel/interfaces/CATIAlias",CATI3DExperienceObject:"DS/CAT3DExpModel/interfaces/CATI3DExperienceObject",CATI3DXAssetHolder:"DS/CAT3DExpModel/interfaces/CATI3DXAssetHolder",CATI3DXJSONProcessor:"DS/VIAIdeaExperienceScenarioModelWeb/interfaces/CATI3DXJSONProcessor",CATICXPResourcesMgr:"DS/CATCXPModel/interfaces/CATICXPResourcesMgr",CATI3DXPictureResourceAsset:"DS/StudioResourceModelWeb/interfaces/CATI3DXPictureResourceAsset",CATI3DXSoundResourceAsset:"DS/StudioResourceModelWeb/interfaces/CATI3DXSoundResourceAsset",CATI3DXURLResourceAsset:"DS/StudioResourceModelWeb/interfaces/CATI3DXURLResourceAsset",CATI3DXKeyframerResourceAsset:"DS/StudioResourceModelWeb/interfaces/CATI3DXKeyframerResourceAsset",CATI3DXAssetProperties:"DS/CATCXPModel/interfaces/CATI3DXAssetProperties",CATI3DXMaterialAsset:"DS/CAT3DExpMaterialWeb/interfaces/CATI3DXMaterialAsset",VCXIRessourceAsset:"DS/VCXWebDocManager/VCXIRessourceAsset"}}GetEWSComponentsTable(){return{Abstract3DExperienceObject_Spec:{extensions:{CATIAlias:"DS/CAT3DExpModel/extensions/CATEAlias",CATI3DExperienceObject:"DS/VCXWebComposer/CATE3DExperienceObjectNavigable",VCXIModelNavigable:"DS/WebApplicationBase/VCXAModelNavigable",CATI3DXAssetHolder:"DS/CAT3DExpModel/extensions/CATE3DXAssetHolder"}},CXPExperience_Spec:{extensions:{W3AISGNodeHolder:"DS/VCXWebComposer/VCXNodeHolderRoot",VCXIVisibility:"DS/VCXWebVisibility/VCXVisibility",VCXIModifiable:"DS/VCXWebEWS/VCXModifiableRoot",VCXIModifiableView:"DS/VCXWebEWS/VCXModifiableViewRoot",VCXISensible:"DS/VCXWebComposer/VCXASensible",VCXIModelNavigable:"DS/VCXWebComposer/VCXModelNavigableRoot",CATICXPResourcesMgr:"DS/CATCXPModel/extensions/CATECXPExperienceResourcesMgr"}},CXPCoveringMaterial_Spec:{extensions:{CATI3DExperienceObject:"DS/CAT3DExpModel/extensions/CATE3DExperienceObject",CATI3DXAssetProperties:"DS/CATCXPModel/extensions/CATE3DXAssetProperties"}},CXPMaterialApplication_Spec:{extensions:{CATI3DExperienceObject:"DS/CAT3DExpModel/extensions/CATE3DExperienceObject"}},ExpTrackManager_Spec:{extensions:{CATI3DExperienceObject:"DS/CAT3DExpModel/extensions/CATE3DExperienceObject",CATI3DXJSONProcessor:"DS/VCXWebExperienceLoader/CATE3DXJSONProcessorExpTrackManager_Spec",CATI3DXAssetHolder:"DS/CAT3DExpModel/extensions/CATE3DXAssetHolder"}},CXPPictureResource_Spec:{extensions:{CATI3DXPictureResourceAsset:"DS/StudioResourceModelWeb/extensions/CATE3DXPictureResourceAsset",VCXIRessourceAsset:"DS/VCXWebDocManager/VCXERessourcePictureAsset"}},CXPSoundResource_Spec:{extensions:{CATI3DXSoundResourceAsset:"DS/StudioResourceModelWeb/extensions/CATE3DXSoundResourceAsset"}},CXPURLResource_Spec:{extensions:{CATI3DXURLResourceAsset:"DS/StudioResourceModelWeb/extensions/CATE3DXURLResourceAsset",VCXIRessourceAsset:"DS/VCXWebDocManager/VCXERessourceURLAsset"}},CXPKeyframerResource_Spec:{extensions:{CATI3DXKeyframerResourceAsset:"DS/StudioResourceModelWeb/extensions/CATE3DXKeyframerResourceAsset",VCXIRessourceAsset:"DS/VCXWebDocManager/VCXERessourceKeyFramerAsset"}}}}GetEWSManagersTable(){return{}}}class C extends r{async _loadManagers(){}async _unloadManagers(){}}return Object.defineProperty(l.prototype,"componentType",{enumerable:!0,get:function(){return"VCXEWSManager"}}),l})),define("DS/VCXWebEWS/VCXModifiableRoot",["DS/VCXWebModifiablesImpl/VCXModifiableOccurrence","DS/VCXWebProperties/VCXPropertySet","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyGroup","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebProperties/VCXPropertyValueBoolean","i18n!DS/VCXWebModifiables/assets/nls/VCXWebModifiables"],(function(e,t,r,a,i,n,o,s){"use strict";return e.extend({init:function(){this._parent()},OnChangeProperty:function(e,t,r){if(r||(r={}),r.fromChildClass);else if(this.OnChangePropertyBegin(e,t))return!0;return"Actor.Name"===e?(this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varName",t.Value),!0):(r.fromChildClass=!0,this._parent(e,t,r))},GetProperty:function(e){var t=null;if("Actor.Name"===e){var a=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName");if(a){var o=new n;o.SetValue(a),t=new r(new i("Actor.Name",2,!1,s),o)}}else t=this._parent(e);return t},GetProperties:function(){var e=new t;return e.AddOrModifyProperty(this.GetProperty("Actor.Name")),e},OnChangePropertiesEnd:function(){}})})),define("DS/VCXWebEWS/interfaces/VCXICAT3DXModel",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("DS/VCXWebEWS/VCXIVolatileComponent",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebEWS/VCXExperienceServices",["require","exports","DS/VCXWebComponents/WebExtensionBaseExperience","DS/VCXWebIO/VCXLogServices","i18n!DS/VCXWebEWS/assets/nls/VCXWebEWS","DS/VCXWebPlatform/VCX3DSpaceServices","DS/VCXWebKernel/VCXNotificationManager"],(function(e,t,r,a,i,n,o){"use strict";o=__importDefault(o);class s{static async onLoadExperienceFromPhysicalID(e,t,r,c=void 0){var l=e.getManager("VCXGUIManager").getGettingStartedUI();let C;c&&(C=c.replace("ctx::",""));let p=e.getManager("VCXNotificationManager"),d=p.addProgressNotification({strObjectName:"",strAction:i["ProgressNotification.Init"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL}),u=await n.getObjectSecurityContextFromExperienceID(r);u&&(C=u,n.SetPreferredSecurityContext(u));let D={physicalID:r,strExperienceName:t,securityContext:C};l?.curtainFade();const V=a.generateUUID();a.memoryLog("Load Experience",!0,V,{name:t,parameterName:"experience"}),p.endProgressNotification(d),d=p.addProgressNotification({strObjectName:u.collabspace,strAction:i["ProgressNotification.ConnectTo"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL}),e=await s.CreateNewExperienceBase(e),p.endProgressNotification(d),D.experience=e,"record"===e.odt&&e.getManager("VCXODTManager").LogAPI("VCXOpenExperienceFromPLMId",{label:t,id:r}),d=p.addProgressNotification({strObjectName:t,strAction:i["ProgressNotification.Opening"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL,maskDisplayEnd:!0});try{D.catexperience=await e.getManager("VCXCAT3DXModelManager").LoadExperienceFromPhysicalID(r,t,C),p.endProgressNotification(d)}catch(t){if("replay"===e.odt)throw t;var X=t.message,f="",g="A crash occured.";let r=e.getManager("VCXEWSManager").GetScenarioType();throw-1!==X.indexOf(r)?(g="This type is not supported.",f="Hint : Please choose a "+r):"Some product's collabspace is not accessible. Please contact the experience owner."===t.message&&(g="Some product's collabspace is not accessible.",f="Please contact the experience owner."),console.log(X),p.endProgressNotification(d,!0),D.experience=await s.CloseExperienceAndReset(e,{level:"error",title:i["Notification.ExpCantOpen.Title"],subtitle:g,message:f},t),console.error(t),new Error(t)}return a.memoryLog("Load Experience",!1,V,{name:t,parameterName:"experience"}),l?.endLoadingExperience(),D}static async CreateNewExperienceBase(e){return this.CreateOrCloseExperienceBase(e,!0)}static async CreateOrCloseExperienceBase(e,t=!0){const r=e.getManager("VCXContextManager");t&&e.getManager("VCXContextManager").IsWAFR()&&await e.getManager("VCXContextManager").getFrameWindow().getExecutionContext().gotoApp();let a=e.webApplication;if(!a)throw new Error("Not WebApp");return e=r.isSupported("SupportWebApplicationBase")?t?await a.RequestNewExperienceBase():await a.RequestCloseExperienceBase():await a.requestNewExperienceBaseAsync(),window.location.href.includes("localhost")&&(window.expBase=e),e}static async CloseExperienceAndReset(e,t=void 0,r=void 0){try{try{await e.getManager("VCXEWSManager").CloseExperience()}catch(e){console.warn("Close failed")}var a=(e=await this.CreateOrCloseExperienceBase(e,!1)).getManager("VCXGUIManager").getGettingStartedUI();return a?.failLoadingExperience(),t&&e.getManager("VCXNotificationManager").addNotification(t),e}catch(e){throw console.error(e),new Error("CloseExperienceAndReset failed")}}static async _createNewExperience(e,t,r=!1,n=void 0){var c=!0;if(e.getManager("VCXContextManager").getRootComponent()){if(!n||"3dxml"!==n.type)return{experience:e,newExperienceCreated:!1};c=!1}var l=e.getManager("VCXGUIManager").getGettingStartedUI();l?.curtainFade();var C=null;let p=await e.getManager("VCXGUIManager").DisplayModalPanelInit(t,n,c);if("Close"===p)return p;if(!c)return p.newExperienceCreated=!1,p.experience=e,p;C=e.getManager("VCXNotificationManager").addProgressNotification({strObjectName:p.experienceName,strAction:i["ProgressNotification.Init"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL}),(e=await this.CreateNewExperienceBase(e)).getManager("VCXNotificationManager").endProgressNotification(C);const d=a.generateUUID();try{!p||void 0!==p.insertProducts&&!0!==p.insertProducts?p&&void 0!==p.insertProducts&&!1===p.insertProducts&&(C=e.getManager("VCXNotificationManager").addProgressNotification({strObjectName:p.collabspace,strAction:i["ProgressNotification.ConnectTo"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL}),a.memoryLog("CreateExperience",!0,d,{name:p.experienceName,parameterName:"experience"}),await e.getManager("VCXCAT3DXModelManager").CreateExperience(p.experienceName,p)):(C=e.getManager("VCXNotificationManager").addProgressNotification({strObjectName:p.collabspace,strAction:i["ProgressNotification.ConnectTo"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL}),a.memoryLog("CreateExperience",!0,d,{name:p.experienceName,parameterName:"experience"}),await e.getManager("VCXCAT3DXModelManager").CreateExperience(p.experienceName,p))}catch(t){throw console.log(t.message),await s.CloseExperienceAndReset(e,{level:"error",title:i["Notification.ExpCreationFailed.Title"]},t),t}return a.memoryLog("CreateExperience",!1,d,{name:p.experienceName,parameterName:"experience"}),r&&await e.getManager("VCXCAT3DXModelManager").OnEndLoading(!0),e.getManager("VCXNotificationManager").endProgressNotification(C),p.newExperienceCreated=c,p.experience=e,p}static async SessionRecover(e){var t=e.getManager("VCXContextManager").IsLocalMode(),r=e.getManager("VCXContextManager").getContextFromName("Cat3DXIntegration");if(t||!r)return e;let a=e.getManager("VCXNotificationManager"),n=a.addProgressNotification({strObjectName:"",strAction:i["ProgressNotification.Init"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL});e=await s.CreateNewExperienceBase(e),a.endProgressNotification(n);var c=e.getManager("VCXCAT3DXModelManager");n=a.addProgressNotification({strAction:i["ProgressNotification.Recovering"],maskDisplayAdd:o.default.FDisplayMode.CONSOLE|o.default.FDisplayMode.LOADINGPANEL,maskDisplayEnd:!0});try{await c.RetrieveExperienceFromServer(),a.endProgressNotification(n)}catch(t){throw e=await s.CloseExperienceAndReset(e,{level:"error",title:i["Notification.SessionNotRecovered.Title"]},t),a.endProgressNotification(n),t}return console.log("RetrieveExperienceFromServer done."),e}static async DisplaySaveBeforeCloseModal(e){try{let t=await e.getManager("VCXGUIManager").createSaveBeforeCloseModal();return"Close"===t?Promise.resolve():("Save"===t&&await e.getManager("VCXCAT3DXModelManager").SaveExperience(),await s.CloseExperienceAndReset(e))}catch(t){throw console.error(t),e.getManager("VCXNotificationManager").addNotification({level:"error",title:i["Notification.Error"],message:i["Notification.CloseExpFailed.Message"]}),t}}static async onCreateEmptyExperience(e,t=""){try{let a=await s._createNewExperience(e,t,!0);if("Close"===a)return a;a.newExperienceCreated&&(e=a.experience);var r=e.getManager("VCXGUIManager").getGettingStartedUI();return r?.endLoadingExperience(),a}catch(t){throw await s.CloseExperienceAndReset(e,{level:"error",title:i["Notification.NewExpCreationFailed.Title"]},t),t}}static async onDropProduct(e,t,r,a){let n,o=await s._createNewExperience(r,e);if("Close"===o)return o;o.newExperienceCreated&&(r=o.experience),"record"===r.odt&&r.getManager("VCXODTManager").LogAPI("VCXNewExperienceFromPLMId",{label:e,id:t});let c=!1;try{const s=r.getManager("VCXEWSManager"),l=s.getEmptyCsiParameters();l.writeString("plmId",t);const C=s.getEmptyCsiParameters();C.writeParameters("plmId","PLMID",l);const p=await s.SendFunction({name:"getPrototypeNameFromPLMIdFunc",parameters:C});if(!p||p&&"Model_VPMReference_Spec"!==p.readString("defaultPrototype"))throw new Error(i["Notification.Failed.NotSupported"]+" : "+a+"/"+p.readString("defaultPrototype"));c=!0,n=await r.getManager("VCXCAT3DXModelManager").InsertProduct(e,t,o),o.product=n}catch(e){let t=UWA.Element("div",{html:i[c?"Notification.FailedContent.Message":"Notification.Failed.NotSupported"]});const a={level:"error",title:i["Notification.Error"],subtitle:t,sticky:!0};o.newExperienceCreated?o.experience=await s.CloseExperienceAndReset(r,a,e):r.getManager("VCXNotificationManager").addNotification(a)}return o}static async onDropAmbience(e,t,r,a){var i=a.getManager("VCXGUIManager").getGettingStartedUI();let n=await s._createNewExperience(a,e);if("Close"===n)return n;n.newExperienceCreated&&(a=n.experience);let o=await a.getManager("VCXCAT3DXModelManager").InsertAmbience(e,r,t);return n.ambience=o,i?.endLoadingExperience(),n}static async onDropMaterial(e,t,r,a,i){var n=[];return a.getManager("VCXSelectionManager").ProcessComponentsFromSelection("CSO",(e=>{e.IsKindOf("VCXComponentOccurrenceComposer")&&(e.IsMesh()||a.getManager("VCXContextManager").isSupported("FullFeaturesOnNodes"))&&n.push(e)})),n.length?a.getManager("VCXCAT3DXModelManager").InsertMaterial(e,r,t,n):i&&i.length>0?a.getManager("VCXCAT3DXModelManager").InsertMaterial(e,r,t,i):void 0}static async handle3DXML(e,t){try{let r=e&&Object.keys(e)[0],i=await s._createNewExperience(t,r,!1,{type:"3dxml"});if("Close"===i)return i;i.newExperienceCreated&&(t=i.experience);const n=a.generateUUID();a.memoryLog("Insert3DXML",!0,n,{name:r,parameterName:"product"});let o=await t.getManager("VCXCAT3DXModelManager").Insert3DXML(e,i);return o=await s.treat3DXMLResults(o,t),a.memoryLog("Insert3DXML",!1,n,{name:r,parameterName:"product"}),o}catch(e){throw await s.CloseExperienceAndReset(t,{level:"error",title:i["Notification.NewExpCreationFailed.Title"]},e),e}}static async treat3DXMLResults(e,t){if(!e)return;let r=e.elementCounter;if(!r)return console.warn("no count of element was found"),e;let a=r.products,n=r.ambiences,o=r.materials,c=r.presentations;if(e.newExperienceCreated){let r=!1;e.insertFailed&&(r=!0),e.insertProducts||(r=!0),e.insertProducts&&0===e.productsToInsert.length&&(r=!0),r&&(t=await s.CloseExperienceAndReset(t),e.experience=t)}if(e.insertFailed){let e=UWA.Element("div",{html:i["Notification.InsertFailed.SubTitle"]});const r={level:"error",title:i["Notification.InsertFailed.Title"],subtitle:e,sticky:!0};t.getManager("VCXNotificationManager").addNotification(r)}else{let e=UWA.Element("div",{html:i["Notification.InsertOk.SubTitle"]+a+i["Notification.InsertOk.ProductCount"]+"- <b>"+n+i["Notification.InsertOk.AmbienceCount"]+"- <b>"+o+i["Notification.InsertOk.MaterialCount"]+"- <b>"+c+i["Notification.InsertOk.PresentationCount"]});const r={level:"info",title:i["Notification.InsertOk.Title"],subtitle:e,sticky:!0};t.getManager("VCXNotificationManager").addNotification(r)}return e}}return s}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebEWS/CATContextManager",["require","exports","DS/VCXWebExperienceBase/VCXContextManager"],(function(e,t,r){"use strict";r=__importDefault(r);class a extends r.default{initialize(){super.initialize(),this._rootInfos={componentType:"CXPExperience_Spec",productType:"Reference3D",name:"NewPresentation",id:"VCX_Root"}}getRootComponentName(){if(!this.getCat3DXIntegration())return super.getRootComponentName();let e=null,t=this.getRootComponent();if(t){let r=t.QueryInterface("VCXIModifiable")?.GetProperty("Actor.Name");e=r?.GetPropertyValue().GetValue()??null}return e||(e=super.getRootComponentName()),e}getRootComponent(){return this.getCat3DXIntegration()?(this._cRootComponent||(this._cRootComponent=this._experienceBase.getManager("VCXEWSManager").GetExperience()),this._cRootComponent):super.getRootComponent()}update(e){if(super.update(e),this.traverseGraphMustBePerformed&&this.useTraverseGraph){let e=this.getRootComponent();if(e){let t=e.QueryInterface("VCXIModelNavigable"),r=t?.getChildren();if(!r)return;for(let e=0;e<r.length;e++){let t=r[e].GetObject();t.TraverseGraph&&t.TraverseGraph(null,null,null,0)}}this.traverseGraphMustBePerformed=!1}}}return Object.defineProperty(a.prototype,"componentType",{enumerable:!0,get:()=>"VCXContextManager"}),a}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebEWS/VCXVolatileConversionHelper",["require","exports","DS/CoreEvents/Events","DS/WebComponentModeler/WebComponentBase"],(function(e,t,r,a){"use strict";a=__importDefault(a);return class{static transfertVolatileToPersitent(e,t,a,i=["CATI3DExperienceObject"]){r.publish({event:"VCX_VOLATILE_PERSISTENT_PRE",data:{component:t}});for(let e of Object.keys(t._instanciatedExtensions))i.includes(e)||(a._instanciatedExtensions[e]=t.QueryInterface(e),a.QueryInterface(e).SetObject(a));let n=t.GetID();const o=["_experienceBase","_instanciatedExtensions","_ID","_ePersistent"];Object.keys(t).filter((e=>!o.includes(e))).forEach((e=>a[e]=t[e])),t._instanciatedExtensions=[],Object.setPrototypeOf(t,new Proxy(a,{get:(e,t)=>"__isProxy"===t||("function"==typeof e[t]?e[t].bind(e):e[t])})),e.ComponentsMap.RemoveComponent(n,!1),e.ComponentsMap.SetAlias(a,n),r.publish({event:"VCX_VOLATILE_PERSISTENT_POST",data:{component:a}})}static transfertEWSInterfacesFromPersitent(e,t,i){const n=i.GetID();r.publish({event:"VCX_VOLATILE_PERSISTENT_PRE",data:{component:t}}),e.ComponentsMap.RemoveComponent(n),e.ComponentsMap.RemoveComponent(t.getPreviousComponentID()),e.ComponentsMap.AddComponent(t),t.SetID(n),e.ComponentsMap.AddComponent(t),t._instanciatedExtensions.CATI3DExperienceObject=i._instanciatedExtensions.CATI3DExperienceObject,i._instanciatedExtensions=[],t._instanciatedExtensions.CATI3DExperienceObject.SetObject(t),t.SetPersistency(i.GetPersistency()),i.SetPersistency(a.default.EPersistencyType.notPersistent),t._instanciatedExtensions.CATI3DExperienceObject._GetExpDataObject()._SetObjectModelerComponent(t),r.publish({event:"VCX_VOLATILE_PERSISTENT_POST",data:{component:t}})}static askForPersistency(e){let t=e.GetID();e.QueryInterface("VCXIReadiness")?.registerDomainPromise("persistency",new Promise((e=>{let a=r.subscribe({event:"VCX_VOLATILE_PERSISTENT_POST"},(i=>{i.component.getPreviousComponentID()===t&&(e(this),r.unsubscribe(a))}))}))),r.publish({event:"VCX_VOLATILE_PERSISTENT_REGISTERED",data:{component:this}})}}})),define("DS/VCXWebEWS/interfaces/CATI3DExpVCXObjectConvertor",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebEWS/VCXBaseVCXCXPConvertor",["require","exports","DS/CAT3DExpModel/interfaces/CATI3DExperienceObject","DS/Visualization/ThreeJS_DS","DS/VCXWebProperties/VCXColor","DS/VCXWebComponents/WebExtensionBaseExperience","DS/VCXWebProperties/VCXPropertyValuePoint","DS/VCXWebProperties/VCXPropertyValueInt","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebProperties/VCXPropertyValueColor"],(function(e,t,r,a,i,n,o,s,c,l,C,p){"use strict";i=__importDefault(i),n=__importDefault(n),o=__importDefault(o),s=__importDefault(s),c=__importDefault(c),l=__importDefault(l),C=__importDefault(C),p=__importDefault(p);class d extends n.default{constructor(){super(...arguments),this._tab=[]}Build(){return this._tab=[...this._computeTab()],this}_computeTab(){return[{variableName:"_varName",propertyName:"Actor.Name"}]}GetNeutralsFromVariables(e){let t=this.getTab();t&&t.forEach((t=>this._ProcessNeutralsFromVariables(e,{...t}))),this._variablesToProperties(e)}_ProcessNeutralsFromVariables(e,t){if(t.conversionDirection&&t.conversionDirection===d.ConversionType.VFN)return;if(e.GetProperty(t.propertyName))return;"Vector3"===t.type&&(t.variableName=[t.variableName+" X",t.variableName+" Y",t.variableName+" Z"],t.NFVFunction=(e,t)=>{let r=new a.Vector3(e[0],e[1],e[2]);return t.SetValue(r),!0});let r=this.variableToProperty(t.variableName,t.propertyName,t.NFVFunction);r&&e.AddOrModifyProperty(r)}_variablesToProperties(e){var t=this.QueryInterface("VCXIModifiable");for(var r in e.map)e.map.hasOwnProperty(r)&&t?.OnChangeProperty(r,e.map[r].GetPropertyValue())}UpdateVariablesFromNeutrals(e,t){let r=this.getTab();r&&r.forEach((r=>{r.conversionDirection&&r.conversionDirection===d.ConversionType.NFV||("Vector3"===(r={...r}).type&&(r.variableName=[r.variableName+" X",r.variableName+" Y",r.variableName+" Z"],r.VFNFunction=e=>{let t=e.GetValue();return[t.x,t.y,t.z]}),this.propertyToVariable(e,r.propertyName,t,r.variableName,r.VFNFunction))}))}_getMaterialVariableType(e){const t=this.QueryInterface("CATI3DExperienceObject");switch(t.GetVariableType(e)){case r.VarType.Integer:return s.default;case r.VarType.Double:return c.default;case r.VarType.String:return l.default;case r.VarType.Boolean:return C.default;case r.VarType.Color:return p.default}const a=t.GetValueByName(e);if(a)switch(a.GetType()){case"Color_Spec":return p.default;case"Vector3D_Spec":return o.default}}_getMaterialVariableValue(e,t){const a=e.QueryInterface("CATI3DExperienceObject"),n=a.GetVariableType(t),o=a.GetValueByName(t);if(void 0===o)return;switch(n){case r.VarType.Integer:case r.VarType.Double:case r.VarType.String:case r.VarType.Boolean:case r.VarType.Color:return o}const s=o.QueryInterface("CATI3DExperienceObject");switch(o.GetType()){case"Color_Spec":{let e=new i.default;return e.SetRGBA(s.GetValueByName("r")/255,s.GetValueByName("g")/255,s.GetValueByName("b")/255,s.GetValueByName("a")/255),e}case"Vector3D_Spec":return[s.GetValueByName("x"),s.GetValueByName("y"),s.GetValueByName("z")]}}_testVariable(e,t){return e.HasVariable(t)}variableToProperty(e,t,r){var a=this.QueryInterface("CATI3DExperienceObject");if(a){Array.isArray(e)||(e=[e]);let s=e.map((e=>this._testVariable(a,e)?this._getMaterialVariableValue(a,e):null));var i=this.QueryInterface("VCXIModifiable"),n=i?.GetProperty(t);if(n&&-1!=s.findIndex((e=>null!=e))){var o=n.Clone();if(r){if(!r(s,o.GetPropertyValue()))return null}else o.GetPropertyValue().SetValue(s[0]);return o}}return null}propertyToVariable(e,t,a,i,n){var o=this.QueryInterface("CATI3DExperienceObject");if(o){if(Array.isArray(i)||(i=[i]),i.find((e=>!o.HasVariable(e))))throw new Error("One variable is missing ! : "+i);var s=e.map[t];if(s){var c=s.GetPropertyValue().Value;let l=n?n(s.GetPropertyValue()):[c];if(l.length!==i.length)throw new Error("Mismatch varName varValues "+l+" / "+i);for(let e=0;e<l.length;e++){let t=i[e],n=o.GetVariableType(t),s=l[e];if(n===r.VarType.Object){let e=o.GetValueByName(t);switch(e.GetType()){case"Color_Spec":this._addIfDifferent(255*s.r,a,"r",e),this._addIfDifferent(255*s.g,a,"g",e),this._addIfDifferent(255*s.b,a,"b",e),this._addIfDifferent(255*s.a,a,"a",e);break;case"Vector3D_Spec":this._addIfDifferent(s.x,a,"x",e),this._addIfDifferent(s.y,a,"y",e),this._addIfDifferent(s.z,a,"z",e)}}else if(n===r.VarType.Color){let e=s.GetRGBA().map((e=>String(e).replace(".",",")));this._addIfDifferent(e,a,t)}else this._addIfDifferent(s,a,t)}e.RemoveProperty(t)}}return null}_addIfDifferent(e,t,r,a=this.GetObject()){let i=a.QueryInterface("CATI3DExperienceObject").GetValueByName(r);null!==i&&i.toString()===e.toString()||t.push({object:a,variableName:r,variableValues:e})}getTab(){return this._tab}}return function(e){let t;!function(e){e[e.BOTH=0]="BOTH",e[e.VFN=1]="VFN",e[e.NFV=2]="NFV"}(t=e.ConversionType||(e.ConversionType={}))}(d||(d={})),Object.defineProperty(d.prototype,"componentType",{enumerable:!0,get:function(){return"VCXBaseVCXCXPConvertor"}}),d})),define("DS/VCXWebEWS/interfaces/VCXResultExperienceStarted",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("DS/VCXWebEWS/VCXWebEWSDictionary",[],(function(){"use strict";var e={CATContextManager:{W3AIManager:"DS/WebApplicationBase/W3AAManager"},VCXActorDocManager:{CATI3DExperienceObject:"DS/CAT3DExpModel/extensions/CATE3DExperienceObject"},ExpTrackManager_Spec:{CATI3DExperienceObject:"DS/CAT3DExpModel/extensions/CATE3DExperienceObject",CATI3DXJSONProcessor:"DS/VCXWebExperienceLoader/CATE3DXJSONProcessorExpTrackManager_Spec",CATI3DXAssetHolder:"DS/CAT3DExpModel/extensions/CATE3DXAssetHolder"},AmbienceModel_Spec:{CATI3DXAssetHolder:"DS/CAT3DExpModel/extensions/CATE3DXAssetHolder",CATI3DExpVCXObjectConvertor:"DS/VCXWebDressup/VCXAmbience/AmbienceModelVCXCXPConvertor",CATI3DXAssetProperties:"DS/CATCXPModel/extensions/CATE3DXAssetProperties",CATI3DX3DActorAsset:"DS/CATCXPModel/extensions/CATE3DX3DActorAsset"},CXPCameraActor_Spec:{W3AISGNodeHolder:"DS/VCXWebDressup/VCXCamera/VCXCamera_SpecSGNodeHolder"},VCXDressup_Spec:{CATI3DExperienceObject:"DS/CAT3DExpModel/extensions/CATE3DExperienceObject"},VCXActorList_Spec:{CATI3DExperienceObject:"DS/CAT3DExpModel/extensions/CATE3DExperienceObject"},VCXInternalMaterial_Spec:{VCXIMaterialCache:"DS/VCXWebMaterials/VCXEInternalMaterialCache",VCXISelectBehavior:"DS/VCXWebDressup/VCXInternalMaterialSelectBehavior"},VCXVolatileCXPCoveringMaterial_Spec:{VCXIModelNavigable:"DS/WebApplicationBase/VCXAModelNavigable",VCXIModifiable:"DS/VCXWebDressup/VCXCoveringMaterial/VCXCoveringMaterialSpecModifiable",VCXIMaterialCache:"DS/VCXWebMaterials/VCXEVolatileCoveringMaterialCache",VCXIReadiness:"DS/WebApplicationBase/VCXAReadiness"},CXPCoveringMaterial_Spec:{VCXIModifiableView:"DS/VCXWebDressup/VCXCoveringMaterial/VCXCoveringMaterialSpecModifiableView",VCXIMaterialCache:"DS/VCXWebMaterials/VCXECoveringMaterialCache",VCXIModifiable:"DS/VCXWebDressup/VCXCoveringMaterial/VCXCoveringMaterialSpecModifiable",VCXITreeNode:"DS/VCXWebTreeExtensions/VCXTreeNodeCoveringMaterial",VCXISelectBehavior:"DS/VCXWebDressup/VCXCoveringMaterial/VCXCoveringMaterialSelectBehavior"},CXPRenderingFeature_Spec:{CATI3DExpVCXObjectConvertor:"DS/VCXWebDressup/CXPRenderingFeatureModelVCXCXPConvertor",VCXIModifiableView:"DS/VCXWebDressup/VCXRenderingFeatureModifiableView",VCXIModifiable:"DS/VCXWebDressup/VCXRenderingFeatureModelModifiable",VCXITreeNode:"DS/VCXWebTreeExtensions/VCXTreeNodeRenderingMaterial",VCXIVisibility:"DS/VCXWebVisibilityImpl/VCXVisibilityShow",CATIAlias:"DS/CAT3DExpModel/extensions/CATEAlias",CATI3DExperienceObject:"DS/VCXWebComposer/CATE3DExperienceObjectNavigable",VCXIModelNavigable:"DS/WebApplicationBase/VCXAModelNavigable",CATI3DXAssetHolder:"DS/CAT3DExpModel/extensions/CATE3DXAssetHolder"},VCXColor:{CATIAlias:"DS/CAT3DExpModel/extensions/CATEAlias",CATI3DExperienceObject:"DS/VCXWebComposer/CATE3DExperienceObjectNavigable",VCXIModelNavigable:"DS/WebApplicationBase/VCXAModelNavigable",CATI3DXAssetHolder:"DS/CAT3DExpModel/extensions/CATE3DXAssetHolder"},VCXComponentOccurrenceExperience:{CATI3DGeoVisu:"DS/VCXWeb3DMaster/VCXCATE3DGeoVisu"},VCXComponentOccurrenceExt:{CATI3DExpVCXObjectConvertor:"DS/VCXWebComposer/CATE3DExpVCXObjectConvertorOccurrence"}},t={VCXIMaterialCache:"DS/VCXWebKernel/VCXIMaterialCache",CATI3DExpVCXObjectConvertor:"DS/CAT3DExpModel/interfaces/CATI3DExpVCXObjectConvertor"},r={VCXContextManager:"DS/VCXWebEWS/CATContextManager",VCXInternalMaterial_Spec:"DS/VCXWebMaterials/VCXInternalMaterial_Spec",VCXVolatileCXPCoveringMaterial_Spec:"DS/VCXWebMaterials/VCXVolatileCXPCoveringMaterial_Spec",CXPRenderingFeature_Spec:"DS/VCXWebMaterials/CXPRenderingFeature_Spec",CATI3DGeoVisu:"DS/CAT3DExpModel/interfaces/CATI3DGeoVisu"};return{GetDictionary:function(){return{interfaces:t,components:r,extensions:e}}}})),define("DS/VCXWebEWS/VCXModifiableViewRoot",["DS/VCXWebModifiablesImpl/VCXModifiableViewOccurrence","DS/VCXWebProperties/VCXPropertyGroup","i18n!DS/VCXWebModifiables/assets/nls/VCXWebModifiables","i18n!DS/VCXWebEWS/assets/nls/VCXWebEWS"],(function(e,t,r,a){"use strict";return e.extend({init:function(){this._parent()},getPropertyGroups:function(e){e||(e={});var i=this.getGroupPropertiesOrders();return e["Group.Essentials"]||(e["Group.Essentials"]=new t({groupID:"Group.Essentials"}),e["Group.Essentials"].i18nGroup=r),e["Group.Essentials"].setPropertiesOrder(i["Group.Essentials"]),e["Group.Essentials"].priority=0,e["Group.Essentials"].addProperties([{propertyName:"Actor.Name",i18n:a}]),e},getGroupPropertiesOrders:function(){return{"Group.Essentials":["Actor.Name"]}}})}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebEWS/VCXVolatileComponentOccurrenceComposer",["require","exports","DS/VCXWeb3DMaster/VCXComponentOccurrenceComposer","DS/VCXWebEWS/VCXVolatileConversionHelper"],(function(e,t,r,a){"use strict";r=__importDefault(r),a=__importDefault(a);class i extends r.default{constructor(){super(...arguments),this._previousComponentID="",this._registeredToPersistent=!1,this._isVolatileListeningToProperties=!1}setPersistentComponent(e){this._previousComponentID=this.GetID(),this._experienceBase.getManager("VCXContextManager").isSupported("VCXOverrideOnDemandTransfertV2")?(e.getPreviousComponentID=()=>this._previousComponentID,a.default.transfertVolatileToPersitent(this._experienceBase,this,e)):a.default.transfertEWSInterfacesFromPersitent(this._experienceBase,this,e)}registerToPersistent(){if(!this._registeredToPersistent){this._registeredToPersistent=!0,a.default.askForPersistency(this);var e=this._experienceBase.getManager("VCXCAT3DXModelManager");e&&e.registerVolatileToPeristentCandidate(this)}return this.QueryInterface("VCXIReadiness")?.isReady("persistency")??Promise.resolve()}isRegisteredToPersistent(){return this._registeredToPersistent}getPreviousComponentID(){return this._previousComponentID}}return Object.defineProperty(i.prototype,"componentType",{enumerable:!0,get:()=>"VCXVolatileComponentOccurrenceComposer"}),i}));