<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">

<head>

    <link rel="stylesheet" href="GlobeViewer2D.css" />
    <link rel="stylesheet" href="test.css" />

    <!-- AMDLoader -->
    <script type="text/javascript" src="../AmdLoader/AmdLoader.js"></script>
    <script type="text/javascript" src="../WebappsUtils/WebappsUtils.js"></script>

    <!-- UWA -->
    <script type="text/javascript" src="../c/UWA/js/UWA_Standalone_Alone.js"></script>

    <!--script type="text/javascript" src="../WebUX/WebUX.js"></script>
    <script type="text/javascript" src="../WebVisualization/WebVisualization.js"></script>
    <script type="text/javascript" src="../SocialGlobe/SocialGlobe.js"></script>
    <script type="text/javascript" src="../SocialGlobe/Globe.js"></script-->

    <!-- <script src="GlobeViewer2D.js"></script> -->

    <script>
        require(["DS/SocialGlobeAPI/GlobeAPI",
        "DS/SocialGlobeAPI/Model/Link",
        "DS/SocialGlobeAPI/Manager/LinkManager",
        "UWA/Class/Model",
        ], function (GlobeAPI, Link, LinkManager, Model) {
            const geoJson = {
  "type": "FeatureCollection",
  "representation" : "heatmap",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501fe931bb929ea5ff8e",
        "amount1": 849,
        "amount2": 5
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          0.2002,
          47.4148
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501ffdf685fb0c99c24c",
        "amount1": 795,
        "amount2": 4
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          -1.0419,
          46.9666
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501ffa8b70987a23fbcc",
        "amount1": 899,
        "amount2": 3
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          5.1978,
          44.2068
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501fdb1bdce01fc943d4",
        "amount1": 698,
        "amount2": 3
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          -2.9279,
          45.3291
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f9ac545834a11a517",
        "amount1": 638,
        "amount2": 8
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          0.5258,
          44.6454
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f4213d7a5c9ac5c2c",
        "amount1": 361,
        "amount2": 2
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          0.6799,
          45.502
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f9157436126728c82",
        "amount1": 920,
        "amount2": 4
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          2.2112,
          43.6739
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501ffe2bf24f8dc1ba6c",
        "amount1": 636,
        "amount2": 6
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          2.6328,
          49.4206
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f1a644e528ebcc270",
        "amount1": 386,
        "amount2": 1
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          1.9934,
          44.9021
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f89077f52c69dea46",
        "amount1": 925,
        "amount2": 4
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          -2.9639,
          45.4878
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f596c36b03ecce331",
        "amount1": 155,
        "amount2": 9
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          1.814,
          48.3594
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501fa840d9c850a55dc7",
        "amount1": 479,
        "amount2": 8
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          -2.5925,
          43.7605
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f4ad1eee0d86e33c9",
        "amount1": 321,
        "amount2": 7
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          3.1741,
          46.2624
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f68a6cd78e3ca6bdb",
        "amount1": 612,
        "amount2": 6
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          -0.4766,
          48.4593
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "_id": "62a0501f94400792a2e55601",
        "amount1": 337,
        "amount2": 3
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          -2.5709,
          47.8434
        ]
      }
    }]
  };
			// SET DELAY FOR TESTS
			function sleep(ms) {
				return new Promise(
				resolve => setTimeout(resolve, ms)
				);
			}
			function getContent(url){
				// read text from URL location
				var request = new XMLHttpRequest();
				request.withCredentials = true;
				request.open('GET', url, true);
				request.send(null);
				request.onreadystatechange = function () {
					if (request.readyState === 4 && request.status === 200) {
						var type = request.getResponseHeader('Content-Type');
						if (type.indexOf("text") !== 1) {
							return request.responseText;
						}
					}
				}
			}

      var geocodingUrl = "https://3dmap-geocoding.uwglobe.com/nominatim/search.php";
			
				var options = {
					initialCoordinates: [48.786192,2.210616],
					initialZoomLevel: 8,
					// tmsUrl: "https://tile.openstreetmap.org/",
					tmsMaxLevel: 19,
					geocodingServiceUrl: geocodingUrl
				};
			
			async function launchTest() {
				
				// init the map
				var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);
        console.log("Yo");
				await sleep(2000);
				globeMap.addGeoJson(geoJson);
        await sleep(2000);
        /*globeMap.display("bubble",{
          sizePropertyName: "amount1",
          scale: 2,
          primaryColor: " #ff5733",
          strokeColor: "lightgreen",
          strokeWidth: 3
        });
        await sleep(2000);
        console.log("Yo")
        globeMap.display("bubble", {
          sizePropertyName: "amount1",
          scale: 4,
          primaryColor: "steelblue",
          strokeColor: "lightgreen",
          strokeWidth: 1
        })
        await sleep(2000);
        console.log("Yo")
        globeMap.display("clustering");
        await sleep(2000);
        console.log("Yo")
        globeMap.display("default");
				await sleep(2000);
        console.log("Yo")
        globeMap.display("bubble", {
          sizePropertyName: "amount1",
          gradiantSettings: {
            colorPropertyName: "amount2",
            secondaryColor: "purple"
          }
        })
        await sleep(2000);
        console.log("Yo")
        globeMap.display("std");
        // console.log("link");
        // globeMap.setEditMode("link");
        // await sleep(5000);
        // console.log("default");
        // globeMap.setEditMode("default");*/
		
		var marker1 = globeMap.addMarker(48.13729150787028, -1.6215134739695942, "Dassault Systemes", "Cesson Sevigne Office",{color: "#0000ff"});
		var marker2 = globeMap.addMarker(48.13729150787028, -1.6185, "Dassault Systemes 2", "Cesson Sevigne Office", {});
		var marker3 = globeMap.addMarker(48.1375, -1.6187, "Dassault Systemes 3", "Cesson Sevigne Office", {"color": "#00ff00"});
		
		
		// add connections
		var conn1 = globeMap.addLink([marker1, marker3], {"color": "#ff0000",
    "pattern": "dashdotted",
    "icon": "user-change",
    popup: { trigger: "both", content: () => "BOTH POPUP"},
    "desc": "this is my description"
  });
  globeMap.moveCamera(48.13729150787028, -1.6215134739695942, { zoomLevel: 16});
    var conn2 = globeMap.addLink([marker1, marker2], {"color": "#00ff00",
      "pattern": "dashed",
      popup: { trigger: "click", content: () => "Generated Bonsoir"},
      "bidirectional": true
    });
    await sleep(2000);
    conn2.setIcon("record");
    await sleep(2000);
    conn1.setIcon();
    marker1.setIcon("user-change");
    // globeMap.setEditMode("link");
    await sleep(2000);
    globeMap.removeLink(conn1);
  }

  async function launchTest2() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);
    globeMap.addGeoJson(geoJson);
    globeMap.setEditMode("link");
    // await sleep(3000);
    // globeMap.setEditMode("default");

    // globeMap.reset();
  }

  async function launchTest_New_MarkerStyling() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);

    var marker1 = globeMap.addMarker(48.13729150787028, -1.6215134739695942, "Dassault Systemes", "Cesson Sevigne Office", {
      "icon": "record", 
      "notification": {"text": 19, "color": "#ff0000"}, 
      "badge": {"icon":"home", color: "red"}, 
      color: "purple",
      popup: { trigger: "both", content: "<h2>Bonsoir</h2>"}
    });
    var marker2 = globeMap.addMarker(48.13729150787028, -1.6185, "Dassault Systemes 2", "Cesson Sevigne Office", {
      "notification": {"text": "7", "color": "#0000ff"}, 
      "icon": "user",
      popup: { trigger: "click", content: () => "Generated Bonsoir"}
    });
    var marker3 = globeMap.addMarker(48.1375, -1.6187, "Dassault Systemes 3", "Cesson Sevigne Office", {
      "color": "#00ff00", 
      "badge": {"color": "#A0522D"},
      popup: { trigger: "hover", content: () => " generated Hover"}
    });
    globeMap.moveCamera(48.13729150787028, -1.6215134739695942, { zoomLevel: 16});

    await sleep(5000);
    globeMap.removeMarker(marker3);
    // globeMap.setEditMode("link");
  }

  async function testReproj() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);

    globeMap.proj({x:-180507.2366240,y:6129749.2448020}, "EPSG:900913", "EPSG:27561", false).then(function (reprojCoords) {
      console.log("reprojected coords: " + reprojCoords.x + " - " + reprojCoords.y);
    });
  }

  async function testSVG() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);

    var marker3 = globeMap.addMarker(48.1375, -1.6187, "Dassault Systemes 3", "Cesson Sevigne Office", {
      "color": "#00ff00", 
      "badge": {"color": "#A0522D"},
      popup: { trigger: "hover", content: () => " generated Hover"}
    });
    globeMap.addSVGMarker(48.786192,2.210616)
  }

  async function testFitBounds() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);
    const bounds = [[48, 2], [49, -2]];

    await sleep(2000);
    globeMap.fitBounds(bounds);
    globeMap.display("bubble", {});
  }

  function testRequire(path) {
    const a = require(path);

    console.log("out require");
    const b = new a();
    console.log(b, b.get("type"));
  }

  async function testDisplayMode() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);
    await sleep(2000);
    const a = globeMap.addGeoJson(geoJson);
    a.forEach((m) => m.setPopup({ trigger: "click", content: "bonsoir"}))
    await sleep(6000);
    // globeMap.display("clustering", {});
    await sleep(2000);
    // globeMap.display("bubble",{
    //     sizePropertyName: "amount1",
    //     scale: 2,
    //     color: "#ff5733",
    //     strokeColor: "lightgreen",
    //     strokeWidth: 3,
    //     popup: {
    //       trigger: "click",
    //       content: (m) => {
    //         const id = m.getId();

    //         console.log(`id = ${id}`);
    //         return id;
    //       }
    //     },
    //     onSelect: (bi) => console.log("select", bi),
    //     onUnSelect: (bi) => console.log("unselect", bi),
    //   });
    // globeMap.display("bubble",{
    //     sizePropertyName: "amount1",
    //     scale: 2,
    //     color: {
    //       interpolationType: "threshold",
    //       colorPropertyName: "amount2",
    //       colors: [
    //         {
    //           color: "#000000",
    //           stopValue: "0%"
    //         },
    //         {
    //           color: "#FF00FF",
    //           stopValue: "50%"
    //         },
    //         {
    //           color: "#FFFFFF",
    //           stopValue: "100%"
    //         },
    //       ]
    //     },
    //     strokeColor: "lightgreen",
    //     strokeWidth: 3,
    //     popup: {
    //       trigger: "click",
    //       content: (bi) => {
    //         const id = bi.marker.getId();

    //         return id;
    //       }
    //     },
    // globeMap.display("extent");
    // await sleep(50000);
    globeMap.display("bubble",{
        sizePropertyName: "amount1",
        scale: 2,
        color: {
          interpolationType: "threshold",
          colorPropertyName: "amount2",
          colors: [
            {
              color: "#000000",
              stopValue: "15%"
            },
            {
              color: "#101023",
              stopValue: "45%"
            },
            {
              color: "#212324",
              stopValue: "55%"
            },
            {
              color: "#1324ff",
              stopValue: "75%"
            },
            {
              color: "#31ba11",
              stopValue: "100%"
            },
          ]
        },
        strokeColor: "lightgreen",
        strokeWidth: 3,
        popup: {
          trigger: "click",
          content: (bi) => {
            const id = bi.marker.getId();

            return id;
          }
        },
        onSelect: (bi) => console.log("select", bi),
        onUnSelect: (bi) => console.log("unselect", bi),
      });
    // console.log("Yo")
    // globeMap.display("bubble", {
    //   sizePropertyName: "amount1",
    //   scale: 4,
    //   primaryColor: "steelblue",
    //   strokeColor: "lightgreen",
    //   strokeWidth: 1
    // })
    // await sleep(2000);
    // console.log("Yo")
    // globeMap.display("clustering");
    // await sleep(2000);
    // console.log("Yo")
    // globeMap.display("default");
    // await sleep(2000);
    // console.log("Yo")
    // globeMap.display("bubble", {
    //   sizePropertyName: "amount1",
    //   gradiantSettings: {
    //     colorPropertyName: "amount2",
    //     secondaryColor: "purple"
    //   }
    // });
    // await sleep(2000);
    // globeMap.display();
    return globeMap;
  }

  async function testClickListeners() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);
    const cb = (lat, lon) => console.log(`lat: ${lat}, lon: ${lon}`);

    globeMap.setOnClickCallback(cb);
    await sleep(5000);
    console.log("new CB");
    globeMap.setOnClickCallback((lat, lon) => console.log(`lon: ${lon}, lat: ${lat} _ New`));
    await sleep(5000);
    console.log("without CB");
    globeMap.unsetClickCallback(cb);
  }

  async function testClickFeature() {
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);
    const globeOnSelectCB = (f) => console.log(`GlobeOnSelectCB _ ${f.getTitle()}`);
    const globeOnUnSelectCB = (f) => console.log(`GlobeOnUNSelectCB _ ${f.getTitle()} _ UNSELECT`);
    const globeOnSelectCB2 = (f) => console.log(`GlobeOnSelectCB _ ${f.getTitle()}  ____ 2`);
    const globeOnUnSelectCB2 = (f) => console.log(`GlobeOnUNSelectCB _ ${f.getTitle()} _ UNSELECT  ____ 2`);
    const markerOnSelectCB = (f) => console.log(`MarkerOnSelectCB _ ${f.getTitle()}`);
    const markerOnUnSelectCB = (f) => console.log(`MarkerOnUNSelectCB _ ${f.getTitle()} _ UNSELECT`);
    const markerOnSelectCB2 = (f) => console.log(`MarkerOnSelectCB _ ${f.getTitle()} ____ 2`);
    const markerOnUnSelectCB2 = (f) => console.log(`MarkerOnUNSelectCB _ ${f.getTitle()} _ UNSELECT ____ 2`);
    

    var marker1 = globeMap.addMarker(48.13729150787028, -1.6215134739695942, "Dassault Systemes", "Cesson Sevigne Office", {
      "icon": "record", 
      "notification": {"text": 19, "color": "#ff0000"}, 
      "badge": {"icon":"home", color: "red"}, 
      color: "purple",
      popup: { trigger: "both", content: "<h2>Bonsoir</h2>"}
    });
    var marker2 = globeMap.addMarker(48.13729150787028, -1.6185, "Dassault Systemes 2", "Cesson Sevigne Office", {
      "notification": {"text": "7", "color": "#0000ff"}, 
      "icon": "user",
      popup: { trigger: "click", content: () => "Generated Bonsoir"}
    });

    globeMap.moveCamera(48.13729150787028, -1.6215134739695942, { zoomLevel: 16});
    console.log("INIT");
    globeMap.setOnSelectCallback(globeOnSelectCB);
    globeMap.setOnUnSelectCallback(globeOnUnSelectCB)
    marker1.setOnSelectCallback(markerOnSelectCB);
    marker2.setOnSelectCallback(markerOnSelectCB);
    marker1.setOnUnSelectCallback(markerOnUnSelectCB);
    marker2.setOnUnSelectCallback(markerOnUnSelectCB);
    await sleep(15000);
    console.log("add");
    globeMap.setOnSelectCallback(globeOnSelectCB2);
    globeMap.setOnUnSelectCallback(globeOnUnSelectCB2)
    marker1.setOnSelectCallback(markerOnSelectCB2);
    marker2.setOnSelectCallback(markerOnSelectCB2);
    marker1.setOnUnSelectCallback(markerOnUnSelectCB2);
    marker2.setOnUnSelectCallback(markerOnUnSelectCB2);
    await sleep(15000);
    console.log("remove");
    globeMap.unsetOnSelectCallback(globeOnSelectCB);
    globeMap.unsetOnUnSelectCallback(globeOnUnSelectCB)
    marker1.unsetOnSelectCallback(markerOnSelectCB);
    marker2.unsetOnSelectCallback(markerOnSelectCB2);
    marker1.unsetOnUnSelectCallback(markerOnUnSelectCB2);
    marker2.unsetOnUnSelectCallback(markerOnUnSelectCB);
  }

  function testModel() {
    const MyModel = Model.extend({

      loadData: function() {
        const self = this;

        setTimeout(() => {
          self.fire("test:toto", { data: 10})
        }, 1000);
      }
    });
    const instance = new MyModel();
    instance.on("test:toto", ({ data }) => cnsole.log(`My test: ${data}`));
  }

  async function testWithoutTms() { 
    var globeMap = await GlobeAPI.build("left-map", "devopspx2mchy26131936", options);
  }
  // testClickFeature();
  var globeMap = testWithoutTms();
  // var globeMap = testDisplayMode();
  // testRequire("DS/SocialGlobeAPI/Model/Link");
});
    </script>



</head>

<body>
    <div>
        <div id="left-map">
        </div>
        <div id="right">
            <div id="right-left">
            </div>
            <div id="right-right">
            </div>
            </div>
        </div>
</body>

</html>
