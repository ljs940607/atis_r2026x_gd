define("DS/3DPlayExperienceModule/3DPlayAbstractExperience",["UWA/Core","DS/WebSystem/Scripting","DS/3DPlay/3DPlay","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/UIManager","DS/WebSystem/Settings","DS/3DPlayWAFRMigration/CommandsManager","DS/WebInfraUI/Notification","DS/WebSystem/Environment","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/WebUtils/EventDisposer","DS/WebSystem/Nls","DS/WebUtils/FunctionDisposer","DS/3DPlayUtils/XCADSpatialSupport","DS/3DPlayConnectors/3DPlayInputPreProcessor","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","DS/WebUtils/ProbesManager","DS/WebInfraUI/MobileActionBar","DS/WebUtils/PhaseProgress","DS/WebUtils/Tracker","DS/ENOXTriptych/js/ENOXTriptych","DS/WebSystem/App","i18n!DS/3DPlay/assets/nls/3DPlay","DS/3DPlayUtils/DFATools","DS/3DPlayWAFRMigration/Framewindow"],(function(e,i,t,n,s,o,r,a,d,l,c,h,p,u,g,m,f,v,P,D,S,w,y,C,b,A,E){"use strict";return i.extend({name:"3DPlayAbstractExperience",getExperienceModule:function(){return this.args.input.experience.filename},init:function(e){this._parent(),this.disposed=!1,this.commandEnabler=[],this.widgetPreferences={},this.args=e,this._name=e.input.experience.filename||"Default",this.EventDisposer=new h,this.addOnPauseCB(this.onPause),this.addOnPlayCB(this.onPlay),this.addOnStopCB(this.onStop),this.addOnScenarioChangeCB(this.onScenarioChange),this.addOnLoadingFinishedCB(this.onLoadingFinished),this.disposeFunctions=new u,this.createScriptingAPI(),this.addScriptingInitCB(),this.xcadSupport=new g(this),this._isReady=!1,this._enableCMenu=!0,this.playerSplashScreen=void 0,this.showSplashBetweenLoad=!0,this.modelLoadComplete=!1,this.phaseProgress=new S({mode:this.args.input.mode}),this.isFromTransition=!1,window.widget&&(this.landingPage=widget.welcomeScreen);var i=this;this.progress={},this.progress.hide=function(){i.getPhaseProgress()&&i.getPhaseProgress().hideProgressBar()},this.progress.updateProgression=function(e){i.getPhaseProgress()&&(i.getPhaseProgress().setAbsoluteProgress(this.subProgressID,e),i.progress.state.value=e)},this.progress.visible=function(){i.getPhaseProgress()&&(i.getPhaseProgress().showProgressBar(),i.progress.state.visible=!0)},this.progress.state={visible:!1,value:0},this.progress.spinnerContainer={style:{overflow:""}}},acceptSwitch:function(){return!1},acceptRefresh:function(){var e=void 0===this.needToRefresh||this.needToRefresh;return this.needToRefresh=void 0,e},resetWidgetPreferences:function(){var e=window.widget;for(var i in e&&C.is3DPlay()&&e.setPreferences([]),this.widgetPreferences)this.widgetPreferences.hasOwnProperty(i)&&(this.widgetPreferences[i].update=null)},refreshFromPreferences:function(e){this.needToRefresh=e},addWidgetPreferences:function(){var e=window.widget,i=this.widgetPreferences;if(e){var t=this,n=function(n){var s=!1;e.addEvent("onUpdateValue",(function(e){i[e]&&i[e].update&&i[e].update(this.getValue(e))&&(s=!0)})),e.addEvent("endEdit",(function(e){e&&e.submitted&&t.refreshFromPreferences(s)}))};for(var s in i)i.hasOwnProperty(s)&&(e.hasPreference(s)||e.addPreference(i[s]));e.addEvent("onEdit",n),this.EventDisposer.add((function(){var e=window.widget;e.removeEvent("onEdit",n),e.removeEvent("onUpdateValue",onUpdateValue),onUpdateValue=null,n=null,t=null}))}},registerCollabAction:function(){},isLoadingFinished:function(){return this.modelLoadComplete},isLoadingFInished:function(){return console.error("Wrong function - case error, please use isLoadingFinished"),console.error("Wrong function - case error, please use isLoadingFinished"),this.isLoadingFinished()},createScriptingAPI:function(){var e=this.args.options.helper||f.get(this.args.ctx,"helper"),i=this;i.addScriptingFunction("registerAction",i.addScriptingFunction.bind(i),"",e),i.addScriptingFunction("performAction",i.executeScriptingFunction.bind(i),"",e),i.addScriptingFunction("getAvailableActions",i.getScriptingFunctions.bind(i),"",e),i.addScriptingFunction("isActionSupported",i.hasScriptingFunction.bind(i),"",e),i.addScriptingFunction("unregisterAction",i.removeScriptingFunction.bind(i),"",e),i.addScriptingFunction("unregisterAllActions",i.disposeAllScriptingFunctions.bind(i),"",e),i.addScriptingFunction("notifyAction",i.notifyScriptingFunction.bind(i),"",[e,i]),i.addScriptingFunction("subscribeAction",i.subscribeScriptingFunction.bind(i),"",e),i.addScriptingFunction("unsubscribeAction",i.unsubscribeScriptingFunction.bind(i),"",e),i.addScriptingFunction("subscribeAllActions",i.subscribeAllScriptingFunctions.bind(i),"",e),i.addScriptingFunction("unsubscribeAllActions",i.unsubscribeAllScriptingFunctions.bind(i),"",e);this.trackScriptingFunction=function(e){w.trackPageEvent("commands","scripting",e)},i.addScriptingFunction("getScreenshot",function(e){this._check()&&this.instance.getScreenShot(e)}.bind(e),"",e,void 0,this.trackScriptingFunction);i.addScriptingFunction("getCollabMode",function(){return i.collabMode}.bind(e),"",e);i.addScriptingFunction("setCollabMode",function(e){i.collabMode=e}.bind(e),"",e),this.trackScriptingFunction;var t=[],n=["selectNode","unselectNode","setCurrentViewpoint","hideNode","showNode","showAll","hideAll","setVisuMode"];i.addScriptingFunction("addCollabCB",function(e){void 0!==e&&(t.push(e),e.collabNotif=function(e,t){"ADD"===e?i.notifyScriptingFunction("selectNode",t):"REMOVE"===e?i.notifyScriptingFunction("unselectNode",t):"HIDE"===e?i.notifyScriptingFunction("hideNode",t):"SHOW_ALL"===e?i.notifyScriptingFunction("showAll"):"VISU_MODE"===e?i.notifyScriptingFunction("setVisuMode",t):void 0===t&&i.notifyScriptingFunction("setCurrentViewpoint",[e])},this.addSelectionCB&&this.addSelectionCB(e.collabNotif),this.addViewpointChangeCB&&this.addViewpointChangeCB(e.collabNotif),this.addHideShowCB&&this.addHideShowCB(e.collabNotif),this.addVisuModeCB&&this.addVisuModeCB(e.collabNotif),n.forEach((function(t){i.subscribeScriptingFunction(t,e)})))}.bind(e),"",e);i.addScriptingFunction("removeCollabCB",function(e){if(void 0!==e){for(var i=t.indexOf(e);i>-1;)t[i]=void 0,i=t.indexOf(e);removeSelectionCB(e.sCB),removeViewpointChangeCB(sCB),removeHideShowCB(e.collabNotif),removeVisuModeCB(e.collabNotif)}}.bind(e),"",e);i.addScriptingFunction("registerCollabAction",function(s,o){i.addScriptingFunction(s,o,"",[e,i]),n.push(s),t.forEach((function(e){i.subscribeScriptingFunction(s,e)}))}.bind(i),"",[e,i]);i.addScriptingFunction("unRegisterCollabAction",function(e){if(void 0!==n)for(var s=n.indexOf(e);s>-1;)n[s]=void 0,s=n.indexOf(e);i.removeScriptingFunction(e),t.forEach((function(t){i.unSubscribeScriptingFunction(e,t)}))}.bind(i),"",[e,i]),i.addScriptingFunction("initCustomTypes",(function(){}),"",e)},addScriptingInitCB:function(){var e=this,i=e.args.options.helper||f.get(e.args.ctx,"helper");i&&e.args.options.collabmode&&i.setCollabMode("true"===e.args.options.collabmode),this.addOnLoadingFinishedCB((function(){i.initCustomTypes()}))},addOnLoadingFinishedCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGFINISHED"},e))},addOnLoadingProgressdCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGPROGRESS"},e))},onLoadingFinished:function(){},addOnLoadingStartedCB:function(e,i){return this.subscribe("ASSET/LOADINGSTARTED",e,i)},addOnPlayCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PLAY"},e))},onPlay:function(){},addOnPauseCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PAUSED"},e))},onPause:function(){},addOnStopCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/STOP"},e))},onStop:function(){},addOnScenarioChangeCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/SCENARIO/CHANGE"},e))},onScenarioChange:function(){},onLightboxReady:function(){},dispose:function(e){if(d.isSet("3DPlay.Debug")&&console.log("3DPlay.Debug:3DPlayAbstractExperience.dispose",e),this.commandEnabler&&(this.commandEnabler.forEach((e=>{e.dispose()})),this.commandEnabler=null),this.stop(),this.notifScreen&&(this.notifScreen.dispose&&this.notifScreen.dispose(),this.notifScreen=null),e=e||{},this.playerSplashScreen&&(this.playerSplashScreen=null),this.landingPage&&(this.landingPage=null),this.notifTimeoutID&&(clearTimeout(this.notifTimeoutID),this.notifTimeoutID=null),this.EventDisposer.dispose(),this.EventDisposer=null,this.resetWidgetPreferences(),this.disposeFunctions.dispose(),this.disposeFunctions=null,t.removeCallbacks(this.args.ctx),void 0===e.disposeFrameWindow||!0===e.disposeFrameWindow)void 0!==this.frmWindow&&null!==this.frmWindow&&(void 0!==this.frmWindow.dispose&&null!==this.frmWindow.dispose&&this.frmWindow.dispose(),this.frmWindow.experience=null,this.frmWindow=null);else if(r.isAFR2()){var i=this.args.ctx;r._commandsState[i]={lastCommand:[],currentCommand:null,defaultCommand:null},r.resetDefaultCommand(i),r._isCommandEnding=!1,r._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach((function(e){if(r[e]){var t=r[e][i];t&&Object.keys(t).forEach((function(e){var i=t[e];i&&i._destroy&&i._destroy(),delete t[e]}))}}))}r.isAFR2()||r.dispose(),this.PanelManager&&(this.PanelManager.dispose(),this.PanelManager=null),this.UIManager&&(this.UIManager.dispose&&this.UIManager.dispose(),this.UIManager=null),this.phaseProgress&&(this.phaseProgress.dispose&&this.phaseProgress.dispose(),this.phaseProgress=null),this.xcadSupport&&(this.xcadSupport.dispose&&this.xcadSupport.dispose(),this.xcadSupport=null),this.disposed=!0,this._parent(e),this.args=null,this.actionBarProfile&&(this.actionBarProfile.dispose&&this.actionBarProfile.dispose(),this.actionBarProfile=null),this.mainTrip&&this.mainTrip.remove(),this.triptych&&this.triptych.destroy(),this.mainTrip=null,this.triptych=null},informActiveState:function(e){this.PanelManager.setVisibility(e),e?v.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}}):v.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})},play:function(){if(void 0===this.pausetime&&(this.pausetime=this.first),!0===this.paused||!0===this.stoped){var e=(new Date).getTime()-this.pausetime;this.first+=e,this.paused=this.stoped=!1,this.publish("EXPERIENCE/PLAY",{experience:this,ctx:this.args.ctx})}},pause:function(){!1===this.paused&&(this.pausetime=(new Date).getTime(),this.paused=!0,this.stoped=!1,this.publish("EXPERIENCE/PAUSED",{experience:this,ctx:this.args.ctx}))},stop:function(){this.stoped=!0,this.paused=!1,this.publish("EXPERIENCE/STOP",{experience:this,ctx:this.args.ctx})},_testBrowser:function(){return BrowserSupport.ok},testBrowser:function(){return BrowserSupport.ok},getScreenShot:function(e){},start:function(){this.playerSplashScreen&&this.playerSplashScreen.removeOnClick(),this.args.options.loading===loadingMode.preload?this.isLoaded?this.toggleSplash(!1):this.args.options.splashscreen&&this.args.options.splashscreen.waitloading?this.toggleSplash(!0):this.toggleSplash(!1):this.initExperience()},toggleSplash:function(e){this.landingPage&&e&&this.landingPage.hide(),this.playerSplashScreen&&(e?this.playerSplashScreen.show():this.playerSplashScreen.hide())},initExperience:function(){},fromTransition:function(){return this.isFromTransition},createUIComponents:function(e){var i=this;if(this.paused=!0,e.experience=this,this.UIManager=new s({frameWindow:e,ctx:this.args.ctx}),this.PanelManager=new n({frameWindow:e,ctx:this.args.ctx}),this.PanelManager.setTopBarId(this.args.options),C.is3DPlay()&&this.PanelManager.tagger&&this.PanelManager.tagger.proxyTag(),0==this.getIfToDealyMABCreation()){var t=e.getActionBar();!t&&r.isAFR2()&&(t=this),t&&this.mabModel&&(t.MAB&&t.MAB.dispose(),t.MAB=new D({ctx:this.ctx,frameWnd:e,exp:this,actionBar:t,model:this.mabModel,modelTablet:this.tabletMabModel,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&d.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF}))}i.disposeFunctions.add((function(){let e=i.frmWindow.getMAB();e&&(!0===e.state.visible&&e.hide(),e.dispose()),i=null})),void 0!==this.notifScreen&&null!==this.notifScreen||(this.notifMsg=l,this.notifScreen=c,c.elements&&c.elements.container.isInjected()||c.inject(e.getUIFrame()),this.args&&(this.args.commandFullscreen||this.args.options.fullscreen)?c.slide({top:60,right:0}):c.slide({top:0,right:0}),c.setNotificationManager(l)),e.getActionBar()?this.manageWorkBenchs({createActionBar:void 0!==this.args.options.pad3DViewer,frameWindow:e,finishCallBack:function(){i.publish("EXPERIENCE/EXPERIENCEREADY",i)}}):i.publish("EXPERIENCE/EXPERIENCEREADY",this),this.notifScreen&&this.UIManager.addToPanelEvent(this.notifScreen,(function(e){i.notifScreen.slide({top:60,right:0}),e.visible&&i.notifScreen.slide({top:60,right:e.size+10})}))},getInformationsOnAsset:function(){var e=this.args.input&&this.args.input.asset;if(Array.isArray(e)&&(e=e[0]),!e)return e;var i=e.provider,t=e.type,n=e.objectId||e.physicalid||e.id,s=e.source,o=e.tenant,r=e.displayPreview;if(e.originalType&&(t=e.originalType),e.originalAsset&&(i=e.originalAsset.provider||i,t=t||e.originalAsset.format||e.originalAsset.dtype||e.originalAsset.type,n=e.originalAsset.objectId||e.originalAsset.physicalid||n,s=s||e.originalAsset.source,o=o||e.originalAsset.tenant,r=r||e.originalAsset.displayPreview),e.localFile&&(s=o="Desktop"),"FILE"===i&&(C.is3DDrive()?i="3DDRIVE":C.is3DSwym()&&(i="3DSWYM")),"xmlv43"===t&&(t="3DXML"),"EV6"===i)i="3DSpace";else if("3DSWYM"===i&&!n&&e.originalAsset&&null==(n=e.originalAsset.objectId)&&e.filename){var a=e.filename;if(a.search("/id/")>=0){var d=a.search("/id/");d+=4,d=(a=a.slice(d)).search("/"),n=a.slice(0,d)}e.swymAttr&&(n=e.swymAttr.id)}return{id:n,provider:i,type:t,source:s,tenant:o,swymAttr:e.swymAttr,swymServerToken:e.swymServerToken,driveAttr:e.driveAttr,fileAttr:e.localFile,displayPreview:r}},getIfToDealyMABCreation:function(){return!1},updateConnection:function(e,i){i&&i()},createDom:function(i,t){if(!this.frmWindow){this.args.ui=this.args.ui||{displayTree:!0};var n={context:this.args.ctx,height:"100%",minHeight:void 0!==this.args.minHeight?this.args.minHeight:0,viewerOptions:this.args.viewerOptions||this.args.visu||{},uiOptions:this.args.ui,onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};if(this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var s=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++,n.ignoreResetCommandManager=!0,n.workbenchModule=s.module,n.workbench=s.name+".xml",n.defaultCommand=void 0!==s.defaultCommand?s.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"},this.actionBarProfile=P.createProbe("ActionBar_"+s.name),this.actionBarProfile.begin()}if(E.isAFR2()?this.frmWindow=E:this.frmWindow=new i(n),C.is3DPlay()){this.mainTrip=e.createElement("div",{class:"3Dplayviewer_mainTriptych",styles:{width:"100%",height:"100%",position:"relative"}}),this.rightTrip=e.createElement("div",{class:"3Dplayviewer_rightTriptych rightSidePanel"});var o={container:this.mainTrip,withtransition:!0,withoverflowhidden:!0,right:{resizable:!0,originalState:"close",overMobile:!0,minWidth:250,withClose:!1}};this.triptych=new y,this.triptych.init(o,void 0,this.frmWindow.getContent(),this.rightTrip);var r=this;require(["DS/PADServices/utils/GlobalModelEvents"],(function(e){r.triptych._modelEvents.subscribe({event:"triptych-clicked-overlay"},(function(i){e.publish({event:"ENXViews/Triptych/onOverlayClick",data:i})}))})),this.triptych.togglePanel=function(e){"left"===e?r.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"left"}):r.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"right"})};let i=this.args.container;if(this.triptych.inject(i),E.getExecutionContext()){let e=document.getElementsByClassName("wux-applicationframe-app");e[0]&&(e=e[0],e.inject(i))}this.triptych.getMainPanelContainer().style.zIndex="auto";var a=this.frmWindow.getActionBar();a&&a.inject(this.mainTrip)}else this.frmWindow.inject(this.args.container)}t&&t.apply(this)},getPhaseProgress:function(){return this.phaseProgress},load:function(i,n){if(this.hasConvertFailed=!1,n&&n.newAsset){if(t.endAllCommands({ctx:this.args.ctx,resetDefaultCmd:!1}),o.get("3DPlay.Video.Enabled")){var s=f.get(this.args.ctx,"3DP_Video_Controls");s&&(s.destroyUI(),f.remove(this.args.ctx,"3DP_Video_Controls")),f.get(this.args.ctx,"3DP_Video_Viewer")&&f.remove(this.args.ctx,"3DP_Video_Viewer")}t.publish(this.args.ctx,"ASSET/CHANGE",{model:"clear",ctx:this.args.ctx})}if(null==n&&(n={}),this.playerSplashScreen){var r=n?n.splashscreen:null;this.playerSplashScreen.refreshOptions(r)}!0!==i.preProcessed&&(console.error("3DPlayWeb: inputs should have been pre processed before call."),console.error("3DPlayWeb: Please consider using 3DPlayHelper or InputPreProcessor."));var a=P.createProbe("PreProcessor");a.begin();var d=this;(new m).run(i,(function(s){a.end(),a=null;var o=s;if(i=s,d._isReady=!0,!0!==d._isReady)return d.args.input=i,void(d.args.options=n);if(void 0!==d.frmWindow){if(o&&void 0!==o.asset&&!1===Array.isArray(o.asset)&&(o.asset=[o.asset]),o&&void 0!==o.asset&&void 0!==o.asset[0]){var r=!1,l=!0;n&&(r=(void 0===o||void 0===o.asset||void 0===o.asset[0])&&!0===n.clearSceneGraph,void 0!==n.clearSceneGraph&&null!==n.clearSceneGraph&&(l=n.clearSceneGraph)),d.notifTimeoutID&&(clearTimeout(d.notifTimeoutID),d.notifTimeoutID=null),r||l?(d.showSplashBetweenLoad&&d.playerSplashScreen&&(d.playerSplashScreen.showView(d.playerSplashScreen.views.loading),d.toggleSplash(!0)),d.clearView(),d.getPhaseProgress().setIndeterminateState(),d.xcadSupport.clearQueue()):d.autoReframe=!1,r&&d.publish("ASSET/LOADINGFINISHED",{model:"clear",ctx:this.args.ctx});for(var c=null,h={},p=d.getInformationsOnAsset(),u=function(e){e.loadAssetInfo=p,d.onModelLoadingError?d.onModelLoadingError(e):d.onDocumentLoadingError&&d.onDocumentLoadingError(e);var i={};i[e.type]=1,w.trackPageEvent("errors","conversion_error",p.type,0,i),p=null,console.error("Conversion fails, see logs below :"),console.error(e)},g=0;g<o.asset.length;g++)o.asset[g]&&(o.asset[g].mimetype&&o.asset[g].mimetype.toLowerCase&&"3dxml"==o.asset[g].mimetype.toLowerCase()||o.asset[g].format&&o.asset[g].format.toLowerCase&&"3dxml"==o.asset[g].format.toLowerCase())&&("3ddrive"!=o.asset[g].provider.toLowerCase()&&(!o.asset[g].originalAsset||"3ddrive"!=o.asset[g].originalAsset.provider.toLowerCase())||o.asset[g]&&o.asset[g].filename&&o.asset[g].filename.includes&&o.asset[g].filename.includes("3DPlayExperiencesTest")||o.asset[g]&&o.asset[g].serverurl&&o.asset[g].serverurl.includes&&(o.asset[g].serverurl.includes("3DPlayExperiencesTest")||o.asset[g].serverurl.includes("zz3DPlayPCSLoading")))&&(o.asset[g].useConvertors=!1);if(o.asset.length>1){var f=[],v=[];for(g=0;g<o.asset.length;g++)o.asset[g]&&(n&&n.tenant&&(void 0===o.asset[g].tenant||null===o.asset[g].tenant)&&(o.asset[g].tenant=n.tenant),null!==(c=d.xcadSupport.getConversionFormat(o.asset[g].mimetype||o.asset[g].format))&&!1!==o.asset[g].useConvertors?(o.asset[g].dataFormat=c,f.push(o.asset[g])):v.push(o.asset[g]));f.length>0&&(h.nbAssetToConvert=f.length,h.progress=d.getPhaseProgress(),h.progressDivisions=v.length+f.length);var D=o;D.asset=v;var S=d._loadAssets(D,e.extend(n,{convert:h}));S&&f.length>0&&(this.notifTimeoutID=h.notifTimeoutID=setTimeout((function(){t.sendEvent(d.args.ctx,eventType.notif,notification.info,{msg:b.ConversionNeeded})}),6e3),f.length>0&&d.xcadSupport.convert(f,h,(function(e,i){u(e),S.addNewFile(i)}),(function(e,i){d.playerSplashScreen.showView(d.playerSplashScreen.views.loading),S.addNewFile(e)}),(function(e){S.addNewFile(e)})))}else{if(null===o.asset[0]||void 0===o.asset[0])return void d.loadAsset(void 0,n);n&&n.tenant&&(void 0===o.asset[0].tenant||null===o.asset[0].tenant)&&(o.asset[0].tenant=n.tenant);let i=null,s=null;if(!1!==o.asset[0].useConvertors){let e=A.getFormat(o.asset[0]),t=A.getTarget(o.asset[0]);t||(t=d.xcadSupport.getConversionFormat(e)),t&&(s=t,i=d.xcadSupport)}if(null===s)o.asset=o.asset[0],window.localStorage["3DPlayHybridApp"]&&window.HybridAppArgs&&window.HybridAppArgs.myAppsUrl?d.updateConnection(o,(function(){d.loadAsset(o,n)})):d.loadAsset(o,n);else{d.subProgressID=d.getPhaseProgress().registerSubProgress(),d.getPhaseProgress().showProgressBar(),o.asset[0].dataFormat=s;var y=e.extend(n,{clearSceneGraph:!0,ConversionFeedBack:{progress:d.getPhaseProgress()}});d.notifTimeoutID=y.ConversionFeedBack.notifTimeoutID=setTimeout((function(){t.sendEvent(d.args.ctx,eventType.notif,notification.info,{msg:b.ConversionNeeded})}),6e3);var C=P.createProbe("Convert");C.begin(),i.convert(o.asset[0],y,(function(e,i){d.args.input.asset=i,d.loadAssetInfo=i,C.end();i&&i.format&&{step:!0,stp:!0}[i.format.toLowerCase()]?(d.playerSplashScreen&&d.playerSplashScreen.showView(d.playerSplashScreen.views.loading),i&&(i.originalAsset?(new m).run({asset:i.originalAsset},(function(e){e.asset.serverurl="",e.asset.filename=e.asset.url,d.loadAsset(e,y)})):d._loadAssets({asset:i},y))):u(e)}),(function(i){d.loadAssetInfo=e.clone(i,!0),o.asset[0].originalAsset?d.loadAssetInfo.originalAsset=e.clone(o.asset[0].originalAsset,!0):d.loadAssetInfo.originalAsset=e.clone(o.asset[0],!0),d.args.input.asset=i,C.end(),d.playerSplashScreen&&d.playerSplashScreen.showView(d.playerSplashScreen.views.loading),d._loadAssets({asset:i},y)}))}}}d.args.input.annotation=o.annotation,d.args.input.asset=e.clone(o.asset,!0),d.args.input.experience=e.extend(d.args.input.experience,o.experience,!0),d.args.options=e.extend(d.args.options,e.clone(n,!0),!0),d.loadAssetInfo=e.clone(d.args.input.asset,!0),d.modelLoadComplete=void 0}}))},loadAssets:function(e,i){console.error("Function not implemented - loadAsset")},_handleNotification:function(e){e.eventID===a.fatal?t.displayFatalError({ctx:e.ctx,msg:e.msg}):e.eventID===a.warning||e.eventID===a.info||e.eventID===a.success||e.eventID===a.error||e.eventID===a.assistance?(this.notifMsg.addNotif({level:e.eventID,title:e.title,subtitle:e.subtitle,message:e.msg,category:e.category||"3DPlay - "+this.ctx,sticky:!1}),this.publish("EXPERIENCE/NOTIF",{ctx:e.ctx,event:e.eventID,msg:e.msg})):console.error("3DPlay: "+b.IncorectNotif)},setOnLoadedCallback:function(e){console.error("Function not implemented - AbstractExp")},setOnProgressCallback:function(e){console.error("Function not implemented - AbstractExp")},_step:function(){console.error("Function not implemented - AbstractExp")},step:function(){console.error("Function not implemented - AbstractExp")},preRenderCB:function(){console.error("Function not implemented - AbstractExp")},postRenderCB:function(){console.error("Function not implemented - AbstractExp")},preCreate:function(){console.error("Function not implemented - AbstractExp")},postCreate:function(){console.error("Function not implemented - AbstractExp")},onPreCreate:function(){console.error("Function not implemented - AbstractExp")},onPostCreate:function(){console.error("Function not implemented - AbstractExp")},addScenario:function(e){console.error("Function not implemented - AbstractExp")},getScenarioNumber:function(){console.error("Function not implemented - AbstractExp")},getScenario:function(e){console.error("Function not implemented - AbstractExp")},loadWorkbench:function(e,i){console.error("Function not implemented - AbstractExp")},changeScenario:function(e,i){console.error("Function not implemented - AbstractExp")},getDefaultScenario:function(){console.error("Function not implemented - AbstractExp")},manageScenario:function(){console.error("Function not implemented - AbstractExp")},getModelLoader:function(){console.error("Function not implemented - AbstractExp")},getScenarioManager:function(){console.error("Function not implemented - AbstractExp")},clearView:function(){this.notifScreen&&this.notifScreen.removeNotifications(),this.showSplashBetweenLoad&&this.playerSplashScreen&&(this.playerSplashScreen.showView(this.playerSplashScreen.views.loading),this.toggleSplash(!0))},showContextualMenu:function(e){this._enableCMenu=e},addCallbacks:function(e){t.addCallbacks(this.args.ctx,e)},publish:function(e,i){v.publish({event:"/"+this.args.ctx+"/"+e+"/",data:i})},subscribe:function(e,i,t){var n=v.subscribe({event:"/"+this.args.ctx+"/"+e+"/"},i);return t?(this.EventDisposer.add(n),null):n},subscribeOnce:function(e,i){var t=v.subscribe({event:"/"+this.args.ctx+"/"+e+"/"},(function(){v.unsubscribe(t),i.apply(void 0,arguments)}))},unsubscribe:function(e){return v.unsubscribe(e)}})}));var deps=["DS/3DPlaySupport/SupportList"];"false"!==window.localStorage["3DPlay.pad3DViewer"]&&deps.push("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),define("DS/3DPlayExperienceModule/SceneGraphNodeServices",deps,(function(e,i){"use strict";return{is3DXMLNode:function(e){return e?e.productType||void 0!==e.persistentId:null},getName:function(e){return e?this.is3DXMLNode(e)?e.getName():e.title||e.name:null},getId:function(e){return e?(i&&(t=i.getNodeID(e)),t||(t=e.getId?e.getId():t),t||(t=e.persistentId),t):null;var t},getType:function(e){return e?(i&&(t=i.getNodeType(e)),t||(t=e.getType?e.getType():void 0),t||(t=e.productType||e.worktype||e.plmtype),t):null;var t},isReference:function(t){return t?t.productType?"Reference3D"===t.productType:t.worktype?"Reference3D"===t.worktype:t.plmtype?"Reference3D"===t.plmtype:"VPMReference"===e.CROSSHIGHLIGHT[this.getType(t)]||(i?i.isReference(t):null):null},isInstance:function(t){return t?t.productType?"Instance3D"===t.productType:t.worktype?"Instance3D"===t.worktype:t.plmtype?"Instance3D"===t.plmtype:"VPMInstance"===e.CROSSHIGHLIGHT[this.getType(t)]||(i?i.isInstance(t):null):null},isRepReference:function(e){return e?e.productType?"ReferenceRep"===e.productType:e.worktype?"ReferenceRep"===e.worktype:e.plmtype?"ReferenceRep"===e.plmtype:i?i.isRepReference(e):null:null},isRepInstance:function(e){return e?e.productType?"InstanceRep"===e.productType:e.worktype?"InstanceRep"===e.worktype:e.plmtype?"InstanceRep"===e.plmtype:i?i.isRepInstance(e):null:null},is3DLeaf:function(e){return e?this.is3DXMLNode(e)?this.isRepReference(e):i?i.is3DLeaf(e):null:null},isPLMNode:function(e){if(!e)return null;if(this.is3DXMLNode(e)){var t=this.getType(e);return null!=t&&""!==t}return i?i.isPLMNode(e):null}}})),define("DS/3DPlayExperienceModule/Tracker_Translation_Experience",[],(function(){"use strict";return{experience:{Connector_Require:2,Connector_Finished:3,Experience_Require:4,Viewer_init:5,ActionBar_Ready:6,Experience_Ready:7,WaitAllCommands:8,CSV_Tenant_Init:10},asset:{Connector_Require:2,Connector_Finished:3,Wait_MaterialsCommands:4,XCAD_DownloadExternalDrive:5,XCAD_Authentication:6,XCAD_Preprocess:7,XCAD_Transfer:8,XCAD_Convert:9,Download:10,Load_Infra:11,Load_Session:12,nbMeshOccurrences:13,nbMeshes:14,nbNodeOccurrences:15,nbNodes:16,nbLines:17,nbPoints:18,nbTriangles:19,width:17,height:18,nbPages:19,DownloadSize:20},comment:{measure:2,clipping:3,annotations:4,scenario:5,pgpFromServer:6,cgrPolicy:7}}}));var EditPropConstantsReq=[];"true"!==window.localStorage["3DPlay.useOutsidePlatform"]&&EditPropConstantsReq.push("DS/EditPropWidget/constants/EditPropConstants"),define("DS/3DPlayExperienceModule/3DPlayExperience",["DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayAbstractExperience","DS/3DPlayWAFRMigration/CommandsManager","DS/3DPlay/3DPlayScenarioManager","DS/WebInfraUI/Notification","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/3DPlaySupport/SupportList","DS/3DPlaySupport/ExperiencesList","DS/3DPlaySupport/AssetSupport","DS/WebUtils/ProbesManager","DS/WebUtils/Statistics","DS/WebUtils/Tracker","DS/3DPlaySocialPanel/3DPlaySocialPanelManager","DS/WebSystem/App","DS/WebUtils/WebServices","DS/3DPlayExperienceModule/Tracker_Translation_Experience","i18n!DS/3DPlayExperienceModule/assets/nls/3DPlayExperienceModule","DS/WebSystem/SessionManager","DS/3DPlayHelper/AssetLoadingPreview","DS/WebInfraUI/MobileActionBar"].concat(EditPropConstantsReq),(function(e,i,t,n,s,o,r,a,d,l,c,h,p,u,g,m,f,v,P,D,S,w,y,C){"use strict";return n.extend({isCommentAvailable:function(){return f.isOnCloud()},init:function(t){if(this.detectPlatform(),this._parent(t),this.useSession){var n=t.session||[];S.init({sessionKey:"3DPlay.Session",dataKey:"experience",ToCopy:n.ToCopy,toMigrate:n.toMigrate})}if(f.is3DPlay()&&(this.args.options.propertiesFacet=this.args.options.propertiesFacet||[],this.args.options.propertiesFacet.push(C.FACET_PROPERTIES),this.args.options.propertiesFacet.push(C.FACET_SWYMCOMMENTS),this.args.options.propertiesFacet.push(C.FACET_RELATIONS)),t.options.callback&&this.setOnAnnotationShared(t.options.callback.onAnnotationShared),this.force3DComment=!1,this.args.options&&this.args.options.behaviors&&(this.force3DComment=Array.isArray(this.args.options.behaviors)&&this.args.options.behaviors.indexOf("comment")>-1),void 0===t.commandApplication||!0===t.commandApplication){if(t.workbenchs=t.workbenchs||[],t.workbenchs.unshift({name:"3DPlay",module:"3DPlay"}),i.isSet("3DPlay.Session.AB")&&t.workbenchs.push({name:"3DPlayDebug",module:"3DPlayExperienceModule"}),window.widget&&(this._hasLightbox=widget.hasLightbox),t.disableDefaultInformationPanel&&(this._hasLightbox=t.disableDefaultInformationPanel),this._hasLightbox)this.isCommentAvailable()?t.workbenchs.push({name:"3DPlayShareComment_LightboxMode",module:"3DPlay"}):t.workbenchs.push({name:"3DPlayShare_LightboxMode",module:"3DPlay"});else{let e=this.force3DComment||this.useSession&&(f.is3DSwym()||f.is3DDrive()||f.is3DSpace()||f.is3DPlay())&&this.isCommentAvailable()&&!0!==this.share3DCommentHide;this._iOS?e?t.workbenchs.push({name:"3DPlayShareComment_iOS",module:"3DPlay"}):i.isSet("3DPlay.publishToMakeCmdActivate")?t.workbenchs.push({name:"3DPlayShare_iOSPublishToMake",module:"3DPlay"}):t.workbenchs.push({name:"3DPlayShare_iOS",module:"3DPlay"}):e?t.workbenchs.push({name:"3DPlayShareComment",module:"3DPlay"}):i.isSet("3DPlay.publishToMakeCmdActivate")?t.workbenchs.push({name:"3DPlaySharePublishToMake",module:"3DPlay"}):t.workbenchs.push({name:"3DPlayShare",module:"3DPlay"})}i.isSet("3DPlay.Session.AB")&&t.workbenchs.push({name:"3DPlayDebug",module:"3DPlayExperienceModule"}),i.isSet("3DPlay.Activate3DComment")&&t.workbenchs.push({name:"3DPlayComment",module:"3DPlay"})}o.loadManager(this),this.ctx=this.args.ctx,this.modelTotalCount=0,this.modelLoadComplete=void 0,this.getPhaseProgress().setIndeterminateState(),this.getPhaseProgress().addProgressBarIntoUI(t.container);var s=this;this.disposeFunctions.add((function(){s=null})),this.onModelLoadingStarted=function(i){s.args.container.classList.toggle("3DPlayPO-Loading-Started");var t=s.args.input.asset,n=s.getInformationsOnAsset(t);if(!s.onAnnotationShared&&t){var o,r=t.serviceURL;"3DSWYM"===n.provider&&(o=t.swymServerToken),null==r?"3DSWYM"===n.provider&&v.getServiceUrl({serviceName:"3DSwym",platformId:n.tenant,onSuccess:function(e){var i=e;i&&(Array.isArray(i)&&(i=i[0]),i.url&&(r=i.url)),n.id&&n.tenant&&r&&s.createSocialPanel(n.id,n.tenant,r,n.provider)},onError:function(){}}):n.id&&n.tenant&&r&&s.createSocialPanel(n.id,n.tenant,r,n.provider,o)}s.modelLoadComplete=!1,s.startLoadingPreview(n),s.publish("ASSET/LOADINGSTARTED",{data:s.modelName,ctx:s.args.ctx,loadAssetInfo:n}),e.endAllCommands({ctx:s.args.ctx,resetDefaultCmd:!1}),!0===(void 0===i||i)&&(s.getPhaseProgress().setIndeterminateState(),s.getPhaseProgress().showProgressBar()),0===s.getPhaseProgress().getSubProgressDivisions()&&(s.subProgressID=s.getPhaseProgress().registerSubProgress()),s.noGeoTimO&&clearTimeout(s.noGeoTimO),s.noGeoInt&&clearInterval(s.noGeoInt)},this.onModelLoadingProgression=function(e){if(s){var i=e.currentProgressID||s.subProgressID;i?s.subProgressID!==i&&(s.subProgressID=i):i=s.subProgressID=s.getPhaseProgress().registerSubProgress(),void 0!==e.loaded&&void 0!==e.total&&0!==e.total&&(s.newPart=!0,s.modelLoadCount=e.loaded,s.modelTotalCount=e.total,s.getPhaseProgress().setAbsoluteProgress(i,Math.round(100*e.loaded/e.total)),s.modelLoadCount>0&&s.stopLoadingPreview(),s.publish("ASSET/LOADINGPROGRESS",{model:s.modelName,progress:e,ctx:s.ctx}))}},this.onModelLoadingCompleted=function(){if(s){s.args.container.classList.toggle("3DPlayPO-Loading-Complete"),s.args.container.classList.toggle("3DPlayPO-Loading-Started"),s._onModelLoadingCompleted&&s._onModelLoadingCompleted(),s.getPhaseProgress()&&(s.getPhaseProgress().advanceToMax(s.subProgressID),s.getPhaseProgress().resetProgress(),s.getPhaseProgress().hideProgressBar()),s.args.options.loading===loadingMode.preload&&(s.isLoaded=!0),s.stopLoadingPreview(),s.toggleSplash(!1),s.modelLoadComplete=!0;var e=0;s.totalLoadingAssetProfiler&&(s.totalLoadingAssetProfiler.end(),e=Math.floor(s.totalLoadingAssetProfiler.getTime())),s.publish("ASSET/LOADINGFINISHED",{model:s.modelName,time:e,ctx:s.args.ctx,loadAssetInfo:s.loadAssetInfo||{}});s.args.input.asset;if(s.stats&&setTimeout((function(){s.stats.UpdateProbes=!0,s.stats.postProcess()}),2e3),i.isSet("3DPlay.zzPCS")){var t=window.top.document.createEvent("CustomEvent");t.initCustomEvent("3DPlay.zzPCS",!0,!1,require("DS/WebUtils/ProbesManager").GetProcessedData({topWindow:!0,cleanNames:!0,only3DPlay:!0})),window.top.document.dispatchEvent(t)}if(i.isSet("3DPlay.ConsolePCS")){var n=p.GetProcessedData({topWindow:!0,cleanNames:!0}),o={Timings:{},Memory:{},FIleStats:s.computeViewerStats()};n.sort((function(e,i){var t=e.startTime,n=i.startTime;return t<n?-1:t>n?1:0})),n.forEach((function(e){o.Timings[e.name]={startTime:e.startTime,duration:e.duration}})),require("DS/WebSystem/Downloader")("3DPlay.QAPCS.json",new Blob([JSON.stringify(o)],{type:"text/plain"}))}s.args.input.annotation&&(s.loadAnnotations(s.args.input.annotation),delete s.args.input.annotation)}},this.subscribe("ASSET/LOADINGERROR",(function(){s&&s.stopLoadingPreview()})),i.isSet("3DPlay.Statistics")&&(this.stats=new u,this.stats.set({container:this.args.container}))},detectPlatform:function(){this._iOS=Boolean(navigator.platform)&&/iPad|iPhone|iPod/.test(navigator.platform)||Boolean(navigator.userAgent)&&/iPad|iPhone|iPod/.test(navigator.userAgent)||(/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&!window.MSStream||navigator.userAgent.match(/Macintosh/i)&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2,this._android=Boolean(navigator.userAgent)&&/Android/.test(navigator.userAgent)},comuteViewerStats:function(){return{}},getExperienceBase:function(){return this.experienceBase},getScenarioManager:function(){return o},loadScenario:function(){console.error("3DPlayExperience : Method Deprecated -> Use getScenarioManager Instead")},dispose:function(e){this._loadingPreview&&(this._loadingPreview.hide(),this._loadingPreview.remove()),this.useSession&&S.dispose(),this.sessionProbes&&(this.sessionProbes.end(),g.trackPageEvent("infos","3DPlay_session","duration",Math.floor(this.sessionProbes.getTime())/1e3));var i=d.get(this.args.ctx,"ANNOTATION_MANAGER");i&&(i.deleteAllAnnotations(),d.remove(this.args.ctx,"ANNOTATION_MANAGER")),this.currentLoadingAssetProfiler&&(this.currentLoadingAssetProfiler.dispose&&this.currentLoadingAssetProfiler.dispose(),this.currentLoadingAssetProfiler=null);var t=require("DS/ApplicationFrame/AfrPlayerService");t&&(t._playerView=t._playerView||{},t.hidePlayer(),t.registerPlayerContainer(void 0)),this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,this._parent(e),o.dispose(),this.frmWindow&&(this.frmWindow.experience=null,this.frmWindow=null)},setOnLoadedCallback:function(){},setOnProgressCallback:function(){},step:function(){},_step:function(){this.stats&&this.stats.postProcess()},onPreCreate:function(){},onPostCreate:function(){},manageWorkBenchs:function(e){var t,n=e&&e.frameWindow?e.frameWindow:this.frmWindow,o=e.finishCallBack;if(this.actionBarReady=!1,n&&n.getActionBar()){var r=this;t=e.customWorkBench?e.customWorkBench:r.args.workbenchs;var a="none";e&&e.frameWindow&&e.frameWindow.experience&&e.frameWindow.experience.args&&e.frameWindow.experience.args.input&&e.frameWindow.experience.args.input.asset&&e.frameWindow.experience.args.input.asset.provider&&(a=e.frameWindow.experience.args.input.asset.provider);for(var l=t.length;l--;)!i.isSet("3DPlay.publishToMakeCmdActivate")||"FILE"!=a&&"3DDRIVE"!=a&&"3DSWYM"!=a?"3DPlayShare_iOSPublishToMake"==t[l].name?t[l].name="3DPlayShare_iOS":"3DPlaySharePublishToMake"==t[l].name&&(this.args.workbenchs[l].name="3DPlayShare"):r._iOS?"3DPlayShare_iOS"==t[l].name&&(t[l].name="3DPlayShare_iOSPublishToMake"):"3DPlayShare"==t[l].name&&(t[l].name="3DPlaySharePublishToMake");var c=function(i){var a,l;a=function(){var e;if(n&&n.experience&&n.experience.workbenchIndex>0&&r.actionBarProfile&&r.actionBarProfile.end(),void 0===r.workbenchIndex&&(r.workbenchIndex=0),r.workbenchIndex<t.length)e=t[r.workbenchIndex],r.actionBarProfile=p.createProbe("ActionBar_"+e.name),r.actionBarProfile.begin(),r.loadWorkbench(e,0!==r.workbenchIndex),r.workbenchIndex++;else{(e=t[t.length-1])&&e.defaultCommand&&(e.defaultCommand.context=r.args.ctx,s.setDefaultCommand(e.defaultCommand)),r.actionBarReady=!0,p.end("ActionBar_Ready"),void 0!==r.args.ui.onActionBarReady&&r.args.ui.onActionBarReady(),r.args.container.classList.toggle("3DPlayPO-Init-Ready");r.args.options.helper||d.get(this.args.ctx,"helper");var c=s.getCommands(r.args.ctx);if(c)for(var h in c)c.hasOwnProperty(h)&&r.addScriptingFunction(c[h].getId(),function(e){return function(i){e[i||"begin"]()}}(c[h]),"Command "+c[h].getId(),void 0,void 0,r.trackScriptingFunction);if(c=s.getCommandCheckHeaders(r.args.ctx))for(var h in c)c.hasOwnProperty(h)&&r.addScriptingFunction(c[h]._id,function(e){return function(i){var t="begin"===(i||"begin");e.setState(t)}}(c[h]),"Command "+c[h]._id,void 0,void 0,r.trackScriptingFunction);r.play(),a=null,n._actionBar.removeCallback(l),o&&o(),i()}}.bind(r),l=n.onActionBarReady(a),(e.createActionBar||r.enopadInited)&&a&&a()};this.WKPromise?this.WKPromise.then((function(){r.WKPromise=new Promise(c)})):this.WKPromise=new Promise(c)}},updateMAB:function(e){e&&this.MAB&&(this.MAB?this.MAB.update(e):this.MAB=new y({ctx:this.ctx,frameWnd:this.frmWindow,exp:this,actionBar:actionBar,model:e,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&i.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF}))},resetScenarioMAB:function(e){this.MAB&&this.MAB.resetScenario()},loadWorkbench:function(e,i,t){if(this.frmWindow){var n=void 0!==i&&i;if(void 0!==e.name){var s=e.name,o=this.args.ctx;"xml"!==a.getExtension(e.name)&&(s+=".xml");var r=this.frmWindow.getActionBar();r&&(r.loadModel({context:o,file:s,module:e.module,merge:!0===n}),t&&this.MAB&&this.MAB.loadScenarioWb(t,i))}}},preCreate:function(){},postCreate:function(){},_loadAssets:function(e,i){var n=this;null!==i.convert&&void 0!==i.convert||(i.convert={});var s=[];if(i.convert.progressArray)s=s.concat(i.convert.progressArray);else{var o=i.convert.progressDivisions||e.asset.length;s=this.getPhaseProgress().registerMultipleSubProgress(o)}var r={modelLoaderonLoadedCB:this.getModelLoader().onLoadedCB,proportion:i.convert.progressProportion||1/e.asset.length,array:[].concat(e.asset),experience:this,phaseprogress:i.convert.progress||this.getPhaseProgress(),progressArray:[].concat(s),currentProgressID:void 0,ctx:this.args.ctx,currentmodel:void 0,options:t.extend({},i),nbAssetDelayed:i.convert.nbAssetToConvert||0,isWaiting:!1,addNewFile:function(e){null!==e&&r.array.push(e),r.nbAssetDelayed=r.nbAssetDelayed-1,r.isWaiting&&(r.isWaiting=!1,r.processNextFile())},processNextFile:function(){if(void 0===this.currentmodel?void 0!==this.options.clearSceneGraph&&null!==this.options.clearSceneGraph||(this.options.clearSceneGraph=!0):this.options.clearSceneGraph=!1,this.array.length>0){this.currentmodel=this.array.shift(),this.currentProgressID=this.progressArray.shift();var e=this.experience;e.updateConnection({asset:this.currentmodel},function(){e.loadAsset({asset:this.currentmodel},this.options,!1,this.profile),e=null}.bind(this))}else 0===r.nbAssetDelayed?(n.setOnLoadedCallback(this.experience.onModelLoadingCompleted),n.setOnProgressCallback(this.experience.onModelLoadingProgression),this.modelLoaderonLoadedCB()):r.isWaiting=!0},progress:function(e){e.currentProgressID=r.currentProgressID,this.experience.onModelLoadingProgression(e)}};return this.setOnLoadedCallback((function(){r.phaseprogress.advanceToMax(r.currentProgressID),r.processNextFile()})),this.setOnProgressCallback((function(e){r.progress(e)})),r.processNextFile(),r},initExperienceBase:function(e,i){i&&i(0)},disposeExperienceBase:function(e){e&&e(0)},computeViewerStats:function(){return{}},initExperience:function(){if(this.onPreCreate(),this.preCreate(),this._postcreate=function(){this.createUIComponents(this.frmWindow),this.args.helpercb&&this.args.helpercb(this,this.args.ctx);var e=this.args.options.helper;e||(e=d.get(this.args.ctx,"helper")),e&&(e.instance=this,e.loaded=!0,e.SupportList=l,e.ExperiencesList=c,e.AssetSupport=h),this.addWidgetPreferences(),this.postCreate(),this.onPostCreate(),this.first=(new Date).getTime(),this.fromTransition()||this.args.input&&this.args.input.asset&&(this.args.options.loading===loadingMode.preload||this.args.options.splashscreen&&this.args.options.splashscreen.waitloading||this.toggleSplash(!1),this.totalLoadingAssetProfiler=p.createProbe("_Load_"),this.totalLoadingAssetProfiler.begin(),this.waitingCammandsForLoad=this.waitingCammandsForLoad||[],Promise.all(this.waitingCammandsForLoad).then(function(){this.load(this.args.input,this.args.options)}.bind(this)))},this.startLoadingPreview(this.getInformationsOnAsset(this.args.input.asset)),this.frmWindow)this.createDom(void 0,this._postcreate),this._postcreate();else{var e=this,i=this.args.input.experience.filename||this.args.input.experience;this.subscribeOnce("EXPERIENCE/EXPERIENCEREADY",(function(){e.sessionProbes=p.createProbe("session_duration"),e.sessionProbes.begin(),setTimeout((function(){var e="ExperienceReady",t=p._parse(e);t.end();var n=t.getTime(),s=p.GetSubProbesFrom(t,!1);s.Experience_Ready=n,g.trackPageEvent("experience",e,i,Math.floor(t.getTime()),s,void 0,P.experience)}),100),e.stats&&(e.stats.probesDone=!1,e.stats.postProcess()),e=null})),this.addOnLoadingFinishedCB(function(e){this.args.input&&this.args.input.asset&&"ENOPAD"!==this.currentProvider&&this._sendStats(!0)}.bind(this),!0),this.subscribe("ASSET/LOADINGSTARTED",function(e){e&&!e.refreshed&&(this._sendStats(!1),g.resetCommandCounter())}.bind(this),!0),this.createDom(this.args.FrameWindow,this._postcreate),this.frmWindow&&(this.frmWindow.experience=this,this.frmWindow.getMAB=function(){return this.getActionBar()?this.getActionBar().MAB:this.experience.MAB})}},_sendStats:function(e){var i=this.getInformationsOnAsset();if(i)if(e)try{var n=p.GetSubProbesFrom(this.totalLoadingAssetProfiler,!1);n=t.extend(n,this.computeViewerStats()),g.trackPageEvent("asset",i.type,i.provider,this.totalLoadingAssetProfiler.getTime(),n,void 0,P.asset)}catch(e){}else g.trackPageEvent("infos","asset_type",i.type),g.trackPageEvent("infos","asset_source",i.provider),g.trackPageEvent("infos","tenant",i.tenant),i.source&&g.trackPageEvent("infos","drop_source",i.source)},loadAnnotations:function(e,i){if(1==this.modelLoadComplete)this._loadAnnotations(e,i);else{var t=this;this.subscribeOnce("ASSET/LOADINGFINISHED/",(function(){t._loadAnnotations(e,i)}))}},_loadAnnotations:function(e,i){var t=new FileReader,n=this;t.addEventListener("loadend",(function(e){var t;try{t=JSON.parse(e.srcElement.result)}catch(e){}if(t&&t.experience){S.restoreSession(t);let e={measure:0,clipping:0,annotations:0,pgpFromServer:t.experience.pgpFromServer?1:0};t.experience.DMU&&t.experience.DMU.dmuObjects&&t.experience.DMU.dmuObjects.forEach(((i,t)=>{"MeasureItem"===i.type&&(e.measure=1),"Clipping"===i.type&&(e.clipping=1)})),(s=d.get(n.args.ctx,"ANNOTATION_MANAGER"))&&(e.annotations=s._annotViewpointList.length),g.trackPageEvent("interactions","comment","3d",0,e,void 0,P.comment)}else{var s;(s=d.get(n.args.ctx,"ANNOTATION_MANAGER"))&&s.drawAnnotationsFromJSON(e.srcElement.result,i),n=null,g.trackPageEvent("interactions","comment","2d")}})),t.readAsText(e)},createSocialPanel:function(e,t,n,s,o){i.isSet("3DPlay.Activate3DComment")&&(this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,e&&e&&n&&(this._3dCommentPanel=new m({frameWindow:this.frmWindow,assetId:e,tenantId:t,serviceUrl:n,assetProvider:s,serverToken:o,onCommentClick:function(e){e.data&&e.data.annotationFile&&this.loadAnnotations(e.data.annotationFile,!0)}.bind(this)})))},createComment:function(e){return!!this._3dCommentPanel&&(this._3dCommentPanel.postComment(e.annotation,e.screenshot),this._3dCommentPanel.show())},hideSocialPanel:function(){return!!this._3dCommentPanel&&this._3dCommentPanel.hide()},setOnAnnotationShared:function(e){this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,this.onAnnotationShared=e},refresh:function(){if(this.args.input.asset.originalAsset){var e=this;(new(require("DS/3DPlayConnectors/3DPlayInputPreProcessor"))).run(this.args.input.asset.originalAsset,(function(i){e.load(i,e.args.options),e=null}))}else this.load(this.args.input,this.args.options);return!0},startLoadingPreview:function(e){e&&!0!==this.modelLoadComplete&&(this._hidePreview=!1,this.thumbnailURL(e).then(function(e){this._hidePreview||(this._loadingPreview?(this._loadingPreview.updateThumbnailURL(e),this._loadingPreview.show()):(this._loadingPreview=new w({thumbnailURL:e}),this._loadingPreview.inject(this.args.container)))}.bind(this)).catch((function(e){console.warn("Unable to retrieve thumbnail URL for loading preview"),console.warn(e)})))},stopLoadingPreview:function(){this._hidePreview=!0,this._loadingPreview&&this._loadingPreview.hide()},thumbnailURL:function(e){return new Promise(function(i,t){"3DDRIVE"!=e.provider?e.originalAsset&&e.originalAsset.displayPreview?i(e.originalAsset.displayPreview):e.displayPreview?i(e.displayPreview):"3DSWYM"==e.provider&&(e.preview&&e.preview.thumbnails&&i(e.preview.thumbnails[2].transient_url),e.swymAttr&&e.swymAttr.thumbnails&&i(e.swymAttr.thumbnails[2].transient_url),e.swymAttr&&e.swymAttr.preview&&e.swymAttr.preview.thumbnails?i(e.swymAttr.preview.thumbnails[2].transient_url):v.getMediaInformationFrom3DSwym(e).then((function(e){i(e.result.preview.thumbnails[2].transient_url)})).catch(t)):t("Loading preview disabled for 3DDrive content.")}.bind(this))}})})),define("DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin",["DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/3DPlayUtils/VisibilityUtils","DS/Visualization/ThreeJS_DS","DS/3DPlayWAFRMigration/CommandsManager","DS/3DPlaySupport/SupportList","DS/3DPlayExperienceModule/SceneGraphNodeServices"],(function(e,i,t,n,s,o,r,a){"use strict";var d=["InstanceRep","ReferenceRep"],l=function(e,i){-1==d.indexOf(e)&&r.CROSSHIGHLIGHT.resolveParenting({type:e,physicalid:i},(function(i){void 0!==i&&r.CROSSHIGHLIGHT[i]?r.CROSSHIGHLIGHT[e]=i:r.CROSSHIGHLIGHT[e]=0}))},c=function(i){var t=i.getNodes(),n=[];return t.forEach((function(i){var t=new e;t.addElement(i),n.push(t)})),n},h=function(e,i){var t,n=c(i),s=e.split("/"),o=function(e,i){e.length>0&&e.forEach((function(e){var n,s=e.getLastElement();if(void 0!==s.getPersistentId)"Instance3D"!=s.productType&&1!=s.getPersistentId()||(n=s.getPersistentId())==i[0]&&(i.splice(0,1),t=e);else{var d=a.getType(s);null!=d&&(null==r.CROSSHIGHLIGHT[d]&&l(d,a.getId(s)),r.CROSSHIGHLIGHT[d]&&(n=a.getId(s))),null!=n&&n==i[0]&&(i.splice(0,1),t=e)}var c=e.getChildrenOccurrencePathes();null!=c&&i.length>0&&o(c,i)}))};return o(n,s),t},p=function(e){for(var i=e.pathElement,t="";null!=i;){var n=i.getLastElement(!0);if(void 0!==n.getPersistentId)"Instance3D"!=n.productType&&1!=n.getPersistentId()||(0!==t.length&&(t="/"+t),t=n.getPersistentId()+t);else{var s,o=a.getType(n);null!=o&&(null==r.CROSSHIGHLIGHT[o]&&l(o,a.getId(n)),r.CROSSHIGHLIGHT[o]&&(s=a.getId(n))),null!=s&&(0!==t.length&&(t="/"+t),t=s+t)}i=i.getParentOccurrencePath()}return t},u=function(e){var i=this,t=this.instance.frmWindow.getViewer(),n=c(t),s=function(t){t.length>0&&t.forEach((function(t){var n,o,r=t.getLastElement();a.getId(r)==e&&(null!=(n=a.getType(r))&&-1!==n.indexOf("FEM")&&i.hideNode({pathElement:t}));null!=(o=t.getChildrenOccurrencePathes())?s(o):console.log("FINISHED FEM FILTERING")}))};s(n)};return function(e,d){var g=[];d.addScriptingFunction("subscribeCommandEvent",(function(e){var i=WUX.Events.subscribe({event:"/WUX/AFR/CMD/"+d.ctx+"/"+e.name+"/"+e.cmd.toUpperCase()},(function(){e.cb(e.name+"/"+e.cmd.toUpperCase())}));return g.push(i),i})),d.addScriptingFunction("unsubscribeCommandEvent",(function(e){var i=g.indexOf(e);return i>-1&&(g.splice(i,1),WUX.Events.unsubscribe(e),!0)})),d.disposeFunctions.add((function(){g.forEach((e=>{WUX.Events.unsubscribe(e)})),g=[]})),d.createPathFromId=function(){console.error("Empty Function")},d.addScriptingFunction("createPathFromId",h.bind(e),"",[e,d]),d.createIdFromPath=function(){console.error("Empty Function")},d.addScriptingFunction("createIdFromPath",p.bind(e),"",[e,d]),d.filterFEM=function(){console.error("Empty Function")},d.addScriptingFunction("filterFEM",u.bind(e),"",[e,d]),d.addScriptingFunction("checkCustomType",l.bind(e),"",e);d.addScriptingFunction("initCustomTypes",function(){var e=this.instance.frmWindow.getViewer(),i=c(e),t=function(e){e.length>0&&e.forEach((function(e){var i,n,s=e.getLastElement();void 0!==(i=a.getType(s))&&null==r.CROSSHIGHLIGHT[i]&&l(i,a.getId(s)),null!=(n=e.getChildrenOccurrencePathes())?t(n):console.log("FINISHED CUSTOM TYPES PARSING")}))};t(i)}.bind(e),"",e);var m;d.addScriptingFunction("getSceneContent",function(e){var i=this.instance.frmWindow.getViewer(),t=c(i),n=[],s=function(i,t,n){i.length>0&&i.forEach((function(i){var o,d,c,h,p,u=i.getLastElement();o=a.getId(u),d=a.getName(u),null!=(c=a.getType(u))?(null==r.CROSSHIGHLIGHT[c]&&l(c,o),r.CROSSHIGHLIGHT[c]&&(h={name:d,id:o=t+o,type:c},n.push(h))):o=t,null!=(p=i.getChildrenOccurrencePathes())?s(p,o?o+"/":o,h&&e?h.children=[]:n):h&&(h.id=h.slice(0,-1))}))};return s(t,"",n),n}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("get3DPlayInstanceId",function(){return null==m&&(m=Date.now()+Math.random()),m}.bind(e),"",e);d.addScriptingFunction("set3DPlayInstanceId",function(e){m=e}.bind(e),"",e);d.addScriptingFunction("selectNode",function(e,n){if(this._check()){var o,r=this.instance.frmWindow.getViewer(),a=[],d=[];Array.isArray(e)?d=e:d.push(e),n&&n.highlightColor&&((o={color:new s.Color(0),outlineColor:new s.Color(0),intensity:n.highlightColor.intensity}).color.set(n.highlightColor.color),o.outlineColor.set(n.highlightColor.outlineColor),r.createHighlightSet(o,!0)),d.forEach((function(e){a.push({pathElement:h(e,r),parameters:{highlightColor:o}})})),i.add(a),t.add(a)}this.instance.frmWindow.getViewer().render()}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("unselectNode",function(e,n){if(this._check()){var s=i.get(),o=[];s.forEach((function(e){o.push(p(e))}));var r=[];Array.isArray(e)?r=e:r.push(e);var a=[];r.forEach((function(e){for(var i=0;i<o.length;i++)o[i].indexOf(e)>-1&&a.push(s[i])})),a.forEach((function(e){i.remove(e),t.remove(e)}))}this.instance.frmWindow.getViewer().render()}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("selectAll",function(){if(this._check()){var e=this.getSceneContent(),n=[],s=this.instance.frmWindow.getViewer();e.forEach((function(e){n.push({pathElement:h(e.id,s)})})),i.add(n),t.add(n)}}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("emptySelection",function(){this._check()&&(i.empty(),t.empty())}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("getCurrentSelection",function(){if(this._check()){var e=[];return i.get().forEach((function(i){e.push(p(i))})),e}}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("addSelectionCB",function(e){void 0!==e&&(e.onAddToken=i.onAdd((function(i){Array.isArray(i)||(i=[i]);var t=[];i.forEach((function(e){t.push(p(e))})),e("ADD",t)})),e.onRemoveToken=i.onRemove((function(i){Array.isArray(i)||(i=[i]);var t=[];i.forEach((function(e){t.push(p(e))})),e("REMOVE",t)})))}.bind(e),"",e);d.addScriptingFunction("removeSelectionCB",function(e){void 0!==e&&(void 0!==e.onAddToken&&i.unsubscribe(e.onAddToken),void 0!==e.onRemoveToken&&i.unsubscribe(e.onRemoveToken))}.bind(e),"",e);d.addScriptingFunction("hideNode",function(e,i){if(this._check()){var t=this.instance.frmWindow.getViewer(),s=n.getCurrentSceneGraphState(t);Array.isArray(e)?e.forEach((function(e){null!=e.pathElement?n.reallyApplyVisibilityToAll(s,e.pathElement,0):n.reallyApplyVisibilityToAll(s,h(e,t),0)})):null!=e.pathElement?n.reallyApplyVisibilityToAll(s,e.pathElement,0):n.reallyApplyVisibilityToAll(s,h(e,t),0),this.instance.frmWindow.getViewer().render()}}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("showNode",function(e,i){if(this._check()){var t=this.instance.frmWindow.getViewer(),s=n.getCurrentSceneGraphState(this.instance.frmWindow.getViewer());Array.isArray(e)?e.forEach((function(e){n.reallyApplyVisibilityToAll(s,h(e,t),1)})):n.reallyApplyVisibilityToAll(s,h(e,t),1),this.instance.frmWindow.getViewer().render()}}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("hideAll",function(){if(this._check()){var e=this.instance.frmWindow.getViewer(),i=n.getCurrentSceneGraphState(e),t=c(e);n.reallyApplyVisibilityToAll(i,t,0),e.render()}}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("showAll",function(){if(this._check()){var e=this.instance.frmWindow.getViewer();n.showAll(e),e.render()}}.bind(e),"",e,void 0,d.trackScriptingFunction);d.addScriptingFunction("getCurrentHiddenSet",function(){}.bind(e),"",e);d.addScriptingFunction("getCurrentShownSet",function(){}.bind(e),"",e);var f=[];d.addScriptingFunction("addHideShowCB",function(e){void 0!==e&&(f[WUX.Events.subscribe({event:"/"+d.ctx+"/3DPLAY/HIDE/"},(function(i){0!=i.data.length&&e("HIDE",[p(i.data[0])])}))]=e,f[WUX.Events.subscribe({event:"/"+d.ctx+"/3DPLAY/SHOW_ALL/"},(function(i){e("SHOW_ALL")}))]=e)}.bind(e),"",e);d.addScriptingFunction("removeHideShowCB",function(e){for(var i=f.indexOf(e);i>-1;)f[i]=void 0,WUX.Events.unsubscribe(i.toString()),i=f.indexOf(e)}.bind(e),"",e);var v=[];d.addScriptingFunction("addViewpointChangeCB",function(e){void 0!==e&&(v[WUX.Events.subscribe({event:"/VISU/"},(function(i){if("@onViewpointChange"==i.eventType){var t={position:i.cameraEye.clone(),target:i.cameraTarget.clone(),upDirection:i.cameraUp.clone()};e(t)}}))]=e)}.bind(e),"",[d,e],void 0,d.trackScriptingFunction);d.addScriptingFunction("removeViewpointChangeCB",function(e){for(var i=v.indexOf(e);i>-1;)WUX.Events.unsubscribe(i.toString()),v[i]=void 0,i=v.indexOf(e)}.bind(e),"",[d,e]);d.addScriptingFunction("getCurrentViewpoint",function(){var e=this.frmWindow.getViewer().currentViewpoint;return{position:e.getEyePosition().clone(),target:e.getTarget().clone(),upDirection:e.getUpDirection().clone()}}.bind(d),"",[d,e]);d.addScriptingFunction("setCurrentViewpoint",function(e){Array.isArray(e)&&(e=e[0]);var i=this.getCurrentViewpoint();i.position.x=e.position.x,i.position.y=e.position.y,i.position.z=e.position.z,i.target.x=e.target.x,i.target.y=e.target.y,i.target.z=e.target.z,i.upDirection.x=e.upDirection.x,i.upDirection.y=e.upDirection.y,i.upDirection.z=e.upDirection.z;var t=this.frmWindow.getViewer(),n=t.currentViewpoint.camera.matrix.clone(),s=t.currentViewpoint.camera.quaternion.clone();n.lookAt(i.position,i.target,i.upDirection),s.setFromRotationMatrix(n);var o={position:i.position,orientation:s,distanceToTarget:i.target.distanceTo(i.position),duration:void 0!==i.duration?i.duration:1};t.currentViewpoint.getControl().moveTo(o)}.bind(d),"",[d,e]);d.addScriptingFunction("setVisuMode",function(e){var i=function(e,i){return o.getCommand(e,i)||o.getCommand(e)}(e,d.ctx);i&&i.beginExecute()}.bind(e),"",e,void 0,d.trackScriptingFunction);var P=[],D=["VisuNoShadingEdges","VisuShading","VisuShadingEdges","VisuShadingEdgesNoSmoothEdges","VisuShadingEdgesHiddenEdges","VisuShadingMaterial","VisuShadingMaterialEdges","VisuShadingIllustration","VisuOrthographicView","VisuPerspectiveView"];d.addScriptingFunction("addVisuModeCB",function(e){void 0!==e&&D.forEach((function(i){P[WUX.Events.subscribe({event:"/WUX/AFR/CMD/"+d.ctx+"/"+i+"/"},(function(t){e("VISU_MODE",[i])}))]=e}))}.bind(e),"",e);d.addScriptingFunction("removeVisuModeCB",function(e){for(var i=P.indexOf(e);i>-1;)WUX.Events.unsubscribe(i.toString()),P[i]=void 0,i=P.indexOf(e)}.bind(e),"",e);d.addScriptingFunction("setNodeProperties",function(e,i){if(this._check()){var t=this.instance.frmWindow.getViewer();if(e){var s=n.getCurrentSceneGraphState(t);s&&(i.opacity&&s.setOpacity(e,i.opacity),i.color,i.position,void 0!==i.visibility&&i.visibility)}}}.bind(e),"",e,void 0,d.trackScriptingFunction)}}));var enopad=[];"false"!=window.localStorage.getItem("3DPlay.pad3DViewer")&&(enopad=["DS/PADUtils/PADUtilsServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","i18n!DS/PADUtils/assets/nls/PADUtils","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSharedSettings"],window.WebSystem||console.error("This file is loaded BEFORE 3DPlay runtime (3DPlayHelper) You may experience some issues"),window["3DPlay.AFRV2"]||enopad.push("DS/ENOPAD3DViewer/PAD3DViewer")),define("DS/3DPlayExperienceModule/PlayExperience3D",["DS/WebappsUtils/WebappsUtils","DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayExperience","DS/3DPlayWAFRMigration/CommandsManager","DS/WebUtils/Profiler","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/TestBrowser","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/WebSystem/Nls","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/WebInfraUI/Notification","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/WebViewer/SceneGraphHelper","DS/3DPlayExperienceModule/SceneGraphNodeServices","css!DS/3DPlayExperienceModule/assets/PlayExperience3D","DS/WebUtils/ProbesManager","i18n!DS/3DPlayHelper/assets/nls/SplashScreen","UWA/Promise","DS/WebRunloop/Runloop","DS/WebUtils/Tracker","DS/WebUtils/Network","DS/VisuTools/StatsComputer","i18n!DS/3DPlayExperienceModule/assets/nls/3DPlayExperienceModule","DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/Controls/ProgressBar","DS/UIKIT/Tooltip","DS/3DPlaySupport/ExperiencesList","DS/ApplicationFrame/FrameWindow3D","DS/WebSystem/Preference","DS/WebSystem/App","DS/Selection/CSOManager","DS/WebInfraUI/ConfirmBox","i18n!DS/3DPlayCommands/assets/nls/CmdENOPADStream","i18n!DS/3DPlay/assets/nls/3DPlay","DS/WebUtils/Logger","DS/WebSystem/SessionManager","DS/DMU3DPlayAPIWeb/DMUMeasureSectionExportImportAPI","DS/3DPlayAnnotation3D/AnnotationManagerUtils","DS/DMUBaseExperience/DMUContextManager","DS/3DPlayWAFRMigration/Framewindow"].concat(enopad),(function(WebappsUtils,_3DPlay,Environment,UWA,EXPERIENCE,CommandsManager,Profiler,PanelManager,TestBrowser,Node3D,WorldOrientation,StringUtils,ContextedSingleton,NLS,ModelLoader,THREE,Notification,SceneGraphOverrideSet,SceneGraphHelper,SceneGraphNodeServices,Css,ProbesManager,SplashScreenNLS,UWAPromise,Runloop,Tracker,Network,StatsComputer,prefs,PlayExperience3DScriptingPlugin,VisuEventsManager,WUXEvents,WUXProgressBar,Tooltip,ExperiencesList,FrameWindow3D,Preference,App,CSOManager,ConfirmBox,CmdENOPADStreamNLS,NLS3DPlay,Logger,SessionManager,DMUMeasureSectionExportImportAPI,AnnotationManagerUtils,DMUContextManager,WAFR2Utils,PADUtilsServices,NLSPAD3DViewer,NLSPADUtuils,PADSettingsMgt,PAD3DViewerModelServices,PADSharedSettings,ENOPAD3DViewer){"use strict";var VCXExperienceBase;WAFR2Utils.isAFR2()&&(ENOPAD3DViewer=!0);var requirePromise=new UWAPromise((function(e){WAFR2Utils.isAFR2()?e():require(["DS/VCXWebExperienceBase/VCXExperienceBase"],(function(i){VCXExperienceBase=i,e()}))})),endEdit,logger=Logger("3DPlay.PlayExperience3D"),prefName="3DPlay.CGRPolicy",visuModeOptions={MaterialMode:{needCGR:!0,needMaterial:!0},Illustration:{needCGR:!0,needMeshInRam:!0},Edges:{needCGR:!0},AxisFilter:{needCGR:!0},PlanesFilter:{needCGR:!0},LinesFilter:{needCGR:!0},PointsFilter:{needCGR:!0}},exp={name:"PlayExperience3D",refresh:function(e){if(this.acceptRefresh()){if(CommandsManager.endAll(this.args.ctx),e||(SessionManager.clearSession(),AnnotationManagerUtils.deleteAnnotationManager(this.args.ctx)),"ENOPAD"!==this.currentProvider)return this._parent();this.pad3DViewer&&this.pad3DViewer.getRoots().length>0&&(this._materialModeChanged&&e?(this.pad3DViewer.getController().refreshForMaterials(),this._materialModeChanged=!1):(e||this.changeVisuSettingIfPossible(),this.pad3DViewer.refresh()))}return!0},acceptSwitch:function(){var e=!1,i=this.args.input.asset;return Array.isArray(i)&&(i=i[0]),null==i?e=!0:i.provider&&(e="FILE"!==i.provider),e},_onModelLoadingCompleted:function(){this.loadingAsset.Load_Session&&this.loadingAsset.Load_Session.end()},computeViewerStats:function(){var e=new StatsComputer(this.frmWindow.getViewer()),i=e.computeStats();if(i){i.DownloadSize=Math.floor(this.loadingAsset.size/1e3),e.viewer=null,e=null}return i},createScriptingAPI:function(){this._parent();var e=this.args.options.helper||ContextedSingleton.get(this.args.ctx,"helper");e&&PlayExperience3DScriptingPlugin(e,this)},init:function(options){if(options&&options.options&&options.options.NR&&!0===options.options.NR.active){var moduleNR="DS/3DPlayWebNRTools/NRModeManager";require([moduleNR],(function(e){logger.warn("NRModeManager call completed in DefaultExp"),_this.NRMgr=new e({frmWindow:_this.frmWindow})})),!0===Environment.isSet("3DPlay.NRPrototype.DebugCmd")&&(options.workbenchs=options.workbenchs||[],options.workbenchs.unshift({name:"3DPlayNRExperience",module:"3DPlayNRExperience"}))}var expName;options.workbenchs=options.workbenchs||[];try{expName=options.input.experience.filename.match(/\/(\w*)$/)[1]}catch(e){expName=null}var experiencesWithoutQM=["CAT3DSketchExperience","3DPlay360Experience"],wkbName;((App.is3DSwym()||App.is3DDrive())&&expName&&!experiencesWithoutQM.includes(expName)&&options.workbenchs.unshift({name:"3DPlayQualityManager",module:"3DPlay"}),Environment.isSet("3DPlay.publishToMakeCmdTest")&&options&&options.input&&options.input.asset&&options.input.asset.provider&&("FILE"===options.input.asset.provider||"3DDRIVE"===options.input.asset.provider||"3DSWYM"===options.input.asset.provider)?Environment.set("3DPlay.publishToMakeCmdActivate","true"):Environment.remove("3DPlay.publishToMakeCmdActivate"),this.evtTokenMouse=[],void 0===VisuEventsManager._isInit&&VisuEventsManager.init(),this.reframeConfiguration={},this.noGeoTimO="timeout",this.noGeoInt="interval",this.loadingAsset={size:0},this.pad3DViewerTokens=[],options=options||{},this.does3DPlayDoTheRequestNewExperienceBase=!CommandsManager.isAFR2(),options.input&&options.input.experience&&("DS/VCXWebComposer3DPlayExperience/VCXWebPlayerIn3DPlayExperience"===options.input.experience.filename||"DS/XCT3DPlayIntegratability/XCT3DPlayIntegratability"===options.input.experience.filename)&&(this.does3DPlayDoTheRequestNewExperienceBase=!1),window.widget&&(this._hasLightbox=widget.hasLightbox),void 0===options.commandApplication||!0===options.commandApplication)&&(wkbName=this._iOS||this._android?"3DPlayExperience3D_mobile":"3DPlayExperience3D",options.workbenchs.unshift({name:wkbName,module:"3DPlay"}),App.is3DPlay()&&(this._hasLightbox?options.workbenchs.push({name:"EnopadRightPanel_LightboxMode",module:"3DPlay"}):options.workbenchs.push({name:"EnopadRightPanel",module:"3DPlay"})),Environment.isSet("3DPlay.VisuPanel")&&options.workbenchs.push({name:"3DPlayVisuPanel",module:"3DPlayExperienceModule"}));function isLoadAnimationValid(val){return"Full"===val||"None"===val||"Optimized"===val||!isNaN(val)&&eval(val)>=0&&eval(val)%1==0}var EnvLoadAnimation=Environment.get("3DPlay.LoadAnimation");isNaN(EnvLoadAnimation)||(EnvLoadAnimation=eval(EnvLoadAnimation)),isLoadAnimationValid(EnvLoadAnimation)?options.options.loadAnimation=EnvLoadAnimation:!1===isLoadAnimationValid(options.options.loadAnimation)&&(options.options.loadAnimation="Optimized"),this.useSession&&(options.session={ToCopy:["VisuViewSettings"],toMigrate:[{src:"3DPlay.scenarioActivated",dst:"Scenario"}]}),this._parent(options),this.modelLoadCount=0,this.modelTotalCount=0,this.modelLoadComplete=void 0,this.showSplashBetweenLoad=!1,NLS.loadNls("Visualization/3DXML_errors");var _this=this,hideRefAxisCount=0;this.hideRefAxis=function(){if(++hideRefAxisCount>0&&_this&&_this.frmWindow){var e=_this.frmWindow.getViewer();e&&e.setReferenceAxisSystem&&(e.setReferenceAxisSystem(!1),e.render())}},this.showRefAxis=function(){if(0===(hideRefAxisCount=Math.max(0,hideRefAxisCount-1))&&_this&&_this.frmWindow){var e=_this.frmWindow.getViewer();e&&e.setReferenceAxisSystem&&(e.setReferenceAxisSystem(!0),e.render())}};var phaseProgress=this.getPhaseProgress(),ctx=_this.args.ctx,viewpoint,viewer,frmWindow;this.onModelLoadingError=function(e){if(_this.hadLoadingError=!0,void 0!==e.rsc)NLS.nls(e.rsc,e.type,(function(i){e.text&&(i+=e.text),_3DPlay.sendEvent(ctx,eventType.notif,e.level,{msg:i}),e.abort&&phaseProgress.hideProgressBar()}));else if(void 0!==e.nls&&null!==e.nls)if("Convert_SERVICE_NOT_FOUND"===e.type&&(_this.hasConvertFailed?e.level=Notification.fatal:_this.hasConvertFailed=!0),null==e.fileNls){var i=NLS3DPlay[e.nls]+(e.text?e.text:"");_3DPlay.sendEvent(ctx,eventType.notif,e.level,{msg:i}),e.abort&&phaseProgress.hideProgressBar()}else{var t=["i18n!DS/"+e.fileNls.split("/")[0]+"/assets/catnls/"+e.fileNls.split("/")[1]];require(t,(function(i){var t=i[e.nls.split(".")[0]][e.nls.split(".")[1]]+" : "+(e.txt?e.txt:"");_3DPlay.sendEvent(ctx,eventType.notif,Notification.warning,{msg:t})}))}else NLS.nls("Visualization/3DXML_errors","ERROR_"+e.type,(function(i){var t;"FORMAT"===e.type?(t=NLS3DPlay.LoadingError_FORMAT+":"+StringUtils.getExtension(e.url),_this=!1,_3DPlay.displayFatalError({ctx:ctx,msg:t})):"NO_GEOMETRY"===e.type?(_3DPlay.displayNotification({ctx:ctx,msg:i}),phaseProgress.hideProgressBar()):(t=i+" : "+e.url,_3DPlay.sendEvent(ctx,eventType.notif,Notification.error,{msg:i}),phaseProgress.hideProgressBar()),void 0!==t&&logger.error(t)}));_this&&_this.publish("ASSET/LOADINGERROR",UWA.extend({ctx:ctx},e))},this.onSelectCallback=function(e){let i=!1;if(CommandsManager.isAFR2()){CommandsManager.getCurrentCmdId()&&(i=!0)}else{let e=CommandsManager.getCommands(_this.frmWindow.experience.ctx);if(!e)return;let o=Object.keys(e);for(var t=0;t<o.length;t++){var n=o[t];if("myDefaultCmd"!==n){var s=e[n];if(s&&s.isRunning()){i=!0;break}}}}if(!1===i&&_this.frmWindow.getViewerFrame().offsetHeight>240&&_this.frmWindow.getViewerFrame().offsetWidth>240){var o=CSOManager.get(),r=!1;if(1===o.length){var a=o[0].pathElement||o[0];if(a&&a.externalPath)for(t=0;t<a.externalPath.length&&!r;t++)if("annotGroupNode"===a.externalPath[t].name){r=!0;break}}if(!0===r){var d=a.externalPath[a.externalPath.length-1].annotID,l=ContextedSingleton.get(_this.frmWindow.experience.ctx,"ANNOTATION_MANAGER");if(l){var c=l.getAnnotationTypeWithID(d),h=_this.frmWindow.getViewer(),p=_this.frmWindow.experience.ctx;if("text"===c){h.shapeEditionData={id:d};let e=CommandsManager.getCommand("AnnotationCommand3DText",p);e&&e.isEnabled()&&e.begin()}else{var u={x:e.event._currentPosition.x,y:e.event._currentPosition.y};h.shapeEditionData={point:u};let i=CommandsManager.getCommand("AnnotationCommand3DEditShape",p);i&&i.isEnabled()&&i.begin()}}}}},this.countRender=0,this.countBeforeRender=1,this.modelPrevLoadCount=0,this.renderTime=0,this.postCreate=function(){var e,i=this.args;i&&i.visu&&!0!==i.visu.showReferenceAxisSystem&&hideRefAxisCount++,(viewpoint=this.frmWindow.getViewer().currentViewpoint)&&(viewpoint.control.lockZ=!0,viewpoint.control.setRotationSpeed(3.5)),viewer=this.frmWindow.getViewer();try{e=this.pad3DViewer?this.getRootBag():null}catch(a){}if(frmWindow=this.frmWindow,null===e&&(this.rootbag=new Node3D("RootBag"),viewer.addNode(this.rootbag),e=this.rootbag),this.modelLoader=new ModelLoader({node:e,viewer:viewer}),"DS/3DPlayModelViewer/3DPlayModelViewer"===this.args.input.experience.filneame&&this.modelLoader.setNoMeshInRAM(!0),this.modelLoader.setViewer&&this.modelLoader.setViewer(viewer),i.modelLoader&&void 0!==i.modelLoader.readDecoration&&(this.modelLoader.readDecoration=i.modelLoader.readDecoration),this.modelLoader.setOnProgressCallback(this.onModelLoadingProgression),this.modelLoader.setOnLoadedCallback(this.onModelLoadingCompleted),this.modelLoader.setOnErrorCallback(this.onModelLoadingError),this.token=CSOManager.onAdd(this.onSelectCallback),this.pad3DViewer&&this.pad3DViewer.getController()._BIProxy.addEvent("ApplyNGFilter",(function(){try{Tracker.trackPageEvent("interactions","6wTags",this.experience.getInformationsOnAsset().type)}catch(e){}this.onModelLoadingStarted(!1)}),this),viewer.getBagNode=function(){return logger.error("Please use 3DPlayExperience.getRootBag() rathen the Viewer.getBagNode()"),this.getRootBag()}.bind(this),viewer.deleteSceneGraphState=function(e){var i=this.getSceneGraphOverrideSetManager();if(i)for(var t=i.getNumberOfSceneGraphOverrideSets();t--;){var n=i.getSceneGraphOverrideSetAt(t);n&&n.privateName===e&&(i.removeSceneGraphOverrideSetAt(t),n.helper&&(n.helper.dispose(),n.helper=null),n.dispose&&n.dispose())}},viewer.getSceneGraph=function(e){var i=this.getSceneGraphOverrideSetManager();if(i)for(var t=i.getNumberOfSceneGraphOverrideSets();t--;){var n=i.getSceneGraphOverrideSetAt(t);if(n&&n.helper&&n.helper.name===e)return n.helper}return null},viewer.createSceneGraph=function(e,i){var t=this.getSceneGraph(e);if(void 0===i&&(i=this.getBagNode()),!t&&i){var n=new SceneGraphOverrideSet(i),s=this.getSceneGraphOverrideSetManager();s&&s.pushSceneGraphOverrideSet(n)&&(t=n.helper=new SceneGraphHelper(n,e))}return t},this.EventDisposer.add(this.subscribe("ASSET/CHANGE",(function(e){_this.reframeConfiguration.hasViewpointSet=!1,SessionManager.clearSession()}))),this.addOnLoadingFinishedCB((function(i){if(_this&&ExperiencesList.is3DPlay3DExperience(_this)){if(_this.modelFailure){try{var t=_this.getInformationsOnAsset();Tracker.trackPageEvent("errors","no_access",t.type)}catch(e){}_3DPlay.displayNotification({ctx:i.ctx,msg:NLS3DPlay.LoadingDocument404})}else if(0===_this.getRootBag().getBoundingSphere().radius&&"FILE"===_this.currentProvider&&!_this.hadLoadingError){try{t=_this.getInformationsOnAsset();Tracker.trackPageEvent("errors","input_no_geometry",t.type)}catch(e){}_3DPlay.sendEvent(_this.ctx,eventType.notif,Notification.warning,{msg:NLS3DPlay.LoadingError_NO_GEOMETRY})}var n=e.getChildByName("AxisSystems");n&&(void 0===frmWindow.hello?(frmWindow.hello=!0,n.setVisibility(!0)):n.setVisibility(frmWindow.hello));var s=_this.args.input.annotData;s&&Environment.get("3DPlay.PersistedAnnotationsEnabled")&&setTimeout((function(){let e=AnnotationManagerUtils.getAnnotationManager(ctx);e&&e.drawAnnotationsFromJSON(s)}),200)}})),this.autoReframe=!0,this.useSession){this.reframeConfiguration.viewpointCB=function(e){SessionManager.setSessionEntry("viewpoint",e)};var t=function(){var e=AnnotationManagerUtils.getAnnotationManager(this.args.ctx);e&&SessionManager.isReady()&&SessionManager.setSessionEntry("annotations",e.saveAnnotationsToJSON(void 0,!0))}.bind(this);this.subscribe("3DPLAY/ANNONATION/ADD",t,!0),this.subscribe("3DPLAY/ANNONATION/UPDATE",t,!0),this.subscribe("3DPLAY/ANNONATION/REMOVE",t,!0),this.subscribe("3DPLAY/ANNONATION/SESSION",(function(e){e||SessionManager.setSessionEntry("annotations",void 0)}),!0);var n=this;function d(e){SessionManager.isReady()&&(_this&&e&&"DMUSection"===e.dmuObject.getType()||"DMUMeasure"===e.dmuObject.getType()&&!e.dmuObject._isInCreationState)&&_this.updateSession()}this.disposeFunctions.add((function(){n=null,t=null})),SessionManager.register({key:"annotations",clearCB:function(e){AnnotationManagerUtils.getAnnotationManager(n.args.ctx,n.frmWindow).deleteAllAnnotations(),e()},readCB:function(e,i,t){AnnotationManagerUtils.getAnnotationManager(n.args.ctx,n.frmWindow).drawAnnotationsFromJSON(e,!0),t()}}),Tracker.pause(!0),this.addViewpointChangeCB(this.reframeConfiguration.viewpointCB),Tracker.pause(!1),SessionManager.register({key:"viewpoint",readCB:function(e,i,t){_this.autoReframe=!1,_this.reframeConfiguration.hasViewpointSet=!0,_this.setCurrentViewpoint(e),_this.frmWindow.getViewer().animate(),setTimeout(t,20)}}),SessionManager.register({key:"VisuViewSettings",readCB:function(e,i,t){viewer.applyViewPanelSettings(e),t&&t()}}),SessionManager.register({key:"pgpFromServer",readCB:function(e,i,t){(App.is3DSpace()||App.is3DPlay())&&PADSettingsMgt.getSetting("pgpFromServer")!==e&&(PADSettingsMgt.setSetting("pgpFromServer",e),_this.refresh(!0)),t&&t()},writeCB:function(){return PADSettingsMgt.getSetting("pgpFromServer")}}),SessionManager.register({key:"DMU",clearCB:function(e){let i=DMUContextManager.getReviewContext({context:_this.pad3DViewer});i&&i.getTransientReviewBag().removeDMUObjects(),e&&e()},readCB:function(e,i,t){new DMUMeasureSectionExportImportAPI({ctxViewer:_this.pad3DViewer}).importModel(e),t&&t()}});var s=DMUContextManager.getEventsController({context:this.pad3DViewer});s&&(this.DMUTokens=[s.addEvent("onDMUObjectInitialized",d)],this.DMUTokens.push(s.addEvent("onDMUObjectDeleted",d)),this.disposeFunctions.add((function(){_this.DMUTokens.forEach((e=>{s.removeEvent(e)})),_this.DMUTokens=[],s=null})))}this.updateSession=async function(){if(DMUContextManager.getReviewContext({context:this.pad3DViewer})){let e=await new DMUMeasureSectionExportImportAPI({ctxViewer:this.pad3DViewer}).exportModel();e?SessionManager.setSessionEntry("DMU",e):console.error("error exportModel NULL")}},this.EventDisposer.add(this.subscribe("ASSET/LOADINGSTARTED",(function(){_this.hadLoadingError=!1,_this.modelFailure=!1,_this.oldradius=0,_this.autoReframe=!_this.reframeConfiguration.hasViewpointSet,_this.reframeConfiguration.userclicked=!1})));this.addCallbacks({asset:{LoadingFinished:function(){_this.autoReframe&&viewpoint.reframe(void 0,0),viewer.render({updateInfinitePlane:!0})}}});var o=function(){_this.autoReframe=!1,_this.reframeConfiguration.userclicked=!0};let r=CommandsManager.isAFR2()?this.frmWindow.getImmersiveFrame():this.frmWindow.getViewerFrame();this.evtTokenMouse.push(VisuEventsManager.addEvent(r,"onLeftMouseDown",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(r,"onRightMouseDown",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(r,"onMiddleMouseDown",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(r,"onMouseWheel",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(r,"onTouch",o)),r=CommandsManager.isAFR2()?this.frmWindow.getViewerFrame():this.frmWindow.getUIFrame(),this.PanelManager.createTopMenu({ctx:i.ctx,container:r,experience:this,showBubbleMenu:this.args.options.showBubbleMenu}),this.PanelManager.createDefaultHelp(),this.disposeFunctions.add((function(){o=null}))},this.disposeFunctions.add((function(){frmWindow=null,viewpoint=null,viewer=null,_this=null}))},initExperienceBase:function(e,i){this.frmWindow._experienceBase=e,i&&i(0)},requestNewExperienceBase:function(){this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&(this.disposeExperienceBase(),this.experienceBase._ManagerSet.unInitialize(),this.experienceBase.Clean(),this.frmWindow._experienceBase=null,this.experienceBase.webApplication=null,this.experienceBase.modelLoader=null,this.experienceBase=null),this.experienceBase=new VCXExperienceBase(null),this.experienceBase.webApplication=this,this.frmWindow._experienceBase=this.experienceBase,this.initExperienceBase(this.experienceBase),this.experienceBase._ManagerSet.initialize();var e=this.experienceBase._ManagerSet.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.experienceBase._ManagerSet.postInitialize(),e&&e.setRootNode(this.getRootBag()),this.profileFrame=Profiler.start("Runloop"),this.runloop=new Runloop({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase.webApplication=this,this.experienceBase},requestNewExperienceBaseAsync:function(){var e=this;ProbesManager.begin("requestNewExperienceBaseAsync");var i=UWA.Promise.resolve().then((function(){return e.runloop&&(e.runloop.stop(),e.runloop.dispose(),e.runloop=null),e.experienceBase&&e.disposeExperienceBase()})).then((function(){return e.experienceBase&&e.experienceBase._ManagerSet&&e.experienceBase._ManagerSet.unInitialize(!0)})).then((function(){return e.experienceBase&&(e.experienceBase.Clean(),e.experienceBase.webApplication=null,e.experienceBase=null),e.experienceBase=new VCXExperienceBase(null),e.frmWindow._experienceBase=e.experienceBase,e.experienceBase.requestPromise=i,e.experienceBase.initialize&&e.experienceBase.initialize(e)})).then((function(){return e.experienceBase.webApplication=e,new UWA.Promise((function(i,t){e.initExperienceBase(e.experienceBase,i)}))})).then((function(){return e.experienceBase._ManagerSet.initialize(!0)})).then((function(){var i=e.experienceBase._ManagerSet.getManager("VCXContextManager");if(i){i.setFrameWindow(e.frmWindow);var t=e.getRootBag();i.setRootNode(t),e.frmWindow.getViewer().addNode(t)}return e.experienceBase._ManagerSet.postInitialize(!0)})).then((function(){ProbesManager.end("requestNewExperienceBaseAsync")})).then((function(){return e.profileFrame=Profiler.start("webApplication::frame"),e.runloop=new Runloop({data:e,func:e.runloopFunc}),e.runloop.start(),e.experienceBase}));return i},runloopFunc:function(e){this.profileFrame.start();var i=this.profileFrame.addProfile("3DPlay::Step");if(this.skipRender=!1,this._step.apply(this,[arguments[0].time,arguments[0].profiler]),i.stop(),this.skipRender)this.skipRender=!1;else{if(this.nbrender=this.nbrender||0,this.nbrender++,this.experienceBase){var t=this.experienceBase._ManagerSet.getManager("VCXContextManager"),n=UWA.extend({viewer:this.frmWindow.getViewer()},e,!0);if(n.profiler=this.profileFrame.addProfile("managerSet::update"),this.experienceBase._ManagerSet.update(n),this.skipRender)this.skipRender=!1;else{var s=this;t.applyToViewers((function(e){e._modelEvent&&!e.registredCBs&&(e.registredCBs={preToken:e._modelEvent.subscribe({event:"PreRender"},(function(e){e.profiler=s.profile_animate.addProfile("preRender"),s.experienceBase._ManagerSet.preRender(e),s.profile_render=s.profile_animate.addProfile("render")})),postToken:e._modelEvent.subscribe({event:"PostRender"},(function(e){e.renderingTime=s.profile_render.stop(),e.profiler=s.profile_animate.addProfile("postRender"),s.experienceBase._ManagerSet.postRender(e)}))},e.defaultAnimationLoop=!1,s.disposeFunctions.add((function(){s=null}))),s.profile_animate=s.profileFrame.addProfile("viewer["+e.id+"]::animate"),e.animate(),s.profile_animate.stop()}))}return n.profiler=this.profileFrame.addProfile("managerSet::postUpdate"),this.experienceBase._ManagerSet.postUpdate(n),void this.profileFrame.stop()}this.frmWindow.getViewer().animate()}},dispose:function(e){if(this.removeViewpointChangeCB(this.reframeConfiguration.viewpointCB),CSOManager.unsubscribe(this.token),this.token=null,this.evtTokenMouse&&(this.evtTokenMouse.forEach((function(e){VisuEventsManager.removeEventFromToken(e)})),this.evtTokenMouse=void 0),this.noGeoTimO&&clearTimeout(this.noGeoTimO),this.noGeoInt&&clearInterval(this.noGeoInt),endEdit&&App.isInWidget()&&widget.removeEvent("endEdit",endEdit),this.stats&&(this.stats.dispose&&this.stats.dispose(),this.stats=null),_3DPlay.endAllCommands({ctx:this.ctx,resetDefaultCmd:!0}),this.publish("EXPERIENCE/DISPOSE",{exprience:this}),this.intervalTimer&&clearInterval(this.intervalTimer),this.modelLoader.abort(),this.modelLoader.dispose&&this.modelLoader.dispose(),this.modelLoader=null,this.pad3DViewer){this.deletePad3DViewerCBs();var i=!1;if(!0!==(e=e||{}).disposeFrameWindow&&void 0!==e.disposeFrameWindow||(i=!0,e.disposeFrameWindow=!1),!1===e.disposeFrameWindow&&this.experienceBase&&this.experienceBase._ManagerSet){var t=this.experienceBase._ManagerSet.getManager("VCXContextManager");t&&(t._nRootNode=null)}var n=this.frmWindow.getViewer();if(this.viewerVisuModeCB.forEach((e=>{n.unsubscribe(e)})),delete this.viewerVisuModeCB,n.deleteSceneGraphState=null,n.getSceneGraph=null,n.createSceneGraph=null,n.getBagNode=null,this.experienceBase){this.frmWindow._experienceBase=null;var s=this;this.disposeExperienceBase((function(){s.runloop&&(s.runloop.stop(),s.runloop.dispose(),s.runloop=null);var e=s.experienceBase&&s.experienceBase._ManagerSet&&s.experienceBase._ManagerSet.unInitialize();e||(e=new UWAPromise((function(e){e()}))),e.then((function(){s.experienceBase._ManagerSet.getManager("VCXContextManager").applyToViewers((function(e){e.registredCBs&&(e.defaultAnimationLoop=!0,e.disposed||(e._modelEvent.unsubscribe(e.registredCBs.preToken),e._modelEvent.unsubscribe(e.registredCBs.postToken)),delete e.registredCBs,e.animate())})),s.experienceBase&&(s.experienceBase.Clean(),s.experienceBase.webApplication=null,s.experienceBase=null),s=null}))}))}if(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.pad3DViewerConfig.changeVisuModeCmdAvailability&&(this.pad3DViewer.changeVisuModeCmdAvailability=null,this.pad3DViewer.changeVisuModeCmdAvailability=this.pad3DViewerConfig.changeVisuModeCmdAvailability,this.pad3DViewerConfig.changeVisuModeCmdAvailability=null),this._parent(e),i){if(this.pad3DViewer){this.frmWindow&&this.frmWindow.removeReviewModel&&this.frmWindow.removeReviewModel();try{this.pad3DViewer.getController()._BIProxy._biFilter.die()}catch(e){}let e=this.pad3DViewer.getFrameWindow();e._viewpoint=null,e._sceneGraphTree=null,e._private_sceneGraph=null,CommandsManager.isAFR2()||this.pad3DViewer.destroy(),this.repLoadingStuff&&(this.repLoadingStuff.hide(),this.repLoadingStuff.parentNode.removeChild(this.repLoadingStuff),this.repLoadingStuff=null)}}else{this.resetWidgetPreferences(),n.setPicking(this.pad3DViewerConfig.picking),n.setPrePicking(this.pad3DViewerConfig.pPicking),this.pad3DViewer.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!0,this.pad3DViewerConfig.ControlMode),this.pad3DViewer.setRobotVisibility(this.pad3DViewerConfig.Robot),this.pad3DViewer.setDefaultProgressBarVisibility(this.pad3DViewerConfig.Progress),this.pad3DViewer.setAutomaticReframePolicy(this.pad3DViewerConfig.Reframe),this.pad3DViewer.setDefaultContextualMenuVisibility(!1),this.pad3DViewer.setDefaultContextualBarVisibility(!1),this.RuntimeMode.dynamicRepLoading&&(this.repLoadingStuff.hide(),this.repLoadingStuff.parentNode.removeChild(this.repLoadingStuff),this.repLoadingStuff=null),this.pad3DViewer.elements.container.addEventListener("dragenter",this.pad3DViewer._dndCB[0]),this.pad3DViewer.elements.container.addEventListener("dragover",this.pad3DViewer._dndCB[0]),this.pad3DViewer.elements.container.addEventListener("dragleave",this.pad3DViewer._dndCB[1]),this.pad3DViewer.elements.container.addEventListener("dragend",this.pad3DViewer._dndCB[1]),this.pad3DViewer.elements.container.addEventListener("drop",this.pad3DViewer._dndCB[2]),this.pad3DViewerConfig.toShow();var o=this.getRootBag();(o&&o.children&&o.children.length>0||this.pad3DViewer.getRoots().length>0)&&this.pad3DViewer._dropZoneContainer.elements.container.hide(),this.pad3DViewer._dropZoneContainer.options.mode=this.pad3DViewerConfig.DropMode}this.pad3DViewerConfig=null,this.pad3DViewer=null}else this._parent(e)},preCreate:function(){var e={visu:{antiAliasing:!0,useShadowMap:!0,infinitePlane:!0,displayGrid:!1,displayLines:!1,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1,picking:!0,displayPicking:!0,prePicking:!1,displayprePicking:!1,highlight:{trapSelection:!1},autoUpdatePlane:!0,useMirror:!0,defaultAnimationLoop:!1,multiViewerFix:!0,useViewPanel:!0,viewPanelConfig:{uiConfig:{useShadingIllustration:!0}}},ui:{displayTree:Environment.isBoolActive("3DPlay.Debug.DisplayTree"),displayActionBar:!0}};Environment.isSet("3DPlay.VisuPanel")&&(e.visu.useViewPanel=!0),window.nearFarBigScale=!0,this.args=UWA.extend(e,this.args,!0),this.args.touch="ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0,(App.is3DSwym()||App.is3DDrive())&&(this.mabModel&&this.mabModel.sections&&this.mabModel.sections.push({id:"QualityManager",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"}),this.tabletMabModel&&this.tabletMabModel.sections&&this.tabletMabModel.sections.push({id:"QualityManager",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"}))},_step:function(){if(!1===this.modelLoadComplete){if(!this.does3DPlayDoTheRequestNewExperienceBase)return void(this.forceRender=!0);this.skipRender=!0;var e=!1,i=!1,t=this.frmWindow.getViewer();if(this.forceRender)this.forceRender=!1,e=i=!0;else if(this.newPart)if(this.newPart=!1,"Optimized"===this.args.options.loadAnimation){if(this.autoReframe){var n=t.getRootNode().getBoundingSphere().radius;1.3*this.oldradius<n&&(i=!0,e=!0,this.oldradius=n,this.modelPrevLoadCount=this.modelLoadCount)}if(!i){var s=this.modelPrevLoadCount+5;this.modelTotalCount>0&&(s=this.reframeConfiguration.userclicked?this.modelPrevLoadCount+1:this.modelPrevLoadCount+Math.max(1,.08*this.modelTotalCount)),this.modelLoadCount>s&&(this.modelPrevLoadCount=s,i=!0)}}else"Full"===this.args.options.loadAnimation?(e=!0,i=!0):"None"===this.args.options.loadAnimation||this.modelLoadCount>this.modelPrevLoadCount+this.args.options.loadAnimation&&(this.modelPrevLoadCount=this.modelLoadCount,e=!0,i=!0);if(e&&this.autoReframe&&t.currentViewpoint.reframe(),i||this.reframeConfiguration.userclicked)this.skipRender=!1,t.render({updateInfinitePlane:!0});else{var o=t.div.clientWidth||1,r=t.div.clientHeight||1;t.SCREEN_WIDTH===o&&t.SCREEN_HEIGHT===r||(this.skipRender=!1)}}this._parent()},preRenderCB:function(){},postRenderCB:function(){},setOnLoadedCallback:function(e){this.modelLoader&&this.modelLoader.setOnLoadedCallback(e)},setOnProgressCallback:function(e){this.modelLoader&&this.modelLoader.setOnProgressCallback(e)},getModelLoader:function(){return this.modelLoader},getRootBag:function(){if(this.pad3DViewer){var e=this.pad3DViewer.getRootBagPath();if(e)return e.getLastElement()}if(this.rootbag)return this.rootbag;var i=this.frmWindow.getViewer();return i.getBagNode?i.getBagNode():i.getRootNode()},createPad3DViewerCBs:function(){this.subscribeToReloadEvents(),this.configureController=function(e){!1===this.isLoadingFinished()&&this.clearView(),logger.warn("DEBUG-configureController",e),this.pad3DViewer.setDefaultStreamToLoad(e.needCGR||e.haveCGR||"index"!==Preference.get(prefName));var i=this.pad3DViewer.getController();if(e.needMeshInRam)if("ENOPAD"===this.currentProvider){this.pad3DViewer.getRoots()[0];this._haveMeshInRam(i)||i.lockGlobalMeshInRAM()}else Environment.isSet("3DPlay.noMeshInRam.File")&&this.modelLoader.setNoMeshInRAM(!e.needMeshInRam);else"ENOPAD"===this.currentProvider?i.unlockGlobalMeshInRAM():Environment.isSet("3DPlay.noMeshInRam.File")&&this.modelLoader.setNoMeshInRAM(!e.needMeshInRam)},this.isReloadRequired=function(e){var i=!e||void 0===e.needCGR||e.needCGR,t=!(!e||void 0===e.needMeshInRam)&&e.needMeshInRam,n=!(!e||void 0===e.needMaterial)&&e.needMaterial,s=!0,o=!0,r=!0;if("ENOPAD"===this.currentProvider){var a=this.pad3DViewer.getController();s="cgr"===a.getDefaultStreamToLoad(),a.hasMeshInRAM&&(o=this._haveMeshInRam(a)),(r=!a.areDataLoadedWithoutMaterial())||0!==this.pad3DViewer.getRoots().length||(r=!0),i&&!s&&this.enopadStatistics&&this.enopadStatistics.nbCgrLoaded>0&&0===this.enopadStatistics.nbThbLoaded&&(s=!0)}else o=!this.modelLoader.getNoMeshInRAM();var d={needCGR:i&&!s,needMaterial:n&&!r,needMeshInRam:t&&!o,haveCGR:s};return logger.warn("DEBUG-isReloadRequired",d),d};var e=this,i=window.widget;if(i){i.getValue("appId");if(!App.is3DDrive()&&!App.is3DSwym())for(var t in this.addENOPADProperty=function(e){this.widgetPreferences[e.prop]={name:e.prop,defaultValue:e.defaultValue,type:e.type,label:e.label,update:e.update||function(i){return PADSettingsMgt.setSetting(e.prop,void 0!==i&&i),"ENOPAD"===this.currentProvider}.bind(this)}},this.resetWidgetPreferences(),this.RuntimeMode.dynamicRepLoading&&(this.widgetPreferences["3DPlay.displayCandidateQueue"]={name:"3DPlay.displayCandidateQueue",defaultValue:!0,type:"boolean",label:prefs.displayCandidateQueue,update:function(e){return PADSettingsMgt.setSetting("enopad3dviewer_displayCandidateQueue",e?"ALWAYS":"OFF"),this.pad3DViewer.setupLoadingBoxesEngine(),!1}.bind(this)}),this.widgetPreferences[prefName]={name:prefName,defaultValue:"index",type:"list",label:prefs.Label,options:[{label:prefs.index,value:"index"},{label:prefs.base,value:"base"}],update:function(e){return e&&this.configureController&&this.configureController({needCGR:"high"===e||"base"===e,needMeshInRam:"high"===e}),"ENOPAD"===this.currentProvider}.bind(this)},this.widgetPreferences[prefName].options.push({label:prefs.high,value:"high"}),this.widgetPreferences[prefName+".automaticQualityAdaptation"]={name:prefName+".automaticQualityAdaptation",defaultValue:!1,type:"boolean",label:prefs.automaticQualityAdaptation},this.addENOPADProperty({prop:"enopad3dviewer_flexibleAssemblySupportActivated",defaultValue:!1,type:this.pad3DViewer&&this.pad3DViewer.getController&&!App.isOnCloud()&&!this.pad3DViewer.getController()._elasticLoadingGranted?"boolean":"hidden",label:NLSPAD3DViewer.flexibleAssemblySupport}),this.addENOPADProperty({prop:"pgpFromServer",defaultValue:!0,type:"boolean",label:NLSPADUtuils.enopad3dviewer_pgpFromServer_label,update:function(e){return PADSettingsMgt.setSetting("pgpFromServer",void 0!==e&&e),SessionManager.setSessionEntry("pgpFromServer",e),"ENOPAD"===this.currentProvider}.bind(this)}),void 0===Preference.get("pgpFromServer")&&Preference.set("pgpFromServer",!0),"auto"===Preference.get(prefName)&&(Preference.set("3DPlay.CGRPolicy.automaticQualityAdaptation",!0),Preference.set(prefName,"index")),this.widgetPreferences)this.widgetPreferences.hasOwnProperty(t)&&this.widgetPreferences[t].update&&this.widgetPreferences[t].update(Preference.get(t))}this.pad3DViewerTokens=this.pad3DViewerTokens||[];var n=void 0!==this.args.options.callbacks?this.args.options.callbacks.enopad:void 0;if(n)for(var s in n){var o=this.pad3DViewer.subscribe({event:s},n[s]);this.pad3DViewerTokens.push(o)}if(this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLeafReferenceLoaded"},(function(){e.modelLoadCount++,e.newPart=!0}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({evnt:"onLeafReferenceUnloaded"},(function(){e.newPart=!0}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onUrlLoaded"},(function(i){e.enopadStatistics=i}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRootRemoved"},(function(){if(e.pad3DViewer._dropZoneContainer){var i=e.pad3DViewer._dropZoneContainer.elements.container;i&&!i.isHidden()&&i.hide()}}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRootAdded"},(function(e){WUXEvents.publish({event:"onRootAdded",data:e})}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingComplete"},(function(){e.onLoadingFailure||(e.forceRender=!0,e.onModelLoadingCompleted())}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRepresentationLoaded"},(function(i){e.commandEnabler.forEach((e=>e.update())),Environment.isSet("3DPlay.FilterFEMRep")&&e.filterFEM(i)}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRefreshBegin"},(function(){e.publish("ASSET/LOADINGSTARTED",{refreshed:!0})}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingFailure"},(function(i){e.onLoadingFailure=!0;var t="LOAD";if(i&&i.message){var n=i.message.replace(" ","_");"Timeout_raised"===n&&(t=n)}_3DPlay.displayFatalError({ctx:e.args.ctx,msg:NLS3DPlay["LoadingError_"+t]})}))),this.RuntimeMode.dynamicRepLoading){this.DynamicProgressUI=new WUXProgressBar({shape:"circular",infiniteFlag:!0,statusFlag:!1});var r=40;this.DynamicProgressUI.height=r,this.DynamicProgressUI.repLoadingStuff=this.repLoadingStuff=new UWA.Element("div",{id:"PlayWeb-Spinner-DynRepLoading",events:{click:function(){this.repLoadingStuff.isHidden()||(this.DynamicProgressUI.playPause3DloadingFonticon.hasClassName("wux-ui-3ds-pause")?(this.DynamicProgressUI.pause(),this.pad3DViewer.getController().pauseProgressiveLoading()):(this.pad3DViewer.getController().resumeProgressiveLoading(),this.DynamicProgressUI.play()))}.bind(this)}}).inject(this.args.container),this.repLoadingStuff.style["z-index"]=10,this.DynamicProgressUI.inject(this.repLoadingStuff),this.DynamicProgressUI._playPause3DloadingFonticonTooltip=new Tooltip({target:this.DynamicProgressUI.repLoadingStuff,position:"right"}),this.DynamicProgressUI._playPause3DloadingFonticonTooltip.options.target.addEventListener("touchend",this.DynamicProgressUI._playPause3DloadingFonticonTooltip.toggle),this.DynamicProgressUI.playPause3DloadingFonticon=UWA.createElement("span",{class:"wux-ui-3ds wux-ui-3ds-1x",styles:{top:"17px",left:"17px",position:"absolute"}}).inject(this.repLoadingStuff),this.DynamicProgressUI.createAnimation=function(i){return new UWA.Fx(i.container,{duration:i.fadeDuration,transition:"linear",events:{onComplete:function(){e&&("fadeOut"===e.DynamicProgressUI.currentFade&&e.repLoadingStuff.hide(),e.DynamicProgressUI.currentFade="none")}}})},this.DynamicProgressUI._fadeOut=function(e){this.animation||(this.animation=this.createAnimation(e)),"fadeIn"===this.currentFade&&this.animation.stop(),this.animation.start({opacity:[parseFloat(this.repLoadingStuff.style.opacity),0]}),this.currentFade="fadeOut"},this.DynamicProgressUI._fadeIn=function(e){this.animation||(this.animation=this.createAnimation(e)),"fadeOut"===this.currentFade&&this.animation.stop(),this.animation.start({opacity:[parseFloat(this.repLoadingStuff.style.opacity),1]}),this.currentFade="fadeIn"};var a=1e3;this.DynamicProgressUI.start=function(){this.repLoadingStuff.show(),this._fadeIn({container:e.repLoadingStuff,fadeDuration:a}),this.play()},this.DynamicProgressUI.play=function(){this.paused=!1,this.finishTimeout&&(clearTimeout(this.finishTimeout),this.finishTimeout=null),this.emphasize="info",this.value=30,this.infiniteFlag=!0,this.playPause3DloadingFonticon.style.left="16px",this.playPause3DloadingFonticon.removeClassName("fonticon-check"),this.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-play"),this.playPause3DloadingFonticon.addClassName("wux-ui-3ds-pause"),this._playPause3DloadingFonticonTooltip.setBody(NLSPADUtuils.PADStatusInfos_lock3DLoadingTooltip)},this.DynamicProgressUI.pause=function(e){this.paused=!0,this.infiniteFlag=!1,this.emphasize=e?"err":"info",e?this._playPause3DloadingFonticonTooltip.setBody(NLSPAD3DViewer.progressiveExpandFullMemory):(this.playPause3DloadingFonticon.style.left="17px",this.playPause3DloadingFonticon.removeClassName("fonticon-check"),this.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-pause"),this.playPause3DloadingFonticon.addClassName("wux-ui-3ds-play"),this._playPause3DloadingFonticonTooltip.setBody(NLSPADUtuils.PADStatusInfos_unlock3DLoadingTooltip)),this.value=100},this.DynamicProgressUI.finish=function(){if(!this.paused&&!this.finishTimeout){var i=this;this.finishTimeout=setTimeout((function(){i.finishTimeout=null,i.infiniteFlag=!1,i.emphasize="success",i.value=100,i._playPause3DloadingFonticonTooltip.setBody(NLSPAD3DViewer.PADStatus_loadingComplete),i.playPause3DloadingFonticon.style.left="16px",i.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-play"),i.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-pause"),i.playPause3DloadingFonticon.addClassName("fonticon-check"),e&&i._fadeOut({container:e.repLoadingStuff,fadeDuration:a})}),a)}},this.DynamicProgressUI.inject(this.repLoadingStuff),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onStartProgressiveLoad"},(function(){e.DynamicProgressUI.start()}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onEndProgressiveLoad"},(function(i){i.memoryFull?e.DynamicProgressUI.pause(!0):e.DynamicProgressUI.finish(),"timeout"===e.noGeoTimO&&(e.noGeoTimO=setTimeout((function(){if(!0!==e.frmWindow.getViewer().get360Mode()&&0===e.getRootBag().getBoundingSphere().radius){try{var i=this.getInformationsOnAsset();Tracker.trackPageEvent("errors","input_no_geometry",i.type)}catch(e){}_3DPlay.sendEvent(e.args.ctx,eventType.notif,Notification.warning,{msg:NLS3DPlay.LoadingError_NO_GEOMETRY}),e.noGeoInt=setInterval((function(){e.noGeoTimO="timeout",0!==e.getRootBag().getBoundingSphere().radius&&(e.notifScreen.removeNotifications(),clearInterval(e.noGeoInt))}),1e3)}}),4e3))}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onStartAsync"},(function(){e.frmWindow.getActionBar()&&e.frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled")}))),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingFailure"},(function(){var i=arguments[0];i&&i.message&&i.message.startsWith("Failed to retrieve object information.")&&(e.modelFailure=!0),e.onModelLoadingCompleted()}))),this.disposeFunctions.add((function(){e=null}))}},deletePad3DViewerCBs:function(){if(this.pad3DViewerTokens){for(var e=this.pad3DViewerTokens.length;e--;)this.pad3DViewer.unsubscribe(this.pad3DViewerTokens[e]);this.pad3DViewerTokens=[]}},createDom:function(e,i){if(this.args.options.pad3DViewer){this.currentProvider="ENOPAD",this.isFromTransition=!0,this.pad3DViewer=this.args.options.pad3DViewer,this.frmWindow=this.pad3DViewer.getFrameWindow(),this.RuntimeMode={dynamicRepLoading:PADSettingsMgt.getSetting("enopad3dviewer_dynamicRepLoading"),OOC:PADSettingsMgt.getSetting("enopad3dviewer_lightNodeModel")},this.customizePad3DViewer(),this._parent(e);var t=this;requirePromise.then((function(){i.apply(t),t=null}))}else if(this.RuntimeMode={binaryPrimitives:!1},ENOPAD3DViewer){var n=!1;(ExperiencesList.isDynamicRepLoadingCompatibleExperience(this)||Environment.isSet("3DPlay.OOC"))&&(n=!0),Environment.isSet("3DPlay.DisableOOC")&&(n=!1);var s={widget:window.widget?window.widget:o.widget,windowOptions:o};if(WAFR2Utils.isAFR2()){this.pad3DViewer=WAFR2Utils.getViewerComponent(),this.frmWindow=WAFR2Utils,document.getElementsByClassName("wux-applicationframe-app")[0].inject(this.args.container)}else{var o={context:this.args.ctx,height:"100%",minHeight:void 0!==this.args.minHeight?this.args.minHeight:0,viewerOptions:this.args.visu||{},uiOptions:this.args.ui||{},onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};if(this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var r=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++,o.ignoreResetCommandManager=!0,o.workbenchModule=r.module,o.workbench=r.name+".xml",o.defaultCommand=void 0!==r.defaultCommand?r.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"},ProbesManager.begin("ActionBar_Ready"),this.actionBarProfile=ProbesManager.createProbe("ActionBar_"+r.name),this.actionBarProfile.begin()}else o.workbench=!1,o.defaultCommand={ID:"",className:"DS.3DPlayCommands.EmptyCmd"};s={widget:window.widget?window.widget:o.widget,windowOptions:o};if(this.args.options.enopad&&(s=UWA.extend(s,this.args.options.enopad,!0)),this.args.input&&this.args.input.asset&&"guest"===this.args.input.asset.user||App.is3DDrive()||App.is3DSwym())s.offline=!0;else{var a,d=Preference.get("x3dPlatformId"),l=Environment.get("3DPlay.Plateform.3DSpaceUrl");if(l&&d)s.offline=!l.some((function(e){return e.platformId===d&&e.url})),s.offline&&(l.forEach((function(e){!a&&e.url&&(a=e.platformId)})),a?(s.offline=!1,Preference.set("x3dPlatformId",a),a=1):a=0),Tracker.trackPageEvent("infos","tenant_provider",d,void 0===a?2:a)}void 0===s.allowAuthoring&&(s.allowAuthoring=!0,this.RuntimeMode.allowAuthoring=s.allowAuthoring),s.authorizeSet3DStructure=!1,this.args.options.platformServices&&(s.plateformServices=this.args.options.platformServices),s.getPlatformServicesInBackground=!0,void 0===window.HybridApp&&this.args.input&&this.args.input.asset&&(this.args.input.asset.provider&&"EV6"===this.args.input.asset.provider||void 0!==this.args.input.asset.dtype)&&(s.getPlatformServicesInBackground=!1),s.windowOptions.robotVisibility=!1,s.interwidgetComAvailability=!1,s.enableFiltering=!0,s.interwidgetComAvailability=!0,ProbesManager.createProbe("Viewer_init").begin(),n?(s.dynamicRepLoading=!0,s.windowOptions.supportWorldOrientation=!0,s.windowOptions.defaultStatusBarVisibility=!1,s.binaryPrimitives=!0):((Environment.isSet("3DPlay.OOC")||Environment.isSet("3DPlay.dynamicRepLoading"))&&(s.dynamicRepLoading=!0),(Environment.isSet("3DPlay.OOC")||Environment.isSet("3DPlay.binaryPrimitives"))&&(s.binaryPrimitives=!0),Environment.isSet("3DPlay.OOC")&&(n=!0)),n&&(s.visuProgressiveTileModel=!0),this.RuntimeMode.binaryPrimitives=s.binaryPrimitives,this.RuntimeMode.dynamicRepLoading=s.dynamicRepLoading,this.args.options.propertiesFacet&&this.args.options.propertiesFacet.length&&(s.enableSidePanel=!0),App.isInWidget()&&("ENOENBO_AP"!==App.getEmbeder()&&(s.windowOptions.BIMode="DUAL"),widget.setValue("addPlatformPref",!1)),App.is3DSwym()&&(s.windowOptions.viewerOptions.qualityManagerProfile="SWYM"),s.useWidgetLink=App.is3DPlay(),this.pad3DViewer=new ENOPAD3DViewer(s),this.frmWindow=this.pad3DViewer.getFrameWindow(),this.pad3DViewer.render().inject(this.args.container)}this.RuntimeMode.OOC=!0;var c=this,h=this._parent;c.disposeFunctions.add((function(){c=null}));var p=function(){c.enopadInited||(Preference.get("3DPlay.Controller.Configuration")&&Preference.delete("3DPlay.Controller.Configuration"),Preference.get("3DPlay.lastVisuCommand.FILE")&&Preference.delete("3DPlay.lastVisuCommand.FILE"),Preference.get("3DPlay.lastVisuCommand.ENOPAD")&&Preference.delete("3DPlay.lastVisuCommand.ENOPAD"),window.widget&&PADSharedSettings.addSharedSettings(widget,["x3dPlatformId"]),PADSettingsMgt.setSetting("x3dPlatformId",Preference.get("x3dPlatformId")),ProbesManager.end("Viewer_init"),c.enopadInited=!0,h.apply(c,[e]),requirePromise.then((function(){var e=[];VCXExperienceBase&&e.push(c.requestNewExperienceBaseAsync()),c.pad3DViewer&&e.push(c.customizePad3DViewer(s.windowOptions)),Promise.all(e).then((function(){i.apply(c),s=null})),c.subscribeOnce("EXPERIENCE/EXPERIENCEREADY",(function(){Tracker.trackPageEvent("infos","loader_config",c.RuntimeMode?c.RuntimeMode.OOC?"OOC":c.RuntimeMode.dynamicRepLoading?"Dynamic":"Basic":"Base"),c=null})),h=null})))};WAFR2Utils.isAFR2()&&p(),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onReady"},p))}else this._parent(FrameWindow3D,i)},customizePad3DViewer:function(e){PADSettingsMgt.setSetting("enopad3dviewer_staticMappingSupportActivated",!0),PADSettingsMgt.setSetting("enopad3dviewer_autoReloadOnMaterialModeEngaged",!1),this.createPad3DViewerCBs();var i=this.pad3DViewer.getViewer();this.pad3DViewerConfig={picking:UWA.clone(i.picking),pPicking:UWA.clone(i.pPicking),Robot:this.pad3DViewer.isRobotVisible(),Progress:this.pad3DViewer.getDefaultProgressBarVisibility(),Reframe:this.pad3DViewer.getAutomaticReframePolicy(),Menu:this.pad3DViewer.isDefaultContextualMenuVisible(),Bar:this.pad3DViewer.isDefaultContextualBarVisible(),toHide:function(e){e.hide(),this.hideshowElem=this.hideshowElem||[],this.hideshowElem.push(e)},toShow:function(){if(this.hideshowElem){for(var e=0;e<this.hideshowElem.length;e++)this.hideshowElem[e].show();this.hideshowElem=null}}},i.setPicking({activated:this.args.visu.picking,displayHL:this.args.visu.displayPicking,primitive:!1}),i.setPrePicking({activated:this.args.visu.prePicking,displayHL:this.args.visu.displayprePicking}),this.pad3DViewerConfig.changeVisuModeCmdAvailability=this.pad3DViewer.changeVisuModeCmdAvailability,this.pad3DViewer.changeVisuModeCmdAvailability=function(){};var t=this,n=this;let s=new Promise((function(i){require(["DS/PADUtils/PADWebInWinServices"],(function(s){Promise.all([new Promise((function(i){var n=function(){try{if(t.pad3DViewer._dropZoneContainer&&t.pad3DViewer._dropZoneContainer.elements.container){t.pad3DViewerConfig.DropMode=t.pad3DViewer._dropZoneContainer.options.mode,t.pad3DViewer._dropZoneContainer.options.mode="none",t.pad3DViewer.elements.container.removeEventListener("dragenter",t.pad3DViewer._dndCB[0]),t.pad3DViewer.elements.container.removeEventListener("dragover",t.pad3DViewer._dndCB[0]),t.pad3DViewer.elements.container.removeEventListener("dragleave",t.pad3DViewer._dndCB[1]),t.pad3DViewer.elements.container.removeEventListener("dragend",t.pad3DViewer._dndCB[1]),t.pad3DViewer.elements.container.removeEventListener("drop",t.pad3DViewer._dndCB[2]);var e=t.pad3DViewer._dropZoneContainer.elements.container;e.isHidden()||(t.pad3DViewerConfig.toHide(e),i()),void 0!==t.intervalTimer&&(clearInterval(t.intervalTimer),this.intervalTimer=void 0)}else void 0===t.intervalTimer&&(t.intervalTimer=setInterval(n,2))}catch(e){void 0===t.intervalTimer&&(t.intervalTimer=setInterval(n,2))}};s.isWebInWinContext()||e&&!1===e.allowDnD||CommandsManager.isAFR2()&&!1===PADSettingsMgt.getSetting("enopad3dviewer_allowDnD")?i():n()})),new Promise((function(i){var t=function(){var e=window.document.getElementsByClassName("pad_status");e&&((e=e[0])?(i(),n.pad3DViewerConfig.toHide(e)):setTimeout(t,50))};e&&!1!==e.defaultStatusBarVisibility&&!n.RuntimeMode.dynamicRepLoading?t():i()}))]).then((function(){n=null,t=null,e=null,i()}))}),i)}));var o=window.document.getElementById("BubbleContainer");return o&&!o.isHidden()&&this.pad3DViewerConfig.toHide(o),this.pad3DViewer.setRobotVisibility(!1),this.pad3DViewer.setDefaultProgressBarVisibility(!1),this.pad3DViewer.setAutomaticReframePolicy(!1),this.pad3DViewer.setDefaultContextualMenuVisibility(!1),this.pad3DViewer.setDefaultContextualBarVisibility(!1),s},clearView:function(){if(this.notifScreen.removeNotifications(),this.autoReframe=!0,this.pad3DViewer&&"ENOPAD"===this.currentProvider&&this.pad3DViewer.getRoots().length>0){var e=PAD3DViewerModelServices.getRoots(this.pad3DViewer),i=[];e.forEach((function(){i.push(PAD3DViewerModelServices.getNodeID(e[0]))})),this.DynamicProgressUI&&this.DynamicProgressUI.finish(),this.pad3DViewer.removeRoots({pids:i})}else{this.xcadmodelLoader&&this.xcadmodelLoader.clear&&(this.xcadmodelLoader.clear(),this.xcadmodelLoader=void 0);var t=this.getRootBag();t&&t.children&&t.children.length>0&&t.removeChildren(),this.modelLoader.setSceneGraph(t),!1===this.modelLoadComplete&&(this.modelLoader.abort(),this.progress.hide())}this.frmWindow.getViewer().render({updateInfinitePlane:!0})},subscribeToReloadEvents:function(){var e=this.pad3DViewer.getViewer();this.viewerVisuModeCB=[];var i=function(e){this.pendingConfiguration||(this.pendingConfiguration={}),this.pendingConfiguration=function(){for(var e={},i=0;i<arguments.length;i+=1)for(var t=arguments[i]?arguments[i]:{},n=Object.keys(t),s=0;s<n.length;s+=1)e[n[s]]=t[n[s]];return e}(this.pendingConfiguration,e.configuration),this.pendingCancel=e.onCancel,this.timeoutConfiguration||(this.timeoutConfiguration=setTimeout(function(){this.checkReloadNeeded(this.pendingConfiguration,{onCancel:this.pendingCancel}),delete this.timeoutConfiguration}.bind(this),100))};this.viewerVisuModeCB.push(e.onVisuShadingFaceModeChange(function(e){!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),"Illustration"!==e.value&&"Wireframe"!==e.value||i.apply(this,[{configuration:visuModeOptions[e.value],onCancel:function(){e.viewer.setVisuShadingEdgeMode("NoEdges"),e.viewer.setVisuShadingFaceMode("Shaded")}.bind(this)}])}.bind(this))),this.viewerVisuModeCB.push(e.onMaterialModeChange(function(e){!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),this._materialModeChanged=!0;let i=visuModeOptions.MaterialMode;if(!0===e.value){this.currentProvider;this.checkReloadNeeded(i,{onCancel:function(){e.viewer.setMaterialMode(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onVisuShadingEdgeModeChange(function(e){!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),"NoEdges"!==e.value&&i.apply(this,[{configuration:visuModeOptions.Edges,onCancel:function(){e.viewer.setVisuShadingEdgeMode("NoEdges"),e.viewer.setVisuShadingMode("Shading")}.bind(this)}])}.bind(this))),this.viewerVisuModeCB.push(e.onAxisFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let i=visuModeOptions.AxisFilter;this.currentProvider;this.checkReloadNeeded(i,{onCancel:function(){e.viewer.setAxisFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onPlanesFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let i=visuModeOptions.PlanesFilter;this.currentProvider;this.checkReloadNeeded(i,{onCancel:function(){e.viewer.setPlanesFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onLinesFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let i=visuModeOptions.LinesFilter;this.currentProvider;this.checkReloadNeeded(i,{onCancel:function(){e.viewer.setLinesFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onPointsFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let i=visuModeOptions.PointsFilter;this.currentProvider;this.checkReloadNeeded(i,{onCancel:function(){e.viewer.setPointsFilter(!1)}})}}.bind(this)))},_haveMeshInRam:function(e){var i=function(t){for(var n=t.children,s=0;s<n.length;s++)return SceneGraphNodeServices.isRepReference(n[s])?e.hasMeshInRAM(PAD3DViewerModelServices.getNodeID(n[s])):i(n[s]);return!1},t=this.pad3DViewer.getRoots()[0];return!!t&&i(t)},checkReloadNeeded:function(e,i){var t;if(e=e||{needCGR:!0},this.pad3DViewer&&(t=this.frmWindow),t){var n=this.isReloadRequired(e);if(n.needCGR||n.needMeshInRam||n.needMaterial){var s=!Preference.get("3DPlay.CGRPolicy.automaticQualityAdaptation");return n.needMeshInRam&&(s="high"!==Preference.get("3DPlay.CGRPolicy")),void(s?this.confirmReloadBoxDisplayed||(this.confirmReloadBoxDisplayed=!0,ConfirmBox({this:this,warning:!1,container:t.getViewerFrame(),caption:CmdENOPADStreamNLS.Title,info:[n.needMeshInRam?CmdENOPADStreamNLS.Specific_Caption_NMIR:CmdENOPADStreamNLS.General_Caption,CmdENOPADStreamNLS.Confirm_General],checkBox:{text:CmdENOPADStreamNLS.CheckBox_Settings,callback:function(e){e&&Tracker.trackPageEvent("commands","enopadstream","automaticQualityAdaptation"),Preference.set("3DPlay.CGRPolicy.automaticQualityAdaptation",e)}},confirm:{callback:function(){this.confirmReloadBoxDisplayed=!1,this.reload(n),i.onConfirm&&i.onConfirm()},text:CmdENOPADStreamNLS.Button_Proceed},cancel:{callback:function(){this.confirmReloadBoxDisplayed=!1,i.onCancel&&i.onCancel()},text:CmdENOPADStreamNLS.Button_Cancel}})):(this.reload(n),i.onConfirm&&i.onConfirm()))}i.onConfirm&&i.onConfirm()}},reload:function(e){Tracker.trackPageEvent("commands","enopadstream","acceptReload",void 0,{needCGR:e.needCGR?1:0,needMeshInRam:e.needMeshInRam?1:0,needMaterial:e.needMaterial?1:0}),this.configureController(e),this.refresh(!0)},fromTransition:function(){return!0===this.isFromTransition&&(this.pad3DViewer.getController().toggleBetweenStandaloneAndSlaveMode("DUAL"),this.pad3DViewer.displayStatusBar(!1),this.modelName=UWA.clone(this.args.input.asset),this.onModelLoadingStarted(),this.isFromTransition=!1,this.onModelLoadingCompleted(),!0)},updateConnection:function(e,i){window.localStorage["3DPlayHybridApp"]&&window.HybridAppArgs&&window.HybridAppArgs.myAppsUrl?this.pad3DViewer.connectToPlatform({readyCB:i,allowAuthoring:!1}):i()},changeVisuSettingIfPossible:function(){if(ExperiencesList.is3DPlay3DExperience(this)){function e(){var e=this.frmWindow.getViewer();this.dontrecordVisuChange=!0,e.setVisuShadingMode("Shading"),e.setVisuShadingEdgeMode("NoEdges"),e.setMaterialMode("FILE"===this.currentProvider),this.dontrecordVisuChange=!1,logger.warn("DEBUG-setDefaultVisualizationSetting")}if(logger.warn("DEBUG-3DPlay.DefaultVisualizationChanged."+this.currentProvider,Preference.get("3DPlay.DefaultVisualizationChanged."+this.currentProvider)),1==Preference.get("3DPlay.DefaultVisualizationChanged."+this.currentProvider)){let i=this.frmWindow.getViewer(),t={needCGR:"Shaded"!==i.getVisuShadingFaceMode()||i.getAxisFilter()||i.getPointsFilter()||i.getPlanesFilter()||i.getLinesFilter()||"NoEdges"!=i.getVisuShadingEdgeMode()||i.getMaterialMode(),needMaterial:i.getMaterialMode(),needMeshInRam:"Illustration"===i.getVisuShadingFaceMode()};if(logger.warn("DEBUG-targetVisuCommandConfiguration",t),t.needCGR){let n=!1,s="FILE"===this.currentProvider||!0===Preference.get(prefName+".automaticQualityAdaptation")||Environment.isSet("3DPlay.Plateform.Cloud",!0)&&!PADSettingsMgt.getSetting("enopad3dviewer_VISnVIOStatus")||"cgr"===this.pad3DViewer.getController().getDefaultStreamToLoad();s&&(n=s,t.needMeshInRam&&(n="FILE"===this.currentProvider||Environment.isSet(prefName,"high")||this._haveMeshInRam(this.pad3DViewer.getController()))),logger.warn("DEBUG-canChangeConfigurationSilently",n),n?this.configureController(t):e.apply(this,[])}}else e.apply(this,[])}},loadModel:function(e,i,t){if(!1!==this.modelLoadComplete||"ENOPAD"!==this.currentProvider){var n=this.frmWindow.getViewer();i&&!1!==i.resetCameraOrientation&&!this.reframeConfiguration.hasViewpointSet&&n.currentViewpoint.resetCameraOrientation();var s=e?e.asset:this.args.input?this.args.input.asset:null,o="",r=s;if("string"==typeof r){if(""===r)return;o=r;var a=StringUtils.getExtension(r);""!==a&&"3dxml"!==(a=a.toLowerCase())&&this.modelLoader.setFileType(a)}else if(void 0===r.provider||null===r.provider||"file"===r.provider.toLowerCase()){o=r.filename;var d=r.serverurl;if(!(null!=d&&""!==d||null!=o&&""!==o))return}var l=this;if(this.disposeFunctions.add((function(){l=null,Network.disableHook()})),this.pad3DViewer&&r.provider&&"FILE"!==r.provider?this.currentProvider="ENOPAD":this.currentProvider="FILE",this.changeVisuSettingIfPossible(),this.donwlonadProgress||(this.donwlonadProgress=this.getPhaseProgress().registerSubProgress()),this.oldradius=0,this.onLoadingFailure=!1,(Environment.isSet("3DPlay.ProtoSMM")||Environment.isSet("3DPlay.ProtoConvertSpatial"))&&"BUFFER"===r.provider)this.modelLoader.setFileType("cgr"),this.modelName="buffer",this.modelLoader.loadModelFromBuffer(r.data);else if("ENOPAD"===this.currentProvider){var c;s=e.asset,this.pad3DViewer._lockCSONotification=!1,this.modelName=s.id=s.physicalid;try{c=PADUtilsServices.get3DSpaceUrl()}catch(e){}if(!c||s.tenant&&s.tenant!==Preference.get("x3dPlatformId"))return Tracker.trackPageEvent("infos","switch_tenant",s.tenant),Preference.set("x3dPlatformId",s.tenant),void this.pad3DViewer.connectToPlatform({readyCB:ProbesManager.createFunctionProbe("Enopad:connectToPlatform",(function(){new UWAPromise((function(e){PADUtilsServices.updateWidgetSecPref({tenant:s.tenant,padsecurityctx:s.contextid,resolve:e,withPreference:!1})})).then((function(){PADSettingsMgt.setSetting("x3dPlatformId",s.tenant),l.loadModel(e,i,t),null})).catch((function(){Traker.trackPageEvent("error","switch_tenant",Preference.get("x3dPlatformId")),l.modelFailure=!0,l.onModelLoadingCompleted(),null}))})),allowAuthoring:!1});try{this.PanelManager.tagger.activate(!1),this.pad3DViewer.getController()._BIProxy._biFilter.activate(),this.pad3DViewer.getController()._BIProxy.addEvent("ApplyNGFilter",(function(){this.onModelLoadingStarted(!1)}),this)}catch(e){}this.RuntimeMode.dynamicRepLoading?(!0===this.DynamicProgressUI.paused&&this.pad3DViewer.getController().resumeProgressiveLoading(),this.onModelLoadingStarted(!1)):this.onModelLoadingStarted(),s.Play3DXContent&&s.Play3DXContent.biProxyCtx?this.pad3DViewer.addRootNodesFromContent({json3DXContent:s.Play3DXContent,dispatch:!1}):"ENOStrRefinementSpecification"===s.dtype?this.pad3DViewer.addFilter([{objectId:s.physicalid}]):"R2VSURVEY"===s.provider?this.pad3DViewer.addR2Vs({objects:[s],reframe:!0,displayNotif:!1,dispatch:!1}):this.pad3DViewer.addRoots({objects:[s]},!1,!1)}else{r.originalType||(this.loadingAsset.size=0);try{this.pad3DViewer.getController()._BIProxy._biFilter.deactivate(),this.PanelManager.tagger.activate()}catch(e){}var h;if(ProbesManager.begin("TECHNO.loadmodel"),Network.hookNetwork((function(e){var i;return-1===e.indexOf(".js")&&(i={id:"Download",onStatistics:function(e){l.loadingAsset.size=e.DownloadSize},onProgress:function(e){if(0!==e.total){l.loadingAsset.size=e.total;var i=e.loaded/e.total;l.donwlonadProgress&&l.getPhaseProgress().setAbsoluteProgress(l.donwlonadProgress,i/1*100)}},onComplete:function(){l.getPhaseProgress().setAbsoluteProgress(l.donwlonadProgress,100),l.loadingAsset.Load_Session=ProbesManager.createProbe("Load_Session").begin()}}),ProbesManager.end("TECHNO.loadmodel"),i})),this.pad3DViewer&&(this.pad3DViewer._lockCSONotification=!1),o.indexOf("blob:")>-1?(this.modelName="blob",this.loadingAsset.Load_Session=ProbesManager.createProbe("Load_Session").begin()):(this.modelName=o.split("/").pop(),this.modelName.length>128&&(this.modelName=this.modelName.substr(this.modelName.length-128,this.modelName.length))),n.setWorldOrientation(WorldOrientation.ZUpYRight),"stpa"===r.format){h=!1;if(!r.localFile){var p=NLS3DPlay.LoadingError_FORMAT+":stpa";return l=!1,void _3DPlay.displayFatalError({ctx:this.args.ctx,msg:p})}require(["DS/XCADLoader/XCADModelLoader"],(function(e){l.xcadmodelLoader=new e(l.frmWindow.getViewer(),l.modelLoader,r.localFile),l.xcadmodelLoader.setOnStartLoadingCB((function(){l.DynamicProgressUI.start()})),l.xcadmodelLoader.setOnEndLoadingCB&&l.xcadmodelLoader.setOnEndLoadingCB((function(e){e.memoryFull?l.DynamicProgressUI.pause(!0):l.DynamicProgressUI.finish(),l.modelLoadComplete=!0})),l.xcadmodelLoader.setObjectLoadedCB&&l.xcadmodelLoader.setObjectLoadedCB((function(){l.newpart=!0}))}))}else i&&i["3DXMLLoadOpts"]?this.modelLoader.loadModel(r,void 0,void 0,{applicativeContainers:i["3DXMLLoadOpts"]}):this.modelLoader.loadModel(r);this.onModelLoadingStarted(h)}n.render({updateInfinitePlane:!0}),this.forceRender=!0}else this.loadingpending=arguments},loadAsset:function(e,i,t,n){requirePromise.then(function(){this.does3DPlayDoTheRequestNewExperienceBase?this.requestNewExperienceBaseAsync().then(function(){this.publish("EXPERIENCEBASE/NEW",{data:this.experienceBase}),this.loadModel(e,i,t)}.bind(this)):(this.runloop||(this.runloop=new Runloop({data:this,func:this.runloopFunc}),this.runloop.start(),this.profileFrame=Profiler.start("webApplication::frame")),this.loadModel(e,i,t))}.bind(this)),this.pad3DViewer&&!this.isFromTransition&&this.frmWindow&&this.frmWindow.removeReviewModel&&this.frmWindow.removeReviewModel(),this._parent()},_testBrowser:TestBrowser,getScreenShot:function(e){var i=this.frmWindow.getViewer();i.save&&i.save();var t=i.currentViewpoint,n=window.devicePixelRatio>1?window.devicePixelRatio:1,s={data:null,width:Math.floor(i.SCREEN_WIDTH*n),height:Math.floor(i.SCREEN_HEIGHT*n)},o=document.createElement("canvas");o.width=e.width?e.width:s.width,o.height=e.height?e.height:s.height,t.getControl().update(),i.renderToTarget(s,t);var r=o.getContext("2d"),a=r.getImageData(0,0,o.width,o.height);a.width!==o.width&&e.onError("size error"),a.height!==o.height&&e.onError("size error");var d,l,c,h,p=(s.width-1)/(a.width-1),u=(s.height-1)/(a.height-1),g=s.data,m=a.data;if(1===p&&1===u){var f=a.height,v=4*a.width;for(l=0;l<f;l++)for(c=v*l,h=v*(f-l),d=v;d--;)m[c+d]=g[h+d]}else{var P=function(e,i,t,n,s){return s&&(i=n-i),t*i+e},D=a.height,S=a.width,w=s.height,y=s.width;for(l=0;l<D;l++){var C=Math.floor(u*l);for(d=0;d<S;d++)c=4*P(d,l,S,D),h=4*P(Math.floor(p*d),C,y,w,!0),m[c]=g[h],m[c+1]=g[h+1],m[c+2]=g[h+2],m[c+3]=g[h+3]}}r.putImageData(a,0,0,0,0,o.width,o.height),this._setScreenshotUI(o);var b=e.type?"image/"+e.type:"png";if(Environment.get("3DPlay.PersistedAnnotationsEnabled")){var A=this._getSvgScreenshot(o.toDataURL(b));e.onSuccess(A)}else"jpeg"===e.type?o.toBlob((function(i){e.onSuccess(i)}),"image/jpeg"):"canvas"===e.type?e.onSuccess(o):e.onSuccess(o.toDataURL(b))},_getSvgScreenshot:function(e){this.frmWindow.getViewer().getBagNode();var i=this.frmWindow.getViewerFrame().getDimensions();let t=AnnotationManagerUtils.getAnnotationManager(_thatannot.args.ctx);var n="<Model>"+JSON.stringify(this.args.input.asset)+"</Model>",s="<Annotations>"+t.saveAnnotationsToJSON()+"</Annotations>",o="<svg width='"+i.width+"' height='"+i.height+"' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'> <image xlink:href='"+e+"' x='0' y='0' width='100%' height='100%'/>"+n+s+"</svg>",r=new Blob([o],{type:"image/svg+xml;charset=utf-8"});return(self.URL||self.webkitURL||self).createObjectURL(r)},_setScreenshotUI:function(){}};return CommandsManager.isAFR2()&&(delete exp.requestNewExperienceBase,delete exp.requestNewExperienceBaseAsync),EXPERIENCE.extend(exp)}));