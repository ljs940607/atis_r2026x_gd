define("DS/XCADLoader/XCADModelLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/3DXMTiles/OOCModel3DZipHandler","DS/XCADLoader/XCADOOCHandler","DS/3DXMTiles/OOCManager","DS/ZipJS/zip-fs","DS/ZipJS2/ZipJS2","DS/ZipJS2/LoaderInflate","DS/ZipJS2/pako","DS/Visualization/Utils","DS/CoreEvents/Events"],(function(e,t,o,r,n,i,a,s,d,l,u){"use strict";var f=!0,p=!1,c=!1,g=!1,v=function(t,i,s,h){console.log("XCADModelLoader"),this.viewer=t,this.viewer.endLoaded=void 0;var m=this;u.subscribe({event:"3DPLAY/EXPLODE/START"},(function(e){m.hideAllAnnot(),p=!0})),u.subscribe({event:"3DPLAY/EXPLODE/END"},(function(e){p=!1,m.showAllAnnot()})),u.subscribe({event:"/Default/3DPLAY/HIDE"},(function(e){c=e.data.length>0})),u.subscribe({event:"/Default/3DPLAY/SHOW_ALL"},(function(e){c=!1})),u.subscribe({event:"/VISU/"},(function(e){!1===c&&("@onViewpointBeginMove"==e.eventType?m.hideAllAnnot():"@onViewpointEndMove"==e.eventType&&0==p&&1==g&&m.showAllAnnot())}));var L=void 0;a.configure({maxWorkers:4,terminateWorkerTimeout:NaN});var A=void 0;if(A=new a.fs.FS,null!=s)A.importBlob(s,{directAccess:!0}).then(b);else{this.modelName="";var D=function(e,t){var o=function(e){if("string"==typeof e){var t="",o="";if("blob:"===e.substring(0,5))return{provider:"FILE",serverurl:"",filename:e,requiredAuth:null,proxyurl:"none"};if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else if("ms-appx://"===e.substring(0,10))t=e;else if("file://"===e.substring(0,7))t=e;else{var r=location.href,n=r.indexOf("?");-1!==n&&(r=r.substring(0,n));var i=r.lastIndexOf("/");-1!==i&&(r=r.substring(0,i+1)),t=r+e}o=(t=l.parseUrl(t)).protocol,""!==t.protocol&&(o+="://"),o+=t.authority+t.path.substring(0,t.path.lastIndexOf("/"))+"/";var a=t.path.substring(t.path.lastIndexOf("/")+1,t.path.length);return""!==t.query&&(a=a+"?"+t.query),{provider:"FILE",serverurl:o,filename:a,requiredAuth:null,proxyurl:"none"}}return"EV6"===e.provider&&(t=l.parseUrl(e.serverurl),e.serverdefinition={},e.serverdefinition.protocol=t.protocol,e.serverdefinition.hostname=""!==t.user?t.user+"@"+t.domain:t.domain,e.serverdefinition.port=t.port,e.serverdefinition.rooturi=t.path,"/"===e.serverdefinition.rooturi.slice(0,1)&&(e.serverdefinition.rooturi=e.serverdefinition.rooturi.slice(1,e.serverdefinition.rooturi.length))),e}(t);return e.modelName=o.serverurl?o.serverurl:"",e.modelName+=o.filename?o.filename:"",o}(this,h);A.importHttpContent(h,{useXHR:!1,preventHeadRequest:!0}).then(b)}function b(){var a="root_url";t.endLoaded=!1,g=!1,L=new n(t),v.oocManager=L,L.modelLoader=i,L.setTargetNode(i.targetNode),i.setKeepLoaderMode(!0),v.StartLoadingCB&&L.setOnStartLoadingCB(v.StartLoadingCB),v.EndLoadingCB&&L.setOnEndLoadingCB(v.EndLoadingCB),L.addOnEndLoadingCB((e=>{null!=m.viewer.currentViewpoint&&1!=g&&m.viewer.currentViewpoint.reframe(),g=!0,m.viewer.endLoaded=!0,m.showAllAnnot()}));var l=new o({loadModelCB:function(e){var t={};i.setOnLoadedProductStructureCallback((t=>{e.onLoadedCB()}));let o=this.manager.fullVPHandler.oocHandler.assyProductsMap.get(e.targetNode.modelIdentification).geomRep.filename;var r=o.substring(o.lastIndexOf(".")+1,o.length);if("CGR"===r.toUpperCase())i.fileType="cgr",i.loadModelFromBuffer(e.data,e.targetNode,t);else if("STP"===r.toUpperCase())i.fileType="stp",i.loadModelFromBuffer(e.data,e.targetNode,t);else if("STPZ"===r.toUpperCase()){i.fileType="stp";var n=d.inflate(e.data);i.loadModelFromBuffer(n,e.targetNode,t)}else console.log("Not supported file type: "+r)},unzipLib:"zipjs2"});l.ldhHandler.nbTickets=8;var u=new r({manager:L,viewer:t,zipArchive:A,filename:void 0===D?s.name:D.filename,useZip2:f});L.registerHandlers({ref:u,repRef:l}),u.init((function(){L.registerReference(a,{boundingSphere:null,boundingBox:u.rootBbox,manager:L,handlerType:"ref",url:a});var o=L.addRoot(a,{matrix:new e.Matrix4,node:i.targetNode,manager:L,instanceId:u.rootName});l.rootId=o,t.currentViewpoint.reframe()}))}};return v.prototype.getAnnotationRootNodes=function(e){return e.getRootNode().getChildrenByName("3DPlay_XCAD_Annotation")},v.prototype.showAllAnnot=function(){var e=this.getAnnotationRootNodes(this.viewer);if(null!=e){for(var t=0;t<e.length;t++)e[t].setVisibility(!0);this.viewer.render()}},v.prototype.hideAllAnnot=function(){var e=this.getAnnotationRootNodes(this.viewer);if(null!=e){for(var t=0;t<e.length;t++)e[t].setVisibility(!1);this.viewer.render()}},v.prototype.clear=function(){v.oocManager&&v.oocManager.getRootOccurrences().forEach((function(e,t,o){v.oocManager.removeRoot(e.rootId)}))},v.prototype.pauseLoading=function(e){v.oocManager&&v.oocManager.setPauseLoading(e,"XCAD")},v.prototype.setOnStartLoadingCB=function(e){v.StartLoadingCB=e},v.prototype.setOnEndLoadingCB=function(e){v.EndLoadingCB=e},v.prototype.setObjectLoadedCB=function(e){v.ObjectLoadedCB=e},v}));