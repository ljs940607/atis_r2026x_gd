define("DS/XCADLoader/XCADOOCHandler",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/OOCHandler","DS/3DXMTiles/3DXMTilesUtils","DS/EasySax/EasySax","DS/ZipJS2/pako","DS/ZipJS2/LoaderInflate","DS/XCADLoader/XCADError"],(function(e,t,s,a,r,i,n){"use strict";var l=function(e){t.call(this,t.InstRefHander),this.viewer=e.viewer,this.manager=e.manager,this.rootId=e.rootId,this.onHandlePathesCB=null,this.onDoneCB=null,this.ready=!0,this.zipArchive=e.zipArchive||null,this.filename=e.filename||null,this.useZip2=e.useZip2,this.cnt=0,this.process=0,this.nbExternalRef=0,this.processExternalRef=0,this.shapeRepListMap=new Map,this.assyProductsMap=new Map,this.rootProducts=[],this.rootBbox=void 0,this.rootName=void 0,this.childSet=new Set,this._filesSet=new Set,this._Files=[],this._Parts=[],this._VORs=[],this._occurencesMap=new Map,this._matchingDoc=new Map,this._matchingRC=new Map,this._matchingBBox=new Map,this._matchingFile=new Map,this.filesuids=[],this._missingPart=[],this._roots=[]};return(l.prototype=Object.create(t.prototype)).dispose=function(){},l.prototype.isReady=function(){return this.ready},l.prototype.isOK=async function(){return"OK"},l.prototype.init=function(t){function s(s){var r=s.data;let i,l,h,o,d,c=!1,p=!1,u=!1,f=!1,g=!1,_=!1,m=!1,P=!1,b=!1,R=!1,F=!1,v=!1,x=!1,S=!1,D=!1;var y=new a;y.on("startNode",(function(e,t){var a=t();switch(e){case"Header":c=!0;break;case"DataContainer":case"Document":break;case"File":if(p=!0,!u){var r={uid:a.uid,path:".",root:i};s.handler._matchingFile.set(r.uid+i,s.handler._Files.length),s.handler._Files.push(r)}break;case"Id":null!=a.id&&!0===p&&(s.handler._Files[s.handler._Files.length-1].filename=a.id),null!=a.id&&!0===m&&!0===S&&(s.handler._Parts[s.handler._Parts.length-1].occurences[s.handler._Parts[s.handler._Parts.length-1].occurences.length-1].id=a.id);break;case"Identifier":null!=a.id&&!0===m&&!0===S&&(s.handler._Parts[s.handler._Parts.length-1].occurences[s.handler._Parts[s.handler._Parts.length-1].occurences.length-1].id=a.id);break;case"IdentifierString":f=!0;break;case"DocumentVersion":u=!0,d=a.uid;break;case"ClassString":g=!0;break;case"Part":m=!0;var n={uid:a.uid,root:i,occurences:[],vors:[],bbox:[]};s.handler._Parts.push(n);break;case"Name":_=!0;break;case"CharacterString":x=!0;break;case"Occurrence":if(S=!0,null!=a.uid&&!0===m){var l={uid:a.uid};s.handler._Parts[s.handler._Parts.length-1].occurences.push(l)}break;case"AssignedDocument":if(m){let e=a.uidRef;s.handler._Parts[s.handler._Parts.length-1].AssignedDocumentUidRef=e}break;case"ViewOccurrenceRelationship":P=!0;var h={uid:a.uid,idx:s.handler._VORs.length,part_idx:-1};m&&(h.part_idx=s.handler._Parts.length-1),p&&(h.File_id=s.handler._Files[s.handler._Files.length-1].id),s.handler._VORs.push(h);break;case"Related":P&&(s.handler._VORs[s.handler._VORs.length-1].uidRef=a.uidRef);break;case"RotationMatrix":b=!0;break;case"TranslationVector":R=!0;break;case"RepresentationContext":o=a.uid,F=!0;break;case"DigitalFile":u&&s.handler._matchingDoc.set(d,a.uidRef);break;case"ShapeDependentProperty":v=!0;break;case"DefinedIn":m&&v&&(s.handler._Parts[s.handler._Parts.length-1].bbox[s.handler._Parts[s.handler._Parts.length-1].bbox.length]=a.uidRef);break;case"Coordinates":D=!0}})),y.on("textNode",(function(e,t){!0===p&&(!0===f&&(s.handler._Files[s.handler._Files.length-1].path=e),!0===g&&(s.handler._Files[s.handler._Files.length-1].type=e)),!0===P&&(!0===b&&(l=e),!0===R&&(h=e)),!0===m&&_&&x&&void 0===s.handler._Parts[s.handler._Parts.length-1].name&&(s.handler._Parts[s.handler._Parts.length-1].name=e+s.handler._Parts[s.handler._Parts.length-1].uid),F&&D&&s.handler._matchingRC.set(o,e),c&&_&&void 0===i&&(i=e)})),y.on("endNode",(function(t){switch(t){case"Header":c=!1;break;case"DataContainer":i=void 0;break;case"File":p=!1;break;case"Id":case"Document":break;case"IdentifierString":f=!1;break;case"ClassString":g=!1;break;case"Part":m=!1;break;case"Name":_=!1;break;case"CharacterString":x=!1;break;case"Occurrence":S=!1;break;case"ViewOccurrenceRelationship":let t=(a=l.trim().split(" "),r=h.trim().split(" "),(n=new e.Matrix4).set(parseFloat(a[0]),parseFloat(a[3]),parseFloat(a[6]),parseFloat(r[0]),parseFloat(a[1]),parseFloat(a[4]),parseFloat(a[7]),parseFloat(r[1]),parseFloat(a[2]),parseFloat(a[5]),parseFloat(a[8]),parseFloat(r[2]),0,0,0,1),n);s.handler._VORs[s.handler._VORs.length-1].curTransfo=t,!0===m&&s.handler._Parts[s.handler._Parts.length-1].vors.push(s.handler._VORs[s.handler._VORs.length-1]),P=!1;break;case"RotationMatrix":b=!1;break;case"TranslationVector":R=!1;break;case"RepresentationContext":F=!1;break;case"DocumentVersion":u=!1,d=void 0;break;case"ShapeDependentProperty":v=!1;break;case"Coordinates":D=!1}var a,r,n})),s.handler.processSTPXFileV2(r,y,(function(){if(s.handler._missingPart.length>0){let t="";for(let e=0;e<s.handler._missingPart.length;e++)t+=s.handler._missingPart[e],e!=s.handler._missingPart.length-1&&(t+=",");var e=new n;e.setError("XCADLoader/XCADLoader","warning.MISSING_PART",t),null!=s.handler.manager.modelLoader.onErrorCB&&s.handler.manager.modelLoader.onErrorCB(e)}for(let e=0;e<s.handler._Parts.length;e++){for(let t=0;t<s.handler._Parts[e].vors.length;t++)s.handler._occurencesMap.set(s.handler._Parts[e].root+s.handler._Parts[e].vors[t].uidRef,s.handler._Parts[e].vors[t].idx);if(2===s.handler._Parts[e].bbox.length){let t,a=s.handler._matchingRC.get(s.handler._Parts[e].bbox[0]),r=s.handler._matchingRC.get(s.handler._Parts[e].bbox[1]);null!=a&&null!=r&&(t=s.handler.buildBbox(a.trim().split(" "),r.trim().split(" "))),s.handler._matchingBBox.set(s.handler._Parts[e].name,t)}}for(var a=0;a<s.handler._Parts.length;a++)s.handler.processOccurenceV2(s.handler._Parts[a]);t()}))}if(this.zipArchive){var i=this.filename.substring(this.filename.lastIndexOf("/")+1,this.filename.lastIndexOf("."));let l=this;function h(){let e,t;null!=l._roots[0]?(e=l._roots[0].toUpperCase().includes(".STPX")?l._roots[0]:void 0,t=l._roots[0].toUpperCase().includes(".STPXZ")?l._roots[0]:void 0):(e=i+".stpx",t=i+".stpxZ");var a=l.zipArchive.find(e);if(a)l.useZip2?a.getRope().then((e=>{s({data:e,handler:l})})):a.getBlob("text/plain",(e=>{var t=new FileReader;t.onload=e=>{s({data:e.target.result,handler:l})},t.readAsText(e)}));else if(void 0===(a=l.zipArchive.find(t))&&(t=i+".stpxz",a=l.zipArchive.find(t)),a)a.getUint8Array().then((e=>{var t=r.inflate(e),a=new TextDecoder,i=[],n=268435456;if(t.length>n){let e=0,s=n,r=0;for(;s<t.length;)i[r]=a.decode(t.subarray(e,s)),r++,e=s,s+=n;i[r]=a.decode(t.subarray(e,t.length))}else i[0]=a.decode(t);s({data:i,handler:l})}));else{var h=new n;h.setError("XCADLoader/XCADLoader","error.NO_STPXZ",null),null!=l.manager.modelLoader.onErrorCB&&l.manager.modelLoader.onErrorCB(h)}}(function(e){let t=e.zipArchive.find("stpa.ini");if(!t)return new Promise((function(e,t){e("no manifest")}));if(e.useZip2)return t.getRope().then((t=>{!function(e){let t=e.data.toString().match(/Names=\".*\"/g);if(0!=t.length)for(var s=0;s<t.length;s++)e.handler._roots.push(t[s].substring(7,t[0].length-1))}({data:t,handler:e})}));console.log("not implemented")})(this).then((()=>h()))}},l.prototype.processSTPXFileV2=function(e,t,s,a,r){this.process++;let i=0;t.parse(e);for(var n=0;n<this._Files.length;n++){let e;e=void 0===a?this._Files[n].uid:a;var l=this._Files[n].filename.substring(this._Files[n].filename.lastIndexOf(".")+1,this._Files[n].filename.length);if(("geometry"==this._Files[n].type||"STPX"!=l.toUpperCase())&&"/NULL"!==this._Files[n].filename){let t=this._Files[n].path;t.startsWith("./")?t=t.substring(2,t.length):t.startsWith(".")&&(t=t.substring(1,t.length));let s=t+this._Files[n].filename,a=this.zipArchive.find(s);null==a&&(a=this.zipArchive.find(s+"Z"),null==a?(a=this.zipArchive.find(s+"z"),this._Files[n].filename+="z"):this._Files[n].filename+="Z"),null!=a?this.shapeRepListMap.set(e+this._Files[n].root,{type:this._Files[n].type,filename:this._Files[n].filename,folder:this._Files[n].path}):this._missingPart.push(s)}if(!1===this._filesSet.has(this._Files[n].path+this._Files[n].filename)){i++,this._filesSet.add(this._Files[n].path+this._Files[n].filename);let e=this._Files[n].uid;if("STPX"===l.toUpperCase()){this.nbExternalRef++;let a=this.zipArchive.find(this._Files[n].filename);a&&(this.useZip2?a.getBlob("application/octet-stream").then((a=>{let r=new FileReader;r.onload=a=>{this.processSTPXFileV2(a.target.result,t,s,e,(function(e){e.processExternalRef++,e.nbExternalRef==e.processExternalRef&&s()}))},r.readAsText(a)})):a.getBlob("application/octet-stream",(a=>{var r=new FileReader;r.onload=a=>{this.processSTPXFileV2(a.target.result,t,s,e,(function(e){e.processExternalRef++,e.nbExternalRef==e.processExternalRef&&s()}))},r.readAsText(a)})))}}}null!=r&&r(this),null!=r||0!=i&&0!=this.nbExternalRef||s()},l.prototype.processOccurenceV2=function(e){let t,s,a,r,i;for(let n=0;n<e.occurences.length;n++){let l=this._occurencesMap.get(e.root+e.occurences[n].uid);t=e.occurences[n].id,s=e.name,a=this._Parts[this._VORs[l].part_idx].name;let h=a?this._matchingBBox.get(s):void 0;if(r=e.AssignedDocumentUidRef,null!=r&&r.startsWith("DV")&&(r=this._matchingDoc.get(r)),null!=r){let t=this._matchingFile.get(r+e.root);"STPX"===this._Files[t].filename.substring(this._Files[t].filename.lastIndexOf(".")+1,this._Files[t].filename.length).toUpperCase()?r+=this._Files[t].filename:r+=e.root}if(i=e.AssignedDocumentUidRef,null!=i&&i.startsWith("DV")&&(i=this._matchingDoc.get(i)),null!=i){let t=this._matchingFile.get(i+e.root);"STPX"===this._Files[t].filename.substring(this._Files[t].filename.lastIndexOf(".")+1,this._Files[t].filename.length).toUpperCase()?i+=this._Files[t].filename:i+=e.root}if(null!==s&&null!==s){if(!1===this.assyProductsMap.has(a)&&(this.assyProductsMap.set(a,{referenceName:a,isRoot:!0,childrenList:[],geomRep:this.shapeRepListMap.get(i)}),this.rootProducts.push(a),this.rootName=a,this.rootBbox=h),!0===this.assyProductsMap.has(s)){this.assyProductsMap.get(s).isRoot=!1;let e=this.rootProducts.indexOf(s);-1!=e&&this.rootProducts.splice(e,1)}else this.assyProductsMap.set(s,{referenceName:s,isRoot:!1,childrenList:[],geomRep:this.shapeRepListMap.get(r)});this.assyProductsMap.get(a).geomRep=void 0,this.assyProductsMap.get(a).childrenList.push({instanceName:t,productReferenceIdx:s,transfo:this._VORs[l].curTransfo,bbox:h})}}},l.prototype.buildBbox=function(t,s){let a=new e.Box3;return a.setValues(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])),a},l.prototype.processInstance=function(e,t,s){let a,r=e.instanceName,i=e.productReferenceIdx,n=e.transfo,l=e.bbox,h=this.assyProductsMap.get(i);if(h.geomRep){let e=h.geomRep.folder;e.startsWith("./")?e=e.substring(2,e.length):e.startsWith(".")&&(e=e.substring(1,e.length)),a=e+h.geomRep.filename}if(!0===s?this.manager.registerReference(i,{boundingSphere:null,boundingBox:l,url:this.zipArchive?void 0:a,src:this.zipArchive?{zipArchive:this.zipArchive,path:a}:void 0,handlerType:h.geomRep?"repRef":"ref"}):0==this.childSet.has(t+" : "+i+" : "+r)&&(this.childSet.add(t+" : "+i+" : "+r),this.manager.addChild(t,i,{instanceId:r+this.cnt++,matrix:n})),!h.geomRep){let e=h.childrenList.length;for(let t=0;t<e;t++)this.processInstance(h.childrenList[t],i,s)}},l.prototype.handlePathes=function(e,t,s){if(1!==e.length)throw new Error("Invalid pathes.length ("+e.length+")");if(1!==e[0].ids.length)throw new Error("Invalid pathes.ids.length ("+e.ids.length+")");this.ready=!1,this.onHandlePathesCB&&this.onHandlePathesCB(e,t,s),setTimeout(this.handlePathes_internal.bind(this,e,t,s),0)},l.prototype.handlePathes_internal=function(e,t,s){this.manager.startInstRefGraphTransaction(),this.assyProductsMap.forEach(((e,t)=>{if(e.isRoot){let t=e.childrenList.length;for(let s=0;s<t;s++)this.processInstance(e.childrenList[s],"root_url",!0)}})),this.assyProductsMap.forEach(((e,t)=>{if(e.isRoot){let t=e.childrenList.length;for(let s=0;s<t;s++)this.processInstance(e.childrenList[s],"root_url",!1)}}));let a=this.manager.getHandler("repRef").rootId;this.manager.freezeRoot(a),this.manager.endInstRefGraphTransaction(),this.ready=!0,t.doneCB(e,[])},l}));