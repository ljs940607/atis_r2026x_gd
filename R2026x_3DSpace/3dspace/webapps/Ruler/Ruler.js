/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/RulerManipulator",["DS/Visualization/ThreeJS_DS","DS/Manipulators/Manipulator"],(function(e,t){"use strict";return t.extend({init:function(e){const t=e||{};this._parent(t.viewer),this.axis=t.axis,this.clickGradManipulator=!1,this.axis?this.axis.normalize():(this.clickGradManipulator=!0,this.associatedValue=t.value,this.linkedNode=t.linkedNode),this.setPrePickingDuringManipulation(!1),this.setPreActivationDuringManipulation(!1),this.setPickingDuringManipulation(!1),this.setExclusive(!0),this.magnitude=1e3,this.setValue=function(e){this.associatedValue=e}},BeginManipulate:function(t,i,a){this._parent(t,i,a),this.clickEvent=!0,this.clickGradManipulator||(this.initial3dIntersectionPoint=a.position,this.initial3dIntersectionPointTranslated=(new e.Vector3).copy(this.initial3dIntersectionPoint),this.initial3dIntersectionPointTranslated.add(this.axis)),this.publish("BeginManipulate",{eventChannel:"BeginManipulate",paths:this.manipulatedPaths,event:i,manipulator:this})},Manipulate:function(t,i){if(this._parent(t,i),!this.clickGradManipulator){let t=(new e.Vector2).copy(i.from[0].getCurrentPosition(this.viewer.canvas)),a=this.viewer.currentViewpoint.create3DRayFrom2DPoint(t).computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated),n=(new e.Vector3).subVectors(a,this.initial3dIntersectionPoint);Math.round(100*n.length())>this.magnitude&&(this.clickEvent=!1,this.publish("Manipulate",{event:i,eventChannel:"Manipulate",paths:this.manipulatedPaths,translationVector:n,manipulator:this}))}},EndManipulate:function(e,t){this._parent(e,t),this.clickGradManipulator||(this.clickEvent?this.publish("Click",{eventChannel:"Click",paths:this.manipulatedPaths,event:t,manipulator:this}):this.publish("EndManipulate",{eventChannel:"EndManipulate",paths:this.manipulatedPaths,manipulator:this,event:t}))},PrimaryPointerClick:function(e,t){this._parent(e,t),this.publish("Click",{eventChannel:"Click",paths:this.manipulatedPaths,event:t,manipulator:this,value:this.clickGradManipulator?this.associatedValue:void 0})},BeginPreactivate:function(e,t){this._parent(e,t),this.publish("BeginPreactivate",{eventChannel:"BeginPreactivate",preactivated:this.preactivated,manipulator:this,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})},Preactivate:function(e,t){this._parent(e,t),this.publish("Preactivate",{eventChannel:"Preactivate",preactivated:this.preactivated,manipulator:this,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})},EndPreactivate:function(e,t){this._parent(e,t),this.publish("EndPreactivate",{eventChannel:"EndPreactivate",preactivated:this.preactivated,manipulator:this,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})}})})),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/AngularRulerManipulator",["DS/Visualization/ThreeJS_DS","DS/Manipulators/Manipulator"],(function(e,t){"use strict";return t.extend({init:function(t){const i=t||{};this._parent(i.viewer),this.axis=i.axis,this.clickGradManipulator=!1,this.axis?(this.axis.normalize(),this.centerPosition=new e.Vector3,this.projector=new e.Projector):(this.clickGradManipulator=!0,this.associatedValue=i.value,this.linkedNode=i.linkedNode),this.setPrePickingDuringManipulation&&this.setPrePickingDuringManipulation(!1),this.setPreActivationDuringManipulation&&this.setPreActivationDuringManipulation(!1),this.setPickingDuringManipulation&&this.setPickingDuringManipulation(!1),this.centerPosition=i.center,this.setExclusive(!0)},BeginManipulate:function(e,t,i){this._parent(e,t,i),this.initial3dIntersectionPoint=i.position,this.clickEvent=!0,this.publish("BeginManipulate",{event:t})},Manipulate:function(t,i){if(this._parent(t,i),!this.clickGradManipulator){let t=(new e.Vector2).copy(i.from[0].getCurrentPosition(this.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(t),n=(new e.Plane).setFromNormalAndCoplanarPoint(this.axis,this.initial3dIntersectionPoint),r=a.intersectPlane(n),l=(new e.Vector3).subVectors(this.initial3dIntersectionPoint,this.centerPosition);l.projectOnPlane(this.axis),l.normalize();let o=(new e.Vector3).subVectors(r,this.centerPosition);o.projectOnPlane(this.axis),o.normalize();let s=new e.Vector3;s.crossVectors(l,o),s.normalize();let u=l.angleTo(o),d=(new e.Matrix4).makeRotationAxis(s,u);Math.round(180*u/Math.PI)>.05&&(this.clickEvent=!1,this.publish("Manipulate",{rotationMatrix:d,angle:u,axis:s,center:this.centerPosition,event:i}))}},EndManipulate:function(e,t){this._parent(e,t),this.clickGradManipulator||(this.clickEvent?this.publish("Click",{event:t}):this.publish("EndManipulate",{event:t}))},PrimaryPointerClick:function(e,t){this._parent(e,t),this.publish("Click",{event:t,value:this.clickGradManipulator?this.associatedValue:void 0})},BeginPreactivate:function(e,t){this._parent(e,t),this.publish("BeginPreactivate",{event:t,preactivated:this.preactivated,node:this.clickGradManipulator?this.linkedNode:void 0})},Preactivate:function(e,t){this._parent(e,t),this.publish("Preactivate",{preactivated:this.preactivated,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})},EndPreactivate:function(e,t){this._parent(e,t),this.publish("EndPreactivate",{preactivated:this.preactivated,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})}})})),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/RulerEditor",["UWA/Core","DS/SceneGraphNodes/CSS2DNode","DS/VisuEvents/EventsManager","DS/Controls/LineEditor","i18n!DS/Ruler/assets/nls/Ruler","css!DS/Ruler/Ruler.css"],(function(e,t,i,a,n){"use strict";return t.extend({init:function(t){let r=t||{},l=window.widget&&window.widget.lang?window.widget.lang:void 0;const o=new Intl.NumberFormat(l).format(1.1).replaceAll("1","");let s=e.createElement("div",{id:"WEB3DUXRulersValueEditor",class:"WEB3DUXRulersValueEditor"}),u=new a({autoCommitFlag:!0,touchMode:!0,pattern:`^[+\\-]?[0-9]*[\\.\\${o}]?[0-9]*$`,value:parseFloat(r.value).toString().replace(".",o)}).inject(s);s.setStyles({opacity:0}),u.getContent().addClassName("WEB3DUXValueEditor");let d=u.getContent().childNodes[0];d.setStyles({border:"none"}),d.addClassName("WEB3DUXRulersValueEditorField");let h=setTimeout((()=>{h=null,s&&d&&(s.setStyles({opacity:1}),d.select(),d.focus())}),100),c=e.createElement("span",{id:"WEB3DUXCancelRulerEditionButton",class:"fonticon fonticon-cancel WEB3DUXCancelRulerEditionButton"}).inject(s),p=e.createElement("span",{id:"WEB3DUXAcceptRulerEditionButton",class:"fonticon fonticon-check WEB3DUXAcceptRulerEditionButton"}).inject(s),g=e.createElement("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention WEB3DUXAcceptRulerEditionWarningDiv"}).inject(s);g.setStyles({visibility:"hidden"}),this._parent({html:s,name:"immersiveEditor2DNode"}),this._getExcludeFromCSO=function(){return!0},this.css2DNode.primitive=!0,navigator.userAgent.match(/(iPhone|iPad)/i)&&t.frmWindow&&t.frmWindow.getUIFrame().appendChild(s.parentNode);let M,f=null;u.addEventListener("change",(function(){let e=f;const t=(u.value||"").replace(o,".");f=isNaN(t)?n.warningBadValueEntered:"number"==typeof r.startValue&&parseFloat(t)<r.startValue?n.warningValueTooSmall+r.startValue:"number"==typeof r.endValue&&parseFloat(t)>r.endValue?n.warningValueTooBig+r.endValue:null,g.title=f||"",(e&&!f||!e&&f)&&g.setStyles({visibility:f?"":"hidden"})}));let m=function(e){null===f&&(r.okCB(e),M())},b=function(e){r.cancelCB(e),M()},w=function(e){let t=e.which||e.keyCode;13===t?m({event:e}):27===t&&b({event:e}),13!==t&&27!==t||(e.preventDefault(),e.stopPropagation())};M=function(){h&&clearTimeout(h),h=null,i.removeEvent(p,"onPrimaryPointerClick",m),i.removeEvent(c,"onPrimaryPointerClick",b),d&&d.removeEventListener("keydown",w)},i.addEvent(p,"onPrimaryPointerClick",m),i.addEvent(c,"onPrimaryPointerClick",b),d.addEventListener("keydown",w),this.getInputValue=function(){return u?u.value:null},this.validateEditor=function(){null===f&&u.value&&parseFloat(u.value)!==r.value?m():b()}}})})),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/AngularRuler",["UWA/Class","DS/Ruler/RulerEditor","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Ruler/AngularRulerManipulator","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CSS2DNode","i18n!DS/Ruler/assets/nls/Ruler"],(function(e,t,i,a,n,r,l,o,s,u,d,h,c,p){"use strict";const g=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator.png"),void 0,null,null,!0);g.flipY=!1;const M=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Over.png"),void 0,null,null,!0);M.flipY=!1;const f=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_On.png"),void 0,null,null,!0);f.flipY=!1;const m=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0);m.flipY=!1;const b=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0);b.flipY=!1;const w=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);w.flipY=!1;const v=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0),y=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0),T=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),C=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0),x=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),S=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0);S.flipY=!1;const R=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);R.flipY=!1;const N=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLight.png"),void 0,null,null,!0),I=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOver.png"),void 0,null,null,!0),V=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOn.png"),void 0,null,null,!0),P=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightZeroManip.png"),void 0,null,null,!0),D=e.extend({init:function(e,_){if(!e)return void window.console.error("Ruler - Frame window argument missing");const E=_||{};this._parent(E);const U=[];U.push({unit:D.DEG_UNIT,nls:String.fromCharCode(176)}),U.push({unit:D.RAD_UNIT,nls:p.radLbl}),U.push({unit:D.GRAD_UNIT,nls:p.gradLbl}),U.push({unit:D.MRAD_UNIT,nls:p.mradLbl}),U.push({unit:D.INPERFOOT_UNIT,nls:p.inPerFootLbl}),U.push({unit:D.PERCENT_UNIT,nls:String.fromCharCode(37)}),this.value=0,this.initValue=0,this.origin=new i.Vector3,this.direction=new i.Vector3(0,0,1),this.originVector=null,this.radius=E.radius,this.worldRadius=E.worldRadius,this.openingAngle=E.openingAngle,this.mainGrad=E.mainGrad,this.nbSecondaryGrads=E.nbSecondaryGrads,this.startValue=E.startValue,this.endValue=E.endValue,this.lightDisplay=E.lightDisplay,this.displayRulerDuringLocalTransfo=E.displayRulerDuringLocalTransfo,this.displayOrigin=E.displayOrigin,this.unit=E.unit,this.displayUnit=E.displayUnit,this.graduationsDisplay=E.graduationsDisplay,this.originValue=E.originValue,this.hideOnEmptySelection=E.hideOnEmptySelection,this.nbDecimals=E.nbDecimals;const k=this;let A,O,G,B,L,F,W,H,X,Y,q,z,K,Z,j,J,$,Q,ee,te,ie,ae,ne,re,le,oe=null,se=null,ue=null,de=null,he=new i.Vector2,ce=1,pe=1,ge=0,Me=0,fe=15,me=1,be=35,we=20,ve=15,ye=14,Te=10,Ce=.33*be,xe=100,Se="255, 128, 0",Re="115, 195, 225",Ne="130, 190, 220",Ie="40, 90, 120",Ve="80, 80, 80",Pe="0,0,0",De=!1,_e=1,Ee=new u,Ue=e.getViewer(),ke=e.getViewpoint(),Ae=new a("rulerMainNode");Ae.setVisibilityInTree(!1),Ae.side=i.DoubleSide,Ae.exludeFromBounding(!0),Ae._getExcludeFromCSO=function(){return!0},Ae.setNoZ(!0);let Oe=new a("rulerMainNodeNoPick");Oe.setVisibilityInTree(!1),Oe.side=i.DoubleSide,Oe.exludeFromBounding(!0),Oe._getExcludeFromCSO=function(){return!0},Oe.setNoZ(!0),Oe.setPickable(h.PICKTHROUGH);let Ge,Be,Le,Fe=new a,We=new a,He=new a,Xe=new a("rulerGraduationNode"),Ye=new a,qe=new a,ze=new a,Ke=new a,Ze=new a,je=new a,Je=new a,$e=null,Qe=new a,et=new a,tt=100,it=[],at=[],nt=0,rt=0,lt=null,ot=0,st=null,ut=0,dt=null,ht=0,ct=0,pt=null,gt=!1,Mt=!1,ft=!1,mt=!1,bt=!0,wt=!1,vt=!1,yt=!1,Tt=!1,Ct=!1,xt=!1,St=!1,Rt=!1,Nt=!1,It=!1,Vt=!1,Pt=!1,Dt=document.createElement("canvas"),_t=document.createElement("canvas"),Et=document.createElement("canvas"),Ut=document.createElement("canvas"),kt=document.createElement("canvas"),At=document.createElement("canvas"),Ot=document.createElement("canvas");At.width=1,At.height=1;let Gt=At.getContext("2d");Gt.clearRect(0,0,At.width,At.height),Gt.rect(0,0,At.width,At.height),Gt.fillStyle="rgba(0,0,0,0)",Gt.fill();let Bt=new i.Texture,Lt=new i.Texture,Ft=new i.Texture,Wt=new i.Texture,Ht=new i.Texture;Ht.image=At,Ht.needsUpdate=!0;let Xt,Yt,qt,zt,Kt=new i.Texture,Zt=window.widget&&window.widget.lang?window.widget.lang:void 0;const jt=new Intl.NumberFormat(Zt).format(1.1).replaceAll("1","");function Jt(e){if(k.__performanceMeasures){for(let t=0;t<k.__performanceMeasures.measures.length;t++)if(k.__performanceMeasures.measures[t].id===e)return void(k.__performanceMeasures.measures[t].mark=(new Date).getTime());k.__performanceMeasures.measures.push({id:e,mark:(new Date).getTime(),cumulatedTime:0,nbCalls:0})}}function $t(e){if(k.__performanceMeasures)for(let t=0;t<k.__performanceMeasures.measures.length;t++)if(k.__performanceMeasures.measures[t].id===e)return k.__performanceMeasures.measures[t].cumulatedTime+=(new Date).getTime()-k.__performanceMeasures.measures[t].mark,void(k.__performanceMeasures.measures[t].nbCalls+=1)}function Qt(e,t,i){let a=e;return L===D.SYMETRIC_GRADUATIONS&&e>180?a=e-360:L===D.ORIENTED_GRADUATIONS&&e>180?a=360-e:L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&(a=e-360,-360===a&&(a=0)),i||(a*=Y),t?a:Math.round(a*$)/$}function ei(e){let t,i=e;if(null!=i)return(i<-360||i>360)&&(i%=360),i<0&&(i=360+i),void 0!==q&&void 0!==z?q<z?i>=q&&i<=z?i:(t=q-(360-(z-q))/2,(t<-360||t>360)&&(t%=360),t<0&&(t=360+t),i>=0&&i<q||i>=t?q:z):i>=q||i<=z?i:(t=z+(q-z)/2,(t<-360||t>360)&&(t%=360),t<0&&(t=360+t),i>=t?q:z):i}function ti(){return!se||Math.abs(se.dot(ke.getSightDirection()))<=.2}function ii(e){if("@onPrimaryPointerMoveUniqueEvent"!==e.eventType){if(Mt)Mt=!1;else if(e&&!It&&!ft){let t=ze.children[0];!t&&k.getVisibleFlag()?setTimeout((function(){let t=null;if(Tt&&(t="ruler"),null===t){let i=Ue.getMousePosition(e.from[0].getCurrentPosition(Ue.canvas)),a=Ue.pick(i,"primHybrid",!1);if(0!==a.path.length&&a.path[0]||(a=Ue.pick(i,"mesh",!1),0!==a.path.length&&a.path[0]||(t="")),null===t){let e=a.path[0];if(e&&e.externalPath)for(let i=0;i<e.externalPath.length;i++)"rulerMainNode"===e.externalPath[i].name&&(t="ruler")}}""===t&&J&&k.clear()}),0):t&&t.validateEditor()}}else!e.from[0].currentPosition||isNaN(e.from[0].currentPosition.x)||isNaN(e.from[0].currentPosition.y)||(he.x=e.from[0].currentPosition.x,he.y=e.from[0].currentPosition.y)}function ai(e,t){if((!Nt||e!==Xe&&e!==Ye&&e!==Ze)&&e){e.getMaterial()&&(e.getMaterial().map&&t&&e.getMaterial().map.dispose(),e.getMaterial().dispose());for(let i=e.children.length-1;i>=0;i--)ai(e.children[i],t);e.removeChildren()}}function ni(e,t){return Ee.publish({event:e,data:t,context:this})}function ri(e){Jt("_stroke"),e.stroke(),$t("_stroke")}function li(e){let t;Jt("_generateMainCanvas");let a=e?Ut:Dt;a.width=Math.round(re),a.height=Math.round(re);let n=a.getContext("2d");n.clearRect(0,0,a.width,a.height);n.translate(Math.round(re/2),Math.round(re/2));let r,l,o=e?Math.min(1.5*B,Math.PI):B,s=Math.round(Math.cos(o)*(A+be)),u=Math.round(Math.sin(o)*(A+be)),d=Math.round(A+be),h=Math.round(Math.sin(o-Math.PI/4)*(A+be)*Math.sqrt(2)),c=F?.25:.4,p=F?Ve:"255, 255, 255";if(t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+p+",0)"),t.addColorStop(e||F?.75:.25,"rgba("+p+","+c+")"),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",F||(n.beginPath(),n.arc(0,0,Math.round(A+be/2),0,o,!1),n.lineWidth=be,ri(n)),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",n.lineWidth=2*me,n.beginPath(),n.arc(0,0,A,0,o,!1),ri(n),F||(n.beginPath(),n.arc(0,0,A+be,0,o,!1),ri(n)),s=Math.round(Math.cos(-o)*(A+be)),u=Math.round(Math.sin(-o)*(A+be)),h=Math.round(Math.sin(-o+Math.PI/4)*(A+be)*Math.sqrt(2)),t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+p+",0)"),t.addColorStop(e||F?.75:.25,"rgba("+p+","+c+")"),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",F||(n.beginPath(),n.arc(0,0,Math.round(A+be/2),-o,0,!1),n.lineWidth=be,ri(n)),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",n.lineWidth=2*me,n.beginPath(),n.arc(0,0,A,-o,0,!1),ri(n),F||(n.beginPath(),n.arc(0,0,A+be,-o,0,!1),ri(n)),c=F?.8:.5,H){let e=de-j;(e<-360||e>360)&&(e%=360),e<0&&(e=360+e),e*=Math.PI/180;let i=Re;if((vt||yt)&&(i=Se),0!==e){let a=e>Math.PI?-1:1;s=Math.round(Math.cos(De?-e:e)*(A+be)),u=Math.round(Math.sin(De?-e:e)*(A+be)),d=Math.round(A+be),h=De?Math.round(a<0?0:A+be):Math.round(a<0?A+be:0),t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+i+",0)"),t.addColorStop(.6,"rgba("+i+","+c+")"),n.strokeStyle=t,n.beginPath();let r=1===a?0:-(2*Math.PI-e),l=1===a?e:0;De&&(r=1===a?-e:0,l=1===a?0:-e);let o=F?A:Math.round(vt?A+(xe+be+ne)/2:A+be/2);n.arc(0,0,o,r,l,!1),n.lineWidth=F?2*me:Math.round(vt?xe+be+ne:be),ri(n)}else F||(r=Math.min(.2*o,Math.PI/8),s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),d=Math.round(A+be),h=0,t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+i+",0)"),t.addColorStop(1,"rgba("+i+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+xe/2:A+be/2),0,r,!1),n.lineWidth=Math.round(vt?xe+be:be),ri(n),r=2*Math.PI-r,s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+i+",0)"),t.addColorStop(1,"rgba("+i+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+xe/2:A+be/2),0,r,!0),n.lineWidth=Math.round(vt?xe+be:be),ri(n))}if(c=F?.8:.7,!e&&!H&&(vt||yt))if(0!==de){l=0,r=0;let e=(new i.Vector3).copy(ke.getSightDirection()).normalize(),a=se.dot(e),p=!1;de<180&&de>0?r=de>180*o/Math.PI?o:de*Math.PI/180:de>=180&&de<360&&(r=de*Math.PI/180,p=!0),s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),d=Math.round(A+be),h=0,t=null,a<0?(t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+Se+",0)"),t.addColorStop(1,"rgba("+Se+","+c+")")):(s=Math.round(Math.cos(-r)*(A+be)),u=Math.round(Math.sin(-r)*(A+be)),t=n.createLinearGradient(d,h,s,u),t.addColorStop(0,"rgba("+Se+","+c+")"),t.addColorStop(1,"rgba("+Se+",0)")),n.strokeStyle=t,n.beginPath(),n.arc(0,0,F?A:Math.round(vt?A+be/2+xe/2+ne/2:A+be/2),a<0?0:-r,a<0?r:0,p),n.lineWidth=F?2*me:Math.round(vt?xe+be+ne:be),ri(n)}else F||(r=Math.min(.2*o,Math.PI/8),s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),d=Math.round(A+be),h=0,t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+Se+",0)"),t.addColorStop(1,"rgba("+Se+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+xe/2:A+be/2),0,r,!1),n.lineWidth=Math.round(vt?xe+be:be),ri(n),r=2*Math.PI-r,s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),t=n.createLinearGradient(s,u,d,h),t.addColorStop(0,"rgba("+Se+",0)"),t.addColorStop(1,"rgba("+Se+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+xe/2:A+be/2),0,r,!0),n.lineWidth=Math.round(vt?xe+be:be),ri(n));return $t("_generateMainCanvas"),a}function oi(){let e=Ue.currentViewpoint.create3DRayFrom2DPoint(he),t=(new i.Plane).setFromNormalAndCoplanarPoint(se,oe);return e.intersectPlane(t)||new i.Vector3}function si(e){return void 0===q||void 0===z||(q<z?e>=q&&e<=z:e>=q||e<=z)}function ui(e){return e<.1?0:e>=.1&&e<.4?.25:e>=.4&&e<.7?.55:e>=.7&&e<.9?.75:1}function di(e){let t=k.getMatrix().elements,a=new i.Vector3(t[4],t[5],t[6]),n=(de-e)*Math.PI/180;De||(n=-n);let r=(new i.Matrix4).makeRotationAxis(se,n);return a.applyMatrix4(r),a.dot(ke.getUpDirection())<0}function hi(e){e.setSSAO(!1),e.setShadow(!1,!1),e.setRenderDepth(0),e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.setFrustumCulled(!1)}function ci(e){let t=de,i=e.value;L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&(i-=360,-360===i&&(i=0)),ft=!0,k.setValue(i),ft=!1,Tt=!1,ni("AngularRulerManipulateBegin",{eventName:"AngularRulerManipulateBegin",direction:se,value:de,event:e.event}),ni("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:se,value:de,diffAngle:de-t,rulerDragged:!1,event:e.event}),ni("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:se,value:de,event:e.event})}function pi(e){if(ft)return void(Tt=!1);Tt=!0;let t=e.node;t&&(t.setRatio(1.05),Ue.setTemporaryCursor("pointer"),Ue.render())}function gi(e){if(ft)return;Tt=!1;let t=e.node;t&&(t.setRatio(1),Ue.unsetTemporaryCursor(),Ue.render())}function Mi(e,t,i){Jt("_drawTextCanvas");let a=i||{},n=a.isCurrentValue||!1,r=a.onManipulatorPreactivated||!1,l=n&&ft?1:2,o=fe*l*(n?1.2:1),s=a.reverse;t.width=n?(ne+xe)*l:xe*l,t.height=2*o;let u=t.getContext("2d");u.globalAlpha=a.alpha,u.clearRect(0,0,t.width,t.height);let d,h=0,c=0;!s||n&&ft&&Vt&&Pt?(h=10*l,c=t.height-10*l):(u.rotate(Math.PI),u.textAlign="right",h=-10*l,c=-10*l),u.translate(h,c),d=n?vt||yt?"rgba("+Se+",1)":St?"rgba("+Ie+",1)":r?"rgba("+Ne+",1)":"rgba("+Pe+", 1)":"rgba("+Ve+",1)";let p=Qt(e).toString().replace(".",jt);X&&n&&(p=p.toString()+" "+le);let g=u.font.split(" "),M=F?"bold ":"900 ";return u.font=M+o+"pt "+g[g.length-1],n&&(vt||St&&"220,220,220"===Ve&&!yt)&&(u.shadowColor="white",u.shadowBlur=3*l),u.fillStyle=d,u.fillText(p,0,0),t.textDisplayed=p,$t("_drawTextCanvas"),t}function fi(e,t){Jt("_createGraduationNode");let l,s,u=null,d=null,h=t.alpha,c=t.color,p=Qt(e,!1,!0),g=(de-e)*Math.PI/180;for(De&&(g=-g),l=0;l<it.length;l++)if(!1===it[l].toDispose&&it[l].associatedValue===e){d=it[l];break}if(!d){for(l=0;l<it.length;l++)if(!0===it[l].toDispose){d=it[l],d.manipulator.associatedValue=e,d.texture.dispose();break}if(!d){d={};let t=ge>=7?Math.floor(ge/2)-1:ge-1,l=180*B/(Math.PI*t),u=n.createRectangleNode({width:xe,height:2*fe,fill:!0,noEdge:!0});hi(u),u.setMatrix((new i.Matrix4).makeTranslation(0,-fe,0));let h=new o({ratio:1});h.addChild(u),d.texture=new i.Texture,s=new i.MeshBasicMaterial({map:d.texture,transparent:!0,enableClipPlanes:!1}),s.force=!0,s.depthTest=!1,h.setMaterial(s);let c=n.createCircleNode({radius:(A+be+xe+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-l*Math.PI/180,endAngle:l*Math.PI/180});hi(c),s=new i.MeshBasicMaterial({map:Ht,transparent:!0,enableClipPlanes:!1}),s.force=!0,s.depthTest=!1,c.setMaterial(s),c.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,-2*_e));let p=new r({viewer:Ue,value:e,linkedNode:h});d.manipulator=p,p.subscribe("Click",ci),p.subscribe("BeginManipulate",null),p.subscribe("Manipulate",null),p.subscribe("EndManipulate",null),p.subscribe("BeginPreactivate",pi),p.subscribe("EndPreactivate",gi),d.manipNode=new a,d.manipNode.addChild(h),d.manipNode.addChild(c),d.token=p.linkToNode(d.manipNode),it.push(d)}d.associatedValue=e}for(l=0;l<at.length;l++)if(!1===at[l].toDispose&&at[l].associatedValue===p&&at[l].associatedAlpha===h&&at[l].associatedColor===c&&at[l].reverse===t.reverse){u=at[l];break}if(!u){if(at.length===tt){for(l=0;l<at.length;l++)if(!0===at[l].toDispose){u=at[l];break}}else u={canvas:document.createElement("canvas")},at.push(u);u.canvas=Mi(e,u.canvas,t),u.associatedValue=p,u.associatedAlpha=h,u.associatedColor=c,u.reverse=t.reverse}u.toDispose=!1,d.texture.image=u.canvas,d.texture.needsUpdate=!0,d.toDispose=!1;let M=-Math.sin(g)*(A+be+Te)*Me,f=(-re/2-Math.cos(B)*A)*Me+Math.cos(g)*(A+be+Te)*Me,m=(new i.Matrix4).makeTranslation(f,M,0),b=(new i.Matrix4).makeRotationZ(-1*g);d.manipNode.setMatrix(m.multiply(b)),d.manipNode.setVisibility(!0),Xe.addChild(d.manipNode),$t("_createGraduationNode")}function mi(){Jt("_generateGraduations");let e=ft||It?1:2,t=_t;t.width=Math.round(e*re),t.height=Math.round(e*re);let i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.translate(Math.round(e*re/2),Math.round(e*re/2));let a=1,n=1,r=de*Math.PI/180,l=180*(r-B)/Math.PI;l=(Math.floor(l/K)*K).valueOf();let o=K;ge>=7&&(o=2*K);let s=2*ve*e,u=0,d=0,h=0,c=0,p=0,g=0,M=0,f=0,m=!1,b=[];i.textBaseline="middle";let w,v,y=[],T=[],C=(A+be)*Math.sin(B)*e;for(w=0;w<=ge;w++){if(d=(w*K+l)*Math.PI/180,u=De?d-r:r-d,h=Math.sin(u)*(A+be)*e,c=Math.cos(u)*(A+be)*e,p=Math.sin(u)*A*e,g=Math.cos(u)*A*e,M=Math.sin(u)*(A+.75*be)*e,f=Math.cos(u)*(A+.75*be)*e,B===Math.PI)a=1;else if(Math.abs(u)<=Math.PI/2)if(B<Math.PI/2){let e=C-Math.abs(h);a=e<s?e/s:1}else a=1;else{let t=(A+be)*Math.abs(Math.cos(B))*e-Math.abs(c);a=t<s?t/s:1}Math.abs(u)<=Math.PI/4&&Math.abs(h)<s?(n=Math.max(Math.abs(h)/s*2-1,0),m=!0):(n=a,m=!1),d=w*K+l;let t,i,x,S=d;if(d<0?S=360+d:d>=360&&(S=d-360),d%o==0&&(t=Math.round(10*Math.max(n-.2,0))/10,(t<.1||m&&!wt&&t<.8)&&(t=0),0!==t&&(t=ui(t+.1),si(S)||(t=0),0!==t&&b.push({val:S,alpha:t,nearCurrentValue:m}))),si(S)&&(t=Math.round(10*Math.max(n-.2,0))/10,0!==t&&(t=ui(t+.1),0!==t))){let i={moveTo:{x:Math.round(g),y:Math.round(p)},alpha:t,lineWidth:me*e*2};i.lineTo=d%o!=0?{x:Math.round(f),y:Math.round(M)}:{x:Math.round(c),y:Math.round(h)},y.push(i),-1===T.indexOf(t)&&T.push(t)}for(v=1;v<Z;v++)if(i=(w+v/Z)*K+l,x=i,i<0?x=360+i:i>=360&&(x=i-360),si(x)){let t=i*Math.PI/180-r;if(De||(t=-t),Math.abs(t)>B)continue;h=Math.sin(t)*(A+Ce)*e,c=Math.cos(t)*(A+Ce)*e,p=Math.sin(t)*A*e,g=Math.cos(t)*A*e;let n=Math.abs(p)<s?Math.max(2*Math.abs(p)/s-1,0):a;if(B===Math.PI&&Math.cos(t)<0&&(n=1),n=ui(n),0===n)continue;let l={moveTo:{x:Math.round(g),y:Math.round(p)},alpha:n,lineWidth:me*e};l.lineTo={x:Math.round(c),y:Math.round(h)},y.push(l),-1===T.indexOf(n)&&T.push(n)}}let x=[me*e*2,me*e];for(let e=0;e<x.length;e++)for(w=0;w<T.length;w++){for(i.beginPath(),i.strokeStyle=0===e&&vt||1===e&&yt?"rgba("+Se+","+T[w]+")":"rgba(0,0,0,"+T[w]+")",v=0;v<y.length;v++)y[v].alpha===T[w]&&x[e]===y[v].lineWidth&&(i.lineWidth=y[v].lineWidth,i.moveTo(y[v].moveTo.x,y[v].moveTo.y),i.lineTo(y[v].lineTo.x,y[v].lineTo.y));ri(i)}for(w=0;w<it.length;w++)it[w].toDispose=!0,it[w].manipNode.setVisibility(!1);for(w=0;w<at.length;w++)at[w].toDispose=!0;for(w=0;w<b.length;w++){let e=Qt(b[w].val);for(v=0;v<it.length;v++)it[v].associatedValue===b[w].val&&(it[v].toDispose=!1);for(v=0;v<at.length;v++)at[v].associatedValue===e&&at[v].associatedAlpha===b[w].alpha&&at[v].associatedColor===Ve&&(at[v].toDispose=!1)}for(w=0;w<b.length;w++){let e=di(b[w].val);fi(b[w].val,{alpha:b[w].alpha,nearCurrentValue:b[w].nearCurrentValue,color:Ve,reverse:e})}return $t("_generateGraduations"),t}function bi(e){St=!1,Tt=!1;let t=de,i=e?e.event?e.event:e.from[0].event:null;if(!xt&&ze.children.length){let e=(ze.children[0].getInputValue()||"").replace(jt,".");if(!isNaN(e)&&e&&""!==e){let a=parseFloat(e)/Y;mt=!0,k.setValue(a),mt=!1,ni("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:se,value:de,diffAngle:de-t,rulerDragged:!1,event:i,fromEditor:!0})}}Yt(),ni("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:se,value:de,event:i})}function wi(e){St=!1,Tt=!1,e&&e.doNotRefresh||Yt();let t=e?e.event?e.event:e.from?e.from[0].event:null:null;ni("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Cancelled",direction:se,value:de,event:t})}function vi(a){if(ft=!1,!ze.children.length){let n=Qt(de,!0),l=$;l<1?l/=Q>0?10:100:l*=Q>0?10:100,n=Math.round(n*l)/l;let o=new t({value:n,okCB:bi,cancelCB:wi,startValue:q*Y,endValue:z*Y,frmWindow:e});new r({viewer:Ue}).linkToNode(o),ze.addChild(o),a.event.from[0].currentPosition.x&&(he.x=a.event.from[0].currentPosition.x),a.event.from[0].currentPosition.y&&(he.y=a.event.from[0].currentPosition.y);let s=oi(),u=(new i.Matrix4).makeTranslation(s.x,s.y,s.z),d=(new i.Matrix4).getInverse(Ae.getMatrix());ze.setMatrix(d.multiply(u));let h=-30,c=-30,p=155,g=30;s=a.event.from[0].currentPosition,s.x+h<0?h=-1*s.x+15:s.x+h+p>Ue.SCREEN_WIDTH&&Ue.SCREEN_WIDTH>p&&(h=h+-1*(s.x+h+p-Ue.SCREEN_WIDTH)-15),s.y+c<0?c=-1*s.y+15:s.y+c+g>Ue.SCREEN_HEIGHT&&Ue.SCREEN_HEIGHT>g&&(c=c+-1*(s.y+c+g-Ue.SCREEN_HEIGHT)-15),o.setOffset(new i.Vector2(h,c)),Mt=!0,setTimeout((function(){Ye.setVisibility(!1),Ue.render()}),0)}}function yi(){let e=de-j;e<0&&(e=360+e);let t,i,a,n=De?e<=180:e>180;F?(t=N,i=V,a=I):(t=n&&H?v:H?m:g,i=n&&H?T:H?w:f,a=n&&H?y:H?b:M);let r=!0===xt?i:Ct?a:t;Ge.getMaterial().map!==r&&(Ge.getMaterial().map=r),Ue.render()}function Ti(){ft||(Wt.dispose(),Wt.image=Mi(de,Et,{isCurrentValue:!0,onManipulatorPreactivated:!0,alpha:1,reverse:di(de)}),Wt.needsUpdate=!0,$e.setRatio(1.05),Tt=!0,Ue.setTemporaryCursor("pointer"),Ue.render())}function Ci(){ft?Tt=!1:(Wt.dispose(),Wt.image=Mi(de,Et,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1,reverse:di(de)}),Wt.needsUpdate=!0,$e.setRatio(1),Tt=!1,Ue.unsetTemporaryCursor(),Ue.render())}function xi(e){Jt("_entireManipulationMeasure"),k.initValue=de,ft=!0,Vt=e&&e.event&&e.event.from&&e.event.from.length&&"Touch"===e.event.from[0].type,Ue.setTemporaryCursor("-webkit-grabbing",10),ni("AngularRulerManipulateBegin",{eventName:"AngularRulerManipulateBegin",value:de,direction:se,event:e.event})}function Si(e){Jt("_manipulateCB");let t=k.getSnappedRotationValue(e),i=t.snappedRotationAngle;if(0!==t.returnCode||void 0===i)return;let a=de;k.setValue(i+k.initValue),ni("AngularRulerManipulate",{eventName:"AngularRulerManipulate",value:i,diffAngle:de-a,rulerDragged:!0,direction:se,event:e.event}),$t("_manipulateCB")}function Ri(e,t){vt=!1,yt=!1,Ue.unsetTemporaryCursor(),t||!1||Yt(),ni("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:se,value:de,event:e.event}),ft=!1,$t("_entireManipulationMeasure")}function Ni(e){e.event.from[0].currentPosition.x&&(he.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(he.y=e.event.from[0].currentPosition.y);let t=(new i.Vector3).copy(oi()).sub(oe),a=de,n=180*te.angleTo(t)/Math.PI;if((new i.Vector3).copy(te).cross(t).dot(se)<0&&(n=360-n),Math.abs(a-n)>=5){let t=K/Z;n=Math.round(n/t)*t,k.setValue(n),xi(e),ni("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:se,value:de,diffAngle:de-a,rulerDragged:!1,event:e.event})}else xi(e);xt=!0}function Ii(e){if(ft)return void(Tt=!1);e.event.from[0].currentPosition.x&&(he.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(he.y=e.event.from[0].currentPosition.y);let t=(new i.Vector3).copy(oi()).sub(oe),a=de,n=180*te.angleTo(t)/Math.PI;(new i.Vector3).copy(te).cross(t).dot(se)<0&&(n=360-n),Ct=!1,Math.abs(a-n)<5?(Ct=!0,F||(He.setVisibility(!1),Fe.setVisibility(!0))):F||(He.setVisibility(!0),Fe.setVisibility(!1)),Ue.setTemporaryCursor("pointer"),yi()}function Vi(){Tt=!1,Ct=!1,ft||(He.setVisibility(!1),Fe.setVisibility(!0),Ue.unsetTemporaryCursor(),yi())}function Pi(){if(Jt("_initRulerParameters"),!Rt){if(!k.origin)return;if(oe=(new i.Vector3).copy(k.origin),!k.direction)return;se=(new i.Vector3).copy(k.direction).normalize();let e,t=D.DEG_UNIT,a=!1;if(Y=1,"number"==typeof k.unit||"string"==typeof k.unit)k.unit&D.RAD_UNIT||"Radian"===k.unit?(t=D.RAD_UNIT,Y=Math.PI/180):k.unit&D.GRAD_UNIT||"Grade"===k.unit?(t=D.GRAD_UNIT,Y=1/.9):k.unit&D.MRAD_UNIT||"Milliradian"===k.unit?(t=D.MRAD_UNIT,Y=1e3*Math.PI/180):k.unit&D.INPERFOOT_UNIT||"InchPerFoot"===k.unit?(t=D.INPERFOOT_UNIT,Y=1/4.77464829):(k.unit&D.PERCENT_UNIT||"AnglePercent"===k.unit)&&(t=D.PERCENT_UNIT,Y=100/360);else if(window.widget&&window.widget.hasPreference&&window.widget.hasPreference("Angle")){let e=window.widget.getValue("Angle");if(e)switch(e){case"Degree":case"deg":t=D.DEG_UNIT,Y=1;break;case"Radian":case"rad":t=D.RAD_UNIT,Y=Math.PI/180}}for(let e=0;e<U.length;e++)if(t===U[e].unit&&le!==U[e].nls){a=!0,le=U[e].nls;break}if(X="boolean"!=typeof k.displayUnit||k.displayUnit,O="number"==typeof k.radius&&!isNaN(k.radius)&&k.radius>=0?k.radius:0,G="number"==typeof k.worldRadius&&!isNaN(k.worldRadius)&&k.worldRadius>=0?k.worldRadius:0,k.originVector&&(ue=(new i.Vector3).copy(k.originVector).normalize()),ue&&Math.round(100*ue.dot(se))/100!=0)return;if("number"!=typeof k.openingAngle||isNaN(k.openingAngle)?B=45:((k.openingAngle<-360||k.openingAngle>360)&&(k.openingAngle=k.openingAngle%360),k.openingAngle<0&&(k.openingAngle=360+k.openingAngle),0===k.openingAngle&&(k.openingAngle=360),B=k.openingAngle/2),B*=Math.PI/180,K="number"==typeof k.mainGrad&&!isNaN(k.mainGrad)&&k.mainGrad>0?k.mainGrad:10,Z="number"==typeof k.nbSecondaryGrads&&!isNaN(k.nbSecondaryGrads)&&k.nbSecondaryGrads>=0?k.nbSecondaryGrads+1:5,q="number"!=typeof k.startValue||isNaN(k.startValue)?void 0:k.startValue,z="number"!=typeof k.endValue||isNaN(k.endValue)?void 0:k.endValue,void 0!==q&&void 0!==z&&((q<-360||q>360)&&(q%=360),q<0&&(q=360+q),(z<-360||z>360)&&(z%=360),z<0&&(z=360+z),q===z&&(z=void 0,q=void 0)),j="number"!=typeof k.originValue||isNaN(k.originValue)?0:k.originValue,j=ei(j),L=k.graduationsDisplay===D.SYMETRIC_GRADUATIONS||k.graduationsDisplay===D.FULLSYMETRIC_GRADUATIONS||k.graduationsDisplay===D.ORIENTED_GRADUATIONS?k.graduationsDisplay:D.DEFAULT_GRADUATIONS,F="boolean"==typeof k.lightDisplay&&k.lightDisplay,W="boolean"==typeof k.displayRulerDuringLocalTransfo&&k.displayRulerDuringLocalTransfo,H="boolean"==typeof k.displayOrigin&&k.displayOrigin,J="boolean"!=typeof k.hideOnEmptySelection||k.hideOnEmptySelection,Q=0,"number"==typeof k.nbDecimals&&(k.nbDecimals>=0&&k.nbDecimals<=9?Q=k.nbDecimals:k.nbDecimals<0?Q=0:k.nbDecimals>9&&(Q=9)),ne=0,X)if(t!==D.DEG_UNIT&&t!==D.PERCENT_UNIT){let e=Ot.getContext("2d"),t=e.font.split(" "),i=F?"bold ":"900 ";e.font=i+1.1*fe+"pt "+t[t.length-1],ne=Math.round(10*e.measureText(" "+le).width)/10}else ne=5;if(Jt("_updateGraduationColors"),255*new i.Color(Ue.backgroundColor).getHSL().l>120?(Ve="80, 80, 80",Pe="0,0,0"):(Ve="220,220,220",Pe="240,240,240"),$t("_updateGraduationColors"),ft=!1,vt=!1,yt=!1,xt=!1,St=!1,wt=!1,1===ke.getProjectionType())e=ke.camera.top-ke.camera.bottom;else{let t=ke.getAngle()*Math.PI/180,a=(new i.Vector3).copy(ke.getEyePosition()),n=(new i.Vector3).copy(oe),r=(new i.Vector3).subVectors(n,a);e=2*Math.tan(.5*t)*r.length()}let n=ke.camera.height&&ke.camera.fullHeight?ke.camera.height/ke.camera.fullHeight:1;Me=e*n/Ue.SCREEN_HEIGHT,Me<1&&(_e=Me),A=Math.max(G/Me,0),A+=O,A=Math.max(A,100);let r=xe;if($=1,Q>0?(xe=100+15*Q,$=Math.pow(10,Q)):xe=100,re=2*(A+be+xe+ne),(xe!==r||a)&&(H&&(kt=document.createElement("canvas")),at.length=0,Nt=!1),ae=(new i.Vector3).copy(se),ue?te=(new i.Vector3).copy(ue):(ie=new i.Vector3(ae.y,ae.x,0).normalize(),0===ie.x&&0===ie.y&&0===ie.z&&(ie=new i.Vector3(ae.z,0,ae.x).normalize()),te=(new i.Vector3).crossVectors(ae,ie).normalize()),ie=(new i.Vector3).crossVectors(ae,te).normalize(),ae.dot(ke.getSightDirection())>0?(ie.multiplyScalar(-1),ae.multiplyScalar(-1),De=!0):De=!1,ge=Math.round(2*B*180/(Math.PI*K)),ge++,0===rt){let e=!1,t=function(){if(ze&&ze.children.length&&wi({doNotRefresh:!0}),W){let t=(new i.Vector3).copy(se).dot(ke.getSightDirection());De===t>0?Nt=!0:e=!0,ti()?(Ae.setVisibility(!1),Oe.setVisibility(!1)):(e&&Nt&&It&&(Nt=!1,e=!1),Yt()),Nt=!1}else!0===k.getVisibleFlag()&&(k.setVisibleFlag(!1),e=!0),It||(ee&&(clearTimeout(ee),ee=null),ee=setTimeout(Xt,200))};Xt=function(){W||e&&(k.setVisibleFlag(!0),0===G?(ti()?(Ae.setVisibility(!1),Oe.setVisibility(!1)):Yt(),It=!1):(It=!1,Yt())),e=!1},rt=s.subscribe({event:"/VISU/"},(function(e){"@onViewpointBeginMove"===e.eventType?It=!0:"@onViewpointChange"===e.eventType?t():"@onViewpointEndMove"===e.eventType&&(Xt(),It=!1)})),nt=Ue.onBackgroundModify((function(){k.getVisibleFlag()&&Yt()})),d.addEvent(Ue.canvas,"onPrimaryPointerClick",ii),d.addEvent(Ue.canvas,"onPrimaryPointerMoveUnique",ii)}Rt=!0}$t("_initRulerParameters")}Yt=function(){Jt("_internalDisplay"),qt(),Pi(),zt();let e=k.value;L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&(e-=360,-360===e&&(e=0)),k.setValue(e),$t("_internalDisplay")},qt=function(){if(Jt("_internalClear"),Rt){if(ee&&Xt&&(clearTimeout(ee),ee=null,Xt(),Xt=null),!Nt){for(let e=0;e<it.length;e++)it[e].manipulator&&0!==it[e].token&&it[e].manipulator.unlink(it[e].token),ai(it[e].manipNode,!1),it[e].texture.dispose();it.splice(0,it.length),0!==ct&&pt.unlink(ct),0!==ut&&lt.unlink(ut),ut=0,ct=0,pt=null,lt=null}0!==ht&&dt.unlink(ht),0!==ot&&st.unlink(ot),ot=0,ht=0,st=null,dt=null,ai(Ae,!1),ai(Oe,!1),Ue.removeNode(Ae),Ue.removeNode(Oe),0===rt||W&&(!W||It)||(s.unsubscribe(rt),Ue.unsubscribe(nt),d.removeEvent(Ue.canvas,"onPrimaryPointerClick",ii),d.removeEvent(Ue.canvas,"onPrimaryPointerMoveUnique",ii),rt=0),Rt=!1,de=null}$t("_internalClear")},zt=function(){if(Jt("_internalBuild"),!Rt)return;let e;if(A<Ue.SCREEN_WIDTH||A<Ue.SCREEN_HEIGHT){let t,a;if(Fe=n.createRectangleNode({width:re*Me,height:re*Me,fill:!0,noEdge:!0}),hi(Fe),e=new i.MeshBasicMaterial({map:Bt,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,Fe.setMaterial(e),Fe.setMatrix((new i.Matrix4).makeTranslation(-(re+A*Math.cos(B))*Me,-re*Me/2,-3*_e)),(!It&&0===G||0!==G)&&(gt=!0),F||(He=n.createRectangleNode({width:re*Me,height:re*Me,fill:!0,noEdge:!0}),hi(He),!H&&gt&&(Ft.dispose(),Ft.image=li(!0),Ft.needsUpdate=!0),e=new i.MeshBasicMaterial({map:Ft,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,He.setMaterial(e),He.setMatrix((new i.Matrix4).makeTranslation(-(re+A*Math.cos(B))*Me,-re*Me/2,-3*_e)),We=n.createRectangleNode({width:re*Me,height:re*Me,fill:!0,noEdge:!0}),hi(We),e=new i.MeshBasicMaterial({map:Lt,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,We.setMaterial(e),We.setMatrix((new i.Matrix4).makeTranslation(-(re+A*Math.cos(B))*Me,-re*Me/2,-2*_e))),!Nt){a=n.createRectangleNode({width:ne+xe,height:2.4*fe,fill:!0,noEdge:!0}),hi(a),a.setMatrix((new i.Matrix4).makeTranslation(0,1.2*-fe,0)),$e=new o({ratio:1}),$e.addChild(a),$e.setVisibility(!0),e=new i.MeshBasicMaterial({map:Wt,transparent:!0,enableClipPlanes:!1}),e.force=!0,$e.setMaterial(e),Ye.addChild($e),t=Math.PI/12;let l=n.createCircleNode({radius:(A+be+xe+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});if(hi(l),e=new i.MeshBasicMaterial({map:Ht,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,l.setMaterial(e),l.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,0)),Ye.addChild(l),!F){let a=n.createCircleNode({radius:(A+be+xe+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-2*t,endAngle:2*t});hi(a),e=new i.MeshBasicMaterial({map:Ht,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,a.setMaterial(e),a.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,-2*_e)),Ye.addChild(a)}let s=F?(-re/2+(1-Math.cos(B))*A+Te)*Me:(-re/2+(1-Math.cos(B))*A+be+Te)*Me;if(Ye.setMatrix((new i.Matrix4).makeTranslation(s,0,0)),0===ut){lt=new r({viewer:Ue,axis:(new i.Vector3).copy(se),center:oe}),lt.subscribe("Click",vi),lt.subscribe("BeginManipulate",(function(e){xt=!1,St=!0,xi(e)}));let e=!0;lt.subscribe("Manipulate",(function(t){e=!1,Si(t)})),lt.subscribe("EndManipulate",(function(t){xt=!1,St=!1,Ri(t,e)})),lt.subscribe("BeginPreactivate",Ti),lt.subscribe("EndPreactivate",Ci),ut=lt.linkToNode(Ye)}}t=1.5*B,t>Math.PI&&(t=Math.PI);let s=(A+be/2)*Me,u=n.createCircleNode({radius:s,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});hi(u),je.addChild(u),e=new i.MeshBasicMaterial({map:Ht,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,je.setMaterial(e),je.setMatrix((new i.Matrix4).makeTranslation(-(re/2+A*Math.cos(B))*Me,0,_e)),0===ht&&(dt=new r({viewer:Ue,axis:(new i.Vector3).copy(se),center:oe}),dt.subscribe("BeginManipulate",Ni),dt.subscribe("Manipulate",Si),dt.subscribe("EndManipulate",(function(e){xt=!1,Ri(e)})),dt.subscribe("Click",(function(e){xt=!1,Ri(e)})),dt.subscribe("Preactivate",Ii),dt.subscribe("EndPreactivate",Vi),ht=dt.linkToNode(je)),t=Math.min(-2*B,Math.PI),s=F?(A-be/2)*Me:A*Me;let d,h,c=n.createCircleNode({radius:s,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});if(hi(c),Je.addChild(c),e=new i.MeshBasicMaterial({map:Ht,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,Je.setMaterial(e),Je.setMatrix((new i.Matrix4).makeTranslation(-(re/2+A*Math.cos(B))*Me,0,2*_e)),H){if(!Nt&&!F){a=n.createRectangleNode({width:xe,height:2*fe,fill:!0,noEdge:!0}),hi(a),a.setMatrix((new i.Matrix4).makeTranslation(0,-fe,0));let l=new o({ratio:1});l.addChild(a),Kt.image=Mi(j,kt,{alpha:1,reverse:di(j)}),Kt.needsUpdate=!0,e=new i.MeshBasicMaterial({map:Kt,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,l.setMaterial(e),Ze.addChild(l);let s=ge>=7?Math.floor(ge/2)-1:ge-1;t=B/s;let u=n.createCircleNode({radius:(A+be+xe+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});hi(u),e=new i.MeshBasicMaterial({map:Ht,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,u.setMaterial(e),u.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,-2*_e)),Ze.addChild(u),pt=new r({viewer:Ue,value:j,linkedNode:l}),pt.subscribe("Click",ci),pt.subscribe("BeginManipulate",null),pt.subscribe("Manipulate",null),pt.subscribe("EndManipulate",null),pt.subscribe("BeginPreactivate",pi),pt.subscribe("EndPreactivate",gi),ct=pt.linkToNode(Ze)}F?(d=16*Me,h=16*Me):(d=(be+ye+4*me)*Me,h=H?(ve/2+2*me)*Me:(ve+me)*Me),Be=n.createRectangleNode({width:d,height:h,fill:!0,noEdge:!0}),hi(Be),e=new i.MeshBasicMaterial({map:F?P:C,transparent:!0,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,Be.setMaterial(e)}if(F?(d=we*Me,h=we*Me):(d=(be+ye+4*me)*Me,h=H?(ve/2+2*me)*Me:(ve+me)*Me),Ge=n.createRectangleNode({width:d,height:h,fill:!0,noEdge:!0}),hi(Ge),e=new i.MeshBasicMaterial({map:F?N:H?m:g,side:i.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1}),e.force=!0,e.depthTest=!1,Ge.setMaterial(e),Ge.setVisibility(!0),0===ot&&(st=new r({viewer:Ue,axis:(new i.Vector3).copy(se),center:oe}),st.subscribe("Click",null),st.subscribe("BeginManipulate",(function(e){xt=!0,St=!1,xi(e)})),st.subscribe("Manipulate",Si),st.subscribe("EndManipulate",(function(e){xt=!1,St=!1,Ri(e)})),st.subscribe("BeginPreactivate",(function(){Ct=!0,Ue.setTemporaryCursor("pointer"),yi()})),st.subscribe("EndPreactivate",(function(){Ct=!1,Ue.unsetTemporaryCursor(),yi()})),ot=st.linkToNode(Ge)),H)if(Ae.addChild(et),F){let e=new l({type:"Spherical"});e.addChild(Be),Be.setMatrix((new i.Matrix4).makeTranslation(-20*Me*.4,-20*Me*.4,0)),et.addChild(e)}else et.addChild(Be),Ae.addChild(Ze);if(Oe.addChild(Fe),Ae.addChild(Ye),Ae.addChild(je),Ae.addChild(Je),Ae.addChild(qe),Ae.addChild(ze),F){let e=new l({type:"Spherical"});e.addChild(Ge),Ge.setMatrix((new i.Matrix4).makeTranslation(-20*Me/2,-20*Me/2,0)),qe.addChild(e)}else qe.addChild(Ge),Oe.addChild(He),Oe.addChild(We),Ae.addChild(Xe);Ae.addChild(Ke)}let t=new i.Vector3((-re/2+(1-Math.cos(B))*A-ye+10)*Me,0,0),a=new i.Vector3((-re/2-Math.cos(B)*A)*Me,0,0),s=n.createLineNode({points:[t,a]});hi(s),e=new i.LineBasicMaterial({color:"80, 80, 80"===Ve?0:16777215,opacity:.5,transparent:!0}),e.force=!0,e.depthTest=!1,s.setMaterial(e),Oe.addChild(s),H&&(t=new i.Vector3((-re/2+(1-Math.cos(B))*A-ye+10)*Me,0,0),a=new i.Vector3((-re/2-Math.cos(B)*A)*Me,0,0),s=n.createLineNode({points:[t,a]}),hi(s),Qe.addChild(s),e=new i.LineBasicMaterial({color:"80, 80, 80"===Ve?0:16777215,opacity:.5,transparent:!0}),e.force=!0,e.depthTest=!1,Qe.setMaterial(e),Oe.addChild(Qe)),Ue.addNode(Ae,!1),Ue.addNode(Oe,!1);let u=(new i.Vector3).copy(te).multiplyScalar((re/2+A*Math.cos(B))*Me),d=(new i.Vector3).copy(oe).add(u);Le=new i.Matrix4(te.x,ie.x,ae.x,d.x,te.y,ie.y,ae.y,d.y,te.z,ie.z,ae.z,d.z,0,0,0,1),Ae.setMatrix(Le),Oe.setMatrix(Le),de=null,$t("_internalBuild")},this.setValue=function(e){Jt("setValue");let t=this.value,a=e;mt&&!ft&&L===D.ORIENTED_GRADUATIONS&&t>180&&t!==a&&(a=360-a),a=ei(a),ft&&a%360==0&&(t>=180?a=360:t<180&&(a=0)),pe=ce,L===D.FULLSYMETRIC_GRADUATIONS&&(ft&&(a>300||a<60)?t<=180&&a>180&&t<a?ce=-1:t>180&&a<=180&&t>a&&(ce=1):ft||(ce=e<0?-1:e>0?1:ce)),this.value=a,this.getVisibleFlag()&&function(){if(Jt("_internalRefresh"),!Rt)return void Yt();let e=(new i.Matrix4).makeRotationAxis(se,k.value*Math.PI/180),t=(new i.Matrix4).setPosition(oe),a=(new i.Matrix4).getInverse(t).multiply(Le),n=(new i.Matrix4).copy(e).multiply(a),r=(new i.Matrix4).copy(t).multiply(n);if(Ae.setMatrix(r),Oe.setMatrix(r),(A<Ue.SCREEN_WIDTH||A<Ue.SCREEN_HEIGHT)&&k.value!==de){if(de=k.value,ze.removeChildren(),Fe.setVisibility(!0),He.setVisibility(!1),Nt){0!==G&&((gt||H)&&(Bt.dispose(),Bt.image=li(!1),Bt.needsUpdate=!0),gt=!1,H&&!F&&(Ft.dispose(),Ft.image=li(!0),Ft.needsUpdate=!0),F||(Lt.dispose(),Lt.image=mi(),Lt.needsUpdate=!0));for(let e=0;e<it.length;e++)if(!1===it[e].toDispose){let t=(de-it[e].associatedValue)*Math.PI/180;De&&(t=-t);let a=-Math.sin(t)*(A+be+Te)*Me,n=(-re/2-Math.cos(B)*A)*Me+Math.cos(t)*(A+be+Te)*Me;it[e].manipNode.setMatrix((new i.Matrix4).makeTranslation(n,a,0).multiply((new i.Matrix4).makeRotationZ(-1*t)))}let e=F?(-re/2+(1-Math.cos(B))*A+Te)*Me:(-re/2+(1-Math.cos(B))*A+be+Te)*Me;Ye.setMatrix((new i.Matrix4).makeTranslation(e,0,0))}else Xe.removeChildren(),(gt||H)&&(Bt.dispose(),Bt.image=li(!1),Bt.needsUpdate=!0),gt=!1,H&&!F&&(Ft.dispose(),Ft.image=li(!0),Ft.needsUpdate=!0),F||(Lt.dispose(),Lt.image=mi(),Lt.needsUpdate=!0),Wt.dispose(),Wt.image=Mi(de,Et,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1,reverse:di(de)}),Wt.needsUpdate=!0;H&&L&&D.FULLSYMETRIC_GRADUATIONS&&pe!==ce&&(Kt.dispose(),Kt.image=Mi(j,kt,{alpha:1,reverse:di(j)}),Kt.needsUpdate=!0);let e=0;e=H?(ve/2+2*me)*Me:(ve+me)*Me;let n=de-j;n<0&&(n=360+n);let l,o,s=De?n<=180:n>180;F?(l=N,o=V):(l=s&&H?v:H?m:g,o=s&&H?T:H?w:f);let u=!0===xt?o:l;Ge.getMaterial().map!==u&&(Ge.getMaterial().map=u);let d=new i.Matrix4;if(F?(d.makeTranslation((-re/2+(1-Math.cos(B))*A)*Me,0,0),qe.setMatrix(d)):(H?d.makeTranslation((-re/2+(1-Math.cos(B))*A-ye)*Me,s?-e:0,0):d.makeTranslation((-re/2+(1-Math.cos(B))*A-ye)*Me,-e/2,0),qe.setMatrix(d)),H){let n=(de-j)*Math.PI/180;De&&(n=-n);let l=!0;for(let e=0;e<it.length;e++)it[e].associatedValue===j&&(l=!1);if(l&&!F){let e=Math.abs(de-j);if(e<180&&e*Math.PI/180>B||e>=180&&(360-e)*Math.PI/180>B){let e=(new i.Matrix4).makeTranslation((-re/2-Math.cos(B)*A)*Me+Math.cos(n)*(A+be+Te)*Me,-Math.sin(n)*(A+be+Te)*Me,0);Ze.setMatrix(e.multiply((new i.Matrix4).makeRotationZ(-n)))}else l=!1}if(Ze.setVisibility(l),!F){let e=!0===xt?s?R:x:s?S:C;Be.getMaterial().map!==e&&(Be.getMaterial().map=e)}let o=(new i.Matrix4).makeRotationAxis(se,j*Math.PI/180),u=(new i.Matrix4).copy(t).multiply(o.multiply(a)),d=new i.Matrix4;F?d.makeTranslation((-re/2+(1-Math.cos(B))*A)*Me,0,0):d.makeTranslation((-re/2+(1-Math.cos(B))*A-ye)*Me,s?0:-e,0),et.setMatrix((new i.Matrix4).getInverse(r).multiply(u).multiply(d))}if(ft&&Vt&&Pt){if(Ye.setVisibility(!1),!Ke.children.length&&Wt){let e=new c({html:Wt.image});Ke.setMatrix((new i.Matrix4).makeTranslation((-re/2+(1-Math.cos(B))*A)*Me,0,0)),Ke.addChild(e)}Ke.children[0].setOffset(new i.Vector2(-Wt.image.getContext("2d").measureText(Wt.image.textDisplayed).width/2,-85))}else Ye.setVisibility(!0),Ke.removeChildren();wt=!0,Tt=!1}if(H){let e=(new i.Matrix4).copy(t).multiply((new i.Matrix4).makeRotationAxis(se,j*Math.PI/180).multiply(a));Qe.setMatrix((new i.Matrix4).getInverse(r).multiply(e))}Ae.setVisibility(!ti()&&bt),Oe.setVisibility(!ti()&&bt),Ue.render(),$t("_internalRefresh")}(),$t("setValue")},this.getDisplayedValue=function(e){return Qt(this.value,"boolean"!=typeof e||!e)},this.getMatrix=function(){return Ae?(new i.Matrix4).copy(Ae.getMatrixWorld()):null},this.setVisibleFlag=function(e){if(e!==bt){if(bt=e,Ae.setVisibility(!ti()&&bt),Oe.setVisibility(!ti()&&bt),bt){let e=this.value;L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&(e-=360,-360===e&&(e=0)),this.setValue(e)}Ue.render()}},this.getVisibleFlag=function(){return Rt?bt:null},this.setVisibilityFree=function(e){Ae&&Oe&&Ae.setVisibilityFree&&Oe.setVisibilityFree&&(Oe.setVisibilityFree(e),Ae.setVisibilityFree(e))},this.getVisibilityFree=function(){return Ae?Ae.visibilityFree:null},this.clear=function(){gt=!1,Mt=!1,ft=!1,wt=!1,vt=!1,yt=!1,Tt=!1,Ct=!1,xt=!1,St=!1,Nt=!1,It=!1,Vt=!1,Pt=!1,qt()},this.subscribe=function(e,t){if(e&&t&&("AngularRulerManipulateBegin"===e||"AngularRulerManipulate"===e||"AngularRulerManipulateEnd"===e))return Ee.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&Ee.unsubscribe(e)},this.getSnappedRotationValue=function(e){Jt("getSnappedRotationValue");let t=se.dot(e.axis)<0?2*Math.PI-e.angle:e.angle;t=180*t/Math.PI,(vt||yt)&&(gt=!0),vt=!1,yt=!1,Pt=!1;let a=oi(),n=(new i.Vector3).copy(a).sub(oe),r=Ae.getMatrix().elements,l=new i.Vector3(r[0],r[1],r[2]),o=Math.abs(l.angleTo(n)),s=n.length(),u=1.5*B;if(u>Math.PI&&(u=Math.PI),s<(F?(A+be)*Me:(A+be+xe+ne)*Me)&&o<u){let e;if(e=!F&&s<A*Me||F&&s<(A-be)*Me?"noSnap":!F&&s<(A+be)*Me||F&&s<(A+be)*Me?"snappingSmallGrads":F?"noSnap":"snappingMainGrads","noSnap"!==e){Pt=!0,gt=!0,vt="snappingMainGrads"===e,yt="snappingSmallGrads"===e,t+=this.initValue;let i="snappingSmallGrads"===e?K/Z:K;t=Math.round(t/i)*i,t=ei(t),t-=this.initValue}}else F&&(Pt=s>A*Me&&s<(A+be/2+Wt.image.getContext("2d").measureText(Wt.image.textDisplayed).width)*Me);return $t("getSnappedRotationValue"),{snappedRotationAngle:t,axis:se,returnCode:0}},this.beginManipulation=function(){ft=!0,Ae.setPickable(h.PICKTHROUGH)},this.endManipulation=function(){Ae.setPickable(h.PICKABLE),ft=!1,vt=!1,yt=!1},this.display=function(){gt=!1,Mt=!1,ft=!1,wt=!1,vt=!1,yt=!1,Tt=!1,Ct=!1,xt=!1,St=!1,Nt=!1,It=!1,Vt=!1,Pt=!1,Yt()},this.refresh=function(){this.setValue(this.value)}}});return D.DEFAULT_GRADUATIONS=0,D.ORIENTED_GRADUATIONS=1,D.SYMETRIC_GRADUATIONS=2,D.FULLSYMETRIC_GRADUATIONS=3,D.DEG_UNIT=1,D.RAD_UNIT=2,D.GRAD_UNIT=4,D.MRAD_UNIT=8,D.INPERFOOT_UNIT=16,D.PERCENT_UNIT=32,D})),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/Ruler",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/Ruler/RulerEditor","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Ruler/RulerManipulator","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/SceneGraphNodes/CSS2DNode","i18n!DS/Ruler/assets/nls/Ruler"],(function(e,t,i,a,n,r,l,o,s,u,d,h,c,p,g){"use strict";const M=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator.png"),void 0,null,null,!0);M.flipY=!1;const f=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Over.png"),void 0,null,null,!0);f.flipY=!1;const m=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_On.png"),void 0,null,null,!0);m.flipY=!1;const b=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0);b.flipY=!1;const w=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0);w.flipY=!1;const v=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);v.flipY=!1;const y=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0),T=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0),C=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),x=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0),S=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),R=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0),N=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0);N.flipY=!1;const I=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);I.flipY=!1;const V=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0);V.flipY=!1;const P=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLight.png"),void 0,null,null,!0),D=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOver.png"),void 0,null,null,!0),_=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOn.png"),void 0,null,null,!0),E=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightZeroManip.png"),void 0,null,null,!0),U=require.toUrl("DS/Ruler/assets/textures/Web3DUX_OriginManipulator.png"),k=require.toUrl("DS/Ruler/assets/textures/Web3DUX_OriginManipulatorOn.png"),A=require.toUrl("DS/Ruler/assets/textures/Web3DUX_OriginManipulatorOver.png"),O=t.extend({init:function(t,G){if(!t)return void window.console.error("Ruler - Frame window argument missing");const B=G||{};this._parent(B),this.value=0,this.initValue=0,this.origin=new n.Vector3,this.direction=new n.Vector3(0,0,1),this.offset=B.offset,this.worldOffset=B.worldOffset,this.mainGrad=B.mainGrad,this.nbSecondaryGrads=B.nbSecondaryGrads,this.startValue=B.startValue,this.endValue=B.endValue,this.lightDisplay=B.lightDisplay,this.displayOrigin=B.displayOrigin,this.originDisplay=B.originDisplay,this.lockedOrigin=B.lockedOrigin,this.onOriginManipulator=B.onOriginManipulator,this.unit=B.unit,this.displayUnit=B.displayUnit,this.displayRulerDuringLocalTransfo=B.displayRulerDuringLocalTransfo,this.graduationsDisplay=B.graduationsDisplay,this.rulerDisplay=B.rulerDisplay,this.originValue=B.originValue,this.hideOnEmptySelection=B.hideOnEmptySelection,this.nbDecimals=B.nbDecimals,this.scale=B.scale;const L=this;let F,W,H,X,Y,q,z,K,Z,j,J,$,Q,ee,te,ie,ae,ne,re,le,oe,se,ue,de,he,ce,pe,ge,Me,fe,me=new n.Vector3,be=null,we=null,ve=new n.Vector2,ye=!0,Te=350,Ce=150,xe=14,Se=16,Re=1,Ne=30,Ie=15,Ve=10,Pe=20,De=.33*Ne,_e="255, 128, 0",Ee="115, 195, 225",Ue="130, 190, 220",ke="40, 90, 120",Ae="80, 80, 80",Oe="0,0,0",Ge=1,Be=0,Le=1,Fe=!1,We=te,He=te,Xe=new i,Ye=t.getViewer(),qe=t.getViewpoint(),ze=21.6,Ke=new l("rulerMainNode");Ke.setVisibilityInTree(!1),Ke.exludeFromBounding(!0),Ke._getExcludeFromCSO=function(){return!0},Ke.setNoZ(!0);let Ze,je,Je=new l("rulerGraduationNode"),$e=new l,Qe=new l,et=new l;et.setPickable(h.PICKTHROUGH);let tt,it,at,nt,rt,lt=new l("originArrowMNode"),ot=new l("originManipMNode"),st=null,ut=0,dt=new l,ht=new l,ct=new l,pt=new s({constraintAxis:new n.Vector3(0,1,0),type:"Cylindrical"}),gt=null,Mt=null,ft=60,mt=[],bt=[],wt=0,vt=0,yt=0,Tt=0,Ct=null,xt=null,St=null,Rt=0,Nt=0,It=null,Vt=!1,Pt=!1,Dt=!1,_t=!1,Et=!1,Ut=!0,kt=!1,At=!1,Ot=!1,Gt=!1,Bt=!1,Lt=!1,Ft=!1,Wt=!1,Ht=!1,Xt=!1,Yt=!1,qt=!1,zt=!1,Kt=null,Zt=window.widget&&window.widget.lang?window.widget.lang:void 0,jt=new Intl.NumberFormat(Zt).format(1.1).replaceAll("1",""),Jt=!1,$t=document.createElement("canvas"),Qt=document.createElement("canvas"),ei=document.createElement("canvas"),ti=document.createElement("canvas"),ii=document.createElement("canvas"),ai=document.createElement("canvas"),ni=document.createElement("canvas");ai.width=1,ai.height=1;let ri=ai.getContext("2d");ri.clearRect(0,0,ai.width,ai.height),ri.rect(0,0,ai.width,ai.height),ri.fillStyle="rgba(0,0,0,0)",ri.fill();let li=new n.Texture,oi=new n.Texture,si=new n.Texture,ui=new n.Texture;ui.image=ai,ui.needsUpdate=!0;let di=new n.Texture;const hi={};let ci,pi,gi,Mi;function fi(e){if(L.__performanceMeasures){for(let t=0;t<L.__performanceMeasures.measures.length;t++)if(L.__performanceMeasures.measures[t].id===e)return void(L.__performanceMeasures.measures[t].mark=(new Date).getTime());L.__performanceMeasures.measures.push({id:e,mark:(new Date).getTime(),cumulatedTime:0,nbCalls:0})}}function mi(e){if(L.__performanceMeasures)for(let t=0;t<L.__performanceMeasures.measures.length;t++)if(L.__performanceMeasures.measures[t].id===e)return L.__performanceMeasures.measures[t].cumulatedTime+=(new Date).getTime()-L.__performanceMeasures.measures[t].mark,void(L.__performanceMeasures.measures[t].nbCalls+=1)}function bi(){let e=Te*ce;return ne===O.SYMMETRIC&&(e+=2*Math.abs(we-(re||0))),e}function wi(e){e.setSSAO(!1),e.setShadow(!1,!1),e.setRenderDepth(1),e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.setFrustumCulled(!1)}function vi(e){return e<.15?0:e>=.15&&e<.4?.25:e>=.4&&e<.7?.55:e>=.7&&e<.9?.75:1}function yi(e,t,i,a,n){fi("_fillRect"),e.fillRect(t,i,a,n),mi("_fillRect")}function Ti(e,t){if(e){e.getMaterial()&&(e.getMaterial().map&&t&&e.getMaterial().map.dispose(),e.getMaterial().dispose());for(let i=e.children.length-1;i>=0;i--)Ti(e.children[i],t);e.removeChildren()}}function Ci(e,t){return Xe.publish({event:e,data:t,context:this})}function xi(e){if("@onPrimaryPointerMoveUniqueEvent"!==e.eventType){if(Vt)Vt=!1;else if(e&&!_t&&!Pt){let t=dt.children[0];if(!t&&L.getVisibleFlag()){let t=Ye.getMousePosition(e.from[0].getCurrentPosition(Ye.canvas));setTimeout((function(){let e=null;if((Gt||Bt)&&(e="ruler"),null===e){let i=Ye.pick(t,"primHybrid",!1);if(0!==i.path.length&&i.path[0]||(i=Ye.pick(t,"mesh",!1),0!==i.path.length&&i.path[0]||(e="")),null===e){let t=i.path[0];if(t&&t.externalPath)for(let i=0;i<t.externalPath.length;i++)"rulerMainNode"===t.externalPath[i].name&&(e="ruler")}}""===e&&oe&&L.clear()}),0)}else t&&t.validateEditor()}}else!e.from[0].currentPosition||isNaN(e.from[0].currentPosition.x)||isNaN(e.from[0].currentPosition.y)||(ve.x=e.from[0].currentPosition.x,ve.y=e.from[0].currentPosition.y)}function Si(){fi("_getRatio");let e,t=0;if(1===qe.getProjectionType())e=qe.camera.top-qe.camera.bottom;else{let t=qe.getAngle()*Math.PI/180,i=qe.getEyePosition(),a=(new n.Vector3).copy(be).multiplyScalar(L.value),r=(new n.Vector3).copy(me).add(a),l=(new n.Vector3).subVectors(r,i);e=2*Math.tan(.5*t)*l.length()}return t=e*(qe.camera.height&&qe.camera.fullHeight?qe.camera.height/qe.camera.fullHeight:1)/Ye.SCREEN_HEIGHT,mi("_getRatio"),t}function Ri(e){Ht=!1,Gt=!1,Bt=!1;let t=we,i=e?e.event?e.event:e.from[0].event:null;if(!Lt&&dt.children.length){let e=(dt.children[0].getInputValue()||"").replace(jt,".");if(!isNaN(e)&&e&&""!==e){let a=parseFloat(e)/j;Et=!0,L.setValue(a),Et=!1,Ci("RulerManipulate",{eventName:"RulerManipulate",translationVector:(new n.Vector3).copy(be).multiplyScalar(we-t),value:we,direction:be,rulerDragged:!1,event:i,fromEditor:!0})}}Ci("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:we,direction:be,status:"Validated",event:i}),pi()}function Ni(e){Ht=!1,Gt=!1,Bt=!1;let t=e?e.event?e.event:e.from[0].event:null;Ci("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:we,direction:be,status:"Cancelled",event:t}),pi()}function Ii(){return!be||Math.abs(be.dot(qe.getSightDirection()))>.95}function Vi(){if(fi("_initRulerParameters"),!Xt){if(!L.origin)return;if(me=(new n.Vector3).copy(L.origin),!L.direction)return;be=(new n.Vector3).copy(L.direction).normalize(),F=L.scale||1,L.initOrigin||(L.initOrigin=(new n.Vector3).copy(L.origin));let e=O.MM_UNIT;if(j=1,"number"==typeof L.unit||"string"==typeof L.unit)L.unit&O.NM_UNIT||"Nanometer"===L.unit?(e=O.NM_UNIT,j=Math.pow(10,6)):L.unit&O.MICRON_UNIT||"Micrometer"===L.unit?(e=O.MICRON_UNIT,j=Math.pow(10,3)):L.unit&O.CM_UNIT||"Centimeter"===L.unit?(e=O.CM_UNIT,j=Math.pow(10,-1)):L.unit&O.M_UNIT||"Meter"===L.unit?(e=O.M_UNIT,j=Math.pow(10,-3)):L.unit&O.HM_UNIT||"Hectometer"===L.unit?(e=O.HM_UNIT,j=Math.pow(10,-5)):L.unit&O.KM_UNIT||"Kilometer"===L.unit?(e=O.KM_UNIT,j=Math.pow(10,-6)):L.unit&O.INCH_UNIT||"Inch"===L.unit?(e=O.INCH_UNIT,j=1/25.4):L.unit&O.FOOT_UNIT||"Foot"===L.unit||"Feet,Inch,Fraction/64"===L.unit||"Feet,Inch,Fraction/16"===L.unit||"Feet,Inch,Decimal"===L.unit?(e=O.FOOT_UNIT,j=1/304.8):L.unit&O.YARD_UNIT||"Yard"===L.unit?(e=O.YARD_UNIT,j=1/914.4):L.unit&O.MILE_UNIT||"Mile"===L.unit?(e=O.MILE_UNIT,j=1/1609344):(L.unit&O.NMILE_UNIT||"NauticalMile"===L.unit)&&(e=O.NMILE_UNIT,j=1/1852e3);else if(window.widget&&window.widget.hasPreference&&window.widget.hasPreference("Length")){let t=window.widget.getValue("Length");if(t)switch(t){case"mm":e=O.MM_UNIT,j=1;break;case"cm":e=O.CM_UNIT,j=Math.pow(10,-1);break;case"m":e=O.M_UNIT,j=Math.pow(10,-3);break;case"km":e=O.KM_UNIT,j=Math.pow(10,-6);break;case"inch":e=O.INCH_UNIT,j=1/25.4;break;case"foot":e=O.FOOT_UNIT,j=1/304.8}}j*=F,ge=hi[e],Z="boolean"!=typeof L.displayUnit||L.displayUnit,H="number"==typeof L.offset&&!isNaN(L.offset)&&L.offset>=0?L.offset:0,X="number"==typeof L.worldOffset&&!isNaN(L.worldOffset)&&L.worldOffset>=0?L.worldOffset:0,Q="number"!=typeof L.startValue||isNaN(L.startValue)?void 0:L.startValue,ee="number"!=typeof L.endValue||isNaN(L.endValue)?void 0:L.endValue,void 0!==Q&&void 0!==ee&&ee<=Q&&(Q=void 0,ee=void 0),re="number"!=typeof L.originValue||isNaN(L.originValue)?0:L.originValue,void 0!==Q&&re<Q&&(re=Q),void 0!==ee&&re>ee&&(re=ee),te="number"==typeof L.mainGrad&&!isNaN(L.mainGrad)&&L.mainGrad>0?L.mainGrad:10,ie="number"==typeof L.nbSecondaryGrads&&!isNaN(L.nbSecondaryGrads)&&L.nbSecondaryGrads>=0?L.nbSecondaryGrads+1:10,Y="boolean"==typeof L.displayOrigin&&L.displayOrigin,q=L.originDisplay===O.ORIGIN_SYMMETRIC?L.originDisplay:O.ORIGIN_DEFAULT,z="boolean"!=typeof L.lockedOrigin||L.lockedOrigin,K="function"==typeof L.onOriginManipulator?L.onOriginManipulator:null,$="boolean"==typeof L.displayRulerDuringLocalTransfo&&L.displayRulerDuringLocalTransfo,J="boolean"==typeof L.lightDisplay&&L.lightDisplay,ae=L.graduationsDisplay===O.ORIENTED_GRADUATIONS?L.graduationsDisplay:O.DEFAULT_GRADUATIONS,ne=L.rulerDisplay===O.SYMMETRIC?L.rulerDisplay:O.DEFAULT,oe="boolean"!=typeof L.hideOnEmptySelection||L.hideOnEmptySelection,se=0,"number"==typeof L.nbDecimals&&(L.nbDecimals>=0&&L.nbDecimals<=9?se=L.nbDecimals:L.nbDecimals<0?se=0:L.nbDecimals>9&&(se=9)),Te=J?200:350;let t=ni.getContext("2d"),i=t.font.split(" "),a=J?"bold ":"900 ";if(t.font=a+Se+"pt "+i[i.length-1],pe=Z?Math.round(10*t.measureText(" "+ge).width)/10:0,ce=Si(),ce){Pt=!1,Dt=!1,At=!1,Ot=!1,Lt=!1,Ft=!1,Ht=!1,kt=!1,He=te,fi("_updateGraduationColors"),255*new n.Color(Ye.backgroundColor).getHSL().l>120?(Ae="80,80,80",Oe="0,0,0"):(Ae="220,220,220",Oe="240,240,240"),mi("_updateGraduationColors"),W=Math.max(X/ce,0),W+=H;let e=Math.floor(1.2*bi()/He),i=He,a=e,r=bi()/(Te*ce),l=3*r,o=15*r,s=function(e,t){let n=Math.floor(1.2*bi()/e);return n<o&&n>a&&(a=n,i=e),n>=l&&n<=o||n<l&&n<t?e:n>o&&n>t?i:n<l?s(e/ie,n):n>o?s(e*ie,n):e};He=s(He,e),We=He,e=Math.floor(1.2*bi()/He);let u=Math.round(L.value)+Math.round(e/2)*He*j,h=Math.round(L.value)-Math.round(e/2)*He*j;Be=Math.abs(u-h),de=(new n.Vector3).copy(be);let p=new n.Vector3(1,0,0);if(he=(new n.Vector3).crossVectors(p,de).normalize(),(de.angleTo(p)<.001||0===he.x&&0===he.y&&0===he.z)&&(p=new n.Vector3(0,0,1),he=(new n.Vector3).crossVectors(p,de).normalize()),ue=(new n.Vector3).crossVectors(de,he),qe.getSightDirection().angleTo(ue)<Math.PI/4||qe.getSightDirection().angleTo(ue)>3*Math.PI/4){let e=(new n.Vector3).copy(ue);ue.copy(he).negate(),he.copy(e)}he.dot(qe.getSightDirection())>0&&(ue.multiplyScalar(-1),he.multiplyScalar(-1)),Fe=de.dot(qe.getUpDirection())<0,Ge=-1,ce<1&&(Ge=-ce);let g=Be.toExponential(),M=g.toString().indexOf("e"),f=parseFloat(g.toString().substring(M+1));Le=1;for(let e=1;e>f;e--)Le*=10;ye=!0,Le>Math.pow(10,se)?ye=!1:Le=Math.pow(10,se);let m,b,w=Math.abs(Math.round(L.value*j*Le)/Le).toString(),v=Math.abs(Math.round(h*Le)/Le).toString(),y=Math.abs(Math.round(u*Le)/Le).toString(),T=Math.abs(Math.round(He/ie*Le)/Le).toString(),C="";(se>0||-1!==T.indexOf(".")||-1!==v.indexOf(".")||-1!==y.indexOf(".")||-1!==w.indexOf("."))&&(C+="."),(h<0||Math.round(L.value*j*Le)/Le<0)&&(C+="-");let x=v.split("."),S=y.split("."),R=w.split("."),N=T.split(".");m=Math.max(x[0].length,S[0].length),m=Math.max(m,R[0].length),ye?b=se:(b=void 0!==x[1]?x[1].length:0,void 0!==S[1]&&(b=Math.max(b,S[1].length)),void 0!==R[1]&&(b=Math.max(b,R[1].length)),void 0!==N[1]&&(b=Math.max(b,N[1].length)));let I=m+b;for(let e=0;e<I;e++)C+="A";let V=Math.round(10*t.measureText(C).width)/10,P=Ce;if(Ce=xe+Ne+pe+V,Ce!==P&&(bt.length=0),0===Rt){let e,t=null,i=null,a=null,n=function(){if(dt&&dt.children.length&&Ni(),null===a&&(a=Ut),$){null===t&&null===i&&(t=ce,i=ce);let e=Si();if(!e||Ii())Ke.setVisibility(!1);else if(e!==i){let t=!1;Math.abs((e-i)/i)>.1&&(t=!0),!t&&_t||(Yt=!0),pi(),t&&(i=ce)}else Ke.setVisibility(!0)}else!0===L.getVisibleFlag()&&L.setVisibleFlag(!1),_t||(e&&clearTimeout(e),e=setTimeout((function(){ci()}),200))};ci=function(){if(_t=!1,$)a&&pi();else if(a){L.setVisibleFlag(!0);let e=Si();!e||Ii()?Ke.setVisibility(!1):e!==t?pi():Ke.setVisibility(!0),t=null}a=null},Rt=c.subscribe({event:"/VISU/"},(function(t){"@onViewpointBeginMove"===t.eventType?(_t=!0,e&&clearTimeout(e)):"@onViewpointChange"===t.eventType?n():"@onViewpointEndMove"===t.eventType&&ci()})),wt=Ye.onBackgroundModify((function(){L.getVisibleFlag()&&pi()})),d.addEvent(Ye.canvas,"onPrimaryPointerClick",xi),d.addEvent(Ye.canvas,"onPrimaryPointerMoveUnique",xi)}Xt=!0}}mi("_initRulerParameters")}function Pi(e,t,i){let a=e;return ae===O.ORIENTED_GRADUATIONS&&a<0&&(a*=-1),i||(a*=j),t?a:Math.round(a*Le)/Le}function Di(e,t,i){fi("_drawTextCanvas");let a=i||{},n=a.isCurrentValue||!1,r=a.onManipulatorPreactivated||!1,l=n&&Pt?1:2,o=Se*l*(n?1.1:1);t.height=2*o,t.width=(Ce-Ne)*l;let s,u=t.getContext("2d");u.globalAlpha=a.alpha,u.clearRect(0,0,t.width,t.height),!Fe||n&&Pt&&qt&&zt?u.translate(10*l,t.height-10*l):(u.rotate(Math.PI),u.textAlign="right",u.translate(-10*l,-10*l)),s=n?At||Ot?"rgba("+_e+",1)":Ht?"rgba("+ke+",1)":r?"rgba("+Ue+",1)":"rgba("+Oe+", 1)":"rgba("+Ae+",1)";let d=Pi(e).toString().replace(".",jt);Z&&n&&(d=d+" "+ge);let h=u.font.split(" "),c=J?"bold ":"900 ";return u.font=c+o+"pt "+h[h.length-1],n&&(At||Ht&&"220,220,220"===Ae&&!Ot)&&(u.shadowColor="white",u.shadowBlur=3*l),u.fillStyle=s,u.fillText(d,0,0),t.textDisplayed=d,mi("_drawTextCanvas"),t}function _i(){let e=Ye.currentViewpoint.create3DRayFrom2DPoint(ve),t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(be).multiplyScalar(we).add(t),a=(new n.Vector3).copy(me).add(i),r=(new n.Matrix4).multiplyMatrices(Ke.getMatrix(),pt.getMatrix().rotateX(.5*Math.PI)).elements,l=new n.Vector3(r[8],r[9],r[10]),o=(new n.Plane).setFromNormalAndCoplanarPoint(l,a);return e.intersectPlane(o)}function Ei(){if(!z){let e=!0===Ft?k:Bt?A:U;at.setStyle("backgroundImage",'url("'+e+'")'),Ft||Bt||!me.equals(L.initOrigin)?at.setOpacity(1):at.setOpacity(.5),Ye.render()}Y&&function(){let e,t,i;if(!Y)return;J?(t=D,e=P,i=_):(t=we>=re?R:V,e=we>=re?x:N,i=we>=re?S:I);let a=!0===Ft?i:Bt?t:e;tt.getMaterial().map!==a&&(tt.getMaterial().map=a),Ye.render()}()}function Ui(){let e,t,i;J?(t=D,e=P,i=_):(t=we<re&&Y?T:Y?w:f,e=we<re&&Y?y:Y?b:M,i=we<re&&Y?C:Y?v:m);let a=!0===Lt?i:Wt?t:e;Ze.getMaterial().map!==a&&(Ze.getMaterial().map=a),Ye.render()}function ki(){if(Pt)return;let e=Math.round(we*Le)/Le;oi.dispose(),oi.image=Di(e,ei,{isCurrentValue:!0,onManipulatorPreactivated:!0,alpha:1}),oi.needsUpdate=!0,rt.setRatio(1.05),Gt=!0,Ye.setTemporaryCursor("pointer"),Ye.render()}function Ai(){if(Pt)return void(Gt=!1);let e=Math.round(we*Le)/Le;oi.dispose(),oi.image=Di(e,ei,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1}),oi.needsUpdate=!0,rt.setRatio(1),Gt=!1,Ye.unsetTemporaryCursor(),Ye.render()}function Oi(e){fi("_entireManipulationMeasure"),qt=e&&e.event&&e.event.from&&e.event.from.length&&"Touch"===e.event.from[0].type,gt=new n.Vector3(0,0,0),L.initValue=we,Pt=!0,Ye.setTemporaryCursor("-webkit-grabbing",10),Ci("RulerManipulateBegin",{eventName:"RulerManipulateBegin",value:we,direction:be,event:e.event})}function Gi(e){!z&&le&&(Ke.removeChild(le),le=null),fi("_manipulateCB");let t=L.getSnappedTranslationVector(e),i=t.snappedTranslationVector;if(0!==t.returnCode||(At||Ot)&&i.x===e.translationVector.x&&i.y===e.translationVector.y&&i.z===e.translationVector.z)return;let a=(new n.Vector3).copy(i).sub(gt),r=a.dot(be),l=a.length();r<0&&(l*=-1);let o=we;L.setValue(we+l),we!==o+l&&a.setLength(we-o),gt.add(a),a.length()&&(Ye.render(),Ci("RulerManipulate",{eventName:"RulerManipulate",translationVector:a,value:we,direction:be,rulerDragged:!0,event:e.event})),mi("_manipulateCB")}function Bi(e,t){At=!1,Ot=!1,Pt=!1,qt=!1,Ye.unsetTemporaryCursor(),Ye.render(),t||!1||pi(),Ci("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:we,direction:be,status:"Validated",event:e.event}),mi("_entireManipulationMeasure")}function Li(e){fi("_entireOriginManipulationMeasure"),qt=e&&e.event&&e.event.from&&e.event.from.length&&"Touch"===e.event.from[0].type,Mt=new n.Vector3(0,0,0),Pt=!0,Dt=!0,Ft=!0,Ke.setPickable(h.PICKTHROUGH),ot.setPickable(h.PICKTHROUGH),it.setPickable(h.PICKTHROUGH),Kt=new n.Line3(me,(new n.Vector3).copy(me).add(be)),Ye.setTemporaryCursor("-webkit-grabbing",10),Ci("OriginManipulateBegin",{eventName:"OriginManipulateBegin",origin:me,value:we,direction:be,event:e.event})}function Fi(e){let t=null;if(!z&&le&&(Ke.removeChild(le),le=null),K){let i=null,a=K(e);if(function(){if(fi("refreshOrigin"),L.displayOrigin!==Y){Y=L.displayOrigin;for(let e=0;e<mt.length;e++)mt[e].manipulator&&0!==mt[e].token&&mt[e].manipulator.unlink(mt[e].token),Ti(mt[e].manipNode,!1),mt[e].texture.dispose();mt.splice(0,mt.length),Ti(Ke,!1),Ye.removeNode(Ke),Mi(),L.setValue(L.value)}mi("refreshOrigin")}(),a){i=Kt.closestPointToPoint(a,!1),t=i.sub(me),Mt=new n.Vector3,L.origin3DPos=(new n.Vector3).copy(a);let e=(new n.Vector3).copy(_i()),r=(new n.Matrix4).getInverse(ot.getParents()[0].getMatrixWorld()).multiply((new n.Matrix4).setPosition(e));ot.setMatrix(r)}}if(t){let i=(new n.Vector3).copy(t).sub(Mt),a=i.length();if(0!==a){me.add(i),L.origin=(new n.Vector3).copy(me),i.dot(be)>0&&(a*=-1),L.setValue(we+a),Mt.add(i),Ci("OriginManipulate",{eventName:"OriginManipulate",origin:me,translationVector:i,value:we,direction:be,rulerDragged:!0,event:e.event})}Ye.render(),mi("_manipulateOriginCB")}}function Wi(e){At=!1,Ot=!1,Pt=!1,Ft=!1,qt=!1,Kt=null,Ke.setPickable(h.PICKABLE),ot.setPickable(h.PICKABLE),it.setPickable(h.PICKABLE),Ye.unsetTemporaryCursor(),Ye.render(),pi(),Dt=!1,Ci("OriginManipulateEnd",{eventName:"OriginManipulateEnd",value:me,direction:be,status:"Validated",event:e.event}),mi("_entireOriginManipulationMeasure")}function Hi(){Bt=!0,Ye.setTemporaryCursor("pointer"),Ei()}function Xi(){Bt=!1,Pt||(Ye.unsetTemporaryCursor(),Ei())}function Yi(e){let t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(me).add(t);e.event.from[0].currentPosition.x&&(ve.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(ve.y=e.event.from[0].currentPosition.y);let a=(new n.Vector3).copy(_i()).sub(i),r=we,l=a.dot(de);if(Y){let e=(Ie/2+2*Re)*ce;l>=0?l-=e/2:l+=e/2}let o=Y?(Ie/2+2*Re)*ce:(Ie+2*Re)*ce;if(Math.abs(r-l)>=o){let t=We/ie;l=Math.round(l/t)*t,L.setValue(l),Oi(e),Ci("RulerManipulate",{eventName:"RulerManipulate",translationVector:(new n.Vector3).copy(be).setLength(we-r),value:we,direction:be,rulerDragged:!1,event:e.event})}else Oi(e);Lt=!0}function qi(e){if(Pt)return void(Gt=!1);Gt=!0;let t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(me).add(t);e.event.from[0].currentPosition.x&&(ve.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(ve.y=e.event.from[0].currentPosition.y);let a=(new n.Vector3).copy(_i()).sub(i),r=we,l=a.dot(de);if(Y){let e=(Ie/2+2*Re)*ce;l>=0?l-=e/2:l+=e/2}let o=Y?(Ie/2+2*Re)*ce:(Ie+2*Re)*ce;Wt=Math.abs(r-l)<o,Ye.setTemporaryCursor("pointer"),Ui()}function zi(){Gt=!1,Wt=!1,Pt||(Ye.unsetTemporaryCursor(),Ui())}function Ki(e){let t=we;Pt=!0,L.setValue(e.value),Pt=!1;let i=(new n.Vector3).copy(be).multiplyScalar(we-t);Gt=!1,Bt=!1,Ye.render(),Ci("RulerManipulateBegin",{eventName:"RulerManipulateBegin",value:we,direction:be,event:e.event}),Ci("RulerManipulate",{eventName:"RulerManipulate",translationVector:i,value:we,direction:be,rulerDragged:!1,event:e.event}),Ci("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:we,direction:be,status:"Validated",event:e.event})}function Zi(e){if(Pt)return void(Gt=!1);Gt=!0;let t=e.node;t&&(t.setRatio(1.05),Ye.setTemporaryCursor("pointer"),Ye.render())}function ji(e){if(Pt)return;Gt=!1;let t=e.node;t&&(t.setRatio(1),Ye.unsetTemporaryCursor(),Ye.render())}function Ji(e,t,i){fi("_createGraduationNode");let a,s=null,d=null,h=i.alpha,c=i.color,p=!1,g=Pi(e,!1,!0);for(a=0;a<mt.length;a++)if(!1===mt[a].toDispose&&mt[a].associatedValue===e&&mt[a].associatedAlpha===h){d=mt[a],p=!0;break}let M=t;if(!d){for(a=0;a<mt.length;a++)if(!0===mt[a].toDispose){d=mt[a],d.manipulator.associatedValue=e,d.texture.dispose();break}if(!d){d={};let t=r.createRectangleNode({width:Ce-Ne,height:2*Se,fill:!0,noEdge:!0});wi(t);let i=new u({ratio:1});i.name="textNode",i.addChild(t),d.texture=new n.Texture;let a=new n.MeshBasicMaterial({map:d.texture,transparent:!0,enableClipPlanes:!1});if(a.force=!0,a.depthTest=!1,i.setMaterial(a),!M){let e=i.getBoundingBox();M=Math.abs(e.max.y-e.max.x)}i.setMatrix((new n.Matrix4).makeTranslation(0,M/2-ce*Se,0));let s=r.createRectangleNode({width:(Ce-Ne)*ce,height:M,fill:!0,noEdge:!0});wi(s),a=new n.MeshBasicMaterial({map:ui,transparent:!0,enableClipPlanes:!1}),a.force=!0,a.depthTest=!1,s.setMaterial(a);let h=new o({viewer:Ye,value:e,linkedNode:i});d.manipulator=h,h.subscribe("Click",Ki),h.subscribe("BeginManipulate",null),h.subscribe("Manipulate",null),h.subscribe("EndManipulate",null),h.subscribe("BeginPreactivate",Zi),h.subscribe("EndPreactivate",ji),d.manipNode=new l,d.manipNode.addChild(s),d.manipNode.addChild(i),d.token=h.linkToNode(d.manipNode),mt.push(d)}d.associatedValue=e,d.associatedAlpha=h,d.ratio=ce}if(!p){for(a=0;a<bt.length;a++)if(!1===bt[a].toDispose&&bt[a].associatedValue===g&&bt[a].associatedAlpha===h&&bt[a].associatedColor===c&&bt[a].reverse===Fe){s=bt[a];break}if(!s){if(bt.length===ft){for(a=0;a<bt.length;a++)if(!0===bt[a].toDispose){s=bt[a];break}}else s={canvas:document.createElement("canvas")},bt.push(s);s.canvas=Di(e,s.canvas,i),s.associatedValue=g,s.associatedAlpha=h,s.associatedColor=c,s.reverse=Fe}d.texture.image=s.canvas,d.texture.needsUpdate=!0,s.toDispose=!1}if(!M){let e=d.manipNode.getChildByName("textNode").getBoundingBox();M=Math.abs(e.max.y-e.max.x)}d.toDispose=!1;let f=we-.5*Te*ce,m=(new n.Matrix4).makeTranslation((Ne+Ve+xe)*ce,Ge,e-f-M/2);d.manipNode.setMatrix(m.rotateX(.5*Math.PI)),Je.addChild(d.manipNode),mi("_createGraduationNode")}function $i(e){if(Pt=!1,!dt.children.length){let i=Pi(we,!0),r=Le;r<1?r/=se>0?10:1e3:r*=se>0?10:1e3;let l=new a({value:Math.round(i*r)/r,okCB:Ri,cancelCB:Ni,startValue:Q*j,endValue:ee*j,frmWindow:t});new o({viewer:Ye}).linkToNode(l),dt.addChild(l),e.event.from[0].currentPosition.x&&(ve.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(ve.y=e.event.from[0].currentPosition.y);let s=_i(),u=(new n.Matrix4).makeTranslation(s.x,s.y,s.z),d=(new n.Matrix4).getInverse(Ke.getMatrix());dt.setMatrix(d.multiply(u));let h=-30,c=-30,p=155,g=30;s=e.event.from[0].currentPosition,s.x+h<0?h=-1*s.x+15:s.x+h+p>Ye.SCREEN_WIDTH&&Ye.SCREEN_WIDTH>p&&(h=h+-1*(s.x+h+p-Ye.SCREEN_WIDTH)-15),s.y+c<0?c=-1*s.y+15:s.y+c+g>Ye.SCREEN_HEIGHT&&Ye.SCREEN_HEIGHT>g&&(c=c+-1*(s.y+c+g-Ye.SCREEN_HEIGHT)-15),l.setOffset(new n.Vector2(h,c)),Vt=!0,setTimeout((function(){$e.setVisibility(!1),Ye.render()}),0)}}function Qi(e){pt.removeChild(fe),fe=r.createRectangleNode({width:(Ne+xe)*ce,height:bi(),fill:!0,noEdge:!0}),wi(fe),fe.setRenderDepth(-1);let t=new n.MeshBasicMaterial({map:li,transparent:!0,enableClipPlanes:!1});t.force=!0,t.depthTest=!1,fe.setMaterial(t),fe.setMatrix((new n.Matrix4).makeTranslation(0,-1.9*Ge,e).rotateX(.5*Math.PI)),pt.addChild(fe)}function ea(e){Me&&pt.removeChild(Me),Me=r.createRectangleNode({width:Ce*ce,height:bi(),fill:!0,noEdge:!0}),wi(Me),Me.setRenderDepth(-1);let t=new n.MeshBasicMaterial({map:si,transparent:!0,enableClipPlanes:!1});t.force=!0,t.depthTest=!1,Me.setMaterial(t),Me.setMatrix((new n.Matrix4).makeTranslation(0,-2*Ge,e).rotateX(.5*Math.PI)),pt.addChild(Me)}function ta(){if(fi("_internalRefresh"),Xt){if(L.value!==we){we=L.value;let e=0;ne===O.SYMMETRIC&&(re?we>re&&(e=2*(re-we)):we>0&&(e=-2*we));let t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(be).multiplyScalar(we-.5*Te*ce).add(t),a=(new n.Vector3).copy(me).add(i);if(Ke.setMatrix(Ke.getMatrix().setPosition(a)),W<1.5*Ye.SCREEN_WIDTH||W<1.5*Ye.SCREEN_HEIGHT){dt.removeChildren(),Je.removeChildren();let t=null;if((Yt||ne===O.SYMMETRIC)&&(si.dispose(),si.image=function(){fi("_generateMainCanvas");let e=Math.round(we*Le)/Le,t=Qt;t.width=Ce,t.height=bi()/ce;let i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);let a,n,r,l=.7,o=re||0,s=(ne===O.SYMMETRIC?o:e)-.5*t.height*ce,u=(ne===O.SYMMETRIC?o:e)+.5*t.height*ce;if(J)a=Ae,n=i.createLinearGradient(0,0,0,t.height),l=.5,n.addColorStop(0,"rgba("+a+",0)"),n.addColorStop(.15,"rgba("+a+","+l+")"),n.addColorStop(.85,"rgba("+a+","+l+")"),n.addColorStop(1,"rgba("+a+",0)"),i.fillStyle=n,yi(i,0,0,Re,t.height),l=.7,Ot&&(Y||(e>o?s>o?(r=i.createLinearGradient(xe,.5*t.height,xe,t.height),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,0,.5*t.height,Re,.5*t.height)):(r=i.createLinearGradient(xe,.5*t.height,xe,t.height-Math.abs(s)/ce),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,0,.5*t.height,Re,.5*t.height-Math.abs(s)/ce)):e<o&&(u<0?(r=i.createLinearGradient(xe,0,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,0,0,Re,.5*t.height)):(r=i.createLinearGradient(xe,u/ce,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,0,u/ce,Re,.5*t.height-u/ce)))));else{a="255, 255, 255",n=i.createLinearGradient(0,0,0,t.height),n.addColorStop(0,"rgba("+a+",0)"),n.addColorStop(.2,"rgba("+a+",0.4)"),n.addColorStop(.8,"rgba("+a+",0.4)"),n.addColorStop(1,"rgba("+a+",0)"),i.fillStyle=n,yi(i,xe-2*Re,0,Ne+4*Re,t.height),n=i.createLinearGradient(0,0,0,t.height),n.addColorStop(0,"rgba("+a+",0)"),n.addColorStop(.15,"rgba("+a+",0.8)"),n.addColorStop(.85,"rgba("+a+",0.8)"),n.addColorStop(1,"rgba("+a+",0)"),i.fillStyle=n,yi(i,xe-2*Re,0,3*Re,t.height),yi(i,xe+Ne,0,3*Re,t.height);let d=.05*t.height;!Y&&Ot?e>o?ne===O.SYMMETRIC?(r=i.createLinearGradient(xe,.5*t.height-Math.abs(e-o)/ce,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height-Math.abs(e-o)/ce,Ne,Math.abs(e-o)/ce)):s>o?(r=i.createLinearGradient(xe,.5*t.height,xe,t.height),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,Ne,.5*t.height)):(r=i.createLinearGradient(xe,.5*t.height,xe,t.height-Math.abs(o-s)/ce),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,Ne,.5*t.height-Math.abs(o-s)/ce)):e<o?ne===O.SYMMETRIC?(r=i.createLinearGradient(xe,.5*t.height+Math.abs(o-e)/ce,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,Ne,Math.abs(o-e)/ce)):u<o?(r=i.createLinearGradient(xe,0,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,xe,0,Ne,.5*t.height)):(r=i.createLinearGradient(xe,Math.abs(u-o)/ce,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,xe,Math.abs(u-o)/ce,Ne,.5*t.height-Math.abs(u-o)/ce)):(r=i.createLinearGradient(xe,.5*t.height,xe,.5*t.height+d),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,Ne,d),r=i.createLinearGradient(xe,.5*t.height-d,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,xe,.5*t.height-d,Ne,d)):!Y&&At&&(e>o?ne===O.SYMMETRIC?(r=i.createLinearGradient(xe,.5*t.height-Math.abs(e-o)/ce,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height-Math.abs(e-o)/ce,t.width-xe,Math.abs(e-o)/ce)):s>o?(r=i.createLinearGradient(xe,.5*t.height,xe,t.height),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,t.width-xe,.5*t.height)):(r=i.createLinearGradient(xe,.5*t.height,xe,t.height-Math.abs(o-s)/ce),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,t.width-xe,.5*t.height-Math.abs(o-s)/ce)):e<o?ne===O.SYMMETRIC?(r=i.createLinearGradient(xe,.5*t.height+Math.abs(o-e)/ce,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,t.width-xe,Math.abs(o-e)/ce)):u<o?(r=i.createLinearGradient(xe,0,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,xe,0,t.width-xe,.5*t.height)):(r=i.createLinearGradient(xe,Math.abs(u-o)/ce,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,xe,Math.abs(u-o)/ce,t.width-xe,.5*t.height-Math.abs(u-o)/ce)):(r=i.createLinearGradient(xe,.5*t.height,xe,.5*t.height+d),r.addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,yi(i,xe,.5*t.height,t.width-xe,d),r=i.createLinearGradient(xe,.5*t.height-d,xe,.5*t.height),r.addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,yi(i,xe,.5*t.height-d,t.width-xe,d)))}return mi("_generateMainCanvas"),t}(),si.needsUpdate=!0,ne===O.SYMMETRIC&&ea(e)),Yt=!1,J||(li.dispose(),li.image=function(){fi("_generateGraduations");let e=Pt||_t?1:2,t=$t;t.width=Math.round(e*(Ne+xe));let i=bi()/ce;t.height=Math.round(e*i);let a=t.getContext("2d");a.clearRect(0,0,t.width,t.height);let n=ce/e,r=Math.floor(t.height*n*1.2/He);r++;let l=ne===O.SYMMETRIC?null:r>=7?Math.floor(r/2)-1:r-1,o=bi()/(Te*ce),s=we;ne===O.SYMMETRIC&&(s=re||0);let u=s-.5*t.height*n,d=ne===O.SYMMETRIC?t.height-(we-u)/n:.5*t.height,h=He;r>=7*o&&(h=2*He),h*=Le,u=(Math.floor(u/He)*He).valueOf(),a.textBaseline="middle";let c,p,g,M,f,m,b=2*Ie*e,w=1,v=1,y=!1,T=[],C=[],x=[];for(p=0;p<=r;p++)if(f=.5*t.height+(s-p*He-u)/n,f>0&&f<t.height){w=f<b?f/b:f>t.height-b?(t.height-f)/b:1,y=!1,Math.abs(f-d)<b?(v=Math.max(Math.abs(f-d)/b*2-1,0),y=!0):(v=w,y=!1);let i=Math.round((p*He+u)*Le)/Le,a=i*Le%h==0;a&&(c=Math.round(10*Math.max(v-.2,0))/10,(c<.1||y&&!kt&&c<.8)&&(c=0),0!==c&&(c=vi(c+.1),(void 0!==Q&&i<Q||void 0!==ee&&i>ee)&&(c=0),0!==c&&T.push({val:i,alpha:c,nearCurrentValue:y}))),void 0!==Q&&i<Q||void 0!==ee&&i>ee||(c=Math.round(10*Math.max(v-.2,0))/10,0!==c&&(c=vi(c+.1),0!==c&&(m={moveTo:{x:Math.round(e*xe),y:Math.round(f)},alpha:c,lineWidth:Re*e*2},m.lineTo=a?{x:Math.round(e*(Ne+xe)),y:Math.round(f)}:{x:Math.round(e*(xe+.75*Ne)),y:Math.round(f)},C.push(m),-1===x.indexOf(c)&&x.push(c))))}for(p=0;p<=r;p++)for(g=1;g<ie;g++){let i=Math.round(((p-g*(1/ie))*He+u)*Le)/Le;if(!(void 0!==Q&&i<Q||void 0!==ee&&i>ee)){f=.5*t.height+(s-(p-g*(1/ie))*He-u)/n,w=f<b?f/b:f>t.height-b?(t.height-f)/b:1;let i=Math.abs(f-d)<b?Math.max(Math.abs(f-d)/b*2-1,0):w;i=vi(i),0!==i&&(m={moveTo:{x:Math.round(e*xe),y:Math.round(f)},alpha:i,lineWidth:Re*e},m.lineTo={x:Math.round(e*(De+xe)),y:Math.round(f)},C.push(m),-1===x.indexOf(i)&&x.push(i))}}let S=[Re*e*2,Re*e];for(M=0;M<S.length;M++)for(p=0;p<x.length;p++){for(a.beginPath(),a.lineWidth=S[M],a.strokeStyle=0===M&&At||1===M&&Ot?"rgba("+_e+","+x[p]+")":"rgba(0,0,0,"+x[p]+")",g=0;g<C.length;g++)C[g].alpha===x[p]&&C[g].lineWidth===S[M]&&(a.moveTo(C[g].moveTo.x,C[g].moveTo.y),a.lineTo(C[g].lineTo.x,C[g].lineTo.y));R=a,fi("_stroke"),R.stroke(),mi("_stroke")}var R;if(!_t&&q!==O.ORIGIN_SYMMETRIC){for(p=0;p<mt.length;p++)mt[p].toDispose=!0;for(p=0;p<bt.length;p++)bt[p].toDispose=!0;for(p=0;p<T.length;p++){let e=Pi(T[p].val);for(g=0;g<mt.length;g++)mt[g].associatedValue===T[p].val&&mt[g].associatedAlpha===T[p].alpha&&Math.abs(mt[g].ratio-ce)/mt[g].ratio<.2&&(mt[g].toDispose=!1);for(g=0;g<bt.length;g++)bt[g].associatedValue===e&&bt[g].associatedAlpha===T[p].alpha&&bt[g].associatedColor===Ae&&bt[g].reverse===Fe&&(bt[g].toDispose=!1)}for(p=0;p<T.length;p++)Ji(T[p].val,l?Te*ce/l:null,{alpha:T[p].alpha,reverse:Fe,nearCurrentValue:T[p].nearCurrentValue,color:Ae})}return mi("_generateGraduations"),t}(),li.needsUpdate=!0,ne===O.SYMMETRIC&&Qi(e)),!_t){oi.dispose(),oi.image=Di(we,ei,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1}),oi.needsUpdate=!0;let e=we-.5*Te*ce,i=1.2*Se*2,a=J?Ve*ce:(Ne+Ve+xe)*ce;t=(new n.Matrix4).makeTranslation(a,0,we-e-ce*i/2),$e.setMatrix(t.rotateX(.5*Math.PI)),Ct.magnitude=Be/j,st&&(st.magnitude=Be/j)}let i,a,l=0;l=J?Pe*ce:Y?(Ie/2+2*Re)*ce:(Ie+Re)*ce,J?(i=P,a=_):(i=we<re&&Y?y:Y?b:M,a=we<re&&Y?C:Y?v:m);let o=!0===Lt?a:i;Ze.getMaterial().map!==o&&(Ze.getMaterial().map=o),t=new n.Matrix4,J?(t.makeTranslation(0,0,Te/2*ce),Qe.setMatrix(t.rotateX(.5*Math.PI))):(Y?we>=re?t.makeTranslation(0,-1.5*Ge,Te/2*ce):t.makeTranslation(0,-1.5*Ge,Te/2*ce-l):t.makeTranslation(0,-1.5*Ge,Te/2*ce-l/2),Qe.setMatrix(t.rotateX(.5*Math.PI))),St.magnitude=Be/j,xt.magnitude=Be/j;let s=Te*ce;if((Ot||At)&&(s=20*Te*ce),t=J?(new n.Matrix4).makeTranslation(-Ne/4*ce,0,e+(Te*ce-s)/2):(new n.Matrix4).makeTranslation(xe*ce,-Ge,e+(Te*ce-s)/2),nt.setMatrix(t.rotateX(.5*Math.PI).multiply((new n.Matrix4).makeScale(1,bi()/nt.originalLength,1))),Y||!z){et.removeChildren();let e,i,a=null;i=J?2*Re*ce:At?Ce*ce:Ne*ce,e=we!==re?(q===O.ORIGIN_SYMMETRIC?2*Math.abs(we-re):Math.abs(we-re))+ce:.1*Te*ce,e>0&&(a=r.createRectangleNode({width:i,height:e,fill:!0,noEdge:!0}),wi(a),a.setRenderDepth(0),et.addChild(a),di.dispose(),di.image=function(){fi("_generateOriginTexture");let e=Ee;(At||Ot)&&(e=_e);let t=ii.getContext("2d");t.clearRect(0,0,ii.width,ii.height),ii.width=J?3*Re:At?Ne:Ce-xe;let i,a=Math.round(we*Le)/Le;return a!==re?(ii.height=(a-re)/ce,i=t.createLinearGradient(0,0,0,ii.height),a>re?(i.addColorStop(0,"rgba("+e+",0.7)"),i.addColorStop(1,"rgba("+e+",0)")):(i.addColorStop(0,"rgba("+e+",0)"),i.addColorStop(1,"rgba("+e+",0.7)")),t.fillStyle=i,yi(t,0,0,ii.width,ii.height)):J||(ii.height=.1*Te,i=t.createLinearGradient(0,0,0,ii.height),i.addColorStop(0,"rgba("+e+",0)"),i.addColorStop(.5,"rgba("+e+",0.7)"),i.addColorStop(1,"rgba("+e+",0)"),t.fillStyle=i,yi(t,0,0,ii.width,ii.height)),mi("_generateOriginTexture"),ii}(),di.needsUpdate=!0),t=new n.Matrix4;let o=(q===O.ORIGIN_SYMMETRIC?2*we:we)-.5*Te*ce,s=q===O.ORIGIN_SYMMETRIC?2*re:re;we<re?t.makeTranslation(J?-Re*ce:xe*ce,0,.5*Te*ce):we>re?t.makeTranslation(J?-Re*ce:xe*ce,0,-o+s):t.makeTranslation(J?-Re*ce:xe*ce,0,.45*Te*ce),et.setMatrix(t.rotateX(.5*Math.PI));let u=!0;if(q!==O.ORIGIN_SYMMETRIC)for(let e=0;e<mt.length;e++)mt[e].associatedValue===re&&(u=!1);if(J)o=(q===O.ORIGIN_SYMMETRIC?2*we:we)-Te/2*ce,t=(new n.Matrix4).makeTranslation(0,0,-o+s);else{if(o=(q===O.ORIGIN_SYMMETRIC?2*we:we)-.5*Te*ce,q===O.ORIGIN_SYMMETRIC||u&&!(we+.15*Be>re&&we-.15*Be<re)){let e=Math.floor(Te*ce*1.2/He),i=e>=7?Math.floor(e/2):e,a=Te*ce/i;t=(new n.Matrix4).makeTranslation((Ne+Ve+xe)*ce,Ge,-o-a/2+s),ct.setMatrix(t.rotateX(.5*Math.PI)),ct.setVisibility(!0)}else ct.setVisibility(!1);Ei(),t=(new n.Matrix4).makeTranslation(0,0,we>=re?-o-l+ce+s:-o+s)}if(Y&&lt.setMatrix(t.rotateX(.5*Math.PI)),!z)if(L.displayOrigin&&L.origin3DPos){let e=(new n.Matrix4).getInverse(ot.getParents()[0].getMatrixWorld()).multiply((new n.Matrix4).setPosition(L.origin3DPos));ot.setMatrix(e)}else ot.setMatrix((new n.Matrix4).setPosition(new n.Vector3(0,Te/2*ce,0)))}if(Pt&&qt&&zt){if($e.setVisibility(!1),!ht.children.length&&oi){let e=new p({html:oi.image});ht.setMatrix((new n.Matrix4).makeTranslation(0,0,Te/2*ce)),ht.addChild(e)}let e=-oi.image.getContext("2d").measureText(oi.image.textDisplayed).width/2;e+=J?-(Ne/4+2*Re):Ne/2+xe/2-4*Re,ht.children[0].setOffset(new n.Vector2(e,-85))}else $e.setVisibility(!0),ht.removeChildren();kt=!0,Gt=!1,Bt=!1}if(W>0&&Y&&(je.setMatrix((new n.Matrix4).makeTranslation(0,Te/2*ce-we+re,0)),function(){if(!z&&!Dt&&L.origin3DPos&&!L.origin.equals(L.initOrigin)){le&&Ke.removeChild(le);let e=(new n.Matrix4).getInverse(Ke.getMatrixWorld()),t=we?Te/2*ce-we+re:0,i=e.multiply((new n.Matrix4).setPosition(L.origin3DPos)),a=new n.Vector3(-ce*W,t,0),l=(new n.Vector3).getPositionFromMatrix(i);le=r.createLineNode({points:[a,l]}),wi(le);let o=new n.LineBasicMaterial({color:"80,80,80"===Ae?0:16777215,opacity:.5,dashPattern:[3,2],scale:3});o.force=!0,o.depthTest=!1,le.setMaterial(o),Ke.addChild(le);let s=r.createSphereNode({matrix:(new n.Matrix4).setPosition(l),radius:.3,fill:!0});wi(s),le.addChild(s)}}(),L.origin3DPos)){let e=(new n.Matrix4).getInverse(ot.getParents()[0].getMatrixWorld()).multiply((new n.Matrix4).setPosition(L.origin3DPos));ot.setMatrix(e)}Ye.render()}mi("_internalRefresh")}else pi()}hi[O.NM_UNIT]=g.nmLbl,hi[O.MICRON_UNIT]=g.micronLbl,hi[O.MM_UNIT]=g.mmLbl,hi[O.CM_UNIT]=g.cmLbl,hi[O.M_UNIT]=g.mLbl,hi[O.HM_UNIT]=g.hmLbl,hi[O.KM_UNIT]=g.kmLbl,hi[O.INCH_UNIT]=g.inLbl,hi[O.FOOT_UNIT]=g.ftbl,hi[O.YARD_UNIT]=g.yardLbl,hi[O.MILE_UNIT]=g.mileLbl,hi[O.NMILE_UNIT]=g.nmiLbl,gi=function(){if(fi("_internalClear"),Xt){for(let e=0;e<mt.length;e++)mt[e].manipulator&&0!==mt[e].token&&mt[e].manipulator.unlink(mt[e].token),Ti(mt[e].manipNode,!1),mt[e].texture.dispose();mt.splice(0,mt.length),0!==Nt&&It.unlink(Nt),0!==ut&&st.unlink(ut),0!==vt&&Ct.unlink(vt),0!==Tt&&xt.unlink(Tt),0!==yt&&St.unlink(yt),yt=0,vt=0,Tt=0,Nt=0,ut=0,It=null,st=null,at&&at.destroy(),at=null,Ct=null,xt=null,St=null,Ti(Ke,!1),Ye.removeNode(Ke),0===Rt||_t||(c.unsubscribe(Rt),Ye.unsubscribe(wt),d.removeEvent(Ye.canvas,"onPrimaryPointerClick",xi),d.removeEvent(Ye.canvas,"onPrimaryPointerMoveUnique",xi),Rt=0),Xt=!1,we=null}mi("_internalClear")},pi=function(){Jt?Jt=!1:(fi("_internalDisplay"),gi(),Vi(),Mi(),L.setValue(L.value),mi("_internalDisplay"))},Mi=function(){let t,i,a,l;if(fi("_internalBuild"),!Xt)return;let d,c,g=bi();if(W<1.5*Ye.SCREEN_WIDTH||W<1.5*Ye.SCREEN_HEIGHT){if(ne!==O.SYMMETRIC&&(ea(0),(!_t&&0===X||0!==X)&&(Yt=!0),J||Qi(0)),!_t){t=r.createRectangleNode({width:Ce-Ne,height:2.4*Se,fill:!0,noEdge:!0}),wi(t),rt=new u({ratio:1}),rt.addChild(t),rt.setVisibility(!0),l=new n.MeshBasicMaterial({map:oi,transparent:!0,enableClipPlanes:!1}),l.force=!0,rt.setMaterial(l),rt.setMatrix((new n.Matrix4).makeTranslation(0,0,-2*Ge)),$e.addChild(rt),i=(Ce-Ne)*ce,a=Te*ce/10;let e=r.createRectangleNode({width:i,height:a,fill:!0,noEdge:!0});if(wi(e),l=new n.MeshBasicMaterial({map:ui,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,e.setMaterial(l),e.setMatrix((new n.Matrix4).makeTranslation(0,0,-2*Ge)),$e.addChild(e),!J){a=.5*ce*Te;let e=r.createRectangleNode({width:i,height:a,fill:!0,noEdge:!0});wi(e),l=new n.MeshBasicMaterial({map:ui,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,e.setMaterial(l),e.setMatrix((new n.Matrix4).makeTranslation(0,-a/2+Se*ce*1.2,0)),$e.addChild(e)}if(0===vt){Ct=new o({viewer:Ye,axis:(new n.Vector3).copy(be)}),Ct.subscribe("Click",$i),Ct.subscribe("BeginManipulate",(function(e){Lt=!1,Ft=!1,Ht=!0,Oi(e)}));let e=!0;Ct.subscribe("Manipulate",(function(t){e=!1,Gi(t)})),Ct.subscribe("EndManipulate",(function(t){Lt=!1,Ft=!1,Ht=!1,Bi(t,e)})),Ct.subscribe("BeginPreactivate",ki),Ct.subscribe("EndPreactivate",Ai),vt=Ct.linkToNode($e)}}let d,c,f,m=J?Ne/2*ce:Ne*ce,w=g;if((Ot||At)&&(w=20*g),nt=r.createRectangleNode({width:m,height:w,fill:!0,noEdge:!0}),nt.originalLength=g,wi(nt),l=new n.MeshBasicMaterial({map:ui,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,nt.setMaterial(l),pt.addChild(nt),0===Tt&&(xt=new o({viewer:Ye,axis:(new n.Vector3).copy(be)}),xt.subscribe("BeginManipulate",Yi),xt.subscribe("Manipulate",Gi),xt.subscribe("EndManipulate",(function(e){Lt=!1,Ft=!1,Bi(e)})),xt.subscribe("Click",(function(e){Lt=!1,Ft=!1,Bi(e)})),xt.subscribe("Preactivate",qi),xt.subscribe("EndPreactivate",zi),Tt=xt.linkToNode(nt)),!z){let t=new n.Vector2(-10.8,-36);at=e.createElement("div",{class:"originPinMainDiv"}),at.setStyle("width",ze),at.setStyle("height",36),at.setStyle("backgroundImage",'url("'+U+'")'),it=new p({html:at}),it.height=36,it.width=ze,Dt&&it.setPickable(h.PICKTHROUGH),it.setOffset(t),st=new o({viewer:Ye,axis:(new n.Vector3).copy(be),linkedNode:it}),st.subscribe("BeginManipulate",Li),st.subscribe("Manipulate",Fi),st.subscribe("EndManipulate",Wi),st.subscribe("BeginPreactivate",Hi),st.subscribe("EndPreactivate",Xi),ut=st.linkToNode(it)}if(Y&&(l=new n.MeshBasicMaterial({map:di,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,et.setMaterial(l),J?(d=16*ce,c=16*ce):(d=(Ne+xe+2*Re)*ce,c=Y?(Ie/2+2*Re)*ce:(Ie+Re)*ce),tt=r.createRectangleNode({width:d,height:c,fill:!0,noEdge:!0}),wi(tt),l=new n.MeshBasicMaterial({map:J?E:N,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,tt.setMaterial(l),!_t&&!J)){let e=Ce-Ne+10,s=2*Se;t=r.createRectangleNode({width:e,height:s,fill:!0,noEdge:!0}),wi(t);let d=new u({ratio:1});d.addChild(t);let h=new n.Texture;h.image=Di(re,ti,{alpha:1}),h.needsUpdate=!0,l=new n.MeshBasicMaterial({map:h,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,d.setMaterial(l),ct.addChild(d);let c=Math.floor(Te*ce*1.2/He);i=(Ce-Ne)*ce;let p=c>=7?Math.floor(c/2):c;a=Te*ce/p;let g=r.createRectangleNode({width:i,height:a,fill:!0,noEdge:!0});wi(g),l=new n.MeshBasicMaterial({map:ui,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,g.setMaterial(l),ct.addChild(g),It=new o({viewer:Ye,value:re,linkedNode:d}),It.subscribe("Click",Ki),It.subscribe("BeginManipulate",null),It.subscribe("Manipulate",null),It.subscribe("EndManipulate",null),It.subscribe("BeginPreactivate",Zi),It.subscribe("EndPreactivate",ji),d.setMatrix((new n.Matrix4).makeTranslation(0,(a-s*ce)/2,0)),Nt=It.linkToNode(ct)}J?(d=Pe*ce,c=Pe*ce):(d=(Ne+xe+2*Re)*ce,c=Y?(Ie/2+2*Re)*ce:(Ie+Re)*ce),Ze=r.createRectangleNode({width:d,height:c,fill:!0,noEdge:!0}),wi(Ze),l=new n.MeshBasicMaterial({map:J?P:Y?b:M,side:n.DoubleSide,transparent:!0,enableClipPlanes:!1}),l.force=!0,l.depthTest=!1,Ze.setMaterial(l),0===yt&&(St=new o({viewer:Ye,axis:(new n.Vector3).copy(be)}),St.subscribe("Click",null),St.subscribe("BeginManipulate",(function(e){Lt=!0,Ft=!1,Ht=!1,Oi(e)})),St.subscribe("Manipulate",Gi),St.subscribe("EndManipulate",(function(e){Lt=!1,Ft=!1,Ht=!1,Bi(e)})),St.subscribe("BeginPreactivate",(function(){Wt=!0,Ye.setTemporaryCursor("pointer"),Ui()})),St.subscribe("EndPreactivate",(function(){Wt=!1,Ye.unsetTemporaryCursor(),Ui()})),yt=St.linkToNode(Ze)),pt.addChild($e),pt.addChild(Qe),J?(f=new s({type:"Spherical"}),f.addChild(Ze),Ze.setMatrix((new n.Matrix4).makeTranslation(-20*ce/2,-20*ce/2,0)),Qe.addChild(f)):(Qe.addChild(Ze),pt.addChild(Je)),Y&&(pt.addChild(et),pt.addChild(lt),J?(f=new s({type:"Spherical"}),f.addChild(tt),tt.setMatrix((new n.Matrix4).makeTranslation(-20*ce*.4,-20*ce*.4,0)),lt.addChild(f)):(lt.addChild(tt),pt.addChild(ct))),z||(Ke.addChild(ot),ot.addChild(it)),Ke.addChild(pt),Ke.addChild(dt),pt.addChild(ht)}if(W>0){let e;d=new n.Vector3(0,Te/2*ce,0),c=new n.Vector3(-ce*W,Te/2*ce,0),e=r.createLineNode({points:[d,c]}),wi(e),l=new n.LineBasicMaterial({color:"80,80,80"===Ae?0:16777215,opacity:.5,transparent:!0}),l.force=!0,l.depthTest=!1,e.setMaterial(l),Ke.addChild(e),Y&&(d=new n.Vector3(0,0,0),c=new n.Vector3(-ce*W,0,0),je=r.createLineNode({points:[d,c]}),wi(je),l=new n.LineBasicMaterial({color:"80,80,80"===Ae?0:16777215,opacity:.5,transparent:!0}),l.force=!0,l.depthTest=!1,je.setMaterial(l),Ke.addChild(je))}Ke.setVisibility(!Ii()&&Ut),Ye.addNode(Ke,!1),Ke.setMatrix(new n.Matrix4(ue.x,de.x,he.x,0,ue.y,de.y,he.y,0,ue.z,de.z,he.z,0,0,0,0,1)),we=null,mi("_internalBuild")},this.setValue=function(e){fi("setValue");let t=e;Et&&ae===O.ORIENTED_GRADUATIONS&&!Pt&&this.value<0&&(t*=-1),this.value=void 0!==Q&&t<Q?Q:void 0!==ee&&t>ee?ee:t,this.getVisibleFlag()&&ta(),mi("setValue")},this.getDisplayedValue=function(e){return Pi(this.value,"boolean"!=typeof e||!e)},this.getMatrix=function(){if(Ke)return(new n.Matrix4).copy(Ke.getMatrixWorld())},this.setVisibleFlag=function(e){e!==Ut&&(Ut=e,Ke.setVisibility(!Ii()&&Ut),e&&this.setValue(this.value),Ye.render())},this.getVisibleFlag=function(){return Xt?Ut:null},this.setVisibilityFree=function(e){Ke&&Ke.setVisibilityFree&&Ke.setVisibilityFree(e)},this.getVisibilityFree=function(){if(Ke)return Ke.visibilityFree},this.clear=function(){Vt=!1,Pt=!1,_t=!1,kt=!1,At=!1,Ot=!1,Gt=!1,Bt=!1,Lt=!1,Ft=!1,Wt=!1,Ht=!1,Yt=!1,qt=!1,zt=!1,Jt=!0,gi()},this.subscribe=function(e,t){if(e&&t&&("RulerManipulateBegin"===e||"RulerManipulate"===e||"RulerManipulateEnd"===e||"OriginManipulateBegin"===e||"OriginManipulate"===e||"OriginManipulateEnd"===e))return Xe.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&Xe.unsubscribe(e)},this.getSnappedTranslationVector=function(e){fi("getSnappedTranslationVector");let t=(new n.Vector3).copy(e.translationVector);(At||Ot)&&(Yt=!0),At=!1,Ot=!1,zt=!1;let i=Ye.currentViewpoint.create3DRayFrom2DPoint(ve),a=(new n.Vector3).copy(ue).multiplyScalar(W*ce),r=(new n.Vector3).copy(be).multiplyScalar(we).add(a),l=(new n.Vector3).copy(me).add(r),o=(new n.Matrix4).multiplyMatrices(Ke.getMatrix(),pt.getMatrix().rotateX(.5*Math.PI)).elements,s=new n.Vector3(o[0],o[1],o[2]),u=new n.Vector3(o[8],o[9],o[10]),d=(new n.Plane).setFromNormalAndCoplanarPoint(u,l),h=i.intersectPlane(d);J||l.add((new n.Vector3).copy(s).multiplyScalar(xe*ce));let c=(new n.Vector3).copy(h).sub(l).dot(s),p=this.initValue+e.translationVector.length()*(be.dot(e.translationVector)>0?1:-1),g=J?-Ne*ce:0;if(c<g||c>(J?Ne*ce:ce*Ce))J&&c>g&&c<(Ne+oi.image.getContext("2d").measureText(oi.image.textDisplayed).width)*ce&&(zt=!0),void 0!==Q&&p<Q?t=(new n.Vector3).copy(be).multiplyScalar(Q-this.initValue):void 0!==ee&&p>ee&&(t=(new n.Vector3).copy(be).multiplyScalar(ee-this.initValue));else{let e=c>Ne*ce?"snappingMainGrads":"snappingSmallGrads";zt=!0,J&&(e="snappingSmallGrads"),Yt=!0,At="snappingMainGrads"===e,Ot="snappingSmallGrads"===e;let i="snappingMainGrads"===e?We:We/ie;p=Math.round(p/i)*i,void 0!==Q&&p<Q?p=Q:void 0!==ee&&p>ee&&(p=ee),p-=this.initValue,t=(new n.Vector3).copy(be).multiplyScalar(p)}return mi("getSnappedTranslationVector"),{snappedTranslationVector:t,returnCode:0}},this.beginManipulation=function(){Pt=!0,Ke.setPickable(h.PICKTHROUGH)},this.endManipulation=function(){Ke.setPickable(h.PICKABLE),Pt=!1,At=!1,Ot=!1},this.display=function(){Vt=!1,Pt=!1,Dt=!1,_t=!1,kt=!1,At=!1,Ot=!1,Gt=!1,Bt=!1,Lt=!1,Ft=!1,Wt=!1,Ht=!1,Yt=!1,qt=!1,zt=!1,Jt=!1,pi()},this.refresh=function(){this.setValue(this.value)}}});return O.DEFAULT=0,O.SYMMETRIC=1,O.DEFAULT_GRADUATIONS=0,O.ORIENTED_GRADUATIONS=1,O.ORIGIN_DEFAULT=0,O.ORIGIN_SYMMETRIC=1,O.NM_UNIT=1,O.MICRON_UNIT=2,O.MM_UNIT=4,O.CM_UNIT=8,O.M_UNIT=16,O.HM_UNIT=32,O.KM_UNIT=64,O.INCH_UNIT=128,O.FOOT_UNIT=256,O.YARD_UNIT=512,O.MILE_UNIT=1024,O.NMILE_UNIT=2048,O}));