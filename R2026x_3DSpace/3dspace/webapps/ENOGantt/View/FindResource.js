define("DS/ENOGantt/View/FindResource",["UWA/Class","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Data/ResourceStore","DS/ENOGantt/Data/ResponseUtil","DS/ENOGantt/URLStore","DS/ENOProjectMgmtCommonComponents/utils/ProjectMgmtCloneModel","DS/ENOProjectMgmtModels/Collections/Persons","DS/ENOProjectMgmtModels/Models/Person"],(function(e,t,a,o,r,n,s,i){var d;try{d=e.extend({init:function(e){let t=UWA.clone(e||{},!1);that=this,that.viewCollection=t.viewCollection;new a({viewCollection:that.viewCollection});that.resourceStore=Ext.create("DS.ENOGantt.Data.ResourceStore",{storeId:"resourceStore"}),Ext.define("DS.ENOGantt.View.FindResource",{extend:"Ext.form.field.ComboBox",xtype:"dpmfindresourceview",store:that.resourceStore,displayField:"title",emptyText:App.Nls["emxProgramCentral.Gantt.ResourceUtilization.FindResource.PlaceholderText"],typeAhead:!1,minChars:3,hideLabel:!0,hideTrigger:!0,width:"100%",anchor:"100%",displayField:"Name",valueField:"UserName",queryCaching:!1,listeners:{beforequery:function(e){var t=e.query;if(t){return!/([\\\"\#\$\@\%\*\,\/\?\<\>\[\]\|\:\']+(\s[\\\"\#\$\@\%\*\,\?\\\\\<\>\[\]\|\:\']+)?)/.test(t)}return!1},select:function(e,t,a){that.assignResource(t,e),e.clearValue()}}})},assignResource:function(e,t){var a=this,d=Ext.ComponentQuery.query("#dpmprojectgantt")[0],l=Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0];l.setLoading(!1),l.setLoading(App.Nls["emxProgramCentral.Gantt.ResourceUtilization.Loading"]);var c=e.get("Id");if(d.resourceStore.getModelById(c))return Ext.Msg.alert(App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Header"],App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Body"].replace("{PERSON_NAME}",e.get("Name")),Ext.emptyFn),t.clearValue(),void l.setLoading(!1);var g=l.context,u=g.get("Id"),m=g.get("TaskProjectId"),p=d.taskStore.getModelById(m),S=p.get("StartDate").getTime(),h=p.get("EndDate").getTime();this.data={taskId:u,resourceId:c,taskProjectId:m,projectStart:S,projectEnd:h};App.Infra.contextInfo;let f=d.crudManager.viewCollection.getModelFromModelCache(u),D=f.get("assignees")||new s,E=new i({id:c});D.add(E),f.set("assignees",D),UWA.extend(f._changed,{objectId:f.id});let x=r.getAssignResourceToTaskUrl();var T=function(e){let t,r=a.data.taskProjectId,n=a.data.projectStart,s=a.data.projectEnd,i=(a.data.taskId,a.data.resourceId),c=e.assignees;c&&c.forEach((e=>{e.id===i&&(t=e)}));data.length;var g=[],u=[],m=[];if(t){if(t.FirstName=t.firstname,t.LastName=t.lastname,t.Name=t.name,delete t.firstname,delete t.lastname,delete t.name,t.calendar&&t.calendar.length>0){t.hasCalendar=!0;var p=t.calendar[0].id}var S=t.WorkTime;t.WorkTime=S?parseFloat(S)/60:parseFloat("8.0");var h=t.Id;if(""==p||null==p)p="Custom:"+h;t.CalendarId=p,g.push(t);var f=t.Assignments;if(f&&f.length>0)for(var D=f[0],E=(D.contextUser,1);E<f.length;E++){var x=f[E],T=x,v=x.relelements;o.convertToGanttKeyValues(T),o.convertToGanttKeyValues(v);var I=new Date(T.StartDate),k=new Date(T.EndDate),N=o.stdTimezoneOffset(I),y=I.getTimezoneOffset();if(I=I.getTime(),k=k.getTime(),N!==y&&(I+=60*(y-N)*1e3,k+=60*(y-N)*1e3),!(I<n||k>s)){var C={};C.TaskId=T.TaskId;var w=d.taskStore.getModelById(C.TaskId);C.isReadOnly=!1,w&&"TRUE"!=w.data.hasEditAccess&&(C.isReadOnly=!0);var A=x.type;if(D[A]&&(C.icon=D[A]),C.Id=v.Id,C.Units=v.allocation,C.ResourceId=h,T.TaskProjectId==r)C.Type="Internal";else{var M={};C.Type="External",M.Id=T.TaskId,M.Name=T.Name,M.PercentDone=T.PercentDone,M.Duration=T.Duration,T.StartDate&&(T.StartDate=Ext.Date.format(new Date(T.StartDate),"c")),T.EndDate&&(T.EndDate=Ext.Date.format(new Date(T.EndDate),"c")),M.StartDate=T.StartDate,M.EndDate=T.EndDate,M.expanded=!0,m.push(M)}u.push(C)}}}var R=d.taskStore.data.items[0],P=m.length;if(console.log("e3b extLenth : :"+P),console.time("looping through external Task"),P>0){App.Infra.doNotPropagate=!0;for(var O=0;O<P;O++){var j=m[O],U=j.Id;if(null==d.taskStore.getModelById(U)&&"root"!=j.Name){j.visible=!1,j.Id=U,j.Rollup=!1,j.ReadOnly=!0,j.ExternalTask=!0,j.expanded=!0;var G=Ext.create("DS.ENOGantt.Data.TaskModel",j);App.Infra.ExtTaskArray.push(G),R.addTaskBelow(G),R.nextSibling=""}}console.timeEnd("looping through external Task"),d.taskStore.commitChanges(),delete App.Infra.doNotPropagate}u.length;g.length>0&&d.taskStore.resourceStore.add(g),u.length>0&&d.taskStore.assignmentStore.add(u),d.taskStore.resourceStore.commitChanges(),d.taskStore.assignmentStore.commitChanges(),d.taskStore.commitChanges(),d.taskStore.filterBy((function(e){return!e.get("ExternalTask")})),l.setLoading(!1)};if(window.isODTRunning)"GET",dataObj="",Ext.Ajax.request({url:getAssignResourceToTaskUrl,async:!1,success:function(e){e=JSON.parse(e.responseText.trim()),T(e)}});else{let e=d.crudManager.viewCollection,t=new n(f);window.Widget||(donotShowMessage=!0),e.processSaveDataModel(t,{fields:x.fields,include:x.include,isNew:!1,donotShowMessage:donotShowMessage,doNotCache:!0,customParams:x.customParams,onComplete:function(e){T(JSON.parse(JSON.stringify(e)))}})}}})}catch(e){console.log("::::::::error")}return d}));