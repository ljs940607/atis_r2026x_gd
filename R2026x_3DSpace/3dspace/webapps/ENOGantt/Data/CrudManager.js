define("DS/ENOGantt/Data/CrudManager",["UWA/Class","DS/PlatformAPI/PlatformAPI","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Ven/Bryntum","DS/ENOGantt/Data/TaskStore","DS/ENOGantt/Data/ResponseUtil","DS/ENOGantt/URLStore","DS/ENOProjectMgmtModels/Models/AppSettings","DS/ENOProjectMgmtModels/Utils/StorageDataUtil","DS/ENOProjectMgmtModels/Collections/Tasks","DS/ENOProjectMgmtCommonComponents/utils/ProjectMgmtCloneModel"],(function(e,t,a,n,o,r,s,l,i,d,c){"use strict";return e.extend({init:function(e){let t=UWA.clone(e||{},!1);var a=new o({viewCollection:t.viewCollection});a=a.getStore(),Ext.define("DS.ENOGantt.Data.CrudManager",{extend:"Gnt.data.CrudManager",parentView:t.parentView,viewCollection:t.viewCollection,autoLoad:!1,taskStore:a,prepareRemoved:function(e){for(var t,a=[],n=0,o=e.length;n<o;n++)(t={})[e[n].idProperty]=e[n].getId(),"Gnt.model.Dependency"==e[n].$className&&(t.To=e[n].get("To"),t.From=e[n].get("From")),"Gnt.model.Assignment"==e[n].$className&&(t.TaskId=e[n].get("TaskId")),a.push(t);return a},sendRequest:function(){var e=this,t="live",a=e.transport.sync.params;a&&a.AddRemoveTask&&(t="");var n={rollup:t},o=arguments[0].success,i=JSON.parse(arguments[0].data).type,p="GET";let m=s.getTaskRepositoryURL(i,n,this.transport.load.url);var u,f={};let g,C,v,S=!1;if("sync"===i){if(u={},p="PUT",f=this.getChangeSetPackage(),S=Boolean(f.tasks&&f.tasks.removed),f.tasks)if(void 0===f.tasks.updated)f.tasks.updated={},f.tasks.updated[1]={Id:e.getTaskStore().data.items[0].data.Id};else{for(var A=e.getTaskStore().getRoot().childNodes[0].data.Id,h=f.tasks.updated,E=!1,D=0,I=h.length;D<I;D++){if(h[D].Id===A){E=!0;break}}0==E&&(f.tasks.updated[h.length]={Id:A})}C=r.getUpdatedTaskModels(this,f,this.viewCollection),v=UWA.is(C.isNew,"function")?C.isNew():C.isNew,g=v?C.parentModel:C,v&&(e.isNew=v),u.csrf={name:App.csrf.name,value:App.csrf.value}}u=this.encode(u);if(App.Infra.ViewId!=App.Infra.Views.VIEW_STATUS_REPORT||App.Infra.LoadStatusActualData||enoviaServer.initGantt)if("PUT"===p){let t=g?new c(g):void 0;this.viewCollection.processSaveDataModel(t,{fields:m.fields,include:m.include,isNew:v,isDisconnectModel:S,childObjs:C.childObjs,parentModel:C.parentModel,customParams:m.customParams,donotShowMessage:!window.Widget,doNotCache:!0,doNotUpdateTaggerData:!0,doNotUpdateTreeNodeModel:v||l.getContextId()!==t.id,onComplete:function(t,a){if(S){let t=e.transport.sync.params.deletedTaskArray;t&&t.length&&this.modelCache&&t.forEach((e=>{this.modelCache[e].remove(),this.removeTasksFromTaskCollection(this.modelCache[e].model)}))}e.callbackFunc(JSON.parse(JSON.stringify(t)),o),S&&e.parentView.homeView.dispatchEvent("closePropertyPanel")},onFailure:function(t,a){e.callbackFunc(JSON.parse(JSON.stringify(a)))}})}else{let t=App.Infra.contextInfo;this.viewCollection.getDataModelDetails({model:t,fields:m.fields,include:m.include,customParams:m.customParams,doNotCache:!0,refresh:this.isExpandCall,relatedDataItemFieldToRefresh:"tasks",modelCacheFieldName:"tasks",expandCall:!0}).then((function(t){let a=e.viewCollection&&e.viewCollection.modelCache;if(a&&Object.values(a).forEach((t=>{t.model&&!t.model.hasEvent("onSaveModelComplete")&&e.parentView.handleListenersForTasks(t.model)})),e.viewCollection.handleTabViewOnComplete(),delete e.isExpandCall,e.callbackFunc(t.dataForRendering(),o),e.isNew){var n=Ext.ComponentQuery.query("#dpmprojectgantt")[0];let t=e.parentView.panel.lockedGrid.getSelectionModel().selected.items,a=t[0].data.children.length;a&&1===a&&n.fireEvent("selectionchange",n,t),delete e.isNew}}),(function(t){delete e.isExpandCall}))}else{(new d).fetch({idList:enoviaServer.objectId,refresh:!0,fields:m.fields,include:m.include,customParams:m.customParams,onComplete:function(t){e.callbackFunc(JSON.parse(JSON.stringify(t)),o)}})}},callbackFunc:function(e,t){var a=this;if(window.isODTRunning&&(this.type=window.ODT.type?window.ODT.type:"GET",delete window.ODT.type),e.error){null!=App.Infra.Load.Level&&0!=App.Infra.Load.Level&&(App.Infra.Load.Level=App.Infra.Load.Level+1),a.activeRequests={};var o="";o=e.error===App.Nls["emxProgramCentral.Gantt.Task.Duration.Limit"]?(o=App.Nls["emxProgramCentral.Gantt.Task.Duration.Limit"]).replace(/\\n/g,"\n"):(o=App.Nls["emxProgramCentral.Gantt.ServerSideFailure"]).replace(/\\n/g,"\n"),alert(o),a.load()}else{var s=e,l=e.csrf;if(l&&(App.csrf=l),a.loaded&&a.activeRequests.sync){var d=Ext.ComponentQuery.query("#dpmprojectgantt")[0],c=d.taskStore.scheduleByConstraints,p=d.taskStore.checkDependencyConstraint,m=d.taskStore.checkPotentialConflictConstraint;d.taskStore.scheduleByConstraints=!1,d.taskStore.checkDependencyConstraint=!1,d.taskStore.checkPotentialConflictConstraint=!1;try{var u=a.transport.sync.params,f=r.syncFormat(s,!1,u,a);a.transport.sync.params={};var g=a.encode(f);t.call(a,g);var C=a.taskStore.store.data.items[0];if(0!=C.data.PercentDone&&C.data.State===App.Nls.Create&&(C.data.State=App.Nls.Active,a.commit()),100===C.data.PercentDone&&(C.data.State=App.Nls.Review,a.commit()),App.Infra.contextInfo.unset("performRollup"),r.resetChangedAttributes(this),window.isIFWE&&(C.previousValues.EndDate||C.previousValues.StartDate)){App.ContextModel.set({estimatedFinishDate:C.data.EndDate,estimatedStartDate:C.data.StartDate}),delete C.previousValues.StartDate,delete C.previousValues.EndDate,App.ContextModel.resetChangedAttrs();let e={doNotCacheAttributes:["tasks"]};i.get(App.ContextModel.id)&&this.viewCollection.handleDoNotCacheAttributes(App.ContextModel,e)}u&&u.AddRemoveTask&&(App.Infra.loadProjectSelectable||(App.Infra.loadProjectSelectable=!0),null!=App.Infra.Load.Level&&0!=App.Infra.Load.Level&&(App.Infra.Load.Level=App.Infra.Load.Level+1),a.isExpandCall=!0,a.load())}catch(e){console.log("Error after sync... "+e)}finally{d.taskStore.scheduleByConstraints=c,d.taskStore.checkDependencyConstraint=p,d.taskStore.checkPotentialConflictConstraint=m}}else{if(App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT){if(!App.Infra.LoadStatusActualData&&!enoviaServer.initGantt){var v={};v.tasks=s,s=v}}else if(s.length>1){var S=s[1];r.getsourceIdData(S),s.splice(1,1)}var A=r.loadFormat([s]);if(App.Infra.LoadStatusActualData){var h=r.filterTaskForStatusReport(A,a);A.tasks.rows=h,delete App.Infra.LoadStatusActualData}console.timeEnd("loadFormat");g=a.encode(f);if(t.call(a,A,g),a.taskStore.store.autoNormalizeNodes=!0,a.taskStore.store.dependenciesCalendar=App.Infra.depLagCalendar,null==App.Infra.ProjectCalendar||""==App.Infra.ProjectCalendar){var E=a.taskStore.store.data.items[0].get("CalendarId");if(null==E||""==E){var D=new n.data.calendar.BusinessTime({name:"General",calendarId:"General"});a.taskStore.store.setCalendar(D,!0)}else{D=a.getStore("calendars").getCalendar(E);a.taskStore.store.setCalendar(D,!0)}App.Infra.ProjectCalendar=D}if((App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT||1==App.Infra.ReadOnly)&&null==a.taskStore.store.data.items[0].getBaselineEndDate()){var I=Ext.getCmp("View");I.isDisabled()||I.disable()}var w=App.Infra.ViewId;if(w==App.Infra.Views.VIEW_EXPERIMENT_VERSUS_PROJECT||w==App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE||w==App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE2)a.getTaskStore().collect("BaselineStartDate").sort((function(e,t){return(e=new Date(e))-(t=new Date(t))})),a.getTaskStore().collect("BaselineEndDate").sort((function(e,t){return(e=new Date(e))-(t=new Date(t))})),a.commit();if(a.transport.load.resolve)console.log("Reolve in CRUD"),(0,a.transport.load.resolve)(),delete a.transport.load.resolve;console.timeEnd("call"),App.Infra.loadProjectSelectable&&(App.Infra.loadProjectSelectable=!1)}}(a.transport.load.resolve||window.ODT&&window.ODT.resolve)&&((a.transport.load.resolve||window.ODT.resolve)(),delete a.transport.load.resolve)},transport:{load:{method:"GET",url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:6e4}},sync:{url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:6e4},params:{}}}});var p=Ext.create("DS.ENOGantt.Data.CrudManager");p.on("sync",(function(e,t){if(window.isODTRunning&&this.commit(),null!=t&&t.error)alert(t.error),this.reject();else{if(t.assignments)if(t.assignments.rows.length>0||t.assignments.removed.length>0||t.resources.rows.length>0||t.resources.removed.length>0)Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0].getStore().commitChanges(),this.commit();this.hasChanges()?(console.log("============SYNC CALLED========"),this.commit()):this.commit();var a=Ext.getCmp("tBarActionSaveAll"),n=Ext.getCmp("tBarActionResetAll"),o=Ext.getCmp("tBarActionUndo"),r=Ext.getCmp("tBarActionRedo");a.isDisabled()&&n.isDisabled()&&o.isDisabled()&&r.isDisabled()||(a.disable(),n.disable(),o.disable(),r.disable())}Ext.ComponentQuery.query("#dpmprojectgantt")[0].undoManager.start()})),p.on("haschanges",(function(e,t){var a=Ext.getCmp("tBarActionSaveAll"),n=Ext.getCmp("tBarActionResetAll"),o=Ext.getCmp("tBarActionUndo");(a.isDisabled()||n.isDisabled()||o.isDisabled())&&(a.enable(),n.enable(),o.enable())})),p.on("nochanges",(function(e,t){var a=Ext.getCmp("tBarActionSaveAll"),n=Ext.getCmp("tBarActionResetAll"),o=Ext.getCmp("tBarActionUndo"),r=Ext.getCmp("tBarActionRedo");if(a&&n&&!(a.isDisabled()&&n.isDisabled()&&o.isDisabled()&&r.isDisabled())&&(a.disable(),n.disable(),o.disable(),!0===App.Infra.OnReset)){if(null!=r)if(!r.isDisabled())r.disable(),Ext.ComponentQuery.query("#dpmprojectgantt")[0].undoManager.redoQueue=[];delete App.Infra.OnReset}})),p.on("beforeload",(function(e,t,a){var n=Ext.ComponentQuery.query("#dpmprojectgantt")[0];n.rendered&&n.setLoading({msg:App.Infra.LoadText||n.L("loadingText")})})),p.on("beforesync",(function(e,t){var a=Ext.ComponentQuery.query("#dpmprojectgantt")[0];a.undoManager.stop(),a.rendered&&a.setLoading({msg:"load"===t.type?a.L("loadingText"):a.L("savingText")})})),this.crudManager=p}})}));