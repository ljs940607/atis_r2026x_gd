define("DS/ENOGantt/Data/ResponseUtil",["UWA/Utils","DS/ENOGantt/GanttConstants","DS/Foundation2/FoundationV2Data","DS/ENOProjectMgmtModels/Collections/Tasks","DS/ENOProjectMgmtModels/Collections/Calendars","DS/ENOProjectMgmtModels/Models/Task","DS/ENOProjectMgmtModels/Models/FieldsDefinition","DS/ENOProjectMgmtCommonComponents/utils/CommonUtils","DS/ENOProjectMgmtModels/Utils/DataUtils"],(function(e,t,a,n,r,o,s,d,i){"use strict";var l={},c=[],p={},u={},D={},f={To6WFieldMap:{icon:"typeicon","current.access[modify]":"modifyAccess",Policy:"policy",Type:"nlsType",Name:"title",Id:"objectId",State:"state",PercentDone:"percentComplete",StartDate:"estimatedStartDate",EndDate:"dueDate",Duration:"estimatedDurationInputValue",DurationUnit:"estimatedDurationInputUnit",ConstraintType:"constraintType",ConstraintDate:"constraintDate",TaskSequenceId:"sequenceOrder",LagTime:"lagTime",Lag:"lagTimeInputValue",LagUnit:"lagTimeInputUnit",Type:"dependencyType",TaskProjectId:"taskProjectId",CriticalTask:"criticalTask",Status:"status",SourceId:"sourceId",ScheduleFrom:"scheduleFrom",Owner:"owner",FreeFloat:"freeFloat",TotalFloat:"totalFloat",ExpectedEndDate:"expectedEndDate",Color:"color",Pattern:"pattern",Symbol:"symbol",Note:"notes",Description:"description",ActualDuration:"actualDuration",ActualStartDate:"actualStartDate",ActualFinishDate:"actualFinishDate",DPMTaskCalendarName:"dpmTaskCalendarName",TaskCompletionType:"taskCompletionType"},ToGanttFieldMap:{typeicon:"icon",modifyAccess:"current.access[modify]",policy:"Policy",nlsType:"Type",title:"Name",objectId:"Id",state:"State",percentComplete:"PercentDone",estimatedStartDate:"StartDate",dueDate:"EndDate",estimatedDurationInputValue:"Duration",estimatedDurationInputUnit:"DurationUnit",constraintType:"ConstraintType",constraintDate:"ConstraintDate",sequenceOrder:"TaskSequenceId",lagTimeInputValue:"Lag",lagTimeInputUnit:"LagUnit",dependencyType:"Type",taskProjectId:"TaskProjectId",criticalTask:"CriticalTask",status:"Status",sourceId:"SourceId",scheduleFrom:"ScheduleFrom",owner:"Owner",expectedEndDate:"ExpectedEndDate",freeFloat:"FreeFloat",totalFloat:"TotalFloat",color:"Color",pattern:"Pattern",symbol:"Symbol",notes:"Note",description:"Description",actualDuration:"ActualDuration",actualStartDate:"ActualStartDate",actualFinishDate:"ActualFinishDate",dpmTaskCalendarName:"DPMTaskCalendarName",taskCompletionType:"TaskCompletionType"},convertToGanttKeyValues:function(e){for(var t in e)if(t&&(App.Infra.CustomeColumnDataIndex.includes(t)&&(e[t]=this.formatDate(e[t])),e.hasOwnProperty(t))){var a,n=App.Infra.isCustomizedEnvironment;!n||"actualStartDate"!==t&&"actualFinishDate"!==t&&"actualDuration"!==t?n||"forecastStartDate"!==t&&"forecastFinishDate"!==t&&"forecastDuration"!==t?a=this.ToGanttFieldMap[t]:"forecastStartDate"===t?a="BaselineStartDate":"forecastFinishDate"===t?a="BaselineEndDate":"forecastDuration"===t&&(a="BaselineDuration"):"actualStartDate"===t?a="BaselineStartDate":"actualFinishDate"===t?a="BaselineEndDate":"actualDuration"===t&&(a="BaselineDuration"),a&&(e[a]=e[t],delete e[t])}},convertTo6WKeyValues:function(e){for(var t in e)if(t&&(App.Infra.CustomeColumnDataIndex.includes(t)&&(e[t]=this.getFormattedDate(new Date(e[t]))),e.hasOwnProperty(t))){var a,n=App.Infra.isCustomizedEnvironment;!n||"BaselineStartDate"!==t&&"BaselineEndDate"!==t&&"BaselineDuration"!==t?n||"BaselineStartDate"!==t&&"BaselineEndDate"!==t&&"BaselineDuration"!==t?a=this.To6WFieldMap[t]:"BaselineStartDate"===t?a="forecastStartDate":"BaselineEndDate"===t?a="forecastFinishDate":"BaselineDuration"===t&&(a="forecastDuration"):"BaselineStartDate"===t?a="actualStartDate":"BaselineEndDate"===t?a="actualFinishDate":"BaselineDuration"===t&&(a="actualDuration"),a&&(e[a]=e[t],delete e[t])}},mergeRelDataToBusData:function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])},filterTaskForStatusReport:function(e,t){var a,n=t.taskStore.store.toArray(),r=[],o=e.tasks?e.tasks.rows:e,s=enoviaServer.objectId,d=[];if(enoviaServer.initGantt)for(var i=1;i<n.length;i++)a=n[i].data.Id,d.push(a);else void 0!==s&&(d=s.split(","));for(var l=0;l<o.length;l++)if(a=o[l].Id,-1!==d.indexOf(a)&&r.push(o[l]),o[l].children.length>0){var c=this.filterTaskForStatusReport(o[l].children,t);r=r.concat(c)}return r},formatAssignees:function(e){for(var t=[],a=0,n=e.length;a<n;a++){var r=e[a].fullName;t.push(r)}return t.join()},setLastSequence:function(e){var t=e.TaskProjectId;if(t){if(t&&(l[t]||(l[t]={}),e.TaskSequenceId))if(void 0===l[t].LastSequence)l[t].LastSequence=e.TaskSequenceId;else{var a=parseInt(l[t].LastSequence),n=parseInt(e.TaskSequenceId);(void 0===a||n>a)&&(l[t].LastSequence=e.TaskSequenceId)}}else{if(l[e.Id]){var r=l[e.Id].LastSequence;e.LastSequence=r}l[e.Id]=e}},formatDate:function(e){return e},getEnglishType:function(e){var t=e.type||e.Type,a="Task";void 0!==t&&(t=t.split(" ").join(""),a=App.Infra.DerivativeTypes[t]);return a},isEqualObject:function(e,t){var a=!0;for(let n in e)if(n){if(e[n]===t[n])continue;a=!1;break}return a},mergeExternalDep:function(e,t){for(var a=t.length-1;a>=0;a--){for(var n=t[a],r=!0,o=e.length-1;o>=0;o--){var s=e[o];if(s.predProjectName===n.predProjectName&&s.From===n.From&&s.To===n.To){if(r=!1,this.isEqualObject(n,s))continue;t[a]=s,e.splice(o,1)}}r&&t.splice(a,1)}if(e.length>0)for(var d=0;d<e.length;d++)t.push(e[d]);return t},setRawExternalDependency:function(e,t,a){var n=e.get("ExternalRawDependencies");(n={}).updated=[],n.added=[],n.removed=[];for(var r=0;r<a.length;r++){for(var o=a[r],s=!0,d=t.length-1;d>=0;d--){var i=t[d];i.predProjectName===o.predProjectName&&i.From===o.From&&i.To===o.To&&i.Type===o.Type&&i.Lag===o.Lag&&i.LagUnit===o.LagUnit&&(s=!1)}s&&n.removed.push(o)}if(t.length>0)for(var l=0;l<t.length;l++)n.added.push(t[l]);e.set("ExternalRawDependencies",n)},formatCalendarData:function(e){var t=[];return e&&e.forEach((e=>{e.Id=e.id,e.name=e.name,e.HoursPerDay=parseFloat(e.workHoursPerDay)/60;var a=[],n=e.workweek;let r=e.workingDaysPerMonth,o=e.workingDaysPerWeek;n&&n.forEach(((t,n)=>{var r=t.workdayType;"Non Working"===r&&void 0===e.WeekendFirstDay?e.WeekendFirstDay=n:"Non Working"===r?e.WeekendSecondDay=n:void 0===e.WeekendSecondDay?e.WeekendSecondDay=e.WeekendFirstDay:void 0===e.WeekendFirstDay&&void 0===e.WeekendSecondDay&&(e.WeekendsAreWorkdays=!0);var o=t.workingHours;o&&""!==o||(o="0000-0000");for(var s=[],d=o.split(","),i=0;i<d.length;i++){var l=d[i].split("-"),c=l[0].substr(0,2)+":"+l[0].substr(2,2)+"-"+(l[1].substr(0,2)+":"+l[1].substr(2,2));s.push(c)}"Working"===r?a.push({Type:"WEEKDAY",Weekday:n,IsWorkingDay:!0,Availability:s}):a.push({Type:"WEEKDAY",Weekday:n,IsWorkingDay:!1})})),e.DaysPerWeek=o,e.DaysPerMonth=r,delete e.id,delete e.workHoursPerDay,delete e.workweek,e.Days={rows:a},t.push(e)})),t},formatDependencies:function(e,t){for(var a=new Array,n=t.TaskProjectId,r=new Array,o=e.length,s=0;s<o;s++){var d=e[s],i=d;i.Id=d.relId,this.convertToGanttKeyValues(i);var l=i.predTaskSeqNumber;l&&(i.predTaskSeqNumber=parseInt(l)),i.predecessorTaskName=d.Name;var p=i.Type,u=t.TaskSequenceId;u&&(i.taskSeqNumber=parseInt(u)),i.successorTaskName=t.Name;var D=i.predTaskSeqNumber,f=i.predProjectName,m=i.predProjectId,h=i.Lag,g=i.LagUnit,T="",v=!0;if(f&&!c.includes(f)?(T=f+":",v=!1):f&&c.includes(f)&&n!==m?T=f+":":delete i.predProjectName,T=T+D+":"+p+"+"+h+" "+g,v||(i.isExtDep=!0,r.push(i)),void 0!==p){switch(p){case"SS":p="0";break;case"SF":p="1";break;case"FS":p="2";break;case"FF":p="3"}i.Type=p}v&&a.push(i)}return r.sort(),t.ExternalDependencies=r,a},formatDeliverableForStatusReport:function(e){for(var t=[],a=0;a<e.length;a++){var n=e[a],r={};r.Id=n.id;var o=n;r.Name=o.name,r.leaf=!0,t.push(r)}return t},getsourceIdData:function(e,t){var a=[];if((a=t?e:e.relateddata.tasks).length>0)for(var n=0,r=a.length;n<r;n++){var o=a[n];this.convertToGanttKeyValues(o);var s=o.SourceId;if(D[s]=o,a[n].children.length>0){var d=this.getsourceIdData(a[n].children,!0);this.mergeRelDataToBusData(D,d)}}return D},populateProjectNames:function(e){e&&e.forEach((e=>{var t=this.getEnglishType(e);this.isProjectType(t)&&c.push(e.title||e.name),e.tasks&&e.tasks.length>0&&this.populateProjectNames(e.tasks)}))},loadFormat:function(e,a){e&&e.length&&d.sortModels(e,"sequenceOrder");var n=e[0],r=enoviaServer.viewId||App.Infra.ViewId;if(r===App.Infra.Views.VIEW_STATUS_REPORT){if(n.tasks&&n.tasks.length&&(e=[],e=n.tasks),!window.isODTRunning&&null!=e)for(var o=e.length,l=0;l<o;l++)e[l].CalendarId=App.Infra.projectDataElements.CalendarId}else a||(n.expanded="true",n.FreeFloat="0.0",n.TotalFloat="0.0",this.setProjectModel(n),"Project Start Date"===n.scheduleFrom?n.ScheduleBackwards=!1:n.ScheduleBackwards=!0,window.isODTRunning&&(n.expanded="true"),n.tasks&&n.tasks.length&&(n.children=[],n.children=n.tasks));var c=e.length;a||this.populateProjectNames(e);var p=new Array,u=new Array,f=(new Array,[]),m=[];for(l=0;l<c;l++){var h=e[l],g=h.id,T=h;this.convertToGanttKeyValues(T),T.Id=g;var v=h.children;if(v&&v.length>0){var y=this.loadFormat(v,!0);App.Infra.isCustomizedEnvironment&&(y.predActualStartDate.sort(),y.predActualEndDate.sort(),T.BaselineStartDate=y.predActualStartDate[0],T.BaselineEndDate=y.predActualEndDate[y.predActualEndDate.length-1]),T.children=y.tasks.rows,u=u.concat(y.dependencies.rows)}else T.children=[];T.hasEditAccess=T["current.access[modify]"],T.ReadOnly="TRUE"!=T.hasEditAccess;var I=T.isSummaryTask;let a=this.getEnglishType(T);I&&"true"==I.toLowerCase()&&r!=App.Infra.Views.VIEW_STATUS_REPORT?T.leaf=!1:T.leaf="ProjectTemplate"!=a&&"ProjectSpace"!=a&&"ProjectConcept"!=a&&"Experiment"!=a&&"ProjectBaseline"!=a,this.setLastSequence(T);var S=T.isTypeGate,k=T.isTypeMilestone;T.Rollup="TRUE"==S||"TRUE"==k;var E=T.ConstraintType?T.ConstraintType:T.defaultConstraintType;E&&("assoonaspossible"==(E=(E=E.replace(/ /g,"")).toLowerCase())&&(E=""),"TRUE"!=T.kindOfProjectSpace&&"TRUE"!=T.kindOfExperiment&&"TRUE"!=T.kindOfProjectConcept&&null!=T.ConstraintType&&""!=T.ConstraintType&&(T.ConstraintType=E),"Actual"===App.Infra.projectDataElements.scheduleBasedOn&&(T.ConstraintType=""));var A=T.Policy;-1!=t.OOTBPolicyList.indexOf(A)&&void 0!==App.Nls[T.State]&&(T.State=App.Nls[T.State]);var C=T.TaskCompletionType;if(C&&""!==C){const e=s.getFieldRangeItems("tasks","taskCompletionType");T.TaskCompletionType=i.findObject(e,"value",C).display}if(T.ExternalDependencies=[],App.Infra.expandStatus[g]&&(T.expanded=!0),App.Infra.isCustomizedEnvironment){var F=D[T.SourceId];if(e.length>1&&F){var P=F.StartDate,M=F.EndDate;T.BaselineStartDate=this.formatDate(P),T.BaselineEndDate=this.formatDate(M)}else T.BaselineStartDate=this.formatDate(T.BaselineStartDate),T.BaselineEndDate=this.formatDate(T.BaselineEndDate);r!=App.Infra.Views.VIEW_EXPERIMENT_VERSUS_PROJECT&&r!=App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE&&r!=App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE2&&(T.BaselineStartDate&&""!=T.BaselineStartDate||(T.BaselineStartDate=T.StartDate),T.BaselineEndDate&&""!=T.BaselineEndDate||(T.BaselineEndDate=T.EndDate),f.push(T.BaselineStartDate),m.push(T.BaselineEndDate));var w=App.Nls["emxProgramCentral.DurationUnits.Days"];T.BaselineDuration=T.BaselineDuration+" "+w.toLowerCase()}var x=T.TaskSequenceId;x&&(T.TaskSequenceId=parseInt(x));var j=T.Description;if(j&&(T.Description=Ext.htmlEncode(j)),T.EnglishType=this.getEnglishType(h),T.ExternalProjectDepRawData=[],h.assignees&&r!=App.Infra.Views.VIEW_STATUS_REPORT&&h.assignees.length>0){var B=this.formatAssignees(h.assignees);T.Assignee=B}if(h.deliverables&&h.deliverables.length>0&&r==App.Infra.Views.VIEW_STATUS_REPORT&&!enoviaServer.initGantt){var U=this.formatDeliverableForStatusReport(h.deliverables,T);T.leaf=!1,T.children=U}if(p.push(T),h.predecessors&&r!=App.Infra.Views.VIEW_STATUS_REPORT){var N=this.formatDependencies(h.predecessors,T);u=u.concat(N)}}return{success:!0,tasks:{rows:p},dependencies:{rows:u},calendars:{rows:App.Infra.calendarData},predActualStartDate:f,predActualEndDate:m}},isProjectType:function(e){return"ProjectTemplate"===e||"ProjectSpace"===e||"ProjectConcept"===e||"Experiment"===e||"ProjectBaseline"===e},syncFormat:function(e,a,n,r){if(!a){for(var o=r.taskStore.store.toArray(),s=0,d=o.length;s<d;s++){var i=o[s].data.EnglishType;this.isProjectType(i)&&c.push(o[s].data.Name)}var l=e;if(l&&l.tasks&&l.tasks.length>0&&(l.children=[],l.children=l.children.concat(l.tasks)),l&&l.performRollup&&l.performRollup.length>0){var D=l.performRollup,f=r.getTaskStore().collect("Id");if(D&&D.length){for(var m=D.length-1;m>=0;m--){var h=D[m].id;f.indexOf(h)<0&&D.splice(m,1)}l.children=l.children.concat(D)}}}var g=new Array,T=[],v=[],y=[],I=[],S=[];if(n&&n.contextTaskId&&S.push(n.contextTaskId),n&&n.deletedTaskArray&&(T=T.concat(n.deletedTaskArray)),e){var k=[],E=(P=e).children;if(E&&E.length>0)for(var A=[],C=[],F=0;F<E.length;F++){var P,M=!0;if("RemovedTasks"==(ne=(P=E[F]).id)){k=P.children;for(d=0;d<k.length;d++){var w=k[d];T.push(w)}}else{var x=!0,j=P;if(j){if(P.tempId)j.PhantomId=u.TaskPhantomId,delete u.TaskPhantomId;else{var B=(r=Ext.ComponentQuery.query("#dpmprojectgantt")[0].crudManager).taskStore.store.getModelById(ne);0==App.Infra.Load.Level||B||(M=!1)}var U=P.relelements;this.mergeRelDataToBusData(j,U),this.convertToGanttKeyValues(j),j.Id=ne;var N=P.tasks;if(N&&N.length>0){var b=this.syncFormat({children:N},!0);App.Infra.isCustomizedEnvironment&&(b.predActualStartDate.sort(),b.predActualEndDate.sort(),j.BaselineStartDate=b.predActualStartDate[0],j.BaselineEndDate=b.predActualEndDate[b.predActualEndDate.length-1]),g=g.concat(b.tasks.rows)}x=j.isSummaryTask;let e=this.getEnglishType(j);x&&"true"==x.toLowerCase()?j.leaf=!1:j.leaf="ProjectTemplate"!=e&&"ProjectSpace"!=e&&"ProjectConcept"!=e&&"Experiment"!=e;var W=j.TaskSequenceId;W&&(j.TaskSequenceId=parseInt(W));var L=j.Description;if(L&&(j.Description=Ext.htmlEncode(L)),""==j.ConstraintDate)j.ConstraintType="";else{var R=j.ConstraintType;if(R&&(R=(R=R.replace(/ /g,"")).toLowerCase()),"assoonaspossible"==R&&(R=""),"muststarton"!=j.ConstraintType&&"mustfinishon"!=j.ConstraintType){R=""}j.ConstraintType=R,j.ConstraintDate=this.formatDate(j.ConstraintDate)}var O=j.Policy;if(-1!=t.OOTBPolicyList.indexOf(O)&&void 0!==App.Nls[j.State]&&(j.State=App.Nls[j.State]),App.Infra.isCustomizedEnvironment){j.StartDate=this.formatDate(j.StartDate),j.EndDate=this.formatDate(j.EndDate),j.BaselineStartDate=this.formatDate(j.BaselineStartDate),j.BaselineEndDate=this.formatDate(j.BaselineEndDate),j.BaselineStartDate&&""!=j.BaselineStartDate||(j.BaselineStartDate=j.StartDate),j.BaselineEndDate&&""!=j.BaselineEndDate||(j.BaselineEndDate=j.EndDate),A.push(j.BaselineStartDate),C.push(j.BaselineEndDate);var V=App.Nls["emxProgramCentral.DurationUnits.Days"];j.BaselineDuration=j.BaselineDuration+" "+V.toLowerCase()}j.EnglishType=this.getEnglishType(P),M&&g.push(j)}}if(n&&n.removedDepArray&&(y=n.removedDepArray),P.predecessors&&P.predecessors.length>0){var _=r.taskStore.store,q=P.id,G=_.getModelById(P.Id),K=G.get("TaskProjectId"),z=P.predecessors,$=new Array,H=new Array;for(s=0;s<z.length;s++){(w=z[s]).Id=z[s].relId,this.convertToGanttKeyValues(w);w.To;var Y=w.Type,J=w.predTaskSeqNumber,Q=w.Lag,X=w.LagUnit,Z=w.predProjectName,ee=w.predProjectId,te=!0;Z&&!c.includes(Z)?te=!1:Z&&c.includes(Z)&&K!=ee?ae=Z+":":delete w.predProjectName,ae=ae+J+":"+Y+"+"+Q+" "+X;var ae=J+":"+Y+"+"+Q+" "+X;$.push(ae);var ne=z[s].id;if("SS"==w.Type?w.Type="0":"SF"==w.Type?w.Type="1":"FS"==w.Type?w.Type="2":"FF"==w.Type&&(w.Type="3"),te){var re=w.To,oe=w.From,se=w.$PhantomId,de=re+"-"+oe;(se=p[de])&&(delete p[de],w.$PhantomId=se),v.push(w)}else w.isExtDep=!0,H.push(w)}if(G){var ie=G.get("ExternalDependencies"),le=this.mergeExternalDep(H,ie);q=P.Id;g.push({Id:q,ExternalDependencies:le})}$.sort()}if(P.assignees){var ce=P.assignees;for(s=0;s<ce.length;s++){(w=ce[s]).Id=ce[s].relId,this.convertToGanttKeyValues(w),I.push(w)}}}}return{success:!0,tasks:{rows:g,removed:T},dependencies:{rows:v,removed:y},assignments:{rows:I,removed:S},resources:{rows:[],removed:[]},predActualStartDate:A,predActualEndDate:C}},getFormattedDate:function(e){return e instanceof Date?Ext.Date.format(e,"Y-m-d\\TH:i:s"):e},formatDeletedTaskModelData:function(e,t,a){var n=e.taskStore.store;let r=e.viewCollection;for(var o=n.getRemovedRecords(),d={},i=0,l=o.length;i<l;i++){var c=o[i],p=c.id;let e=c.data.lastParentId,t={};t.lastParentId=e;var u=c.data.EnglishType;"ProjectSpace"!==u&&"ProjectConcept"!==u&&"Experiment"!==u||(t.isDisconnect=!0),d[p]=t}App.Infra.contextInfo;t&&t.length&&t.forEach((e=>{var t=e.Id;let n=d[t].lastParentId;if(n){let e=r&&r.getModelFromModelCache(n),o=e.get("tasks"),d=o.get(t);d.performDeleteOnDisconnect=s.isTaskType(d.get("type")),a.push(t),o.remove(t),e.set("tasks",o),UWA.extend(e._changed,{objectId:e.id})}})),e.transport.sync.params.deletedTaskArray=a},formatAssignment6WData:function(e,t,a){var n=e.taskStore.store.assignmentStore;App.Infra.contextInfo;let r=e.viewCollection;if(t.updated)for(var o=t.updated,s=0,d=o.length;s<d;s++){let e=o[s],t=e.Id,a=e.Units,d=n.getModelById(t),l=d.get("ResourceId");var i=d.get("TaskId");let c,p=r&&r.getModelFromModelCache(i),u=p.get("assignees");u&&u.forEach((e=>{e.id===l&&(c=e)})),c&&(c.set({allocation:""+a}),UWA.extend(p._changed,{objectId:p.id}))}if(t.removed){let e=t.removed;for(let o=0,s=t.removed.length;o<s;o++){let s=t.removed[o].TaskId;if(a.includes(s))continue;let d=r&&r.getModelFromModelCache(s),i=d.get("assignees");e=n.removed;let l=e[0].get("ResourceId");i.remove(l),d.set("assignees",i),UWA.extend(d._changed,{objectId:d.id})}}},formatNewTaskData:function(e,t,a,n,r){return this.convertTo6WKeyValues(e),UWA.extend(e,{tempId:t,type:a}),r?UWA.extend(e,{nextTaskId:n}):UWA.extend(e,{previousTaskId:n}),new o(e)},formatAddedTaskModelData:function(e,t){this.formatTaskDataForSync(e,t,"added");var a=e.taskStore.store,n=e.transport.sync.params.extraParam;App.Infra.contextInfo;let r,o=e.viewCollection,s=t.length,d=[];return t&&t.forEach((e=>{e.Duration=""+e.Duration;var t=e.PhantomId;e.Name||delete e.Name,u.TaskPhantomId=t;var i=n[t],l=i.addTaskAbove,c=i.type;let p,D,f=l?i.selectedTaskId:e.parentId,m=a.getModelById(f);if(l){p=f,m.parentNode.get("Type")&&(D=m.parentNode.get("Id"))}else{var h=m.childNodes.length;D=f,h>s&&(p=m.childNodes[h-(s+1)].id)}if(D){r=o&&o.getModelFromModelCache(D);let a=this.formatNewTaskData(e,t,c,p,l);d.push(a)}})),{childObjs:d,parentModel:r,isNew:!0}},formatUpdateTaskDataForRightIndent:function(e,t,a,r,o){let s=o&&o.getModelFromModelCache(e);var d=a.getModelById(t);let i=a.getModelById(e).modified.parentId;(o&&o.getModelFromModelCache(i)).get("tasks").remove(s,{ignoreAddref:!0}),"Project Space"===d.get("Type")&&(t=d.previousSibling.id),s.set({operation:"IndentationAndDragDrop"});let l=o&&o.getModelFromModelCache(t),c=l.get("tasks")||new n;c&&(c.add(s),l.set("tasks",c)),l&&UWA.extend(l._changed,{objectId:l.id})},formatUpdateTaskDataForLeftIndent:function(e,t,a,r,o){var s=a.getModelById(e);let d=o&&o.getModelFromModelCache(e);let i,l,c=a.getModelById(e).modified.parentId;(o&&o.getModelFromModelCache(c)).get("tasks").remove(d,{ignoreAddref:!0}),t&&null!==s.nextSibling?i=s.nextSibling.id:null!==s.previousSibling?l=s.previousSibling.id:null!==s.nextSibling?i=s.nextSibling.id:l=s.parentNode.id,d.set({operation:"IndentationAndDragDrop",nextTaskId:i,previousTaskId:l});let p=o&&o.getModelFromModelCache(t),u=p.get("tasks")||new n;u&&(u.add(d),p.set("tasks",u)),p&&UWA.extend(p._changed,{objectId:p.id})},formatUpdateTaskDataForDragDrop:function(e,t,a,r){let o,s=e.Id,d=e.parentId,i="",l="",c=t.getModelById(s),p=c.previousValues&&c.previousValues.parentId,u=r&&r.getModelFromModelCache(s);if(!0===e.leaf&&1==e.Duration){u&&(this.convertTo6WKeyValues(e),u.set(e));let t=c.parentNode.get("Id"),a=r&&r.getModelFromModelCache(t);a&&UWA.extend(a._changed,{objectId:a.id})}if("Active"===e.State){u&&(this.convertTo6WKeyValues(e),u.set(e));let t=c.parentNode.get("Id"),a=r&&r.getModelFromModelCache(t);a&&UWA.extend(a._changed,{objectId:a.id})}else{if(d){if(i="True",o=d,p){(r&&r.getModelFromModelCache(p)).get("tasks").remove(u,{ignoreAddref:!0})}}else o=c.parentNode.id;if("root"!==o){let e,t;"True"===i&&(l="IndentationAndDragDrop"),d&&null!==c.nextSibling?e=c.nextSibling.id:null!==c.previousSibling?t=c.previousSibling.id:null!==c.nextSibling?e=c.nextSibling.id:t=c.parentNode.id,u.set({operation:l,isOnlyResequencing:!0,nextTaskId:e,previousTaskId:t});let a=r&&r.getModelFromModelCache(o),s=a.get("tasks")||new n;s&&(s.remove(u,{ignoreAddref:!0}),s.add(u)),a&&UWA.extend(a._changed,{objectId:a.id})}else{u&&(this.convertTo6WKeyValues(e),u.set(e));let t=c.parentNode.get("Id");if("root"!==t){let e=r&&r.getModelFromModelCache(t);e&&UWA.extend(e._changed,{objectId:e.id})}}}},formatUpdateTaskModelData:function(e,t){!0===e.transport.sync.params.DragDrop&&t.sort((function(e,t){return e.index<t.index?-1:e.index>t.index?1:0})),this.formatTaskDataForSync(e,t,"updated");var a=e.taskStore.store;let n=App.Infra.contextInfo,r=e.viewCollection;return t&&t.length&&t.forEach((t=>{let o=t.Id,s=r.getModelFromModelCache(o),d=a.getModelById(o);if("Complete"!==s.get("state")&&(!0!==e.transport.sync.params.DragDrop||100!=s.get("percentComplete")))if(t.Duration&&(t.Duration=""+t.Duration),t.Description&&(t.Description=Ext.htmlDecode(t.Description)),void 0!==t.PercentDone&&(t.PercentDone=""+t.PercentDone),e.transport.sync.params.RightIndent&&t.parentId)this.formatUpdateTaskDataForRightIndent(o,t.parentId,a,n,r);else if(e.transport.sync.params.LeftIndent&&t.parentId)this.formatUpdateTaskDataForLeftIndent(o,t.parentId,a,n,r);else if(e.transport.sync.params.DragDrop)this.formatUpdateTaskDataForDragDrop(t,a,n,r);else{let e=d.parentNode.get("Id");if(s&&(this.convertTo6WKeyValues(t),s.set(t)),"root"!==e){let t=r.getModelFromModelCache(e);t&&UWA.extend(t._changed,{objectId:t.id})}}})),n},appendUpdatedPredecessorModelData:function(e,t,a,n){var r=t.updated,o=e.taskStore.store.dependencyStore,s={};let d=e.viewCollection;for(let e=0,t=r.length;e<t;e++){var i=r[e],l=i.isExtDep?i:o.getModelById(i.Id).data,c=l.To;void 0!==i.Lag?i.LagTime=""+i.Lag:i.LagTime=""+l.Lag,void 0!==i.LagUnit?i.LagTime=i.LagTime+" "+i.LagUnit:i.LagTime=i.LagTime+" "+l.LagUnit;var p=l.From;n.includes(c)||n.includes(p)||("0"==i.Type?i.Type="SS":"1"==i.Type?i.Type="SF":"2"==i.Type?i.Type="FS":"3"==i.Type&&(i.Type="FF"),this.convertTo6WKeyValues(i),UWA.extend(i,{id:l.From}),s.hasOwnProperty(c)?s[c].push(i):s[c]=[i])}if(r.length>0)for(var u=0,D=a.length;u<D;u++){var f=a[u].objectId;if(s[f]&&s[f].length>0){let e=d.getModelFromModelCache(f),t=e&&e.get("predecessors");s[f].forEach((e=>{t.get(e.id).set(e)})),UWA.extend(e._changed,{objectId:f}),delete s[f]}}},appendPredecessorModelData:function(e,t,a,n){t.updated&&this.appendUpdatedPredecessorModelData(e,t,a,n);let r=e.viewCollection;if(t.removed){var o=t.removed;for(let e=0,t=o.length;e<t;e++){let t=o[e],a=t.To,n=t.From,s=r&&r.getModelFromModelCache(a);s.get("predecessors").remove(n),UWA.extend(s._changed,{objectId:s.id})}e.transport.sync.params.removedDepArray=o}if(t.added){for(var s=t.added,d={},i=0,l=s.length;i<l;i++){var c=s[i],u=c.To,D=c.From;if(null!=c.Lag&&(c.LagTime=""+c.Lag),null!=c.LagUnit&&(c.LagTime=c.Lag+" "+c.LagUnit),!n.includes(u)&&!n.includes(D)){var f=c.$PhantomId;p[h=u+"-"+D]=f,"0"==c.Type?c.Type="SS":"1"==c.Type?c.Type="SF":"2"==c.Type?c.Type="FS":"3"==c.Type&&(c.Type="FF"),this.convertTo6WKeyValues(c),UWA.extend(c,{id:D,connectWithAttributes:!0}),d.hasOwnProperty(u)?d[u].push(c):d[u]=[c]}}for(let e=0,t=a.length;e<t;e++){var m=a[e].objectId;if(d[m]&&d[m].length>0){let e=r&&r.getModelFromModelCache(m),t=e.get("predecessors")||e.createRelatedDataItems();d[m].forEach((e=>{delete e.$PhantomId,t.add(e)})),UWA.extend(e._changed,{objectId:m}),delete d[m]}}}for(var h in d)if(d.hasOwnProperty(h)){d[h];let e=r&&r.getModelFromModelCache(h),t=e.get("predecessors")||e.createRelatedDataItems();d[h].forEach((e=>{e.$PhantomId&&delete e.$PhantomId,t.add(e)})),e.set("predecessors",t),UWA.extend(e._changed,{objectId:h})}},formatLeafTaskDataForSyncUpdated:function(e,t){if(e.ConstraintType||e.ConstraintDate){var a=e.ConstraintType;"startnoearlierthan"===a||"startnolaterthan"===a?e.EndDate&&delete e.EndDate:"finishnoearlierthan"===a&&e.StartDate&&delete e.StartDate,e.StartDate&&(e.StartDate=this.getFormattedDate(new Date(e.StartDate))),e.EndDate&&(e.EndDate=this.getFormattedDate(new Date(e.EndDate)))}else delete e.StartDate,delete e.EndDate;delete e.ConstraintType,delete e.ConstraintDate,e.TaskProjectId=t.get("TaskProjectId")},formatTaskDataForSyncUpdated:function(e,t){for(var a=t.length-1;a>=0;a--){var n=t[a];if(void 0===e.transport.sync.params.DragDrop&&delete n.index,n.parentId&&e.getTaskStore().getModelById(n.Id).data.State===App.Nls.Active&&e.getTaskStore().getModelById(n.parentId).data.State!==App.Nls.Active&&t.push({Id:n.parentId,State:"Active"}),n.StartDate||n.EndDate||n.Duration){var r=n.Id,o=e.taskStore.store.getModelById(r);0==App.Infra.Load.Level||o||(console.log("Updated:"+t[a]),delete t[a]),n.ConstraintDate&&!n.ConstraintType&&(n.ConstraintType=o.get("ConstraintType")),!0===n.leaf&&0!==o.modified.Duration&&(delete n.StartDate,delete n.EndDate,delete n.Duration),o&&(!1===o.get("leaf")&&(delete n.StartDate,delete n.EndDate,delete n.Duration),e.transport.sync.params.RightIndent||e.transport.sync.params.LeftIndent||e.transport.sync.params.DragDrop||!1!==o.get("leaf")?this.formatLeafTaskDataForSyncUpdated(n,o):(n.ConstraintType||n.ConstraintDate||null===n.ConstraintDate&&""===n.ConstraintType)&&(delete n.ConstraintType,delete n.ConstraintDate))}else(n.ConstraintType||n.ConstraintDate||null===n.ConstraintDate&&""===n.ConstraintType)&&(delete n.ConstraintType,delete n.ConstraintDate)}},formatTaskDataForSyncAdded:function(e,a){for(var n=e.transport.sync.params.extraParam,r=0;r<a.length;r++){var o=a[r],s=n[o.PhantomId];if(o.addTaskAbove=s.addTaskAbove,o.type=s.type,!0===o.addTaskAbove&&(o.selectedTaskId=s.selectedTaskId),o.StartDate&&(o.StartDate=this.getFormattedDate(new Date(o.StartDate))),o.EndDate&&(o.EndDate=this.getFormattedDate(new Date(o.EndDate))),o.ConstraintDate&&(o.ConstraintDate=this.getFormattedDate(new Date(o.ConstraintDate))),o.ConstraintType){var d=t.constraintType;o.ConstraintType=d[o.ConstraintType]}}},formatTaskDataForSync:function(e,t,a){"updated"===a&&this.formatTaskDataForSyncUpdated(e,t),"added"===a&&this.formatTaskDataForSyncAdded(e,t)},getCriticalTasksArray:function(e,t){for(var a=new Array,n=e.length,r=0;r<n;r++){var o=e[r],s=o.id,d=o.isOverallCritical;if(d&&"TRUE"===d.toUpperCase()){var i=t.getModelById(s);i&&a.push(i)}var l=o.children;if(l&&l.length>0){var c=this.getCriticalTasksArray(l,t);a=a.concat(c)}}return a},getGanttTableColumnArray:function(e){var t=Ext.ComponentQuery.query("#dpmprojectgantt")[0],a=[];if(t)for(var n=t.columns,r=0;r<n.length;r++){var o=n[r];if((!o||1!=o.hidden||e)&&(a.push(o),n[r].columns))for(var s=n[d].columns,d=0,i=s.length;d<i;d++){var l=s[d];a.push(l)}}return a},stdTimezoneOffset:function(e){var t=new Date(e.getFullYear(),0,1),a=new Date(e.getFullYear(),6,1);return Math.max(t.getTimezoneOffset(),a.getTimezoneOffset())},setProjectModel:function(e){e.TaskType="DS.ENOGantt.Data.ProjectModel",e.AllowDependencies=!0},getUpdatedTaskModels:function(e,t){let a=t.tasks,n=App.Infra.contextInfo;var r=[];let o=[];if(a){if(o=a.updated,o&&this.formatUpdateTaskModelData(e,o),a.added){var s=a.added;return this.formatAddedTaskModelData(e,s)}if(a.removed){let a=t.tasks.removed;this.formatDeletedTaskModelData(e,a,r)}if(o)for(var d=0;d<o.length;d++)if(o[d].ExternalRawDependencies){var i=o[d].ExternalRawDependencies;if(t.dependencies?(t.dependencies.updated||(t.dependencies.updated=[]),t.dependencies.added||(t.dependencies.added=[]),t.dependencies.removed||(t.dependencies.removed=[])):(t.dependencies={},t.dependencies.added=[],t.dependencies.updated=[],t.dependencies.removed=[]),i.updated){var l=t.dependencies.updated;t.dependencies.updated=l.concat(i.updated)}if(i.added){var c=t.dependencies.added;t.dependencies.added=c.concat(i.added)}if(i.removed){var p=t.dependencies.removed;t.dependencies.removed=p.concat(i.removed)}delete o[d].ExternalRawDependencies,delete o[d].ExternalDependencies}}if(t.dependencies&&this.appendPredecessorModelData(e,t.dependencies,o,r),t.assignments){var u=t.assignments;this.formatAssignment6WData(e,u,r)}return n},resetChangedAttributes:function(e){let t;App.Infra.contextInfo;e.viewCollection&&(t=e.viewCollection.modelCache),t&&Object.values(t).forEach((e=>{e.model.resetChangedAttrs()}))},loadCalendarData:function(e){return new UWA.Promise((function(t,a){if(!App.Infra.calendarData){(new r).fetch({refresh:!0,ignoreDefinition:!0,fields:e.fields,include:e.include,customParams:e.customParams,onComplete:function(e){App.Infra.calendarData=[];let a=f.formatCalendarData(JSON.parse(JSON.stringify(e)));a&&(App.Infra.calendarData=a),t()}})}}))}};return f}));