/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/LineTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Web3DUXUtils/Web3DUXArrow","DS/Ruler/Ruler","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/AxisSystemNode","DS/Manipulators/PointHandle"],(function(e,t,i,n,r,a,o,d,l,s,c){"use strict";return e.extend({init:function(e){var u,g,x,h,p,f,m=e||{},D=this,v=[],b=!0,y=9689341,C=6543615,w=m.window.getViewer(),A=m.stepRequired,P=new Array(6),M=new Array(6),V=!0,T=new i("BoxEditor_HandleBag");T.setVisibility(!1),T.exludeFromBounding(!0);var S=new i,R=new Array(6),O=null,G=new r,E=!1,B=!1,z=0,L=e.lengthUnit.unit,U=e.lengthUnit.decimalPlaceRO,I=new i("BoxEditor_Axis");I.exludeFromBounding(!0),I.setPickable(a.PICKTHROUGH),I.setVisibility(!1);var N=new s({headLength:10,arrowLength:50,arrowWidth:2,head:s.types.ARROW,colors:{colorX:new a.Color(1,.5,0,0),colorY:new a.Color(1,.5,0,0),colorZ:new a.Color(1,.5,0,0)}});I.addChild(N);var F=new i,k=new i;k.setVisibilityFree(!0),k.setVisibilityInTree(!1);var j=new o({sceneGraph:k,width:60,viewer:w});j.setVisibility(!1),j.setPickable(a.PICKTHROUGH),k.addChild(F),k.addChild(j),k.addChild(T),k.addChild(S),k.addChild(I),w.addNode(k);var H=new d(m.window,{displayOrigin:!0,startValue:0,offset:5,unit:L,nbDecimals:U}),X=0,W=0;this.display=function(e){f=e.matrix,k.setMatrix(f),k.name="BoxGridEditor "+e.rootID;var t=J(e);u=t.selectedCorner,g=t.fstAxis,x=t.sndAxis,h=t.thdAxis,p=t.cornerPoint,V=e.displayHandlePoints,q(),K(e.gridDataPreference);for(var i=0;i<6;i++)te(i,y,C);T.setVisibility(!0),X||(X=H.subscribe("RulerManipulate",_),W=H.subscribe("RulerManipulateEnd",Y)),w.render()},this.refresh=function(){pe(),H.clear(),w.render()},this.updateUnit=function(e){H.unit=e.unit,H.nbDecimals=e.decimalPlaceRO,H.display()},this.setHandlePointsVisibility=function(e){V=e,pe(),w.render()},this.setDataPreference=function(e){var t=J({gridDataPreference:e});p=t.cornerPoint,u=t.selectedCorner,v=[],g=t.fstAxis,x=t.sndAxis,h=t.thdAxis,K(D.getDataPreference())},this.getDataPreference=function(){var e=(new t.Vector3).subVectors(p,u),i=0===Math.round(e.x)?g.x:e.x,n=0===Math.round(e.y)?x.y:e.y,r=0===Math.round(e.z)?h.z:e.z;return{origin:u,xAxis:i,yAxis:n,zAxis:r}},this.updateAutomaticCorner=function(){var e=(new t.Vector3).crossVectors(x,g),i=(new t.Vector3).crossVectors(g,h),n=(new t.Vector3).crossVectors(h,x),r=p.clone(),a=w.currentViewpoint.getSightDirection();a.dot(e)<0&&a.dot(i)>0&&a.dot(n)>0?r.add(h):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)>0?r.add(x):a.dot(e)>0&&a.dot(i)>0&&a.dot(n)<0?r.add(g):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)>0?(r.add(x),r.add(h)):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)<0?(r.add(x),r.add(g)):a.dot(e)<0&&a.dot(i)>0&&a.dot(n)<0?(r.add(h),r.add(g)):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)<0&&(r.add(g),r.add(x),r.add(h)),!r||u.x===r.x&&u.y===r.y&&u.z===r.z||$({selectedCorner:r})},this.clean=function(){for(var e=0;e<6;e++)R[e]&&R[e].unlink(M[e]),P[e]&&P[e].removeChildren();P.splice(0,P.length),M.splice(0,M.length),R.splice(0,R.length),S&&S.removeChildren(),I&&I.removeChildren(),F&&F.removeChildren(),T&&T.removeChildren(),k.removeChildren(),w.removeNode(k),j=null,F=null,S=null,I=null,X&&(H.unsubscribe(X),X=0),W&&(H.unsubscribe(W),W=0),H.clear(),H=null,G=null,T=null,w.render()},this.getBag=function(){return S},this.isSizeOK=function(){return b},this.subscribe=function(e,t){return G.subscribe({event:e},t)},this.unsubscribe=function(e){G.unsubscribe(e)};var _=function(e){E=!0,de(e.translationVector)},Y=function(){se()},Z=function(e){var i=new c({viewer:w,sceneGraph:e.parent});i.name=e.name,i.setMatrix((new t.Matrix4).setPosition(e.position));var n=a.PICKABLE;return i.setPickable(n),i.setVisibility(!0),i.setSize(20),i.subscribe("EndManipulate",(function(e){var i=e.paths[0].externalPath[2],n=(new t.Vector3).getPositionFromMatrix(i.getMatrix());u!==n?($({selectedCorner:n}),he("BoxCornerChanged",{cornerChanged:!0})):he("BoxCornerChanged",{cornerChanged:!1})})),i},q=function(){for(var e,i=function(e){var i=new t.Vector3;return i.x=e.x.toFixed(4),i.y=e.y.toFixed(4),i.z=e.z.toFixed(4),i},n=new t.Matrix4,r=new t.Color("#FFFFFF"),a=new t.Color("#FF8000"),o=["mO","mOX","mOY","mOZ","mOXY","mOYZ","mOXZ","mOXYZ"],d=[p.clone(),p.clone().add(g),p.clone().add(x),p.clone().add(h),p.clone().add(g).add(x),p.clone().add(x).add(h),p.clone().add(g).add(h),p.clone().add(g).add(x).add(h)],l=0;l<o.length;l++){(e=T.getChildByName(o[l]))?e.setMatrix(n.setPosition(d[l])):(n=n.setPosition(d[l]),e=Z({name:o[l],position:d[l],parent:T}));var s=i(d[l]).equals(i(u));e.setFillColor(s?a:r),e.setVisibility(V||s)}},J=function(e){var i=(new t.Vector3).copy(e.gridDataPreference.origin),n=(new t.Vector3).copy(e.gridDataPreference.origin),r=new t.Vector3(e.gridDataPreference.xAxis,0,0),a=new t.Vector3(0,e.gridDataPreference.yAxis,0),o=new t.Vector3(0,0,e.gridDataPreference.zAxis);return i.x+e.gridDataPreference.xAxis<i.x&&(n.x=i.x+r.x,r.x*=-1),i.y+e.gridDataPreference.yAxis<i.y&&(n.y=i.y+a.y,a.y*=-1),i.z+e.gridDataPreference.zAxis<i.z&&(n.z=i.z+o.z,o.z*=-1),{selectedCorner:i,cornerPoint:n,fstAxis:r,sndAxis:a,thdAxis:o}},K=function(e){var i=function(e){return 0===(e=Number(e))||isNaN(e)?e:e>0?1:-1};I.setMatrix((new t.Matrix4).setPosition(e.origin)),I.setVisibility(!0);var n=(new t.Matrix4).rotateX(3*i(e.yAxis)*Math.PI/2);I.children[0].children[0].setMatrix(n);var r=(new t.Matrix4).rotateY(i(e.xAxis)*Math.PI/2);I.children[0].children[1].setMatrix(r);var a=new t.Matrix4;e.zAxis<0&&a.rotateX(Math.PI),I.children[0].children[2].setMatrix(a)},Q=function(e,i){var n=(new t.Vector3).copy(e),r=(new t.Vector3).copy(i),a=n.cross(r).length();return 0===Math.round(100*a)},$=function(e){v=[],u=e.selectedCorner,pe(),K(D.getDataPreference())},ee=function(){var e=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e};b=!0,y=9689341,C=6543615;var i=(new t.Vector3).copy(p);if(i.x%A!=0&&i.x%A!=0&&i.x%A!=0){var n=(new t.Vector3).copy(i).add(g).add(x).add(h),r=e(n.x,A),a=e(n.y,A),o=e(n.z,A);r<i.x&&a<i.y&&o<i.z&&(b=!1,y=16711765,C=14876748)}},te=function(e,n,r){P[e]&&P[e].removeChildren();var a=null,o=null,d=null,s=null;switch(e){case 0:a=p,o=x,d=g,3!==v.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&v.push(e));break;case 1:a=p,o=h,d=x,3!==v.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&v.push(e));break;case 2:a=p,o=g,d=h,3!==v.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&v.push(e));break;case 3:a=(new t.Vector3).copy(p).add(g),o=x,d=h,3!==v.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&v.push(e));break;case 4:a=(new t.Vector3).copy(p).add(x),o=h,d=g,3!==v.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&v.push(e));break;case 5:a=(new t.Vector3).copy(p).add(h),o=g,d=x,3!==v.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&v.push(e))}var c=ie(a,o,d,n,r,e),f=l.createMeshNode(c);f.excludeFromCSO(!0),f.excludeFromHighlight(!0),f.setSSAO(!1),f.setShadow(!1,!1),P[e]||(P[e]=new i("Face"+e),S.add(P[e])),P[e].add(f),R[e]&&R[e].unlink(M[e]),R[e]=ne(e,(new t.Vector3).copy(o).cross(d).normalize()),M[e]=R[e].linkToNode(P[e]),ne(-1,new t.Vector3)},ie=function(e,i,n,r,o){var d,l,s,c,u,g,x,h,p,f,m;(d=new a.PrimitiveGroup).fillAttr=new a.FillAttributes,d.lineAttr=new a.LineAttributes,d.pointAttr=new a.PointAttributes,(l=new a.Buffer).size=12,l.component=a.VertexComponentEnum.POSITION,l.format=a.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(12),(c=new a.Buffer).indexBuffer=!0,c.size=9,c.format=a.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(9),(s=new a.Buffer).size=3,s.component=a.VertexComponentEnum.NORMAL,s.format=a.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(3),(u=new a.Buffer).indexBuffer=!0,u.size=4,u.format=a.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(4),d.addBuffer(0,l),d.addBuffer(1,c),d.addBuffer(2,s),d.addBuffer(3,u),x=0,(g=l.data)[x++]=e.x,g[x++]=e.y,g[x++]=e.z,m=(new t.Vector3).copy(e).add(i),g[x++]=m.x,g[x++]=m.y,g[x++]=m.z,m=(new t.Vector3).copy(e).add(i).add(n),g[x++]=m.x,g[x++]=m.y,g[x++]=m.z,m=(new t.Vector3).copy(e).add(n),g[x++]=m.x,g[x++]=m.y,g[x++]=m.z,(g=c.data)[0]=0,g[1]=1,g[2]=3,g[3]=2,(g=s.data)[0]=0,g[1]=0,g[2]=1,(g=u.data)[0]=0,g[1]=0,g[2]=0,g[3]=0,(h=new a.Primitive).nbIndices=4,h.connectivity=a.ConnectivityTypeEnum.TRIANGLE_STRIP,h.material=new t.MeshBasicMaterial({side:t.DoubleSide,color:r,opacity:.5,transparent:!0}),(p=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=a.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=0,p.indices=new a.IndexArray,p.indices.format=a.DataTypeEnum.UINT,p.indices.bufferId=1,p.indices.offset=0,h.addVertexComponent(p),(f=new a.VertexComponent).component=a.VertexComponentEnum.NORMAL,f.nbVertices=4,f.nbValuesPerVertex=3,f.format=a.DataTypeEnum.FLOAT,f.cardinality=0,f.bufferId=2,f.indices=new a.IndexArray,f.indices.format=a.DataTypeEnum.UINT,f.indices.bufferId=3,f.indices.offset=0,h.addVertexComponent(f),d.addPrimitive(h),x=4,(g=c.data)[x++]=0,g[x++]=1,g[x++]=2,g[x++]=3,g[x++]=0;var D=new a.Primitive;return D.nbIndices=4,D.connectivity=a.ConnectivityTypeEnum.LINE_STRIP,D.attr={fill:new a.FillAttributes,line:new a.LineAttributes(new a.Color(o)),point:new a.PointAttributes},(p=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,p.nbVertices=5,p.nbValuesPerVertex=3,p.format=a.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=0,p.indices=new a.IndexArray,p.indices.format=a.DataTypeEnum.UINT,p.indices.bufferId=1,p.indices.offset=4,D.addVertexComponent(p),d.addPrimitive(D),d.noz=!1,d},ne=function(e,i){var r=new n({axis:(new t.Vector3).copy(i)});return r.setExclusive(!0),e>=0&&(r.subscribe("BeginManipulate",(function(){oe(e)})),r.subscribe("Manipulate",(function(e){le(e)})),r.subscribe("EndManipulate",(function(e){ce(e)})),r.subscribe("BeginPreactivate",(function(t){ue(e,t)})),r.subscribe("EndPreactivate",(function(){ge()}))),r},re=function(e){var i=null,n=null;switch(e){case 0:i=(new t.Vector3).copy(x),n=(new t.Vector3).copy(g);break;case 1:i=(new t.Vector3).copy(h),n=(new t.Vector3).copy(x);break;case 2:i=(new t.Vector3).copy(g),n=(new t.Vector3).copy(h);break;case 3:i=(new t.Vector3).copy(x),n=(new t.Vector3).copy(h);break;case 4:i=(new t.Vector3).copy(h),n=(new t.Vector3).copy(g);break;case 5:i=(new t.Vector3).copy(g),n=(new t.Vector3).copy(x)}return(new t.Vector3).copy(n).cross(i).normalize()},ae=function(e,i){var n=null,r=null,a=null;switch(e){case 0:n=(new t.Vector3).copy(p),r=(new t.Vector3).copy(x),a=(new t.Vector3).copy(g);break;case 1:n=(new t.Vector3).copy(p),r=(new t.Vector3).copy(h),a=(new t.Vector3).copy(x);break;case 2:n=(new t.Vector3).copy(p),r=(new t.Vector3).copy(g),a=(new t.Vector3).copy(h);break;case 3:n=(new t.Vector3).copy(p).add(g),r=(new t.Vector3).copy(x),a=(new t.Vector3).copy(h);break;case 4:n=(new t.Vector3).copy(p).add(x),r=(new t.Vector3).copy(h),a=(new t.Vector3).copy(g);break;case 5:n=(new t.Vector3).copy(p).add(h),r=(new t.Vector3).copy(g),a=(new t.Vector3).copy(x)}var o=r.length();a.length()>o&&(o=a.length());var d=(new t.Vector3).copy(r).setLength(r.length()/2),l=(new t.Vector3).copy(a).setLength(a.length()/2);n.add(d).add(l);var s=(new t.Vector3).copy(a).cross(r).normalize(),c=new t.Matrix4;r.normalize(),a.normalize();var u=c.elements;i&&s.applyAxisAngle(r,Math.PI),u[0]=r.x,u[1]=r.y,u[2]=r.z,u[4]=a.x,u[5]=a.y,u[6]=a.z,u[8]=s.x,u[9]=s.y,u[10]=s.z,c.setPosition(n),j.setMatrix(c),B=i},oe=function(e){z=e,O=new t.Vector3(0,0,0),ae(z),j.setVisibility(!0),F.removeChildren(),E=!0,H.clear();var i=re(z),n=null;Q(i,g)?n=g:Q(i,x)?n=x:Q(i,h)&&(n=h);var r=null,a=null;switch(z){case 0:r=(new t.Vector3).copy(p),a=g;break;case 1:r=(new t.Vector3).copy(p),a=x;break;case 2:r=(new t.Vector3).copy(p).sub(h),a=h;break;case 3:r=(new t.Vector3).copy(p).add(g).sub(h),a=h;break;case 4:r=(new t.Vector3).copy(p).add(x),a=g;break;case 5:r=(new t.Vector3).copy(p).add(h),a=x}var o=(new t.Vector3).copy(i).setLength(n.length()).add((new t.Vector3).copy(a).setLength(a.length()));H.origin=(new t.Vector3).copy(r).add(o).add((new t.Vector3).getPositionFromMatrix(f)),H.initValue=n.length(),H.value=H.initValue,H.direction=i.multiplyScalar(-1),H.setVisibleFlag(!0),H.display(),H.beginManipulation(),w.render()},de=function(e){var i;O.add(e),0===z?(i=(new t.Vector3).copy(h).sub(e),h.copy(i)):1===z?(i=(new t.Vector3).copy(g).sub(e),g.copy(i)):2===z?(i=(new t.Vector3).copy(x).sub(e),x.copy(i)):3===z?(i=(new t.Vector3).copy(g).add(e),g.copy(i)):4===z?(i=(new t.Vector3).copy(x).add(e),x.copy(i)):5===z&&(i=(new t.Vector3).copy(h).add(e),h.copy(i)),0!==z&&1!==z&&2!==z||p.add(e),v.indexOf(z)>-1&&u.add(e);var n=P[z].children[0],r=n.getMatrix();r.setPosition((new t.Vector3).getPositionFromMatrix(r).add(e)),n.setMatrix(r),xe(z);var a=e.dot(re(z));a>0&&!B?ae(z,!0):a<0&&B&&ae(z,!1);var o=(new t.Vector3).getPositionFromMatrix(j.getMatrix()).add(e);j.setMatrix((new t.Matrix4).copy(j.getMatrix()).setPosition(o)),T.setVisibility(!1),I.setVisibility(!1)},le=function(e){var i=H.getSnappedTranslationVector(e);if(0!==i.returnCode)return null;var n=(new t.Vector3).copy(i.snappedTranslationVector).sub(O),r=H.value+n.length()*(n.dot(re(z))<0?1:-1);r<=0&&(r=0,n.setLength(H.value)),H.setValue(r),de(n)},se=function(){j&&j.setVisibility(!1),E=!1,q(),T.setVisibility(!0),K(D.getDataPreference()),he("EndBoxChanged")},ce=function(){se(),H.endManipulation(),H.display()},ue=function(e){if(E)return!0;var i=null,n=null,r=null;switch(e){case 0:i=p,n=x,r=g;break;case 1:i=p,n=h,r=x;break;case 2:i=p,n=g,r=h;break;case 3:i=(new t.Vector3).copy(p).add(g),n=x,r=h;break;case 4:i=(new t.Vector3).copy(p).add(x),n=h,r=g;break;case 5:i=(new t.Vector3).copy(p).add(h),n=g,r=x}var a=(new t.Vector3).copy(n);a.cross(r),a.normalize(),a.setLength(.05);var o=(new t.Vector3).copy(i).sub(a),d=ie(o,n,r,9689341,6543615,e),s=l.createMeshNode(d);s.excludeFromCSO(!0),s.excludeFromHighlight(!0),s.setSSAO(!1),s.setShadow(!1,!1),F.removeChildren(),F.add(s),ae(e),j.setVisibility(!0),w.render()},ge=function(){E||(j.setVisibility(!1),F.removeChildren(),w.render())},xe=function(e){ee();for(var t=0;t<6;t++)t!==e&&te(t,y,C)},he=function(e){return G.publish({event:e,context:this,data:D.getDataPreference()})},pe=function(){var e;for(F.removeChildren(),E=!1,e=0;e<6;e++)R[e]&&R[e].unlink(M[e]),R[e]=null,P[e]&&P[e].removeChildren(),P[e]=null;for(S&&(S.removeChildren(),k.remove(S)),P=new Array(6),S=new i,k.addChild(S),R=new Array(6),q(),ee(),e=0;e<6;e++)te(e,y,C);w.render()}}})})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CoreEvents/Events"],(function(e,t){"use strict";let i;var n=e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}});return n.Check=function(e,n){i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext(),i&&t.publish({event:"CATRelatedData3DGridAutoOriginHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","true"),e()},n.Uncheck=function(e,n){i||(i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext()),i&&t.publish({event:"CATRelatedData3DGridAutoOriginHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false"),e()},n})),define("DS/CATRelatedData3DGrid/CATRelatedData3DGrid",[],(function(){})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridRemoveOverloadCmd",["DS/CATWebUXComponents/DMUCommand","DS/CoreEvents/Events"],(function(e,t){"use strict";let i,n;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),n=this},beginExecute:function(){i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0,i&&t.publish({event:n.getId()+"/BEGIN",data:n})},cancelExecute:function(){i||(i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0),i&&t.publish({event:n.getId()+"/END",data:n}),i=void 0,this.done()}})})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCancelCmd",["DS/CATWebUXComponents/DMUCommand"],(function(e){"use strict";return e.extend({init:function(){},beginExecute:function(){window.console.log("Cancel edit"),this.done()}})})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CoreEvents/Events"],(function(e,t){"use strict";let i;var n=e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}});return n.Check=function(e,n){i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext(),i&&t.publish({event:"CATRelatedData3DGridAutoFitHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","true"),e&&e()},n.Uncheck=function(e,n){i||(i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext()),i&&t.publish({event:"CATRelatedData3DGridAutoFitHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","false"),e&&e()},n})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/CoreEvents/Events"],(function(e,t,i){"use strict";let n,r;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),r=this},beginExecute:function(){n=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0,t.get().setRobotVisibility(!1),n&&(i.publish({event:r.getId()+"/BEGIN",data:r}),i.subscribe({event:"onCancelEdit"},(()=>{r.cancelExecute()})))},cancelExecute:function(){n||(n=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0),t.get().setRobotVisibility(!0),n&&i.publish({event:r.getId()+"/END",data:r}),n=void 0,this.done()}})})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridPropertiesCmd",["DS/CATWebUXComponents/DMUCommand","DS/CoreEvents/Events"],(function(e,t){"use strict";let i,n;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),n=this},beginExecute:function(){i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0,i&&(t.publish({event:n.getId()+"/BEGIN",data:n}),t.subscribe({event:n.getId()+"/CANCEL"},(()=>{n.cancelExecute()})))},cancelExecute:function(){i||(i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0),i&&t.publish({event:n.getId()+"/END",data:n}),i=void 0,this.done()}})})),
/*!  Copyright 2024 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridDMUObject",["DS/DMUBaseExperience/DMUObject","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";let i=[{name:"sType",type:"string",JSONname:"type"},{name:"sPitch",type:"float",JSONname:"pitch",isOverloadable:!0},{name:"sLabelPrefixX",type:"string",JSONname:"LabelPrefixX",defaultValue:"L",isOverloadable:!0},{name:"sLabelPrefixY",type:"string",JSONname:"LabelPrefixY",defaultValue:"W",isOverloadable:!0},{name:"sLabelPrefixZ",type:"string",JSONname:"LabelPrefixZ",defaultValue:"H",isOverloadable:!0},{name:"sScale",type:"int",JSONname:"scale",defaultValue:"1",isOverloadable:!0},{name:"bIsBBOverloaded",type:"bool",JSONname:"IsBBOverloaded",defaultValue:!1,isOverloadable:!0},{name:"vBBMin",type:"Vector3",JSONname:"BoundingBoxMin",defaultValue:null,isOverloadable:!0},{name:"vBBMax",type:"Vector3",JSONname:"BoundingBoxMax",defaultValue:null,isOverloadable:!0},{name:"idxLockedOrigin",type:"int",JSONname:"LockedOriginIndex",defaultValue:0,isOverloadable:!0}];return class extends e{constructor(e,n){super(e,n),this.addParameters(i),this._type="3DGrid",this.setAttribute("sType","3DGrid"),this.getType=function(){return this._type},this.setGridOverload=function(e,t){var i=[];i.push({attribute:"bIsBBOverloaded",value:e}),e?(i.push({attribute:"vBBMin",value:t.min?t.min:null}),i.push({attribute:"vBBMax",value:t.max?t.max:null})):(i.push({attribute:"vBBMin",value:null}),i.push({attribute:"vBBMax",value:null})),this.set(i)},this.importData=function(e){if(e){var i=[];i.push({attribute:"sPitch",value:e.pitch}),i.push({attribute:"sLabelPrefixX",value:e.LabelPrefixX}),i.push({attribute:"sLabelPrefixY",value:e.LabelPrefixY}),i.push({attribute:"sLabelPrefixZ",value:e.LabelPrefixZ}),i.push({attribute:"sScale",value:e.scale}),i.push({attribute:"bIsBBOverloaded",value:e.IsBBOverloaded}),i.push({attribute:"vBBMin",value:e.BoundingBoxMin?(new t.Vector3).setFromArray(e.BoundingBoxMin):null}),i.push({attribute:"vBBMax",value:e.BoundingBoxMax?(new t.Vector3).setFromArray(e.BoundingBoxMax):null}),i.push({attribute:"idxLockedOrigin",value:e.LockedOriginIndex}),this.set(i)}},this.afterImport=function(){this.fireEvent("onDMUObjectInitialized",{dmuObject:this})}}}})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridView",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/CanvasNodeTexture","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/CATWebUXComponents/DMUCommandsManager","DS/Manipulators/HandlePointManipulator","DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridPropertiesCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridRemoveOverloadCmd","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/SpinBox","DS/Controls/LineEditor","DS/CATRelatedData3DGrid/CATRelatedData3DGridDMUObject","i18n!DS/CATRelatedData3DGrid/assets/nls/CATRelatedData3DGrid","css!DS/CATRelatedData3DGrid/assets/css/CATRelatedData3DGrid"],(function(e,t,i,n,r,a,o,d,l,s,c,u,g,x,h,p,f,m,D,v,b,y,C,w,A,P,M){"use strict";return t.extend({init:function(t){if(!t)return;var V,T=t.viewer,S=t.window,R=t.context,O=[{},{x:"min",y:"min",z:"min"},{x:"max",y:"min",z:"min"},{x:"min",y:"max",z:"min"},{x:"max",y:"max",z:"min"},{x:"min",y:"min",z:"max"},{x:"max",y:"min",z:"max"},{x:"min",y:"max",z:"max"},{x:"max",y:"max",z:"max"}],G=!1,E=!1,B=null,z=null,L=this,U=[],I=JSON.parse(localStorage.getItem("CATRelatedData3DGridDftOrigin"));I||(I={x:"min",y:"min",z:"min"});var N={xStep:t.stepRequiredX,yStep:t.stepRequiredY,zStep:t.stepRequiredZ},F=new i.Matrix4;t.gridMatrix&&(F=t.gridMatrix.clone());var k=t.id,j=void 0===t.isEditable||t.isEditable,H=void 0===t.isLabelManipulable||t.isLabelManipulable,X=t.owner,W=void 0!==t.isAbsoluteMode&&t.isAbsoluteMode,_=t.nbMaxLabel,Y=t.labels?t.labels:{x:"L",y:"W",z:"H"},Z=t.scaleValue?t.scaleValue:1,q=2*Math.round(10*window.devicePixelRatio/2),J=window.widget,K=null;J&&(K=J.getValue("3DGridData")),K?K=JSON.parse(K):(J&&J.addPreference({name:"3DGridData",type:"hidden"}),K={gridList:[]});var Q,$,ee,te,ie=null,ne=!1,re=null,ae=new i.Vector3,oe=null,de=null,le=null,se=null,ce=null,ue=!1,ge=null,xe=null,he=S.getContextualUIManager(),pe=null,fe={},me={},De=null,ve=null,be=null,ye=null,Ce=null,we=null,Ae=null,Pe=null,Me=null,Ve=null,Te=null,Se=null,Re=null,Oe=null,Ge=null,Ee=null,Be=[],ze=[],Le=!1,Ue=[],Ie=[],Ne="#FF8000",Fe=null,ke=0,je=!1;var He=null,Xe=null,We=null,_e=null,Ye=null,Ze=null,qe=["ENOR3D_AP","ENOR3R_AP","ENOR3V_AP","ENOR3D_APWebApp"],Je={width:t.freeZoneDim?t.freeZoneDim.width:0,height:t.freeZoneDim?t.freeZoneDim.height:0,left:t.freeZoneDim?t.freeZoneDim.left:0,right:t.freeZoneDim?t.freeZoneDim.width-t.freeZoneDim.right:0,top:t.freeZoneDim?t.freeZoneDim.top:0,bottom:t.freeZoneDim?t.freeZoneDim.height-t.freeZoneDim.bottom:0},Ke={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3,nls:"mm"},Qe=!1,$e={OriTyp:{att:"idxLockedOrigin",typ:"number"},XPitch:{att:"sPitch",typ:"number"},YPitch:{att:"sPitch",typ:"number"},ZPitch:{att:"sPitch",typ:"number"},XLabel:{att:"sLabelPrefixX",typ:"string"},YLabel:{att:"sLabelPrefixY",typ:"string"},ZLabel:{att:"sLabelPrefixZ",typ:"string"},LabSca:{att:"sScale",typ:"number"},UsrBox:{att:"bIsBBOverloaded",typ:"boolean"},UsrMin:{att:"vBBMin",typ:"number"},UsrMax:{att:"vBBMax",typ:"number"}};function et(e,t,i){$e[t]?typeof i===$e[t].typ?void 0!==e[t]&&e[t]===i||(e[t]=i,e.gridDMUObject&&$e[t]&&e.gridDMUObject.setAttribute($e[t].att,i)):window.console.warn("Grid wrong value type ",i," for property ",t):window.console.warn("Grid unknown property ",t)}function tt(e,t){t.forEach((t=>et(e,t.prop,t.val)))}function it(e,t){if(void 0!==e[t])return e[t];if(e.gridDMUObject&&$e[t]){let i=e.gridDMUObject.getAttribute($e[t].att);return e[t]=i,i}}function nt(e,t){var i=!0;if(Object.keys(e).length===Object.keys(t).length){for(let n in e)if(e[n]!==t[n]){i=!1;break}}else i=!1;return i}function rt(e){for(let t=0;t<O.length;t++)if(nt(e,O[t]))return t}function at(e){var t=e.getHotspot();return t.width=e.hotspotWidth||0,t.height=e.hotspotHeight||0,t}function ot(e){var t;if(e){var n=e.getOrientedBoundingBox?e.getOrientedBoundingBox(new i.Matrix4,T):e.getBoundingBox(null,T,T.getVisibleSpace()?"visibleSpace":"invisibleSpace");t=n&&!n.isNaN()?n:void 0}return t}this.setProps=tt;var dt=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e},lt=function(e,t){var i=e%t;return i>0?e+(t-i):i<0?e-i:e},st=function(e){return 0===(e=parseFloat(e))||isNaN(e)?e:e>0?1:-1},ct=function(e){return e.x<0||e.y<0||e.z<0?-1:1},ut=function(){Fe&&(T.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(Fe),Fe=null)},gt=function(e){e&&(Fe&&ut(),Fe=new D(e.externalPath[0]),T.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(Fe))},xt=function(e,t){Fe&&e&&t&&("color"===t.type?Fe.createOverride(e).setColor(t.value):"pickability"===t.type&&Fe.createOverride(e).setPickability(t.value))},ht=function(e,t,i){var n=e.getContext("2d"),r=e.height-2;n.font=q+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,r);for(var a=B.childNodes.length-1;a>=0;a--)B.childNodes[a].label.name===t&&((n=B.childNodes[a].getContext("2d")).font=q+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,r))},pt=function(e){for(var t=new v,i=[],n=e;n&&!n.notAllowedInPathElement;)i.splice(0,0,n),n=n.parents[0];return t.setFromArray(i),t},ft=function(e){var t,i;if(e.preactivated&&(i=e.preactivated.path.externalPath.length),se=e.preactivated?e.preactivated.path.externalPath[i-2]:e.currentTarget.label,ce=e.currentTarget,se){var n=se.canvasNodeTexture;n.isHighlighted=!0,n.requestRedraw(),ce&&ht(ce,se.name,Ne);var r=e.preactivated?e.preactivated.path:null;if(r)for(;r&&-1===r.getLastElement(!0).name.indexOf("3D Grid");)r=r.getParentPath();else if(X)for(t=0;t<U.length;t++)U[t].grid.name===e.currentTarget.label.gridID&&(r=pt(X)).addElement(U[t].grid);else for(t=0;t<U.length;t++)U[t].grid.name===e.currentTarget.label.gridID&&(r=new v).addElement(U[t].grid);gt(r);var a=r.getChildrenPathes();for(t=0;t<a.length;t++)for(var o=a[t].getChildrenPathes()[0].getChildrenPathes(),d=0;d<o.length;d++)o[d].getLastElement(!0).relatedLabel&&n.labelValue&&o[d].getLastElement(!0).relatedLabel.prefix===n.labelValue.prefix&&o[d].getLastElement(!0).relatedLabel.value===n.labelValue.value&&(xt(o[d],{type:"color",value:Ne}),ne||o[d].getLastElement(!0).setNoZ(!0),Ue.push(o[d].getLastElement(!0)));T.render()}},mt=function(){if(se){var e=se.canvasNodeTexture;if(e.isHighlighted=!1,e.requestRedraw(),ce&&ht(ce,se.name,xe),se=null,ut(),!ne)for(var t=0;t<Ue.length;t++)Ue[t].setNoZ(!1);Ue.splice(0,Ue.length),T.render()}},Dt=function(e){if(ke<2&&ke++,2===ke&&!$&&(ke=4,T.currentViewpoint.getControl()._changeState(3),($={}).eyePosition=T.currentViewpoint.getEyePosition(),$.upDirection=T.currentViewpoint.getUpDirection(),$.sightDirection=T.currentViewpoint.getSightDirection(),$.distanceToTarget=T.currentViewpoint.getTargetDistance(),ft(te?{currentTarget:te}:{preactivated:{path:e.paths[0]}}),2===Ue.length)){var t=(new i.Vector3).copy(Ue[0].explicitBBox.min),n=(new i.Vector3).copy(Ue[0].explicitBBox.max);t.applyMatrix4(Ue[0].getMatrix()),n.applyMatrix4(Ue[0].getMatrix());var a,d=(new i.Vector3).copy(Ue[1].explicitBBox.min),l=(new i.Vector3).copy(Ue[1].explicitBBox.max);if(d.applyMatrix4(Ue[1].getMatrix()),l.applyMatrix4(Ue[1].getMatrix()),te){for(var s=0;s<U.length;s++)if(U[s].grid.name===te.label.gridID){a=U[s].grid.getMatrix();break}}else a=e.paths[0].externalPath[0].getMatrix();t.applyMatrix4(a),n.applyMatrix4(a),d.applyMatrix4(a),l.applyMatrix4(a);var c=t,u=new i.Vector3,g=new i.Vector3;c.x===d.x&&c.y===d.y&&c.z===d.z||c.x===l.x&&c.y===l.y&&c.z===l.z?u=(new i.Vector3).subVectors(n,t):(c=n,u=(new i.Vector3).subVectors(t,c)),c.x===d.x&&c.y===d.y&&c.z===d.z?g.subVectors(l,c):g.subVectors(d,c),ee&&(T.removeNode(ee),ee=null),(ee=function(e,t,n,a,d){var l=new o.PrimitiveGroup;l.noz=!1,l.fillAttr=new o.FillAttributes,l.lineAttr=new o.LineAttributes,l.pointAttr=new o.PointAttributes;var s=new o.Buffer;s.size=12,s.component=o.VertexComponentEnum.POSITION,s.format=o.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(12);var c=new o.Buffer;c.indexBuffer=!0,c.size=4,c.format=o.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(4),c.data[0]=0,c.data[1]=1,c.data[2]=3,c.data[3]=2;var u=new o.Buffer;u.size=3,u.component=o.VertexComponentEnum.NORMAL,u.format=o.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(3),u.data[0]=0,u.data[1]=0,u.data[2]=1;var g=new o.Buffer;g.indexBuffer=!0,g.size=4,g.format=o.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(4),g.data[0]=0,g.data[1]=0,g.data[2]=0,g.data[3]=0,l.addBuffer(0,s),l.addBuffer(1,c),l.addBuffer(2,u),l.addBuffer(3,g);var x=s.data,h=0;x[h++]=e.x,x[h++]=e.y,x[h++]=e.z;var p=(new i.Vector3).copy(e).add(t);x[h++]=p.x,x[h++]=p.y,x[h++]=p.z,p=(new i.Vector3).copy(e).add(t).add(n),x[h++]=p.x,x[h++]=p.y,x[h++]=p.z,p=(new i.Vector3).copy(e).add(n),x[h++]=p.x,x[h++]=p.y,x[h++]=p.z;var f=new o.Primitive;f.nbIndices=4,f.connectivity=o.ConnectivityTypeEnum.TRIANGLE_STRIP;var m=new i.MeshBasicMaterial({side:i.DoubleSide,color:a,opacity:d,transparent:!0});f.material=m;var D=new o.VertexComponent;D.component=o.VertexComponentEnum.POSITION,D.nbVertices=4,D.nbValuesPerVertex=3,D.format=o.DataTypeEnum.FLOAT,D.cardinality=0,D.bufferId=0,D.indices=new o.IndexArray,D.indices.format=o.DataTypeEnum.UINT,D.indices.bufferId=1,D.indices.offset=0;var v=new o.VertexComponent;v.component=o.VertexComponentEnum.NORMAL,v.nbVertices=4,v.nbValuesPerVertex=3,v.format=o.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=2,v.indices=new o.IndexArray,v.indices.format=o.DataTypeEnum.UINT,v.indices.bufferId=3,v.indices.offset=0,f.addVertexComponent(D),f.addVertexComponent(v),l.addPrimitive(f);var b=r.createMeshNode(l);return b.setSSAO(!1),b.setShadow(!1,!1),b.excludeFromCSO(!0),b.excludeFromHighlight(!0,!0),b.setMatrix(F),b}(c,u,g,16744448,.5)).name="Box_PreviewPlane",T.addNode(ee)}},vt=function(e){je=!0,setTimeout((function(){je&&(ke=2,Dt(e))}),100)},bt=function(){je=!1,te&&(te=null),$&&(T.currentViewpoint.getControl()._changeState(-1),T.currentViewpoint.moveTo({eyePosition:$.eyePosition,upDirection:$.upDirection,sightDirection:$.sightDirection,distanceToTarget:$.distanceToTarget,duration:100}),$=null),ee&&(T.removeNode(ee),ee=null,mt()),ke=0},yt=function(e){ke=0,je=!1,"touch"===(e.type?e.type:e.event.from[0].type).indexOf!==-1&&(Ve&&(clearTimeout(Ve),mt(),Ve=null),Ve=setTimeout((function(){mt(),Ve=null}),1e3),ft(te?{currentTarget:te}:{preactivated:{path:e.intersection.path[0]}}));for(var t=te?te.label.gridID:e.intersection?e.intersection.path[0].externalPath[0].name:e.gesture.currentEvent[0].view.label.gridID,i=0;i<U.length;i++)if(U[i].grid.name===t){oe=U[i];break}Te&&Te.setState(!it(oe,"UsrBox")),De&&(De=s.getCommand("CATRelatedData3DGridEditHdr",R.getCommandContext()));var n=[];let r=oe.gridDMUObject.getParent();n=r&&r.getCurrentSlide?[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"},{name:"CATRelatedData3DGridRemoveOverload",line:1,hdr_list:["CATRelatedData3DGridRemoveOverloadHdr"],type:"handler",identifier:"CATRelatedData3DGridRemoveOverloadHdr"}]:[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"}],R.getExecutionContext?he._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:n}}},context:R.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}):he.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:n}},context:R.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}),te&&(te=null)},Ct=function(e){var t;e.stopPropagation(),e.preventDefault(),-1!==e.type.indexOf("touch")?("function"==typeof window.UIEvent?t=new window.UIEvent(e.type):(t=document.createEvent("UIEvent")).initUIEvent(e.type,!0,!0,window,1),t.touches=e.touches,t.changedTouches=e.changedTouches):"function"==typeof window.MouseEvent?t=new MouseEvent(e.type,{bubbles:!0,cancelable:!0,view:window,clientX:e.clientX,clientY:e.clientY,screenX:e.clientX,screenY:e.clientY,button:0}):(t=document.createEvent("MouseEvent")).initMouseEvent(e.type,!0,!0,window,1,0,0,e.clientX,e.clientY,!1,!1,!1,!1,0,null),t._simul=!0===l._ODTMode||void 0,T.canvas.dispatchEvent(t)},wt=function(e){je=!0,te=e.currentTarget,ke=0,setTimeout((function(){je&&te&&(ke=2,"Touch"===e.type&&Ct(e),Dt())}),100)},At=function(e){e.stopPropagation(),e.preventDefault(),te&&Ct(e)},Pt=function(e){te&&!ke?yt(e):bt()},Mt=function(e,t){var n;e.setVisibility(!0);var r,a,o,d=(new i.Matrix4).multiplyMatrices(t,e.getMatrix()),l=(new i.Vector3).getPositionFromMatrix(d),s=T.currentViewpoint.project(l),c=s.clone(),u=Je.width-Je.right,g=Je.height-Je.bottom,x=Je.left,h=Je.top,p=at(e);function f(e){e.x-=p.x,e.y+=p.y;var t=Je.left+(u-Je.left)/2,i=Je.top+(g-Je.top)/2;e.x<=t/2&&e.y<=i/2?e.y-=p.height:e.x>t/2&&e.y>i/2?e.x+=p.width:e.x>t/2&&e.y<=i/2&&(e.x+=p.width,e.y-=p.height)}if(f(c),c.x<x||c.y<h||c.x>u||c.y>g||Math.abs(c.z)>1){e.setVisibility(!1);var m,D,v=new i.Vector2(-1,-1),b=(new i.Vector3).copy(e.boundaries[0]).applyMatrix4(t),y=(new i.Vector3).copy(e.boundaries[1]).applyMatrix4(t);if(m=b.x===l.x&&b.y===l.y&&b.z===l.z?s:T.currentViewpoint.project(b),D=y.x===l.x&&y.y===l.y&&y.z===l.z?s:T.currentViewpoint.project(y),Math.abs(m.z)>1&&Math.abs(D.z)>1)return n;if(Math.abs(m.z)>1||Math.abs(D.z)>1){var C=new i.Line3(b,y),w=T.currentViewpoint.getSightDirection().setLength(T.currentViewpoint.camera.near),A=T.currentViewpoint.getEyePosition().add(w),P=(new i.Plane).setFromNormalAndCoplanarPoint(T.currentViewpoint.getSightDirection(),A).intersectLine(C);if(!P)return n;Math.abs(m.z)>1?(m=T.currentViewpoint.project(P),b.x===l.x&&b.y===l.y&&b.z===l.z&&f(c=m.clone())):(D=T.currentViewpoint.project(P),y.x===l.x&&y.y===l.y&&y.z===l.z&&f(c=D.clone()))}if(m.x<x&&D.x<x||m.x>u&&D.x>u||m.y<h&&D.y<h||m.y>g&&D.y>g)return n;var M=D.x-m.x!=0?(D.y-m.y)/(D.x-m.x):"infinity";M="infinity"!==M?Math.round(100*M)/100:"infinity",Math.abs(M)>1e7&&(M="infinity");var V=Math.round("infinity"!==M?m.y-m.x*M:m.y);if(c.y<=h){if(0===M)return n;if(c.x>x&&c.x<u)v.x="infinity"!==M?-1*V/M:m.x,v.y=h;else if(c.x<=x){if("infinity"===M)return n;M*x+V>h&&M*x+V<g?(v.x=x,v.y=M*x+V):(v.x=-1*V/M,v.y=h)}else{if("infinity"===M)return n;M*u+V>h&&M*u+V<g?(v.x=u,v.y=M*u+V):(v.x=-1*V/M,v.y=h)}}else if(c.y>=g){if(0===M)return n;if(c.x>x&&c.x<u)v.x="infinity"!==M?(g-V)/M:m.x,v.y=g;else if(c.x<=x){if("infinity"===M)return n;M*x+V>h&&M*x+V<g?(v.x=x,v.y=M*x+V):(v.x=(g-V)/M,v.y=g)}else{if("infinity"===M)return n;M*u+V>h&&M*u+V<g?(v.x=u,v.y=M*u+V):(v.x=(g-V)/M,v.y=g)}}else if(c.x<=x){if("infinity"===M)return n;c.y>h&&c.y<g&&(v.x=x,v.y=0!==M?M*x+V:m.y)}else if(c.x>=u){if("infinity"===M)return n;c.y>h&&c.y<g&&(v.x=u,v.y=0!==M?M*u+V:m.y)}if(v.x>=x&&v.y>=h&&v.x<=u&&v.y<=g&&v.x>=Math.min(m.x,D.x)-p.width&&v.y>=Math.min(m.y,D.y)-p.height&&v.x<=Math.max(m.x,D.x)+p.width&&v.y<=Math.max(m.y,D.y)+p.height){v.x=Math.floor(v.x),v.y=Math.floor(v.y);for(var S=0;S<ze.length;S++)if(ze[S].label.name===e.name&&null===ze[S].isUsed&&ze[S].label.gridID===e.gridID){n=ze[S];break}n||(r=e.canvasNodeTexture._canvas2DCanvas,a=document.createElement("canvas"),o=a.getContext("2d"),a.width=r.width,a.height=r.height,o.drawImage(r,0,0),(n=a).style.transform="scale("+1/window.devicePixelRatio+")",n.className="Grid3D_AnchoredLabel",n.style.position="absolute",n.ondrag=function(){},n.label=e,H&&(n.addEventListener("mouseenter",ft),n.addEventListener("mouseleave",mt),n.addEventListener("mousedown",wt),n.addEventListener("mousemove",At),n.addEventListener("mouseup",Pt),n.addEventListener("touchstart",wt),n.addEventListener("touchmove",At),n.addEventListener("touchend",Pt)),ze.push(n)),n.isUsed=!0,n.style.visibility="";var R=0,O=0;v.x===x&&(R=-5,O=n.height/2),v.y===h&&(R=n.width/2,O=-5),v.x===u&&(R=n.width+5,O=n.height/2),v.y===g&&(R=n.width/2,O=n.height+5),R=Math.floor(R),O=Math.floor(O),n.position2D={x:v.x,y:v.y},n.offset2D={x:R,y:O},n.style.top=v.y-O+"px",n.style.left=v.x-R+"px",n.parentNode||B.appendChild(n)}}return n},Vt=function(e){var t,n,r,a,o,d,l,s,c;if(B){if(e)for(ze.splice(0,ze.length);B.firstChild;)B.removeChild(B.firstChild);else{for(t=B.childNodes.length-1;t>=0;t--)B.childNodes[t].style.visibility="hidden";for(t=0;t<ze.length;t++)ze[t].isUsed=null}var u=[],g=[];for(t=0;t<U.length;t++)if(U[t].grid&&U[t].grid.isVisible())for(var x=(new i.Matrix4).multiplyMatrices(U[t].grid.getMatrix(),F),h=0;h<U[t].grid.children.length;h++)if(U[t].grid.children[h].isVisible()){var p=U[t].grid.children[h].children[1];if(p&&p.isVisible())for(var f=0;f<p.children.length;f++){var m=p.children[f];if(m.isVisible())for(var D=0;D<m.children.length;D++){var v=Mt(m.children[D],x);if(v){var b="x:"+v.position2D.x+", y:"+v.position2D.y,y=u.indexOf(b);-1!==y&&(n=v,r=g[y],a=void 0,o=void 0,d=void 0,l=void 0,s=void 0,c=void 0,a=0,o=0,d=Je.width-Je.right,l=Je.height-Je.bottom,s=Je.left,c=Je.top,n.position2D.x===s&&(a=-5-r.width),n.position2D.y===c&&(o=-5-r.height),n.position2D.x===d&&(a=r.width+5),n.position2D.y===l&&(o=r.height+5),n.style.top=n.position2D.y-n.offset2D.y-o+"px",n.style.left=n.position2D.x-n.offset2D.x-a+"px"),u.push(b),g.push(v)}}}}}},Tt=function(e){var t={};return e.xAxis<0?t.x="max":t.x="min",e.yAxis<0?t.y="max":t.y="min",e.zAxis<0?t.z="max":t.z="min",t},St=function(e){if(e.grid){var t={origin:(new i.Vector3).copy(e.gridDataPreference.origin),xAxis:Math.abs(e.gridDataPreference.xAxis),yAxis:Math.abs(e.gridDataPreference.yAxis),zAxis:Math.abs(e.gridDataPreference.zAxis)};e.gridDataPreference.xAxis<0&&(t.origin.x+=e.gridDataPreference.xAxis),e.gridDataPreference.yAxis<0&&(t.origin.y+=e.gridDataPreference.yAxis),e.gridDataPreference.zAxis<0&&(t.origin.z+=e.gridDataPreference.zAxis),t.origin.applyMatrix4(e.grid.getMatrix());var n=new i.Vector3(0,t.yAxis,0),r=new i.Vector3(t.xAxis,0,0);n.applyMatrix4(F),r.applyMatrix4(F);var a=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(t.xAxis,0,0),r=new i.Vector3(0,0,t.zAxis),n.applyMatrix4(F),r.applyMatrix4(F);var o=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(0,0,t.zAxis),r=new i.Vector3(0,t.yAxis,0),n.applyMatrix4(F),r.applyMatrix4(F);var d=(new i.Vector3).crossVectors(n,r),l=T.currentViewpoint.getSightDirection();return l.dot(a)<0&&l.dot(o)>0&&l.dot(d)>0?t.zAxis=-t.zAxis:l.dot(a)>0&&l.dot(o)<0&&l.dot(d)>0?t.yAxis=-t.yAxis:l.dot(a)>0&&l.dot(o)>0&&l.dot(d)<0?t.xAxis=-t.xAxis:l.dot(a)<0&&l.dot(o)<0&&l.dot(d)>0?(t.yAxis=-t.yAxis,t.zAxis=-t.zAxis):l.dot(a)>0&&l.dot(o)<0&&l.dot(d)<0?(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis):l.dot(a)<0&&l.dot(o)>0&&l.dot(d)<0?(t.xAxis=-t.xAxis,t.zAxis=-t.zAxis):l.dot(a)<0&&l.dot(o)<0&&l.dot(d)<0&&(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis,t.zAxis=-t.zAxis),Tt(t)}},Rt=function(e){if(e.grid&&0===it(e,"OriTyp"))if(ue&&ie&&e===oe)ie.updateAutomaticCorner();else{var t=St(e),i=Tt(e.gridDataPreference);t.x===i.x&&t.y===i.y&&t.z===i.z||(e.bBox?L.drawGrids({specifications:[{BBox:e.bBox}]}):e.root&&L.drawGrids({rootPaths:[e.root]}))}},Ot=function(e){var t=new i.Vector2(0,0),n=e.positionOnAxis;return"left"===e.anchor?"first"===n?t.x=e.width:"last"===n?(t.x=e.width,t.y=e.height):(t.x=e.width,t.y=e.height/2):"right"===e.anchor?"last"===n?t.y=e.height:"first"!==n&&(t.y=e.height/2):"top"===e.anchor?"first"===n?t.y=-e.height/3:"last"===n?(t.x=e.width,t.y=-e.height/3):(t.x=e.width/2,t.y=-e.height/3):"bottom"===e.anchor&&("first"===n?t.y=4*e.height/3:"last"===n?(t.x=e.width,t.y=4*e.height/3):(t.x=e.width/2,t.y=4*e.height/3)),t.x=Math.round(10*t.x)/10,t.y=Math.round(10*t.y)/10,e.node&&(e.node.hotspotWidth=e.width,e.node.hotspotHeight=e.height),t},Gt=function(e){var t=e.isFirst?"first":!1===e.hasNext?"last":"else",i="xAxis"===e.axis&&e.axisOrientation>0||"xAxis"!==e.axis&&e.axisOrientation<0;return e.planeSightOrientation.side&&(i=!i),-1!==e.planeID.indexOf("yx")?e.planeSightOrientation.top||"left"!==e.labelPositionOnGrid&&"right"!==e.labelPositionOnGrid||(i=!i):-1===e.planeID.indexOf("yz")&&-1===e.planeID.indexOf("xz")||e.planeSightOrientation.top||"top"!==e.labelPositionOnGrid&&"bottom"!==e.labelPositionOnGrid||(i=!i),i&&"else"!==t&&(t="first"===t?"last":"first"),t},Et=function(e){var t=(new i.Vector3).copy(e.plane.localYAxis).clone().normalize(),n=T.currentViewpoint.getSightDirection(),r=T.currentViewpoint.getUpDirection(),a=(new i.Vector3).crossVectors(n,r),o=t.projectOnPlane(a),d=0!==o.x||0!==o.y||0!==o.z?o.angleTo(r):0,l={},s={},c=st(e.plane.normal.dot(n));s.top=c>0,s.side=!1,c>0?(l.localYAxis="left",l.oppositeLocalYAxis="right",l.localXAxis="bottom",l.oppositeLocalXAxis="top"):-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?(l.localYAxis="right",l.oppositeLocalYAxis="left",l.localXAxis="bottom",l.oppositeLocalXAxis="top"):(l.localYAxis="left",l.oppositeLocalYAxis="right",l.localXAxis="top",l.oppositeLocalXAxis="bottom");var u=!1,g=null,x=null;return-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?ct(e.plane.localYAxis)>0?(g=Math.PI/2,x=Math.PI):(g=0,x=Math.PI/2):ct(e.plane.localYAxis)===c?(g=0,x=Math.PI/2):(g=Math.PI/2,x=Math.PI),d&&d>=g&&d<=x&&(u=!0,s.side=!0),u&&(l.localXAxis="bottom"===l.localXAxis?"top":"bottom",l.oppositeLocalXAxis="top"===l.oppositeLocalXAxis?"bottom":"top",l.localYAxis="right"===l.localYAxis?"left":"right",l.oppositeLocalYAxis="left"===l.oppositeLocalYAxis?"right":"left"),l.planeSightOrientation=s,l},Bt=function(e){for(var t=Et({plane:e}),i=e.getChildByName("Labels").children,n=0;n<i.length;n++)if(i[n].isVisible())for(var r=i[n].children,a=0;a<r.length;a++){var o=at(r[a]),d=Gt({axis:r[a].axis,axisOrientation:r[a].axisOrientation,isFirst:r[a].labelIsFirst,hasNext:r[a].labelHasNext,labelPositionOnGrid:t[i[n].getName()],planeSightOrientation:t.planeSightOrientation,planeID:e.getName()});r[a].labelIsFirst&&r[a].labelHasNext&&Ie.push({node:r[a]});var l=Ot({node:r[a],anchor:t[i[n].getName()],width:o.width,height:o.height,positionOnAxis:d});l.x===o.x&&l.y===o.y&&l.width===o.width&&l.height===o.height||r[a].setHotspot(l)}},zt=function(e){var t=e.plane.getChildByName("Labels"),i="",n="";-1!==e.plane.getName().indexOf("yx")?(i=ct(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis",t.getChildByName(i).setVisibility(e.flag),n=ct(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("yz")?(i=ct(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=ct(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("xz")&&(i=ct(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=ct(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis",t.getChildByName(n).setVisibility(e.flag))},Lt=function(e){if(e.grid){var t;if(0===e.gridDataPreference.xAxis||0===e.gridDataPreference.yAxis||0===e.gridDataPreference.zAxis)for(t=0;t<e.grid.children.length;t++)zt({plane:e.grid.children[t],flag:!0});else{var i=null;for(t=0;t<e.grid.children.length;t++){var n;if((n=T.currentViewpoint.getSightDirection().clone().projectOnPlane(e.grid.children[t].normal.applyMatrix4(F))).x=parseFloat(n.x.toFixed(4)),n.y=parseFloat(n.y.toFixed(4)),n.z=parseFloat(n.z.toFixed(4)),0===n.x&&0===n.y&&0===n.z){i=e.grid.children[t].name;break}}if(i){for(e.grid.setNoZ(!0),t=0;t<e.grid.children.length;t++)e.grid.children[t].setVisibility(i===e.grid.children[t].name),i===e.grid.children[t].name&&(zt({plane:e.grid.children[t],flag:!0}),Bt(e.grid.children[t]));ne=!0,re=i}}T.render()}},Ut=function(){for(var e,t,n=0;n<Ie.length;n++)if(!Ie[n].updated){var r=at(t=Ie[n].node),a=(new i.Vector3).getPositionFromMatrix(t.getMatrix()),o=[];for(e=0;e<Ie.length;e++)if(n!==e){var d=(new i.Vector3).getPositionFromMatrix(Ie[e].node.getMatrix());if(d.x===a.x&&d.y===a.y&&d.z===a.z){var l=at(Ie[e].node);l.y<r.y-r.height||r.y-r.height>l.y||l.x<r.x-r.width||r.x-r.width>l.x||o.push(e)}}if(1===o.length){o.push(n);var s=0;for(e=0;e<o.length;e++){var c=at(t=Ie[o[e]].node),u=new i.Vector2;u.x=c.width/2,u.y=s,t.hotspotWidth=c.width,t.hotspotHeight=c.height,u.x===c.x&&u.y===c.y||t.setHotspot(u),s+=c.height,s+=3,Ie[o[e]].updated=!0}}Ie[n].updated=!0}},It=function(e){var t,i;if(-1!==e.eventType.indexOf("@onViewpoint")){var n=T.currentViewpoint.getSightDirection();if("@onViewpointBeginMove"===e.eventType)ge=!0,mt(),Le=!0;else if("@onViewpointChange"===e.eventType){if(null===ge&&(ge=!0),!n.equals(ae)){if(ne){for(t=0;t<U.length;t++)for(U[t].grid.setNoZ(!1),i=0;i<U[t].grid.children.length;i++)Bt(U[t].grid.children[i]),zt({plane:U[t].grid.children[i],flag:!1}),U[t].grid.children[i].setVisibility(!0);ne=!1,re=null}for(t=0;t<U.length;t++)Lt(U[t]);ae.copy(n)}if(!$)for(t=0;t<U.length;t++)Rt(U[t]);Vt(ge),ge=!1}else if("@onViewpointEndMove"===e.eventType)if(je)bt();else if(ge=null,Le=!1,Vt(!0),!ne){for(Ie.splice(0,Ie.length),t=0;t<U.length;t++)if(U[t].grid)for(i=0;i<U[t].grid.children.length;i++)Bt(U[t].grid.children[i]);Ut()}T.render()}},Nt=function(){if(j){(ie=new z({window:S,stepRequired:it(oe,"XPitch"),lengthUnit:Ke})).display({rootID:b.getNodeID(oe.root.getLastElement(!0)),gridDataPreference:oe.gridDataPreference,matrix:oe.grid.getMatrix(),displayHandlePoints:0!==it(oe,"OriTyp")}),de=ie.subscribe("EndBoxChanged",(function(){et(oe,"UsrBox",!0),Te.setState(!1),he._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:[{type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"}]}}},context:R.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})})),le=ie.subscribe("BoxCornerChanged",(function(){Re.setState(0===it(oe,"OriTyp")),R.getExecutionContext?he._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:[{type:"handler",identifier:"CATRelatedData3DGridAutoOriginHdr"}]}}},context:R.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}):he.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoOrigin",line:1,hdr_list:["CATRelatedData3DGridAutoOriginHdr"]}]}},context:R.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}));var e=function(t){0!==T.pick(T.getMousePosition(t.from[0].currentPosition),"mesh",!1).path.length||T.currentViewpoint.isMoving()||(l.removeEvent(T.canvas,"onPrimaryPointerClick",e),De&&(R.getExecutionContext?d.publish({event:"onCancelEdit"}):De.cancel()))};De=s.getCommand("CATRelatedData3DGridEditHdr",R.getCommandContext()),l.addEvent(T.canvas,"onPrimaryPointerClick",e),pe.disable()}},Ft=function(e){var t;if(e){if(Le&&"Labels"===e.name)return;if(e.material&&(e.material.dispose(),e.material=null,e.canvasNodeTexture&&(e.canvasNodeTexture._canvas2DTexture&&(e.canvasNodeTexture._canvas2DTexture.dispose(),e.canvasNodeTexture._canvas2DTexture=null),e.canvasNodeTexture.materials&&e.canvasNodeTexture.materials.length)))for(t=0;t<e.materials.canvasNodeTexture.length;t++)e.canvasNodeTexture.materials[t].dispose(),e.canvasNodeTexture.materials[t]=null;for(t=e.children.length-1;t>=0;t--)Ft(e.children[t]);e.removeChildren()}},kt=function(e){var t=!0;e.userBox&&(t=!e.userBox);var n=new i.Vector3(e.min.x,e.min.y,e.min.z),r=st(e.max.x-e.min.x),a=st(e.max.y-e.min.y),o=st(e.max.z-e.min.z),d=new i.Vector3(e.min.x,e.min.y,e.min.z),l=e.max.x,s=e.max.y,c=e.max.z;t&&(d.x=r?r>0?dt(n.x,e.step.xStep):lt(n.x,e.step.xStep):0,d.y=a?a>0?dt(n.y,e.step.yStep):lt(n.y,e.step.yStep):0,d.z=o?o>0?dt(n.z,e.step.zStep):lt(n.z,e.step.zStep):0,l=r?r>0?lt(e.max.x,e.step.xStep):dt(e.max.x,e.step.xStep):0,s=a?a>0?lt(e.max.y,e.step.yStep):dt(e.max.y,e.step.yStep):0,c=o?o>0?lt(e.max.z,e.step.zStep):dt(e.max.z,e.step.zStep):0);var u=l-d.x,g=s-d.y,x=c-d.z,h=e.defaultOrigin;return h&&("max"===h.x&&(d.x=d.x+u,u*=-1),"max"===h.y&&(d.y=d.y+g,g*=-1),"max"===h.z&&(d.z=d.z+x,x*=-1)),{origin:d,xAxis:u,yAxis:g,zAxis:x}},jt=function(){for(var e={gridList:[]},t=0;t<U.length;t++)e.gridList.push({rootID:U[t].gridName.split("3D Grid ")[1],gridDataPreference:U[t].gridDataPreference,type:it(U[t],"UsrBox")?"userDefined":"auto",originType:it(U[t],"OriTyp")>0?"userDefined":"auto"});J&&J.setValue("3DGridData",JSON.stringify(e)),localStorage.setItem("CATRelatedData3DGridDftOrigin",JSON.stringify(I))},Ht=function(e){if(oe)if(it(oe,"UsrBox")||e){if(it(oe,"UsrBox")&&e){et(oe,"UsrBox",!1);var t=ot(oe.root),i=null;if(t){var n=Object.assign({},N);if(n.xStep=n.yStep=n.zStep=it(oe,"XPitch"),ue)i=kt({step:n,gridDMUObject:oe.gridDMUObject,min:t.min,max:t.max,defaultOrigin:Tt(ie.getDataPreference())}),ie.setDataPreference(i),ie.refresh();else{i=kt({step:n,gridDMUObject:oe.gridDMUObject,min:t.min,max:t.max,defaultOrigin:Tt(oe.gridDataPreference)}),oe.gridDataPreference=i,L.drawGrids({rootPaths:[oe.root]});var r=[];let e=oe.gridDMUObject.getParent();r=e&&e.getCurrentSlide?[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"},{name:"CATRelatedData3DGridRemoveOverload",line:1,hdr_list:["CATRelatedData3DGridRemoveOverloadHdr"],type:"handler",identifier:"CATRelatedData3DGridRemoveOverloadHdr"}]:[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"}],he._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return R.getExecutionContext?{WAfrCtxBarRow1:{model:r}}:{cmdList:r}},context:R.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}}localStorage.setItem("CATRelatedData3DGridAutoFitCmd","true")}}else et(oe,"UsrBox",!0),jt(),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","false")},Xt=function(e){oe&&(0!==it(oe,"OriTyp")||e?0!==it(oe,"OriTyp")&&e&&(et(oe,"OriTyp",0),ue&&(ie.setHandlePointsVisibility(!1),ie.updateAutomaticCorner()),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","true")):(et(oe,"OriTyp",1),jt(),ue&&ie.setHandlePointsVisibility(!0),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false")))},Wt=function(e,t){var i=e.height-2;t.font=q+"pt sans-serif",t.fillStyle=this.isHighlighted?Ne:xe,t.fillText(this.txtValue,0,i)},_t=function(e){var t,n=Ee.getContext("2d");n.font=q+"pt sans-serif",e.scale<1&&(e.scale=1);var d,l=e.prefix+f.convertUnitValueToString(e.value/e.scale,"Length",Ke.unit,Ke.decimalPlaceRO,Qe,{displaySymbol:!1,displaySpace:!1}),s=Math.round(10*n.measureText(l).width)/10,c=q+2;Ee.width=s,Ee.height=c;var u=e.plane.getName();for(t=0;t<Be.length;t++)if(Be[t].txtValue===l&&Be[t].gridID===e.gridID){d=Be[t].canvasNodeTexture;break}d||((d=new a({width:s,height:c,drawCB:Wt})).txtValue=l,d.labelValue={prefix:e.prefix,value:e.value},Be.push({txtValue:l,canvasNodeTexture:d,gridID:e.gridID}));var g=Et({plane:e.plane});for(t=0;t<e.position.length;t++){var x="";-1!==u.indexOf("yx")?x="yAxis"===e.axis?ct(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis":ct(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("yz")?x="yAxis"===e.axis?ct(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":ct(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("xz")&&(x="xAxis"===e.axis?ct(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":ct(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis"),t>0&&("localXAxis"===x?x="oppositeLocalXAxis":"oppositeLocalXAxis"===x?x="localXAxis":"localYAxis"===x?x="oppositeLocalYAxis":"oppositeLocalYAxis"===x&&(x="localYAxis"));var h=Gt({axis:e.axis,axisOrientation:e.gridData[e.axis],planeID:u,isFirst:e.isFirst,hasNext:e.hasNext,planeSightOrientation:g.planeSightOrientation,labelPositionOnGrid:g[x]}),p=Ot({anchor:g[x],positionOnAxis:h,width:s,height:c}),m=r.createCanvas2DNode({name:l,hotspot:p,canvasNodeTexture:d});m.hotspotWidth=s,m.hotspotHeight=c,m.setMatrix((new i.Matrix4).makeTranslation(e.position[t].x,e.position[t].y,e.position[t].z)),m.setPickable(o.PICKABLE),m.labelIsFirst=e.isFirst,m.gridID=e.gridID,m.labelHasNext=e.hasNext,m.axis=e.axis,m.axisOrientation=e.gridData[e.axis],m.boundaries=[e.position[0].clone(),e.position[1].clone()],e.labels.getChildByName(x).addChild(m),pe&&(fe[e.gridID]||(fe[e.gridID]=[]),fe[e.gridID].push(pe.linkToNode(m))),e.isFirst&&e.hasNext&&Ie.push({node:m})}},Yt=function(){var e=new i.Vector3,t=new i.Vector3,n=new i.Vector3,r=new i.Vector3;F.extractBasis(t,n,r);var a=new i.Vector3(F.elements[12],F.elements[13],F.elements[14]);return e.x=t.dot(a),e.y=n.dot(a),e.z=r.dot(a),e},Zt=function(e){let t={x:it(e.gridData,"XLabel"),y:it(e.gridData,"YLabel"),z:it(e.gridData,"ZLabel")},r=it(e.gridData,"LabSca");var a,o=Object.assign({},N);j&&(o.xStep=o.yStep=o.zStep=it(e.gridData,"XPitch")),Ie.splice(0,Ie.length),W&&(a=Yt());for(var d,l=["yx","yz","xz"],s=0;s<l.length;s++){var c=e.gridData.gridDataPreference,u=l[s].charAt(0),g=l[s].charAt(1),x=u+"Axis",h=g+"Axis",p=e.gridData.grid.getChildByName(l[s]+" Plane");if(0!==c[x]&&0!==c[h]&&p){var f=p.getChildByName("Labels");if(f)for(d=0;d<f.children.length;d++)f.children[d].removeChildren();else(f=new n("Labels")).addChild(new n("localXAxis")),f.addChild(new n("localYAxis")),f.addChild(new n("oppositeLocalXAxis")),f.addChild(new n("oppositeLocalYAxis")),p.addChild(f);var m=u+"Step",D=g+"Step",v=st(c[x])<0?dt(c.origin[u],o[m]):lt(c.origin[u],o[m]),b=v,y=0;if(W)for("x"===u&&(b=b=st(v)<0?v+a.x:v-a.x),"y"===u&&(b=b=st(v)<0?v+a.y:v-a.y),"z"===u&&(b=b=st(v)<0?v+a.z:v-a.z);Math.abs(b)>Math.abs(c.origin[u]);)y+=o[m],b=st(b)<0?b+=o[m]:b-=o[m];var C,w,A=0;for(d=0;Math.abs(b+d*st(c[x])-c.origin[u])<=Math.abs(c[x]);d+=o[m])0!==A&&A%e.gridData.labelRatio!=0&&A!==e.labelsInfos[l[s]].fstAxis||(C=(new i.Vector3).copy(c.origin),w=(new i.Vector3).copy(c.origin),C[u]=b+d*st(c[x]),C[g]=c.origin[g],w[u]=b+d*st(c[x]),w[g]=c.origin[g]+c[h],_t({prefix:t[u],value:Math.pow(10,-3)*(v+y+d*st(c[x])),scale:r,isFirst:0===d,hasNext:Math.abs(b+(d+o[m])*st(c[x])-c.origin[u])<=Math.abs(c[x]),position:[C,w],axis:x,labels:f,plane:p,gridData:c,gridID:e.gridData.grid.getName()})),A++;var P=st(c[h])<0?dt(c.origin[g],o[D]):lt(c.origin[g],o[D]),M=0,V=P;if(W)for("x"===g&&(V=V=st(P)<0?P+a.x:P-a.x),"y"===g&&(V=V=st(P)<0?P+a.y:P-a.y),"z"===g&&(V=V=st(P)<0?P+a.z:P-a.z);Math.abs(V)>Math.abs(c.origin[g]);)M+=o[D],V=st(V)<0?V+=o[D]:V-=o[D];for(A=0,d=0;Math.abs(V+d*st(c[h])-c.origin[g])<=Math.abs(c[h]);d+=o[D])0!==A&&A%e.gridData.labelRatio!=0&&A!==e.labelsInfos[l[s]].scdAxis||(C=(new i.Vector3).copy(c.origin),w=(new i.Vector3).copy(c.origin),C[u]=c.origin[u],C[g]=V+d*st(c[h]),w[u]=c.origin[u]+c[x],w[g]=V+d*st(c[h]),_t({prefix:t[g],value:Math.pow(10,-3)*(P+M+d*st(c[h])),scale:r,isFirst:0===d,hasNext:Math.abs(V+(d+o[D])*st(c[h])-c.origin[g])<=Math.abs(c[h]),position:[C,w],axis:h,labels:f,plane:p,gridData:c,gridID:e.gridData.grid.getName()})),A++;ne&&re===p.name?zt({plane:p,flag:!0}):zt({plane:p,flag:!1})}}Ut()},qt=function(e){let t=e.gridDataPreference;if(t){var i=Object.assign({},N);j&&(i.xStep=i.yStep=i.zStep=it(e,"XPitch"));for(var n,r={max:0},a=["yx","yz","xz"],o=0;o<a.length;o++){var d=a[o].charAt(0),l=a[o].charAt(1),s=d+"Axis",c=l+"Axis";if(0!==t[s]&&0!==t[c]){var u=d+"Step",g=l+"Step";r[a[o]]={};var x=0,h=st(t[s])<0?dt(t.origin[d],i[u]):lt(t.origin[d],i[u]);for(n=0;Math.abs(h+n*st(t[s])-t.origin[d])<=Math.abs(t[s]);n+=i[u])x++,r.max++;r[a[o]].fstAxis=x,x=0;var p=st(t[c])<0?dt(t.origin[l],i[g]):lt(t.origin[l],i[g]);for(n=0;Math.abs(p+n*st(t[c])-t.origin[l])<=Math.abs(t[c]);n+=i[g])x++,r.max++;r[a[o]].scdAxis=x}}return r}},Jt=function(e){var t,i=0,n=[];for(t=0;t<U.length;t++)if(U[t].grid&&U[t].gridDMUObject&&U[t].gridDataPreference){var r=qt(U[t]);r&&(n.push(r),i+=r.max)}var a=i,o=1;if(_)for(;i>_;)i=a/++o;for(t=0;t<U.length;t++)U[t].grid&&(U[t].labelRatio!==o||e)&&(U[t].labelRatio=o,Zt({gridData:U[t],labelsInfos:n[t]}));Vt(!0)};function Kt(e){e.forEach((function(e){if("cke"===e.name){let t=!1;e.preferences.forEach((function(e){"Length"===e.name&&Ke.unit!==e.value?(Ke.unit=e.value,t=!0):"LengthCalcDisplay"===e.name&&Ke.decimalPlaceRO!==parseInt(e.value)?(Ke.decimalPlaceRO=parseInt(e.value),t=!0):"TrailingZeros"===e.name&&(Qe=e.value,t=!0)})),t&&(Jt(!0),T.render(),ie&&ie.updateUnit(Ke))}}))}function Qt(){return new Promise((function(e){if(E)return e();f.readPreferences([{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay"]}]).then((function(t){Kt(t.repositories),E=!0,e()})).catch((function(t){window.console.warn("Error Preferences ",t),e()}))}))}var $t=function(){V||(V=Qt()),V.then((function(){ue=!0,gt(t.rootBagPath);for(var e=0;e<U.length;e++)xt(U[e].root,{type:"pickability",value:"NOT_PICKABLE"}),U[e].grid.name===oe.grid.name&&Ft(U[e].grid);for(;B.firstChild;)B.removeChild(B.firstChild);z?Nt():require(["DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle"],(function(e){z=e,Nt()}))})).catch((function(e){window.console.warn("Error Preferences ",e)}))},ei=function(){V||(V=Qt()),V.then((function(){Ze=new y({title:"Properties",content:function(){if(!oe||!oe.gridDMUObject)return;let t=it(oe,"XPitch"),i=it(oe,"XLabel"),n=it(oe,"YLabel"),r=it(oe,"ZLabel"),a=it(oe,"LabSca"),o=new e.Element("div");var d=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(o);d.setStyles({paddingTop:"5px"});var l=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(d);l.innerHTML=M.lblPitch,l.setStyles({width:"50%",fontWeight:"normal",marginRight:"10px"});var s=Ke.unit;(He=new w({value:t,units:f.Length.Millimeter.symbol,minValue:1,maxValue:1e5,stepValue:1})).value=f.convert(t,"Length","Millimeter",Ke.unit),He.units=f.Length[s].symbol,He.inject(d),He.elements.container.setStyles({width:"50%",marginRight:"10px"});var c=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(o);c.innerHTML=M.DirectionLabel,c.setStyles({fontWeight:"bold",marginTop:"5px",marginRight:"5px"});var u=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(o);u.setStyles({paddingTop:"5px"});var g=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(u);g.innerHTML=M.lblDirection1,g.setStyles({width:"50%",fontWeight:"normal",marginLeft:"5px",marginRight:"5px"}),(We=new A({value:i,selectAllOnFocus:!0,autoCommitFlag:!0,maxLength:3}).inject(u)).elements.container.setStyles({width:"50%",marginRight:"10px"});var x=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(o);x.setStyles({paddingTop:"5px"});var h=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(x);h.innerHTML=M.lblDirection2,h.setStyles({width:"50%",fontWeight:"normal",marginLeft:"5px",marginRight:"5px"}),(_e=new A({value:n,selectAllOnFocus:!0,autoCommitFlag:!0,maxLength:3}).inject(x)).elements.container.setStyles({width:"50%",marginRight:"10px"});var p=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(o);p.setStyles({paddingTop:"5px"});var m=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(p);m.innerHTML=M.lblDirection3,m.setStyles({width:"50%",fontWeight:"normal",marginLeft:"5px",marginRight:"5px"}),(Ye=new A({value:r,selectAllOnFocus:!0,autoCommitFlag:!0,maxLength:3}).inject(p)).elements.container.setStyles({width:"50%",marginRight:"10px"});var D=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(o);D.setStyles({paddingTop:"5px"});var v=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(D);return v.innerHTML=M.lblScale,v.setStyles({width:"50%",fontWeight:"normal",marginLeft:"5px",marginRight:"5px"}),(Xe=new w({value:a,minValue:1,maxValue:1e5,stepValue:1}).inject(D)).elements.container.setStyles({width:"50%",marginRight:"10px"}),o}(),buttons:{Ok:new C({label:M.lblOk,onClick:function(){tt(oe,[{prop:"XPitch",val:f.convert(He.value,"Length",Ke.unit,"Millimeter")},{prop:"XLabel",val:We.value.replace(/\s+/g,"").slice(0,3)},{prop:"YLabel",val:_e.value.replace(/\s+/g,"").slice(0,3)},{prop:"ZLabel",val:Ye.value.replace(/\s+/g,"").slice(0,3)},{prop:"LabSca",val:Xe.value}]),L.drawGrids({rootPaths:R.getRootBagPath().getChildrenPathes()}),R.getExecutionContext?ye.cancelExecute():ye.cancel()}}),Apply:new C({label:M.lblApply,onClick:function(){tt(oe,[{prop:"XPitch",val:f.convert(He.value,"Length",Ke.unit,"Millimeter")},{prop:"XLabel",val:We.value.replace(/\s+/g,"").slice(0,3)},{prop:"YLabel",val:_e.value.replace(/\s+/g,"").slice(0,3)},{prop:"ZLabel",val:Ye.value.replace(/\s+/g,"").slice(0,3)},{prop:"LabSca",val:Xe.value}]),L.drawGrids({rootPaths:R.getRootBagPath().getChildrenPathes()})}}),Cancel:new C({label:M.lblClose,onClick:function(){R.getExecutionContext?ye.cancelExecute():ye.cancel()}})}})}))},ti=function(){for(var e=0;e<U.length;e++)if(U[e].grid.name===oe.grid.name){let t=U[e].gridDMUObject.getParent();t&&(t&&t.removeDMUObjects?t.removeDMUObjects([U[e].gridDMUObject]):t&&t.getCurrentSlide()&&(t.getCurrentSlide().removeDMUObject(U[e].gridDMUObject),t.getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:t.getCurrentSlide()})));let i=oe.grid.name;Ft(U[e].grid),T.removeNode(U[e].grid),gi(i),xi(i),hi(i),Ae&&Ae.cancel();break}Ae&&Ae.cancel()};let ii=function(e){if(!e.gridDMUObject)return;let t=e.gridDataPreference.origin,n=(new i.Vector3).setFromArray([t.x+e.gridDataPreference.xAxis,t.y+e.gridDataPreference.yAxis,t.z+e.gridDataPreference.zAxis]);e.gridDMUObject.setAttribute("vBBMin",(new i.Vector3).setFromArray([Math.min(t.x,n.x),Math.min(t.y,n.y),Math.min(t.z,n.z)])),e.gridDMUObject.setAttribute("vBBMax",(new i.Vector3).setFromArray([Math.max(t.x,n.x),Math.max(t.y,n.y),Math.max(t.z,n.z)]))},ni=function(e){if(!e.gridDMUObject||!e.gridDataPreference)return;let t=e.gridDMUObject.getAttribute("vBBMin"),n=e.gridDMUObject.getAttribute("vBBMax");if(t&&n){let r=[n.x-t.x,n.y-t.y,n.z-t.z],a=[0,0,0],o=[0,0,0];switch(it(e,"OriTyp")){case 0:case 1:a[0]=t.x,a[1]=t.y,a[2]=t.z,o[0]=r[0],o[1]=r[1],o[2]=r[2];break;case 2:a[0]=n.x,a[1]=t.y,a[2]=t.z,o[0]=-r[0],o[1]=r[1],o[2]=r[2];break;case 3:a[0]=t.x,a[1]=n.y,a[2]=t.z,o[0]=r[0],o[1]=-r[1],o[2]=r[2];break;case 4:a[0]=n.x,a[1]=n.y,a[2]=t.z,o[0]=-r[0],o[1]=-r[1],o[2]=r[2];break;case 5:a[0]=t.x,a[1]=t.y,a[2]=n.z,o[0]=r[0],o[1]=r[1],o[2]=-r[2];break;case 6:a[0]=n.x,a[1]=t.y,a[2]=n.z,o[0]=-r[0],o[1]=r[1],o[2]=-r[2];break;case 7:a[0]=t.x,a[1]=n.y,a[2]=n.z,o[0]=r[0],o[1]=-r[1],o[2]=-r[2];break;case 8:a[0]=n.x,a[1]=n.y,a[2]=n.z,o[0]=-r[0],o[1]=-r[1],o[2]=-r[2]}e.gridDataPreference.origin=(new i.Vector3).setFromArray(a),e.gridDataPreference.xAxis=o[0],e.gridDataPreference.yAxis=o[1],e.gridDataPreference.zAxis=o[2]}},ri=function(){if(ue){ie.unsubscribe(null),ie.unsubscribe(de),ie.unsubscribe(le);for(var e=0;e<U.length;e++)if(U[e].grid.name===oe.grid.name){ie.isSizeOK()&&(U[e].gridDataPreference=ie.getDataPreference(),et(U[e],"UsrBox",it(oe,"UsrBox")),I=Tt(U[e].gridDataPreference),0!==it(oe,"OriTyp")&&et(U[e],"OriTyp",rt(I)),ii(U[e]));break}ie.clean(),ie=null,ue=!1,ut(),L.drawGrids({rootPaths:[oe.root]}),pe.enable()}};let ai=function(){Ze&&(Ze.destroy(),Ze=null),he&&he.activateContextualBar(),pe&&pe.enable()},oi=function(){he&&he.activateContextualBar(),pe&&pe.enable()};let di=async function(){let e,t=S.getExecutionContext?S.getExecutionContext():void 0;t&&(e=t.getComponent(WAfrStandardComponentKey.HandlerComponent),await e.setCheckState({id:"CATRevealRelatedDataHdr",state:"false"!==localStorage.getItem("CATRevealRelatedDataCmd")}),await e.setCheckState({id:"CATRelatedData3DGridAutoFitHdr",state:"false"!==localStorage.getItem("CATRelatedData3DGridAutoFitCmd")}))};this.setActiveState=function(t){var i;if(t!==G)if(G=t)Ee||(Ee=document.createElement("canvas")),B||(B=e.createElement("div").inject(S.getUIFrame())),Ge=d.subscribe({event:"/VISU/"},It),ae.copy(T.currentViewpoint.getSightDirection()),H&&((pe=new c).setExclusive(!0),me.beginPreactivate=pe.onBeginPreactivate(ft),me.endPreactivate=pe.onEndPreactivate(mt),me.primaryPointerClick=pe.onPrimaryPointerClick(yt),me.beginManipulate=pe.onBeginManipulate(vt),me.manipulate=pe.onManipulate(Dt),me.endanipulate=pe.onEndManipulate(bt)),S.getExecutionContext&&setTimeout(di,500),j&&(R&&(De=R.getExecutionContext?s.getCommand("CATRelatedData3DGridEditHdr",R.getExecutionContext()):new u({ID:"CATRelatedData3DGridEditHdr",isEnabled:!0,context:R.getCommandContext()}),ve=R.getExecutionContext?De.onBeginExecute((function(){$t()})):De.onBegin((function(){$t()})),be=R.getExecutionContext?De.onEndExecute((function(){ri()})):De.onEnd((function(){ri()}))),function(){if(R.getExecutionContext){let e=R.getExecutionContext();e&&(Te=s.getCommandCheckHeader("CATRelatedData3DGridAutoFitHdr",e),Se=Te.onStateChange((function(){Ht(Te.getState())})))}else Te=new g({ID:"CATRelatedData3DGridAutoFitHdr",isEnabled:!0,context:R.getCommandContext()}),Se=Te.onStateChange((function(){Ht(this.getState())}))}(),function(){if(R.getExecutionContext){let e=R.getExecutionContext?R.getExecutionContext():void 0;e&&((Re=s.getCommandCheckHeader("CATRelatedData3DGridAutoOriginHdr",e)).setState(!localStorage.getItem("CATRelatedData3DGridAutoOriginCmd")||"true"===localStorage.getItem("CATRelatedData3DGridAutoOriginCmd")),Re.onStateChange((async function(){Re&&Xt(await Re.getState())})))}else Re=new x({ID:"CATRelatedData3DGridAutoOriginHdr",isEnabled:!0,context:R.getCommandContext()}),Oe=Re.onStateChange((function(){Xt(this.getState())}))}(),R&&(ye=R.getExecutionContext?s.getCommand("CATRelatedData3DGridPropertiesHdr",R.getExecutionContext()):new h({ID:"CATRelatedData3DGridPropertiesHdr",isEnabled:!0,context:R.getCommandContext()}),Ce=R.getExecutionContext?ye.onBeginExecute((function(e){ye=e,R&&R.getFrameWindow()&&R.getFrameWindow().getContextualUIManager()&&R.getFrameWindow().getContextualUIManager().deactivateContextualBar(),ei()})):ye.onBegin((function(e){ye=e,pe.disable(),ei()})),we=R.getExecutionContext?ye.onEndExecute((function(e){ye=e,ai()})):ye.onEnd((function(e){ye=e,ai()}))),R&&(Ae=R.getExecutionContext?s.getCommand("CATRelatedData3DGridRemoveOverloadHdr",R.getExecutionContext()):new p({ID:"CATRelatedData3DGridRemoveOverloadHdr",isEnabled:!0,context:R.getCommandContext()}),Pe=R.getExecutionContext?Ae.onBeginExecute((function(e){Ae=e,R&&R.getFrameWindow()&&R.getFrameWindow().getContextualUIManager()&&R.getFrameWindow().getContextualUIManager().deactivateContextualBar(),ti()})):Ae.onBegin((function(e){Ae=e,pe.disable(),ti()})),Me=R.getExecutionContext?Ae.onEndExecute((function(e){Ae=e,oi()})):Ae.onEnd((function(e){Ae=e,oi()})))),V||(V=Qt()),(i=m.getPreferenceManager({context:S}))&&(Q=i.subscribe("com.ds.mep:onPrefUpdate",(function(e){Kt(JSON.parse(e[1].preferences).repositories)})));else{var n;B&&S.getUIFrame().removeChild(B),B=null,Ee=null,d.unsubscribe(Ge),Ge=0,H&&((n=Object.keys(me)).forEach((function(e){pe.unsubscribe(me[e])})),me={}),(i=m.givePreferenceManager({context:S}))&&(i.unsubscribe(Q),Q=null),m.unreferencePreferenceManager({context:S}),V=null,E=!1,j&&(ye&&ye.cancel(),R.getExecutionContext?(d.unsubscribe(be),d.unsubscribe(ve),d.unsubscribe(we),d.unsubscribe(Ce),d.unsubscribe(Me),d.unsubscribe(Pe),d.unsubscribe(Se),d.unsubscribe(Oe)):(d.unsubscribe(be),d.unsubscribe(ve),d.unsubscribe(we),d.unsubscribe(Ce),d.unsubscribe(Me),d.unsubscribe(Pe),Te._modelEvents.unsubscribe(Se),Re._modelEvents.unsubscribe(Oe)),be=null,ve=null,De=null,Se=null,Te=null,Oe=null,Re=null,Ce=null,we=null,ye=null,Pe=null,Me=null,Ae=null),n=Object.keys(fe);for(var r=0;r<n.length;r++)for(var a=0;a<fe[n[r]].length;a++)pe.unlink(fe[n[r]][a]);fe={}}},this.endEditMode=function(){De&&(R.getExecutionContext?(ri(),d.publish({event:"onCancelEdit"})):De.cancel())};var li=function(e,t){var n,r;let a=it(e,"OriTyp");if(it(e,"UsrBox"))r=e.gridDataPreference;else{var o=Object.assign({},N);o.xStep=o.yStep=o.zStep=it(e,"XPitch"),r=kt({step:o,gridDMUObject:e.gridDMUObject,min:t.min,max:t.max,defaultOrigin:a>0?O[a]:{x:"min",y:"min",z:"min"}})}if((n=0!==a?O[a]:St(e))&&(r=function(e,t,n){for(var r,a,o=t.origin,d=[new i.Vector3(o.x,o.y,o.z),new i.Vector3(o.x+t.xAxis,o.y,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z+t.zAxis)],l=0;l<d.length;l++)void 0===r&&void 0===a?(r=(new i.Vector3).copy(d[l]),a=(new i.Vector3).copy(d[l])):(r.x=Math.min(d[l].x,r.x),r.y=Math.min(d[l].y,r.y),r.z=Math.min(d[l].z,r.z),a.x=Math.max(d[l].x,a.x),a.y=Math.max(d[l].y,a.y),a.z=Math.max(d[l].z,a.z));var s=Object.assign({},N);return s.xStep=s.yStep=s.zStep=it(e,"XPitch"),kt({step:s,gridDMUObject:e.gridDMUObject,min:r,max:a,defaultOrigin:n,userBox:it(e,"UsrBox")})}(e,r,n)),r!==e.gridDataPreference)return r},si=function(e){var t;if(K.gridList&&K.gridList.length>0)for(var i=0;i<K.gridList.length;i++){if((t=K.gridList[i]).rootID===e.split("3D Grid ")[1]){K.gridList.splice(i,1);break}t=null}return t},ci=function(e,t,i){for(var n,r=0;r<U.length;r++)if(U[r].gridName===e){if(t&&(U[r].root=t.clone()),i&&(U[r].bBox=i.clone()),n=U[r],fe&&fe[e]){for(var a=0;a<fe[e].length;a++)pe.unlink(fe[e][a]);fe[e].splice(0,fe[e].length)}break}return n},ui=function(e,t,a,d,l,s){var c,u,g,x,h,p,f,m=!0,D=[];let v=!1;var b=null;if(s&&(b=s.getGridRvwContext()),e&&(x=e.gridDataPreference,e.type&&(h=e.type),e.originType&&(p=e.originType)),t)t.grid||(t.grid=new n(t.gridName),t.grid.setVisibilityFree(!0)),c=t.grid,x=t.gridDataPreference,h=it(t,"UsrBox")?"userDefined":"auto",p=t.originType,m=t.visibility,t.gridDMUObject||(c||(c=new n(l)),t.gridDMUObject=new P(T,b),t.savedDMUObject=t.gridDMUObject,D.push({attribute:"sType",value:"3DGrid"}),D.push({attribute:"sPitch",value:N.xStep}),D.push({attribute:"sLabelPrefixX",value:Y.x}),D.push({attribute:"sLabelPrefixY",value:Y.y}),D.push({attribute:"sLabelPrefixZ",value:Y.z}),D.push({attribute:"bIsBBOverloaded",value:!1}),D.push({attribute:"vBBMin",value:null}),D.push({attribute:"vBBMax",value:null}),D.push({attribute:"idxLockedOrigin",value:"userDefined"===p?rt(I):0}),t.gridDMUObject.set(D),t.root=d?d.clone():void 0,v=!0),f=t.gridDMUObject;else{c=new n(l),f=new P(T,b),v=!0,D.push({attribute:"sType",value:"3DGrid"}),D.push({attribute:"sPitch",value:N.xStep}),D.push({attribute:"sLabelPrefixX",value:Y.x}),D.push({attribute:"sLabelPrefixY",value:Y.y}),D.push({attribute:"sLabelPrefixZ",value:Y.z}),D.push({attribute:"sScale",value:Z}),D.push({attribute:"bIsBBOverloaded",value:!1}),D.push({attribute:"vBBMin",value:null}),D.push({attribute:"vBBMax",value:null}),l==="3D Grid "+k?void 0===p&&(p="auto"):void 0===p&&(p="false"===localStorage.getItem("CATRelatedData3DGridAutoOriginCmd")?"userDefined":"auto"),D.push({attribute:"idxLockedOrigin",value:"userDefined"===p?rt(I):0}),f.set(D),c.setVisibilityFree(!0);var y=Object.assign({},N);y.xStep=y.yStep=y.zStep=N.xStep,l==="3D Grid "+k?(void 0===h&&(h="userDefined"),void 0===x&&(x=kt({step:y,gridDMUObject:f,savedDMUObject:f,min:a.min,max:a.max,defaultOrigin:I,userBox:"userDefined"===h})),et(t={bBox:a?a.clone():void 0,gridName:l,grid:c,gridDataPreference:x,originType:p,gridDMUObject:f},"UsrBox","userDefined"===h)):(void 0===h&&(h="false"===localStorage.getItem("CATRelatedData3DGridAutoFitCmd")?"userDefined":"auto"),void 0===x&&(x=kt({step:y,gridDMUObject:f,savedDMUObject:f,min:a.min,max:a.max,defaultOrigin:I})),et(t={root:d?d.clone():void 0,gridName:l,grid:c,gridDataPreference:x,originType:p,gridDMUObject:f},"UsrBox","userDefined"===h)),U.push(t),s&&s.onGridAddedToGridList({addedGrid:t})}return Ft(c),t.labelRatio=null,c.setVisibility(m),t.visibility=m,t.previousVisibility=m,v&&(t.previousMode="Default",t.mode="Default"),(u=li(t,a))&&(t.gridDataPreference=u),(g=t.gridDMUObject)&&(t.gridDMUObject=g),(v||"Default"===t.mode)&&s&&s.addGridDMUObject(t),function(e){var t,a=["yx","yz","xz"],d=Object.assign({},N);j&&(d.xStep=d.yStep=d.zStep=it(e,"XPitch"));let l={x:it(e,"XLabel"),y:it(e,"YLabel"),z:it(e,"ZLabel")};var s;W&&(s=Yt());for(var c=0;c<a.length;c++){var u=e.gridDataPreference,g=a[c].charAt(0),x=a[c].charAt(1),h=g+"Axis",p=x+"Axis";if(0!==u[h]&&0!==u[p]){var f=new n(g+x+" Plane");e.grid.addChild(f);var m=new n("Lines");m.setPickable(o.PICKTHROUGH),f.addChild(m);var D=new i.Vector3,v=new i.Vector3;D[g]=u[h],v[x]=u[p],f.localXAxis=D,f.localYAxis=v,f.normal=(new i.Vector3).crossVectors(D,v).normalize(),ct(f.normal)>0&&(f.normal=f.normal.negate());var b=g+"Step",y=x+"Step",C=st(u[h])<0?dt(u.origin[g],d[b]):lt(u.origin[g],d[b]);if(W)for("x"===g&&(C=st(C)<0?C+=s.x:C-=s.x),"y"===g&&(C=st(C)<0?C+=s.y:C-=s.y),"z"===g&&(C=st(C)<0?C+=s.z:C-=s.z);Math.abs(C)>Math.abs(u.origin[g]);)C=st(C)<0?C+=d[b]:C-=d[b];var w=(new i.Vector3).copy(u.origin),A=(new i.Vector3).copy(u.origin);w[g]=C,w[x]=u.origin[x],A[g]=C,A[x]=u.origin[x]+u[p];var P=r.createLineNode({points:[w,A]});for(t=0;Math.abs(C+t*st(u[h])-u.origin[g])<=Math.abs(u[h]);t+=d[b]){var M=P;0!==t&&(M=M.clone()),M.setMatrix((new i.Matrix4).makeTranslation("x"===g?t*st(u[h]):0,"y"===g?t*st(u[h]):0,"z"===g?t*st(u[h]):0)),M.relatedLabel={prefix:l[g],value:Math.pow(10,-3)*Math.round(C+t*st(u[h]))},m.addChild(M)}var V=st(u[p])<0?dt(u.origin[x],d[y]):lt(u.origin[x],d[y]);if(W)for("x"===x&&(V=st(V)<0?V+=s.x:V-=s.x),"y"===x&&(V=st(V)<0?V+=s.y:V-=s.y),"z"===x&&(V=st(V)<0?V+=s.z:V-=s.z);Math.abs(V)>Math.abs(u.origin[x]);)V=st(V)<0?V+=d[y]:V-=d[y];for(w=(new i.Vector3).copy(u.origin),A=(new i.Vector3).copy(u.origin),w[g]=u.origin[g],w[x]=V,A[g]=u.origin[g]+u[h],A[x]=V,P=r.createLineNode({points:[w,A]}),t=0;Math.abs(V+t*st(u[p])-u.origin[x])<=Math.abs(u[p]);t+=d[y]){var T=P;0!==t&&(T=T.clone()),T.setMatrix((new i.Matrix4).makeTranslation("x"===x?t*st(u[p]):0,"y"===x?t*st(u[p]):0,"z"===x?t*st(u[p]):0)),T.relatedLabel={prefix:l[x],value:Math.pow(10,-3)*Math.round(V+t*st(u[p]))},m.addChild(T)}}}}(t),c.exludeFromBounding(!1),c.setVisibilityInTree(!1),Jt(),c};this.drawGrids=function(e){var t,n,r,a;n=T.backgroundColor,r=new i.Color(n),a=Math.round((255*r.r*299+255*r.g*587+255*r.b*114)/1e3),xe=a>125?"black":"white";var o,d,l,s,c=null;if(e.rootPaths){var u;for(u=0;u<e.rootPaths.length;u++){if(l=e.rootPaths[u],d="3D Grid "+b.getNodeID(l.getLastElement(!0)),(s=si(d))||(c=ci(d,l)),c&&ue&&ie&&c===oe)continue;let t=ot(l);if(t){c&&e.mode&&"Default"===e.mode&&(c.gridDMUObject=c.savedDMUObject,c.grid&&c.grid.setVisibility(!0),c.visibility=!0,c.mode="Default");var g=e.gridCmd;g||(window.widget.data.appId&&-1!==qe.indexOf(window.widget.data.appId)||window.widget.data.afrAppId&&-1!==qe.indexOf(window.widget.data.afrAppId))&&(g=require("DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd")),o=ui(s,c,t,l,d,g),T.getRootNode().getChildByName("3D Grid "+b.getNodeID(l.getLastElement(!0)))||T.addNode(o)}else c&&c.grid&&(c.grid.setVisibility(!1),Vt(!0))}for(u=0;u<e.rootPaths.length;u++)for(t=0;t<U.length;t++)if(U[t].root&&U[t].root.isEqual(e.rootPaths[u])){Lt(U[t]);break}e.rootPaths.length>0&&(jt(),T.render({updateInfinitePlane:!0}))}else if(e.specifications){let t=e.specifications[0].BBox;if((s=si(d="3D Grid "+k))||(c=ci(d,l,t)),c&&ue&&ie&&c===oe)return;!t&&c&&c.grid&&c.grid.setVisibility(!1),o=ui(s,c,t,l,d),Lt(U[0]),jt(),X&&X.addChild(o)}};var gi=function(e){var t=fe[e];if(t&&t.length){for(var i=0;i<t.length;i++)pe.unlink(t[i]);t.splice(0,t.length)}},xi=function(e){if(B&&B.childNodes&&B.childNodes.length)for(var t=B.childNodes.length-1;t>=0;t--)B.childNodes[t].label.gridID===e&&B.removeChild(B.childNodes[t])},hi=function(e){if(Be)for(var t=Be.length-1;t>=0;t--)Be[t].gridID===e&&Be.splice(t,1)},pi=function(e,t){for(var i=U.length-1;i>=0;i--)if(U[i].gridName===t){Ft(U[i].grid),e.rootPaths?T.removeNode(U[i].grid):e.owner&&e.owner.removeChild(U[i].grid),e.fromStorage?U.splice(i,1):(U[i]&&U[i].grid&&delete U[i].grid,U[i]&&U[i].root&&delete U[i].root,U[i]&&U[i].bBox&&delete U[i].bBox,U[i]&&U[i].labelRatio&&delete U[i].labelRatio),gi(t);break}xi(t),hi(t)};this.deleteGrids=function(e){var t=void 0;if(e.rootPaths)for(var i=0;i<e.rootPaths.length;i++)t="3D Grid "+b.getNodeID(e.rootPaths[i].getLastElement(!0)),pi(e,t);else pi(e,t="3D Grid "+k);e.fromStorage&&e.rootPaths&&e.rootPaths.length>0&&(jt(),T.render()),0===U.length?Be.splice(0,Be.length):Jt()},this.getGridRootNames=function(){for(var e=[],t=0;t<U.length;t++)e.push(U[t].gridName);return e},this.setGridsVisibility=function(e){var t,i=[];for(t=0;t<e.roots.length;t++)for(var n=0;n<U.length;n++)if(b.getNodeID(U[n].root.getLastElement(!0))===b.getNodeID(e.roots[t].getLastElement(!0))&&U[n].grid&&U[n].grid.isVisible()!==e.flag){if(U[n].grid.setVisibility(e.flag),U[n].visibility=e.flag,e.flag){var r=ot(U[n].root);if(r){var a=li(U[n],r);a&&(U[n].gridDataPreference=a,i.push(e.roots[t]))}else U[n].grid.setVisibility(!1)}break}for(t=B.childNodes.length-1;t>=0;t--)B.childNodes[t].style.visibility=e.flag?"":"hidden";i.length&&L.drawGrids({rootPaths:i}),T.render()},this.setSlide3DGrid=function(e){let t=!1;var i,n,r=[];for(i=0;i<e.roots.length;i++)for(var a=0;a<U.length;a++)if(!(n=U[a].root?b.getNodeID(U[a].root.getLastElement(!0)):null)&&U[a].gridName&&(n=U[a].gridName.replace("3D Grid ","")),n===b.getNodeID(e.roots[i].getLastElement(!0))){U[a].root||(U[a].root=e.roots[i]);let n,s=!1;"StartPreviewSlide"!==U[a].mode&&"EndPreviewSlide"!==U[a].mode&&(U[a].previousMode=U[a].mode?U[a].mode:"Default",U[a].previousVisibility=U[a].visibility);let c=!1;if(U[a].mode=e.mode,"StartPreviewSlide"===U[a].mode?(n=e.gridDMUObject,e.gridDMUObject&&(c=!0)):"EndPreviewSlide"===U[a].mode?(n=U[a].savedDMUObject,U[a].previousVisibility&&(c=!0)):"ViewSlide"===U[a].mode?(n=e.gridDMUObject,U[a].savedDMUObject=e.gridDMUObject,e.gridDMUObject&&(c=!0)):"Default"===U[a].mode&&(n=U[a].savedDMUObject,c=!0),U[a].gridDMUObject!==n&&(U[a].gridDMUObject=n,ni(U[a]),s=!0),U[a].grid?U[a].grid.isVisible()!==c&&(U[a].grid.setVisibility(c),U[a].visibility=c,s=!0):(U[a].visibility=c,s=!0),s&&c){var o=ot(U[a].root);if(o){var d=li(U[a],o);d&&(U[a].gridDataPreference=d),r.push(e.roots[i])}else U[a].grid&&U[a].grid.setVisibility(!1)}else t=!0;if(B)for(var l=B.childNodes.length-1;l>=0;l--)B.childNodes[l].style.visibility=c;break}r.length?L.drawGrids({rootPaths:r}):t&&Vt(!0),T.render()},this.updateFreeZone=function(e){Je=e,Vt(!0)},this.updateDefault=function(e){N={xStep:e.stepRequiredX,yStep:e.stepRequiredY,zStep:e.stepRequiredZ},Z=e.scaleValue,Y=e.labels}}})})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridController",["UWA/Core","UWA/Utils","UWA/Class","DS/CATWebUXComponents/DMUCommandsManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/CoreEvents/Events","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],(function(e,t,i,n,r,a,o,d,l){"use strict";var s=i.extend({init:function(i){var s=i||{};this._parent(s);var c,u=!1,g=!1,x=null,h=["CAT3DComposeExamineSelectionHdr","Explode","CAT3DComposeFakeMoveHdr","CATW3DSetIdentityPositionHdr"],p=s.ctxViewer,f={},m=null,D=p.getViewer(),v=null,b=this,y={},C=null,w=function(e){var t=!1;return e.forEach((function(e){"GridRepository"===e.name&&e.preferences.forEach((function(e){"GridPitchValue"===e.name?(y.PitchValue=1e3*parseFloat(e.value),t=!0):"Direction1"===e.name?(y.Direction1=e.value.replace(/\s+/g,"").slice(0,3),t=!0):"Direction2"===e.name?(y.Direction2=e.value.replace(/\s+/g,"").slice(0,3),t=!0):"Direction3"===e.name?(y.Direction3=e.value.replace(/\s+/g,"").slice(0,3),t=!0):"UnitScale"===e.name&&(y.UnitScale=parseFloat(e.value),t=!0)}))})),t};var A=function(){return new Promise((function(e){if(C)return e();let t=[{Repository:"GridRepository",PreferenceNames:["GridPitchValue","Direction1","Direction2","Direction3","UnitScale"]}];try{d.readPreferences(t).then((function(t){C||(C=l.getPreferenceManager({context:p.getFrameWindow()}))&&(m=C.subscribe("com.ds.mep:onPrefUpdate",(function(e){w(JSON.parse(e[1].preferences).repositories)&&v&&v.updateDefault({stepRequiredX:y.PitchValue,stepRequiredY:y.PitchValue,stepRequiredZ:y.PitchValue,scaleValue:y.UnitScale,labels:{x:y.Direction1,y:y.Direction2,z:y.Direction3}})}))),e(t)}))}catch(t){window.console.warn("Error Preferences ",t),e()}}))},P=function(){if(u&&!x&&v){var e=p.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();v.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}},M=function(e){if(p&&u&&!x){for(var t=!1,i=0;i<h.length;i++)if(h[i]===e._id){t=!0;break}if(t){var r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",p.getCommandContext?p.getCommandContext():null);p.getExecutionContext||r.disable(),v.deleteGrids({rootPaths:p.getRootBagPath().getChildrenPathes(),fromStorage:!1}),p.getExecutionContext||(x=e.onEnd((function(){r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",p.getCommandContext?p.getCommandContext():null),p.getExecutionContext||r.enable(),v.drawGrids({rootPaths:p.getRootBagPath().getChildrenPathes(),mode:"Default"}),a.unsubscribe(x),x=null})))}}},V=function(e,t){let i=e.map((function(e){return e.modelIdentification})),n=i.indexOf(t[0]);if(n<0)return!1;let r=0;for(;r<i.length-n&&i[r+n]===t[r];)r++;return r===i.length-n},T=M;n.onCommandStart(T,p.getCommandContext&&p.getCommandContext()?p.getCommandContext():void 0);this.setActiveState=function(i,a){var d,l;if(i!==u){u=i;var s=p.getRootBagPath().getChildrenPathes();u?A().then((function(i){if(i&&w(i.repositories),!v){var m={};""!==window.location.search&&(e.extend(m,t.parseQuery(window.location.search)),m.widgetDomain&&e.extend(m,t.parseQuery(m.widgetDomain))),v=new r({window:p.getFrameWindow(),rootBagPath:p.getRootBagPath(),viewer:D,context:p,nbMaxLabel:"CAT3DGRID_MAXLABEL"in m?m.CAT3DGRID_MAXLABEL:300,stepRequiredX:y.PitchValue,stepRequiredY:y.PitchValue,stepRequiredZ:y.PitchValue,scaleValue:y.UnitScale,labels:{x:y.Direction1,y:y.Direction2,z:y.Direction3}}),P()}v.setActiveState(!0);var b=v.getGridRootNames(),C=!1,A=[];for(d=0;d<b.length;d++){for(l=0;l<s.length;l++)if("3D Grid "+o.getNodeID(s[l].getLastElement(!0))===b[d]){C=!0;break}if(!C)for(l=0;l<s.length;l++)if("3D Grid "+o.getNodeID(s[l].getLastElement(!0))===b[d]){A.push(s[l]);break}}for(v.deleteGrids({rootPaths:A,fromStorage:!0}),v.drawGrids({rootPaths:s,mode:"Default",gridCmd:a}),p.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",P),f.onViewerResizedToken=D.onViewerResize(P),f.onRootAddedToken=p.subscribe({event:"onRootAdded"},(function(e){if(u&&!x){v.endEditMode();var t=e.path;if(e.inContext)for(var i=p.getRootBagPath().getChildrenPathes(),n=0;n<i.length;n++)if(i[n].isAParentOf(e.path)){t=i[n];break}v.drawGrids({rootPaths:[t]})}})),f.onLoadingCompleteToken=p.subscribe({event:"onLoadingComplete"},(function(){if(u&&!x){v.drawGrids({rootPaths:p.getRootBagPath().getChildrenPathes()});var e=p.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();v.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}})),f.onRenderComplete=p.subscribe({event:"onEndProgressiveLoad"},(function(){u&&!x&&v.drawGrids({rootPaths:p.getRootBagPath().getChildrenPathes()})})),c=p.subscribe({event:"onRootRemoved"},(function(e){u&&!x&&v.endEditMode();var t=!g;v.deleteGrids({rootPaths:[e.path],fromStorage:t}),!u&&c&&0===v.getGridRootNames().length&&(p.unsubscribe(c),c=null)})),f.onHide=p.subscribe({event:"onHide"},(function(e){if(u&&e&&Array.isArray(e.paths)&&v&&!x){v.endEditMode();for(var t=[],i=p.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++){if(e.paths[n].externalPath&&i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}if(V(i[r].externalPath,e.paths[n])){t.push(i[r]);break}}t.length&&v.drawGrids({rootPaths:t})}})),f.onShow=p.subscribe({event:"onShow"},(function(e){if(u&&e&&Array.isArray(e.paths)&&v&&!x){v.endEditMode();for(var t=[],i=p.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++){if(e.paths[n].externalPath&&i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}if(V(i[r].externalPath,e.paths[n])){t.push(i[r]);break}}t.length&&v.drawGrids({rootPaths:t})}})),f.onRefreshBeginToken=p.subscribe({event:"onRefreshBegin"},(function(){g=!0,v.endEditMode()})),f.onRefreshCompletedToken=p.subscribe({event:"onRefreshCompleted"},(function(){g=!1})),f.onRootAttachedToken=p.subscribe({event:"onRootAttached"},(function(e){u&&!x&&v.drawGrids({rootPaths:[e.path]})})),f.onRootDetachedToken=p.subscribe({event:"onRootDetached"},(function(e){u&&!x&&(v.endEditMode(),v.deleteGrids({rootPaths:[e.path],fromStorage:!1}))})),f.onLayoutComputedToken=p.subscribe({event:"onLayoutComputationBegin"},(function(){u&&!x&&(v.endEditMode(),v.deleteGrids({rootPaths:p.getRootBagPath().getChildrenPathes(),fromStorage:!1}))})),f.onLayoutResetToken=p.subscribe({event:"onLayoutComputationEnd"},(function(){u&&!x&&v.drawGrids({rootPaths:p.getRootBagPath().getChildrenPathes()})})),f.onModelUpdatedToken=p.subscribe({event:"onModelUpdated"},(function(e){if(u&&!x){v.endEditMode();var t=[],i=p.getRootBagPath().getChildrenPathes();if(e.rootNodes){for(var n=0;n<e.rootNodes.length;n++)for(var r=0;r<i.length;r++)if(i[r].getLastElement(!0)===e.rootNodes[n]){t.push(i[r]);break}v.drawGrids({rootPaths:t})}else v.drawGrids({rootPaths:i})}})),T=M,f.onBackgroundModifyToken=D.onBackgroundModify((function(){u&&!x&&(v.endEditMode(),v.drawGrids({rootPaths:p.getRootBagPath().getChildrenPathes()}))})),d=0;d<h.length;d++){var S=n.getCommand(h[d],p.getCommandContext?p.getCommandContext():null);if(S&&S.isRunning()){M(S);break}}})):(v&&(v.endEditMode(),v.deleteGrids({rootPaths:s,fromStorage:!1}),v.setActiveState(!1)),p.unsubscribe(f.onRefreshBeginToken),p.unsubscribe(f.onRefreshCompletedToken),p.unsubscribe(f.onRenderComplete),p.unsubscribe(f.onRootAddedToken),p.unsubscribe(f.onRootAttachedToken),p.unsubscribe(f.onRootDetachedToken),p.unsubscribe(f.onLayoutComputedToken),p.unsubscribe(f.onLayoutResetToken),p.unsubscribe(f.onModelUpdatedToken),D.unsubscribe(f.onBackgroundModifyToken),D.unsubscribe(f.onViewerResizedToken),p.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",P),f={},T=null)}},this.getActiveState=function(){return u},this.clearController=function(){C&&C.unsubscribe(m),C=null,b.setActiveState(!1),p=D=h=v=b=null},this.hide3DGrids=function(){u&&!x&&v.setGridsVisibility({roots:p.getRootBagPath().getChildrenPathes(),flag:!1})},this.display3DGrids=function(){u&&!x&&v.setGridsVisibility({roots:p.getRootBagPath().getChildrenPathes(),flag:!0})},this.displaySlide3DGrid=function(e,t){u=Boolean(t),v.setActiveState(u),v.setSlide3DGrid({roots:p.getRootBagPath().getChildrenPathes(),mode:e,gridDMUObject:t})}}}),c=[];return i.singleton({init:function(){},give3DGridController:function(e){if(e&&e.context)for(var t=0;t<c.length;t++)if(c[t].context===e.context)return c[t].gridController},get3DGridController:function(e){var t=this.give3DGridController(e);if(e&&e.context&&!t){var i=new s({ctxViewer:e.context});t={setActiveState:function(e,t){i&&i.setActiveState(e,t)},getActiveState:function(){if(i)return i.getActiveState()},clearController:function(){i&&(i.clearController(),i=null)},hide3DGrids:function(){i&&i.hide3DGrids()},display3DGrids:function(){i&&i.display3DGrids()},displaySlide3DGrid:function(e,t){i&&i.displaySlide3DGrid(e,t)}},c.push({context:e.context,gridController:Object.freeze(t)})}return t},unreference3DGridController:function(e){if(e&&e.context)for(var t=c.length-1;t>=0;t--)c[t].context===e.context&&(c[t].gridController.clearController(),c.splice(t,1))}})})),define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCommandsComponent",["DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],(function(e){"use strict";let t=null,i=null,n=null,r=[{id:"CATRelatedData3DGridHdr",type:"check",localStorageID:"CATRelatedData3DGridCmd"}];return class{constructor(a){this.initialize=function(){t=this,i=t.getExecutionContext(),n=i.getComponent(WAfrStandardComponentKey.HandlerComponent);let e=i.getTargetApp(),o=!1;return e&&(e=e.getAfrAppId(),e.includes("ENOR3")&&(o=!0)),new Promise((e=>{a.forEach((e=>{let t=function(e){for(let t=0;t<r.length;t++)if(r[t].id===e)return r[t];return!1}(e.id);t&&("check"===t.type?o||n.setCheckState({id:t.id,state:"true"===localStorage.getItem(t.localStorageID)}):"default"===t.type&&(t.enable&&("true"===t.enable?n.enableHandler(t.id):n.disableHandler(t.id)),"true"===t.init&&n.executeHandler({id:t.id})))})),e()}))},this.clean=function(){return new Promise((t=>{if(i){let t=i.getTargetApp();if(t&&(t=t.getAfrAppId(),t.includes("ENOR3"))){let t=e.give3DGridController({context:i.getComponent("Viewer")});t&&t.setActiveState(!1)}}t()}))},this.destroy=function(){return new Promise((e=>{e()}))},this.canBeParallelized=function(){return!1}}}})),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/PADUtils/PADContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/DMUBaseExperience/DMUContextManager","DS/CATWebUXComponents/DMUCommandsManager","DS/CoreEvents/Events"],(function(e,t,i,n,r,a){"use strict";var o=null,d=null,l=null;let s,c;var u,g=!1,x=["ENOR3D_AP","ENOR3R_AP","ENOR3V_AP","ENOR3D_APWebApp"],h=null,p=e.extend({init:function(e){this._parent(e,{}),u=this,this._skipNextChg=g,s=!(!e.arguments.length||!e.arguments[0].context)&&"Review"===e.arguments[0].context,h=this.onStateChange((function(){if(u._skipNextChg)return u._skipNextChg=!1,g=!1,void(u.getState()||p.Hide3DGrid());u.getState()?p.Display3DGrid():p.Hide3DGrid()}));var t=this._destroy;this._destroy=function(){o&&i.unreference3DGridController({context:o}),u._modelEvents.unsubscribe(h),a.unsubscribe(f),t.call(u)};var n="true"===localStorage.getItem("CATRelatedData3DGridCmd");this.setState(n,!0),n&&require(["DS/CATWebUXComponents/CATWebUXUtils"],(function(e){e._sendUsageProbe("commandCheck","3DGridOn")}))},_destroy:function(){this._parent()},isReviewContext:function(){return s}});p._onDMUSlideDisplayedCB=function(e){if(e.dmuObject){var t=u.getState();t!==e.dmuObject.getDMUObjects("3DGrid").length>0&&(u._modelEvents.unsubscribe(h),u.setState(!t),u._modelEvents.subscribe(h))}};var f=a.subscribe({event:"onSlideDisplayedToManageGrid"},p._onDMUSlideDisplayedCB);return p.onGridAddedToGridList=function(e){e.addedGrid&&(c=e.addedGrid)},p.getGridRvwContext=function(){if(!s)return null;if((l=n.getReviewContext({viewer:d}))||require(["DS/DMUBaseUIControllers/DMUReviewContextInitializer"].concat([]),(function(e){o||(o=n.getContextViewer({viewer:d})),e.createReviewContext({context:o}).then((function(){l=n.getReviewContext({viewer:d}),c&&l&&c.gridDMUObject&&l.getTransientReviewBag().addDMUObject(c.gridDMUObject)}))})),!l)return;var e=l.getCurrentSessionMarkup();let t=!0;if(e){let i=l.getRestrictions(e);i.markup&&void 0!==i.markup.canEdit&&(t=i.markup.canEdit)}return e&&e.getActiveFlag()&&e.isVisible()&&!e.isReadOnly()&&t&&e.getCurrentSlide()?e:l.getTransientReviewBag()},p.addGridDMUObject=function(e){if(!s)return null;var t,i=this.getGridRvwContext();if(i){var n=i.getCurrentSlide?i.getCurrentSlide():null;if(i.addDMUObject){if(i.getDMUObjects){let e=i.getDMUObjects("3DGrid");for(t=0;t<=e.length&&i.removeDMUObject;t++)i.removeDMUObject&&i.removeDMUObject(e[t])}i.addDMUObject(e.gridDMUObject)}else if(n&&n.addDMUObject){if(n.getDMUObjects){let e=n.getDMUObjects("3DGrid");for(t=0;t<=e.length&&n.removeDMUObject;t++)n.removeDMUObject&&n.removeDMUObject(e[t])}n.addDMUObject(e.gridDMUObject),n.fireEvent("onSlidePreviewRefreshRequired",{dmuObject:n})}}},p.ManageGridOnDMUSlideDisplay=function(e){if(e&&e.dmuObject){let n=e.dmuObject.getDMUObjects("3DGrid"),a=i.give3DGridController({context:o});if(!a)return;a.displaySlide3DGrid("ViewSlide",n.length?n[0]:void 0);let d=n.length>=1;var t=r.getCommandCheckHeader("CATRelatedData3DGridHdr",o.getCommandContext?o.getCommandContext():null);t.getState()!==d&&(g=!0,t.setState(d))}},p.Display3DGrid=async function(e,n){var r="";n&&n.executionContext&&(r=n.executionContext.getSourceApp()&&n.executionContext.getSourceApp().options&&n.executionContext.getSourceApp().options.id?n.executionContext.getSourceApp().options.id:window.widget.data.afrAppId?window.widget.data.afrAppId:window.widget.data.appId?window.widget.data.appId:"",s=x.indexOf(r)>=0),!o&&n?o=n.executionContext.getComponent("Viewer"):o||n||(o=t.get()),o&&(d=o.getViewer()),await i.get3DGridController({context:o}).setActiveState(!0,p),localStorage.setItem("CATRelatedData3DGridCmd","true"),e&&e()},p.Hide3DGrid=async function(e,n){var r="";n&&n.executionContext&&(r=n.executionContext.getSourceApp()&&n.executionContext.getSourceApp().options&&n.executionContext.getSourceApp().options.id?n.executionContext.getSourceApp().options.id:window.widget.data.afrAppId?window.widget.data.afrAppId:window.widget.data.appId?window.widget.data.appId:"",s=x.indexOf(r)>=0),!o&&n?o=n.executionContext.getComponent("Viewer"):o||n||(o=t.get()),o&&(d=o.getViewer());let a=i.give3DGridController({context:o});a&&await a.setActiveState(!1),localStorage.setItem("CATRelatedData3DGridCmd","false"),e&&e()},p.updateGridCommandState=function(){if(!s)return null;var e=r.getCommandCheckHeader("CATRelatedData3DGridHdr",o.getCommandContext?o.getCommandContext():null);if(!e)return;let t=null,i=null;var n=this.getGridRvwContext();if(n){var a=n.getCurrentSlide?n.getCurrentSlide():null;n.getDMUObjects?t=n.getDMUObjects("3DGrid"):a&&a.getDMUObjects&&(i=a.getDMUObjects("3DGrid"))}var d;d=t&&t.length>0||i&&i.length>0,e.setState(d)},p}));