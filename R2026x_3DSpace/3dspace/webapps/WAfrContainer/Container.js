define("DS/WAfrContainer/Container",["UWA/Core","UWA/Class/Promise","DS/Core/Core","DS/WAfrExecutionContext/mod_ExecutionContext","DS/PlatformAPI/PlatformAPI","DS/WAfrUtils/Logger","WebappsUtils/WebappsUtils","DS/WAFData/WAFData","DS/WAfrUtils/mod_ConcatenationUtils"],(function(t,e,i,n,o,r,s,a,c){"use strict";const u=c.hasConfigurationFor;var p=n.ExecutionContext,d=function(e){var i,n={view:null,debug:!1,infraComponents:[],proxified:!1,baseUrl:s.getWebappsBaseUrl()};if(i=t.extend(t.clone(n),e),this._proxified=i.proxified,this._view=i.view,!this._view)throw new Error("A view must be defined for the container");this.id=this._view.getId(),this._executionContexts=[],this._currentExecutionContext=-1,this._config=i.config,this._forceProxy=i.forceProxy,this._registeredInfraComponents=i.standardComponents,this._baseUrl=i.baseUrl,this._version=i.version,r.debug("Registry",i&&i.registry),this._context=e.context?e.context:void 0;var o=this.destroy.bind(this);this._view.addEvent("onDestroy",o),this._view.addEvent("onBeforeDestroy",o),this._restoreContextsIfNeed({context:this._context,registry:i&&i.registry});var a=this;this.subscribe("onCreateContext."+this.id,(function(t){a.createNewExecutionContext({registry:i&&i.registry}),a.loadCurrentConfig(t)})),Object.defineProperty(this,"currentApp",{get:function(){var t=this.getCurrentExecutionContext();if(t){var e=t.getSourceApp();if(e)return e}}}),Object.defineProperty(this,"lang",{get:function(){return this._view.getLanguage()}}),Object.defineProperty(this,"productTitle",{get:function(){const t=this._view.getValue("afrProductTitle");return t?decodeURI(t):t}})};function l(t,e){return new Promise(((i,n)=>{require([`text!DS/WebAfr/Applications/${t}${void 0===e?"":`_${e}`}.json`],(function(t){let e;try{e=JSON.parse(t)}catch(t){return n(t)}return i(e)}),(function(t){return n(t)}))}))}return d.prototype.destroy=function(t){return this.id==t&&(this._executionContexts.map((function(t){return t.dispose()})),this._executionContexts=[],this._currentExecutionContext=-1,this._view.setValues({afrCode:void 0,afrAppId:void 0,appId:void 0,title:void 0,appTitle:void 0,afrDebug:void 0,components:void 0}),this._view.destroy(),sessionStorage.removeItem("WAfrABV3FirstLaunch")),e.resolve()},d.prototype._restoreContextsIfNeed=function(t){const e=t&&t.context,i=t&&t.registry;var n=this._view.getValue("afrExecutionContexts")||[],o=this._view.getValue("afrCurrentExecutionContextIdx")||0,s=this._view.getValue("afrAppId");if(n.length>0&&!s&&(r.warn("A context has been found "+JSON.stringify({contexts:n})+" but the app id is null,Ignore the restoration of the saved context"),n=[]),0===n.length||"AppsTester"===e||"AppStandalone"===e){var a=this.createNewExecutionContext({registry:i});n.push({id:a.getId(),currentappId:null}),o=this._currentExecutionContext}else{var c=0;for(c=0;c<n.length;c++)this.createNewExecutionContext({id:n[c].id,registry:i});if(o<0||o>=n.length)throw new Error("The current context index must be in the range of the list of contexts");this._currentExecutionContext=o}this._view.setValue("afrExecutionContexts",n.slice()),this._view.setValue("afrCurrentExecutionContextIdx",o)},d.prototype.createNewExecutionContext=function(t){const e=t&&t.id,i=t&&t.registry;var n=new p({id:e,registry:i,container:this,config:this._config});return this._executionContexts.push(n),this._currentExecutionContext=this._executionContexts.length-1,this._view.addExecutionContextView(n,this.onChangeExecutionContext.bind(this)),n},d.prototype.onChangeExecutionContext=function(t){},d.prototype.getApplicationJSON=function(t){var e=t||this.getCurrentConfig();if(!e.afrAppId)return Promise.reject("The current configuration could not locate a WebAfr application");const i=e.afrAppId;return l(i).catch((t=>l(i,"en")))},d.prototype.requestWAfrService=function(t,i){var n,o=this;if(!this._configService)return e.resolve();if(i&&!t)throw new Error("Must provide an app id to call the transition service");t=t||this._configService.afrAppId||this._configService.appId;var r,s=this._configService.afrService,c="GET";if(i&&(s=s.replace("/apps","/transition"),c="POST",r={containers:[{id:this.id,contexts:this._view.getValue("afrExecutionContexts"),currentIndex:this._view.getValue("afrCurrentExecutionContextIdx")}],currentIndex:0}),!(s+=t).startsWith("http")){var u=this._baseUrl.split("/");if(u.length>=2){var p=u[2].split(":"),d=p[0],l="";p.length>1&&!this._configService.afrServicePort&&(l=":"+p[1]),this._configService.afrServicePort&&(l=":"+this._configService.afrServicePort),s=u[0]+"//"+d+l+"/"+s}}this.lang&&(s+="?lang="+this.lang);var f=this._proxified?this._forceProxy?"proxifiedRequest":"authenticatedRequest":"request";return n=o._executionContexts[o._currentExecutionContext]._perf.start("WAFR: request the App data from WAfr Server"),new e((function(t,e){a[f](s,{type:"json",responseType:"json",method:c,data:r,onComplete:function(e){o._executionContexts[o._currentExecutionContext]._perf.stop(n),t(e)},onFailure:function(t){t.url=s,e(t)}})})).catch((function(t){if(t.message.contains("NetworkError"))return o.getApplicationJSON()}))},d.prototype.loadCurrentConfig=function(t,e){var i=t||this.getCurrentConfig();this._configService=null,i.appTitle&&"Apps supporting transition"!==i.appTitle||(i.appTitle=this._view.getTitleHeader().appTitle);var n=this.getCurrentExecutionContext();let o=null;return 1===this._version?o=Promise.resolve():2===this._version&&(i.afrService?(this._configService=i,o=this.requestWAfrService()):o="0.2"===i.afrVersion?Promise.resolve(null):"0.1"===i.afrVersion?this.getApplicationJSON().then((function(t){return Promise.resolve(t)}),(function(t){return Promise.resolve(null)})):this.getApplicationJSON()),o.then((t=>{if(u(t||i,"a2x")){if(window.dsDashboardWindow&&window.dsDashboardWindow.top.dsA2X&&!window.dsDashboardWindow.top.dsA2X._a2XWebFrame){require(["DS/WAfrA2XWebFrame/A2XWebFrame"],(function(t){let i={globalImmersiveFrame:e.globalImmersiveFrame};window.dsDashboardWindow.top.dsA2X._a2XWebFrame=new t(i)}),(()=>{}))}return this.initializeA2XSession(t||i).then((()=>(window.dsDashboardWindow&&window.dsDashboardWindow.top.dsA2X&&window.dsDashboardWindow.top.dsA2X._a2XWebFrame&&window.dsDashboardWindow.top.dsA2X._a2XWebFrame.init(i.afrExecutionContexts[i.afrCurrentExecutionContextIdx],this._context),Promise.resolve(t))))}return Promise.resolve(t)})).then((t=>{const o=e&&e.appInfo?e.appInfo:null;let r=null;i&&(r={appId:i.appId,afrAppId:i.afrAppId,appTitle:i.appTitle});const s={appIds:r,appInfo:o};return n.load(Object.assign(t||i,{winId:e&&e.winId?e.winId:null,nativeAppContent:e&&e.nativeAppContent?e.nativeAppContent:null}),void 0,s)}))},d.prototype.initializeA2XSession=function(t){var e=this;let i=null,n=null;return n=e._a2xClient?Promise.resolve():new Promise((function(t,n){require(["DS/WA2XCommunication/WA2XClient","DS/WA2XCommunicationUI/WA2XClientUI"],(function(n,o){e._a2xClient=n.getA2XClient(),i=o,t()}),n)})),n.then((()=>e.processA2XConfig(t))).then((t=>{let n=e.getCurrentExecutionContext();if(e._a2xClient&&!e._a2xClient.isConnected()&&n){let e=n.getUiContainer();return i.connect(t,e)}})).catch((t=>{throw t}))},d.prototype.processA2XConfig=function(t){const e="default",i="custom",n="afrTest",o={hypervisorUrl:"ws://localhost:2097",poolName:"A2XPool"};let r=t.stdConf.a2x.configurationName;return new Promise((function(s,a){if(r){if(r===e)s(o);else if(r===i){let e=t.stdConf.a2x,i=e.configurationFile;i?require([i],(t=>{s(JSON.parse(t))}),(t=>{a(t)})):s(e)}else if(r===n){if(!window.__karma__||!window.__karma__.config||!window.__karma__.config.json)throw new Error("Impossible to retrieve the json configuration from KARMA_ODT_CLIENT_JSON");const t=window.__karma__.config.json,e=`ws://localhost:${t.websocketPort}`,i=t.poolName;s({hypervisorUrl:e,poolName:i})}}else a(new Error("The configurationName property cannot be empty"))}))},d.prototype.launchApp=function(i,n){var o=this.id;return new e((function(e,r){require(["DS/i3DXCompassServices/i3DXCompassPubSub"],(function(s){s.subscribe("launchAppCallback",(function(t){"COMPLETE"===t.response?e():r()}));var a={widgetId:o,appId:i};a=t.extend(a,n),s.publish("launchApp",a)}))}))},d.prototype.getCurrentConfig=function(){var e=t.clone(this._view.getValues());return e.appId=this._view.getValue("appId"),e.afrAppId||(e.afrAppId=e.appId),e.version=this._view._version,e},d.prototype.publish=function(t,e){o.publish(t,e)},d.prototype.subscribe=function(t,e){o.unsubscribe(t),o.subscribe(t,e)},d.prototype.getCurrentExecutionContext=function(){return this._currentExecutionContext<0?null:this._executionContexts[this._currentExecutionContext]},d.prototype.registerInfraComponents=function(t){for(var e=0;e<this._registeredInfraComponents.length;e++){var i=this._registeredInfraComponents[e],n=i.DEFAULT_COMPONENT_NAME;t.createAndRegisterComponent(n,i,{container:this})}},d.prototype.updateTitle=function(t,e){if(!e){const t=this.getCurrentExecutionContext();t&&(e=t.getTargetApp()||t.getSourceApp())}e&&(t.appTitle=t.appTitle||e.getTitle()||this._view.getValue("appTitle"),t.brand=t.brand||e.getBrand()||this._view.getValue("brand"));const i=t.title?encodeURI(t.title):t.title;this._view.setValue("afrProductTitle",i),this._view.setValue("title",t.title),this._view.setTitleHeader(t)},d.prototype.updateAppTitle=function(t){const e=this._view.getId(),i=window.dsDashboardWindow?window.dsDashboardWindow.top.UWA?window.dsDashboardWindow.top.UWA.Widgets?window.dsDashboardWindow.top.UWA.Widgets.instances:[]:void 0:window.top.UWA?window.top.UWA.Widgets?window.top.UWA.Widgets.instances:[]:void 0;if(i&&i.length){let n=i.findIndex((t=>e===t.id));if(-1!==n){const e=i[n]?i[n].environment:void 0;e&&e.wp&&e.wp.originalTitle&&(e.wp.originalTitle=t)}}},d}));