define("DS/DELPPWIndexServices/IndexParserNode",["UWA/Core","UWA/Class"],(function(t,e){"use strict";return e.extend({init:function(e){var i=this;this._children=[],this._result=e,this._result.attributes.forEach((function(e){var n,a=e.name;t.is(i[a])?t.is(i[a].value,"string")?(n=i[a].value,i[a].value=[n,e.value]):t.is(i[a].value,"array")&&i[a].value.push(e.value):i[a]=e}))},getAttribute:function(t){if(this.hasOwnProperty(t))return this[t]},getAttributeValue:function(t){var e=this.getAttribute(t);if(e)return e.value},addChild:function(t){-1===this._children.indexOf(t)&&this._children.push(t)},getChildren:function(){return this._children},getRawResult:function(){return this._result}})})),define("DS/DELPPWIndexServices/IndexParser",["UWA/Core","UWA/Class","DS/DELPPWIndexServices/IndexParserNode","DS/DELPPWLoggerModel/LoggerUtils"],(function(t,e,i,n){"use strict";return e.singleton({name:"IndexParser",_dicoUtils:null,_indexMapping:null,_DBAttrToPredicateMapping:{},init:function(t){t=t||{},this._parent(t)},setup:function(e){t.is(e.dicoUtils)&&(this._dicoUtils=e.dicoUtils),t.is(e.indexToDBMapping)&&this.setIndexMapping(e.indexToDBMapping)},setIndexMapping:function(e){var i=this;this._indexMapping=e,t.is(e)&&t.is(e.IndexMapping)&&(t.is(e.IndexMapping.Entity)&&e.IndexMapping.Entity.Key.forEach((function(t){i._DBAttrToPredicateMapping[t.database]=t.index})),t.is(e.IndexMapping.Relation)&&e.IndexMapping.Relation.Key.forEach((function(t){i._DBAttrToPredicateMapping[t.database]=t.index})))},getPredicate:function(t){return this._DBAttrToPredicateMapping[t]},translateAttributeToPredicate:function(e,i){var n,a,r=this,s=[];if(t.is(this._indexMapping)){switch(n=(i=i||{}).type||"entity"){case"entity":a=this._indexMapping.IndexMapping.Entity.Key;break;case"relation":a=this._indexMapping.IndexMapping.Relation.Key}return e.forEach((function(t){var e=!1;a.forEach((function(i){i.database===t&&-1===s.indexOf(i.index)&&(s.push(i.index),e=!0)})),e||r._dicoUtils.getDicoTypeIndexesForAttribute(t,n).forEach((function(t){s.push(t)}))})),s}},translatePredicateToAttribute:function(e,i){var n,a,r,s=this;if(t.is(this._indexMapping)){switch(r=(i=i||{}).type||"entity",e instanceof Array?n=[]:(n={},i.fromExpandService&&(e=function(e){var i={};return e=e||{},Object.keys(e).forEach((function(n){var a=e[n];a instanceof Function||0===n.indexOf("_")||(t.is(a,"object")&&t.is(a.value)?i[n]=a.value:i[n]=a)})),i}(e))),r){case"entity":a=this._indexMapping.IndexMapping.Entity.Key;break;case"relation":a=this._indexMapping.IndexMapping.Relation.Key}return e instanceof Array?e.forEach((function(t){var e;a.some((function(i){var n=i.index===t;return n&&(e=i),n})),e?-1===n.indexOf(e.database)&&n.push(e.database):s._dicoUtils.getDicoTypeAttributesForIndex(t,r).forEach((function(t){n.push(t)}))})):Object.keys(e).forEach((function(t){var i,u,o;a.some((function(e){var i=e.index===t;return i&&(o=e),i})),o?(i=e[o.index],a.some((function(t){var e=t.index===i;return e&&(u=t),e})),u&&(i=u.database),n[o.database]=i):(i=e[t],s._dicoUtils.getDicoTypeAttributesForIndex(t,r).forEach((function(t){n[t]=i})))})),n}},parseNavigateResult:function(e){var a=null,r={},s=[];return"string"==typeof e?a=JSON.parse(e):"object"==typeof e&&null!==e&&(a=e),t.is(a)&&t.is(a.results,"array")&&a.results.forEach((function(e){var a,u,o,c,d,p;if(Object.prototype.hasOwnProperty.call(e,"attributes"))u=(a=new i(e)).getAttributeValue("did"),r[u]=a;else if(Object.prototype.hasOwnProperty.call(e,"path"))for(c=0;c<e.path.length;c++){if(d=e.path[c],p=r[d],!t.is(p))throw new Error("Result corruption : did not found "+d);0===c?(-1===s.indexOf(p)&&s.push(p),o=p):(o.addChild(p),o=p)}else n.warn("IndexParser.parseNavigateResult Unsupported element: "+JSON.stringify(e))})),s},parseFetchResult:function(e){var i=this,n={attributes:{},ds6w:{}};return t.is(e)&&t.is(e.attributes,"array")&&e.attributes.forEach((function(e){var a;if(t.is(e)&&t.is(e.format,"string"))switch(e.format){case"attribute":{let r=!1,s=!1,[u]=i._dicoUtils.getPredicateInfosForUriPredicate(e.name);if(t.is(u)){let e=i._dicoUtils.getAttributeInfo(u);t.is(e)&&(r=t.is(e.MultiValuated)&&"Yes"===e.MultiValuated,s=t.is(e.Type)&&"Double"===e.Type)}let o=e.value;if(s){let t=Number(o);isFinite(t)&&(o=t.toFixed(6).replace(/\.?0+$/,""))}t.is(n.attributes[e.name])?t.is(n.attributes[e.name],"string")?(a=n.attributes[e.name],n.attributes[e.name]=[a,o]):t.is(n.attributes[e.name],"array")&&n.attributes[e.name].push(o):n.attributes[e.name]=r?[o]:o;break}case"ds6w_facet":n.ds6w[e.name]={value:e.value,dispValue:e.dispValue,type:e.type}}})),n},parseOnInverseLinkfetch:function(e){var i=e||{},n=this;return t.is(i,"object")&&Object.keys(i).forEach((function(e){let a=!1,[r]=n._dicoUtils.getPredicateInfosForUriPredicate(e);if(t.is(r)){let e=n._dicoUtils.getAttributeInfo(r);t.is(e)&&(a=t.is(e.Type)&&"Double"===e.Type)}if(a){let t=Number(i[e]);isFinite(t)&&(i[e]=t.toFixed(6).replace(/\.?0+$/,""))}})),i}})}));