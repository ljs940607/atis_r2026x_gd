window.top.performance.mark("C3D_jsAppLoad"),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
function(){"use strict";var e=[];e.giveNavigationObject=function(t){var n;return t&&t.context&&(n=null,e.some((function(e){return e.context===t.context&&(n=e,!0)}))),n},e.getNavigationObject=function(t){var n=this.giveNavigationObject(t);return null===n&&(n={context:t.context,onStart:null,onExit:null,controller:null,activated:!1},e.push(n)),n},define("DS/CATC3DNavigation/CATD3CBoxNavigation",["UWA/Core","UWA/Class","DS/VisuEvents/EventsManager","DS/Visualization/PathElement","DS/CATW3DAnims/CATW3DAnimation3D","DS/PADUtils/PADWSAccess","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/SceneGraphNodes/FixedSizeNode3D","DS/CATC3DNavigation/CATBreadCrumbs","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DComposeUtils/CATC3DDropManager","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,C,v,h,f,D,A,S,E){function x(e){this.pts=[new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3],this.vecU=new r.Vector3,this.vecV=new r.Vector3,this.vecW=new r.Vector3,e&&(this.pts[0].set(e.min.x,e.min.y,e.min.z),this.pts[1].set(e.max.x,e.min.y,e.min.z),this.pts[2].set(e.min.x,e.max.y,e.min.z),this.pts[3].set(e.max.x,e.max.y,e.min.z),this.pts[4].set(e.min.x,e.min.y,e.max.z),this.pts[5].set(e.max.x,e.min.y,e.max.z),this.pts[6].set(e.min.x,e.max.y,e.max.z),this.pts[7].set(e.max.x,e.max.y,e.max.z),this.vecU.subVectors(this.pts[1],this.pts[0]),this.vecV.subVectors(this.pts[2],this.pts[0]),this.vecW.subVectors(this.pts[4],this.pts[0]))}function y(){var e,t,n,i,o,a;this.store=function(s,l){var c=l?(new r.Matrix4).getInverse(l):null,u=c?(new r.Matrix4).extractRotation(c):null;e=s.getEyePosition(),c&&e.applyMatrix4(c),t=s.getUpDirection(),u&&t.applyMatrix4(u),n=s.getSightDirection(),u&&n.applyMatrix4(u),i=s.getTargetDistance(),o=s.getProjectionType(),a=s.getAngle()},this.restore=function(s,l){if(e){var c=l?(new r.Matrix4).extractRotation(l):null;s.moveTo({eyePosition:l?e.applyMatrix4(l):e,upDirection:c?t.applyMatrix4(c):t,sightDirection:c?n.applyMatrix4(c):n,distanceToTarget:i}),s.setProjectionType(o),s.setAngle(a)}}}function b(e){var t,n,i,o,a=e&&e.externalPath.length>1;for(t=0,n=e.externalPath.length-1;a&&t<n;++t)i=e.externalPath[t],o=e.externalPath[t+1],i.children.indexOf(o)<0&&(a=!1);return a}function T(e){if(!e)return!1;if(E.isReference(e))return!0;var t=E.getNodeType(e);return"CATDrawing"===t||"Drawing"===t||"CATAnalysis"===t||"PPRContext"===t}function M(e){if(!e)return!1;if(E.isInstance(e))return!0;var t=E.getNodeType(e);return"CatDrawing"===t||"CatAnalysis"===t||"CatProcess"===t}function P(e){return!e||e.empty()||e.isNaN()||e.min.distanceTo(e.max)<=0}x.prototype={constructor:x,copy:function(e){for(var t=0;t<8;++t)this.pts[t].copy(e.pts[t]);return this.vecU.copy(e.vecU),this.vecV.copy(e.vecV),this.vecW.copy(e.vecW),this},clone:function(){return(new this.constructor).copy(this)},center:function(e){return(e||new r.Vector3).set(.5*(this.pts[0].x+this.pts[7].x),.5*(this.pts[0].y+this.pts[7].y),.5*(this.pts[0].z+this.pts[7].z))},applyMatrix4:function(e){for(var t=0;t<8;++t)this.pts[t].applyMatrix4(e);var n=(new r.Matrix4).extractRotation(e);return this.vecU.applyMatrix4(n),this.vecV.applyMatrix4(n),this.vecW.applyMatrix4(n),this},containsPoint:function(e){return!(e.x<this.pts[0].x||e.x>this.pts[7].x||e.y<this.pts[0].y||e.y>this.pts[7].y||e.z<this.pts[0].z||e.z>this.pts[7].z)},minX:function(){for(var e=this.pts[0].x,t=1;t<8;++t)e=Math.min(e,this.pts[t].x);return e},maxX:function(){for(var e=this.pts[0].x,t=1;t<8;++t)e=Math.max(e,this.pts[t].x);return e},minY:function(){for(var e=this.pts[0].y,t=1;t<8;++t)e=Math.min(e,this.pts[t].y);return e},maxY:function(){for(var e=this.pts[0].y,t=1;t<8;++t)e=Math.max(e,this.pts[t].y);return e},minZ:function(){for(var e=this.pts[0].z,t=1;t<8;++t)e=Math.min(e,this.pts[t].z);return e},maxZ:function(){for(var e=this.pts[0].z,t=1;t<8;++t)e=Math.max(e,this.pts[t].z);return e},min:function(){for(var e=(new r.Vector3).copy(this.pts[0]),t=1;t<8;++t)e.x=Math.min(e.x,this.pts[t].x),e.y=Math.min(e.y,this.pts[t].y),e.z=Math.min(e.z,this.pts[t].z);return e},max:function(){for(var e=(new r.Vector3).copy(this.pts[0]),t=1;t<8;++t)e.x=Math.max(e.x,this.pts[t].x),e.y=Math.max(e.y,this.pts[t].y),e.z=Math.max(e.z,this.pts[t].z);return e}},y.prototype={constructor:y},Object.freeze(y);var w,R,I=-1,N=144,U=108,L=1e-6,_=S.getOption("C3DSTR"),W=new r.Vector3(0,0,1),O=new r.Vector3(1,0,0),F=new r.Vector3(-1,0,0),V=Math.PI,k=.5*Math.PI,B=.25*Math.PI,X=.75*Math.PI,G=new r.Color("rgb(202,202,202)").getHex(),H=new r.Color("rgb(54,142,196)").getHex(),q=0,j={},Y=new r.MeshBasicMaterial({map:new r.ImageUtils.loadTexture(u.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",void 0,null,null,!0),side:r.DoubleSide,force:!0,transparent:!0}),z=new r.MeshBasicMaterial({map:new r.ImageUtils.loadTexture(u.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",void 0,null,null,!0),side:r.DoubleSide,force:!0,transparent:!0});function K(){w=new r.MeshBasicMaterial({color:G,opacity:.95}),R=new r.MeshBasicMaterial({color:H,opacity:.95}),w.line=R.line=new r.LineBasicMaterial({color:q,opacity:.95}),w.force=R.force=!0}return K(),t.extend({init:function(t){var u,S,G,H,J,Z,Q,$,ee,te,ne,ie,oe,ae,re,se,le,ce,ue=t.context,de=ue.getController(),me=ue.getViewer(),pe=me.getSceneGraphOverrideSetManager(),ge=!1,Ce=[],ve=ue.getRootBagPath().getLastElement(!0),he=o.getAnimation3DEngine({viewer:me}),fe={},De=[],Ae=[];function Se(t,n,o){var a=t.pathElement.getLastElement(!0);if(a&&a.navigationAssociatedPath)t.pathElement=2===n?a.navigationAssociatedPath.clone():new i(t.pathElement.externalPath.slice(0,3));else if(t.pathElement.externalPath[0]===ve){if(1===n&&o){var r=fe.levels[fe.levels.length-1].node.getChildByName("EmptyNodes");r&&r.getChildren().some((function(n){if(n.children.length&&t.pathElement.isAParentOf(n.navigationAssociatedPath)){var o=e.extend({},t,!1);return o.pathElement=new i([fe.levels[fe.levels.length-1].node,r,n,n.children[0]]),l.isIn(o)||l.add(o),!0}return!1}))}var s=H.clone(),c=H.getLastElement(!0);t.pathElement.externalPath.length>s.externalPath.length&&(s.addElement(t.pathElement.externalPath[s.externalPath.length]),c!==ve&&t.pathElement.externalPath.length>s.externalPath.length&&s.addElement(t.pathElement.externalPath[s.externalPath.length]),t.pathElement=s)}return t}function Ee(e,t,n){Array.isArray(e)?e.forEach((function(e){Se(e,t,n)})):Se(e,t,n)}function xe(e){Ee(e,0,!0)}function ye(e){Ee(e,1,!0)}function be(e){Ee(e,2,!0)}function Te(e){Ee(e,1,!1)}function Me(e){return Se({pathElement:e},2,!0).pathElement}function Pe(t){if(t&&t.completed)if(t.arrayPath&&1===t.arrayPath.length&&t.token){var n=Me(t.arrayPath[0]);if(n){var i,o=n.getLastElement(!0),a=o?E.getNodeID(o):void 0;if(a){n.externalPath.length>1&&E.isInstance(n.externalPath[n.externalPath.length-2])&&(i=E.getNodeID(n.externalPath[n.externalPath.length-2]));var r=[a];i&&r.push(i),ue.getController().getAttributes({ids:r,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(n){var o,r=n[a]?n[a]["ds6w:label"]:"";if(i&&n[i]&&n[i]["ds6w:label"]&&(r+=" ("+n[i]["ds6w:label"]+")"),r&&"string"==typeof r&&0!==r.trim().length){(o=e.createElement("div")).setText(r);var s=n[a].type_icon_url;s&&"string"==typeof s&&s.length>0&&(o.setStyles({"background-image":"url("+s+")","background-repeat":"no-repeat","background-position-y":"center"}),o.setStyle("padding-left","21px"))}t.completed({token:t.token,div:o})},onFailure:function(){t.completed({token:t.token})}}})}else t.completed()}else t.completed()}else t.completed()}function we(){$?$.restore(ue.getFrameWindow().getViewpoint(),H.getWorldMatrix()):($=new y,ue.getFrameWindow().getViewpoint().reframe(null))}function Re(e,t){var n=u.createOverride({pathes:e});return t.push(n),n}function Ie(t){var n=t.getLastElement(!0),i=!0===pe.getCurrentVisibility(t)?0:!0===pe.getCurrentVisibilityFree(t)?-1:1;if(T(n)||E.is3DLeaf(n))return i;var o=n.getChildren();if(1!==o.length)return e.log("Instance or RepInstance with no or more than one Reference or RepReference"),i;var a=t.clone();return a.addElement(o[0]),!0===pe.getCurrentVisibility(a)?0:!0===pe.getCurrentVisibilityFree(a)?-1:1}function Ne(e,t){if(e){var n=null,i=e.angleTo(t);return i>L&&V-i>L&&(n=new r.Matrix4,i<=k||i-k<L?n.makeRotationAxis((new r.Vector3).crossVectors(e,t).normalize(),i):n.makeRotationAxis((new r.Vector3).crossVectors(e,t).normalize().negate(),V-i)),n}}function Ue(e,t,n){if(_){var i,o,a,s,l=e.clone(),c=l.vecU.length(),u=l.vecV.length(),d=l.vecW.length(),m=l.vecU,p=l.vecV,g=l.vecW;return n?((s=g.angleTo(W))>L&&(i=(new r.Matrix4).makeRotationAxis((new r.Vector3).crossVectors(g,W).normalize(),s),l.applyMatrix4(i)),(s=m.angleTo(O))>L&&V-s>L&&Math.abs(s-k)>L&&(o=new r.Matrix4,s<=B?o.makeRotationAxis((new r.Vector3).crossVectors(m,O).normalize(),s):s>=X?o.makeRotationAxis((new r.Vector3).crossVectors(m,F).normalize(),V-s):(s=p.angleTo(O))<=B?o.makeRotationAxis((new r.Vector3).crossVectors(p,O).normalize(),s):o.makeRotationAxis((new r.Vector3).crossVectors(p,F).normalize(),V-s),i=i?o.multiply(i):o)):(d<=c&&d<=u?(m=l.vecU,p=l.vecV,a=l.vecW):c<=u&&c<d?(m=l.vecV,p=l.vecW,a=l.vecU):(m=l.vecW,p=l.vecU,a=l.vecV),(i=Ne(a,W))&&l.applyMatrix4(i),t&&(o=Ne(a=(c=m.length())===(u=p.length())?t.x?m:p:c>u?m:p,t))&&(i=i?o.multiply(i):o)),i}}function Le(e,t,n){var i=(new r.Matrix4).setPosition(e),o=(new r.Matrix4).copy(t).multiply((new r.Matrix4).getInverse(i).multiply(n));return i.multiply(o)}function _e(e,t){var n=new r.Vector3(0,0,0);return n.applyMatrix4(t),e.containsPoint(n)||e.center(n),n}function We(e,t,n){return e.setSSAO(!1),e.setShadow(!1,!1),e.setRenderDepth(1),t||(e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.exludeFromBounding(!0)),n&&(e.name=n),e}function Oe(e){if(e.box){var t=!1;if(1===e.node.children.length){var n=e.node.children[0];(E.is3DLeaf(n)||E.is3DLeaf(e.node)||M(e.node)&&!T(n)||T(e.node)&&!M(n))&&(t=!0)}var i=e.box,o=i.minX(),a=i.maxX(),s=i.minY(),l=i.maxY(),c=i.minZ();if(a-o>0&&l-s>0){var u=m.createRectangleNode({width:a-o,height:l-s,fill:!0,material:t?R:w});u.setMatrix((new r.Matrix4).setPosition(new r.Vector3(o,s,c))),fe.levels[fe.levels.length-1].node.addChild(We(u))}}}function Fe(t,n,i){if(t.length){var o=new g({name:"EmptyNodes",ratio:1});o.setMatrix((new r.Matrix4).setPosition(new r.Vector3(i.max.x,(n.minY()+n.maxY())/2,i.min.z))),fe.levels[fe.levels.length-1].node.addChild(o);for(var s,l={},c={},u=t.length>3?(b=t.length,M=Math.sqrt(b),P=Math.floor(M),M-P<.5?P:P+1):1,d=t.length>3?function(e){return Math.ceil(Math.sqrt(e))}(t.length):t.length,p=118*(.5*u-1),C=0,v=0;v<u;++v){for(var h=0,f=0;f<d;++f){var D=t[C].node,A=!1;0===D.children.length?T(D)||(e.log("Inst or RepInst with no Ref or RepRef"),A=!0):1===D.children.length||T(D)?(E.isRepInstance(D)||E.is3DLeaf(D.children[0])||E.is3DLeaf(D))&&(A=!0):(e.log("Inst or RepInst with more than one Ref or RepRef"),A=!1);var S=m.createRectangleNode({width:154,height:118,fill:!0,material:A?R:w});S.setMatrix((new r.Matrix4).setPosition(new r.Vector3(h,p,0))),o.addChild(We(S,!1,"Node_"+t[C].id)),S.navigationAssociatedPath=t[C].pathElement,(s=j[t[C].type])||(s=A?Y:z,l[t[C].type]||(l[t[C].type]=t[C].id),c[t[C].id]=t[C].type);var x=m.createRectangleNode({width:N,height:U,fill:!0,noEdge:!0,material:s});if(x.setMatrix((new r.Matrix4).setPosition(new r.Vector3(5,5,5))),h+=154,S.addChild(We(x,!0,"Texture_"+t[C].id)),x.navigationAssociatedPath=t[C].pathElement,++C>=t.length)break}if(p-=118,C>t.length)break}var y=Object.keys(l).map((function(e){return l[e]}));if(!y.length)return;a.fetch({enopad_webapis:require("DS/PADUtils/PADSettingsMgt").getSetting("enopad_webapis"),data:{intent:"explore_2D",select_file:["preview_url","thumbnail_2d"],select_predicate:["physicalid"]},pids:y,onComplete:function(e){var t=JSON.parse(e),n={};(t&&t.results||[]).forEach((function(e){if(e.attributes){for(var t,i,o=0,a=e.attributes.length;o<a&&(!t||!i);++o){var r=e.attributes[o];t||"ds6w:type"!==r.name?i||"preview_url"!==r.name&&"thumbnail_2d"!==r.name||(i=r.value):t=r.value}t&&i&&(n[t]=i)}})),o.getChildren().forEach((function(e){var t=e.getChildren();if(t&&t.length){var i,o,a=t[0].name.replace("Texture_","");c[a]&&(!(i=j[c[a]])&&n[c[a]]&&(o=new r.ImageUtils.loadTexture(n[c[a]],void 0,(function(){j[c[a]]?i=j[c[a]]:j[c[a]]=i=new r.MeshBasicMaterial({map:o,side:r.DoubleSide,force:!0,transparent:!0}),t[0].setMaterial(i)}),(function(){}),!0)),i&&t[0].setMaterial(i))}})),me.render()},onFailure:function(){}})}var b,M,P}function Ve(e,t){var n,i,o,a=null;return T(e)||E.is3DLeaf(e)?((a=t.clone()).addElement(e),i=E.getNodeID(e),o=E.getNodeType(e)):1===(n=e.getChildren()).length&&((a=t.clone()).addElement(e),a.addElement(n[0]),i=E.getNodeID(n[0]),o=E.getNodeType(n[0])),{id:i,node:e,pathElement:a,type:o}}function ke(e,t){return e.valueForSort<t.valueForSort?-1:e.valueForSort>t.valueForSort?1:0}function Be(e,t){return e.valueForSort>t.valueForSort?-1:e.valueForSort<t.valueForSort?1:0}function Xe(e,t){var n=new r.Box3;e.forEach((function(e){n.union(new r.Box3(e.box.min(),e.box.max()))})),e.delta=0,t.min.y>n.min.y&&(e.delta=t.min.y-n.min.y),t.max.y<n.max.y&&(e.delta=Math.min(e.delta,n.max.y-t.max.y))}function Ge(e,t){var n=new r.Box3;e.forEach((function(e){n.union(new r.Box3(e.box.min(),e.box.max()))})),e.delta=0,t.min.x>n.min.x&&(e.delta=t.min.x-n.min.x),t.max.x<n.max.x&&(e.delta=Math.min(e.delta,n.max.x-t.max.x))}function He(e,t,n,i,o){var a=(new r.Matrix4).setPosition((new r.Vector3).copy(i.dir).multiplyScalar(o));return n.box.applyMatrix4(a),n.worldMatrixTarget=n.worldMatrixSource.multiplyMatrices(a,n.worldMatrixSource),n.matrixTarget=(new r.Matrix4).multiplyMatrices(e,n.worldMatrixTarget),delete n.worldMatrixSource,n.centerRotation&&n.centerRotation.applyMatrix4(a),t.union(new r.Box3(n.box.min(),n.box.max())),t}function qe(){var e=ue.getFrameWindow();e&&e.removeReviewModel&&e.removeReviewModel()}function je(t){if(he.forward(),ue.getFrameWindow().getContextualUIManager().hideContextualMenus(),t.div!==fe.levels[fe.levels.length-1].button){for(var n,i,o,a,r=[],s=[],l=[],c=[];fe.levels.length;){var d,m=fe.levels.pop();if(m.button===t.div){fe.levels.push(m),H=m.path,ee&&ee.setCurrentPath(H);break}if(1===fe.levels.length)for(n=fe.levels[0].overridesMove.length-1;n>=0;--n)if(1!==(a=(o=fe.levels[0].overridesMove[n]).getPathes()).length&&e.log("More than one path in override, not expected"),a[0].isEqual(m.path)){d=o.getPosition();break}for(n=0,i=m.overridesMove?m.overridesMove.length:0;n<i;++n){o=m.overridesMove[n],r.push(o),1!==(a=o.getPathes()).length&&e.log("More than one path in override, not expected");var p=a[0].getLastElement(!0).getMatrix();d&&a[0].isEqual(m.path)&&(p=d,d=null),c.push({override:o,matrixSource:o.getPosition(),matrixTarget:p})}for(n=0;n<(m.overridesHide?m.overridesHide.length:0);++n)r.push(m.overridesHide[n]),s.push({override:m.overridesHide[n]});fe.mainDiv.removeBreadCrumb(m.button.idthumb),me.removeNode(m.node),De.push({path:m.path,pathReference:m.pathReference})}qe(),he.addAnimation({animationType:"unmask",objectListToAnimate:s,duration:1e3}),he.addAnimation({animationType:"move",objectListToAnimate:c,duration:1e3,callBackFct:function(){u.deleteOverrides(r),u.deleteOverrides(l),me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0})}}),he.startAnimation(),me.render({updateInfinitePlane:!0})}}function Ye(e,t){H=e,ee&&ee.setCurrentPath(H);var n=me.getVisibleSpace(),i={button:fe.mainDiv.addHomeBreadCrumb({cb:je}),path:e};i.node=new d("Navigation_"+fe.levels.length),i.node.setVisibility(1===me.getVisibleSpace()),i.node.setVisibilityFree(!1),i.node.setVisibilityInTree(!1),me.addNode(i.node),fe.levels.push(i);var o,a,s,l,c,u=[],m=[],p=[],g=e.getLastElement(!0);fe.levels[fe.levels.length-1].overridesMove=u,g.getChildren().forEach((function(t){var i=e.clone();i.addElement(t);var d=Ie(i);if(-1!==d)if(a=i.getBoundingBox(null,me,"visibleSpace"),s=i.getBoundingBox(null,me,"invisibleSpace"),P(a)&&P(s))(0===d&&n||1===d&&!n)&&p.push(Ve(t,e));else if(!P(o=n?a:s)){o=new x(o);var g=e.clone();g.addElement(t);var C=g.getMatrix(),v=(new r.Matrix4).copy(C),h=g.getWorldMatrix();o.applyMatrix4(h);var f=o.center(),D=Ue(o,null,!0);if(D&&(h=v=Le(f,D,h),(o=new x(i.getBoundingBox(null,me,n?"visibleSpace":"invisibleSpace"))).applyMatrix4(v),f=o.center()),l){var A=o.min(),S=new r.Vector3;S.x=f.x<c.x?l.min.x-Math.abs(f.x-A.x):l.max.x+Math.abs(f.x-A.x),S.y=c.y,S.z=l.min.z+(f.z-A.z);var E=(new r.Matrix4).setPosition(S.sub(f));o.applyMatrix4(E),v=(new r.Matrix4).copy(E).multiply(v),m.push({override:Re(g,u),matrixSource:C,matrixTarget:v,box:o,node:t}),l.union(new r.Box3(o.min(),o.max()))}else c=(new r.Vector3).copy(f),l=new r.Box3(o.min(),o.max()),m.push({override:Re(g,u),matrixSource:C,matrixTarget:v,box:o,node:t})}})),l||(l=new r.Box3(new r.Vector3,new r.Vector3)),!$&&t&&ue.getFrameWindow().getViewpoint().reframe("iso",0),he.addAnimation({animationType:"move",objectListToAnimate:m,duration:t?1e3:0,callBackFct:function(){t&&(me.render({updateInfinitePlane:!0}),$||we())}}),he.startAnimation(),Fe(p,new x(l),l),m.forEach(Oe)}function ze(t,n,i,o){he.forward();var a=[],s=[],l=t.getLastElement(!0),c=!1;if(T(l)&&!E.is3DLeaf(l)){c=!0;var u=de.createReferenceIterator(E.getNodeID(l)),m=l.getChildren().map(E.getNodeID,E),g=u.getChildren().map((function(e){return-1===m.indexOf(e.getInstanceId())?e.getReferenceIterator().getReferenceId():null})).filter((function(e){return e&&-1===Ce.indexOf(e.refID)}));g.length&&(Ce=Ce.concat(g),de.lockNodes({ids:g})),l.children.forEach((function(e){var n=t.clone();n.addElement(e),-1!==Ie(n)&&a.push(n)}))}else if(M(l)){var C=t.clone();C.addElement(l.children[0]),ze(C,n,i,o)}if(a.length||c){H=t,qe(),ee&&ee.setCurrentPath(H),fe.levels&&fe.levels.length&&fe.levels[fe.levels.length-1].node&&me.removeNode(fe.levels[fe.levels.length-1].node);var v=[],h=H.externalPath.length>1?H.externalPath[H.externalPath.length-2]:null;M(h)&&1===h.parents.length?s=s.concat(H.getParentPath().getSiblingsPathes()):h&&h===ve&&(s=s.concat(H.getSiblingsPathes())),s.length&&he.addAnimation({animationType:"mask",objectListToAnimate:[{override:Re(s,v),duration:i?1e3:0}]});var f={path:H,node:new d("Navigation_"+fe.levels.length),overridesHide:v,pathReference:n};f.node.setVisibility(1===me.getVisibleSpace()),f.node.setVisibilityFree(!1),f.node.setVisibilityInTree(!1),fe.levels.push(f);var A=l.getChildren().every((function(t){var n=t.getChildren();return 0===n.length||(1!==n.length?(e.log("Instance or RepInstance with no or more than one Reference or RepReference"),!1):E.isPLMNode(n[0])?!!E.is3DLeaf(n[0]):(e.log("Navigation to a non PAD3DViewer node should not be possible"),!0))})),S=E.getNodeID(l),y=[S],b=E.getNodeID(H.externalPath[H.externalPath.length-2]);b&&y.push(b),f.button||(f.button=fe.mainDiv.addBreadCrumb({cb:je,lastBreadCrumb:A})),ue.getController().getAttributes({ids:y,attributes:["ds6w:label"],callbacks:{onComplete:function(e){var t=e[S]?e[S]["ds6w:label"]:"";b&&e[b]&&e[b]["ds6w:label"]&&(t+=" ("+e[b]["ds6w:label"]+")"),fe.mainDiv&&fe.mainDiv.setLabel(f.button.idthumb,t)},onFailure:function(){}}}),a.length?function(t){var n,i,o=t.path.getWorldMatrix(),a=(new r.Matrix4).getInverse(o),s=me.getVisibleSpace(),l=t.pathReference?t.pathReference.getLastElement(!0):null,c=[];if(!l){var u=0;t.pathsToExplode.forEach((function(e){var n,i=e.getBoundingBox(null,me,"visibleSpace"),a=e.getBoundingBox(null,me,"invisibleSpace");P(i)&&P(a)||(P(i)?n=0:((i=new x(i)).applyMatrix4(o),n=(i.maxX()-i.minX())*(i.maxY()-i.minY())),n>u&&(u=n,t.pathReference=e,l=e.getLastElement(!0)))}))}if(!$&&t.applyViewpoint&&ue.getFrameWindow().getViewpoint().reframe("iso",0),!t.pathReference){var d=fe.levels[fe.levels.length-2].node.getChildByName("EmptyNodes");t.pathsToExplode.forEach((function(e){c.push(Ve(e.getLastElement(!0),t.path))}));var m=(new r.Vector3).getPositionFromMatrix(d?d.getMatrix():o);return n=new x(i=new r.Box3(new r.Vector3(m.x-N,m.y-54,m.z),new r.Vector3(m.x,m.y+54,m.z))),he.startAnimation(),Fe(c,n,i),t.startAnimation&&(me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0})),void(t.applyViewpoint&&we())}var p=[];fe.levels[fe.levels.length-1].overridesMove=p;var g=t.pathReference.getMatrix(),C=(new r.Matrix4).multiplyMatrices(o,g);P(n=t.pathReference.getBoundingBox(null,me,s?"visibleSpace":"invisibleSpace"))&&(n=new r.Box3(new r.Vector3,new r.Vector3)),(n=new x(n)).applyMatrix4(C);var v=_e(n,C),h=Ue(n,null,!1);if(h){var f={override:Re(t.path,p),matrixSource:o,matrixRotation:h,centerRotation:v,matrixParentInv:(new r.Matrix4).getInverse(t.path.getParentPath().getWorldMatrix())};he.addAnimation({animationType:"rotate",objectListToAnimate:[f],duration:t.startAnimation?500:0,callBackFct:function(){t.startAnimation&&me.render({updateInfinitePlane:!0})}}),o=Le(v,h,o),a=(new r.Matrix4).getInverse(o),C=(new r.Matrix4).multiplyMatrices(o,g),(n=new x(t.pathReference.getBoundingBox(null,me,s?"visibleSpace":"invisibleSpace"))).applyMatrix4(C),v=_e(n,C)}var D=n.minZ();if(!_){var A=t.path.getBoundingBox(null,me,s?"visibleSpace":"invisibleSpace");A&&(A.applyMatrix4(o),D=A.min.z)}var S={path:t.pathReference,override:Re(t.pathReference,p),node:l,matrixSource:g,matrixTarget:g,worldMatrixTarget:C,box:n};S.vectorZMatrix=(new r.Matrix4).setPosition(new r.Vector3(0,0,D-n.minZ())),n.applyMatrix4(S.vectorZMatrix);var E=[S],y={min:[],max:[]},b={min:[],max:[]};y.min.dir=new r.Vector3(-1,0,0),y.max.dir=new r.Vector3(1,0,0),b.min.dir=new r.Vector3(0,-1,0),b.max.dir=new r.Vector3(0,1,0),t.pathsToExplode.forEach((function(e){if(!e.isEqual(t.pathReference)){var n=e.getBoundingBox(null,me,"visibleSpace"),i=e.getBoundingBox(null,me,"invisibleSpace");if(P(n)&&P(i))c.push(Ve(e.getLastElement(!0),t.path));else{var l=s?n:i;if(!P(l)){l=new x(l);var u={path:e,node:e.getLastElement(!0)};E.push(u),u.override=Re(u.path,p),u.matrixSource=u.path.getMatrix();var d,m=(new r.Matrix4).multiplyMatrices(o,u.matrixSource),g=(new r.Matrix4).getInverse(m);l.applyMatrix4(m),u.worldMatrixSource=m.clone();var C=new r.Vector3;l.center(C),Math.abs(l.maxX()-l.minX())>Math.abs(l.maxY()-l.minY())?(u.valueForSort=C.y,C.y<v.y?b.min.push(u):b.max.push(u),d=(new r.Vector3).copy(y.max.dir)):(u.valueForSort=C.x,C.x<v.x?y.min.push(u):y.max.push(u),d=(new r.Vector3).copy(b.max.dir));var h=Ue(l,d,!1);h&&(u.matrixRotation=h,u.centerRotation=C,u.matrixParent=o,u.matrixParentInv=a,m=Le(C,h,m),l.applyMatrix4(g),l.applyMatrix4(m),g.getInverse(m)),u.vectorZMatrix=(new r.Matrix4).setPosition(new r.Vector3(0,0,D-l.minZ())),l.applyMatrix4(u.vectorZMatrix),u.box=l}}}})),y.min.sort(Be),y.max.sort(ke),b.min.sort(Be),b.max.sort(ke);var T=0;T+=y.min.length?0:1,T+=y.max.length?0:1,T+=b.min.length?0:1,3===(T+=b.max.length?0:1)&&(y.min.length||y.max.length?v.x=y.min.length?y.min[0].box.maxX():y.max[0].box.minX():v.y=b.min.length?b.min[0].box.maxY():b.max[0].box.minY()),i=new r.Box3(new r.Vector3(n.minX(),n.minY(),n.minZ()),new r.Vector3(n.maxX(),n.maxY(),n.maxZ())),Xe(y.min,i),Xe(y.max,i),Ge(b.min,i),Ge(b.max,i);var M=[y.min,y.max,b.min,b.max];M.sort((function(e,t){return e.delta-t.delta})),M.forEach((function(e){e===y.min?y.min.forEach((function(e,t,n){i=He(a,i,e,n,-1*((i?i.min.x:v.x)-e.box.maxX()))})):e===y.max?y.max.forEach((function(e,t,n){i=He(a,i,e,n,(i?i.max.x:v.x)-e.box.minX())})):e===b.min?b.min.forEach((function(e,t,n){i=He(a,i,e,n,-1*((i?i.min.y:v.y)-e.box.maxY()))})):e===b.max&&b.max.forEach((function(e,t,n){i=He(a,i,e,n,(i?i.max.y:v.y)-e.box.minY())}))}));var w,R=[],I=[];E.forEach((function(t){t.matrixRotation&&(w=e.extend({},t),I.push(w),w.matrixSource=t.matrixTarget,w.worldMatrixTarget=Le(t.centerRotation,t.matrixRotation,t.worldMatrixTarget),t.centerRotation.applyMatrix4(a),w.matrixTarget=(new r.Matrix4).multiplyMatrices(a,w.worldMatrixTarget),t=w),w=e.extend({},t),R.push(w),w.matrixSource=t.matrixTarget,w.worldMatrixTarget.multiplyMatrices(t.vectorZMatrix,t.worldMatrixTarget),w.matrixTarget=(new r.Matrix4).multiplyMatrices(a,w.worldMatrixTarget)})),he.addAnimation({animationType:"move",objectListToAnimate:E,duration:t.startAnimation?300:0,offsetTime:h?500:0}),he.addAnimation({animationType:"rotate",objectListToAnimate:I,duration:t.startAnimation?400:0,offsetTime:h?800:300}),he.addAnimation({animationType:"move",objectListToAnimate:R,duration:t.startAnimation?300:0,offsetTime:h?I.length?1200:800:I.length?700:300,callBackFct:function(){t.startAnimation&&(me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0})),t.applyViewpoint&&we()}}),he.startAnimation(),me.render({updateInfinitePlane:!0}),Fe(c,n,i),E.forEach(Oe)}({path:f.path,pathsToExplode:a,pathReference:f.pathReference,startAnimation:i,applyViewpoint:o}):function(e,t,n){!$&&n&&ue.getFrameWindow().getViewpoint().reframe("iso",0);var i=new D({headLength:10,arrowLength:50,arrowWidth:2,head:D.types.ARROW});i.exludeFromBounding(!0),i.setVisibilityInTree(!1),i.setPickable(p.PICKTHROUGH);var o=fe.levels[fe.levels.length-2].node.getChildByName("EmptyNodes");o&&i.setMatrix(o.getMatrix()),fe.levels[fe.levels.length-1].node.addChild(i),he.axisSystemVisibility({objectListToAnimate:[i],visibility:!0,pickability:!1,callBackFct:function(){me.addNode(fe.levels[fe.levels.length-1].node),$||we()}}),he.startAnimation()}()}}function Ke(e){var t=e.gesture?e.gesture.getEvents()[0]:e.from[0],n=me.pick(me.getMousePosition(t.getCurrentPosition(me.canvas)),"mesh",!1);if(n.path&&n.path.length&&H){var i=n.path[0].getLastElement(!0);i.navigationAssociatedPath&&(n.path[0]=i.navigationAssociatedPath);var o=H.clone();if(n.path[0].externalPath.length>o.externalPath.length){o.addElement(n.path[0].externalPath[o.externalPath.length]);var a,r=M(o.externalPath[o.externalPath.length-1])?[0,1]:[0];n.path[0].externalPath.length>=o.externalPath.length+r.length&&(a=o.clone(),r.forEach((function(e){a.addElement(n.path[0].externalPath[o.externalPath.length+e])}))),l.empty(),c.empty(),De=[],ze(o,a,!0,!1)}}}function Je(e){if("ArrowLeft"===e.key||37===e.keyCode||"ArrowUp"===e.key||38===e.keyCode)fe.levels.length>1&&(document.removeEventListener("keydown",Je),fe.mainDiv.activate(fe.levels[fe.levels.length-2].button.idthumb),document.addEventListener("keydown",Je));else if(("ArrowRight"===e.key||39===e.keyCode||"ArrowDown"===e.key||40===e.keyCode)&&De.length>0){var t=De.pop();document.removeEventListener("keydown",Je),ze(t.path,t.pathReference,!0,!1),document.addEventListener("keydown",Je)}}function Ze(){!te&&(te=E.getRoots(ue).map(E.getNodeID,E).some(de.isLargeDataStructure,de))&&(ue.freezeProgressiveLoading?ue.freezeProgressiveLoading():de.pauseProgressiveLoading())}function Qe(){te&&(ue.unfreezeProgressiveLoading?ue.unfreezeProgressiveLoading():de.resumeProgressiveLoading()),te=!1}var $e,et=function(e,t){var n,i,o,a,r,s;if(t===Ae[0]?Ze():t===Ae[1]&&(Qe(),Ze()),t===Ae[2]){for($e=!0,fe.levels.forEach((function(e){me.removeNode(e.node),e.node=null})),i=fe.levels.length-1;i>0;--i)fe.mainDiv.removeBreadCrumb(i-1);return Ce.length&&de.unlockNodes({ids:Ce}),void(Ce=[])}if($e&&t===Ae[3]){$e=!1;var l=ue.getController();fe.levels.forEach((function(e,t,i){if(0!==t){var s=e.path,c=i[t-1].path.clone();for(o=c.externalPath.length,a=s.externalPath.length;o<a&&(n=E.getNodeID(s.externalPath[o]),r=l.getNode({id:n}));++o)c.addElement(r);var u=e.pathReference,d=u?c.clone():void 0;if(d)for(o=d.externalPath.length,a=u.externalPath.length;o<a&&(n=E.getNodeID(u.externalPath[o]),r=l.getNode({id:n}));++o)d.addElement(r);e.path=c,e.pathReference=d}}))}if(!$e){he.forward(),pe.removeSceneGraphOverrideSet(u),u=null,fe.mainDiv.destroy(),J=[],fe.levels.forEach((function(e){me.removeNode(e.node),e.node=null,J.push({path:e.path,pathReference:e.pathReference})})),fe.mainDiv=new C({parentFrame:ue.getFrameWindow().getUIFrame()}),fe.levels=[],u=new A(ue.getRootBagPath().externalPath[0]),pe.pushSceneGraphOverrideSet(u);var c,d=J;for((t===Ae[0]&&(c=E.getRoots(ue))&&1===c.length&&!E.is3DLeaf(c[0])&&(1===d.length||d.length>1&&!b(d[1].path))||t===Ae[1]&&d.length>1&&!b(d[1].path)&&(c=E.getRoots(ue))&&1===c.length&&!E.is3DLeaf(c[0]))&&((s=d[0].path.clone()).addElement(c[0]),d.length=1,d.push({path:s})),ee&&ee.setCurrentPath(H=null),i=0;i<d.length;++i)if(0===i)Ye(d[i].path,d.length-1===i);else{if(!b(s=d[i].path)||-1===Ie(s)){he.startAnimation(),me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0});break}ze(s,d[i].pathReference,d.length-1===i,!1)}he.forward()}};function tt(){ue.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,t){var n=c.get();if(0!==n.length){var i=E.getRoots(ue),o=[],a=!1,s=n.some((function(e){var t=e.pathElement.getLastElement(!0);return i.some((function(n){var i=n!==t,o=e.pathElement.externalPath.some((function(e){return n===e}));return!a&&o&&(a=!0),i&&o}))}));if(a&&t&&t.withContextMenu&&"number"==typeof t.XmousePosition&&"number"==typeof t.YmousePosition)0===me.pick(me.getMousePosition(new r.Vector2(t.XmousePosition,t.YmousePosition)),"mesh",!1).path.length&&(s=a=!1);return s&&v.getExamineController({context:ue}).canBeEnabled()&&o.push({name:"CATC3DNavigationExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"],type:"handler",identifier:"CAT3DComposeExamineSelectionHdr"}),_||!a||1!==n.length||E.is3DLeaf(n[0].pathElement.getLastElement(!0))||o.push({name:"CATC3DNavigationOnChildStr",line:1,hdr_list:["CATC3DNavigationOnChildHdr"],type:"handler",identifier:"CATC3DNavigationOnChildHdr"}),ue.getExecutionContext?o.length?{WAfrCtxBarRow1:{model:o}}:void 0:o.length?{cmdList:o}:void 0}},context:ue.getCommandContext?ue.getCommandContext():null,workbenchName:"CATC3DNavigation",module:"CATC3DNavigation",cmdPrefix:"",merge:!0,subscriberId:"CATC3DNavigation_"+ ++I})}this.start=function(){ge=!0,Ze(),(Q=new y).store(ue.getFrameWindow().getViewpoint()),q=me.backgroundColor,K(),ne=ue.isRobotVisible(),ue.setRobotVisibility(!1),ue.setDefaultContextualBarVisibility(!1),G=me.picking.primitive,S=me.pPicking.primitive,me.setPrePicking({primitive:0}),me.setPicking({primitive:0}),ie=s.onPreAdd(xe),oe=l.onPreAdd(ye),ae=l.onRemove(Te),re=c.onPreAdd(be),Z=h.getTooltipManager({context:ue}),se=Z.register({onTooltipReady:Pe,filterPath:Me}),Ae.push(ue.subscribe({event:"onLoadingComplete"},et)),Ae.push(ue.subscribe({event:"onEndRootRemoved"},et)),Ae.push(ue.subscribe({event:"onRefreshBegin"},et)),Ae.push(ue.subscribe({event:"onEndProgressiveLoad"},et)),Ae.push(ue.subscribe({event:"onRootDetached"},et)),Ae.push(ue.subscribe({event:"onRootAttached"},et)),Ae.push(ue.subscribe({event:"onAuthoringTransactionEnd"},et)),Ae.push(ue.subscribe({event:"onShow"},et)),Ae.push(ue.subscribe({event:"onHide"},et)),Ae.push(ue.subscribe({event:"onEndDelete"},et)),Ae.push(ue.subscribe({event:"onEndMatriceUpdate"},et)),ce=me.onSwapVisibleSpace?me.onSwapVisibleSpace(et):null,(ee=f.getDropManager({context:ue})).connect(),le=ee.subscribe({event:"onEndInsertDrop3D"},et),u=new A(ue.getRootBagPath().externalPath[0]),pe.pushSceneGraphOverrideSet(u),n.addEvent(me.canvas,"onLeftDoubleClick",Ke),n.addEvent(me.canvas,"onDoubleTap",Ke),fe.mainDiv=new C({parentFrame:ue.getFrameWindow().getUIFrame()}),fe.levels=[];var e,t=[];if(H&&b(H)&&J&&0!==J.length)t=J;else{t.push({path:ue.getRootBagPath()});var i=E.getRoots(ue);1!==i.length||E.is3DLeaf(i[0])||((e=t[0].path.clone()).addElement(i[0]),t.push({path:e})),$=null}H=null,ee&&ee.setCurrentPath(H);for(var o=0;o<t.length;++o)if(0===o)Ye(t[o].path,t.length-1===o);else{if(!b(e=t[o].path)||-1===Ie(e)){he.startAnimation(),me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0}),we();break}ze(e,t[o].pathReference,t.length-1===o,t.length-1===o)}document.addEventListener("keydown",Je),tt()},this.end=function(){ge=!1,he.stop(),ue.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+I),document.removeEventListener("keydown",Je),qe(),ue.setRobotVisibility(ne),ue.setDefaultContextualBarVisibility(!1),me.setPicking({primitive:G}),me.setPrePicking({primitive:S}),ee.disconnect(),ee.unsubscribe(le),s.unsubscribe(ie),l.unsubscribe(oe),c.unsubscribe(re),l.unsubscribe(ae),Z.unregister(se),h.unreferenceTooltipManager({context:ue}),ie=oe=re=ae=se=ee=le=null;for(var e=l.get(),t=e.length-1;t>=0;--t){var i=e[t];i&&i.pathElement.externalPath[0]!==ve&&i.pathElement.getLastElement(!0).navigationAssociatedPath&&(l.remove(i),i.pathElement=i.pathElement.getLastElement(!0).navigationAssociatedPath.clone(),l.isIn(i)||l.add(i))}Ce.length&&de.unlockNodes({ids:Ce}),Ce=[],Ae.forEach((function(e){ue.unsubscribe(e)})),Ae=[],me.unsubscribe(ce),ce=null;var o=ue.getFrameWindow().getViewpoint();$&&$.store(o,b(H)?H.getWorldMatrix():null),Q.restore(o),pe.removeSceneGraphOverrideSet(u),u=null,n.removeEvent(me.canvas,"onLeftDoubleClick",Ke),n.removeEvent(me.canvas,"onDoubleTap",Ke),fe.mainDiv.destroy(),J=[],fe.levels.forEach((function(e){me.removeNode(e.node),J.push({path:e.path,pathReference:e.pathReference})})),fe={},De=[],Qe(),me.render({updateInfinitePlane:!0})},this.pause=function(){ie&&ge&&(document.removeEventListener("keydown",Je),me.setPicking({primitive:G}),me.setPrePicking({primitive:S}),s.unsubscribe(ie),ie=void 0,l.unsubscribe(oe),oe=void 0,l.unsubscribe(ae),ae=void 0,c.unsubscribe(re),re=void 0,Z.unregister(se),se=void 0,n.removeEvent(me.canvas,"onLeftDoubleClick",Ke),n.removeEvent(me.canvas,"onDoubleTap",Ke),ue.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+I),fe.mainDiv.hide(),fe.levels[fe.levels.length-1].node&&me.removeNode(fe.levels[fe.levels.length-1].node))},this.resume=function(){!ie&&ge&&(G=me.picking.primitive,S=me.pPicking.primitive,me.setPrePicking({primitive:0}),me.setPicking({primitive:0}),ie=s.onPreAdd(xe),oe=l.onPreAdd(ye),ae=l.onRemove(Te),re=c.onPreAdd(be),se=Z.register({onTooltipReady:Pe,filterPath:Me}),n.addEvent(me.canvas,"onLeftDoubleClick",Ke),n.addEvent(me.canvas,"onDoubleTap",Ke),document.addEventListener("keydown",Je),tt(),fe.mainDiv.show(),fe.levels[fe.levels.length-1].node&&me.addNode(fe.levels[fe.levels.length-1].node))},this.navigateOnChild=function(e){var t=e&&e.pathToExplode?e.pathToExplode:null;[1,2].some((function(){return(t=t?t.getParentPath():null)?t.isEqual(H):null}))&&(l.empty(),c.empty(),De=[],ze(e.pathToExplode,null,!0,!1))}}})})),define("DS/CATC3DNavigation/CATC3DNavigationStartCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUCommandsManager","DS/CATC3DNavigation/CATD3CBoxNavigation","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(t,n,i,o,a){var r=t.extend({init:function(t){var r=this;this._parent(t,{mode:"exclusive",isAsynchronous:!1}),this.beginExecute=function(){var t=e.getNavigationObject({context:n.get()}),a=this._ctx;t.onExit&&t.onExit.actionBar&&t.onExit.actionBar.length&&t.onStart&&t.onStart.onStart&&(t.done=function(){if(delete t.done,n.get().getExecutionContext){t.activated=!0,t.controller||(t.controller=new o({context:t.context})),t.controller.start(),n.get().getExecutionContext().switchApp("CATC3D_AP","C3DSelection_AP").then((()=>{r.done()}))}else{var e=t.context.subscribe({event:"onActionBarReady"},(function(){t.context.unsubscribe(e),i.setDefaultCommand({ID:"CATD3CNavigationDefaultHdr",className:"DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",context:a}),t.activated=!0,t.controller||(t.controller=new o({context:t.context})),t.controller.start()}));t.context.loadActionBar({merge:!1,file:"CATC3DNavigation.xml",module:"CATC3DNavigation"})}},t.onStart.onStart(t)),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(e){e._sendUsageProbe("command","StructureMode")}))};var s=n.get(),l=s.subscribe({event:"onRootAdded"},(function(){1===a.getRoots(s).length&&r.enable()})),c=s.subscribe({event:"onEndRootRemoved"},(function(){0===a.getRoots(s).length&&r.disable()}));0===a.getRoots(s).length&&this.disable(),this.cancelExecute=function(){this.done&&this.done()},this._destroy=function(){s.unsubscribe(l),l=null,s.unsubscribe(c),c=null,Object.getPrototypeOf(this)._destroy.apply(this,arguments),r=null}}});return r}));var t=function(e,t,n){["_commands","_cmdCheckHeader"].forEach((function(i){var o=n?e[i][n]:e[i];o[t]&&(o[t]._destroy&&o[t]._destroy(),delete o[t])}))};define("DS/CATC3DNavigation/CATC3DNavigationEndCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUCommandsManager"],(function(n,i,o){var a,r="CATC3DNavigation";return r+=require("DS/CAT3DComposeUI/CAT3DComposeWidgetOptions").getOption("authoring3d")?"Next":"",require(["text!DS/CATC3DNavigation/assets/afr/"+r+".xml"],(function(e){a=e})),n.extend({init:function(n){let r=this;this._parent(n,{mode:"exclusive",isAsynchronous:!1}),this.beginExecute=function(){var n=e.getNavigationObject({context:i.get()});if(n.activated=!1,n.controller&&n.controller.end(),i.get().getExecutionContext){i.get().getExecutionContext().switchApp("CATC3D_AP","CATC3D_AP").then((()=>{n.onExit.actionBar[0]&&n.onExit.actionBar[0].onActionBarReady&&n.onExit.actionBar[0].onActionBarReady(),r.done()}))}else{var s={lastCommand:[],currentCommand:null,defaultCommand:null};this._ctx?o._commandsState[this._ctx]=s:o._commandsState=s,o.resetDefaultCommand(this._ctx),t(o,"CATD3CNavigationDefaultHdr",this._ctx);for(var l=(new DOMParser).parseFromString(a,"text/xml").getElementsByTagName("CATCommandHeader"),c=l.length-1;c>=0;--c){var u=l[c].attributes.getNamedItem("ClassName").value;if(!u.startsWith("DS/ViewerCommands")&&!u.startsWith("DS/ENOPAD3DViewer")&&!u.startsWith("DS/PADUtils")){var d=l[c].attributes.getNamedItem("ID").value;"CAT3DComposeExamineSelectionHdr"!==d&&t(o,d,this._ctx)}}var m=0,p=n.context.subscribe({event:"onActionBarReady"},(function(){n.onExit.actionBar[m-1].onActionBarReady&&n.onExit.actionBar[m-1].onActionBarReady(),m<n.onExit.actionBar.length?(n.context.loadActionBar({merge:!0,file:n.onExit.actionBar[m].file,module:n.onExit.actionBar[m].module}),m++):n.context.unsubscribe(p)}));n.context.loadActionBar({merge:!1,file:n.onExit.actionBar[0].file,module:n.onExit.actionBar[0].module}),m++}},this.cancelExecute=function(){this.done&&this.done()}}})})),define("DS/CATC3DNavigation/CATC3DNavigationOnChildCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/Selection/CSOManager"],(function(t,n,i){return t.extend({init:function(t){this._parent(t,{mode:"exclusive",isAsynchronous:!1}),this.beginExecute=function(){var t=n.get(),o=i.get(),a=1===o.length?o[0].pathElement:null,r=a?e.giveNavigationObject({context:t}):null;t.getFrameWindow().getContextualUIManager().hideContextualMenus(),r&&setTimeout((function(){r.controller.navigateOnChild({pathToExplode:a})}),0),this.done&&this.done()}}})})),define("DS/CATC3DNavigation/CATC3DNavigationContoller",["UWA/Class"],(function(t){return t.singleton({init:function(){},getNavigationContoller:function(t){return e.getNavigationObject({context:t.context}).controller},isNavigationActivated:function(t){var n=e.giveNavigationObject({context:t.context});return!!n&&n.activated},onNavigationStart:function(t){var n=e.getNavigationObject({context:t.context});n.activated||(n.onStart=t.start)},onNavigationExit:function(t){var n=e.getNavigationObject({context:t.context});n.activated||(n.onExit=t.exit)}})}))}(),define("DS/CAT3DComposeCommands/CATC3DPasteAtLocalCoordinatesCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/DMUCommandsManager","DS/CATW3DMoveManager/CATW3DMoveManager"],(function(e,t,n,i,o,a){"use strict";var r=new i.Matrix4;let s,l,c;var u=e.extend({init:function(e){this._parent(e),c=this,s=a.getMoveManager({context:n.get()}),this.onStateChange((function(){c.getState()&&u.PasteAtLocalCoordinates()})),this.toggleState=function(){c.getState()||c.setState(!0)},this._destroy=function(){Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),c=void 0}}});return u.PasteAtLocalCoordinates=function(e,i){let c=[];!l&&i?l=i.executionContext.getComponent("Viewer"):l||i||(l=n.get()),s=a.getMoveManager({context:l});var d=[];let m;if(t.get().forEach((function(e){d.push({path:e.pathElement});var t=s.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(r)||c.push({pathElement:e.pathElement,path:t,matrix:n})}})),c.length&&require(["DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd"],(function(t){t&&t.storeOriginalPositionMatrix(e,c)})),d.length&&(s.onMoveBegin({objectsMoved:d,from:u,moveMode:"Persistent"}),s.onMove({objectsMoved:d,from:u,leafMatrix:r}),s.onMoveEnd({from:u,status:"Moved"}),l.getViewer().render()),i&&(m=i.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent)),m)m.setCheckState({id:"PasteAtOriginalPosition",state:!1});else{var p=n.get();o.getCommandCheckHeader("CATC3DPasteAtOriginalPositionHdr",p.getCommandContext?p.getCommandContext():null).setState(!1)}e&&e()},u.clean=function(e){c&&c.setState&&c.setState(!1),e&&e()},u})),define("DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXComponents/DMUCommandsManager"],(function(e,t,n,i,o,a){"use strict";var r=new i.Matrix4;let s,l,c,u,d,m=this,p=[],g=[],C=null;var v=e.extend({init:function(e){this._parent(e),m=this,g=[],c=n.get().getFrameWindow().getContextualUIManager(),u=o.giveMoveManager({context:n.get()}),d=function(){l=[],c.hideContextualMenus(),t.get().forEach((function(e){var t=u.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(r)||l.push({pathElement:e.pathElement,path:t,matrix:n})}})),l.length>0&&(c.showContextualBar({x:n.get().getViewer().SCREEN_WIDTH/2,y:n.get().getViewer().SCREEN_HEIGHT/2,hideWithDistance:!1,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"]},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"]}]}},context:n.get().getCommandContext?n.get().getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]}),m.setState(!0))},C=n.get().subscribe({event:"onAuthoringTransactionEnd"},d),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(e){var t=e.getDropManager({context:n.get()});g.push(t.subscribe({event:"onBeginInsertDrop3D"},(function(){n.get().unsubscribe(C)}))),g.push(t.subscribe({event:"onEndInsertDrop3D"},(function(e){e&&"inPosition"===e.type&&d(),C=n.get().subscribe({event:"onAuthoringTransactionEnd"},d)})))})),this.onStateChange((function(){m.getState()&&v.PasteAtOriginalPosition()})),this.toggleState=function(){this.getState()||m.setState(!0)},this._destroy=function(){n.get().unsubscribe(C),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(e){var t=e.getDropManager({context:n.get()});t&&g.forEach((function(e){t.unsubscribe(e)})),g=[]})),Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),u=l=C=c=d=m=void 0}}});return v.PasteAtOriginalPosition=function(e,i){!s&&i?s=i.executionContext.getComponent("Viewer"):s||i||(s=n.get()),u=o.giveMoveManager({context:s});let r,l=[];if(t.get().forEach((function(e){let t=p.find((t=>t.pathElement===e.pathElement));t&&l.push({pathElement:e.pathElement,path:t.path,matrix:t.matrix})})),l&&l.length>0&&(u.onMoveBegin({objectsMoved:l,from:v,moveMode:"Persistent"}),l.forEach((function(e){!e.path.getMatrix().equals(e.matrix)&&t.isIn(e)&&u.onMove({objectsMoved:[e],from:v,leafMatrix:e.matrix})})),u.onMoveEnd({from:v,status:"Moved"}),s.getViewer().render()),i&&(r=i.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent)),r)r.setCheckState({id:"PasteAtLocalCoordinates",state:!1});else{var c=n.get();a.getCommandCheckHeader("CATC3DPasteAtLocalCoordinatesHdr",c.getCommandContext?c.getCommandContext():null).setState(!1)}e&&e()},v.clean=function(e){m&&m.setState&&m.setState(!1),e&&e()},v.storeOriginalPositionMatrix=function(e,t){p=t,e&&e()},v})),define("DS/CAT3DComposeWidget/C3DAppInit",["DS/WAfrContainer/App","UWA/Core","DS/Controls/Loader"],(function(e,t,n){"use strict";var i,o,a,r;return e.extend({setUp:function(e){if(e.sourceApp&&this.options.id===e.sourceApp.options.id)return e.sourceApp.pad3DViewer&&(this.pad3DViewer=e.sourceApp.pad3DViewer),e.sourceApp.appMainDiv&&(this.appMainDiv=e.sourceApp.appMainDiv),Promise.resolve();var s=this;if(a=s.getExecutionContext(),o=a.getComponent("Viewer"),window.widget.getValue("X3DContentId")){var l="",c=JSON.parse(window.widget.getValue("X3DContentId"));c.data&&c.data.items&&c.data.items[0]&&c.data.items[0].displayName&&(l=c.data.items[0].displayName);var u=t.createElement("div",{class:"DMULoadingPanel"}).inject(document.body);(r=new n({text:"Loading "+l}).inject(u)).on(),r.getContent().addClassName("DMULoadingPanelInfoDiv");var d=r.elements.label.getSize().width,m=r.elements.progressBar.getContent().getSize().width,p=r.elements.progressBar.getContent().getSize().height,g=d+m;u.setStyles({position:"absolute",bottom:"0",left:"0","z-index":"40000","background-color":"rgba(255,255,255,1",height:"100%",width:"100%"}),r.getContent().setStyles({position:"absolute",left:"calc(50% - "+g/2+"px)",top:"calc(50% - "+p/2+"px)"})}return e.sourceApp?e.sourceApp.pad3DViewer?(this.pad3DViewer=e.sourceApp.pad3DViewer,this.appMainDiv=e.sourceApp.appMainDiv,void new Promise((function(t){i?(e.done&&e.done(),t()):require(["DS/CAT3DComposeWidget/C3DMain"],(function(n){i=new n({widget:window.widget,executionContext:a,pad3DViewer:o,appMainDiv:e.sourceApp.appMainDiv}),e.done&&e.done(),t()}))})).then((function(){e.sourceApp&&!e.sourceApp.isDisposeCalled()&&e.sourceApp.dispose();var t=e.done;e.done=function(n){s.appMainDiv||(s.appMainDiv=n.appMainDiv),e.done=t,e.done()},i.setUp(e)}))):(window.console.log("pad3DViewer property must be valuated"),void e.done()):new Promise((t=>{require(["DS/CAT3DComposeWidget/C3DMain"],(function(t){i=new t({widget:window.widget,pad3DViewer:o,executionContext:a,viewerAttachment:e.done,done:function(e){s.pad3DViewer=e.pad3DViewer,s.appMainDiv=e.appMainDiv}})})),e.done&&e.done(),t()}))},dispose:function(e){if(o&&o.getExecutionContext){let e=a.getSourceApp(),t=a.getTargetApp();if(e&&t&&e.options.id===t.options.id)return}i.dispose(e),r&&(r.destroy(),r=null);var t=window.document.getElementsByClassName("DMULoadingPanel");t.length&&t[0].destroy(),this._parent(e)},onWillEnter:function(e){return this.options.id===e.options.id?Promise.resolve():(require(["DS/CAT3DComposeUtils/CATC3DUtils","DS/PADUtils/PADSettingsMgt"],(function(t,n){n.setSetting("enopad3dviewer_staticMappingSupportActivated",!0),t._sendUsageProbe("appTransitionFrom",e.options.id,"resolved")})),this._parent(e))},onWillLeave:function(e){return this.options.id===e.options.id?Promise.resolve():(i&&i.onWillLeave&&i.onWillLeave(e),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(t){t._sendUsageProbe("appTransitionTo",e.options.id,"resolved")})),this._parent(e))}})})),define("DS/CAT3DComposeWidget/C3DMain",["UWA/Core","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","DS/CATWebUXComponents/DMUFrameWindow","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Selection/CSOManager","DS/CATWebUXComponents/CATWebUXUtils","DS/CATW3DCommands/CATW3DCmdsUtils"].concat(["i18n!DS/DMUBaseUIComponents/assets/nls/DMUBaseUIComponents"]),(function(e,t,n,i,o,a,r,s,l,c,u){"use strict";return class{constructor(o){let d,m,p,g,C,v,h=o.widget,f=o.pad3DViewer,D=o.executionContext,A=o.appMainDiv,S=f?f.getCommandContext():null,E=!1;var x,y,b,T,M,P,w,R,I,N,U=[];function L(e,t,n){window.top.performance.measure(h.id+e,n?h.id+t:t)}function _(e){window.top.performance.mark(h.id+e)}function W(e){require(["DS/Selection/HSOManager"],(function(e){setTimeout((function(){e.empty(),e.add(s.get())}),100)}))}function O(){window.widget.deleteValue("X3DContentId"),F()}function F(){d&&d.getContentName({callbacks:{onComplete:function(e){h.setTitle(e.contentName),d&&d.getFrameWindow()&&d.getFrameWindow().getContextualUIManager()&&d.getFrameWindow().getContextualUIManager().hideContextualMenus()},onFailure:function(){}}})}function V(e,t){e.objectsMoved.length>0&&"Persistent"===e.moveMode&&document.querySelector(".c3dMoveCmdDlg")&&(e.objectsMoved.forEach((function(e){var n=e.path.getLastElement(!0);c.isPLMInstanceNode(n)&&t&&(t.showSpinner(),y.isPathLocked({pathElement:e.path,onCompleted:function(e){t&&(t.hideSpinner(),e.isLocked?t.showLock():t.showSave())}}))})),T&&r.unsubscribe(T),T=void 0)}f&&n.init(f,{executionContext:D});let k=[];function B(e,t,n){require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],(function(e){e.onNavigationStart({context:d,start:{onStart:function(e){t.getDropManager({context:d}).disconnect();var n=w.giveMove3DRobot({context:d});n&&n.unreference(),p=e;var i=d.getExecutionContext().getSourceApp().options.appConfig.handlers;const o=d.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);let a=[];i.check.forEach((e=>{let t=e.identifier,n=e.check.code.module;n.startsWith("DS/ViewerCommands")||n.startsWith("DS/ENOPAD3DViewer")||n.startsWith("DS/PADUtils")||t.includes("CATRelatedData3DGridAuto")||o.hasCheckHandler(t)&&o.isCheckExecutable(t)&&o.getCheckState({id:t})&&(k.push(t),a.push(o.setCheckState({id:t,state:!1})))})),Promise.all(a).then((()=>e.done()))}}}),e.onNavigationExit({context:d,exit:{actionBar:[{file:"",module:"",onActionBarReady:function(){n.getMove3DRobot({context:d}),p=null,d.setDefaultContextualBarVisibility(!1),d.setDefaultContextualMenuVisibility(!0),d.setOpenWithMenuAvailability(!0),t.getDropManager({context:d}).connect();const e=d.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);k.reverse().forEach((t=>{e.hasCheckHandler(t)&&e.isCheckExecutable(t)&&!e.getCheckState({id:t})&&e.setCheckState({id:t,state:!0})})),k.length=0,setTimeout((function(){let e=d;var t={x:d.getViewer().div.clientWidth/2,y:d.getViewer().div.clientHeight/2};e.getFrameWindow().getExecutionContext,e.getFrameWindow().getContextualUIManager().hideContextualMenus(),e.getFrameWindow().getExecutionContext?e.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!1,x:t.x,y:t.y}):e.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!1,x:t.x,y:t.y})}),100)}}]}})}))}function X(e){x&&w&&P&&M&&!g&&(B(0,P,w),m&&m(A),m=null,L("_C3D_Global widget creation time","C3D_jsAppLoad",!1),h.dispatchEvent("onWidgetAndAppReady","1"===h.getValue("widgetForODTReplay")?[{pad3DViewer:e}]:void 0))}function G(e){L("_C3D_PAD3DViewer creation","_C3D_PAD3DViewerReady",!0),e.unsubscribe(g),g=null,X(e)}function H(e){e.unsubscribe(C),C=null,F(),require("DS/PADUtils/PADUtilsServices").isCloud()&&!window.__preventPrefPanel&&e.getViewer().displayIntroductoryControlPreferencePanel(),_("_C3D_beforeRobotAndDirectMoveLoad"),require(["DS/CATW3DRobot/CATW3DRobot","DS/CAT3DComposeUtils/CATC3DDropManager"],(function(t,n){L("_C3D_Applicative Init JS Loading","_C3D_beforeRobotAndDirectMoveLoad",!0),_("_C3D_afterRobotAndDirectMoveLoad"),(w=t).getMove3DRobot({context:e}),e.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClic(),L("_C3D_Applicative Init","_C3D_afterRobotAndDirectMoveLoad",!0),(P=n).getDropManager({context:e}).connect(),function(e){v&&e.unsubscribe(v),v=null,_("_C3D_ownCommands"),L("_C3D_Action Bar merge app commands","_C3D_ownCommands",!0),_("_C3D_beforeDefaultCmdLoad"),S=d.getCommandContext(),(M=require("DS/CATWebUXComponents/DMUCommandsManager")).refreshCommandsManager(f.getExecutionContext()),y=x.getMoveManager({context:d,saveToDatabase:!0}),b||(b=y.subscribe("Move",(function(e){e.objectsMoved.length>0&&"Persistent"===e.moveMode&&(M.getCommand("DMUSnapCmdHdr",S).isRunning()||e.objectsMoved.forEach((function(t){let n=M.getCommand("CAT3DComposeMoveHdr",S);var i=t.path.getLastElement(!0);c.isPLMInstanceNode(i)&&(n.isRunning()||E||(T||(T=r.subscribe({event:"onNotifAgentDisplayed"},(t=>{V(e,t.notifAgent)}))),n.begin(),E=!0,setTimeout((function(){E=!1}),500)))})))}))),L("_C3D_Default Cmd Init","_C3D_beforeDefaultCmdLoad",!0)}(e),X(e),g=d.subscribe({event:"onReady"},G),d.getLandingPageComponent().appReady()}))}let q=function(e,t){var n=[],i=[],o=[];if(d._defaultContextualMenuVisibility&&void 0!==e&&void 0!==e.XmousePositionWithDevPxRatio&&void 0!==e.YmousePositionWithDevPxRatio&&d.getViewer()){var a=s.get(),r=t?{x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio}:{x:e.XmousePositionWithDevPxRatio,y:e.YmousePositionWithDevPxRatio};if(0===d.getViewer().pick({xPix:r.x,yPix:r.y},"mesh",!0).path.length)o.push({category:u.ctxMenuDisplayTitle,hdrs:l.isMobile()?["ENO3DToggleStatusBarCmd"]:["VisuQMCommand","ENO3DToggleStatusBarCmd"]},{category:u.ctxMenuAmbienceTitle,hdrs:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]});else if(a.length){let e=!1;for(let t=0;t<a.length;t++)for(var c=0;c<a[t].pathElement.externalPath.length;c++)a[t].pathElement.externalPath[c].getDMUType&&(e=!0);e||(i.push("ENO3DFocusOnCmd"),i.push("ENO3DReframeOnCmd"),i.push("ENO3DHideShowCmd"),i.push("ActionBar_Attributes"),o.push({category:u.ctxMenuQualityTitle,hdrs:["OptimizedQualityCmd","HighQualityCmd"]}))}for(let e=0;e<i.length;e++)"ENO3DToggleStatusBarCmd"===i[e]?n.push({type:"WAfrCheckHandlerItem",handlerId:i[e]}):n.push({type:"WAfrDefaultHandlerItem",handlerId:i[e]});return o.forEach((e=>{let t={type:"PushItem",title:e.category,submenu:[]};for(let n=0;n<e.hdrs.length;n++)"ENO3DToggleStatusBarCmd"===e.hdrs[n]?t.submenu.push({type:"WAfrCheckHandlerItem",handlerId:e.hdrs[n]}):t.submenu.push({type:"WAfrDefaultHandlerItem",handlerId:e.hdrs[n]});n.push(t)})),n}return n};function j(){require(["DS/CATWebUXComponents/DMUCommandsManager","DS/UPSCommands/commands/UPSAuthCmdUnparent","DS/UPSCommands/commands/UPSAuthCmdReplaceByExisting","DS/PADUtils/PADContext"],(function(e,t,n,i){["UPSAuthReplaceByExisting","UPSAuthUnparent"].forEach((function(o){var a=e.getCommand(o,d.getCommandContext());a&&(!function(e,t){var n=void 0,i="empty_no_authoring_or_monoSelection",o="empty_no_authoring_or_multiSelection",a=!0,r=e.defaultOptions.availability;if(r){var l=t.get(),c=s.get().length,u=!0;if(r!==i&&r!==o&&0!=c||(u=!1),l&&"function"==typeof l.getEditMode&&(a=l.getEditMode()),u&&!a)return n=!1;"always"===r||r===o?n=!0:"empty_or_monoSelection"===r||r===i?n=c<=1:"monoSelection"===r?n=1===c:"multiSelection"===r&&(n=c>=1)}return n&&e.defaultOptions.fnCmdAvailability&&e.defaultOptions.fnCmdAvailability((function(e){n=e})),n}("UPSAuthUnparent"===o?t.prototype:n.prototype,i)?a.isEnabled()&&a.disable():a.isEnabled()||a.enable())}))}))}function Y(){t.declareDelegationForDataKey("objectOverloads",(function(e){var t=null;if((e=e.filter((e=>"Transformation"===e.data.type))).length>0){!function(){if(!d||!D)return;let e,t=["CAT3DComposeRobotSnapMoveHdr","CAT3DComposeMoveHdr","CAT3DComposeWidgetDefaultHdr"],n=D.getSourceApp()?D.getSourceApp().options.appConfig.handlers:D.getTargetApp().options.appConfig.handlers;if(n){if(n.check)for(let i=0;i<n.check.length;i++){if(e=n.check[i].identifier,t.indexOf(e)>=0)continue;let o=M.getCommandCheckHeader(e,S);o.getState()&&o.setState(!1)}if(n.default)for(let i=0;i<n.default.length;i++){if(e=n.default[i].identifier,t.indexOf(e)>=0)continue;let o=M.getCommand(e,S);o&&o._isRunning&&(o.cancel&&o.cancel(),o.end&&o.end())}}}();var n=require("DS/CATW3DRobot/CATW3DRobot");if(e.forEach((function(e){let n=d.getController().buildPathFromArray(e.targetPath);if(n){let o=e.data.value;y.onMoveBegin({objectsMoved:[{path:n}],from:{},moveMode:"Persistent"});let r=new a.Matrix4(o[0],o[4],o[8],o[12],o[1],o[5],o[9],o[13],o[2],o[6],o[10],o[14],o[3],o[7],o[11],o[15]);y.onMove({objectsMoved:[{path:n}],from:{},worldMatrix:r}),y.onMoveEnd({from:{},status:"Moved"}),d.getViewer().render();var i=s.get();if(1===i.length){y.getSubPathToMovable(i[0].pathElement).externalPath.equals(n.externalPath)&&(t=(new a.Vector3).getPositionFromMatrix(r))}}})),t){var i=n.getMove3DRobot({context:d});setTimeout((function(){i.setValueToPanel(t)}),100)}}}))}function z(){if(i.setSetting("useNewUXGuidelinesWP",!0),!d){L("_C3D_UWA widget loading","_C3D_widgetLoad",!0),_("_C3D_LoadJSPAD3DViewer");var a=new Promise((function(e){require(["DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","text!DS/CAT3DComposeWidget/assets/json/CATC3DWindowOptions.json"],(function(t,n,i){L("_C3D_PAD3DViewer load JS","_C3D_LoadJSPAD3DViewer",!0),_("_C3D_PAD3DViewerReady"),x=t,R=n,h.setValue("tenantAware",!0),e([i])}))}));Promise.all([a]).then((function(a){var r=e.extend({context:"Default"},JSON.parse(a[0][0]));require("DS/PADUtils/PADUtilsServices").isCloud()?(i.setSetting("mouseProfile",window.__mouseProfile),r.mouseProfile=window.__mouseProfile):(i.setSetting("mouseProfile","CATIA"),r.mouseProfile="CATIA"),d=f,n.init(d,{executionContext:f.getExecutionContext()}),require(["DS/CATWebUXComponents/DMUCommandsManager"],(function(e){e.dmuSetExecutionContext(f.getExecutionContext()),e.dmuSetHandlerComponent(f.getExecutionContext()),H(d),r.mouseProfile&&d.getViewpoint().setDefaultController(!0,r.mouseProfile),y=x.getMoveManager({context:d,saveToDatabase:!0}),d.setOption("propertiesFacet",i.getSetting("propertiesFacet")),d.setAuthorizedRootTypes(i.getSetting("ups_authorized_root_types")),d.setDefaultContextualBarVisibility(!1),d.setDefaultContextualMenuVisibility(!0),d.setOpenWithMenuAvailability(!0),d.subscribe({event:"onRootAdded"},F),d.subscribe({event:"onEndProgressiveLoad"},(function(){let e=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),t=d.getController&&d.getController().hasAnyEffectiveFlexibleAssembly(),n=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration"),i=require("DS/CATWebUXComponents/DMUCommandsManager").getCommand("CAT3DComposeMoveHdr",d.getCommandContext());i&&(n&&e&&t?i.disable():i.enable()),n&&e&&t&&require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){e.give().setAllowManipulation(!1)}))})),d.subscribe({event:"onRootRemoved"},O),d.subscribe({event:"onInsertExisting"},W),d.subscribe({event:"onRootAttached"},F),d.subscribe({event:"onRootDetached"},F),d.subscribe({event:"onContentNameModified"},(function(e){h.setTitle(e)})),d.setLoadingDelegations(t.getDelegation(d)),Y(),0===U.length&&(U.push(s.onPostAdd(j)),U.push(s.onPostRemove(j))),I||(I=d.subscribe({event:"onShow"},j)),N||(N=d.subscribe({event:"onHide"},j)),i.setSetting("settypes",!0),"1"===h.getValue("widgetForODTReplay")&&h.dispatchEvent("onPAD3DViewerCreated",[{pad3DViewer:d}]),d.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"CATComposeContextMenu",context:d.getCommandContext(),merge:!0,onContextualMenuReady:q}),o.done&&o.done({appMainDiv:A,pad3DViewer:d})}))}))}}function K(){!function(){var e=i.getSetting("enopad3dviewer_roles");let t=!0,n=require("DS/PADUtils/PADUtilsServices").isCloud(),o=require("DS/PADUtils/PADSession").isAuthoring();for(var a=0;a<e.length;a++)if("E19"===e[a].id&&(!e[a].platforms||e[a].platforms&&e[a].platforms.indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)){t=!1;break}i.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",t&&!n&&!o),i.setSetting("enopad3dviewer_staticMappingSupportActivated",!o)}(),d&&d.refresh()}function J(e){d&&d.search({searchQuery:e})}function Z(){if(h&&(h.removeEvent("onRefresh",K),h.removeEvent("onSearch",J)),P&&P.unreferenceDropManager({context:d}),b&&y&&y.unsubscribe(b),b=void 0,T&&r.unsubscribe(T),T=void 0,x&&x.unreferenceMoveManager({context:d}),w){var e=w.giveMove3DRobot({context:d});e&&e.unreference()}h=d=S=m=A=p=x=M=P=w=null}d?h.addEvent("onDestroy",Z):(L("_C3D_JS dependencies loading","C3D_jsAppLoad",!1),_("_C3D_widgetLoad"),o.viewerAttachment?(m=o.viewerAttachment,z()):(m=function(e){e&&h.setBody(e)},h.addEvent("onLoad",z)),h.addEvent("onRefresh",K),h.addEvent("onDestroy",(function(){var e=d;Z(),e&&e.destroy()})),h.addEvent("onSearch",J),h.setMetas({helpPath:"CAT3DComposeWidget/assets/help"})),this.setUp=function(e){Promise.all([M?Promise.resolve():new Promise((function(e){require(["DS/CATWebUXComponents/DMUCommandsManager"],(function(t){(M=t).dmuSetExecutionContext(f.getExecutionContext()),M.refreshCommandsManager(f.getExecutionContext()),e()}))})),x?Promise.resolve():new Promise((function(e){require(["DS/CATW3DMoveManager/CATW3DMoveManager"],(function(t){x=t,e()}))})),R?Promise.resolve():new Promise((function(e){require(["DS/CATWebUXPreferences/CATWebUXPreferencesManager"],(function(t){R=t,e()}))}))]).then((async function(){if(h.addEvent("onRefresh",K),h.addEvent("onSearch",J),h.setMetas({helpPath:"CAT3DComposeWidget/assets/help"}),e.sourceApp&&e.sourceApp.pad3DViewer!==d){if(P&&P.unreferenceDropManager({context:d}),P=null,x&&x.unreferenceMoveManager({context:d}),x=null,w){var t=w.giveMove3DRobot({context:d});t&&t.unreference()}w=null,d=e.sourceApp.pad3DViewer,n.init(d)}d.setOption("propertiesFacet",require("DS/PADUtils/PADSettingsMgt").getSetting("propertiesFacet")),d.getBIController().toggleBetweenStandaloneAndSlaveMode("DUAL"),d.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClic(),d.setDefaultContextualBarVisibility(!1),d.setDefaultContextualMenuVisibility(!0),d.setOpenWithMenuAvailability(!0),d.getViewer().updateViewPanelUIConfiguration&&d.getViewer().updateViewPanelUIConfiguration({useShadingIllustration:!1,useOutline:!1}),F(),y&&b&&y.unsubscribe(b),x||await new Promise((function(e){require(["DS/CATW3DMoveManager/CATW3DMoveManager"],(function(t){x=t,e()}))})),x.unreferenceMoveManager({context:d}),y=x.getMoveManager({context:d,saveToDatabase:!0}),b||(b=y.subscribe("Move",(function(e){e.objectsMoved.length>0&&"Persistent"===e.moveMode&&e.objectsMoved.forEach((function(t){let n=M.getCommand("CAT3DComposeMoveHdr",S);var i=t.path.getLastElement(!0);c.isPLMInstanceNode(i)&&(n.isRunning()||(T||(T=r.subscribe({event:"onNotifAgentDisplayed"},(t=>{V(e,t.notifAgent)}))),n.begin()))}))}))),R.getPreferenceManager({context:d.getFrameWindow()}).removeAllPreferences(),M.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:S}),require(["DS/CATW3DRobot/CATW3DRobot","DS/CAT3DComposeUtils/CATC3DDropManager"],(function(t,n){(w=t).getMove3DRobot({context:d}),(P=n).getDropManager({context:d}).connect(),B(0,P,w);let i=d.getLandingPageComponent();i.setViewer(d),i.appReady(),e.done({appMainDiv:A,pad3DViewer:d})}))})),require("DS/ENOXInterWdgCom/LinkManager").updateLinkability({appIds:[],open:!0,uses:["ENXContent","ENXContentSync3D","ENXContentSync2D","ENXAuthoring2D","ENXAuthoring3D","ENXLandingPageSync"],implements:["ENXContent","ENXContentSync3D","ENXAuthoring3D","ENXLandingPageSync"]}),require("DS/PADUtils/PADSettingsMgt").setSetting("activateWidgetLink",!0),require("DS/PADUtils/PADSettingsMgt").setSetting("useNewUXGuidelinesWP",!0)},this.dispose=function(){if(h&&(h.removeEvent("onRefresh",K),h.removeEvent("onSearch",J)),b&&y&&y.unsubscribe(b),b=void 0,p&&p.controller&&(p.activated=!1,p.controller.end(),p=null),w){var e=w.giveMove3DRobot({context:d});e&&e.unreference()}x&&x.unreferenceMoveManager({context:d}),d&&(d.setDefaultContextualBarVisibility(!0),d.setDefaultContextualMenuVisibility(!0),d.setOpenWithMenuAvailability(!1)),P&&P.getDropManager({context:d}).disconnect();var i=R.givePreferenceManager({context:d.getFrameWindow()});i&&i.removeAllPreferences(),t.removeDelegationForDataKey("objectOverloads"),U.forEach((function(e){s.unsubscribe(e)})),d.unsubscribe(I),d.unsubscribe(N),U.length=0,I=N=null,R.unreferencePreferenceManager({context:d.getFrameWindow()});let o=d.getFrameWindow().getContextualUIManager();o&&o.unregister("CATComposeContextMenu");let a=d&&d.getExecutionContext&&d.getExecutionContext()&&d.getExecutionContext().getTargetApp?d.getExecutionContext().getTargetApp():void 0;n.reset(a&&"ENX3DIR_AP"===a.getAfrAppId()?d:void 0)},this.onWillLeave=function(){}}}})),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter",["DS/StateCommandEngine/PathElementAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/CATW3DUtils/CATC3DAxisSystemDisplayAgent","DS/WebappsUtils/WebappsUtils","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],(function(e,t,n,i,o,a,r,s,l){"use strict";var c;return e.extend({_frameWindow:null,_filterUI:null,_activeFilters:null,_filtersEnum:null,_postFilter:null,_axisAgent:null,geometryTypesEnum:{POINT:n.GeometryType.POINT,LINE:n.GeometryType.LINE,CIRCLE:n.GeometryType.CIRCLE,PLANE:n.GeometryType.PLANE,CYLINDER:n.GeometryType.CYLINDER,CONE:n.GeometryType.CONE,SPHERE:n.GeometryType.SPHERE,REFERENCE:10,AXISSYSTEM:n.GeometryType.AXISSYSTEM,AXISSYSTEMAXIS:n.GeometryType.AXISSYSTEMAXIS,AXISSYSTEMORIGIN:n.GeometryType.AXISSYSTEMORIGIN},init:function(e){var i,r=a.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),u=a.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");return this._preselection=!0,c=this,e.context?(this._frameWindow=e.context.getFrameWindow(),this._axisAgent=new o({context:e.context}),this._activeFilters=e.activeFilters||{POINT:1,CENTER:1,CIRCLE:1,AXISSYSTEM:1,AXISSYSTEMAXIS:1,AXISSYSTEMORIGIN:1,LINE:1,PLANE:1,CYLINDER:1,REFERENCE:1},this._postFilter=e.postFilter,this._filtersEnum={POINT:{type:"element",id:"POINT",nls:l.point,url:r+"I_Meas_Point.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.POINT},CENTER:{type:"element",id:"CENTER",nls:l.center,url:r+"I_Meas_PointCircle.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.CENTER},CIRCLE:{type:"element",id:"CIRCLE",nls:l.circle,url:r+"I_WebMarkerCircle.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.CIRCLE},AXISSYSTEM:{type:"element",id:"AXISSYSTEM",nls:l.axisSystem,url:u+"I_3DComposeAxisSystem.png",callback:function(){c._lastClicked="AXISSYSTEM",c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.AXISSYSTEM},AXISSYSTEMAXIS:{type:"element",id:"AXISSYSTEMAXIS",nls:l.axisSystemAxis,url:u+"I_C3DAxisAxis.png",callback:function(){c._lastClicked="AXISSYSTEMAXIS",c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.AXISSYSTEMAXIS},AXISSYSTEMORIGIN:{type:"element",id:"AXISSYSTEMORIGIN",nls:l.axisSystemOrigin,url:u+"I_C3DAxisOrigin.png",callback:function(){c._lastClicked="AXISSYSTEMORIGIN",c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.AXISSYSTEMORIGIN},LINE:{type:"element",id:"LINE",nls:l.line,url:r+"I_Meas_Line.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.LINE},PLANE:{type:"element",id:"PLANE",nls:l.plane,url:r+"I_Meas_Plane.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.PLANE},CYLINDER:{type:"element",id:"CYLINDER",nls:l.cylinder,url:r+"I_Meas_Cylinder.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.CYLINDER},REFERENCE:{type:"element",id:"REFERENCE",nls:l.reference,url:r+"I_Meas_Product.png",callback:function(){c.updateFilters()},bexclude:!0,bstateActif:c._activeFilters.REFERENCE}},(i={agentId:"CAT3DComposeAssemblyPatternSelect",frameWindow:this._frameWindow,withPrevaluation:!1,engWithPSOHSO:!1,withPSO:!0,withHSO:!1,valuedFromCSO:!1,saveToCSO:!1,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",withUndoStep:!1}).prePickingFilter=i.pickingFilter=function(i){var o,a,r=!1,l=0,u=t.getEquivalentGeometry({pathElement:i,axisSystemSub:!c._activeFilters.AXISSYSTEM,axisSystemOrigin:!c._activeFilters.AXISSYSTEMORIGIN,viewer:e.context.getViewer()}),d=u?u.getType():null;if((c._activeFilters.AXISSYSTEM||c._activeFilters.AXISSYSTEMAXIS||c._activeFilters.AXISSYSTEMORIGIN)&&c._axisAgent.analyze({pathElement:i}),(1===c._activeFilters.AXISSYSTEM&&d===c.geometryTypesEnum.AXISSYSTEM||1===c._activeFilters.AXISSYSTEMAXIS&&d===c.geometryTypesEnum.AXISSYSTEMAXIS||1===c._activeFilters.AXISSYSTEMORIGIN&&d===c.geometryTypesEnum.AXISSYSTEMORIGIN)&&(u&&(a=u.getPathElement())&&(i.internalPath=a.internalPath,i.externalPath=a.externalPath),r=!0),!r&&(1===c._activeFilters.POINT&&d===c.geometryTypesEnum.POINT||1===c._activeFilters.CENTER&&(d===c.geometryTypesEnum.CIRCLE||d===c.geometryTypesEnum.SPHERE)||1===c._activeFilters.CIRCLE&&d===c.geometryTypesEnum.CIRCLE||1===c._activeFilters.LINE&&d===c.geometryTypesEnum.LINE||1===c._activeFilters.PLANE&&(d===c.geometryTypesEnum.PLANE||n.GeometryType.REFPLANE)||1===c._activeFilters.CYLINDER&&(d===c.geometryTypesEnum.CYLINDER||d===c.geometryTypesEnum.CONE))&&(r=!0),!r&&1===c._activeFilters.REFERENCE)for(l=i.externalPath.length-1;l>=0;--l)if((o=i.externalPath[l])&&s.isReference(o)){i.setFromArray(i.externalPath.slice(0,l+1)),r=!0;break}return r&&"function"==typeof c._postFilter&&(r=c._postFilter(i)),r},this._parent(i),this.updateFilters(),null):null},activate:function(){var e=r.get();this._parent(),this._preselection&&e.length>0&&(this._preselection=!1,this.object3D=[],this.options.pickingFilter(e[0].pathElement)&&(this.object3D.push(e[0]),this._modelEvents.publish({event:this._agentId,data:this.object3D}))),this.updateFilters()},deactivate:function(){this._filterUI&&(this._filterUI.clear(),this._filterUI.destroy(),this._filterUI=null),c._axisAgent.deactivate(),this._parent()},getSelType:function(e){var n=t.getEquivalentGeometry({pathElement:e,axisSystemSub:!c._activeFilters.AXISSYSTEM}),i=n?n.getType():null;return e&&e.externalPath&&s.isAModelPath(e)?!i&&0===e.internalPath.length&&e.externalPath.some((function(e){return e&&s.isReference(e)}))?this.geometryTypesEnum.REFERENCE:"number"==typeof i?i:null:null},getActiveFilters:function(){return this._activeFilters},updateFilters:function(e,t){var n,o,a,r=!1,s=[];if("boolean"!=typeof t&&(t=!0),e&&"object"==typeof e){for(n in c._activeFilters={},e)e.hasOwnProperty(n)&&c._filtersEnum.hasOwnProperty(n)&&(c._activeFilters[n]=e[n],1!==c._activeFilters[n]&&(c._activeFilters[n]=0));r=!0}if(c._filterUI&&t)for(o in c._activeFilters)c._activeFilters.hasOwnProperty(o)&&(c._activeFilters[o]=c._filterUI.getActiveState(o)?1:0);if(c._lastClicked&&1===c._activeFilters[c._lastClicked]&&(c._activeFilters.AXISSYSTEM&&(c._activeFilters.AXISSYSTEM=0),c._activeFilters.AXISSYSTEMAXIS&&(c._activeFilters.AXISSYSTEMAXIS=0),c._activeFilters.AXISSYSTEMORIGIN&&(c._activeFilters.AXISSYSTEMORIGIN=0),c._activeFilters[c._lastClicked]=1,r=!0),c._lastClicked=null,c._activeFilters.AXISSYSTEM||c._activeFilters.AXISSYSTEMAXIS||c._activeFilters.AXISSYSTEMORIGIN?c._axisAgent.activate({type:"HSO",noPSOcb:!0}):c._axisAgent.deactivate(),r&&c._filterUI&&(c._filterUI.clear(),c._filterUI.destroy(),c._filterUI=null),!c._filterUI){for(o in c._activeFilters)c._activeFilters.hasOwnProperty(o)&&c._filtersEnum.hasOwnProperty(o)&&((a=c._filtersEnum[o]).bstateActif=c._activeFilters[o],s.push(a));c._filterUI=new i({body:c._frameWindow.getUIFrame(),frmWindow:c._frameWindow,Idpanel:"c3dPatternSelectionFilter",typeSeparator:"bubble",verticalPanel:!0,lJsonElement:s}),c._filterUI.build(),c._viewer.render()}}})})),define("DS/CATC3DNavigation/CAT3DComposeExamineController",["UWA/Class","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATWebUXComponents/DMUCommandsManager"],(function(e,t,n,i){"use strict";var o=e.extend({init:function(e){var o=e||{};this._parent(o);var a,r,s,l,c=o.ctxViewer,u=c.getViewer(),d=u.getSceneGraphOverrideSetManager(),m=!1,p=[],g=function(){var e=t.get();return!(!e||!Array.isArray(e))&&(e.length>50||e.some((function(e){if(!e||!e.pathElement||e.pathElement.externalPath.length<2||!n.isAModelPath(e.pathElement))return!1;var t=e.pathElement,i=d.getCurrentVisibilityFree(t);return"boolean"==typeof i&&((!0!==i||d.getCurrentVisibility(t))&&(!t.getBoundingBox(null,u,"visibleSpace").isNaN()||!t.getBoundingBox(null,u,"invisibleSpace").isNaN()))})))};function C(){var e=i.getCommand("CAT3DComposeExamineSelectionHdr",c.getCommandContext());e&&(g()?e.isEnabled()||e.enable():e.isEnabled()&&!e.isRunning()&&e.disable())}a=function(e){if((" "===e.key||"Spacebar"===e.key||32===e.keyCode)&&!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey){document.removeEventListener("keypress",a),document.addEventListener("keyup",r);var t=i.getCommand("CAT3DComposeExamineSelectionHdr",c.getCommandContext());if(!t)return;g()?t.begin():t.cancel()}},r=function(e){" "!==e.key&&"Spacebar"!==e.key&&32!==e.keyCode||(document.removeEventListener("keyup",r),document.addEventListener("keypress",a))};this.clearController=function(){this.setActiveState(!1)},this.canBeEnabled=function(){return g()},this.setActiveState=function(e){if(m!==e){m=e;var n=i.getCommand("CAT3DComposeExamineSelectionHdr",c.getExecutionContext?c.getExecutionContext():c.getCommandContext());m?(n&&n.enable(),document.addEventListener("keypress",a),0===p.length&&(p.push(t.onPostAdd(C)),p.push(t.onPostRemove(C))),s||(s=c.subscribe({event:"onShow"},C)),l||(l=c.subscribe({event:"onHide"},C)),C()):(document.removeEventListener("keypress",a),document.removeEventListener("keyup",r),p.forEach((function(e){t.unsubscribe(e)})),c.unsubscribe(s),c.unsubscribe(l),p.length=0,s=l=null,n&&!n.isRunning()&&n.disable())}}}}),a=[];return e.singleton({init:function(){},getExamineController:function(e){var t;if(e&&e.context){for(var n=0;n<a.length;n++)if(a[n].context===e.context){t=a[n].ExamineController;break}if(!t){var i=new o({ctxViewer:e.context});a.push({context:e.context,ExamineController:i}),t=i}}return t},unregisterExamineController:function(e){if(e&&e.context)for(var t=0;t<a.length;t++)if(a[t].context===e.context){a[t].ExamineController.clearController(),a.splice(t,1);break}}})})),define("DS/CAT3DComposeCommands/CATC3DSwitchAxisCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CATWebUXComponents/DMUCommandsManager","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,i,o,a,r,s,l,c){"use strict";var u,d,m,p=l.GeometryType;let g=e.extend({init:function(e){let t,n;switch(this._parent(e),e.ID){case"CATC3DSwitchAxisXHdr":t=p.AXISX,n=["CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"];break;case"CATC3DSwitchAxisYHdr":t=p.AXISY,n=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisZHdr"];break;default:t=p.AXISZ,n=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr"]}var i=this.onStateChange((function(){this.getState()&&g.SwitchAxis(void 0,e,t,n)}));this._destroy=function(){this._modelEvents.unsubscribe(i),Object.getPrototypeOf(this)._destroy.call(this),i=n=null}},toggleState:function(){this.getState()||this.setState(!0,!0)},_destroy:function(){this._parent()}});return g.SwitchAxis=function(e,l,C,v){if(!u&&l.executionContext?u=l.executionContext.getComponent("Viewer"):u||l.executionContext||(u=i.get()),C&&v&&(d=C,m=v),l.executionContext&&l.args&&l.args.Axis)switch(l.args.Axis){case"X":d=p.AXISX,m=["SwitchToX","SwitchToZ"];break;case"Y":d=p.AXISY,m=["SwitchToX","SwitchToZ"];break;default:d=p.AXISZ,m=["SwitchToX","SwitchToY"]}var h,f,D=a.giveConstraintsController({context:u}),A=s.giveMoveManager({context:u}),S=r.getMoveReferentManager({context:u}),E=n.get();if(E.some((function(e){var t;return f=S.getMoveReferent(e.pathElement),!!(D&&f&&(t=f.getLastElement(!0))&&c.isInstance(t)&&t.children.length>0)&&(f.addElement(t.children[0]),h=D.getAxisTypeIfCstOnProductAxis(f))})),D&&h&&h!==d&&f){var x=D.simulateSwitchAxis(f,d)||{},y=x.matrix||new o.Matrix4,b=new o.Matrix4,T=x.rc,M=x.redundancy;0!==T||M||(A.onMoveBegin({objectsMoved:E,from:g,moveMode:"Persistent"}),E.forEach((function(e){A.onMove({objectsMoved:[{path:e.pathElement}],from:g,worldMatrix:b.multiplyMatrices(y,e.pathElement.getWorldMatrix())})}),g),A.onMoveEnd({from:g,status:"Moved"}),D.setProductAxisForConstraint(d))}l.executionContext?m.forEach((function(e){let t=l.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent);t&&t.setRadioItemState({id:e,radioId:"CATC3DSwitchAxisHdr",state:!1})})):m.forEach((function(e){t.getCommandCheckHeader(e,u.getCommandContext?u.getCommandContext():null).setState(!1)})),e&&e()},g.clean=function(e,t){!u&&t?u=t.executionContext.getComponent("Viewer"):u||t||(u=i.get()),e&&e()},g})),define("DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/WebappsUtils/WebappsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DUtils/CATC3DAxisSystemDisplayAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DUtils/CATW3DUtils"],(function(e,t,n,i,o,a,r,s,l){"use strict";var c={};require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],(function(e){c.point=e.point,c.center=e.center,c.axisSystem=e.axisSystem,c.line=e.line,c.plane=e.plane,c.cylinder=e.cylinder,c.surface=e.surface,c.product=e.product}));var u,d,m=i.getWebappsAssetUrl("DMUMeasure","icons/32/"),p=i.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),g=e.extend({init:function(e){var i,g,C,v,h,f,D,A,S=e.context,E=!0,x=S.getViewer(),y={none:0,point:0,center:0,axisSystem:1,line:0,plane:1,cylinder:1,surface:0,product:1},b=localStorage.getItem("C3DSelectionFilter"),T=new a({context:S}),M=function(){y={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},h.getActiveState("point")&&(y.none=0,y.point=1),h.getActiveState("center")&&(y.none=0,y.center=1),h.getActiveState("axisSystem")&&(y.none=0,y.axisSystem=1),h.getActiveState("line")&&(y.none=0,y.line=1),h.getActiveState("plane")&&(y.none=0,y.plane=1),h.getActiveState("cylinder")&&(y.none=0,y.cylinder=1),h.getActiveState("surface")&&(y.none=0,y.surface=1),h.getActiveState("product")&&(y.none=0,y.product=1);var e="1-"+y.point+y.center+y.axisSystem+y.line+y.plane+y.cylinder+y.surface+y.product+"-"+(E?1:0);localStorage.setItem("C3DSelectionFilter",e),y.axisSystem?T.activate():T.deactivate()},P=function(){var e;function t(t){if(!t)return e=!1,void(h&&h.setVisibleFlag(!1));var n;e=!0,E?h?h.setVisibleFlag(!0):(n=function(){(h=new u({body:S.getFrameWindow().getUIFrame(),frmWindow:S.getFrameWindow(),Idpanel:"c3dSelectionFilter",classpanel:"c3dSelectionFilter",typeSeparator:"bubble",verticalPanel:!0,lJsonElement:[{type:"element",id:"point",nls:c.point,url:m+"I_Meas_Point.png",callback:M,bexclude:!1,bstateActif:y.point},{type:"element",id:"center",nls:c.center,url:m+"I_Meas_PointCircle.png",callback:M,bexclude:!1,bstateActif:y.center},{type:"element",id:"axisSystem",nls:c.axisSystem,url:p+"I_3DComposeAxisSystem.png",callback:M,bexclude:!1,bstateActif:y.axisSystem},{type:"element",id:"line",nls:c.line,url:m+"I_Meas_Line.png",callback:M,bexclude:!1,bstateActif:y.line},{type:"element",id:"plane",nls:c.plane,url:m+"I_Meas_Plane.png",callback:M,bexclude:!1,bstateActif:y.plane},{type:"element",id:"cylinder",nls:c.cylinder,url:m+"I_Meas_Cylinder.png",callback:M,bexclude:!1,bstateActif:y.cylinder},{type:"element",id:"surface",nls:c.surface,url:m+"I_Meas_Surface.png",callback:M,bexclude:!1,bstateActif:y.surface},{type:"element",id:"product",nls:c.product,url:m+"I_Meas_Product.png",callback:M,bexclude:!1,bstateActif:y.product}]})).build();var t=document.querySelector(".c3dSelectionFilter");t&&(t.style.position="absolute"),h.setVisibleFlag(!1),e&&E&&h.setVisibleFlag(!0)},u?n():d||(d=!0,require(["DS/Web3DUXFilterBar/Web3DUXFilterBar"],(function(e){d=!1,u=e,n()})))):h&&h.setVisibleFlag(!1)}return function(){t(!!f&&(S&&o.getRoots(S).length>0))}}();if(b&&b.length>8){var w=2,R=parseInt(b.split("-")[0]);y.point="1"===b.charAt(w++)?1:0,y.center="1"===b.charAt(w++)?1:0,y.axisSystem="1"===b.charAt(w++)?1:0,y.line="1"===b.charAt(w++)?1:0,y.plane="1"===b.charAt(w++)?1:0,y.cylinder="1"===b.charAt(w++)?1:0,R&&(y.surface="1"===b.charAt(w++)?1:0),y.product="1"===b.charAt(w++)?1:0,y.point||y.center||y.axisSystem||y.line||y.plane||y.cylinder||y.surface||y.product||(y.none=1),b.length>w&&"-"===b.charAt(w++)&&(E="1"===b.charAt(w))}function I(e){var n=e.pathElement;return e.pathElement=new t,n.externalPath.some((function(t){return e.pathElement.addElement(t),t&&o.is3DLeaf(t)})),n.internalPath.length>0&&(e.originalPathElement=n),e}function N(e){if(!(e&&e.pathElement&&e.pathElement.externalPath.length&&o.isAModelPath(e.pathElement)))return e;if(!f||y.none)return I(e);if(y.axisSystem||y.point||y.center||y.line||y.plane||y.cylinder||y.surface){var t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:x,nonCanonicGeometry:Boolean(y.surface)}),n=t?t.getType():null;if(y.axisSystem&&n===s.GeometryType.AXISSYSTEM)return e.originalPathElement=e.pathElement,e.pathElement=t.getPathElement(),e.equivalentGeometry=t,e;if(y.point&&n===s.GeometryType.POINT||y.center&&(n===s.GeometryType.CIRCLE||n===s.GeometryType.SPHERE)||y.line&&n===s.GeometryType.LINE||y.plane&&(n===s.GeometryType.PLANE||n===s.GeometryType.REFPLANE)||y.cylinder&&(n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE)||y.surface&&n===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e;if(y.surface&&(n===s.GeometryType.PLANE||n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE||n===s.GeometryType.SPHERE)&&(n=(t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:x,canonicGeometry:!1,nonCanonicGeometry:!0}))?t.getType():null)===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e}if(y.surface){for(var i,a=e.pathElement.externalPath.length-1;a>=0&&!i;a--)o.isRepReference(e.pathElement.externalPath[a])&&(i=e.pathElement.externalPath[a]);if(i&&!S.getController().hasMeshInRAM(o.getNodeID(i)))return I(e)}return y.product?I(e):(e.originalPathElement=e.pathElement,e.pathElement=null,e)}function U(e){Array.isArray(e)?e.forEach(N):N(e)}function L(){return{point:y.point,center:y.center,line:y.line,axisSystem:y.axisSystem,plane:y.plane,cylinder:y.cylinder,surface:y.surface,product:y.product}}function _(e){g&&g.cancel&&g.cancel(),g=null,e&&e.pickingResult&&e.pickingResult.path&&e.pickingResult.path.length&&(g=l.switchToAV1withMesh({pathElement:e.pickingResult.path[0],pad3DViewer:S,selectionFilter:L(),onComplete:function(){g=null},onFailure:function(){g=null}}))}function W(){if(f){var e=S.getViewer();e.setPicking(v),e.setPrePicking({primitive:C}),i&&e.unsubscribe(i),i=null,n.unsubscribe(f),S.unsubscribe(D),S.unsubscribe(A),f=D=A=null,P(),T.deactivate()}}this.filter={activate:function(e){if(!f){var t=S.getViewer();v={primitive:t.picking.primitive,trapSelection:t.picking.trapSelection,trapPrimitive:t.picking.trapPrimitive,trapGPU:t.picking.trapGPU},C=t.pPicking.primitive,t.setPicking({primitive:1,trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),t.setPrePicking({primitive:1}),e&&e.switchToAV1withMesh&&(i=t.onPreactivate(_)),f=n.onPreAdd(U),D=S.subscribe({event:"onRootAdded"},P),A=S.subscribe({event:"onRootRemoved"},P),P(),y.axisSystem&&T.activate()}},deactivate:W,isActive:function(){return Boolean(f)},display:function(e){"boolean"==typeof e&&e!==E&&(E=e,P())},filterPath:N,switchToAV1withMesh:_,getFiltersState:L},Object.freeze(this.filter),this.unreference=function(){W(),h&&h.clear(),T=h=S=null}}}),C=[];return e.singleton({init:function(){},giveDefaultSelectionFilter:function(e){var t,n;return n=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===n&&C.some((function(n){return n.context===e.context&&(t=n.mng.filter,!0)})),t},getDefaultSelectionFilter:function(e){var t,n;if(n=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===n&&(C.some((function(n){return n.context===e.context&&(t=n.mng.filter,!0)})),!t)){var i=new g({context:e.context});C.push({context:e.context,mng:i}),t=i.filter}return t},unreferenceDefaultSelectionFilter:function(e){e&&e.context&&C.some((function(t,n){return t.context===e.context&&(t.mng.unreference(),C.splice(n,1),!0)}))}})})),define("DS/CAT3DComposeWidget/CATC3DAppInit",["DS/WAfrContainer/App","UWA/Core","DS/Controls/Loader"],(function(e,t,n){"use strict";var i,o;return e.extend({setUp:function(e){var a=this;if(window.widget.getValue("X3DContentId")){var r="",s=JSON.parse(window.widget.getValue("X3DContentId"));s.data&&s.data.items&&s.data.items[0]&&s.data.items[0].displayName&&(r=s.data.items[0].displayName);var l=t.createElement("div",{class:"DMULoadingPanel"}).inject(document.body);(o=new n({text:"Loading "+r}).inject(l)).on(),o.getContent().addClassName("DMULoadingPanelInfoDiv");var c=o.elements.label.getSize().width,u=o.elements.progressBar.getContent().getSize().width,d=o.elements.progressBar.getContent().getSize().height,m=c+u;l.setStyles({position:"absolute",bottom:"0",left:"0","z-index":"40000","background-color":"rgba(255,255,255,1",height:"100%",width:"100%"}),o.getContent().setStyles({position:"absolute",left:"calc(50% - "+m/2+"px)",top:"calc(50% - "+d/2+"px)"})}if(e.sourceApp){if(!e.sourceApp.pad3DViewer)return window.console.log("pad3DViewer property must be valuated"),void e.done();this.pad3DViewer=e.sourceApp.pad3DViewer,this.appMainDiv=e.sourceApp.appMainDiv,new Promise((function(t){i?t():require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],(function(n){i=n.getApp({widget:window.widget,pad3DViewer:e.sourceApp.pad3DViewer,appMainDiv:e.sourceApp.appMainDiv}),t()}))})).then((function(){e.sourceApp&&!e.sourceApp.isDisposeCalled()&&e.sourceApp.dispose();var t=e.done;e.done=function(n){a.appMainDiv||(a.appMainDiv=n.appMainDiv),e.done=t,e.done()},i.setUp(e)}))}else require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],(function(t){i=t.getApp({widget:window.widget,viewerAttachment:e.done,done:function(e){a.pad3DViewer=e.pad3DViewer,a.appMainDiv=e.appMainDiv}})}))},dispose:function(e){i.dispose(e),o&&(o.destroy(),o=null);var t=window.document.getElementsByClassName("DMULoadingPanel");t.length&&t[0].destroy(),this._parent(e)},onWillEnter:function(e){return require(["DS/CAT3DComposeUtils/CATC3DUtils","DS/PADUtils/PADSettingsMgt"],(function(t,n){n.setSetting("enopad3dviewer_staticMappingSupportActivated",!0),t._sendUsageProbe("appTransitionFrom",e.options.id,"resolved")})),this._parent(e)},onWillLeave:function(e){return i&&i.onWillLeave&&i.onWillLeave(e),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(t){t._sendUsageProbe("appTransitionTo",e.options.id,"resolved")})),this._parent(e)}})})),define("DS/CAT3DComposeCommands/CATC3DReverseDirectionCmd",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,i,o,a,r,s){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!1}),this.setRepeatMode(!1),this.beginExecute=function(){var e=t.get();if(e.length){var l,c=i.get(),u=r.giveMoveManager({context:c}),d=o.getMoveReferentManager({context:c}),m=a.giveConstraintsController({context:c});if(e.some((function(e){var t;return l=d.getMoveReferent(e.pathElement),!!(m&&l&&(t=l.getLastElement(!0))&&s.isInstance(t)&&t.children.length>0)&&(l.addElement(t.children[0]),m.isThereACstSuppportingReverseDirection(l))}))&&l&&m){var p=m.simulateReverseDirection(l)||{},g=p.matrix||new n.Matrix4,C=new n.Matrix4,v=p.rc,h=p.redundancy;0!==v||h||(u.onMoveBegin({objectsMoved:e,from:this,moveMode:"Persistent"}),e.forEach((function(e){u.onMove({objectsMoved:[{path:e.pathElement}],from:this,worldMatrix:C.multiplyMatrices(g,e.pathElement.getWorldMatrix())})}),this),u.onMoveEnd({from:this,status:"Moved"}))}this.done()}}}})})),define("DS/CAT3DComposeUI/CAT3DComposeWidgetOptions",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils"],(function(e,t,n,i){"use strict";return t.singleton(n,{init:function(){var t={};window.c3dUrlComplementForODT&&(t=i.parseQuery(window.c3dUrlComplementForODT)),""!==window.location.search&&(e.extend(t,i.parseQuery(window.location.search)),t.widgetDomain&&e.extend(t,i.parseQuery(t.widgetDomain)));var n={};"c3dAnim"in t&&(n.animationOff="no"===t.c3dAnim),"C3DSTR"in t&&(n.C3DSTR=!0),"debug_me"in t&&(n.debug=!0),"testWkb"in t&&(n.testWkb=!0),"authoring3d"in t&&(n.authoring3d=!0),this.setOptions(n)}})})),define("DS/CATC3DNavigation/CATBreadCrumbs",["UWA/Core","UWA/Class","DS/CoreEvents/Events","css!DS/CATC3DNavigation/CATC3DNavigation.css"],(function(e,t,n){"use strict";return t.extend({init:function(t){var i,o,a,r,s=[],l=t.parentFrame,c=null,u=function(){for(var e=0;e<s.length;e++)s[e].div.removeClassName("first-crumb"),s[e].div.removeClassName("crumbs-with-home"),s[e].div.removeClassName("last-crumb"),0===e&&(s[e].div.addClassName("first-crumb"),o&&s[e].div.addClassName("crumbs-with-home")),s[e].lastBreadCrumb&&s[e].div.addClassName("last-crumb"),s[e].div.setStyle("z-index",1e4-e);o&&(o.div.setStyle("z-index",10001),s.length?(o.div.setStyle("border-top-right-radius","0px"),o.div.setStyle("border-bottom-right-radius","0px")):(o.div.setStyle("border-top-right-radius","5px"),o.div.setStyle("border-bottom-right-radius","5px")))},d=function(e){var t=null,n=e.changedTouches[0].clientX,o=e.changedTouches[0].clientY,a=i.getPosition();return i.getChildren().some((function(e){var i=e.getPosition(),r=e.getDimensions(),l=i.x+a.x,c=l+r.width,u=i.y+a.y,d=u+r.height;return"number"==typeof e.idthumb&&e.idthumb<s.length-1&&(c+=16),l<=n&&n<=c&&u<=o&&o<=d&&(t=e,!0)})),t},m=function(e){e&&a===e&&e.addClassName("navigationBreadCrumbActivated"),e&&"Home"!==e.idthumb&&!c&&(c=setTimeout((function(){e.querySelector("p").addClassName("navigationBreadCrumbExpand"),c=null}),1e3))},p=function(e){e&&e.removeClassName("navigationBreadCrumbActivated"),e&&"Home"!==e.idthumb&&(c?(clearTimeout(c),c=null):a&&a===e||e.querySelector("p").removeClassName("navigationBreadCrumbExpand"))},g=function(e){a&&e&&a===e.div&&(a.removeClassName("navigationBreadCrumbActivated"),e.cb()),a=null},C=function(e){1===e.touches.length&&(e.preventDefault(),e.stopPropagation(),m(a=r=d(e)))},v=function(e){if(1===e.touches.length){e.preventDefault(),e.stopPropagation();var t=d(e);t!==r&&(p(r),m(t),r=t)}},h=function(e){e.preventDefault(),e.stopPropagation();var t=d(e);g(t?"Home"===t.idthumb?o:s[t.idthumb]:null),p(t)},f=function(e){var t=e.target.idthumb;m("Home"===t?o.div:s[t].div)},D=function(e){var t=e.target.idthumb;p("Home"===t?o.div:s[t].div)},A=function(e){if(0===e.button&&1===e.buttons){var t=e.target.idthumb;m(a="Home"===t?o.div:s[t].div);var i=n.subscribe({event:"/VISU/onLeftMouseUp"},(function(e){n.unsubscribe(i),i=void 0,("Home"===(t=e.from[0].event.target.idthumb)?o.div:"number"==typeof t?s[t].div:null)!==a&&(a.querySelector("p").removeClassName("navigationBreadCrumbExpand"),a=null)}))}},S=function(e){if(a&&0===e.button&&0===e.buttons){var t=e.target.idthumb;g("Home"===t?o:s[t])}};function E(){i||(i=e.createElement("ul",{class:"navigationBreadCrumb"}).inject(l))}function x(){i&&(0!==s.length||o?u():(i.destroy(),i=null))}function y(e,t){i&&(s[e].div.setStyle("opacity","0"),s[e].div.setStyle("right","25px"),s[e].div.removeEvents(),i.removeChild(s[e].div),s.splice(e,1)),t&&x()}this.activate=function(e){i&&("Home"!==e?s[e].cb():o.cb())},this.addHomeBreadCrumb=function(t){if(t&&!o)return E(),(o={}).div=e.createElement("li",{class:"navigationBreadCrumb homeBreadCrumb"}),e.createElement("span",{class:"homeBreadCrumb fonticon fonticon-home"}).inject(o.div).idthumb="Home",0===s.length?i.appendChild(o.div):i.insertBefore(o.div,s[0].div),o.cb=function(){return t.cb?t.cb({div:o.div}):void 0},o.div.setStyle("opacity","1"),o.div.setStyle("right","0px"),o.div.idthumb="Home",o.div.addEvents({mousedown:A,mouseup:S,mouseenter:f,mouseleave:D}),o.div.addEvents({touchstart:C,touchmove:v,touchend:h}),u(),o.div},this.removeHomeBreadCrumb=function(){i&&o&&(o.div.removeEvents(),i.removeChild(o.div),o=null),x()},this.addBreadCrumb=function(t){E();var n=e.createElement("li",{class:"navigationBreadCrumb"}).inject(i);n.idthumb=s.length;var o=e.createElement("p").inject(n);return o.idthumb=s.length,o.innerHTML=e.is(t.label)&&e.is(t.label,"string")?t.label:"",e.createElement("span").inject(n).idthumb=s.length,s.push({div:n,cb:function(){return t.cb?t.cb({div:n}):void 0},lastBreadCrumb:t.lastBreadCrumb}),n.addEvents({mousedown:A,mouseup:S,mouseenter:f,mouseleave:D}),n.addEvents({touchstart:C,touchmove:v,touchend:h}),u(),setTimeout((function(){n.setStyle("opacity","1"),n.setStyle("right","0px")}),10),n},this.removeBreadCrumb=function(e){y(e,!0)},this.setLabel=function(e,t){i&&"Home"!==e&&e<s.length&&(s[e].div.querySelector("p").innerHTML=t)},this.destroy=function(){for(var e=s.length-1;e>=0;e--)y(e,!1);this.removeHomeBreadCrumb()},this.show=function(){i&&i.show()},this.hide=function(){i&&i.hide()}}})})),define("DS/CAT3DComposeUtils/CATC3DUtils",[],(function(){"use strict";var e,t,n;function i(e,t,n,i){var o,a,r=n.length,s=e.getFrameWindow().getViewpoint().reframe,l=!0===require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_lightNodeModel"),c=function(){0===--r&&(e.unsubscribe(o),e.unsubscribe(a),e.getFrameWindow().getViewpoint().reframe=s,l&&e.getController().forceRefresh(),i(n))};o=e.subscribe({event:"onInsertExisting"},c),a=e.subscribe({event:"onInsertExistingFailure"},c),e.getFrameWindow().getViewpoint().reframe=function(){},n.forEach((function(n){n.instID?(e.getController().switchAuthoringMode(!0,!0,"PADSession_disabling_index_authoring"),e.getController().insertExisting({created:[n.instID],inserted:[[t,n.instID,n.childID]],modified:[t],matrix:n.matrix})):c()}))}return Object.freeze({insertExisting:function n(o){if("string"==typeof o.parentID&&o.children instanceof Array&&"function"==typeof o.onCompleted&&o.context)if(e){var a=o.parentID,r=[];o.children.forEach((function(n){e.insertExisting({modeler:"product",data:{version:"1.0",hasParent:a,children:[{isInstanceOf:n.id}]},onComplete:function(e){var s="string"==typeof e?JSON.parse(e):null;if(s&&"success"===s.status){var l=s.results[0].instance;!function(e,n,i){if(n){var o={onComplete:function(){i()},onFailure:function(){i(),window.console.log("Unable to store matrix")}};o.instances=[{instance:e,hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map((function(e){return n.elements[e]}))}],t?t.move3D(o):i()}else i()}(l,n.matrix,(function(){r.push({instID:l,childID:n.id,matrix:n.matrix}),o.children.length===r.length&&i(o.context,a,r,o.onCompleted)}))}else r.push({instID:null,matrix:null,childID:n.id,message:s&&s.message?s.message:void 0}),o.children.length===r.length&&i(o.context,a,r,o.onCompleted)},onFailure:function(e){var t="string"==typeof e?JSON.parse(e):null;r.push({instID:null,matrix:null,childID:n.id,message:t&&t.message?t.message:void 0}),o.children.length===r.length&&i(o.context,a,r,o.onCompleted)}})}))}else require(["DS/AuthGenericCommands/AuthGenericCmdWSAccess","DS/UPSCommands/UPSCmdUtils"],(function(i,a){e=i,t=a,n(o)}))},_sendUsageProbe:function(e,t,i){if(n){var o=n.getPADTracker({eventCategory:"usage",eventAction:e}),a={eventLabel:t};void 0!==i&&(a.eventValue=i),o.setEventData(a),o.trackPageEvent()}else require(["DS/PADServices/utils/PADTrackerManager"],function(e,t,i,o){n=o,this._sendUsageProbe(e,t,i)}.bind(this,e,t,i))}})})),define("DS/CAT3DComposeCommands/CAT3DComposeRobotSnapMove",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/CATW3DRobot/CATW3DRobot","DS/PADUtils/PADContext","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var a=i.get();this.beginExecute=function(){var e=n.getMove3DRobot({context:a}),i=t.get();if(1===i.length){var r;r=t._items[0].pathElement.getBoundingSphere().center,e.modifyTargetAndPosition({pathElement:i[0].pathElement,robotPosition:r}),e.addCoordPanel({immersiveFrame:a.getFrameWindow().getImmersiveFrame(),w3dRobot:e,robotP:r});var s=o.getExamineController({context:a});s&&s.setActiveState(!1)}this.done()}}})})),define("DS/CATC3DNavigation/CATC3DNavigationDefaultCmdV2",["DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext","DS/CATC3DNavigation/CATC3DNavigationContoller","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i){"use strict";return class{constructor(){var o=t.get(),a=n.getNavigationContoller({context:o}),r=i.getExamineController({context:o});this.beginExecute=function(){var t=e.giveDataLauncherController({context:o});t&&t.setActiveState(!0),r&&r.setActiveState(!0),a&&a.resume()},this.destroy=function(){var t=e.giveDataLauncherController({context:o});t&&t.setActiveState(!1),r&&r.setActiveState(!1),a&&a.pause()},this.pauseExecute=function(){var t=e.giveDataLauncherController({context:o});t&&t.setActiveState(!1),r&&r.setActiveState(!1),a&&a.pause(),this.done()},this.resumeExecute=function(){var t=e.giveDataLauncherController({context:o});t&&t.setActiveState(!0),r&&r.setActiveState(!0),a&&a.resume(),this.done()}}}})),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove",["UWA/Core","UWA/Class","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/Manipulators/ScreenPlaneManipulator","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DUtils/CATW3DUtils","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Visualization/IdPath","DS/CoreEvents/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATWebUXComponents/DMUCommandsManager","css!DS/CAT3DComposeUI/CAT3DComposeUI.css"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,C,v,h,f,D,A,S,E,x){"use strict";var y,b=t.extend({init:function(){var t,y,b=!1,T=null,M=null,P=null,w=this,R={},I=[],N="",U=!0,L=!1,_=null,W=null,O={},F=3394815,V=!1,k={},B=[],X=null,G=null,H=null,q=null,j=null,Y=null,z=null,K=!g.getOption("animationOff"),J=!1,Z={},Q=!1,$=null,ee=!1,te=null,ne=null,ie=new D,oe=new s("LocalAxisSystemNode");oe.exludeFromBounding(!0),oe.setVisibilityInTree(!1),oe.setPickable(l.PICKTHROUGH),oe.setVisibility(!1),oe.setVisibilityFree(!0),oe.updateDisplay=function(e){0===oe.parents.length&&P.addNode(oe),e.visibility&&e.pathElement&&oe.pathElement!==e.pathElement&&(oe.pathElement=e.pathElement,oe.setMatrix(e.pathElement.getWorldMatrix()),oe.setVisibility(!0)),e.visibility||(oe.pathElement=null,oe.setVisibility(!1))};var ae=new s("MovePrevisuNode");ae.exludeFromBounding(!0),ae.setVisibilityFree(!0),ae.setVisibilityInTree(!1),ae.setPickable(l.PICKTHROUGH),ae.setNoZ(!0),ae.updateDisplay=function(e,t,n){0===ae.parents.length&&P.addNode(ae),ae.removeChildren(),e&&e.equivalentGeometry&&e.equivalentGeometry.getPrevisuNode&&ae.addChild(e.equivalentGeometry.getPrevisuNode(t,n))};var re=function(e){if(e.color){var t=new r.MeshBasicMaterial({side:2,forceSide:!0,color:e.color,transparent:!0,depthWrite:!1,depthTest:!1,opacity:.6,overridable:!1});S.applyMaterialToPath(e.path,t)}else S.applyMaterialToPath(e.path,null)},se=function(e){e.objectToMove.override.setColor("#FFFFFF",!1);var t=function(t){e.objectToMove&&z&&!Q&&t&&P.render()},n=T.isPathLocked({pathElement:e.objectToMove.path,onCompleted:function(e){Z.isRunning()||t(e.isLocked)}});0===n.returnCode&&n.hasOwnProperty("isLocked")&&(t(n.isLocked),t=function(){})};function le(){z&&P.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(z),z=null,X=null,b=!1,R={},V=!1,k={},W=null,O={},N="",B=[],I.forEach((function(e){e.lockedID&&t.getController().unlockNodes({ids:[e.lockedID]})})),I=[],Q=!1,K&&(J=!1,ee=!1)}var ce,ue=function(){if(z&&P.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(z),z=null,V)B.forEach((function(e){e.path&&n.add({pathElement:e.path})})),T.onMoveEnd({from:w,status:N}),"Moved"===N&&i.get().some((function(e){if(e.pathElement.isEqual(R.pathElement))return e.position=R.beginPosLocal.clone().applyMatrix4(R.pathElement.getWorldMatrix()),!0})),_&&(_.simulateReverseDirection(R.pathElement)||_.getAxisTypeIfCstOnProductAxis(R.pathElement))&&setTimeout((function(){t.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!0})}));else if(R.pathElement&&!k.partIsInCSO){var e=R.pathElement;i.add({pathElement:e,event:R.beginEvent,position:R.beginPosLocal.clone().applyMatrix4(e.getWorldMatrix())}),setTimeout((function(){t.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!0})}))}le(),ie.publish({event:"onDirectMoveEnd"})},de={panInterval:void 0,viewpoint:void 0,panDuration:100,x:void 0,y:void 0},me=function(){de.panInterval&&clearInterval(de.panInterval),de.panInterval=void 0,de.viewpoint=void 0,de.x=void 0,de.y=void 0,de.div=de.div?de.div.destroy():void 0,de.divL=de.divT=de.divR=de.divB=void 0};function pe(e){if(y&&y.cancel&&y.cancel(),y=null,me(),e&&!U?(U=!1,N="Moved"):N="Cancelled",oe&&oe.updateDisplay({visibility:!1}),V)if(K){if($&&(clearTimeout($),$=null),Z.forward(),Z.addAnimation({animationType:"opacityOff",objectListToAnimate:I,callBackFct:function(){I.forEach((function(e){e.override.setColor(null,!1)})),R.equivalentGeometry&&re({path:R.pathElement})}}),"Cancelled"===N){var o=P.getSceneGraphOverrideSetManager();I.forEach((function(e){e.currentMatrix=o.computeAppliedPosition(e.path)})),Z.addAnimation({animationType:"cancel",objectListToAnimate:I,callBackFct:function(){ue()}})}else Q?ue():J?ee=!0:(ee=!0,Z.addAnimation({animationType:"snap",objectListToAnimate:I,callBackFct:function(){Q=!0,$=!1,ee&&ue()}}));Z.startAnimation()}else ue();else B.forEach((function(o){if(o.path)if(o.path.isEqual(R.pathElement))if(k.partIsInCSO)if(b)i.remove({pathElement:R.pathElement,event:e.event}),n.remove({pathElement:R.pathElement});else{var a=R.pathElement;i.remove({pathElement:a}),i.add({pathElement:a,event:R.beginEvent,position:R.beginPosLocal.clone().applyMatrix4(a.getWorldMatrix())}),t.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!0})}else n.add({pathElement:R.pathElement});else o.path.isAParentOf(R.pathElement)&&b&&k.partIsInCSO&&(i.remove({pathElement:R.pathElement,event:e.event}),n.remove({pathElement:R.pathElement}))})),ue();P.render()}function ge(s,l){if(ce&&!G){var g=t.getFrameWindow();if(T=h.giveMoveManager({context:t}),M=v.getMoveReferentManager({context:t}),_||(_=u.getConstraintsController({context:t})),te=T?T.subscribe("onValidateMove",(function(){_&&_.deleteAllCst()})):null,ne=T?T.subscribe("onCancelMove",(function(e){_&&e.objectsCancelled.some((function(e){return _.isLevelConstrained(e.path)}))&&_.deleteAllCst()})):null,g)if(T)if(M){var D;if(P=g.getViewer(),Z=m.getAnimation3DEngine({viewer:P}),(G=new a).setDynamic(!0),G.setPrePickingDuringManipulation(!0),G.setPreActivationDuringManipulation(!0),G.setPickingDuringManipulation(!0),G.setExclusive(!0),H=G.linkToNode((D=t.getRootBagPath())?D.getLastElement(!0):null),G.HandleLongHold=function(){return le(),!0},q=G.subscribe("BeginManipulate",(function(e){if(!Z.isRunning()){var a,s=t.getController(),c=s.getRootBagId();if(z=new A(s.getRootBag(),c),P.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(z),P.setCursor("pointer"),b=e.event.gesture.events[0].event.ctrlKey,R={},l&&l.isActive())a=P.pick(P.getMousePosition(e.event.from[0].currentPosition),"primHybrid",!1),(R=l.filterPath({pathElement:a.path[0]})).pathReferent=M.getMoveReferent(a.path[0]);else{var u=p.giveSelectionManager({context:t});u&&((a=P.pick(P.getMousePosition(e.event.from[0].currentPosition),u.getPicking()?"mesh":"primHybrid",!1)).path[0]=u.getTruncatedPath(a.path[0]),R.pathElement=a.path[0],R.pathReferent=M.getMoveReferent(a.path[0]),R.equivalentGeometry=o.getEquivalentGeometry({pathElement:a.path[0],viewer:P,nonCanonicGeometry:!0}))}R.pathElement&&(R.beginEvent=e.event,R.beginPosLocal=e.position.clone().applyMatrix4((new r.Matrix4).getInverse(R.pathElement.getWorldMatrix())),B.push({path:R.pathElement}),e&&e.event&&e.event.from&&e.event.from&&e.event.from.length&&"Touch"!==e.event.from[0].type&&i.get().slice(0).forEach((function(t){t.pathElement&&(t.pathElement.isEqual(R.pathElement)?k.partIsInCSO=!0:b?(t.pathElement.isAParentOf(R.pathElement)&&(k.fatherIsInCSO=!0),B.push({path:t.pathElement})):(i.remove({pathElement:t.pathElement,event:e.event}),n.remove({pathElement:t.pathElement})))})),B.forEach((function(e){if(e.path){var n,i=I.slice(0).some((function(n){if(n.path&&(!n.path.isEqual(e.path)&&n.path.isAParentOf(e.path)||(i=e.path,!t.getRootBagPath().isAParentOf(i))))return!0;var i}));if(!L){var o=x.getCommand("CAT3DComposeMoveHdr",t.getCommandContext());!o||o.isRunning()||!t.getExecutionContext&&o.isPaused()||(i=!0)}if(i||!(n=M.getMoveReferent(e.path)))return;for(var a,r=n.externalPath.map((function(e){return C.getNodeID(e)})).filter((function(e){return e})),l=e.path.externalPath.length-1;l>0;--l)if(C.isRepReference(e.path.externalPath[l])){a=C.getNodeID(e.path.externalPath[l]);break}a&&s.lockNodes({ids:[a]}),r.unshift(c),I.push({path:n,lockedID:a,override:z.createIdPathOverride({idPathes:[new f(r)]}),initWorldMatrix:n.getWorldMatrix(),initMatrix:n.getLastElement(!0).getMatrix(),selectionWorldMatrix:R.pathElement.getWorldMatrix(),isAxisSystem:R.pathElement.externalPath.some((function(e){return"AxisSystems"===e.name}))})}})))}})),j=G.subscribe("Manipulate",(function a(c,u){if(y&&y.cancel&&y.cancel(),y=null,!Z.isRunning()&&(P.setCursor("pointer"),!c.event.from[0].currentPosition.equals(c.event.from[0].lastPosition)&&I.length)){var m=s?c.intersection.path[0]:null;if(!V){if(c&&c.event&&c.event.from&&c.event.from&&c.event.from.length&&"Touch"===c.event.from[0].type&&i.get().slice(0).forEach((function(e){e.pathElement&&(e.pathElement.isEqual(R.pathElement)?k.partIsInCSO=!0:b?(e.pathElement.isAParentOf(R.pathElement)&&(k.fatherIsInCSO=!0),B.push({path:e.pathElement})):(i.remove({pathElement:e.pathElement,event:c.event}),n.remove({pathElement:e.pathElement})))})),ie.publish({event:"onDirectMoveBegin"}),!k.partIsInCSO){var p=R.pathElement;i.add({pathElement:p,event:R.beginEvent,position:R.beginPosLocal.clone().applyMatrix4(p.getWorldMatrix())})}B.forEach((function(e){e.path&&n.remove({pathElement:e.path})})),T.onMoveBegin({objectsMoved:I,from:w,moveMode:"Transient"}),I.forEach((function(e){e.path&&e.override.setPickability("IGNORED")})),P.render(),R.equivalentGeometry||(R.equivalentGeometry=o.getEquivalentGeometry({pathElement:R.pathReferent,axis:_.getProductAxisForConstraint(),viewer:P})),K?(Z.addAnimation({animationType:"opacityOn",objectListToAnimate:I,callBackFct:function(){R.equivalentGeometry&&R.equivalentGeometry.getMode()===E.GeometryMode.REAL&&re({path:R.pathElement,color:F}),I.forEach((function(e){e.path&&se({objectToMove:e})}))}}),Z.startAnimation()):(R.equivalentGeometry&&R.equivalentGeometry.getMode()===E.GeometryMode.REAL&&re({path:R.pathElement,color:F}),I.forEach((function(e){e.path&&(e.override.setOpacity(.35,!1),se({objectToMove:e}))}))),_&&(_.count()>0&&!R.equivalentGeometry||_.count()>0&&!_.isLevelConstrained(R.pathReferent))&&_.deleteAllCst(),V=!0}if(!function(n){function i(){if(de.viewpoint||(de.viewpoint=P.currentViewpoint),de.viewpoint&&de.viewpoint.control&&void 0!==de.x&&void 0!==de.y){var n,i,o=new r.Vector3(de.x,de.y,0);if(o.applyQuaternion(de.viewpoint.control.orientation),o.setLength(.05*de.viewpoint.control.distanceToTarget),n=de.viewpoint.target.clone().add(o),i=de.viewpoint.control.distanceToTarget,de.viewpoint.moveTo({eyePosition:n.add(de.viewpoint.getCamera().getLookAt().normalize().multiplyScalar(-i)),duration:K?de.panDuration:0}),!de.div){var a=t.getFrameWindow().getUIFrame();de.div=e.createElement("div",{id:"C3D-viewpoint",styles:{top:P.SCREEN_HEIGHT/2+"px",left:P.SCREEN_WIDTH/2+"px"}}).inject(a);var s=function(t){var n=e.createElement("div",{class:t.side}).inject(de.div);n.setStyle(t.posKey,t.posValue+"px");var i=e.createElement("div",{class:"arrow"}).inject(n);return e.createElement("div",{class:"borderBottom"}).inject(i),e.createElement("div",{class:"borderRight"}).inject(i),n},l=Math.min(P.SCREEN_WIDTH/10,P.SCREEN_HEIGHT/10);de.divL=s({side:"left",posKey:"left",posValue:-l}),de.divT=s({side:"top",posKey:"top",posValue:-l}),de.divR=s({side:"right",posKey:"left",posValue:l}),de.divB=s({side:"bottom",posKey:"top",posValue:l})}de.x<0?de.divL.addClassName("active"):de.divL.removeClassName("active"),de.x>0?de.divR.addClassName("active"):de.divR.removeClassName("active"),de.y<0?de.divB.addClassName("active"):de.divB.removeClassName("active"),de.y>0?de.divT.addClassName("active"):de.divT.removeClassName("active")}}var o=(n.event.gesture?n.event.gesture.getEvents()[0]:n.event.from[0]).getCurrentPosition(t.getViewer().canvas);return de.x=o.x<=9?-1:o.x>=P.SCREEN_WIDTH-10-1?1:0,de.y=o.y<=9?1:o.y>=P.SCREEN_HEIGHT-10-1?-1:0,0===de.x&&de.y?de.x=o.x<P.SCREEN_WIDTH/3?-1:o.x>2*P.SCREEN_WIDTH/3?1:0:0===de.y&&de.x&&(de.y=o.y<P.SCREEN_HEIGHT/3?1:o.y>2*P.SCREEN_HEIGHT/3?-1:0),de.x||de.y?(clearInterval(de.panInterval),de.panInterval=setInterval((function(){i()}),de.panDuration),i(),1):(me(),0)}({event:c.event})){var g=s?P.pick(P.getMousePosition(c.event.from[0].currentPosition),"primHybrid",!1):{path:[]};g.path[0]&&!C.isAModelPath(g.path[0])&&(g.path[0]=null);var v={pathElement:g.path[0]};!(y=d.switchToAV1withMesh({pathElement:v.pathElement,pad3DViewer:t,selectionFilter:l?l.getFiltersState():null,onComplete:function(){a(c,!0),y=null},onFailure:function(){y=null}}))||"filtered"!==y.status&&"done"!==y.status||(y=null),l&&l.filterPath(v);var h=!1;v.pathElement&&O.pathElement&&(h=O.pathElement.isEqual(v.pathElement)),O=v,W&&!h&&(_.deleteLastCst(),W=null);var f={},D=null,A=null;if(v.pathElement&&m&&!R.pathReferent.isAParentOf(m)){var S=R.equivalentGeometry&&R.equivalentGeometry.getType(),x=v.equivalentGeometry&&v.equivalentGeometry.getType();if(D=S&&S!==E.GeometryType.AXISSYSTEM&&S!==E.GeometryType.SURFACE,A=x&&x!==E.GeometryType.AXISSYSTEM&&x!==E.GeometryType.SURFACE,v.pathElement&&!R.pathReferent.isAParentOf(v.pathElement)&&A&&D){if(!h){W=_.createCst({movable:R,fixed:v});var M=_.simulateSolveCst();if(M){var N=M.matrix;f.rc=M.rc,f.redundancy=M.redundancy,0===f.rc&&N&&!f.redundancy?f.matrix=N.multiply(R.pathReferent.getWorldMatrix()):(0!==f.rc||f.redundancy)&&(_.deleteLastCst(),W=null),O=v}else O={}}}else v&&v.pathElement&&(f.matrix=v.pathElement.getWorldMatrix(),v.pathElement.externalPath.some((function(e){return"AxisSystems"===e.name}))?(f.isAxisSystem=!0,oe.updateDisplay({visibility:!1})):oe.updateDisplay({pathElement:v.pathElement,visibility:!0}))}if(f.matrix){var L;if(f.isAxisSystem&&I[0].isAxisSystem){var H=(new r.Matrix4).copy(f.matrix);H.multiply((new r.Matrix4).getInverse(I[0].selectionWorldMatrix)),H.multiply(I[0].initWorldMatrix),L=(new r.Matrix4).getInverse(I[0].initWorldMatrix).multiply(H)}else(L=(new r.Matrix4).getInverse(I[0].initWorldMatrix).multiply(f.matrix)).multiply((new r.Matrix4).getInverse(R.pathElement.getLastElement(!0).getMatrix()));I.forEach((function(e,t){var n=(new r.Matrix4).copy(e.initWorldMatrix).multiply(L);if(e.path){var i=(new r.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix()),o=(new r.Matrix4).copy(i).multiply(n),a=null;e.snappedPosition&&(a=(new r.Matrix4).copy(e.snappedPosition));var s=a&&a.equals(o);if(e.snappedPosition=(new r.Matrix4).copy(o),K){var l=(new r.Matrix4).copy(e.initWorldMatrix),d=(new r.Vector3).getPositionFromMatrix(e.initWorldMatrix).add(c.translationVector);l.setPosition(d);var m=(new r.Matrix4).copy(i).multiply(l);Q?s||(e.currentPosition=o):(e.currentPosition=(new r.Matrix4).copy(m),(_&&_.count()<=1&&A&&D||!A&&!D||A&&!D)&&e.override.setPosition(m)),0===t&&(e.snappedTarget=v.pathElement,s||!v.pathElement||e.snappedTarget.isEqual(v.pathElement)||(clearTimeout($),$=null),$||s&&Q||y||($=setTimeout((function(){Z.addAnimation({animationType:"snap",objectListToAnimate:I,callBackFct:function(){Q=!0,$=null,ee&&ue()}}),Z.addAnimation({animationType:"opacityOff",offsetTime:Z.getDefaultDuration("snap"),objectListToAnimate:I,callBackFct:function(){I.forEach((function(e){e.override.setColor(null,!1)})),R.equivalentGeometry&&re({path:R.pathElement})}}),Z.startAnimation()}),u?0:500)))}else e.override.setPosition(o),Q=!0}})),U=!1,T.onMove({objectsMoved:I,transformation:L,from:w})}else if(oe&&oe.updateDisplay({visibility:!1}),void 0===v.pathElement||null===v.pathElement||f.rc&&0!==f.rc||f.redundancy?(U=!0,T.onMove({objectsMoved:I,vector:c.translationVector,from:w})):A&&D&&0===f.rc&&(U=!1),void 0!==v.pathElement||null!==v.pathElement){var q=null;I.forEach((function(e,t){if(e.path){var n=null;if(0===_.count()||1===_.count()&&W){var i=(new r.Matrix4).copy(e.initWorldMatrix),o=(new r.Vector3).getPositionFromMatrix(e.initWorldMatrix).add(c.translationVector);i.setPosition(o);var a=e.path.getParentPath().getWorldMatrix();n=(new r.Matrix4).getInverse(a).multiply(i),Q||e.override.setPosition(n),e.currentPosition=(new r.Matrix4).copy(n)}else{if(0===t){q=null,W&&_.deleteLastCst();var s=(new r.Vector3).addVectors(c.translationVector,G.initial3dIntersectionPoint),l=null;l=X?(new r.Vector3).subVectors(c.translationVector,X):c.translationVector,X=c.translationVector;var u=_.simulateMoveWithCst({movableReference:s,translation:l});u&&0===u.rc&&u.matrix&&(q=u.matrix.multiply(R.pathReferent.getWorldMatrix())),W&&_.restoreLastDeletedCst()}if(q){var d=(new r.Matrix4).getInverse(I[0].initWorldMatrix).multiply(q),m=(new r.Matrix4).copy(e.initWorldMatrix).multiply(d),p=(new r.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix());n=(new r.Matrix4).copy(p).multiply(m),Q||e.override.setPosition(n)}e.currentPosition=(new r.Matrix4).copy(e.initMatrix)}}})),K?h||($&&(clearTimeout($),$=null),Q&&U&&(Z.addAnimation({animationType:"unsnap",objectListToAnimate:I,callBackFct:function(){Q=!1,I.forEach((function(e){e.snappedPosition=null}))}}),Z.addAnimation({animationType:"opacityOn",objectListToAnimate:I,offsetTime:Z.getDefaultDuration("unsnap"),callBackFct:function(){R.equivalentGeometry&&re({path:R.pathElement,color:F}),I.forEach((function(e){e.path&&se({objectToMove:e})}))}}),Z.startAnimation())):Q&&U&&(I.forEach((function(e){e.path&&e.currentPosition&&e.override.setPosition(e.currentPosition)})),Q=!1)}ae.updateDisplay(v,c.intersection.position,c.intersection.normal),P.render()}}})),Y=G.subscribe("EndManipulate",pe),0===oe.getChildren().length){var S=new c({headLength:10,arrowLength:50,arrowWidth:2,head:c.types.ARROW});oe.addChild(S)}oe.updateDisplay({visibility:!1}),P.render({updateInfinitePlane:!0})}else window.console.log("A move referent component must be defined");else window.console.log("A move manager component must be defined");else window.console.log("A frame window must be defined")}}function Ce(){me(),te&&(T.unsubscribe(te),te=null),ne&&(T.unsubscribe(ne),ne=null),G&&(G.unsubscribe(q),G.unsubscribe(j),G.unsubscribe(Y),G.unlink(H),G=q=j=Y=H=null),oe&&oe.removeChildren(),ae&&ae.removeChildren()}this.activate=function(e){t=e.context,ce=!0,ge(e.withSnap,e.selectionFilter)},this.deactivate=function(){Ce(),ce=!1},this.unreference=function(){Ce(),_&&(_.deleteAllCst(),_.unreference()),oe&&P.removeNode(oe),oe=null,ae&&P.removeNode(ae),ae=null,t=null,ie=null,ce=!1},this.subscribe=function(e,t){return"onDirectMoveBegin"===e||"onDirectMoveEnd"===e?ie.subscribe({event:e},t):void 0},this.unsubscribe=function(e){return ie.unsubscribe(e)},this.setAllowManipulation=function(e){L=e}}});return t.singleton({init:function(){},activate:function(e){var t;t=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===t&&(y||(y=new b),y.activate(e))},deactivate:function(e){var t;t=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===t&&y&&y.deactivate()},unreference:function(e){var t;t=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===t&&(y&&y.unreference(),y=null)},subscribe:function(e,t){return y?y.subscribe(e,t):null},unsubscribe:function(e){return y?y.unsubscribe(e):null},give:function(){return y}})})),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeAssemblyPatternCmd",["DS/CATWebUXComponents/DMUStateCommand","DS/CoreEvents/Events","DS/CATWebUXComponents/CATWebUXNotifBar","DS/FlagPanel/FlagPanel","DS/FlagPanel/FlagPanelEnums","DS/FlagPanel/FlagPanelManager","DS/PADUtils/PADContext","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter","DS/Selection/HSOManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUtils/CATC3DUtils","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CATW3DAnims/CATW3DAnimation3D","DS/Mesh/Mesh","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeAssemblyPatternCmd","css!DS/UIKIT/UIKIT"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,C,v,h,f,D){"use strict";return e.extend({init:function(e){var A,S,E,x,y,b,T,M,P,w,R=this,I=0,N=r.get(),U=N.getFrameWindow(),L=N.getViewer(),_=!1,W=!1,O={},F={},V="NOPATTERN",k=!0,B="LINEAR",X="LINEAR",G={count:2,spacing:50,angle:30,reverse:!1},H={count:2,spacing:50,angle:30,reverse:!1},q={NOPATTERN:{REFERENCE:1,POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0},NOPATTERN_LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_RECTANGULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_CIRCULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1},LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},RECTANGULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},CIRCULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1}},j={NOPATTERN:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEM","AXISSYSTEMORIGIN","AXISSYSTEMAXIS","REFERENCE"],NOPATTERN_LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_RECTANGULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_CIRCULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_USERDEFINED:["POINT","CENTER","AXISSYSTEM"],LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],RECTANGULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],CIRCULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],USERDEFINED:["POINT","CENTER","AXISSYSTEM"]},Y=function(e){return e===T.geometryTypesEnum.POINT||e===T.geometryTypesEnum.CIRCLE||e===T.geometryTypesEnum.AXISSYSTEM||e===T.geometryTypesEnum.AXISSYSTEMORIGIN},z=function(){var e={version:3,reuse:k,radioPattern:X,direction1:G,direction2:H,filters:q};e.reuse=!0,localStorage.setItem("CAT3DComposeAssemblyPatternCmd",JSON.stringify(e))},K=function(e,n,i,o){var a;i=void 0===i||i,o=void 0===o||o,P.removeFlag(S[e]),S[e].destroy(),delete S[e],e!==W&&o&&delete O[e],e===x?(x=null,y&&(G.count=H.count,G.spacing=H.spacing,G.reverse=H.reverse,S[y].destroy(),delete S[y],x=y,y=null)):e===y?y=null:e===_&&(n&&"NOPATTERN"===n&&(a="NOPATTERN",W&&(a=a+"_"+X),q[a]=T.getActiveFilters(),V=null),L.removeNode(b),_=null),T.object3D[0]=null,i&&t.publish({event:"C3D_UNSELECT_EVT"})},J=function(e){var t,n,i,o,a,r,s=0,l=function(e){var t,n,i={bReference:Boolean(W),bOrigin:Boolean(_),typesCount:{}};for(t in T.geometryTypesEnum)T.geometryTypesEnum.hasOwnProperty(t)&&(i.typesCount[T.geometryTypesEnum[t]]=0);for(t in O)O.hasOwnProperty(t)&&t!==_&&t!==W&&i.typesCount[O[t].type]++;return T.object3D[0]&&!O[T.object3D[0].pathElement.getKey()]&&(n=T.getSelType(T.object3D[0].pathElement),W||n!==T.geometryTypesEnum.REFERENCE?!_&&Y(n)?i.bOrigin=!0:!_&&e!==M.USERDEFINED.id&&Y(n)||i.typesCount[n]++:i.bReference=!0),i}(e.stateID);if(!l||!l.bReference)return!1;for(s=0,a=(o=Object.keys(l.typesCount)).length,i=e.validTypes.length,t=0;t<a;++t)if(l.typesCount[o[t]]>0){for(r=!1,n=0;n<i;++n)if(o[t]===e.validTypes[n].type.toString()&&!(e.validTypes[n].maxcount&&l.typesCount[o[t]]>e.validTypes[n].maxcount)){s+=l.typesCount[o[t]],r=!0;break}if(!r)return!1}return e.stateID===M.USERDEFINED.id&&l.bOrigin&&s++,e.stateID===M.CIRCULAR.id&&l.bOrigin&&0===s&&s++,e.validSelCount>-1&&s===e.validSelCount||-1===e.validSelCount&&s>0},Z=function(e,t,n){var i=new u.Vector3;return e.type===T.geometryTypesEnum.POINT?i.subVectors(e.canonicGeom.getPoint(),t.position):e.type===T.geometryTypesEnum.LINE?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===T.geometryTypesEnum.CIRCLE?i.subVectors(e.canonicGeom.getCenter(),t.position):e.type===T.geometryTypesEnum.CYLINDER?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===T.geometryTypesEnum.AXISSYSTEM||e.type===T.geometryTypesEnum.AXISSYSTEMORIGIN?i.subVectors(e.position,t.position):e.type===T.geometryTypesEnum.AXISSYSTEMAXIS&&(i=e.canonicGeom.getDirection()),n?i.normalize():i},Q=function(e){var t,n,i;if(!e.getParentPath)return null;for(i=(n=e.getParentPath().clone()).getLength()-1;i>=0;--i)if((t=n.externalPath[i])&&f.isReference(t))return n.setFromArray(n.externalPath.slice(0,i+1)),n;return null},$=function(e){F.hasOwnProperty(e)&&(F[e].pRefParent.getLastElement().removeChild(F[e].node),delete F[e],I--),L.render()},ee=function(){var e;if(F)for(e in F)F.hasOwnProperty(e)&&$(e)},te=function(e,t,n){var i,o,a,r,s;return a=t.clone(),(s=t.getWorldMatrix()).getInverse(s),(i=new u.Matrix4).multiplyMatrices(s,n),I++,(o=new d("PreviewNode"+I)).setMatrix(i),o.addChild(e.pathElement.getLastElement()),t.getLastElement().addChild(o),a.addElement(o),r=a.getKey(),F[r]={node:o,activated:!0,pathElement:a,pRefParent:t},r},ne=function(e,t,n){var o={position:(new u.Matrix4).setPosition(O[e].position),iconUrl:O[e].iconUrl?O[e].iconUrl:"",closeButton:!0,closeCB:function(){K(e,n)}};S[e]=new i(L,o),t&&S[e].setOffset(t),P.addFlag(S[e])},ie=function(e,n,a,r,s){var l={position:O[n].clickPos?(new u.Matrix4).setPosition(O[n].clickPos):new u.Matrix4,label:a,iconUrl:O[n].iconUrl?O[n].iconUrl:"",closeButton:!0,closeCB:function(){K(n,e)},dialogs:[{type:o.fieldsTypeEnum.INTEGER,value:r.count,suffix:D.SUFFIX_INSTANCES,fnCallback:function(e){r.count=parseInt(e),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.DOUBLE,prefix:D.PREFIX_SPACING,value:"CIRCULAR"===e?r.angle:r.spacing,suffix:"CIRCULAR"===e?"":"mm",fnCallback:function(n){"CIRCULAR"===e?r.angle=parseInt(n):r.spacing=parseInt(n),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReverseDirection.png",value:r.reverse,fnCallback:function(e){r.reverse=e,t.publish({event:"C3D_PARAMETERS_CHG"})}}]};S[n]=new i(L,l),s&&S[n].setOffset(s),P.addFlag(S[n])},oe=function(e){var n,a,r,s,l,c,d,m,p,f,A,E,w="NOPATTERN"===e?X:e,R={};for(a in S)S.hasOwnProperty(a)&&(R[a]=S[a].getOffset(),P.removeFlag(S[a]),S[a].destroy(),delete S[a]);if(b&&L.removeNode(b),W){for(c=function(){var e,t=[];for(e in M)(M[e].conditions&&J(M[e].conditions)||W&&_&&2===Object.keys(O).length&&-1!==["LINEAR","CIRCULAR","USERDEFINED"].indexOf(e))&&t.push(e);return 0===t.length&&(t=["LINEAR","CIRCULAR","USERDEFINED"]),t}(),n=[{value:w,iconUrl:M[w].iconUrl,label:D["LABEL_"+w],isdefault:!0}],l=c.length||0,s=0;s<l;++s)c[s]!==w&&n.push({value:c[s],iconUrl:M[c[s]].iconUrl,label:D["LABEL_"+c[s]]});d={position:O[W].clickPos?(new u.Matrix4).setPosition(O[W].clickPos):(new u.Matrix4).setPosition(O[W].position),label:D.FLAG_REF_LABEL,iconUrl:O[W].iconUrl?O[W].iconUrl:"",closeButton:!0,closeCB:function(){P.removeFlag(S[W+"ref"]),S[W+"ref"].destroy(),delete S[W+"ref"],W!==_&&delete O[W],"NOPATTERN"===e&&(m="NOPATTERN",W&&(m=m+"_"+X),q[m]=T.getActiveFilters(),V=null),W=null,T.object3D[0]=null,t.publish({event:"C3D_UNSELECT_EVT"})},dialogs:[{type:o.fieldsTypeEnum.RADIO,radios:n,fnCallback:function(e){B=X,oe(X=e),t.publish({event:"C3D_PATTERN_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReuse.png",value:k}]},S[W+"ref"]=new i(L,d),S[W+"ref"].setOffset(R[W+"ref"]),(p=S[W+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1]).style.width=0,p.style.border=0,p.style.padding=0,p.style.margin=0,P.addFlag(S[W+"ref"])}if(W&&S[W+"ref"]&&W!==_?S[W+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].removeClassName("hidden"):W&&S[W+"ref"]&&S[W+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].addClassName("hidden"),_&&e!==M.USERDEFINED.id&&w!==M.USERDEFINED.id&&(f=O[_].worldMatrix.clone().setPosition(O[_].position),A=v.getAnimation3DEngine({viewer:L}),(E=new C({headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new h.Color(.25,.63,.85,1),colorY:new h.Color(.25,.63,.85,1),colorZ:new h.Color(.25,.63,.85,1)},head:C.types.ARROW})).exludeFromBounding(!0),E.setVisibilityInTree(!1),E.setPickable(h.PICKTHROUGH),E.setMatrix(f),L.addNode(E),A.axisSystemVisibility({objectListToAnimate:[E],visibility:!0,pickability:!1}),A.startAnimation(),b=E,e!==M.CIRCULAR.id||x||y?(d={position:(new u.Matrix4).setPosition(O[_].position),label:D.FLAG_ORIGIN_LABEL,iconUrl:O[_].iconUrl?O[_].iconUrl:"",closeButton:!0,closeCB:function(){K(_,e)}},_===W&&(d.offset=new u.Vector2(0,50)),S[_]=new i(L,d),S[_].setOffset(R[_]),P.addFlag(S[_])):ie(e,_,D.LABEL_AXIS,G,R[_])),e===M.USERDEFINED.id||w===M.USERDEFINED.id)for(r in O)O.hasOwnProperty(r)&&r!==W&&ne(r,R[r],e);else x&&ie(e,x,D.LABEL_DIR1,G,R[x]),y&&ie(e,y,D.LABEL_DIR2,H,R[y])},ae=function(e){var t,n,i,o,a,r,s,l,c,d,p,g,C,v,h,f,D,A,S,b,P=[],w=L.getSceneGraphOverrideSetManager();for(t in E&&(w.removeSceneGraphOverrideSet(E),E=null),E=new m(N.getRootBagPath().externalPath[0]),F)F.hasOwnProperty(t)&&$(t);if(W)switch(P.push(O[W].pathElement),i=_&&O.hasOwnProperty(_)?O[_]:null,"USERDEFINED"!==e&&"USERDEFINED"!==X&&(_&&(s=_),x&&(v=Z(O[x],i,!0),s=x,D=v.clone().setLength((G.reverse?-1:1)*G.spacing),h=(new u.Matrix4).makeTranslation(D.x,D.y,D.z)),y&&(D=Z(O[y],i,!0).clone().setLength((H.reverse?-1:1)*H.spacing),f=(new u.Matrix4).makeTranslation(D.x,D.y,D.z))),C=O[W],(g=(p=Q(C.pathElement)).getWorldMatrix()).getInverse(g),A=k?C.worldMatrix.clone().setPosition(C.position):C.worldMatrix.clone().setPosition(i.position),e){case M.LINEAR.id:if(x)for(o=0;o<G.count;++o)(0!==o||k)&&o>0&&(A=h.clone().multiply(A),S=te(C,p,A),P.push(F[S].pathElement));break;case M.RECTANGULAR.id:if(x&&y)for(d=A.clone(),c=0;c<H.count;++c)for(c>0&&(d=f.clone().multiply(d)),A=d.clone(),o=0;o<G.count;++o)0===o&&(c>0||!k)?(S=te(C,p,A),P.push(F[S].pathElement)):o>0&&(A=h.clone().multiply(A),S=te(C,p,A),P.push(F[S].pathElement));break;case M.CIRCULAR.id:if(s)for(r=v||O[s].canonicGeom.getNormal().clone(),n=(new u.Matrix4).makeRotationAxis(r,(G.reverse?-1:1)*G.angle*Math.PI/180),l=(new u.Matrix4).setPosition(O[s].position),o=0;o<G.count;++o)(0!==o||k)&&o>0&&(A=l.clone().multiply(n.clone().multiply((new u.Matrix4).getInverse(l).multiply(A))),S=te(C,p,A),P.push(F[S].pathElement));break;case M.USERDEFINED.id:for(a in O)O.hasOwnProperty(a)&&a!==W&&(A=O[a].type===T.geometryTypesEnum.AXISSYSTEM?O[a].worldMatrix.clone():C.worldMatrix.clone().setPosition(O[a].position),S=te(C,p,A),P.push(F[S].pathElement))}E&&((b=E.createOverride({pathes:P}))&&(b.setOpacity(.5),b.setPickability("IGNORED")),w.pushSceneGraphOverrideSet(E))},re=function(){var e;for(e in c.empty(),O)O.hasOwnProperty(e)&&c.add(O[e]);for(e in F)F.hasOwnProperty(e)&&c.add(F[e])},se=function(e){var t=null,n=g.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),i=g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");switch(e){case T.geometryTypesEnum.POINT:t=n+"I_Meas_Point.png";break;case T.geometryTypesEnum.CENTER:case T.geometryTypesEnum.CIRCLE:t=n+"I_Meas_PointCircle.png";break;case T.geometryTypesEnum.AXISSYSTEM:t=i+"I_3DComposeAxisSystem.png";break;case T.geometryTypesEnum.AXISSYSTEMORIGIN:t=i+"I_C3DAxisOrigin.png";break;case T.geometryTypesEnum.AXISSYSTEMAXIS:t=i+"I_C3DAxisAxis.png";break;case T.geometryTypesEnum.PLANE:t=n+"I_Meas_Plane.png";break;case T.geometryTypesEnum.CYLINDER:t=n+"I_Meas_Cylinder.png";break;case T.geometryTypesEnum.LINE:t=n+"I_Meas_Line.png"}return t},le=function(e){_=e},ce=function(e){var t,n,i,o,a=e;for(V&&(q[V]=T.getActiveFilters()),W&&a===M.NOPATTERN.id&&(a=a+"_"+X),o=q[a],W&&o.REFERENCE&&delete o.REFERENCE,n=0,i=j[a].length;n<i;++n)o.hasOwnProperty(j[a][n])||(o[j[a][n]]=0);for(t in o)o.hasOwnProperty(t)&&-1===j[a].indexOf(t)&&delete o[t];e===M.CIRCULAR.id&&x&&(o={}),T.updateFilters(o,!1)},ue=function(e){var t,n=Object.keys(O),i=n.length;for(_||(y&&Y(O[y].type)&&K(y,e,!1,!1),x&&Y(O[x].type)&&K(x,e,!1,!1)),t=0;t<i;++t)if(Y(O[n[t]].type)){if(!_&&n[t]!==x&&n[t]!==y){le(n[t]);continue}if(!x&&n[t]!==_&&n[t]!==y){x=n[t];continue}if(!y&&n[t]!==x&&n[t]!==_){y=n[t];continue}}oe(e)},de=function(e,n,i){var o,a,r,l,c,d,m=null,p=new u.Vector3;T.object3D[0]&&T.object3D[0].pathElement&&(m=T.object3D[0].pathElement),m&&!O[m.getKey()]&&(r=(o=s.getEquivalentGeometry({pathElement:m,axisSystemSub:!0,viewer:L}))?o.getType():T.geometryTypesEnum.REFERENCE,l=m.getWorldMatrix(),a=m.getKey(),r===T.geometryTypesEnum.REFERENCE||r===T.geometryTypesEnum.AXISSYSTEM||r===T.geometryTypesEnum.AXISSYSTEMAXIS?p.getPositionFromMatrix(l):p=function(e){var t=null,n=e.getType();if(void 0===n)return null;switch(n){case T.geometryTypesEnum.POINT:t=e.getPoint();break;case T.geometryTypesEnum.LINE:case T.geometryTypesEnum.CYLINDER:t=e.getEndPoints().beginPoint;break;case T.geometryTypesEnum.CIRCLE:case T.geometryTypesEnum.CENTER:t=e.getCenter()}return t}(o),O[a]={pathElement:m,type:r,worldMatrix:l,position:p,clickPos:T.object3D[0].position,canonicGeom:o,iconUrl:se(r)},r===T.geometryTypesEnum.AXISSYSTEM&&(O[a].clickPos=p),W||r!==T.geometryTypesEnum.REFERENCE?!_&&e.id!==M.USERDEFINED.id&&Y(r)?le(a):a!==_&&a!==W&&(x?y||(y=a,!_||r!==T.geometryTypesEnum.POINT&&r!==T.geometryTypesEnum.CIRCLE&&r!==T.geometryTypesEnum.AXISSYSTEM||(H.spacing=Math.round(1e3*O[_].position.distanceTo(p))/1e3)):(x=a,!_||r!==T.geometryTypesEnum.POINT&&r!==T.geometryTypesEnum.CIRCLE&&r!==T.geometryTypesEnum.AXISSYSTEMORIGIN||(G.spacing=Math.round(1e3*O[_].position.distanceTo(p))/1e3))):(c=a,d=f.getNodeID(O[c].pathElement.getLastElement(!0)),W=c,O[c].iconUrl="",N.getController().getAttributes({ids:[d],attributes:["type_icon_url"],callbacks:{onComplete:function(e){O[c].iconUrl=e[d]?e[d].type_icon_url:"",S[c+"ref"]&&S[c+"ref"].setIcon(O[c].iconUrl)},onFailure:function(){}}})),T.object3D=[]),oe(e.id),ce(e.id),z(),ae(e.id),e.id!==M.NOPATTERN.id?A.removeAll((function(){A.add({message:D["LABEL_"+e.id],closable:!1,buttons:[{label:D.SAVEBTN,className:"primary",onClick:function(){t.publish({event:"C3D_SAVE_CLICK"})},doClose:!0},{label:D.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})})):A.removeAll((function(){var n=0;W&&(n=1),A.add({message:D["LABEL_"+e.id+"_"+n],closable:!1,buttons:[{label:D.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})})),i(),re()},me=function(e,t,n){ae(e.id),ce(e.id),z(),n(),re()},pe=function(){return!!W||(A.add({message:D.NOREFERROR,msgType:"warning",autoHide:!0,closable:!0}),!1)},ge=function(){var e;for(e in z(),c.empty(),_=null,W=null,x=null,y=null,F&&ee(),E&&(L.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(E),E=null),L.setDefaultPicking(!0),T&&T.deactivate(),ee(),A&&(A.destroy(),A=null),b&&L.removeNode(b),S)S.hasOwnProperty(e)&&(P.removeFlag(S[e]),S[e].destroy(),delete S[e]);S.length=0,R.end?R.end():R.done()},Ce=function(e){var t,n,i,o=L,a={context:N,parentID:null,children:[],onCompleted:function(t){var n=t.length||0;if(0===n)return ge(),void e();t.forEach((function(t){n--,!t.instID&&t.message&&A.add({message:t.message,msgType:"error",autoHide:!0,closable:!0}),0===n&&(ge(),e())}))}};if(F&&O){for(t in n=O[W],i=f.getNodeID(n.pathElement.getLastElement()),a.parentID=f.getNodeID(Q(n.pathElement).getLastElement()),F)F.hasOwnProperty(t)&&F[t].activated&&a.children.push({id:i,matrix:F[t].pathElement.getMatrix(o)});p.insertExisting(a)}},ve=function(e){ge(),e()};this.buildGraph=function(){P||(P=new a(L)),_=null,W=null,x=null,y=null,O={},A=(new n).inject(U.getUIFrame()),S=[],c.isEmpty()&&A.add({message:D.LABEL_NOPATTERN_0,closable:!1,buttons:[{label:D.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]}),L.setDefaultPicking(!1);var e=g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),i=this.createInitialState("NoPatternState"),o=this.createState("LinearState"),r=this.createState("RectangularState"),s=this.createState("CircularState"),u=this.createState("UserDefineState"),d=this.getFinalState(),m=q.NOPATTERN;W||(m={POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0,REFERENCE:1}),T=new l({context:N,activeFilters:m,postFilter:function(e){var t=f.getRoots(N);return!!f.isAModelPath(e)&&(!Array.isArray(t)||-1===t.indexOf(e.getLastElement()))}}),M={NOPATTERN:{id:"NOPATTERN",iconUrl:"",chkConditions:function(){return!0},actions:function(e){de(M.NOPATTERN,0,e)}},LINEAR:{id:"LINEAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return("LINEAR"===X||"RECTANGULAR"===X)&&J(M.LINEAR.conditions)},conditions:{stateID:"LINEAR",debugTxt:"Linear pattern condition",validSelCount:1,validTypes:[{type:T.geometryTypesEnum.POINT},{type:T.geometryTypesEnum.CIRCLE},{type:T.geometryTypesEnum.LINE},{type:T.geometryTypesEnum.AXISSYSTEM},{type:T.geometryTypesEnum.AXISSYSTEMAXIS},{type:T.geometryTypesEnum.CYLINDER}]},actions:function(e){de(M.LINEAR,0,e)}},RECTANGULAR:{id:"RECTANGULAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return!("LINEAR"!==X&&"RECTANGULAR"!==X||!x)&&J(M.RECTANGULAR.conditions)},conditions:{stateID:"RECTANGULAR",debugTxt:"Rectangular pattern condition",validSelCount:2,validTypes:[{type:T.geometryTypesEnum.POINT},{type:T.geometryTypesEnum.CIRCLE},{type:T.geometryTypesEnum.LINE},{type:T.geometryTypesEnum.CYLINDER},{type:T.geometryTypesEnum.AXISSYSTEM},{type:T.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){de(M.RECTANGULAR,0,e),L.setDefaultPicking(!1)}},CIRCULAR:{id:"CIRCULAR",iconUrl:e+"I_C3DCircularPattern.png",chkConditions:function(){return"CIRCULAR"===X&&J(M.CIRCULAR.conditions)},conditions:{stateID:"CIRCULAR",debugTxt:"Circular pattern condition",validSelCount:1,validTypes:[{type:T.geometryTypesEnum.POINT},{type:T.geometryTypesEnum.CIRCLE},{type:T.geometryTypesEnum.CYLINDER},{type:T.geometryTypesEnum.LINE},{type:T.geometryTypesEnum.AXISSYSTEM},{type:T.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){de(M.CIRCULAR,0,e)}},USERDEFINED:{id:"USERDEFINED",iconUrl:e+"I_C3DUserPattern.png",chkConditions:function(){return"USERDEFINED"===X&&J(M.USERDEFINED.conditions)},conditions:{stateID:"USERDEFINED",debugTxt:"User defined pattern condition",validSelCount:-1,validTypes:[{type:T.geometryTypesEnum.POINT},{type:T.geometryTypesEnum.CIRCLE},{type:T.geometryTypesEnum.AXISSYSTEM}]},actions:function(e){de(M.USERDEFINED,0,e)}}},this.addTransition({iInitialState:i,iFinalState:o,iEvent:T,iCondition:function(){return M.LINEAR.chkConditions()},iAction:function(e){V="NOPATTERN_LINEAR",M.LINEAR.actions(e)},iSender:R}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:T,iCondition:function(){return M.RECTANGULAR.chkConditions()},iAction:function(e){V="NOPATTERN_LINEAR",M.RECTANGULAR.actions(e)},iSender:R}),this.addTransition({iInitialState:i,iFinalState:s,iEvent:T,iCondition:function(){return M.CIRCULAR.chkConditions()},iAction:function(e){V="NOPATTERN_CIRCULAR",M.CIRCULAR.actions(e)},iSender:R}),this.addTransition({iInitialState:i,iFinalState:u,iEvent:T,iCondition:function(){return M.USERDEFINED.chkConditions()},iAction:function(e){V="NOPATTERN_USERDEFINED",M.USERDEFINED.actions(e)},iSender:R}),this.addTransition({iInitialState:i,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){V="NOPATTERN",W&&(V=V+"_"+X),ve(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:T,iCondition:function(){return M.NOPATTERN.chkConditions()},iAction:function(e){V="NOPATTERN",W&&(V=V+"_"+X),M.NOPATTERN.actions(e)},iSender:R}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:T,iCondition:function(){return M.LINEAR.chkConditions()},iAction:function(e){V="LINEAR",M.LINEAR.actions(e)},iSender:R}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){V="LINEAR",me(M.LINEAR,0,e)}}),this.addTransition({iInitialState:o,iFinalState:r,iEvent:T,iCondition:function(){return M.RECTANGULAR.chkConditions()},iAction:function(e){V="LINEAR",M.RECTANGULAR.actions(e)},iSender:R}),this.addTransition({iInitialState:o,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){V="LINEAR",ve(e)}}),this.addTransition({iInitialState:o,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return pe()},iAction:function(e){V="LINEAR",Ce(e)}}),this.addTransition({iInitialState:r,iFinalState:r,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){V="RECTANGULAR",me(M.RECTANGULAR,0,e)}}),this.addTransition({iInitialState:r,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){V="RECTANGULAR",ve(e)}}),this.addTransition({iInitialState:r,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return pe()},iAction:function(e){V="RECTANGULAR",Ce(e)}}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:T,iCondition:function(){return M.CIRCULAR.chkConditions()},iAction:function(e){V="CIRCULAR",M.CIRCULAR.actions(e)},iSender:R}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){V="CIRCULAR",me(M.CIRCULAR,0,e)}}),this.addTransition({iInitialState:s,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){V="CIRCULAR",ve(e)}}),this.addTransition({iInitialState:s,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return pe()},iAction:function(e){V="CIRCULAR",Ce(e)}}),this.addTransition({iInitialState:u,iFinalState:u,iEvent:T,iCondition:function(){return M.USERDEFINED.chkConditions()},iAction:function(e){V="USERDEFINED",M.USERDEFINED.actions(e)},iSender:R}),this.addTransition({iInitialState:u,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){V="USERDEFINED",ve(e)}}),this.addTransition({iInitialState:u,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return pe()},iAction:function(e){V="USERDEFINED",Ce(e)}}),this.addTransition({iInitialState:o,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.CIRCULAR.chkConditions()},iAction:function(e){V="LINEAR",M.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.USERDEFINED.chkConditions()},iAction:function(e){V="LINEAR",M.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.LINEAR.chkConditions()},iAction:function(e){V="CIRCULAR",M.LINEAR.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.USERDEFINED.chkConditions()},iAction:function(e){V="CIRCULAR",M.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.CIRCULAR.chkConditions()},iAction:function(e){ue(M.CIRCULAR.id),V="USERDEFINED",M.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.USERDEFINED.chkConditions()},iAction:function(e){V="RECTANGULAR",M.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:r,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.RECTANGULAR.chkConditions()},iAction:function(e){ue(M.RECTANGULAR.id),V="USERDEFINED",M.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.LINEAR.chkConditions()},iAction:function(e){ue(M.LINEAR.id),V="USERDEFINED",M.LINEAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){V="LINEAR",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){V="RECTANGULAR",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){V="CIRCULAR",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){V="USERDEFINED",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.LINEAR.chkConditions()},iAction:function(e){V="NOPATTERN",M.LINEAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.RECTANGULAR.chkConditions()},iAction:function(e){V="NOPATTERN",M.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.CIRCULAR.chkConditions()},iAction:function(e){V="NOPATTERN",M.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return M.USERDEFINED.chkConditions()},iAction:function(e){V="NOPATTERN",M.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){V="NOPATTERN",W&&(V=V+"_"+B),M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:o,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return M.LINEAR.chkConditions()},iAction:function(e){V="RECTANGULAR",M.LINEAR.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:u,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return M.USERDEFINED.chkConditions()},iAction:function(e){M.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){V="LINEAR",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return M.CIRCULAR.chkConditions()},iAction:function(e){V="CIRCULAR",M.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){V="CIRCULAR",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){V="USERDEFINED",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){V="RECTANGULAR",M.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){M.NOPATTERN.actions(e)}})},(w=JSON.parse(localStorage.getItem("CAT3DComposeAssemblyPatternCmd")))&&3===w.version&&(k=w.reuse,X=w.radioPattern,G="object"==typeof w.direction1?w.direction1:G,H="object"==typeof w.direction2?w.direction2:H,q="object"==typeof w.filters?w.filters:q),this._parent(e,{mode:"exclusive",isAsynchronous:!0,doServerCall:!1}),this.odtUtilsSetDefaultNbInstances=function(e){G.count=e,H.count=e}}})})),define("DS/CAT3DComposeCommands/CAT3DComposeExamineSelection",["UWA/Core","DS/CATWebUXComponents/DMUCommand","DS/CATWebUXComponents/DMUCommandsManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/CATW3DAnims/CATW3DAnimation3D","DS/PADUtils/PADContext","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/LevelSelector/LevelSelector","DS/CATW3DCommands/CATW3DCmdsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/CoreEvents/Events","css!DS/CAT3DComposeUI/CAT3DComposeUI.css"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,C,v,h,f){"use strict";var D=Math.PI/4;let A=!1;function S(e){var t,n,i,o=e&&e.externalPath.length>1;for(t=0;o&&t<e.externalPath.length-1;++t)n=e.externalPath[t],i=e.externalPath[t+1],n.children.indexOf(i)<0&&(o=!1);return o}var E=function(){var e,t,n,i,o,a;this.store=function(s,l){e=t=n=i=o=a=void 0;var c=l?(new r.Matrix4).extractRotation(l):null;e=s.getEyePosition(),l&&e.applyMatrix4(l),t=s.getUpDirection(),c&&t.applyMatrix4(c),n=s.getSightDirection(),c&&n.applyMatrix4(c),i=s.getTargetDistance(),o=s.getProjectionType(),a=s.getAngle()},this.restore=function(s,l){if(e){var c=l?(new r.Matrix4).extractRotation(l):null;s.moveTo({eyePosition:l?e.applyMatrix4(l):e,upDirection:c?t.applyMatrix4(c):t,sightDirection:c?n.applyMatrix4(c):n,distanceToTarget:i}),s.setProjectionType(o),s.setAngle(a)}}};E.prototype={constructor:E},Object.freeze(E);var x,y,b=t.extend({init:function(t){this._parent(t,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1);var b,T,M,P,w,R,I,N,U,L,_,W,O,F,V,k=this,B=l.get(),X=B.getViewer(),G=B.getController(),H=X.getSceneGraphOverrideSetManager(),q=m.giveMoveManager({context:B}),j=[],Y=[],z={},K=d.getMoveReferentManager({context:B}),J=h.getExamineController({context:B});function Z(){j.some((function(e){return"boolean"!=typeof H.getCurrentVisibility(e.path)}))&&(B.getExecutionContext&&k.cancelExecute(),k.cancel())}function Q(){b=null}function $(e){if(e&&e.from&&e.from.some((function(e){return e.view.id===X.canvas.id}))){var t=e.gesture?e.gesture.getEvents()[0]:e.from[0];if(t&&t.event&&0===t.event.button&&0===t.event.buttons){var n=X.pick(X.getMousePosition(t.getCurrentPosition(X.canvas)),"mesh",!1);n&&n.path&&0!==n.path.length||(Q(),B.getExecutionContext&&k.cancelExecute(),k.cancel())}}}require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],(function(e){V=e})),x||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){if(x=e,k.isRunning()){var t=v.giveDefaultSelectionFilter({context:B});t&&x.activate({context:B,withSnap:!0,selectionFilter:t})}})),y||require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],(function(e){y=e}));var ee,te=function(){var e=B.getFrameWindow().getViewpoint(),t=new r.Matrix4,n=e.getUpDirection(),i=e.getSightDirection();this.className.search("right")>=0?t.makeRotationAxis(n,D):this.className.search("left")>=0?t.makeRotationAxis(n,-D):this.className.search("top")>=0?t.makeRotationAxis(i.cross(n),-D):t.makeRotationAxis(i.cross(n),D),j.forEach((function(e){e.matrixRotation=t})),M.addAnimation({animationType:"rotate",objectListToAnimate:j.filter((function(e){return e.rotate})),callBackFct:function(){j.forEach((function(e){e.matrixSource=e.override.getPosition()}))}}),M.startAnimation()},ne=function(e,t,n,i){var o=[];if(e){var a=e.getKey();-1!==n.indexOf(a)||!0===i.getCurrentVisibilityFree(e)&&!i.getCurrentVisibility(e)||(t.some((function(t){return e.isAParentOf(t)}))?e.getChildrenPathes().forEach((function(e){o=o.concat(ne(e,t,n,i))})):o.push(e))}return o},ie=(ee=new r.Color,function(){return ee.set(X.backgroundColor),255*ee.getHSL().l>120?"black":"white"});function oe(){var e=60*Math.sqrt(2),t=48,n=B.getViewer(),i=n.SCREEN_WIDTH,o=n.SCREEN_HEIGHT,a=i/2,r=o/2;z.main.setStyles({top:r+"px",left:a+"px"}),document.querySelector(".c3dSelectionFilter")&&(t=document.querySelector(".c3dSelectionFilter").getSize().width),z.right.setStyle("left",a-e-t-10+"px"),z.left.setStyle("left",-1*a+e+10+"px"),z.top.setStyle("top",-1*r+e+10+"px");var s=B.getExecutionContext?document.querySelector(".WAfrPageObjectUseOnly-WAfr-Actionbar").offsetHeight+2:"true"===B.getFrameWindow().getActionBar().elements.container.getAttribute("data-open")?73:30;z.bottom.setStyle("top",r-e-s+"px");var l=setInterval((function(){z.main&&!document.querySelector(".c3dSelectionFilter")||(z.main&&(t=document.querySelector(".c3dSelectionFilter").getSize().width,z.right.setStyle("left",a-e-t-10+"px")),clearInterval(l))}),10)}function ae(e){var t;M.forward(),"ArrowLeft"===e.key||37===e.keyCode?t=z.left:"ArrowUp"===e.key||38===e.keyCode?t=z.top:"ArrowRight"===e.key||39===e.keyCode?t=z.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=z.bottom),t&&(t.addClassName("active"),te.call(t))}function re(e){var t;"ArrowLeft"===e.key||37===e.keyCode?t=z.left:"ArrowUp"===e.key||38===e.keyCode?t=z.top:"ArrowRight"===e.key||39===e.keyCode?t=z.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=z.bottom),t&&t.removeClassName("active")}function se(){j.length&&(W||(W=new u(j[0].path.externalPath)),S(W)?(F=new E).store(B.getFrameWindow().getViewpoint(),(new r.Matrix4).getInverse(W.getWorldMatrix())):W=F=null)}function le(e){J&&J.setActiveState(!1);var t=v.giveDefaultSelectionFilter({context:B});t&&(x&&!e&&x.deactivate({context:B}),e||t.deactivate()),B.setRobotVisibility(T),V&&window.widget&&"true"===window.widget.getValue("changeControlActivation")&&V.show(),a.removeEvent(X.canvas,"onPrimaryPointerClick",$),N&&(q.unsubscribe(N),N=void 0),!e&&I&&(q.unsubscribe(I),I=void 0),Y.forEach((function(e){B.unsubscribe(e)})),Y=[],p.destroyView(),z.main&&z.main.hide(),U&&B.getViewer().unsubscribe(U);var n=B.getFrameWindow().getActionBar();L&&n.removeCallback(L),_&&n.removeCallback(_),U=L=_=void 0,document.removeEventListener("keydown",ae),document.removeEventListener("keyup",re)}function ce(){se(),j=[],Q(),le(!0);var e=B.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(P),P=w=null,e.render(),O.restore(B.getFrameWindow().getViewpoint())}function ue(){J&&J.setActiveState(!0);var e=v.giveDefaultSelectionFilter({context:B});if(e&&x&&y&&!y.isNavigationActivated({context:B})&&x.activate({context:B,withSnap:!0,selectionFilter:e}),e&&e.activate({switchToAV1withMesh:!0}),B.getFrameWindow().getContextualUIManager().hideContextualMenus(),T=B.isRobotVisible(),B.setRobotVisibility(!1),V&&V.hide(),a.addEvent(X.canvas,"onPrimaryPointerClick",$),N=q.subscribe("Move",ce),I=q.subscribe("MoveEnd",(function(){B.getExecutionContext&&k.cancelExecute(),k.cancel()})),["onRootRemoved","onRootDetached","onAuthoringTransactionEnd","onEndDelete"].forEach((function(e){Y.push(B.subscribe({event:e},Z))})),function(e){if(e){var t,n=K.getMoveReferent(e)||e,a=n.getLastElement(!0);if(g.isPLMInstanceNode(a)){a&&a.children.length&&n.addElement(a.children[0]);var r={display:{type:"docked",marginW:10,marginH:10},background:X,disableKeyboard:!0,displayWhileViewpointIsManipulated:!0,uiFrame:B.getFrameWindow().getUIFrame(),getLevels:function(t){var i=g.getLevelSelectorLevels({pathElement:e,pathElementCurrent:n,onInfoCompleted:t,context:B});if(i){i.selectColor="#ff821e",i.selectOverColor="#ffb477";for(var o=i.levels.length-1;o>=0;--o){var a=i.levels[o];g.isPLMReferenceNode(a.pathElement.getLastElement(!0))&&K.getMoveReferent(a.pathElement)||(a.selection="notSelectable")}}return i},onHover:function(e){w&&(w.setColor(ie(),!1),w.setOpacity(.05,!1),w.setVisibility(!0),w.setVisibilityFree(null)),(t=P.createOverride({pathes:[n]})).setColor(16744448,!0),t.setOpacity(1,!0),X.render(),i.empty(),i.add(e)},onLeave:function(){w&&(w.setColor(null,null),w.setOpacity(null,null),w.setVisibility(!1),w.setVisibilityFree(!0)),P.deleteOverride(t),t=null,X.render(),i.empty(),i.add(o.get())},onSelect:function(i){if(i&&i.pathElement&&K){if(K.addMoveReferent(i.pathElement),P.deleteOverride(t),t=null,!(n=K.getMoveReferent(e)))return;(a=n.getLastElement(!0))&&a.children.length&&n.addElement(a.children[0]),(t=P.createOverride({pathes:[n]})).setColor(16744448,!0),t.setOpacity(1,!0),X.render()}}};p.createView(r)}}}(1===j.length?j[0].path:null),z.main.show(),oe(),U=X.onViewerResize(oe),!B.getExecutionContext){var t=B.getFrameWindow().getActionBar();L=t.onActionBarOpen(oe),_=t.onActionBarClose(oe)}document.addEventListener("keydown",ae),document.addEventListener("keyup",re)}this.beginExecute=function(){if((R=C.getRoots(B).map(C.getNodeID,C).some(G.isLargeDataStructure,G))&&G.pauseProgressiveLoading(),(O=new E).store(B.getFrameWindow().getViewpoint()),B.getExecutionContext||B.getFrameWindow().getActionBar().close(),M=s.getAnimation3DEngine({viewer:X}),j=[],P=new c(B.getRootBagPath().externalPath[0]),H.pushSceneGraphOverrideSet(P),B.getExecutionContext){f.subscribe({event:k.getId()+"/CANCEL"},(()=>{k.cancelExecute()}));let e=n.getCommandCheckHeader("CATRelatedData3DGridHdr");e&&e.getState()&&(e.setState(!1),e.disable(),A=!0)}var t=[],a=[],l=new r.Box3,d=X.getVisibleSpace();if(b=[],o.get().forEach((function(e){b.push(e);for(var n=new u(e.pathElement.externalPath);n&&!g.isPLMNode(n.getLastElement(!0));)n=n.getParentPath();if(n&&n.externalPath.length&&(!1===H.getCurrentVisibilityFree(n)||"boolean"==typeof H.getCurrentVisibility(n))){var i=n.getParentPath().getWorldMatrix(),o=(new r.Matrix4).getInverse(i),s=n.getMatrix(),c={path:n,override:P.createOverride({pathes:[n]}),matrixSource:s,matrixParent:i,matrixParentInv:o,rotate:!0},m=d?n.getBoundingBox(null,X,"visibleSpace"):n.getBoundingBox(null,X,"invisibleSpace");m&&!m.isNaN()?(m.applyMatrix4(n.getWorldMatrix()),l.union(m)):c.rotate=!1,j.push(c),t.push(n),a.push(n.getKey())}})),t.length>0){var m=l.center();j.forEach((function(e){e.centerRotation=(new r.Vector3).copy(m).applyMatrix4(e.matrixParentInv)}));var p=!1;W&&(W.isEqual(new u(t[0].externalPath))&&S(W)||(F=W=null)),F||(p=!0);var v=ne(B.getRootBagPath(),t,a,H);w=P.createOverride({pathes:v}),M.addAnimation({animationType:"mask",objectListToAnimate:[{override:w}],callBackFct:function(){p?B.getFrameWindow().getViewpoint().reframe(null,0,l.getBoundingSphere()):F&&(F.restore(B.getFrameWindow().getViewpoint(),W.getWorldMatrix()),F=null)}}),M.startAnimation();z.main=e.createElement("div",{id:"C3D-viewpoint"}).inject(B.getFrameWindow().getUIFrame()),["left","top","right","bottom"].forEach((function(t){var n=new e.createElement("div",{class:t}).inject(z.main);n.addEvents({click:te}),new e.createElement("div",{class:"background"}).inject(n);var i=new e.createElement("div",{class:"arrow"}).inject(n);new e.createElement("div",{class:"borderBottom"}).inject(i),new e.createElement("div",{class:"borderRight"}).inject(i),z[t]=n})),ue(),i.empty(),o.empty(),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(e){e._sendUsageProbe("command","ExamineSelection")}))}else B.getExecutionContext&&k.cancelExecute(),k.cancel()},this.cancelExecute=function(){if(se(),j=[],le(),z.main&&z.main.destroy(),z={},P){var e=B.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(P),P=w=null,e.render(),B.getExecutionContext||B.getFrameWindow().getActionBar().open(),O.restore(B.getFrameWindow().getViewpoint())}b&&b.length&&0===o.get().length&&(i.empty(),o.empty(),b.filter((function(e){return"boolean"==typeof H.getCurrentVisibility(e.pathElement)})).length&&(i.add(b),o.add(b)));Q(),R&&G.resumeProgressiveLoading(),R=!1,this.done()},this.pauseExecute=function(){le(!1),this.done()},this.resumeExecute=function(){ue(),i.empty(),o.empty();var e=new r.Box3,t=X.getVisibleSpace();j.forEach((function(n){var i=n.path,o=t?i.getBoundingBox(null,X,"visibleSpace"):i.getBoundingBox(null,X,"invisibleSpace");o&&!o.isNaN()?(o.applyMatrix4(i.getWorldMatrix()),e.union(o),n.rotate=!0):n.rotate=!1}));var n=e.center();j.forEach((function(e){e.centerRotation=(new r.Vector3).copy(n).applyMatrix4(e.matrixParentInv)})),this.done()},this.destroy=function(){let e=n.getCommandCheckHeader("CATRelatedData3DGridHdr");e&&A&&(e.enable(),e.setState(!0),A=!1)},this.disable(),this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){k&&(x&&x.unreference({context:B}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),k=B=G=X=H=null)}}});return b})),define("DS/CAT3DComposeWidget/CAT3DComposeWidgetMain",["UWA/Core","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","DS/CATWebUXComponents/DMUFrameWindow","DS/PADUtils/PADSettingsMgt","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/CATW3DRobot/CATW3DRobot"],(function(e,t,n,i,o,a,r,s){"use strict";var l,c;function u(e){this.isAppReady=!1,this.params=e,this.welcomePanel=this.pad3DViewer=null,this.tokensWelcomePanel=[]}return u.prototype={constructor:u,initialize:function(){return new Promise(function(e){require(["DS/PADServices/views/LandingPage","DS/PADServices/utils/GlobalModelEvents","i18n!DS/CAT3DComposeWidget/assets/nls/CAT3DComposeWidget"],function(t,n,i){l=n,this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomPanelPrefCmd"},function(){require(["DS/CATWebUXComponents/DMUCommandsManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,t){let n=t.givePreferenceManager({context:this.pad3DViewer.getFrameWindow()});if(n)var i=n.subscribe("onPreferencesPanelDestroyed",function(){n.unsubscribe(i),this.showWelcomePanel(!0)}.bind(this));this.showWelcomePanel(!1),e&&e.getCommand("CATWebUXPreferencesHdr",this.pad3DViewer&&this.pad3DViewer.getCommandContext?this.pad3DViewer.getCommandContext():null).begin()}.bind(this))}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/userAssistance"},(function(){let e=require("DS/WebUAUtils/WebUAUtils");window.open(e.getHelpFullPath(i.userAssistanceURL))}))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/whatsNew"},(function(){let e=require("DS/WebUAUtils/WebUAUtils");window.open(e.getEmbeddedHelpFullPath(i.whatsNewURL))})));var o=t.getDefaultActivities();o.activities.push({section:{id:"customizeAppSection",title:i.customApp,actions:[{id:"welcomPanelPrefCmd",title:i.prefs,icon:"cog"}]}}),o.activities.push({section:{id:"contentAndKnowledge",title:i.contentAndKnowledge,actions:[{id:"userAssistance",title:i.userAssistance,icon:"help"},{id:"whatsNew",title:i.whatsNew,icon:"megaphone"}]}}),this.welcomePanel=new t({widget:this.params.widget,readOnlyApp:!1,renderDiv:this.params.renderDiv,externalViewerMgt:!0,externalViewerMgtCB:function(e,t){!0!==t&&this.showWelcomePanel("viewer"!==e)}.bind(this),defaultActionId:o.defaultActionId,activities:o.activities,onLandingPageReady:this.params.onLandingPageReady}),this.welcomePanel.initialize().then(e)}.bind(this))}.bind(this))},setViewer:function(e){this.pad3DViewer=e,i.init(this.pad3DViewer),!this.params.initApp&&this.showWelcomePanel(!1);var t=e.render().getContent(),n=t.parentNode;t.style.position="relative",!this.params.renderDiv.parentNode&&n&&n!==this.params.renderDiv&&n.insertBefore(this.params.renderDiv,n.firstChild),this.params.renderDiv.insertBefore(t,this.params.renderDiv.firstChild),this.params.renderDiv.insertBefore(this.welcomePanel.elements.mainBody,this.params.renderDiv.firstChild),this.welcomePanel.setViewer(e,!this.params.initApp)},appReady:function(){if(this.isAppReady=!0,this.params.initApp){var e=this.params.widget.getValue("X3DContentId");let t=this;this.params.widget.deleteValue("X3DContentId"),e&&setTimeout((function(n){t.showWelcomePanel(!1),n.addRootNodesFromContent({json3DXContent:JSON.parse(e),dispatch:!1})}),0,this.pad3DViewer)}var t=this.welcomePanel.appReady();return this.welcomePanel.redraw(),t},dispose:function(){if(this.showWelcomePanel(!1),this.welcomePanel)return this.pad3DViewer=this.params=null,this.tokensWelcomePanel.forEach(l.unsubscribe,l),this.tokensWelcomePanel.length=0,this.welcomePanel.dispose()},showWelcomePanel:function(e){this.welcomePanel&&(this.welcomePanel.elements.mainBody.style.position="relative",this.welcomePanel.elements.mainBody.style.display=e?"":"none",e&&this.welcomePanel.redraw())}},Object.freeze({getApp:function(l){if(c||null===c)return c;var d,m,p,g,C,v,h,f,D,A,S,E,x,y=l.widget,b=l.pad3DViewer,T=l.appMainDiv,M=b?b.getCommandContext():null,P=t.getOption("testWkb")?{module:"CAT3DComposeWebUXTstUtils",file:"CAT3DComposeWidgetWkb_TST.xml",xmlPath:"text!DS/CAT3DComposeWebUXTstUtils/assets/afr/CAT3DComposeWidgetWkb_TST.xml"}:t.getOption("authoring3d")?{module:"CAT3DComposeWidget",file:"CAT3DComposeWidgetNextWkb.xml",xmlPath:"text!DS/CAT3DComposeWidget/assets/afr/CAT3DComposeWidgetNextWkb.xml"}:{module:"CAT3DComposeWidget",file:"CAT3DComposeWidgetWkb.xml",xmlPath:"text!DS/CAT3DComposeWidget/assets/afr/CAT3DComposeWidgetWkb.xml"};function w(e,t,n){window.top.performance.measure(y.id+e,n?y.id+t:t)}function R(e){window.top.performance.mark(y.id+e)}function I(){b&&b.getContentName({callbacks:{onComplete:function(e){y.setTitle(e.contentName)},onFailure:function(){}}})}function N(e,t){["_commands","_cmdCheckHeader"].forEach((function(n){var i=M?e[n][M]:e[n];i[t]&&(i[t]._destroy&&i[t]._destroy(),delete i[t])}))}function U(e,t,n){require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],(function(i){i.onNavigationStart({context:b,start:{onStart:function(n){var i={lastCommand:[],currentCommand:null,defaultCommand:null};M?e._commandsState[M]=i:e._commandsState=i,e.resetDefaultCommand(M),t.getDropManager({context:b}).disconnect();var o=E.giveMove3DRobot({context:b});o&&o.unreference(),m=n,N(e,"CAT3DComposeWidgetDefaultHdr");for(var a=P.xml?(new DOMParser).parseFromString(P.xml,"text/xml").getElementsByTagName("CATCommandHeader"):[],r=a.length-1;r>=0;--r){var s=a[r].attributes.getNamedItem("ClassName").value;if(!s.startsWith("DS/ViewerCommands")&&!s.startsWith("DS/ENOPAD3DViewer")&&!s.startsWith("DS/PADUtils")){var l=a[r].attributes.getNamedItem("ID").value;"CAT3DComposeExamineSelectionHdr"!==l&&N(e,l)}}n.done()}}}),i.onNavigationExit({context:b,exit:{actionBar:[{file:P.file,module:P.module,onActionBarReady:function(){e.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:M}),n.getMove3DRobot({context:b}),m=null,b.setDefaultContextualBarVisibility(!1),b.setDefaultContextualMenuVisibility(!0),b.setOpenWithMenuAvailability(!0),t.getDropManager({context:b}).connect(),setTimeout((function(){let e=b;var t={x:b.getViewer().div.clientWidth/2,y:b.getViewer().div.clientHeight/2};e.getFrameWindow().getExecutionContext,e.getFrameWindow().getContextualUIManager().hideContextualMenus(),e.getFrameWindow().getExecutionContext?e.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!1,x:t.x,y:t.y}):e.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!1,x:t.x,y:t.y})}),100)}}]}})}))}function L(e){h&&E&&S&&A&&!p&&(U(A,S,E),d&&d(T),d=null,v.appReady(),w("_C3D_Global widget creation time","C3D_jsAppLoad",!1),y.dispatchEvent("onWidgetAndAppReady","1"===y.getValue("widgetForODTReplay")?[{pad3DViewer:e}]:void 0))}b&&i.init(b),require([P.xmlPath],(function(e){P.xml=e}));var _,W,O,F=function(){require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","DS/PADUtils/PADCommandProxy"],(function(e,t){if((_=e).renderDiv)return;let n="top-right";sessionStorage.getItem("changeControlPosition")&&(n=sessionStorage.getItem("changeControlPosition")),_.initialize2(b.getFrameWindow().getViewerFrame(),t.appId(),y.getValue("changeControlActivation")?"show":"hide",n,(function(){_.addEvent("onAuthoringCtxVisible",(function(e){e.showAuthoringContext&&y.setValue("changeControlActivation",!0)}))}))}))},V=function(e){require(["DS/PADUtils/PADCommandProxy","DS/PADUtils/PADSharedSettings","i18n!DS/PADUtils/assets/nls/PADUtils"],(function(n,i,a){var r,s=[],l=[];O=function(){y.setPreferences([]),r.destroy(),s.forEach((function(e){e.cb&&o.removeEvent(e.cb,e.padFct)})),O=function(){}},W=function(){s.forEach((function(e){var t=e.preference.name,n=y.getValue(t),i=o.getSetting(t);(n="boolean"===e.preference.type&&"boolean"!=typeof n?"true"===n:n)!==i&&o.setSetting(t,n),e.fct&&e.fct(n)})),o.updateWidgetPreferences(),!r&&s.length&&(r=n.create({events:{onPreferenceModification:function(e){s.some((function(t){if(e.name===t.preference.name){if("boolean"!=typeof e.value&&"string"!=typeof e.value)throw new Error("Value must be a string or a boolean");if(o.getSetting(e.name)!==e.value){if("boolean"===t.preference.type&&"boolean"!=typeof e.value)throw new Error("Preference is a boolean type so value must be a boolean");t.debounce=!0,y.setValue(e.name,e.value),o.setSetting(e.name,e.value)}return t.fct&&t.fct(e.value),!0}}))}}}),s.forEach((function(e){e.cb&&o.addEvent(e.cb,e.padFct=function(t){e.debounce?e.debounce=!1:r.preferenceModification({name:e.preference.name,value:t})})})))},y.setPreferences([]),o.setSetting("syncAutoReload",!0),i.destroy(),i.addSharedSettings(y),i.addSharedSettings(y,["addRemoveMessagePreference","displayConfirmationOnRemove"]),s.push({preference:{name:"changeControlActivation",type:"boolean",label:a.changeControlActivation_label,defaultValue:!0},fct:function(e){_&&_[e?"show":"hide"]()},cb:"onChangeControlActivation",debounce:!1}),s.push({preference:{name:"changeControlPosition",type:"list",label:a.changeControlPosition_label,defaultValue:"top-right",options:[{label:a["top-right_label"],value:"top-right"},{label:a["top-left_label"],value:"top-left"},{label:a["bottom-left_label"],value:"bottom-left"},{label:a["bottom-right_label"],value:"bottom-right"}]},fct:function(e){_&&_.setPosition(e),sessionStorage.setItem("changeControlPosition",e)}}),o.setSetting("authorizeChangeControl",!0),e&&F(),t.getOption("debug")?s.push({preference:{name:"webapi_timeout",type:"text",label:"Query timeout",defaultValue:"60000"}}):l=["webapi_timeout"],l.forEach((function(e){y.deleteValue(e)})),l.length=0,s.forEach((function(e){y.mergePreferences([e.preference])})),W(),require(["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer"],(e=>{y.addEvent("onChangeFlexibleAssembliesSupport",(function(e,t){o.setSetting(e,t)}));var t=o.getSetting("enopad3dviewer_roles");let n=!0,i=require("DS/PADUtils/PADUtilsServices").isCloud(),a=require("DS/PADUtils/PADSession").isAuthoring();for(var r=0;r<t.length;r++)if("E19"===t[r].id&&(!t[r].platforms||t[r].platforms&&t[r].platforms.indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)){n=!1;break}!n||i||a?(y.addPreference({name:"enopad3dviewer_flexibleAssemblySupportActivated",type:"hidden",defaultValue:!1,label:e.flexibleAssemblySupport,onchange:"onChangeFlexibleAssembliesSupport",value:!1}),o.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",!1)):y.getPreference("enopad3dviewer_flexibleAssemblySupportActivated")||(y.addPreference({name:"enopad3dviewer_flexibleAssemblySupportActivated",type:"boolean",defaultValue:!1,label:e.flexibleAssemblySupport,onchange:"onChangeFlexibleAssembliesSupport",value:void 0!==y.getValue("enopad3dviewer_flexibleAssemblySupportActivated")&&y.getValue("enopad3dviewer_flexibleAssemblySupportActivated")}),o.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",y.getValue("enopad3dviewer_flexibleAssemblySupportActivated"))),o.setSetting("enopad3dviewer_staticMappingSupportActivated",!a)})),y.addEvent("endEdit",W)}))};function k(e){e.unsubscribe(g),g=null,I(),F(),require("DS/PADUtils/PADUtilsServices").isCloud()&&!window.__preventPrefPanel&&e.getViewer().displayIntroductoryControlPreferencePanel(),R("_C3D_beforeRobotAndDirectMoveLoad"),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(t){w("_C3D_Applicative Init JS Loading","_C3D_beforeRobotAndDirectMoveLoad",!0),R("_C3D_afterRobotAndDirectMoveLoad"),(E=s).getMove3DRobot({context:e}),e.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange(),w("_C3D_Applicative Init","_C3D_afterRobotAndDirectMoveLoad",!0),(S=t).getDropManager({context:e}).connect(),L(e)}))}function B(e){e.unsubscribe(C),C=null,R("_C3D_ownCommands"),w("_C3D_Action Bar merge app commands","_C3D_ownCommands",!0),R("_C3D_beforeDefaultCmdLoad"),M=b.getCommandContext(),(A=require("DS/CATWebUXComponents/DMUCommandsManager")).setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:M}),f=h.getMoveManager({context:b,saveToDatabase:!0}),require(["DS/CATW3DCommands/CATW3DCmdsUtils"],(function(e){D=f.subscribe("Move",(function(t){t.objectsMoved.length>0&&"Persistent"===t.moveMode&&t.objectsMoved.forEach((function(t){let n=A.getCommand("CAT3DComposeMoveHdr",M);var i=t.path.getLastElement(!0);e.isPLMInstanceNode(i)&&(n._isRunning||n.begin())}))}))})),w("_C3D_Default Cmd Init","_C3D_beforeDefaultCmdLoad",!0),L(e)}function X(e){w("_C3D_PAD3DViewer creation","_C3D_PAD3DViewerReady",!0),e.unsubscribe(p),p=null,L(e)}function G(t){return T||(T=e.createElement("div",{class:"appMain",styles:{width:"auto",height:"100%"}})),(v=new u({widget:y,readOnlyApp:!1,renderDiv:T,initApp:t&&t.initApp,onLandingPageReady:t&&t.onLandingPageReady})).initialize()}function H(){if(o&&(o.setSetting("activateWidgetLink",!0),o.setSetting("useNewUXGuidelinesWP",!0)),!b){w("_C3D_UWA widget loading","_C3D_widgetLoad",!0),R("_C3D_LoadJSPAD3DViewer");var t=new Promise((function(e){require(["DS/PADUtils/PADSharedSettings"],(t=>{t.addSharedSettings(y,["showWelcomePanel"]),G({initApp:!0,onLandingPageReady:function(){d(T),d=null}}).then(e)}))})),c=new Promise((function(e){require(["DS/ENOPAD3DViewer/PAD3DViewer","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","text!DS/CAT3DComposeWidget/assets/json/CATC3DWindowOptions.json"],(function(t,n,i,o){w("_C3D_PAD3DViewer load JS","_C3D_LoadJSPAD3DViewer",!0),R("_C3D_PAD3DViewerReady"),h=n,x=i,y.setValue("tenantAware",!0),e([t,o])}))})),u=new Promise((e=>{if(y.data.x3dShareId)e();else{require(["DS/ENOXInterWdgCom/LinkManager"],(t=>{t.initializeWidgetLink(y,{appIds:[],uses:["ENXContent","ENXContentSync3D","ENXContentSync2D","ENXAuthoring2D","ENXAuthoring3D","ENXLandingPageSync"],implements:["ENXContent","ENXContentSync3D","ENXAuthoring3D","ENXLandingPageSync"],open:!0}).then(e)}))}}));Promise.all([t,c,u]).then((function(t){var c=e.extend({context:"Default",workbench:P.file,workbenchModule:P.module},JSON.parse(t[1][1])),u={widget:y,windowOptions:c,enableFiltering:!0,binaryPrimitives:!0,enableSidePanel:!0,visuProgressiveTileModel:!0,readyCB:V};c.mouseProfile=require("DS/PADUtils/PADUtilsServices").isCloud()?window.__mouseProfile:"CATIA",b=new t[1][0](u),i.init(b),c.mouseProfile&&b.getViewpoint().setDefaultController(!0,c.mouseProfile),f=h.getMoveManager({context:b,saveToDatabase:!0}),x.getPreferenceManager({context:b.getFrameWindow()}).removeAllPreferences(),v.setViewer(b),b.setOption("propertiesFacet",o.getSetting("propertiesFacet")),b.setAuthorizedRootTypes(o.getSetting("ups_authorized_root_types")),b.setDefaultContextualBarVisibility(!1),b.setDefaultContextualMenuVisibility(!0),b.setOpenWithMenuAvailability(!0),g=b.subscribe({event:"onViewerReady"},k),C=b.subscribe({event:"onActionBarReady"},B),p=b.subscribe({event:"onReady"},X),b.subscribe({event:"onRootAdded"},I),b.subscribe({event:"onEndProgressiveLoad"},(function(){let e=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),t=b.getController&&b.getController().hasAnyEffectiveFlexibleAssembly(),n=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration"),i=require("DS/CATWebUXComponents/DMUCommandsManager").getCommand("CAT3DComposeMoveHdr",b.getCommandContext());i&&(n&&e&&t?i.disable():i.enable()),n&&e&&t&&require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){e.give().setAllowManipulation(!1)}))})),b.subscribe({event:"onBeginRootLoading"},(function(){var e=window.document.getElementsByClassName("DMULoadingPanelInfoDiv"),t=window.document.getElementsByClassName("DMULoadingPanel");e.length&&(e[0].dsModel.off(),e[0].dsModel.destroy(),e=null),t.length&&t[0].destroy()})),b.subscribe({event:"onRootRemoved"},I),b.subscribe({event:"onRootAttached"},I),b.subscribe({event:"onRootDetached"},I),b.subscribe({event:"onContentNameModified"},(function(e){y.setTitle(e)})),b.setLoadingDelegations(n.getDelegation(b)),n.declareDelegationForDataKey("objectOverloads",(function(e){var t=null;if((e=e.filter((e=>"Transformation"===e.data.type))).length>0&&(function(){if(!b)return;var e=A.getCommands(b.getCommandContext());let t=["CAT3DComposeRobotSnapMoveHdr","CAT3DComposeMoveHdr","CAT3DComposeWidgetDefaultHdr"];var n,i;for(n in e)if(e.hasOwnProperty(n)){if(i=e[n],t.indexOf(i._id)>=0)continue;i._isRunning&&(i.cancel&&i.cancel(),i.end&&i.end())}var o=A.getCommandCheckHeaders(b.getCommandContext());for(n in o)if(o.hasOwnProperty(n)){if(i=o[n],t.indexOf(i._id)>=0)continue;i.getState()&&i.setState(!1)}}(),e.forEach((function(e){let n=b.getController().buildPathFromArray(e.targetPath);if(n){let o=e.data.value;f.onMoveBegin({objectsMoved:[{path:n}],from:{},moveMode:"Persistent"});let s=new a.Matrix4(o[0],o[4],o[8],o[12],o[1],o[5],o[9],o[13],o[2],o[6],o[10],o[14],o[3],o[7],o[11],o[15]);f.onMove({objectsMoved:[{path:n}],from:{},worldMatrix:s}),f.onMoveEnd({from:{},status:"Moved"}),b.getViewer().render();var i=r.get();1===i.length&&f.getSubPathToMovable(i[0].pathElement).externalPath.equals(n.externalPath)&&(t=(new a.Vector3).getPositionFromMatrix(s))}})),t)){var n=s.getMove3DRobot({context:b});setTimeout((function(){n.setValueToPanel(t)}),100)}})),o.setSetting("settypes",!0),"1"===y.getValue("widgetForODTReplay")&&y.dispatchEvent("onPAD3DViewerCreated",[{pad3DViewer:b}]),l.done&&l.done({appMainDiv:T,pad3DViewer:b})}))}}function q(){!function(){var e=o.getSetting("enopad3dviewer_roles");let t=!0,n=require("DS/PADUtils/PADUtilsServices").isCloud(),i=require("DS/PADUtils/PADSession").isAuthoring();for(var a=0;a<e.length;a++)if("E19"===e[a].id&&(!e[a].platforms||e[a].platforms&&e[a].platforms.indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)){t=!1;break}o.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",t&&!n&&!i),o.setSetting("enopad3dviewer_staticMappingSupportActivated",!i)}(),b&&b.refresh()}function j(){if(v&&v.dispose(),v=null,S&&S.unreferenceDropManager({context:b}),D&&f&&f.unsubscribe(D),D=null,h&&h.unreferenceMoveManager({context:b}),E){var e=E.giveMove3DRobot({context:b});e&&e.unreference()}c=y=b=M=d=T=m=h=A=S=E=P=null}function Y(e){b&&b.search({searchQuery:e})}return b?y.addEvent("onDestroy",j):(w("_C3D_JS dependencies loading","C3D_jsAppLoad",!1),R("_C3D_widgetLoad"),l.viewerAttachment?(d=l.viewerAttachment,H()):(d=function(e){y.setBody(e)},y.addEvent("onLoad",H)),y.addEvent("onRefresh",q),y.addEvent("onDestroy",(function(){var e=b;j(),e&&e.destroy()})),y.addEvent("onSearch",Y),y.setMetas({helpPath:"CAT3DComposeWidget/assets/help"})),c=Object.freeze({setUp:function(e){Promise.all([A?Promise.resolve():new Promise((function(e){require(["DS/CATWebUXComponents/DMUCommandsManager"],(function(t){A=t,e()}))})),h?Promise.resolve():new Promise((function(e){require(["DS/CATW3DMoveManager/CATW3DMoveManager"],(function(t){h=t,e()}))})),x?Promise.resolve():new Promise((function(e){require(["DS/CATWebUXPreferences/CATWebUXPreferencesManager"],(function(t){x=t,e()}))}))]).then((function(){y.addEvent("onRefresh",q),y.addEvent("onSearch",Y),y.setMetas({helpPath:"CAT3DComposeWidget/assets/help"});var t={lastCommand:[],currentCommand:null,defaultCommand:null};if(M?A._commandsState[M]=t:A._commandsState=t,A.resetDefaultCommand(M),A._isCommandEnding=!1,A._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach((function(e){var t=M?A[e][M]:A[e];Object.keys(t).forEach((function(e){var n=t[e];n&&n._destroy&&n._destroy(),delete t[e]}))})),e.sourceApp&&e.sourceApp.pad3DViewer!==b){if(S&&S.unreferenceDropManager({context:b}),S=null,h&&h.unreferenceMoveManager({context:b}),h=null,E){var n=E.giveMove3DRobot({context:b});n&&n.unreference()}E=null,b=e.sourceApp.pad3DViewer,i.init(b)}b.setOption("propertiesFacet",require("DS/PADUtils/PADSettingsMgt").getSetting("propertiesFacet")),b.getBIController().toggleBetweenStandaloneAndSlaveMode("DUAL"),V(b),b.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange(),b.setDefaultContextualBarVisibility(!1),b.setDefaultContextualMenuVisibility(!0),b.setOpenWithMenuAvailability(!0),b.getViewer().updateViewPanelUIConfiguration&&b.getViewer().updateViewPanelUIConfiguration({useShadingIllustration:!1,useOutline:!1}),I(),f&&D&&f.unsubscribe(D),h.unreferenceMoveManager({context:b}),f=h.getMoveManager({context:b,saveToDatabase:!0}),require(["DS/CATW3DCommands/CATW3DCmdsUtils"],(function(e){D=f.subscribe("Move",(function(t){t.objectsMoved.length>0&&"Persistent"===t.moveMode&&t.objectsMoved.forEach((function(t){let n=A.getCommand("CAT3DComposeMoveHdr",M);var i=t.path.getLastElement(!0);e.isPLMInstanceNode(i)&&(n._isRunning||n.begin())}))}))})),x.getPreferenceManager({context:b.getFrameWindow()}).removeAllPreferences();var o=b.subscribe({event:"onActionBarReady"},(function(){b.unsubscribe(o),A.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:M}),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(t){(E=s).getMove3DRobot({context:b}),(S=t).getDropManager({context:b}).connect(),U(A,S,E),e.done({appMainDiv:T,pad3DViewer:b})}))}));b.loadActionBar({merge:!1,file:P.file,module:P.module}),require("DS/ENOXInterWdgCom/LinkManager").updateLinkability({appIds:[],open:!0,uses:["ENXContent","ENXContentSync3D","ENXContentSync2D","ENXAuthoring2D","ENXAuthoring3D","ENXLandingPageSync"],implements:["ENXContent","ENXContentSync3D","ENXAuthoring3D","ENXLandingPageSync"]}),require("DS/PADUtils/PADSettingsMgt").setSetting("activateWidgetLink",!0),require("DS/PADUtils/PADSettingsMgt").setSetting("useNewUXGuidelinesWP",!0),G().then((function(){v.setViewer(b),v.appReady()}))}))},dispose:function(){if(y.removeEvent("onRefresh",q),y.removeEvent("onSearch",Y),y.removeEvent("endEdit",W),O(),v&&v.dispose(),v=null,m&&m.controller&&(m.activated=!1,m.controller.end(),m=null),E){var e=E.giveMove3DRobot({context:b});e&&e.unreference()}h&&h.unreferenceMoveManager({context:b}),b&&(b.setDefaultContextualBarVisibility(!0),b.setDefaultContextualMenuVisibility(!0),b.setOpenWithMenuAvailability(!1)),S&&S.getDropManager({context:b}).disconnect();var t=x.givePreferenceManager({context:b.getFrameWindow()});t&&t.removeAllPreferences(),x.unreferencePreferenceManager({context:b.getFrameWindow()}),n.removeDelegationForDataKey("objectOverloads")},onWillLeave:function(){}})}})})),define("DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext","DS/CATC3DNavigation/CATC3DNavigationContoller","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var a=n.get(),r=i.getNavigationContoller({context:a}),s=o.getExamineController({context:a});this.beginExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!0),s&&s.setActiveState(!0),r&&r.resume(),this.done()},this.endExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!1),s&&s.setActiveState(!1),r&&r.pause()},this.pauseExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!1),s&&s.setActiveState(!1),r&&r.pause(),this.done()},this.resumeExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!0),s&&s.setActiveState(!0),r&&r.resume(),this.done()}}})})),define("DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent",["UWA/Class","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/DMUCommandsManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/PADUtils/PADContext"],(function(e,t,n,i,o,a,r,s,l,c,u){"use strict";var d=0,m=[],p=!1,g=null,C=!1;return e.extend({init:function(e){this._parent(e);var v,h,f,D,A,S=e.context,E=S.getCommandContext?S.getCommandContext():null,x=[],y=u.get(),b=[],T=new n.Matrix4;function M(e){return!e||e.empty()||e.isNaN()||e.min.distanceTo(e.max)<=0}function P(e){var t=y.getController().buildPathFromArray(e.data.paths[0],!0),n=e.data.paths[0];if(t){var i=t.getLastElement(!0);if(!function(e){if(!e)return!1;if(l.isReference(e))return!0;var t=l.getNodeType(e);return"CATDrawing"===t||"Drawing"===t||"CATAnalysis"===t||"PPRContext"===t}(i)||l.is3DLeaf(i))return;var o=y.getController().createReferenceIterator(l.getNodeID(i)),a=i.getChildren().map(l.getNodeID,l),r=o.getChildren().map((function(e){return-1===a.indexOf(e.getInstanceId())?e.getReferenceIterator().getReferenceId():null})).filter((function(e){return e&&-1===m.indexOf(e)&&n.indexOf(e)>=0}));if(!r.length)return;m=m.concat(r),y.getController().lockNodes({ids:r}),P(e)}}this.activate=function(){if(require("DS/PlatformAPI/PlatformAPI").subscribe("DS/PADUtils/PADCommandProxy/select",(e=>{if(e&&e.data&&1===e.data.paths.length){p=!1;var t=y.getController().buildPathFromArray(e.data.paths[0],!0);e.data.paths[0];if(t){if(P(e),!l.is3DLeaf(t.getLastElement(!0))){var n=(t=y.getController().buildPathFromArray(e.data.paths[0],!0)).getBoundingBox(null,y.getViewer(),"visibleSpace"),o=t.getBoundingBox(null,y.getViewer(),"invisibleSpace");M(n)&&M(o)&&setTimeout((function(){if(g=y.getController().buildPathFromArray(e.data.paths[0],!0),n=g.getBoundingBox(null,y.getViewer(),"visibleSpace"),o=g.getBoundingBox(null,y.getViewer(),"invisibleSpace"),M(n)&&M(o)){p=!0;var t=i.getCommand("CAT3DComposeRobotSnapMoveHdr",u.get()._context);t&&t._isRunning&&t.end();var a=i.getCommand("LevelSelectorHdr",u.get()._context);a&&a._isRunning&&(a.cancel(),a.end());var r={x:y.getViewer().div.clientWidth/2,y:y.getViewer().div.clientHeight/2};S.getFrameWindow().getExecutionContext,S.getFrameWindow().getContextualUIManager().hideContextualMenus(),S.getFrameWindow().getExecutionContext?S.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!1,x:r.x,y:r.y}):S.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!1,x:r.x,y:r.y})}else p=!1}),100)}}}else m.length&&y.getController().unlockNodes({ids:m}),m=[],p=!1,g=null})),0===x.length&&(v=S.getViewer(),h=r.getMoveReferentManager({context:S}),x=["CAT3DComposeCtxMenuAgent_"+d++,"CAT3DComposeCtxMenuAgent_"+d++],S.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,r){var s=t.get();p&&g&&0===s.length&&s.push({pathElement:g});var u=l.getRoots(S),d=[],m=!1,f=!1,D=a.giveConstraintsController({context:S});s.some((function(e){var t,n=h.getMoveReferent(e.pathElement);if(n&&(t=n.getLastElement(!0))&&l.isInstance(t)&&t.children.length>0){n.addElement(t.children[0]),D&&D.isThereACstSuppportingReverseDirection(n)&&(m=!0);var a=D?D.getAxisTypeIfCstOnProductAxis(n):null;if(a)if(f=!0,S.getExecutionContext){let e=S.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);e&&(a===o.GeometryType.AXISX?e.setRadioItemState({id:"SwitchToX",radioId:"CATC3DSwitchAxisHdr",state:!0}):a===o.GeometryType.AXISY?e.setRadioItemState({id:"SwitchToY",radioId:"CATC3DSwitchAxisHdr",state:!0}):e.setRadioItemState({id:"SwitchToZ",radioId:"CATC3DSwitchAxisHdr",state:!0}))}else a===o.GeometryType.AXISX?i.getCommandCheckHeader("CATC3DSwitchAxisXHdr",E).setState(!0):a===o.GeometryType.AXISY?i.getCommandCheckHeader("CATC3DSwitchAxisYHdr",E).setState(!0):i.getCommandCheckHeader("CATC3DSwitchAxisZHdr",E).setState(!0);return m&&f}return!1})),f&&d.push({name:"CATC3DSwitchAxisIcb",line:1,hdr_list:["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"],type:"handler",identifier:"CATC3DSwitchAxisHdr"}),m&&d.push({name:"CATC3DReverseDirectionStr",line:1,hdr_list:["CATC3DReverseDirectionHdr"],type:"handler",identifier:"CATC3DReverseDirectionHdr"});var A=s.some((function(e){var t=e.pathElement.getLastElement(!0);return u.some((function(n){var i=n!==t,o=e.pathElement.externalPath.some((function(e){return n===e}));return i&&o}))}));A&&r&&r.withContextMenu&&"number"==typeof r.XmousePosition&&"number"==typeof r.YmousePosition&&(0===v.pick(v.getMousePosition(new n.Vector2(r.XmousePosition,r.YmousePosition)),"mesh",!1).path.length&&(A=!1));if(C)d.push({name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"],type:"handler",identifier:"PasteAtOriginalPosition"}),d.push({name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"],type:"handler",identifier:"PasteAtLocalCoordinates"}),C=!1,b=[];else if(A){if(!p&&c.getExamineController({context:S}).canBeEnabled()&&d.push({name:"CAT3DComposeExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"],type:"handler",identifier:"CAT3DComposeExamineSelectionHdr"}),1===s.length){let e=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),t=y.getController&&y.getController().hasAnyEffectiveFlexibleAssembly();require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration")&&e&&t||d.push({name:"RobotSnapMove",line:1,hdr_list:["CAT3DComposeRobotSnapMoveHdr"],type:"handler",identifier:"CAT3DComposeRobotSnapMoveHdr"}),d.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"],type:"handler",identifier:"LevelSelectorHdr"})}p=!1,g=null}return y.getExecutionContext?d.length?{WAfrCtxBarRow1:{model:d}}:void 0:d.length?{cmdList:d}:void 0},context:E,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:"",merge:!0,subscriberId:x[0]}),S.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,i){var o=[],a=t.get();if(1===a.length){var r=a[0].pathElement.getLastElement(!0);l.getRoots(S).some((function(e){return e===r}))&&o.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"],type:"handler",identifier:"ENO3DRemoveRootCmd"})}if(i&&i.withContextMenu&&"number"==typeof i.XmousePosition&&"number"==typeof i.YmousePosition&&0===v.pick(v.getMousePosition(new n.Vector2(i.XmousePosition,i.YmousePosition)),"mesh",!1).path.length)return;return y.getExecutionContext?o.length?{WAfrCtxBarRow1:{model:o}}:void 0:o.length?{cmdList:o}:void 0},context:E,workbenchName:"ENOPAD3DViewerContextualBar",module:"ENOPAD3DViewer",cmdPrefix:"",merge:!0,subscriberId:x[1]}),S.getExecutionContext)){D=S.getFrameWindow().getContextualUIManager(),A=s.giveMoveManager({context:S});let e=function(){t.get().forEach((function(e){var t=A.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(T)||b.push({pathElement:e.pathElement,path:t,matrix:n})}})),b.length>0&&setTimeout((function(){C=!0,D._showContextualBar({x:v?v.SCREEN_WIDTH/2:S.getViewer().SCREEN_WIDTH/2,y:v?v.SCREEN_HEIGHT/2:S.getViewer().SCREEN_HEIGHT/2,hideWithDistance:!1});let e=S.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);e&&e.setCheckState({id:"PasteAtOriginalPosition",state:!0})}),10)};f=S.subscribe({event:"onAuthoringTransactionEnd"},e),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(t){var n=t.getDropManager({context:S});x.push(n.subscribe({event:"onBeginInsertDrop3D"},(function(){S.unsubscribe(f),f=null}))),x.push(n.subscribe({event:"onEndInsertDrop3D"},(function(t){t&&"inPosition"===t.type&&e(),f=S.subscribe({event:"onAuthoringTransactionEnd"},(function(){e()}))})))}))}},this.deactivate=function(){v=h=null,x.forEach((function(e){S.getFrameWindow().getContextualUIManager().unregister(e)})),S.unsubscribe(f),x=[],f=null}}})})),define("DS/CAT3DComposeCommands/CAT3DComposeMoveCmd",["DS/CATWebUXComponents/DMUCommand","DS/Visualization/SceneGraphUtils","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATW3DBoxes/CATW3DBoxController","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DCommands/CATW3DCmdsUtils","DS/CATW3DCommands/CATW3DMoveBarUX","DS/CoreEvents/Events"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m){"use strict";var p,g,C,v,h;require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],(function(e){p=e.PositionModifiedSaveOK,g=e.PositionModifiedSaveKO,C=e.singleSplitInstance,v=e.multipleSplitInstance})),require(["DS/Selection/CSOManager"],(function(e){h=e}));var f,D=e.extend({init:function(D){this._parent(D,{mode:"exclusive",isAsynchronous:!0});var A,S,E,x,y,b,T,M,P,w=this,R=!0,I=!1,N=l.get(),U=N.getCommandContext(),L=c.getMoveManager({context:N}),_=r.getExamineController({context:N}),W=i.getDefaultSelectionFilter({context:N}),O=function(){I=!0,R=!1,L.terminateMove({save:!1}),N.getExecutionContext?w.cancelExecute():w.cancel()},F=function(){I=!0,R=!1,L.terminateMove({save:!0}),N.getExecutionContext?w.cancelExecute():w.cancel()},V=function(){L.cancelLocked()},k=function(e){var n="success"===e.eventID&&e.objectsMoved.length>0?p:"error"===e.eventID&&e.objectsCancelled.length>0?g:null;n&&N.displayNotification({eventID:e.eventID,msg:n});var i=o.getAnimation3DEngine({viewer:N.getViewer()});if(e&&e.splitInstances&&e.splitInstances.length){N.displayNotification({eventID:"info",msg:e.splitInstances.length>1?v:C});var a=[],r=N.getController(),s=N.getRootBagPath().getLastElement(!0);if(e.splitInstances.forEach((function(e){a=a.concat(t.buildPathesLeadingToNode(r.getNode({id:e.newId}),s).map((function(e){return{path:e}})))})),i.addAnimation({animationType:"opacityOnOff",objectListToAnimate:a,duration:1e3,createOverrideSet:!0}),i.addAnimation({animationType:"color",objectListToAnimate:a,duration:1e3,createOverrideSet:!0,color:"#ff821e"}),h){var l=h.get();l.length&&h.empty(),a.length&&h.add(a.map((function(e){return{pathElement:e.path}}))),l.length&&h.empty(),h.add(l)}}e.objectsCancelled&&e.objectsCancelled.length>0&&i.addAnimation({animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout((function(){E.begin()}),0)},createOverrideSet:!0}),i.startAnimation(),I&&(L.unsubscribe(T),L.unsubscribe(M))},B=function(e){if(A&&!0===e.bEmptyMove?(A.hideSave(),A.hideLock()):A&&!e.someMovedObjectsAreLocked&&A.hideLock(),e.objectsCancelled&&e.objectsCancelled.length>0){var t=o.getAnimation3DEngine({viewer:N.getViewer()}),n={animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout((function(){}),0)},createOverrideSet:!0};t.addAnimation(n),t.startAnimation()}else N.getViewer().render();I&&(L.unsubscribe(T),L.unsubscribe(M))},X=function(e){"Enter"!==e.key&&13!==e.keyCode||!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey&&(F(),document.removeEventListener("keydown",X))};y=L.subscribe("Move",(function(e){A||(A=new d({uiFrame:N.getFrameWindow().getUIFrame(),onSave:F,onCancel:O,onCancelLocked:V})),e.objectsMoved.length>0&&"Persistent"===e.moveMode&&e.objectsMoved.forEach((function(e){var t=e.path.getLastElement(!0);u.isPLMInstanceNode(t)&&(A.showSpinner(),L.isPathLocked({pathElement:e.path,onCompleted:function(e){A&&(A.hideSpinner(),e.isLocked?A.showLock():A.showSave())}}))}))})),f||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){f=e,w.isRunning()&&f.activate({context:N,withSnap:!0,selectionFilter:W})})),this.beginExecute=function(){x=L.subscribe("MoveBegin",(function(){_&&_.setActiveState(!1);var e=n.give3DGridController({context:N});e&&e.hide3DGrids()})),b=L.subscribe("MoveEnd",(function(){if(w.isRunning()){var e=a.getBoxController({context:N});e&&e.setActiveState(!0),_&&_.setActiveState(!0);var t=n.give3DGridController({context:N});t&&t.display3DGrids()}})),S||(S=new s({context:N})),E||(E=new e({ID:"CAT3DComposeFakeMoveHdr",mode:"shared",isAsynchronous:!1,context:U})),R=!0,I=!1,document.querySelector(".c3dMoveCmdDlg")||(A=new d({uiFrame:N.getFrameWindow().getUIFrame(),onSave:F,onCancel:O,onCancelLocked:V})),A&&A.show(),N.getExecutionContext&&m.publish({event:"onNotifAgentDisplayed",data:{notifAgent:A}}),S.activate();var t=a.getBoxController({context:N});t&&t.setActiveState(!L.isMoving());var i=n.give3DGridController({context:N});i&&i[L.isMoving()?"hide3DGrids":"display3DGrids"](),_&&_.setActiveState(!0),f&&f.activate({context:N,withSnap:!0,selectionFilter:W}),W.activate({switchToAV1withMesh:!0}),document.addEventListener("keydown",X),T=L.subscribe("onValidateMove",k),M=L.subscribe("onCancelMove",B),P=m.subscribe({event:w.getId()+"/CANCEL"},(()=>{w.cancelExecute()}))},this.cancelExecute=function(){document.removeEventListener("keydown",X),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(e){e._sendUsageProbe("command",R?"MoveCancel":"MoveOK")})),R&&(I=!0,L.terminateMove({save:!1})),A&&A.destroy(),A=null,S.deactivate(),W&&W.deactivate();var e=a.getBoxController({context:N});e&&e.setActiveState(!1),_&&_.setActiveState(!1),N.getFrameWindow().getContextualUIManager().hideContextualMenus(),f&&f.deactivate({context:N}),N.getExecutionContext&&m.publish({event:"onCommandStart/BEGIN",data:{_id:N.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getDefaultCommand()}}),this.done()},this.pauseExecute=function(){var e=a.getBoxController({context:N});e&&e.setActiveState(!1),A&&A.hide(),S.deactivate(),W.deactivate(),_&&_.setActiveState(!1),f&&f.deactivate({context:N}),document.removeEventListener("keydown",X),this.done()},this.resumeExecute=function(){var e=a.getBoxController({context:N});e&&e.setActiveState(!0),A&&A.show(),S.activate(),W.activate({switchToAV1withMesh:!0}),_&&_.setActiveState(!0),f&&f.activate({context:N,withSnap:!0,selectionFilter:W}),document.addEventListener("keydown",X),this.done()},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){Object.getPrototypeOf(this)._destroy.apply(this,arguments),L.unsubscribe(x),L.unsubscribe(y),L.unsubscribe(b),L.unsubscribe(T),L.unsubscribe(M),m.unsubscribe(P),f&&f.unreference({context:N}),N=L=S=A=T=M=x=y=b=w=null}}});return D})),define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmdV2",["DS/CATW3DBoxes/CATW3DBoxController","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUFrameWindow","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DRobot/CATW3DRobot","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m,p){"use strict";let g;return class{constructor(C){var v=this,h=!1,f=C.executionContext,D=f?f.getComponent("Viewer"):a.get();r.init(D,{executionContext:f});let A,S,E=new o({context:D}),x=e.getBoxController({context:D}),y=p.getExamineController({context:D}),b=s.getMoveManager({context:D,saveToDatabase:!!f||void 0}),T=m.getSelectionManager({context:D}),M=l.getDefaultSelectionFilter({context:D}),P=c.getMove3DRobot({context:D}),w=[],R=[],I={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},N={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3},U=!0;function L(){if(v.isRunning()){var e=t.give3DGridController({context:D});e&&e.hide3DGrids(),v&&v.isRunning()&&(M&&M.activate(),T&&T.setActiveState(!1)),x&&x.setActiveState(!1)}}function _(){if(v.isRunning()){var e=t.give3DGridController({context:D});e&&e.display3DGrids(),v&&v.isRunning()&&M&&!P.hasTarget()&&(M.deactivate(),T&&T.setActiveState(!0)),x&&x.setActiveState(!0)}}g||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){g=e,v.isRunning()&&(g.activate({context:D,withSnap:!0,selectionFilter:M}),g.give().setAllowManipulation(U),R.length||(R.push(g.subscribe("onDirectMoveBegin",L)),R.push(g.subscribe("onDirectMoveEnd",_))))})),P.setSelectionFilter(M),w.push(P.subscribe("onRobotMoveBegin",(function(){v.isRunning()&&(v&&v.isRunning()&&(M&&M.activate(),T&&T.setActiveState(!1)),x&&x.setActiveState(!1))}))),w.push(P.subscribe("onRobotMoveEnd",_));var W=[];function O(){W.length>0||(W.push(b.subscribe("MoveBegin",(function(){y&&y.setActiveState(!1)}))),W.push(b.subscribe("Move",(function(){var e=i.giveDataLauncherController({context:D});e&&e.setVisibility(!1)}))),W.push(b.subscribe("MoveEnd",(function(){var e=i.giveDataLauncherController({context:D});e&&e.setVisibility(!0),y&&y.setActiveState(!0)}))))}function F(){W.forEach((function(e){b.unsubscribe(e)})),D.unsubscribe(A),D.unsubscribe(S),W=[],A=S=void 0}var V=u.getPreferenceManager({context:D.getFrameWindow()}),k=[];function B(e){v&&e.forEach((function(e){if("W3MprefMove"===e.name)e.preferences.forEach((function(e){if("C3DAllowDirectManipulation"===e.name){let t=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),n=D.getController&&D.getController().hasAnyEffectiveFlexibleAssembly(),i=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration");U=!(t&&n&&i)&&"true"===e.value,g&&g.give().setAllowManipulation(U)}else"defaultMoveReferent"===e.name&&(n.setMoveReferentDefault(e.value),x&&x.refreshBoxes(!0))}));else if("FrameGeneral"===e.name)e.preferences.forEach((function(e){if("ProjectionType"===e.name){var t="Perspective"===e.value?0:1;let n=D?D.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.setProjectionType(t)}}));else if("VisualizationRepository"===e.name)e.preferences.forEach((function(e){if("Gravity"===e.name){var t="true"===e.value;let n=D?D.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.control&&(n.currentViewpoint.getControl().setRotationRolling(!t),n.currentViewpoint.getControl().setRollingForTouchAvailable(!t))}}));else if("SelectionRepository"===e.name)e.preferences.forEach((function(e){if("Select3DGeometry"===e.name){var t=!!M&&M.isActive();t&&M.deactivate(),T.setPicking("true"===e.value?0:1),t&&M.activate()}else"SelectParentReferenceOr3DShape"===e.name&&T&&T.selectParentReference("select3DShape"!==e.value)}));else if("cke"===e.name){let t=!1,n=!1;e.preferences.forEach((function(e){"Length"===e.name?(I.unit=e.value,t=!0):"LengthCalcDisplay"===e.name?(I.decimalPlaceRO=parseInt(e.value),t=!0):"Angle"===e.name?(N.unit=e.value,n=!0):"AngleCalcDisplay"===e.name&&(N.decimalPlaceRO=parseInt(e.value),n=!0)})),t&&P.setLengthUnit(I),n&&P.setAngleUnit(N)}}))}V.addPreferences(n.getPreferencesDefinition()),V.setUnitsPreferencesDisplayFlag(!0),V.setDisplayPreferencesDisplayFlag(!0),V.set3DSelectionPreferencesDisplayFlag(!0),V.setMeasurePreferencesDisplayFlag(!0),V.setClippingPreferencesDisplayFlag(!0),V.setPreferredPreferenceContainersOrder(["W3MprefMove","MeasurePreferences","SectionPreferences"]),k.push(V.subscribe("com.ds.mep:onPrefUpdate",(function(e){B(JSON.parse(e[1].preferences).repositories)}))),D.getViewer().currentViewpoint.getControl().setRotationRolling(!0),D.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!0),T.setPicking(1),T.selectParentReference(!1);function X(){if(!D)return;let e=D.getRoots(),t=f.getComponent(WAfrStandardComponentKey.HandlerComponent);t.hasHandler("CATC3DNavigationStartHdr")&&(e.length?t.enableHandler("CATC3DNavigationStartHdr"):t.disableHandler("CATC3DNavigationStartHdr"))}d.readPreferences([{Repository:"W3MprefMove",PreferenceNames:["C3DAllowDirectManipulation","defaultMoveReferent"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]},{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Angle","AngleCalcDisplay"]}]).then((function(e){B(e.repositories)})).catch((function(e){window.console.warn("Error Preferences ",e)})),this.beginExecute=function(){D&&(A=D.subscribe({event:"onRootAdded"},(function(){X()})),S=D.subscribe({event:"onRootRemoved"},(function(){X()})),X(),T.setActiveState(!0),D.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),function(){if(D&&!h){E.activate(),x.setActiveState(!0);var e=i.giveDataLauncherController({context:D});e&&e.setActiveState(!0),g&&g.activate({context:D,withSnap:!0,selectionFilter:M}),y&&y.setActiveState(!0),O()}}())},this.destroy=function(){if(D){E.deactivate(),x.setActiveState(!1);var e=i.giveDataLauncherController({context:D});e&&e.setActiveState(!1),g&&g.deactivate({context:D}),T.setActiveState(!1),y&&y.setActiveState(!1),F()}},this.pauseExecute=function(){E.deactivate(),x.setActiveState(!1);var e=i.giveDataLauncherController({context:D});e&&e.setActiveState(!1),g&&g.deactivate({context:D}),M&&M.deactivate(),T.setActiveState(!1),y&&y.setActiveState(!1),F(),this.done()},this.resumeExecute=function(){if(D){M&&P.hasTarget()?(M.activate(),T.setActiveState(!1)):T.setActiveState(!0),D.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),E.activate(),x.setActiveState(!0);var e=i.giveDataLauncherController({context:D});e&&e.setActiveState(!0),g&&g.activate({context:D,withSnap:!0,selectionFilter:M}),y&&y.setActiveState(!0),O(),this.done()}},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this.isRunning=function(){let e,t,n;return e=D.getExecutionContext?D.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent):void 0,e&&(n=e.getDefaultCommand(),t=null===e.getRunningCommand()?n:e.getRunningCommand()),t===n},this._destroy=function(){F(),w.forEach(P.unsubscribe,P),R.forEach(P.unsubscribe,R),g&&(R.forEach(g.unsubscribe,R),g.unreference({context:D})),h=!0,k.forEach(V.unsubscribe,V),l.unreferenceDefaultSelectionFilter({context:D}),m.unreferenceSelectionManager({context:D}),p.unregisterExamineController({context:D}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),v=M=D=E=x=b=P=V=k=T=null}}}})),define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATW3DBoxes/CATW3DBoxController","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUFrameWindow","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DRobot/CATW3DRobot","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g){"use strict";var C,v=e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var v=this,h=!1,f=e.executionContext?e.executionContext.getComponent("Viewer"):r.get();s.init(f,{executionContext:e.executionContext});let D=new a({context:f}),A=t.getBoxController({context:f}),S=g.getExamineController({context:f}),E=l.getMoveManager({context:f}),x=p.getSelectionManager({context:f}),y=c.getDefaultSelectionFilter({context:f}),b=u.getMove3DRobot({context:f}),T=[],M=[],P={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},w={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3},R=!0;function I(){if(v.isRunning()){var e=n.give3DGridController({context:f});e&&e.hide3DGrids(),v&&v.isRunning()&&(y&&y.activate(),x&&x.setActiveState(!1)),A&&A.setActiveState(!1)}}function N(){if(v.isRunning()){var e=n.give3DGridController({context:f});e&&e.display3DGrids(),v&&v.isRunning()&&y&&!b.hasTarget()&&(y.deactivate(),x&&x.setActiveState(!0)),A&&A.setActiveState(!0)}}C||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){C=e,v.isRunning()&&(C.activate({context:f,withSnap:!0,selectionFilter:y}),C.give().setAllowManipulation(R),M.length||(M.push(C.subscribe("onDirectMoveBegin",I)),M.push(C.subscribe("onDirectMoveEnd",N))))})),b.setSelectionFilter(y),y.deactivate(),T.push(b.subscribe("onRobotMoveBegin",(function(){v.isRunning()&&(v&&v.isRunning()&&(y&&y.activate(),x&&x.setActiveState(!1)),A&&A.setActiveState(!1))}))),T.push(b.subscribe("onRobotMoveEnd",N));var U=[];function L(){U.length>0||(U.push(E.subscribe("MoveBegin",(function(){S&&S.setActiveState(!1)}))),U.push(E.subscribe("Move",(function(){var e=o.giveDataLauncherController({context:f});e&&e.setVisibility(!1)}))),U.push(E.subscribe("MoveEnd",(function(){var e=o.giveDataLauncherController({context:f});e&&e.setVisibility(!0),S&&S.setActiveState(!0)}))))}function _(){U.forEach((function(e){E.unsubscribe(e)})),U=[]}var W=d.getPreferenceManager({context:f.getFrameWindow()}),O=[];function F(e){v&&e.forEach((function(e){if("W3MprefMove"===e.name)e.preferences.forEach((function(e){if("C3DAllowDirectManipulation"===e.name){let t=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),n=f.getController&&f.getController().hasAnyEffectiveFlexibleAssembly(),i=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration");R=!(t&&n&&i)&&"true"===e.value,C&&C.give().setAllowManipulation(R)}else"defaultMoveReferent"===e.name&&(i.setMoveReferentDefault(e.value),A&&A.refreshBoxes(!0))}));else if("FrameGeneral"===e.name)e.preferences.forEach((function(e){if("ProjectionType"===e.name){var t="Perspective"===e.value?0:1;let n=f?f.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.setProjectionType(t)}}));else if("VisualizationRepository"===e.name)e.preferences.forEach((function(e){if("Gravity"===e.name){var t="true"===e.value;let n=f?f.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.control&&(n.currentViewpoint.getControl().setRotationRolling(!t),n.currentViewpoint.getControl().setRollingForTouchAvailable(!t))}}));else if("SelectionRepository"===e.name)e.preferences.forEach((function(e){if("Select3DGeometry"===e.name){var t=!!y&&y.isActive();t&&y.deactivate(),x.setPicking("true"===e.value?0:1),t&&y.activate()}else"SelectParentReferenceOr3DShape"===e.name&&x&&x.selectParentReference("select3DShape"!==e.value)}));else if("cke"===e.name){let t=!1,n=!1;e.preferences.forEach((function(e){"Length"===e.name?(P.unit=e.value,t=!0):"LengthCalcDisplay"===e.name?(P.decimalPlaceRO=parseInt(e.value),t=!0):"Angle"===e.name?(w.unit=e.value,n=!0):"AngleCalcDisplay"===e.name&&(w.decimalPlaceRO=parseInt(e.value),n=!0)})),t&&b.setLengthUnit(P),n&&b.setAngleUnit(w)}}))}W.addPreferences(i.getPreferencesDefinition()),W.setUnitsPreferencesDisplayFlag(!0),W.setDisplayPreferencesDisplayFlag(!0),W.set3DSelectionPreferencesDisplayFlag(!0),W.setMeasurePreferencesDisplayFlag(!0),W.setClippingPreferencesDisplayFlag(!0),W.setPreferredPreferenceContainersOrder(["W3MprefMove","MeasurePreferences","SectionPreferences"]),O.push(W.subscribe("com.ds.mep:onPrefUpdate",(function(e){F(JSON.parse(e[1].preferences).repositories)}))),f.getViewer().currentViewpoint.getControl().setRotationRolling(!0),f.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!0),f.getViewer().currentViewpoint.setProjectionType(0),x.setPicking(1),x.selectParentReference(!1);m.readPreferences([{Repository:"W3MprefMove",PreferenceNames:["C3DAllowDirectManipulation","defaultMoveReferent"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]},{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Angle","AngleCalcDisplay"]}]).then((function(e){F(e.repositories)})).catch((function(e){window.console.warn("Error Preferences ",e)})),this.beginExecute=function(){f&&(x.setActiveState(!0),f.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),function(){if(f&&!h){D.activate(),A.setActiveState(!0);var e=o.giveDataLauncherController({context:f});e&&e.setActiveState(!0),C&&C.activate({context:f,withSnap:!0,selectionFilter:y}),y&&y.deactivate(),S&&S.setActiveState(!0),L()}}(),this.done())},this.endExecute=function(){if(f){D.deactivate(),A.setActiveState(!1);var e=o.giveDataLauncherController({context:f});e&&e.setActiveState(!1),C&&C.deactivate({context:f}),x.setActiveState(!1),S&&S.setActiveState(!1),_()}},this.pauseExecute=function(){D.deactivate(),A.setActiveState(!1);var e=o.giveDataLauncherController({context:f});e&&e.setActiveState(!1),C&&C.deactivate({context:f}),y&&y.deactivate(),x.setActiveState(!1),S&&S.setActiveState(!1),_(),this.done()},this.resumeExecute=function(){if(f){y&&b.hasTarget()?(y.activate(),x.setActiveState(!1)):x.setActiveState(!0),f.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),D.activate(),A.setActiveState(!0);var e=o.giveDataLauncherController({context:f});e&&e.setActiveState(!0),C&&C.activate({context:f,withSnap:!0,selectionFilter:y}),S&&S.setActiveState(!0),L(),this.done()}},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){_(),T.forEach(b.unsubscribe,b),M.forEach(b.unsubscribe,M),C&&(M.forEach(C.unsubscribe,M),C.unreference({context:f})),h=!0,O.forEach(W.unsubscribe,W),c.unreferenceDefaultSelectionFilter({context:f}),p.unreferenceSelectionManager({context:f}),g.unregisterExamineController({context:f}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),v=y=f=D=A=E=b=W=O=x=null}}});return v})),define("DS/CAT3DComposeUtils/CATC3DDropManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/PADUtils/PADUtilsServices","DS/CoreEvents/ModelEvents","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXComponents/DMUCommand","DS/CAT3DComposeUtils/CATC3DUtils","i18n!DS/PADUtils/assets/nls/PADUtils.json","i18n!DS/CAT3DComposeUtils/assets/nls/CATC3DDropManager.json"],(function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,C,v){"use strict";var h=i.getOption("authoring3d"),f=["CATProduct","CATPart","VPMReference","3DShape"],D=["CATProduct","VPMReference"],A=e.extend({init:function(e){var i,A,S,E,x=e.context,y=x.getViewer(),b=this,T=new p({ID:"CATC3DDropMngFakeCmdHdr",context:x.getCommandContext?x.getCommandContext():null});function M(e){var t=a.get(),n=!((t.length?t[0].pathElement:null)&&t[0].equivalentGeometry);return e?!n:n}function P(){var e=o.getRoots(x);if(!e.length)return!0;if(!e.some((function(e){return e&&!o.is3DLeaf(e)})))return!0;var t=i?i.getLastElement(!0):null;return!(!t||"RootBag"!==t.name)||!(!t||o.isPLMNode(t)&&-1!==D.indexOf(o.getNodeType(t)))}function w(e){if(!P()){if(A){var t=A.getPosition(),r=A.getSize();if(0===t.x&&0===t.y&&(t.x=y.SCREEN_WIDTH/2-r.width/2,t.y=y.SCREEN_HEIGHT/2-r.height/2),t.x<=e.offsetX&&e.offsetX<=t.x+r.width&&t.y<=e.offsetY&&e.offsetY<=t.y+r.height)A.setOpacity(0);else{var s=Math.max(Math.min(e.offsetX,t.x+r.width),t.x),l=Math.max(Math.min(e.offsetY,t.y+r.height),t.y),c=Math.sqrt((e.offsetX-s)*(e.offsetX-s)+(e.offsetY-l)*(e.offsetY-l));c<200?A.setOpacity(c/200):A.setOpacity(1)}}var u=function(e){if(i)return{pathElement:i.clone()};var t=y.pick(y.getMousePosition(new n.Vector2(e.offsetX,e.offsetY)),"primHybrid",!0);if(t&&t.path&&0!==t.path.length){var a=t.path[0];if(a&&a.externalPath&&!(a.externalPath.length<2)&&o.isAModelPath(a))return o.is3DLeaf(a.externalPath[1])&&a.externalPath.length>2&&(a.externalPath.splice(2),a.internalPath=[]),{pathElement:a,position:t.position}}}(e);if(u)a.unique(u),a.get()[0].position=u.position;else if(a.empty(),!i)return;e.preventDefault(),e.stopPropagation(),x.addWidgetBorder(),document.querySelector(".paddnd_invite_display.insert .paddnd_invite_txt").setText(M(e.shiftKey)?"Insert object in position":"Insert"),x._dropZoneContainer.show("insert")}}function R(e){return a.empty(),r.empty(),s.empty(),A=document.querySelector(".paddnd_invite_container"),w(e)}function I(){A&&A.setOpacity(1)}function N(e){return a.empty(),I()}function U(e){if(!P()){A&&A.setOpacity(1),x._dropZoneContainer.hide(),x.clearWidgetBorder();for(var u=a.get().slice(),p=i?i.clone():u.length?u[0].pathElement:null;p;){var h=p.getLastElement(!0);if(h&&o.isReference(h)&&!o.is3DLeaf(h))break;p=p.getParentPath()}p&&(e.preventDefault(),e.stopPropagation(),function(e,n){try{t.retrieveAuthorizedObjects({displayNotif:!1,dnd_event:e,version:"2.0",callback:function(e){var t={unauthorized:[],add:[],insert:[]};e.unauthorized_objects&&e.unauthorized_objects.length&&(t.unauthorized=e.unauthorized_objects),Object.keys(e.authorizedWithKind).forEach((function(n){"Product"===n?e.authorizedWithKind.Product.forEach((function(e){-1===f.indexOf(e.objectType)?t.add.push(e):t.insert.push(e)})):e.authorizedWithKind[n].forEach((function(e){t.add.push(e)}))})),n(t)}})}catch(e){window.console.log("")}}(e,(function(t){if(t.unauthorized.length&&t.unauthorized.forEach((function(e){x.displayNotification({msg:C.replace(C.get("unsupported_type"),{type:e.objectType,name:e.displayName}),eventID:"warning"})})),t.insert.length){var i,a=!1,h=c.getPlatformId();for(i=0;i<t.insert.length;i++)h!==t.insert[i].envId&&(t.insert.splice(i,1),a=!0,i--),a&&x.displayNotification({msg:v.Tenant_InsertInfo,eventID:"warning"});if(t.insert.length){var f=o.getNodeID(p.getLastElement(!0)),D=M(e.shiftKey),A=[];S&&S.publish({event:"onBeginInsertDrop3D",data:{type:D?"inPosition":""}}),r.empty(),s.empty(),t.insert.forEach((function(i){var o=D?i.path?i.path.map((function(e){return e.resourceid})):[i.objectId]:null,a=i.objectId;!function(e,t,i,o){function a(e){var t=new n.Matrix4;return e.externalPath.forEach((function(e){t.multiply(e.getMatrix())})),t}if(i){if(1===i.length)return void o();var r=a(t),s=i.filter((function(e,t){return t%2}));x.getController().getAttributes({ids:s,attributes:["matrixtxt"],callbacks:{onComplete:function(e){var t=new n.Matrix4,i=new n.Matrix4;s.forEach((function(n){if(e[n]&&e[n].matrixtxt){var o=e[n].matrixtxt.replace(/^\[?|\]?$/g,"").split(",").map(parseFloat);i.set(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1),t.multiply(i)}})),o(i.getInverse(r).multiply(t))},onFailure:function(){o()}}})}else{var c,u=a(t),d=u.clone();switch(e.equivalentGeometry?e.equivalentGeometry.getType():null){case l.GeometryType.POINT:c=e.equivalentGeometry.getPoint();break;case l.GeometryType.LINE:case l.GeometryType.CYLINDER:case l.GeometryType.CONE:var m=e.equivalentGeometry.getEndPoints(),p=new n.Line3(m.beginPoint,m.endPoint);if(c=e.position?e.position.clone():null){var g=p.closestPointToPointParameter(c,!0);c=p.at(g>=.5?1:0)}break;case l.GeometryType.CIRCLE:case l.GeometryType.SPHERE:c=e.equivalentGeometry.getCenter();break;case l.GeometryType.AXISSYSTEM:u=a(e.pathElement);break;default:c=e.position?e.position.clone():null}c&&u.setPosition(c),o((new n.Matrix4).getInverse(d).multiply(u))}}(u[0],p,o,(function(i){A.push({id:a,matrix:i}),A.length===t.insert.length&&(T.begin(),g.insertExisting({parentID:f,children:A,context:x,onCompleted:function(t){var i=0,o=s.get();t.forEach((function(e){e.instID||(e.message?x.displayNotification({msg:e.message,eventID:"error"}):i++)})),i&&x.displayNotification({msg:"Insertion failed",eventID:"error"});var a=m.giveMoveManager({context:x}),r=d.getMoveReferentManager({context:x});o.forEach((function(e){r.addMoveReferent(e.pathElement)}));var c=u.length?u[0].equivalentGeometry:null,p=c?c.getType():null;!o.length||p!==l.GeometryType.LINE&&p!==l.GeometryType.CYLINDER&&p!==l.GeometryType.CONE&&p!==l.GeometryType.PLANE&&p!==l.GeometryType.REFPLANE?(o.length&&require(["DS/CATW3DBoxes/CATW3DBoxController"],(function(e){e.getBoxController({context:x}).refreshBoxes()})),S&&S.publish({event:"onEndInsertDrop3D",data:{type:o.length?D?"inPosition":"":"cancelled"}})):require(["DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DGeometry/CATW3DEquivalentGeometry"],(function(t,i){E||(E=t.getConstraintsController({context:x})),E.deleteAllCst();var r=i.getEquivalentGeometry({pathElement:o[0].pathElement,axis:E.getProductAxisForConstraint(),viewer:x.getViewer()});E.createCst({movable:{equivalentGeometry:r},fixed:{equivalentGeometry:c}});var s=E.simulateSolveCst()||{},l=s.matrix||new n.Matrix4,u=new n.Matrix4,d=s.rc,m=s.redundancy;0!==d||m||(a.onMoveBegin({objectsMoved:o,from:b,moveMode:"Persistent"}),o.forEach((function(e){a.onMove({objectsMoved:[{path:e.pathElement}],from:b,worldMatrix:u.multiplyMatrices(l,e.pathElement.getWorldMatrix())})})),a.onMoveEnd({from:b,status:"Moved"}),x.getExecutionContext?x.getFrameWindow().getContextualUIManager()._showContextualBar({x:e.offsetX+45,y:e.offsetY-45,hideWithDistance:!0}):x.getFrameWindow().getContextualUIManager().showContextualBar({x:e.offsetX+45,y:e.offsetY-45,hideWithDistance:!0})),o.length&&require(["DS/CATW3DBoxes/CATW3DBoxController"],(function(e){e.getBoxController({context:x}).refreshBoxes()})),S&&S.publish({event:"onEndInsertDrop3D",data:{type:o.length?D?"inPosition":"":"cancelled"}})}))}}))}))}))}}else t.add.length&&x.addRootNodesFromContent({json3DXContent:{data:{items:t.add}},dispatch:!0,inContext:!e.shiftKey})})))}}this.connect=function(){h&&(y.canvas.addEventListener("dragenter",R),y.canvas.addEventListener("dragover",w),y.canvas.addEventListener("dragleave",N),y.canvas.addEventListener("dragend",I),y.canvas.addEventListener("drop",U),i=null)},this.disconnect=function(){h&&(E&&E.unreference(),y.canvas.removeEventListener("dragenter",R),y.canvas.removeEventListener("dragover",w),y.canvas.removeEventListener("dragleave",N),y.canvas.removeEventListener("dragend",I),y.canvas.removeEventListener("drop",U),i=null)},this.setCurrentPath=function(e){i=e?e.clone():null},this.subscribe=function(e,t){return S||(S=new u),S.subscribe(e,t)},this.unsubscribe=function(e){return S?S.unsubscribe(e):this}}}),S=[];return e.singleton({init:function(){},getDropManager:function(e){var t,n;return n=e.context&&e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===n&&(S.some((function(n){return n.context===e.context&&(t=n.dropMng,!0)})),t||(t=new A({context:e.context}),S.push({context:e.context,dropMng:t}))),t},unreferenceDropManager:function(e){var t;t=e.context&&e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===t&&S.some((function(t,n){return t.context===e.context&&(S.splice(n,1),!0)}))}})}));