<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">
  <head>
    <!-- Application Metas -->
	<!-- These information will be displayed in the widget preferences -->
    <title>Web in Win LifeCycle</title>
    <meta name="author" content="LHX" />
    <meta name="description" content="AWeb in Win LifeCycle" />
    <!-- UWA Environment -->
	<script type="text/javascript" src="../AmdLoader/AmdLoader.js"></script>
	<!-- Load UWA environment --> 
	<link rel="stylesheet" type="text/css" href="../c/UWA/assets/css/standalone.css" />
	<script type="text/javascript" src="../c/UWA/js/UWA_Standalone_Alone.js"></script>
	<!-- UWA/Class/View, Model and Collection will be loaded dynamically -->

	<link rel="stylesheet" type="text/css" href="../UIKIT/UIKIT.css" /> 
	<script type="text/javascript" src="../UIKIT/UIKIT.js"></script> 

	<link rel="stylesheet" type="text/css" href="./ENOBaseLifeCycleWintop.css" />

    <script type="text/javascript">
        /*
          We create the global MyWidget object.
          This object will be used to store variables and functions.
        */

        var decodeUrlParam = function(urlparam) { //should be kept consistent with what is done in CATPLMBaseLifeCycleCmdCAfr::EncodeForURLParam
            return decodeURIComponent(urlparam);
        };

        var decodeUrlParam_OldFormating = function(urlparam) {
            return urlparam.replace(/#47;/g, "/");
        };

        function getUrlParamVal(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair.length>=1 && pair[0] == variable) {
                    return decodeUrlParam(pair[1]);
                }
            }
            return '';
        }

        function getUrlParamVal_OldFormating(variable) {
            var vars = location.href.split("?");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair.length>=1 && pair[0]==variable) {
                    return decodeUrlParam_OldFormating(pair[1]);
                }
            }
            return '';
        }

        function getUrlWidgetOptions() {
            var widgetOptions = {};
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair.length==2 && pair[0].startsWith("widgetoption_"))
                    widgetOptions[pair[0].substr("widgetoption_".length)] = decodeURIComponent(pair[1]);
            }
            return widgetOptions;
        }

        function getUrlWidgetOptions_OldFormating() {
            var widgetOptions = {};
            var vars = location.href.split("?");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair.length==2 && pair[0].startsWith("widgetoption_"))
                    widgetOptions[pair[0].substr("widgetoption_".length)] = decodeURIComponent(pair[1]); //decodeURIComponent is correct here.
            }
            return widgetOptions;
        }

        debugger;

        var oldUrlFormating = location.href.indexOf("#47;")>0;
        if (oldUrlFormating) console.log("*** old url formating ***");
        else console.log("*** new url formating ***");

        var myWidgetName = !oldUrlFormating ? getUrlParamVal('widget')    : getUrlParamVal_OldFormating('widget');
        console.log("*** widget name: " + myWidgetName + " ***");

        var myServerUrl  = !oldUrlFormating ? getUrlParamVal('serverurl') : getUrlParamVal_OldFormating('serverurl');
        var myEnoviaTenant = !oldUrlFormating ? getUrlParamVal('enoviatenant') : getUrlParamVal_OldFormating('enoviatenant');
        myEnoviaTenant = myEnoviaTenant || 'OnPremise';

        var myEnvVarsS = !oldUrlFormating ? getUrlParamVal('LAEnvVar') : getUrlParamVal_OldFormating('LAEnvVar');
        var myEnvVars = myEnvVarsS ? myEnvVarsS.split(";") : [];

        var myWidgetOptions = !oldUrlFormating ? getUrlWidgetOptions() : getUrlWidgetOptions_OldFormating();

		var addinmode = getUrlParamVal('addinmode');
        console.log("addinmode: " + addinmode);

        //IR-909445-3DEXPERIENCER2022x  - Provide a way to set the language if there is no command header.
        if (myWidgetOptions['Language']) {
        	Object.defineProperty(navigator,'language',{writable:true});
        	navigator.language = myWidgetOptions['Language'];
        	Object.defineProperty(navigator,'language',{writable:false});
        }

        var _webinwincom_socket = null;

        var map = {
        		options: {
        			mapSettings: {}
        		},

                initMap: function (url3DSpace) {
                  var that = this;
                  this.options = {};
                  this.options.mapSettings = {
                          "platform_services": [{
                            "3DSpace": url3DSpace,
                          }]
                        };
                   // mySecondDiv.initEnvfromWin(map.options.mapSettings);
 	               },
          };

        var mySecondDiv = null;
        function addItem(physicalId, name) {
            if (mySecondDiv != null) {
                physicalId=physicalId.replace(/_/g, ""); // replace all _ by nothing
                mySecondDiv.initDatafromWin([{
                    'physicalId': physicalId,
                    'name': name
                }]);
            }
        };
 
        //To manage shortcults (ctrl+O ...) if doNotDisplay == 1, the contextual menu is not dispalyed
        function SetCtxMenu (jsonCtxMenu, jsonCtxSubMenu, doNotDisplay) {
          var that = this;
          if (mySecondDiv != null) {
              mySecondDiv.onSetCtxMenuForItem(jsonCtxSubMenu);
          }
        };

        function addItems(objects) {
            if (mySecondDiv != null) {
                //objects=objects.replace(/_/g, ""); // replace all _ by nothing
                mySecondDiv.initDatafromWin(objects);
            }
        };

        function executeWebActionSync(action) {

            //see https://dsext001-eu1-215dsi0708-3dswym.3dexperience.3ds.com/#dm:W6pdRtlYQ2eUenieYBJQRw/post:LJlUI6otSWqQl4AlzceQ4A
            // "What's new: two-way execution for JavaScript"
            if (mySecondDiv != null && typeof mySecondDiv[action] === 'function') {
                return mySecondDiv[action].call(mySecondDiv); //could return a Promise.
            }
        };

        function dispatchWebAction(callBack) {

        	if (mySecondDiv != null) {
                mySecondDiv.dispatchEvent(callBack);
            }
        }

        function licenseList(objects){
        	if ( mySecondDiv != null){
        		mySecondDiv.onLicenseList(objects);
        	}
        };

        function InitMap(url3DSpace) {
            map.initMap(url3DSpace);
        };

        function ErrorSelection(unMessage) {
            if (mySecondDiv != null) {
                var error= {
                    code: "",
                    message: unMessage
                }
                mySecondDiv.initData([]);
                mySecondDiv.addError(error);
            }
        };

        var dependencies = dependencies || [];

        require(
            // dependencies
            [
                myWidgetName,
                'DS/WidgetServices/WidgetServices',
                'DS/LifecycleServices/LifecycleServicesSettings',
                'DS/WebToWinInfra/WebToWinCom',
                'DS/WebInWinUtils/dscef'
            ].concat(dependencies),

            // execute this callback, passing all dependencies as params

            function (WidgetCore, widgetServices, LifecycleServicesSettings, webinwinCom, dscef) {
 
           		var _webinwincom_socket = webinwinCom.createSocket({
                	  socket_id: 'lf_web_in_win'
                });

                var WIWI = {

                    onLoad: function () { //Needed to be sure to have a widget.body
                        //sendNotification('Message', "pageLoaded");
                        //this.send_notif("pageLoaded");
                        var that = this;

                        _webinwincom_socket.addListener('onDispatchToWin', function (parameters){
                      	   var name = parameters.notif_name;
                     	   var parameters_string = UWA.is(parameters.notif_parameters, 'string') ? parameters.notif_parameters : JSON.stringify(parameters.notif_parameters);
                     	   var message = parameters_string;

                           if (!parameters.recordable || dscef.isA2X)
                                dscef.sendString (name + '=' + message);
                           else {
                                var last_args = { recordable: true };
                                if (parameters.captureAll) last_args.captureAll = true;

                     	        dscef.sendString (name + '=' + message, last_args);
                            }
                        });

                  		var ServerUrl = {
                          "platform_services": [{
                            "3DSpace": myServerUrl,
                            "platformId":myEnoviaTenant,
                          }]
                        };

                  		Object.assign( myWidgetOptions ,  {
                            //'setRefreshButton': true,
                            //'setValidButton': true,
                            //'setCloseButton': false,
                            //'setRefreshButton': false,
                            'wintop': true,
                            'serverUrl' : ServerUrl.platform_services,
                            'addinmode': addinmode, //'CATIAV5', //addinmode,
                            //'readOnly': false,'
                         	   events: {
                                "onRefresh": function () {
                                    console.log("refresh");
                           	   },
       	        		        "onCancel" : function(){
       	        		        	console.log("Cancel");
    	                           	//dscef.sendString ('notifText=ClosePanel');
    	                           	this.webToWinCom_Socket.dispatchEvent(
						            'onDispatchToWin',
						            {
						                notif_name: 'ClosePanel',
						                notif_parameters: 'ClosePanel',
						                recordable: true,
						                captureAll: true
						            },
						            'lf_web_in_win'
						        );
    	        		       },
      	        		        "onChangeSize" : function(){
      	        		        	//console.log("onResize");
    	        		    	    //that.onResize();
      	                          if (typeof mySecondDiv.postResize === "function"){
      	                    		var sizeBody= mySecondDiv.container.getDimensions();
      	                    		var maxHeight = sizeBody.innerHeight;
      	                    		mySecondDiv.postResize(maxHeight);
      	                        }
    	        		       }
                          	  }
                       	 });
                         if (myWidgetOptions.SecurityContext) { //IR-1253312-3DEXPERIENCER2024x. A way to pass the Win SecurityContext to the Web.
                            if (!myWidgetOptions.context) myWidgetOptions.context = {};
                            myWidgetOptions.context.getSecurityContext = function () { return {"SecurityContext": myWidgetOptions.SecurityContext} };
                         }

                       	 //widgetServices.setODTComment(true);
                       	 mySecondDiv = new WidgetCore(widget, widget.body, myWidgetOptions);

                         widget.setBody(mySecondDiv);
                         widget.body.style.overflow = 'hidden';
                       	 widget.body.setStyle("height", "100%");
                       	 if (typeof mySecondDiv.getBottomBar === "function"){
                        	 var modalFooter = this.elements.footer;
                        	 if (modalFooter){
                        		 var modalWrapper = this.elements.content;
                        		 if (modalWrapper){
                        			 modalWrapper.setStyle("height", "calc(100% - 50px)");
                        		 }
                        		 modalFooter.show();
                        		 modalFooter.empty();
                        		 var BottomBar = mySecondDiv.getBottomBar();
                        		 BottomBar.inject(modalFooter);
                        	 }
                       	 }

                         /*
                       	dscef.sendString ('notifText=pageLoaded',{
                            recordable: true,
                            captureAll: true
                        });
                        */
                       	dscef.sendString ('notifText=pageLoaded');
                    },
                    onRefresh: function () {
                        mySecondDiv.onRefresh();
                    },
                    onResize: function () {
                        mySecondDiv.onResize();
                        if (typeof mySecondDiv.postResize === "function"){
                        	if( mySecondDiv.container && mySecondDiv.container.getDimensions && typeof mySecondDiv.container.getDimensions === "function"){
	                    		var sizeBody= mySecondDiv.container.getDimensions();
	                    		var maxHeight = sizeBody.innerHeight;
	                    		mySecondDiv.postResize(maxHeight);
                        	}
                        	else if(typeof mySecondDiv.widget.body.getDimensions === "function"){
                        		var sizeBody= mySecondDiv.widget.body.getDimensions();
                        		mySecondDiv.postResize(sizeBody);
                        	}
                        }
                    },

                };
                widget.addEvent('onLoad', WIWI.onLoad);
                widget.addEvent('onRefresh', WIWI.onRefresh);
                widget.addEvent('onResize', WIWI.onResize);
                return WIWI;
            });

    </script>
  </head>
  <body>
    <p>Loading...</p>
   </body>
</html>
