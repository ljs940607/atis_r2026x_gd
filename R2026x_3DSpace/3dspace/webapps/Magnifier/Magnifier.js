define("DS/Magnifier/Magnifier",["UWA/Class","UWA/Controls/Abstract","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/VisuEvents/ScreenEvent","DS/VisuEvents/EventsManager"],(function(e,i,t,n,s,a,o){"use strict";return i.extend({defaultOptions:{activated:!0,viewer:null,dim:83,shiftVector:{x:-40,y:110},styles:{position:"absolute",display:"none",boxShadow:"-1px 2px 5px 1px rgba(0, 0, 0, 0.7)",border:"1px solid #ccc"}},nativeBehaviour:{dim:100,shiftVector:{x:-130,xLH:30,y:160},styles:{outline:"1px solid rgba(30, 30, 30, 0.7)",border:"6px solid #fff",boxShadow:" inset 0 0 12px rgba(120, 120, 120, 1), 0 0 14px rgba(30, 30, 30, 1)"}},init:function(e){this._parent(e),this._buildView(),this.displayed=!1,this.enableSelection=!1,this.enableNativeBehaviour=!1,this.devicePixelRatio=n.getDevicePixelRatio()||1,this.container=this.elements.container,this.content=this.elements.container.firstChild,this.setUpCBs(),this.setOption(this.options),this.viewer.divCssElement.appendChild(this.container),this.onRenderCB=null},setOption:function(e){e.viewer&&(this.viewer=e.viewer),this.enableNativeBehaviour=void 0!==e.a2xMode&&e.a2xMode,!0===this.enableNativeBehaviour?(this._setDimension(this.nativeBehaviour.dim),this.shiftVector=new n.Vector2(e.leftHanded&&!0===e.leftHanded?this.nativeBehaviour.shiftVector.xLH:this.nativeBehaviour.shiftVector.x,this.nativeBehaviour.shiftVector.y),this.container.setStyles(this.nativeBehaviour.styles)):(e.dim&&this._setDimension(e.dim),e.shiftVector?this.shiftVector=e.shiftVector:this.shiftVector=new n.Vector2,this.container.setStyles(this.defaultOptions.styles)),e.activated?this._activate():this._desactivate()},getActive:function(){return this.active},_buildView:function(){this.elements.container=UWA.Element("div",{id:"magnify-div",html:[{tag:"canvas",id:"magnify-canvas"}],styles:this.defaultOptions.styles})},_setDimension:function(e){this.dim=e%2==0?e+1:e,this.container.setStyle("width",this.dim),this.container.setStyle("height",this.dim),this.container.setStyle("overflow","hidden"),this.container.setStyle("border-radius","50%"),this.content.setStyle("width","100%"),this.content.setStyle("height","100%"),this.content.width=this.dim*this.devicePixelRatio,this.content.height=this.dim*this.devicePixelRatio},_updateMagnifier:function(e){var i=this.viewer.devicePixelRatio;i!==this.devicePixelRatio&&(this.devicePixelRatio=i,this._setDimension(this.dim));var t={x:this.viewer.renderer.deviceWidth,y:this.viewer.renderer.deviceHeight},n={x:Math.round(this.dim*i),y:Math.round(this.dim*i)},s=Math.min(Math.max(0,e.xPix+this.shiftVector.x*i),t.x-n.x),a=Math.min(Math.max(0,e.yPix-this.shiftVector.y*i),t.y-n.y);this.container.show(),this.displayed=!0,this._renderOffscreen(this.viewer,this.viewer.currentViewpoint,this.content,t,n,e),this.container.setStyles({left:Math.round(s/i),top:Math.round(a/i)})},_renderOffscreen:function(e,i,t,n,s,a){var o={x:a.xPix-s.x/2,y:a.yPix+s.y/2},r={data:null,width:s.x,height:s.y,x:Math.round(o.x),y:Math.round(n.y-o.y)};e.renderToTarget(r,i,!0);for(var h=t.getContext("2d",{willReadFrequently:!0}),d=h.getImageData(0,0,s.x,s.y),l=d.data,v=0;v<d.height;v++)for(var c=0;c<d.width;c++){var f=this._getBufferIndex(c,v,d.width,d.height,!1),u=this._getBufferIndex(c,v,r.width,r.height,!0);l[4*f]=r.data[4*u],l[4*f+1]=r.data[4*u+1],l[4*f+2]=r.data[4*u+2],l[4*f+3]=r.data[4*u+3]}h.putImageData(d,0,0),h.drawImage(h.canvas,0,0,s.x,s.y);var x=Math.floor(s.x/2)+.5,y=Math.floor(s.y/2)+.5;this.enableNativeBehaviour?(this._drawViewFinder(h,x,y),this._drawViewFinder(h,x-.5,y-.5,"rgba(0, 255, 255, 0.6)"),this._drawViewFinder(h,x+.5,y+.5,"rgba(255, 255, 255, 0.6)")):(h.fillStyle="rgba(0, 255, 255, 0.5)",h.fillRect(x-2,y-8,4,16),h.fillRect(x-8,y-2,16,4),h.fillStyle="rgba(0, 0, 0, 0.5)",h.fillRect(x-1.5,y-7.5,3,15),h.fillRect(x-7.5,y-1.5,15,3),h.fillStyle="rgba(255, 255, 255, 1)",h.fillRect(x-.5,y-6.5,1,13),h.fillRect(x-6.5,y-.5,13,1)),this.onRenderCB&&this.onRenderCB()},_drawViewFinder:function(e,i,t,n="rgba(0, 0, 0, 1)"){let s=(i+t)/2,a=6*this.devicePixelRatio,o=4*devicePixelRatio,r=o/2,h={x:s-(a+r),y:s-r};e.beginPath(),e.moveTo(h.x,h.y),h.x+=a,e.lineTo(h.x,h.y),h.y-=a,e.lineTo(h.x,h.y),h.x+=o,e.lineTo(h.x,h.y),h.y+=a,e.lineTo(h.x,h.y),h.x+=a,e.lineTo(h.x,h.y),h.y+=o,e.lineTo(h.x,h.y),h.x-=a,e.lineTo(h.x,h.y),h.y+=a,e.lineTo(h.x,h.y),h.x-=o,e.lineTo(h.x,h.y),h.y-=a,e.lineTo(h.x,h.y),h.x-=a,e.lineTo(h.x,h.y),e.closePath(),e.strokeStyle=n,e.stroke()},_getBufferIndex:function(e,i,t,n,s){return s?(i=n-i,t*Math.floor(i-1)+Math.floor(e)):t*Math.floor(i)+Math.floor(e)},_activate:function(){this.active=!0,this.enableNativeBehaviour?o.addEvent(this.viewer.canvas,"onHold",this.startCB):o.addEvent(this.viewer.canvas,"onLongHold",this.startCB)},_desactivate:function(){this.active=!1,this.enableNativeBehaviour?o.removeEvent(this.viewer.canvas,"onHold",this.startCB):o.removeEvent(this.viewer.canvas,"onLongHold",this.startCB)},setUpCBs:function(){var e=this;e.displayed=!1,this.startCB=function(i){e.viewer.currentViewpoint.control.isMiddleButtonPressed()||e.viewer.currentViewpoint.control.isRightButtonPressed()||(e._updateMagnifier(e.viewer.getMousePosition(i.from[0].getCurrentPosition(e.viewer.canvas))),o.addEvent(e.viewer.canvas,"onSwipe",e.moveCB),o.addEvent(e.viewer.canvas,"onRelease",e.endCB))},this.moveCB=function(i){i.from[0].deltaPosition.length()<300?e._updateMagnifier(e.viewer.getMousePosition(i.from[0].getCurrentPosition(e.viewer.canvas))):e.container.hide(),i.from[0].offsetPosition.length()>10&&(e.enableSelection=!0)},this.endCB=function(){e.container.hide(),o.removeEvent(e.viewer.canvas,"onSwipe",e.moveCB),o.removeEvent(e.viewer.canvas,"onRelease",e.endCB)}}})})),define("Magnifier/Magnifier",["DS/Magnifier/Magnifier","DS/DSMigration/DSMigration"],(function(e,i){return i.deprecateModule("Magnifier/Magnifier"),e}));