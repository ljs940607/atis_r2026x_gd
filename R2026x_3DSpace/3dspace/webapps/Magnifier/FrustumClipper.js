define("DS/Magnifier/FrustumClipper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager"],(function(e,t,i){"use strict";var s=Object.freeze({Near:0,NearFar:1,Far:2}),n=Object.freeze({KeyCode:{Q:81,S:83,D:68,C:67,R:82},Type:{Down:1,Up:0}}),r=Object.freeze({Value:1,Type:{Forward:1,Backward:-1}});return e.extend({defaultOptions:Object.freeze({clippingMode:s.NearFar,clippingStep:4,animationTime:1e3}),init:function(e){this._viewpoint=e.viewpoint,this._visuEventTokens=[],this._clippingOptions={mode:this.defaultOptions.clippingMode,step:this.defaultOptions.clippingStep},this._backup={near:this._viewpoint.camera.near,far:this._viewpoint.camera.far},this._clippingFrustum={near:this._viewpoint.camera.near,far:this._viewpoint.camera.far};let t={_state:0,_shiftKey:!1,setPress:function(e,t){this._state=e,this._shiftKey=t},isPressed:function(){return this._state},shiftPressed:function(){return this._shiftKey}};this._store={q_key:Object.create(t),s_key:Object.create(t),d_key:Object.create(t),c_key:Object.create(t),r_key:Object.create(t),flush:function(){this.q_key.setPress(0,!1),this.s_key.setPress(0,!1),this.d_key.setPress(0,!1),this.c_key.setPress(0,!1),this.r_key.setPress(0,!1)}},this._clippingNavigator={_list:[],push:function(e){this._list.push(e)},pop:function(){return this._list.pop()},isEmpty:function(){return 0===this._list.length},flush:function(){this._list=[]}},this._enable()},dispose:function(){this._disable()},getActive:function(){return this.active},setOptions:function(e){e&&this._applyOptions(e)},getClippingFrustum:function(){return Object.assign({},this._clippingFrustum)},_applyOptions:function(e){this._clippingOptions.mode="number"==typeof e.clippingMode?e.clippingMode:this.defaultOptions.clippingMode},_subscribe:function(){this._visuEventTokens.push(i.addEvent(this._viewpoint.viewer.canvas,"onKeyDown",this._onKeyDownCB.bind(this))),this._visuEventTokens.push(i.addEvent(this._viewpoint.viewer.canvas,"onKeyUp",this._onKeyUpCB.bind(this))),this._visuEventTokens.push(i.addEvent(this._viewpoint.viewer.canvas,"onMouseWheel",this._onMouseWheelCB.bind(this)))},_unsubscribe:function(){this._visuEventTokens.length>0&&this._visuEventTokens.forEach((e=>{i.removeEventFromToken(e)}))},_enable:function(){this._subscribe(),this._setBackup(),this.active=!0,this._doSnap({position:{xPix:this._viewpoint.viewer.SCREEN_WIDTH/2,yPix:this._viewpoint.viewer.SCREEN_HEIGHT/2}},!1),this._viewpoint.viewer.render()},_setBackup:function(){this._backup.near=this._viewpoint.camera.near,this._backup.far=this._viewpoint.camera.far},_restoreBackup:function(){this._applyFrustum({near:this._backup.near,far:this._backup.far}),this._clippingNavigator.flush()},_disable:function(){this._unsubscribe(),this._restoreBackup(),this.active=!1,this._viewpoint.viewer.render()},_onKeyDownCB:function(e){e.gesture&&e.gesture.currentEvent&&e.gesture.currentEvent.length>0&&this._onKeyEvent(e.gesture.currentEvent[0].event,n.Type.Down)},_onKeyUpCB:function(e){e.gesture&&e.gesture.currentEvent&&e.gesture.currentEvent.length>0&&this._onKeyEvent(e.gesture.currentEvent[0].event,n.Type.Up),this._flushKeyEvents()},_onKeyEvent:function(e,t){e&&e.code&&(e.keyCode===n.KeyCode.Q?this._store.q_key.setPress(t,e.shiftKey):e.keyCode===n.KeyCode.S?this._store.s_key.setPress(t,e.shiftKey):e.keyCode===n.KeyCode.D?this._store.d_key.setPress(t,e.shiftKey):e.keyCode===n.KeyCode.C?this._store.c_key.setPress(t,e.shiftKey):e.keyCode===n.KeyCode.R&&t===n.Type.Up&&(this._store.d_key.setPress(t,e.shiftKey),this._restoreBackup()))},_flushKeyEvents:function(){this._store.flush()},_onMouseWheelCB:function(e){if(e.from&&e.from.length){let t=e.from[0];if(t&&t.event){let e=t.event;e.wheelDeltaY&&0!==e.wheelDeltaY&&this._onWheelEvent({position:{xPix:e.clientX,yPix:e.clientY},value:r.Value,direction:e.wheelDeltaY>0?r.Type.Forward:r.Type.Backward})}}},_onWheelEvent:function(e){this._store.q_key.isPressed()&&this._updateStep(e),(this._store.s_key.isPressed()||this._store.c_key.isPressed())&&this._updateCapture(e),this._store.d_key.isPressed()&&this._updateNearFar(e)},_updateStep:function(e){e.direction===r.Type.Forward?this._clippingOptions.step+=e.value:e.direction===r.Type.Backward&&this._clippingOptions.step-e.value>=this.defaultOptions.clippingStep?this._clippingOptions.step-=e.value:e.direction===r.Type.Backward&&this._clippingOptions.step-e.value<this.defaultOptions.clippingStep&&(this._clippingOptions.step=this.defaultOptions.clippingStep)},_updateCapture:function(e){e.direction===r.Type.Forward?this._pushCapture(e):e.direction===r.Type.Backward&&this._popCapture()},_pushRecord:function(e){let t={near:this._clippingFrustum.near,far:this._clippingFrustum.far};if(e&&e.captureViewpoint){let e={upDir:this._viewpoint.getUpDirection(),sightDir:this._viewpoint.getSightDirection().clone(),eyePos:this._viewpoint.getEyePosition(),targetDist:this._viewpoint.getTargetDistance()};Object.assign(t,{vp:e})}this._clippingNavigator.push(t)},_popRecord:function(e){if(this._clippingNavigator.isEmpty())return;let t=this._clippingNavigator.pop();t&&(this._applyFrustum({near:t.near,far:t.far}),t.vp&&this._viewpoint.moveTo({eyePosition:t.vp.eyePos,upDirection:t.vp.upDir,sightDirection:t.vp.sightDir,distanceToTarget:t.vp.targetDist,duration:this.defaultOptions.animationTime}))},_pushCapture:function(e){this._store.c_key.isPressed()?this._pushRecord({captureViewpoint:this._store.c_key.shiftPressed()}):this._store.s_key.isPressed()&&this._doSnap(Object.assign(e,{captureViewpoint:this._store.s_key.shiftPressed()}))},_popCapture:function(e){this._popRecord()},_doSnap:function(e,t=!0){let i;t&&this._clippingNavigator.isEmpty()&&this._pushRecord(),i=e.position;let s=this._viewpoint.viewer.pick(i,"mesh",!0);if(s.path.length){let i=this._viewpoint.position.distanceTo(s.position)-this._viewpoint.camera.near;this._applyFrustum({delta:i}),t&&this._pushRecord(e)}},_applyFrustum:function(e){switch(this._clippingOptions.mode){case s.Near:this._clippingFrustum.near="number"==typeof e.delta?this._viewpoint.camera.near+e.delta:"number"==typeof e.near?e.near:this._clippingFrustum.near;break;case s.NearFar:this._clippingFrustum.near="number"==typeof e.delta?this._viewpoint.camera.near+e.delta:"number"==typeof e.near?e.near:this._clippingFrustum.near,this._clippingFrustum.far="number"==typeof e.delta?this._viewpoint.camera.far+e.delta:"number"==typeof e.far?e.far:this._clippingFrustum.far;break;case s.Far:this._clippingFrustum.far="number"==typeof e.delta?this._viewpoint.camera.far+e.delta:"number"==typeof e.far?e.far:this._clippingFrustum.far}},_updateNearFar:function(e){let t=e.value*e.direction*this._clippingOptions.step;this._applyFrustum({delta:t})}})})),define("Magnifier/FrustumClipper",["DS/Magnifier/FrustumClipper","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Magnifier/FrustumClipper"),e}));