define("DS/MPFMiniCartComponent/MiniCartComponent",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Button","DS/PlatformAPI/PlatformAPI","DS/MPFClickAndBuyComponent/ClickAndBuyCartHelper","DS/MPFClickAndBuyComponent/ClickAndBuyStateMachine","DS/MPFTracker/Tracker","DS/MPFTracker/Category","DS/MPFTracker/Dimension","DS/MPFCartModel/CartModelHelper","i18n!DS/MPFMiniCartComponent/assets/nls/MiniCartComponent","css!DS/MPFMiniCartComponent/MPFMiniCartComponent.css"],((t,e,r,a,s,n,i,o,c,C,h)=>{"use strict";const l=Object.freeze({BUTTON_CLICKED:"buttonClicked"}),m=Object.freeze({VIEW_CART:"ViewCart"}),d=e.extend({className:"mpf-mini-cart-component",setup(t={}){this.service=t.service,this.cart=t.cart,this.hideInterval=null,this._hideOnOrder(),a.subscribe(s.Events.MpfCartUpdated,(t=>{this.render(t.nbItems)}))},render(t){return this.container.setContent(this._createCartDiv(t)),this},destroy(){this._parent(),this.hideInterval&&window.clearInterval(this.hideInterval),this.container=null,this.cart=null},refresh(){this.cart.fetchPromise().then(this.render.bind(this))},isDisplayed(){const t=window.location.pathname;return!(t.contains("/"+n.PageToUrlMap.get(n.Pages.CART))||t.contains("/"+n.PageToUrlMap.get(n.Pages.CHECKOUT))||t.contains("/"+n.PageToUrlMap.get(n.Pages.PAYMENT_RESULT)))},_hideOnOrder(){this.hideInterval&&window.clearInterval(this.hideInterval),this.hideInterval=setInterval((()=>{this.isDisplayed()?(document.querySelector(".mpf-mini-cart-component").classList.remove("mpf-hide"),this._adaptCompassCss(!1)):(document.querySelector(".mpf-mini-cart-component").classList.add("mpf-hide"),this._adaptCompassCss(!0))}),600)},_adaptCompassCss(t){const e=document.getElementsByClassName("content-overlay");Array.prototype.forEach.call(e,(e=>{t?e.addClassName("mpf-expand"):e.removeClassName("mpf-expand")}))},_createCartDiv(e){const r=this._createViewCartButton(),a=t.is(e)?e:this._getNbItemsInCart();return t.createElement("div",{class:"mpf-div-mini-cart",html:[{tag:"span",class:"fonticon fonticon-shopping-cart mpf-grey"},{tag:"p",text:h.get("items",{itemCount:a}),class:"mpf-items"},r]})},_createViewCartButton(){return new r({value:h.get("viewCart"),className:"primary",events:{onClick:()=>{const t=i.createEventBuilder({category:o.MINI_CART,action:m.VIEW_CART}).addDimension(c.MARKETPLACE_SERVICE,this.service);C.addTrackerInformation(t,this.cart),t.send(),this.dispatchEvent(l.BUTTON_CLICKED)}}})},_getNbItemsInCart(){const t=[];return this.cart.getItems().filter((e=>{let r=!0;const a=e.getOfferId();return a&&(t.includes(a)?r=!1:t.push(a)),r})).reduce(((t,e)=>t+=parseInt(e.getQuantity())),0)}});return d.Events=l,d})),define("DS/MPFMiniCartComponent/MiniCartComponentFactory",["UWA/Class","UWA/Promise","DS/MPFUtils/StorageUtils","DS/MPFServices/MarketplaceServices","DS/MPFConnector/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartFilters","DS/MPFMiniCartComponent/MiniCartComponent","DS/MPFUtils/MPFUtils"],((t,e,r,a,s,n,i,o,c,C,h)=>{"use strict";const l=t.extend({init(){this.lastCartV2sync=0},_adaptCompassCss(){const t=document.getElementsByClassName("content-overlay");Array.prototype.forEach.call(t,(t=>{t.addClassName("mpf-expand")}))},createComponent(t={}){return t.service||(t.service=a.CLICK_AND_BUY),this._getData(t).then((()=>this._createMiniCartComponent(t)))},hasItems(t){return this._adaptCompassCss(),this._getData(t).then((()=>this.cart.getItems().length>0))},_getData(t={}){return t.service||(t.service=a.CLICK_AND_BUY),s.fetchPromise(t).then(this._getFactories.bind(this)).then(this._getCart.bind(this,t))},_getFactories(t){const r=n.getInstance(t);return e.all([r.getFactory(n.Types.CART)]).then((t=>{this.cartFactory=t[0]}))},_getCart({service:t}){const e=this._getCartFormLocalStorage({service:t});return e?(this.cart=e,this.cart):this._getMeCartsV2().then((()=>this.carts.isEmpty()?this._createCart():(this.cart=this.carts.first(),this.cart.dataProxy=this.cartFactory.getDataProxy(i.Types.CART),this.cart.fetchPromise({expand:[o.Expands.CART_ITEMS]}))))},_getCartFormLocalStorage({service:t}){let e;return r.hasStoredCart(t)&&(e=this.cartFactory.createModel(i.Types.ME),r.loadStoredCart(t,e)),e},_getMeCartsV2(){const t={};t[c.FILTER_BY_STATE]=c.STATE_DRAFT,this.carts||(this.carts=this.cartFactory.createCollection(i.Types.ME_V2));const r=Date.now();return r-this.lastCartV2sync>5e3?(this.lastCartV2sync=r,this.carts.fetchPromise(t)):e.cast(this.carts)},_createCart(){return this.cart=this.cartFactory.createModel(i.Types.ME),this.cart},_createMiniCartComponent(t={}){return t.cart=this.cart,new C(t)}});let m;return l.getMiniCartComponent=function(t){return m||(m=new l(t)),m.createComponent()},l.hasItems=function(t){return m||(m=new l(t)),m.hasItems()},l}));