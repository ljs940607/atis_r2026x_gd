define("DS/CAT3DExpModelAVP/managers/CAT3DXAVPComManager",["UWA/Core","UWA/Class"],(function(e,t){"use strict";const a=0,r=1;return t.extend({GetType:function(){return"CAT3DXAVPComManager"},Build:function(){window.CAT3DXAVPComManager=this.GetObject(),this._webCommandId=0,this._webCommandsDeferred={},this._commandsFromSwift={}},isAVPEnabled:function(){return!!window.webkit},sendCommandToSwift:async function(t,r){r=r||"{}";const n=this._generateWebCommandId(),i={type:a,id:n,command:t,parameters:JSON.stringify(r)};return window?.webkit?.messageHandlers?.DSXMCom?.postMessage(JSON.stringify(i)),this._webCommandsDeferred[n]=e.Promise.deferred(),this._webCommandsDeferred[n].promise},registerCommandFromSwift:function(e,t){this._commandsFromSwift[e]?console.error("CAT3DXAVPComManager.registerCommandFromSwift fail, command already exist"):this._commandsFromSwift[e]=t},unregisterCommandFromSwift:function(e){delete this._commandsFromSwift[e]},_onReceiveAnswerFromSwift:function(e){const t=e.id,a=JSON.parse(e.answer);this._webCommandsDeferred[t]?(this._webCommandsDeferred[t].resolve(a),delete this._webCommandsDeferred[t]):console.error("CAT3DXAVPComManager._onReceiveAnswerFromSwift fail, cant retrieve caller")},_onReceiveCommandFromSwift:function(e){this._launchCommandFromSwift(e)},_launchCommandFromSwift:async function(e){const t=e.id,a=e.command,r=JSON.parse(e.parameters);if(!this._commandsFromSwift[a])return void console.error("CommandFromSwift fail. Cant retrieve command : "+a);const n=await this._commandsFromSwift[a](r);this._sendAnswerToSwift(t,n)},_sendAnswerToSwift:function(e,t){t=t||"{}";const a={type:r,id:e,answer:JSON.stringify(t)};window.webkit.messageHandlers.DSXMCom.postMessage(JSON.stringify(a))},_generateWebCommandId:function(){return this._webCommandId++,this._webCommandId}})})),define("DS/CAT3DExpModelAVP/extensions/CATE3DXAVPExpModel",["UWA/Core","UWA/Class","UWA/Class/Listener","DS/CAT3DExpModel/interfaces/CATI3DExperienceObject"],(function(e,t,a,r){"use strict";return e.Class.extend(a,{Build:function(){if(!this.GetObject()._experienceBase.getManager("CAT3DXAVPComManager").isAVPEnabled())return;this.GetObject()._experienceBase.getManager("CAT3DXAVPExpModelManager").addExpObject(this.GetObject());const e=this.QueryInterface("CATI3DExperienceObject");this.listenTo(e,"VARIABLE_CHANGED",this._updateVariable);e.ListVariables(null,r.VarType.Object).forEach((t=>{const a=e.GetValueByName(t);a&&(Array.isArray(a)?a.forEach((e=>e.QueryInterface("CATI3DXAVPExpModel"))):a.QueryInterface("CATI3DXAVPExpModel"))}))},Dispose:function(){this.stopListening(),this.GetObject()._experienceBase.getManager("CAT3DXAVPExpModelManager").removeExpObject(this.GetObject())},_updateVariable:function(e){this.GetObject()._experienceBase.getManager("CAT3DXAVPExpModelManager").updateVariable(this.GetObject(),e);const t=this.QueryInterface("CATI3DExperienceObject"),a=t.GetVariableInfo(e);if(r.VarType.Object===a.type&&r.ValuationMode.AggregatingValue===a.ValuationMode){const a=t.GetValueByName(e);a&&(Array.isArray(a)?a.forEach((e=>e.QueryInterface("CATI3DXAVPExpModel"))):a.QueryInterface("CATI3DXAVPExpModel"))}}})})),define("DS/CAT3DExpModelAVP/managers/CAT3DXAVPExpModelManager",["UWA/Core","UWA/Class","DS/CAT3DExpModel/interfaces/CATI3DExperienceObject"],(function(e,t,a){"use strict";return e.Class.extend({GetType:function(){return"CAT3DXAVPExpModelManager"},Build:function(){this._addExpObjects=[],this._removeExpObjects=[],this._variablesUpdates={},this._debugRecordFrameRate=!1,this._experienceBase.getManager("CAT3DXAVPComManager").registerCommandFromSwift("SetRecordWebFrameRate",(e=>{this._debugRecordFrameRate=e}))},_update:function(e){const t=this._experienceBase.getManager("CAT3DXAVPComManager");if(!t||!t.isAVPEnabled())return;const a=Object.keys(this._variablesUpdates);if(0!==this._addExpObjects.length||0!==a.length||0!==this._removeExpObjects.length){const e={addExpObjects:this._addExpObjects,removeExpObjects:this._removeExpObjects,variablesUpdates:a.map((e=>({pathOfIds:e,variablesToUpdate:[...this._variablesUpdates[e].variablesToUpdate].map((t=>{const a=this._variablesUpdates[e].expObject.QueryInterface("CATI3DExperienceObject"),r=a.GetVariableInfo(t),n=a.GetValueByName(t);return{name:t,value:JSON.stringify(this._writeVariableValue(n,r))}}))})))};this._experienceBase.getManager("CAT3DXAVPComManager").sendCommandToSwift("UpdateExpModel",e)}this._addExpObjects=[],this._removeExpObjects=[],this._variablesUpdates={},this._debugRecordFrameRate&&this._experienceBase.getManager("CAT3DXAVPComManager").sendCommandToSwift("UpdateWebFrameRate",e.deltaTime)},addExpObject:function(e){const t=e.QueryInterface("CATI3DExperienceObject"),a=t.ListVariables(),r={pathOfIds:e.GetID(),types:e.GetTypes(),variables:a.map((e=>this._writeVariableDescription(t,e)))},n=t._GetAsset();n&&(r.asset={linkDescription:n.linkDescription,cache:JSON.stringify(n.cache),status:n.status}),this._addExpObjects.push(r)},removeExpObject:function(e){const t=e.GetID();this._removeExpObjects.push(t),this._variablesUpdates[t]&&delete this._variablesUpdates[t]},updateVariable:function(e,t){const a=e.GetID();this._variablesUpdates[a]||(this._variablesUpdates[a]={expObject:e,variablesToUpdate:new Set}),this._variablesUpdates[a].variablesToUpdate.add(t)},_writeVariableDescription:function(e,t){const r=e.GetVariableInfo(t);let n=e.GetValueByName(t),i=this._writeVariableValue(n,r);return{name:t,type:r.type,isArray:1!==r.maxNumberOfValues,isAggregating:r.valuationMode===a.ValuationMode.AggregatingValue,value:JSON.stringify(i)}},_writeVariableValue:function(e,t){return t.type===a.VarType.Color?this._writeVariableValueColor(e,t):t.type===a.VarType.Object?this._writeVariableValueObject(e,t):e},_writeVariableValueColor:function(e,t){if(1===t.maxNumberOfValues){if(!e)return;const t=e.GetThreeColor();return{r:t.r,g:t.g,b:t.b}}return e.map((e=>{const t=e.GetThreeColor();return{r:t.r,g:t.g,b:t.b}}))},_writeVariableValueObject:function(e,t){if(1===t.maxNumberOfValues){if(!e)return;return e.GetID()}const a=[];return e.forEach((e=>{e.QueryInterface("CATI3DXAVPExpModel")&&a.push(e.GetID())})),a}})})),define("DS/CAT3DExpModelAVP/interfaces/CATI3DXAVPExpModel",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATI3DXAVPExpModel",required:{},optional:{}})})),define("DS/CAT3DExpModelAVP/managers/W3AACAT3DXAVPExpModelManager",["UWA/Core","DS/WebApplicationBase/W3AAManager"],(function(e,t){"use strict";return e.Class.extend(t,{getUpdatePriority:function(){return 1},update:function(e){this.GetObject()._update(e)}})})),define("DS/CAT3DExpModelAVP/managers/XCTEWSEExperienceAVPExpModelManager",["UWA/Core","UWA/Class"],(function(e,t){"use strict";return t.extend({onExperienceReady:function(e){e.QueryInterface("CATI3DXAVPExpModel")},onPreDisposeExperience:function(){}})}));