define("DS/DELWebViewerProxyManagerV2/ProxyManager",["DS/ApplicationFrame/CommandsManager","DS/DELWebViewerPerformaceLogger/PerformaceLogger","DS/DELWebViewerUtils/Utils","DS/DELWebViewerUtils/DELWebViewerSettingsMgt","DS/DELWebViewerUtils/CustomCodesV2","DS/DELWebViewerControllerV2/Utils/DataParser","DS/DELWebViewerCommon/DELCommonUtils"],(function(e,t,r,n,i,o,a){"use strict";return function(r,l,u,s){var c=s.getOption("logger"),d=s.getOption("executionContext"),g=r.getInstance("BuildUpBehavior"),h=s.getOption("eventCollection").getViewerCtrlEventHnd(),f=r.getInstance("WorkInstructionBehavior"),p=r.getInstance("PartFabricationBehavior"),w=l.getHideShowBehavior(),P=function(e,t,r){var n={};return n.input=e||{},r?n.error=i.getError(r):n.output=t?UWA.is(t,"array")?t:[t]:[],n},m=s.getOption("mappingKeys"),v="process";return{addRoots:function(t){let r=this;return c.debug("ProxyManager::addRoots method invoked with parameters : ",t),new UWA.Promise((async function(n,i){var o=[];t.objects.forEach((function(e){o.push(new UWA.Promise((function(t){var r=l.subscribe("onRootAdded",(function(n){n&&n.idPath&&UWA.Array.equals(n.idPath,e.path)&&(l.unSubscribe(r),t())}))})))})),UWA.Promise.all(o).then((function(r){if(!!UWA.is(t.fitAll,"boolean")&&t.fitAll)if(d){let e=d.getComponent(WAfrStandardComponentKey.HandlerComponent);e&&e.hasHandler("VisuReframeViewCmd")&&e.executeHandler({id:"VisuReframeViewCmd"})}else{let t=e.getCommand("VisuReframeView");t?t.beginExecute():c.log("Reframe Command is not available, unable to do reframe")}n(P(t,r))})).fail((function(e){i(P(t,null,e))}));let u=!UWA.is(t.reframe,"boolean")||t.reframe;l.setAutomaticReframePolicy(u),l.changeGraphCondition&&(l.changeGraphCondition(!!UWA.is(t.outofScope,"boolean")&&t.outofScope),r.updateOptions({partFabrication:t.outofScope}));let s=[],g=[];if(t.objects.forEach((e=>{e.publicFilterSpec?s.push(e):g.push(e)})),s.length>0){let e=l.getENOPADBIProxy();if(e)for(let r of s){let n=UWA.is(r.path,"array")?r.path[0]:null;if(n){let t={rootID:n,specification:r.publicFilterSpec.publicSpec,applyFilter:1,displayFilter:0};e.removeRoot(n),await a.setPublicFilterSpecification({proxy:e,publicFilterSpec:t})}else c.warn("Root ID not available to apply filter",t)}else c.error("Cannot add the Root with filter as Enopad proxy is not available")}g.length>0&&l.addRoots({objects:g},t.dispatch,t.displayNotif)}))},setProcess:function(e){var t=this,r=e?Object.assign({},e):{},n=[],i=!!e.defaultShow,a=e.outofScope,d=function(){let o=function(){let e=[];["noDependecy","successors"].forEach((t=>{let n=r[t];Array.isArray(n)&&n.forEach((t=>{e.push({path:t,[m.GRAPHICPROPERTIES.VISIBILITY]:!1,[m.GRAPHICPROPERTIES.VISIBILITYFREE]:!0})}))})),e.length>0&&l.setGraphicProperties({graphicProperties:e},m.SCENEGRAPHKEYS.PRIVATE).then(l.render)},c=function(){let r=!UWA.is(e.reframe,"boolean")||e.reframe;var i=[];return n.forEach((e=>{l.isRegistered([e[0]])||i.push({path:e})})),i.length>0?t.addRoots({objects:i,reframe:!1,fitAll:r,outofScope:a}):UWA.Promise.resolve()};return(d=UWA.Promise.resolve(),Array.isArray(r.installPath)&&r.installPath.length>0&&(d=u.getInstallContext(r).then((function(e){Object.assign(r,e)}))),d).then((function(){let e,t=Array.isArray(r.installPath)?r.installPath:[],i=t.length>0?t.slice(0,1):UWA.is(r.mfgId)?[r.mfgId]:[];return i.length>0?(n.push(i),r.resourceId&&n.push([r.resourceId]),e=n):e=UWA.Promise.reject(s.getNLSValue("Error.InvalidInput.Message")),e})).then((()=>UWA.Promise.all([o(),new UWA.Promise((function(e,t){i?e():l.setGraphicProperties({graphicProperties:n.map((e=>({path:e,visibility:!1})))},m.SCENEGRAPHKEYS.BUILDUP).then((function(){l.render(),e()})).fail(t)})),c()])));var d},h=function(){u.getDataManager().set(v,o.getInitializeBuildupOptions(r))},f=function(){return new UWA.Promise((function(t,n){s.getOption("viewerType")<=0?n(P(e,null,s.getNLSValue("Error.InvalidViewerType.Message"))):(c.warn("ProxyManager::setProcess is deprecated, use setProcessV2"),c.debug("ProxyManager::setProcess method invoked with parameters : ",e),c.info(`********** SetProcess Started (process-${JSON.stringify(r)}) **************`),r.processId?(h(),UWA.Promise.all([d(),g.initializeBuildup(o.getInitializeBuildupOptions(r))]).then((function(){h(),c.info(`********** SetProcess Completed (process-${JSON.stringify(r)} **************`),t(P(e))})).fail((function(t){c.error("setProcess failed due to -",t),n(P(e,null,t))}))):n(P(e,null,s.getNLSValue("Error.InvalidInput.Message"))))}))};return f()},setProcessV2:async function(e){if(s.getOption("viewerType")<=0)throw new Error(P(s,null,s.getNLSValue("Error.InvalidViewerType.Message")));let t=this,r=e?Object.assign({},e):{},n=!UWA.is(e.defaultShow,"boolean")||e.defaultShow,i=!!UWA.is(e.scopedMfg,"array")&&e.scopedMfg.some((e=>!0===e.outofScope)),a=function(){u.getDataManager().set(v,{...r,version:"V2"})},d=function(){let a=[],s=[],c=function(){let e=[];["noDependecy","successors"].forEach((t=>{let n=r[t];Array.isArray(n)&&n.forEach((t=>{e.push({path:t,[m.GRAPHICPROPERTIES.VISIBILITY]:!1,[m.GRAPHICPROPERTIES.VISIBILITYFREE]:!0})}))})),e.length>0&&l.setGraphicProperties({graphicProperties:e},m.SCENEGRAPHKEYS.PRIVATE).then(l.render)},d=function(){let r=!UWA.is(e.reframe,"boolean")||e.reframe;var n=[];return a.forEach((t=>{l.isRegistered([t[0]])||n.push({path:t,publicFilterSpec:o.getPublicFilterSpec(e,t[0])})})),n.length>0?t.addRoots({objects:n,reframe:!1,fitAll:r,outofScope:i}):UWA.Promise.resolve()};return(g=UWA.Promise.resolve(),s=UWA.is(e.scopedMfg,"array")?e.scopedMfg.filter((e=>UWA.is(e.occurrence,"array")&&e.occurrence.length>1)).map((e=>e.occurrence)):[],Array.isArray(s)&&s.length>0&&(g=u.getInstallContextV2({installPaths:s}).then((function(e){Object.assign(r,e)}))),g).then((function(){if(s.length>0)a=a.concat(s.map((e=>e.slice(0,1))));else{let t=UWA.is(e.scopedMfg,"array")?e.scopedMfg.map((e=>[e.id])):[];a=a.concat(t)}UWA.is(e.resource,"array")&&e.resource.length>0&&(a=a.concat(e.resource.map((e=>[e.id])))),a=Array.from(new Set(a.map((e=>JSON.stringify(e))))).map((e=>JSON.parse(e)))})).then((()=>UWA.Promise.all([c(),new UWA.Promise((function(e,t){n?e():l.setGraphicProperties({graphicProperties:a.map((e=>({path:e,visibility:!1})))},m.SCENEGRAPHKEYS.BUILDUP).then((function(){l.render(),e()})).fail(t)})),d()])));var g};c.debug("ProxyManager::setProcessV2 method invoked with parameters : ",s),c.info(`********** SetProcessV2 Started (process-${JSON.stringify(r)}) **************`);try{if(e.id)return a(),await UWA.Promise.all([d(),g.initializeBuildup(r)]),a(),c.info(`********** SetProcessV2 Completed (process-${JSON.stringify(r)} **************`),P(e);throw new Error(P(e,null,s.getNLSValue("Error.InvalidInput.Message")))}catch(t){throw c.error("setProcessV2 failed due to -",t),new Error(P(e,null,t))}},initializeBuildup:function(e){return c.warn("ProxyManager :: initializeBuildup is deprecated, use initializeBuildupV2"),new UWA.Promise((function(t,r){g?g.initializeBuildup(o.getInitializeBuildupOptions(e)).then((function(){t(P(e))})).catch((function(t){r(P(e,null,t))})):r(P(e,null,s.getNLSValue("Error.BuildUpCntrlNotInit.Message")))}))},initializeBuildupV2:function(e){return new UWA.Promise((function(t,r){g?g.initializeBuildup(e).then((function(){t(P(e))})).catch((function(t){r(P(e,null,t))})):r(P(e,null,s.getNLSValue("Error.BuildUpCntrlNotInit.Message")))}))},empty:function(){let e=!(!arguments[0]||!UWA.is(arguments[0].filterUpdated,"boolean"))&&arguments[0].filterUpdated;return new UWA.Promise((function(t,n){l.removeRoots({pids:[],filterUpdated:e}).then((function(){r.reset(),u.reset(),l.resetGraphicProperties(),l.resetCameraOrientation(),l.render(),t(P())})).fail((function(e){c.error("empty failed due to -",e),n(P(null,null,e))}))}))},refresh:function(){var e,t=arguments[0];return 1!==s.getOption("viewerType")&&2!==s.getOption("viewerType")||(e=u.getDataManager().get(v)),r.reset(),l.refresh(),t?UWA.Promise.resolve(P()):e?this.setProcessV2(e):UWA.Promise.resolve(P())},removeRoots:function(e){return c.debug("ProxyManager::removeRoots method invoked with parameters : ",e),new UWA.Promise((function(t,r){l.removeRoots(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("removeRoots failed due to -",t),r(P(e,null,t))}))}))},setOperation:function(e){return c.debug("ProxyManager::setOperation event invoked with parameters : ",e),new UWA.Promise((function(t,r){g?(f&&l.getMode()===m.VIEWERMODES.WORKINSTRUCTIONS&&f.clean(),g.applyBuildUp(e).then((function(r){c.info("setOperation completed for given operation -",e),t(P(e,r))})).fail((function(t){c.error("setOperation failed due to -",t),r(P(e,null,t))}))):r(s.getNLSValue("Error.BuildUpCntrlNotInit.Message"))}))},removeBuildUp:function(){return c.warn("removeBuildUp is deprecated, please use remove operation instead"),new UWA.Promise((function(e){g.removeBuildUp(),e()}))},removeOperation:async function(){g&&g.removeBuildUp(),f&&await f.reset()},setMode:function(e){return c.debug("ProxyManager::setMode method invoked with parameters : ",e),new UWA.Promise((function(t,r){var n,i=l.getMode()===m.VIEWERMODES.WORKINSTRUCTIONS,o=s.getOption("eventCollection").getViewerCtrlEventHnd();if(UWA.is(e,"object")&&e.mode){switch(e.mode){case m.VIEWERMODES.WORKINSTRUCTIONS:!i&&function(){let e=!1;return g&&(e=g.isBuildUpApplied()),e}()&&(f?f.show():(c.error("WorkInstruction Behavior is not available, check whether proper viewer type is provided during initialization"),n=s.getNLSValue("Error.WorkInstModeNotActive.Message")));break;case m.VIEWERMODES.BUILDUP:i&&f&&f.reset(),g&&g.applyCurrentBuildUp();break;default:n=s.getNLSValue("Error.InvalidViewerMode.Message")}n?r(P(e,null,n)):(s.setOption(m.OPTIONS.VIEWERMODE,e.mode),o.publish(o.events.onSetModeComplete,{mode:e.mode}),t(P(e)))}else r(P(e,null,s.getNLSValue("Error.InvalidInput.Message")))}))},getMode:function(){return l.getMode()},getViewerModes:function(){return m.VIEWERMODES},getBuildUpGlobalSettings:async function(e){let t,r=u.getInstance("BuildUpBehaviorModelService");try{if(!r)throw new Error(s.getNLSValue("Error.BuildUpCntrlNotInit.Message"));t=P(e,r.getBuildUpGlobalSettings(e))}catch(t){throw new Error(P(e,null,t))}return t},setBuildUpGlobalSettings:async function(e){let t,r=u.getInstance("BuildUpBehaviorModelService");try{if(!r)throw new Error(s.getNLSValue("Error.BuildUpCntrlNotInit.Message"));t=!0===e.isWKI?P(e,await this.applyBuildupSettings(e)):P(e,r.setBuildUpGlobalSettings(e))}catch(t){throw new Error(P(e,null,t))}return t},applyBuildupSettings:async function(e){let t;try{if(!g)throw new Error(s.getNLSValue("Error.BuildUpCntrlNotInit.Message"));t=P(e,await g.applyBuildupSettings(e.settings))}catch(t){throw new Error(P(e,null,t))}return t},getBuildUpGlobalContent:async function(e){let t;try{if(!g)throw new Error(s.getNLSValue("Error.BuildUpCntrlNotInit.Message"));t=P(e,await g.getBuildUpGlobalContent(e))}catch(t){throw new Error(P(e,null,t))}return t},selectNode:function(e){return e=e||{},c.debug("ProxyManager::selectNode event invoked with parameters : ",e),new UWA.Promise((function(t,r){l.selectNode(UWA.merge(e,{select:!0})).then((function(r){t(P(e,r))})).fail((function(t){c.error("Select Node failed due to : ",t),r(P(e,null,t))}))}))},unSelectNode:function(e){return e=e||{},c.debug("ProxyManager::unSelectNode event invoked with parameters : ",e),new UWA.Promise((function(t,r){l.selectNode(UWA.merge(e,{select:!1})).then((function(r){t(P(e,r))})).fail((function(t){c.error("ProxyManager:: Unselect Node failed due to : ",t),r(P(e,null,t))}))}))},highlightNode:function(e){return e=e?UWA.merge(e,{highlight:!0}):{},c.debug("ProxyManager::highlightNode API invoked with parameters : ",e),new UWA.Promise((function(t,r){h.publish(h.events.highlightNode,e),l.highlightNode(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("Highlight Node failed due to : ",t),r(P(e,null,t))}))}))},unHighlightNode:function(e){return e=e?UWA.merge(e,{highlight:!1}):{},c.debug("ProxyManager::unHighlightNode API invoked with parameters : ",e),new UWA.Promise((function(t,r){h.publish(h.events.unHighlightNode,e),l.highlightNode(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("Unhighlight Node failed due to : ",t),r(P(e,null,t))}))}))},preHighlightNode:function(e){return e=e||{},c.debug("ProxyManager::preHighlightNode API invoked with parameters : ",e),new UWA.Promise((function(t,r){l.preHighlightNode(UWA.merge(e,{highlight:!0})).then((function(r){t(P(e,r))})).fail((function(t){c.error("PreHighlight Node failed due to : ",t),r(P(e,null,t))}))}))},unPreHighlightNode:function(e){return e=e||{},c.debug("ProxyManager::unPreHighlightNode API invoked with parameters : ",e),new UWA.Promise((function(t,r){l.preHighlightNode(UWA.merge(e,{highlight:!1})).then((function(r){t(P(e,r))})).fail((function(t){c.error("UnPreHighlight Node failed due to : ",t),r(P(e,null,t))}))}))},setGraphicProperties:function(e){return c.debug("ProxyManager::setGraphicProperties method invoked with parameters :",e),new UWA.Promise((function(r,n){t.markStart("DELWebViewerSetGraphicProperties");let i=e||{};i.force=!0,l.setGraphicProperties(i,m.SCENEGRAPHKEYS.PUBLIC).then((function(n){l.render(),t.markEnd("DELWebViewerSetGraphicProperties","Time taken to setGraphicProperties "),r(P(e,n))})).fail((function(t){c.error("setGraphicProperties failed due to : ",t),n(P(e,null,t))}))}))},removeGraphicProperties:function(e){return c.debug("ProxyManager::removeGraphicProperties method invoked with parameters : ",e),new UWA.Promise((function(t,r){l.removeGraphicProperties(e,m.SCENEGRAPHKEYS.PUBLIC).then((function(r){l.render(),t(P(e,r))})).fail((function(t){c.error("removeGraphicProperties failed due to : ",t),r(P(e,null,t))}))}))},resetGraphicProperties:function(e){return new UWA.Promise((function(t){l.resetGraphicProperties(),(e=!UWA.is(e,"boolean")||e)&&l.render(),t(P({render:e}))}))},getGraphicPropertiesEnum:function(){return l.getGraphicPropertiesEnum()},setReframe:function(e){return c.debug("ProxyManager::setReframe method invoked with parameters : ",e),new UWA.Promise((function(t,r){l.setReframe(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("setReframe failed due to : ",t),r(P(e,null,t))}))}))},reframeOn:async function(e){let t;try{c.debug("ProxyManager::reframeOn method invoked with parameters : ",JSON.stringify(e)),t=await l.reframeOn(e),P(e,t)}catch(t){throw c.debug(`ProxyManager::reframeOn method failed due to ${JSON.stringify(t)}`),new Error(P(e,null,t))}},highlightLinkedViews:function(e){return c.warn("ProxyManager::highlightLinkedViews is deprecated use highlightWKIViews API"),new UWA.Promise((function(t,r){f?f.highlightLinkedViews(e).then((function(r){t(P(e,r))})).fail((function(t){r(P(e,null,t))})):(c.error("highlightLinkedViews failed due to WorkInstruction behavior not found"),r(P(e,null,s.getNLSValue("Error.WorkInstModeNotActive.Message"))))}))},setViewPoint:function(e){return c.debug("ProxyManager::setViewPoint event received with parameters :",e),new UWA.Promise((function(t,r){l.setViewPoint(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("setViewPoint failed due to ",t),r(P(e,null,t))}))}))},getCurrentView:function(){return c.debug("ProxyManager::getCurrentView method invoked"),new UWA.Promise((function(e,t){f?f.getCurrentView().then((function(t){e(P(null,t))})).fail((function(e){c.error("getCurrentView failed due to -",e),t(P(null,null,e))})):(c.error("getCurrentView failed due to WorkInstruction behavior not found"),t(P(null,null,s.getNLSValue("Error.WorkInstModeNotActive.Message"))))}))},getViewPoint:function(){return c.debug("ProxyManager::getViewPoint event received with parameters :"),new UWA.Promise((function(e,t){l.getViewPoint().then((function(t){e(P(null,t))})).fail((function(e){c.error("getViewPoint failed due to -",e),t(P(null,null,e))}))}))},setCurrentView:function(e){return c.debug("ProxyManager::setCurrentView method invoked with parameters : ",e),new UWA.Promise((function(t,r){f?f.setCurrentView(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("setCurrentView failed due to -",t),r(P(e,null,t))})):(c.error("setCurrentView failed due to WorkInstruction behavior not found"),r(P(e,null,s.getNLSValue("Error.WorkInstModeNotActive.Message"))))}))},getBoundingBox:function(e){return c.debug("ProxyManager::getBoundingBox event received with parameters :",e),new UWA.Promise((function(t,r){l.getBoundingBox(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("getBoundingBox failed due to -",t),r(P(e,null,t))}))}))},getPartPosition:function(e){return c.debug("ProxyManager::getPartPosition event received with parameters :",s),new UWA.Promise((function(t,r){g?g.getPartPosition(e).then((function(r){t(P(e,r))})).fail((function(t){c.error("getPartPosition failed due to -",t),r(P(e,null,t))})):r(P(e,null,s.getNLSValue("Error.BuildUpCntrlNotInit.Message")))}))},displayOrientationViewer:function(e){return c.debug("ProxyManager::displayOrientationViewer event received with parameters :",e),new UWA.Promise((function(t,r){l.displayOrientationViewer(e).then((function(r){t(P({toShow:e,data:r}))})).fail((function(t){c.error("displayOrientationViewer failed due to -",t),r(P({toShow:e},null,t))}))}))},search:function(e){c.debug("ProxyManager::search method invoked with parameters :",e),l.search(e)},updateOptions:function(e){if(c.debug("ProxyManager::updateOptions method invoked with parameters :",e),s.setOptions(e),e&&e.viewerOptions&&e.viewerOptions.delviewer&&e.viewerOptions.delviewer.run_options){let t=e.viewerOptions.delviewer.run_options;for(let e in t)Object.prototype.hasOwnProperty.call(t,e)&&n.setSetting(e,t[e].value)}else Object.keys(e).forEach((t=>{n.updateDELViewerSetting(t,e[t])}));h.publish(h.events.onUpdateOptions,{data:e})},notifyRootVisibilityChange:function(e,t){l.getContext().getController().notifyRootVisibilityChange(e,t)},loadFTA:async function(e){let t=r.getInstance("FTABehavior");if(!t)throw new Error(P(e,null,s.getNLSValue("Error.InvalidViewerType.Message")));return P(e,await t.loadFTA(e))},removeFTA:async function(e){let t=r.getInstance("FTABehavior");if(!t)throw new Error(P(e,null,s.getNLSValue("Error.InvalidViewerType.Message")));return P(e,await t.removeFTA(e))},hideNode:async function(e){try{let t=await w.hideNode(e);P(e,t)}catch(t){throw new Error(P(e,null,t))}},showNode:async function(e){try{let t=await w.showNode(e);P(e,t)}catch(t){throw new Error(P(e,null,t))}},toggleNodeVisibility:async function(e){try{let t=await w.toggleNodeVisibility(e);P(e,t)}catch(t){throw new Error(P(e,null,t))}},resetHideShow:function(){w.reset()},getRIRPathsLeadingToReference:function(e){return l.getIdPathesLeadingToReference(e)},getPublishedContent:async function(e){try{let t=await u.getInstance("WorkInstructionBehaviorModelService").getWKIContentPromise(e.path,e.content);return P(e,t)}catch(t){return P(e,null,t)}},highlightWKIViews:function(e){return c.debug("ProxyManager::highlightWKIViews method invoked with parameters : ",e),new UWA.Promise((function(t,r){f?f.highlightWKIViews(e).then((function(r){t(P(e,r))})).fail((function(t){r(P(e,null,t))})):(c.error("highlightWKIViews failed due to WorkInstruction behavior not found"),r(P(e,null,s.getNLSValue("Error.WorkInstModeNotActive.Message"))))}))},showMaterial:function(e){let t;return t=p?p.showMaterial(e):Promise.reject(P(e,null,s.getNLSValue("Error.MaterialFeatureNotFound.Message"))),t},hideMaterial:function(e){let t;return t=p?p.hideMaterial(e):Promise.reject(P(e,null,s.getNLSValue("Error.MaterialFeatureNotFound.Message"))),t},enrich3D:function(e){return l.getContext().getController().enrich3D(e)},destroy:function(){c=g=f=P=m=null}}}}));