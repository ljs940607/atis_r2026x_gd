define("DS/DMUCommands/DMU3DCompareCmd",["UWA/Utils","DS/DMUBaseCommands/EXPStateCommand","DS/DMUPlayCompare/DMUCompare3D","DS/DMUPlayCompare/DMUCompare2D","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/PADServices/utils/SearchUtils","DS/DMUControls/EXPNotify","DS/CATWebUXComponents/CATWebUXNotifBar","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUReadPersistence/DMUWebServicesUtils","i18n!DS/DMUCommands/assets/nls/DMUCommands"],(function(e,t,n,i,o,r,a,l,s,d,c,u,g,m,p,f,C){"use strict";return t.extend({init:function(t){var h="DMU2DCompareCmdHdr"===t.ID?"2D":"3D";this._parent(t,"exclusive",!0);let v,D,S=a.getContextViewer({viewer:this.getFrameWindow().getViewer()}),M=this;this.cancelExecute=function(){D&&D(),this.restoreDefaultController(),this.cancel()},this.destroy=function(){D&&D(),this.restoreDefaultController(),this.done()},this.buildGraph=function(){this.changeDefaultController();let t=a.giveEventsController({viewer:S.getViewer()});t&&t.fireEvent("onTransientCompareRemoved");let x,w,y,b,E,I,U,P,A,O,R,T,F,W,V,N,k,_,L=[],G=null,q=!1,B={},j={},X=r.createSceneGraphOverrideSet(M.getFrameWindow().getViewer()),H=!1,z=null,K=null;"2D"===h&&(k=l.getManager({name:"DMU2DSheetManager",context:S.getFrameWindow()}));let J=a.getReviewContext({viewer:M.getFrameWindow().getViewer()}),Y=!1;if(J&&J.getCurrentSessionMarkup()&&J.getCurrentSessionMarkup().isVisible()&&(Y=!0,J.getUIManager().setMarkupVisualizationActiveState(!1)),q=!1,U=J&&J.getReviewCtxInformation()?J.getReviewCtxInformation().contextId:null,S.getApplicativeData()&&S.getApplicativeData().getLoadedItfData&&S.getApplicativeData().getLoadedItfData()&&S.getApplicativeData().getLoadedItfData().data&&S.getApplicativeData().getLoadedItfData().data.length)U=S.getApplicativeData().getLoadedItfData().data[0].prd[0]?S.getApplicativeData().getLoadedItfData().data[0].prd[0]:U;else if(U){let e=S.getRootBagPath().getChildrenPathes();for(let t=0;t<e.length;t++){let n=r.getNodeID(e[t].getLastElement(!0));if(S.getController().isFiltered(n)&&U===S.getController().isFiltered(n).filterId){U=n;break}}}function Z(){N&&(N.removeAll(),N.destroy()),N=new c({className:"DMU3DCompareCommand"}).inject(M.getFrameWindow().getUIFrame());let e="3D"===h?C.notifySecondProduct:C.notifySecondDocument;N.add({msgType:"primary",message:e,closable:!1,buttons:[{className:"default",label:C.compareCancel,onClick:function(){M.publish({event:"DMU3DCompareCmdCancelled"})}}]}),M.getFrameWindow().getViewer().render()}function Q(){let e=r.getOverrides(X,{idPaths:[[b]]});e&&e.length&&e.forEach((e=>{e.setOpacity(.5),e.setPickability("IGNORED")})),Z()}function $(e,t,n){v&&(v.destroy(),v=null),v=new d({body:M.getFrameWindow().getUIFrame(),type:e,notificationType:n,message:t})}async function ee(e){try{let t=await f.getParentTypes(e);return[e].concat(t)}catch{return[e]}}function te(){let e=g.get(),t=[],n=[];e.forEach((e=>{e.pathElement.externalPath.length>2&&(t.push(e),n.push({pathElement:new m([e.pathElement.externalPath[0],e.pathElement.externalPath[1]])}))})),t.length&&g.remove(t),n.length&&g.add(n),M.getFrameWindow().getViewer().render()}async function ne(){if(J||(J=await o.createReviewContext({context:S})),!J)return;let t=J.getTransientReviewBag();if(!t)return;let a=x?t.getOccurence({pathElement:x},!0):y?t.getOccurence({idPath:[y]},!0):null,l=w?t.getOccurence({pathElement:w},!0):A?t.getOccurence({idPath:[A]},!0):null;if("ENOStrRefinementSpecification"===P){let e=S.getRootBagPath().getChildrenPathes();for(let n=0;n<e.length;n++){let i=r.getNodeID(e[n].getLastElement(!0));if(S.getController().isFiltered(i).hasFilter&&y===S.getController().isFiltered(i).filterId){t.getOccurence({idPath:[i]},!0);break}}}if("ENOStrRefinementSpecification"===O){let e=await S.getController().getPrdIdFromFilterId([A]);e&&t.getOccurence({idPath:[e]},!0)}if(l&&a&&l.id!==a.id&&("3D"===h||z&&K)){"2D"===h&&S.getViewpoint().reframe();let o="3D"===h?new n(M.getFrameWindow().getViewer(),t):new i(M.getFrameWindow().getViewer(),t);o.setAttributes([{name:"sID",value:t.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:t.computeNewName({object:o,prefix:h+"Compare"})},{name:"bVisible",value:!0},{name:"fBalance",value:50},{name:"bLocalAxis",value:!0},{name:"oSelections",value:[{id:a.id},{id:l.id}]}]),"2D"===h&&o.setAttributes([{name:"oSheetIDs",value:[{id:z||null},{id:K||null}]}]),t.addDMUObject(o),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","DMU3DCompare")})),o.fireEvent("onDMUObjectInitialized",{dmuObject:o}),M.publish({event:"DMU3DCompareCmdEvent"})}else l&&a&&l.id===a.id?M.publish({event:"DMU3DCompareSameObjError"}):M.publish({event:"DMU3DCompareCmdError"})}function ie(){if(y&&(E||I)){let e=!1;s.inAppsSearch({mode:"furtive",app_socket_id:"DMU3DCompareCmd",fts_value:E?"(logicalid:"+E+") AND NOT (physicalid:"+y+")":"(versionid:"+I+") AND NOT (physicalid:"+y+")",callback:async function(e){if(W&&clearTimeout(W),W=null,M.isRunning()&&e.length>=0){A=e[0].resourceid;let n="ENOStrRefinementSpecification"===P?await S.getController().getPrdIdFromFilterId([y]):y;if(A===y)return void M.publish({event:"DMU3DCompareSameObjError"});A?S.getController().getAttributes({ids:[A],attributes:["ds6w:type"],callbacks:{onComplete:async function(e){if(e){if(J||(J=await o.createReviewContext({context:S})),!J)return;let i=J.getTransientReviewBag();if(!i)return;O=e[A]&&e[A]["ds6w:type"];let l="ENOStrRefinementSpecification"===O?await S.getController().getPrdIdFromFilterId([A]):A;if(n!==l&&n!==A&&y!==l)if("2D"===h){if("Drawing"!==O&&"DIFLayout"!==O&&"DIFSheet"!==O){let e=await ee(O);e&&e.length&&-1!==e.indexOf("Drawing")&&(O="Drawing")}P===O||"DIFLayout"===P&&"DIFSheet"===O||"DIFSheet"===P&&"DIFLayout"===O?(i.fireEvent("onComparisonStarted",{is2DCompare:!0}),i.fireEvent("onDMUAdd2DCompareRoot",{compare2DSecondRoot:A,documentType:O}),t=a.giveEventsController({viewer:S.getViewer()}),R=t.addEvent("on2DDocumentLoadSuccess",(function(){t.removeEvent(R),R=null;let e=S.getRoots();if(k&&e.length>1){let e=k.getDocumentData(A);e&&e.sheetIDList&&e.sheetIDList.length?(-1!==e.sheetIDList.indexOf(z)?_=e.sheetIDList.indexOf(z):void 0!==_&&-1!==_&&_>=e.sheetIDList.length&&(_=0),K=e.sheetIDList[_],K||(K=A),K?ne():(A&&S.removeRoots({pids:[A]}),M.publish({event:"DMU3DCompareCmdError"}))):(A&&S.removeRoots({pids:[A]}),M.publish({event:"DMU3DCompareCmdError"}))}else A&&S.removeRoots({pids:[A]}),M.publish({event:"DMU3DCompareCmdError"})})),F=t.addEvent("onEmptyDocument",(function(){t.removeEvent(F),F=null;let e=S.getRoots(),n=[],i=!1;for(let t=0;t<e.length;t++)n.push(r.getNodeID(e[t]))===A&&(S.removeRoots({pids:[A]}),i=!0);i||(T=S.subscribe({event:"onRootAdded"},(function(){S.unsubscribe(T),T=null,setTimeout((function(){S.removeRoots({pids:[A]}),S.getViewpoint().reframe(),M.publish({event:"DMU3DCompareCmdError"})}))})))}))):M.publish({event:"DMU3DCompareCmdError"})}else ne();else M.publish({event:"DMU3DCompareSameObjError"})}else M.publish({event:"DMU3DCompareCmdError"})},onFailure:function(){v&&(v.destroy(),v=null),M.isRunning()&&(v=M.sendNotify("info",C.errorFetchingPrdData))}}}):M.publish({event:"DMU3DCompareCmdError"})}},cancel:function(){e?null!==W&&(W&&clearTimeout(W),W=setTimeout((()=>{M.publish({event:"DMU3DCompareCmdCancelled"}),W=null}),500)):e=!0}})}}function oe(){let e=u.get();if(e&&e.length&&r.isAModelPath(e[0].pathElement)){let t=r.getFirstReference(e[0].pathElement);b?(w=t,b===r.getNodeID(w.externalPath[0])?M.publish({event:"DMU3DCompareSameObjError"}):setTimeout(ne)):(x=t,y=r.getNodeID(x.externalPath[0]),b=y,E=V[y]?V[y].logicalid:null,I=V[y]?V[y].versionid:null,Q(),M.emptyCSO(),M.emptyHSO(),ie())}else M.publish({event:"DMU3DCompareCmdError"})}function re(){if(M.executionContext)M.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent).setCheckState({id:"ToggleLeftSidePanel",state:!0}).then((()=>{H=!0}));else{let e=p.getCommandCheckHeader("RootPanel",S.getCommandContext());e&&!e.getState()&&(e.setState(!0),H=!0)}}D=function(){if(M.emptyCSO(),M.emptyHSO(),M.getFrameWindow().getViewer().render(),H)if(M.executionContext)M.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent).setCheckState({id:"ToggleLeftSidePanel",state:!1});else{let e=p.getCommandCheckHeader("RootPanel",S.getCommandContext());e&&e.getState()&&e.setState(!1)}t&&(F&&(t.removeEvent(F),F=null),R&&(t.removeEvent(R),R=null)),S.unsubscribe(T),T=null,x=w=null,G&&G.destroy(),B&&B.onAdd&&u.unsubscribe(B.onAdd),j&&j.onAdd&&g.unsubscribe(j.onAdd),X&&r.removeSceneGraphOverrideSet(M.getFrameWindow().getViewer(),X),N&&(N.removeAll(),N.destroy()),N=null,B={},j={},U=y=A=E=I=G=null};let ae=this.createInitialState("initialState"),le=this.getFinalState();this.setEnterStateAction(ae,(function(){let e=S.getRoots();if(!e||!e.length)return void M.publish({event:"DMU3DCompareCmdError"});L=u.get();let t=[];if("3D"===h&&L.length){if(L[0].pathElement||(q=!0),!q){let e=r.getLastReference(L[0].pathElement);e&&U&&r.getNodeID(e.externalPath[1])!==U&&(q=!0)}if(q)return;{x=L[0].pathElement.clone();let e=r.getLastReference(x);e&&(y=r.getNodeID(e.getLastElement(!0))),y&&t.push(y)}}if(!t.length)for(let n=0;n<e.length;n++){let i=r.getNodeID(e[n]);S.getController().isFilterOpen((e=>{e&&e.filterAvailable&&S.getController().isFiltered(i).hasFilter&&(i=S.getController().isFiltered(i).filterId)})),i&&t.push(i)}t.length?(M.emptyCSO(),M.emptyHSO(),S.getController().getAttributes({ids:t,attributes:["ds6wg:revision","logicalid","versionid","ds6w:type"],callbacks:{onComplete:async function(e){if(V=e,V&&M.isRunning())if(!x&&t.length>1&&!U&&"3D"===h)N=new c({className:"DMU3DCompareCommand"}).inject(M.getFrameWindow().getUIFrame()),N.add({msgType:"primary",message:C.notifyFirstProduct,closable:!1,buttons:[{className:"default",label:C.compareCancel,onClick:function(){M.publish({event:"DMU3DCompareCmdCancelled"})}}]}),B.onAdd=u.onAdd(oe),j.onAdd=g.onAdd(te),re();else{if(y)"3D"===h&&x&&x.externalPath.length&&x.externalPath[1]&&(b=r.getNodeID(x.externalPath[1]));else{if(U)y=U;else{let e=r.getRootReferences(M.getFrameWindow().getViewer())[0];e&&(y=r.getNodeID(e)),S.getController().isFilterOpen((e=>{e&&e.filterAvailable&&S.getController().isFiltered(y).hasFilter&&(y=S.getController().isFiltered(y).filterId)}))}b=y,P=V[y]?V[y]["ds6w:type"]:null}if(k&&"2D"===h&&y){if(P=V[y]?V[y]["ds6w:type"]:null,"Drawing"!==P&&"DIFLayout"!==P&&"DIFSheet"!==P){let e=await ee(P);e&&e.length&&-1!==e.indexOf("Drawing")&&(P="Drawing")}if("Drawing"===P||"DIFLayout"===P||"DIFSheet"===P){let e=k.getDocumentData(y);e&&(z=e.activatedSheetID),z||(z=b),e&&e.sheetIDList&&(_=e.sheetIDList.indexOf(z))}}E=V[y]?V[y].logicalid:null,I=V[y]?V[y].versionid:null,"3D"===h?(B.onAdd=u.onAdd(oe),j.onAdd=g.onAdd(te),Q()):Z(),ie(),"3D"===h&&re()}},onFailure:function(){v&&(v.destroy(),v=null),M.isRunning()&&(v=M.sendNotify("info",C.errorFetchingPrdData))}}})):M.publish({event:"DMU3DCompareCmdError"})})),this.addTransition({iSender:this,iEvent:"DMU3DCompareCmdEvent",iInitialState:ae,iFinalState:le,iAction:function(e){D&&D(),this.restoreDefaultController(),e()}}),this.addTransition({iSender:this,iEvent:"DMU3DCompareCmdCancelled",iInitialState:ae,iFinalState:le,iAction:function(e){$("info",C.compareCancelled),J&&J.getCurrentSessionMarkup()&&Y&&J.getUIManager().setMarkupVisualizationActiveState(!0),M.emptyCSO(),M.emptyHSO(),D&&D(),this.restoreDefaultController(),e()}}),this.addTransition({iSender:this,iInitialState:ae,iFinalState:le,iCondition:function(){return q},iAction:function(e){$("error",C.notifyFirstProductError),J&&J.getCurrentSessionMarkup()&&Y&&J.getUIManager().setMarkupVisualizationActiveState(!0),M.emptyCSO(),M.emptyHSO(),D&&D(),this.restoreDefaultController(),e()}}),this.addTransition({iSender:this,iEvent:"DMU3DCompareSameObjError",iInitialState:ae,iFinalState:le,iAction:function(e){$("error",C.sameObjectsCompared),J&&J.getCurrentSessionMarkup()&&Y&&J.getUIManager().setMarkupVisualizationActiveState(!0),M.emptyCSO(),M.emptyHSO(),D&&D(),this.restoreDefaultController(),e()}}),this.addTransition({iSender:this,iEvent:"DMU3DCompareCmdError",iInitialState:ae,iFinalState:le,iAction:function(e){$("error",C.compareCmdFailed),J&&J.getCurrentSessionMarkup()&&Y&&J.getUIManager().setMarkupVisualizationActiveState(!0),M.emptyCSO(),M.emptyHSO(),D&&D(),this.restoreDefaultController(),e()}})}}})})),define("DS/DMUCommands/DMUColorOpacityOverloadCmd",["DS/CATWebUXComponents/DMUCommand","DS/DMUControls/EXPColorPicker","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager","DS/Visualization/ThreeJS_DS","i18n!DS/DMUCommands/assets/nls/DMUCommands"],(function(e,t,n,i,o,r){"use strict";return e.extend({init:function(e){e.mode="shared",this._parent(e)},beginExecute:function(e){this._parent(e);var a,l=i.getReviewContext({viewer:this.getFrameWindow().getViewer()}),s=l&&!l.isReadOnly()?l.getCurrentSessionMarkup():null;if(s&&!s.isReadOnly()){var d,c,u=n.get().slice(),g=[];for(d=0;d<u.length;d++)(c=s.getOrCreateOccurrenceOverloader(u[d]))?g.push({color:c.getAttribute("cColor"),opacity:c.getAttribute("fOpacity")}):g.push({color:null,opacity:null});var m,p,f,C=!0,h=!0;for(d=0;d<g.length;d++)h&&(void 0===m?m=g[d].color:(null!==m&&null!==g[d].color&&!m.equals(g[d].color)||null===m&&null!==g[d].color||null!==m&&null===g[d].color)&&(m=null,f=!1,h=!1)),C&&(void 0===p?p=g[d].opacity:p!==g[d].opacity&&(p=null,f=!1,C=!1));void 0===f&&(f=null===p&&null===m);var v=!1,D=i.giveEventsController({viewer:this.getFrameWindow().getViewer()});a||(a=new t({frameWindow:this.getFrameWindow(),onDestroyCB:function(){v&&D.fireEvent("onSaveRequested",{}),a=null,v=!1}})).build({displayColorSlider:!0,displayOpacitySlider:!0,displayResetButton:!0,defaultColor:m,onColorChangedCB:function(e){for(var t=[],n=0;n<u.length;n++)(c=s.getOrCreateOccurrenceOverloader(u[n],!0))&&(v=!0,c.setAttribute("cColor",new o.Color(e.color)),t.push({state:{cColor:new o.Color(e.color)},target:c}));t.length&&(D.fireEvent("onDMUOverloadPropertiesChanged",{overloads:t}),D.fireEvent("onSaveRequested",{}))},defaultOpacity:p,minOpacity:0,maxOpacity:1,onOpacityChangedCB:function(e){for(var t=[],n=0;n<u.length;n++)(c=s.getOrCreateOccurrenceOverloader(u[n],!0))&&(v=!0,c.setAttribute("fOpacity",e.opacity),t.push({state:{fOpacity:e.opacity},target:c}));t.length&&(D.fireEvent("onDMUOverloadPropertiesChanged",{overloads:t}),D.fireEvent("onSaveRequested",{}))},defaultResetState:f,resetButtonLabel:r.resetLabel,onResetButtonPressedCB:function(){for(var e=[],t=0;t<u.length;t++)(c=s.getOrCreateOccurrenceOverloader(u[t]))&&(v=!0,c.setAttribute("cColor",null),c.setAttribute("fOpacity",null),e.push({state:{cColor:null,fOpacity:null},target:c}));e.length&&(D.fireEvent("onDMUOverloadPropertiesChanged",{overloads:e}),D.fireEvent("onSaveRequested",{}))}})}this.cancel()}})})),define("DS/DMUCommands/DMUEditPropertiesCmd",["UWA/Class","DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager"],(function(e,t,n,i){"use strict";return e.extend(t,{init:function(e){e.mode="shared",e.isAsynchronous=!0,this._parent(e),this.beginExecute=function(){var t=this;let o=t.options.executionContext?t.options.executionContext.getComponent("Viewer").getViewer():t.getFrameWindow().getViewer();var r=n.getReviewContext({viewer:o});if(r){var a=r.getReviewCtxInformation(),l=i.get();let n;if(1===l.length&&l[0].pathElement.getLastElement(!0).getDMUType&&"DMUMarkup"===l[0].pathElement.getLastElement(!0).getDMUType()){let e=r.getValidation();e&&e.getMarkups().some((e=>{let t=e.getRepRef();if(t.getMarkupContent()&&t.getMarkupContent().getNode()===l[0].pathElement.getLastElement(!0))return n=e.getPlmID(),!0}))}var s=this._objectId?this._objectId:n||a.reviewId;if(s){require(["DS/PADUtils/PADSettingsMgt"],(function(n){t.launchProperties({options:e,getSecurityContext:function(){return{SecurityContext:n.getSetting("pad_security_ctx"),tenant:n.getSetting("x3dPlatformId")}},getSelectedNodes:function(){return[{id:s,getID:function(){return this.id},source:"3DSpace",tenant:n.getSetting("x3dPlatformId")}]}}),t.cancel(),t._objectId=void 0})),t.done()}else t.done()}else t.done()}},setObject:function(e){this._objectId=e}})})),define("DS/DMUCommands/DMURemoveAllcmd",["DS/CATWebUXComponents/DMUCommand","DS/DMUBaseExperience/DMUContextManager"],(function(e,t){"use strict";return e.extend({init:function(e){e.mode="shared",e.repeatMode=!1,e.isAsynchronous=!0,this._parent(e);let n=(e.frameWindow||this.getFrameWindow()).getViewer();this.beginExecute=()=>{const e=t.getContextViewer({viewer:n});t.getReviewContext({context:e})&&t.removeReviewContext({context:e}),this.done()}}})})),define("DS/DMUCommands/DMUGenerateTICCmd",["DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/FrameWindowsManager","DS/CATWebUXTIC/CATWebUXTICCmdAdapt","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/Selection/CSOManager","DS/DMUMeasurable/DMUToolsSceneGraph","UWA/Core","DS/Windows/Dialog","DS/Controls/Button","i18n!DS/DMUCommands/assets/nls/DMUCommands","DS/DMUReadPersistence/DMULoadingContextController","DS/Visualization/PathElement","DS/DMUBaseUIControllers/DMUCommentsController"],(function(e,t,n,i,o,r,a,l,s,d,c,u,g){"use strict";var m=n.extend({init:function(n){let m=n.executionContext?n.executionContext.getComponent("Viewer").getFrameWindow().getViewer():t.getFrameWindow(n.context).getViewer();var p=e.getContextViewer({viewer:m}),f=[];function C(e,t){var n=require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx"),i=require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/fetch/v2?SecurityContext="+n+"&tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId(),o={physicalid:e,label:"DMUFetchForMarkerVisualization-",select_predicate:["ds6w:type"],select_file:[]};require("DS/WAFData/WAFData").authenticatedRequest(i,{data:JSON.stringify(o),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":require("DS/PADUtils/PADSettingsMgt").getSetting("lang"),SecurityContext:n},timeout:6e4,onComplete:function(e){var n=e?JSON.parse(e):null;t(n)},onFailure:function(){t([])},onTimeout:function(){t([])}})}function h(){var e=[];return o.get().forEach((function(t){for(var n=0;t.pathElement,n<t.pathElement.getLength();n++){var i=t.pathElement.getElement(n);i&&"function"==typeof i.getDMUType&&"DMUValidationExposedPresentation"===i.getDMUType()&&e.push(i)}})),e}function v(e){let t;if("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId)if("ENOR3R_AP"===window.widget.data.appId)t=e.getValidation().getName();else{var n=h();t=n.length>0?n[0].getOwner().getName():e.getValidation().getName()}else t=e.getReviewCtxInformation().reviewName;return t}function D(e){var t=[];if("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId){var n=h();if(n.length>0&&"ENOR3V_AP"===window.widget.data.appId)for(var i=0;i<n.length;i++){var o=n[i].getOwner();t.push(o.getPlmID());var r=o.getAssociatedCheck(),a=e.getValidation().getChecks();for(let e=0;e<r.length;e++)for(let n=0;n<a.length;n++)if(r[e]===a[n].getPlmID()){let e=a[n].getJsonRequirements();if(e.length){const n=t=>t===e[0].getPlmID();e.length&&t.findIndex(n)<0&&t.push(e[0].getPlmID())}}}else t.push(e.getValidation().getPlmID())}else t.push(e.getReviewCtxInformation().reviewId);return t}function S(e,t){return new Promise((function(n){var i=e.pathElement;if(!i)return n();(function(e){return new Promise((function(t){var n={path:e,typeIFC:!1};if(!1===require("DS/PADUtils/PADSettingsMgt").getSetting("activateSGI"))return t(n);for(var i=[],o=[],r=e.externalPath.length,a=e.externalPath,l=1;l<r;l++)a[l].modelIdentification&&i.push(a[l].modelIdentification);if(0===i.length)return t(n);C(i,function(e,r){if(r&&r.results&&r.results.length>0){if(r.results.forEach((function(e){e.attributes&&e.attributes.forEach((function(e){"resourceid"===e.name&&o.push(e.value)}))})),o.length===i.length)return t(n);var a=e.externalPath.length,l=e.externalPath;n.path=new u,n.typeIFC=!0;for(var s=0;s<a;s++){let t=l[s].modelIdentification;if(null!==t&&!o.find((e=>e===t)))break;n.path.addElement(e.getElement(s))}return t(n)}}.bind(this,e))}))})(i).then((function(e){if(e&&e.path){let o=e.path,a=e.path;for("Issue"===t&&e.typeIFC&&(a=i);a&&!r.isReference(a.getLastElement());)a=a.getParentPath();a&&n({ifcPathElement:a.getLastElement(),validPathElement:o.getLastElement()})}n()}))}))}function M(e,t){return new Promise((n=>{var a=p.getController().getRootStats(e.getReviewCtxInformation().subContext&&e.getReviewCtxInformation().subContext.id?e.getReviewCtxInformation().subContext.id:e.getReviewCtxInformation().contextId),l=[],s=a&&a.serviceId?a.serviceId:"3DSpace";const d=[];f=[],o.get().forEach((function(e){d.push(S(e,t))})),Promise.all(d).then((function(a){if(a.forEach((function(e){if("object"==typeof e&&Object.keys(e).length>0){var n=r.getNodeID(e.ifcPathElement);if(l||(l=[]),!0===require("DS/PADUtils/PADSettingsMgt").getSetting("activateSGI")){if("CA"!==t){let t=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),n=t.getNodeI3DX(e.ifcPathElement);!l.some((e=>e.physicalId===n))&&n&&l.push({physicalId:n,serviceId:s,objectType:t.getNodeType(e.ifcPathElement)}),f.push(r.getNodeID(e.validPathElement))}}else"CA"===t?-1===l.indexOf(n)&&l.push(n):l.some((e=>e.physicalId===n))||l.push({physicalId:n,serviceId:s,objectType:r.getNodeType(e.ifcPathElement)})}})),!l.length&&("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId))for(var d=e.getValidation().getValidated().getPathElements(),c=0;c<d.length;c++)if(d[c]&&d[c].pathElement.length)if("CA"===t)"Change Action"!==d[c].referenceType&&l.push(d[c].pathElement[d[c].pathElement.length-1]);else{var u=p.getController().getNode({id:d[c].pathElement[d[c].pathElement.length-1]});l.push({physicalId:d[c].pathElement[d[c].pathElement.length-1],serviceId:s,objectType:r.getNodeType(u)})}if(!l.length){var m=[];m=function(e){var t=[],n=h();if(n.length)for(var o=0;o<n.length;o++){var r=n[o].getOwner().getHighlightObject().slideId;if(r){var a,l=g.giveDMUCommentsController({context:p.getFrameWindow()});if(l&&(a=l.getTargetedObject(r)),a)t.push(a);else{var s=i.giveDMUApplicativeContextManager({context:p});s&&s.getApplicativeContainersTICInfo(e,(function(e){if(e.length)return e[0].attachments?e[0].attachments:void 0}))}}}return t}(t),0===h().length&&0===m.length&&(m=function(e,t){var n=[];return o.get().forEach((function(o){var r,a=t.getDMUObjectFromPathElement(o.pathElement),l=g.giveDMUCommentsController({context:p.getFrameWindow()});if(l&&a&&(r=l.getTargetedObject(a.getAttribute("sUuid"))),r)n.push(r);else{var s=i.giveDMUApplicativeContextManager({context:p});s&&s.getApplicativeContainersTICInfo(e,(function(e){if(e.length)return e[0].attachments?e[0].attachments:void 0}))}})),n}(t,e)),m&&m.forEach((function(e){l.push({physicalId:e,serviceId:s,objectType:r.getNodeType(p.getController().getNode({id:e}))})}))}n(l)}))}))}function x(e,t,n){return new Promise((function(i){if("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId)if("ENOR3V_AP"===window.widget.data.appId&&(0===e.getValidation().getHighlights().length||h().length>0||o.get().length>0))i(t);else if("ENOR3R_AP"===window.widget.data.appId&&(0===e.getValidation().getHighlights().length||0===h().length&&(e.getValidation().getValidated().getPathElements().length>0||o.get().length!==(m=[],o.get().forEach((function(e){for(var t=0;e.pathElement,t<e.pathElement.getLength();t++){var n=e.pathElement.getElement(t);n&&"function"==typeof n.getDMUType&&"DMUSlide"===n.getDMUType()&&m.push(n)}})),m).length)))i(t);else{var r,c,u=a.createElement("div");"Issue"===n.cmdType||"IssueTemplate"===n.cmdType?(r=d.issueOnReview,c=d.issueTitle):"Task"===n.cmdType?(r=d.taskOnReview,c=d.taskTitle):(r=d.caOnReview,c=d.caTitle),a.createElement("label",{text:r,styles:{"margin-bottom":"0px",padding:"10px 0px"}}).inject(u);var g=new l({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:c,immersiveFrame:p.getFrameWindow().getImmersiveFrame(),content:u,closeButtonFlag:!0,buttons:{Ok:new s({label:d.yes,onClick:function(){g.destroy(),i(t)}}),Cancel:new s({label:d.no,emphasize:"primary",onClick:function(){g.destroy(),t.status="ticCancel",i(t)}})}});g.addEventListener("close",(function(){g.destroy(),i()}))}else t.fromIssue=e.getReviewCtxInformation().fromIssue,i(t);var m})).then((function(e){e?n.onComplete(e):n.onCancel()}))}n.pad3DViewer=p,this._parent(n),this.getParameters=function(t){var n=e.getReviewContext({context:p}),o=n.getReviewCtxInformation(),l=p.getController().getRootStats(o.subContext&&o.subContext.id?o.subContext.id:o.contextId),s=l&&l.serviceId?l.serviceId:"3DSpace";if(!o||o.reviewId){var d=i.giveDMUApplicativeContextManager({context:p});d&&d.getApplicativeContainersTICInfo(t.cmdType,(function(i){if(i.length)if(i[0]&&i[0].status&&"ticCancel"===i[0].status)t.onCancel();else{if(c.getLoadingContextController({context:p}).getLoadedWorkplanInformations()&&(i[0].title=v(n)),i[0].attachments)D(n).forEach((e=>{i[0].attachments.push(e)}));i[0].fromIssue=o.fromIssue,i[0].serviceID=s,t.onComplete(i[0])}else{var l={reportedAgainst:[],contexts:[],assignees:[],attachments:[]};l.title=v(n),l.priority=function(e){let t="Low";if("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId){if("ENOR3R_AP"===window.widget.data.appId)return t;var n=h();if(n.length>0&&n[0].getOwner()){var i=parseInt(n[0].getOwner().getRating());3===i&&(t="Medium"),"CA"===e.cmdType||"Task"===e.cmdType?4!==i&&6!==i||(t="High"):4===i?t="High":6===i&&(t="Urgent")}}return t}(t),l.attachments=D(n),l.serviceID=s,M(n,t.cmdType).then((i=>{var o,s,d;l.reportedAgainst=i,l.attachments.length&&(l.onComplete=function(t){e.giveEventsController({viewer:p.getViewer()}).fireEvent("onTICCreationComplete",t)},l.onClose=function(t){e.giveEventsController({viewer:p.getViewer()}).fireEvent("onTICCreationCancel",t)}),(o=n,s=t.cmdType,d="ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId?{ids:o.getValidation().getContext().getSubContextID()?[o.getValidation().getContext().getSubContextID()]:[o.getValidation().getContext().getMainContextID()],type:o.getValidation().getContext().getSubContextType()?o.getValidation().getContext().getSubContextType():o.getValidation().getContext().getMainContextType()}:{ids:[o.getReviewCtxInformation().subContext&&o.getReviewCtxInformation().subContext.id?o.getReviewCtxInformation().subContext.id:o.getReviewCtxInformation().contextId],type:o.getReviewCtxInformation().subContext&&o.getReviewCtxInformation().subContext.type?o.getReviewCtxInformation().subContext.type:o.getReviewCtxInformation().contextType},new Promise((e=>{if("CA"===s)void 0===d.type?C(d.ids,(function(t){t&&t.results&&t.results.length&&t.results[0].attributes&&t.results[0].attributes.length>=2&&"ENOStrRefinementSpecification"===t.results[0].attributes[1].value?p.getController().getPrdIdFromFilterId(d.ids).then((function(t){e([t])})):e(d.ids)})):"ENOStrRefinementSpecification"===d.type?p.getController().getPrdIdFromFilterId(d.ids).then((function(t){e([t])})):e(d.ids);else{var t=[],n=p.getController().getRootStats(o.getReviewCtxInformation().subContext&&o.getReviewCtxInformation().subContext.id?o.getReviewCtxInformation().subContext.id:o.getReviewCtxInformation().contextId),i=n&&n.serviceId?n.serviceId:"3DSpace";d.ids.forEach((function(e){t.push({physicalId:e,serviceId:i,objectType:r.getNodeType(p.getController().getNode({id:e}))})})),e(t)}}))).then((e=>{if(e)if(0===l.reportedAgainst.length&&(l.reportedAgainst=e),l.contexts=e,"R2V_Activity"===c.getLoadingContextController({context:p}).getLoadMarkupCtxType()){var i="CA"===t.cmdType?l.contexts:l.contexts.map((e=>e.physicalId));l.description=function(e,t){let n;return new Promise(((i,o)=>{var r=require("DS/PADUtils/PADUtilsServices").getPlatformURL("r2vsurvey"),a=require("DS/PADUtils/PADSettingsMgt").getSetting("lang");require("DS/WAFData/WAFData").authenticatedRequest(r+"/enovia/resources/r2v/v1/modeler/featurestate/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":a},data:JSON.stringify({ids:t}),timeout:6e4,onComplete:function(t){let o=JSON.parse(t);if("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId){var r=h(),a=e.getValidation().getContext();r.length>0&&r[0].getOwner()&&r[0].getOwner().getDescription&&"ENOR3V_AP"===window.widget.data.appId?(n=r[0].getOwner().getDescription(),n||(n=a.getSubContextName()?a.getSubContextName():a.getMainContextName())):n=void 0!==e.getReviewCtxInformation().reviewDescription?e.getReviewCtxInformation().reviewDescription:a.getSubContextName()?a.getSubContextName():a.getMainContextName()}else n=void 0!==e.getReviewCtxInformation().reviewDescription?e.getReviewCtxInformation().reviewDescription:o.result[0]["ds6w:label"];i(n)},onFailure:o,onTimeout:o})}))}(n,i).then((e=>{l.description=e,l.reportedAgainst=l.contexts=[],x(n,l,t)}))}else{var o="CA"===t.cmdType?l.reportedAgainst:l.reportedAgainst.map((e=>e.physicalId));(function(e,t){return new Promise((function(n){let i,o=a.clone(t);if("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId){var r=e.getValidation().getContext().getSubContextType()?e.getValidation().getContext().getSubContextType():e.getValidation().getContext().getMainContextType();"DesignSight"!==r&&"MSR"!==r||o.push(e.getValidation().getPlmID()),new Promise((function(e){p.getController().getAttributes({ids:o,attributes:["owner","ds6w:description"],callbacks:{onComplete:t=>e(t),onFailure:()=>e}})})).then((function(t){var o=h(),r=e.getValidation().getContext();o.length>0&&o[0].getOwner()&&o[0].getOwner().getDescription&&"ENOR3V_AP"===window.widget.data.appId?(i=o[0].getOwner().getDescription(),i||(i=r.getSubContextName()?r.getSubContextName():r.getMainContextName())):(t&&t[e.getValidation().getPlmID()]&&(i=t[e.getValidation().getPlmID()]["ds6w:description"]),i||(i=r.getSubContextName()?r.getSubContextName():r.getMainContextName())),n(i)}))}else{var l=e.getReviewCtxInformation();if(i=l.reviewDescription?l.reviewDescription:"",i)n(i);else{let e,o=[],r=l.subContext&&l.subContext.id?l.subContext.id:l.contextId;o.push(l.subContext&&l.subContext.id?l.subContext.id:l.contextId);let a=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),s=a.getRoots(p).map((function(e){return a.getNodeID(e)}));-1===s.indexOf(r)&&s.some((function(t){var n=p.getController().isFiltered(t);if(n&&n.hasFilter&&n.filterId===r)return o.push(e=t)})),new Promise((function(n){p.getController().getAttributes({ids:[].concat(t,o),attributes:["ds6w:label"],callbacks:{onComplete:function(t){i||(t[r]&&(i=t[r]["ds6w:label"]),e&&t[e]&&(i+=" ("+t[e]["ds6w:label"]+")")),n(i)},onFailure:()=>n}})})).then((function(e){n(e)}))}}}))})(n,Array.isArray(f)&&f.length>0?f:o).then((e=>{"Task"===t.cmdType&&(l.contexts=l.contexts.filter((e=>"DIFLayout"!==e.objectType&&"DIFSheet"!==e.objectType)),l.reportedAgainst=l.reportedAgainst.filter((e=>""!==e.physicalId&&"DIFLayout"!==e.objectType&&"DIFSheet"!==e.objectType&&"DIFView"!==e.objectType&&"DesignSight"!==e.objectType))),l.description=e,function(e,t,n){return new Promise((function(i){if("ENOR3V_AP"===window.widget.data.appId||"ENOR3R_AP"===window.widget.data.appId){var o=e.getValidation().getContext().getSubContextType()?e.getValidation().getContext().getSubContextType():e.getValidation().getContext().getMainContextType(),r=a.clone(t);"DesignSight"!==o&&"MSR"!==o||r.push(e.getValidation().getPlmID()),new Promise((function(e){p.getController().getAttributes({ids:r,attributes:["owner","ds6w:description"],callbacks:{onComplete:t=>e(t),onFailure:()=>e}})})).then((function(e){for(var o=0;o<t.length;o++)e&&e[t[o]]&&e[t[o]].owner&&-1===n.indexOf(e[t[o]].owner)&&n.push(e[t[o]].owner);i()}))}else{let o=[];o.push(e.getReviewCtxInformation().subContext&&e.getReviewCtxInformation().subContext.id?e.getReviewCtxInformation().subContext.id:e.getReviewCtxInformation().contextId),new Promise((function(e){p.getController().getAttributes({ids:[].concat(t,o),attributes:["ds6w:responsibleuid"],callbacks:{onComplete:function(i){t.forEach((e=>{if(i[e]){let t=i[e]["ds6w:responsibleuid"];t&&(n||(n=[]),-1===n.indexOf(t)&&n.push(t))}})),e()},onFailure:()=>e}})})).then((function(){i()}))}}))}(n,Array.isArray(f)&&f.length>0?f:o,l.assignees).then((()=>{x(n,l,t)}))}))}}))}))}}))}else t.onFailure("No Markup is available")},this._destroy=function(){var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)}}});return m})),define("DS/DMUCommands/DMUNormalViewCmd",["DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseCommands/EXPToolsWUX","DS/DMUMeasurable/DMUToolsMaths","DS/DMUBaseExperience/EXPToolsVisualization","i18n!DS/DMUCommands/assets/nls/DMUCommands"],(function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,this._applyViewpoint,o.normalViewTargetLabel,{engWithPSOHSO:!0,multiAcquisition:!1,multiAcquisitionCtrl:!1,valuedFromCSO:!0,pickingMode:"primHybrid",prePickingMode:"primHybrid"},!0)},beginExecute:function(){t.emptyCSO(),t.emptyHSO(),this._parent(),this.done()},cancelExecute:function(){this._parent()},_applyViewpoint:function(e){var o=e[0].normal,r=e[0].position;if(null!=o&&null!=r){var a=i.getViewpointInfo(this.getFrameWindow().getViewer().currentViewpoint),l=o.angleTo(a.sight);l>Math.PI/2&&l<Math.PI/2*3&&o.negate();var s=n.computeTransformationBetweenTwoLines(a.position,a.sight,r,o);i.moveViewpoint({freeZoneSize:this.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect(),viewerSize:{width:this.getFrameWindow().getViewer().SCREEN_WIDTH,height:this.getFrameWindow().getViewer().SCREEN_HEIGHT},viewpoint:this.getFrameWindow().getViewer().currentViewpoint,target:a.position.applyMatrix4(s.transformation),sightDirection:a.sight.transformDirection(s.transformation),upDirection:a.up.transformDirection(s.transformation),targetDistance:a.distance,duration:400})}t.emptyCSO()}})})),define("DS/DMUCommands/DMUSelectionFilterUI",["require","exports","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/WebappsUtils/WebappsUtils","DS/Visualization/PathElement","DS/CoreEvents/ModelEvents","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DUtils/CATC3DAxisSystemDisplayAgent","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUCommands/assets/nls/DMUCommands"],(function(e,t,n,i,o,r,a,l,s,d,c){"use strict";return class{constructor(e){let t,u=this,g=e.context.getFrameWindow(),m=e.context.getFrameWindow().getViewer(),p=new r,f=i.getWebappsAssetUrl("DMUMeasure","icons/32/"),C={none:1,point:0,center:0,axisSystem:0,line:1,plane:1,cylinder:1,product:0},h=new l({context:e.context}),v=function(){C={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,product:0},t.getActiveState("point")&&(C.none=0,C.point=1),t.getActiveState("center")&&(C.none=0,C.center=1),t.getActiveState("axisSystem")&&(C.none=0,C.axisSystem=1),t.getActiveState("line")&&(C.none=0,C.line=1),t.getActiveState("plane")&&(C.none=0,C.plane=1),t.getActiveState("cylinder")&&(C.none=0,C.cylinder=1),t.getActiveState("product")&&(C.none=0,C.product=1);let e="1-"+C.point+C.center+C.axisSystem+C.line+C.plane+C.cylinder+C.product+"-1";localStorage.setItem("C3DSelectionFilter",e),p.publish({event:"UpdateFilter",data:{filters:C}}),C.axisSystem?h.activate():h.deactivate()};t||(t=new n({body:g.getUIFrame(),frmWindow:g,Idpanel:"SnapSelectionFilter",classpanel:"SnapSelectionFilter",typeSeparator:"bubble",verticalPanel:!0,lJsonElement:[{type:"element",id:"point",nls:c.point,url:f+"I_Meas_Point.png",callback:v,bexclude:!1,bstateActif:C.point},{type:"element",id:"center",nls:c.center,url:f+"I_Meas_PointCircle.png",callback:v,bexclude:!1,bstateActif:C.center},{type:"element",id:"axisSystem",nls:c.axisSystem,url:f+"I_Meas_Axis.png",callback:v,bexclude:!1,bstateActif:C.axisSystem},{type:"element",id:"line",nls:c.line,url:f+"I_Meas_Line.png",callback:v,bexclude:!1,bstateActif:C.line},{type:"element",id:"plane",nls:c.plane,url:f+"I_Meas_Plane.png",callback:v,bexclude:!1,bstateActif:C.plane},{type:"element",id:"cylinder",nls:c.cylinder,url:f+"I_Meas_Cylinder.png",callback:v,bexclude:!1,bstateActif:C.cylinder},{type:"element",id:"product",nls:c.product,url:f+"I_Meas_Product.png",callback:v,bexclude:!1,bstateActif:C.product}]})),t&&(t.build(),t.setVisibleFlag(!0)),this.filterPath=function(e){if(!e||!e.pathElement||!e.pathElement.externalPath.length)return e;if(C.axisSystem||C.point||C.center||C.line||C.plane||C.cylinder){let t=a.getEquivalentGeometry({pathElement:e.pathElement,viewer:m,nonCanonicGeometry:!1}),n=t?t.getType():null;if(C.axisSystem&&n===s.GeometryType.AXISSYSTEM)return e.originalPathElement=e.pathElement,e.pathElement=t.getPathElement(),e.equivalentGeometry=t,e;if(C.point&&n===s.GeometryType.POINT||C.center&&(n===s.GeometryType.CIRCLE||n===s.GeometryType.SPHERE)||C.line&&n===s.GeometryType.LINE||C.plane&&(n===s.GeometryType.PLANE||n===s.GeometryType.REFPLANE)||C.cylinder&&(n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE))return e.equivalentGeometry=t,e}return C.product?function(e){let t=e.pathElement;return e.pathElement=new o,t.externalPath.some((function(t){return e.pathElement.addElement(t),t&&d.is3DLeaf(t)})),t.internalPath.length>0&&(e.originalPathElement=t),e}(e):(e.originalPathElement=e.pathElement,e.pathElement=null,e)},this.subscribe=function(e,t){let n;return"UpdateFilter"===e&&(n=p.subscribe({event:e},t)),n},this.unsubscribe=function(e){p.unsubscribe(e)},this.getActivatedFilter=function(){return C},this.activate=function(){m.setPicking({primitive:1,trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),m.setPrePicking({primitive:1}),C.axisSystem&&h.activate()},this.deactivate=function(){m.setPicking(!1),m.setPrePicking({primitive:!0}),h.deactivate()},this.unreference=function(){u.deactivate(),t&&t.clear(),t=h=null}}}})),define("DS/DMUCommands/DMUPositionOverloadCmd",["DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/DMUCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/Selection/CSOManager","DS/CoreEvents/Events","DS/CATW3DBoxes/CATW3DBoxController","DS/CATW3DRobot/CATW3DRobot","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DCommands/CATW3DMoveBarUX","DS/CATW3DCommands/CATW3DLevelSelectorCmd","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/DMUCommands/assets/nls/DMUCommands"],(function(e,t,n,i,o,r,a,l,s,d,c,u,g,m,p,f,C){"use strict";return t.extend({init:function(t){this._parent(t,{mode:"exclusive",isAsynchronous:!0});var h,v,D,S,M,x,w,y,b=this,E=!1,I=[],U={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},P={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3};let A,O=t.executionContext;var R,T;function F(){E=!1,b.endCommand(),O?b.done():b.cancel()}function W(){E=!0,b.endCommand(),O?b.done():b.cancel()}function V(e){"Enter"!==e.key&&13!==e.keyCode||!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey&&W()}function N(t){var i,o=n.getReviewContext({viewer:b.getFrameWindow().getViewer()}),r=o&&!o.isReadOnly()?o.getCurrentSessionMarkup():null,a=[];if(t&&t.objectsMoved&&t.objectsMoved.length&&r){for(var l=0;l<t.objectsMoved.length;l++)if(i=r.getOrCreateOccurrenceOverloader(t.objectsMoved[l],!0)){var s=i.getOccurrencePathElement(),d=s?s.getParentPath().getWorldMatrix():null;if(d){var c=(new e.Matrix4).getInverse(d);i.setAttribute("mTransfoMatrix",(new e.Matrix4).multiplyMatrices(c,t.objectsMoved[l].worldMatrix)),a.push({target:i,state:{mTransfoMatrix:(new e.Matrix4).multiplyMatrices(c,t.objectsMoved[l].worldMatrix)}})}}b.getFrameWindow().getViewer().render();var u=n.giveEventsController({viewer:b.getFrameWindow().getViewer()});u&&a.length&&(u.fireEvent("onDMUOverloadPropertiesChanged",{overloads:a}),u.fireEvent("onSaveRequested",{}))}}function k(e){e.forEach((e=>{if("cke"===e.name){let t,n=!1;e.preferences.forEach((e=>{"Length"===e.name?(U.unit=e.value,t=!0):"LengthCalcDisplay"===e.name?(U.decimalPlaceRO=parseInt(e.value),t=!0):"Angle"===e.name?(P.unit=e.value,n=!0):"AngleCalcDisplay"===e.name&&(P.decimalPlaceRO=parseInt(e.value),n=!0)})),S&&t&&S.setLengthUnit(U),S&&n&&S.setAngleUnit(P)}}))}O&&(A=O.getComponent(WAfrStandardComponentKey.HandlerComponent)),this.beginExecute=function(){if(O&&(w||(w=r.subscribe({event:b.getId()+"/PAUSE"},b.pauseExecute)),y||(y=r.subscribe({event:b.getId()+"/RESUME"},b.resumeExecute))),!(h=n.getContextViewer({viewer:this.getFrameWindow().getViewer()})))return window.console.log("No PAD3DViewer available!!"),void this.cancel();var e=m.giveSelectionManager({context:h});e&&e.getActiveState()&&(e.setActiveState(!1),T=!0);var t=h.getViewer();x={primitive:t.picking.primitive,trapSelection:t.picking.trapSelection,trapPrimitive:t.picking.trapPrimitive,trapGPU:t.picking.trapGPU},M=t.pPicking.primitive,t.setPicking({primitive:0,trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),t.setPrePicking({primitive:0}),R=[];for(var U=i.giveDMUApplicativeContextManager({context:h}),P=U?U.getApplicativeControllers():[],_=0;_<P.length;_++)P[_].setMinimalUIFlag&&(R.push({ctx:P[_],minimalFlag:P[_].getMinimalUIFlag()}),P[_].setMinimalUIFlag(!0),P[_].setAnnotationUIVisibleFlag&&P[_].setAnnotationUIVisibleFlag(!1));(v=new d({uiFrame:h.getFrameWindow().getUIFrame(),onSave:W,onCancel:F,nlsModifLbl:C.movePartsOrPrdLabel})).show(),A?c.displayReferentLevel(!0):u.getCommand("DMULevelSelectorHdr",h.getCommandContext()).showReferentLevel(!0),E=!1,s.unreferenceMoveManager({context:h}),D=s.getMoveManager({context:h}),I.push(D.subscribe("onValidateMove",N)),I.push(D.subscribe("MoveEnd",(function(){h.getController().forceRefresh()}))),S=l.getMove3DRobot({context:h});var L=p.givePreferenceManager({context:b.getFrameWindow()});L&&(b._prefSubscribe=L.subscribe("com.ds.mep:onPrefUpdate",(e=>k(JSON.parse(e[1].preferences).repositories)))),f.readPreferences([{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Angle","AngleCalcDisplay"]}]).then((e=>{k(e.repositories)}));var G,q=o.get();q.length&&(q[q.length-1].event&&(G=t.pick(t.getMousePosition(q[q.length-1].event.getCurrentPosition(t.canvas)),"mesh",!0).position),S.modifyTargetAndPosition({pathElement:q[0].pathElement,robotPosition:G}));var B=D.subscribe("Move",(function(){v.showSave(),D.unsubscribe(B)})),j=a.getBoxController({context:h});j&&j.setActiveState(!0),document.addEventListener("keydown",V),h.getFrameWindow().getContextualUIManager().register({subscriberId:"DMUMoveCmdCtxBarID",workbenchName:"CATW3DCommands",context:h.getCommandContext(),module:"CATW3DCommands",cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:function(){let e=[],t=Boolean(h.getExecutionContext);var n=o.get();if(1===n.length)for(var i=n[0].pathElement;i;){if(g.isPLMNode(i.getLastElement(!0)))return e=[{name:"LevelSelectorStr",line:1,hdr_list:["LevelSelectorHdr"],type:"handler",identifier:"LevelSelectorHdr"}],t?{WAfrCtxBarRow1:{model:e}}:{cmdList:e};i=i.getParentPath()}}})},this.pauseExecute=function(){a.getBoxController({context:h}).setActiveState(!1),S.setVisibility(!1),v.hide(),document.removeEventListener("keydown",V),this.done&&this.done()},this.resumeExecute=function(){a.getBoxController({context:h}).setActiveState(!0),S.setVisibility(!0),v.show(),document.addEventListener("keydown",V),this.done&&this.done()},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this.endCommand=function(){D&&D.terminateMove({save:E}),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command",E?"MoveOK":"MoveCancel")})),A?c.displayReferentLevel(!1):u.getCommand("DMULevelSelectorHdr",h.getCommandContext()).showReferentLevel(!1),function(){if(R&&R.length)for(var e=0;e<R.length;e++)void 0!==R[e].minimalFlag&&(R[e].ctx.setMinimalUIFlag(R[e].minimalFlag),R[e].ctx.setAnnotationUIVisibleFlag&&R[e].ctx.setAnnotationUIVisibleFlag(!R[e].minimalFlag));R=null,document.removeEventListener("keydown",V),v&&v.destroy(),v=null,S&&S.unreference(),S=null,D&&I.forEach(D.unsubscribe,D),I=[],s.unreferenceMoveManager({context:h}),D=null,a.unregisterBoxController({context:h}),h&&h.getFrameWindow().getContextualUIManager().unregister("DMUMoveCmdCtxBarID")}(),h&&h.getFrameWindow().getContextualUIManager().hideContextualMenus();var e=m.giveSelectionManager({context:h});if(e&&T&&e.setActiveState(!0),T=null,h){var t=h.getViewer();t.setPicking(x),t.setPrePicking({primitive:M})}h=D=v=S=null;var n=p?p.givePreferenceManager({context:this.getFrameWindow()}):null;n&&b._prefSubscribe&&n.unsubscribe(b._prefSubscribe)},this.destroy=function(){O&&(r.unsubscribe(w),r.unsubscribe(y)),w=y=void 0}}})})),define("DS/DMUCommands/DMUReqCompareCmd",["require","exports","DS/CATWebUXComponents/DMUCommandCheckHeader","DS/DMUPlayCompare/DMUCompareRequirement","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/PADServices/utils/SearchUtils","DS/DMUBaseUIControllers/DMUReviewContextInitializer","UWA/Utils","DS/DMUControls/EXPNotify","DS/CATWebUXComponents/CATWebUXNotifBar","DS/CATWebUXComponents/DMUCommandsManager","i18n!DS/DMUCommands/assets/nls/DMUCommands","DS/DMUBaseUIControllers/DMUReqCompareController","DS/DMUBaseExperience/DMUContextManager"],(function(e,t,n,i,o,r,a,l,s,d,c,u,g,m,p){"use strict";let f,C,h,v,D,S,M,x,w,y,b,E,I,U,P="",A="",O="",R="",T="",F=!1,W=!1,V={},N=n.extend({init:function(e){this._parent(e,{}),f=this,C=this.getFrameWindow().getViewer(),this.onStateChange((function(){f.getState()?N.StartReqCompare():N.StopReqCompare()}))}}),k=function(e,t,n){w&&(w.destroy(),w=null),w=new d({body:v.getFrameWindow().getUIFrame(),type:e,notificationType:n,message:t})},_=function(e){if(h){let t=h.getComponent(WAfrStandardComponentKey.HandlerComponent);t&&t.isCheckExecutable("DMUReqCompareCmdHdr")&&t.setCheckState({id:"DMUReqCompareCmdHdr",state:e})}},L=function(e){P&&e&&(F=!1,a.inAppsSearch({mode:"furtive",app_socket_id:"DMUReqCompareCmd",search_criteria_to_display:"",fts_value:R?"(logicalid:"+R+") AND NOT (physicalid:"+e+")":"(versionid:"+T+") AND NOT (physicalid:"+e+")",callback:function(t){if(x&&(clearTimeout(x),x=null),t.length>=0){if(E&&(E.removeAll(),E.destroy()),A=t[0].resourceid,A===e)return F=!0,_(!1),void k("info",g.sameObjectsCompared);A&&v.getController().getAttributes({ids:[A],attributes:["ds6w:type"],callbacks:{onComplete:async function(e){if(e){if(M||(M=await l.createReviewContext({context:v})),!M)return;let t=M.getTransientReviewBag();if(!t)return;let n=e[A]&&e[A]["ds6w:type"];O===n||"Requirement Specification"===O&&"Requirement"===n||"Requirement"===O&&"Requirement Specification"===n||W&&("Chapter"===n||"Requirement"===n||"Comment"===n)?(t.fireEvent("onDMUDisplayRequirementCompare",{compare2DDocument:A,documentType:n}),async function(){if(M||(M=await l.createReviewContext({context:v})),!M)return;let e;I||(I=m.giveReqCompareController({context:v}));let t=M.getCurrentSessionMarkup();if(t&&t.isVisible()&&t.getActiveFlag()){let n=t.getSlides();if(n&&n.length>1)for(let e=0;e<n.length;e++){let t=n[e].getDMUObjects("DMUCompareRequirement");if(t&&t.length&&I){let e=t[0].getAttribute("oSelections");if(e[0].id===P&&e[1].id===A)return void I.displayRequirementComparison(t[0])}}e=t}else e=M.getTransientReviewBag();if(e)if(P!==A){if(b=new i(C,e),b.setAttributes([{name:"sID",value:e.computeNewID()},{name:"sUuid",value:s.getUUID()},{name:"sName",value:e.computeNewName({object:b,prefix:"RequirementCompare"})},{name:"oSelections",value:[{id:P},{id:A}]}]),"DMUMarkup"===e.getType()&&e.isVisible()&&e.getActiveFlag()){let e=u.getCommand("slideCmdHdr",v.getCommandContext());e&&await e.begin();let n=t.getSlides();if(n&&n.length&&n.length>1){let e=n[1];t.setCurrentSlide(e),e.addDMUObject(b)}}else e.addDMUObject(b);I&&I.displayRequirementComparison(b),b.fireEvent("onDMUObjectInitialized",{dmuObject:b})}else k("error",g.compareCmdFailed)}()):(F=!0,_(!1),k("error",g.invalidCompareObj))}},onFailure:function(){k("error",g.compareCmdFailed)}}})}},cancel:function(){E&&(E.removeAll(),E.destroy()),x&&clearTimeout(x),h.getComponent(WAfrStandardComponentKey.HandlerComponent).getCheckState({id:"DMUReqCompareCmdHdr"})?x=setTimeout((()=>{F=!0,k("info",g.compareCancelled),_(!1),x=null}),500):_(!1)}}))};return N.StartReqCompare=function(e,t){if(!v&&t?v=t.executionContext.getComponent("Viewer"):v||t||!C||(v=p.getContextViewer({viewer:C})),C||(v||(v=window.require("DS/PADUtils/PADContext").get()),v&&(C=v.getViewer())),t&&t.executionContext&&(h=t.executionContext),y=v.subscribe({event:"onRootRemoved"},(function(){I||(I=m.giveReqCompareController({context:v})),null==I||I.updateSideBarData(),v.unsubscribe(y),y=null,_(!1)})),_(!0),I||(I=m.giveReqCompareController({context:v})),I&&(b=I.getActiveCompareFeature()),!b){S=r.getManager({name:"DMU2DSheetManager",context:v.getFrameWindow()});let e=S.getSelectedElementIDs();W=!1;let t=v.getRoots();if(!t||!t.length)return k("error",g.compareCmdFailed),F=!0,void _(!1);if(e&&e.length){W=!0;let t=e[0].split("/");P=t.pop()}else{let e=o.getNodeID(t[0]);e&&(P=e)}M=p.getReviewContext({viewer:C}),v.getController().getAttributes({ids:[P],attributes:["ds6wg:revision","logicalid","versionid","ds6w:type","type_icon_url"],callbacks:{onComplete:function(e){D=e,D&&S&&P&&(O=D[P]?D[P]["ds6w:type"]:null,("Requirement"===O||"Requirement Specification"===O||W&&("Comment"===O||"Chapter"===O))&&(R=D[P]?D[P].logicalid:null,T=D[P]?D[P].versionid:null,E=new c({className:"DMUReqCompareCmd"}).inject(v.getFrameWindow().getUIFrame()),E.add({msgType:"primary",message:g.notifySecondTextDoc,closable:!1,buttons:[{className:"default",label:g.compareCancel,onClick:function(){_(!1),k("info",g.compareCancelled)}}]}),L(P)))},onFailure:function(){F=!0,_(!1),k("error",g.compareCmdFailed)}}})}e&&e()},N.StopReqCompare=function(e,t){if(!v&&t?v=t.executionContext.getComponent("Viewer"):v||t||!C||(v=p.getContextViewer({viewer:C})),C||(v||(v=window.require("DS/PADUtils/PADContext").get()),v&&(C=v.getViewer())),t&&t.executionContext&&(h=t.executionContext),_(!1),E&&(E.removeAll(),E.destroy()),I||(I=m.giveReqCompareController({context:v})),I&&I.getActiveCompareFeature()&&(b=I.getActiveCompareFeature()),!F&&b&&(b.fireEvent("onDMUReqCompareCancelled",{dmuObject:b}),M||(M=p.getReviewContext({viewer:C}))),v.unsubscribe(y),U=p.giveEventsController({viewer:v.getViewer()}),U){let e=Object.keys(V);for(let t=0;t<e.length;t++)U.removeEvent(V[e[t]]||"")}V={},y=null,P="",A="",R="",T="",b=null,I=void 0,e&&e()},N})),define("DS/DMUCommands/DMUFLEditPropertiesCmd",["UWA/Class","DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager"],(function(e,t,n,i){"use strict";return e.extend(t,{init:async function(e){let t=this;t._tokensXSO={},t._parent(e,{mode:"shared",isAsynchronous:!1}),t.getSelect=function(){return new Promise((e=>{require(["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(t){var n,o=i.get();if(o.length&&o.some((function(e){return t.isAModelPath(e.pathElement)}))){for(var r=o[0].pathElement.externalPath.length-1;r>=0&&((n=o[0].pathElement.externalPath[r])&&!t.isPLMNode(n));--r){if(n.getDibInfo){var a=r>0?o[0].pathElement.externalPath[r-1]:null;e([{dibInfo:n.getDibInfo(),parentDibInfo:a&&a.getDibInfo?a.getDibInfo():null}])}n.getReqInfo&&e([{reqInfo:n.getReqInfo(),parentDocInfo:null}])}e(o)}e([])}))}))},t._tokensXSO.onPostAdd=i.onPostAdd((function(){window&&window.__karma__&&window.editPropertiesCmdDoNotListenToCSOEvents||t.getSelect().then((e=>{if(e&&e.length>0){if(t.enable(),e[0].dibInfo){let i=n.giveEventsController({viewer:t.getFrameWindow().getViewer()});i&&i.fireEvent("onFireCrossWidgetSelection",{paths:[[e[0].dibInfo.id]]})}}else t.disable()}))})),t._tokensXSO.onEmpty=i.onEmpty((function(){window&&window.__karma__&&window.editPropertiesCmdDoNotListenToCSOEvents||t.disable()})),t._tokensXSO.onPostRemove=i.onRemove((async function(){if(window&&window.__karma__&&window.editPropertiesCmdDoNotListenToCSOEvents)return;const e=await t.getSelect();e&&e.length>0?t.enable():t.disable()}));const o=await t.getSelect();o&&o.length>0?t.enable():t.disable()},beginExecute:async function(){var e=this;const t=require("DS/PADUtils/PADSettingsMgt");var n=await e.getSelect(),i=[],o=[];if(n.length){if(n[0].dibInfo)o.push({refID:n[0].dibInfo.id});else if(n[0].reqInfo)o.push({refID:n[0].reqInfo.id});else{for(var r=0;r<n.length;r++)i.push(n[r].pathElement);i.forEach((function(e){require(["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADContext"],(function(t,n){for(;e&&!t.isPLMNode(e.getLastElement(!0));)e=e.getParentPath();if(!e&&n.get().isSelectiveLoadingActivated()){var i=n.get().getController().getOOCSelectedReferenceID();i&&o.push({refID:i,instID:null})}else{var r=e.getLastElement(!0),a=e.getParentPath().getLastElement(!0);o.push({refID:t.getNodeID(r),instID:t.getNodeID(a)})}}))}))}var a={getSelectedNodes:function(){var e=[];return o.forEach((function(n){var i={id:n.refID,tenant:t.getSetting("x3dPlatformId"),source:"3DSpace",getID:function(){return n.refID},getRelationID:function(){return n.instID}};e.push(i)})),e},getSecurityContext:function(){return{SecurityContext:t.getSetting("pad_security_ctx"),tenant:t.getSetting("x3dPlatformId")}}};e.launchProperties(a)}else e.endExecute()},_destroy:function(){this._tokensXSO.onPostAdd&&i.unsubscribe(this._tokensXSO.onPostAdd),this._tokensXSO.onPostRemove&&i.unsubscribe(this._tokensXSO.onPostRemove),this._tokensXSO.onEmpty&&i.unsubscribe(this._tokensXSO.onEmpty)},setObject:function(e){this._objectId=e}})})),define("DS/DMUCommands/DMURemoveOverloadCmd",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager","DS/DMUControls/DMUOptionsPanel","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUCommands/assets/nls/DMUCommands"],(function(e,t,n,i,o,r){"use strict";return e.extend({init:function(e){var t=e||{};t.mode="shared",this._parent(t)},beginExecute:function(e){this._parent(e);var a=this,l=[],s=function(){var e=n.giveEventsController({viewer:a.getFrameWindow().getViewer()});e&&e.fireEvent("onDMUOccOverloadRemoved",l)},d=n.getReviewContext({viewer:this.getFrameWindow().getViewer()}),c=d?d.getCurrentSessionMarkup():null;if(c&&!c.isReadOnly()){var u,g,m,p=t.get(),f=[];for(g=0;g<p.length;g++)!(u=p[g].pathElement.getLastElement(!0)).getDMUType||"DMUSlide"!==u.getDMUType()&&"DMUFormat"!==u.getDMUType()||f.push(c.getDMUObjectFromPathElement(p[g].pathElement));var C=!1;if(f.length||(C=!0,f.push(c.getCurrentSlide())),f.length){var h=[],v=!1,D=!1;if(C)for(g=0;g<p.length;g++){var S,M=c.getOrCreateOccurrenceOverloader(p[g]);M&&(S=f[0].getOverloadForTarget(M))&&S.state&&(h.push({slide:f[0],slideOverload:S,overload:M}),(S.state.mPosition||S.state.mTransfoMatrix)&&(v=!0),(void 0!==S.state.bVisible&&null!==S.state.bVisible||void 0!==S.state.cColor&&null!==S.state.cColor||void 0!==S.state.fOpacity&&null!==S.state.fOpacity)&&(D=!0));var x=p[g].pathElement.clone();o.isInstance(x.getParentPath().getLastElement(!0))&&(M=c.getOrCreateOccurrenceOverloader({pathElement:x.getParentPath()}))&&(S=f[0].getOverloadForTarget(M))&&S.state&&(h.push({slide:f[0],slideOverload:S,overload:M}),(S.state.mPosition||S.state.mTransfoMatrix)&&(v=!0),(void 0!==S.state.bVisible&&null!==S.state.bVisible||void 0!==S.state.cColor&&null!==S.state.cColor||void 0!==S.state.fOpacity&&null!==S.state.fOpacity)&&(D=!0))}else for(g=0;g<f.length;g++){var w=f[g].getObjectOverloads();for(m=0;m<w.length;m++)w[m].state&&(h.push({slide:f[g],slideOverload:w[m],overload:w[m].target}),(w[m].state.mPosition||w[m].state.mTransfoMatrix)&&(v=!0),(void 0!==w[m].state.bVisible&&null!==w[m].state.bVisible||void 0!==w[m].state.cColor&&null!==w[m].state.cColor||void 0!==w[m].state.fOpacity&&null!==w[m].state.fOpacity)&&(D=!0))}var y=function(){h.forEach((function(e){e.slide.removeObjectOverload(e.slideOverload),l.push({target:e.overload})})),a.getFrameWindow().getViewer().render(),s()};if(D&&v)new i({frmWindow:a.getFrameWindow(),panelTitle:r.removeObjectOverloadPanelTitle,options:[{nls:r.graphicOverloads,id:"DMURemoveGraphicOverloads",value:"false"!==localStorage.getItem("DMURemoveGraphicOverloads")},{nls:r.positionOverloads,id:"DMURemovePositionOverloads",value:"false"!==localStorage.getItem("DMURemovePositionOverloads")}],cb:function(e){if(e){var t;if(e.DMURemoveGraphicOverloads&&e.DMURemovePositionOverloads)y();else e.DMURemoveGraphicOverloads?(h.forEach((function(e){e.slideOverload.state.mPosition||e.slideOverload.state.mTransfoMatrix?(t={},null!==e.overload.getAttribute("bVisible")&&(e.overload.setAttribute("bVisible",null),t.bVisible=null),null!==e.overload.getAttribute("cColor")&&(e.overload.setAttribute("cColor",null),t.cColor=null),null!==e.overload.getAttribute("fOpacity")&&(e.overload.setAttribute("fOpacity",null),t.fOpacity=null),l.push({target:e.overload,state:t})):(e.slide.removeObjectOverload(e.slideOverload),l.push({target:e.overload}))})),s(),localStorage.removeItem("DMURemoveGraphicOverloads")):localStorage.setItem("DMURemoveGraphicOverloads","false"),e.DMURemovePositionOverloads?(h.forEach((function(e){void 0!==e.slideOverload.state.bVisible&&null!==e.slideOverload.state.bVisible||void 0!==e.slideOverload.state.cColor&&null!==e.slideOverload.state.cColor||void 0!==e.slideOverload.state.fOpacity&&null!==e.slideOverload.state.fOpacity?(t={},null!==e.overload.getAttribute("mPosition")&&(e.overload.setAttribute("mPosition",null),t.mPosition=null),null!==e.overload.getAttribute("mTransfoMatrix")&&(e.overload.setAttribute("mTransfoMatrix",null),t.mTransfoMatrix=null),l.push({target:e.overload,state:t})):(e.slide.removeObjectOverload(e.slideOverload),l.push({target:e.overload}))})),s(),localStorage.removeItem("DMURemovePositionOverloads")):localStorage.setItem("DMURemovePositionOverloads","false");a.getFrameWindow().getViewer().render()}}});else y()}}this.cancel()}})})),define("DS/DMUCommands/DMUSnapCmd",["require","exports","DS/DMUBaseCommands/EXPStateCommand","DS/CATWebUXComponents/CATWebUXNotifBar","DS/DMUMeasurable/DMUMeasurable","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeasureEnums","DS/DMUMeasurable/DMUPreVisuNode3D","DS/Mesh/MeshUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/CATW3DBoxes/CATW3DBoxController","DS/Visualization/IdPath","DS/Visualization/ThreeJS_DS","DS/DMUMeasurable/DMUMeasurableElementAgent","DS/DMUBaseExperience/DMUContextManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/DMUCommands/assets/nls/DMUCommands","DS/DMUCommands/DMUSelectionFilterUI"],(function(e,t,n,i,o,r,a,l,s,d,c,u,g,m,p,f,C,h,v,D,S,M,x,w,y){"use strict";return n.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});let t,n,b,E,I,U,P,A,O,R,T,F,W,V,N,k,_,L=this,G=this.getFrameWindow().getViewer(),q=e.executionContext?e.executionContext.getComponent("Viewer"):S.getContextViewer({viewer:G}),B=0;function j(){let e,t=S.getReviewContext({viewer:L.getFrameWindow().getViewer()}),n=t&&!t.isReadOnly()?t.getCurrentSessionMarkup():null,i=[];if(E)if(n){if(e=n.getOrCreateOccurrenceOverloader({pathElement:I.pathReferent,worldMatrix:I.pathReferent.getWorldMatrix()},!0),e){let t=e.getOccurrencePathElement(),n=t?t.getParentPath().getWorldMatrix():null;if(n){let t=(new v.Matrix4).getInverse(n);e.setAttribute("mTransfoMatrix",(new v.Matrix4).multiplyMatrices(t,I.pathReferent.getWorldMatrix())),i.push({target:e,state:{mTransfoMatrix:(new v.Matrix4).multiplyMatrices(t,I.pathReferent.getWorldMatrix())}})}}let t=S.giveEventsController({viewer:G});t&&i.length&&(t.fireEvent("onDMUOverloadPropertiesChanged",{overloads:i}),t.fireEvent("onSaveRequested",{}))}else{let e=d.getNodeID(E.path.getLastElement(!0));q.getController().updateInstance(e,{matrix:E.initMatrix})}}function X(){T&&(d.getSceneRoot(G).remove(T),G.render(),T.removeChildren(),T.remove(),T=void 0)}function H(){G.setCursor("Auto"),q.getFrameWindow().getContextualUIManager().unregister("DMUSnapCmdCtxBarID"),W&&G.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(W),W=null,P&&((null==P?void 0:P.count())>0&&P.deleteAllCst(),P.unreference()),t&&(t.removeAll(),t.destroy()),N&&U.unsubscribe(N),p.unsubscribe(k),p.empty(),f.empty(),X(),b.unsubscribe(V),null==b||b.unreference(),m.unreferenceMoveManager({context:q}),I=k=N=O=R=U=V=t=n=null}function z(){F="IntermediateState"}function K(){}function J(){F="InitialState"}function Y(){}function Z(){let e,t=q.getController(),n=t.getRootBagId();W||(W=new M(t.getRootBag(),n)),I=b.filterPath({pathElement:_.path[0]}),I.pathReferent=O.getMoveReferent(_.path[0]);for(let t=_.path[0].externalPath.length-1;t>0;--t)if(d.isRepReference(_.path[0].externalPath[t])){e=d.getNodeID(_.path[0].externalPath[t]);break}let i=I.pathReferent.externalPath.map((function(e){return d.getNodeID(e)})).filter((function(e){return e}));i.unshift(n),E={path:I.pathReferent,lockedID:e,override:W.createIdPathOverride({idPathes:[new h(i)]}),initWorldMatrix:I.pathReferent.getWorldMatrix(),initMatrix:I.pathReferent.getLastElement(!0).getMatrix(),selectionWorldMatrix:I.pathElement.getWorldMatrix(),isAxisSystem:I.pathElement.externalPath.some((function(e){return"AxisSystems"===e.name})),snappedPosition:null},U.onMoveBegin({objectsMoved:[E],from:L,moveMode:"Transient"}),p.add({pathElement:I.pathElement}),R&&R.setActiveState(!0),q.getExecutionContext?q.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!0}):q.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0})}function Q(e,t){_=G.pick(G.getMousePosition(t[0].eventDatas.event.currentPosition),"primHybrid",!1),Z(),e()}function $(e,t){0===P.count()&&Z();let i=G.pick(G.getMousePosition(t[0].eventDatas.event.currentPosition),"primHybrid",!1),o=b.filterPath({pathElement:i.path[0]}),r=!1,a={};o.pathElement&&I.pathElement&&(r=o.pathElement.isEqual(I.pathElement));let l=I.equivalentGeometry&&I.equivalentGeometry.getType(),s=o.equivalentGeometry&&o.equivalentGeometry.getType(),d=l&&l!==c.GeometryType.AXISSYSTEM&&l!==c.GeometryType.SURFACE,u=s&&s!==c.GeometryType.AXISSYSTEM&&s!==c.GeometryType.SURFACE;if(!r&&u&&d){P.createCst({movable:I,fixed:o});let e=P.simulateSolveCst();if(e){let t=e.matrix;a.rc=e.rc,a.redundancy=e.redundancy,0===a.rc&&t&&!a.redundancy?a.matrix=t.multiply(I.pathReferent.getWorldMatrix()):(0!==a.rc||a.redundancy)&&(q.displayNotification({msg:w.snapConstrained,eventID:"error"}),P.deleteLastCst())}}else o&&o.pathElement&&(a.matrix=o.pathElement.getWorldMatrix(),o.pathElement.externalPath.some((function(e){return"AxisSystems"===e.name}))&&(a.isAxisSystem=!0));if(a.matrix){let e;if(a.isAxisSystem){let t=(new v.Matrix4).copy(a.matrix);t.multiply((new v.Matrix4).getInverse(E.selectionWorldMatrix)),t.multiply(E.initWorldMatrix),e=(new v.Matrix4).getInverse(E.initWorldMatrix).multiply(t)}else e=(new v.Matrix4).getInverse(E.initWorldMatrix).multiply(a.matrix),e.multiply((new v.Matrix4).getInverse(I.pathElement.getLastElement(!0).getMatrix()));let t=(new v.Matrix4).copy(E.initWorldMatrix).multiply(e);if(E.path){let e=(new v.Matrix4).getInverse(E.path.getParentPath().getWorldMatrix()),i=(new v.Matrix4).copy(e).multiply(t);E.snappedPosition=(new v.Matrix4).copy(i),E.override.setPosition(i),n.buttons[0].show()}p.add({pathElement:I.pathElement}),U.onMove({objectsMoved:[E],transformation:e,from:L})}U.onMoveEnd({from:L,status:"Moved"}),e()}function ee(e){let t=!1,n=!1;if(void 0!==e){if(d.getFirstReference(e).externalPath.length>0){let i=d.getLastRepReference(e);if(I)for(let e=0;e<I.pathReferent.externalPath.length;e++){let t=d.getNodeID(I.pathReferent.externalPath[e]);for(let e=0;e<i.externalPath.length;e++){if(d.getNodeID(i.externalPath[e]).includes(t)){n=!0;break}n=!1}if(!n)break}t=!0,n&&"IntermediateState"===F||!n&&"InitialState"===F&&void 0!==I?(t=!1,G.setCursor("not-allowed",0,!0)):(t=!0,G.setCursor("Auto"))}else G.setCursor("Auto")}return t}function te(e){T?T.buildPreVisuNode({data:e}):(T=new l(G),T.buildPreVisuNode({data:e}),T.setNoZ(!0),T.setPickable(s.PICKTHROUGH),G&&(d.getSceneRoot(G).add(T),G.render())),T.setVisibility(G.getVisibleSpace())}function ne(e){e&&e.pathElement||T&&(G.setCursor("Auto"),X());let t=function(e){let t,n=e;if(!n||!n.pathElement)return;let i=n.pathElement.getLastElement().sgNode;if(void 0!==i)t=new o({primitive:i,pathElement:n.pathElement,selpoint:n.position,selnormal:n.normal,rayDir:n.ray&&n.ray.direction?n.ray.direction:void 0,bIsPOISelection:!1});else if(n.position){let e=n.position.clone();if(n.pathElement.getWorldMatrix()){let i=(new v.Matrix4).getInverse(n.pathElement.getWorldMatrix());e=e.applyMatrix4(i);let a=r.GeometryType.PRODUCT;t=new o({canonic:{type:a,position:e},pathElement:n.pathElement,selpoint:n.position,selnormal:n.normal,isApprox:!1,bIsPOISelection:!1})}}return t}(e);if(t){let e=t.getType(),n=b.getActivatedFilter();switch(e){case r.GeometryType.POINT:(n.none||n.point)&&te(t);break;case r.GeometryType.LINE:(n.none||n.line)&&te(t);break;case r.GeometryType.CIRCLE:(n.none||n.center)&&te(t);break;case r.GeometryType.SPHERE:case r.GeometryType.SURFACE:case r.GeometryType.PLANE:case r.GeometryType.CURVE:(n.none||n.plane||n.surface)&&te(t);break;case r.GeometryType.CYLINDER:case r.GeometryType.CONE:(n.none||n.cylinder||n.surface)&&te(t);break;case r.GeometryType.PRODUCT:n.surface&&te(t)}}else G.setCursor("Auto")}this.beginExecute=function(){p.empty(),f.empty(),b=new y({context:q}),b.activate(),O=g.getMoveReferentManager({context:q}),U=m.getMoveManager({context:q}),R=C.getBoxController({context:q}),R&&R.setActiveState(!1),P||(P=u.getConstraintsController({context:q})),G.setOverrideCursors(!0),F="InitialState";let e="primHybrid";A=new D({agentId:"_pathElementAgentWithCSO",viewer:G,engWithPSOHSO:!0,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:e,prePickingMode:e,valuedFromCSO:!1,saveToCSO:!1,activatePrePicking:!0,acceptedGeometries:[],appli:this,checkAppli:ee,displayAppli:ne,switchRepOnPreSelection:!0,viewerController:q.getController()}),A.options.acceptedGeometries=[r.GeometryType.PLANE,r.GeometryType.LINE,r.GeometryType.CYLINDER,r.GeometryType.CONE],V=b.subscribe("UpdateFilter",(function(e){let t=[];e.filters.plane&&(t.push(r.GeometryType.PLANE),t.push(r.GeometryType.CURVE),A.options.acceptedGeometries=t),e.filters.center&&(t.push(r.GeometryType.CIRCLE),t.push(r.GeometryType.SPHERE),A.options.acceptedGeometries=t,A.options.viewedGeometries=[a.ViewedType.CENTER]),e.filters.cylinder&&(t.push(r.GeometryType.CYLINDER),t.push(r.GeometryType.CONE),t.push(r.GeometryType.SPHERE),A.options.acceptedGeometries=t),e.filters.line&&(t.push(r.GeometryType.LINE),t.push(r.GeometryType.CURVE),t.push(r.GeometryType.CIRCLE),A.options.acceptedGeometries=t),e.filters.point&&(t.push(r.GeometryType.POINT),A.options.acceptedGeometries=t),e.filters.axisSystem&&(t.push(r.GeometryType.AXISSYSTEM),A.options.acceptedGeometries=t),e.filters.product&&(A.options.viewedGeometries=[a.ViewedType.PRODUCT],A.options.acceptedGeometries=[]),e.filters.none&&(A.options.acceptedGeometries=[])})),t&&(t.removeAll(),t.destroy()),t=new i({className:"DMUSnapCommand",alwaysOntop:!0}).inject(L.getFrameWindow().getUIFrame()),n=t.add({msgType:"primary",message:w.snapMessage,closable:!1,buttons:[{className:"primary",label:w.cumulativeSnapSavePreference,onClick:function(){L.publish({event:"DMUSnapCmdSaved"})}},{className:"default",label:w.cumulativeSnapCancelPreference,onClick:function(){L.publish({event:"DMUSnapCmdCancelled"})}}]}),n.buttons[0].hide(),N=U.subscribe("onValidateMove",j),q.getFrameWindow().getContextualUIManager().register({subscriberId:"DMUSnapCmdCtxBarID",workbenchName:"CATW3DCommands",context:q.getCommandContext(),module:"CATW3DCommands",cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:function(){let e=[],t=p.get();if(1===t.length){let n=t[0].pathElement;for(;n;){if(d.isPLMNode(n.getLastElement(!0))&&0===B)return e=[{name:"LevelSelectorStr",line:1,hdr_list:["LevelSelectorHdr"],type:"handler",identifier:"LevelSelectorHdr"}],B++,{WAfrCtxBarRow1:{model:e}};n=n.getParentPath()}}}}),async function(){let e=await x.readPreferences([{Repository:"W3MprefMove",PreferenceNames:["defaultMoveReferent"]}]);g.setMoveReferentDefault(e.repositories[0].preferences[0].value),R&&R.refreshBoxes(!0)}(),k=p.onAdd((function(){if(I&&I.pathReferent){let e=p.get();I.pathReferent=O.getMoveReferent(e[0].pathElement)}}))},this.cancelExecute=function(){H(),this.done()},this.endExecute=function(){H(),this.done()},this.buildGraph=function(){L.beginExecute();let e=this.createInitialState("InitialState");this.setEnterStateAction(e,J),this.setExitStateAction(e,Y);let t=this.getFinalState(),n=this.createState("intermediateState");this.setEnterStateAction(n,z),this.setExitStateAction(n,K),this.addTransition({iSender:this,iEvent:"DMUSnapCmdSaved",iInitialState:e,iFinalState:t,iAction:function(e){U&&U.terminateMove({save:!0}),L.endExecute(),e()}}),this.addTransition({iSender:this,iEvent:"DMUSnapCmdSaved",iInitialState:n,iFinalState:t,iAction:function(e){U&&U.terminateMove({save:!0}),L.endExecute(),e()}}),this.addTransition({iSender:this,iEvent:A,iInitialState:e,iFinalState:n,iAction:Q}),this.addTransition({iSender:this,iEvent:A,iInitialState:n,iFinalState:e,iAction:$}),this.addTransition({iSender:this,iEvent:"DMUSnapCmdCancelled",iInitialState:e,iFinalState:t,iAction:function(e){U&&U.terminateMove({save:!1}),L.endExecute(),e()}}),this.addTransition({iSender:this,iEvent:"DMUSnapCmdCancelled",iInitialState:n,iFinalState:t,iAction:function(e){U&&U.terminateMove({save:!1}),L.endExecute(),e()}})}}})}));