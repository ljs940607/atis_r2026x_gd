define("DS/InstantMessagingCall/store/modules/settings",[],(function(){"use strict";return{state:Object.assign({mediaDevices:{audioinput:[],videoinput:[],audiooutput:[]}},{displaySettings:!1,enableSettings:!0,currentAudioinputId:null,currentVideoinputId:null,currentAudiooutputId:null,audioInputGroupId:null,videoInputGroupId:null,audioOutputGroupId:null}),getters:{displaySettings:e=>e.displaySettings,enableSettings:e=>e.enableSettings,audioInputs:e=>e.mediaDevices.audioinput,videoInputs:e=>e.mediaDevices.videoinput,audioOutputs:e=>e.mediaDevices.audiooutput,currentAudioinputId:e=>e.currentAudioinputId,currentVideoinputId:e=>e.currentVideoinputId,currentAudiooutputId:e=>e.currentAudiooutputId,audioInputGroupId:e=>e.audioInputGroupId,videoInputGroupId:e=>e.videoInputGroupId,audioOutputGroupId:e=>e.audioOutputGroupId,groupId:e=>(t,i)=>{if("no_value"==i)return i;const r=e.mediaDevices[t].find((e=>e.deviceId==i));return r&&r.groupId},findDeviceByCurrentGroupId:e=>t=>{const i=e.mediaDevices[t];if(i){if("audioinput"==t&&e.audioInputGroupId){return i.find((t=>t.groupId==e.audioInputGroupId))}if("videoinput"==t&&e.videoInputGroupId)return i.find((t=>t.groupId==e.videoInputGroupId));if("audiooutput"==t&&e.audioOutputGroupId){return i.find((t=>t.groupId==e.audioOutputGroupId))}}},findDeviceByCurrentDeviceId:e=>t=>{const i=e.mediaDevices[t];if(i){if("audioinput"==t&&e.currentAudioinputId){return i.find((t=>t.deviceId==e.currentAudioinputId))}if("videoinput"==t&&e.currentVideoinputId){return i.find((t=>t.deviceId==e.currentVideoinputId))}if("audiooutput"==t&&e.audioOutputGroupId){return i.find((t=>t.deviceId==e.currentAudiooutputId))}}},findDeviceByLabel:e=>(t,i)=>{const r=e.mediaDevices[t];if(r){if("audioinput"==t){return r.find((e=>e.label==i))}if("videoinput"==t){return r.find((e=>e.label==i))}if("audiooutput"==t){return r.find((e=>e.label==i))}}},resolveDefaultAudioDevice:e=>t=>{const i=e.mediaDevices.audioinput,r=i.find((e=>"default"==e.deviceId)),s=t.getAudioTracks()[0].getSettings();if(s&&r&&r.groupId!=s.groupId){return i.find((e=>e.groupId==r.groupId&&"default"!=e.deviceId)).deviceId}},getLocalDevice:e=>e=>JSON.parse(localStorage.getItem(`collab${e}`)),deviceConstraints:(e,t)=>({type:e,defaultConstraints:i})=>{const r=t.getLocalDevice(e),s=r&&r.label&&t.findDeviceByLabel(e,r.label);return s&&s.deviceId?{deviceId:{exact:s.deviceId},...i}:i}},mutations:{displaySettings:(e,{visible:t})=>{e.displaySettings=t},disableSettings:e=>{e.enableSettings=!1},resetMediaDevices:e=>{e.mediaDevices={audioinput:[],videoinput:[],audiooutput:[]}},addMediaDevice:(e,{kind:t,deviceId:i,deviceLabel:r,groupId:s})=>{e.mediaDevices[t].some((e=>e.deviceId==i))||(e.mediaDevices[t]=e.mediaDevices[t]||[],e.mediaDevices[t].push({deviceId:i,deviceLabel:r,value:i,label:r,groupId:s}))},resetSettingsState(e){Object.assign(e,{displaySettings:!1,enableSettings:!0,currentAudioinputId:null,currentVideoinputId:null,currentAudiooutputId:null,audioInputGroupId:null,videoInputGroupId:null,audioOutputGroupId:null})},currentAudioinputId(e,t){e.currentAudioinputId=t},currentVideoinputId(e,t){e.currentVideoinputId=t},currentAudiooutputId(e,t){e.currentAudiooutputId=t},audioInputGroupId(e,t){e.audioInputGroupId=t},videoInputGroupId(e,t){e.videoInputGroupId=t},audioOutputGroupId(e,t){e.audioOutputGroupId=t}},actions:{displaySettings({commit:e},{visible:t}){e("displaySettings",{visible:t})},enumerateDevices:({dispatch:e,commit:t})=>navigator&&navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then((i=>(t("resetMediaDevices"),e("gotDevices",{deviceInfos:i})))).catch((e=>{t("disableSettings"),console.error(e),console.error("MediaDevices Selector feature disabled.")})):t("disableSettings"),gotDevices({commit:e,getters:t},{deviceInfos:i}){for(let r=0;r!==i.length;++r){const s=i[r],o=s&&s.deviceId,a=s&&s.kind,n=s&&s.groupId;let d=s&&s.label;if("audioinput"===a)d=d||`microphone ${t.audioInputs.length+1}`;else if("audiooutput"===a)d=d||`speaker ${t.audioOutputs.length+1}`;else{if("videoinput"!==a){console.log("Some other kind of source/device: ",s);continue}d=d||`camera ${t.videoInputs.length+1}`}e("addMediaDevice",{kind:a,deviceId:o,deviceLabel:d,groupId:n})}},currentAudioinput({commit:e,getters:t},{deviceId:i,stream:r}){let s;if(i)s=i;else if(r){const e=r.getAudioTracks()[0];e&&(s=e.getSettings().deviceId)}e("currentAudioinputId",s),e("audioInputGroupId",t.groupId("audioinput",s))},currentVideoinput({commit:e,dispatch:t,getters:i},{deviceId:r,stream:s}){let o;if(r)o=r;else if(s){const e=s.getVideoTracks()[0];e&&""!=e.deviceId&&(o=e.getSettings().deviceId)}e("currentVideoinputId",o),e("videoInputGroupId",i.groupId("videoinput",o)),"no_value"==o&&t("alert_deviceUnplugged","videoinput")},currentAudiooutput({commit:e,getters:t},i){e("currentAudiooutputId",i),e("audioOutputGroupId",t.groupId("audiooutput",i))},setCurrentDevices({dispatch:e,getters:t},i){t.currentAudioinputId||e("currentAudioinput",{stream:i}),t.currentVideoinputId||e("currentVideoinput",{stream:i})},setSpeaker({dispatch:e,getters:t}){const i=t.getLocalDevice("audiooutput");if(i&&i.deviceId&&i.label){const r=t.findDeviceByLabel("audiooutput",i.label);r&&r.deviceId&&(e("changeAudioOutput",r.deviceId),e("currentAudiooutput",r.deviceId),e("saveDeviceLocalStorage",{deviceId:r.deviceId,kind:"audiooutput"}))}},saveDeviceLocalStorage({getters:e,state:t},{deviceId:i,kind:r}){const s=t.mediaDevices[r],o=e.groupId(r,i),a=s.find((e=>{return e.groupId==o&&("string"==typeof(t=e.deviceId)&&/\d/.test(t));var t}));a&&a.deviceId&&a.label&&localStorage.setItem(`collab${r}`,JSON.stringify({deviceId:a.deviceId,label:a.label}))},changeAudioOutput({dispatch:e},t){const i=document.querySelectorAll(".im-call-video-item > video"),r=i&&Array.from(i)||[];if(0===r.length||!r[0].setSinkId)return e("alert_audioOutputChangeNotSupported"),void console.error("Change audio output not supported by the navigator");const s=(e,t,i=0)=>new Promise(((r,o)=>{if(!document.body.contains(e)||!e.setSinkId||!t)return r();try{e.load(),e.setSinkId(t).then(r).catch((a=>{"AbortError"===a.name&&i<3?setTimeout((()=>{s(e,t,i+1).then(r).catch(o)}),200):o(a)}))}catch(e){o(e)}}));r.reduce(((e,i)=>e.then((()=>{const e=!i.paused;if(e)try{i.pause()}catch(e){return Promise.reject(e)}return s(i,t).then((()=>{e&&setTimeout((()=>i.play()))})).catch((e=>console.error(e)))}))),Promise.resolve())}}}})),define("DS/InstantMessagingCall/store/modules/notifSW",["DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessagingCall/assets/nls/feed"],(function(e,t){"use strict";window.Notification=window.Notification||window.webkitNotification||window.mozNotification;const i=()=>({serviceWorker:navigator.serviceWorker,swScriptUrl:void 0,registration:void 0,actionsAvailability:null});return{state:i(),getters:{serviceWorker:e=>e.serviceWorker,swScriptUrl:e=>e.swScriptUrl,registration:e=>e.registration,actionsAvailability:e=>e.actionsAvailability,notificationsSupported:()=>!!window.Notification,serviceWorkerSupported:()=>!!navigator.serviceWorker,badgeIcon_url:()=>window.dsDefaultWebappsBaseUrl+"/i3DXCompass/assets/small-compass.ico",loginIcon_url:(e,t)=>e=>t.swymUrl+"/api/user/getpicture/login/"+e,accept_button:()=>({action:"accept",title:t.acceptCall}),cancel_button:()=>({action:"refuse",title:t.cancel}),resume_button:()=>({action:"resume",title:t.resumeCall}),refuse_button:()=>({action:"refuse",title:t.refuseCall})},mutations:{resetNotificationsState(e){Object.assign(e,i())},serviceWorker:(e,t)=>{e.serviceWorker=t},swScriptUrl:(e,t)=>{e.swScriptUrl=t},registration:(e,t)=>{e.registration=t},actionsAvailability:(e,t)=>{e.actionsAvailability=t}},actions:{notifSW({dispatch:t,getters:i},{action:r,data:s}){if(i.isMobile||i.isIOS)return e.CallNotif("No Desktop notifications for mobile");switch(r){case"initSW":t("initNotifSW");break;case"inviteReceived":t("notifInviteReceived",s);break;case"acceptCall":case"callAccepted":t("notifCallAccepted",s);break;case"endCall":t("closeNotification",{tag:s.room_id}),t("stopFocusListener");break;case"closeNotifRoomId":t("closeNotification",{tag:s.room_id});default:e.CallNotif("unknown notifications action "+r)}},onMessageSW({dispatch:t,getters:i},r){e.CallNotif("Message from desktop notification: "+r);let s=r.data&&r.data.action,o=r.data&&r.data.room_id,a=i.room(o);switch(s){case"accept":if(e.CallNotif("Call accepted from desktop notification: "+o),!a)return e.CallNotif("SW accept - No room found for "+o);t("acceptCall",{room_id:a.room_id,type:a.type,noNotif:!0});break;case"resume":if(e.CallNotif("Call resumed from desktop notification: "+o),!a)return e.CallNotif("SW resume - No room found for "+o);t("resumeCall",a.room_id);break;case"refuse":if(e.CallNotif("Call refused from desktop notification: "+o),!a)return e.CallNotif("SW refuse - No room found for "+o);t("endCall",a);break;default:e.CallNotif("unknown SW message "+r.data)}},initNotifSW({getters:t,dispatch:i,commit:r}){e.CallNotif("Desktop notifications permission set to: "+window.Notification&&window.Notification.permission),r("swScriptUrl",t.assets_url+"notifSwScript.js"),i("registerServiceWorker")},requestNotificationPermission({getters:t}){if(t.isMobile||t.isIOS)return e.CallNotif("Desktop notifications permission set to false for mobile");window.Notification.requestPermission((t=>{e.CallNotif("Desktop notifications permission set to "+t)}))},registerServiceWorker:({commit:t,getters:i,dispatch:r},s)=>i.serviceWorkerSupported?i.actionsAvailability&&i.registration?(s&&r("showNotification",s),e.CallNotif("Service Workers already registered")):(e.CallNotif("Service Workers registration ..."),i.serviceWorker.register(i.swScriptUrl,{}).then((i=>{e.CallNotif("Service Workers registration SUCCESS"),t("registration",i),t("actionsAvailability",!0)})).catch((i=>{e.CallNotif("Service worker registration FAILED: "+i),t("actionsAvailability",!1)})).then((()=>{s&&r("showNotification",s)})),i.serviceWorker.onmessage=e=>{r("onMessageSW",e)},void i.serviceWorker.startMessages()):(t("actionsAvailability",!1),e.CallNotif("Service Workers not supported")),showNotification:({dispatch:t,getters:i},{title:r,options:s})=>i.isHidden?r?(e.CallNotif("New browser notification: "+r+" : "+s.body),window.Notification&&"granted"===window.Notification.permission?!1===i.actionsAvailability?(s.actions=[],e.CallNotif("Cannot send notification without registered service worker"),e.CallNotif("Actions button not supported")):i.registration&&i.registration.active?(i.registration.showNotification(r,s),e.CallNotif("Notification via Service Worker: "+r)):void 0:e.CallNotif("Cannot send notification if permission not granted: "+window.Notification&&window.Notification.permission)):e.CallNotif("Cannot send notification without title"):e.CallNotif("No notification sent when tab is focused. isHidden: "+i.isHidden),closeNotification:({getters:t},{tag:i})=>i?(e.CallNotif("Close notification ("+i+")"),t.registration?void t.registration.getNotifications().then((t=>{if(!t||!t[0])return e.CallNotif("Close notification: No opened notifications found.");t.filter((e=>e.tag===i)).map((e=>e.close()))})):e.CallNotif("Cannot close notification without registered service worker.")):e.CallNotif("Cannot close notification without tag."),closeAllNotifications({getters:t}){if(!t.registration)return e.CallNotif("Cannot close notifications without registered service worker.");t.registration.getNotifications().then((t=>{if(!t||!t[0])return e.CallNotif("Close all notifications: No opened notifications found.");e.CallNotif("Close all notifications: "+t.length+" opened notifications found."),t.map((e=>e.close()))}))},notifInviteReceived({dispatch:i,getters:r},{room_id:s,username:o,login:a}){if(e.CallNotif("Invite received: "+s),!s)return e.CallNotif("Cannot send callAccepted notifications without room_id.");const n=r.room(s);let d=n&&(r.roomName(n)||n.user&&n.user.username)||o||a,l=t.incoming,c=[r.accept_button,r.refuse_button];n&&n.IamTheCaller&&(l=t.calling,c=[r.cancel_button]),r.isOpera&&(c=[]);const u={body:l,tag:s,data:{url:window.location.href},icon:r.loginIcon_url(a),badge:r.badgeIcon_url,requireInteraction:!0,actions:c};r.isElectedSocket&&i("showNotification",{title:d,options:u})},notifCallAccepted({dispatch:i,getters:r},{room_id:s}){if(e.CallNotif("Call accepted: "+s),!s)return e.CallNotif("Cannot send callAccepted notifications without room_id.");const o=r.room(s),a=o&&(r.roomName(o)||o.user&&o.user.username)||r.called_users_name(s),n=r.logins_except_myself[0];let d=t.ongoing,l=[r.refuse_button];r.is_onhold_room(s)&&(d=t.onHold,l=[r.resume_button,r.refuse_button]),r.isOpera&&(l=[]);const c={body:d,tag:s,data:{url:window.location.href},icon:r.loginIcon_url(n),badge:r.badgeIcon_url,requireInteraction:!0,actions:l};r.isElectedSocket&&i("showNotification",{title:a,options:c})}}}})),define("DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument",["text!DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument.html","DS/UIKIT/Input/Button","DS/UIKIT/Mask"],(function(e,t,i){"use strict";var r=void 0;const s=(e,t,i,s)=>{var o={community_id:t,id_media:i};r.save({callbackUrl:e+"/api/media/editmedia",params:o,headers:{"X-DS-SWYM-CSRFTOKEN":"ode:{csrfToken}"},filenameForUpload:"userFile",firstCallUrl:e+"/api/session/info"}).then((function(e){s()}),(function(e){switch(e){case r.ERROR.NO_DOCUMENT_URL_PROVIDED:console.error("ODE Collab : NO_DOCUMENT_URL_PROVIDED");break;case r.ERROR.SERVICE_NOT_FOUND:console.error("ODE Collab : SERVICE_NOT_FOUND");break;default:console.error("ODE Collab : "+e)}s(e)}))};return{props:["featureData","featureId","active","swymDriver"],data:()=>({skip:!0}),computed:{dmId(){return this.$store.getters.dmId||this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId},title(){var e=this.featureData;if(!e||!e.title||!this.featureId)return this.publishButton&&this.publishButton.destroy(),this.$refs.OdeContainer&&this.$refs.OdeContainer.children[0]&&"function"==typeof this.$refs.OdeContainer.children[0].destroy&&this.$refs.OdeContainer.children[0].destroy(),r&&(r=void 0),null;if(e&&e.title&&e.ext&&e.url&&this.featureId){var o=this.$store.getters.swymUrl,a=this.dmId,n=this;this.publishButton=((e,i)=>{var r=document.getElementById("im-call-lightbox");if(r)var s=r.getElementsByClassName("lightbox-bar__menu");var o=s[0].getElementsByClassName("bt_publish");o[0]&&"function"==typeof o[0].destroy&&o[0].destroy();var a=new t({value:e,className:"primary bt_publish",id:"bt_publish",events:{onClick:i}});return a.getContent().style.alignSelf="center",a.getContent().style.paddingLeft="28px",a.getContent().style.paddingRight="28px",s[0].insertBefore(a.getContent(),s[0].firstChild),a})(this.$store.getters.nls("publish"),(()=>{i.mask(n.publishButton.getContent(),""),s(o,a,e.mediaId,(function(e){i.unmask(n.publishButton.getContent()),e?n.$store.dispatch("alert_publishDocumentError"):n.$store.dispatch("alert_publishDocument")}))})),(!this.reloadFeatureODE||this.reloadFeatureODE&&this.reloadFeatureODE.reload)&&((({title:e,ext:t,url:i},s,o,a,{isMobile:n,isODEEditionSupported:d})=>{if(!(e&&t&&i&&s))return console.error("loadODE missing params");o.children[0]&&"function"==typeof o.children[0].destroy&&o.children[0].destroy(),require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor","DS/OfficeDocumentEditorClient/Utils"]).then((function(l){r=l[0];var c=l[1];if(r){var u=UWA.extendElement(o);r.init({title:e,ext:t,url:i,readOnly:!1,docKeyToUse:"featureId"+s,useIframe:!0,rootElem:u,platformId:a}).then((function(e){const i=c.isDeviceSupportedForEditingDoc(n,(()=>{switch(t){case"docx":return c.DOCTYPE.WORD;case"pptx":return c.DOCTYPE.PRESENTATION;case"xlsx":return c.DOCTYPE.SPREADSHEET}})());d(i)}),(function(e){switch(e){case r.ERROR.NO_DOCUMENT_URL_PROVIDED:console.error("ODE Collab : NO_DOCUMENT_URL_PROVIDED");break;case r.ERROR.SERVICE_NOT_FOUND:console.error("ODE Collab : SERVICE_NOT_FOUND");break;default:console.error("ODE Collab : "+e)}}))}}))})(e,this.featureId,this.$refs.OdeContainer,this.$store.getters.tenant,{isMobile:this.$store.getters.isMobile,isODEEditionSupported:e=>this.$store.dispatch("send_isODEEditionNotSupported",e)}),this.reloadFeatureODE&&this.reloadFeatureODE.reload&&(this.$store.dispatch("reloadFeatures",{kind:"ode",reload:!1,deleteReloadData:!0}),this.$store.dispatch("removeFeatureData",this.getFeature)))}return e.title},getFeature(){return this.$store.getters.getFeatureOfKind("ode")},swymUrl(){return this.$store.getters.swymUrl},reloadFeatureODE(){return this.$store.getters.reloadFeature("ode")},reload(){var e,t,i,r,o=this;return this.reloadFeatureODE&&this.reloadFeatureODE.save&&s(o.swymUrl,o.$store.getters.oldDmId,o.featureData.mediaId,(function(e){e?o.$store.dispatch("alert_publishDocumentError"):(o.$store.dispatch("alert_publishDocument"),o.$store.dispatch("reloadFeatures",{kind:"ode",forward:!0,save:!1}))})),this.reloadFeatureODE&&this.reloadFeatureODE.forward&&(o.$store.dispatch("reloadFeatures",{kind:"ode",forward:!1,reload:!0}),o.$store.commit("isPrivateConv",!1),e=o.swymDriver,t=o.$store.getters.dmId,i=o.featureData,r=function(e){const t={...o.getFeature,featureData:e};o.$store.dispatch("sendFeature",t),o.$store.commit("feature",t)},new Promise(((s,o)=>e.forwardSwym(t,i.mediaId).then((t=>t?(i.model=t,i.mediaId=t.id_media,i.title=i.title||"New Document",i.ext=i.ext||t.play.download_original_url.format,e.getMediaSwym(i.mediaId).then((e=>(i.url=e.play.download_original_url.transient_url,i.reload=!0,r(i),s(i))))):o()))))),this.featureData.title}},template:e}})),define("DS/InstantMessagingCall/components/Watermark/Watermark",["text!DS/InstantMessagingCall/components/Watermark/Watermark.html"],(function(e){"use strict";return{props:[],data:()=>({ratio:16/9}),mounted(){this.videoMetaDimension()},computed:{screensharer_id(){return this.$store.getters.screensharer_id},screensharerInfo(){const e=this.screensharer_id&&`${this.$store.getters.user(this.screensharer_id).username} - ${this.$store.getters.login(this.screensharer_id)}           `;return e&&e.repeat(100)},isTheScreensharer(){return this.$store.getters.myself.user_id==this.screensharer_id},room_id(){return this.$store.getters.accepted_room_id},watermarkActivated(){return this.$store.getters.isWatermarkActivated(this.room_id)}},methods:{videoMetaDimension(){const e=document.querySelector(".im-call-user-item.hasVideo .im-call-video-item video");if(e){const t=e.videoWidth/e.videoHeight;e.addEventListener("loadedmetadata",(()=>{this.ratio=isNaN(t)||1==t||t==16/9?16/9:t}))}}},template:e}})),define("DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline",["DS/WAFData/WAFData","text!DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline.html"],(function(e,t){"use strict";var i,r;return{methods:{deleteTimelineChildren(){if(this.$refs.TimelineContainer)return this.$refs.TimelineContainer.children[0]&&this.$refs.TimelineContainer.children[0].destroy(),this.$refs.TimelineContainer;{const e=(this.$store.getters.windowRef?this.$store.getters.windowRef.document:document).getElementById("im-call-panel-timeline");return e&&e.children&&e.children[0]&&e.children[0].remove(),e}}},computed:{dmId(){if(this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options){const t=this.deleteTimelineChildren();var e=this.$store.getters.dmId||this.$store.getters.accepted_room.options.dmId;e&&((e,t,s,o)=>{if(i=i||require("DS/i3DXCompass/i3DXCompass"),r=r||require("UWA/Core"),!i||!r)return console.error("PanelTimeline prereqs not available");const a="X3DMCTY_AP",n=UWA.extendElement(e);n.getParent().style.height="100%";let d=t;const l=s.toUpperCase();i.getAppInfo({appId:a,onComplete:function(e){if(e){var t,i,s,o={communityType:"dm",community:d,x3dPlatformId:l,leftPanelState:"closed"},c=JSON.stringify(o),u={el:n,parent:!1,preview:!1,appId:a,data:c,header:!1};if(!e||!(e.checksum&&e.launchInfos||e.platforms))return console.error("Could not get valid Config from MyApps for the App "+u.appId);if(e.platformId&&e.platformId.toLowerCase()===l.toLowerCase())t=e.launchInfos,i=e.isolationLevel,s=e.checksum;else{var m=e.platforms.find((e=>e.id.toLowerCase()===l.toLowerCase()));if(!m)return console.error("Could not get valid Config from MyApps for the App "+u.appId);t=m.launchInfos,i=m.isolationLevel,s=m.checksum}u=r.extend(u,{widgetId:t,isolationLevel:i,token:s}),require("DS/TopFrame/TopFrame")._loadModules(["DS/UWPClientCode/WidgetFactory","DS/TopFrame/Environment"]).then((function(e){var t=e[0],i=e[1];t.load(u,(function(e){}),i)}))}}})})(t,e,this.$store.getters.tenant,this.$store.getters.isMobile)}return this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId}},template:t}})),define("DS/InstantMessagingCall/api/senders",["DS/RTProxyDriver/RTProxyDriver","DS/PlatformAPI/PlatformAPI"],(function(e,t){"use strict";const i=["startCall","endCall","acceptCall","webrtcIceCandidate","SDP","callEventFromView","getStrategy","setIdlePresence","sendAlert","sendAlertRemoved","sendFinalReportCall","sendSocketIdentifier","getRouterRtpCapabilities","clientRtpCapabilities","connectTransport","producer","consumer"],r={};for(let t of i)r[t]=function(i){return function(r){var s;return e.dispatch(i,[{...r,TxID:(s=`${t}`,Date.now()+"-r"+Math.floor(998*Math.random()+1)+"-"+s)}]),!0}}(t);return r.presence=t=>{e.dispatch("SETSTATUS",[{myStatus:t,statusMsg:t}])},r.ToSwym=e=>{t.publish("toswym.im.ds.com",e)},r.ToNotif=e=>{t.publish("tonotif.im.ds.com",e)},r})),define("DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard",["text!DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard.html","DS/UIKIT/Input/Button","DS/UIKIT/Mask"],(function(e,t,i){"use strict";const r=(e,t)=>new Promise(((i,r)=>{e.startPublish((e=>{if(!e)return r();var s=new File([e],"3DWhiteboard.3dwb"),o=new FormData;return o.append("is_illustration",!1),o.append("community_id",t.coreview.data.communityId||t.coreview.data.communityUri),o.append("title",t.title||t.model.title),o.append("userFile",s,s.name),o.append("published",1),t.coreview.data.mediaId?o.append("id_media",t.coreview.data.mediaId):o.append("fileName",s.name),i(o)}))})),s=(e,t)=>new Promise(((i,r)=>t.addMediaSwym(e).then((e=>e?i(e):r()))));return{props:["featureData","featureId","masterUser","active","swymDriver"],data:()=>({sketchObj:null,isLoaded:!1,mediaToForward:null}),computed:{title(){if(!this.active)return this.callInactive&&this.cleanWhiteboard(),this.publishButton&&this.publishButton.destroy(),null;var e=this.featureData;if(!e)return this.publishButton&&this.publishButton.destroy(),null;var o=this;return this.publishButton=((e,i)=>{var r=document.getElementById("im-call-lightbox");if(r)var s=r.getElementsByClassName("lightbox-bar__menu");var o=s[0].getElementsByClassName("bt_publish");o[0]&&"function"==typeof o[0].destroy&&o[0].destroy();var a=new t({value:e,className:"primary bt_publish",id:"bt_publish",events:{onClick:i}});return a.getContent().style.alignSelf="center",a.getContent().style.paddingLeft="28px",a.getContent().style.paddingRight="28px",s[0].insertBefore(a.getContent(),s[0].firstChild),a})(this.$store.getters.nls("publish"),(()=>{i.mask(o.publishButton.getContent(),""),r(o.sketchObj,o.featureData).then((t=>{i.unmask(o.publishButton.getContent()),o.featureData.edit=!0,o.featureData.coreview.data.mediaId?((e,t)=>new Promise(((i,r)=>t.editMediaSwym(e).then((e=>e?i(e):r())))))(t,o.swymDriver).then((t=>{o.featureData.model=t,e.coreview.action="initCoreview",o.isDOMWidget||o.createSketch(o.featureData)})):s(t,o.swymDriver).then((e=>{o.featureData.coreview.data.mediaId=e.id_media,o.featureData.model=e,o.featureData.fileUrl=e.play.download_original_url.transient_url,o.featureData.update=!0;const t={...o.getFeature,featureData:o.featureData};o.$store.dispatch("sendFeature",t),o.$store.commit("feature",t),o.isDOMWidget||o.createSketch(o.featureData)}))}))})),!this.isLoaded&&this.loadWhiteboard(),e.title},masterLogin(){if(!this.active||!this.masterUser)return null;var e=this.masterUser.login,t=e==this.$store.getters.myself.login;return this.sketchObj&&"function"==typeof this.sketchObj.onChangeCollabMaster&&this.sketchObj.onChangeCollabMaster({login:e,IAmMaster:t}),e},callInactive(){return this.$store.getters.isInitial||this.$store.getters.isEnded},getFeature(){return this.$store.getters.getFeatureOfKind("whiteboard")},reloadFeatureWhiteboard(){return this.$store.getters.reloadFeature("whiteboard")},reload(){var e,t,i,o,a,n=this;return this.reloadFeatureWhiteboard&&this.reloadFeatureWhiteboard.save&&(this.$store.dispatch("reloadFeatures",{kind:"whiteboard",save:!1}),r(this.sketchObj,this.featureData).then((e=>{s(e,n.swymDriver).then((e=>{e?(n.mediaToForward=e,n.$store.dispatch("reloadFeatures",{kind:"whiteboard",forward:!0})):console.error("ERROR when saving")}))}))),this.reloadFeatureWhiteboard&&this.reloadFeatureWhiteboard.forward&&(this.$store.dispatch("reloadFeatures",{kind:"whiteboard",forward:!1}),n.$store.commit("isPrivateConv",!1),(e=this.mediaToForward,t=this.swymDriver,i=this.featureData,o=this.$store.getters.dmId,this.isLoaded,a=function(e){n.isDOMWidget||n.createSketch(e);const t={...n.getFeature,featureData:e};n.$store.dispatch("sendFeature",t),n.$store.commit("feature",t)},new Promise(((r,s)=>t.forwardSwym(o,e.id_media).then((e=>e?(i.coreview.data.communityId=o,i.coreview.data.mediaId=e.id_media,i.coreview.action="initCoreview",i.model=e,i.fileUrl=e.play.download_original_url.transient_url,i.edit=!0,i.reload=!0,a(i),r(i)):s()))))).then((e=>{e||console.error("ERROR when forwarding"),n.$store.dispatch("removeFeatureData",n.getFeature),e.title})),this.$store.dispatch("reloadFeatures",{kind:"whiteboard",deleteReloadData:!0})),this.reloadFeatureWhiteboard&&this.reloadFeatureWhiteboard.reload&&(this.$store.dispatch("reloadFeatures",{kind:"whiteboard",reload:!1,deleteReloadData:!0}),this.isDOMWidget||this.createSketch(this.getFeature.featureData),this.$store.dispatch("removeFeatureData",this.getFeature)),this.featureData.title},isDOMWidget:()=>!!document.getElementById("im-call-whiteboard").firstChild},methods:{createSketch(e){this.isLoaded=!0;var t,i=this.$refs.WhiteboardContainer;i.children[0]&&"function"==typeof i.children[0].destroy&&i.children[0].destroy(),require("DS/TopFrame/TopFrame")._loadModules(["DS/CAT3DSKBootstrap/CAT3DSketchBootstrap"]).then((t=this,function(r){var s=r[0];s?(t.sketchObj=new s,t.sketchObj.create(i,e)):this.isLoaded=!1}))},loadWhiteboard(){this.isLoaded=!0;var e=this.featureData,t=this.$refs.WhiteboardContainer;if(!e||!t)return console.error("loadWhiteboard missing params");this.createSketch(e)},cleanWhiteboard(){this.sketchObj&&"function"==typeof this.sketchObj.destroy&&(this.sketchObj.destroy(),this.sketchObj=null,this.isLoaded=!1,this.publishButton&&this.publishButton.destroy())}},template:e}})),define("DS/InstantMessagingCall/store/modules/focus",["DS/RTProxyDriver/RTLogger"],(function(e){"use strict";return{state:{isHidden:null,hidden:null,visibilityChange:null},getters:{isHidden:e=>e.isHidden,hidden:e=>e.hidden,visibilityChange:e=>e.visibilityChange},mutations:{resetFocusState(e){Object.assign(e,{isHidden:null,hidden:null,visibilityChange:null})},isHidden:(e,t)=>{e.isHidden=!!t},hidden:(e,t)=>{e.hidden=t},visibilityChange:(e,t)=>{e.visibilityChange=t}},actions:{getFocusNavigatorValues({commit:e,getters:t}){void 0!==document.hidden?(e("hidden","hidden"),e("visibilityChange","visibilitychange")):void 0!==document.msHidden?(e("hidden","msHidden"),e("visibilityChange","msvisibilitychange")):void 0!==document.webkitHidden&&(e("hidden","webkitHidden"),e("visibilityChange","webkitvisibilitychange")),null!==t.hidden&&e("isHidden",document[t.hidden])},listenFocusEvent:({getters:t,commit:i,dispatch:r})=>void 0===document.addEventListener||null===t.hidden||null===t.visibilityChange?e.CallNotif("Browser does not support the Page Visibility API."):document[t.visibilityChange]?e.CallNotif("Focus Listener already started. isHidden: "+t.isHidden):void document.addEventListener(t.visibilityChange,(function(s){i("isHidden",document[t.hidden]),e.CallNotif("Focus - Visibility change: isHidden: "+t.isHidden),t.isHidden?(t.accepted_room_id&&(e.CallNotif("Focus - Accepted room: "+t.accepted_room_id),r("notifSW",{action:"callAccepted",data:{room_id:t.accepted_room_id}})),t.invitations&&t.invitations.length>0&&(e.CallNotif("Focus - Invitations room: "+t.invitations.length),t.invitations.map((e=>{r("notifSW",{action:"inviteReceived",data:{room_id:e}})})))):r("closeAllNotifications")})),startFocusListener({dispatch:t,getters:i}){t("getFocusNavigatorValues"),t("listenFocusEvent"),e.CallNotif("Focus Listener started. isHidden: "+i.isHidden)},stopFocusListener({getters:t}){if(void 0!==t.room_id_accepted||t.room_id_invitations&&t.room_id_invitations.length>0)return e.CallNotif("Not stopping focus listeners because some calls are still running.");document.removeEventListener(t.visibilityChange,(()=>{e.CallNotif("Focus Listener stopped")}))}}}})),define("DS/InstantMessagingCall/components/MemberAdd/MemberAdd",["text!DS/InstantMessagingCall/components/MemberAdd/MemberAdd.html","DS/RTInterface/RTInterface"],(function(e,t){"use strict";return{data(){return{selectUsers:{input:"",label:this.$store.getters.nls("users"),list:[],options:[],placeholder:this.$store.getters.nls("searchUser"),preserveSearchOnBlur:!0},topic:{label:this.$store.getters.nls("setTopicLabel"),model:"",placeholder:this.$store.getters.nls("setTopic"),rules:[e=>!this.isTopicEmpty]}}},props:["showAddUser"],updated(){this.showAddUser&&(this.selectUsers.input=this.$refs.searchUsersMultipleSelect.$refs.input,this.selectUsers.input.oninput=e=>{this.preserveSearchOnBlur(!0),e.target.value.length>2&&this.searchUsers(e.target.value),(e.target.value.length<3||""==e.target.value)&&this.sendEmptyUsersList()},this.selectUsers.input.onblur=e=>{this.sendEmptyUsersList(),this.selectUsers.preserveSearchOnBlur||(e.target.value=""),this.selectUsers.input.size=23},this.selectUsers.input.onfocus=e=>{this.selectUsers.input.readOnly=this.disableInput,e.target.value.length>2&&this.searchUsers(e.target.value)})},computed:{called_users_logins(){return this.$store.getters.called_users_logins},isPrivateConv(){return 2==this.$store.getters.called_users_logins.length&&this.$store.getters.isPrivateConv},isTopicEmpty(){return 0==this.topic.model.trim().length},addUserLimit(){return 15-(this.called_users_logins.length+this.selectUsers.list.length)},searchUsersList(){return Object.fromEntries(Object.entries(this.$store.getters.searchUsersList).filter((([e,t])=>!this.called_users_logins.includes(e)&&!this.selectUsers.list.includes(e))))},selectHelper(){return this.addUserLimit>0?this.$store.getters.nls("addUserLimit").replace("{0}",this.addUserLimit):0==this.addUserLimit?this.$store.getters.nls("reachMaxUsersConv"):""},removeUsersRule(){return this.$store.getters.nls("removeUsersRule").replace("{0}",Math.abs(this.addUserLimit))},room_id(){return this.$store.getters.accepted_room_id},room(){return this.$store.getters.room(this.room_id)},convTopic(){return this.isPrivateConv?this.topic.model:this.$store.getters.roomName(this.room)},disableInput(){return this.addUserLimit<1}},methods:{sendInvite(){let e;0==this.selectUsers.list.length&&(this.$store.dispatch("alert_addUser","emptyUsers"),e=!0),this.isPrivateConv&&this.isTopicEmpty&&(this.$store.dispatch("alert_addUser","emptyTopic"),e=!0),this.$refs.form.validate()&&(e||(this.$store.dispatch("addUserToCall",{room_id:this.room_id,logins:this.selectUsers.list,options:{topic:this.convTopic,isPrivateConv:this.isPrivateConv}}),this.hideAddUserModal()))},hideAddUserModal(){this.$store.commit("showAddUser",!1),this.sendEmptyUsersList(),this.selectUsers.list=[],this.selectUsers.options=[],this.topic.model=""},searchUsers:e=>t.send({evenement:"SEARCHCONTACT",data:e},"fromwidgetim.ds.com"),addUser(e,t){this.selectUsers.options.push({label:e,value:t}),this.selectUsers.list.push(t),this.sendEmptyUsersList(),this.preserveSearchOnBlur(!1)},sendEmptyUsersList(){this.$store.commit("searchUsersList",{users:{}})},preserveSearchOnBlur(e){this.selectUsers.preserveSearchOnBlur=e}},template:e}})),define("DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem",["text!DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem.html"],(function(e){"use strict";return{props:[],data:()=>({srcObject:null}),methods:{onloadeddata(e){this.play()}},computed:{src(){var e=this.$store.getters.mediaSource;if(!e)return null;try{return window.URL.createObjectURL(e)}catch(e){return console.error("TelephonyItem unable to compute src from stream "+e),null}}},template:e}})),define("DS/InstantMessagingCall/components/CustomType/CustomType",["text!DS/InstantMessagingCall/components/CustomType/CustomType.html"],(function(e){"use strict";return{props:["logins","isVideoMinimizeView"],computed:{users(){return this.logins&&0!=this.logins.length?this.logins.length>4?this.logins.slice(0,3):this.logins:[]},notDisplayed(){return this.logins&&0!=this.logins.length?this.logins.length<=4?0:this.logins.length-3:0}},template:e}})),define("DS/InstantMessagingCall/components/SpeakerName/SpeakerName",["text!DS/InstantMessagingCall/components/SpeakerName/SpeakerName.html"],(function(e){"use strict";return{props:["user_id"],computed:{username(){return this.$store.getters.user(this.user_id).username}},template:e}})),define("DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti",["text!DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti.html"],(function(e){"use strict";return{props:["featureData","masterUser","feature","active"],computed:{masterUsername(){return this.active?this.masterUser&&this.masterUser.username:null},IAmMaster(){return!!this.active&&(this.masterUser&&this.masterUser.login==this.$store.getters.myself.login)}},methods:{genId:function(e,t){return"confetti"+e+"-"+t},sendConfetti:function(e,t){this.IAmMaster&&!this.feature.featureData.confettis[this.genId(e,t)]&&this.$store.dispatch("send_confetti",{spanId:this.genId(e,t),feature:this.feature})}},template:e}})),define("DS/InstantMessagingCall/lib/NoiseMaker",["UWA/Class/Model"],(function(e){"use strict";return document.noiseMaker||(document.noiseMaker=new(e.extend({defaults:{ringtone:"./resources/en/1/webapps/InstantMessagingCall/assets/ringtone.mp3",userin:"./resources/en/1/webapps/InstantMessagingCall/assets/userin.mp3",userout:"./resources/en/1/webapps/InstantMessagingCall/assets/userout.mp3"},setup:function(e){this.timeouts={},this.audios={}},preload:function(){var e,t,i,r=this.pairs();for(e in r){t=r[e][0],i=r[e][1];try{this.audios[t]=new Audio(i)}catch(e){console.error("NoiseMaker unable to load sound "+t+" :"+e)}}},start:function(e,t){if(!e)e="ringtone";var i,r=this.audios[e];if(!r)return console.error("NoiseMaker start failed : tone not loaded "+e);r.loop=!!t;try{var s=r.play();void 0!==s&&s.then((function(){UWA.log("NoiseMaker play "+e)}),(function(t){console.error("NoiseMaker failed to play "+e+" : "+t)}))}catch(t){console.error("NoiseMaker failed to play "+e+" : "+t)}t&&"number"==typeof t&&(this.timeouts[e]=setTimeout((i=this,function(){i.stop(e)}),t))},stop:function(e){if(!e)e="ringtone";try{clearTimeout(this.timeouts[e]);var t=this.audios[e];if(!t)return console.error("NoiseMaker stop failed : tone not loaded "+e);t.pause(),t.currentTime=0,UWA.log("NoiseMaker stop "+e)}catch(e){console.error("NoiseMaker failed to stop tone "+e)}}}))),document.noiseMaker})),define("DS/InstantMessagingCall/components/MemberItem/MemberItem",["text!DS/InstantMessagingCall/components/MemberItem/MemberItem.html"],(function(e){"use strict";return{props:["user","hasJoined"],computed:{username(){return this.user.username},login(){return this.user.login},isAudioStreamer(){return this.user.stream_info.isAudioStreamer},isVideoStreamer(){return this.user.stream_info.isVideoStreamer},isAudioMuted(){return this.user.stream_info.isAudioStreamerMuted},isVideoMuted(){return this.user.stream_info.isVideoStreamerMuted},isScreenStreamer(){return this.user.stream_info.isScreenStreamer},isOnHold(){return this.user.stream_info.isOnHold},mustBeVisible(){return this.hasJoined?this.user.user_id==this.$store.getters.myself.user_id||this.$store.getters.accepters.indexOf(this.user.user_id)>-1:this.user.user_id!=this.$store.getters.myself.user_id&&!(this.$store.getters.accepters.indexOf(this.user.user_id)>-1)}},template:e}})),define("DS/InstantMessagingCall/lib/VueTeleport/VueTeleport",["text!DS/InstantMessagingCall/lib/VueTeleport/VueTeleport.html","DS/RTProxyDriver/RTLogger"],(function(e,t){"use strict";return{template:e,props:{width:{type:Number,default:870},height:{type:Number,default:570},left:{type:Number,default:200},top:{type:Number,default:200}},data:()=>({windowRef:null,windowLoaded:!1}),computed:{isCallWindowed(){return this.$store.getters.isCallWindowed?this.$nextTick(this.openPortal):this.closePortal(),this.$store.getters.isCallWindowed},isWindowOpened(){return!!this.$store.getters.windowRef}},mounted(){window.addEventListener("beforeunload",this.closePortal)},beforeDestroy(){this.closePortal()},methods:{openPortal(){if(this.windowRef)return;const e=window.location.origin+window.location.pathname,i=window.ds&&"MOBILE"===window.ds.env||window.top&&window.top.ds&&"MOBILE"===window.top.ds.env,{width:r,height:s,left:o,top:a}=this;if(i){this.windowRef=window.open("about:blank","_blank",`width=${r},height=${s},left=${o},top=${a},resizable=false`,`config={"id":"${this.generateRandomID()}", "options": {}}`);const e=setInterval((()=>{this.windowRef&&this.windowRef.document&&"complete"===this.windowRef.document.readyState&&(clearInterval(e),this.initBody(),this.$emit("opened",this.windowRef),this.$store.commit("windowRef",this.windowRef),this.windowRef.addEventListener("beforeunload",this.closePortal),this.windowRef.focus())}),10)}else this.windowRef=window.open(e,"_blank",`width=${r},height=${s},left=${o},top=${a},resizable=false`),this.windowRef.addEventListener("load",(()=>{this.initBody(),this.$emit("opened",this.windowRef),this.$store.commit("windowRef",this.windowRef),this.windowRef.addEventListener("message",(e=>{if(e.origin!==window.location.origin)return;const t=e.data;"showConfirmDialog"===t.action&&this.showConfirmDialog(t.message)})),this.windowRef.addEventListener("beforeunload",this.closePortal),this.windowRef.focus()}));this.windowRef?window.addEventListener("beforeunload",this.closePortal):t.Call("error: Failed to open window. Popup blocker may be active.")},closePortal(){this.windowRef&&(this.windowRef.close(),this.$store.commit("isCallWindowed",!1),this.$store.commit("windowRef",null),this.windowRef=null,window.removeEventListener("beforeunload",this.closePortal))},cloneStyles(){document.head.querySelectorAll("style, link[rel=stylesheet]").forEach((e=>{const t=e.cloneNode(!0);this.windowRef.document.head.appendChild(t)})),this.windowRef.document.body.classList.add("collabVueTeleportBody"),this.$store.getters.isDesktopApp&&(this.windowRef.document.body.classList.add("window-native-bar"),this.windowRef.document.body.parentElement.classList.add("collabVueTeleportHTML"))},initBody(){this.windowRef?.document.body.contains(this.$el)||(this.windowRef.document.body.innerHTML="",this.windowRef.document.body.appendChild(this.$el),this.cloneStyles())},showConfirmDialog(e){this.$confirm(this.$store.getters.nls("confirmEndCall"),this.$store.getters.nls("refuseCall"),{okLabel:this.$store.getters.nls("confirm"),cancelLabel:this.$store.getters.nls("cancel")})},generateRandomID(e=10){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array.from({length:e},(()=>t.charAt(Math.floor(62*Math.random())))).join("")}}}})),define("DS/InstantMessagingCall/store/modules/messages",["i18n!DS/InstantMessagingCall/assets/nls/feed","vuejs"],(function(e,t){"use strict";const i=e;return{state:{NLS:i,connexionLost:!1,bodyAlerts:{connexionLost:{text:i.startCallAbortedBecauseOffline,type:"warning",timeout:3e3,visible:!1},connexionRetrieved:{text:i.connexionRetrieved,type:"success",timeout:3e3,visible:!1},reconnectOngoing:{text:i.reconnectOngoing,type:"warning",timeout:3e3,visible:!1},connexionNetworkLost:{text:i.connexionNetworkLost,type:"error",timeout:0,visible:!1},callUnavailable:{text:i.callUnavailable,type:"warning",timeout:3e3,visible:!1},callUnavailablePlurial:{text:i.callUnavailablePlurial,type:"warning",timeout:3e3,visible:!1},callUnavailableSingular:{text:i.callUnavailableSingular,type:"warning",timeout:3e3,visible:!1},publishDocument:{text:i.publishDocument,type:"success",timeout:3e3,visible:!1},publishDocumentError:{text:i.publishDocumentError,type:"error",timeout:3e3,visible:!1},audiomuted:{text:i.audiomuted,type:"warning",timeout:3e3,visible:!1},mediaDeviceNotFound:{text:i.localMediaError_NotFoundError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessDisabled:{text:i.localMediaError_SecurityError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessAborted:{text:i.localMediaError_AbortError,type:"warning",timeout:3e3,visible:!1},mediaAccessNotAllowed:{text:i.localMediaError_NotAllowedError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessFailed:{text:i.localMediaError_OverConstrainedError,type:"warning",timeout:3e3,visible:!1},mediaDeviceNotSupported:{text:i.localMediaError_NotReadableError,type:"warning",timeout:3e3,visible:!1},browserNotCompatible:{text:i.localMediaError_TypeError,type:"warning",timeout:3e3,visible:!1},callOnHold:{text:i.alert_callOnHold,type:"primary",visible:!1,closable:!1},alreadyOnCall:{text:i.alreadyOnCall,type:"warning",timeout:3e3,visible:!1},emptyInvitedUsers:{text:i.emptyInvitedUsers_error,type:"error",timeout:0,visible:!1},emptyTopic:{text:i.emptyTopic_error,type:"error",timeout:0,visible:!1},ODEEditionNotSupported:{text:i.ODEEditionNotSupported,type:"warning",timeout:0,visible:!1},emptyMediaTitle:{text:i.emptyTitle,type:"error",timeout:0,visible:!1},invalidCharacters:{text:i.invalidCharacters,type:"error",timeout:0,visible:!1},audioOutputChangeNotSupported:{text:i.audioOutputChangeNotSupported,type:"warning",timeout:3e3,visible:!1},mobileUsersCannotViewContent:{text:i.mobileUsersCannotViewContent,type:"warning",timeout:3e3,visible:!1},audioinputUnplugged:{text:i.audioInputUnplugged,type:"primary",timeout:3e3,visible:!1},videoinputUnplugged:{text:i.videoInputUnplugged,type:"warning",timeout:3e3,visible:!1},audiooutputUnplugged:{text:i.audioOutputUnplugged,type:"primary",timeout:3e3,visible:!1},needSelectmicro:{text:i.needSelectMicro,type:"error",timeout:0,visible:!1},needSelectcamera:{text:i.needSelectCamera,type:"error",timeout:0,visible:!1},needSelectspeaker:{text:i.needSelectSpeaker,type:"error",timeout:0,visible:!1},mediasoupOnly:{text:"I'm Using Mediasoup Only",type:"success",timeout:3e3,visible:!1},connectedUserP2P:{text:"Connected to User {0} in P2P",type:"success",timeout:3e3,visible:!1},connectedUserMediasoup:{text:"Connected to User {0} with Mediasoup",type:"success",timeout:3e3,visible:!1},membersAdded:{text:i.membersAdded,type:"success",timeout:3e3,visible:!1},reconnecting:{text:i.reconnecting,type:"primary",timeout:0,visible:!1,closable:!1},connectionRestored:{text:i.connectionRestored,type:"success",timeout:3e3,visible:!1}}},getters:{nls:e=>t=>e.NLS[t],bodyAlerts:e=>e.bodyAlerts},mutations:{bodyAlertVisible:(e,{key:t,visible:i})=>{e.bodyAlerts[t]?e.bodyAlerts[t].visible=i:console.error("bodyAlert not found "+t)},connexionLost:(e,t)=>{e.connexionLost=t},bodyAlertText:(e,{key:t,text:i})=>{e.bodyAlerts[t]?e.bodyAlerts[t].text=i:console.error("bodyAlert not found "+t)},newCustomAlert:(e,{customNLSKey:i,text:r,timeout:s,type:o,closable:a,visible:n})=>{t.set(e.bodyAlerts,i,{type:o,timeout:s,visible:n,closable:a,text:r})},removeCustomAlert:(e,i)=>{t.set(e.bodyAlerts,i,{}),delete e.bodyAlerts[i]}},actions:{hide_bodyAlert({commit:e},t){e("bodyAlertVisible",{key:t,visible:!1})},show_bodyAlert({commit:e},t){e("bodyAlertVisible",{key:t,visible:!0})},alert_connexionLost({dispatch:e,commit:t}){t("connexionLost",!0),e("hide_bodyAlert","connexionRetrieved"),e("show_bodyAlert","connexionLost")},alert_connexionRetrieved({state:e,dispatch:t,commit:i}){e.connexionLost&&(t("hide_bodyAlert","connexionLost"),t("hide_bodyAlert","connexionNetworkLost"),t("show_bodyAlert","connexionRetrieved"),i("connexionLost",!1))},alert_reconnectOngoing({dispatch:e}){e("hide_bodyAlert","connexionLost"),e("hide_bodyAlert","connexionRetrieved"),e("hide_bodyAlert","connexionNetworkLost"),e("show_bodyAlert","reconnectOngoing")},alert_connexionNetworkLost({dispatch:e}){e("hide_bodyAlert","connexionLost"),e("hide_bodyAlert","connexionRetrieved"),e("hide_bodyAlert","reconnectOngoing"),e("show_bodyAlert","connexionNetworkLost")},alert_uncallableUsers({getters:e,dispatch:t,commit:i},{uncallableUsers:r,calledUsers:s}){const o=r.length;let a;if(0==s.length)a="callUnavailable";else{a=o>1?"callUnavailablePlurial":"callUnavailableSingular";i("bodyAlertText",{text:e.nls(a).replace("{0}",o).replace("{1}",s.length+o),key:a})}t("show_bodyAlert",a)},alert_publishDocument({dispatch:e}){e("show_bodyAlert","publishDocument")},alert_publishDocumentError({dispatch:e}){e("show_bodyAlert","publishDocumentError")},alert_audiomuted({dispatch:e}){e("show_bodyAlert","audiomuted")},alert_browserNotCompatible({dispatch:e}){e("show_bodyAlert","browserNotCompatible")},alert_getLocalMediaError({dispatch:e},t){switch(t.name){case"NotFoundError":case"DevicesNotFoundError":e("show_bodyAlert","mediaDeviceNotFound");break;case"SecurityError":e("show_bodyAlert","mediaDeviceAccessDisabled");break;case"AbortError":e("show_bodyAlert","mediaDeviceAccessAborted");break;case"NotAllowedError":case"PermissionDeniedError":e("show_bodyAlert","mediaAccessNotAllowed");break;case"NotReadableError":case"TrackStartError":case"InvalidStateError":case"MediaDeviceFailedDueToShutdown":case"MediaDeviceKillSwitchOn":case"InternalError":e("show_bodyAlert","mediaDeviceAccessFailed");break;case"OverConstrainedError":case"ConstraintNotSatisfiedError":e("show_bodyAlert","mediaDeviceNotSupported");break;case"TypeError":case"NotSupportedError":e("show_bodyAlert","browserNotCompatible");break;default:console.error(t)}},alert_callOnHold({dispatch:e}){e("show_bodyAlert","callOnHold")},alert_callResumed({dispatch:e}){e("hide_bodyAlert","callOnHold")},alert_alreadyOnCall({dispatch:e}){e("show_bodyAlert","alreadyOnCall")},alert_ODEEditionNotSupported({dispatch:e}){e("show_bodyAlert","ODEEditionNotSupported")},alert_addUser({dispatch:e},t){switch(t){case"emptyTopic":e("show_bodyAlert","emptyTopic");break;case"emptyUsers":e("show_bodyAlert","emptyInvitedUsers");break;default:console.error("unknown error",t)}},alert_emptyMediaTitle({dispatch:e}){e("show_bodyAlert","emptyMediaTitle")},alert_invalidCharacters({dispatch:e}){e("show_bodyAlert","invalidCharacters")},alert_audioOutputChangeNotSupported({dispatch:e}){e("show_bodyAlert","audioOutputChangeNotSupported")},alert_mobileUsersCannotViewContent({dispatch:e}){e("show_bodyAlert","mobileUsersCannotViewContent")},alert_deviceUnplugged({dispatch:e},t){e("show_bodyAlert",`${t}Unplugged`)},alert_needSelectDevice({dispatch:e},t){e("show_bodyAlert",`needSelect${t}`)},alert_mediasoupOnly({dispatch:e}){e("show_bodyAlert","mediasoupOnly")},alert_connectedUserP2P({dispatch:e,commit:t},i){t("bodyAlertText",{key:"connectedUserP2P",text:`Connected To User ${i} in P2P`}),e("show_bodyAlert","connectedUserP2P")},alert_connectedUserMediasoup({dispatch:e,commit:t},i){t("bodyAlertText",{key:"connectedUserMediasoup",text:`Connected To User ${i} with Mediasoup`}),e("show_bodyAlert","connectedUserMediasoup")},alert_membersAdded({commit:e,dispatch:t,getters:i},r){const s="membersAdded",o=r.map((e=>e.username)).join(", ");e("bodyAlertText",{text:i.nls(s).replace("{0}",o),key:s}),t("show_bodyAlert",s)},alert_reconnecting({commit:e,dispatch:t,getters:i},{show:r,user:s}){if(s&&s.id&&s.username){const t="userReconnecting",o=`${s.id}-${t}`;if(r){e("newCustomAlert",{customNLSKey:o,type:"primary",text:i.nls(t).replace("{0}",s.username),timeout:0,visible:!0,closable:!1})}else e("removeCustomAlert",o)}else t(r?"show_bodyAlert":"hide_bodyAlert","reconnecting")},alert_connectionRestored({commit:e,dispatch:t,getters:i},{user:r}){if(r&&r.id){const t="userConnectionRestored",s=`${r.id}-${t}`,o=i.nls(t).replace("{0}",r.username);e("newCustomAlert",{customNLSKey:s,type:"success",timeout:3e3,visible:!0,text:o}),setTimeout((()=>{e("removeCustomAlert",s)}),3e3)}else t("show_bodyAlert","connectionRestored")},resetCustomAlert({commit:e,dispatch:t,state:i},r){for(let t in i.bodyAlerts)r.test(t)&&e("removeCustomAlert",t);const s=r.toString();s.slice(1,s.lastIndexOf("/"))in i.bodyAlerts&&t("hide_bodyAlert","reconnecting")}}}})),define("DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem",["text!DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem.html"],(function(e){"use strict";return{props:["label","rightTooltip"],template:e}})),define("DS/InstantMessagingCall/lib/RTCallingTracker",["UWA/Class","UWA/Class/Model","UWA/Class/Collection","DS/RTProxyDriver/RTLogger","DS/WAFData/WAFData","DS/Usage/TrackerAPI","DS/RTProxyDriver/RTProxyDriver"],(function(e,t,i,r,s,o,a){"use strict";r.addLevel("WebRTCtracker","magenta");const n=t.extend({defaults:{login:null,isCaller:!1,date_accept:0,date_end:0,reason:null,date_stream_ok:0},toJSON:function(){var e=this._parent();for(let t in e)e[t]||delete e[t];return e}}),d=i.extend({model:n});var l=null;var c=function(e,t,i){var o=UWA.clone(e);if(!o)return r.WebRTCtracker("swymSender missing report");if(!t)return r.WebRTCtracker("swymSender missing webservice url");if(!i)return r.WebRTCtracker("swymSender missing base url");var a=JSON.stringify(o);r.WebRTCtracker("Swym Report : "+a+" to "+t),function(e,t){if(l)return t(l);s.authenticatedRequest(e+"/api/index/tk",{method:"GET",type:"json",onComplete:function(e){try{l=e.result.ServerToken,t(l)}catch(e){r.WebRTCtracker("Failed to resolve CSRF Token "+e)}},onFailure:function(e){r.WebRTCtracker("Failed to get CSRF Token "+e)}})}(i,(function(e){if(!e)return r.WebRTCtracker("Cannot send swym message without csrf token");s.authenticatedRequest(t,{method:"POST",type:"json",data:a,headers:{"Content-Type":"application/json","X-DS-SWYM-CSRFTOKEN":e},onComplete:function(e){r.WebRTCtracker("Swym report sent.")},onFailure:function(e){r.WebRTCtracker("Swym request failed : "+e)}})}))};return t.extend({defaults:{date_start:0,response_time:0,date_end:0,caller:null,logins:null,dmId:null,swymBaseUrl:null,swymWebservice:null},setup:function(e){for(var t of(this.get("swymBaseUrl")&&this.get("dmId")&&this.set("swymWebservice",this.get("swymBaseUrl")+"/api/directmessages/logavcall/"+this.get("dmId")),this.set("date_start",Date.now()),this.UsersStatus=new d,this.addUser({login:this.get("caller"),isCaller:!0,date_accept:this.get("date_start")}),this.get("logins")))this.addUser({login:t});this.listenTo(this.UsersStatus,"onChange",(function(e){r.WebRTCtracker("Status changed for "+e.id+" : "+JSON.stringify(e._changed))})),this.listenTo(this.UsersStatus,"onAdd",(function(e){r.WebRTCtracker("New user : "+e.get("login"))})),r.WebRTCtracker("startTracking "+JSON.stringify(this))},addUser:function(e){this.getByLogin(e.login)&&this.UsersStatus.remove(this.getByLogin(e.login)),this.UsersStatus.add(Object.assign({},e,{id:e.login}))},destroy:function(){this.stopListening(),this.UsersStatus.stopListening(),this.UsersStatus=null,this._parent()},getCaller:function(){return this.getByLogin(this.get("caller"))},getByLogin:function(e){return e?this.UsersStatus.get(e)?this.UsersStatus.get(e):(this.UsersStatus.add({id:e,login:e}),this.getByLogin(e)):(r.WebRTCtracker("missing login "+e),new n({login:"unknown"}))},logAccepted:function(e){this.getByLogin(e).set("date_accept",Date.now())},logEnded:function(e,t){this.getByLogin(e).set("date_end",Date.now()),this.getByLogin(e).set("reason",t)},logStream:function(e){var t=this.getByLogin(e);t.get("date_stream_ok")||t.set("date_stream_ok",Date.now())},logInviteSent:function(){this.set("response_time",Date.now()-this.get("date_start"))},logEvent:function(e,t){switch(e){case"callEnded":this.logEnded(t.login,t.reason);break;case"callAccepted":this.logAccepted(t.login);break;case"streamReceived":this.logStream(t.login);break;case"inviteSent":this.logInviteSent();break;default:r.WebRTCtracker("eventAction unknown : "+e)}},findMainEndReason:function(e){return"user_hangup"==this.getCaller().get("reason")&&1===e.accepters.length?"caller refused":"user_hangup"==this.getCaller().get("reason")&&e.accepters.length>1?"caller hang up":e.hangupers.length&&e.hangupers.length==e.accepters.length-1?"all callees hang up":"offline"==this.getCaller().get("reason")?"caller offline":e.missers.length&&e.missers.length==e.callables.length?"all callees missed":e.refusers.length&&e.refusers.length==e.callables.length?"all callees refused":e.callables.length?e.unexpectedReasons.length>=e.callables.length?"all streams failed":e.accepters.length?null:"nobody accepted the call":"all callees busy"},endCall:function(e,t){this.set("date_end",Date.now());var i={type:this.get("type")||"none",caller:this.get("caller"),callees:this.get("logins"),logins:this.UsersStatus.pluck("login"),date_start:this.get("date_start"),response_time:this.get("response_time"),date_end:this.get("date_end"),duration:this.get("date_end")-this.get("date_start"),usersDetails:this.UsersStatus.toJSON(),callables:UWA.Array.invoke(this.UsersStatus.filter((function(e){return!e.get("isCaller")&&"Busy"!=e.get("reason")})),"get","login"),accepters:UWA.Array.invoke(this.UsersStatus.filter((function(e){return 0!=e.get("date_accept")})),"get","login"),streamers:UWA.Array.invoke(this.UsersStatus.filter((function(e){return 0!=e.get("date_stream_ok")})),"get","login"),missers:UWA.Array.invoke(this.UsersStatus.filter((function(e){return"callMissed"==e.get("reason")||"callTimeout"==e.get("reason")})),"get","login"),refusers:UWA.Array.invoke(this.UsersStatus.filter((function(e){return!e.get("isCaller")&&"user_hangup"==e.get("reason")&&!e.get("date_accept")})),"get","login"),hangupers:UWA.Array.invoke(this.UsersStatus.filter((function(e){return!e.get("isCaller")&&"user_hangup"==e.get("reason")&&e.get("date_accept")})),"get","login"),allReasons:UWA.Array.invoke(this.UsersStatus.filter((function(e){return e.get("reason")})),"get","reason"),calleesReasons:UWA.Array.invoke(this.UsersStatus.filter((function(e){return!e.get("isCaller")&&e.get("reason")})),"get","reason"),unexpectedReasons:UWA.Array.invoke(this.UsersStatus.filter((function(e){return!(!e.get("reason")||-1!=["user_hangup","callTimeout","callMissed","Busy"].indexOf(e.get("reason")))})),"get","reason"),dmId:this.get("dmId")};i.mainEndReason=this.findMainEndReason(i),r.WebRTCtracker(i),e||this.gen3DSwymReport(i),!0!==t&&this.gen3DAnalyticsReport(i),this.gen3DMessagingReport(i)},gen3DSwymReport:function(e){return c({users:e.accepters,type:e.type,usersDetails:e.usersDetails,date_start:e.date_start,date_end:e.date_end},this.get("swymWebservice"),this.get("swymBaseUrl"))},gen3DMessagingReport:function(e){return function(e){var t=UWA.clone(e);a.dispatch("callEventFromView",{action:"reporting",report:t})}({type:e.type,duration:e.duration,mainEndReason:e.mainEndReason,users:e.usersDetails})},gen3DAnalyticsReport:function(e){var t={appID:"X3DIMSG_AP",eventCategory:"call",eventAction:"end",eventLabel:"3DMessaging call report",eventValue:e.duration,persDim:{pd1:e.type,pd2:e.mainEndReason},persVal:{pv1:e.logins.length,pv2:e.accepters.length-1,pv3:e.streamers.length,pv4:e.missers.length,pv5:e.refusers.length,pv6:e.unexpectedReasons.length,pv7:e.response_time,pv8:e.callables.length,pv9:e.hangupers.length}},i=2;for(var s of e.allReasons)t.persDim["pd"+ ++i]=s;return function(e){var t=UWA.clone(e);try{r.WebRTCtracker("Analytics report : "+JSON.stringify(t)),t.callback=function(e){r.WebRTCtracker("Analytics report sent.")},o.trackPageEvent(t)}catch(e){r.WebRTCtracker("Analytics request failed : "+e)}}(t)}})})),define("DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay",["DS/3DPlayHelper/3DPlayHelper","UWA/Data","text!DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay.html"],(function(e,t,i){"use strict";var r;return{props:["featureData","featureId","masterUser","active","feature","swymDriver"],computed:{title(){if(!this.active)return null;var t=this.featureData;return t?(r&&r.isReady&&r.isReady()?console.log("Collab 3DPLay player already running"):((t,i,s,o)=>{if(!t||!i)return console.error("load3DPlay missing params");if(!t.mime)return console.error("load3DPlay missing mime");if(!t.fileName)return console.error("load3DPlay missing fileName");if(!t.path)return console.error("load3DPlay missing path");i.children[0]&&"function"==typeof i.children[0].destroy&&i.children[0].destroy();const a={collabmode:!0,container:i,input:{asset:{filename:t.path,provider:"FILE",format:t.mime,type:t.mime}},options:{loading:"autoplay",callbacks:{experience:{ExperienceReady:()=>{s&&(r.setCollabMode(!0),"function"==typeof o&&r.addCollabCB(((e,t)=>{o({arg1:e,arg2:t})})))}},asset:{LoadingFinished:()=>{console.log("Collab 3DPlay LoadingFinished")}}}}};a.input.asset.originalAsset=JSON.parse(JSON.stringify(a.input.asset)),r&&"function"==typeof r.dispose&&r.dispose(),r=new e(a)})(t,this.$refs.TroisDPlayContainer,this.IAmMaster,this.collabCallback),t.title):null},IAmMaster(){return this.masterUser&&this.masterUser.login==this.$store.getters.myself.login},masterLogin(){if(!this.active||!this.masterUser)return null;var e=this.masterUser.login;return console.log("Collab 3DPLay master changed "+e),e},actions(){if(this.IAmMaster||!this.active||!this.feature||!this.feature.featureData)return null;var e=this.feature.featureData.actions;return e&&this.onCoreviewAction(e),e},reload:()=>null},methods:{collabCallback({arg1:e,arg2:t}){this.$store.dispatch("send_3DPlay_data",{room_id:this.feature.room_id,featureId:this.featureId,featureData:this.featureData,actions:{arg1:e,arg2:t}})},onCoreviewAction({arg1:e,arg2:t}){if(r&&"function"==typeof r.isReady&&r.isReady()&&"function"==typeof r.performAction)try{r.performAction(e,t)}catch(e){console.error(e)}}},template:i}})),define("DS/InstantMessagingCall/lib/ConfirmEndCallModal/ConfirmEndCallModal",["text!DS/InstantMessagingCall/lib/ConfirmEndCallModal/ConfirmEndCallModal.html"],(function(e){"use strict";return{emits:["closeModal"],methods:{closeModal(){emit("closeModal")},confirmHangup(){this.$refs.lightboxComponent&&this.$refs.lightboxComponent.endCall()}},template:e}})),define("DS/InstantMessagingCall/store/modules/telephony",["DS/RTProxyDriver/RTLogger"],(function(e){"use strict";window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;return{state:{mediaSource:null,telwebsocket:null,mediaRecorder:null,holdRecorder:null,sourceBuffer:null,streamTel:null,streamHold:null,streaming:!1,callOnHold:!1,audioBitsPerSecond:null,holdFramesCount:0},mutations:{resetTelephonyState(e){Object.assign(e,{mediaSource:null,telwebsocket:null,mediaRecorder:null,holdRecorder:null,sourceBuffer:null,streamTel:null,streamHold:null,streaming:!1,callOnHold:!1,audioBitsPerSecond:null,holdFramesCount:0})},telwebsocket:(e,t)=>{e.telwebsocket=t},mediaRecorder:(e,t)=>{e.mediaRecorder=t},holdRecorder:(e,t)=>{e.holdRecorder=t},mediaSource:(e,t)=>{e.mediaSource=t},streamTel:(e,t)=>{e.streamTel=t},streamHold:(e,t)=>{e.streamHold=t},sourceBuffer:(e,t)=>{e.sourceBuffer=t},streaming:(e,t)=>{e.streaming=!!t},callOnHold:(e,t)=>{e.callOnHold=!!t},audioBitsPerSecond:(e,t)=>{e.audioBitsPerSecond=t},holdFramesCount:(e,t)=>{t?e.holdFramesCount=0:e.holdFramesCount++}},getters:{mediasource:e=>e.mediaSource,mediaSource:e=>e.mediaSource,mediaRecorder:e=>e.mediaRecorder,holdRecorder:e=>e.holdRecorder,sourceBuffer:e=>e.sourceBuffer,streamTel:e=>e.streamTel,streamHold:e=>e.streamHold,telwebsocket:e=>e.telwebsocket,streaming:e=>e.streaming,callOnHold:e=>e.callOnHold,audioBitsPerSecond:e=>e.audioBitsPerSecond,holdFramesCount:e=>e.holdFramesCount},actions:{recordHoldStream({getters:t,dispatch:i},{audioBitsPerSecond:r}){e.Call("Telephony recordHoldStream");const s=new Audio(t.holdtoneURL);s.loop=!0;const o=new window.AudioContext,a=o.createMediaElementSource(s),n=o.createMediaStreamDestination();a.connect(n),s.play();i("onHoldMediaStream",{stream:n.stream,audioBitsPerSecond:r})},onHoldMediaStream:({commit:t,getters:i,dispatch:r},{stream:s,audioBitsPerSecond:o})=>(e.Call("Telephony onHoldMediaStream"),s?(t("streamHold",s),o&&t("audioBitsPerSecond",o),t("holdRecorder",new MediaRecorder(i.streamHold,{audioBitsPerSecond:i.audioBitsPerSecond||24e3})),i.holdRecorder?(i.holdRecorder.ondataavailable=e=>{i.holdFramesCount>1?r("sendHoldStreamWebTel",e.data):t("holdFramesCount",!1)},i.holdRecorder.onpause=()=>e.Call("Telephony holdRecorder onpause."),void r("resumeHoldTrack")):console.error("Telephony failed to create holdRecorder")):e.Call("Telephony onHoldMediaStream no stream")),sendHoldStreamWebTel({getters:e},t){e.telwebsocket&&e.telwebsocket.emit("web-hold-stream",t)||console.error("cant sendHoldStreamWebTel : missing telwebsocket")},muteHoldTrack({getters:t}){if(e.Call("Telephony muteHoldTrack"),t.callOnHold||!t.holdRecorder||"inactive"===t.holdRecorder.state)return Promise.reject("muteHoldTrack failed: no holdRecorder active or call on hold.");try{return t.holdRecorder.pause()}catch(e){return Promise.reject("muteHoldTrack failed "+e)}},resumeHoldTrack({getters:t,dispatch:i}){if(e.Call("Telephony resumeHoldTrack"),!t.callOnHold)return Promise.reject("resumeHoldTrack failed: call is not on hold.");if(t.holdRecorder||i("recordHoldStream",{}),"inactive"===t.holdRecorder.state)return t.holdRecorder.start(20);try{return t.holdRecorder.resume()}catch(e){return Promise.reject("resumeHoldTrack failed "+e)}},stopHoldTrack({getters:t,commit:i}){if(e.Call("Telephony stopHoldTrack"),i("holdFramesCount",!0),!t.holdRecorder)return!0;if(t.holdRecorder.ondataavailable=null,t.holdRecorder.onpause=null,"inactive"===t.holdRecorder.state)return!0;try{return t.holdRecorder.stop()}catch(t){e.Call("Telephony stopHoldTrack failed "+t)}},stopHoldStream({getters:t}){e.Call("Telephony stopHoldStream");try{return t.streamHold.getTracks().forEach((e=>e&&e.stop&&e.stop()))}catch(t){e.Call("Telephony stopHoldStream failed "+t)}},recordStream:({dispatch:t},{audioBitsPerSecond:i})=>(e.Call("Telephony recordStream"),t("getUserMedia",{audio:!0}).then((e=>t("onMediaDeviceStream",{stream:e,audioBitsPerSecond:i}))).catch((function(t){e.Call("Fail to record, error in getUserMedia "+t)}))),onMediaDeviceStream:({commit:t,getters:i,dispatch:r},{stream:s,audioBitsPerSecond:o})=>(e.Call("Telephony onMediaDeviceStream"),s?(t("streamTel",s),o&&t("audioBitsPerSecond",o),t("mediaRecorder",new MediaRecorder(i.streamTel,{audioBitsPerSecond:i.audioBitsPerSecond||24e3})),i.mediaRecorder?(i.mediaRecorder.ondataavailable=e=>r("sendStreamWebTel",e.data),i.mediaRecorder.onpause=()=>e.Call("Telephony mediaRecorder onpause."),void r("resumeTelTrack")):console.error("Telephony failed to create MediaRecorder")):e.Call("Telephony onMediaDeviceStream no stream")),sendStreamWebTel({getters:e},t){e.telwebsocket&&e.telwebsocket.emit("web-stream",t)||console.error("cant sendStreamWebTel : missing telwebsocket")},resumeTelTrack({getters:t,dispatch:i}){if(e.Call("Telephony resumeTelTrack"),!t.streaming||t.callOnHold)return Promise.reject("resumeTelTrack failed: call on hold or not streaming.");if(t.mediaRecorder||i("recordStream",{}),"inactive"===t.mediaRecorder.state)return t.mediaRecorder.start(20);try{return t.mediaRecorder.resume()}catch(e){return Promise.reject("resumeTelTrack failed "+e)}},muteTelTrack({getters:t}){if(e.Call("Telephony muteTelTrack"),!t.mediaRecorder||"inactive"===t.mediaRecorder.state)return Promise.reject("muteTelTrack failed: No active mediaRecorder.");try{return t.mediaRecorder.pause()}catch(e){return Promise.reject("muteTelTrack failed "+e)}},stopTelTrack({getters:t}){if(e.Call("Telephony stopTelTrack"),!t.mediaRecorder)return!0;if(t.mediaRecorder.ondataavailable=null,t.mediaRecorder.onpause=null,"inactive"==t.mediaRecorder.state)return!0;try{return t.mediaRecorder.stop()}catch(t){e.Call("Telephony stopTelTrack failed "+t)}},stopTelStream({getters:t}){e.Call("Telephony stopTelStream");try{return t.streamTel.getTracks().forEach((e=>e&&e.stop&&e.stop()))}catch(t){e.Call("Telephony stopTelStream failed "+t)}},activeStreamWebTel({dispatch:t,commit:i},{onHold:r}){e.Call("Telephony activeStreamWebTel- onHold: "+r),i("callOnHold",r),t("muteHoldTrack").catch((t=>e.Call("Telephony activeStreamWebTel "+t))).then((()=>t("resumeTelTrack"))).catch((t=>e.Call("Telephony activeStreamWebTel "+t)))},muteStreamWebTel({dispatch:t,commit:i},{onHold:r}){e.Call("Telephony muteStreamTelWeb - onHold: "+r),i("callOnHold",r),t("muteTelTrack").catch((t=>e.Call("Telephony muteStreamTelWeb "+t))).then((()=>t("resumeHoldTrack"))).catch((t=>e.Call("Telephony muteStreamTelWeb "+t)))},initMediaSource({commit:t,getters:i,dispatch:r}){if(e.Call("Telephony initMediaSource"),t("mediaSource",new MediaSource),!i.mediaSource)return console.error("Telephony failed to create MediaSource");i.mediaSource.addEventListener("sourceopen",(t=>{e.Call("Telephony initMediaSource sourceopen"),r("onMediaSourceOpen",t)}))},onMediaSourceOpen({getters:t,commit:i,dispatch:r}){if(e.Call("Telephony onMediaSourceOpen"),!t.mediaSource)return console.error("Telephony onMediaSourceOpen no mediaSource");i("sourceBuffer",t.mediaSource.addSourceBuffer("audio/mpeg")),r("received_track_audio",{user_id:t.accepters[0]},{root:!0})},stopSourceBuffer({getters:t}){e.Call("Telephony stopSourceBuffer");try{return t.sourceBuffer&&t.sourceBuffer.abort()}catch(t){e.Call("Telephony stopSourceBuffer failed "+t)}},stopMediaSource({getters:t}){if(e.Call("Telephony stopMediaSource"),!t.mediaSource)return!0;try{if(t.mediaSource.onsourceopen=null,"open"!=t.mediaSource.readyState)return!0;t.mediaSource.endOfStream(),t.mediaSource.removeSourceBuffer(t.sourceBuffer)}catch(t){e.Call("Telephony stopMediaSource failed "+t)}},disconnectTelWS({getters:t}){e.Call("Telephony disconnectTelWS");try{return!(t.telwebsocket&&!t.telwebsocket.disconnected)||t.telwebsocket.io.disconnect()}catch(t){e.Call("Telephony disconnectTelWS failed "+t)}},connectTelWS:({commit:t,dispatch:i,getters:r},{connectionParams:s,call_id:o,url:a,cookie:n})=>s?a?o?(n||e.Call("WARNING - TelWS will be randomly chosen without cookie"),r.telwebsocket?e.Call("TelWS already exists "+(r.telwebsocket.call_id&&r.telwebsocket.call_id==o)&&"for same call"):(e.Call("connectTelWS "+a+" for call "+o),cookieStore.set({name:"TELSERVERID",value:n,path:"/",domain:"3ds.com"}),t("telwebsocket"),r.telwebsocket?(r.telwebsocket.call_id=o,r.telwebsocket.cookie=n,r.telwebsocket.on("connect",(e=>{i("onConnect",e)})),r.telwebsocket.on("connection_ok",(e=>{i("onConnectionOK",e)})),r.telwebsocket.on("start-streaming",(e=>{i("onStartStream",e)})),r.telwebsocket.on("stop-streaming",(e=>{i("onStopStream",e)})),r.telwebsocket.on("pstn-stream",(e=>{i("onPstnStream",e)})),void r.telwebsocket.on("disconnect",(e=>{i("onDisconnect",e)}))):e.Call("connectTelWS failed"))):e.Call("cant connectTelWS without call_id"):e.Call("cant connectTelWS without url"):e.Call("cant connectTelWS without params"),onDisconnect({dispatch:t},i){e.Call("Telephony close-ws "+i&&i.call_id),t("cleanTelephony")},onPstnStream({getters:t},i){try{if(!t.sourceBuffer)throw"no sourceBuffer.";if(!t.mediaSource||"open"!=t.mediaSource.readyState)throw"mediaSource not ready";if(t.sourceBuffer.updating)return e.Call("Telephony onPstnStream sourceBuffer is already processing another chunk");t.sourceBuffer.appendBuffer(i)}catch(t){e.Call("Telephony onPstnStream Error : "+t)}},onStartStream({dispatch:t,getters:i,commit:r},s){e.Call("Telephony start-streaming."),r("streaming",!0),i.mediaRecorder&&"inactive"!==i.mediaRecorder.state||t("recordStream",s)},onStopStream({dispatch:t,commit:i},r){e.Call("Telephony stop-streaming"),i("streaming",!1),t("muteTelTrack"),t("muteHoldTrack")},onConnectionOK({getters:t,dispatch:i},r){e.Call("Telephony connection_ok"),i("initMediaSource"),t.telwebsocket.emit("init_call",{call_id:t.telwebsocket.call_id,cookie:t.telwebsocket.cookie,allCookie:document.cookie})},onConnect({},t){e.Call("Telephony connected")},cleanTelephony({getters:t,commit:i,dispatch:r},s){r("stopTelTrack").then((()=>r("stopTelStream"))).then((()=>r("stopHoldTrack"))).then((()=>r("stopHoldStream"))).then((()=>r("disconnectTelWS"))).then((()=>r("stopMediaSource"))).then((()=>r("stopSourceBuffer"))).then((()=>i("resetTelephonyState"))).catch((t=>{e.Call("Telephony cleanTelephony failed "+t),i("resetTelephonyState")}))}}}})),define("DS/InstantMessagingCall/store/modules/usergroup",["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI","DS/WAFData/WAFData","DS/RTProxyDriver/RTLogger","DS/RTConvAPI/drivers/RTC_driver","DS/OfficeDocumentEditorClient/Editor"],(function(e,t,i,r,s,o){"use strict";return{state:Object.assign({odeFeature:!0,whiteboardFeature:!0,telephonyFeature:!1,troisdplayFeature:!1,addUserFeature:!0,changeMediaDeviceFeature:!0,standAloneCollabFeature:!1,standAloneCollabForAppFeature:!1},{}),getters:{odeFeature:e=>e.odeFeature,whiteboardFeature:e=>e.whiteboardFeature,telephonyFeature:e=>e.telephonyFeature,troisdplayFeature:e=>e.troisdplayFeature,addUserFeature:e=>e.addUserFeature,changeMediaDeviceFeature:e=>e.changeMediaDeviceFeature,standAloneCollabFeature:e=>e.standAloneCollabFeature,standAloneCollabForAppFeature:e=>e.standAloneCollabForAppFeature},mutations:{changeOdeFeature(e,t){e.odeFeature=t},changeWhiteboardFeature(e,t){e.whiteboardFeature=t},changeTelephonyFeature(e,t){e.telephonyFeature=t},change3DPlayFeature(e,t){e.troisdplayFeature=t},changeaddUserFeature(e,t){e.addUserFeature=t},changeChangeMediaDeviceFeature(e,t){e.changeMediaDeviceFeature=t},changeStandAloneCollabFeature(e,t){e.standAloneCollabFeature=t},changeStandAloneCollabForAppFeature(e,t){e.standAloneCollabForAppFeature=t}},actions:{getCollaborationFeatures({dispatch:e,getters:t,commit:i}){e("getCollaborationFeature",{feature:"whiteboard",mutationMethod:"changeWhiteboardFeature",uwp:"app.swymfeature.activateWBCollab"}),e("getCollaborationFeature",{feature:"telephony",mutationMethod:"changeTelephonyFeature",uwp:"app.swymfeature.activatePhoneCall"}),e("getCollaborationFeature",{feature:"3dplay",mutationMethod:"change3DPlayFeature",uwp:"app.swymfeature.activate3DPlay"}),e("getCollaborationFeature",{feature:"ode",mutationMethod:"changeOdeFeature",uwp:"app.swymfeature.activateODECollab"}).then((()=>{t.odeFeature&&o&&"function"==typeof o.isGranted&&o.isGranted({platformId:t.tenant}).then((()=>{r.Call("ODEClientEditor activated and granted")})).catch((e=>{r.Call("ODEClientEditor activated but not granted "+e),i("changeOdeFeature",!1)}))})),e("getCollaborationFeature",{feature:"addUser",mutationMethod:"changeaddUserFeature",uwp:"app.swymfeature.activateCollabAddUser"}).then((()=>{const e=s.getInstance(t.tenant);t.addUserFeature&&e&&e.checkCallAddUserActivation().then((e=>{i("changeaddUserFeature",e)}))})),e("getCollaborationFeature",{feature:"changeMediaDevice",mutationMethod:"changeChangeMediaDeviceFeature",uwp:"app.swymfeature.activateCollabChangeMediaDevice"}).then((()=>{const e=s.getInstance(t.tenant);t.changeMediaDeviceFeature&&e&&e.checkCallChangeMediaDeviceFeature().then((e=>{i("changeChangeMediaDeviceFeature",e)}))})),e("getCollaborationFeature",{feature:"standAloneCollabForApp",mutationMethod:"changeStandAloneCollabForAppFeature",uwp:"app.swymfeature.standAloneCollabForAppFeature"}).then((()=>{const e=s.getInstance(t.tenant);t.standAloneCollabForAppFeature&&e&&e.checkStandAloneCollabForAppActivation().then((e=>{i("changeStandAloneCollabForAppFeature",e)}))})),e("getCollaborationFeature",{feature:"standAloneCollab",mutationMethod:"changeStandAloneCollabFeature",uwp:"app.swymfeature.standAloneCollabFeature"}).then((()=>{const e=s.getInstance(t.tenant);t.standAloneCollabFeature&&e&&e.checkStandAloneCollabActivation().then((e=>{i("changeStandAloneCollabFeature",e)}))}))},getCollaborationFeature({getters:e,dispatch:i,commit:s},{feature:o,mutationMethod:a,uwp:n}){if(UWA&&UWA.Utils&&UWA.Utils.getQueryString(document.URL,"activateCollab")||location&&location.href&&location.href.contains("activateCollab"))return s(a,!0);if("3dprint"==e.appName)return s(a,!1);const d=t.getApplicationConfiguration(n);return""===d||"true"===d||!0===d?s(a,!0):"false"===d?s(a,!1):void 0!==d?i("isUserInUserGroup",d).then((()=>{r.Call("Usergroup activation of feature "+o),s(a,!0)})).catch((e=>{r.Call("Usergroup deactivation of feature "+o+" : "+e),s(a,!1)})):void 0},isUserInUserGroup({getters:t},s){const o=t.tenant.toUpperCase(),a=t.myself.username;return new Promise(((t,n)=>{e.getServiceUrl({serviceName:"3DSearch",platformId:o,onComplete:function(e){if(!e)return r.Call("Can't check usergroup without searchUrl"),n();i.authenticatedRequest(e+"/search",{method:"POST",type:"json",headers:{"Content-Type":"application/json"},data:JSON.stringify({with_synthesis_hierarchical:!1,with_synthesis:!1,with_synthesis_attribute:!1,source:["usersgroup"],query:'[ds6w:label]:"'+s+'"',select_predicate:["ds6w:hasMember","ds6w:responsible"],label:"bot",tenant:o}),onComplete:function(e){var i=[];return e&&e.results?(e.results.forEach((function(e){i=i.concat(e.attributes)})),i.filter((function(e){return"ds6w:hasMember"===e.name&&e.value===a||"ds6w:responsible"===e.name&&e.value===a})).length>0?t():n("not in usergroup")):n()},onFailure:function(t){return r.Call("AuthenticatedRequest on "+e+"/search failed : "+t),n("request to "+e+" failed")}})},onFailure:function(){return n("request to i3DXCompassPlatformServices failed")}})}))}}}})),define("DS/InstantMessagingCall/lib/WindowBar/WindowBar",["text!DS/InstantMessagingCall/lib/WindowBar/WindowBar.html"],(function(e){return{template:e,mounted(){window.document.body.classList.add("window-native-bar")}}})),define("DS/InstantMessagingCall/components/ModalTitle/ModalTitle",["text!DS/InstantMessagingCall/components/ModalTitle/ModalTitle.html"],(function(e){"use strict";return{data(){return{title:{label:this.$store.getters.nls("enterAFileName"),placeholder:this.$store.getters.nls("fileName"),rules:[e=>!this.isTitleEmpty]}}},props:["showModal","modalTitle","modelTitle"],computed:{isTitleEmpty(){return this.modelTitle&&0==this.modelTitle.trim().length},dontValidate(){return!(this.$refs.form.validate()&&!this.isTitleEmpty)}},methods:{updateTitle(e){this.$emit("input",e)},sendTitle(){this.dontValidate?this.$store.dispatch("alert_emptyMediaTitle"):this.showModal&&this.$emit("send")},closeModal(){this.showModal&&this.$store.commit("showModalTitle",!1),this.$emit("clear")}},template:e}})),define("DS/InstantMessagingCall/components/SettingsItem/SettingsItem",["text!DS/InstantMessagingCall/components/SettingsItem/SettingsItem.html"],(function(e){"use strict";return{props:["icon","label","select","selectOption","preview"],methods:{updateSelect(e){this.$emit("input",e)},warningOnSettings(e){this.$emit("click",e)}},template:e}})),require.config({paths:{vuejs:window.dsDefaultWebappsBaseUrl+"vuejs/2.6.10/vue.min",vuex:window.dsDefaultWebappsBaseUrl+"vuex/3.1.1/vuex.min","vu-kit":window.dsDefaultWebappsBaseUrl+"vuekit/vu-kit.umd.min","mediasoup-client":window.dsDefaultWebappsBaseUrl+"VENMediaSoupClient/mediasoup-client"}}),define("DS/InstantMessagingCall/InstantMessagingCall",["vuejs","vu-kit","vuex","DS/RTVueUserPresenceAPI/RTVueUserPresenceAPI","DS/RTDialer/RTDialer","css!vuekit/vu-kit"],(function(e,t,i,r,s){"use strict";return e.use(t),e.use(i),{init(e){require(["DS/InstantMessagingCall/main"],(function(t){t.init(e)}))}}})),define("DS/InstantMessagingCall/components/VideoItem/VideoItem",["text!DS/InstantMessagingCall/components/VideoItem/VideoItem.html","DS/InstantMessagingCall/components/Watermark/Watermark"],(function(e,t){"use strict";return{components:{"im-call-watermark":t},props:["stream","user_id","isSpeakerView","isAudioMuted","isVideoMuted","track_id","muted","isSelfView"],data:()=>({srcObject:null}),computed:{video_track_id(){var e=this.stream&&this.stream.getVideoTracks();if(e&&e.length)return this.stream.getVideoTracks()[0].id},src(){try{try{return window.URL.createObjectURL(this.stream)}catch(e){return this.srcObject=this.stream,null}}catch(e){return console.error("VideoItem unable to compute src from stream "+e),null}}},methods:{toggleSpeaker(){if(!this.$store.getters.clickOnVideo)return!0;this.isSpeakerView?this.$store.dispatch("removeSpeaker",{user_id:this.user_id}):this.$store.dispatch("setAsSpeaker",{user_id:this.user_id,track_id:this.video_track_id})}},template:e}})),define("DS/InstantMessagingCall/components/UserItem/UserItem",["text!DS/InstantMessagingCall/components/UserItem/UserItem.html","DS/InstantMessagingCall/components/VideoItem/VideoItem","DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem"],(function(e,t,i){"use strict";return{components:{"im-call-video-item":t,"im-tel-video-item":i},props:["user_id","track_id","isSpeakerView","room","minimized"],data:()=>({streams:[],isScreen:!1,isAudio:!1}),computed:{isSip(){return this.$store.getters.sip},asMediasource(){return!!this.$store.getters.mediasource},user(){return this.$store.getters.user(this.user_id)},isSpeaker(){return this.$store.getters.speaker_id==this.user_id},isNotLarge(){return this.$store.getters.isAvatarNotLarge},isVideo(){var e=this.user.stream_info.isVideoStreamer,t=this.user.stream_info.isAudioStreamer,i=this.user.stream_info.isScreenStreamer,r=(e||t||i)&&this.$store.getters.streams(this.user_id,this.track_id);if(e&&i&&!this.track_id&&this.isSpeaker){var s=(o=r[0]).getVideoTracks();if(s&&s.length&&1!=s.length){var o=new MediaStream,a=r[0].getAudioTracks(),n=a&&a[0];n&&o.addTrack(n);for(let e of s)if("text"!==e.contentHint){o.addTrack(e);break}r=[o]}else r=[o]}else(e||i)&&this.track_id&&this.room&&this.$store.dispatch("browserStopSharing",{stream:r[0],room_id:this.room.room_id});return this.streams=r,this.isScreen=i,this.isAudio=t,e},isVideoMuted(){return this.user.stream_info.isVideoStreamerMuted},isAudioMuted(){return this.user.stream_info.isAudioStreamerMuted},isOnHold(){return this.user.stream_info.isOnHold},hasCollabExperience(){return this.$store.getters.hasFeature},showVideo(){return(this.isVideo&&!this.isVideoMuted||this.isScreen)&&(!!this.track_id||!this.track_id&&(!this.isSpeaker||this.isSpeaker&&this.isScreen&&this.isVideo&&!this.isVideoMuted))}},methods:{unlargeAvatar(){var e=this.$refs.userItemContainer,t=e&&e.offsetHeight<240;this.$store.commit("avatarNotLarge",t)}},updated(){this.unlargeAvatar()},created(){window.addEventListener("resize",this.unlargeAvatar)},destroyed(){window.removeEventListener("resize",this.unlargeAvatar)},template:e}})),define("DS/InstantMessagingCall/components/SelfView/SelfView",["text!DS/InstantMessagingCall/components/SelfView/SelfView.html","DS/InstantMessagingCall/components/VideoItem/VideoItem"],(function(e,t){"use strict";return{props:["showSelfView","isInUserList"],components:{"im-call-video-item":t},data:()=>({streams:null,isSpeaker:!1}),computed:{isVideo(){var e=this.$store.getters.local_stream_info("video"),t=e&&"muted"!=e;if((this.$store.getters.isInitial||this.$store.getters.isEnded)&&(this.streams=null),this.streams)return t;var i=this.$store.getters.isLocalSpeaker,r=(t||i!=this.isSpeaker)&&this.$store.getters.local_track_of_kind("video");if(r){var s=new MediaStream;s.addTrack(r),this.streams=[s]}return this.isSpeaker=i,t},isLocalVideoMuted(){return"muted"==this.$store.getters.local_stream_info("video")},isLocalAudioMuted(){return"muted"==this.$store.getters.local_stream_info("audio")},user_id(){return this.$store.getters.myself.user_id},username(){return this.$store.getters.myself.username}},methods:{minimize(){this.$store.commit("hideSelfView")}},destroyed(){this.streams=null},deactivated(){this.streams=null},mounted(){var e=this,t=document.getElementById("im-call-lightbox");new MutationObserver((function(){if("none"==t.style.display&&!e.$store.getters.isAccepted){if(!e.streams)return;for(let t=0;t<e.streams.length;t++)e.streams[t].getTracks().forEach((e=>e.stop()));e.streams=null}})).observe(t,{attributes:!0,childList:!0})},template:e}})),define("DS/InstantMessagingCall/components/ActionBar/ActionBar",["text!DS/InstantMessagingCall/components/ActionBar/ActionBar.html","DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem","DS/WAFData/WAFData","DS/InstantMessagingCall/assets/CollabOfficeTemplates","DS/InstantMessagingCall/components/MemberAdd/MemberAdd","DS/InstantMessagingCall/components/ModalTitle/ModalTitle"],(function(e,t,i,r,s,o){"use strict";const a=window.ds&&"MOBILE"===window.ds.env||window.top&&window.top.ds&&"MOBILE"===window.top.ds.env;return{components:{"im-call-bar-item":t,"im-call-member-add":s,"im-call-modal-title":o},props:["room","showSelfView","showUserList","hasFeature","hasSpeaker","isWhiteboard","isODE","isTelephonySupported","isConfetti","is3DPlay"],data(){return{document:document,durationInterval:null,duration:0,ODEitems:[{text:this.$store.getters.nls("createDocument"),fonticon:"doc-text",handler:e=>this.activeODE("docx")},{text:this.$store.getters.nls("createPresentation"),fonticon:"presentation-slide-layout",handler:e=>this.activeODE("pptx")},{text:this.$store.getters.nls("createSpreadsheet"),fonticon:"table",handler:e=>this.activeODE("xlsx")}],window:window,modalTitle:{model:""},watermarkToggle:{options:[{value:"watermark"}],model:"",ref:"watermarkRef"}}},computed:{isConfettiSupported(){return!this.$store.getters.hideConvFeatures&&this.$store.state.call.confettiAvailable},isODESupported(){return!this.$store.getters.hideConvFeatures&&this.$store.getters.isAccepted&&this.$store.getters.odeFeature},isWhiteboardSupported(){return!this.$store.getters.hideConvFeatures&&this.$store.getters.whiteboardFeature},is3DPlaySupported(){return!this.$store.getters.hideConvFeatures&&this.$store.getters.troisdplayFeature},isSpeaker(){return!!this.$store.getters.speaker_id},isLocalVideo(){return!!this.$store.getters.local_stream_info("video")},isLocalVideoMuted(){return"muted"==this.$store.getters.local_stream_info("video")},isLocalAudio(){return!!this.$store.getters.local_stream_info("audio")},isLocalAudioMuted(){return"muted"==this.$store.getters.local_stream_info("audio")},isLocalScreen(){return!!this.$store.getters.local_stream_info("screen")},isLocalScreenMuted(){return"muted"==this.$store.getters.local_stream_info("screen")},isSip(){return!!this.$store.getters.sip},areDeviceSettingsSupported(){return this.$store.getters.enableSettings},date_start(){var e=this.$store.getters.date_start;return e?this.durationInterval=setInterval((()=>{this.duration=Date.now()-e}),1e3):this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null,this.duration=0),e},durationString(){var e=Math.floor(this.duration/1e3),t=Math.floor(e/3600),i=(e-=3600*t)%60;i<10&&(i="0"+i);var r=Math.floor(e/60);return r<10&&(r="0"+r),(t?t+":":"")+r+":"+i},isLocalScreenDisplayed(){return this.isLocalScreen&&!this.isLocalScreenMuted},isScreenDisplayed(){return this.hasSpeaker&&this.runningScreenSharingFeature&&"screen"===this.$store.getters.speaker_kind},screenSharingDisabled(){return!this.$store.getters.screenSharingAvailable||this.hasFeature},collabDisabled(){return this.isSpeaker||this.hasFeature||this.isLocalScreenDisplayed},isDialerON(){return!!this.$store.getters.showDialer},runningConfettiFeature(){return this.$store.getters.getFeatureOfKind("confetti")},running3DPlayFeature(){return this.$store.getters.getFeatureOfKind("3dplay")},runningWhiteboardFeature(){return this.$store.getters.getFeatureOfKind("whiteboard")},runningODEFeature(){return this.$store.getters.getFeatureOfKind("ode")},runningScreenSharingFeature(){return"screen"===this.$store.getters.call_speaker_kind},isOnHold(){return this.room&&this.$store.getters.is_onhold_room(this.room.room_id)},ODESetMode(){return this.isODESupported&&(!this.collabDisabled||this.isODE&&!this.isOnHold||!this.isODE&&!!this.runningODEFeature&&!this.isOnHold)},ODEAvailableMode(){return!this.isODE&&!this.runningODEFeature&&!this.isOnHold},ODEStopMode(){return this.isODE&&!this.isOnHold},ODERunningMode(){return!this.isODE&&!!this.runningODEFeature&&!this.isOnHold},ODEDisableMode(){return!this.isODE&&!this.runningODEFeature&&this.collabDisabled},displayAddUserModel(){return this.$store.getters.isShowAddUser},isRTCActivated(){return this.$store.getters.isRTCActivated},addUserFeature(){return this.$store.getters.addUserFeature},isPrivateConv(){return this.$store.getters.isPrivateConv},isSwymConv(){return this.$store.getters.isSwymConv},showModalTitle(){return this.$store.getters.showModalTitle&&this.onClearTitle(),this.$store.getters.showModalTitle},isTheSpeaker(){return this.$store.getters.isTheSpeaker(this.$store.getters.myself.user_id)},isWatermarkActivated(){return this.room&&this.$store.getters.isWatermarkActivated(this.room.room_id)},isWatermarkToggled(){return this.watermarkToggle.model.length>0},isStandAloneCollabEnabled(){return this.$store.getters.standAloneCollabFeature},isStandAloneCollabForAppEnabled(){return this.$store.getters.standAloneCollabForAppFeature},changeMediaDeviceFeature(){return this.$store.getters.changeMediaDeviceFeature}},methods:{displaySettings(){this.$store.dispatch("displaySettings",{visible:!0})},endCall(){this.isLocalScreenDisplayed&&this.stopTrack("screen"),(a&&this.isStandAloneCollabForAppEnabled||this.isStandAloneCollabEnabled)&&this.track_event(["handset",this.$store.getters.isAccepted],0),this.$store.dispatch("endCall",this.room)},acceptCall(){a&&this.isStandAloneCollabForAppEnabled&&this.$store.commit("isCallWindowed",!0),this.track_event(["handset"],1),this.$store.dispatch("acceptCall",this.room)},holdCall(){this.track_event(["track","holdCall"],1),this.$store.dispatch("holdCall",this.room.room_id)},resumeCall(){this.track_event(["track","resumeCall"],0),this.$store.dispatch("resumeCall",this.room.room_id)},activeTrack(e){this.isDeviceStillAvailable(e)?(this.$store.dispatch("activeTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],1),"screen"==e&&(this.watermarkToggle.model=[])):this.displaySettings()},muteTrack(e){this.$store.dispatch("muteTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],0)},stopTrack(e){this.$store.dispatch("stopTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],0),this.watermarkToggle.model=[]},volumeOFF(e){this.$store.dispatch("volumeOFF",e),this.track_event(["track","volume"],e?0:1)},displayDialer(){this.$store.commit("showDialer")},hideDialer(){this.$store.commit("hideDialer")},stopFeatures(e){this.$store.dispatch("stopFeatures",{room_id:this.room.room_id}),this.track_event(["feature",e],0)},activeODE(e){if(this.runningODEFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningODEFeature});e&&(this.modalTitle.title=this.$store.getters.nls("new"+r.extensionsFormat[e].name),this.modalTitle.ext=e,this.$store.commit("showModalTitle",!0))},onSendTitle(){if(this.showModalTitle){if("whiteboard"!=this.modalTitle.ext){if(/[*"\\|<>\/?:]/.test(this.modalTitle.model))return this.$store.dispatch("alert_invalidCharacters");this.onConfirm(this.modalTitle.model,this.modalTitle.ext)}else this.$store.dispatch("newWhiteboard",{room_id:this.room.room_id,title:this.modalTitle.model}),this.track_event(["feature","whiteboard"],1);this.$store.commit("showModalTitle",!1),this.onClearTitle()}},onEditTitle(e){this.showModalTitle&&(this.modalTitle.model=e)},onClearTitle(){this.modalTitle.model=""},onConfirm(e,t){if(e&&t){var i=e,r=this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId,s=e+"."+t,o=this;this.addmedia(r,i,s,t,(function(e,r){e&&r?o.$store.dispatch("newODE",{room_id:o.room.room_id,title:i,ext:t,media_id:e,url:r}):console.error("Error no mediaId or url define")})),this.track_event(["feature","ode",t],1)}},addmedia(e,t,s,o,a){if((n=this.$store.getters.swymUrl)&&e&&t&&s&&o&&a){var n=this.$store.getters.swymUrl,d=this.$store.getters.tenant,l=this;require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor"]).then((function(c){var u=c[0];u&&u.getDocumentTemplatesURL({platformId:d}).then((d=>{if(d&&d[o]){var c=d[o];if(!c)return console.error("Failed to get ODE template"),a();i.authenticatedRequest(c,{method:"GET",type:"blob",onComplete:function(d){if(!d)return console.error("Failed to get ODE template"),a();!function(e,t,i){if(r.extensionsFormat[e]){var s=new Blob([t],{type:r.extensionsFormat[e].format});s&&i(s)}else console.error("Error loading CollabOfficeTemplates of extension "+e)}(o,d,(function(r){var o=new FormData;o.append("is_illustration",!1),o.append("community_id",e),o.append("title",t),o.append("media_type","document"),o.append("published",!0),o.append("fileName",s),o.append("userFile",r,s),l.getCSRFswym((function(e){e&&i.authenticatedRequest(n+"/api/media/addmedia",{method:"POST",headers:{"X-DS-SWYM-CSRFTOKEN":e},data:o,onComplete:function(e){if(e)try{var t=(e=JSON.parse(e)).result.id_media;a(t,c)}catch(e){console.error("Failed to add media"),a()}},onFailure:function(e){console.error("Failed to add media"),a()}})}))}))},onFailure:function(e){console.error("Failed to get template"),a()}})}else console.error("Failed to get template")}))}))}},getMedia(e,t,r){var s=this.$store.getters.swymUrl,o={params:{id_media:e,detailedInfos:!0}};i.authenticatedRequest(s+"/api/media/getmedia",{method:"POST",type:"json",headers:{"Content-Type":"application/json","X-DS-SWYM-CSRFTOKEN":t},data:JSON.stringify(o),onComplete:function(e){e&&e.result&&e.result.play&&e.result.play.download_original_url&&e.result.play.download_original_url.transient_url_as_attachment||r();var t=e.result.play.download_original_url.transient_url_as_attachment;r(t)},onFailure:function(e){console.error("Failed to get media"),r()}})},getCSRFswym(e){var t=this.$store.getters.swymUrl;i.authenticatedRequest(t+"/api/index/tk",{method:"GET",type:"json",onComplete:function(t){t||e();try{var i=t.result.ServerToken;e(i)}catch(t){console.error("Failed to resolve CSRF Token "+t),e()}},onFailure:function(t){console.error("Failed to get CSRF Token "+t),e()}})},joinODE(){if(this.runningODEFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningODEFeature});console.error("Can not join unexisting ODE")},activeWhiteboard(){if(this.runningWhiteboardFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningWhiteboardFeature});this.modalTitle.title=this.$store.getters.nls("newWhiteboard"),this.modalTitle.ext="whiteboard",this.$store.commit("showModalTitle",!0)},activeConfetti(){if(this.runningConfettiFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningConfettiFeature});this.$store.dispatch("newConfetti",{room_id:this.room.room_id})},active3DPlay(){if(this.running3DPlayFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.running3DPlayFeature});this.$store.dispatch("new3DPlay",{room_id:this.room.room_id})},track_event(e,t){this.$store.dispatch("track_event",{action:"actionBar",dimensions:e,eventValue:t})},removeSpeaker(){this.$store.dispatch("removeSpeaker",{user_id:this.$store.getters.speaker_id})},switchToCallSpeaker(){this.$store.dispatch("switchToCallSpeaker")},showAddUserModal(){this.$store.commit("searchUsersList",{users:{}}),this.$store.commit("showAddUser",!0)},watermarkSwitch(){this.isTheSpeaker&&this.room&&(this.isWatermarkToggled?(this.watermarkToggle.model=[],this.$store.dispatch("watermark",{room_id:this.room.room_id,active:!1})):(this.watermarkToggle.model=[this.watermarkToggle.options[0].value],this.$store.dispatch("watermark",{room_id:this.room.room_id,active:!0})))},isDeviceStillAvailable(e){return"video"!=e||"no_value"!=this.$store.getters.currentVideoinputId}},template:e}})),define("DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize",["text!DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize.html","DS/InstantMessagingCall/components/CustomType/CustomType"],(function(e,t){"use strict";return{props:["logins"],components:{"im-call-custom-type":t},template:e}})),define("DS/InstantMessagingCall/store/modules/feature",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/SwymUICore/script/feature/community/media/model/media-model","vuejs"],(function(e,t,i,r){"use strict";const s="whiteboard",o="ode",a="confetti",n="3dplay";return{state:Object.assign({},{currentFeatureId:null,features:{},isODEEditionSupported:!0,reloadFeatures:{},showModalTitle:!1}),mutations:{resetFeatureState(e){Object.assign(e,{currentFeatureId:null,features:{},isODEEditionSupported:!0,reloadFeatures:{},showModalTitle:!1})},setMaster(e,{featureId:t,user_id:i}){e.features[t]&&r.set(e.features[t],"master",i)},featureMembers(e,{featureId:t,featureMembers:i}){e.features[t]&&r.set(e.features[t],"members",i)},featureEnded(e,{featureId:t}){},feature(e,{featureKind:t,room_id:i,featureId:s,featureData:o,master:a}){(!e.features[s]||o.reload||o.update)&&(delete o.reload,delete o.update,r.set(e.features,s,{featureKind:t,featureId:s,featureData:o,room_id:i,master:a}))},currentFeatureId(e,t){e.currentFeatureId=t},confetti:(e,{spanId:t,user_id:i,featureId:s})=>{r.set(e.features[s].featureData.confettis,t,i)},coreview_3DPlay_data:(e,{actions:t,featureId:i})=>{if(!e.features[i])return console.error("Received 3DPlay coreview data but the feature is not loaded "+i);r.set(e.features[i].featureData,"actions",t)},isODEEditionSupported(e,t){e.isODEEditionSupported=t},reloadFeatures:(e,t)=>{e.reloadFeatures={...e.reloadFeatures,...t}},showModalTitle:(e,t)=>{e.showModalTitle=t}},getters:{hasFeature:e=>!!e.currentFeatureId,feature:e=>t=>e.features[t],currentFeatureId:e=>e.currentFeatureId,currentFeature:(e,t)=>!!t.currentFeatureId&&t.feature(t.currentFeatureId),isODE:e=>e=>e.featureKind==o,isWhiteboard:e=>e=>e.featureKind==s,isConfetti:e=>e=>e.featureKind==a,is3DPlay:e=>e=>e.featureKind==n,isMaster:(e,t)=>e=>e.master==t.myself.user_id,getFeatureOfKind:(e,t)=>i=>{for(let r in e.features){let s=e.features[r];if(s.featureKind==i&&t.is_accepted_room(s.room_id))return s}return null},isODEEditionSupported:e=>e.isODEEditionSupported,reloadFeatures:e=>e.reloadFeatures,reloadFeature:e=>t=>e.reloadFeatures[t],showModalTitle:e=>e.showModalTitle},actions:{activateFeature({commit:t,dispatch:i,getters:r},s){if(!s.featureKind||!s.featureId||!s.featureData)return e.error("Can not init feature "+JSON.stringify(s));s.master=r.myself.user_id,t("feature",s),i("switchToFeature",{room_id:s.room_id,featureInfo:s}),i("sendCurrentFeature")},stopFeatures({dispatch:e},{room_id:t}){e("switchToFeature",{room_id:t})},newODE({dispatch:e,getters:t},{room_id:i,title:r,ext:s,media_id:a,url:n}){e("activateFeature",{room_id:i,featureKind:o,featureId:Date.now(),featureData:{mediaId:a,title:r,ext:s,url:n}})},newConfetti({dispatch:e},{room_id:t}){e("activateFeature",{room_id:t,featureKind:a,featureId:Date.now(),featureData:{confettis:{}}})},new3DPlay({dispatch:e,getters:t},{room_id:i}){e("activateFeature",{room_id:i,featureKind:n,featureId:Date.now(),featureData:{fileName:"RadialEngine.3dxml",mime:"3dxml",path:t.assets_url+"RadialEngine.3dxml",actions:{}}})},newWhiteboard({dispatch:t,getters:r},{room_id:o,title:a}){var n=r.accepted_room&&r.accepted_room.options&&r.accepted_room.options.dmId;if(n){var d=new i;d.set("play",{}),d.set("community",{community_type:"dm",id:n}),t("activateFeature",{room_id:o,featureKind:s,featureId:Date.now(),featureData:{model:d,whiteboard:!0,title:a,"3DSwymV3":!0,noCloseAtPublish:!0,coreview:{action:"initCoreview",room_id:o,noCall:!0,collabExperienceOrigin:!0,logins:r.called_users_logins,threadType:"dm",threadId:n,data:{communityId:n,logins:r.called_users_logins,mediaId:null,room_id:o}}}})}else e.error("New whiteboard dmId is undefined")},sendCurrentFeature({dispatch:e,getters:t}){var i=t.currentFeature;i&&e("sendFeature",i)},switchToFeature({getters:e,commit:i},{featureInfo:r,room_id:s}){i("currentFeatureId",r&&r.featureId);var o=s||r&&r.room_id;t.callEventFromView({action:"switchToFeature",room_id:o,user_id:e.myself.user_id,featureInfo:r,featureId:r&&r.featureId})},sendFeature({getters:i},r){r?t.callEventFromView({action:"feature",room_id:r.room_id,user_id:i.myself.user_id,featureInfo:r}):e.error("no featureInfo in sendFeature")},setMaster({getters:e,commit:i},r){i("setMaster",{user_id:user_id,featureId:r.featureId}),t.callEventFromView({action:"masterChanged",room_id:r.room_id,user_id:e.myself.user_id,featureInfo:r,featureId:r.featureId})},received_feature({commit:e,getters:t,dispatch:i},{user_id:r,featureInfo:s,room_id:o,type:a}){s.room_id=o,s.master=r,s.featureData.coreview&&(s.featureData.coreview.action="acceptCoreview",s.featureData.coreview.room_id=o),s.featureData.coreviewData,e("feature",s),!t.hasFeature&&t.is_accepted_room(o)&&i("switchToFeature",{featureInfo:s,room_id:o})},invited_feature({dispatch:e},{type:t,featureData:i,room_id:r}){"3dplay"==t&&(i.fileName="Collab3DPlay",i.mime=i.fileExt,i.path=i.fileUrl,i.actions={}),t==s&&(i.noCloseAtPublish=!0),e("activateFeature",{featureData:i,featureId:Date.now(),featureKind:t==o||t==s||t==n?t:null,room_id:r})},masterChanged({commit:e},{user_id:t,featureId:i}){e("setMaster",{user_id:t,featureId:i})},featureMembers({commit:e},{user_id:t,featureId:i,featureMembers:r}){e("featureMembers",{user_id:t,featureId:i,featureMembers:r})},featureEnded({commit:e},{user_id:t,featureId:i}){e("featureMembers",{user_id:t,featureId:i,featureMembers:null}),e("featureEnded",{user_id:t,featureId:i})},received_confetti({commit:e},{featureData:t,featureId:i,user_id:r,room_id:s}){e("confetti",{spanId:t.spanId,user_id:r,featureId:i})},send_confetti({getters:e,commit:i},{spanId:r,feature:s}){i("confetti",{spanId:r,user_id:e.myself.user_id,featureId:s.featureId}),t.callEventFromView({action:"confetti",room_id:s.room_id,user_id:e.myself.user_id,featureId:s.featureId,featureData:{spanId:r}}),t.callEventFromView({action:"nextMaster",room_id:s.room_id,user_id:e.myself.user_id,featureId:s.featureId})},received_3DPlay_data({getters:e,commit:t},{room_id:i,actions:r,featureData:s,featureId:o}){t("coreview_3DPlay_data",{featureId:o,actions:r})},send_3DPlay_data({getters:e,commit:i},{room_id:r,actions:s,featureData:o,featureId:a}){t.callEventFromView({action:"3DPlayData",room_id:r,user_id:e.myself.user_id,featureId:a,featureData:o,actions:s})},send_isODEEditionNotSupported({commit:e,getters:t,dispatch:i},r){e("isODEEditionSupported",r),t.isMobile||r||i("alert_ODEEditionNotSupported")},reloadFeatures({commit:e,getters:t},{save:i,forward:r,reload:a,kind:d,deleteReloadData:l}){const c={};r||(r=!1),a||(a=!1),i||(i=!1),(t.getFeatureOfKind("whiteboard")&&!d||d&&d==s)&&(c[s]={save:i,forward:r,reload:a}),(t.getFeatureOfKind("ode")&&!d||d&&d==o)&&(c[o]={save:i,forward:r,reload:a}),(t.getFeatureOfKind("3dplay")&&!d||d&&d==n)&&(c[n]={save:i,forward:r,reload:a}),l&&d&&delete c[d],e("reloadFeatures",c)},removeFeatureData({commit:e},t){const i=t;i.featureData.save&&delete i.featureData.save,i.featureData.reload&&delete i.featureData.reload,i.featureData.forward&&delete i.featureData.forward,e("feature",i)}}}})),define("DS/InstantMessagingCall/components/SettingsModal/SettingsModal",["text!DS/InstantMessagingCall/components/SettingsModal/SettingsModal.html","DS/InstantMessagingCall/components/SettingsItem/SettingsItem","DS/InstantMessagingCall/components/VideoItem/VideoItem"],(function(e,t,i){"use strict";return{props:["room"],components:{"im-call-settings-item":t,"im-call-video-item":i},data:()=>({audioinputDeviceSelected:"",videoinputDeviceSelected:"",audiooutputDeviceSelected:"",videoStream:null,defaultVideoActivation:!1,videoToggle:{options:[{value:"videoInput"}],model:[]},microToggle:{options:[{value:"audioInput"}],model:[]},speakerToggle:{options:[{value:"audioOutput"}],model:[]}}),mounted(){navigator.mediaDevices&&navigator.mediaDevices.addEventListener("devicechange",(e=>{this.onDeviceChange()}))},beforeDestroy(){navigator.mediaDevices&&navigator.mediaDevices.removeEventListener("devicechange",(e=>{this.$store.dispatch("enumerateDevices")}))},updated(){if(this.videoinputActivated?(this.videoToggle.model=["videoInput"],this.videoinputDeviceSelected=this.currentVideoinputId,this.previewVideoStream()):this.videoToggle.model=[],this.audioinputActivated?(this.microToggle.model=["audioInput"],this.audioinputDeviceSelected=this.currentAudioinputId):this.microToggle.model=[],this.audiooputActivated){this.speakerToggle.model=["audioOutput"];this.$store.getters.audioOutputs.length>0&&(this.audiooutputDeviceSelected=this.currentAudiooutputId,this.testAudioOutput(this.currentAudiooutputId)),this.firefoxSpeakerSelection()}else this.speakerToggle.model=[]},computed:{displaySettings(){return this.$store.getters.displaySettings},audioinputDevices(){return this.audioinputDeviceSelected=this.currentAudioinputId,this.$store.getters.audioInputs},videoinputDevices(){const e=this.$store.getters.videoInputs;return this.videoinputActivated&&""==this.videoinputDeviceSelected&&(this.videoinputDeviceSelected=e&&e.length>0&&this.currentVideoinputId),this.previewVideoStream(),e},audiooutputDevices(){const e=this.$store.getters.audioOutputs;return e.length>0&&(this.audiooutputDeviceSelected=this.currentAudiooutputId),e},videoinputActivated(){return!!this.$store.getters.local_stream_info("video")&&"muted"!=this.$store.getters.local_stream_info("video")},audioinputActivated(){return!!this.$store.getters.local_stream_info("audio")&&"muted"!=this.$store.getters.local_stream_info("audio")},audiooputActivated(){return!this.$store.getters.isVolumeOFF},isVideoToggle(){return this.videoToggle.model.length>0},isMicroToggle(){return this.microToggle.model.length>0},isSpeakerToggle(){return this.speakerToggle.model.length>0},audioVolume(){return this.$store.getters.audioVolume},audioVolumePercentage(){return Math.min(this.audioVolume/255*100,100)},currentAudioinputId(){const e=this.$store.getters.audioInputs;return this.$store.getters.currentAudioinputId||e.find((t=>"default"==t.deviceId||e[0])).value},currentVideoinputId(){const e=this.$store.getters.videoInputs;return this.$store.getters.currentVideoinputId||e[0].value},currentAudiooutputId(){const e=this.$store.getters.audioOutputs;let t;return t=this.$store.getters.currentAudiooutputId,!t&&e.length>0&&(t=e.find((t=>"default"==t.deviceId||e[0])).value,this.$store.dispatch("currentAudiooutput",t.deviceId)),t},isNotSameAudioInputGroupId(){const e=this.$store.getters.findDeviceByCurrentDeviceId("audioinput");return e&&e.groupId!=this.$store.getters.audioInputGroupId},isNotSameAudioOutputGroupId(){const e=this.$store.getters.findDeviceByCurrentDeviceId("audiooutput");return e&&e.groupId!=this.$store.getters.audioOutputGroupId},microRule(){return!this.displaySettings||!this.isMicroToggle||"no_value"!=this.audioinputDeviceSelected&&""!=this.audioinputDeviceSelected},cameraRule(){return!this.displaySettings||!this.isVideoToggle||"no_value"!=this.videoinputDeviceSelected&&""!=this.videoinputDeviceSelected},speakerRule(){return!this.displaySettings||!this.isSpeakerToggle||"no_value"!=this.audiooutputDeviceSelected&&""!=this.audiooutputDeviceSelected}},methods:{close(){this.videoStream&&(this.videoStream.getTracks().forEach((e=>e.stop())),this.videoStream=null),this.$store.dispatch("displaySettings",{visible:!1})},onSelectedVideoInput(e){this.displaySettings&&(this.videoinputDeviceSelected=e)},onSelectedAudioInput(e){this.displaySettings&&(this.audioinputDeviceSelected=e,this.testTrack("audio",e))},onSelectedAudioOutput(e){this.displaySettings&&(this.audiooutputDeviceSelected=e,this.testAudioOutput(e))},videoinputActivation(){this.videoinputActivated?this.muteTrack("video"):this.activeTrack("video")},muteTrack(e){this.$store.dispatch("muteTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],0)},activeTrack(e){this.$store.dispatch("activeTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],1)},track_event(e,t){this.$store.dispatch("track_event",{action:"settingsModal",dimensions:e,eventValue:t})},replaceTrack(e,t){this.$store.dispatch("replaceTrack",{deviceId:t,kind:e,room_id:this.room.room_id})},testTrack(e,t){const i={[e]:{deviceId:{exact:t}}};this.$store.dispatch("getUserMedia",i).then((i=>{if("audio"==e){if("default"==t){const e=this.$store.getters.resolveDefaultAudioDevice(i);e&&e!=t&&this.testTrack("audio",e)}this.$store.dispatch("audioAnalyzer",i)}else"video"==e&&(this.videoStream=i)})).catch((e=>{console.error("error happend : ",e)}))},volumeOFF(e){this.$store.dispatch("volumeOFF",e),this.track_event(["track","volume"],e?0:1)},previewVideoStream(){this.displaySettings&&this.isVideoToggle&&this.videoinputDeviceSelected&&this.videoinputDeviceSelected.length>0&&this.testTrack("video",this.videoinputDeviceSelected)},videoSwitch(){if(this.isVideoToggle)this.videoToggle.model=[];else{this.defaultVideoActivation=!0;const e=this.$store.getters.getLocalDevice("videoinput"),t=e&&e.label&&this.$store.getters.findDeviceByLabel("videoinput",e.label);this.videoinputActivated?(this.videoinputDeviceSelected=this.currentVideoinputId,this.previewVideoStream()):this.$store.dispatch("getUserMedia",{video:!0}).then((e=>t&&t.deviceId?this.$store.dispatch("getUserMedia",{video:{deviceId:{exact:t.deviceId}}}):e)).then((e=>{this.$store.dispatch("enumerateDevices"),"no_value"!=this.currentVideoinputId&&this.$store.dispatch("currentVideoinput",{stream:e}),this.videoinputDeviceSelected=this.currentVideoinputId,this.previewVideoStream(),this.videoToggle.model=["videoInput"]})).catch((e=>{this.$store.dispatch("alert_getLocalMediaError",e),this.videoToggle.model=[],console.error(e)}))}},microSwitch(){this.isMicroToggle?this.microToggle.model=[]:(this.audioinputActivated||this.$store.dispatch("getUserMedia",{audio:!0}).then((e=>{this.$store.dispatch("enumerateDevices")})),this.microToggle.model=["audioInput"],this.audioinputDeviceSelected=this.currentAudioinputId)},speakerSwitch(){this.isSpeakerToggle?this.speakerToggle.model=[]:(this.speakerToggle.model=["audioOutput"],this.audiooutputDevices.length>0&&(this.audiooutputDeviceSelected=this.currentAudiooutputId),this.firefoxSpeakerSelection())},setAudioToTest(e,t){if(e.pause(),e.currentTime=0,e.setSinkId)return e.setSinkId(t).catch((e=>{console.error(e),this.alertErrorAudioOutputChange()}));this.alertErrorAudioOutputChange()},testAudioOutput(e){const t=document.querySelector(".im-call-settings-modal-test-speaker audio");if(t&&this.setAudioToTest(t,e),this.$store.getters.windowRef){const t=this.$store.getters.windowRef.document.querySelector(".im-call-settings-modal-test-speaker audio");t&&this.setAudioToTest(t,e)}},audioOutputNotSupported(){this.audiooutputDevices.length<1&&this.alertErrorAudioOutputChange()},alertErrorAudioOutputChange(){this.$store.dispatch("alert_audioOutputChangeNotSupported"),console.error("Change audio output not supported by the navigator")},firefoxSpeakerSelection(){navigator.mediaDevices.selectAudioOutput&&this.$nextTick((()=>{const e=this.$refs.speakerRef&&this.$refs.speakerRef.$el&&Array.from(this.$refs.speakerRef.$el.getElementsByClassName("select")[0].getElementsByTagName("ul"))[0];e&&(e.onclick=()=>{this.$store.dispatch("getUserMedia",{audio:!0}).then((()=>navigator.mediaDevices.selectAudioOutput({}))).then((e=>{this.$store.dispatch("enumerateDevices"),e.deviceId&&(this.audiooutputDeviceSelected=e.deviceId)})).catch((e=>{console.error(e),this.alertErrorAudioOutputChange()}))})}))},onDeviceChange(){this.$store.dispatch("enumerateDevices").then((()=>{const e=this.$store.getters.findDeviceByCurrentGroupId("audioinput"),t=this.$store.getters.findDeviceByCurrentGroupId("videoinput"),i=this.$store.getters.findDeviceByCurrentGroupId("audiooutput");if(!e&&this.$store.getters.audioInputGroupId){const e="default";this.replaceTrack("audio",e),this.audioinputDeviceSelected=e,this.$store.dispatch("currentAudioinput",{deviceId:e}),this.$store.dispatch("alert_deviceUnplugged","audioinput")}else e&&"default"==this.currentAudioinputId&&this.isNotSameAudioInputGroupId&&(this.$store.dispatch("currentAudioinput",{deviceId:e.deviceId}),this.replaceTrack("audio",e.deviceId),this.audioinputDeviceSelected=e.deviceId);if(!t&&this.$store.getters.videoInputGroupId&&"no_value"!=this.$store.getters.videoInputGroupId&&(this.muteTrack("video"),this.videoinputDeviceSelected="",this.videoToggle.model=[],this.$store.dispatch("currentVideoinput",{deviceId:"no_value"})),!i&&this.$store.getters.audioOutputs.length>0&&!this.$store.getters.isInitial&&!this.$store.getters.isEnded){const e="default";this.$store.dispatch("alert_deviceUnplugged","audiooutput"),this.$store.dispatch("currentAudiooutput",e),this.testAudioOutput(e),this.audiooutputDeviceSelected=e}else i&&"default"==this.currentAudiooutputId&&this.isNotSameAudioOutputGroupId&&(this.$store.dispatch("currentAudiooutput",i.deviceId),this.$store.dispatch("changeAudioOutput",i.deviceId),this.testAudioOutput(i.deviceId),this.audiooutputDeviceSelected=i.deviceId)}))},checkForm(){this.microRule||this.$store.dispatch("alert_needSelectDevice","micro"),this.cameraRule||this.$store.dispatch("alert_needSelectDevice","camera"),this.speakerRule||this.$store.dispatch("alert_needSelectDevice","speaker")},validate(){this.$refs.form.validate()?(this.currentVideoinputId&&(this.isVideoToggle?((this.currentVideoinputId!=this.videoinputDeviceSelected||this.defaultVideoActivation)&&(this.replaceTrack("video",this.videoinputDeviceSelected),this.$store.dispatch("currentVideoinput",{deviceId:this.videoinputDeviceSelected}),this.$store.dispatch("saveDeviceLocalStorage",{deviceId:this.videoinputDeviceSelected,kind:"videoinput"})),this.defaultVideoActivation=!1):this.videoinputActivated&&this.muteTrack("video")),this.isMicroToggle?(this.audioinputActivated||this.activeTrack("audio"),(this.currentAudioinputId!=this.audioinputDeviceSelected||this.isNotSameAudioInputGroupId)&&(this.replaceTrack("audio",this.audioinputDeviceSelected),this.$store.dispatch("currentAudioinput",{deviceId:this.audioinputDeviceSelected}),this.$store.dispatch("saveDeviceLocalStorage",{deviceId:this.audioinputDeviceSelected,kind:"audioinput"}))):this.audioinputActivated&&this.muteTrack("audio"),this.isSpeakerToggle?(this.audiooputActivated||this.volumeOFF(!1),this.currentAudiooutputId&&(this.currentAudiooutputId!=this.audiooutputDeviceSelected&&this.$store.dispatch("changeAudioOutput",this.audiooutputDeviceSelected),this.$store.dispatch("currentAudiooutput",this.audiooutputDeviceSelected),this.$store.dispatch("saveDeviceLocalStorage",{deviceId:this.audiooutputDeviceSelected,kind:"audiooutput"}))):this.audiooputActivated&&this.volumeOFF(!0),this.close()):this.checkForm()}},template:e}})),define("DS/InstantMessagingCall/components/InvitationItem/InvitationItem",["text!DS/InstantMessagingCall/components/InvitationItem/InvitationItem.html","DS/InstantMessagingCall/components/ActionBar/ActionBar"],(function(e,t){"use strict";return{components:{"im-call-bar":t},props:["room_id"],computed:{room(){return this.$store.getters.room(this.room_id)},isCaller(){return this.room.IamTheCaller},isMinimizedCall(){return this.$store.getters.isAccepted},labelArray(){if(this.room){if(this.$store.getters.roomName(this.room))return[this.$store.getters.roomName(this.room)];if(!this.room.IamTheCaller&&this.room.user&&this.room.user.username)return[this.room.user.username]}var e=this.$store.getters.called_users_name(this.room_id).slice(0),t=e.indexOf(this.$store.getters.myself.username);return e.splice(t,1),e},label(){return this.labelArray&&this.labelArray.toString().replaceAll(",",", ")},callerLogin(){return this.room&&this.room.user.login},subtitle(){return this.isMinimizedCall&&this.$store.getters.nls("ongoing")||this.isCaller&&this.$store.getters.nls("calling")||this.$store.getters.nls("incoming")},asDelegateOf(){return this.room&&this.room.room_id&&this.$store.getters.asDelegateOf(this.room.room_id)},simringWith(){return this.room&&this.room.room_id&&this.$store.getters.simringWith(this.room.room_id)},delegationMessage(){return!!this.asDelegateOf&&this.$store.getters.nls("invitedAsDelegate").replace("{username}",this.asDelegateOf.username)||!!this.simringWith&&1===this.simringWith.length&&this.$store.getters.nls("simringWith").replace("{username}",this.simringWith[0])||!!this.simringWith&&this.simringWith.length>1&&this.$store.getters.nls("simringWithDelegates")}},methods:{maximize(){this.$store.commit("minimize",!1),this.track_event("minimize",0)},track_event(e,t){this.$store.dispatch("track_event",{action:"topBar",dimensions:e,eventValue:t})}},template:e}})),define("DS/InstantMessagingCall/store/modules/users",["DS/RTProxyDriver/RTLogger","vuejs","DS/InstantMessagingCall/api/senders","DS/RTConvAPI/RTConvAPI"],(function(e,t,i,r){"use strict";return{state:{users:{},accepters:[],refusers:[],video_streamers:[],screen_streamers:[],audio_streamers:[],speaker:null,speaker_track_id:null,speaker_kind:null,call_speaker:null,call_speaker_kind:null,call_speaker_track_id:null,isLocalSpeaker:!1,media_id:null,local_audio:!1,local_video:!1,local_screen:!1,avatarNotLarge:!1,showUserList:!0,isShowAddUser:!1,searchUsersList:[],cusers:[],screensharer_id:null},getters:{isAvatarNotLarge:e=>e.avatarNotLarge,isTheSpeaker:e=>t=>e.call_speaker==t,accepters:e=>e.accepters,refusers:e=>e.refusers,accepters_name:e=>{var t=[];for(let i of e.accepters)t.push(e.users[i].username);return t},accepters_except_myself:(e,t)=>e.accepters.filter((e=>e!==t.myself.user_id)),accepters_logins_except_myself:(e,t)=>t.accepters_except_myself.map((t=>e.users[t].login)),user:e=>t=>e.users[t],speaker_id:e=>e.speaker,speaker_track_id:e=>e.speaker_track_id,speaker_kind:e=>e.speaker_kind,call_speaker_id:e=>e.call_speaker,call_speaker_kind:e=>e.call_speaker_kind,call_speaker_track_id:e=>e.call_speaker_track_id,local_stream_info:e=>t=>e["local_"+t],called_users:(e,t)=>{if(!t.accepted_room||!t.accepted_room.calledUsers||!t.accepted_room.calledUsers.length)return e.cusers;if(0==e.cusers.length)for(let i of t.accepted_room.calledUsers)e.cusers.push(t.user(i.user_id));else e.cusers=e.cusers.map((e=>t.user(e.user_id)));return e.cusers},called_users_logins:(e,t)=>{var i=[];return t.called_users.forEach((e=>e&&e.login&&i.push(e.login))),i},isLocalSpeaker:e=>e.isLocalSpeaker,login:e=>t=>e.users[t]&&e.users[t].login,logins_except_myself:(e,t)=>{var i=[];for(let e of t.called_users)e.user_id!=t.myself.user_id&&i.push(e.login);return i},showUserList:e=>e.showUserList,hasHoldCall:e=>t=>e.users[t]&&e.users[t].stream_info.isOnHold,isShowAddUser:e=>e.isShowAddUser,searchUsersList:e=>e.searchUsersList,screensharer_id:e=>e.screensharer_id},mutations:{avatarNotLarge(e,t){e.avatarNotLarge=t},resetUsersState(e){Object.assign(e,{users:{},accepters:[],refusers:[],video_streamers:[],screen_streamers:[],audio_streamers:[],speaker:null,speaker_track_id:null,speaker_kind:null,call_speaker:null,call_speaker_kind:null,call_speaker_track_id:null,isLocalSpeaker:!1,media_id:null,local_audio:!1,local_video:!1,local_screen:!1,avatarNotLarge:!1,showUserList:!0,isShowAddUser:!1,searchUsersList:[],cusers:[],screensharer_id:null})},isLocalSpeaker(e,t){e.isLocalSpeaker=t},user(e,i){e.users[i.user_id]||(e.users[i.user_id]=i,e.users[i.user_id].stream_info=t.observable({isAudioStreamer:!1,isAudioStreamerMuted:!1,isVideoStreamer:!1,isVideoStreamerMuted:!1,isScreenStreamer:!1,isOnHold:!1,track_id_screen:null,track_id_audio:null,track_id_video:null}))},accepter(e,t){var i=e.refusers.indexOf(t);-1!=i&&e.refusers.splice(i,1),-1==e.accepters.indexOf(t)&&e.accepters.push(t)},refuser(e,t){var i=e.accepters.indexOf(t);-1!=i&&e.accepters.splice(i,1),-1==e.refusers.indexOf(t)&&e.refusers.push(t)},received_track_video(e,{user_id:t,track_id:i}){e.users[t].stream_info.isVideoStreamer=!1,e.users[t].stream_info.isVideoStreamer=!0,e.users[t].stream_info.track_id_video=i,-1==e.video_streamers.indexOf(t)&&e.video_streamers.push(t)},received_track_screen(e,{user_id:t}){e.users[t].stream_info.isScreenStreamer=!0,-1==e.screen_streamers.indexOf(t)&&e.screen_streamers.push(t)},remove_track_screen(e,{user_id:t}){e.users[t].stream_info.isScreenStreamer=!1;var i=e.screen_streamers.indexOf(t);-1!=i&&e.screen_streamers.splice(i,1)},received_track_audio(e,{user_id:t,track_id:i}){e.users[t].stream_info.isAudioStreamer=!1,e.users[t].stream_info.isAudioStreamer=!0,e.users[t].stream_info.track_id_audio=i,-1==e.audio_streamers.indexOf(t)&&e.audio_streamers.push(t)},remove_track_audio(e,{user_id:t}){e.users[t].stream_info.isAudioStreamer=!1;var i=e.audio_streamers.indexOf(t);-1!=i&&e.audio_streamers.splice(i,1)},remove_track_video(e,{user_id:t}){e.users[t].stream_info.isVideoStreamer=!1;var i=e.video_streamers.indexOf(t);-1!=i&&e.video_streamers.splice(i,1)},local_stream_info(e,{kind:t,muted:i,loaded:r,user_id:s}){e["local_"+t]=i?"muted":r,"audio"==t?e.users[s].stream_info.isAudioStreamerMuted=!1!==i:"video"==t&&(e.users[s].stream_info.isVideoStreamerMuted=!1!==i)},stream_muted(e,{kind:t,user_id:i,muted:r}){"audio"==t?e.users[i].stream_info.isAudioStreamerMuted=r:"video"==t&&(e.users[i].stream_info.isVideoStreamerMuted=r)},call_hold(e,{user_id:t,onHold:i}){e.users[t].stream_info.isOnHold=!!i},call_speaker(e,{user_id:t,speaker_track_id:i,kind:r}){e.call_speaker=t,e.call_speaker_kind=r,e.call_speaker_track_id=i},speaker(e,{user_id:t,speaker_track_id:i,kind:r}){e.speaker_track_id=i,e.speaker=t,e.speaker_kind=r},track_stopped(t,{user_id:i,track_id:r,kind:s}){if("screen"===s)t.users[i].stream_info.isScreenStreamer=!1,t.showUserList=!0,t.speaker==i&&(t.speaker=null,t.speaker_track_id=null,t.speaker_kind=null),t.call_speaker==i&&(t.call_speaker=null,t.call_speaker_id=null,t.call_speaker_kind=null);else e.Call("stop track "+s+" but feature not implemented")},showUserList:(e,t)=>{e.showUserList=t},showAddUser:(e,t)=>{e.isShowAddUser=t},searchUsersList:(e,{users:t})=>{e.searchUsersList=t},called_users:(e,{users:t})=>{const i=t.map((t=>e.users[t.user_id]));e.cusers=i},screensharer_id:(e,t)=>{e.screensharer_id=t}},actions:{setPresence({dispatch:e},t){i.presence(t)},setAsSpeaker({commit:e,getters:t},{user_id:i,track_id:r,firstSpeaker:s,kind:o}){e("speaker",{user_id:i,speaker_track_id:r,kind:o})},switchToCallSpeaker({dispatch:e,getters:t}){e("setAsSpeaker",{user_id:t.call_speaker_id,track_id:t.call_speaker_track_id,kind:t.call_speaker_kind})},removeSpeaker({commit:e,getters:t},{user_id:i}){e("speaker",{user_id:null,speaker_track_id:null}),i==t.myself.user_id&&e("isLocalSpeaker",!1)},search({commit:e},t){Object.keys(t).length>0?e("searchUsersList",{users:t}):e("searchUsersList",{users:{noResult:{userName:"No results.",userId:"noResult"}}})},addCalledUsers:({commit:e,dispatch:t,getters:i},s)=>{i.accepted_room.options.dmId!=s.options.dmId&&(i.isPrivateConv&&t("reloadFeatures",{}),e("dmId",{newDmId:s.options.dmId,room_id:s.room_id}));for(let t of s.users)e("user",t);if(s.room_id==i.accepted_room.room_id&&e("called_users",{users:[...i.called_users,...s.users]}),s.user_id==i.myself.user_id){let e=s.options.dmId.slice();e.includes(":rt:")&&(e=e.split(":").pop()),r.addMembers({platformId:i.tenant,dmId:e,logins:s.logins}),i.isPrivateConv&&t("reloadFeatures",{save:!0})}e("isPrivateConv",!1),e("roomName",s),t("alert_membersAdded",s.users)}}}})),define("DS/InstantMessagingCall/components/UserCircleList/UserCircleList",["text!DS/InstantMessagingCall/components/UserCircleList/UserCircleList.html","DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize"],(function(e,t){"use strict";return{components:{"im-call-video-minimize":t},props:["users","myLogin","showSelfView"],computed:{},methods:{displaySelfView(){this.$store.commit("showSelfView")}},template:e}})),define("DS/InstantMessagingCall/store/modules/mediasoupServer/handlers",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders"],(function(e,t){const i=i=>{e.Call(`Producer ${i.id} created for track ${i.track.id}`),i.observer.on("close",(()=>{e.Call(`Producer ${i.id} closed`),t.producer({action:"closeProducer",payload:{id:i.id}})})),i.observer.on("pause",(()=>{e.Call(`Producer ${i.id} paused`),t.producer({action:"pauseProducer",payload:{id:i.id}})})),i.observer.on("resume",(()=>{e.Call(`Producer ${i.id} resumed`),t.producer({action:"resumeProducer",payload:{id:i.id}})})),i.observer.on("trackended",(()=>{e.Call(`Producer ${i.id} trackended`),i.close(),t.producer({action:"closeProducer",payload:{id:i.id}})}))};return{handleNewTransport:(r,s)=>{r.on("connect",(({dtlsParameters:i},o,a)=>{(({dtlsParameters:e},i,r,s,o)=>{t.connectTransport({id:s,dtlsParameters:e,direction:o,callback:i,errback:r})})({dtlsParameters:i},o,a,r.id,r.direction).catch((t=>{e.Call("Error connect transport",t),s(`transport.connect:${r.direction}`)}))})),"send"===r.direction?(r.on("produce",((i,o,a)=>{((e,i,r,s)=>{const{kind:o,rtpParameters:a,appData:n}=e;t.producer({action:"createProducer",payload:{id:s,kind:o,rtpParameters:a,appData:n},callback:i,errback:r})})(i,o,a,r.id).catch((t=>{e.Call("Error produce transport",t),s(`transport.produce:${r.direction}`)}))})),r.observer.on("newproducer",i)):r.observer.on("newconsumer",(i=>{try{(i=>{i.on("close",(()=>{e.Call(`Consumer ${i.id} closed`),t.consumer({action:"closeConsumer",payload:{id:i.id}})})),i.on("pause",(()=>{e.Call(`Consumer ${i.id} paused`),t.consumer({action:"pauseConsumer",payload:{id:i.id}})})),i.on("resume",(()=>{e.Call(`Consumer ${i.id} resumed`),t.consumer({action:"resumeConsumer",payload:{id:i.id}})}))})(i)}catch(t){e.Call("Error new consumer",t),s(`transport.newconsumer:${r.direction}`)}})),r.on("connectionstatechange",(t=>{e.Call(`Transport ${r.direction} connection state: `,t),"failed"!=t&&"disconnected"!=t||s(`transport.connectionstatechange:${t}:${r.direction}`)}))}}})),define("DS/InstantMessagingCall/store/modules/noises",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/lib/NoiseMaker"],(function(e,t){"use strict";return{state:{noiseMaker:t,holdToneDisplayed:!1},getters:{holdtoneURL:(e,t)=>t.assets_url+"holdtone.mp3"},mutations:{noiseURL(e,{noisename:t,url:i}){e.noiseMaker.set(t,i)},startRingtone(e){e.noiseMaker.start("ringtone",3e4)},startRingbacktone(e){e.noiseMaker.start("ringbacktone",3e4)},stopTones(e){e.noiseMaker.stop("ringtone"),e.noiseMaker.stop("ringbacktone"),e.noiseMaker.stop("holdtone")},userIn(e){e.noiseMaker.start("userin")},userOut(e){e.noiseMaker.start("userout")},startHoldtone(e){e.noiseMaker.start("holdtone",!0)},stopHoldtone(e){e.noiseMaker.stop("holdtone")}},actions:{noises({commit:t},{action:i}){switch(i){case"userIn":t("userIn");break;case"userOut":t("userOut");break;case"startRingtone":t("startRingtone");break;case"startRingbacktone":t("startRingbacktone");break;case"stopTones":t("stopTones");break;case"startHoldtone":t("startHoldtone");break;case"stopHoldtone":t("stopHoldtone");break;default:e.error("unknown noises action "+i)}},preloadNoises({state:e,commit:t,getters:i}){const r=i.assets_url;t("noiseURL",{noisename:"ringtone",url:r+"ringtone.mp3"}),t("noiseURL",{noisename:"ringbacktone",url:r+"ringbacktone.wav"}),t("noiseURL",{noisename:"userin",url:r+"userin.mp3"}),t("noiseURL",{noisename:"userout",url:r+"userout.mp3"}),t("noiseURL",{noisename:"holdtone",url:i.holdtoneURL}),e.noiseMaker.preload()}}}})),define("DS/InstantMessagingCall/components/Collab/Collab",["text!DS/InstantMessagingCall/components/Collab/Collab.html","DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument","DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard","DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti","DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay"],(function(e,t,i,r,s,o){"use strict";return{components:{"im-call-ode":t,"im-call-whiteboard":i,"im-call-confetti":r,"im-call-3dplay":s},props:["feature","feature_id","isODE","isWhiteboard","isConfetti","is3DPlay","isScreenShare","swymDriver"],computed:{featureData(){return this.feature&&this.feature.featureData},masterUser(){return this.feature&&this.feature.master&&this.$store.getters.user(this.feature.master)}},template:e}})),define("DS/InstantMessagingCall/store/modules/mediasoupServer/store",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/InstantMessagingCall/store/modules/mediasoupServer/handlers","mediasoup-client"],(function(e,t,i,r){if(!r)return void e.Call("mediasoupClient library is not available");const{Device:s}=r,{handleNewTransport:o}=i,a=()=>{try{return new s}catch(t){"UnsupportedError"===t.name&&e.Call("Unsupported browser")}},n=()=>({sendTransport:null,receiveTransport:null,producers:new Map,consumers:new Map,device:a(),mediasoupEnabled:!1,mediasoupOnly:!1,mediasoupUsers:new Set,mediasoupDebug:!1});return{state:n(),getters:{mediasoupEnabled:e=>e.mediasoupEnabled,mediasoupOnly:e=>e.mediasoupOnly,isUserUsingMediasoup:e=>t=>e.mediasoupUsers.has(t),mediasoupDebug:e=>e.mediasoupDebug,producers:e=>e.producers,consumers:e=>e.consumers},mutations:{mediasoupEnabled(e,t){e.mediasoupEnabled=t},mediasoupOnly(e,t){e.mediasoupOnly=t},sendTransport(e,t){e.sendTransport=t},receiveTransport(e,t){e.receiveTransport=t},resetState(e){Object.assign(e,n())}},actions:{getRouterRtpCapabilities(){t.getRouterRtpCapabilities({callId:"mzi12call"})},routerRtpCapabilities({state:i,commit:r,dispatch:s},{rtpCapabilities:a}){i.device.observer.on("newtransport",(e=>{o(e,(e=>s("fallbackP2P",{step:e})))})),i.device.load({routerRtpCapabilities:a}).then((()=>{t.clientRtpCapabilities({clientRtpCapabilities:i.device.rtpCapabilities}),r("mediasoupEnabled",!0)})).catch((t=>{e.Call("Error loading device",t),s("fallbackP2P",{step:"device.load"})}))},newMediasoupUser({state:t,getters:i,commit:r},{userId:s}){i.myself.user_id==s&&r("mediasoupOnly",!0),t.mediasoupUsers.add(s.toString()),e.Call("New mediasoup user",s)},mediasoupUserLeft({state:t,getters:i},{userId:r}){t.mediasoupUsers.delete(r.toString()),i.myself.user_id==r&&commit("mediasoupOnly",!1),e.Call("Mediasoup user left",r)},webrtcTransportCreated({state:e,commit:t,dispatch:i},{parameters:r,iceServers:s,direction:o}){let a=null;"send"===o?(a=e.device.createSendTransport({...r,iceServers:s}),t("sendTransport",a),i("createProducers")):(a=e.device.createRecvTransport({...r,iceServers:s}),t("receiveTransport",a))},createProducers({state:t,getters:i,dispatch:r},s){if(!t.sendTransport)return r("fallbackP2P",{step:"sendTransport"}),e.Call("Send transport is not available");r("getLocalMedia",{user_id:i.myself.user_id,kind:s}).then((()=>{const[s]=i.streams(i.myself.user_id);return s?t.sendTransport?(s.getTracks().forEach((i=>{if(((e,t,i,r)=>!i.get(t)&&r.canProduce(e))(i.kind,i.id,t.producers,t.device)){const s="video"===i.kind?[{maxBitrate:3e6,maxFrameRate:30}]:[{maxBitrate:15e4}];t.sendTransport.produce({track:i,encodings:s,zeroRtpOnPause:!0,appData:{mediaTag:i.kind,mediasoupOnly:t.mediasoupOnly}}).then((e=>{t.producers.set(i.id,e),r("startMetrics")})).catch((t=>{e.Call("Error creating producer",t),r("fallbackP2P",{step:"sendTransport.produce"})}))}})),r("sendStreamInfo",{kind:"screen",pc:{room_id:i.accepted_room_id}}),r("sendStreamInfo",{kind:"video",pc:{room_id:i.accepted_room_id}}),r("sendStreamInfo",{kind:"audio",pc:{room_id:i.accepted_room_id}}),void r("sendStreamInfo",{kind:"hold",pc:{room_id:i.accepted_room_id}})):(r("fallbackP2P",{step:"sendTransport.getLocalMedia"}),e.Call("Send transport is not available")):e.Call("Local stream is not available")}))},stopProducer({state:e},t){const i=e.producers.get(t);i&&(i.close(),e.producers.delete(t))},pauseProducer({state:e},t){const i=e.producers.get(t);i&&i.pause()},resumeProducer({state:e},t){const i=e.producers.get(t);i&&i.resume()},gotNewProducer({dispatch:i,state:r},s){if(!r.receiveTransport)return i("fallbackP2P",{step:"receiveTransport.gotNewProducer"}),e.Call("Receive transport is not available");t.consumer({action:"requestConsumer",producerId:s.id,transportId:r.receiveTransport.id})},consumerCreated({state:t,getters:i,commit:r,dispatch:s},{id:o,producerId:a,kind:n,rtpParameters:d,paused:l,appData:c}){if(!t.receiveTransport)return s("fallbackP2P",{step:"receiveTransport.consumerCreated"}),e.Call("Receive transport is not available");t.receiveTransport.consume({id:o,producerId:a,kind:n,rtpParameters:d,paused:l,appData:c}).then((o=>{try{t.consumers.set(o.id,o);const{from:e}=o.appData,[a]=i.streams(e)||[new MediaStream];a&&(a.addTrack(o.track),r("remote_stream",{stream:a,pc:{user_id:e}}),s("update_received_stream",{user_id:e,pc:{user_id:e}}))}catch(t){e.Call("Error adding consumer to stream",t)}})).catch((t=>{e.Call("Error creating consumer",t)}))},consumerClosed({state:t,getters:i,commit:r,dispatch:s},{consumerId:o}){const a=t.consumers.get(o);if(!a)return e.Call("Consumer not found");const{from:n}=a.appData,[d]=i.streams(n)||[new MediaStream];d&&(d.removeTrack(a.track),r("remote_stream",{stream:d,pc:{user_id:n}}),s("update_received_stream",{user_id:n,pc:{user_id:n}})),a.close(),t.consumers.delete(o)},consumerPaused({state:t},{consumerId:i}){const r=t.consumers.get(i);if(!r)return e.Call("Consumer not found");r.pause()},consumerResumed({state:t},{consumerId:i}){const r=t.consumers.get(i);if(!r)return e.Call("Consumer not found");r.resume()},resetMediasoup({state:e,commit:t}){e.sendTransport&&"function"==typeof e.sendTransport.close&&e.sendTransport.close(),e.receiveTransport&&"function"==typeof e.receiveTransport.close&&e.receiveTransport.close(),e.producers&&e.producers instanceof Map&&e.producers.size>0&&Array.from(e.producers.values()).forEach((e=>{e&&"function"==typeof e.close&&e.close()})),e.consumers&&e.consumers instanceof Map&&e.consumers.size>0&&Array.from(e.consumers.values()).forEach((e=>{e&&"function"==typeof e.close&&e.close()})),t("resetState")}}}})),define("DS/InstantMessagingCall/store/modules/metrics",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders"],(function(e,t){"use strict";const i=e=>{if(!e)return null;let t={};return e.forEach((e=>{Object.keys(e).forEach((i=>{t[i]=e[i]}))})),t};return{state:{metricsWorker:null,roomId:null,isRunning:!1},mutations:{metricsWorker(e,t){e.metricsWorker=new window.Worker(t)},isRunning(e,t){e.isRunning=t},roomId(e,t){e.roomId=t},resetMetrics(e){const{metricsWorker:t,roomId:i,isRunning:r}={metricsWorker:null,roomId:null,isRunning:!1};e.metricsWorker=t,e.roomId=i,e.isRunning=r}},actions:{registerMessageHandler:({state:i,dispatch:r,getters:s,commit:o})=>{i.metricsWorker.onmessage=a=>{const{data:n}=a,d=s.myself.user_id,l=i.roomId;switch(n.action){case"gatherMetrics":r("gatherMetrics");break;case"stopMetrics":const{payload:s}=a.data;t.sendFinalReportCall({from:d,callId:l,payload:s}),i.metricsWorker.terminate(),o("resetMetrics");break;case"newAlert":const{payload:n}=a.data;t.sendAlert({from:d,callId:l,payload:n});break;case"removedAlert":const{payload:c}=a.data;t.sendAlertRemoved({from:d,callId:l,payload:c});break;default:e.Call("Action not supported")}}},sendToMetricsWorker:({state:e},{action:t,payload:i})=>{if(!t)return null;e.metricsWorker.postMessage({action:t,payload:i})},gatherMetricsFromSenders:({getters:e,dispatch:t},r)=>{r.getSenders().forEach((s=>{if(s&&s.track&&s.track.id){const o=s.track.id;if(o){const a=e.local_kind_of_track(o);a&&s.getStats().then((e=>{const s=i(e);s&&t("sendToMetricsWorker",{action:"newMetric",payload:{userId:r.user_id,kind:a,metric:s,type:"local"}})}))}}}))},gatherMetricsFromReceivers:({getters:e,dispatch:t},r)=>{r.getReceivers().forEach((s=>{if(s&&s.track&&s.track.id){const o=s.track.id;if(o){const a=e.remote_kind_of_track(o);a&&s.getStats().then((e=>{const s=i(e);s&&t("sendToMetricsWorker",{action:"newMetric",payload:{userId:r.user_id,kind:a,metric:s,type:"remote"}})}))}}}))},startMetrics:({getters:e,commit:t,dispatch:i})=>{t("metricsWorker",e.assets_url+"metricsWorker.js"),t("isRunning",!0),t("roomId",e.accepted_room_id),i("registerMessageHandler")},gatherMetrics:({dispatch:e,getters:t})=>{const i=Object.values(t.peer_connections);i.length&&i.forEach((t=>{e("gatherMetricsFromSenders",t),e("gatherMetricsFromReceivers",t)})),e("gatherMetricsProducers"),e("gatherMetricsConsumers")},stopMetrics:({state:e,dispatch:t})=>{e.metricsWorker&&t("sendToMetricsWorker",{action:"stopMetrics"})},gatherMetricsProducers:({dispatch:e,getters:t})=>{t.producers&&t.producers.size>0&&t.producers.forEach((r=>{r.closed||"function"!=typeof r.getStats||r.getStats().then((r=>{const s=i(r);s&&e("sendToMetricsWorker",{action:"newMetric",payload:{userId:t.myself.user_id,kind:s.kind,metric:s,type:"producer"}})}))}))},gatherMetricsConsumers:({dispatch:e,getters:t})=>{t.consumers&&t.consumers.size>0&&t.consumers.forEach((r=>{r.closed||"function"!=typeof r.getStats||r.getStats().then((r=>{const s=i(r);s&&e("sendToMetricsWorker",{action:"newMetric",payload:{userId:t.myself.user_id,kind:s.kind,metric:s,type:"consumer"}})}))}))}}}})),define("DS/InstantMessagingCall/components/UserVideoList/UserVideoList",["text!DS/InstantMessagingCall/components/UserVideoList/UserVideoList.html","DS/InstantMessagingCall/components/UserItem/UserItem"],(function(e,t){"use strict";return{data:()=>({startIndex:0}),components:{"im-call-user-item":t},props:["users","videoDisplayNumber"],computed:{maxVideoNumber(){return this.videoDisplayNumber||6},endIndex(){return this.startIndex+this.maxVideoNumber},isScrollable(){return this.users.length>this.maxVideoNumber},isScrollableUp(){return this.isScrollable&&this.startIndex>0},isScrollableDown(){return this.isScrollable&&this.endIndex<this.users.length}},methods:{scrollUp(){this.startIndex=this.startIndex-1>0?this.startIndex-1:0},scrollDown(){this.startIndex=this.endIndex<this.users.length?this.startIndex+1:this.startIndex},isVisible(e){return this.startIndex<=e&&e<this.endIndex}},template:e}})),define("DS/InstantMessagingCall/store/modules/p2p",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/InstantMessagingCall/store/modules/metrics"],(function(e,t,i){"use strict";var r=window.navigator.userAgent,s=!!r.match(/iPad/i)||!!r.match(/iPhone/i)||!!r.match(/iPadPro/i),o=!!r.match(/WebKit/i),a=s&&o&&!r.match(/CriOS/i);window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;const n={googTypingNoiseDetection:!1,googEchoCancellation:!0,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},d={cursor:!0,logicalSurface:!0},l={mandatory:{OfferToReceiveAudio:!0,offerToReceiveAudio:!0,OfferToReceiveVideo:!0,offerToReceiveVideo:!0}},c=({room_id:t,user_id:i})=>t&&i&&"string"==typeof t&&"string"==typeof i?t+i:e.error("p2p protocol error p2pKey "+JSON.stringify(arguments[0])),u="text",m=t=>(t&&t.getVideoTracks().forEach((t=>{t.contentHint=u,"contentHint"in t?t.contentHint!==u&&console.error("Invalid video track contentHint: "+u):e.error("MediaStreamTrack contentHint attribute not supported")})),t),p=e=>"contentHint"in e&&e.contentHint==u,h=(e,t)=>!!e&&!!(e.kind==t&&("audio"==t||"video"==t&&!p(e))||"screen"==t&&p(e)),g=e=>{var t=e.getTracks(),i={isAudio:!1,isVideo:!1,isScreen:!1};for(let e of t)"audio"==e.kind?(i.isAudio=!0,i.isAudioMuted=!e.enabled,i.track_id_audio=e.id):"video"==e.kind&&(p(e)||i.isVideo?(i.isScreen=!0,i.isScreenMuted=!e.enabled,i.track_id_screen=e.id):(i.isVideo=!0,i.isVideoMuted=!e.enabled,i.track_id_video=e.id));return i},f=(e,t)=>{var i=e.getSenders();for(let e of i)if(e.track&&e.track.id==t)return!0;return!1},v=function(t,i,r){let s=t.getParameters();s.encodings||(s.encodings=[{}]),s.encodings[0]||(s.encodings[0]={}),r&&(s.encodings[0].priority=r),i&&(s.encodings[0].maxBitrate=1e3*i),t.setParameters(s).then((()=>{e.Call("setPriority success to "+r)}),(t=>{e.Call("setPriority failed "+t)}))},_=e=>{const t=navigator.mediaDevices.getSupportedConstraints();return Object.keys(e).reduce(((i,r)=>(t[r]&&(i[r]=e[r]),i)),{})},S=(e=!1,t=!1,i=!1,r=!1)=>t?"screenFirst":r?"audioFirst":"default",C=(e,t)=>{const i=document.querySelector("#im-call-self video");if(i&&(i.srcObject=e),t){const i=t.document.querySelector("#im-call-self video");i&&(i.srcObject=e)}};var b=[];return{modules:{metrics:i},state:{peer_connections:{},local_stream:null,mutex_local_media:!1,remote_streams:{},video_activated:!1,audio_activated:!1,screen_activated:!1,bandwidth:{},priority:{},constraintsVideo:{},constraintsScreen:{},constraintsAudio:{},forceTURN:!1,audioAnalyzer:null,amITalking:!1,amITalkingTimeout:null,audioVolume:null},getters:{pc:e=>t=>e.peer_connections[c(t)],isTrackId:e=>(t,i)=>{var r=e.remote_streams[t];return!!r&&!!r.getTrackById(i)},streams:(e,t)=>(i,r,s)=>{if((s=s||e.remote_streams[i])||i!=t.myself.user_id||(s=e.local_stream),s||t.sip){if(r){var o=new MediaStream,a=s.getTrackById(r);if(a)o.addTrack(a);else{var n=s.getVideoTracks(),d=void 0;n.forEach((e=>{e.contentHint&&e.contentHint==u&&(d=e)})),d?n&&n.length&&o.addTrack(d):n&&n.length&&o.addTrack(n[n.length-1])}return[o]}return[s]}console.warn("can't find stream of user "+i)},self_stream:(e,t)=>e=>t.streams(t.myself.user_id),mutex_local_media:e=>e.mutex_local_media,local_track_of_kind:e=>t=>{if(!e.local_stream)return null;for(let i of e.local_stream.getTracks())if(h(i,t))return i;return null},bandwidth:e=>({kind:t})=>t&&e.bandwidth[t]?e.bandwidth[t]:500,constraintsVideo:e=>e.constraintsVideo,constraintsScreen:e=>e.constraintsScreen,constraintsAudio:e=>e.constraintsAudio,priority:e=>({kind:t})=>t&&e.priority[t]?e.priority[t]:"medium",audioVolume:e=>e.audioVolume,peer_connections:e=>e.peer_connections,local_kind_of_track:e=>t=>{if(!t)return null;if(!e.local_stream)return null;const i=e.local_stream.getTrackById(t);return i&&i.kind?"audio"===i.kind?i.kind:"video"===i.kind?h(i,"screen")?"screen":"video":void 0:null},remote_kind_of_track:e=>t=>{if(!e.remote_streams)return null;if(!t)return null;const i=Object.values(e.remote_streams);for(let e of i){const i=e.getTrackById(t);if(i&&i.kind){if("audio"===i.kind)return i.kind;if("video"===i.kind)return h(i,"screen")?"screen":"video"}}return null}},mutations:{resetP2PState(e){Object.assign(e,{peer_connections:{},local_stream:null,mutex_local_media:!1,remote_streams:{},video_activated:!1,audio_activated:!1,screen_activated:!1,bandwidth:{},priority:{},constraintsVideo:{},constraintsScreen:{},constraintsAudio:{},forceTURN:!1,audioAnalyzer:null,amITalking:!1,amITalkingTimeout:null,audioVolume:null})},pc(t,{user_id:i,room_id:r,webrtcConfig:s,p2pTentatives:o}){var a={user_id:i,room_id:r},n=c(a);if(t.peer_connections[n])return e.Call("p2p bypass PC creation : PC already exists "+i);var d=t.forceTURN?Object.assign({},s,{iceTransportPolicy:"relay"}):s;t.peer_connections[n]=Object.assign(new RTCPeerConnection(d),a),t.peer_connections[n].key=n,t.peer_connections[n].p2pTentatives=o||0},mutex_local_media(e,t){e.mutex_local_media=t},local_stream(e,t){if(e.local_stream)for(let i of t.getTracks())e.local_stream.addTrack(i);else e.local_stream=t},remote_stream(e,{stream:t,pc:i}){let r=i.user_id;e.remote_streams[r]=t},polite(t,{user_id:i,room_id:r}){var s=c({user_id:i,room_id:r});t.peer_connections[s]?t.peer_connections[s].polite=!0:e.error("polite: pc not found "+i)},stopLocalTrack(e,{kind:t}){if(!e.local_stream)return!0;for(let i of e.local_stream.getTracks())if(h(i,t)){i.stop(),e.local_stream.removeTrack(i);break}},deleteLocalStream(e){if(!e.local_stream)return!0;for(let t of e.local_stream.getTracks())t.stop();delete e.local_stream},deleteP2P(t,i){var r=t.peer_connections[i];if(!r)return e.error("failed to retrieve PC "+i);r.close(),delete t.peer_connections[i]},activated(e,{kind:t}){"video"==t?e.video_activated=!0:"screen"==t?e.screen_activated=!0:"audio"==t&&(e.audio_activated=!0)},deactivated(e,{kind:t}){"video"==t?e.video_activated=!1:"screen"==t?e.screen_activated=!1:"audio"==t&&(e.audio_activated=!1)},constraints(e,{bandwidth:t,constraintsVideo:i,constraintsAudio:r,priority:s,constraintsScreen:o}){t&&(e.bandwidth=t),i&&i!={}&&(e.constraintsVideo=i),r&&r!={}&&(e.constraintsAudio=r),o&&o!={}&&(e.constraintsScreen=o),s&&s!={}&&(e.priority=s)},forceTURN(e,t){e.forceTURN=t},amITalking(e,t){e.amITalking=t},amITalkingTimeout(e,t){e.amITalkingTimeout=t}},actions:{getUserMedia:({},t)=>navigator.mediaDevices?navigator.mediaDevices.getUserMedia(t):navigator.getUserMedia?new Promise(((e,i)=>navigator.getUserMedia(t,e,i))):(e.Call("no navigator getLocalMedia method found"),Promise.reject("NotReadableError")),initP2P({commit:t,rootState:i,dispatch:r,getters:s},o){if(e.Call("iOSSafari : "+a),s.pc(o))return e.Call("p2p already exists");if(s.mediasoupOnly&&!o.reason)return s.mediasoupDebug&&r("alert_mediasoupOnly"),e.Call("Im using mediasoup only, skipping p2p");if(!o.reason&&(s.isUserUsingMediasoup(o.user_id)||o.mediasoupOnly))return s.mediasoupDebug&&r("alert_connectedUserMediasoup",o.user_id),e.Call(`User ${o.user_id} is using mediasoup only, skipping p2p`);o.reason&&t("mediasoupOnly",!1),t("pc",Object.assign({},o,{webrtcConfig:i.webrtcConfig}));var n=s.pc(o);s.mediasoupDebug&&r("alert_connectedUserP2P",o.user_id),n.ontrack=e=>{r("ontrack",{data:e,pc:n})},n.onicecandidate=e=>{r("onicecandidate",{data:e,pc:n})},n.onnegotiationneeded=t=>{if("stable"!=n.signalingState)return e.Call("onnegotiationneeded ignored "+n.user_id);e.Call("onnegotiationneeded "+n.user_id),r("createOffer",{data:t,pc:n}),r("getStrategy")},n.oniceconnectionstatechange=e=>{r("oniceconnectionstatechange",{data:e,pc:n})},n.onsignalingstatechange=e=>{r("onsignalingstatechange",{data:e,pc:n})},n.onicegatheringstatechange=e=>{r("onicegatheringstatechange",{data:e,pc:n})},r("startMetrics")},sendStream({dispatch:i,getters:r},s){e.Call("sendStream to "+s.user_id),i("getLocalMedia",s).then((()=>r.mediasoupOnly?e.Call("Im using mediasoup only, no need to send stream"):r.isUserUsingMediasoup(s.user_id)||s.mediasoupOnly?e.Call(`User ${s.user_id} is using mediasoup only, no need to send stream`):void i("addLocalStream",r.pc(s)))).catch((e=>{console.error(e),i("alert_getLocalMediaError",e);var o=r.pc(s);t.callEventFromView({action:"reporting",reason:e,room_id:s.room_id,pcStates:o&&[o.polite,o.signalingState,o.iceConnectionState],step:"sendStream"})}))},cleanAllP2P({state:e,commit:t,dispatch:i}){for(let t in e.peer_connections)i("cleanP2P",{key:t});t("deleteLocalStream")},cleanP2P({commit:t},{key:i,room_id:r,user_id:s}){e.Call("cleanP2P of "+(i||s)),t("deleteP2P",i||c({room_id:r,user_id:s}))},fallbackP2P({commit:i,dispatch:r,getters:s,rootState:o,state:a},{step:n}){const d=s.accepted_room_id,l="muted"==s.local_stream_info("audio"),c=s.local_stream_info("video")&&"muted"!=s.local_stream_info("video"),u=s.local_stream_info("screen");e.Call(`Error with mediasoup on step ${n}. Use P2P.`);try{r("resetMediasoup"),r("stopTrack",{room_id:d,kind:"audio"}),r("alertReconnect",{room_id:d,step:n});const e=s.deviceConstraints({type:"audioinput",defaultConstraints:{}});let t=!1;return c&&(r("stopTrack",{room_id:d,kind:"video"}),t=s.deviceConstraints({type:"videoinput",defaultConstraints:{}})),u&&r("stopTrack",{room_id:d,kind:"screen"}),r("getUserMedia",{audio:e,video:t}).then((e=>{i("local_stream",e),r("local_stream_info"),s.accepters.forEach((e=>{if(e!=s.myself.user_id){r("initP2P",{room_id:d,webrtcConfig:o.webrtcConfig,user_id:e,reason:n});const t=s.pc({user_id:e,room_id:d,webrtcConfig:o.webrtcConfig});t.reason=n,r("addLocalStream",t)}})),l&&r("muteTrack",{kind:"audio",room_id:d}),c&&C(e,s.windowRef),r("alertRestore",{room_id:d,step:n})}))}catch(e){t.callEventFromView({action:"reporting",reason:`reconnectFailed - ${e}`,connectionMode:"p2p",room_id:d,step:n,user_id:s.myself.user_id})}},getLocalMedia:({state:i,commit:r,dispatch:s,getters:o},{user_id:a,kind:l})=>new Promise(((c,u)=>{const{local_stream:p,screen_activated:h,video_activated:f}=i,v=h,S=f,C=!0;let k,y,w;if(p){const{isAudio:e,isVideo:t,isScreen:i}=g(p);if(y=!e,k=S&&!t,w=v&&!i,!y&&!k&&!w)return c()}else y=C,k=S,w=v;if(i.mutex_local_media)return b.push((t=>{e.Call("Concurrent getLocalMedia finished, use same media for "+a),t&&u(t)||c()})),e.Call("Waiting for a concurrent getLocalMedia to finish before sending my stream to "+a);r("mutex_local_media",!0);let{constraintsScreen:I,constraintsAudio:D,constraintsVideo:T}=o;D=_(D),T=_(T),I=_(I);const M=D&&Object.keys(D).length>0,A=T&&Object.keys(T).length>0,E=I&&Object.keys(I).length>0;M&&e.Call(`getLocalMedia audio constraints to apply ${JSON.stringify(D)}`),A&&e.Call(`getLocalMedia video constraints to apply ${JSON.stringify(T)}`),E&&e.Call(`getLocalMedia screen constraints to apply ${JSON.stringify(I)}`),M||M||E||e.Call("getLocalMedia no constraints to apply");let O={...n,audio:y&&{},video:k&&T};const $=e=>{for(var t of(e&&r("local_stream",e),e&&s("audioAnalyzer",null),s("local_stream_info"),s("setCurrentDevices",e),c(),b))t();b.length=0,r("mutex_local_media",!1)};var R=e=>{for(var i of(u(e),b))i(e);b.length=0,r("mutex_local_media",!1),s("tracking",{action:"getLocalMediaFailed",reason:e,user_id:a}),s("track_event",{action:"getLocalMediaResult",dimensions:e.toString()}),t.callEventFromView({action:"reporting",reason:e,step:"getLocalMedia"})};const U=[...w?["screen"]:[],...y?["audio"]:[],...k?["video"]:[]];s("track_event",{action:"getLocalMedia",dimensions:U,eventValue:U.length}),new Promise(((e,t)=>{const i=I?{...d,video:I}:d;if(!w)return e();navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(i).then(e).catch(t):navigator.getDisplayMedia(i).then(e).catch(t)})).then((e=>{O.audio||O.video?(e&&r("local_stream",m(e)),s("getUserMedia",{audio:y,video:k}).then((()=>{s("enumerateDevices").then((()=>{const e=o.deviceConstraints({type:"audioinput",defaultConstraints:{}});if(O.audio=e,k){const e=o.deviceConstraints({type:"videoinput",defaultConstraints:T});O.video=e}if(l){const e=O[l];O={},O[l]=e}})).then((()=>{s("getUserMedia",O).then($,R)}))}))):$(m(e))})).catch((e=>{R(e),console.error(e)}))})),removeLocalTrackFromPC({},{pc:e,kind:t}){var i=e.getSenders();if(!i)return!0;i.forEach((i=>{h(i.track,t)&&e.removeTrack(i)}))},replaceLocalTrack({},{pc:e,kind:t,stream:i}){var r=e.getSenders();if(!r)return!0;const[s]="audio"===t?i.getAudioTracks():i.getVideoTracks().filter((e=>h(e,"video")));r.forEach((e=>{s&&h(e.track,t)&&e.replaceTrack(s)}))},addLocalStream({state:i,getters:r,dispatch:s},o){var a=i.local_stream;if(!a)return e.Call("no local stream");if(o.addTrack)try{var n,d=a.getTracks(),l=-1;for(n=0;n<d.length;n++)f(o,d[n].id)||(d[n].contentHint&&d[n].contentHint==u?l=n:o.addTrack(d[n],a));l>-1&&o.addTrack(d[l],a)}catch(i){e.error(i),t.callEventFromView({action:"reporting",reason:i,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"addTrack"})}else{if(!o.addStream)return e.error("addLocalStream called but addTrack & addStream unexist");try{o.addStream(a)}catch(i){e.error("addLocalStream failed to addStream "+i),t.callEventFromView({action:"reporting",reason:i,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"addStream"})}}s("sendStreamInfo",{kind:"screen",pc:o}),s("sendStreamInfo",{kind:"video",pc:o}),s("sendStreamInfo",{kind:"audio",pc:o}),s("sendStreamInfo",{kind:"hold",pc:o})},sendStreamInfo({getters:e},{kind:i,pc:r}){let s=e.local_track_of_kind(i);switch(i){case"screen":s&&t.callEventFromView({action:"speaker",type:i,room_id:r.room_id,user_id:e.myself.user_id,track_id:s.id,watermark_activated:e.isWatermarkActivated(r.room_id)});break;case"audio":case"video":s&&t.callEventFromView({action:"mute",type:i,muted:"muted"==e.local_stream_info(i),room_id:r.room_id,track_id:s.id});break;case"hold":t.callEventFromView({action:"hold",user_id:e.myself.user_id,onHold:e.hold&&-1!==e.hold.indexOf(r.room_id),room_id:r.room_id,sip:e.sip})}},local_stream_info({state:e,dispatch:t}){e.local_stream&&t("local_stream_changed",g(e.local_stream),{root:!0})},createOffer({dispatch:i},{pc:r}){r.makingOffer=!0,e.Call("CreateOffer"),r.createOffer(l).then((e=>r.setLocalDescription(e))).then((()=>{t.SDP({room_id:r.room_id,user_id:r.user_id,sdp:r.localDescription,isCaller:!0,reason:r.reason}),r.makingOffer=!1})).catch((s=>{e.error("failed to createOffer "+s),r.makingOffer=!1,i("track_event",{action:"webrtcIssue",dimensions:["createOffer",JSON.stringify(s),r.polite,r.signalingState,r.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:s,room_id:r.room_id,pcStates:[r.polite,r.signalingState,r.iceConnectionState],step:"createOffer"})}))},onAnswer({dispatch:i},{data:r,pc:s}){s.isSettingRemoteAnswerPending=!0,s.setRemoteDescription(new RTCSessionDescription(r.sdp)).then((()=>{e.Call("onAnswer setRemoteDescription success"),s.isSettingRemoteAnswerPending=!1})).catch((r=>{e.error("onAnswer failed "+r),s.isSettingRemoteAnswerPending=!1,i("track_event",{action:"webrtcIssue",dimensions:["onAnswer",JSON.stringify(r),s.polite,s.signalingState,s.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:r,room_id:s.room_id,pcStates:[s.polite,s.signalingState,s.iceConnectionState],step:"onAnswer"})}))},onOffer({dispatch:i,commit:r},{data:s,pc:o}){var n=!o.makingOffer&&("stable"==o.signalingState||o.isSettingRemoteAnswerPending);if(o.ignoreOffer=!o.polite&&!n,o.ignoreOffer)return e.Call("Ignoring SDP offer to avoid collision");o.setRemoteDescription(new RTCSessionDescription(s.sdp)).then((()=>(e.Call("onOffer setRemoteDescription success"),i("getLocalMedia",s)))).then((()=>(e.Call("onOffer getLocalMedia resolved"),i("addLocalStream",o)))).then((()=>(e.Call("onOffer localStream added"),o.createAnswer(l)))).then((t=>(e.Call("onOffer answer created"),o.setLocalDescription(t)))).then((()=>{e.Call("onOffer setLocalDescription success"),t.SDP({room_id:o.room_id,user_id:o.user_id,sdp:o.localDescription,isCaller:!1})})).catch((r=>{e.error("onOffer failed (polite  : "+o.polite+", iOSSafari: "+a+", signalingState : "+o.signalingState+"). Error: "+r),i("track_event",{action:"webrtcIssue",dimensions:["onOffer",JSON.stringify(r),o.polite,o.signalingState,o.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:r,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"onOffer"}),i("initRetryProcess",{pc:o})}))},ontrack({dispatch:t,commit:i,getters:r},{data:s,pc:o}){var a=s.stream||s.streams[0],n=a.getVideoTracks();n&&r.speaker_id&&o.user_id==r.speaker_id&&1==n.length&&(n[0].contentHint=u,i("speaker",{user_id:o.user_id,speaker_track_id:n[0].id,kind:"screen"}));var d=g(a);e.Call("Track of "+o.user_id+" received "+JSON.stringify(d)),i("remote_stream",{stream:a,pc:o,info:d}),t("update_received_stream",{user_id:o.user_id,pc:o})},update_received_stream({dispatch:e,state:t},{user_id:i,pc:r}){var s=t.remote_streams[i];if(!s)return!0;var o=g(s);o.isAudio?e("received_track_audio",{user_id:r.user_id},{root:!0}):e("remove_track_audio",{user_id:r.user_id},{root:!0}),o.isVideo?e("received_track_video",{user_id:r.user_id},{root:!0}):e("remove_track_video",{user_id:r.user_id},{root:!0}),o.isScreen?e("received_track_screen",{user_id:r.user_id},{root:!0}):e("remove_track_screen",{user_id:r.user_id},{root:!0})},onicecandidate({},{data:i,pc:r}){if(!i.candidate)return e.Call("ignoring candidate "+JSON.stringify(i));t.webrtcIceCandidate({room_id:r.room_id,user_id:r.user_id,candidate:i.candidate})},oniceconnectionstatechange({dispatch:t},{data:i,pc:r}){e.Call("oniceconnectionstatechange : "+r.iceConnectionState),"failed"===r.iceConnectionState&&"function"==typeof r.restartIce&&r.restartIce(),"failed"===r.iceConnectionState||"disconnected"===r.iceConnectionState||"closed"===r.iceConnectionState||r.iceConnectionState},onsignalingstatechange({dispatch:t},{data:i,pc:r}){e.Call("onsignalingstatechange : "+r.signalingState),"stable"==r.signalingState&&t("update_received_stream",{user_id:r.user_id,pc:r})},onicegatheringstatechange({},{data:t,pc:i}){let r="Unknown";switch(i.iceGatheringState){case"new":case"complete":r="Idle";break;case"gathering":r="Determining route"}e.Call("ICE status : "+i.iceGatheringState)},SDP({dispatch:t,getters:i,commit:r},s){if(!s.sdp)return e.error("failed to find sdp in "+JSON.stringify(s));if(i.refusers.indexOf(s.user_id)>-1)return e.Call("SDP sender already left the call");var o=i.pc(s);if(!o){if(!i.accepted_room||s.room_id!=i.accepted_room.room_id)return e.Call("SDP received for another device");if(e.Call("SDP initP2P for mobile retrocompatibility"),r("accepter",s.user_id),t("initP2P",s),t("autoEndTimeoutOFF",{room_id:s.room_id}),!(o=i.pc(s)))return e.error("SDP failed to create pc "+JSON.stringify(s))}s.isCaller?t("onOffer",{data:s,pc:o}):t("onAnswer",{data:s,pc:o})},webrtcIceCandidate({getters:i,dispatch:r},s){if(!s.candidate)return e.Call("error no candidate in "+JSON.stringify(s));var o=i.pc(s);if(!o)return e.error("webrtcIceCandidate failed to find pc "+JSON.stringify(s));o.addIceCandidate(new RTCIceCandidate(s.candidate)).then((()=>{e.Call("addIceCandidate success")})).catch((i=>{o.ignoreOffer||(e.error("addIceCandidate failed "+i),r("track_event",{action:"webrtcIssue",dimensions:["webrtcIceCandidate",JSON.stringify(i),o.polite,o.signalingState,o.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:i,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"webrtcIceCandidate"}))}))},activeTrack({state:e,dispatch:i,getters:r,commit:s},{kind:o,room_id:a}){s("activated",{kind:o}),r.local_track_of_kind(o)?i("muteTrack",{kind:o,room_id:a,unmute:!0}):r.mediasoupOnly?i("createProducers",o):(r.mediasoupEnabled&&i("createProducers",o),i("getLocalMedia",{kind:o,room_id:a}).then((()=>{for(let t in e.peer_connections)i("addLocalStream",e.peer_connections[t]);t.callEventFromView({type:o,action:"mute",muted:!1,room_id:a})})).catch((e=>{s("deactivated",{kind:o}),i("alert_getLocalMediaError",e),t.callEventFromView({action:"reporting",reason:e,room_id:a,step:"activeTrack"})}))),r.sip&&i("activeStreamWebTel",{onHold:r.is_onhold_room(a)})},muteTrack({getters:e,dispatch:i,commit:r,state:s},{kind:o,room_id:a,unmute:n}){for(let t of s.local_stream.getTracks())if(h(t,o)&&(t.enabled=!!n,e.mediasoupOnly||e.mediasoupEnabled)){const e=!n,r=t;r&&e&&i("pauseProducer",r.id),r&&!e&&i("resumeProducer",r.id)}i("local_stream_info"),"video"==o&&r("showSelfView"),t.callEventFromView({type:o,action:"mute",muted:!n,room_id:a}),e.sip&&i("muteStreamWebTel",{onHold:e.is_onhold_room(a)})},stopTrack({state:i,dispatch:r,commit:s,getters:o},{kind:a,room_id:n}){var d=o.local_track_of_kind(a);if(!d)return console.error("Can not find track of kind "+a);(o.mediasoupOnly||o.mediasoupEnabled)&&r("stopProducer",d.id);var l=d.id;e.Call("stopTrack "+a+" "+l);for(let e in i.peer_connections)r("removeLocalTrackFromPC",{pc:i.peer_connections[e],kind:a});s("stopLocalTrack",{kind:a}),r("local_stream_info"),s("deactivated",{kind:a}),"screen"==a&&r("watermarkedScreensharer",{room_id:n,active:!1,screensharer_id:null}),t.callEventFromView({type:a,action:"stopTrack",track_id:l,room_id:n||o.accepted_room&&o.accepted_room.room_id,watermark_activated:o.isWatermarkActivated(n)})},addStreamToAllPC({dispatch:e,getters:t,state:i},{kind:r}){e("getLocalMedia",{type:r,user_id:t.myself.user_id}).then((()=>{for(let t in i.peer_connections)e("addLocalStream",i.peer_connections[t])}))},restartAllP2P({dispatch:e,state:t}){for(let i in t.peer_connections)e("initRetryProcess",{pc:t.peer_connections[i]})},initRetryProcess({dispatch:i,getters:r,rootState:s},{pc:o}){if(e.Call("initRetryProcess with "+o.user_id),"number"==typeof o.p2pTentatives?o.p2pTentatives++:o.p2pTentatives=1,i("track_event",{action:"retryP2P",dimensions:"init",eventValue:o.p2pTentatives}),o.p2pTentatives>s.max_p2pTentatives)return e.Call("initRetryProcess aborted : reached max_p2pTentatives");t.callEventFromView({action:"restartP2P",user_id:r.myself.user_id,user_id_to:o.user_id,room_id:o.room_id,p2pTentatives:o.p2pTentatives})},restartP2P({rootState:i,dispatch:r,getters:s,commit:o},{user_id:a,room_id:n,p2pTentatives:d}){var l={user_id:a,room_id:n,webrtcConfig:i.webrtcConfig,p2pTentatives:d};e.Call("restartP2P asked by "+l.user_id),r("resetPC",l).then((()=>(o("polite",l),t.callEventFromView({action:"p2pRestarted",user_id:s.myself.user_id,user_id_to:l.user_id,room_id:l.room_id,p2pTentatives:d})))).catch((i=>{e.error("restartP2P failed "+i),t.callEventFromView({action:"reporting",reason:i,room_id:n,p2pTentatives:d,step:"restartP2P"})}))},p2pRestarted({dispatch:i,rootState:r},{user_id:s,room_id:o,p2pTentatives:a}){var n={user_id:s,room_id:o,webrtcConfig:r.webrtcConfig,p2pTentatives:a};e.Call("p2pRestarted "+n.user_id),i("resetPC",n).then((()=>i("sendStream",{user_id:n.user_id,room_id:n.room_id}))).catch((i=>{e.error("p2pRestarted failed "+i),t.callEventFromView({action:"reporting",reason:i,room_id:o,p2pTentatives:a,step:"p2pRestarted"})}))},resetPC:({commit:e,dispatch:t},i)=>(e("remove_track_audio",{user_id:i.user_id}),e("remove_track_video",{user_id:i.user_id}),e("remove_track_screen",{user_id:i.user_id}),t("cleanP2P",i).then((()=>t("initP2P",i)))),replaceTrack:({state:e,getters:t,commit:i,dispatch:r},{deviceId:s,kind:o,room_id:a})=>r("getUserMedia",{[o]:{deviceId:{exact:s}}}).then((n=>{if("audio"==o&&"default"==s){const e=t.resolveDefaultAudioDevice(n);e&&e!=s&&r("replaceTrack",{deviceId:e,kind:o,room_id:a})}const d=Object.values(e.peer_connections);r("stopTrack",{kind:o,room_id:a}),i("local_stream",n),r("local_stream_info"),"video"==o&&C(n,t.windowRef),r("addStreamToAllPC",{kind:o}),d.forEach((e=>{r("replaceLocalTrack",{pc:e,kind:o,stream:n})})),(t.mediasoupOnly||t.mediasoupEnabled)&&r("createProducers")})).catch((e=>{console.error("error happend : ",e)})),getStats:({state:e},{selector:t,allStats:i})=>new Promise(((r,s)=>{var o=[],a=[];for(let i in e.peer_connections)o.push(e.peer_connections[i].getStats(t)),a.push(i);Promise.all(o).then((e=>{var t={},s=0;return e.forEach((e=>{t[a[s]]=[],e.forEach((e=>{("outbound-rtp"==e.type||"inbound-rtp"==e.type||i)&&t[a[s]].push(e)})),s++})),r(t)})).catch(s)})),setStrategy({commit:e,dispatch:t,getters:i,state:r},s){const{constraints:o,parameters:a}=s;if(e("constraints",{...o,...a}),t("applyStrategy",s),s.toNegociate)for(let e in r.peer_connections)t("createOffer",{pc:r.peer_connections[e]})},applyStrategy({dispatch:t},i){if(i&&i.constraints){const{constraints:e}=i;t("changeConstraints",e)}else e.Call("error : strategy does not contain constraints");if(i&&i.parameters){const{parameters:e}=i;t("updateBitrateAndPriority",e)}else e.Call("error : strategy does not contain parameters")},changeConstraints({state:t},i){if(!t.local_stream)return e.Call("warn : No local stream to update");t.local_stream.getTracks().forEach((t=>{let r=null;if(t.kind){const s=h(t,"screen")?"screen":t.kind;switch(s){case"audio":r=i.constraintsAudio;break;case"video":r=i.constraintsVideo;break;case"screen":r=i.constraintsScreen;break;default:r={}}const o=_(r);t.applyConstraints(o).then((()=>{e.Call(`new ${s} Constraints applied : ${JSON.stringify(o)}`)})).catch((t=>{e.Call("error : cannot applyConstraints "+t)}))}}))},updateBitrateAndPriority({state:t},i){const r=Object.values(t.peer_connections);if(!r||!r.length)return e.Call("error: no peer connections found");for(const t of r){const r=t.getSenders();r&&r.length?r.filter((e=>e&&e.track&&e.track.kind)).forEach((e=>{const t=h(e.track,"screen")?"screen":e.track.kind,r=i.bandwidth[t],s=i.priority[t];v(e,r,s)})):e.Call(`error: pc of ${t.user_id} have no senders`)}},getStrategy({state:e},i=!1){const{screen_activated:r,video_activated:s,audio_activated:o,amITalking:a}=e;t.getStrategy({strategyName:S(s,r,o,a),toNegociate:i})},audioAnalyzer({commit:t,dispatch:i,state:r},s){if(!r.audioAnalyzer){const[o]=s&&s.getAudioTracks()||r.local_stream.getAudioTracks();if(!o)return e.Call("no audio tracks");const a=new(window.AudioContext||window.webkitAudioContext),n=a.createMediaStreamSource(new MediaStream([o])),d=a.createAnalyser();d.fftSize=256,n.connect(d);const l=d.frequencyBinCount,c=new Uint8Array(l),u=40;function m(){d.getByteFrequencyData(c);const e=c.reduce(((e,t)=>e+t),0)/l;e>u?(r.amITalking||(t("amITalking",!0),r.screen_activated||i("getStrategy",!0)),r.amITalkingTimeout&&(clearTimeout(r.amITalkingTimeout),t("amITalkingTimeout",null))):r.amITalking&&!r.amITalkingTimeout&&t("amITalkingTimeout",setTimeout((()=>{t("amITalking",!1),i("getStrategy",!0)}),1e4)),r.audioVolume=e,requestAnimationFrame(m)}m()}},browserStopSharing({dispatch:e,getters:t},{stream:i,room_id:r}){i.oninactive=()=>{e("stopTrack",{kind:"screen",room_id:r})},i.getVideoTracks()[0].addEventListener("ended",(()=>{!i.active&&t.local_track_of_kind("screen")&&e("stopTrack",{kind:"screen",room_id:r})}))},alertReconnect({dispatch:e},{room_id:i,step:r,user:s}){e("alert_reconnecting",{show:!0,user:s}),s&&s.id||t.callEventFromView({action:"reporting",reason:"reconnect",connectionMode:"mediasoup",room_id:i,step:r})},alertRestore({dispatch:e},{room_id:i,step:r,user:s}){setTimeout((()=>{e("alert_reconnecting",{show:!1,user:s}),e("alert_connectionRestored",{user:s}),s&&s.id||t.callEventFromView({action:"reporting",reason:"restored",connectionMode:"p2p",room_id:i,step:r})}),500)}}}})),define("DS/InstantMessagingCall/components/PanelUsers/PanelUsers",["text!DS/InstantMessagingCall/components/PanelUsers/PanelUsers.html","DS/InstantMessagingCall/components/UserVideoList/UserVideoList","DS/InstantMessagingCall/components/UserCircleList/UserCircleList","DS/InstantMessagingCall/components/SelfView/SelfView"],(function(e,t,i,r){"use strict";return{components:{"im-call-user-video-list":t,"im-call-user-circle-list":i,"im-call-self":r},props:["showSelfView","myLogin"],computed:{users(){return this.$store.getters.accepters.map((e=>this.$store.getters.user(e)))},videoUserList(){return this.$store.getters.accepters.map((e=>this.$store.getters.user(e))).filter((e=>e.stream_info.isVideoStreamer&&!e.stream_info.isVideoStreamerMuted))},audioUserList(){return this.$store.getters.accepters.map((e=>this.$store.getters.user(e))).filter((e=>!e.stream_info.isVideoStreamer||e.stream_info.isVideoStreamerMuted))}},methods:{minimize(){this.$store.commit("showUserList",!1)}},template:e}})),define("DS/InstantMessagingCall/store/modules/call",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/InstantMessagingCall/store/modules/users","DS/InstantMessagingCall/store/modules/p2p","DS/InstantMessagingCall/store/modules/mediasoupServer/store","DS/RTConvAPI/drivers/RTC_driver","DS/InstantMessagingCall/store/modules/settings"],(function(e,t,i,r,s,o,a){"use strict";const n={initial:"initial",invited:"invited",accepted:"accepted",ended:"ended"},d=()=>({callStatus:n.initial,rooms:{},room_id_accepted:null,room_id_invitations:[],room_id_hold:[],roomName:null,dmId:null,oldDmId:null,isVolumeOFF:!1,displayActionBar:!0,minimized:!1,date_start:0,showSelfView:!0,currentPanel:null,sip:!1,showInvite:!0,showDialer:!1,isHoldtoneON:!1,hideConvFeatures:!1,isPrivateConv:!1,isSwymConv:!1,isCallWindowed:!1,windowRef:null,isWindowRefReady:!1,isRTCActivated:!1,room_id_watermark:[],invitePosition:{}});return{modules:{users:i,p2p:r,settings:a,server:s},state:Object.assign({startMinimized:!1,timelineAvailable:!0,screenSharingAvailable:!0,confettiAvailable:!1},d()),getters:{screenSharingAvailable:e=>e.screenSharingAvailable,timelineAvailable:e=>e.timelineAvailable&&!e.hideConvFeatures,isInitial:e=>e.callStatus==n.initial,isAccepted:e=>e.callStatus==n.accepted,isInvited:e=>e.callStatus==n.invited,isEnded:e=>e.callStatus==n.ended,invitations:e=>e.room_id_invitations,room:e=>t=>e.rooms[t],accepted_room_id:e=>e.room_id_accepted,accepted_room:e=>e.rooms[e.room_id_accepted],is_accepted_room:e=>t=>!!e.room_id_accepted&&e.room_id_accepted==t,called_users_name:e=>t=>{var i=[];if(!e.rooms[t]||!e.rooms[t].calledUsers)return i;for(let r of e.rooms[t].calledUsers)i.push(r.username);return i},isVolumeOFF:e=>e.isVolumeOFF,displayActionBar:e=>e.displayActionBar,minimized:e=>e.minimized,date_start:e=>e.date_start,const_timeout_ms:e=>3e4,timeout_date_start:e=>t=>e.rooms[t].timeout_date_start,showSelfView:e=>e.showSelfView,currentPanel:e=>e.currentPanel,dmId:e=>(e.dmId||(e.dmId=e.accepted_room&&e.accepted_room.options&&e.accepted_room.options.dmId),e.dmId),oldDmId:e=>e.oldDmId,isPrivateConv:e=>e.isPrivateConv,isSwymConv:e=>e.isSwymConv,isRTCActivated:e=>e.isRTCActivated,sip:e=>e.sip,roomName:e=>t=>(e.roomName||(e.roomName=t.topic||t.options&&t.options.topic||t.orderId||t.options&&t.options.orderId),e.rooms[t.room_id].topic||e.rooms[t.room_id].options&&e.rooms[t.room_id].options.topic||e.rooms[t.room_id].orderId||e.rooms[t.room_id].options&&e.rooms[t.room_id].options.orderId),showInvite:e=>e.showInvite,showDialer:e=>e.showDialer,hideConvFeatures:e=>e.sip||e.hideConvFeatures,hold:e=>e.room_id_hold,is_onhold_room:e=>t=>e.room_id_hold&&e.room_id_hold.indexOf(t)>-1,isHoldtoneON:e=>e.isHoldtoneON,asDelegateOf:e=>t=>e.rooms[t].asDelegateOf,simringWith:e=>t=>e.rooms[t].simringWith,isWatermarkActivated:e=>t=>!!e.room_id_watermark.includes(t),isCallWindowed:e=>e.isCallWindowed,windowRef:e=>e.windowRef,isWindowRefReady:e=>e.isWindowRefReady,invitePosition:e=>e.invitePosition},mutations:{resetCallState(e){Object.assign(e,d())},status(t,i){let r;if(i){if(!n[i])return e.Call("error callStatus unknown : "+i);r=n[i]}else switch(t.callStatus){case n.initial:r=n.invited;break;case n.invited:r=n.accepted;break;case n.accepted:r=n.ended;break;default:r=n.initial}return r==t.callStatus||(r==n.invited&&t.callStatus!=n.initial&&t.callStatus!=n.ended||r==n.accepted&&t.callStatus!=n.invited||r==n.ended&&t.callStatus!=n.invited&&t.callStatus!=n.accepted?e.Call("Can not set "+r+" after "+t.callStatus):(r==n.accepted&&t.startMinimized&&(t.minimized=!0),r==n.accepted&&(t.date_start=Date.now()),e.Call("nextStatus: "+r),void(t.callStatus=r)))},room_accepted(e,t){e.room_id_accepted=t},room(e,t){e.rooms[t.room_id]?(e.rooms[t.room_id].asDelegateOf=t.asDelegateOf,e.rooms[t.room_id].simringWith=t.simringWith):e.rooms[t.room_id]=t},roomName(e,t){t.topic&&(e.rooms[t.room_id].topic=t.topic,e.roomName=t.topic),t.options&&t.options.topic&&(e.rooms[t.room_id].options.topic=t.options.topic,e.roomName=t.options.topic),t.orderId&&(e.rooms[t.room_id].orderId=t.orderId,e.roomName=t.orderId),t.options&&t.options.orderId&&(e.rooms[t.room_id].orderId=t.orderId,e.roomName=t.options.orderId)},dmId(e,{newDmId:t,room_id:i}){t&&t!=e.rooms[i].options.dmId&&(e.oldDmId=e.rooms[i].options.dmId,e.dmId=t,e.rooms[i].options.dmId=t)},invitation_del(e,t){let i=e.room_id_invitations.indexOf(t);-1!=i&&e.room_id_invitations.splice(i,1)},invitation_del_all(e){e.room_id_invitations.length=0},invitation(e,t){-1==e.room_id_invitations.indexOf(t)&&e.room_id_invitations.push(t)},volume:(e,t)=>{e.isVolumeOFF=!t},closeActionBar:e=>{e.displayActionBar=!1},openActionBar:e=>{e.displayActionBar=!0},minimize:(e,t)=>{e.minimized=t},timeout_started:(e,{room_id:t})=>{e.rooms[t].timeout_date_start=Date.now()},timeout_stopped:(e,{room_id:t})=>{e.rooms[t].timeout_date_start=0},showSelfView:e=>{e.showSelfView=!0},hideSelfView:e=>{e.showSelfView=!1},currentPanel:(e,t)=>{e.currentPanel=t},screenSharingAvailable:(e,t)=>{e.screenSharingAvailable=t},sipState:(e,t)=>{e.sip=!!(t&&t.options&&t.options.sip)&&!!t.options.sip},showInvite:e=>{e.showInvite=!0},hideInvite:e=>{e.showInvite=!1},showDialer:e=>{e.showDialer=!0},hideDialer:e=>{e.showDialer=!1},hideConvFeatures:(e,t)=>{e.hideConvFeatures=!t||!t.convId&&!t.dmId},hold:(e,t)=>{-1===e.room_id_hold.indexOf(t)&&e.room_id_hold.push(t)},resume:(e,t)=>{const i=e.room_id_hold.indexOf(t);i>-1&&e.room_id_hold.splice(i,1)},holdtoneON:(e,t)=>{e.isHoldtoneON=t},isPrivateConv:(e,t)=>{e.isPrivateConv=t},isSwymConv:(e,t)=>{const i=t.split(":").pop();e.isSwymConv=!/^[0-9]*$/.test(i)},isCallWindowed:(e,t)=>{e.isCallWindowed=t},windowRef:(e,t)=>{e.windowRef=t},isWindowRefReady:(e,t)=>{e.isWindowRefReady=t},isRTCActivated:(e,t)=>{e.isRTCActivated=t},watermark:(e,{room_id:t,active:i})=>{if(i&&!e.room_id_watermark.includes(t))e.room_id_watermark.push(t);else if(!i&&e.room_id_watermark.includes(t)){const i=e.room_id_watermark.indexOf(t);e.room_id_watermark.splice(i,1)}},invitePosition:(e,{top:t,left:i})=>{e.invitePosition={top:t,left:i}}},actions:{nextStatus({commit:e}){e("status")},endCurrentCall({dispatch:e,getters:t}){t.accepted_room&&e("endCall",t.accepted_room)},endCall({dispatch:i,commit:r,getters:s},o){s.isAccepted&&(e.Call("Call Started Resumed before end"),i("resumeCall",o.room_id)),t.endCall({reason:"user_hangup",IamTheCaller:o.IamTheCaller,dontEndCallOnRoom:!1,room_id:o.room_id}),r("isCallWindowed",!1),i("stopMetrics"),i("stopFeatures",{room_id:o.room_id}),i("autoEndTimeoutOFF",{room_id:o.room_id}),i("notifSW",{action:"endCall",data:{room_id:o.room_id}})},endAllInvitations({getters:e,dispatch:i}){for(let r of e.invitations)t.endCall({reason:"user_hangup",IamTheCaller:!1,dontEndCallOnRoom:!1,room_id:r}),i("autoEndTimeoutOFF",{room_id:r}),i("notifSW",{action:"endCall",data:{room_id:r}})},endCallMissed({dispatch:e},{room_id:i,IamTheCaller:r}){t.endCall({reason:r?"callTimeout":"callMissed",IamTheCaller:r,dontEndCallOnRoom:r,room_id:i}),e("notifSW",{action:"endCall",data:{room_id:i}})},endCallFailure({dispatch:e},{room_id:i,reason:r,IamTheCaller:s}){t.endCall({reason:r,IamTheCaller:s,dontEndCallOnRoom:!1,room_id:i}),e("autoEndTimeoutOFF",{room_id:i}),e("notifSW",{action:"endCall",data:{room_id:i}})},acceptCall({commit:e,getters:i,dispatch:r},{room_id:s,type:o,noNotif:a}){e("room_accepted",s),r("autoEndTimeoutOFF",{room_id:s}),e("status","accepted"),e("invitation_del",s);o=o||i.room(s).type;t.acceptCall({room_id:s,type:o,asDelegateOf:i.asDelegateOf(s),simringWith:i.simringWith(s)}),r("getLocalMedia",{type:null,user_id:i.myself.user_id}).catch((e=>{r("alert_getLocalMediaError",e),r("endCallFailure",{room_id:s,IamTheCaller:!1,reason:e})})),a||r("notifSW",{action:"acceptCall",data:{room_id:s}})},inviteSent({commit:e,dispatch:t,getters:i},r){if(t("startFocusListener"),e("status","invited"),r.IamTheCaller=!0,e("sipState",r),e("hideConvFeatures",r&&r.call),e("room",r),e("user",i.myself),t("tracking",{action:"inviteSent"}),t("isRTCActivated"),r.calledUsers)for(let t of r.calledUsers)e("user",t);i.accepted_room||(e("activated",{kind:r.type}),t("autoEndTimeoutON",{room_id:r.room_id,IamTheCaller:!0}),t("noises",{action:"startRingbacktone"})),r.options&&r.options.featureData&&t("invited_feature",{type:r.type,room_id:r.room_id,featureData:r.options.featureData}),e("room_accepted",r.room_id),e("invitation",r.room_id),e("constraints",r),t("getLocalMedia",r).catch((e=>{t("alert_getLocalMediaError",e),t("endCallFailure",{room_id:r.room_id,IamTheCaller:!0,reason:e})})),r.options&&r.options.isPrivateConv&&e("isPrivateConv",!0),r.options&&r.options.dmId&&e("isSwymConv",r.options.dmId)},inviteReceived({commit:i,state:r,getters:s,dispatch:o},a){if(a.mediasoupOnly&&o("newMediasoupUser",{userId:a.user_id}),o("isRTCActivated"),a.options&&a.options.isPrivateConv&&i("isPrivateConv",!0),a.options&&a.options.dmId&&i("isSwymConv",a.options.dmId),a.youHaveToAccept){if(a.room_id!=r.room_id_accepted)return e.Call("Invitation protocol error : while on "+r.room_id_accepted+", received invitation from "+a.login+" on "+a.room_id);i("user",a.user),i("accepter",a.user_id),a.room_id==s.accepted_room.room_id&&a.calledUsers&&s.called_users.length!=a.calledUsers.length&&i("called_users",{users:a.calledUsers}),o("initP2P",a),i("polite",a),o("sendStream",a),t.acceptCall({user_id:a.user_id,room_id:a.room_id,type:"audio",autoAccept:!0})}else if(s.isAccepted)e.Call("Invitation protocol error "+JSON.stringify(a));else{i("sipState",a),i("hideConvFeatures",a&&a.call),!0!==localStorage.getItem(a.room_id)&&(o("noises",{action:"startRingtone"}),localStorage.setItem(a.room_id,!0)),i("user",s.myself);for(let e of a.calledUsers)i("user",e),e.id===s.myself.user_id&&e.asDelegateOf&&(i("user",e.asDelegateOf),a.asDelegateOf=e);a.simringWith=a.calledUsers.filter((e=>e.asDelegateOf&&(e.asDelegateOf.id===s.myself.user_id||e.asDelegateOf===a.asDelegateOf))),"screen"==a.type&&(a.type="audio"),i("room",a),i("invitation",a.room_id),i("constraints",a),i("status","invited"),o("autoEndTimeoutON",{room_id:a.room_id,IamTheCaller:!1}),o("startFocusListener"),o("notifSW",{action:"inviteReceived",data:a})}},accepted({commit:i,state:r,dispatch:s,getters:o},a){if(a.user_id==o.myself.user_id&&a.mediasoupOnly&&s("newMediasoupUser",{userId:a.user_id}),!r.rooms[a.room_id])return e.Call("error room unknown "+a.room_id);if(r.room_id_accepted!=a.room_id&&a.user_id!=o.myself.user_id)return e.Call("someone else accepted the call and I still don't");if(s("noises",{action:"stopTones"}),e.Call("Someone joined the call "+a.user.login),i("invitation_del",a.room_id),i("user",a.user),s("autoEndTimeoutOFF",{room_id:a.room_id}),a.user_id!=o.myself.user_id)i("sipState",o.room(a.room_id)),s("noises",{action:"userIn"}),s("initP2P",a),i("status","accepted"),i("accepter",a.user_id),s("sendCurrentFeature"),a.autoAccepted?(e.Call("Another accepter's p2p is ready, send my stream"),s("sendStream",a)):(e.Call("Another user joined, tell him to start p2p with me"),(!a.clientDevice||!a.clientDevice.callVersion||a.clientDevice.platform&&"ios"==a.clientDevice.platform.toLowerCase())&&i("polite",a),t.startCall({login:a.user.login,alreadyStarted:!0,room_id:a.room_id}),s("tracking",{login:a.user.login,action:"accepted"}));else if(a.room_id==r.room_id_accepted){e.Call("I accepted the call on current device, initP2P with the caller (mobile retrocompat), waiting for other users to start P2P");var n=o.accepted_room.user.user_id;i("accepter",n),s("initP2P",{...a,user_id:n})}else e.Call("I accepted the call on another device whereas I am in the room on current device"),o.invitations.length||i("status","initial"),s("notifSW",{action:"closeNotifRoomId",data:a})},cleanEverything({commit:e,dispatch:t,getters:i},r){r&&i.screensharer_id==i.myself.user_id&&t("watermarkedScreensharer",{room_id:r,active:!1,screensharer_id:null}),t("cleanAllP2P"),t("cleanTelephony"),e("status","ended"),e("resetUsersState"),e("resetP2PState"),t("resetMediasoup"),e("resetFeatureState"),e("resetCallState"),e("resetSettingsState"),t("resetCustomAlert",/reconnecting/i),r&&t("notifSW",{action:"endCall",data:{room_id:r}})},callEnded({commit:i,state:r,dispatch:s,getters:o},{room_id:a,user_id:n,login:d,reason:l}){var c=n==o.myself.user_id,u=o.room(a)&&o.room(a).user.user_id==n,m=o.room(a)&&o.room(a).IamTheCaller;return s("alert_callResumed"),s("tracking",{reason:l,login:d,action:"ended"}),s("noises",{action:"stopTones"}),localStorage.removeItem(a),a==r.room_id_accepted?(i("refuser",n),c?(e.Call("I left the call "+a),o.invitations.length>1?(i("room_accepted",null),i("invitation_del",a)):(s("stopTracking",{dontSendSwymReport:!1}),s("stopMetrics"),s("cleanEverything",a))):(s("noises",{action:"userOut"}),o.called_users.length-1==o.refusers.length||u&&!o.accepters.length&&!m?(e.Call("I am the last one of the call "+a+(u?" and the caller left ":"")),t.endCall({reason:"user_hangup",IamTheCaller:m,dontEndCallOnRoom:!1,room_id:a}),o.invitations.length>1?(i("room_accepted",null),i("invitation_del",a)):(s("stopTracking",{dontSendSwymReport:!1}),s("stopMetrics"),s("cleanEverything",a))):(s("cleanP2P",{room_id:a,user_id:n}),e.Call("Someone left the call "+a)))):(-1!=o.invitations.indexOf(a)&&(c||u?(e.Call((c?"I refused the invitation":"The caller stopped the invitation")+" on "+a),i("invitation_del",a),o.invitations.length||r.room_id_accepted||s("cleanEverything",a)):e.Call("Someone refused/left the call I am invited on "+a)),e.error("Received an unwanted endCall "+a))},volumeOFF({commit:e,getters:t,dispatch:i},r){e("volume",!r),t.isHoldtoneON&&i("noises",r?{action:"stopHoldtone"}:{action:"startHoldtone"})},holdCall({commit:i,getters:r,dispatch:s},o){e.Call("Call hold on "+o),s("alert_callOnHold"),i("hold",o),i("call_hold",{user_id:r.myself.user_id,onHold:!0}),t.callEventFromView({action:"hold",user_id:r.myself.user_id,onHold:!0,room_id:o,sip:r.sip}),s("volumeOFF",!0),s("muteTrack",{kind:"audio",room_id:o}),r.local_stream_info("video")&&s("muteTrack",{kind:"video",room_id:o}),r.local_stream_info("screen")&&"muted"!==r.local_stream_info("screen")&&s("stopTrack",{kind:"screen",room_id:o})},resumeCall({commit:i,getters:r,dispatch:s},o){e.Call("Call resumed on "+o),s("alert_callResumed"),i("resume",o),i("call_hold",{user_id:r.myself.user_id,onHold:!1}),t.callEventFromView({action:"hold",user_id:r.myself.user_id,onHold:!1,room_id:o,sip:r.sip}),s("volumeOFF",!1),s("activeTrack",{kind:"audio",room_id:o})},call_hold({commit:t,getters:i,dispatch:r},{room_id:s,user_id:o,onHold:a}){if(!i.user(o))return e.Call("User on hold doesn't exist.");if(t("call_hold",{user_id:o,onHold:a}),a){let e=i.accepters_except_myself.filter((e=>i.hasHoldCall(e)));i.accepters_except_myself.length===e.length&&(t("holdtoneON",!0),i.isVolumeOFF||i.sip||r("noises",{action:"startHoldtone"}))}else t("holdtoneON",!1),r("noises",{action:"stopHoldtone"})},callEvent({commit:t,getters:i,dispatch:r},{room_id:s,action:o,type:a,user_id:n,track_id:d,muted:l,onHold:c,data:u,featureData:m,featureMembers:p,featureInfo:h,featureId:g,user_id_to:f,p2pTentatives:v,actions:_,users:S,user:C,topic:b,logins:k,options:y,watermark_activated:w,reason:I}){if(!i.isAccepted&&"notCallable"!=o&&"alreadyOnCall"!=o)return e.Call("ignoring callEvent "+o);switch(o){case"mute":t("stream_muted",{kind:a,user_id:n,muted:l});break;case"hold":r("call_hold",{room_id:s,user_id:n,onHold:c});break;case"speaker":t("call_speaker",{user_id:n,speaker_track_id:d,kind:a}),!i.currentFeature&&t("speaker",{user_id:n,speaker_track_id:d,kind:a}),r("watermarkedScreensharer",{room_id:s,active:w,screensharer_id:n});break;case"feature":n!=i.myself.user_id&&(h.featureData.reload||h.featureData.update)?(h.featureData.reload&&r("reloadFeatures",{kind:h.kind,reload:h.featureData.reload}),t("feature",h)):r("received_feature",{user_id:n,room_id:s,featureInfo:h});break;case"confetti":r("received_confetti",{user_id:n,room_id:s,featureData:m,featureId:g});break;case"3DPlayData":r("received_3DPlay_data",{user_id:n,room_id:s,featureData:m,featureId:g,actions:_});break;case"masterChanged":r("masterChanged",{user_id:n,featureId:g});break;case"featureEnded":r("featureEnded",{user_id:n,featureId:g});break;case"featureMembers":r("featureMembers",{user_id:n,featureId:g,featureMembers:p});break;case"stopTrack":r("watermarkedScreensharer",{room_id:s,active:w,screensharer_id:n}),t("track_stopped",{user_id:n,track_id:d,kind:a});break;case"notCallable":for(let e in u.uncallableUsers)r("callEnded",{login:u.uncallableUsers[e].login,user_id:u.uncallableUsers[e].user_id,room_id:s,reason:"Busy"});r("alert_uncallableUsers",{calledUsers:u.callableLogins,uncallableUsers:u.uncallableUsers});break;case"alreadyOnCall":r("alert_alreadyOnCall");break;case"addUserToCall":r("addCalledUsers",{room_id:s,users:S,logins:k,options:y,topic:b,user_id:n});break;case"restartP2P":i.is_accepted_room(s)&&f==i.myself.user_id?r("restartP2P",{room_id:s,user_id:n,p2pTentatives:v}):e.Call("ignore callEvent restartP2P from "+n+" to "+f);break;case"p2pRestarted":i.is_accepted_room(s)&&f==i.myself.user_id?r("p2pRestarted",{room_id:s,user_id:n,p2pTentatives:v}):e.Call("ignore callEvent p2pRestarted from "+n+" to "+f);break;case"watermark":t("watermark",{room_id:s,active:w});break;case"maximize":r("maximize",{room_id:s});break;case"noMobileContentView":r("alert_mobileUsersCannotViewContent");break;case"reporting":"reconnect"==I&&r("alertReconnect",{user:C}),"restored"==I&&r("alertRestore",{user:C});break;default:e.Call("unknown callEvent "+o)}},received_track_video({commit:e,dispatch:t},{user_id:i,track_id:r}){e("received_track_video",{user_id:i,track_id:r}),t("tracking",{user_id:i,kind:"video",action:"stream"})},received_track_screen({commit:e,dispatch:t},{user_id:i}){e("received_track_screen",{user_id:i}),t("tracking",{user_id:i,kind:"screen",action:"stream"})},received_track_audio({commit:e,dispatch:t},{user_id:i,track_id:r}){e("received_track_audio",{user_id:i,track_id:r}),t("tracking",{user_id:i,kind:"audio",action:"stream"})},remove_track_screen({commit:e},{user_id:t}){e("remove_track_screen",{user_id:t})},remove_track_video({commit:e},{user_id:t}){e("remove_track_video",{user_id:t})},remove_track_audio({commit:e},{user_id:t}){e("remove_track_audio",{user_id:t})},local_stream_changed({commit:e,getters:t},i){i.isAudio&&e("received_track_audio",{user_id:t.myself.user_id,track_id:i.track_id_audio}),i.isVideo&&e("received_track_video",{user_id:t.myself.user_id,track_id:i.track_id_video}),i.isScreen?e("received_track_screen",{user_id:t.myself.user_id,track_id:i.track_id_screen}):(e("remove_track_screen",{user_id:t.myself.user_id}),e("track_stopped",{user_id:t.myself.user_id,track_id:i.track_id_screen,kind:"screen"})),e("local_stream_info",{kind:"audio",muted:i.isAudioMuted,loaded:i.isAudio,user_id:t.myself.user_id}),e("local_stream_info",{kind:"video",muted:i.isVideoMuted,loaded:i.isVideo,user_id:t.myself.user_id}),e("local_stream_info",{kind:"screen",muted:i.isScreenMuted,loaded:i.isScreen,user_id:t.myself.user_id})},autoEndTimeoutON({commit:e,getters:t,dispatch:i},{room_id:r,IamTheCaller:s}){t.room(r)&&!t.room(r).callMissed&&(e("timeout_started",{room_id:r}),t.room(r).callMissed=setTimeout((()=>{t.accepted_room_id!=r&&i("endCallMissed",{room_id:r,IamTheCaller:s})}),3e4))},autoEndTimeoutOFF({commit:e,getters:t},{room_id:i}){e("timeout_stopped",{room_id:i}),clearTimeout(t.room(i).callMissed)},offlineStartCall({dispatch:e},t){e("offlineStartCallTracking",t),e("alert_connexionLost")},isRTCActivated({commit:e,getters:t}){o.getInstance(t.tenant).checkRTCActivation().then((t=>{e("isRTCActivated",t)}))},watermarkedScreensharer({commit:e},{room_id:t,active:i,screensharer_id:r}){e("watermark",{room_id:t,active:i}),e("screensharer_id",r)},watermark({dispatch:e,getters:i},{room_id:r,active:s}){const o=s?i.myself.user_id:null;e("watermarkedScreensharer",{room_id:r,active:s,screensharer_id:o}),t.callEventFromView({action:"watermark",room_id:r,watermark_activated:s,user_id:o})},maximize({commit:e,dispatch:t},{room_id:i}){e("minimize",!1),t("track_event",{action:"topBar",dimensions:"minimize",eventValue:0})},minimize({commit:t,dispatch:i,getters:r}){r.accepted_room_id&&!r.windowRef?(t("minimize",!0),i("track_event",{action:"topBar",dimensions:"minimize",eventValue:1})):e.Call("No ongoing call to minimize")},addUserToCall({},{room_id:e,logins:i,options:r}){t.callEventFromView({action:"addUserToCall",room_id:e,logins:i,options:r})}}}})),define("DS/InstantMessagingCall/components/InvitationList/InvitationList",["text!DS/InstantMessagingCall/components/InvitationList/InvitationList.html","DS/InstantMessagingCall/components/InvitationItem/InvitationItem"],(function(e,t){"use strict";return{components:{"im-call-invitation-item":t},props:["rooms_id"],mounted(){this.$store.getters.isAccepted&&this.$store.getters.minimized&&this.repositionElement(),window.addEventListener("resize",this.repositionInviteOnResize)},destroyed(){window.removeEventListener("resize",this.repositionInviteOnResize)},updated(){(this.$store.getters.isInitial||this.$store.getters.isEnded)&&(this.destroyMask(),this.reinitPosition())},computed:{invitePosition(){return this.$store.getters.invitePosition}},methods:{repositionInviteOnResize(){const e=document.body,t=this.inviteListElement();if(t){const i=e.getBoundingClientRect(),r=t.getBoundingClientRect(),s=Math.max(i.left,Math.min(r.left,i.right-r.width)),o=Math.max(i.top,Math.min(r.top,i.bottom-r.height));t.style.left=s+"px",t.style.top=o+"px"}},inviteListElements(){const e=Array.from(document.querySelectorAll("#im-call-invitation-list"));return e&&e.length>0&&Array.from(e)},repositionElement(){const e=this.inviteListElements();this.invitePosition&&(this.invitePosition.top||this.invitePosition.left)&&e&&e.length>0&&e.forEach((e=>{e.style.top=this.invitePosition.top,e.style.left=this.invitePosition.left}))},inviteListElement(){return this.inviteListElements().filter((e=>"none"!=e.style.display))[0]},reinitPosition(){const e=this.inviteListElements();e&&e.length>0&&e.forEach((e=>{e.style.top=null,e.style.left=null}))},createMask(){document.querySelector(".im-call-invitation-mask")&&this.destroyMask(),this.inviteListElement().style.zIndex=5001,this.inviteListElement().firstElementChild.style.marginLeft=0;let e=window.getComputedStyle(document.body).getPropertyValue("grid-template-rows").split(" ")[0];e=e.includes("px")?e:"0px";const t=document.createElement("div");t.className="im-call-invitation-mask",t.style.top=e,t.style.width=document.body.offsetWidth+"px",t.style.height=document.body.offsetHeight-parseInt(e,10)+"px",document.body.appendChild(t)},destroyMask(){this.inviteListElement()&&(this.inviteListElement().style.zIndex=102);const e=document.querySelector(".im-call-invitation-mask");e&&e.remove()},drag(e){const t=this.inviteListElement();this.createMask();const i=e=>{if(e.type.includes("mouse"))return{x:e.clientX,y:e.clientY};if(e.type.includes("touch")){const t=e.touches[0];return{x:t.clientX,y:t.clientY}}};let r=i(e).x-t.getBoundingClientRect().left,s=i(e).y-t.getBoundingClientRect().top;const o=(e,i)=>{e-=r,i-=s;const o=document.querySelector(".im-call-invitation-mask");if(o){const r=o.getBoundingClientRect();e=Math.max(r.left,Math.min(e,r.right-t.getBoundingClientRect().width)),i=Math.max(r.top,Math.min(i,r.bottom-t.getBoundingClientRect().height)),t.style.left=e+"px",t.style.top=i+"px"}},a=e=>{o(i(e).x,i(e).y)},n=e=>{o(i(e).x,i(e).y)};o(i(e).x,i(e).y),document.addEventListener("mousemove",a),document.addEventListener("touchmove",n);const d=()=>{this.$store.commit("invitePosition",{top:t.style.top,left:t.style.left}),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d),document.removeEventListener("touchmove",n),document.removeEventListener("touchend",d),this.destroyMask()};document.addEventListener("mouseup",d),document.addEventListener("touchend",d),t.ondragstart=()=>!1}},template:e}})),define("DS/InstantMessagingCall/store/modules/tracker",["DS/RTProxyDriver/RTLogger","DS/Usage/TrackerAPI","DS/InstantMessagingCall/lib/RTCallingTracker"],(function(e,t,i){"use strict";const r={NotFoundError:"localMediaError_NotFoundError",SecurityError:"localMediaError_SecurityError",AbortError:"localMediaError_AbortError",NotAllowedError:"localMediaError_NotAllowedError",NotReadableError:"localMediaError_NotReadableError",OverConstrainedError:"localMediaError_OverConstrainedError",TypeError:"localMediaError_TypeError",TrackStartError:"localMediaError_NotReadableError",PermissionDeniedError:"localMediaError_NotAllowedError",InvalidStateError:"localMediaError_NotReadableError",DevicesNotFoundError:"localMediaError_NotFoundError",ConstraintNotSatisfiedError:"localMediaError_OverConstrainedError",MediaDeviceFailedDueToShutdown:"localMediaError_NotReadableError",MediaDeviceKillSwitchOn:"localMediaError_NotReadableError",InternalError:"localMediaError_NotReadableError",NotSupportedError:"localMediaError_TypeError"};return{state:{callTracker:null,date_start:0},getters:{callTracker:e=>e.callTracker},mutations:{newTracker(e,{logins:t,caller:r,swymUrl:s,type:o,dmId:a}){e.callTracker&&e.callTracker.destroy(),e.callTracker=new i({caller:r,logins:t,swymBaseUrl:s,type:o,dmId:a})},destroyTracker(e){e.callTracker&&e.callTracker.destroy(),e.callTracker=null}},actions:{offlineStartCallTracking({dispatch:e,getters:t},{logins:i,login:r,dmId:s}){e("startTracking",{logins:i||r,dmId:s}),e("tracking",{action:"ended",login:t.myself.login,reason:"offline"}),e("stopTracking",{dontSendSwymReport:!0})},startTracking({commit:e,getters:t},{logins:i,type:r,dmId:s}){if(!i&&!t.accepted_room)return console.error("Can not start Call Analytics without callees");e("newTracker",{caller:t.myself.login,logins:i||t.accepted_room.calledUsers,swymUrl:t.swymUrl,type:r,dmId:s})},stopTracking({getters:e,commit:t},{dontSendSwymReport:i}){e.callTracker&&e.callTracker.endCall(i),t("destroyTracker")},tracking({getters:t},{action:i,login:s,user_id:o,reason:a,kind:n}){if(!t.callTracker)return!0;if(!s&&o)s=t.user(o).login;switch(i){case"ended":t.callTracker.logEnded(s,a);break;case"getLocalMediaFailed":t.callTracker.logEnded(s,r[a]||a);break;case"stream":t.callTracker.logStream(s);break;case"inviteSent":t.callTracker.logInviteSent();break;case"accepted":t.callTracker.logAccepted(s);break;default:e.error("unknown tracking action "+i)}},track_event({getters:i},{action:r,eventValue:s,dimensions:o,values:a}){if(!r)return e.Call("track_event called without action");if(i.isDevEnv)return e.Call("track_event "+r+" bypassed");const n=i.myself.user_id,d=i.accepted_room&&i.accepted_room.room_id||[],l=i.accepted_room&&i.accepted_room.calledUsers||[],c=i.accepters||[],u=i.refusers||[],m=i.sip?"telephony":"webRTC";var p={appID:"X3DIMSG_AP",eventCategory:"collabexperience",eventAction:r,eventLabel:"3DMessaging collab event "+r,eventValue:"number"==typeof s?s:null,persDim:{pd1:n,pd2:d},persVal:{pv1:l.length,pv2:c.length,pv3:u.length},callback:t=>{e.Call("Analytics event sent. "+(t||""))}};if(o){var h=Object.keys(p.persDim).length;const e="string"==typeof o?[o]:o;for(let t of e)"string"==typeof t&&(7===h&&++h,p.persDim["pd"+ ++h]=t.toLowerCase())}if(p.persDim.pd8=m,a){var g=Object.keys(p.persVal).length;const e="number"==typeof a?[a]:a;for(let t of e)"number"==typeof t&&(p.persVal["pv"+ ++g]=t)}try{e.Call("Analytics event : "+JSON.stringify(p)),t.trackPageEvent(p)}catch(t){e.error("Analytics event request failed : "+t)}}}}})),define("DS/InstantMessagingCall/store/index",["vuejs","vuex","DS/InstantMessagingCall/store/modules/call","DS/InstantMessagingCall/store/modules/tracker","DS/InstantMessagingCall/store/modules/messages","DS/InstantMessagingCall/store/modules/noises","DS/InstantMessagingCall/store/modules/notifSW","DS/InstantMessagingCall/store/modules/feature","DS/InstantMessagingCall/store/modules/focus","DS/InstantMessagingCall/store/modules/usergroup","DS/InstantMessagingCall/store/modules/telephony","DS/InstantMessagingCall/store/modules/settings","DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders"],(function(e,t,i,r,s,o,a,n,d,l,c,u,m,p){"use strict";m.addLevel("CallNotif","darkblue");return new t.Store({state:{tenant:"GLOBAL",webrtcConfig:null,user_id_myself:null,login_myself:null,username_myself:null,appName:null,rtcUrl:null,swymUrl:null,isConnected:!1,clientDevice:null,isIOS:!1,isMac:!1,isDesktopApp:!1,isOpera:!1,backgroundImage:!0,clickOnVideo:!1,selfViewInUserList:!0,assets_url:void 0,max_p2pTentatives:15,socketIdentifier:"",isElectedSocket:!1},modules:{call:i,tracker:r,messages:s,noises:o,notifSW:a,Feature:n,focus:d,usergroup:l,Telephony:c,settings:u},getters:{rtcUrl:e=>e.rtcUrl,swymUrl:e=>e.swymUrl,tenant:e=>e.tenant,myself:e=>({user_id:e.user_id_myself,login:e.login_myself,username:e.username_myself}),isConnected:e=>e.isConnected,isIOS:e=>e.isIOS,isMac:e=>e.isMac,isDesktopApp:e=>e.isDesktopApp,isOpera:e=>e.isOpera,isDevEnv:e=>"devenv"==e.appName,selfViewInUserList:e=>e.selfViewInUserList,assets_url:e=>e.assets_url,backgroundImage:e=>e.backgroundImage,clickOnVideo:e=>e.clickOnVideo,isMobile:e=>e.isMobile,socketIdentifier:e=>e.socketIdentifier,isElectedSocket:e=>e.isElectedSocket},mutations:{tenant(e,t){e.tenant=t},user_id_myself(e,t){e.user_id_myself=t},login_myself(e,t){e.login_myself=t},username_myself(e,t){e.username_myself=t},webrtcConfig(e,t){e.webrtcConfig=t},appName(e,t){e.appName=t,"devenv"!=e.appName&&"3dprint"!=e.appName&&"ElectronCallWebview"!=e.appName||(e.call.timelineAvailable=!1),"devenv"==e.appName&&(e.call.confettiAvailable=!0),e.assets_url="devenv"==e.appName?"../../../InstantMessaging/InstantMessagingCall.mweb/src/assets/":window.dsDefaultWebappsBaseUrl+"InstantMessagingCall/assets/"},swymUrl(e,t){e.swymUrl=t},rtcUrl(e,t){e.rtcUrl=t},isConnected(e,t){e.isConnected=t},clientDevice(e,t){e.clientDevice=t},isIOS(e,t){e.isIOS=t},isMac(e,t){e.isMac=t},isDesktopApp:(e,t)=>{e.isDesktopApp=t},isOpera(e,t){e.isOpera=t},selfViewInUserList(e,t){e.selfViewInUserList=t},isMobile(e,t){e.isMobile=t},isElectedSocket(e,t){e.isElectedSocket=t}},actions:{connected({getters:e,commit:t,dispatch:i},{clientDevice:r,tenant:s,user_id_myself:o,login_myself:a,username_myself:n,appName:d}){i("alert_connexionRetrieved"),t("isConnected",!0),r&&i("clientDevice",r),s&&t("tenant",s),o&&t("user_id_myself",o),a&&t("login_myself",a),n&&t("username_myself",n),d&&t("appName",d),window&&-1!==window.navigator.userAgent.indexOf("OPR")&&t("isOpera",!0),window&&window.ds&&"MOBILE"==window.ds.env&&t("isMobile",!0),(window&&window.ds&&"MOBILE"===window.ds.env||window&&window.top&&window.top.ds&&"MOBILE"===window.top.ds.env)&&t("isDesktopApp",!0),i("notifSW",{action:"initSW"})},disconnected({commit:e}){e("isConnected",!1)},clientDevice({commit:e},t){e("clientDevice",t),void 0===t.ScreenSharingCompatible||t.ScreenSharingCompatible||e("screenSharingAvailable",!1),void 0!==t.isIOS&&e("isIOS",t.isIOS),void 0!==t.isMac&&e("isMac",t.isMac)},socketIdentifier(e,t){const{socketIdentifier:i}=t;e.socketIdentifier=i,p.ToNotif({action:"socketIdentifier",socketIdentifier:i})},isElectedSocket({getters:e,commit:t},i){const{isElected:r}=i;t("isElectedSocket",e.isDesktopApp||r),p.ToNotif({action:"isElectedSocket",isElectedSocket:e.isDesktopApp||r})}}})})),define("DS/InstantMessagingCall/components/UserList/UserList",["text!DS/InstantMessagingCall/components/UserList/UserList.html","DS/InstantMessagingCall/components/UserItem/UserItem","DS/InstantMessagingCall/components/SelfView/SelfView","DS/UIKIT/Scroller"],(function(e,t,i,r){"use strict";return{data:()=>({startIndex:0}),components:{"im-call-user-item":t,"im-call-self":i},props:["hasSpeaker","showSelfView","minimized"],computed:{users(){return this.$store.getters.accepters},isScrollable(){return this.users&&this.users.length>6},isScrollableUp(){return this.isScrollable&&this.startIndex>0},isScrollableDown(){return this.isScrollable&&this.startIndex<this.users.length-6},isLightboxMinimized(){return this.sizeWH(),this.minimized}},methods:{scrollUp(){this.startIndex=0>this.startIndex-6?0:this.startIndex-6},scrollDown(){this.startIndex=this.users.length-6<this.startIndex+6?this.users.length-6:this.startIndex+6},canBeShown(e){return this.startIndex<=e&&e<this.startIndex+6},minimize(){this.$store.commit("showUserList",!1)},getUserItemsContainer(){const e=this.$store.getters.windowRef;if(e)return e.document.getElementById("im-call-user-list-container");const t=this.$refs["useritems-container"];return t||void 0},sizeWH(){var e=this.getUserItemsContainer();if(e){var t,i,r,s,o,a,n=e.offsetHeight,d=e.offsetWidth,l=e.childElementCount;if(this.hasSpeaker)i=1,s=d,a=r=(n-88)/(t=6),o=r*(16/9);else{switch(!0){case 1==l:i=1,t=1;break;case 2==l:i=2,t=1;break;case l<4||4==l:i=2,t=2;break;case l<6||6==l:i=3,t=2;break;case l<9||9==l:t=3,i=3;break;case l<12||12==l:i=4,t=3;break;case l<16||16==l:t=4,i=4}a=(o=(s=d/i)/(16/9)>(r=n/t)?r*(16/9):s)/(16/9)}for(var c=0;c<e.children.length;c++)e.children[c].style.height=a-5+"px",e.children[c].style.width=o-5+"px"}},usernameStyleDisplay(){const e=document.querySelectorAll("#im-call-user-list-container .im-call-user-item:not(.speaker) > .username"),t=document.querySelector("#im-call-user-list-container #im-call-self > .username"),i=e&&Array.from(e)||[];t&&i.push(t),i.forEach((e=>{if(e)if("none"==e.parentElement.style.display){e.parentElement.style.display="flex";const t=e.parentElement.parentElement.querySelectorAll(".im-call-user-item:not(.speaker)")[1];t&&(e.scrollWidth>t.querySelector(".username").scrollWidth?e.style.display="inline":e.style.display="flex"),e.parentElement.style.display="none"}else{const t=e.parentElement;t&&(e.scrollWidth>t.scrollWidth?e.style.display="inline":e.style.display="flex")}}))}},updated(){this.sizeWH(),this.usernameStyleDisplay()},created(){window.addEventListener("resize",this.sizeWH)},destroyed(){window.removeEventListener("resize",this.sizeWH)},watch:{"$store.getters.windowRef":function(e,t){!t&&e&&(this.sizeWH(),e.addEventListener("resize",this.sizeWH)),t&&!e&&t.removeEventListener("resize",this.sizeWH)}},template:e}})),define("DS/InstantMessagingCall/api/desktop/watchers",["DS/InstantMessagingCall/store/index","DS/PlatformAPI/PlatformAPI"],(function(e,t){"use strict";const i=["invitation","invitation_del","room_accepted","status","minimize"],r=["inviteReceived","inviteSent","accepted","callEnded","cleanEverything"];var s;return{init:function(t){this.unsubscribe=e.subscribe(this.mutationsOccured,{prepend:!0}),this.unsubscribeAction=e.subscribeAction(this.actionsOccured,{prepend:!0}),s=t},destroy:function(){this.unsubscribe(),this.unsubscribeAction()},actionsOccured:function(e,i){-1!=r.indexOf(e.type)&&(console.log("To Electron : "+JSON.stringify(e)),t.publish(s,{data:e,state:{}}))},mutationsOccured:function(e,r){-1!=i.indexOf(e.type)&&(console.log("To Electron : "+JSON.stringify(e)),t.publish(s,e))}}})),define("DS/InstantMessagingCall/api/listeners_server",["DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/senders"],(function(e,t){"use strict";const i=function(e){return Object.assign({},e||{},{room_id:e&&(e.room_id||e.room&&e.room.room_id||e.data&&e.data.room_id),user_id:e&&(e.user_id||e.user&&e.user.user_id),login:e&&(e.login||e.user&&e.user.login)})},r=["inviteSent","inviteReceived","callEnded","webrtcIceCandidate","SDP","callEvent","disconnected","connectTelWS","routerRtpCapabilities","webrtcTransportCreated","gotNewProducer","consumerCreated","consumerClosed","consumerPaused","consumerResumed","newMediasoupUser","mediasoupUserLeft"],s={base_url:null,connected(t={}){this.base_url=t.options.url,e.dispatch("connected",{clientDevice:t.clientDevice,devEnv:t.options.devEnv,tenant:t.options.platformId,user_id_myself:t.user_id,login_myself:t.userId,username_myself:t.username,appName:t.appName})},callAccepted(t){e.commit("webrtcConfig",function(e,t){if(e.webrtcConfig&&e.webrtcConfig.iceServers)for(var i=0;i<e.webrtcConfig.iceServers.length;i++)e.webrtcConfig.iceServers[i].urls=e.webrtcConfig.iceServers[i].url.replace("REPLACEMEWITHRTCDNS:3478",t+"/coturn"),e.webrtcConfig.iceServers[i].url=e.webrtcConfig.iceServers[i].url.replace("REPLACEMEWITHRTCDNS:3478",t+"/coturn");return e.webrtcConfig}(t,this.base_url)),e.commit("forceTURN",t.forceTURN),e.dispatch("accepted",i(t))},setStrategy(t){e.dispatch("setStrategy",t)},search(t){const i={};t.forEach((e=>{i[e.userId]=e})),e.dispatch("search",i)},getSocketIdentifier(t){e.dispatch("socketIdentifier",t)},isElectedSocket(t){e.dispatch("isElectedSocket",t)},getBlockPopup(e){},minimizeCollab(){e.dispatch("minimize")}};for(let t of r)s[t]=function(t){return function(r){e.dispatch(t,i(r))}}(t);return s})),define("DS/InstantMessagingCall/api/listeners_papi",["DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/senders"],(function(e,t){"use strict";const i={CONNECTED(t){e.dispatch("connected",{clientDevice:t.data.clientDevice,tenant:t.data.data.tenant,user_id_myself:t.data.user_id,login_myself:t.data.userId,username_myself:t.data.username,appName:t.data.appName})},startCall:i=>e.getters.isConnected?"screen"!=i.type||e.getters.screenSharingAvailable?(i.isJoinable||e.dispatch("startTracking",{logins:i.logins||i.login||i.phone,type:i.sip?"telephony":i.type,dmId:i.dmId}),e.dispatch("track_event",{action:i.isJoinable?"joinCall":"startCall",dimensions:[i.sip?"telephony":i.type,i.dmId||i.orderId],eventValue:(i.logins||[i.login]).length}),void t.startCall({login:i.login,logins:i.logins,username:i.username,type:i.type,rtconvEnable:i.rtconvEnable||!(!i.options||!i.options.rtconvEnable),options:{sip:i.sip||i.options&&i.options.sip,uri:i.uri||i.phone,orderId:i.orderId,topic:i.topic,callId:i.callId,dmId:i.subjectUri||i.dmId,dbConvId:i.subjectUri?i.dmId:i.dbConvId,swymUrl:i.swymUrl||i.options&&i.options.swymUrl,featureData:i.data}})):e.dispatch("alert_browserNotCompatible"):e.dispatch("offlineStartCall",i),getSocketIdentifier(){t.ToNotif({action:"socketIdentifier",socketIdentifier:e.getters.socketIdentifier})},getIsElectedSocket(){t.ToNotif({action:"isElectedSocket",isElectedSocket:e.getters.isDesktopApp||e.getters.isElectedSocket})}};return e=>{if(e.evenement&&i[e.evenement]||e.action&&i[e.action])return i[e.evenement||e.action](e)}})),define("DS/InstantMessagingCall/components/LightboxContent/LightboxContent",["text!DS/InstantMessagingCall/components/LightboxContent/LightboxContent.html","DS/InstantMessagingCall/components/ActionBar/ActionBar","DS/InstantMessagingCall/components/UserList/UserList","DS/InstantMessagingCall/components/SelfView/SelfView","DS/InstantMessagingCall/components/UserItem/UserItem","DS/InstantMessagingCall/components/SpeakerName/SpeakerName","DS/InstantMessagingCall/components/Collab/Collab","DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem","DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize","DS/InstantMessagingCall/components/PanelUsers/PanelUsers","DS/RTConvAPI/drivers/Swym_driver","DS/InstantMessagingCall/components/SettingsModal/SettingsModal"],(function(e,t,i,r,s,o,a,n,d,l,c,u){"use strict";return{components:{"im-call-bar":t,"im-call-user-list":i,"im-call-self":r,"im-call-user-item":s,"im-call-speaker-name":o,"im-call-collaboration":a,"im-call-bar-item":n,"im-call-video-minimize":d,"im-call-panel-users":l,"im-call-settings-modal":u},props:["room","isRightPanel","showUserList","userlist_at_top","showSelfView","backgroundImage","minimized"],data:function(){return{timeoutInterval:null,secondsLeftBeforeTimeout:0,timeoutMessageVisible:!1,swymDriver:c.getInstance(this.$store.getters.tenant)}},computed:{login_myself(){return this.$store.getters.myself.login},logins(){return this.$store.getters.accepters_logins_except_myself},speaker_id(){return this.$store.getters.speaker_id},feature_id(){return this.$store.getters.currentFeatureId},feature(){return!!this.feature_id&&this.$store.getters.feature(this.feature_id)},isODE(){return!!this.feature&&this.$store.getters.isODE(this.feature)},is3DPlay(){return!!this.feature&&this.$store.getters.is3DPlay(this.feature)},isWhiteboard(){return!!this.feature&&this.$store.getters.isWhiteboard(this.feature)},isConfetti(){return!!this.feature&&this.$store.getters.isConfetti(this.feature)},hasFeature(){return!!this.feature_id},hasSpeaker(){return!!this.speaker_id||!!this.feature_id},speaker_track_id(){return this.$store.getters.speaker_track_id},displayActionBar(){return this.$store.getters.displayActionBar},isDialerON(){return!!this.$store.getters.showDialer},isTelephonySupported(){return this.$store.getters.telephonyFeature}},methods:{toggleActionBar(){this.displayActionBar?this.$store.commit("closeActionBar"):this.$store.commit("openActionBar")},displaySelfView(){this.$store.commit("showSelfView"),this.$store.getters.selfViewInUserList&&this.displayUserList()},displayUserList(){this.$store.commit("showUserList",!0)},sendNbr(e){console.log("DIALER ",e)}},template:e}})),define("DS/InstantMessagingCall/components/MemberList/MemberList",["text!DS/InstantMessagingCall/components/MemberList/MemberList.html","DS/InstantMessagingCall/components/MemberItem/MemberItem"],(function(e,t){"use strict";return{props:["members"],components:{"im-call-member-item":t},computed:{},methods:{},template:e}})),define("DS/InstantMessagingCall/api/desktop/listeners_papi",["DS/InstantMessagingCall/store/index"],(function(e){"use strict";const t={},i=["setPresence","endCurrentCall","endCall","acceptCall"],r=["showInvite","hideInvite","minimize"];for(let i of r)t[i]=t=>{e.commit(i,t)};for(let r of i)t[r]=t=>{e.dispatch(r,t)};return e=>{if(e.evenement&&t[e.evenement]||e.action&&t[e.action])return console.log("From Electron : "+JSON.stringify(e)),t[e.evenement||e.action](e&&e.data)}})),define("DS/InstantMessagingCall/components/PanelMembers/PanelMembers",["text!DS/InstantMessagingCall/components/PanelMembers/PanelMembers.html","DS/InstantMessagingCall/components/MemberList/MemberList"],(function(e,t){"use strict";return{components:{"im-call-member-list":t},computed:{called_users(){return this.$store.getters.called_users}},template:e}})),define("DS/InstantMessagingCall/api/desktop/interface",["DS/InstantMessagingCall/api/desktop/listeners_papi","DS/InstantMessagingCall/api/desktop/watchers","DS/PlatformAPI/PlatformAPI"],(function(e,t,i){"use strict";return{init:function(r){return i.subscribe("fromDesktopApp.ds.com",e),t.init("toDesktopApp.ds.com"),this}}})),define("DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox",["text!DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox.html","DS/InstantMessagingCall/components/LightboxContent/LightboxContent","DS/InstantMessagingCall/components/PanelMembers/PanelMembers","DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline","DS/InstantMessagingCall/components/CustomType/CustomType"],(function(e,t,i,r,s){"use strict";return{components:{"im-call-content":t,"im-call-members":i,"im-call-timeline":r,"im-call-type":s},data(){const e=window.ds&&"MOBILE"===window.ds.env||window.top&&window.top.ds&&"MOBILE"===window.top.ds.env;return{currentListPosition:"right",previousPanel:null,currentPanelComponent:null,sideActions:[{name:"minimize",fonticon:"resize-small",label:this.$store.getters.nls("minimize"),hidden:!1},...e?[]:[{name:"new_window",fonticon:"open-in-a-new-window",label:this.$store.getters.nls("newWindowCall"),hidden:!1}]],panel:{name:"right",show:!!this.currentPanel,fonticon:"users",showClose:!0,title:null}}},mounted(){const e=this.isStandAloneCollabEnabled,t=this.isStandAloneCollabForAppEnabled,i=this.isWindowed,r=this.isDesktopApp;this.sideActions=[...i&&(r&&t||e)?[]:[{name:"minimize",fonticon:"resize-small",label:this.$store.getters.nls("minimize"),hidden:!1}],...r?[]:e?[{name:"new_window",fonticon:"open-in-a-new-window",label:this.$store.getters.nls("newWindowCall"),hidden:!1}]:[]]},computed:{actions(){return{display_action_bar:{name:"display_action_bar",fonticon:"bottom-panel",label:this.$store.getters.nls("displayActionBar"),hidden:!0},members:{name:"members",fonticon:"users",label:this.$store.getters.nls("members")},timeline:{name:"timeline",fonticon:"chat-alt",label:this.$store.getters.nls("timeline"),hidden:!this.$store.getters.timelineAvailable},list_at_top:{name:"list_at_top",fonticon:"table-row-column",label:this.$store.getters.nls("displayListTop"),hidden:!0,isUserListAction:!0},list_at_right:{name:"list_at_right",fonticon:"table-row-column",label:this.$store.getters.nls("displayListRight"),hidden:!0,isUserListAction:!0},add_list:{name:"add_list",fonticon:"table-column-add ",label:this.$store.getters.nls("addList"),hidden:!0,isUserListAction:!0},remove_list:{name:"remove_list",fonticon:"table-column-delete",label:this.$store.getters.nls("removeList"),hidden:!0,isUserListAction:!0},remove_list_from_top:{name:"remove_list",fonticon:"table-row-delete",label:this.$store.getters.nls("removeListTop"),hidden:!0,isUserListAction:!0},add_list_at_top:{name:"add_list_at_top",fonticon:"table-row-add",label:this.$store.getters.nls("addListTop"),hidden:!0,isUserListAction:!0}}},hasSpeaker(){var e=!!this.$store.getters.speaker_id;return e||this.displayUserList(),e},backgroundImage(){return this.$store.getters.backgroundImage},actions_array(){var e=[];for(let t in this.actions)e.push(this.actions[t]);return e},room(){return this.$store.getters.accepted_room},showUserList(){return this.$store.getters.showUserList},showSelfView(){return this.$store.getters.showSelfView},labelArray(){if(this.room&&this.$store.getters.roomName(this.room))return[this.$store.getters.roomName(this.room)];var e=this.room&&this.$store.getters.called_users_name(this.room.room_id)||this.$store.getters.accepters_name;if(this.$store.getters.isPrivateConv&&e.includes(this.$store.getters.myself.username)){var t=e.slice(0),i=e.indexOf(this.$store.getters.myself.username);return t.splice(i,1),t}return e},displayActionBar(){return this.$store.getters.displayActionBar},minimized(){return this.$store.getters.minimized},logins(){return this.$store.getters.logins_except_myself},isWindowed(){return this.$store.getters.isCallWindowed},isWindowOpened(){return!!this.$store.getters.windowRef},isStandAloneCollabEnabled(){return this.$store.getters.standAloneCollabFeature},isStandAloneCollabForAppEnabled(){return this.$store.getters.standAloneCollabForAppFeature},isDesktopApp:()=>window.ds&&"MOBILE"===window.ds.env||window.top&&window.top.ds&&"MOBILE"===window.top.ds.env,currentPanel(){var e=this.$store.getters.currentPanel;return e?(this.previousPanel&&e!=this.previousPanel&&(this.actions[this.previousPanel].selected=!1),this.actions[e].selected=!0,this.previousPanel=e,this.panel.show=!0,this.panel.title=this.$store.getters.nls(e),this.currentPanelComponent="im-call-"+e):(this.panel.show=!1,this.currentPanelComponent=null,this.previousPanel&&(this.actions[this.previousPanel].selected=!1),this.previousPanel=null),e}},methods:{endCall(){this.$store.getters.local_stream_info("screen")&&this.$store.dispatch("stopTrack",{kind:"screen",room_id:this.room.room_id}),this.room&&this.$store.dispatch("endCall",this.room),this.isWindowOpened&&(this.$store.getters.windowRef&&this.$store.getters.windowRef.close(),this.$store.commit("windowRef",null)),this.track_event("close")},confirmEndCall(){return this.isWindowOpened?this.$confirm(this.$store.getters.nls("confirmEndCall"),this.$store.getters.nls("refuseCall"),{okLabel:this.$store.getters.nls("confirm"),cancelLabel:this.$store.getters.nls("cancel"),target:this.$store.getters.windowRef.document.body}):this.$confirm(this.$store.getters.nls("confirmEndCall"),this.$store.getters.nls("refuseCall"),{okLabel:this.$store.getters.nls("confirm"),cancelLabel:this.$store.getters.nls("cancel")})},beforeWindowUnload(e){this.$store.getters.isInitial||this.$store.getters.isEnded||(e.preventDefault(),e.returnValue="")},closePanel(){this.$store.commit("currentPanel",null)},togglePanel(e){var t=e==this.previousPanel?null:e;this.$store.commit("currentPanel",t),t&&this.track_event(["togglePanel",e],1)},removeUserListAction(){for(let e in this.actions)this.actions[e].isUserListAction&&(this.actions[e].hidden=!0);return!0},addUserListAction(e){return this.removeUserListAction(),this.actions[e].hidden=!1,!0},userListAction(e){switch(e){case"add_list_at_top":this.displayUserList(),this.currentListPosition="top";break;case"remove_list":case"remove_list_from_top":this.hideUserList(),this.currentListPosition="hidden";break;case"add_list":this.displayUserList(),this.currentListPosition="right";break;case"list_at_top":this.currentListPosition="top";break;default:this.removeUserListAction(),this.displayUserList()}},hideUserList(){this.$store.commit("showUserList",!1)},displayUserList(){this.$store.commit("showUserList",!0)},chooseUserAction(e){e?this.showUserList?this.currentPanel?"right"==this.currentListPosition&&this.addUserListAction("remove_list")||this.addUserListAction("remove_list_from_top"):"right"==this.currentListPosition||"hidden"==this.currentListPosition?this.addUserListAction("list_at_top"):this.addUserListAction("remove_list_from_top"):!this.currentPanel&&this.addUserListAction("add_list")||this.addUserListAction("add_list_at_top"):this.removeUserListAction()},openActionBar(){this.$store.commit("openActionBar")},minimize(e){this.$store.commit("minimize",e),this.track_event("minimize",1)},exportCallToNewWindow(){const e=!this.isWindowed;this.$store.commit("isCallWindowed",e)},track_event(e,t){this.$store.dispatch("track_event",{action:"topBar",dimensions:e,eventValue:t})}},created(){window.addEventListener("beforeunload",this.beforeWindowUnload)},beforeDestroy(){window.removeEventListener("beforeunload",this.beforeWindowUnload)},template:e}})),define("DS/InstantMessagingCall/api/interface",["DS/RTProxyDriver/RTProxyDriver","DS/InstantMessagingCall/api/listeners_server","DS/InstantMessagingCall/api/listeners_papi","DS/InstantMessagingCall/api/senders","DS/PlatformAPI/PlatformAPI","DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/desktop/interface"],(function(e,t,i,r,s,o,a){"use strict";return{audiovideoV2:!1,init:function(r){return this.audiovideoV2=r.audiovideoV2,this.PlatformAPI=s,t.base_url=r.base_url,e.addEvent("CONNECTED",t.connected),e.addEvent("DISCONNECTED",t.disconnected),e.addEvent("inviteSent",t.inviteSent),e.addEvent("inviteToCall",t.inviteReceived),e.addEvent("callAccepted",t.callAccepted),e.addEvent("callEnded",t.callEnded),e.addEvent("webrtcIceCandidateReceived",t.webrtcIceCandidate),e.addEvent("SDPreceived",t.SDP),e.addEvent("callEvent",t.callEvent),e.addEvent("connectTelWS",t.connectTelWS),e.addEvent("getSocketIdentifier",t.getSocketIdentifier),e.addEvent("isElectedSocket",t.isElectedSocket),e.addEvent("setStrategy",t.setStrategy),e.addEvent(e.eventName.RESULTOFSEARCH,t.search),e.addEvent("minimizeCollab",t.minimizeCollab),e.addEvent("routerRtpCapabilities",t.routerRtpCapabilities),e.addEvent("webrtcTransportCreated",t.webrtcTransportCreated),e.addEvent("gotNewProducer",t.gotNewProducer),e.addEvent("consumerCreated",t.consumerCreated),e.addEvent("consumerClosed",t.consumerClosed),e.addEvent("consumerPaused",t.consumerPaused),e.addEvent("consumerResumed",t.consumerResumed),e.addEvent("newMediasoupUser",t.newMediasoupUser),e.addEvent("mediasoupUserLeft",t.mediasoupUserLeft),s.subscribe("towidgetim.ds.com",i),s.subscribe("im.ds.com",i),(o.getters.isDesktopApp||o.getters.isDevEnv)&&a.init(),s.publish("fromwidgetim.ds.com",{evenement:"GETLOGINOKDATA"}),this}}})),define("DS/InstantMessagingCall/components/Base/Base",["text!DS/InstantMessagingCall/components/Base/Base.html","DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox","DS/InstantMessagingCall/components/InvitationList/InvitationList","DS/InstantMessagingCall/lib/VueTeleport/VueTeleport","DS/InstantMessagingCall/lib/WindowBar/WindowBar"],(function(e,t,i,r,s){"use strict";return{components:{"im-call-base-lightbox":t,"im-call-base-invite":i,"im-call-windowed-call":r,"im-window-bar":s},data:()=>({showConfirmEndCall:!1}),computed:{bodyAlerts(){return this.$store.getters.bodyAlerts},isEnded(){return this.$store.getters.isEnded},isInvited(){return this.$store.getters.isInvited},isAccepted(){return this.$store.getters.isAccepted},showInvite(){return this.$store.getters.showInvite},currentBaseComponent(){return this.isAccepted&&(this.$store.getters.minimized?"im-call-base-minimized":"im-call-base-lightbox")||this.isInvited&&"im-call-base-invite"},isStandAloneCollabForAppEnabled(){return this.$store.getters.standAloneCollabForAppFeature}},watch:{isAccepted(e){if(e){(window.ds&&"MOBILE"===window.ds.env||window.top&&window.top.ds&&"MOBILE"===window.top.ds.env)&&this.isStandAloneCollabForAppEnabled&&this.$store.commit("isCallWindowed",!0),setTimeout((()=>{this.$store.dispatch("setSpeaker")}),500)}}},methods:{closeModal(){this.$refs.lightboxComponent.endCall()},showConfirmModal(){this.showConfirmEndCall=!0},hideConfrimModal(){this.showConfirmEndCall=!1},confirmHangup(){this.$refs.lightboxComponent&&this.$refs.lightboxComponent.endCall()}},template:e}})),define("DS/InstantMessagingCall/main",["DS/RTProxyDriver/RTLogger","vuejs","DS/InstantMessagingCall/components/Base/Base","DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/interface","css!DS/InstantMessagingCall/InstantMessagingCall.css"],(function(e,t,i,r,s){"use strict";e.addLevel("Call","purple"),e.Call("InstantMessagingCall load 03/2025 25xFD02 service 3.11.5");const o={divID:"vue-im-call",addDiv:function(t){return document.getElementById(this.divID)?e.Call("InstantMessagingCall div already injected"):t?(this.divCall=document.createElement("div"),this.divCall.id=this.divID,void t.appendChild(this.divCall)):e.Call("InstantMessagingCall needs a div container")},initVm:function(s={}){if(this.vmCall)return e.Call("InstantMessagingCall initVm already done");this.vmCall=new t({el:"#"+this.divID,data:()=>s,components:{"im-call-base":i},store:r,template:"<im-call-base id="+this.divID+" />"})},initTransport:function(e){this.interface=s.init(e)},initStore:function(e){r.commit("tenant",e.platformId),r.commit("appName",e.appName),r.commit("swymUrl",e.swymUrl),r.dispatch("preloadNoises"),r.dispatch("getCollaborationFeatures")},initMediaDevices:function(e){addEventListener("devicechange",(e=>{r.dispatch("enumerateDevices")})),r.dispatch("enumerateDevices")}};return{init:function(e){return o.initStore(e),o.addDiv(e.callContainer||document.body),o.initVm(e),o.initTransport(e),o.initMediaDevices(),document.IMCall=document.IMCall||o,document.IMCall}}}));