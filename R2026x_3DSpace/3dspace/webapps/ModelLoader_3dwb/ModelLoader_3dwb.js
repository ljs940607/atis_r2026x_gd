define("DS/ModelLoader_3dwb/loader",["UWA/Core","DS/Plugins/UserRenderList","DS/ZipJS/zip","DS/Visualization/SceneGraphFactory","DS/CAT3DWVisu/CAT3DWThreeJsExtender","DS/CAT3DWVisu/CAT3DWNode3DHyperlink","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CAT3DSKExperience/CAT3DSKAnnotationAbbreviationsExperience","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/Usage/TrackerAPI","DS/Visualization/MaterialApplication","DS/CAT3DWVideosUI/CAT3DWVideosController","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/CAT3DWInfraUI/CAT3DWHandleErrors","DS/SVGLoader/SVGLineMaterial","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/Mesh/MeshUtils","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices","DS/CAT3DWInfra/CAT3DWUrlServices","DS/WebappsUtils/WebappsUtils","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfra/CAT3DWFileServices","DS/CAT3DWRichLinksUI/CAT3DWLinkProcessingUtils","DS/CAT3DWText/CAT3DWTextCommonConstants","DS/CAT3DWText/CAT3DWTextRenderService","DS/CAT3DWVisu/CAT3DWGeomFactory","DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView","DS/CAT3DWInfraUI/CAT3DWDataModelConverter","DS/CAT3DWInfraUI/CAT3DWCanvasServices","DS/CAT3DWInfraUI/CAT3DWCanvasLimits","DS/ControlsEx/LoadingPanel","DS/CATCreaDesWebUIServices/CATCrDWebUIServices","DS/Visualization/PolygonTessellator","UWA/Utils/Client","DS/Utilities/Color","css!DS/UIKIT/UIKIT"],(function(e,t,i,n,o,r,a,s,l,c,d,h,p,m,u,f,g,w,_,v,x,D,y,C,M,V,b,P,T,S,A,I,k,R,E,N,L,U,W){"use strict";return e.Class.extend({init:function(t){this._parent(t),this._3dMediaCounter=0,this._2dMediaCounter=0,this._videoController=new m,this._mapVid=new Map,this._placeHolderMap=new Map;const i=(e,t)=>{this._viewer.div&&t.viewerDiv?t.viewerDiv===this._viewer.div&&e():e()};this._onStartExperience=f.subscribe({event:"CAT3DSKExperienceStart"},i.bind(this,this.startExperience.bind(this))),this._onStopExperience=f.subscribe({event:"CAT3DSKExperienceStop"},i.bind(this,this.stopExperience.bind(this))),this._onExitExperience=f.subscribe({event:"CAT3DSKExperienceExit"},i.bind(this,this.dispose.bind(this))),this._onMuteAllVideos=f.subscribe({event:"CAT3DSKExperienceMuteVideos"},i.bind(this,this.muteAllVideos.bind(this))),this._onUnmuteAllVideos=f.subscribe({event:"CAT3DSKExperienceUnmuteVideos"},i.bind(this,this.unmuteAllVideos.bind(this))),this._isMobileApp=!1,window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(this._isMobileApp=!0,M.setPreferenceValue("M3DEMobile",!0)),this._placeholderUrl=C.getWebappsAssetUrl("CAT3DWInfra","placeholders/xl_thumb_waiting_processing.png"),this._isMobileApp&&(this._placeholderUrl=e.Data.proxifyUrl(this._placeholderUrl,{proxy:"passport"})),this._placeholderSmallView=C.getWebappsAssetUrl("CAT3DWRichLinksUI","LinkPlaceholderView.png"),this._isMobileApp&&(this._placeholderSmallView=e.Data.proxifyUrl(this._placeholderSmallView,{proxy:"passport"})),this._defaultRectangleValue=100,this._textRenderService=new T},dispose:function(){f.unsubscribe(this._onExitExperience),f.unsubscribe(this._onStartExperience),f.unsubscribe(this._onStopExperience),f.unsubscribe(this._onMuteAllVideos),f.unsubscribe(this._onUnmuteAllVideos),this.stopExperience(),this._3DModelsNode.removeChildren(),this._3DModelsNode=null,this._videoModelsNode.removeChildren(),this._videoModelsNode=null,this._annotContainer.removeChildren(),this._annotContainer=null,this._connectionContainer.removeChildren(),this._connectionContainer=null,this._3DSKTContainer.removeChildren(),this._3DSKTContainer=null,this._textRenderService=null,D.dispose(),this._beforeMainPass=null,this._viewer=null,this._pickedObject=null,this._onMoveToken=null,this._mapVid.forEach((e=>{this._videoController.removeVideo(e.video)})),this._videoController.dispose(),this._videoController=null,this._mapVid=null},startExperience:function(){this._normal=new a.Vector3(0,0,-1),this._pickedObject=null,this._onDownCB=this._onDown.bind(this),this._onMovePointerCB=this._onMovePointer.bind(this),this._onUpCB=this._onUp.bind(this);const e=this._viewer.div;e.addEventListener(u.POINTERDOWN,this._onDownCB),e.addEventListener(u.POINTERMOVE,this._onMovePointerCB),e.addEventListener(u.POINTERUP,this._onUpCB),this._onMoveToken=this._viewer.currentViewpoint.control.onMove(this._onMove.bind(this))},stopExperience:function(){const e=this._viewer.div;if(e.removeEventListener(u.POINTERDOWN,this._onDownCB),e.removeEventListener(u.POINTERMOVE,this._onMovePointerCB),e.removeEventListener(u.POINTERUP,this._onUpCB),this._viewer.currentViewpoint.control.unsubscribe(this._onMoveToken),this._pickedObject=null,this._normal=null,this._3DModelsNode&&this._3DModelsNode.children)for(let e=0;e<this._3DModelsNode.children.length;e++)this._3DModelsNode.children[e].setMatrix(new a.Matrix4);this._mapVid.forEach((e=>{e.video.pause(),e.video.reset()}))},muteAllVideos:function(){this._mapVid.forEach((e=>{e.video.mute()}))},unmuteAllVideos:function(){this._mapVid.forEach((e=>{e.video.unmute()}))},_onDown:function(t){if(this._pickedObject=this._viewer.pick(this._viewer.getMousePosition(new a.Vector2(t.offsetX,t.offsetY)),"primHybrid",!0),this._pickedObject){this._pickedObject.modelObject=null,this._pickedObject.position&&(this._lastMousePosition=new a.Vector2(t.offsetX,t.offsetY));const i=this._pickedObject.path&&this._pickedObject.path[0]?this._pickedObject.path[0]:null;i&&i.externalPath.some(((n,o,r)=>{const s=n.name===this._videoModelsNode.name,l=n.name===this._3DModelsNode.name;let c=n.isURL;if(s||l){const e=r[o+1];if(c=e.isURL,!e)return!1;if(s?this._mapVid.get(e.name)?(this._videoClick(e.name),h.trackPageEvent({eventCategory:"3DWhiteBoard_Loader",eventAction:"3DWhiteBoard_ExperienceVideoClic",eventLabel:"Clic on an embedded link in 3DWhiteboard",appID:"X3DWHTB_AP"})):this._mapVid.forEach((n=>{i.externalPath.length>o+2&&e===n.video._timeline._mainNode&&i.externalPath[o+2]===n.video._timeline._mainLine?n.video.processtimelineTapInVideo(new a.Vector2(t.offsetX,t.offsetY)):i.externalPath.length>o+2&&e===n.video._timeline._mainNode&&i.externalPath[o+2]===n.video._timeline._volumeButtonNode&&n.video.processPickInVideoVolume(new a.Vector2(t.offsetX,t.offsetY))})):this._pickedObject.modelObject=e,!c)return!0;n=e}if("CAT3DWNode3DHyperlink"===n.getName()||c){let t=function(e){window.open(e),h.trackPageEvent({eventCategory:"3DWhiteBoard_Loader",eventAction:"3DWhiteBoard_ExperienceLinkClic",eventLabel:"Clic on an embedded link in 3DWhiteboard",appID:"X3DWHTB_AP"})};if(e.Utils.Client.Platform.ios||e.Utils.Client.Platform.ipad){this._goToUrlBtnContainer&&(this._goToUrlBtnContainer.remove(),this._goToUrlBtnContainer=null),this._goToUrlBtnContainer=e.createElement("div",{styles:{width:"42px",height:"42px",cursor:"pointer",borderRadius:"100%",boxShadow:"0 0 3px rgba(0,0,0,.5)",display:"flex",position:"absolute",marginLeft:"-22px",marginTop:"-22px",backgroundColor:"#42a2da"}}).inject(this._viewer.div),e.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-in-a-new-window",styles:{fontSize:"18px",margin:"auto",color:"white"}}).inject(this._goToUrlBtnContainer);let i=this._viewer.currentViewpoint.project(n.topLeft),o=this._viewer.currentViewpoint.project(n.topRight),r=i.x-o.x,s=500;if("CAT3DWNode3DHyperlink"===n.getName()){let e=new a.Vector3(n.topLeft.x,n.topLeft.y,n.topLeft.z);e.y=e.y+5,r=this._viewer.currentViewpoint.project(e).x-i.x;let t=r/15;this._goToUrlBtnContainer.style.scale=t}else if(r<s){let e=r/s;e<.7&&(e=.7),this._goToUrlBtnContainer.style.scale=e}this._goToUrlBtnContainer.setStyle("left",i.x),this._goToUrlBtnContainer.setStyle("top",i.y),this._goToUrlBtnContainer.addEvent(u.POINTERDOWN,function(){t(n.url),this._goToUrlBtnContainer&&(this._goToUrlBtnContainer.remove(),this._goToUrlBtnContainer=null)}.bind(this))}else{c&&(n=n.children[n.children.length-1]);let e=this._viewer.currentViewpoint.project(n.cornerTopRight);this._pickedObject.position&&"CAT3DWNode3DHyperlink"===n.getName()&&this._lastMousePosition.x>e.x+1&&this._lastMousePosition.y<e.y-1&&t(n.url)}}return!1}))}},_onMovePointer:function(e){if(this._pickedObject&&this._pickedObject.modelObject){var t=new a.Vector2(e.offsetX,e.offsetY);if(this._lastMouseMoveDistance=this._lastMousePosition.distanceTo(t),isNaN(this._lastMouseMoveDistance))return void(this._lastMouseMoveDistance=0);var i=t.clone().sub(this._lastMousePosition).normalize(),n=this._pickOnPlaneOfObject(new a.Vector2,this._pickedObject.position),o=this._pickOnPlaneOfObject(i,this._pickedObject.position);this._lastMousePosition=t;var r=o.sub(n).normalize().clone().cross(this._normal).normalize(),s=.005*this._lastMouseMoveDistance;s&&this._rotate3DModel(this._pickedObject.modelObject,r,s)}else{var l=this._viewer.pick(this._viewer.getMousePosition(new a.Vector2(e.offsetX,e.offsetY)),"primHybrid",!0);if(l){const t=l.path&&l.path[0]?l.path[0]:null;t?t.externalPath.some(((i,n,o)=>{if(i.name===this._videoModelsNode.name){const i=o[n+1];return!!i&&(this._mapVid.forEach((o=>{t.externalPath.length>n+2&&i===o.video._timeline._mainNode&&t.externalPath[n+2]===o.video._timeline._mainLine?o.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!0):o.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)})),!0)}return this._mapVid.forEach((t=>{t.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)})),!1})):this._mapVid.forEach((t=>{t.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)}))}else this._mapVid.forEach((t=>{t.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)}))}},_onUp:function(){this._pickedObject=null},_pickOnPlaneOfObject:function(e,t){var i=new a.Plane;return i.setFromNormalAndCoplanarPoint(this._normal,t).normalize(),this._viewer.currentViewpoint.create3DRayFrom2DPoint(e).intersectPlane(i)},_rotate3DModel:function(e,t,i,n){var o,r,s;n?(o=(new a.Matrix4).makeTranslation(-n.x,-n.y,-n.z),r=(new a.Matrix4).makeTranslation(n.x,n.y,n.z)):"bbox_3D"===e.parents[0].name?(s=e.parents[0].getBoundingBox().center(),o=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),r=(new a.Matrix4).makeTranslation(s.x,s.y,s.z)):"bbox_3D"===e.name?(s=e.getBoundingBox().center(),o=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),r=(new a.Matrix4).makeTranslation(s.x,s.y,s.z)):(s=e.getCenter(),o=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),r=(new a.Matrix4).makeTranslation(s.x,s.y,s.z));var l=(new a.Matrix4).makeRotationAxis(t,i);e.applyMatrix(o),e.applyMatrix(l),e.applyMatrix(r),this._viewer.render()},_videoClick:function(e){var t=this._mapVid.get(e);t&&t.video&&(t.video.isPlaying()?t.video.pause():t.video.play())},_onMove:function(){var e,t;this._mapVid.forEach(((i,n)=>{e=i,t=new a.Vector2(this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.topRight)),this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.bottomLeft)));var o={bottomLeft:e.bottomLeft,bottomRight:e.bottomRight,topLeft:e.topLeft,topRight:e.topRight};e.video.updateVideoControls(e.position,t,o,n)})),this._goToUrlBtnContainer&&(this._goToUrlBtnContainer.remove(),this._goToUrlBtnContainer=null)},unzip:function(e){return new Promise((function(t){var n=new i.BlobReader(e);i.createReader(n,(function(e){var n=e;n.getEntries((function(e){var o=e.find((function(e){return"sketch.json"===e.filename}));o&&o.getData(new i.TextWriter,(function(e){var i=e.target.result;n.close((function(){t(i)}))}))}))}),(function(){console.log("zip error")}))}))},_convertJSON:function(e){return new Promise(function(t){this._DataModelConverter.convertToLatestVersion(e).then((function(e){t(e)})).catch((function(){t(e)}))}.bind(this))},readJsonFile:function(e){return new Promise((function(t,i){var n={proxy:"none",type:"arraybuffer",timeout:6e5,onComplete:function(e){t(new Blob([e],{type:"application/zip"}))},onError:function(e){i(e)}};c.authenticatedRequest(e,n)}))},getListPointFromCircle:function(e,t){for(var i=[],n=new a.Vector3(t.x,t.y,t.z),o=new a.Vector3(e.annotStartPoint.x,e.annotStartPoint.y,e.annotStartPoint.z),r=new a.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),s=e.geometry.radius,l=(new a.Vector3).subVectors(o,r).normalize(),c=(new a.Vector3).crossVectors(l,n).normalize(),d=2*Math.PI/e.pointsCount,h=0;h<2*Math.PI;h+=d){var p=r.x+s*Math.cos(h)*l.x+s*Math.sin(h)*c.x,m=r.y+s*Math.cos(h)*l.y+s*Math.sin(h)*c.y,u=r.z+s*Math.cos(h)*l.z+s*Math.sin(h)*c.z;i.push(new a.Vector3(p,m,u))}return i.push(i[0]),i},getListPointFromEllipse:function(e){var t,i,n,o=[];if(e.matrix){let o=JSON.parse(e.matrix),r=new a.Matrix4;r.setFromArray(o.elements);let s=new a.Vector3,l=new a.Quaternion,c=new a.Vector3;r.decompose(s,l,c),r=(new a.Matrix4).compose(s,l,new a.Vector3(1,1,1)),l=(new a.Matrix4).extractRotation(r),t=new a.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z).applyMatrix4(r),i=new a.Vector3(e.geometry.majorAxis.dir.x,e.geometry.majorAxis.dir.y,e.geometry.majorAxis.dir.z).applyMatrix4(l).normalize(),n=new a.Vector3(e.geometry.minorAxis.dir.x,e.geometry.minorAxis.dir.y,e.geometry.minorAxis.dir.z).applyMatrix4(l).normalize()}else t=new a.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),i=new a.Vector3(e.geometry.majorAxis.dir.x,e.geometry.majorAxis.dir.y,e.geometry.majorAxis.dir.z),n=new a.Vector3(e.geometry.minorAxis.dir.x,e.geometry.minorAxis.dir.y,e.geometry.minorAxis.dir.z);for(var r=e.geometry.majorAxis.length,s=e.geometry.minorAxis.length,l=2*Math.PI/e.pointsCount,c=0;c<2*Math.PI;c+=l){var d=t.x+r*Math.cos(c)*i.x+s*Math.sin(c)*n.x,h=t.y+r*Math.cos(c)*i.y+s*Math.sin(c)*n.y,p=t.z+r*Math.cos(c)*i.z+s*Math.sin(c)*n.z;o.push(new a.Vector3(d,h,p))}return o.push(o[0]),o},getListPointFromLine:function(e){var t=[],i=new a.Vector3(e.geometry.startPoint.x,e.geometry.startPoint.y,e.geometry.startPoint.z),n=new a.Vector3(e.geometry.endPoint.x,e.geometry.endPoint.y,e.geometry.endPoint.z);if(t.push(i,n),e.matrix){let i=JSON.parse(e.matrix),n=new a.Matrix4;n.setFromArray(i.elements);let o=new a.Vector3,r=new a.Quaternion,s=new a.Vector3;n.decompose(o,r,s),n=(new a.Matrix4).compose(o,r,new a.Vector3(1,1,1));for(let e=0;e<t.length;e++)t[e]=t[e].applyMatrix4(n)}return t},getListPointFromRectangle:function(e){var t=[],i=new a.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),n=new a.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),o=new a.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z),r=new a.Vector3(e.geometry.vertexD.x,e.geometry.vertexD.y,e.geometry.vertexD.z);if(t.push(i,n,o,r,i),e.matrix){let i=JSON.parse(e.matrix),n=new a.Matrix4;n.setFromArray(i.elements);let o=new a.Vector3,r=new a.Quaternion,s=new a.Vector3;n.decompose(o,r,s),n=(new a.Matrix4).compose(o,r,new a.Vector3(1,1,1));for(let e=0;e<t.length-1;e++)t[e]=t[e].applyMatrix4(n)}return t},getListPointFromTriangle:function(e){var t=[],i=new a.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),n=new a.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),o=new a.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z);if(t.push(i,n,o,i),e.matrix){let i=JSON.parse(e.matrix),n=new a.Matrix4;n.setFromArray(i.elements);let o=new a.Vector3,r=new a.Quaternion,s=new a.Vector3;n.decompose(o,r,s),n=(new a.Matrix4).compose(o,r,new a.Vector3(1,1,1));for(let e=0;e<t.length-1;e++)t[e]=t[e].applyMatrix4(n)}return t},getListPointFromUnknown:function(e){var t=[];let i;if(e.matrix){let t=JSON.parse(e.matrix);i=new a.Matrix4,i.setFromArray(t.elements);let n=new a.Vector3,o=new a.Quaternion,r=new a.Vector3;i.decompose(n,o,r),i=(new a.Matrix4).compose(n,o,new a.Vector3(1,1,1))}for(var n=0;n<e.geometry.points.length;n++){var o=new a.Vector3(e.geometry.points[n].x,e.geometry.points[n].y,e.geometry.points[n].z);i&&(o=o.applyMatrix4(i)),t.push(o)}return t},_getLineMaterial:function(e){var t={color:e.color,lineWidth:e.thickness*window.devicePixelRatio,opacity:e.opacity,transparent:!1,force:!0,isCPUPattern:!0,linecap:"round",needsUpdate:!0};return new a.LineBasicMaterial(t)},_getSphereMaterial:function(e){return new a.MeshBasicMaterial({color:e.color,opacity:e.opacity,transparent:!1,force:!0})},_applyOpacityStencilOp:function(e,i){if(i.opacity<1){var n=this._viewer.getUserPassManager(),o=new t("StencilOpacityPass"),r=n.createUserRenderPass("userRenderPass",o);r.setEnableStencilTest(!0),r.setEnableStencilWrite(!0),r._passes[0].stencilRef=100*i.opacity,r.setStencilFunc("NOTEQUAL"),r.setStencilOpsSeparate("REPLACE","REPLACE","KEEP","KEEP");var a=n.getSystemPass("main");n.insertUserPassAfterPass(r,a),e.setRenderPasses([o])}},draw:function(e,t,i,o){var r={points:e};if("point"!==t){var s,l,c;if(i.strokeType&&"brush"===i.strokeType){for(var d=N.createMaterial(new a.Color(i.color),i.opacity,i.thickness,1),h=[],p=0;p<e.length;p++)h.push(new a.Vector3(0,0,1));s=N.createPencilGP(e,h,i.thickness,d)}else r.material=new a.SVGLineMaterial({color:i.color,lineWidth:i.thickness*window.devicePixelRatio,side:a.DoubleSide,opacity:i.opacity,enableClipPlanes:!1,linecap:"round",force:!0,transparent:!1}),s=n.createLineNode(r);if(s.setName("3DSketch_Annot"),this._annotContainer.add(s),!0===this._isClosed(e)&&"NoFill"!==i.fillingType){let t=1,n=1;.7===i.thickness?(t=1,n=1):1.4===i.thickness?(t=2,n=2):3.5===i.thickness?(t=3,n=3):4.9===i.thickness?(t=4,n=4):7===i.thickness&&(t=5,n=5);var m=new L;for(p=0;p<e.length;p++)m.addPointToCurrentPolygonLoop(e[p].x,-1*e[p].y);m.closeCurrentPolygonLoop(),m.endCurrentPolygon(),"Solid"===i.fillingType?((l=m.createNode3D(new a.MeshBasicMaterial({color:i.fillcolor,opacity:i.fillingOpacity,force:!0}),e[0].z)).name="CAT3DSketch-FillNode",this._annotContainer.addChild(l)):"Hatch"===i.fillingType?((l=m.createNode3D(this.createHatchingMaterial({stripesDirection:new a.Vector2(1,1),spaceWidth:t,stripesWidth:n,stripesColor:i.fillcolor,spaceOpacity:.3,stripesOpacity:i.fillingOpacity}),e[0].z)).name="CAT3DSketch-FillNode",this._annotContainer.addChild(l)):"CrossHatch"===i.fillingType&&((l=m.createNode3D(this.createHatchingMaterial({stripesDirection:new a.Vector2(1,1),spaceWidth:t,stripesWidth:n,stripesColor:i.fillcolor,spaceOpacity:.3,stripesOpacity:i.fillingOpacity}),e[0].z)).name="CAT3DSketch-FillNode",this._annotContainer.addChild(l),(c=m.createNode3D(this.createHatchingMaterial({stripesDirection:new a.Vector2(1,-1),spaceWidth:t,stripesWidth:n,stripesColor:i.fillcolor,spaceOpacity:.3,stripesOpacity:i.fillingOpacity}),e[0].z)).name="CAT3DSketch-FillNode-Cross ",this._annotContainer.addChild(c))}this._applyOpacityStencilOp(s,i),void 0!==o&&this.setDepth(o,s,l,c)}else this.drawPoint(e,i,o)},setDepth:function(e,t,i,n){var o=5*e;if(t.setRenderDepth(o),t.mesh3js.material.transparent=!0,t.mesh3js.material.depthTest=!1,i){var r=o-1;i.children[0].setRenderDepth(r),i.children[0].mesh3js.material.transparent=!0,i.children[0].mesh3js.material.depthTest=!1}if(n){r=o-2;n.children[0].setRenderDepth(r),n.children[0].mesh3js.material.transparent=!0,n.children[0].mesh3js.material.depthTest=!1}},createHatchingMaterial:function(e){var t,i,n=new a.MeshBasicMaterial({side:a.FrontSide,vertexColors:a.VertexColorType.RGBA,force:!0});t=e.spaceColor?new a.Color(e.spaceColor):new a.Color(16777215),i=e.stripesColor?new a.Color(e.stripesColor):new a.Color(16777215),n.activatePDSFX();var o={planeU:{type:"v3",value:new a.Vector3(1,0,0)},planeV:{type:"v3",value:new a.Vector3(0,1,0)},hatchingDirection:{type:"v2",value:e.stripesDirection.clone().normalize()},hatchingNormal:{type:"v2",value:new a.Vector2(e.stripesDirection.y,-e.stripesDirection.x).normalize()},hatchingSpaceWidth:{type:"f",value:e.spaceWidth},hatchingSpaceColor:{type:"v4",value:new a.Vector4(t.r,t.g,t.b,e.spaceOpacity)},hatchingLineWidth:{type:"f",value:e.stripesWidth},hatchingLineColor:{type:"v4",value:new a.Vector4(i.r,i.g,i.b,e.stripesOpacity)}};n.setPDSFXUniforms(o);n.setPDSFXVaryings({_uv:{type:"v2"},myPosition:{type:"v4"}});n.setPDSFXGlobalShaderCode("vec4 _mvPosition;","");var r={ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) { _mvPosition = vec4(ioWorldViewTS.Position, 0.0); }",ComputeVaryingValues:["void ComputeVaryingValues() {","mat4 VM = vGetViewMatrix();","vec3 mvPlaneU = (VM * vec4(planeU, 0.0)).xyz;","vec3 mvPlaneV = (VM * vec4(planeV, 0.0)).xyz;","_uv = vec2(dot(_mvPosition.xyz, mvPlaneU), dot(_mvPosition.xyz, mvPlaneV))-vec2(dot(VM[3].xyz, mvPlaneU), dot(VM[3].xyz, mvPlaneV));","}"].join("\n")},s={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","float eval = hatchingNormal.x*_uv.x + hatchingNormal.y*_uv.y;","float k = mod(eval, hatchingSpaceWidth);","vec2 fwx = dot(hatchingNormal, dFdx(_uv))*hatchingNormal;","vec2 fwy = dot(hatchingNormal, dFdy(_uv))*hatchingNormal;","vec2 fw = abs(fwx) + abs(fwy);","float fwlen = length(fw);","float tol = min(hatchingLineWidth*fwlen, hatchingSpaceWidth - fwlen);","if (k < tol/2.0 || k > hatchingSpaceWidth - tol/2.0) {","  ioFinalColor = hatchingLineColor;","} else {","  ioFinalColor = hatchingSpaceColor;","}","}"].join("\n")};return n.setPDSFXOverridableFunctions(r,s),n.hatching=!0,n},_isClosed:function(e){return this.isClosedTest(e[0].distanceTo(e[e.length-1]),this._polyPerimeter(e))},_polyPerimeter:function(e){for(var t=0,i=0;i<e.length;i++)t+=e[i].distanceTo(e[(i+1)%e.length]);return t},isClosedTest:function(e,t){return e<Math.min(t/10,40)},drawPoint:function(e,t,i){var o=new a.MeshBasicMaterial({color:t.color,transparent:!1,force:!0,opacity:t.opacity,side:a.DoubleSide}),r=n.createCircleNode({segments:20,radius:.5*t.thickness,fill:!0,material:o});r.name="CAT3DSketch-PointNode",r.setMatrix((new a.Matrix4).setPosition(e[0])),this._annotContainer.addChild(r),this._applyOpacityStencilOp(r,t),void 0!==i&&this.setDepth(i,r)},load3DModel:function(t,i,n){return new Promise(function(o){"3dstory"!==this._appname&&o();var r=new y;i=r.generateUrlWithSuffix(i),this._isMobileApp&&(i=e.Data.proxifyUrl(i,{proxy:"passport"}));var l=new d,c="model3DNode_"+this._3dMediaCounter;this._3dMediaCounter++;var h=new s("bbox_3D"),p=new s(c);h.addChild(p),this._3DModelsNode.addChild(h),l.setOnLoadedCallback((()=>{var e=p.getBoundingBox().center(),t=new a.Matrix4;t.makeTranslation(-e.x,-e.y,-e.z);for(var i=0;i<p.children.length;i++)p.children[i].setMatrix(t);this._viewer.render(),o()})),l.setOnErrorCallback((function(e){console.error(e)})),l.loadModel({filename:i,proxyurl:"none",format:t,withCredentials:!0,viewer:this._viewer},p);var m=new a.Matrix4;m.setFromArray(n),p.setMatrix(m),r.dispose()}.bind(this))},onLoadImageError:function(){},_onTextureLoaded:function(){},apply2Dtexture:function(e,t,i,o,r,l){var c,d="";if(o?(d="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,c=new s(d),this._videoModelsNode.addChild(c)):(d="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,c=new s(d),this._3DSKTContainer.addChild(c)),e.flipY=!1,e.image.width<=0||e.image.height<=0)return c;let h=e.image.width,m=e.image.height;e.image.originalWidth&&e.image.originalHeight&&(h=e.image.originalWidth,m=e.image.originalHeight);var u={width:-100,height:-100,fill:!0,noEdge:!0},f=n.createRectangleNode(u);f.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,50,0)));var g=(new a.Matrix4).makeRotationX(Math.PI);c.addChild(f),c.setMatrix(t),f.applyMatrix(g);var w=m/h,_=0,v=0;if(e.cropInfo){let t=h/e.cropInfo.cropData.hRatio;(w=m/e.cropInfo.cropData.vRatio/t)>1?(_=this._defaultRectangleValue,v=this._defaultRectangleValue/w):(_=this._defaultRectangleValue*w,v=this._defaultRectangleValue),_*=e.cropInfo.cropData.vRatio,v*=e.cropInfo.cropData.hRatio}else w>1?(_=this._defaultRectangleValue,v=this._defaultRectangleValue/w):(_=this._defaultRectangleValue*w,v=this._defaultRectangleValue);t.scale(new a.Vector3(Math.abs(v/this._defaultRectangleValue),Math.abs(_/this._defaultRectangleValue),1)),c.setMatrix(t);var x=new a.MeshBasicMaterial({map:e,side:a.DoubleSide,force:!0,transparent:!0,depthTest:!1});if(x.color=new a.Color,x.polygonOffset=!0,x.polygonOffsetFactor=.7,o){var D=f.getMatrixWorld(),y=f.mesh3js.geometry[0].vertexPositionArray,C=new a.Vector3(y[0],y[1],y[2]).applyMatrix4(D),M=new a.Vector3(y[3],y[4],y[5]).applyMatrix4(D),V=new a.Vector3(y[9],y[10],y[11]).applyMatrix4(D),b=new a.Vector3(y[6],y[7],y[8]).applyMatrix4(D);this._mapVid.set(c.name,{video:o,position:r,bottomLeft:V,bottomRight:b,topLeft:C,topRight:M});var P=new a.Vector2(this._viewer.currentViewpoint.project(C).distanceTo(this._viewer.currentViewpoint.project(M)),this._viewer.currentViewpoint.project(C).distanceTo(this._viewer.currentViewpoint.project(V))),T={bottomLeft:V,bottomRight:b,topLeft:C,topRight:M};o.updateVideoControls(r,P,T,c.name),c.topLeft=M,c.topRight=C}else{var S=f.getMatrixWorld(),A=f.mesh3js.geometry[0].vertexPositionArray;c.topRight=new a.Vector3(A[0],A[1],A[2]).applyMatrix4(S),c.topLeft=new a.Vector3(A[3],A[4],A[5]).applyMatrix4(S)}var I=new p({faceMaterial:x});if(f.setMaterialApplication(I),l){var k=f.getMaterial("Face");k&&(k.opacity=l)}return o?f.setRenderDepth(i-4):f.setRenderDepth(i),this.textureLoaded=!0,c},load2DModel:function(t){return new Promise(function(i){let n=JSON.parse(t.associatedData.matrix).elements,o=5*t.associatedData.renderDepth,r=t.status,s=t.url,l=t.type,c=t.associatedData.cropData,d=t.associatedData.opacity;if(r!==V.STATUS_KO&&r!==V.STATUS_PROCESSING){var h=new y;s=h.generateUrlWithSuffix(s)}this._isMobileApp&&(s=e.Data.proxifyUrl(s,{proxy:"passport"}));var p=new a.Matrix4;p.setFromArray(n);var m=null;if(l===V.TYPE_IMAGE||r===V.STATUS_PROCESSING){let e="image/"+t.extension;this._canvasServices.getImageUrlWithValidResolution(s,e,"anonymous",function(e){c&&r===V.STATUS_OK?this._canvasServices.getCroppedImageUrl(e,c,function(e){new Promise(function(t){(m=a.ImageUtils.loadTexture3DWhiteboard(e,void 0,(function(){t(m)}),this.onLoadImageError,"use-credentials",1)).magFilter=a.LinearMipMapLinearFilter,m.minFilter=a.LinearFilter}.bind(this)).then(function(e){if(e){e.cropInfo=c;let n=this.apply2Dtexture(e,p,o,null,null,d);if(t.associatedData.hyperlink&&(n.isURL=!0,n.url=t.associatedData.hyperlink),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,this._viewer.render(),r!==V.STATUS_PROCESSING){this._updateHyperlinkNode(n,null,o);let r=this._placeHolderMap.get(t.associatedData.uniqueID);this._3DSKTContainer.removeChild(r),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,i(n)}else i({mediaID:t.associatedData.uniqueID,node:n})}}.bind(this))}.bind(this)):new Promise(function(t){(m=a.ImageUtils.loadTexture3DWhiteboard(e,void 0,(function(){t(m)}),this.onLoadImageError,"use-credentials",1)).magFilter=a.LinearMipMapLinearFilter,m.minFilter=a.LinearFilter}.bind(this)).then(function(e){let n=this.apply2Dtexture(e,p,o,null,null,d);if(t.associatedData.hyperlink&&(n.isURL=!0,n.url=t.associatedData.hyperlink),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,this._viewer.render(),r!==V.STATUS_PROCESSING){this._updateHyperlinkNode(n,null,o);let r=this._placeHolderMap.get(t.associatedData.uniqueID);this._3DSKTContainer.removeChild(r),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,i()}else i({mediaID:t.associatedData.uniqueID,node:n})}.bind(this))}.bind(this))}else if(l===V.TYPE_VIDEO){var u=new a.Vector3(0,0,0);u.getPositionFromMatrix(p);var f=new a.Vector3(u.x-50,u.y+50,u.z),g=new a.Vector3(u.x+50,u.y+50,u.z),w=new a.Vector3(u.x-50,u.y-50,u.z),_=new a.Vector3(u.x+50,u.y-50,u.z),v={bottomLeft:w,bottomRight:_,topLeft:f,topRight:g};new Promise(function(e){this._videoController.setViewSettings({_beforeMainPass:this._beforeMainPass,getBeforeMainPass:function(){return this._beforeMainPass}}),this._videoController.createVideo({videoNode:this._videoModelsNode,urlOrTexture:s,viewer:this._viewer,controlPosition:u,matrix:p,corners:v,renderDepth:o,thumbnailURL:t.thumbnailURL,videoDimension:new a.Vector2(this._viewer.currentViewpoint.project(f).distanceTo(this._viewer.currentViewpoint.project(g)),this._viewer.currentViewpoint.project(f).distanceTo(this._viewer.currentViewpoint.project(w)))}).then((function(t){e(t)}))}.bind(this)).then(function(e){m=e.getTexture();let n=this.apply2Dtexture(m,p,o,e,u);if(t.associatedData.hyperlink&&(n.isURL=!0,n.url=t.associatedData.hyperlink),this._viewer.render(),r!==V.STATUS_PROCESSING){this._updateHyperlinkNode(n,null,o);let e=this._placeHolderMap.get(t.associatedData.uniqueID);this._3DSKTContainer.removeChild(e),i()}else i({mediaID:t.associatedData.uniqueID,node:n})}.bind(this))}}.bind(this))},drawSketch:function(e){var t=JSON.parse(e);return this._parsedJSON=t,this._3DModelsNode=new s("3DModels"),this._3DSKTContainer.addChild(this._3DModelsNode),this._videoModelsNode=new s("VideoModels"),this._3DSKTContainer.addChild(this._videoModelsNode),new Promise(function(e){if(t.ver){for(var i=(new l).processJSON(t,"expand"),n=i.explodeStates,o=0;o<n.length;o++)if(0===n[o].id)for(var r=n[o].drawPlanes,s=0;s<r.length;s++){var c=r[s],d=c.annotList.filter((function(e){return e.isVisible}));if(d.length)for(var h=null,p=0;p<d.length;p++){switch(d[p].type){case"circle":h=this.getListPointFromCircle(d[p],c.drawPlaneInfo.normal);break;case"ellipse":h=this.getListPointFromEllipse(d[p]);break;case"line":h=this.getListPointFromLine(d[p]);break;case"rectangle":h=this.getListPointFromRectangle(d[p]);break;case"triangle":h=this.getListPointFromTriangle(d[p]);break;case"unknownOpen":case"unknownClosed":default:h=this.getListPointFromUnknown(d[p]);break;case"point":h=[new a.Vector3(d[p].annotStartPoint.x,d[p].annotStartPoint.y,d[p].annotStartPoint.z)]}this.draw(h,d[p].type,d[p].graphicalProp,d[p].renderDepth)}}e(i)}else e(t)}.bind(this))},loadMedia:function(t){var i=t.Textboxes;let n=new e.Element("div",{class:"loading-pannel-parent",styles:{width:"100%",position:"absolute",top:"-8px"}}).inject(this._viewerContainer);this._loadingPanel=new E({value:0}).inject(n,"top"),this._loadingPanel.displayStyle="lite",this._loadingPanel.elements.container.setStyle("max-width","none"),this._loadingPanel.elements.container.setStyle("position","relative"),this._loadingPanel.elements.container.firstChild.setStyle("max-width","none"),this._loadingPanel.on();var o=[],r=[],s=0,l=[];if(t.ExternalRef&&t.ExternalRef.media2D&&t.ExternalRef.media2D.length)for(let e=0;e<t.ExternalRef.media2D.length;e++){let i=t.ExternalRef.media2D[e].matrixV2,n=t.ExternalRef.media2D[e].hyperlink;if(!i){let n=JSON.parse(t.ExternalRef.media2D[e].matrix),o=new a.Matrix4;o.setFromArray(n.elements);let r=new a.Vector3,s=new a.Quaternion,l=new a.Vector3;o.decompose(r,s,l),l.x=l.z,l.y=l.z,o.compose(r,s,l),i=JSON.stringify(o)}let r=t.ExternalRef.media2D[e].mediaId,c={uniqueID:s,matrix:i,renderDepth:t.ExternalRef.media2D[e].renderDepth,cropData:t.ExternalRef.media2D[e].cropData,opacity:t.ExternalRef.media2D[e].opacity,currentStream:t.ExternalRef.media2D[e].currentStream,hyperlink:n,visible:t.ExternalRef.media2D[e].visible,id:t.ExternalRef.media2D[e].id},d={url:this._placeholderUrl,type:V.TYPE_IMAGE,status:V.STATUS_PROCESSING,associatedData:c};o.push({mediaId:r,associatedData:c}),l.push(this.load2DModel(d).then((e=>{this._placeHolderMap.set(e.mediaID,e.node)}))),s+=1}if(t.ExternalRef&&t.ExternalRef.media3D&&t.ExternalRef.media3D.length)for(let e=0;e<t.ExternalRef.media3D.length;e++){let i=t.ExternalRef.media3D[e].hyperlink;if("RepresentationlImage"===t.ExternalRef.media3D[e].viewType){let n={uniqueID:s,id:t.ExternalRef.media3D[e].id,viewType:"RepresentationlImage",matrix:t.ExternalRef.media3D[e].matrix,renderDepth:t.ExternalRef.media3D[e].renderDepth,hyperlink:i,visible:t.ExternalRef.media3D[e].visible},r={uniqueID:s,url:this._placeholderUrl,type:V.TYPE_IMAGE,status:V.STATUS_PROCESSING,associatedData:n};o.push({mediaId:t.ExternalRef.media3D[e].mediaIdImage,associatedData:n}),l.push(this.load2DModel(r).then((e=>{this._placeHolderMap.set(e.mediaID,e.node)}))),s+=1}else o.push({mediaId:t.ExternalRef.media3D[e].mediaId,associatedData:{matrix:t.ExternalRef.media3D[e].matrix,hyperlink:i}})}if(i&&i.length>0)for(var c=0;c<i.length;c++)r.push(this.loadText(i[c]));if(t.links&&t.links.length){this._linksMedia=new Map;for(let e=0;e<t.links.length;e++){let i,n;if(t.links[e].smallViewThumbnailSubject6wuri&&"small"===t.links[e].linkData.view_type?(n=this._placeholderSmallView,i=t.links[e].smallViewThumbnailSubject6wuri,o.push({mediaId:i,associatedData:{linkid:t.links[e].id,islink:!0,uniqueID:s}})):t.links[e].fullViewSubject6wuri&&"full"===t.links[e].linkData.view_type&&(n=this._placeholderUrl,i=t.links[e].fullViewSubject6wuri,o.push({mediaId:i,associatedData:{linkid:t.links[e].id,islink:!0,uniqueID:s}})),t.links[e].fullViewSubject6wuri||t.links[e].smallViewThumbnailSubject6wuri){let o={id:i,uniqueID:s,viewType:"RepresentationlImage",matrix:t.links[e].matrix,renderDepth:t.links[e].renderDepth},r={uniqueID:s,url:n,type:V.TYPE_IMAGE,status:V.STATUS_PROCESSING,associatedData:o};l.push(this.load2DModel(r).then((e=>{this._placeHolderMap.set(e.mediaID,e.node)}))),s+=1}}}if(!o.length)return Promise.all(r).finally((async()=>{await this.loadComparisons(t),await this.loadImageTemplates(t),await this.loadAIGenerators(t),await this.loadLinks(t),this._viewer.render()})),t;var d="",h=0,p=0;let m=function(){return D.getMedias(o,function(e){this._loadingPanel.value=e}.bind(this),function(e){g.initialize();var t=null;e.status===V.STATUS_PROCESSING&&e.type&&(d+=e.title+" ",p++),e.status===V.STATUS_KO&&e.type&&h++,!0!==e.associatedData.islink?e.format===V.FORMAT_2D||e.status===V.STATUS_PROCESSING?r.push(this.load2DModel(e)):e.format===V.FORMAT_3D&&(t=JSON.parse(e.associatedData.matrix),r.push(this.load3DModel(e.extension,e.url,t.elements))):this._linksMedia.set(e.associatedData.linkid,e)}.bind(this)).catch((e=>{e&&console.log(e)})).then(async function(){return g.initialize(),await Promise.all(r).then((()=>{p&&g.setGeneralErrorMessage(p+" media not yet processed. Try reloading when all medias are processed","",d,"warning"),p&&g.setGeneralErrorMessage(p+" media not yet processed. Try reloading when all medias are processed","",d,"warning"),h&&g.setGeneralErrorMessage(h+" media not available. Check your access rights","","","warning"),h&&g.setGeneralErrorMessage(h+" media not available. Check your access rights","","","warning")})),await this.loadComparisons(t),await this.loadImageTemplates(t),await this.loadAIGenerators(t),await this.loadLinks(t),this._loadingPanel.off(),t}.bind(this)).catch((e=>{e&&console.log(e)}))}.bind(this);return"3dstory"!==this._appname?(m(),t):m()},loadText:function(e){return new Promise((t=>{let i=null;if(e.matrix){i=new a.Matrix4;let t=JSON.parse(e.matrix);i.setFromArray(t.elements)}var n,o;o="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,n=new s(o),this._3DSKTContainer.addChild(n);var r=this.makeNode(i,n,5*e.renderDepth,e.worldDimensions.width,e.worldDimensions.height);if(e.hyperlink){var l=r.getMatrixWorld(),c=r.mesh3js.geometry[0].vertexPositionArray;r.topRight=new a.Vector3(c[9],c[10],c[11]).applyMatrix4(l),r.topLeft=new a.Vector3(c[6],c[7],c[8]).applyMatrix4(l),r.bottomRight=new a.Vector3(c[0],c[1],c[2]).applyMatrix4(l),r.isURL=!0,r.url=e.hyperlink}this._redrawText(r,e),this._updateHyperlinkNode(r,n,e.renderDepth),t()}))},drawConnections:function(e){return new Promise(function(t){var i=e.connections;i&&0!==i.length||t(e);var n=[];if(e.explodeStates[0].drawPlanes[0]&&(n=e.explodeStates[0].drawPlanes[0].annotList),e.ExternalRef){var o=e.ExternalRef.media2D;o&&o.forEach((e=>n.push(e)));var r=e.ExternalRef.media3D;r&&r.forEach((e=>n.push(e)))}var s=e.Textboxes;s&&s.forEach((e=>n.push(e)));var l=e.links;l&&l.forEach((e=>n.push(e)));var c=e.stickers;c&&c.forEach((e=>n.push(e)));for(let e=0;e<i.length;e++){const t=i[e].settings,n=i[e].coordinatesPointA,o=i[e].coordinatesPointB,r=new a.Vector2(n.x,n.y),s=new a.Vector2(o.x,o.y),l=i[e].currentViewPortA,c=i[e].currentViewPortB,g=i[e].arrowSizeA,w=i[e].arrowSizeB;if(!(r&&s&&l&&c&&g&&w))continue;let _=[],v=null;var d=i[e].middlePoint;if(d&&!d[0]&&(d=[]).push(i[e].middlePoint),"spline"===t.connectorType){const n=i[e].pointANormal,o=i[e].pointBNormal,l=new a.Vector2(n.x,n.y),c=new a.Vector2(o.x,o.y);if(!l||!c)return;var h=[];h.push(r);const p=Math.max(g,w);if(i[e].controlPoint){const t=new a.Vector2(i[e].controlPoint.x,i[e].controlPoint.y);h.push(t),h.push(s),v=S.ComputeBezierCurve(h,.01,l,c,p)}else if(d&&d[0].isFixed){const e=d[0].position,i=new a.Vector2(e.x,e.y);let n=0,o=0,h=new a.Vector2(0,-1);h=Math.abs(s.y-r.y)>Math.abs(s.x-r.x)?r.y<s.y?s.x<r.x?new a.Vector2(.5,-.5):new a.Vector2(-.5,-.5):s.x<r.x?new a.Vector2(.5,.5):new a.Vector2(-.5,.5):r.x<s.x?r.y<s.y?new a.Vector2(-.5,-.5):new a.Vector2(-.5,.5):r.y<s.y?new a.Vector2(.5,-.5):new a.Vector2(.5,.5),n=S.GetControlPoint(r,l,i,p);let m=S.GetControlPoint(i,h,r,p);const u=new a.Vector2((n.x+m.x)/2,(m.y+n.y)/2);let f=[];if(d[1]&&d[1].isFixed){let e=d[1].position,t=2*e.x-(r.x+i.x)/2,o=2*e.y-(r.y+i.y)/2;n=new a.Vector3(t,o,50);f=new a.QuadraticBezierCurve3(new a.Vector3(r.x,r.y,50),n,new a.Vector3(i.x,i.y,50)).getPoints(50)}else{let e=[];e.push(r),e.push(u),e.push(i),f=S.ComputeBezierCurve(e,.01,l,h,p)}let x=null;if(d[2]&&d[2].isFixed){let e;e=d[1]&&d[1].isFixed?d[1].position:u;let t=d[2].position;const n=new a.SplineCurve3([new a.Vector3(r.x,r.y,50),new a.Vector3(e.x,e.y,50),new a.Vector3(i.x,i.y,50),new a.Vector3(t.x,t.y,50),new a.Vector3(s.x,s.y,50)]).getPoints(50);f=n.slice(0,26),x=n.slice(25)}else{let e=new a.Vector2(f[f.length-1].x,f[f.length-1].y);const t=new a.Vector2(f[f.length-2].x,f[f.length-2].y).clone().sub(e).normalize().multiplyScalar(-1);o=S.GetControlPoint(i,t,s,p);let n=S.GetControlPoint(s,c,i,p);const r=new a.Vector2((o.x+n.x)/2,(n.y+o.y)/2);let l=[];l.push(i),l.push(r),l.push(s),x=S.ComputeBezierCurve(l,.01,t,c,p)}v=f.concat(x);const D=v[v.length-6],y=v[6];let C=new a.Vector2(D.x,D.y),M=new a.Vector2(y.x,y.y);"unidirectional"!==t.arrowDirection&&"bidirectional"!==t.arrowDirection||_.push(S.ComputeArrowPoint(s,(new a.Vector2).subVectors(C,s).normalize(),w)),"bidirectional"===t.arrowDirection&&_.push(S.ComputeArrowPoint(r,(new a.Vector2).subVectors(M,r).normalize(),g))}else{const e=S.GetControlPoint(r,l,s,p),i=S.GetControlPoint(s,c,r,p);let n=new a.Vector2((e.x+i.x)/2,(i.y+e.y)/2);if(h.push(n),h.push(s),"unidirectional"!==t.arrowDirection&&"bidirectional"!==t.arrowDirection||_.push(S.ComputeArrowPoint(s,c,w)),"bidirectional"===t.arrowDirection&&_.push(S.ComputeArrowPoint(r,l,g)),!n)continue;v=S.ComputeBezierCurve(h,.01,l,c,p)}}else if("parabola"===t.connectorType)if(d&&d[0].isFixed){var p;let e=2,i=2*d[0].position.x-(r.x+s.x)/2,n=2*d[0].position.y-(r.y+s.y)/2;e=new a.Vector3(i,n,50);p=new a.QuadraticBezierCurve3(new a.Vector3(r.x,r.y,50),e,new a.Vector3(s.x,s.y,50)).getPoints(50),"unidirectional"!==t.arrowDirection&&"bidirectional"!==t.arrowDirection||_.push(S.ComputeArrowPoint(s,(new a.Vector2).subVectors(e,s).normalize(),w)),"bidirectional"===t.arrowDirection&&_.push(S.ComputeArrowPoint(r,(new a.Vector2).subVectors(e,r).normalize(),g)),v=p}else v=S.ComputeLine([r,s]),"unidirectional"!==t.arrowDirection&&"bidirectional"!==t.arrowDirection||_.push(S.ComputeArrowPoint(s,(new a.Vector2).subVectors(r,s).normalize(),w)),"bidirectional"===t.arrowDirection&&_.push(S.ComputeArrowPoint(r,(new a.Vector2).subVectors(s,r).normalize(),g));else if(d&&d[0].isFixed){var m=[];if(m.push(r),d[1]&&d[1].isFixed){let e=new a.Vector2(d[1].position.x,d[1].position.y);m.push(e)}for(let e=0;e<d.length;e+=2)if(d[e].isFixed){let t=new a.Vector2(d[e].position.x,d[e].position.y);m.push(t)}m.push(s),v=S.ComputeLine(m);const e=v[v.length-2],i=v[1];let n=new a.Vector2(e.x,e.y),o=new a.Vector2(i.x,i.y);"unidirectional"!==t.arrowDirection&&"bidirectional"!==t.arrowDirection||_.push(S.ComputeArrowPoint(s,(new a.Vector2).subVectors(n,s).normalize(),w)),"bidirectional"===t.arrowDirection&&_.push(S.ComputeArrowPoint(r,(new a.Vector2).subVectors(o,r).normalize(),g))}else v=S.ComputeLine([r,s]),"unidirectional"!==t.arrowDirection&&"bidirectional"!==t.arrowDirection||_.push(S.ComputeArrowPoint(s,(new a.Vector2).subVectors(r,s).normalize(),w)),"bidirectional"===t.arrowDirection&&_.push(S.ComputeArrowPoint(r,(new a.Vector2).subVectors(s,r).normalize(),g));const x={color:t.color?t.color:"#dcdcc8",opacity:t.opacity?t.opacity:1,thickness:t.thickness?t.thickness:2,lineType:t.lineType?t.lineType:"solid"};var u=i[e].renderDepth;u||(u=1/0);const D=5*u-1;var f=S.CreateLineNode(v,x);f.setRenderDepth(D),this._connectionContainer.addChild(f),_.forEach((e=>{const t=[];t.push(e[0]),t.push(e[1]);const i=[];i.push(e[2]),i.push(e[3]),x.lineType="solid";var n=S.CreateLineNode(t,x);n.setRenderDepth(D);var o=S.CreateLineNode(i,x);o.setRenderDepth(D),this._connectionContainer.addChild(n),this._connectionContainer.addChild(o)}))}t(e)}.bind(this))},_redrawText:async function(e,t){let i=1.5;(U.Platform.ios||U.Platform.ipad||U.Platform.android)&&(i=3.5);let n=100*(t.inputDimensions.height/30);if(t.inputDimensions.height>t.inputDimensions.width){let e=Math.floor(Math.sqrt(R.MPLimit/i));n>e&&(n=e)}else{let e=Math.floor(Math.sqrt(R.MPLimit/i))*t.inputDimensions.height/t.inputDimensions.width;n>e&&(n=e)}var o=n/t.inputDimensions.height;let r=null;if(t.stickyNote){let e=W.hexToRgb(t.backgroundColor),i=105,n=105,o=105,a=.25;r="rgb("+(e.r+(i-e.r)*a)+","+(e.g+(n-e.g)*a)+","+(e.b+(o-e.b)*a)+")"}let s=t.stickyNote?P.defaultTextWithBackgroundColorPadding:P.defaultTextPadding;t.masterMediaID&&(s=P.defaultTextPaddingWithShape);var l=await this._textRenderService.renderTextToCanvas({width:t.inputDimensions.width,height:t.inputDimensions.height,text:t.text,lineHeight:t.lineHeight,fontSize:t.fontSize,padding:s,color:t.color,borderColor:r,backgroundColor:t.backgroundColor,scale:o,fontStyle:t.fontStyle,fontWeight:t.fontWeight,textAlign:t.textAlign,fontFamily:t.fontFamily});e.currenttexture&&e.currenttexture.dispose();var c=a.ImageUtils.createTexture3DWhiteboard(l,!0);c.magFilter=a.LinearMipMapLinearFilter,c.minFilter=a.LinearFilter;var d=new a.MeshBasicMaterial({map:c,force:!0,side:a.DoubleSide});d.transparent=!0,d.color=new a.Color;var h=new p({faceMaterial:d});e.setMaterialApplication(h),e.currenttexture=c,this._viewer.render()},makeNode:function(e,t,i,o=100,r=100){let s=e.getScaleOnAxisZ(),l=o/s,c=r/s;var d=n.createRectangleNode({width:-l,height:-c,fill:!0,color:new x.Color(255,255,255,0)});return d.setMatrix((new a.Matrix4).setPosition(new a.Vector3(l/2,c/2,0))),null!=i&&d.setRenderDepth(i),t.addChild(d),t.setMatrix(e),d},setTextureFromCanvas:function(e,t){t.currenttexture&&t.currenttexture.dispose();var i=new a.Texture(e,void 0,a.ClampToEdgeWrapping,a.ClampToEdgeWrapping,a.LinearFilter,a.LinearMipMapLinearFilter);i.anisotropy=16,i.needsUpdate=!0;var n=new a.MeshBasicMaterial({map:i,force:!0,side:a.DoubleSide});n.transparent=!0,n.color=new a.Color;var o=new p({faceMaterial:n});t.setMaterialApplication(o),t.currenttexture=i,this._viewer.render()},loadTextboxFont:function(e){return new Promise(function(t){this._textRenderService.loadTextboxFont().then((function(){t(e)}))}.bind(this))},loadStickersFont:function(t){return new Promise((function(i){var n=C.getWebappsAssetUrl("UIKIT","fonts/3ds-icon.woff2"),o=null;if(M.getPreferenceValue("M3DEMobile")){var r=e.Data.proxifyUrl(n,{proxy:"passport"});o=new FontFace("Entypo","url("+r+') format("woff2")')}else o=new FontFace("Entypo","url("+n+') format("woff2")');o.load().then((function(){document.fonts.add(o),i(t)}))}))},loadLinks:function(t){return new Promise(async function(i){var n=t.links;if(!n.length)return void i(t);let o=new y;for(let t=0;t<n.length;t++){let i;if("small"===n[t].linkData.view_type){let r=this._linksMedia.get(n[t].id),a=null;r&&(a=o.generateUrlWithSuffix(r.previewurl),this._isMobileApp&&r.previewurl&&(a=e.Data.proxifyUrl(r.previewurl,{proxy:"passport"})),i=r.associatedData.uniqueID),!a&&n[t].smallViewThumbnailUrl&&(a=n[t].smallViewThumbnailUrl);let s=await this._getSmallViewCanvas(n[t],a);if(this._createLinkNode({canvas:s,matrix:n[t].matrix,renderDepth:5*n[t].renderDepth,id:n[t].id,url:n[t].url}),void 0!==i){let e=this._placeHolderMap.get(i);this._3DSKTContainer.removeChild(e)}}else if("full"===n[t].linkData.view_type){let r=this._linksMedia.get(n[t].id);if(r){if(i=r.associatedData.uniqueID,r){let i=o.generateUrlWithSuffix(r.url);this._isMobileApp&&(i=e.Data.proxifyUrl(i,{proxy:"passport"}));let a=await this._getCanvasFromImageUrl(i);this._createLinkNode({canvas:a,matrix:n[t].matrix,renderDepth:5*n[t].renderDepth,id:n[t].id,url:n[t].url})}let a=this._placeHolderMap.get(i);this._3DSKTContainer.removeChild(a)}}}i(t)}.bind(this))},_getCanvasFromImageUrl:function(e){return new Promise(function(t){var i=new Image;i.onload=function(){var e=this._canvasServices.createCanvas({width:i.width,height:i.height,tag:"linkFullViewCanvas"});e.getContext("2d").drawImage(i,0,0,i.width,i.height),t(e)}.bind(this),i.crossOrigin="use-credentials",i.src=e}.bind(this))},_createLinkNode:function(e){var t=new s("linkNode-"+e.id);this._3DSKTContainer.addChild(t);let i=JSON.parse(e.matrix),o=new a.Matrix4;o.setFromArray(i.elements);var r=100,l=e.canvas.height*(r/e.canvas.width),c=n.createRectangleNode({width:-100,height:-l,fill:!0,color:new x.Color(255,255,255,0)});c.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,l/2,0))),void 0!==e.renderDepth&&null!==e.renderDepth&&c.setRenderDepth(e.renderDepth),t.addChild(c),t.setMatrix(o);var d=c.mesh3js.geometry[0].vertexPositionArray;c.topLeft=new a.Vector3(d[9]-50,d[10]+l/2,d[11]).applyMatrix4(o),c.topRight=new a.Vector3(d[6]-50,d[7]+l/2,d[8]).applyMatrix4(o),c.isURL=!0,c.url=e.url,this.setTextureFromCanvas(e.canvas,c),this._updateHyperlinkNode(c,t,e.renderDepth)},_getSmallViewCanvas:function(e,t){return new Promise((function(i){let n={};if(n.type=e.linkData.content_type,n.linktype=e.linkData.type,n.title=e.linkData.title,n.description=e.linkData.description,n.thumbnail=t,e.linkData.type===b.LINK_EXTERNAL)n.url=e.linkData.hostname?e.linkData.hostname:e.url;else if(e.linkData.type===b.LINK_INTERNAL){var o=e.url,r=new URL(o);n.hash=r.hash,n.url=o,n.author=e.linkData.author,n.community=e.linkData.community,n.mediaType=e.linkData.mediaType,n.swymv3=!0}new A(n).getCanvas().then((function(e){i(e)}))}))},loadAIGenerators:async function(e){if(e.aiGenNodes&&0!==e.aiGenNodes.length)for(let t of e.aiGenNodes)await this.makeAIGenNode(t),this._2dMediaCounter++},makeAIGenNode:async function(t){function i(e){return new a.MeshBasicMaterial({color:e,transparent:!1,force:!0,opacity:1,side:a.DoubleSide})}function o(e,t){var i=new a.LineBasicMaterial({color:e?new a.Color(e):new a.Color("#42A2DA"),force:!0,transparent:!0,opacity:1,lineWidth:t||2});return i.depthTest=!0,i.depthWrite=!1,i.polite=!0,i.politeMaterial=i.clone(),i.politeMaterial.opacity=.15,i.politeMaterial.depthTest=!1,i.politeMaterial.depthWrite=!1,i}function r(e,t){var i=new a.MeshBasicMaterial({map:e,force:!0,side:a.DoubleSide});return i.transparent=t,i.color=new a.Color,i.polygonOffset=!0,i.polygonOffsetFactor=.7,i}function l(e){var t=null;switch(e){case"edition":case"wizard":(t=new a.LineBasicMaterial({color:"#F4F5F6",lineWidth:10,opacity:1,side:a.DoubleSide})).force=!0,t.depthTest=!0;break;case"modeling":(t=new a.LineBasicMaterial({color:"#77797c",lineWidth:1,opacity:1,side:a.DoubleSide})).force=!0,t.depthTest=!0;break;case"placeholder":var i=new Float32Array(2);i[0]=.6,i[1]=.3,(t=new a.LineBasicMaterial({color:"#77797c",lineWidth:1,opacity:1,side:a.DoubleSide,dashPattern:i})).force=!0,t.depthTest=!0;break;default:t=new a.LineBasicMaterial({opacity:0})}return t}let c=new s("aiGeneratorNode");this._3DSKTContainer.addChild(c),await function(t,i){return new Promise(((o,r)=>{let s=n.createRectangleNode({width:-100,height:-100,fill:!0,cornerPoint:new a.Vector2(50,50),color:new x.Color(255,255,255,0)});s.setMatrix((new a.Matrix4).makeScale(.6,.6,.6)),t.addChild(s),function(t,n){let o=null,r=function(e){return"Generation"===e?"text!DS/CAT3DWInfra/assets/icons/AI_Generate_Image basic_nodots.svg":"Control Net"===e?"text!DS/CAT3DWInfra/assets/icons/AI_Generate_Image ControlNet_nodots.svg":"Inpainting"===e?"text!DS/CAT3DWInfra/assets/icons/AI_Generate_Image mask_nodots.svg":void 0}(i);var s,l;s=r,l=function(i){let r=new Image;r.height=500,r.width=500,r.onload=function(){let i=new e.Element("canvas");i.height=500,i.width=500,i.getContext("2d").drawImage(r,0,0,500,500);let s=(new k).getBlobUrlFromCanvas(i,"image/png");o=a.ImageUtils.loadTexture(s,void 0,(()=>{t(o)}),(()=>{n()}),!1)};let s=new Blob([i],{type:"image/svg+xml"});r.src=URL.createObjectURL(s)},new Promise((function(e){require([s],(function(t){l(t),e(t)}))}))}((e=>{var t=new a.LineBasicMaterial({opacity:0}),i=new a.MeshBasicMaterial({map:e,force:!0,side:a.DoubleSide});i.transparent=!0,i.color=new a.Color,s.removeMaterialApplication();var n=new p({faceMaterial:i,lineMaterial:t});s.setMaterialApplication(n),o()}),(()=>{console.error("Texture loading failed for AI node!"),r()}))}))}.call(this,c,t.aigenerationType),await function(e,t){return new Promise(((s,c)=>{if(null===this._viewer)return;let d=[],h=function(e){return"Generation"===e?"#368EC4":"Inpainting"===e?"#00B8DE":"Control Net"===e?"#191970":void 0}(t),m=[new a.Vector3(60,5,50),new a.Vector3(60,-5,50)],u=[new a.Vector3(-60,-20,50),new a.Vector3(-60,-45,50)],f=[new a.Vector3(-60,20,50),new a.Vector3(-60,45,50)],g=[new a.Vector3(45,-60,50),new a.Vector3(-45,-60,50)],w=[new a.Vector3(45,60,50),new a.Vector3(-45,60,50)],_=n.createCircleNode({segments:20,radius:10,fill:!0,material:i("#32CD32")});_.setMatrix((new a.Matrix4).setPosition(new a.Vector3(60,-25,50))),e.addChild(_),d.push(_),_.name="input_1";let v=n.createCircleNode({segments:20,radius:10,fill:!0,material:i("#32CD32")});v.setMatrix((new a.Matrix4).setPosition(new a.Vector3(60,25,50))),e.addChild(v),d.push(v);let D=n.createCircleNode({segments:20,radius:10,fill:!0,material:i("#32CD32")});D.setMatrix((new a.Matrix4).setPosition(new a.Vector3(-60,0,50))),e.addChild(D),d.push(D);let y=n.createCircleNode({segments:20,radius:15,fill:!1,startAngle:0,endAngle:-Math.PI/2});y.setMatrix((new a.Matrix4).setPosition(new a.Vector3(45,-45,50))),y.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(y),d.push(y);let V=n.createCircleNode({segments:20,radius:15,fill:!1,startAngle:-Math.PI/2,endAngle:-Math.PI});V.setMatrix((new a.Matrix4).setPosition(new a.Vector3(-45,-45,50))),V.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(V),d.push(V);let b=n.createCircleNode({segments:20,radius:15,fill:!1,startAngle:1.5*-Math.PI,endAngle:2*-Math.PI});b.setMatrix((new a.Matrix4).setPosition(new a.Vector3(45,45,50))),b.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(b),d.push(b);let P=n.createCircleNode({segments:20,radius:15,fill:!1,startAngle:-Math.PI,endAngle:1.5*-Math.PI});P.setMatrix((new a.Matrix4).setPosition(new a.Vector3(-45,45,50))),P.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(P),d.push(P);let T=n.createLineNode({points:m});T.setPickable(x.PICKTHROUGH),T.setExcludeFromBounding(!0),T.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(T),d.push(T);let S=n.createLineNode({points:u});S.setPickable(x.PICKTHROUGH),S.setExcludeFromBounding(!0),S.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(S),d.push(S);let A=n.createLineNode({points:f});A.setPickable(x.PICKTHROUGH),A.setExcludeFromBounding(!0),A.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(A),d.push(A);let I=n.createLineNode({points:g});I.setPickable(x.PICKTHROUGH),I.setExcludeFromBounding(!0),I.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(I),d.push(I);let k=n.createLineNode({points:w});k.setPickable(x.PICKTHROUGH),k.setExcludeFromBounding(!0),k.setMaterialApplication(new p({lineMaterial:o(h,6)})),e.addChild(k),d.push(k);let R=n.createRectangleNode({width:-20,height:-20,fill:!0,cornerPoint:new a.Vector2(45,-15),noEdge:!0,color:new x.Color(255,255,255,0)});e.addChild(R),d.push(R);let E=n.createRectangleNode({width:-20,height:-20,fill:!0,cornerPoint:new a.Vector2(50,35),noEdge:!0,color:new x.Color(255,255,255,0)});e.addChild(E),d.push(E);var N=C.getWebappsAssetUrl("CAT3DWInfra","icons/promptInput.png"),L=C.getWebappsAssetUrl("CAT3DWInfra","icons/imageInput.png");let U=2,W=function(){console.error("Texture loading failed for AI node!"),c()},F=M.getPreferenceValue("UseCredentials")||!1;a.ImageUtils.loadTexture3DWhiteboard(N,void 0,(function(e){let t=R.getMaterial("Line")?R.getMaterial("Line"):l(null);R.removeMaterialApplication();let i=new p({faceMaterial:r(e,!0),lineMaterial:t});R.setMaterialApplication(i),U--,0===U&&s()}),W,F,!0),a.ImageUtils.loadTexture3DWhiteboard(L,void 0,(function(e){let t=E.getMaterial("Line")?E.getMaterial("Line"):l(null);E.removeMaterialApplication();let i=new p({faceMaterial:r(e,!0),lineMaterial:t});E.setMaterialApplication(i),U--,0===U&&s()}),W,F,!0)}))}.call(this,c,t.aigenerationType);let d=new a.Matrix4,h=JSON.parse(t.matrix);d.setFromArray(h.elements),c.setMatrix(d),this._viewer.render()},loadImageTemplates:function(e){return new Promise((t=>{let i=e.imageTemplates;if(i&&0!==i.length){let n=[];i.forEach((e=>{n.push(this.makeImageTemplateNode(e))})),Promise.all(n).finally((()=>{t(e)}))}else t(e)}))},makeImageTemplateNode:function(e){let t=function(e,t,i){let o="model2DNode_"+this._2dMediaCounter;this._2dMediaCounter++;let r=new s(o);this._3DSKTContainer.addChild(r),e.flipY=!1;let l=n.createRectangleNode({width:-100,height:-100,fill:!0,noEdge:!0});l.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,50,0)));let c=(new a.Matrix4).makeRotationX(Math.PI);r.addChild(l),r.setMatrix(t),l.applyMatrix(c),r.setMatrix(t);let d=new a.MeshBasicMaterial({map:e,side:a.DoubleSide,force:!0,transparent:!0,depthTest:!1});d.color=new a.Color,d.polygonOffset=!0,d.polygonOffsetFactor=.7;let h=l.getMatrixWorld(),m=l.mesh3js.geometry[0].vertexPositionArray;r.topRight=new a.Vector3(m[0],m[1],m[2]).applyMatrix4(h),r.topLeft=new a.Vector3(m[3],m[4],m[5]).applyMatrix4(h);let u=new p({faceMaterial:d});return l.setMaterialApplication(u),l.setRenderDepth(i),r}.bind(this),i=function(e,i){let n=a.ImageUtils.loadTexture3DWhiteboard(e,void 0,(e=>{if(e){let n=JSON.parse(i.matrix).elements,o=5*i.renderDepth,r=new a.Matrix4;r.setFromArray(n);let s=t(e,r,o);s.id=i.id,s.name=i.id,s._texture=e,this._viewer.render(),resolve()}}),this.onLoadImageError,"use-credentials",1);n.magFilter=a.LinearMipMapLinearFilter,n.minFilter=a.LinearFilter}.bind(this);return new Promise(((t,n)=>{let o=C.getWebappsBaseUrl()+"CAT3DWInfra/assets/moodBoardImages/"+e.originalImageName;if(e.currentMediaId){let t=this._3DSKTContainer.getChildByName(e.currentMediaId);t&&(t.setVisibility(!1),o=t._texture.sourceFile)}this._canvasServices.getImageUrlWithValidResolution(o,"","anonymous",(t=>{e.cropData?this._canvasServices.getCroppedImageUrl(t,e.cropData,(t=>{i(t,e)})):i(t,e)}))}))},loadComparisons:function(e){return new Promise(async function(t){let i=e.comparisons;i&&i.length>0&&i.forEach((e=>{this.makeComparisonNode(e),this._2dMediaCounter++})),t(e)}.bind(this))},makeComparisonNode:function(e){let t;this._defaultRectangleValue=100,this._defaultImage1=C.getWebappsAssetUrl("CAT3DWInfra","placeholders/Image_Thumbnail.png"),this._defaultImage2=C.getWebappsAssetUrl("CAT3DWInfra","placeholders/Image_Thumbnail-Greyscale.png");let i=new a.Matrix4,o=JSON.parse(e.matrix);i.setFromArray(o.elements);let r=this._defaultImage1,s=this._defaultImage2,l=!1,c=!1;if(e.comparisonInfo&&e.comparisonInfo.img1&&e.comparisonInfo.img1.id){let t=this._3DSKTContainer.getChildByName(e.comparisonInfo.img1.id);t&&(t.setVisibility(!1),this._canvasServices.getImageUrlWithValidResolution(t._texture.sourceFile,"","anonymous",(e=>{r=e,l=!0,c&&w()})))}else l=!0;if(e.comparisonInfo&&e.comparisonInfo.img2&&e.comparisonInfo.img2.id){let t=this._3DSKTContainer.getChildByName(e.comparisonInfo.img2.id);t&&(t.setVisibility(!1),this._canvasServices.getImageUrlWithValidResolution(t._texture.sourceFile,"","anonymous",(e=>{s=e,c=!0,l&&w()})))}else c=!0;this._viewer.render();let d=function(e){if(e&&e.mesh3js){let t=e.mesh3js.geometry[0].vertexPositionArray;return{bottomLeft:new a.Vector3(t[0],t[1],t[2]),bottomRight:new a.Vector3(t[3],t[4],t[5]),topLeft:new a.Vector3(t[9],t[10],t[11]),topRight:new a.Vector3(t[6],t[7],t[8])}}},h=function(i,n){if("Slider (vertical)"===e.comparisonType||"Slider (horizontal)"===e.comparisonType){let e=d(i),o=d(t.rectangle),r=e.topLeft.distanceTo(e.topRight)/o.topLeft.distanceTo(o.topRight),a=e.topLeft.distanceTo(e.bottomLeft)/o.topLeft.distanceTo(o.bottomLeft),s=new Image;s.onload=function(){let e={top:0,left:0,width:s.width*r,height:s.height*a};i===t.img2&&(e={top:s.height-s.height*a,left:s.width-s.width*r,width:s.width*r,height:s.height*a}),this._canvasServices._getCroppedImageUrlFromActualImage(s,e,(function(e){m(i,e)}))}.bind(this),s.crossOrigin="use-credentials",s.src=n}else m(i,n)}.bind(this),m=function(t,i){let n=function(i){let n=t.getMaterial("Line")?t.getMaterial("Line"):new a.LineBasicMaterial({opacity:0});t.removeMaterialApplication();let o=new p({faceMaterial:(r=i,s=!0,l=new a.MeshBasicMaterial({map:r,force:!0,side:a.DoubleSide}),l.transparent=s,l.color=new a.Color,l.polygonOffset=!0,l.polygonOffsetFactor=.7,l),lineMaterial:n});var r,s,l;t.setMaterialApplication(o),t.setRenderDepth(5*e.renderDepth),this._viewer.render()}.bind(this),o=M.getPreferenceValue("UseCredentials")||!1;a.ImageUtils.loadTexture3DWhiteboard(i,void 0,n,(function(e){console.log(e)}),o,!0)}.bind(this),u=function(e,t,i){e&&e.cropDataForAspectRatio?this._canvasServices.getCroppedImageUrl(t,e.cropDataForAspectRatio,function(t){e.cropDataAfterEdit?this._canvasServices.getCroppedImageUrl(t,e.cropDataAfterEdit,(function(e){i(e)})):i(t)}.bind(this)):e&&e.cropDataAfterEdit?this._canvasServices.getCroppedImageUrl(t,e.cropDataAfterEdit,(function(e){i(e)})):i(t)}.bind(this),f=function(t){let o=n.createRectangleNode({width:-t._rectangle._3dWidth,height:-t._rectangle._3dHeight,fill:!0,cornerPoint:new a.Vector2(t._rectangle._3dXpos,t._rectangle._3dYpos),noEdge:!0,color:new x.Color(255,255,255,0)});o.name=e.id+"-images-container";let r=n.createRectangleNode({width:-t._image1._3dWidth,height:-t._image1._3dHeight,fill:!0,cornerPoint:new a.Vector2(t._image1._3dXpos,t._image1._3dYpos),noEdge:!0,color:new x.Color(255,255,255,0)});r.name=e.id+"-image-1",o.addChild(r);let s=n.createRectangleNode({width:-t._image2._3dWidth,height:-t._image2._3dHeight,fill:!0,cornerPoint:new a.Vector2(t._image2._3dXpos,t._image2._3dYpos),noEdge:!0,color:new x.Color(255,255,255,0)});return s.name=e.id+"-image-2",o.addChild(s),this._3DSKTContainer.addChild(o),o.setMatrix(i),o.setRenderDepth(5*e.renderDepth),{rectangle:o,img1:r,img2:s}}.bind(this),g=function(t,i){let n,o,r,a,s,l=t/i,c=0,d=0;switch(l>=1?(c=l*this._defaultRectangleValue,d=this._defaultRectangleValue):(c=this._defaultRectangleValue,d=this._defaultRectangleValue/l),e.comparisonType){case"Slider (vertical)":o=e.comparisonInfo&&e.comparisonInfo.img1&&e.comparisonInfo.img1.wRatio?c*e.comparisonInfo.img1.wRatio:.5*c,r=e.comparisonInfo&&e.comparisonInfo.img2&&e.comparisonInfo.img2.wRatio?c*e.comparisonInfo.img2.wRatio:.5*c,n=f({_rectangle:{_3dWidth:c,_3dHeight:d,_3dXpos:.5*c,_3dYpos:.5*d},_image1:{_3dWidth:o,_3dHeight:d,_3dXpos:.5*c,_3dYpos:.5*d},_image2:{_3dWidth:r,_3dHeight:d,_3dXpos:.5*c-o,_3dYpos:.5*d}});break;case"Slider (horizontal)":a=e.comparisonInfo&&e.comparisonInfo.img1&&e.comparisonInfo.img1.hRatio?d*e.comparisonInfo.img1.hRatio:.5*d,s=e.comparisonInfo&&e.comparisonInfo.img2&&e.comparisonInfo.img2.hRatio?d*e.comparisonInfo.img2.hRatio:.5*d,n=f({_rectangle:{_3dWidth:c,_3dHeight:d,_3dXpos:.5*c,_3dYpos:.5*d},_image1:{_3dWidth:c,_3dHeight:a,_3dXpos:.5*c,_3dYpos:a-.5*d},_image2:{_3dWidth:c,_3dHeight:s,_3dXpos:.5*c,_3dYpos:.5*d}});break;case"Side by Side (vertical)":n=f({_rectangle:{_3dWidth:c,_3dHeight:2*d,_3dXpos:.5*c,_3dYpos:d},_image1:{_3dWidth:c,_3dHeight:d,_3dXpos:.5*c,_3dYpos:0},_image2:{_3dWidth:c,_3dHeight:d,_3dXpos:.5*c,_3dYpos:d}});break;case"Side by Side (horizontal)":n=f({_rectangle:{_3dWidth:2*c,_3dHeight:d,_3dXpos:c,_3dYpos:.5*d},_image1:{_3dWidth:c,_3dHeight:d,_3dXpos:c,_3dYpos:.5*d},_image2:{_3dWidth:c,_3dHeight:d,_3dXpos:0,_3dYpos:.5*d}});break;default:console.error("Invalid comparison type")}return n}.bind(this),w=()=>{if(e.comparisonInfo&&e.comparisonInfo.img1){let i=e.comparisonInfo.img1;if(i.cropDataAfterEdit)t=g(i.cropDataAfterEdit.width,i.cropDataAfterEdit.height),u(e.comparisonInfo.img1,r,(function(e){h(t.img1,e)})),u(e.comparisonInfo.img2,s,(function(e){h(t.img2,e)}));else if(i.cropDataForAspectRatio)t=g(i.cropDataForAspectRatio.width,i.cropDataForAspectRatio.height),u(e.comparisonInfo.img1,r,(function(e){h(t.img1,e)})),u(e.comparisonInfo.img2,s,(function(e){h(t.img2,e)}));else if(i.id){let i=new Image;i.onload=function(){t=g(i.width,i.height),u(e.comparisonInfo.img1,r,(function(e){h(t.img1,e)})),u(e.comparisonInfo.img2,s,(function(e){h(t.img2,e)}))},i.src=r}}else if(e.comparisonInfo&&e.comparisonInfo.img2){let i=e.comparisonInfo.img2;if(i.cropDataAfterEdit)t=g(i.cropDataAfterEdit.width,i.cropDataAfterEdit.height),u(e.comparisonInfo.img1,r,(function(e){h(t.img1,e)})),u(e.comparisonInfo.img2,s,(function(e){h(t.img2,e)}));else if(i.cropDataForAspectRatio)t=g(i.cropDataForAspectRatio.width,i.cropDataForAspectRatio.height),u(e.comparisonInfo.img1,r,(function(e){h(t.img1,e)})),u(e.comparisonInfo.img2,s,(function(e){h(t.img2,e)}));else if(i.id){let i=new Image;i.onload=function(){t=g(i.width,i.height),u(e.comparisonInfo.img1,r,(function(e){h(t.img1,e)})),u(e.comparisonInfo.img2,s,(function(e){h(t.img2,e)}))},i.src=r._texture.sourceFile}}else t=g(this._defaultRectangleValue,this._defaultRectangleValue),h(t.img1,r),h(t.img2,s)};l&&c&&w()},loadStickers:function(e){return new Promise(async function(t){var i=e.stickers;!i||i.length?(i.forEach((e=>{let t=null;if(e.matrix){t=new a.Matrix4;let i=JSON.parse(e.matrix);t.setFromArray(i.elements)}var i=this.makeStickerNode({matrix:t,renderDepth:5*e.renderDepth,id:e.id});this._2dMediaCounter++,this._drawSticker(i,e)})),t(e)):t(e)}.bind(this))},makeStickerNode:function(e){var t=new s("sticker2DNode_"+e.id);this._3DSKTContainer.addChild(t);var i=n.createRectangleNode({width:-100,height:-100,fill:!0,color:new x.Color(255,255,255,0)});return i.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,50,0))),void 0!==e.renderDepth&&null!==e.renderDepth&&i.setRenderDepth(e.renderDepth),t.addChild(i),t.setMatrix(e.matrix),i},_drawSticker:function(e,t){var i=t.value,n=this._canvasServices.createCanvas({width:1e3,height:1e3,tag:"stickerCanvas"});const o=n.width/2,r=n.height/2;var s=n.getContext("2d");s.textBaseline="middle",s.textAlign="center",s.fillStyle="#005685",s.font="700px Entypo",s.fillText(i,o,r,1e3),e.currenttexture&&e.currenttexture.dispose();var l=a.ImageUtils.createTexture3DWhiteboard(n,!0);l.magFilter=a.LinearFilter,l.minFilter=a.LinearMipMapLinearFilter;var c=new a.MeshBasicMaterial({map:l,force:!0,side:a.DoubleSide});c.transparent=!0,c.color=new a.Color;var d=new p({faceMaterial:c});e.setMaterialApplication(d),e.currenttexture=l,this._viewer.render()},_updateHyperlinkNode:function(e,t=null,i=null){var n=e.getChildren(),o=null;if(e.isURL){for(let e=0;e<n.length;e++)"CAT3DWNode3DHyperlink"===n[e].getName()&&(o=n[e]);if(null===o){var a={topLeft:e.topRight,topRight:e.topLeft};if(t){var s=new r(a,t.getMatrixWorld(),0);s.url=e.url,t.addChild(s)}else{var l=new r(a,e.getMatrixWorld(),0);l.url=e.url,e.addChild(l)}}}else{n=e.getChildren();for(var c=0;c<n.length;c++)"CAT3DWNode3DHyperlink"===n[c].getName()&&(n[c].deleteNode(),e.removeChild(n[c]))}const d=t?t.getChildren():e.getChildren();if(i)for(let e=0;e<d.length;e++)"CAT3DWNode3DHyperlink"===d[e].name&&d[e].getChildren()[0].setRenderDepth(5*i)},load:function(i,n,o,r){this._3DSKTContainer=new s("3DSKTContainer"),this._annotContainer=new s("annotContainer"),this._annotContainer.setPickable(x.PICKTHROUGH),this._3DSKTContainer.addChild(this._annotContainer),this._connectionContainer=new s("connectionContainer"),this._3DSKTContainer.addChild(this._connectionContainer),this._3DSKTContainer.setVisibility(!1),this._viewerContainer=i.viewer.div,this._viewer=i.viewer,this._viewer.renderer&&this._viewer.renderer.renderer&&(this._viewer.renderer.renderer._useRenderDepthDL=!0),this._maskContainer=e.createElement("div",{styles:{opacity:.7,pointerEvents:"none",position:"absolute",top:"0",width:"100%",height:"100%",zIndex:10,display:"none"}}).inject(this._viewerContainer),this._mask=e.createElement("div",{styles:{position:"absolute",top:"0",width:"100%",height:"100%"}}).inject(this._maskContainer),_.mask(this._mask,"Loading");var l={};if(i.requestsOptions&&i.requestsOptions.serverurl)l.platformUrl=i.requestsOptions.serverurl,l.originUrl=i.requestsOptions.hostname;else{l.platformId=v.getTenant();try{!l.platformId&&parent.ds&&parent.ds.swymTenant&&(l.platformId=parent.ds.swymTenant)}catch(e){}}l&&l.platformId&&M.setPreferenceValue("swymTenant",l.platformId),i.requestsOptions&&i.requestsOptions.appname&&(this._appname=i.requestsOptions.appname,document.body.classList.add("story")),"3dstory"!==this._appname&&(this._maskContainer.style.display="block"),this._canvasServices=new k,D.initWithTenant(l),this._DataModelConverter=new I({version:"5.0",webapp:I.APP_3DWHITEBOARD,platformId:M.getPreferenceValue("swymTenant"),platformUrl:l.platformUrl,originUrl:l.originUrl,appName:this._appname,viewer:this._viewer,viewpoint:this._viewer.currentViewpoint});var c=this._viewer.getUserPassManager();this._beforeMainPass=new t("BeforeMain");var d=c.createUserClearPass("userClearPass",this._beforeMainPass);d.setClearDepth(!0);var p=c.createUserRenderPass("userRenderPass",this._beforeMainPass),m=c.getSystemPass("main");c.insertUserPassBeforePass(d,m),c.insertUserPassBeforePass(p,d),this.readJsonFile(i.filename).then(this.unzip.bind(this)).then(this._convertJSON.bind(this)).then(this.drawSketch.bind(this)).then(this.loadTextboxFont.bind(this)).then(this.loadStickersFont.bind(this)).then(this.loadMedia.bind(this)).then(this.loadStickers.bind(this)).then(this.drawConnections.bind(this)).then((e=>{_.unmask(this._mask),this._3DSKTContainer.setVisibility(!0),n(this._3DSKTContainer),r(this._3DSKTContainer);const t=this._viewer.currentViewpoint;e.viewpoint&&"3dstory"!==this._appname?t.moveTo({eyePosition:(new a.Vector3).copy(e.viewpoint.position),orientation:(new a.Quaternion).copy(e.viewpoint.quaternion),distanceToTarget:e.viewpoint.targetDistance,duration:0}):t.reframe(null,0),this._onMove(),this._viewer.render(),this._viewerContainer.removeChild(this._maskContainer),this._mask=null,this._maskContainer=null,h.trackPageEvent({eventCategory:"3DWhiteBoard_Loader",eventAction:"3DWhiteBoard_LoadVisu",eventLabel:"Load visu of sketch in other apps",appID:"X3DWHTB_AP"})})).catch(this._error)},_error:function(e){console.error(e)}})}));