define("DS/ENOXTaggerOnIndexComponent/ENOXTaggerOnIndexComponent",["UWA/Core","DS/TagNavigatorProxy/TagNavigatorProxy","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/SearchDictionaryAccess/SearchDictionaryAccessAPI"],(function(e,t,i,r,n,l){"use strict";let o={},a={},s={},c={},f={},u="",d=227,g={};function h(e){let t=new Date,i="";return e&&("string"==typeof e&&(e=(e=(e=e.replace(/\&#x2f;/g,"/")).replace(/\&#x3a;/g,":")).replace(/\u200E/g,"")),t=new Date(e),i=t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()),i}function p(i,l,c,d,p,y){let b="",j="",m=l.idDataIndex?l.idDataIndex:"physicalid";if(l.queryWithResourceId)b=p;else if(p&&Array.isArray(p)&&p.length==c.length)for(let e=0;e<c.length;e++)e>0&&(b+=" OR "),b+=p[e];else{b+=m+":(";for(let e=0;e<c.length;e++)e>0&&(b+=" OR "),b+='"'+c[e]+'"';b+=")"}let O=widget.getUrl()+"-"+n.getUser().login+"-"+Date.now();if("function"===e.typeOf(l.onTagFilterChange)&&(o[i]||(o[i]=t.createProxy({id:i,widgetId:widget.id,filteringMode:"FilteringOnServer",colorize:!!l.colorize&&l.colorize,MyFriends:l.MyFriends,tenant:widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",exclude:!0,simplified:{editTagsRelationships:!0,person_data:!0,data_location:!0,type_categorization:!0}}),UWA.is(l.onSetTagProxy,"function")&&l.onSetTagProxy(),a[i]={}),o[i].addEvent("onFilterChange",(function(){a[i].then,a[i].then((()=>{try{const{filterOptions:e,currentFilter:t}=x.getFiltedSubjects(i);l.onTagFilterChange(e)}catch(e){console.error(e)}})).catch((e=>{console.error(e)}))})),l.colorize&&!0===l.colorize&&(o[i].addEvent("colorize",l.onTagColor),o[i].addEvent("unColorize",l.onTagUncolor))),f[i]||(f[i]={subjectPrefix:l.subjectPrefix||""}),0==c.length)return void(o[i]&&(s[i]={},x.publishTags(i,[])));j={query:b,order_by:"asc",order_field:"ds6w:modified",label:O,locale:null!=widget&&null!=widget.lang?widget.lang:"en",nresults:c.length,start:0,tenant:widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",with_synthesis:!0,select_predicate:["ds6w:created"]},l.queryWithResourceId&&(l.resourceid_in?j.resourceid_in=c:l.resourceid_not_in&&(j.resourceid_not_in=c)),l.searchOptions&&l.searchOptions.source&&(j.source=l.searchOptions.source);let P=widget.getValue("x3dPlatformId");u=g[P]?g[P]["3DSearch"]+"/search":"",r.authenticatedRequest(u,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",type:"json",proxy:"passport",data:JSON.stringify(j),onComplete:function(e){!function(e,t,i,r){let n=function(e){let t,i={},r=e.results,n="",l={},o=[];return r&&r.forEach((function(e){t=e.attributes,n="",l={},o=[];for(let e=0;e<t.length;e++)if("internal"==t[e].format)"resourceid"==t[e].name&&(n=t[e].value);else if("ds6w_facet"==t[e].format){if("explicit"===t[e].field&&t[e].sixw)continue;l={object:"date"==t[e].type?h(t[e].value):t[e].value,sixw:t[e].name,field:t[e].field,dispValue:"date"==t[e].type?"NONE_NEEDED":t[e].dispValue?t[e].dispValue:t[e].value,type:t[e].type},o.push(l)}n&&(i[n]=o)})),i}(e);if(o[t]){let e=f[t].subjectPrefix||"",l=Object.keys(n);if(i.length!==l.length){console.log("dataIndexPIDs and serverTagList do not have the same length"),i.filter((function(e){return!l.includes(e)})).forEach((function(e){n[e]={}}))}s[t]||(s[t]={});for(let i in n)s[t][e+i]=n[i];if(r)for(let t in n){let i=r[t]||r[e+t];if(i)for(let e=0;e<i.length;e++)n[t].push(i[e])}}}(e,i,c,d),UWA.is(y,"function")&&y()},onFailure:function(e){console.log("Tagger service Error : "),console.log(e)}})}function y(e,t){let i=t[e];return i||e}i.getPlatformServices({onComplete:function(e){e.forEach((function(e){g[e.platformId]=e}))},onFailure:function(){UWA.log("Error in i3DXCompassPlatformServices.getPlatformServices")}});function b(e){let t=function(e){let t={};const i=["3DSpace"];return e&&e.forEach((e=>{if(e.sixw&&"date"!==e.type){let r=e.sixw.lastIndexOf("/"),n=r>0?e.sixw.substring(r+1):e.sixw;e.nlsKey=n;let l=t[n];l||(l=t[n]=[]),Array.isArray(e.object)?e.object.forEach((e=>l.push({value:e,source:i}))):l.push({value:e.object,source:i})}})),t}(e);return new Promise((i=>{l.getNlsOfSearchValuesBySource(t,{tenantId:widget?widget.getValue("x3dPlatformId"):"onPremise",lang:widget?widget.lang:"en",apiVersion:"R2019x",onComplete:function(t){!function(e,t){const i=Object.assign({},t);e.forEach((e=>{if(e.nlsKey){let r=Object.assign({},t[e.nlsKey]);if(r){Object.keys(r).forEach(((e,i,n)=>{const l=r[e],o=n.filter((t=>r[t]===l&&t!==e));if(o.length>0){const i=e.split(".").shift();let n=t["ds6w:type"][i]?t["ds6w:type"][i]:i;r[e]=`${l} (${n})`,o.forEach((e=>{const t=e.split(".").shift();r[e]=`${l} (${t})`}))}})),i[e.nlsKey]=r;let n=[];Array.isArray(e.object)?e.object.forEach((e=>{n.push(y(e,r))})):n=y(e.object,r),e.dispValue=n}}})),Object.assign(t,i)}(e,t),i()},onFailure:function(e){console.warn("IP Cannot retrieve NLS"),i()}})}))}function j(e){let t=[],i="";return e.object.forEach((e=>{i=""===i?e:i+","+e,t.push(i)})),t}let x={getFiltedSubjects:function(e){let t=o[e].getCurrentFilter(),i=o[e].getCurrentFilter(),r=t.allfilters&&t.allfilters.condition?t.allfilters.condition:[],n={};i&&i.allfilters&&i.allfilters.condition&&i.allfilters.condition.forEach((e=>{Object.entries(e).forEach((([e,t])=>{n[e]=t.condition}))})),i.allfilters=n;let l=[],a=[],c=[];t&&t.allfilters&&t.allfilters.condition&&t.allfilters.condition.forEach((e=>{for(const t in e){let i={property:t,operator:e[t].operator};c.push(i)}}));const f=(t,i,r,n)=>t.filter((t=>{const l=s[e][t];if(!Array.isArray(l)||0===l.length)return!1;let o=[];if(l.forEach((e=>{let t=e.object;Array.isArray(t)?o=[...o,...j(e)]:o.push(t)})),i=i.map((e=>Array.isArray(e)?e.join(","):e)),n)return i.every((e=>!o.includes(e)));if("OR"===r)return i.some((e=>o.includes(e)));if("AND"===r)return i.every((e=>o.includes(e)));if("XOR"===r){return 1===i.filter((e=>o.includes(e))).length}return!1}));if(0===r.length)s[e]&&(l=Object.keys(s[e]));else{let t={};Object.values(n).flat().map((e=>{let i;i=Array.isArray(e.object)?e.object.join(","):e.object,Array.isArray(t[e.predicates[0].predicate])||(t[e.predicates[0].predicate]=[]),t[e.predicates[0].predicate].push(i)})),l=Object.keys(s[e]).filter((i=>Array.isArray(s[e][i])&&s[e][i].some((e=>{if(t[e.sixw]){if(Array.isArray(e.object)){return j(e).filter((i=>t[e.sixw].includes(i))).length>0}return t[e.sixw].includes(e.object)}return!1}))))}let u=[];if(l.length>0&&c.forEach((({property:t,operator:i})=>{if(n[t]){const r=n[t],o=r.filter((e=>e.hasOwnProperty("excluded")&&e.excluded));if(u=r.filter((e=>!e.hasOwnProperty("excluded")||!e.excluded)),o.length>0){const t=o.map((e=>e.object));a=a.concat(f(Object.keys(s[e]),t,i,!1))}if(u.length>0){const e=u.map((e=>e.object));l=f(l,e,i,!1)}}})),l=l.filter((e=>!a.includes(e))),a.length>0&&0===u.length&&s[e]&&"object"==typeof s[e]){const t=Object.keys(s[e]).filter((t=>Array.isArray(s[e][t])&&s[e][t].length>0)).filter((e=>!a.includes(e)));l=t}let d={id:"taggerFilter",content:{ids:l,idPrefix:"pid://",xIDs:a}},g=i.allfilters?Object.keys(i.allfilters):[],h=i.localfilters?Object.keys(i.localfilters):[];return 0===g.length&&0===h.length&&(d.content.ids=Object.keys(s[e])||[]),{filterOptions:d,currentFilter:i}},setTagProxy:function(e,t,i,r,n){o||(o={});o[e]&&(o[e].unsetTags(),s[e]={}),this._callSetupProxy(e,t,i,r,n)},_callSetupProxy:function(e,t,i,r,n){let l=[];if(i.length>d){let e=Math.floor(i.length/d);for(let t=0;t<e;t++){let e=i.slice(t*d,(t+1)*d);l.push(e)}if(i.length%d>0){let t=i.slice(e*d);l.push(t)}}else l.push(i);a[e]=new Promise(((i,o)=>{!function o(a){l.length>a?p(e,t,l[a],r,n,(function(){o(a+1)})):(x.createSummaryData(e,s[e]),i())}(0)}))},getTagProxy:function(e){return o[e]?o[e]:null},publishTags:function(e,t){o[e]&&!0===o[e]._attributes.isAlive&&o[e].setTags(s[e],t)},filterTags:function(e,t,i){let r=o[e],n=[],l=f[e].subjectPrefix||"";if(r&&!0===r._attributes.isAlive&&s[e]){let i={};if(t&&t.length>0)for(let r=0;r<t.length;r++)s[e].hasOwnProperty(l+t[r])&&(i[l+t[r]]=s[e][l+t[r]]);x.createSummaryData(e,i)}i&&setTimeout((function(){n.forEach((e=>{r.addEvent("onFilterChange",e)}))}),200)},createSummaryData:function(e,t){let i=t?Object.values(t):[],r=i?i.flat():[],n={};r.forEach((e=>{let t=e.object+"|"+e.sixw;n[t]?n[t].count++:n[t]={...e,count:1}}));let l=Object.values(n);b(l).then((()=>{c[e]=l,x.publishTags(e,l)}))},focusOnSubjects:function(e,t){let i=f[e].subjectPrefix||"";if(o[e]&&!0===o[e]._attributes.isAlive&&s[e]){let r=[],n={};if(t&&t.length>0)for(let l=0;l<t.length;l++)if(s[e].hasOwnProperty(i+t[l])){let e=i+t[l];r.push(e),n[e]="3DSpace"}o[e].focusOnSubjects(r,!0,n)}},removeSubjects:function(e,t){try{t.forEach((t=>{delete s[e][f[e].subjectPrefix+t]}))}catch(e){UWA.log(e)}},unfocus:function(e){o[e]&&o[e].unfocus()},setLocalFilter:function(e,t){if(UWA.is(t,"object")&&o[e]&&!0===o[e]._attributes.isAlive){let i=!0;o[e].setLocalFilter(t,i)}},killTagProxy:function(e){o[e]&&(o[e].deactivate(),o[e].unsetTags(),o[e].die(),o[e]=void 0,s[e]=void 0,delete o[e],delete s[e])},killAllTagProxy:function(){let e=this;Object.keys(o).forEach((function(t){e.killTagProxy(t)}))},activate:function(e,t){let i=this;if(t&&t.deactivateOthers&&Object.keys(o).forEach((function(t){t&&t!==e&&i.deactivate(t)})),o[e]&&(o[e].activate(),!c[e]||c[e]&&0==c[e].length)){c[e];o[e].setTags([])}},deactivate:function(e){o[e]&&(o[e].deactivate(),o[e].unfocus())},deactivateAll:function(){let e=this;Object.keys(o).forEach((function(t){e.deactivate(t)}))},unsetTags:function(e){o[e]&&o[e].unsetTags()}};return x}));