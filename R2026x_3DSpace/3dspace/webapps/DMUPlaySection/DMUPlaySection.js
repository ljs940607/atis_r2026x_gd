define("DS/DMUPlaySection/DMUClippingRobot",["UWA/Class","DS/DMUMeasurable/DMUManipulableClippingPlane","DS/DMUMeasurable/DMUToolsMaths","DS/Visualization/ThreeJS_DS","DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUMeasurable/DMUMeasurable","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUSwitchRepService","DS/DMUMeasurable/DMUSectionPosService","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/Ruler/Ruler","DS/Robot/LineTranslationNode","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/DMUMeasurable/DMUPreVisuNode3D","DS/DMUMeasurable/DMUMeasureEnums"],(function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,f,v,m,h,S,C,b,M,y,P,w,D,x){"use strict";return e.extend({init:function(e,A){this._parent();var V,N,_,R,O=e,T=O.getFrameWindow(),E=T.getViewer(),U=v,I=m,B=h,k=O.getAppType(),L=new g({viewer:E}),F=!1,z=!1,W=!1,G=!1,H=!1;this.isManipulationOnGo=function(){return W||H||G};var j=O.manipulationInformationCB,X={clearTimeout:void 0,lockedNodeIds:[]};function Y(){X&&X.clearTimeout&&(X.clearTimeout(),X.clearTimeout=void 0)}function J(){L&&X&&(L.unlockNodes({nodeIDsToUnlock:X.lockedNodeIds,nodeIDsToUnlockMeshInRAM:X.lockedNodeIds}),X.lockedNodeIds=[])}var Z,q,Q,K,$,ee,te,ie,ne,oe=this,re=[],ae={origin:new n.Vector3,initOrigin:new n.Vector3,direction:null,initValue:null,value:null,origin3D:null},le={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},se=function(){var e=(new n.Vector3).copy(O.getUDirection()),t=(new n.Vector3).copy(O.getVDirection()),i=(new n.Vector3).copy(O.getNormal()),o=(new n.Matrix4).makeBasis(e,t,i.negate()),r=(new n.Vector3).copy(O.getCenter());return o.setPosition(r),o},ce=!1,ue=function(e){var t=e;if(t){var i=t.clone().normalize(),n=.9995;i.x>n||i.y>n||i.z>n?t=i:(-i.x>n||-i.y>n||-i.z>n)&&(ce=!0,t=i.negate())}return t},pe=function(){return s.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value},ge=function(){return s.readPreferences({name:"cke",PreferenceNames:["Angle"]}).preferences[0].value},de=function(e){ne=null;var t=new n.Vector3,i=new n.Vector3,o=new n.Vector3,r=.9995;return e.extractBasis(t,i,o),o.x>r||-o.x>r||o.y>r||-o.y>r||o.z>r||-o.z>r?(ne=new n.Vector3(0,0,0),ie=ne.clone()):(ne=(new n.Vector3).getPositionFromMatrix(e),ie=ne.clone()),ne};A?(ie=A,ne=A):de(se()),this._getRulerOriginPos=function(){return ie?ie.clone():ie};var fe=function(e){var t=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"mesh",!1);if(0!==t.path.length&&t.path[0]){var i,o=t.path[0];return(i=o&&o.getWorldMatrix?(new n.Vector3).getPositionFromMatrix(o.getWorldMatrix()):new n.Vector3(0,0,0))&&(ae.origin3D=i.clone(),ie=i.clone(),ne=i.clone()),o?{origin3D:i}:void 0}};this._setFilterVisibility=function(e){N&&N.setVisibleFlag&&N.setVisibleFlag(e&&!O.isClippingPanelActive())},this.buildRobot=function(){if(!V){W=!1,G=!1,H=!1;var e=E.picking.primitive,s=E.pPicking.primitive,g={},v={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},m=function(e){var t,i,o,r,a,l,s=e.clone();return t=(s=s.negate()).x,i=s.y,o=s.z,r=Math.abs(t),a=Math.abs(i),l=Math.abs(o),r>=a&&r>=l?t>0?new n.Vector3(1,0,0):new n.Vector3(-1,0,0):a>r&&a>=l?i>0?new n.Vector3(0,1,0):new n.Vector3(0,-1,0):l>r&&l>a?o>0?new n.Vector3(0,0,1):new n.Vector3(0,0,-1):s},h=function(e){e&&(e.drawMode="Section",oe._preVisuNode?oe._preVisuNode.buildPreVisuNode({data:e}):(oe._preVisuNode=new D(E),oe._preVisuNode.buildPreVisuNode({data:e}),oe._preVisuNode.setNoZ(!0),oe._preVisuNode.setPickable(P.PICKTHROUGH),E&&(b.getSceneRoot(E).add(oe._preVisuNode),E.render())),oe._preVisuNode.setVisibility(E.getVisibleSpace()))},S=function(){oe._preVisuNode&&(b.getSceneRoot(E).remove(oe._preVisuNode),E.render(),oe._preVisuNode.removeChildren(),oe._preVisuNode.remove(),oe._preVisuNode=void 0)},C=function(e){var t=(new n.Matrix4).copy(K),i=(new n.Matrix4).setPosition((new n.Vector3).getPositionFromMatrix($)),o=(new n.Matrix4).getInverse(i).multiply(t),r=(new n.Matrix4).copy(e).multiply(o),a=(new n.Matrix4).copy(i).multiply(r);O.setPlaneGeometryCB({referential:a})};V=new o({frameWindow:T,lightDisplay:"3dPlay"===k,getRulerUnitCB:pe,getAngularRulerUnitCB:ge,checkDirforRuler:ue,disablePickingDuringManipulation:!0});var y=se();V.setPosition({robotMatrix:y,translationRulerOrigin:de(y)}),ae.origin3D=ne;var w=O.getCenter();ae.origin=w.clone(),ae.initOrigin=w.clone(),ae.baseOrigin=w.clone(),V.setVisibility(!0),V.robotOrigin3DCompute=fe,V.moveRulerOrigin=function(){O.setClippingRepVisibility(!1),j({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})},V.moveRulerOriginEnd=function(){O.setClippingRepVisibility(!0)},V.robotMatrixCompute||(V.robotMatrixCompute=function(e){Y(),z=!0,_&&U.remove({pathElement:_});var t=l.getViewpointInfo(E.currentViewpoint),i=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"primHybrid",!0);if(i.path.length>0&&i.path[0]&&L&&(v.none||!(A(!0)||0===v.point&&0===v.center&&0===v.axisSystem&&0===v.line&&0===v.plane&&0===v.cylinder&&1===v.surface))){var o=L.switchToAV1({path:i.path[0],lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){X.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(X.lockedNodeIds||(X.lockedNodeIds=[]),t.forEach((function(e){-1===X.lockedNodeIds.indexOf(e)&&X.lockedNodeIds.push(e)})))},onFailureCB:function(){X.clearTimeout=void 0}});if(o&&o.clearTimeout&&(X.clearTimeout=o.clearTimeout),o&&o.nodeIDsOfAlreadyLoadedNode&&o.nodeIDsOfAlreadyLoadedNode.length){var r=[];o.nodeIDsOfAlreadyLoadedNode.forEach((function(e){-1===X.lockedNodeIds.indexOf(e)&&(r.push(e),X.lockedNodeIds.push(e)),r&&r.length&&(L.lockNodes({nodeIDsTolock:r,nodeIDsTolockMeshInRAM:r}),r=[])}))}}if(0!==i.path.length&&i.path[0]&&i.position){g.axisX=void 0,g.axisY=void 0,g.axisZ=void 0,g.position=void 0;var a,s,d=i.path[0];i.normal&&(a=i.normal),i.position&&(s=i.position);var f=!1,C={};if(v.none||v.axisSystem||A()){var M=d,y=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var i=e.externalPath[t];if(b.isPLMNode(i))break;if("AxisSystems"===i.name)return t}return 0}(M);if(y||A()){if(t&&t.sight){var P;if(v.none||v.axisSystem){M&&M.getWorldMatrix?P=M.getWorldMatrix():(P=(new n.Matrix4).makeBasis(new n.Vector3(1,0,0),new n.Vector3(0,1,0),new n.Vector3(0,0,1))).setPosition(new n.Vector3(0,0,0));var w=M.externalPath[y+1];if(Boolean(w)&&Boolean(w.getMatrixWorld())){for(var D=new B,V=0;V<=y+1;V++)D.addElement(M.externalPath[V]);var N=D.getWorldMatrix();N&&(P=N)}for(var O=[],T=0;T<y+2;T++){var k=M.externalPath[T];O.push(k)}O.length&&(_=new B(O),U.add({pathElement:_}))}else{var W=d;P=W.getWorldMatrix(),A()&&(W=function(e){var t=e;return e.pathElement=new B,t.externalPath.some((function(t){return e.pathElement.addElement(t),t&&b.is3DLeaf(t)})),t.internalPath.length>0&&(e.originalPathElement=t),e}(d),P=W.getWorldMatrix())}var G=P.clone(),H=new n.Vector3,j=new n.Vector3,J=new n.Vector3;if(G.extractBasis(H,j,J),s=(new n.Vector3).getPositionFromMatrix(G),a=function(e,t,i,n){if(e||t&&i&&n){var o,r=t,a=void 0,l=e.clone();return l=l.negate(),t&&(a=o=l.angleTo(t),r=t),i&&(o=l.angleTo(i))<a&&(a=o,r=i),n&&(o=l.angleTo(n))<a&&(a=o,r=n),r}}(t.sight,H,j,J),a&&(a.equals(H.clone())||a.equals(H.clone().negate())?(C.axis1=j,C.axis2=J):a.equals(j.clone())||a.equals(j.clone().negate())?(C.axis1=H,C.axis2=J):(a.equals(J.clone())||a.equals(J.clone().negate()))&&(C.axis1=j,C.axis2=H)),A()){var Z=[],q=(new n.Matrix4).makeBasis(C.axis1,C.axis2,a);q.setPosition(s),Z.worldMatrix=q,Z.resultType=x.ResultType.PRODUCT,h(Z)}f=!0}f||(a=void 0,s=void 0,f=!0)}}var Q,K,$=b.isOOCTileSetNodeInPath(d);if(d&&!f&&(d.getLastElement().sgNode||$)){var ee;if($){var te=(new n.Matrix4).getInverse(d.getWorldMatrix()),ie=i.position,ne=ie.clone().applyMatrix4(te);ee=new c({canonic:{type:p.GeometryType.POINT,position:ne},pathElement:d,selpoint:ie})}else ee=new c({primitive:d.getLastElement().sgNode,pathElement:d,selpoint:i.position});var re=ee.getType();switch(oe._preVisuNode&&R!==re&&S(),re){case p.GeometryType.POINT:z=!1,v.none||v.point?(h(ee),t&&t.sight&&(a=m(t.sight))):(a=void 0,s=void 0);break;case p.GeometryType.LINE:if(z=!1,v.none||v.line){if(h(ee),t&&t.sight){var ae=ee.getPoints(),le=new n.Vector3;le.subVectors(ae.beginPoint,ae.endPoint).normalize();var se=le.dot(t.sight);a=le.multiplyScalar(se>0?1:-1).negate(),s=i.position}}else a=void 0,s=void 0;break;case p.GeometryType.CIRCLE:z=!1,v.none||v.center?(h(ee),t&&t.sight&&(a=m(t.sight)),s=ee.getCenter()):(a=void 0,s=void 0);break;case p.GeometryType.SPHERE:case p.GeometryType.SURFACE:case p.GeometryType.PLANE:if(re===p.GeometryType.SPHERE&&!v.surface)break;var ce=i.normal;if(!ce.length()&&re===p.GeometryType.PLANE){let e=ee.getPlane();e&&e.normal&&(ce=ee.getPlane().normal)}if(v.none||v.plane||v.surface){if(v.none&&re===p.GeometryType.SURFACE||v.surface&&(!v.plane||re===p.GeometryType.SURFACE))ee.normal=ce,ee.resultType=x.ResultType.SURFACE,F=!1,R===re&&(F=!0),R=re,ee.onlyUpdatePos=F;else if(v.plane&&!v.surface&&re!==p.GeometryType.PLANE){a=void 0,s=void 0;break}h(ee),a=ce}else a=void 0,s=void 0;break;case p.GeometryType.CYLINDER:case p.GeometryType.CONE:if(v.none||v.cylinder){h(ee),a=i.normal;var ue=ee.getPoints(),pe=i.position.toArray(),ge=ue.beginPoint.toArray(),de=ee.getAxis().toArray(),fe=a.toArray(),ve=u.computeTwoLinesDistance(pe,fe,ge,de).aPosition2;s=new n.Vector3(ve[0],ve[1],ve[2])}else v.surface?(F=!1,R===re&&(F=!0),R=re,ee.onlyUpdatePos=F,ee.resultType=x.ResultType.SURFACE,ee.normal=i.normal,h(ee),s=i.position,a=i.normal):(a=void 0,s=void 0);break;default:a=void 0,s=void 0}}else if(!f&&(v.surface||v.none)){var me=[];me.normal=i.normal;var he=i.position;me.getSelPoint=function(){return he},me.resultType=x.ResultType.SURFACE,F=!1,R===x.ResultType.SURFACE&&(F=!0),R=x.ResultType.SURFACE,me.onlyUpdatePos=F,h(me)}if(!a||!s)return E.setPicking({displayHL:!1}),E.setPrePicking({displayHL:!1}),void(d&&(U.empty(),I.empty()));if(E.setPicking({displayHL:!0}),E.setPrePicking({displayHL:!0}),a.negate(),a.normalize(),f&&C&&C.axis1&&C.axis2)Q=C.axis1,K=C.axis2;else{var Se=b.getXYAxisDirFromZ(a.clone());Se.xDir&&Se.yDir&&(Q=Se.xDir,K=Se.yDir)}g.axisX=Q.clone(),g.axisY=K.clone(),g.axisZ=a.clone(),g.position=s.clone();var Ce=(new n.Matrix4).makeBasis(Q,K,a.negate()),be=(new n.Vector3).copy(s);return Ce.setPosition(be),{robotMatrix:Ce}}oe._preVisuNode&&S()}),function(){V.moveBegin=function(e){oe.clearRulers(),H=!0,"translation"===e.kind?function(e){if(W=!0,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){oe._setFilterVisibility(!0);var i=O.getPlaneGeometryCB();K=(new n.Matrix4).copy(i.referential),$=e.robotMatrix,j({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):function(e){if(W=!0,oe._setFilterVisibility(!0),j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=O.getPlaneGeometryCB();K=(new n.Matrix4).copy(i.referential),"ruler"===e.from&&"rotation"===e.kind&&K.setPosition(O.getCenter()),$=e.robotMatrix,j({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)},V.move=function(e){H=!0,e&&("ruler"===e.from?"translation"===e.kind?function(e){if(W=!0,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=O.getCenter(!0),n=O.getPlaneGeometryCB().referential;n.setPosition(i.clone().add(e.translationVector)),O.setPlaneGeometryCB({referential:n}),j({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):(!function(e){if(W=!0,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var n,o=e.axis.clone().dot(O.getUDirection()),r=e.axis.clone().dot(O.getVDirection()),a=e.axis.clone().dot(O.getNormal().clone().negate()),l=i.areEqual(Math.abs(r),1,"float"),s=i.areEqual(Math.abs(o),1,"float");l?(n=i.isLessOrEqual(r,0)?-e.rotationAngle:e.rotationAngle,K=K.rotateY(n)):s?(n=i.isLessOrEqual(o,0)?-e.rotationAngle:e.rotationAngle,K=K.rotateX(n)):(n=i.isLessOrEqual(a,0)?e.rotationAngle:-e.rotationAngle,K=K.rotateZ(n)),O.setPlaneGeometryCB({referential:K,toRelocate:!0}),j({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.ROTATION,evt:e.event})}}(e),de(e.robotMatrix)):"robot"===e.from&&("translation"===e.kind?function(e){if(W=!0,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=(new n.Matrix4).makeTranslation(e.translationVector.x,e.translationVector.y,e.translationVector.z);C(i),j({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):(!function(e){if(W=!0,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=e.axis,o=e.rotationAngle,r=(new n.Matrix4).makeRotationAxis(i,o);C(r),j({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.ROTATION,evt:e.event})}}(e),de(e.robotMatrix))))},V.moveEnd=function(e){"translation"===e.kind?function(e){j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})&&(K=void 0,$=void 0),j({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:e.event}),W=!1}(e):function(e){W=!1,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})&&(K=void 0,$=void 0);var i=se();V.setPosition({robotMatrix:i,translationRulerOrigin:de(i),doNotResetRuler:1}),ae.origin3D=ne,j({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.ROTATION,evt:e.event})}(e),H=!1};V.moveRobotBegin=function(i){V.disablePickingDuringManipulation&&V.disablePickingDuringManipulation(!1),Y(),oe.clearRulers(),W=!0,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:i.event})&&(A()||(e=E.picking.primitive,s=E.pPicking.primitive,1!==e&&E.setPicking({primitive:1}),1!==s&&E.setPrePicking({primitive:1})),O.setClippingRepVisibility(!1),j({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:i.event}))},V.moveRobot=function(e){W=!0,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:e.event})&&(O.setClippingRepVisibility(!1),j({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:e.event}))},V.moveRobotEnd=function(i){if(V.disablePickingDuringManipulation&&V.disablePickingDuringManipulation(!0),W=!1,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER})){oe._preVisuNode&&S(),O.setClippingRepVisibility(!0);var o,r,a=O.getPlaneGeometryCB().referential;if(g.axisX&&g.axisY&&g.axisZ&&g.position){if(a.makeBasis(g.axisX,g.axisY,g.axisZ),a.setPosition(g.position),!O.isBoxMode||!O.isBoxMode()){var l=M.computeBoundingBox(E),c=d.computePlaneDim(l,a,z);c&&(c.fPlaneSizeV&&c.fPlaneSizeU&&(o=c.fPlaneSizeU,r=c.fPlaneSizeV),c.plane&&((a=c.plane).extractBasis(g.axisX,g.axisY,g.axisZ),g.position=(new n.Vector3).getPositionFromMatrix(a)))}var u=O.computePlaneCenter(a);u&&a.setPosition(u),O.setPlaneGeometryCB({referential:a,uSize:o,vSize:r,uStep:o?o/20:void 0,vStep:r?r/20:void 0});var p=(new n.Matrix4).makeBasis(g.axisX,g.axisY,g.axisZ.clone().negate()),f=(new n.Vector3).copy(g.position);p.setPosition(f),V.setPosition({robotMatrix:p,translationRulerOrigin:de(p)});var v=(new n.Vector3).getPositionFromMatrix(p);ae.origin=v.clone(),ae.initOrigin=v.clone(),ae.baseOrigin=v.clone(),ae.origin3D=ne}}A()||(E.setPicking({primitive:e}),E.setPrePicking({primitive:s})),j({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.CENTER,evt:i.event}),Y(),J(),R=void 0,F=!1}}(),function(){var e=localStorage.getItem("SectionSelectionFilter");e&&12===e.length&&e.startsWith("0-")&&(v.point="1"===e.charAt(2)?1:0,v.center="1"===e.charAt(3)?1:0,v.axisSystem="1"===e.charAt(4)?1:0,v.line="1"===e.charAt(5)?1:0,v.plane="1"===e.charAt(6)?1:0,v.cylinder="1"===e.charAt(7)?1:0,v.surface="1"===e.charAt(8)?1:0,v.product="1"===e.charAt(9)?1:0,0===v.point&&0===v.center&&0===v.axisSystem&&0===v.line&&0===v.plane&&0===v.cylinder&&0===v.surface&0===v.product?v.none=1:v.none=0);var t=function(){if(N){v={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},N.getActiveState("point")&&(v.none=0,v.point=1),N.getActiveState("center")&&(v.none=0,v.center=1),N.getActiveState("axisSystem")&&(v.none=0,v.axisSystem=1),N.getActiveState("line")&&(v.none=0,v.line=1),N.getActiveState("plane")&&(v.none=0,v.plane=1),N.getActiveState("cylinder")&&(v.none=0,v.cylinder=1),N.getActiveState("surface")&&(v.none=0,v.surface=1),N.getActiveState("product")&&(v.none=0,v.product=1);var e="0-"+v.point+v.center+v.axisSystem+v.line+v.plane+v.cylinder+v.surface+v.product+"-1";localStorage.setItem("SectionSelectionFilter",e)}};if(!N){var i={};i.point=f.point,i.center=f.center,i.axisSystem=f.axisSystem,i.line=f.line,i.plane=f.plane,i.cylinder=f.cylinder,i.surface=f.surface,i.product=f.product;var n=a.getWebappsAssetUrl("DMUMeasure","icons/32/");(N=new r({body:T.getUIFrame(),frmWindow:T,Idpanel:"SectionSelectionFilter",classpanel:"SectionSelectionFilter",typeSeparator:"bubble",verticalPanel:!0,lJsonElement:[{type:"element",id:"point",nls:i.point,url:n+"I_Meas_Point.png",callback:t,bexclude:!1,bstateActif:v.point},{type:"element",id:"center",nls:i.center,url:n+"I_Meas_PointCircle.png",callback:t,bexclude:!1,bstateActif:v.center},{type:"element",id:"axisSystem",nls:i.axisSystem,url:n+"I_Meas_Axis.png",callback:t,bexclude:!1,bstateActif:v.axisSystem},{type:"element",id:"line",nls:i.line,url:n+"I_Meas_Line.png",callback:t,bexclude:!1,bstateActif:v.line},{type:"element",id:"plane",nls:i.plane,url:n+"I_Meas_Plane.png",callback:t,bexclude:!1,bstateActif:v.plane},{type:"element",id:"cylinder",nls:i.cylinder,url:n+"I_Meas_Cylinder.png",callback:t,bexclude:!1,bstateActif:v.cylinder},{type:"element",id:"surface",nls:i.surface,url:n+"I_Meas_Surface.png",callback:t,bexclude:!1,bstateActif:v.surface},{type:"element",id:"product",nls:i.product,url:n+"I_Meas_Product.png",callback:t,bexclude:!1,bstateActif:v.product}]}))&&(N.build(),oe._setFilterVisibility(!0))}}()}function A(e){return!(1!==v.product||0!==v.point||0!==v.center||0!==v.axisSystem||0!==v.line||0!==v.plane||0!==v.cylinder||!e&&0!==v.surface)}};var ve=function(){(Z=new S(T,{displayOrigin:!1,offset:20,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:"3dPlay"===k})).setVisibilityFree(!0);var e,i,o;(re=[]).push(Z.subscribe("OriginManipulateBegin",(function(){e=Z.displayOrigin,i=(Z.origin3DPos||Z.origin).clone()}))),Z.onOriginManipulator=function(n){if(o=null,fe){var r=fe({event:n.event,viewer:E});(o=r&&r.origin3D)&&j({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})}return Z.displayOrigin=e,o?(Z.displayOrigin=!0,O&&O.setClippingRepVisibility(!1),o.clone()):i},re.push(Z.subscribe("OriginManipulateEnd",(function(){V&&V.setPosition({translationRulerOrigin:o?o.clone():o}),ae.origin3D=o?o.clone():o,O&&O.setClippingRepVisibility(!0)}))),re.push(Z.subscribe("RulerManipulateBegin",(function(e){var i;i=e,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&(V&&V.setVisibility(!1),j({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:i.event}))}))),re.push(Z.subscribe("RulerManipulate",(function(e){!function(e){if(j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=O.getPlaneGeometryCB().referential,o=(new n.Vector3).getPositionFromMatrix(i);i.setPosition(o.clone().add(e.translationVector)),O.setPlaneGeometryCB({referential:i}),j({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}oe.updateRobotPos()}(e)}))),re.push(Z.subscribe("RulerManipulateEnd",(function(e){var i;i=e,j({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&V&&V.setVisibility(!0),j({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:i.event}),oe.updateRobotPos()})))};return this.clean=function(){this.isManipulationOnGo()||(ce=!1,V&&(V.destroy(),V=null),N&&(N.clear(),N=null),ee&&(E.removeNode(ee),ee.removeChildren(),ee.remove(),ee=void 0),Z&&re&&re.length>0&&(re.forEach((function(e){Z.unsubscribe(e)})),re=[]),Y(),J(),this.clearRulers())},this.setPickable=function(e){V&&V.setPickable(e)},this.update=function(e){void 0!==e&&"boolean"==typeof e&&(void 0===e||H||V.setVisibility(!e),oe._setFilterVisibility(!e))},this.updateRobotPos=function(e,t){if(V){var i=!1;E.getVisibleSpace()||(i=!0),oe.update(i);var n=se();if(t?V.setPosition({robotMatrix:n,translationRulerOrigin:de(n),doNotResetRuler:W}):V.setPosition({robotMatrix:n,doNotResetRuler:W}),t){var o=O.getCenter();ae.origin=o.clone(),ae.initOrigin=o.clone(),ae.baseOrigin=o.clone(),ae.origin3D=ne}}e&&oe.clearRulers()},this.updateOnTranslationBegin=function(e){if(G=!0,ce=!1,Q=e.intersection.position,this.clearAngularRuler(),Z||ve(),!ee){ee=new w;var t={position:new n.Vector3(0,0,0),touchMode:!1},i=new y({name:"fixedSizeNode3D",ratio:7}),o=new C(t);o.name="arrowTranslationNode",o.mat.color=new n.Color("#1B6E9C"),o.mat.opacity=1,o.setNoZ(!0),i.addChild(o),E&&ee&&(ee.addChild(i),E.addNode(ee),E.render({forceDynamicMode:!0}))}ee&&(ee.setMatrix(se().setPosition(Q.clone())),ee.setVisibilityInTree(!1),ee.setVisibility(E.getVisibleSpace()),ee.setPickable(P.PICKTHROUGH));var r=(new n.Vector3).copy(e.manipulator.axis).negate();r=ue(r);var a=O.getCenter().clone(),l=(new n.Vector3).copy(r).multiplyScalar((new n.Vector3).copy(ae.baseOrigin).sub(a).dot(r));ae.initOrigin=(new n.Vector3).copy(a).add(l);var s=(new n.Vector3).copy(ae.initOrigin);ae.origin3D&&(s=new n.Line3(ae.initOrigin,(new n.Vector3).copy(ae.initOrigin).add(r)).closestPointToPoint(ae.origin3D,!1));ae.origin=s;var c=(new n.Vector3).copy(ae.origin).sub(a).dot(r);if(ae.direction=r,ae.value=s.distanceTo(a)*(c>0?-1:1),ae.initValue=ae.value,Z){var u=r.clone().negate().normalize().multiplyScalar(ae.value);Z.origin=Q.clone().add(u),Z.origin3DPos=ae.origin3D,te=ae.value,Z.initOrigin=ae.initOrigin,Z.setValue(ae.value),Z.direction=ae.direction,Z.initValue=ae.initValue,Z.displayOrigin=Boolean(ae.origin3D),Z.unit=pe(),Z.display(),Z.beginManipulation()}this.updateRobotPos(),V&&!H&&V.setVisibility(!0)},this.snapTranslationCallback=function(e){var t=e.translationVector;if(Z){var i=Z.getSnappedTranslationVector(e);0===i.returnCode&&(t=i.snappedTranslationVector)}return t},this.snapRotationCallback=function(e){var t={value:180*e.angle/Math.PI,axis:e.axis};return le&&le.direction&&le.direction.dot(e.axis)<0&&(t.value=360-t.value),t},this.updateOnTranslation=function(e){if(G=!0,Z){var t=ae.value;ae.value=ae.initValue+e.translationVector.length()*(ae.direction.dot(e.translationVector)>0?1:-1),Z.setValue(ae.value);var i=se(),o=new n.Vector3,r=new n.Vector3,a=new n.Vector3;t&&t>ae.value&&(i.extractBasis(o,r,a),a.negate(),i.makeBasis(o,r,a));var l=(new n.Vector3).copy(e.manipulator.axis).normalize(),s=te-ae.value;ce&&(i.extractBasis(o,r,a),a.negate(),i.makeBasis(o,r,a),s=ae.value-te);var c=l.multiplyScalar(s),u=Q.clone().add(c);ee.setMatrix(i.setPosition(u.clone()))}else!Z&&e.intersection&&e.manipulator&&this.updateOnTranslationBegin({intersection:e.intersection,manipulator:e.manipulator});this.updateRobotPos()},this.updateOnTranslationEnd=function(){ce=!1,G=!1,V&&!H&&V.setVisibility(!0),ee&&ee.setVisibility(!E.getVisibleSpace()),Z&&(Z.endManipulation(),Z.display()),ee&&(E.removeNode(ee),ee.removeChildren(),ee.remove(),ee=void 0),Q=void 0},this.clearRulers=function(){this.clearLinearRuler(),this.clearAngularRuler()},this.clearLinearRuler=function(){Z&&Z.clear()},this.clearAngularRuler=function(){q},this}})})),define("DS/DMUPlaySection/DMUSectionImport",["UWA/Class"],(function(e){"use strict";return e.extend({init:function(e){this.importData=function(t,i,n){t&&i&&e&&("Clipping"===t.type&&t.PropertiesSection&&!t.PropertiesSection.Hatching&&(t.PropertiesSection.Hatching={},t.PropertiesSection.Hatching.Display=!1),i.fillObjectAttributes(e,t,n),i.registerForPostImport(e))},this.afterImport=function(){e&&e.fireEvent("onDMUObjectInitialized",{dmuObject:e})}}})})),define("DS/DMUPlaySection/DMUStoreyNavigratorController",["UWA/Class","DS/PADUtils/PADSettingsMgt","DS/CAT3DWebStoreyComponents/CAT3DWebStoreyNavigatorControler"],(function(e,t,i){"use strict";var n,o=[],r=[];function a(e,t,i){e&&t&&r.push({buildingRootID:t,storeyInfo:"NoData",context:e}),i&&i()}function l(e,t){if(!t||!e||!e.context)var i;e&&e.getBuidlingRootID&&(i=e.getBuidlingRootID(),t.SetRootForStoreys([i]));var n=e.context,o=e.storyeRetrivalFailCB;t.GetStoreys().then((function(l){if(l&&l.length){let o;i&&function(e){let t=!1;if(e.context&&e.buildingRootID){for(var i=0;i<r.length;i++)r[i].context===e.context&&(r[i].buildingRootID===e.buildingRootID?(t=!0,r[i].storeyInfo=e.storeyInfo,r[i].isActive=e.isActive):r[i].isActive=!1);t||r.push(e)}}({buildingRootID:i,storeyInfo:l,context:e.context,isActive:!0}),n&&n.getFrameWindow&&(o=n.getFrameWindow()),t.CreateStoreyNavigator({frameWindow:o,viewer:n}),e.storyeRetrivalSuccessCB&&e.storyeRetrivalSuccessCB(t)}else a(n,i,o)}),(function(){a(n,i,o)}))}return e.singleton({init:function(){i||window.require(["DS/CAT3DWebStoreyComponents/CAT3DWebStoreyNavigatorControler"],(function(e){i=e}))},getDMUStoreyNavigratorController:function(e){var n=this.giveDMUStoreyNavigratorController(e);if(!n&&e&&e.context&&i){let r,a=e.context;a&&a.getFrameWindow&&(r=a.getFrameWindow()),n=new i({securityContext:t.getSetting("pad_security_ctx"),frameWindow:r,viewer:a}),o.push({context:e.context,storeyNavigratorController:n}),l(e,n)}return n?Object.freeze(n):n},initNavigatoreUI:function(e){if(e&&e.context){var t=e.storeyNavigatorControler?e.storeyNavigatorControle:this.giveDMUStoreyNavigratorController(e);t?l(e,t):t=this.getDMUStoreyNavigratorController(e)}},giveDMUStoreyNavigratorController:function(e){var t;if(e&&e.context)for(var i=0;i<o.length;i++)if(o[i].context===e.context){t=o[i].storeyNavigratorController;break}return t?Object.freeze(t):t},getStoreyInfo:function(e,t){if(e&&t){for(var i,n=0;n<r.length;n++)r[n].context===t&&r[n].buildingRootID===e&&r[n].isActive&&(i=r[n].storeyInfo);return i}},isNoDataOnStoreyOfRoot:function(e,t){let i=!1;if(!e||!t)return i;for(var n=0;n<r.length;n++)r[n].context===t&&r[n].buildingRootID===e&&(i="NoData"===r[n].storeyInfo);return i},clearStoreyNavigratorController:function(e){if(e&&e.context){for(var t=0;t<o.length;t++)if(o[t].context===e.context){o[t].storeyNavigratorController&&o[t].storeyNavigratorController.DestroyStoreyNavigator(),o.splice(t,1),n&&(n=void 0);break}!function(e){if(e)for(var t=0;t<r.length;t++)r[t].context===e&&r.splice(t,1)}(e.context)}},setActivateClippingActionFlag:function(e){n=e},getActivateClippingActionFlag:function(){return n}})})),define("DS/DMUPlaySection/DMUClippingManipulationTool",["UWA/Core","UWA/Class","DS/Controls/Slider","DS/Controls/SpinBox","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/CATWebUXPreferences/CATWebUXPreferencesManager","css!DS/DMUPlaySection/DMUPlaySection.css"],(function(e,t,i,n,o,r,a,l){"use strict";return t.extend({init:function(t){var s=t||{};this._parent(s);var c=this,u=s.iReviewContext,p=0;if(s.frameWindow&&!(isNaN(s.initValue)||isNaN(s.initMinValue)||isNaN(s.initMaxValue)||isNaN(s.initManipRange))){(s.initValue<s.initMinValue||s.initValue>s.initMaxValue)&&(s.initValue=.5*(s.initMinValue+s.initMaxValue));var g,d,f=s.viewType?s.viewType:"ExploreView";s.initStepValue=void 0!==s.initStepValue&&s.initStepValue>0?parseFloat(s.initStepValue):p/10;var v="Length",m="Millimeter",h=a.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value;if("number"==typeof s.initManipRange){var S,C,b,M;p=r.convert(s.initManipRange,v,m,h);var y={},P=f,w="ExploreView"===P,D=!0;c.bPerformRefreshOrCreate=!0;var x=new e.Element("div",{class:"DMUSectionTranslationSliderSpinnerContainer",styles:{opacity:0}}).inject(s.frameWindow.getUIFrame());s.hasCompareObject&&x.setStyles({top:"70px"});var A=1,V=r.convert(s.initMinValue,v,m,h),N=r.convert(s.initMaxValue,v,m,h);if("number"==typeof s.initStepValue){var _=Math.abs(N-V);A=s.initStepValue<_?s.initStepValue:_}var R=o.getWebappsBaseUrl()+"DMUBaseCommands/assets/icons/32/";new e.createElement("img",{class:"WebSectionImg",src:R+"I_WebClippingTool.png",styles:{left:"0px"}}).inject(x),b=e.createElement("div",{class:"TranslationSliderContainer",styles:{display:!0===w?"":"none"}}).inject(x),(S=new i({minValue:V,maxValue:N,stepValue:A,value:r.convert(s.initValue,v,m,h)}).inject(b)).getTextFromValue=function(){var e="true"===a.readPreferences({name:"cke",PreferenceNames:["TrailingZeros"]}).preferences[0].value;return a.convertUnitValueToString(v,r.convert(this.value,v,h,"Millimeter"),u,!0,!1,e)},S.addEventListener("beginEdit",(function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.beginManipulation&&s.iOwner.beginManipulation(),c.bPerformRefreshOrCreate=!0})),S.addEventListener("change",(function(){c.bPerformRefreshOrCreate=!1,s.onChangeSliderCB&&s.onChangeSliderCB(S.value),s.iOwner&&s.iOwner.doManipulation&&s.iOwner.doManipulation(),c.bPerformRefreshOrCreate=!0})),S.addEventListener("endEdit",(function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.endManipulation&&s.iOwner.endManipulation(),c.bPerformRefreshOrCreate=!0}));var O=a.readPreferences({name:"cke",PreferenceNames:["LengthDisplay"]}),T=parseFloat(O.preferences[0].value);M=e.createElement("div",{class:"TranslationSpinnerContainer",styles:{display:!1===w?"":"none"}}).inject(x),(C=new n({minValue:V,maxValue:N,stepValue:A,value:r.convert(s.initValue,v,m,h),units:r.Length[h].symbol,decimals:T}).inject(M)).elements.container.addClassName("TranslationSpinner"),C.addEventListener("beginEdit",(function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.beginManipulation&&s.iOwner.beginManipulation(),c.bPerformRefreshOrCreate=!0})),C.addEventListener("change",(function(){c.bPerformRefreshOrCreate=!1,s.onChangeSpinnerCB&&s.onChangeSpinnerCB(C.value),s.iOwner&&s.iOwner.doManipulation&&s.iOwner.doManipulation(),c.bPerformRefreshOrCreate=!0})),C.addEventListener("endEdit",(function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.endManipulation&&s.iOwner.endManipulation(),c.bPerformRefreshOrCreate=!0})),y.onFreeZoneResize||(s.frameWindow.getImmersiveFrame().addEventListener("freeZoneResize",E),y.onFreeZoneResize=1),setTimeout((function(){x&&(E(),x.setStyles({opacity:1}))}),50),this.setActiveView=function(e){"ExploreView"===e?(void 0!==b&&b.setStyle("display",""),void 0!==M&&M.setStyle("display","none"),P="ExploreView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider()):"DetailedView"===e&&(void 0!==b&&b.setStyle("display","none"),void 0!==M&&M.setStyle("display",""),P="DetailedView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider())},this.getActiveView=function(){return P},this.setValue=function(e,t){isNaN(e)||(e=r.convert(e,v,m,h),"Slider"===t&&S?(S._properties&&S._properties.value&&(S._properties.value.value=e),S._updateCursor&&S._updateCursor()):"Spinner"===t&&C&&(C.value=e))},this.getValue=function(e){return"Slider"===e&&S?S.value:"Spinner"===e&&C?C.value:void 0},this.setRangeValues=function(e,t,i){isNaN(e)||isNaN(t)||(e=r.convert(e,v,m,h),t=r.convert(t,v,m,h),"Slider"===i&&S?(S.minValue=e,S.maxValue=t):"Spinner"===i&&C&&(C.minValue=e,C.maxValue=t))},this.getRangeValues=function(e){return"Slider"===e&&S?{minValue:S.minValue,maxValue:S.maxValue}:"Spinner"===e&&C?{minValue:C.minValue,maxValue:C.maxValue}:void 0},this.getSpinnerUnit=function(){if(C)return C.units},this.getSpinnerDecimalValue=function(){if(C)return C.decimals},this.getVisibleFlag=function(e){return"Slider"===e&&b?"none"!==b.getStyle("display"):"Spinner"===e&&M?"none"!==M.getStyle("display"):D},this.setVisibleFlag=function(e){D=e,x.setStyle("display",D?"":"none")},this.update=function(e){if(null!=e){var t="Slider";"DetailedView"===P&&(t="Spinner"),void 0!==e.minValue&&void 0!==e.maxValue&&c.setRangeValues(e.minValue,e.maxValue,t),void 0!==e.value&&c.setValue(e.value,t)}},this.subscribeToPrefChangeEvt=function(e){null!=e&&(g||(g=l.givePreferenceManager({context:s.frameWindow}))&&e.event&&e.cb&&(d=g.subscribe(e.event,e.cb)))},this.unsubscribeToPrefChangeEvt=function(){g&&(d=g.unsubscribe(d)),g=d=null},this.clean=function(){t.frameWindow&&x&&x.parentNode===t.frameWindow.getUIFrame()&&t.frameWindow.getUIFrame().removeChild(x),y.onFreeZoneResize&&s.frameWindow&&s.frameWindow.getImmersiveFrame().removeEventListener("freeZoneResize",E),x=null,y={},t.iOwner&&t.iOwner._movegauge&&(t.iOwner._movegauge=null),c.unsubscribeToPrefChangeEvt()},f!==P&&this.setActiveView(f)}}function E(){if(x){var e=s.frameWindow.getImmersiveFrame().getFreeZone().getSize();if(e.width){var t=0,i=s.frameWindow.getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea),n=i.getContainedWindows();if(n&&(1===n.length&&n[0].isAWindowGroup()&&n[0].getEmbeddedWindows().length||1===n.length&&!n[0].isAWindowGroup())){for(var o=n[0].getEmbeddedWindows?n[0].getEmbeddedWindows():n,r=!1,a=0;a<o.length;a++)o[a].visibleFlag&&(r=!0);if(r&&!i.collapseDockingZoneFlag){var l=i._collapserSize;t=i.dockingZoneSize+l}}else i.interactiveDockAreaVisibleFlag&&(t=i.dockingZoneSize);let c=125;s.hasCompareObject&&(c=137.5),t+=e.width/2-c,x.setStyles({left:t+"px"})}}}}})})),define("DS/DMUPlaySection/DMUSectionPosPreVisuNode3D",["DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsAvatars","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUToolsMaterial","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/SceneGraphFactory"],(function(e,t,i,n,o,r,a,l,s){"use strict";return n.extend({init:function(c){this._parent();var u,p,g=c;function d(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)}function f(e,t,n){var o=function(e,t){var n=(new i.Projector).projectVector(t.clone(),e.viewpoints[0].getCamera()),o=Math.round((0-n.y)*(e.canvas.offsetHeight/2)+e.canvas.offsetHeight/2),r=Math.round(n.x*(e.canvas.offsetWidth/2)+e.canvas.offsetWidth/2);return{top:o,left:r,bottom:e.canvas.offsetHeight-o,right:e.canvas.offsetWidth-r,inWindow:o>0&&o<e.canvas.offsetHeight&&r>0&&r<e.canvas.offsetWidth}}(e,t),a=function(e,t,n){var o=new i.Vector3((t-window.pageXOffset)/e.canvas.offsetWidth*2-1,-(n-window.pageYOffset)/e.canvas.offsetHeight*2+1,.5),r=(new i.Projector).pickingRay(o,e.currentViewpoint.camera);return{position:r.ray.origin,direction:r.ray.direction}}(e,o.left+n,o.top);return r.computePointLineDistance(t.toArray(),a.position.toArray(),a.direction.toArray()).distance}var v={};v.preSolidLine=a.retrieveMaterialFromGAS({color:new i.Color(16753920),lineWidth:window.devicePixelRatio,pattern:o.LinePatternEnum.SOLID}),v.dotDashedLineBlack=a.retrieveMaterialFromGAS({color:new i.Color(0),lineWidth:window.devicePixelRatio+1,pattern:o.LinePatternEnum.DOTDASHED}),v.crossPointPreHighlight=a.retrieveMaterialFromGAS({symbol:1,size:10,color:new i.Color(65535)}),v.preFaceMaterial=a.retrieveMaterialFromGAS({color:new i.Color(16753920),opacity:1}),v.preFaceMaterial.force=!0,v.preSolidLine.force=!0,v.preFaceMaterial.line=v.preSolidLine,this.getAxisNode=function(i){var n,o,r,a=i.getType()===e.GeometryType.CIRCLE,l=a?{beginPoint:i.getCenter().clone(),endPoint:i.getCenter().clone()}:i.getPoints();n=i.getAxis().clone();var s=a?60:30,c=f(g,l.beginPoint,s);return n.normalize().multiplyScalar(c),o=l.beginPoint.clone().sub(n),r=l.endPoint.clone().add(n),t.createLineNode(o,r,v.dotDashedLineBlack)},this.getPointNode=function(e){if(e)return v.crossPointPreHighlight.force=!0,s.createPointsNode({positions:e.clone().toArray(),material:v.crossPointPreHighlight})};var m=new n;d(this,m),this.buildPreVisuNode=function(e){if(e&&e.data&&e.data.point&&e.data.normal){m.removeChildren();var i=e.data.point,n=e.data.normal,o=g.currentViewpoint,r=f(g,i,40);u=t.createRectangleNode(r,r,i,n,v.preFaceMaterial,!1),p||(p=t.createArrowNormalNode(o)),p&&p.setMatrix(l.getMatFromNormWithPos(n,i)),d(m,u),d(m,p),e.data.measurable&&e.data.toShowAxisVisu()&&d(m,this.getAxisNode(e.data.measurable,!0))}},this.remove=function(){m&&(m.removeChildren(),m.remove(),m=void 0),u&&(u.removeChildren(),u.remove(),u=void 0),p&&(p.removeChildren(),p.remove(),p=void 0)}}})})),define("DS/DMUPlaySection/DMUToolsSection",["DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUSectionPosService","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUToolsSceneGraph","DS/WebPolyPlanarSectionOper/WebPolyPlanarSectionOper","DS/DMUPlaySection/DMUStoreyNavigratorController"],(function(e,t,i,n,o,r,a,l,s,c,u,p){"use strict";var g={computeSectionCurvesUsingPolyPlanarOperator:function(e,t,i){let n={};var o=new u(e);return o&&(n=o.Run(t,i)),n},computeSectionPlaneReferencial:function(o,a,l,s){var c=new i.Vector3((a.max.x+a.min.x)/2,(a.max.y+a.min.y)/2,(a.max.z+a.min.z)/2),u=n.getViewpointInfo(o.currentViewpoint),p=e.dot(u.sight.toArray(),[1,0,0]),g=e.dot(u.sight.toArray(),[0,1,0]),d=e.dot(u.sight.toArray(),[0,0,1]),f=Math.abs(p),v=Math.abs(g),m=Math.abs(d),h=new i.Matrix4;if(s&&"Automatic"!==s?h=function(e,t){let n=e;var o;switch(t.toLowerCase()){case"x":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateY(-Math.PI/2).setPosition(o);break;case"y":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateX(Math.PI/2).setPosition(o);break;case"z":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateY(Math.PI).setPosition(o)}return n}(h,s):r.isLessOrEqual(f,v)||r.isLessOrEqual(f,m)?r.isLessOrEqual(v,m)?r.isLessThan(d,0)&&h.rotateY(Math.PI):r.isLessThan(g,0)?h.rotateX(Math.PI/2):h.rotateX(-Math.PI/2):r.isLessOrEqual(p,0)?h.rotateY(-Math.PI/2):h.rotateY(Math.PI/2),h.setPosition(c),l){var S=t.computePlaneDim(a,h,!1,!0);if(!isNaN(S.fSliceOffset)&&S.fSliceOffset>0){var C=this.computePlaneCenter(h,2*S.fSliceOffset,!0);C&&h.setPosition(C)}}return h},checkLineIntersection:function(e,t){var i=e[0][0],n=e[0][1],o=e[1][0],r=e[1][1],a=t[0][0],l=t[0][1],s=t[1][0],c=t[1][1],u={x:null,y:null,bIsOnLine1:!1,bIsOnLine2:!1},p=(c-l)*(o-i)-(s-a)*(r-n);if(0===p)return u;var g=n-l,d=i-a,f=(o-i)*g-(r-n)*d;return g=((s-a)*g-(c-l)*d)/p,d=f/p,u.x=i+g*(o-i),u.y=n+g*(r-n),g>0&&g<1&&(u.bIsOnLine1=!0),d>0&&d<1&&(u.bIsOnLine2=!0),u},trimPolylines:function(e,t){var n,o=[];t&&(n=[[[t.min.x,t.min.y],[t.max.x,t.min.y]],[[t.max.x,t.min.y],[t.max.x,t.max.y]],[[t.max.x,t.max.y],[t.min.x,t.max.y]],[[t.min.x,t.max.y],[t.min.x,t.min.y]]]);var r,a,l,s,c=!1,u=0,p=0,d=0;for(u=0;u<e.length;u++){a=e[u]._Vertices.length,c=!1;var f=[];for(p=0;p<a;p++)if(l=new i.Vector2(e[u]._Vertices[p][0],e[u]._Vertices[p][1]),!t||t&&t.containsPoint(l))f.push([e[u]._Vertices[p][0],e[u]._Vertices[p][1],e[u]._Vertices[p][2]]),c=!0;else{r=p,c&&(r=--p,c=!1);var v=!1;if(r<a-1)for(d=0;d<n.length;d++)(s=g.checkLineIntersection(n[d],[[e[u]._Vertices[r][0],e[u]._Vertices[r][1]],[e[u]._Vertices[r+1][0],e[u]._Vertices[r+1][1]]])).bIsOnLine1&&s.bIsOnLine2&&(f.push([s.x,s.y,e[u]._Vertices[r][2]]),v=!0);!v&&f.length>0&&(o.push(f),f=[])}f.length>0&&o.push(f)}return o},getEditCmd:function(e){var t=o.getContextViewer({viewer:e});return s.getEditCmd(t)},computePlaneCenter:function(e,t,n){var o=t,r=(new i.Vector3).getPositionFromMatrix(e);if(!isNaN(o)&&n){var a=e.decompose(),l=new i.Vector3(0,0,1).applyQuaternion(a[1]).normalize();l.negate(),l=l.multiplyScalar(o/2),r=r.add(l)}return r},computeClippingSlice:function(e,t){if(e&&e.radius&&e.center){var n=e.radius;if(t){var o=t.decompose(),r=(new i.Vector3).getPositionFromMatrix(t),s=new i.Vector3(0,0,1).applyQuaternion(o[1]).normalize(),c=e.center;s=s.multiplyScalar(n),c=c.add(s);var u=s.clone().normalize(),p=a.computeTwoPlanesDistance(r.toArray(),u.toArray(),c.toArray(),u.toArray());p&&0===p.returnCode&&p.relationship===l.Relationship.PARRALLEL&&(n=p.distance)}return n}},cleanClippingVisu:function(e){let t=o.giveEventsController({viewer:e});t&&t.fireEvent("onEditCommandEnd");let i=o.getReviewContext({viewer:e});if(i){let e=s.retriveClippingObjsFromSlide(i);e&&e.forEach((function(e){if(e){var t=e.getNode();t&&(t.setPickingInManipulationModeForLineTraslation(!0),t.cleanClippingRobot())}}))}},initClippingVisu:function(e,t){if(!e||!t)return;let i=o.giveEventsController({viewer:e});i&&i.fireEvent("initClippingVisu",t)},getRootsForClipping:function(e){let t=o.getReviewContext({viewer:e});if(t&&t.getReviewCtxInformation){let e=t.getReviewCtxInformation();if(e&&e.contextId)return[c.getNodeFromID(e.contextId)]}return c.getRootReferences(e)},isClippingEligibleForStoreyMode:function(e,t){for(var i=g.getRootsForClipping(e),n=0;n<i.length;n++)if(i[n]){let e=c.getNodeType(i[n]);if("Building"===e||"AecSite"===e){let e=c.getNodeID(i[n]);if(!p.isNoDataOnStoreyOfRoot(e,t))return i[n]}}},getBuildingRootData:function(e,t,i){if(!e)return;let n,o;i&&(o=[]);let r=!1;if(t){let e=c.getNodeType(t);if("Building"===e||"AecSite"===e){r=!0;let e={rootNode:t,ID:c.getNodeID(t)};i?o.push(e):o=e}}if(!r){n=g.getRootsForClipping(e);for(var a=0;a<n.length;a++)if(n[a]){var l=n[a];let e=c.getNodeType(l);if("Building"===e||"AecSite"===e){let e={rootNode:l,ID:c.getNodeID(l)};if(!i){o=e;break}o.push(e)}}}return o},getStoreyinfoOnSlide:function(e){if(!e)return;let t;var i=o.getReviewContext({viewer:e});if(i&&i.getCurrentSessionMarkup){var n=i.getCurrentSessionMarkup();if(n){var r=n.getCurrentSlide();if(r){var a=r.getEnvironmentOverload();t="string"==typeof a.state.sContructionItemId?a.state.sContructionItemId:void 0}}}return t},setStoreyinfoOnSlide:function(e,t){if(!t||!e||"string"!=typeof t)return;let i=t;var n=o.getReviewContext({viewer:e});if(n&&n.getCurrentSessionMarkup){var r=n.getCurrentSessionMarkup();let e;if(r){if(r){let t=n.getRestrictions(r);t.markup&&void 0!==t.markup.canEdit&&(e=t.markup.canEdit)}if(r&&r.getActiveFlag()&&r.isVisible()&&!r.isReadOnly()&&r.getCurrentSlide&&r.getCurrentSlide()&&e){var a=r.getCurrentSlide();if(!r.isReadOnly()){var l=a.getEnvironmentOverload();l&&l.state&&(l.state.sContructionItemId=i,a.updateEnvironmentOverload(l),a.fireEvent("onDMUSlideSessionInfoChanged",{dmuObject:a,info:"storeyId"}))}}}}return i}};return g})),define("DS/DMUPlaySection/DMUClippingNode3D",["UWA/Core","DS/DMUBaseUI/DMUNode3D","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUManipulableClippingPlane","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/DMUBaseCommands/EXPToolsWUX","DS/Visualization/ClippingContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/PADUtils/PADSettingsMgt","DS/DMUPlaySection/DMUToolsSection","DS/DMUPlaySection/DMUClippingRobot","DS/Ruler/Ruler","DS/SceneGraphNodes/FixedSizeNode3D","DS/Robot/LineTranslationNode","DS/Mesh/Mesh","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"].concat(["DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController"]),(function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,f,v,m,h,S,C,b,M){"use strict";var y=e.Class.extend({init:function(e){var t=e.frameWindow,i=e.getAppType,n=e.nodeInfo,r=e.viewer,a=e.type,u=e.originPlaneType,p=!1;this.isManipulationOnGO=function(){return p};var g,d,f,v,b,M,y=[];function P(){g=new m(t,{displayOrigin:!1,offset:20,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!0,lightDisplay:"3dPlay"===i()});(d=[]).push(g.subscribe("RulerManipulateBegin",(function(e){!function(e){if(p=!0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:e.event})){var t=n.getPlaneGeometryCB(a);v=(new s.Vector3).getPositionFromMatrix(t.referential),n.manipulationInformationCB({action:o.ManipulationAction.BEGIN,type:o.ManipulationType.TRANSLATION,evt:e.event})}}(e)}))),d.push(g.subscribe("RulerManipulate",(function(e){!function(e){if(p=!0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:e.event})){if(v){var t=n.getPlaneGeometryCB(a);v=(new s.Vector3).getPositionFromMatrix(t.referential)}var i=v.clone().add(e.translationVector);n.setPlaneGeometryCB({newCenter:i,from:a,UpdateRobotpos:!0}),n.manipulationInformationCB({action:o.ManipulationAction.DO,type:o.ManipulationType.TRANSLATION,evt:e.event})}}(e)}))),d.push(g.subscribe("RulerManipulateEnd",(function(e){var t;t=e,p=!1,v=void 0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:t.event}),n.manipulationInformationCB({action:o.ManipulationAction.END,type:o.ManipulationType.TRANSLATION,evt:t.event})})))}function w(){return n.getPlaneGeometryCB(a).referential}P(),this.updateOnTranslationBegin=function(e){if(p=!0,v=e.intersection.position,"ConstructionItem"===u?(M||(M=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB().referential)),y.origin3D=M):y.origin3D=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB(u).referential),g||P(),!b){b=new c;var t={position:new s.Vector3(0,0,0),touchMode:!1},i=new h({name:"fixedSizeNode3D",ratio:7}),o=new S(t);o.name="arrowTranslationNode",o.mat.color=new s.Color("#1B6E9C"),o.mat.opacity=1,o.setNoZ(!0),i.addChild(o),r&&b&&(b.addChild(i),r.addNode(b),r.render())}b&&(b.setMatrix(w().setPosition(v.clone())),b.setVisibilityInTree(!1),b.setVisibility(r.getVisibleSpace()),b.setPickable(C.PICKTHROUGH));var d=(new s.Vector3).copy(e.manipulator.axis).negate(),m=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB(a).referential);y.initOrigin=m.clone();var D=(new s.Vector3).copy(y.initOrigin);y.origin3D&&(D=new s.Line3(y.initOrigin,(new s.Vector3).copy(y.initOrigin).add(d)).closestPointToPoint(y.origin3D,!1));y.origin=D;var x=(new s.Vector3).copy(y.origin).sub(m).dot(d);if(y.direction=d,y.value=D.distanceTo(m)*(x>0?-1:1),y.initValue=y.value,g){var A=d.clone().negate().normalize().multiplyScalar(y.value);g.origin=v.clone().add(A),g.origin3DPos=y.origin3D,f=y.value,g.initOrigin=y.initOrigin,g.setValue(y.value),g.direction=y.direction,g.initValue=y.initValue,g.unit=l.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value,g.display(),g.beginManipulation()}},this.setOrigin=function(e){M=e},this.snapTranslationCallback=function(e){var t=e.translationVector;if(g){var i=g.getSnappedTranslationVector(e);0===i.returnCode&&(t=i.snappedTranslationVector)}return t},this.updateOnTranslation=function(e){if(p=!0,g){var t=y.value;y.value=y.initValue+e.translationVector.length()*(y.direction.dot(e.translationVector)>0?1:-1),g.setValue(y.value);var i=w();if(t&&t<y.value){var n=new s.Vector3,o=new s.Vector3,r=new s.Vector3;i.extractBasis(n,o,r),r.negate(),i.makeBasis(n,o,r)}var a=(new s.Vector3).copy(e.manipulator.axis).normalize().multiplyScalar(f-y.value),l=v.clone().add(a);b.setMatrix(i.setPosition(l.clone()))}else!g&&e.intersection&&e.manipulator&&this.updateOnTranslationBegin({intersection:e.intersection,manipulator:e.manipulator})},this.updateOnTranslationEnd=function(){p=!1,b&&b.setVisibility(!r.getVisibleSpace()),g&&(g.endManipulation(),g.display()),b&&(r.removeNode(b),b.removeChildren(),b.remove(),b=void 0),v=void 0},this.clear=function(){p||(g&&g.clear(),g=null)}}});return t.extend({init:function(e){var t;this._parent({frmWindow:e._frmWindow,getType:e.getType});var l,m=this;m.clippingNode=!0;var h,S,P,w,D,x,A,V,N,_,R,O,T,E,U,I,B,k,L,F=!1,z=!1,W=!1,G=null,H=!1,j=new s.Plane,X=new s.Plane,Y=new s.Plane,J=new s.Plane,Z=new s.Plane,q=new s.Plane,Q=new s.Plane,K=[],$=[],ee=[],te=new s.Box3,ie=1,ne=!1;this.isHachingAlreadyApplied=()=>ne;var oe=function(e){if(e&&(e.setFrustumCulled&&e.setFrustumCulled(!1),e.children))for(var t=0;t<e.children.length;t++)oe(e.children[t])},re=function(){return n.isOOC(d,e._viewer)};function ae(t){var i=e.getAttribute("fXDirSize");"Right"!==t&&"Left"!==t||(i=e.getAttribute("fSliceOffset"));var n=e.getAttribute("fYDirSize");return"Top"!==t&&"Bottom"!==t||(n=e.getAttribute("fSliceOffset")),{referential:e._getPlanReferential(t),uSize:i,vSize:n,uStep:e.getAttribute("fXDirGridStep"),vStep:e.getAttribute("fYDirGridStep"),sliceOffset:e.getAttribute("fSliceOffset"),planeType:e.getAttribute("sPlaneBoxMode")}}function le(){m._robot||(l||(l=f.getEditCmd(e._viewer)),l&&((l.isRunning()||l.isPaused())&&f.cleanClippingVisu(e._viewer),f.initClippingVisu(e._viewer,e)))}function se(){return m._robot}function ce(t){if(t&&(t.uSize||t.vSize||t.uStep||t.vStep||t.referential||t.sliceOffset)){if(t.uSize&&e.setAttribute("fXDirSize",t.uSize),t.vSize&&e.setAttribute("fYDirSize",t.vSize),t.uStep&&e.setAttribute("fXDirGridStep",t.uStep),t.vStep&&e.setAttribute("fYDirGridStep",t.vStep),isNaN(t.sliceOffset)||e.setAttribute("fSliceOffset",t.sliceOffset),t.referential){var i=t.referential.clone();if(t.toRelocate&&!e.isSinglePlaneMode()){var n=e.getPlaneCenter(i);i.setPosition(n)}e.setAttribute("mPlaneReferential",i),e.modifyPlaneReferential(i)}}else{var o,r,a,l=t.newCenter,c=!0;switch(t.from){case"Top":r="Bottom",a="fYDirSize";break;case"Bottom":r="Top",a="fYDirSize";break;case"Right":r="Left",a="fXDirSize";break;case"Left":r="Right",a="fXDirSize";break;case"Back":r=void 0,a="fSliceOffset",c=!1;break;default:(o=ae().referential).setPosition(l),c=!1,e.isSinglePlaneMode()||(r="Back",a="fSliceOffset")}if(a){var u=(new s.Vector3).getPositionFromMatrix(ae(r).referential);if(l&&u){var p=u.distanceTo(l),g=e.getAttribute(a);if(e.setAttribute(a,p),c&&p){var d=u.clone().sub(l.clone()).normalize();d.multiplyScalar(.5*(g-p));var f=ae(),v=(new s.Vector3).getPositionFromMatrix(f.referential);o=f.referential,v=v.clone().add(d).clone(),o.setPosition(v)}}}o&&e.setAttribute("mPlaneReferential",o)}t.UpdateRobotpos&&m._robot&&m._robot.updateRobotPos(),t.refreshNode&&m.update()}function ue(){var t=o.State.STANDARD;return e.isInEdition()&&(t=o.State.INEDITION),t}function pe(){return e.isSectionDisplayed()}function ge(){var t={mode:o.DisplayMode.PLANE,fillColor:e.getAttribute("cFillStyleColor"),opacity:e.getAttribute("fOpacity")};return"Grid"===e.getAttribute("sDisplayPlaneMode")&&(t.mode=o.DisplayMode.GRID),t}function de(t){var n=!0;if(!t||t.type!==o.ManipulationType.TRANSLATION&&t.type!==o.ManipulationType.ROTATION&&t.type!==o.ManipulationType.RESIZE&&t.type!==o.ManipulationType.CENTER)return n;switch(t.action){case o.ManipulationAction.ENABLE:void 0===I&&(I=!e.isEditable()||function(){var t=a.isManipulationAllowed({viewer:e._viewer});if("boolean"==typeof t)return!t;var n=i.checkIfCommandIsRunning(e._viewer);return n&&"SelectiveSectionContextCmdHdr"===i.getCurrentCommand(e._viewer)&&(u.addInCSO(e,!1),n=!1),n}()||!e.isInEdition()),n=!I;break;case o.ManipulationAction.BEGIN:var r=Boolean(t.fromRobot);e.clearAllRuler(r),I||(t.type===o.ManipulationType.CENTER&&(m.enableClipping(!1),e._viewer.setSectionCapping(!1)),e.beginManipulation({doNotSetPlaneMoveEvent:t.type===o.ManipulationType.CENTER}));break;case o.ManipulationAction.DO:I||e.doManipulation();break;case o.ManipulationAction.END:I?e.isClippingPlaneVisible()&&e.endManipulation(t.evt,!0):(t.type===o.ManipulationType.CENTER&&(m.enableClipping(!0),e._viewer.setSectionCapping(!0)),e.endManipulation(t.evt)),I=void 0;break;case o.ManipulationAction.LONG_HOLD:I||e.onLongHold()}return n}function fe(t){var i=e.isEditable();return new o({viewer:e._viewer,frameWindow:e._frmWindow,bTranslationManipulator:i,sType:t,getState:ue,getShowState:pe,getGeometry:ae,setGeometry:ce,getDisplayInformation:ge,getManipulationInformation:de,appType:e._typeApps,context:e._context,initRobotCB:le,getRobotCB:se,ruler:"NormalMode"!==e.getAttribute("sPlaneBoxMode")?new y({frameWindow:e._frmWindow,getAppType:m.getAppType,nodeInfo:m,viewer:e._viewer,type:t,originPlaneType:e.isConstructionItemMode()?"ConstructionItem":function(e){if(!e)return"Back";var t;switch(e){case"Back":break;case"Top":t="Bottom";break;case"Bottom":t="Top";break;case"Right":t="Left";break;case"Left":t="Right"}return t}(t)}):void 0,storeyMode:e.isConstructionItemMode()})}function ve(t){var i=e.getAttribute("sPlaneBoxMode");"Grid"!==e.getAttribute("sDisplayPlaneMode")&&("Back"!==t||"SliceMode"!==i&&"BoxMode"!==i||(D?D.update():((D=fe(t)).setName(b.sectionplane),(P=new c).setVisibilityInTree(!1),m.addChild(P),P.addChild(D))),"BoxMode"===i&&("Top"===t?R?R.update():((R=fe(t)).setName(b.sectionplane),(x=new c).setVisibilityInTree(!1),m.addChild(x),x.addChild(R)):"Bottom"===t?O?O.update():((O=fe(t)).setName(b.sectionplane),(A=new c).setVisibilityInTree(!1),m.addChild(A),A.addChild(O)):"Right"===t?T?T.update():((T=fe(t)).setName(b.sectionplane),(V=new c).setVisibilityInTree(!1),m.addChild(V),V.addChild(T)):"Left"===t&&(E?E.update():((E=fe(t)).setName(b.sectionplane),(N=new c).setVisibilityInTree(!1),m.addChild(N),N.addChild(E)))))}function me(){var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||(n=e.getAttribute("fSliceOffset"));var a=e.getAttribute("fXDirGridStep"),l=e.getAttribute("fYDirGridStep");a||(a=t/10),l||(l=i/10);var c=e.getAttribute("iGridAbsoluteMode");_=new g({window:e._frmWindow,viewer:e._viewer,context:r.getContextViewer({viewer:e._viewer}),nbMaxLabel:300,stepRequiredX:a,stepRequiredY:l,stepRequiredZ:0===n?0:a,gridMatrix:(new s.Matrix4).copy(e._getPlanReferential()),freeZoneDim:e._viewer.canvas.getBoundingClientRect(),id:"Section",owner:S,isEditable:!1,isLabelManipulable:!1,isAbsoluteMode:1===c})}function he(){var i=e.isSectionDisplayed()&&(e.isInEdition()||e.isClippingPlaneVisible());i||m.clearAllRulers(),e._bIsInShowSpace||(i=!i);var n=i;if(e._bVisible&&(n=!i),"NoPlane"===e.getAttribute("sDisplayPlaneMode")&&i&&(i=!i),w)if(w.setVisibility(i),w.setVisibilityFree(n),!e.isEditable()&&m._robot)m._robot.update(Boolean(e._bIsInShowSpace));else if(m._robot){var o;!1===(e._bIsInShowSpace?i:!i)?(o=!i,m._robot.update(o)):(o=!e.isInEdition(),e._bIsInShowSpace||(o=!o)),m._robot.update(o)}D&&(D.setVisibility(i),D.setVisibilityFree(n)),R&&(R.setVisibility(i),R.setVisibilityFree(n)),O&&(O.setVisibility(i),O.setVisibilityFree(n)),T&&(T.setVisibility(i),T.setVisibilityFree(n)),E&&(E.setVisibility(i),E.setVisibilityFree(n)),function(){var i=e.getAttribute("sPlaneBoxMode");let n=e.getPlaneOffsetAsPerBB();n&&.1!==n||(n=e.updatPlaneOffsetAsPerBB()),(!n||n>.1)&&(n=.1);var o=(new s.Matrix4).translate(new s.Vector3(0,0,n));w&&w.setMatrix(o),D&&D.setMatrix(o),R&&R.setMatrix(o),O&&O.setMatrix(o),T&&T.setMatrix(o),E&&E.setMatrix(o),S.setMatrix(e._getPlanReferential()),"SliceMode"!==i&&"BoxMode"!==i||!P||P.setMatrix(e._getPlanReferential("Back")),"BoxMode"===i&&(x&&x.setMatrix(e._getPlanReferential("Top")),A&&A.setMatrix(e._getPlanReferential("Bottom")),V&&V.setMatrix(e._getPlanReferential("Right")),N&&N.setMatrix(e._getPlanReferential("Left")));var a=e.getAttribute("sSectionRender"),l=e.isSectionDisplayed(),c=!1!==e.getAttribute("bClippingActiveState");F&&l&&h&&a!==h&&"NoCut"!==h&&(e._viewer.removeClippingPlane(j),X&&e._viewer.removeClippingPlane(X),m.enableClipping(!1),e._viewer.setSectionCapping(!1),F=!1),h=a,t||(t=r.getContextViewer({viewer:e._viewer})),l&&!F&&M&&t&&M.getSectionVisibilityFlag(t)&&M.setSectionVisibilityFlag(t,!1);if("CutOneSide"===a&&(!F&&c&&l&&(F=!0,e._viewer.setSectionCappingMaterial(j,null),m.updateClippingPlaneWithMaterial(i),m.enableClipping(!0),e._viewer.setSectionCapping(!0)),F&&!l&&(F=!1,e._viewer.removeClippingPlane(j),"SliceMode"===i?e._viewer.removeClippingPlane(Y):"BoxMode"===i&&(e._viewer.removeClippingPlane(J),e._viewer.removeClippingPlane(Z),e._viewer.removeClippingPlane(Q),e._viewer.removeClippingPlane(q)),m.enableClipping(!1),e._viewer.setSectionCapping(!1)),F&&l&&!e._viewer.getSectionCapping()&&e._viewer.setSectionCapping(c)),"OnlyContour"===a){if(!F&&l){F=!0;var u=(new s.Matrix4).copy(e._getPlanReferential());X.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),X.applyMatrix4(u.rotateX(Math.PI)),e._viewer.addClippingPlane(j,G),e._viewer.addClippingPlane(X,G),m.enableClipping(!0),e._viewer.setSectionCapping(!1)}F&&!l&&(F=!1,e._viewer.removeClippingPlane(j),e._viewer.removeClippingPlane(X),m.enableClipping(!1),e._viewer.setSectionCapping(!1))}}(),m._makePlanedata()}function Se(){if(B)return B;if(!e)return;let t=e,i=t.getParent?t.getParent():void 0;return i&&(B=i.getAttribute("oLinksManager")),B}function Ce(t,i){if(Array.isArray(t))for(var n=0;n<t.length;n++)Ce(t[n],i);else if(t.enableClippingPlane(j,i),"OnlyContour"===e.getAttribute("sSectionRender"))t.enableClippingPlane(X,i);else{var o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||t.enableClippingPlane(Y,i),"BoxMode"===o&&(t.enableClippingPlane(J,i),t.enableClippingPlane(Z,i),t.enableClippingPlane(q,i),t.enableClippingPlane(Q,i))}}function be(e,t){if(t){ne=!0;var i=new p;return i.setPlanes(t),1===e.length?t.forEach((t=>{i.setSectionCappingMaterial(e[0],t)})):4===e.length&&(t.forEach((t=>{i.setSectionCappingMaterial(e[k%4],t)})),k++),i}}function Me(e){m._enableClippingPlaneforCutUncut(e,ie)}function ye(e){let t=e.clone();for(t.internalPath=[];t.getElement(0)&&!n.isPLMNode(t.getElement(0));)t.externalPath.shift();for(;t&&!n.isPLMNode(t.getLastElement(!0));)t=t.getParentPath();return t}function Pe(t,i,o,a){var l=n.getRootReferences(e._viewer);let s=t?void 0:e.retriveHatchingData();var c=a?a():ee;for(let t=0;t<l.length;t++){let a=n.buildPathElement(l[t]);if(a){let t=[];if(!o&&s&&1!==s.length){let i=[],o=[],a=[],l=[];n.parseForLeafNodesOfScene(r.getContextViewer({viewer:e._viewer}),i,o),i.length&&(a=i),o.length&&(a=a.concat(o)),c&&c.length&&a.forEach((e=>{let t=ye(e),i=[];var o,r;if(t)for(o=0;o<t.getLength();o++)i.push(n.getNodeID(t.getElement(o)));var a=i.length,s=!1;for(o=0;o<c.length;o++){var u=re()?c[o]:Se().getOccurrenceIdPath(c[o]),p=u.length;if(p<=a)for(r=0;r<p;r++){if(u[r]!==i[r]){s=!1;break}s=!0}if(s)break}s||l.push(t)})),t=l}t.length<1&&t.push(a),U||(U=n.createSceneGraphOverrideSet(e._viewer));let l=n.getOverrides(U,{pathElements:t});var u;if(l&&l.length)for(let e=0;e<l.length;e++)s&&s.length?u=be(s,i):u||(u=new p).setPlanes(i),l[e].setClippingContext(u)}}}function we(){var t=void 0;e.isCustomColorSorce("Capping")&&(t=e.getAttribute("cCappingColor")),t!==G&&(G=t)}function De(e){w&&w.setPickable(e),D&&D.setPickable(e),R&&R.setPickable(e),O&&O.setPickable(e),T&&T.setPickable(e),E&&E.setPickable(e)}this._makePlanedata=()=>{j.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),j.applyMatrix4(e._getPlanReferential()),"SliceMode"!==e.getAttribute("sPlaneBoxMode")&&"BoxMode"!==e.getAttribute("sPlaneBoxMode")||(Y.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),Y.applyMatrix4(e._getPlanReferential("Back"))),"BoxMode"===e.getAttribute("sPlaneBoxMode")&&(J&&(J.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),J.applyMatrix4(e._getPlanReferential("Top"))),Z&&(Z.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),Z.applyMatrix4(e._getPlanReferential("Bottom"))),q&&(q.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),q.applyMatrix4(e._getPlanReferential("Right"))),Q&&(Q.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),Q.applyMatrix4(e._getPlanReferential("Left"))))},this._enableClippingPlaneforCutUncut=(t,i,o)=>{k=0,ne=!1;let r=!!o&&o.doNotApplyHatching,a=!!o&&o.toRemove,l=!!o&&o.addClippingOnRoot;var s,c=[];if(t&&t.length>0){let v;if(re()||(v=o&&o.listPathElem?o.listPathElem:t),U||(U=n.createSceneGraphOverrideSet(e._viewer)),c.push(j),"OnlyContour"===e.getAttribute("sSectionRender")?c.push(X):("SliceMode"!==(s=e.getAttribute("sPlaneBoxMode"))&&"BoxMode"!==s||c.push(Y),"BoxMode"===s&&(c.push(J),c.push(Z),c.push(q),c.push(Q))),i){var u=null,g=n.getOverrides(U,v?{pathElements:v}:{idPaths:t});if(l&&Pe(r,c,i,null),g&&g.length){let t=r?void 0:e.retriveHatchingData();g.forEach((function(e){a||(t&&t.length?u=be(t,c):u||(u=new p).setPlanes(c)),e.setClippingContext(u)}))}}else{let e=o?o.getSelectedObjectsIdsPath:void 0;Pe(r,c,i,e);var d=n.getOverrides(U,v?{pathElements:v}:{idPaths:t});if(d&&d.length){var f=null;a||((f=new p).setExcludeFromClippingPlanes(c),f.setEnableClippingProfile("off")),d.forEach((function(e){e.setClippingContext(f)}))}}}else l&&(c.push(j),"OnlyContour"===e.getAttribute("sSectionRender")?c.push(X):("SliceMode"!==(s=e.getAttribute("sPlaneBoxMode"))&&"BoxMode"!==s||c.push(Y),"BoxMode"===s&&(c.push(J),c.push(Z),c.push(q),c.push(Q))),Pe(r,c,!0))},m.updateClippingPlaneWithMaterial=function(t,i){let n=t||e.getAttribute("sPlaneBoxMode");G||we();let o=G;if(!i){let t=e.retriveHatchingData();t&&1===t.length&&(o=t[0])}e._viewer.addClippingPlane(j,o),"SliceMode"===n?e._viewer.addClippingPlane(Y,o):"BoxMode"===n&&(e._viewer.addClippingPlane(Y,o),e._viewer.addClippingPlane(J,o),e._viewer.addClippingPlane(Z,o),e._viewer.addClippingPlane(Q,o),e._viewer.addClippingPlane(q,o))},m.refreshCutUnCut=function(){U&&(n.removeSceneGraphOverrideSet(e._viewer,U),ne=!1,U=null),Me(ee)},m.enableClipping=function(t){var i;if(m){$&&Ce($,!1),U&&(n.removeSceneGraphOverrideSet(e._viewer,U),ne=!1,U=null),function(){var t,i,o,r;K=[],ee=[];var a=e.collectCutObjects();t=a.CutObjects,i=a.CutObjectsOOC,W=a.bIsPartial,ie=a.cutUncutMode;var l=0,s=0;if(W)if(void 0!==ie)if(re())for(l=i.length,s=0;s<l;s++){var c=i[s];c&&ee.push(c)}else{for(l=t.length,s=0;s<l;s++){var u=t[s];u&&ee.push(u)}t=[]}else for(l=t.length,s=0;s<l;s++)(o=t[s])&&(r=n.getLastInstance(o),K.push(r.getLastElement()));else{var p=e._viewer.getVisibleSpace();!1===e._bIsInShowSpace&&!1===p&&"Markup"!==e.getParent().getType()||(K=n.getRootReferences(e._viewer))}}();var o=r.getContextViewer({viewer:e._viewer});if(o){var a=o.getController();if(a){var l=a.get3DLayerController();if(l)l.getLayers().forEach((function(e){e.getNode3DBag()&&K.push(e.getNode3DBag())})),t?L||(L=l.subscribe({event:"layerCreated"},(function(e){var i=[],n=l.getLayer(e.id);if(n){n.getNode3DBag()&&i.push(n.getNode3DBag()),Ce(i,t)}}))):(l.unsubscribe(L),L=null)}}$=K,Ce(K,t),t?Me(ee):re()&&e.removeCurvesAndHatching();var s=n.getSceneRoot(e._viewer).children;for(i=0;i<s.length;i++)s[i].toBeSectionned&&s[i].enableClippingPlane(j,t);H=t}},m.isClippingEnabled=function(){return H},m.clean=function(t){if(m.clearAllRulers(!0),t&&m._robot&&m.cleanClippingRobot(),m){var i=n.getRootReferences(e._viewer);re()&&e.removeCurvesAndHatching(),U&&(n.removeSceneGraphOverrideSet(e._viewer,U),ne=!1,U=null),Ce(i,!1),Ce($,!1),e._viewer.setSectionCappingMaterial(j,null),e._viewer.removeClippingPlane(j),j=new s.Plane,e._viewer.removeClippingPlane(X),X=new s.Plane,e._viewer.removeClippingPlane(Y),Y=new s.Plane,e._viewer.removeClippingPlane(J),J=new s.Plane,e._viewer.removeClippingPlane(Z),Z=new s.Plane,e._viewer.removeClippingPlane(Q),Q=new s.Plane,e._viewer.removeClippingPlane(q),q=new s.Plane,w&&w.clean(),_&&S&&(_.deleteGrids({owner:S,fromStorage:!0}),_.setActiveState(!1)),m.removeChildren(),S=P=w=D=null,x=A=V=N=_=null,R=O=T=E=null,K.length=0,$.length=0,F=!1,z=!1,W=!1,I=void 0,G=null}},m.resetClippingFlag=function(){F=!1},m.update=function(t){if(m)if(f.getRootsForClipping(e._viewer).length&&e&&e.isConstructionItemMode()&&!e.isBuidlingRootAvailable(void 0,!0))e.resetToNormalMode();else{if(t&&m.clean(),we(),S||S||((S=new c).setVisibilityInTree(!1),m.addChild(S),"Grid"!==e.getAttribute("sDisplayPlaneMode")?((w=new fe).setName(b.sectionplane),S.addChild(w),ve("Back"),ve("Top"),ve("Bottom"),ve("Right"),ve("Left")):me(),m.addChild(e.getSectionCurveNode()),oe(m)),m.setName(e.getAttribute("sName")),w&&w.update(),_&&S&&(_.deleteGrids({owner:S,fromStorage:!0}),e.isSectionDisplayed()||_.setActiveState(!1)),"Grid"!==e.getAttribute("sDisplayPlaneMode")){var i=e.getAttribute("sPlaneBoxMode");"SliceMode"!==i&&"BoxMode"!==i||(ve("Back"),"BoxMode"===i&&(ve("Top"),ve("Bottom"),ve("Right"),ve("Left")))}else _&&S&&e.isSectionDisplayed()?function(){_.setActiveState(!0);var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||(n=e.getAttribute("fSliceOffset")),te&&te.set(new s.Vector3(-t/2,-i/2,0),new s.Vector3(t/2,i/2,n)),_.drawGrids({specifications:[{BBox:te}]})}():e.isSectionDisplayed()&&me();var n=null,o=!1;e.getAttribute("bSectionCurvesVisible")&&e.isSectionCurveComputationNeeded()&&(n=function(){e.isSecondaryViewerShow()&&e.renderSecondaryViewer()},o=!0),e.manageCurvesAndHatching({computeCurves:o,action:n}),he()}},m._getManpForRobot=function(){if(w)return w},m.updateRobotPos=function(e){m._robot&&m._robot.updateRobotPos(e)},m.manageLock=function(t){var i=!0;return m&&t!==z?(z=t,m.update(),i=!1):function(){if(w&&w._updateManipulators(),D&&D._updateManipulators(),R&&R._updateManipulators(),O&&O._updateManipulators(),T&&T._updateManipulators(),E&&E._updateManipulators(),m._robot){var t=0!==e._viewer.getVisibleSpace(),i=ue()===o.State.INEDITION;i||(r=!1,l||(l=f.getEditCmd(e._viewer)),l&&(r=l.isRunning()),i=r);var n=!(t&&i);m._robot.update(n)}var r}(),i},m.isLocked=function(){return z},m.getFrameWindow=function(){return e._frmWindow},m.getAppType=function(){return e._typeApps},m.getCenter=function(e){var t=ae(),i=(new s.Vector3).getPositionFromMatrix(t.referential),n=t.planeType;if(!(e||"BoxMode"!==n&&"SliceMode"!==n||isNaN(t.sliceOffset))){var o=t.referential.decompose(),r=new s.Vector3(0,0,1).applyQuaternion(o[1]);r=r.normalize().multiplyScalar(t.sliceOffset/2),i=i.add(r)}return i},m.computePlaneCenter=function(t){return f.computePlaneCenter(t,e.getAttribute("fSliceOffset"),!e.isSinglePlaneMode())},m.getNormal=function(){var e=ae().referential.decompose();return new s.Vector3(0,0,1).applyQuaternion(e[1])},m.getUDirection=function(){var e=ae().referential.decompose();return new s.Vector3(1,0,0).applyQuaternion(e[1])},m.getVDirection=function(){var e=ae().referential.decompose();return new s.Vector3(0,1,0).applyQuaternion(e[1])},m.getPlaneGeometryCB=function(e){return ae(e)},m.setPlaneGeometryCB=function(e){ce(e)},m.manipulationInformationCB=function(e){return de(e)},m.setClippingRepVisibility=function(e){w&&w._setPlaneVisibility(e),D&&D._setPlaneVisibility(e),R&&R._setPlaneVisibility(e),O&&O._setPlaneVisibility(e),T&&T._setPlaneVisibility(e),E&&E._setPlaneVisibility(e)},m.setPickingInManipulationModeForLineTraslation=function(e){w&&w.setPickingInManipulationModeForLineTraslation(e),D&&D.setPickingInManipulationModeForLineTraslation(e),R&&R.setPickingInManipulationModeForLineTraslation(e),O&&O.setPickingInManipulationModeForLineTraslation(e),T&&T.setPickingInManipulationModeForLineTraslation(e),E&&E.setPickingInManipulationModeForLineTraslation(e)},m.setRobot=function(e){m._robot=e,!w||e&&P||w.setRobot(e)},m.getRobot=function(){return m._robot},m.isBoxMode=function(){return"BoxMode"===e.getAttribute("sPlaneBoxMode")},m.clearAllRulers=function(e){w&&w.clearRuler(),D&&D.clearRuler(),R&&R.clearRuler(),O&&O.clearRuler(),T&&T.clearRuler(),E&&E.clearRuler(),!e&&m._robot&&m._robot.updateRobotPos()},m.initClippingRobot=function(t){e.isConstructionItemMode()||(m._robot||m.setRobot(new v(m,t)),m._robot.buildRobot())},m.cleanClippingRobot=function(){m._robot&&m._robot.clean(),m._robot=null},m.isClippingNode=function(){return!0},m.isPersistentClippingCB=function(){return"DMUTemporaryBag"!==e.getParent().getType()},e.isSectionDisplayed()&&m.update(),m._eventController=r.giveEventsController({viewer:e._viewer}),m.cbTokenForSetUnSetPickThrough=[],m._eventController&&(m.cbTokenForSetUnSetPickThrough.push(m._eventController.addEvent("onSetPickThroughtRequest",(()=>{De(C.PICKTHROUGH)}))),m.cbTokenForSetUnSetPickThrough.push(m._eventController.addEvent("onUnsetPickThroughRequest",(()=>{De(C.PICKABLE)})))),m.setClippingPickable=function(e){m._robot&&m._robot.setPickable(e),De(e?C.PICKABLE:C.PICKTHROUGH)},m.clearEventToken=function(){m._eventController&&m.cbTokenForSetUnSetPickThrough&&m.cbTokenForSetUnSetPickThrough.forEach((e=>{m._eventController.removeEvent(e)}))},m.setRulerOrigin=function(e){w&&w.setRulerOrigin&&w.setRulerOrigin(e)},m.getCurrentStoreyOrigin=function(){e.getCurrentStoreyOrigin()},m.isClippingPanelActive=function(){let t=!1;return t=e._clippingPosPanelUI&&e._clippingPosPanelUI.isShow(),t}}})})),define("DS/DMUPlaySection/DMUClippingBase",["UWA/Core","DS/DMUBaseExperience/DMUOverloadableObject","DS/Visualization/Node3D","DS/DMUPlaySection/DMUToolsSection","DS/DMUPlaySection/DMUClippingManipulationTool","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUMeshCreation","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUSectionPosService","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseUIControllers/DMUMarkupsController","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/DMUPlaySection/DMUClippingNode3D","DS/DMUPlaySection/DMUSectionImport","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADAlert","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIServices/DMUObjectsServices","DS/CATWebUXPreferences/DMUClippingPrefService","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUModelServices","DS/DMUControls/DMUWarningPanel","DS/DMUControls/EXPNotify","DS/DMUPlaySection/DMUStoreyNavigratorController","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"],(function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,f,v,m,h,S,C,b,M,y,P,w,D,x,A,V,N,_,R,O,T){"use strict";var E=[{name:"mPlaneReferential",type:"Matrix4",JSONname:"PropertiesSection.PlaneReferential",defaultValue:new f.Matrix4},{name:"fXDirSize",type:"float",JSONname:"PropertiesSection.XDirSize"},{name:"fYDirSize",type:"float",JSONname:"PropertiesSection.YDirSize"},{name:"fSliceOffset",type:"float",JSONname:"PropertiesSection.SliceOffset"},{name:"sPlaneBoxMode",type:"string",JSONname:"PropertiesSection.PlaneBoxMode",defaultValue:"NormalMode"},{name:"bSectionCurvesVisible",type:"bool",JSONname:"PropertiesSection.SectionCurvesVisible",defaultValue:!1},{name:"bCustomCappingColor",type:"bool",JSONname:"PropertiesSection.GraphicProperties.Capping.customColor"},{name:"cCappingColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.Capping.color"},{name:"bCustomContourColor",type:"bool",JSONname:"PropertiesSection.GraphicProperties.LineStyle.customColor"},{name:"cLineStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.LineStyle.color"},{name:"sLineStylePattern",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.pattern"},{name:"fLineStyleThicknessIndex",type:"float",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thicknessIndex",defaultValue:1},{name:"cFillStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.FillStyle.color",defaultValue:new f.Color(3575492)},{name:"fOpacity",type:"float",JSONname:"PropertiesSection.GraphicProperties.FillStyle.opacity",defaultValue:.5},{name:"bVisible",type:"bool",JSONname:"PropertiesSection.GraphicProperties.visible",defaultValue:!0},{name:"bClippingPlaneVisible",type:"bool",JSONname:"PropertiesSection.GraphicProperties.clippingPlanesVisible"},{name:"sTargetIds",type:"listStrings",JSONname:"targetIds",defaultValue:[]},{name:"sDisplayPlaneMode",type:"string",JSONname:"PropertiesSection.DisplayPlaneMode",defaultValue:"Plane"},{name:"sDisplayContourMode",type:"string",JSONname:"PropertiesSection.DisplayContourMode",defaultValue:"Contour"},{name:"sSectionRender",type:"string",JSONname:"PropertiesSection.SectionRender",defaultValue:"CutOneSide"},{name:"bPartialClippingMode",type:"bool",JSONname:"PropertiesSection.PartialClippingMode"},{name:"sUpdateAndFreezeMode",type:"string",JSONname:"PropertiesSection.UpdateAndFreezeMode",defaultValue:"Update"},{name:"fXDirGridStep",type:"float",JSONname:"PropertiesSection.XDirGridStep"},{name:"fYDirGridStep",type:"float",JSONname:"PropertiesSection.YDirGridStep"},{name:"vTranslationValue",type:"float",JSONname:"PropertiesSection.TranslationValue",defaultValue:0},{name:"iGridAbsoluteMode",type:"int",JSONname:"PropertiesSection.GridAbsoluteMode",defaultValue:1},{name:"sLinkedObjectId",type:"string",JSONname:"linkedObjectId"},{name:"mRelativePosition",type:"Matrix4",JSONname:"relativePosition"},{name:"iCutUncutMode",type:"int",JSONname:"PropertiesSection.CutUncutMode"},{name:"bClipping",type:"bool",JSONname:"PropertiesSection.Clipping"},{name:"bClippingActiveState",type:"bool",JSONname:"PropertiesSection.ClippingActiveState"},{name:"fLineStyleThickness",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thickness"}];return t.extend({init:function(t){var U,I=t.viewer,B=t.expParent;this.getPlaneOffsetAsPerBB=()=>U,this.setPlaneOffsetAsPerBB=e=>{U=e};var k=t.typeApps,L=t.modeType,F=t.sectionEditCmd,z=t.context,W=t.clippingPrecisePosCmd,G=t.sType?t.sType:"Clipping",H=t.contextbarLib,j=t.propertiesLib,X=t.nodeClass,Y=this;this.storeyMode=t.isStoreyMode,this.csoList=t.csoList,this._parent(I,B);var J=null;this._frmWindow&&(this._executionContext=this._frmWindow.getExecutionContext?this._frmWindow.getExecutionContext():this._frmWindow.getContextualUIManager&&this._frmWindow.getContextualUIManager()?this._frmWindow.getContextualUIManager()._executionContext:void 0);let Z={getFrameWindow:()=>this._frmWindow};if(!this._frmWindow||!this._frmWindow.getViewerFrame){let e=require("DS/CATWebUXComponents/DMUFrameWindow");this._executionContext||(J=C.getContextViewer({viewer:Y._viewer})).getExecutionContex&&(this._executionContext=J.getExecutionContex()),e&&this._executionContext&&(e.init(Z,{executionContext:this._executionContext}),Z&&Z.getFrameWindow&&(this._frmWindow=Z.getFrameWindow(),this.getFrameWindow=function(){return Y._frmWindow?Y._frmWindow:Z.getFrameWindow()}))}if(this.addParameters(E),z)this._context=z;else{var q,Q=C.getContextViewer({reviewContext:C.getReviewContext({viewer:I})});Q&&(q=Q.getCommandContext()),this._context=q||"Default"}var K,$;this.setAttribute("sType",G),W&&(K=W),this._sectionObjectMode=L,this._tokenModelEvent=[],F?$=F:($=n.getEditCmd(I))&&($.isRunning()||$.isPaused())&&$.cancel(),Y._typeApps=k,Y.updateAppType=function(e){e&&(Y._typeApps=e)},this._nSectionCurvesNode=new i,this._nSectionCurvesNode.getDMUType=function(){return Y.getType()},this._nSectionCurvesNode.contourNode=!0;var ee=new i,te=!0,ie=(new f.Matrix4).makeScale(10,0,0),ne=!0,oe=[],re=[],ae=[],le=[],se=[],ce=!1,ue=!1,pe=null,ge=[],de=null,fe=!1,ve=!0,me=[];this._translationValue=0;var he=!1;this._vTranslationValue=50;var Se=H||"DS/DMUSection/DMUClippingContextualBar",Ce=[],be=0;var Me,ye=C.getContextViewer({reviewContext:C.getReviewContext({viewer:I})}),Pe=ye.subscribe({event:"onRepresentationLoaded"},(function(){if(Y.getAttribute("sLinkedObjectId")){var e=Y.getAttribute("sLinkedObjectId");if(null!=e)e.length>0&&(!function(){if(Y.getAttribute("sLinkedObjectId")&&Y.getAttribute("mRelativePosition")){var e=Y.getAttribute("sLinkedObjectId");if(null!=e&&e.length>0){var t=Y.getAttribute("mRelativePosition"),i=new f.Matrix4;i.getInverse(t);var n=e[0],o=x.getAbsolutePositionMatrix(Y,i,n);if(null!=o){var r={attribute:"mPlaneReferential",value:o.rotateX(Math.PI)};Y.set(r),Y.getNode().updateRobotPos(!0),Y._viewer.render({forceDynamicMode:!0})}}}}(),ye.unsubscribe(Pe))}})),we=function(){return s.isOOC(P,Y._viewer)};function De(){let e=Y.getBB();Y._bSphere||(Y._bSphere=c.computeBoundingSphere(Y._viewer,ae));var t=new f.Vector3((e.max.x+e.min.x)/2,(e.max.y+e.min.y)/2,(e.max.z+e.min.z)/2),i=Math.ceil(Math.max(2*Y._bSphere.radius,e.max.distanceTo(e.min))),n=Y.getCenter(),o=-1,r=1,a=0,l=.9995,s=!1,u=Y.getNormal().normalize();u=function(e){var t=e;if(t){var i=t.clone().normalize(),n=.9995;i.x>n||i.y>n||i.z>n?t=i.negate():(-i.x>n||-i.y>n||-i.z>n)&&(t=i)}return t}(u),Y._dotXNormal=u.clone().dot(new f.Vector3(1,0,0)),Y._dotYNormal=u.clone().dot(new f.Vector3(0,1,0)),Y._dotZNormal=u.clone().dot(new f.Vector3(0,0,1));var p,g=t.clone().projectOnVector(u.clone()),d=n.clone().projectOnVector(u.clone());Y._vProjBoxCenterOnPlaneNormal=n.clone().add(g.clone().sub(d.clone())),Y._centerNearPlane=(new f.Vector3).addVectors(Y._vProjBoxCenterOnPlaneNormal,u.clone().multiplyScalar(.5*i)),Y._centerFarPlane=(new f.Vector3).subVectors(Y._vProjBoxCenterOnPlaneNormal,u.clone().multiplyScalar(.5*i));let v,m=Y.getNode();if(m&&(v=m.getRobot()),v&&(p=v._getRulerOriginPos()),null==p&&(p=n.clone()),null!=p){var h=Y._centerNearPlane.clone().distanceTo(n.clone()),S=Y._centerFarPlane.clone().distanceTo(n.clone()),C=u.clone().negate(),b=p.clone().projectOnVector(u.clone()),M=(b=n.clone().add(b.clone().sub(d.clone()))).clone().sub(n.clone()),y=b.clone().sub(Y._centerFarPlane.clone()),P=b.clone().sub(Y._centerNearPlane.clone()),w=M.clone().normalize().dot(C.clone().normalize()),D=y.clone().normalize().dot(C.clone().normalize()),x=P.clone().normalize().dot(C.clone().normalize());a=n.clone().distanceTo(b.clone()),r=Y._centerFarPlane.clone().distanceTo(b.clone()),o=Y._centerNearPlane.clone().distanceTo(b.clone()),w>l&&(a=-a),D>l&&(r=-r),x>l&&(o=-o),Math.abs(h+S-i)<=.001||(h>S?(a=r,s=!0):h<S&&(a=o,s=!0))}return{value:a,minValue:o,maxValue:r,manipRange:i,bSectionPlaneOutOfmanipRange:s}}function xe(e){if(void 0!==l.getValue(Y,"vTranslationValue")){var t=D.convert(e,"length",S.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value,"mm");l.setValue(t,Y,"vTranslationValue")}}function Ae(){if(!Y.isSinglePlaneMode()||!Y.isSectionDisplayed())return;if($||($=n.getEditCmd(Y._viewer)),$&&!$.isRunning())return;var e=De();Y.setTranslationValue(e.value,!1),Y._cleanManipulationTool();let t=!1,i=C.getReviewContext({viewer:Y._viewer});if(B){let e;if("DMUTemporaryBag"===B.getType())e=B.getDMUObjects("DMUCompare3D");else if(i){let t=i.getCurrentSessionMarkup();t.getCurrentSlide()&&(e=t.getCurrentSlide().getDMUObjects("DMUCompare3D"))}e&&e.length&&(t=!0)}if(!Y.isConstructionItemMode()&&A.manipulation.getStatus()){Y.clearOtherslider();var r=S.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value;Y._movegauge=new o({iOwner:Y,iReviewContext:i,frameWindow:Y._frmWindow,runningApp:Y._typeApps,initValue:e.value,initMinValue:e.minValue,initMaxValue:e.maxValue,initStepValue:A.manipulation.getIncrementValToSet(r),initManipRange:e.manipRange,onChangeSliderCB:xe,onChangeSpinnerCB:xe,notifyOutOfRange:e.bSectionPlaneOutOfmanipRange,hasCompareObject:t,viewType:"3dPlay"===Y._typeApps||A.manipulation.isExploreView()?"ExploreView":"DetailedView"}),Y._movegauge&&Y._movegauge.subscribeToPrefChangeEvt&&Y._movegauge.subscribeToPrefChangeEvt({event:"onPreferencesChanged",cb:Me})}}function Ve(e){null!==Y._nSectionCurvesNode&&Y._nSectionCurvesNode.removeChildren(),e||(null!==ee&&ee.removeChildren(),ce=!0),le=[],se=[]}function Ne(){Ce.length>0&&me.length>0&&me.forEach((function(e){e&&e.removeSectionCappingMaterial()})),me=[],Ce=[],ue=!0,be=0}function _e(e){var t,i=Y.getAttribute("cHatchingColor")?Y.getAttribute("cHatchingColor").getHexString():void 0,n=Y.getAttribute("fHatchingLineStyleThickness"),o=Y.getAttribute("fHatchingSingleAngleValue"),r=Y.getAttribute("fHatchingPitchValue")?Y.getAttribute("fHatchingPitchValue")*window.devicePixelRatio:void 0,a=void 0;if(Y.isCustomColorSorce("Capping")&&(a=Y.getAttribute("cCappingColor")),"Single"===e)t=new f.ScreenSizeHatchingMeshMaterial({stripesDirection:new f.Vector2(Math.cos(o),Math.sin(o)),stripesColor:"#"+i,stripesWidth:n,spaceColor:a,autoSpaceColor:void 0===a,spaceWidth:r*window.devicePixelRatio}),Ce.push(t);else if("Various"===e){let e=[30*Math.PI/180,-30*Math.PI/180,60*Math.PI/180,-60*Math.PI/180];for(let o=0;o<e.length;o++)t=new f.ScreenSizeHatchingMeshMaterial({stripesDirection:new f.Vector2(Math.cos(e[o]),Math.sin(e[o])),stripesColor:"#"+i,stripesWidth:n,spaceColor:a,autoSpaceColor:void 0===a,spaceWidth:r}),Ce.push(t)}}function Re(e,t){var i;if(e.length>0&&t.length>0){var n=Y.getAttribute("sLineStylePattern"),o=Y.getAttribute("fLineStyleThickness");o||(o=Y.getAttribute("fLineStyleThicknessIndex"));var r=a.createPolylines(e,t,o,n);(i=v.createMeshNode(r)).name=T.sectioncurves,i.measurable=!0}return i}function Oe(e,t){var i=Re(e,t);i&&ee.add(i)}function Te(e,t,o){for(var r=[],a=[],l=e.aAllPolygons.length,s=Y.getAttribute("cLineStyleColor"),c=Y.isCustomColorSorce("Contour"),u=0;u<l;u++){var p=n.trimPolylines(e.aAllPolygons[u]._Polylines,o);p.length>0&&(r.push(p),a.push(c?s:e.aAllColors[u]),le.push(p),se.push(c?s:e.aAllColors[u]))}!function(e,t,n){if(te||Y.isSecondaryViewerShow()){var o=Re(t,n);if(o){var r=new i;r.name=T.sectioncurves,r.measurable=!0,r.getDMUType=function(){return Y.getType()},r.add(o),e&&r.setMatrix(e),Y._nSectionCurvesNode.add(r)}Y._nSectionCurvesNode.setVisibility(Y._bIsInShowSpace)}Y.isSecondaryViewerShow()&&Oe(t,n)}(t,r,a)}function Ee(e){e?Y.setSectionCurveUpdateStatus(!0):Y.setSectionCurveUpdateStatus(!1),Y.refreshNode(),Y._viewer.render({forceDynamicMode:!0})}function Ue(){var e=[],t=Y.getAttribute("sTargetIds"),i=t.length;if(C.getReviewContext({viewer:Y._viewer})){var n=Y.getParent();if(n){var o=n.getAttribute("oLinksManager");if(o&&i>0)for(var r=0;r<i;r++){var a,l=o.getChildWithID(t[r]);l&&(a=o.getOccurrenceIdPath(l.path)),a&&e.push(a)}}}return e}if(this.cleanLockedInRAMNodes=function(){if(ge.length>0&&de){for(var e=0;e<ge.length;e++)de.unlockRepresentationMeshInRAM(ge[e]);ge=[]}},this.unsuscribeOnRepLoading=function(){pe&&(J&&J.unsubscribe(pe),pe=null)},this.isSectionDisplayed=function(){return Y.isVisible()&&Y.getActiveFlag()&&Y.isDisplayed()&&Y.getAttribute("bVisible")},this.isSectionUpdateReq=function(){return(Y.isTemporaryClipping()||Y.isVisible())&&Y.getActiveFlag()&&Y.isDisplayed()&&Y.getAttribute("bVisible")},this.isClippingPlaneVisible=function(){return!0===Y.getAttribute("bClippingPlaneVisible")},this._cleanManipulationTool=function(){Y._movegauge&&(Y._movegauge.unsubscribeToPrefChangeEvt(),Y._movegauge.clean(),Y._movegauge=null)},Y._buildManipulationTool=function(){Y.isSectionDisplayed()&&(Y._movegauge&&Y._movegauge.getVisibleFlag()||(Ae(),Y._movegauge&&Y._movegauge.setVisibleFlag(!0)))},Me=function(){Y._movegauge&&Y._movegauge.getVisibleFlag()&&(Y._cleanManipulationTool(),Ae(),Y._movegauge&&Y._movegauge.setVisibleFlag(!0))},this.refreshSlider=function(){if(!Y._movegauge||Y._movegauge.bPerformRefreshOrCreate){if(he=!0,Y._movegauge){var e=De();Y._movegauge.update({value:e.value,minValue:e.minValue,maxValue:e.maxValue,stepValue:localStorage.getItem("IncrementValue"),notifyOutOfRange:e.bSectionPlaneOutOfmanipRange}),Y.setTranslationValue(e.value,!1),Y._movegauge&&Y._movegauge.setVisibleFlag(!0)}he=!1}},this._viewer){var Ie;this._bIsInShowSpace=0!==this._viewer.getVisibleSpace();var Be,ke,Le=function(e){Ie&&clearTimeout(Ie),Ie=setTimeout((function(){if(Ie=null,Y._bBox=null,Y._bSphere=null,!Y||!Y._viewer||!Y.isSectionDisplayed())return;Y._bUpdateOnModelChange=!0;let t=Y.getNode();if(t&&Y.isConstructionItemMode()&&e&&n.getRootsForClipping(Y._viewer).length){let e,o,r=n.getBuildingRootData(Y._viewer,void 0,!0),a=!1,l=!1;if(J||(J=C.getContextViewer({viewer:Y._viewer})),r)for(var i=0;i<r.length;i++)if(a||r[i]&&r[i].ID&&(a=!0,e=r[i]),o=O.getStoreyInfo(r[i]?r[i].ID:void 0,J),o&&o.length){l=!0;break}if(!a||!l)if(a){if(!l){O.clearStoreyNavigratorController({context:J});let i=e=>{let t=e.GetPosition3D();Y.updateClippingPosAndOrientation(t),n.setStoreyinfoOnSlide(Y._viewer,e.GetCurrentStorey()),Y.manageNavigatorEdition(),Y._viewer.render({forceDynamicMode:!0})},o=()=>{let e="NormalMode";if(localStorage.setItem("DMUClippingBoxMode",e),Y.setAttribute("sPlaneBoxMode",e),t){let e=t.getRobot();e||(t.initClippingRobot(),e=t.getRobot()),e&&e.updateRobotPos()}Y.refreshNode(),Y._viewer.render({forceDynamicMode:!0})};Y._storeyNavigatorcntroller=O.getDMUStoreyNavigratorController({context:J,getBuidlingRootID:()=>e?r.ID:void 0,storyeRetrivalSuccessCB:i,storyeRetrivalFailCB:o})}}else Y.resetToNormalMode(t)}e&&t.resetClippingFlag(),Y.refreshNode(),Y._viewer.render({forceDynamicMode:!0}),Y._bUpdateOnModelChange=void 0}),100)},Fe=function(){Le(!1)},ze=C.giveEventsController({viewer:this._viewer});if(ze&&!this._tokenModelEvent.length)ke=ze.addEvent(m.Events.EXPRootModifiedEvent,(function(){Le(!0)})),this._tokenModelEvent.push(ke),ke=ze.addEvent(m.Events.EXPMoveEvent,Fe),this._tokenModelEvent.push(ke),ke=ze.addEvent(m.Events.EXPHideShowEvent,Fe),this._tokenModelEvent.push(ke),ke=ze.addEvent(m.Events.EXPModelUpdatedEvent,Fe),this._tokenModelEvent.push(ke),ke=ze.addEvent(m.Events.EXPLineLayoutComputationBeginEvent,(function(){Y.isSectionDisplayed()&&(Be=Y.isVisible(),Y.setVisibleFlag(!1,!1,!0),Y.refreshNode(),Y._viewer.render({forceDynamicMode:!0}))})),this._tokenModelEvent.push(ke),ke=ze.addEvent(m.Events.EXPLineLayoutComputationEndEvent,(function(){"boolean"==typeof Be&&(Y.setVisibleFlag(Be,!1,!0),Be=void 0,Le())})),this._tokenModelEvent.push(ke),we()||(ke=ze.addEvent(m.Events.EXPStartProgressiveLoad,(function(){Ve(),Ne(),Y._bLoadingInProgress=!0,Ee(!1),Y._bPreviousLoadingInProgress=!0})),this._tokenModelEvent.push(ke),ke=ze.addEvent(m.Events.EXPEndProgressiveLoad,(function(){Y._bLoadingInProgress=!1,Ee(!0),Y._bPreviousLoadingInProgress=!1})),this._tokenModelEvent.push(ke));if(!Y._tokenOnPimCtrlOpacityChange){require(["DS/PIMwebViewController/PIMwebItfCtrl"],(function(e){J||(J=C.getContextViewer({viewer:Y._viewer})),Y._pimCtrl=e.giveItfCtrl({pad3DViewer:J}),Y._pimCtrl&&(Y.itfZeroOpacityflag=!0,Y._tokenOnPimCtrlOpacityChange=Y._pimCtrl.subscribe("onOpacityChange",(function(e){e.data&&(0===e.data.oldValue&&0!==e.data.newValue||0!==e.data.oldValue&&0===e.data.newValue)&&(0===e.data.newValue?Y.itfZeroOpacityflag=!0:Y.itfZeroOpacityflag=!1,Le())})))}))}var We=h.getDMUMarkupsController({context:this._viewer,frmWindow:this._frmWindow});We&&We.registerMarker(this)}Y.retriveHatchingData=function(e){return e||Y.isSectionDisplayed()&&Y.getAttribute("bHatchingDisplay")&&ve?(0===Ce.length&&_e("Single"===Y.getAttribute("sHatchingAnglesMode")?"Single":"Various"),Ce):[]},this.initAuthoringData=function(){-1!==C.getAuthoringFeatureTypes().indexOf("Section")&&(-1===C.getAuthoringFeatureTypes().indexOf("Section")||Y.getContextualCommandList||require([Se],(function(e){var t=new e;Y.getContextualCommandList=t.getContextualCommandList,Y.getSharedContextualCommandList=t.getSharedContextualCommandList,Y.getSharedHeaderTypes=t.getSharedHeaderTypes,t.setCheckCmdHdrState&&(Y.setCheckCmdHdrState=t.setCheckCmdHdrState),t.applyStateToContextHdr&&(Y.applyStateToContextHdr=t.applyStateToContextHdr),"ProgressiveVisuLoading"!==Y._typeApps&&(Y.getSharedContextualMenuCommandList=t.getSharedContextualMenuCommandList,Y.getContextualMenuCommandList=t.getContextualMenuCommandList),t.register({frmWindow:Y._frmWindow,type:Y.getType()});var i=1===b.get().length?b.get()[0].pathElement.clone():null;i&&i.getLastElement(!0).getDMUType&&(i.getLastElement(!0)===Y.getNode()||i.getLastElement(!0)===Y._nSectionCurvesNode)&&(b.empty(),b.add({pathElement:i}))})),Y.getPropertiesObject||"ProgressiveVisuLoading"===Y._typeApps||require([j||"DS/DMUSection/DMUClippingProperties"],(function(e){var t=new e(Y);Y.getPropertiesObject=function(){return t}})))},this._getListOfPathForCutUnCut=function(){return function(){let e=[],t=[];var i=Y.getAttribute("sTargetIds"),n=i.length;if(C.getReviewContext({viewer:Y._viewer})){var o=Y.getParent();if(o){var r=o.getAttribute("oLinksManager");if(r&&n>0)for(var a,l=0;l<n;l++)(a=r.getOccurrencePathElement(i[l]))&&(e.push(a),t.push(i[l]))}}return{listOfSelectedObj:e,listOfID:t}}()},this.removeAuthoringData=function(){-1!==C.getAuthoringFeatureTypes().indexOf("Section")&&-1!==C.getAuthoringFeatureTypes().indexOf("Section")&&require([Se],(function(e){var t=new e;Y.getContextualCommandList=null,Y.getSharedContextualCommandList=null,Y.getSharedHeaderTypes=null,Y.getSharedContextualMenuCommandList=null,Y.getContextualMenuCommandList=null,Y.setCheckCmdHdrState=null,Y.applyStateToContextHdr=null,t.unregister({frmWindow:Y._frmWindow})}))},this.setSelectedObjectsIdsPathForCutUncut=function(e,t){if(!e||!e.length)return void this.setAttribute("sTargetIds",[]);let i,n=JSON.parse(e);var o=Y.getParent();if(o&&(i=o.getAttribute("oLinksManager")),i&&n&&n.length){let e=[];for(let t=0;t<n.length;t++){let o=i.getOccurrence({idPath:n[t]},!0);o&&o.id&&i.getOccurrencePathElement(o.id)&&e.push(o.id)}e.length&&(this.setAttribute("iCutUncutMode",t),this.setAttribute("sTargetIds",e))}},this.getSelectedObjectsIdsPathForCutUncut=function(){let e=[],t=Ue();return t&&t.length&&(e=JSON.stringify(t)),e};var Ge=new y(Y);this.importData=Ge.importData,this.afterImport=Ge.afterImport,this.initAuthoringData(),this.getDMUObjectFromPathElement=function(e){if(e)for(var t=e.clone();t;){if(t.getLastElement(!0)===Y.getNode())return Y;t=t.getParentPath()}};var He=!1;this.getDoNotEndEditCmdState=function(){return He},this._startEditCommand=function(){if(K)Y.removeCurvesAndHatching(),K.begin(),K=void 0;else{if($=n.getEditCmd(Y._viewer)){var e=Y.getNode();if(e){let t,i=e.getRobot();i&&(t=i._getRulerOriginPos()),e.initClippingRobot(t)}}"DMUClipping"===this.getType()&&(Y._movegauge?this.refreshSlider():Ae())}},this._endEditCommand=function(){if($=n.getEditCmd(this._viewer),this.getDoNotEndEditCmdState()||!$||$.isEnding&&$.isEnding()||!$.isRunning()&&!$.isPaused())this.getDoNotEndEditCmdState()&&(He=!1);else{n.cleanClippingVisu(this._viewer);var e=Y.getNode();e&&e.setRobot(null)}};var je=this.setReadOnly;function Xe(){let e=n.getEditCmd(Y._viewer);e&&(e.isRunning()||e.isPaused())&&e.cancel()}this.setReadOnly=function(e,t){var i=Boolean(t);je(e,i),Y.getNode()&&Y.getNode().update(!0),this.setStoreyNavigatorEditionState(!e)};let Ye=this.setDisplayedFlag;this.setDisplayedFlag=function(e){let t=Y.isConstructionItemMode(),i=t?this._storeyNavigatorcntroller:void 0;t&&!i&&(i=O.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})}),this._storeyNavigatorcntroller=i),e?i&&(i.ShowStoreyNavigator(),this.isReadOnly()||this.manageNavigatorEdition(!0)):(i&&i.HideStoreyNavigator(),this.isInEdition()&&Xe()),Ye(e)};let Je=this.setVisibleFlag;this.setVisibleFlag=function(e,t,i){i||(!e&&this.isInEdition()?Xe():(this.manageNavigatorEdition(),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.ShowStoreyNavigator())),Je(e,t)},this.removeCurvesAndHatching=function(){Ve(),Ne(),this.cleanLockedInRAMNodes(),this.unsuscribeOnRepLoading()},this.manageCurvesAndHatching=function(t){if(!Y._posCmdActive&&(Y._bClipping||"DMUSection"!==Y.getType()||!this.isReadOnly()||"BoxMode"!==Y.getAttribute("sPlaneBoxMode")||"OnlyContour"===Y.getAttribute("sSectionRender"))){we()||(Ve(),Ne());var i,o=Y.getAttribute("mPlaneReferential");"BoxMode"===Y.getAttribute("sPlaneBoxMode")&&(i=new f.Box2);var r=Y.getAttribute("fXDirSize"),a=Y.getAttribute("fYDirSize"),l=Y.getAttribute("bHatchingDisplay"),c=t.computeCurves;if(i&&i.set(new f.Vector2(-r/2,-a/2),new f.Vector2(r/2,a/2)),c&&ne&&Y.isSectionDisplayed()&&(te||Y.isSecondaryViewerShow())||Y.isSectionDisplayed()&&l&&ve&&Y.isHatchingUpdateNeeded()){Y.removeCurvesAndHatching(),ie=o.clone(),ce=!1,ue=!1;var u=function(e,c){var u=[],p=[];if(Y._bIsInShowSpace?e.forEach((function(e){e&&e.getLastElement&&!s.isOOCTileSetNode(e.getLastElement(!0))&&u.push(e)})):c.forEach((function(e){e&&e.getLastElement&&!s.isOOCTileSetNode(e.getLastElement(!0))&&p.push(e)})),Y._bIsInShowSpace&&u.length>0||!Y._bIsInShowSpace&&p.length>0){if(t.computeCurves&&ne&&Y.isSectionDisplayed()&&(te||Y.isSecondaryViewerShow())){var g=o;if(Te(n.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,i),"SliceMode"!==Y.getAttribute("sPlaneBoxMode")&&"BoxMode"!==Y.getAttribute("sPlaneBoxMode")||(g=Y._getPlanReferential("Back"),Te(n.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,i)),"BoxMode"===Y.getAttribute("sPlaneBoxMode")){var d=Y.getAttribute("fSliceOffset");i&&i.set(new f.Vector2(-r/2,-d/2),new f.Vector2(r/2,d/2)),g=Y._getPlanReferential("Top"),Te(n.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,i),g=Y._getPlanReferential("Bottom"),Te(n.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,i),i&&i.set(new f.Vector3(-d/2,-a/2,0),new f.Vector3(d/2,a/2,0)),g=Y._getPlanReferential("Right"),Te(n.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,i),g=Y._getPlanReferential("Left"),Te(n.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,i)}t.action&&t.action(),Y._viewer.render({forceDynamicMode:!0})}var v="Single"===Y.getAttribute("sHatchingAnglesMode");!(Y.isSectionDisplayed()&&l&&ve)||Y.getNode().isHachingAlreadyApplied()&&Y.isCutUncutOn()||function(e){if(e.cutObjects&&e.cutObjects.length>0){if(0===Ce.length&&_e(e.anglesMode),4===Ce.length)for(let n=0;n<e.cutObjects.length;n++){var t=e.cutObjects[n];if(t){var i=t.getLastElement();i&&-1===me.indexOf(i)&&(i.setSectionCappingMaterial(Ce[be%4]),be++,me.push(i))}}Y._viewer.render({forceDynamicMode:!0})}}({cutObjects:Y._bIsInShowSpace?u:p,anglesMode:v?"Single":"Various"})}},p=!1;if(we()&&(p=!0),p){if(Y.promiseToResolve&&Y.promiseToResolve.length&&(Y.promiseToResolve.forEach((e=>{e("CancelOnDemand")})),Y.promiseToResolve=[]),J||(J=C.getContextViewer({viewer:Y._viewer})),de||J&&(de=J.getController()),de&&J){var g=s.getRootReferences(Y._viewer,!0),d=[],v=[],m=t=>{if(!t||!t.root||!t.cuttingPlane&&!t.cuttingBox)return;let i=t.root,n=t.cuttingPlane,o=t.cuttingBox,r=Boolean(t.computeCurves),a=de.getRootStats(i.getModelIdentification());a&&a.initialPathes&&a.initialPathes.length&&a.initialPathes.forEach((t=>{v.push(de.completeSessionWithClippingOperatorCandidates({path:e.clone(t),sectionPlane:n,box:o,meshInRAM:r}))}))};if(Y.isSinglePlaneMode()){var h=Y.getCenter(),S=Y.getUDirection(),b=Y.getVDirection(),M={origin:[h.x.toString(),h.y.toString(),h.z.toString()],u_direction:[S.x.toString(),S.y.toString(),S.z.toString()],v_direction:[b.x.toString(),b.y.toString(),b.z.toString()]};if(g.length>0)for(var y=0;y<g.length;y++)m({root:g[y],cuttingPlane:M,computeCurves:c})}if("SliceMode"===Y.getAttribute("sPlaneBoxMode")){var P=Y.getCenter(),D=Y.getUDirection(),x=Y.getVDirection(),A={origin:[P.x.toString(),P.y.toString(),P.z.toString()],u_direction:[D.x.toString(),D.y.toString(),D.z.toString()],v_direction:[x.x.toString(),x.y.toString(),x.z.toString()]},V=Y.getCenter(Y._getPlanReferential("Back")),N=Y.getUDirection(Y._getPlanReferential("Back")),_=Y.getVDirection(Y._getPlanReferential("Back")),R={origin:[V.x.toString(),V.y.toString(),V.z.toString()],u_direction:[N.x.toString(),N.y.toString(),N.z.toString()],v_direction:[_.x.toString(),_.y.toString(),_.z.toString()]};if(g.length>0)for(var O=0;O<g.length;O++)m({root:g[O],cuttingPlane:A,computeCurves:c}),m({root:g[O],cuttingPlane:R,computeCurves:c})}else if("BoxMode"===Y.getAttribute("sPlaneBoxMode")){var E=Y.getAttribute("fSliceOffset"),U=new f.Vector3(a,r,E),I=(new f.Matrix4).copy(o);I.rotateZ(-Math.PI/2),I.translate(new f.Vector3(-a/2,-r/2,0));var B=[I.elements[0],I.elements[1],I.elements[2],I.elements[4],I.elements[5],I.elements[6],I.elements[8],I.elements[9],I.elements[10],I.elements[12],I.elements[13],I.elements[14]],k={corner_min:[0,0,0],corner_max:[U.x,U.y,U.z],transformation_matrix:B,intersection_mode:"across"};if(g.length>0)for(var L=0;L<g.length;L++)m({root:g[L],cuttingBox:k,computeCurves:c})}var F=function(e){if(Y.promiseToResolve=[],e.length>0){e.forEach((function(e){if(e.selectedPaths.length>0){var t=Ue(),i=Y.getAttribute("iCutUncutMode");e.selectedPaths.forEach((function(e){var n=e.length;if(t.length>0){for(var o=!1,r=0;r<t.length;r++){var a=t[r],l=a.length;if(l<n||!i&&l===n)for(var s=0;s<l;s++){if(a[s]!==e[s]){o=!1;break}o=!0}if(o)break}i&&o?d.push(e):i||o||d.push(e)}n>0&&c&&ge.push(e[n-1])})),t.length>0&&i?d.push.apply(d,t):0===t.length&&d.push.apply(d,e.selectedPaths)}})),pe||(pe=J.subscribe({event:"onRepresentationLoaded"},(function(e){if(c&&de.hasMeshInRAM(e)||l&&!c){for(var t=[],i=0;i<d.length;i++)-1!==d[i].indexOf(e)&&t.push(de.buildPathFromArray(d[i]));if(t.length>0){for(var n=[],o=[],r=0;r<t.length;r++)s.parseForLeafNodes(t[r],Y._viewer,n,o,Boolean(Y.itfZeroOpacityflag));u(n,o)}}})));for(var t=[],i=[],n=0;n<d.length;n++){var o=d[n][d[n].length-1];if(de.isReferenceComplete(o)&&(c&&de.hasMeshInRAM(o)||l&&!c)){var r=de.buildPathFromArray(d[n]);s.parseForLeafNodes(r,Y._viewer,t,i,Boolean(Y.itfZeroOpacityflag))}}u(t,i)}},z=function(){Y.promiseToResolve=[],w&&w.displayNotification({eventID:"warning",msg:T.notifyComputeContourfailure}),Y.unsuscribeOnRepLoading(),Ve(),Ne(),ce=!1};Y.isConstructionItemMode()?v.forEach((e=>{Promise.race([e,new Promise((e=>{Y.promiseToResolve||(Y.promiseToResolve=[]),Y.promiseToResolve.push(e)}))]).then((function(e){"string"!=typeof e&&F([e])}),(function(){z()}))})):Promise.all(v).then((function(e){F(e)}),(function(){z()}))}}else Y.collectCutObjects(),u(oe,re)}}},this._getPlanReferential=function(e){var t=new f.Matrix4;let i=Y.getAttribute("mPlaneReferential");if(i&&(t=t.copy(i),e)){var n=Y.getAttribute("fSliceOffset");"Back"===e?(t.rotateX(Math.PI),t.translate(new f.Vector3(0,0,-n))):"Top"===e?(t.rotateX(-Math.PI/2),t.translate(new f.Vector3(0,-n/2,-Y.getAttribute("fYDirSize")/2))):"Bottom"===e?(t.rotateX(Math.PI/2),t.translate(new f.Vector3(0,n/2,-Y.getAttribute("fYDirSize")/2))):"Left"===e?(t.rotateY(Math.PI/2),t.translate(new f.Vector3(-n/2,0,-Y.getAttribute("fXDirSize")/2))):"Right"===e&&(t.rotateY(-Math.PI/2),t.translate(new f.Vector3(n/2,0,-Y.getAttribute("fXDirSize")/2)))}return t},this.isSectionCurveComputationNeeded=function(){var e=!1;if(!Y._bLoadingInProgress)if(Y._bUpdateOnModelChange)e=Y._bUpdateOnModelChange;else{var t=Y.getAttribute("mPlaneReferential");Y.isSectionDisplayed()&&(ce||!p.areMatrixEqual(ie.elements,t.elements)||Y._bPreviousLoadingInProgress)&&(e=!0)}return e},this.isHatchingUpdateNeeded=function(){var e=!1;if(!Y._bLoadingInProgress)if(Y._bUpdateOnModelChange)e=Y._bUpdateOnModelChange;else{var t=Y.getAttribute("mPlaneReferential");Y.isSectionDisplayed()&&(ue||!p.areMatrixEqual(ie.elements,t.elements)||Y._bPreviousLoadingInProgress)&&(e=!0)}return e},this.isSecondaryViewerShow=function(){return Y._iViewerSecondaryWindow&&Y._iViewerSecondaryWindow.isShow()};var Ze=!1,qe=!1;this.isManipulationOnGo=function(){return Ze||Y._posCmdActive},this.beginManipulation=function(e){if(e&&e.doNotSetPlaneMoveEvent||!Y._viewer.onSectionPlaneMoveStart||Y._viewer.onSectionPlaneMoveStart(),Ze=!0,qe=!1,ve=!1,this.getAttribute("bHatchingDisplay")&&this.getNode().isClippingEnabled()){this.getNode().enableClipping(!1);let e=this.retriveHatchingData(!0);e&&1===e.length?this.getNode().updateClippingPlaneWithMaterial(Y.getAttribute("sPlaneBoxMode"),!0):Ne(),this.getNode().enableClipping(!0)}ne=!1,fe=!1,Y._movegauge&&Y.refreshSlider?Y.refreshSlider():Ae()},this.doManipulation=function(e){Ze=!0,qe=!0,we()&&(ne=!1,Ve(!0),this.cleanLockedInRAMNodes()),void 0===e&&Ee(!1),Y.updatePosToStoreyNavigator(),Y._viewer.render({forceDynamicMode:!0}),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():Ae()},this.addOrRemoveFromCSO=function(e){var t={pathElement:s.buildPathElement(Y.getNode())};b.isIn(t)?e||b.remove(t):e&&b.add(t)},this.endManipulation=function(e,t){Y._viewer.onSectionPlaneMoveEnd&&Y._viewer.onSectionPlaneMoveEnd();let i=Y.getNode();if(ne=!0,ve=!0,i&&Y.isCutUncutOn()&&!i.isHachingAlreadyApplied()&&i.refreshCutUnCut(),Y.updatePosToStoreyNavigator(),this.getAttribute("bHatchingDisplay")&&this.getNode().isClippingEnabled()){let e=this.retriveHatchingData(!0);e&&1===e.length&&this.getNode().updateClippingPlaneWithMaterial(Y.getAttribute("sPlaneBoxMode"),!1)}if(!fe){var n={pathElement:s.buildPathElement(Y.getNode())};e&&e.from&&(He=!0,!e||e&&!e.from[0].event.ctrlKey?(b.empty(),b.add(n)):b.isIn(n)?b.remove(n):b.add(n),He&&(He=!1))}if(t)return!0;Ee(!0),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():Ae(),Ze=!1,qe&&Y.fireEvent("onDMUObjectAttributeModified",{dmuObject:Y}),qe=!1,Y.fireEvent("onEndSectionManipulation",{dmuObject:Y})},this.onLongHold=function(){fe=!0},this.setObjects=function(e,t){if(e&&e.length>0){ae||(ae=[]);var i=e.length,o=Y.getParent();if(o&&o.getOccurence){for(var r,a,l=Y.getAttribute("sTargetIds"),s=0;s<i;s++)if(r=o.getOccurence({pathElement:e[s]},!0))if((a=l.indexOf(r.id))>=0){var u=l.slice(0,a),p=l.slice(a+1);l=u.concat(p);var g=ae.slice(0,a),d=ae.slice(a+1);ae=g.concat(d)}else l.push(r.id),ae.push(e[s]);Y.setAttribute("sTargetIds",l)}if(!t){var f=c.computeBoundingBox(Y._viewer,ae),v=Math.max(f.max.x-f.min.x,f.max.y-f.min.y,f.max.z-f.min.z),m=n.computeSectionPlaneReferencial(Y._viewer,f);Y.getNode()&&Y.getNode().resetClippingFlag(),Y.setAttribute("fXDirSize",v),Y.setAttribute("fYDirSize",v),Y.modifyPlaneReferential(m),Y.getNode()&&Y.getNode().updateRobotPos(!0)}}},this.collectCutObjects=function(){var e=[],t=!1,i=void 0;let n=Y.getAttribute("iCutUncutMode");var o=C.getContextViewer({viewer:Y._viewer});if(we())(e=Ue())&&e.length>0&&(t=!0,i=void 0!==n?n:1);else{var r=function(){ae=[];var e=Y.getAttribute("sTargetIds"),t=e.length;if(C.getReviewContext({viewer:Y._viewer})){var i=Y.getParent();if(i){var n=i.getAttribute("oLinksManager");if(n&&t>0)for(var o,r=0;r<t;r++)(o=n.getOccurrencePathElement(e[r]))&&ae.push(o)}}return ae}();if(r&&r.length>0)if(t=!0,null!=n)oe=r,re=[],i=n;else for(var a=r.length,l=0;l<a;l++)s.parseForLeafNodes(r[l],Y._viewer,oe,re,Boolean(Y.itfZeroOpacityflag));else s.parseForLeafNodesOfScene(o,oe,re,Boolean(Y.itfZeroOpacityflag))}return t||(t=ae&&ae.length>0),{CutObjects:oe,NoCutObjects:re,CutObjectsOOC:e,bIsPartial:t,cutUncutMode:i}},this.onViewerEventCB=function(e){J||(J=C.getContextViewer({viewer:Y._viewer}));let t=c.getClippingCmd(J);if(!t||t.getState()){var i=!0,n=C.getReviewContext({viewer:this._viewer});if(!n||n.isVisible()&&(!n.getCurrentSessionMarkup()||n.getCurrentSessionMarkup().isVisible())&&this.isDisplayed()||(i=!1),i){var o=0!==Y._viewer.getVisibleSpace();if("beginExplodeCmd"===e.eventType){Y._bIsInShowSpace===o&&Y.setVisibleFlag(!1,!1,!0);var r={pathElement:s.buildPathElement(Y.getNode())};b.isIn(r)?b.remove(r):(r={pathElement:s.buildPathElement(Y._nSectionCurvesNode)},b.isIn(r)&&b.remove(r)),Y.refreshNode(),Y.getNode().enableClipping(!1),Y._viewer.setSectionCapping(!1)}else"endExplodeCmd"===e.eventType&&(Y._bIsInShowSpace===o&&Y.setVisibleFlag(!0,!1,!0),Y.refreshNode(),Y.getNode().enableClipping(!0),Y._viewer.setSectionCapping(!0))}}},this.setSectionCurveUpdateStatus=function(e){te=e};var Qe=this.refreshNode;this.refreshNode=function(e){if(Y.getNode()&&(!B.isImporting||B.isImporting&&!B.isImporting())){oe=[],re=[];var t=Y.isSectionDisplayed();Y.getNode().update(e),Y._viewer.render({forceDynamicMode:!0}),!t&&Y._iViewerSecondaryWindow&&Y._iViewerSecondaryWindow.clear(),Qe()}},this.manageLock=function(e){var t,i=!1;if(B&&"DMUTemporaryBag"===B.getType()&&(i=!0),i)t="boolean"==typeof e?e:!!this._viewer._lockUnlockCmd&&this._viewer._lockUnlockCmd.getState();else{var n=!this._bClippingPlaneVisible;Y.getNode()&&(t=!Y.isInEdition()&&n)}Y.getNode()&&Y.getNode().manageLock(t)},this.sectionToXYZ=function(e){let t=Y.getAttribute("sPlaneBoxMode");"BoxMode"!==t&&(e=this.updateClippingSize(e)),Y.modifyPlaneReferential(e),Y.getNode()&&Y.getNode().updateRobotPos(!0),Y._viewer.render({forceDynamicMode:!0}),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():Ae(),"BoxMode"===t&&Y.fireEvent("onDMUObjectAttributeModified",{dmuObject:Y}),Y.fireEvent("onEndSectionManipulation",{dmuObject:Y})},this.updateClippingSize=function(e){var t=e,i=this.getBB(),n=g.computePlaneDim(i,e,!1,!1,!0);if(n){if(n.fPlaneSizeV&&n.fPlaneSizeU){var o=n.fPlaneSizeU,r=n.fPlaneSizeV;Y.setAttribute("fXDirSize",o),Y.setAttribute("fYDirSize",r),Y.setAttribute("fXDirGridStep",o/20),Y.setAttribute("fYDirGridStep",r/20)}n.plane&&(t=n.plane)}return t},this.sectionToX=function(e){e&&Y.getNode().clearAllRulers();var t=Y.getClippingCenter(),i=(new f.Matrix4).rotateY(-Math.PI/2).setPosition(t);i.setPosition(Y.getPlaneCenter(i)),Y.sectionToXYZ(i)},this.sectionToY=function(e){e&&Y.getNode().clearAllRulers();var t=Y.getClippingCenter(),i=(new f.Matrix4).rotateX(Math.PI/2).setPosition(t);i.setPosition(Y.getPlaneCenter(i)),Y.sectionToXYZ(i)},this.sectionToZ=function(e,t,i){i&&Y.getNode().clearAllRulers();var n=Y.getClippingCenter(),o=(new f.Matrix4).rotateY(Math.PI).setPosition(n);o.setPosition(e?t||new f.Vector3(0,0,0):Y.getPlaneCenter(o)),Y.sectionToXYZ(o)},this.sectionFlip=function(e){e&&Y.getNode().clearAllRulers();var t={attribute:"mPlaneReferential",value:Y.getAttribute("mPlaneReferential").rotateX(Math.PI)};Y.set(t),Y.getNode()&&Y.getNode().updateRobotPos(!0),Y.refreshNode(),Y._viewer.render({forceDynamicMode:!0}),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():Ae(),this.updatePosToStoreyNavigator(),"BoxMode"===Y.getAttribute("sPlaneBoxMode")&&Y.fireEvent("onDMUObjectAttributeModified",{dmuObject:Y}),Y.fireEvent("onEndSectionManipulation",{dmuObject:Y})},this.sectionViewpoint=function(){Y.getNode().clearAllRulers();var e=Y.getAttribute("mPlaneReferential"),t=1.5*Y.getAttribute("fXDirSize"),i=e.decompose(),n=i[0],o=i[1],a=new f.Vector3(1,0,0).applyQuaternion(o),l=new f.Vector3(0,1,0).applyQuaternion(o),s=new f.Vector3(0,0,1).applyQuaternion(o),c=a.dot(new f.Vector3(0,0,1)),p=l.dot(new f.Vector3(0,0,1)),g=Math.abs(c),d=Math.abs(p),v=a;if(u.isZero(g)&&u.isZero(d)){var m=r.getViewpointInfo(Y._viewer.currentViewpoint),h=a.dot(m.sight),S=l.dot(m.sight),C=Math.abs(h),b=Math.abs(S);u.isLessOrEqual(b,C)?u.isLessOrEqual(C,b)||(v=a.multiplyScalar(u.isLessThan(h,0)?-1:1)):v=l.multiplyScalar(u.isLessThan(S,0)?-1:1)}else u.isLessOrEqual(d,g)?u.isLessOrEqual(g,d)||(v=a.multiplyScalar(u.isLessThan(c,0)?-1:1)):v=l.multiplyScalar(u.isLessThan(p,0)?-1:1);r.moveViewpoint({freeZoneSize:Y._frmWindow.getImmersiveFrame().getFreeZone().getBoundingClientRect(),viewerSize:{width:Y._frmWindow.getViewer().SCREEN_WIDTH,height:Y._frmWindow.getViewer().SCREEN_HEIGHT},viewpoint:Y._viewer.currentViewpoint,target:n,sightDirection:s,upDirection:v,targetDistance:t,duration:400}),Y.getNode()&&Y.getNode().updateRobotPos(!0)},this.sectionCut=function(e){Y.getNode().clearAllRulers();var t=e;l.setValue(t,Y,"sSectionRender")},this.sectionGrid=function(){var e;Y.getNode().clearAllRulers(),e="Plane"===l.getValue(Y,"sDisplayPlaneMode")?"Grid":"Plane",l.setValue(e,Y,"sDisplayPlaneMode")},this.sectionSlice=function(){Y.getNode().clearAllRulers();l.setValue("SliceMode",Y,"sPlaneBoxMode"),l.setValue(20,Y,"fSliceOffset")},this.getTranslationValue=function(){return Y._translationValue},this.setTranslationValue=function(e,t){if(!1===t||!0===he)Y._translationValue=e;else{var i=Y.getCenter(),n=Y.getNormal();n=function(e){var t=e;if(t){var i=t.clone().normalize(),n=.9995;i.x>n||i.y>n||i.z>n?t=i.negate():(-i.x>n||-i.y>n||-i.z>n)&&(t=i)}return t}(n);var o=i.clone(),r=Y._centerNearPlane.distanceTo(Y._centerFarPlane),a=Y._centerNearPlane.distanceTo(i.clone()),l=Y._centerFarPlane.distanceTo(i.clone());if(Math.abs(a+l-r)<=.001){var s=Y.getTranslationValue();o=i.clone().add(n.clone().normalize().multiplyScalar(s-e))}else{var c=Y.getTranslationValue();a<l?o=Y._centerNearPlane.clone().add(n.clone().normalize().multiplyScalar(c-e)):a>l&&(o=Y._centerFarPlane.clone().add(n.clone().normalize().multiplyScalar(c-e)))}Y._translationValue=e;var u=Y.getAttribute("mPlaneReferential");u.setPosition(o),Y.modifyPlaneReferential(u),Y.getNode().updateRobotPos(!0),Y._viewer.render({forceDynamicMode:!0})}},this.modifyPlaneReferential=function(e){if(e){var t={attribute:"mPlaneReferential",value:Y.getAttribute("mPlaneReferential").copy(e)};Y.set(t),Y.getNode().update()}},this.getCenter=function(e){var t=e||Y.getAttribute("mPlaneReferential");return(new f.Vector3).getPositionFromMatrix(t)},this.getClippingCenter=function(){var e=Y.getAttribute("mPlaneReferential"),t=(new f.Vector3).getPositionFromMatrix(e),i=Y.getAttribute("sPlaneBoxMode");if("BoxMode"===i||"SliceMode"===i){var n=Y.getNode();if(n&&n.getCenter)t=n.getCenter();else{var o=Y.getAttribute("fSliceOffset");if(!isNaN(o)){var r=e.decompose(),a=new f.Vector3(0,0,1).applyQuaternion(r[1]);a=a.normalize().multiplyScalar(o/2),t=t.add(a)}}}return t},this.getPlaneCenter=function(e){return n.computePlaneCenter(e,this.getAttribute("fSliceOffset"),!this.isSinglePlaneMode())},this.getNormal=function(e){var t=(e||Y.getAttribute("mPlaneReferential")).decompose();return new f.Vector3(0,0,1).applyQuaternion(t[1])},this.computePlaneRef=function(e,t,i){let n=e;var o;n||(n=this.getNormal().negate().normalize());var r=!1;if(i&&n){let e=n.angleTo(this.getNormal().normalize());(u.isZero(e)||u.isZero(Math.PI-e))&&(r=!0)}var a=n.negate().normalize(),l=this.getBB();let c=t&&!r?t:this.getClippingCenter();if(l){let e=l.center();if(e&&a&&c){let t=d.computePointLineDistance(c.toArray(),e.toArray(),a.toArray()).aPosition;t&&(c=new f.Vector3(t[0],t[1],t[2]))}}var p=s.getXYAxisDirFromZ(a.clone());return p.xDir&&p.yDir&&(o=(new f.Matrix4).makeBasis(p.xDir,p.yDir,a)).setPosition(c),o},this.getUDirection=function(e){var t=(e||Y.getAttribute("mPlaneReferential")).decompose();return new f.Vector3(1,0,0).applyQuaternion(t[1])},this.getVDirection=function(e){var t=(e||Y.getAttribute("mPlaneReferential")).decompose();return new f.Vector3(0,1,0).applyQuaternion(t[1])},this.renderSecondaryViewer=function(){Y._iViewerSecondaryWindow&&Y._iViewerSecondaryWindow.render()},this.getSectionCurvesFor2DViwer=function(){return le.length>0&&Oe(le,se),ee},this.getSectionCurveNode=function(){return Y._nSectionCurvesNode},this.removeSectionCurve=function(){Ve()},this.setNode(X?new X(this):new M(this)),this.displayWarning=function(e,t){var i=Y._frmWindow,n=e,o=t;Y.warningPanel&&Y.warningPanel.destroy(),Y.warningPanel=new _({title:T.warningDlg.title,message:T.warningDlg.message,checkboxMessage:null,checked:!0,frmWindow:i,callbacks:{onValidateCB:async function(){let e=n.getAttribute?{}:n;n.getAttribute&&(e=await N.getObjectDefinition(n));let t=new V({viewer:i.getViewer(),experience:o});Y.getNode().clean(!0),Y.importData(e,t,o),Y.refreshNode(!0),Y.afterImport(),Y.updatePosToStoreyNavigator()},onCancelCB:function(){},onCloseCB:function(){}}})},this.notifyWrongPaste=function(e){var t=Y._frmWindow;Y._notify&&Y._notify.destroy(),this._notify=new R({body:t.getUIFrame(),type:"error",message:e?T.warningDlg.errMessageCtoS:T.warningDlg.errMessageStoC})};var Ke=this.setInEdition;let $e;this.setInEdition=function(e,t,i){if(null!=t){Ke(e);var n=Y.getNode();if(i)n&&(e&&n.initClippingRobot(),n.update());else if(Y.isEditable())if(this.manageNavigatorEdition(),e){var o=c.isManipulationAllowed({viewer:Y._viewer}),r=l.checkIfCommandIsRunning(Y._viewer)&&!o;if(n){var a=n._getManpForRobot();r||a||(r=!0)}if(!r){let t=Y.getNode();t&&t.manageLock(!e)&&t.update(),Y._startEditCommand()}}else Y._movegauge&&!this.getDoNotEndEditCmdState()&&Y._cleanManipulationTool(),Y.getNode()&&!this.getDoNotEndEditCmdState()&&Y.getNode().manageLock(!e),Y._endEditCommand()}},$e=!0,addEventListener("custom:StoreyChanged",(e=>{Y&&Y.isSectionUpdateReq()&&$e&&Y.isConstructionItemMode()&&e&&e.detail&&Y.updateClippingPosAndOrientation(e.detail,!0)})),addEventListener("custom:OrientationChanged",(e=>{Y&&Y.isSectionUpdateReq()&&$e&&Y.isConstructionItemMode()&&e&&e.detail&&Y.updateClippingPosAndOrientation(e.detail,!0)})),this.unRegisterStoreyEvents=function(){$e&&($e=!1,removeEventListener("custom:StoreyChanged",(()=>{})),removeEventListener("custom:OrientationChanged",(()=>{})),this.setStoreyNavigatorVisu(!1))},Y._eventController||(Y._eventController=C.giveEventsController({viewer:Y._viewer})),Y._eventController&&(Y.editclippingCmdEventToken&&Y.editclippingCmdEventToken.length||(Y.editclippingCmdEventToken=[],Y.editclippingCmdEventToken.push(Y._eventController.addEvent("onEditCommandStart",(()=>{Y._buildManipulationTool()}))),Y.editclippingCmdEventToken.push(Y._eventController.addEvent("onEditCommandEnd",(()=>{Y._cleanManipulationTool()})))))},getBB:function(e){let t=this._viewer;return this._bBox||(this._bBox=c.computeBoundingBox(t),e||this.updatPlaneOffsetAsPerBB()),this._bBox},updatPlaneOffsetAsPerBB:function(){let e=.1;if(!window.widget||!window.widget.getValue||!window.widget.getValue("widgetForODTReplay")){let t=this._bBox?this._bBox:this.getBB(!0);if(t){let i=Math.abs(t.max.x-t.min.x),n=Math.abs(t.max.y-t.min.y),o=Math.abs(t.max.z-t.min.z),r=500;e=i<n?i<o?i/r:o/r:n<o?n/r:o/r,(isNaN(e)||e>.1)&&(e=.1)}this.setPlaneOffsetAsPerBB(e)}return e},retriveCurrentStoreyInfo:function(){if(!this.isConstructionItemMode())return;let e=n.getStoreyinfoOnSlide(this._viewer);if(e)return e;let t=O.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})});return t?t.GetCurrentStorey():void 0},updateStoreyNav:function(e){var t=this;if(!this.isConstructionItemMode())return;let i=this._storeyNavigatorcntroller;i||(i=O.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})}));let o=e||n.getStoreyinfoOnSlide(this._viewer);i?(o&&i.SetCurrentStorey(o),this.updatePosToStoreyNavigator()):(i=O.getDMUStoreyNavigratorController({context:C.getContextViewer({viewer:t._viewer}),getBuidlingRootID:()=>{var e=n.getBuildingRootData(t._viewer);return e?e.ID:void 0},storyeRetrivalSuccessCB:e=>{o&&e.SetCurrentStorey(o),t.updatePosToStoreyNavigator(),t.manageNavigatorEdition()},storyeRetrivalFailCB:()=>{let e="NormalMode";localStorage.setItem("DMUClippingBoxMode",e),t.setAttribute("sPlaneBoxMode",e),t.refreshNode(!0)}}),this._storeyNavigatorcntroller=i)},setStoreyNavigatorVisu:function(e){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=O.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&(e?(this._storeyNavigatorcntroller.ShowStoreyNavigator(),this.isReadOnly()||this.manageNavigatorEdition(!0)):this._storeyNavigatorcntroller.HideStoreyNavigator()))},setStoreyNavigatorEditionState:function(e){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=O.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.SetEditMode(e))},manageNavigatorEdition:function(e){if(!this.isConstructionItemMode())return;let t="DMUTemporaryBag"!==this.getParent().getType(),i=t?this.isInEdition():e;if("boolean"==typeof i){if(t&&this._storeyNavigatorcntroller){let e=n.getStoreyinfoOnSlide(this._viewer);e&&this.updateStoreyNav(e)}this.setStoreyNavigatorEditionState(i)}},manageNavigatoreVisu:function(e){this.setStoreyNavigatorVisu(e)},isBuidlingRootAvailable:function(e,t){if(!this.isConstructionItemMode())return!0;let i=e||C.getContextViewer({viewer:this._viewer});if(i){let e=n.isClippingEligibleForStoreyMode(this._viewer,i);if(!e)return!1;if(!t){let t=n.getBuildingRootData(this._viewer,e);if(!O.getStoreyInfo(t?t.ID:void 0,i))return!1}}return!0},manageConstrutionItemModeafterClone:function(){if(this.isConstructionItemMode()&&"DMUTemporaryBag"!==this.getParent().getType()){let e=C.getContextViewer({viewer:this._viewer});if(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=O.giveDMUStoreyNavigratorController({context:e})),!this._storeyNavigatorcntroller)return;if(!this.isBuidlingRootAvailable(e))return void this.resetToNormalMode();let t=n.getStoreyinfoOnSlide(this._viewer);t&&(this._storeyNavigatorcntroller.SetCurrentStorey(t),this.updatePosToStoreyNavigator(),n.setStoreyinfoOnSlide(this._viewer,this._storeyNavigatorcntroller.GetCurrentStorey()))}},updatePosToStoreyNavigator:function(){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=O.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.SetPosition3D(this.getNormal().negate().normalize(),this.getClippingCenter()))},updateClippingPosAndOrientation:function(e,t,i){if(!e||!e.position&&!e.Position3D&&!e.orientedDirection&&!e.OrientedDirection)return;let o=e.position||e.Position3D,r=e.orientedDirection||e.OrientedDirection;o&&(o=o.clone()),r&&(r=r.clone()),e.UUID&&n.setStoreyinfoOnSlide(this._viewer,e.UUID);let a=this.computePlaneRef(r,o,i);this.getNode().clearAllRulers(),a=this.updateClippingSize(a);var l={attribute:"mPlaneReferential",value:a};if(this.set(l),this.getNode().setRulerOrigin(o),this.updatePosToStoreyNavigator(),this.refreshNode(),t){let e=c.getClippingCmd(C.getContextViewer({viewer:this._viewer}));!1===e.getState()&&e.setState(!0)}},manageClippingCmd:function(){var e=c.getClippingCmdService();e&&e.updateClippingCommandState({contextViewer:C.getContextViewer({viewer:this._viewer}),reviewContext:C.getReviewContext({viewer:this._viewer})})},remove:function(){if(this.promiseToResolve&&this.promiseToResolve.length&&this.promiseToResolve.forEach((e=>{e("CancelOnDemand")})),this.promiseToResolve=null,this.unRegisterStoreyEvents(),this._movegauge&&(this._movegauge.unsubscribeToPrefChangeEvt(),this._movegauge.clean(),this._movegauge=null),"DMUTemporaryBag"===this.getParent().getType()){let e=c.getClippingCmd(C.getContextViewer({viewer:this._viewer}));e&&e.getState&&!0===e.getState()&&e.setState(!1)}var e=this.getNode();this.setAttribute("bClippingActiveState",!1),this.setVisibleFlag(!1,!1,!0),e.update(),e.clean(!0),e.cleanClippingRobot(!0);let t=n.getEditCmd(this._viewer);t&&(t.isRunning()||t.isPaused()?t.cancel():n.cleanClippingVisu(this._viewer)),e.setRobot(null),this.unsuscribeOnRepLoading(),this.cleanLockedInRAMNodes();var i=h.giveDMUMarkupsController({context:this._viewer});i&&i.unregisterMarker(this),h.unreferenceDMUMarkupsController({context:this._viewer});var o=C.giveEventsController({viewer:this._viewer});if(o)for(var r=0;r<this._tokenModelEvent.length;r++)o.removeEvent(this._tokenModelEvent[r]);this._tokenModelEvent=[],o&&this.editclippingCmdEventToken&&this.editclippingCmdEventToken.forEach((e=>{o.removeEvent(e)})),this._pimCtrl&&this._tokenOnPimCtrlOpacityChange&&(this._tokenOnPimCtrlOpacityChange&&this._pimCtrl.unsubscribe(this._tokenOnPimCtrlOpacityChange),this._tokenOnPimCtrlOpacityChange=null,this._pimCtrl=null),e.clean(),e.clearEventToken(),this._viewer.setSectionCapping(!1),this._iViewerSecondaryWindow&&this._iViewerSecondaryWindow.clear(),this._parent()},retriveClippingObjs:function(e){var t=function(e){return e&&e.getDMUObjects?((i=e.getDMUObjects("DMUClipping"))&&0===i.length&&(i=e.getDMUObjects("DMUSection")),i.length>0&&(t=i),t):[];var t,i}(function(e){var t=function(e){if(e)return C.getReviewContext({viewer:e})}(e);if(!t)return;function i(e){let t;return!!(e&&(t=e.getDMUObjects("DMUClipping"),(!t||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let n,o=!1,r=!1,a=t.getCurrentSessionMarkup();a&&a.getActiveFlag()&&a.isVisible()&&a.getCurrentSlide&&(n=a.getCurrentSlide(),o=i(n));var l=t.getTransientReviewBag();return r=i(l),o||n&&!r?n:l}(e));return t},clearAllRuler:function(e){let t=this.retriveClippingObjs(this._viewer,!0);t&&t.length&&t.forEach((function(t){if(t){t.getNode().clearAllRulers(e)}}))},clearOtherslider:function(){let e=this.retriveClippingObjs(this._viewer,!0);e&&e.length&&e.forEach((function(e){e&&e._cleanManipulationTool&&e._cleanManipulationTool()}))},cleanNode:function(){this.getNode()&&this.getNode().clean()},setAttribute:function(e,t){"fLineStyleThicknessIndex"===e&&this._parent("fLineStyleThickness",null),this._parent(e,t)},isCustomColorSorce:function(e){var t;if("Capping"===e){t=this.getAttribute("bCustomCappingColor");let e=this.getAttribute("cCappingColor");null==t?t=Boolean(e):e||(t=!1)}if("Contour"===e){t=this.getAttribute("bCustomContourColor");let e=this.getAttribute("cLineStyleColor");null==t?t=Boolean(e):e||(t=!1)}return t},isSinglePlaneMode:function(){let e=this.getAttribute("sPlaneBoxMode");return"NormalMode"===e||"ConstructionItemMode"===e},isConstructionItemMode:function(){return"ConstructionItemMode"===this.getAttribute("sPlaneBoxMode")},getClippingModeForDragDrop:function(){return this.isConstructionItemMode()?"NormalMode":this.getAttribute("sPlaneBoxMode")},resetToNormalMode:function(e){this.setStoreyNavigatorVisu(!1),this.getNode().clean();let t="NormalMode";if(this._lastClippingDefHdr=void 0,localStorage.setItem("DMUClippingBoxMode",t),this.setAttribute("sPlaneBoxMode",t),e){let t=e.getRobot();t||(e.initClippingRobot(),t=e.getRobot()),t&&t.updateRobotPos()}this.refreshNode()},isTemporaryClipping:function(){return"DMUTemporaryBag"===this.getParent().getType()},isCutUncutOn:function(){let e=this.getAttribute("sTargetIds"),t=this.getAttribute("iCutUncutMode");return e&&e.length&&null!=t}})})),define("DS/DMUPlaySection/DMUSection",["DS/DMUPlaySection/DMUClippingBase"],(function(e){"use strict";return e.extend({init:function(e){e.sType="Section",this._parent(e)}})})),define("DS/DMUPlaySection/DMUClipping",["DS/DMUPlaySection/DMUClippingBase","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";var i=[{name:"bHatchingDisplay",type:"bool",JSONname:"PropertiesSection.Hatching.Display",defaultValue:!0},{name:"cHatchingColor",type:"Color",JSONname:"PropertiesSection.Hatching.GraphicProperties.color",defaultValue:new t.Color(0)},{name:"fHatchingLineStyleThickness",type:"float",JSONname:"PropertiesSection.Hatching.GraphicProperties.LineStyle.thicknessIndex",defaultValue:1},{name:"sHatchingAnglesMode",type:"string",JSONname:"PropertiesSection.Hatching.AnglesMode",defaultValue:"Various"},{name:"fHatchingSingleAngleValue",type:"float",JSONname:"PropertiesSection.Hatching.SingleAngleValue",defaultValue:.523599},{name:"fHatchingPitchValue",type:"float",JSONname:"PropertiesSection.Hatching.HatchingPitchValue",defaultValue:10}];return e.extend({init:function(e){this._parent(e),this.addParameters(i)}})})),define("DS/DMUPlaySection/DMUClippingService",["UWA/Utils","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUPlaySection/DMUClipping","DS/DMUPlaySection/DMUToolsSection","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUSectionPosService","DS/CATWebUXPreferences/DMUClippingPrefService","DS/DMUBaseCommands/EXPToolsWUX","DS/Visualization/ThreeJS_DS","DS/DMUPlaySection/DMUStoreyNavigratorController","DS/PADUtils/PADSettingsMgt","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"],(function(e,t,i,n,o,r,a,l,s,c,u,p,g,d){"use strict";var f,v=function(e){if(e)return t.getReviewContext({viewer:e})},m=function(e){var t=v(e);if(t){var i=t.getCurrentSessionMarkup();return(!i||i&&!i.getActiveFlag()||i&&i.getActiveFlag()&&!i.isVisible()||i&&i.getActiveFlag()&&i.isVisible()&&i.isReadOnly()||i&&i.getActiveFlag()&&i.isVisible()&&!i.isReadOnly()&&!i.getCurrentSlide())&&(i=t.getTransientReviewBag()),i}};var h=function(e){return e&&e.getDMUObjects?((!(i=e.getDMUObjects("DMUClipping"))||i&&0===i.length)&&(i=e.getDMUObjects("DMUSection")),i.length>0&&(t=i),t):[];var t,i},S=function(e){var i=t.getContextViewer({viewer:e});return i?i.getCommandContext():"Default"};function C(e,t,i){if(!e||!t||!i)return;var n,l,s=t.sliceOffset;let c="NormalMode"!==t.boxMode&&"ConstructionItemMode"!==t.boxMode;var u=t.bbox?t.bbox:r.computeBoundingBox(i,t.objForBB),p=Math.max(u.max.x-u.min.x,u.max.y-u.min.y,u.max.z-u.min.z),g=t.planeReferential||o.computeSectionPlaneReferencial(i,u,c,t.planeDir),d=c&&!s,f=a.computePlaneDim(u,g,!1,d);if(d){var v=r.computeBoundingSphere(i,t.objForBB);s=isNaN(f.fSliceOffset)?o.computeClippingSlice(v,g):f.fSliceOffset}t.planeSizeU&&t.planeSizeV?(l=t.planeSizeV,n=t.planeSizeU):(n=p,l=p,f&&f.fPlaneSizeV&&f.fPlaneSizeU&&(t.planeSizeV||(l=f.fPlaneSizeV),t.planeSizeU||(n=f.fPlaneSizeU))),e.setAttributes([{name:"mPlaneReferential",value:g},{name:"fXDirSize",value:n},{name:"fYDirSize",value:l},{name:"fXDirGridStep",value:n/20},{name:"fYDirGridStep",value:l/20},{name:"fSliceOffset",value:s}])}var b={setClippingParameters:async function(l,s){if(!0!==s.deactivateClipping){var u=this,p=await async function(e){if(e){var n=t.getReviewContext({viewer:e});return n||(n=await i.createReviewContext({context:t.getContextViewer({viewer:e})})),n}}(l);if(p){var g=s.appType||"3dReview",f=!isNaN(s.indexOfClippingObj)&&s.indexOfClippingObj>0?s.indexOfClippingObj:0,v=s.sectionCommandMode,m=[],h=function(){var t=u.retriveClippingObjs(l),i=p.getTransientReviewBag();if(i)return(!(m=i.getDMUObjects("DMUClipping"))||m&&0===m.length)&&(m=i.getDMUObjects("DMUSection")),m.length>0?t=m[f]:((t=new n({viewer:l,expParent:i,typeApps:g,modeType:v,context:S(l),sectionEditCmd:o.getEditCmd(l)})).setAttributes([{name:"sID",value:i.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:i.computeNewName({object:t,prefix:d.sectionPrefix||"Section"})}]),i.addDMUObject&&(i.addDMUObject(t),t.fireEvent("onDMUObjectInitialized",{dmuObject:t}))),t}();if(h){var C,b,M=h.getNode();M&&M.clean();var y=r.computeBoundingBox(l),P=Math.max(y.max.x-y.min.x,y.max.y-y.min.y,y.max.z-y.min.z),w=s.planeReferential||o.computeSectionPlaneReferencial(l,y);if(s.planeSizeU&&s.planeSizeV)b=s.planeSizeV,C=s.planeSizeU;else{C=P,b=P;var D=a.computePlaneDim(y,w,!0);D&&(D.fPlaneSizeV&&D.fPlaneSizeU&&(s.planeSizeV||(b=D.fPlaneSizeV),s.planeSizeU||(C=D.fPlaneSizeU)),D.plane&&!s.planeReferential&&(w=D.plane))}var x=s.opacity;x&&(x/=255);var A=function(e){if(e&&3===e.length)return new c.Color("rgb("+e[0]+","+e[1]+","+e[2]+")")};let e=s.sectionCurvesVisible;h.setAttributes([{name:"mPlaneReferential",value:w},{name:"fXDirSize",value:C},{name:"fYDirSize",value:b},{name:"sDisplayPlaneMode",value:"Plane"},{name:"sDisplayContourMode",value:"Contour"},{name:"sSectionRender",value:s.sectionRender||"CutOneSide"},{name:"sPartialClippingMode",value:!1},{name:"sUpdateAndFreezeMode",value:"Update"},{name:"fXDirGridStep",value:C/20},{name:"fYDirGridStep",value:b/20},{name:"sPlaneBoxMode",value:s.boxMode||"NormalMode"},{name:"fSliceOffset",value:s.sliceOffset||0},{name:"fOpacity",value:isNaN(x)?.5:x},{name:"bSectionCurvesVisible",value:e},{name:"bClipping",value:!0},{name:"bHatchingDisplay",value:s.hatchingDisplay},{name:"cHatchingColor",value:A(s.hatchingColor)},{name:"fHatchingLineStyleThickness",value:s.hatchingLineStyleThickness},{name:"sHatchingAnglesMode",value:s.hatchingAnglesMode},{name:"fHatchingSingleAngleValue",value:s.hatchingSingleAngleValue},{name:"fHatchingPitchValue",value:s.hatchingPitchValue}]),s.targetPaths&&h.setSelectedObjectsIdsPathForCutUncut(s.targetPaths,s.cutUncutMode),h.setAttribute("bCustomCappingColor",s.isCustomCappingColor),s.cappingColor&&h.setAttribute("cCappingColor",A(s.cappingColor)),h.setAttribute("bCustomContourColor",s.isCustomContourColor),s.lineStyleColor&&h.setAttribute("cLineStyleColor",A(s.lineStyleColor)),s.lineStyleThicknessIndex&&h.setAttribute("fLineStyleThicknessIndex",s.lineStyleThicknessIndex),s.lineStylePattern&&h.setAttribute("sLineStylePattern",s.lineStylePattern),s.fillStyleColor&&h.setAttribute("cFillStyleColor",A(s.fillStyleColor)),void 0!==s.clippingPlaneVisible&&h.setAttribute("bClippingPlaneVisible",s.clippingPlaneVisible),h.setInEdition(!1),M&&M.update(!0),h.manageClippingCmd()}}}else{var V=t.getContextViewer({viewer:l});let e=r.getClippingCmd(V);e&&e.getState()&&e.setState(!1)}},createClipping:function(i,r){if(v(i)){var a,s=r.appType||"3dReview",c=r.sectionCommandMode,p=r.precisePosCmd||void 0,g=function(e){var t=v(e);if(!t)return;var i=t.getCurrentSessionMarkup();let n=!0;if(i){let e=t.getRestrictions(i);e.markup&&void 0!==e.markup.canEdit&&(n=e.markup.canEdit)}return i&&i.getActiveFlag()&&i.isVisible()&&!i.isReadOnly()&&n&&i.getCurrentSlide()?i:t.getTransientReviewBag()}(i);if(g){var m;m=new n({viewer:i,expParent:g,typeApps:s,modeType:c,context:S(i),clippingPrecisePosCmd:p,sectionEditCmd:o.getEditCmd(i),csoList:r.csoList,isStoreyMode:"ConstructionItemMode"===r.boxMode}),p&&(m._posCmdActive=!0),m.setAttributes([{name:"sID",value:g.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:g.computeNewName({object:m,prefix:d.clippingPrefix})}]);var h=g;if(g.getCurrentSlide&&(h=g.getCurrentSlide()),h.addDMUObject&&(h.addDMUObject(m),a=!0),m){if(function(e,t,i){if(e&&t&&i){var n=t.boxMode||"NormalMode",o=t.sectionCommandMode;C(e,t,i),e.setAttributes([{name:"sDisplayPlaneMode",value:"Plane"},{name:"sDisplayContourMode",value:"Contour"},{name:"sSectionRender",value:t.sectionRender||"CutOneSide"},{name:"sPartialClippingMode",value:!1},{name:"sUpdateAndFreezeMode",value:"Update"},{name:"sPlaneBoxMode",value:n},{name:"fOpacity",value:void 0!==t.opacity?t.opacity:.2},{name:"bSectionCurvesVisible",value:t.sectionCurvesVisible||"ProgressiveVisuLoading"!==o&&l.contour.getComputeContourStatus()},{name:"bClipping",value:!0},{name:"bClippingActiveState",value:!0},{name:"bClippingPlaneVisible",value:Boolean(t.bDisplayPermanently)},{name:"bHatchingDisplay",value:t.isHatchingDisplayed},{name:"cHatchingColor",value:t.hatchingColor},{name:"fHatchingLineStyleThickness",value:t.hatchingThickness},{name:"sHatchingAnglesMode",value:t.hatchingAnglesMode},{name:"fHatchingSingleAngleValue",value:t.hatchingSingleAngleValue},{name:"fHatchingPitchValue",value:t.hatchingPitchValue}]),e.setAttribute("bCustomCappingColor",t.isCustomCappingColor),t.cappingColor&&e.setAttribute("cCappingColor",t.cappingColor),e.setAttribute("bCustomContourColor",t.isCustomContourColor),t.lineStyleColor&&e.setAttribute("cLineStyleColor",t.lineStyleColor),t.lineStyleThicknessIndex&&e.setAttribute("fLineStyleThicknessIndex",t.lineStyleThicknessIndex),t.fillStyleColor&&e.setAttribute("cFillStyleColor",t.fillStyleColor)}}(m,r,i),"ConstructionItemMode"===r.boxMode){let e=e=>{let t=e.GetPosition3D();m.updateClippingPosAndOrientation(t),o.setStoreyinfoOnSlide(i,e.GetCurrentStorey())},n=()=>{let e="NormalMode";var t=o.getEditCmd(i);localStorage.setItem("DMUClippingBoxMode",e),m.setAttribute("sPlaneBoxMode",e),b.resetClipping(m,i),t&&!t.isRunning()&&t.begin()};var M=t.getContextViewer({viewer:i});let a=o.getBuildingRootData(i,r.buildingRoot),l=u.getStoreyInfo(a?a.ID:void 0,M);if(M&&a&&(l&&l.length||u.clearStoreyNavigratorController({context:M})),f=u.giveDMUStoreyNavigratorController({context:M})){f.ShowStoreyNavigator(),f.SetEditMode(!0),o.setStoreyinfoOnSlide(i,f.GetCurrentStorey());let e=f.GetPosition3D();m.updateClippingPosAndOrientation(e)}else f=u.getDMUStoreyNavigratorController({context:M,getBuidlingRootID:()=>a?a.ID:void 0,storyeRetrivalSuccessCB:e,storyeRetrivalFailCB:n})}a&&m.fireEvent("onDMUObjectInitialized",{dmuObject:m});var y=m.getNode();y&&y.update(),i.render()}return m}}},resetClipping:function(e,t){if(e&&t){C(e,l.getDefaultClippingProp(),t);var i=e.getNode();i&&i.update(!0),t.render()}},resizeClippingFromObject:function(e,t,i){if(e&&i){C(e,t,i);var n=e.getNode();n&&n.update(!0),i.render()}},retriveCurrentReview:function(e){return m(e)},retriveClippingObjs:function(e){var t=m(e);if(t)return t.getCurrentSlide&&(t=t.getCurrentSlide()),h(t)},retriveClippingObjsFromSlide:function(e){var t=this.retriveClippingObjs(e);if(!t||!t.length){var i=function(e){var t=v(e);if(!t)return;function i(e){let t;return!!(e&&(t=e.getDMUObjects("DMUClipping"),(!t||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let n,o=!1,r=!1,a=t.getCurrentSessionMarkup();a&&a.getActiveFlag()&&a.isVisible()&&a.getCurrentSlide&&(n=a.getCurrentSlide(),o=i(n));var l=t.getTransientReviewBag();return r=i(l),o||n&&!r?n:l}(e);t=h(i)}return t},activateClipping:function(e,i){let n=t.getContextViewer({viewer:i});r.activateClipping(e,n)},deActivateClipping:function(e,i,n){let o=t.getContextViewer({viewer:i});e&&e.length||!f||f.HideStoreyNavigator(),r.clearPosPanel(e),r.deActivateClipping(e,o,n)},editClipping:async function(e,t,i){var n=t,r=!0===n.fromContextcmd,a=!i,c=o.getEditCmd(e);if(!e)return;var p=this.retriveClippingObjsFromSlide(e);let g=!1;var d;(!p||p.length<=0)&&a&&(p=[],d=n&&n.getDefaultValues?await n.getDefaultValues():l.getDefaultClippingProp(),p.push(this.createClipping(e,d)),g=!0);if(p&&p.length&&!(p.length<0)){var f=p.length>1;p.forEach((function(e){var t=e.getAttribute("bClippingActiveState");a&&!t&&(e.setAttribute("bClippingActiveState",a),e.setVisibleFlag(!0,!1,!0)),e.getNode().clearAllRulers(),e.setInEdition(a,r,f),f||e._posCmdActive||(a?s.addInCSO(e):e.addOrRemoveFromCSO()),e.isConstructionItemMode()&&!g&&a&&e.setStoreyNavigatorVisu(!0),u.getActivateClippingActionFlag()&&g&&e.isTemporaryClipping()&&e.isConstructionItemMode()||u.setActivateClippingActionFlag(!1)})),r&&(a?c.begin():c.cancel()),u.getActivateClippingActionFlag()&&(u.setActivateClippingActionFlag(!1),c&&c.isRunning()&&c.cancel()),e.render()}},setStoreyNavigatorVisibility:function(e){f&&(e?f.ShowStoreyNavigator():f.HideStoreyNavigator())},checkProgOrDynViewModeMode:function(e){var t=!1;if(e&&e.getRoots&&e.getRoots().length>0){var i=e.getController();i&&i.getRootStats(g.getNodeID(e.getRoots()[0]))&&(p.getSetting("enopad3dviewer_lightNodeModel")||p.getSetting("enopad3dviewer_dynamicRepLoading"))&&(t=!0)}return t}};return b}));