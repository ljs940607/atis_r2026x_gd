define("DS/CAT3DWVideosUI/CAT3DWVideosController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialApplication","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/SceneGraphNodes/FixedSizeNode3D","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWVisu/CAT3DWVisuServices","DS/WebappsUtils/WebappsUtils","UWA/Core","DS/Manipulators/PointHandle","DS/SceneGraphNodes/CanvasNodeTexture","DS/CAT3DWVisu/CAT3DWDataFactory"],(function(e,t,i,n,a,o,s,r,l,h,d,u,_,c){"use strict";var m=function(e,r,c){var m={_mainNode:null,_mainLine:null,_playLine:null,_currTimeHandle:null,_volumeButtonNode:null,_mainVolumeLine:null,_playVolumeLine:null,_volumeHandle:null,_viewer:e.viewer,_fitting:!0,_media:e.media,_cornersOriginal:e.corners,_positionOriginal:e.controlPosition,_matrixOriginal:e.matrix,_videoNode:r,_video:c,load:function(){this._mainNode=new n("timeLineNode"),this._currTimeHandle=new u({viewer:this._viewer,sceneGraph:this._mainNode}),this._currTimeHandle.diskNode.setNoZ(!1),this._volumeHandle=new u({viewer:this._viewer,sceneGraph:this._mainNode}),this._volumeHandle.diskNode.setNoZ(!1),this._currTimeHandle.pointMat.depthTest=!1,this._volumeHandle.pointMat.depthTest=!1,e&&"number"==typeof e.renderDepth&&(this._currTimeHandle.diskNode.setRenderDepth(e.renderDepth),this._volumeHandle.diskNode.setRenderDepth(e.renderDepth)),this._currTimeHandle.name="linearTranslateHandle",this._currTimeHandle.setPickable(o.PICKABLE),this._volumeHandle.name="linearVolumeHandle",this._volumeHandle.setPickable(o.PICKABLE),this._onBeginPreactivateCB=this._onBeginPreactivate.bind(this),this._currTimeHandle.subscribe("BeginPreactivate",this._onBeginPreactivateCB),this._onEndPreactivateCB=this._onEndPreactivate.bind(this),this._currTimeHandle.subscribe("EndPreactivate",this._onEndPreactivateCB),this._onBeginManipulateCB=this._onBeginHandleManipulate.bind(this),this._currTimeHandle.subscribe("BeginManipulate",this._onBeginManipulateCB),this._onManipulateCB=this._onHandleManipulate.bind(this),this._currTimeHandle.subscribe("Manipulate",this._onManipulateCB),this._onEndManipulateCB=this._onEndHandleManipulate.bind(this),this._currTimeHandle.subscribe("EndManipulate",this._onEndManipulateCB),this._onBeginPreactivateVolumeCB=this._onBeginPreactivateVolume.bind(this),this._volumeHandle.subscribe("BeginPreactivate",this._onBeginPreactivateVolumeCB),this._onEndPreactivateVolumeCB=this._onEndPreactivateVolume.bind(this),this._volumeHandle.subscribe("EndPreactivate",this._onEndPreactivateVolumeCB),this._onBeginManipulateVolumeCB=this._onBeginHandleVolumeManipulate.bind(this),this._volumeHandle.subscribe("BeginManipulate",this._onBeginManipulateVolumeCB),this._onManipulateVolumeCB=this._onHandleVolumeManipulate.bind(this),this._volumeHandle.subscribe("Manipulate",this._onManipulateVolumeCB),this._onEndManipulateVolumeCB=this._onEndHandleVolumeManipulate.bind(this),this._volumeHandle.subscribe("EndManipulate",this._onEndManipulateVolumeCB),this._volumeHandle.setVisibility(!1),this._videoNode.addChild(this._mainNode),this._volumeButtonNode=new s({name:"fixedVolumeNode",ratio:1}),this._mainNode.addChild(this._volumeButtonNode);var i=h.getWebappsAssetUrl("CAT3DWVideosUI","graphics/volume_icon.png");window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(i=d.Data.proxifyUrl(i,{proxy:"passport"})),this._texture=t.ImageUtils.loadTexture(i,void 0,this._onTextureLoaded.bind(this,this._volumeButtonNode),this.onLoadImageError,!1)},_onTextureLoaded:function(n){if(null!==this._viewer){this._rectangle&&n.removeChild(this._rectangle),this._rectangle=a.createRectangleNode({width:20,height:20,fill:!0,color:new o.Color(255,255,255,0)});var s=new t.Matrix4;s.set(0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1),s.setPosition(new t.Vector3(10,-10,0)),this._rectangle.setMatrix(s),this._rectangle.setPickable(o.PICKABLE),n.addChild(this._rectangle);var r=new t.LineBasicMaterial({opacity:0}),l=new t.MeshBasicMaterial({map:this._texture,force:!0,side:t.DoubleSide});l.transparent=!0,l.color=new t.Color,this._media?"number"==typeof this._media.getView().getDepth()&&this._rectangle.setRenderDepth(5*this._media.getView().getDepth()-2):e&&"number"==typeof e.renderDepth&&(l.depthTest=!1,this._rectangle.setRenderDepth(e.renderDepth-2)),this._rectangle.removeMaterialApplication();var h=new i({faceMaterial:l,lineMaterial:r});this._rectangle.setMaterialApplication(h),this._viewer.render()}},_onBeginPreactivate:function(){this._currTimeHandle&&(this._activatedTime=!0)},_onEndPreactivate:function(){this._currTimeHandle&&(this._activatedTime=!1)},_onBeginHandleManipulate:function(){this._currTimeHandle&&(this._manipulatingTime=!0)},_onHandleManipulate:function(n){if(this._currTimeHandle){let h,d,u;this._media?(h=this._media.getView().getCorners(),d=this._media.getView().getCenter(),u=new t.Vector3(0,0,1)):(h=this._cornersOriginal,d=this._positionOriginal,u=new t.Vector3(0,0,1));let _=(new t.Plane).setFromNormalAndCoplanarPoint(u,d);var s=n.event.from[0].getCurrentPosition(),r=l.compute3DPointFrom2DPoint(s,_,this._viewer);let c=this._getMainLineEndPoints(d,h),m=c.startLeft3D,p=c.startRight3D,g={A:m,B:p},v=this._getFootOfPerpendicularOnLineFromPoint(g,r);v.distanceTo(m)+v.distanceTo(p)>m.distanceTo(p)+.01&&(v=v.distanceTo(p)>v.distanceTo(m)?m:p),this._playLine&&this._mainNode.removeChild(this._playLine);let f=[m,v];this._playLine=a.createLineNode({points:f}),this._playLine.setPickable(o.PICKTHROUGH),this._playLine.setExcludeFromBounding(!0),this._playLine.setMaterialApplication(new i({lineMaterial:l.getSelectionMaterial()})),this._media?"number"==typeof this._media.getView().getDepth()&&(this._playLine.material.depthTest=!1,this._playLine.setRenderDepth(5*this._media.getView().getDepth()-1)):e&&"number"==typeof e.renderDepth&&(this._playLine.material.depthTest=!1,this._playLine.setRenderDepth(e.renderDepth-1)),this._mainNode.addChild(this._playLine),this._currTimeHandle.setMatrix((new t.Matrix4).setPosition(v));let V=v.distanceTo(m)/p.distanceTo(m)*this.videoDuration;this._video.currentTime=V,this._viewer.render()}},_onEndHandleManipulate:function(){this._currTimeHandle&&(this._manipulatingTime=!1)},_onBeginPreactivateVolume:function(){this._volumeHandle&&(this._activatedVolume=!0)},_onEndPreactivateVolume:function(){this._volumeHandle&&(this._activatedVolume=!1)},_onBeginHandleVolumeManipulate:function(){this._volumeHandle&&(this._manipulatingVolume=!0)},_onHandleVolumeManipulate:function(n){if(this._volumeHandle){let h,d,u;this._media?(h=this._media.getView().getCorners(),d=this._media.getView().getCenter(),u=new t.Vector3(0,0,1)):(h=this._cornersOriginal,d=this._positionOriginal,u=new t.Vector3(0,0,1));let _=(new t.Plane).setFromNormalAndCoplanarPoint(u,d);var s=n.event.from[0].getCurrentPosition(),r=l.compute3DPointFrom2DPoint(s,_,this._viewer);let c=this._getMainLineEndPoints(d,h),m=c.startVolume3D,p=c.endVolume3D,g={A:m,B:p},v=this._getFootOfPerpendicularOnLineFromPoint(g,r);v.distanceTo(m)+v.distanceTo(p)>m.distanceTo(p)+.01&&(v=v.distanceTo(p)>v.distanceTo(m)?m:p),this._playVolumeLine&&this._mainNode.removeChild(this._playVolumeLine);let f=[m,v];this._playVolumeLine=a.createLineNode({points:f}),this._playVolumeLine.setPickable(o.PICKTHROUGH),this._playVolumeLine.setExcludeFromBounding(!0),this._playVolumeLine.setMaterialApplication(new i({lineMaterial:l.getSelectionMaterial()})),this._media?"number"==typeof this._media.getView().getDepth()&&(this._playVolumeLine.material.depthTest=!1,this._playVolumeLine.setRenderDepth(5*this._media.getView().getDepth()-1)):e&&"number"==typeof e.renderDepth&&(this._playVolumeLine.material.depthTest=!1,this._playVolumeLine.setRenderDepth(e.renderDepth-1)),this._mainNode.addChild(this._playVolumeLine),this._volumeHandle.setMatrix((new t.Matrix4).setPosition(v));let V=v.distanceTo(m)/p.distanceTo(m);this._video.volume=V,0===this._video.volume?this._video.muted=!0:this._video.muted=!1,this._viewer.render()}},_onEndHandleVolumeManipulate:function(){if(this._volumeHandle){this._manipulatingVolume=!1;var e="";e=0===this._video.volume?h.getWebappsAssetUrl("CAT3DWVideosUI","graphics/volume_mute_icon.png"):h.getWebappsAssetUrl("CAT3DWVideosUI","graphics/volume_icon.png"),window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(e=d.Data.proxifyUrl(e,{proxy:"passport"})),this._texture=t.ImageUtils.loadTexture(e,void 0,this._onTextureLoaded.bind(this,this._volumeButtonNode),this.onLoadImageError,!1)}},_getMainLineEndPoints:function(e,i){let n=this._viewer.currentViewpoint.project(i.bottomLeft),a=this._viewer.currentViewpoint.project(i.bottomRight),o=this._viewer.currentViewpoint.project(i.topLeft),s=this._viewer.currentViewpoint.project(i.topRight),r=new t.Vector2((1*a.x+9*n.x)/10,(1*a.y+9*n.y)/10),h=new t.Vector2((9*a.x+1*n.x)/10,(9*a.y+1*n.y)/10),d=new t.Vector2((19*a.x+1*n.x)/20,(19*a.y+1*n.y)/20),u=new t.Vector2((1*s.x+9*o.x)/10,(1*s.y+9*o.y)/10),_=new t.Vector2((9*s.x+1*o.x)/10,(9*s.y+1*o.y)/10),c=new t.Vector2((19*s.x+1*o.x)/20,(19*s.y+1*o.y)/20),m=new t.Vector2((1*u.x+9*r.x)/10,(1*u.y+9*r.y)/10),p=new t.Vector2((1*_.x+9*h.x)/10,(1*_.y+9*h.y)/10),g=new t.Vector2((1*c.x+9*d.x)/10,(1*c.y+9*d.y)/10),v=new t.Vector2((3*c.x+17*d.x)/20,(3*c.y+17*d.y)/20),f=new t.Vector2((3*c.x+7*d.x)/10,(3*c.y+7*d.y)/10),V=f.distanceTo(v);V<50?V=50:V>100&&(V=100);let w,D=(new t.Vector2).subVectors(f,v);D.normalize(),f=(new t.Vector2).addVectors(v,D.multiplyScalar(V)),w=(this._media,new t.Vector3(0,0,1));let y=(new t.Plane).setFromNormalAndCoplanarPoint(w,e);return{startLeft3D:l.compute3DPointFrom2DPoint(m,y,this._viewer),startRight3D:l.compute3DPointFrom2DPoint(p,y,this._viewer),volumeBtsPos3D:l.compute3DPointFrom2DPoint(g,y,this._viewer),startVolume3D:l.compute3DPointFrom2DPoint(v,y,this._viewer),endVolume3D:l.compute3DPointFrom2DPoint(f,y,this._viewer)}},_getFootOfPerpendicularOnLineFromPoint:function(e,i){let n,a,o,s,r,l,h,d,u,_;return n=e.B.x-e.A.x,a=e.B.y-e.A.y,o=e.B.z-e.A.z,r=e.A.x,l=e.A.y,h=e.A.z,d=i.x,u=i.y,_=i.z,s=((d-r)*n+(u-l)*a+(_-h)*o)/(n*n+a*a+o*o),new t.Vector3(s*n+r,s*a+l,s*o+h)},roundRect:function(e,t,i,n,a,o,s,r){if(void 0===r&&(r=!0),void 0===o&&(o=5),"number"==typeof o)o={tl:o,tr:o,br:o,bl:o};else{const e=["tl","tr","br","bl"],t=0;for(let i of e)o[i]||(o[i]=t)}e.beginPath(),e.moveTo(t+o.tl,i),e.lineTo(t+n-o.tr,i),e.quadraticCurveTo(t+n,i,t+n,i+o.tr),e.lineTo(t+n,i+a-o.br),e.quadraticCurveTo(t+n,i+a,t+n-o.br,i+a),e.lineTo(t+o.bl,i+a),e.quadraticCurveTo(t,i+a,t,i+a-o.bl),e.lineTo(t,i+o.tl),e.quadraticCurveTo(t,i,t+o.tl,i),e.closePath(),s&&e.fill(),r&&e.stroke()},drawCanvas:function(e,t,i){var n=t.width,a=t.height;i.fillStyle="#000000",this.roundRect(i,0,0,n,a,5,!0,!1),i.font="9pt Arial",i.fillStyle="white",i.textAlign="center",i.fillText(e,25,15),i.globalAlpha=1,i.strokeStyle="black",i.lineWidth=2},updateTimelineMarker:function(e,i){if(this._timeLineMarker&&(this._mainNode.removeChild(this._timeLineMarker),this._timeLineMarker=void 0),!i)return;let n,o,s;this._media?(n=this._media.getView().getCorners(),o=this._media.getView().getCenter(),s=new t.Vector3(0,0,1)):(n=this._cornersOriginal,o=this._positionOriginal,s=new t.Vector3(0,0,1));let r=this._getMainLineEndPoints(o,n),h=r.startLeft3D,d=r.startRight3D,u=this._viewer.currentViewpoint.project(h),c=this._viewer.currentViewpoint.project(d),m=(new t.Vector2).subVectors(u,c);m.normalize();let p=(new t.Vector2).addVectors(e,m.multiplyScalar(25)),g=(new t.Plane).setFromNormalAndCoplanarPoint(s,o),v=l.compute3DPointFrom2DPoint(p,g,this._viewer),f=l.compute3DPointFrom2DPoint(e,g,this._viewer),V={A:h,B:d},w=this._getFootOfPerpendicularOnLineFromPoint(V,f),D=this._getFootOfPerpendicularOnLineFromPoint(V,v);if(w.distanceTo(h)+w.distanceTo(d)>h.distanceTo(d))return;let y=w.distanceTo(h)/d.distanceTo(h)*this.videoDuration;var T=new _({width:50,height:30,drawCB:this.drawCanvas.bind(this,y.toFixed(1)),alphaTest:.02});this._timeLineMarker=a.createCanvas2DNode({canvasNodeTexture:T},a),V={A:n.topLeft,B:n.topRight};let b,P=this._getFootOfPerpendicularOnLineFromPoint(V,D),M=this._viewer.currentViewpoint.project(D),C=this._viewer.currentViewpoint.project(P),x=new t.Vector3((1*C.x+19*M.x)/20,(1*C.y+19*M.y)/20),L=l.compute3DPointFrom2DPoint(x,g,this._viewer),A=new t.Vector3,B=new t.Quaternion,S=new t.Vector3;b=this._media?this._media.getView().getMatrix().clone():this._matrixOriginal.clone(),b.decompose(A,B,S);let N=new t.Quaternion(0,0,-.7071067811865476,.7071067811865476).inverse(),k=(new t.Quaternion).multiplyQuaternions(B,N);this._timeLineMarker.setMatrix((new t.Matrix4).setPosition(L));let I=k.angleTo(new t.Quaternion);this._timeLineMarker.setAngle(I),this._mainNode.addChild(this._timeLineMarker),this._viewer.render()},processtimelineTapInVideo:function(n){if(this._currTimeHandle){let h,d,u;this._media?(h=this._media.getView().getCorners(),d=this._media.getView().getCenter(),u=new t.Vector3(0,0,1)):(h=this._cornersOriginal,d=this._positionOriginal,u=new t.Vector3(0,0,1));let _=(new t.Plane).setFromNormalAndCoplanarPoint(u,d);var s=n,r=l.compute3DPointFrom2DPoint(s,_,this._viewer);let c=this._getMainLineEndPoints(d,h),m=c.startLeft3D,p=c.startRight3D,g={A:m,B:p},v=this._getFootOfPerpendicularOnLineFromPoint(g,r);v.distanceTo(m)+v.distanceTo(p)>m.distanceTo(p)&&(v=v.distanceTo(p)>v.distanceTo(m)?m:p),this._playLine&&this._mainNode.removeChild(this._playLine);let f=[m,v];this._playLine=a.createLineNode({points:f}),this._playLine.setPickable(o.PICKTHROUGH),this._playLine.setExcludeFromBounding(!0),this._playLine.setMaterialApplication(new i({lineMaterial:l.getSelectionMaterial()})),this._media?"number"==typeof this._media.getView().getDepth()&&(this._playLine.material.depthTest=!1,this._playLine.setRenderDepth(5*this._media.getView().getDepth()-1)):e&&"number"==typeof e.renderDepth&&(this._playLine.material.depthTest=!1,this._playLine.setRenderDepth(e.renderDepth-1)),this._mainNode.addChild(this._playLine),this._currTimeHandle.setMatrix((new t.Matrix4).setPosition(v));let V=v.distanceTo(m)/p.distanceTo(m)*this.videoDuration;this._video.currentTime=V,this._viewer.render()}},processPickInVideoVolume:function(){if(this._volumeHandle){var n=1;if(this._volumeHandle._getVisible()){var s="";0===this._video.volume||this._video.muted?s=h.getWebappsAssetUrl("CAT3DWVideosUI","graphics/volume_icon.png"):(s=h.getWebappsAssetUrl("CAT3DWVideosUI","graphics/volume_mute_icon.png"),n=0),window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(s=d.Data.proxifyUrl(s,{proxy:"passport"})),this._texture=t.ImageUtils.loadTexture(s,void 0,this._onTextureLoaded.bind(this,this._volumeButtonNode),this.onLoadImageError,!1),this._video.volume=n,0===this._video.volume?this._video.muted=!0:this._video.muted=!1}else n=this._video.muted?0:this._video.volume;let r,u;this._media?(r=this._media.getView().getCorners(),u=this._media.getView().getCenter()):(r=this._cornersOriginal,u=this._positionOriginal);let _=this._getMainLineEndPoints(u,r),c=_.startVolume3D,m=_.endVolume3D,p=[c,m];this._mainVolumeLine&&this._mainNode.removeChild(this._mainVolumeLine),this._mainVolumeLine=a.createLineNode({points:p}),this._mainVolumeLine.setPickable(o.PICKTHROUGH),this._mainVolumeLine.setExcludeFromBounding(!0),this._mainVolumeLine.setMaterialApplication(new i({lineMaterial:l.getCustomMaterial("#808080")})),this._media?"number"==typeof this._media.getView().getDepth()&&(this._mainVolumeLine.material.depthTest=!1,this._mainVolumeLine.setRenderDepth(5*this._media.getView().getDepth()-2)):e&&"number"==typeof e.renderDepth&&(this._mainVolumeLine.material.depthTest=!1,this._mainVolumeLine.setRenderDepth(e.renderDepth-2)),this._mainNode.addChild(this._mainVolumeLine),this._playVolumeLine&&this._mainNode.removeChild(this._playVolumeLine);let g=n,v=new t.Vector3((1-g)*c.x+g*m.x,(1-g)*c.y+g*m.y,(1-g)*c.z+g*m.z),f=[c,v];this._playVolumeLine=a.createLineNode({points:f}),this._playVolumeLine.setPickable(o.PICKTHROUGH),this._playVolumeLine.setExcludeFromBounding(!0),this._playVolumeLine.setMaterialApplication(new i({lineMaterial:l.getSelectionMaterial()})),this._media?"number"==typeof this._media.getView().getDepth()&&(this._playVolumeLine.material.depthTest=!1,this._playVolumeLine.setRenderDepth(5*this._media.getView().getDepth()-1)):e&&"number"==typeof e.renderDepth&&(this._playVolumeLine.material.depthTest=!1,this._playVolumeLine.setRenderDepth(e.renderDepth-1)),this._mainNode.addChild(this._playVolumeLine),this._volumeHandle.setMatrix((new t.Matrix4).setPosition(v)),this._volumeHandle.setVisibility(!0),this._viewer.render()}},update:function(n,s,r,h){if(this._mainNode){h&&(this._mainVolumeLine&&this._mainVolumeLine.setVisibility(!1),this._playVolumeLine&&this._playVolumeLine.setVisibility(!1),this._volumeHandle&&this._volumeHandle.setVisibility(!1)),this._fitting=!s||s.x>100&&s.y>100;let d=this._getMainLineEndPoints(n,r),u=d.startLeft3D,_=d.startRight3D,c=d.volumeBtsPos3D,m=[u,_];this._mainLine&&this._mainNode.removeChild(this._mainLine),this._mainLine=a.createLineNode({points:m}),this._mainLine.setPickable(o.PICKABLE),this._mainLine.setExcludeFromBounding(!0),this._mainLine.setMaterialApplication(new i({lineMaterial:l.getCustomMaterial("#808080")})),this._media?"number"==typeof this._media.getView().getDepth()&&(this._mainLine.material.depthTest=!1,this._mainLine.setRenderDepth(5*this._media.getView().getDepth()-2)):e&&"number"==typeof e.renderDepth&&(this._mainLine.material.depthTest=!1,this._mainLine.setRenderDepth(e.renderDepth-2)),this._mainNode.addChild(this._mainLine),this._playLine&&this._mainNode.removeChild(this._playLine),this.videoDuration||(this.videoDuration=this._video.duration);let p=this._video.currentTime/this.videoDuration,g=new t.Vector3((1-p)*u.x+p*_.x,(1-p)*u.y+p*_.y,(1-p)*u.z+p*_.z),v=[u,g];this._playLine=a.createLineNode({points:v}),this._playLine.setPickable(o.PICKTHROUGH),this._playLine.setExcludeFromBounding(!0),this._playLine.setMaterialApplication(new i({lineMaterial:l.getSelectionMaterial()})),this._media?"number"==typeof this._media.getView().getDepth()&&(this._playLine.material.depthTest=!1,this._playLine.setRenderDepth(5*this._media.getView().getDepth()-1)):e&&"number"==typeof e.renderDepth&&(this._playLine.material.depthTest=!1,this._playLine.setRenderDepth(e.renderDepth-1)),this._mainNode.addChild(this._playLine),this._currTimeHandle.setMatrix((new t.Matrix4).setPosition(g));let f=new t.Vector3,V=new t.Quaternion,w=new t.Vector3,D=this._volumeButtonNode.getMatrix().clone();D.decompose(f,V,w);let y,T=new t.Vector3,b=new t.Quaternion,P=new t.Vector3;y=this._media?this._media.getView().getMatrix().clone():this._matrixOriginal.clone(),y.decompose(T,b,P);let M=new t.Quaternion(0,0,-.7071067811865476,.7071067811865476).inverse(),C=(new t.Quaternion).multiplyQuaternions(b,M);D.compose(c,C,w),this._volumeButtonNode.setMatrix(D),this._viewer.currentViewpoint.project(c).distanceTo(this._viewer.currentViewpoint.project(_))<14?this._volumeButtonNode.setVisibility(!1):this._volumeButtonNode.setVisibility(!0),this._viewer.render(),this._mainNode.setVisibility(this._fitting&&this._timelineVisibility)}},isActivated:function(){return this._activatedTime||this._manipulatingTime||this._activatedVolume||this._manipulatingVolume},setVisibility:function(e){this._timelineVisibility=e,this._mainLine&&this._mainLine.setVisibility(this._fitting&&e)},dispose:function(){this._mainNode&&this._viewer&&this._currTimeHandle&&(this._currTimeHandle.unsubscribe("BeginPreactivate",this._onBeginPreactivateCB),this._currTimeHandle.unsubscribe("EndPreactivate",this._onEndPreactivateCB),this._currTimeHandle.unsubscribe("BeginManipulate",this._onBeginManipulateCB),this._currTimeHandle.unsubscribe("Manipulate",this._onManipulateCB),this._currTimeHandle.unsubscribe("EndManipulate",this._onEndManipulateCB),this._volumeHandle&&(this._volumeHandle.unsubscribe("BeginPreactivate",this._onBeginPreactivateVolumeCB),this._volumeHandle.unsubscribe("EndPreactivate",this._onEndPreactivateVolumeCB),this._volumeHandle.unsubscribe("BeginManipulate",this._onBeginManipulateVolumeCB),this._volumeHandle.unsubscribe("Manipulate",this._onManipulateVolumeCB),this._volumeHandle.unsubscribe("EndManipulate",this._onEndManipulateVolumeCB)),this._videoNode.removeChild(this._mainNode),this._mainNode=null),this._viewer=null,this._videoNode=null}};return m.load(e.controlPosition,e.videoDimension,e.corners),m.update(e.controlPosition,e.videoDimension,e.corners),m.setVisibility(!0),m},p=function(e,n,s){var l={_viewer:e.viewer,_fitting:!0,_media:e.media,_cornersOriginal:e.corners,_positionOriginal:e.controlPosition,_matrixOriginal:e.matrix,_videoNode:n,_video:s,_thumbnailURL:e.thumbnailURL,_viewSettings:e.viewSettings,load:function(){var e=void 0;e=this._media?this._media.getView():this._videoNode,this._texture=t.ImageUtils.loadTexture(this._thumbnailURL,void 0,this._onTextureLoaded.bind(this,e),this.onLoadImageError,!1)},_onTextureLoaded:function(n){if(null!==this._viewer&&(!this._rectangle||!1!==this._rectangle._getVisible())){var s=100,l=100,h=void 0;if(this._media&&(s=this._media.getView().getDimensions().width,l=this._media.getView().getDimensions().height,h=new t.Vector2(.5*s,.5*l)),this._rectangle){let t=this._rectangle.parents[0];if(this._textureLoaded){let t=this._rectangle.getBoundingBox(),i=t.max.x-t.min.x,n=t.max.y-t.min.y;if(s===i&&l===n)return this._media?"number"==typeof this._media.getView().getDepth()&&this._rectangle.setRenderDepth(5*this._media.getView().getDepth()-3):e&&"number"==typeof e.renderDepth&&this._rectangle.setRenderDepth(e.renderDepth-3),void this._viewer.render()}t&&t.removeChild(this._rectangle)}if(this._texture.image.width>16&&(this._textureLoaded=!0),this._rectangle=a.createRectangleNode({width:-s,height:-l,fill:!0,cornerPoint:h,noEdge:"whiteboard"===r.getPreferenceValue("appMode"),color:new o.Color(255,255,255,0)}),this.parentNodeIdForThumbnail&&(this._rectangle.name=this.parentNodeIdForThumbnail),this._rectangle.setPickingPriorityId(c.getLabelOf(c.SupportTypes.IMAGE)),this._rectangle.setPickable(o.PICKABLE),!this._media){var d=this._matrixOriginal.clone();this._rectangle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(s/2,l/2,0))),this._rectangle.applyMatrix(d)}n.addChild(this._rectangle);var u=new t.LineBasicMaterial({opacity:0}),_=new t.MeshBasicMaterial({map:this._texture,force:!0,side:t.DoubleSide});_.transparent=!0,_.color=new t.Color,_.polygonOffset=!0,_.polygonOffsetFactor=.7,this._media?"number"==typeof this._media.getView().getDepth()&&(_.depthTest=!1,this._rectangle.setRenderDepth(5*this._media.getView().getDepth()-3)):e&&"number"==typeof e.renderDepth&&(_.depthTest=!1,this._rectangle.setRenderDepth(e.renderDepth-3)),this._rectangle.removeMaterialApplication();var m=new i({faceMaterial:_,lineMaterial:u});this._rectangle.setMaterialApplication(m),this._viewer.render()}},update:function(){if(this._texture){var e=void 0;e=this._media?this._media.getView():this._videoNode,this._onTextureLoaded(e)}this._viewer.render()},setVisibility:function(e){this._rectangle&&this._rectangle.setVisibility(e)},dispose:function(){if(this._rectangle){var e=this._rectangle.parents[0];e&&e.removeChild(this._rectangle),this._rectangle=null}this._viewer=null,this._videoNode=null}};return l.load(e.controlPosition,e.videoDimension,e.corners),l.update(),l.setVisibility(!0),l},g=function(e,r){var l={_btnNode:null,_viewer:e.viewer,_fitting:!0,_canvasNode:null,_img:null,_videoNode:r,load:function(){this._btnNode=new n("playButtonNode"),this._fixedNode=new s({name:"fixedPlayNode",ratio:1}),this._btnNode.addChild(this._fixedNode),this._videoNode.addChild(this._btnNode);var e=h.getWebappsAssetUrl("CAT3DWVideosUI","graphics/videoplay.png");window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(e=d.Data.proxifyUrl(e,{proxy:"passport"})),this._texture=t.ImageUtils.loadTexture(e,void 0,this._onTextureLoaded.bind(this,this._fixedNode),this.onLoadImageError,!1)},_onTextureLoaded:function(n){if(null!==this._viewer){this._rectangle=a.createRectangleNode({width:100,height:100,fill:!0,color:new o.Color(255,255,255,0)});var s=new t.Matrix4;s.set(0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1),s.setPosition(new t.Vector3(50,-50,0)),this._rectangle.setMatrix(s),this._rectangle.setPickable(o.PICKTHROUGH),n.addChild(this._rectangle);var r=new t.LineBasicMaterial({opacity:0}),l=new t.MeshBasicMaterial({map:this._texture,force:!0,side:t.DoubleSide});l.transparent=!0,l.color=new t.Color,this._media?"number"==typeof this._media.getView().getDepth()&&(l.depthTest=!1,this._rectangle.setRenderDepth(5*this._media.getView().getDepth()-2)):e&&"number"==typeof e.renderDepth&&(l.depthTest=!1,this._rectangle.setRenderDepth(e.renderDepth-2)),this._rectangle.removeMaterialApplication();var h=new i({faceMaterial:l,lineMaterial:r});this._rectangle.setMaterialApplication(h),this._viewer.render()}},update:function(e,t){if(this._btnNode){this._fitting=!t||t.x>100&&t.y>100;var i=this._btnNode.getMatrix();i.setPosition(e),this._btnNode.setMatrix(i),this._btnNode.setVisibility(this._fitting&&this._playButtonVisibility)}},setVisibility:function(e){this._playButtonVisibility=e,this._btnNode&&this._btnNode.setVisibility(this._fitting&&e)},isPicked:function(e){if(this._btnNode&&this._btnNode.isVisible()){var i=this._viewer.currentViewpoint.project((new t.Vector3).getPositionFromMatrix(this._btnNode.getMatrixWorld()));return e.distanceTo(new t.Vector2(i.x,i.y,0))<=50}return!1},dispose:function(){this._btnNode&&this._viewer&&(this._videoNode.removeChild(this._btnNode),this._btnNode=null),this._viewer=null,this._videoNode=null}};return l.load(),l.update(e.controlPosition,e.videoDimension),l.setVisibility(!0),l},v={registerVideoController:function(e){this.videosControllers.push(e)},removeVideoController:function(e){var t=this.videosControllers.findIndex((function(t){return e===t}));t>=0&&this.videosControllers.splice(t,1)},pauseVideosControllers:function(e){this.videosControllers.forEach((function(t){t.pauseAllVideos(e)}))},muteVideosControllers:function(){this.videosControllers.forEach((function(e){e.muteVideos(!0)}))},videosControllers:[]},f=e.extend({init:function(){return this._videoAnimationToken=null,this._videos=[],this._viewSettings=null,v.registerVideoController(this),this},dispose:function(){this._videoAnimationToken=null,this._videos=[],this._viewSettings=null,v.removeVideoController(this)},setViewSettings:function(e){this._viewSettings=e},pauseAllVideos:function(e){this._videos.forEach((function(t){t!==e&&t.isPlaying()&&t.pause()}))},createVideo:function(e){e.viewSettings=this._viewSettings;var i=document.createElement("video");return i.type="video/mp4",i.width=640,i.height=360,i.loop=!0,i.setAttribute("playsinline","playsinline"),i.crossOrigin=r.getPreferenceValue("CrossOrigin"),i.crossOrigin||(i.crossOrigin="use-credentials"),new Promise((function(t){let n=!1;var a=function(){if(!1===n){if(i.videoWidth&&i.videoHeight){var e=i.videoWidth/i.videoHeight;i.width=640*Math.min(e,1),i.height=640/Math.max(e,1)}n=!0,t()}};i.addEventListener("loadedmetadata",(function(){a()})),i.src=e.urlOrTexture,i.readyState>=2&&a()})).then(function(){return new Promise(function(n){var a=new t.Texture(i);a.minFilter=t.LinearFilter,a.magFilter=t.LinearFilter,a.format=t.RGBFormat;var o={_videosController:this,_texture:a,_video:i,_media:e.media,_src:e.urlOrTexture,_paused:!0,_pausedVideoAnimation:!1,_viewer:e.viewer,_playButton:e.controlPosition?g(e,e.videoNode):null,_timeline:e.controlPosition?m(e,e.videoNode,i):null,_thumbnail:e.thumbnailURL&&e.controlPosition?p(e,e.videoNode,i):null,_onVideoPlayStart:function(e){e&&v.pauseVideosControllers(e)},_startUpdateTexture:function(e){if(!this._updateTextureRequest){this._videPlayData={start:0,currentTime:null,startPlayTime:e};var i=function(e){if(e=e||performance.now(),this._videPlayData.start&&this._video.readyState>=this._video.HAVE_CURRENT_DATA&&this._videPlayData.startPlayTime&&e-this._videPlayData.start>=this._videPlayData.startPlayTime&&(this._videPlayData.startPlayTime=0,this._paused))this._stopUpdateTexture();else{if(!this._videPlayData.start&&this._video.readyState>=this._video.HAVE_CURRENT_DATA&&(this._videPlayData.start=e),this._video.readyState>=this._video.HAVE_CURRENT_DATA&&(null===this._videPlayData.currentTime||this._videPlayData.currentTime!==this._video.currentTime)&&(this._texture.needsUpdate=!0,this._videPlayData.currentTime=this._video.currentTime,this._timeline)){let e,i;this._media?(e=this._media.getView().getCorners(),i=this._media.getView().getCenter()):(e=this._timeline._cornersOriginal,i=this._timeline._positionOriginal),this._timeline.update(i,new t.Vector2(this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.topRight)),this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.bottomLeft))),e,!1)}this._updateTextureRequest=l.requestAnimationFrame(i)}}.bind(this);this._updateTextureRequest=l.requestAnimationFrame(i)}},_stopUpdateTexture:function(){this._updateTextureRequest&&l.cancelAnimationFrame(this._updateTextureRequest),this._updateTextureRequest=null},updateVideoControls:function(e,t,i,n){this._playButton&&this._playButton.update(e,t),this._timeline&&(this._timeline._cornersOriginal=i,this._timeline._positionOriginal=e,this._timeline.update(e,t,i,!0)),this._thumbnail&&(this._thumbnail._cornersOriginal=i,this._thumbnail._positionOriginal=e,n&&(this._thumbnail.parentNodeIdForThumbnail=n),this._thumbnail.update(e,t,i))},isActivated:function(){return!!this._timeline&&this._timeline.isActivated()},getTexture:function(){return this._texture},getSrc:function(){return this._src},pauseVideoAnimation:function(e){this._video&&(e||this._paused?this._video.pause()&&this._stopUpdateTexture():this._video.play()&&this._startUpdateTexture()),this._pausedVideoAnimation=e},play:function(){this._video&&!this._pausedVideoAnimation&&(this._video.play(),this._startUpdateTexture()),this._paused=!1,this._playButton&&this._playButton.setVisibility(!1),this._onVideoPlayStart&&this._onVideoPlayStart(this),this._thumbnail&&this._thumbnail.setVisibility(!1)},pause:function(){this._video&&this._video.pause(),this._paused=!0,this._playButton&&(this._playButton.setVisibility(!0),this._viewer.render())},reset:function(){this._video&&(this._video.currentTime=0)},mute:function(e){this._video.muted=e},isPlaying:function(){return this._video&&!this._paused},processPickInVideo:function(e){return!this.isPlaying()&&(!this._playButton||this._playButton&&this._playButton.isPicked(e))?(this.play(),!0):!!this.isPlaying()&&(this.pause(),!0)},processtimelineMoveInVideo:function(e,t){this._timeline&&this._timeline.updateTimelineMarker(e,t)},processtimelineTapInVideo:function(e){this._timeline&&this._timeline.processtimelineTapInVideo(e)},processPickInVideoVolume:function(e){this._timeline&&this._timeline.processPickInVideoVolume(e)},dispose:function(){this._video&&(this.pause(),this._video.removeAttribute("src"),this._video.load(),this.video=null),this._playButton&&(this._playButton.dispose(),this._playButton=null),this._timeline&&(this._timeline.dispose(),this._timeline=null),this._thumbnail&&(this._thumbnail.dispose(),this._thumbnail=null),this._texture&&(this._texture.dispose(),this.texture=null)}};this._videos.length||(this._viewer=e.viewer,this.startVideosAnimation()),this._videos.push(o),i.play().then((()=>{i.pause(),i.currentTime=0,this._updateTextureRequest=l.requestAnimationFrame((()=>{o._texture.needsUpdate=!0,this._updateTextureRequest=void 0}))})).catch((()=>{i.currentTime=0})),n(o)}.bind(this))}.bind(this))},updateStreamsofSimilarVideoMedia:function(e){this._videos.forEach((function(t){e&&t._media&&t._media.getMediaOccId()===e.getMediaOccId()&&t._media.getDataService().setValue("streams",e.getDataService().getValue("streams"))}))},muteVideos:function(e){this._videos.forEach((function(t){t.mute(e)}))},removeVideo:function(e){var t=this._videos.findIndex((function(t){return e===t}));t>=0&&this._videos.splice(t,1)[0].dispose();this._videos.length||(this.stopVideosAnimation(),this._viewer=null)},startVideosAnimation:function(){if(!this._videoAnimationToken){var e=0;this._videos.forEach((function(e){e.pauseVideoAnimation(!1)}));var t=function(i){this._videoAnimationToken=l.requestAnimationFrame(t),(i=i||performance.now())-e>33&&(e=i,this._videos.some((function(e){return e.isPlaying()}))&&this._viewer&&this._viewer.render())}.bind(this);this._videoAnimationToken=l.requestAnimationFrame(t)}},stopVideosAnimation:function(){this._videos.forEach((function(e){e.isPlaying()&&e.pauseVideoAnimation(!0)})),this._videoAnimationToken&&l.cancelAnimationFrame(this._videoAnimationToken),this._videoAnimationToken=null},isVideosAnimation:function(){return null!==this._videoAnimationToken},isVideoActivated:function(){let e=!1;return this._videos.forEach((function(t){t.isActivated()&&(e=!0)})),e}});return d.namespace("DS/CAT3DWVideosUI/CAT3DWVideosController",f)})),define("DS/CAT3DWVideosUI/CAT3DWVideoView",["UWA/Core","DS/CAT3DWPhoto/CAT3DWImageView","DS/CAT3DWVisu/CAT3DWDataFactory","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/WebUtils/ContextedSingleton","DS/CAT3DWInfra/CAT3DWPreferenceManager"],(function(e,t,i,n,a,o,s,r,l,h){"use strict";var d=t.extend({init:function(e,t,i){this._viewSettings=i,this._parent(e,t),this._sketchBorderMaterial=new s.LineBasicMaterial({color:new s.Color("orange"),lineWidth:2}),this._onTapToken||(this._onTapToken=r.addEvent(this._viewer.canvas,"onTap",this._onTapClick.bind(this))),this._onClickToken||(this._onClickToken=r.addEvent(this._viewer.canvas,"onLeftClick",this._onTapClick.bind(this))),this._onMouseMoveToken||(this._onMouseMoveToken=r.addEvent(this._viewer.canvas,"onMouseMove",this._onMouseMove.bind(this))),this._onViewPointMove||(this._onViewPointMove=this._viewer.currentViewpoint.onMove(function(){this.updateVideoControls()}.bind(this))),this._appMode=h.getPreferenceValue("appMode")},_createRectangle:function(){this._parent(),this.setImagePickable(!0)},_getCornerPoint:function(){return new s.Vector2(.5*this._width,.5*this._height)},resize:function(e,t){e&&t&&(this._width=this._defaultRectangleValue*e,this._height=this._defaultRectangleValue*t,this._createRectangle())},dispose:function(){this._onTapToken&&r.removeEventFromToken(this._onTapToken),this._onTapToken=null,this._onClickToken&&r.removeEventFromToken(this._onClickToken),this._onClickToken=null,this._onMouseMoveToken&&r.removeEventFromToken(this._onMouseMoveToken),this._onMouseMoveToken=null,this._onViewPointMove&&this._viewer.currentViewpoint.unsubscribe(this._onViewPointMove),this._onMovePrevCB=null,this._setDepthInterval&&clearInterval(this._setDepthInterval),this._parent()},setDepth:function(e){var t=this.getMediaObj()?this.getMediaObj().getVideoData():null,i=[];t&&t._playButton&&t._playButton._rectangle&&t._timeline._rectangle&&(!t._thumbnail||t._thumbnail._rectangle)?(i[0]={node:t._playButton._rectangle,offset:2},i[1]={node:t._timeline._rectangle,offset:2},i[2]={node:t._timeline._mainLine,offset:2},i[3]={node:t._timeline._playLine,offset:1},i[4]={node:t._timeline._mainVolumeLine,offset:2},i[5]={node:t._timeline._playVolumeLine,offset:1},i[6]={node:t._timeline._volumeHandle.diskNode,offset:0},i[7]={node:t._timeline._currTimeHandle.diskNode,offset:0},t._thumbnail&&t._thumbnail._rectangle&&(i[8]={node:t._thumbnail._rectangle,offset:3})):(this._setDepthInterval&&clearInterval(this._setDepthInterval),this._setDepthInterval=setInterval(function(){t&&t._playButton&&t._playButton._rectangle&&t._timeline._rectangle&&(!t._thumbnail||t._thumbnail._rectangle)&&(clearInterval(this._setDepthInterval),this._setDepthInterval=void 0,i[0]={node:t._playButton._rectangle,offset:2},i[1]={node:t._timeline._rectangle,offset:2},i[2]={node:t._timeline._mainLine,offset:2},i[3]={node:t._timeline._playLine,offset:1},i[4]={node:t._timeline._mainVolumeLine,offset:2},i[5]={node:t._timeline._playVolumeLine,offset:1},i[6]={node:t._timeline._volumeHandle.diskNode,offset:0},i[7]={node:t._timeline._currTimeHandle.diskNode,offset:0},t._thumbnail&&t._thumbnail._rectangle&&(i[8]={node:t._thumbnail._rectangle,offset:3}),this._setDepth(e,i),this._viewer.render())}.bind(this),1)),this._setDepth(e,i)},_setDepth:function(e,t){if(this._rectangle&&this._rectangle.material){var i=5*e;this._rectangle.setRenderDepth(i-4),this._rectangle.setPickingPriorityId("imagePriority"+e),this._rectangle.material.transparent=!0,this._rectangle.material.depthTest=!1;var n=this._rectangle.getMaterial("Line");if(n&&(n.transparent=!0,n.depthTest=!1),t)for(var a=0;a<t.length;a++)t[a].node&&(t[a].node.setRenderDepth(i-t[a].offset),t[a].node.material&&(t[a].node.material.transparent=!0,t[a].node.material.depthTest=!1));this._hyperlinkNode&&this._hyperlinkNode.getChildren()[0].setRenderDepth(i)}else this._depth=e},getDepth:function(){var e=0;return this._rectangle.mesh3js&&this._rectangle.mesh3js.renderDepth&&(e=(this._rectangle.mesh3js.renderDepth+4)/5),e},updateVideoControls:function(){var e=this.getMediaObj()?this.getMediaObj().getVideoData():null;if(e){var t=this.getCorners();e.updateVideoControls(this.getCenter(),new s.Vector2(this._viewer.currentViewpoint.project(t.topLeft).distanceTo(this._viewer.currentViewpoint.project(t.topRight)),this._viewer.currentViewpoint.project(t.topLeft).distanceTo(this._viewer.currentViewpoint.project(t.bottomLeft))),t)}},isPickedObject:function(e){var t=l.get(null,"ANNOTATION_MANAGER").getPickingController(),n=t.getPickingMask();t.setCPUPicking(),t.setPickingMask(i.SupportTypes.IMAGE);var a=t.pick(e,!0);return t.setPickingMask(n),t.setHybridPicking(),a&&a.path&&a.path.externalPath[0]&&a.path.externalPath[1]===this},isPickedObjectOnTimeline:function(e,t){var n=l.get(null,"ANNOTATION_MANAGER").getPickingController(),a=n.getPickingMask();n.setCPUPicking(),n.setPickingMask(i.SupportTypes.IMAGE);var o=n.pick(e,!0);return n.setPickingMask(a),n.setHybridPicking(),o&&o.path&&o.path.externalPath.length>=3&&o.path.externalPath[0]&&o.path.externalPath[1]===t._timeline._mainNode&&o.path.externalPath[2]===t._timeline._mainLine},isPickedObjectVolumeButton:function(e,t){var n=l.get(null,"ANNOTATION_MANAGER").getPickingController(),a=n.getPickingMask();n.setCPUPicking(),n.setPickingMask(i.SupportTypes.IMAGE);var o=n.pick(e,!0);return n.setPickingMask(a),n.setHybridPicking(),o&&o.path&&o.path.externalPath.length>=3&&o.path.externalPath[0]&&o.path.externalPath[1]===t._timeline._mainNode&&o.path.externalPath[2]===t._timeline._volumeButtonNode},_onTapClick:function(e){var t=this.getMediaObj()?this.getMediaObj().getVideoData():null;if(t){var i=e.gesture.getEvents()[0].getCurrentPosition();"video"!==e.state&&this.isPickedObject(i)&&t.processPickInVideo(i)?e.state="video":this.isPickedObjectOnTimeline(i,t)?t.processtimelineTapInVideo(i):this.isPickedObjectVolumeButton(i,t)&&t.processPickInVideoVolume(i)}},_onMouseMove:function(e){var t=this.getMediaObj()?this.getMediaObj().getVideoData():null;if(t){var i=e.gesture.getEvents()[0].getCurrentPosition();this.isPickedObjectOnTimeline(i,t)?t.processtimelineMoveInVideo(i,!0):t.processtimelineMoveInVideo(i,!1)}},_getRectShadowMaterial:function(e,t,i,n){var a=new s.MeshBasicMaterial({color:new s.Color("black"),transparent:!0,polygonOffset:!0,depthTest:!0,force:!0,side:s.DoubleSide});a.activatePDSFX();var o={width:{type:"f",value:e},height:{type:"f",value:t},widthDiff:{type:"f",value:i},heightDiff:{type:"f",value:n}};a.setPDSFXUniforms(o),a.setPDSFXVaryings({locPos:{type:"v3"}});var r={ComputeOpacity:["float ComputeOpacity() {","  float myX = locPos.x + width / 2.0;","  float myY = locPos.y + height / 2.0;","  bool smallx = (myX < widthDiff);","  bool smally = (myY < heightDiff);","  bool bigx = (myX > width - widthDiff);","  bool bigy = (myY > height - heightDiff);","  float normalizedx = 0.0;","  float normalizedy = 0.0;","  float opacity = 0.25;","","  if (smallx) {","    normalizedx = myX / widthDiff;","    if (smally) {","      normalizedy = myY / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    if (bigy) {","      normalizedy = 1.0 - (myY - height + heightDiff) / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    return pow( normalizedx, 2.0 ) * opacity;","  }","  if (bigx) {","    normalizedx = 1.0 - (myX - width + widthDiff) / widthDiff;","    if (smally) {","      normalizedy = myY / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    if (bigy) {","      normalizedy = 1.0 - (myY - height + heightDiff) / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    return pow( normalizedx, 2.0 ) * opacity;","  }","  if (smally && !smallx && !bigx) {","    return pow( myY / heightDiff, 2.0 ) * opacity;","  }","  if (bigy && !smallx && !bigx) {","    return pow( 1.0 - (myY - height + heightDiff) / heightDiff, 2.0 ) * opacity;","  }","  return 0.0;","}"].join("\n")};return a.setPDSFXOverridableFunctions({ComputeVaryingValues:"void ComputeVaryingValues() { locPos = vGetAttribPosition() ;}"},r),a},setSelected:function(e){e?this._media.select():this._media.deselect()},_getRectangleCorners:function(e){if(this._rectangle){var t=this._rectangle.mesh3js.geometry[0].vertexPositionArray;return{bottomLeft:new s.Vector3(t[0],t[1],t[2]).applyMatrix4(e),bottomRight:new s.Vector3(t[3],t[4],t[5]).applyMatrix4(e),topLeft:new s.Vector3(t[9],t[10],t[11]).applyMatrix4(e),topRight:new s.Vector3(t[6],t[7],t[8]).applyMatrix4(e)}}var i=new s.Vector3(this._defaultRectangleValue/2,this._defaultRectangleValue/2,0),n=new s.Vector3(-this._defaultRectangleValue/2,this._defaultRectangleValue/2,0),a=new s.Vector3(this._defaultRectangleValue/2,-this._defaultRectangleValue/2,0),o=new s.Vector3(-this._defaultRectangleValue/2,-this._defaultRectangleValue/2,0);return i.applyMatrix4(e),n.applyMatrix4(e),a.applyMatrix4(e),o.applyMatrix4(e),{bottomLeft:i,bottomRight:n,topLeft:a,topRight:o}}});return e.namespace("DS/CAT3DWVideosUI/CAT3DWVideoView",d)})),define("DS/CAT3DWVideosUI/CAT3DWVideo",["UWA/Core","DS/CAT3DWPhoto/CAT3DWImage","DS/CAT3DWVideosUI/CAT3DWVideoView","DS/CAT3DWInfraUI/CAT3DWCanvasServices","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/PlatformAPI/PlatformAPI","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices","DS/CAT3DWInfra/CAT3DWFileServices"],(function(e,t,i,n,a,o,s,r,l,h){"use strict";var d=t.extend({init:function(e){this._isVideo=!0===e.isVideo,this._videoData=null,this._videosControllers=e.videosController,this._videosControllers.setViewSettings(e.viewSettings),this._parent(e),this.getDataService().setValue("selected",!1),e.streams&&this.getDataService().setValue("streams",e.streams),e.thumbnailURL&&this.getDataService().setValue("thumbnailURL",e.thumbnailURL),e.currentStream?this.getDataService().setValue("currentStream",e.currentStream):this.getDataService().setValue("currentStream",h.VIDEO_STREAM_BEST),this.getDataService().setValues({id:e.mediaId}),this._file=e.file},dispose:function(){this._videosControllers.removeVideo(this._videoData),this._videoData=null,this._videosControllers=null,this.getView()&&this.getView().dispose(),this._parent()},createMediaView:function(e,t){return new i(this,e,t.viewSettings)},getImageBlob:function(){var e=new n,t=e.getDataUrlFromImg(this.getTexture().image).dataUrl;return e.getBlobFromDataUrl(t)},getFile:function(){return this._file},setTexture:function(e,t){var i="";if(i=e||o.getWebappsAssetUrl("CAT3DWPhoto","graphics/G_NXGAddImage.png"),this._bIsTextureLoading)this._queuedTexture.urlOrTexture=i,this._queuedTexture.callback=t;else if(this._bIsTextureLoading=!0,"string"==typeof i){if(!0===this._isVideo){var n=this.getView().getCorners(),s=this.getDataService().getValue("thumbnailURL");this._videosControllers.createVideo({videoNode:this._mediaView.parents[0],urlOrTexture:i,viewer:this._viewer,controlPosition:this.getView().getCenter(),corners:n,media:this,thumbnailURL:s,videoDimension:new a.Vector2(this._viewer.currentViewpoint.project(n.topLeft).distanceTo(this._viewer.currentViewpoint.project(n.topRight)),this._viewer.currentViewpoint.project(n.topLeft).distanceTo(this._viewer.currentViewpoint.project(n.bottomLeft)))}).then(function(e){this._videoData=e,this._texture=this._videoData.getTexture(),setTimeout(this._onTextureLoaded.bind(this,t))}.bind(this))}}else"object"==typeof i&&(this._texture=i,setTimeout(this._onTextureLoaded.bind(this,t)))},getVideoData:function(){return this._videoData},pause:function(){this.getVideoData()&&this.getVideoData().pause()},mute:function(){this.getVideoData()&&this.getVideoData().mute(!0)},unmute:function(){this.getVideoData()&&this.getVideoData().mute(!1)},play:function(){this.getVideoData()&&this.getVideoData().play()},isPlaying:function(){return!!this.getVideoData()&&this.getVideoData().isPlaying()},isVideo:function(){return this._isVideo},getType:function(){return"CAT3DWVideo"},_transformationUpdate:function(e){this._parent(e),this._mediaView.updateVideoControls()},stream:function(e){let t=this._parent(e);return t.published=this.getDataService().getValue("published"),t.isVideo=!0,t.image=this.getTexture().image.currentSrc,t.title=this.getDataService().getValue("title"),t.extension=this.getDataService().getValue("extension"),t},callOnMediaSaveCB:function(e){if(!e.error){this.getDataService().setValue("mediaId",e.mediaId),this.getDataService().setValue("published",e.published),e.thumbnailURL&&this.getDataService().setValue("thumbnailURL",e.thumbnailURL);var t=this.getMediaOccId();if(e.mapOfMediaOccIdToMedia)for(let i=0;i<e.mapOfMediaOccIdToMedia.get(t).length;i++)e.mapOfMediaOccIdToMedia.get(t)[i].getDataService().setValue("mediaId",e.mediaId),e.mapOfMediaOccIdToMedia.get(t)[i].getDataService().setValue("published",e.published),e.thumbnailURL&&e.mapOfMediaOccIdToMedia.get(t)[i].getDataService().setValue("thumbnailURL",e.thumbnailURL);l.getMediaWhenProcessed({mediaID:e.mediaId,object:this})}this._onMediaSavedCB&&(this.getView()&&this._onMediaSavedCB(),this._onMediaSavedCB=null)},platformCallback:function(e){e.uri&&e.uri===this.getDataService().getValue("mediaId")&&l.requestSingleMedia({mediaId:this.getDataService().getValue("mediaId"),associatedData:{fullData:!0}}).then((e=>{e&&e.play&&e.play.av_streams&&(this.getDataService().setValue("streams",e.play.av_streams),this._videosControllers.updateStreamsofSimilarVideoMedia(this))}))}});return e.namespace("DS/CAT3DWVideosUI/CAT3DWVideo",d)}));