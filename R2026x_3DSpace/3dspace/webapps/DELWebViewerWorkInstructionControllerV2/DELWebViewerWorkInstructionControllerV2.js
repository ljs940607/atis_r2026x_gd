define("DS/DELWebViewerWorkInstructionControllerV2/DELImporter",["UWA/Core","DS/DELWebViewerCommon/DELCommonImporter"],(function(e,t){"use strict";return function(e,n){var i,o=n.getOption("logger"),r=function(){var n={context:e.getContext(),frameWindow:e.getFrameWindow(),bDisplayNominal:!1,bDisplayInWork:!1,thumbnailListTitle:"",activateSlide:!1,displayDMUSlidePanel:!1,beforeApplySlideCB:null,afterApplySlideCB:null};return i||(i=new t(n)),i};return{importModel:function(e){o.debug("DELImporter::importModel method invoked with parameters : %o",e),r().importModel(e)},removeModel:function(){o.debug("DELImporter::removeModel method invoked"),r().removeModel()},destroy:function(){i&&(i.removeModel(),i.destroyDMUImporter()),o=i=r=null}}}})),define("DS/DELWebViewerWorkInstructionControllerV2/WorkInstructionDataManager",["DS/DELWebViewerModel/Buildup/BuildUpSettings"],(function(e){"use strict";return function(t,n){var i=n.getOption("logger"),o=t.getInstance("WorkInstructionBehaviorModelService"),r=n.getOption("mappingKeys"),u=function(e,t){var n=[];return UWA.is(e)&&UWA.is(e.Model,"array")&&UWA.is(e.Model[0].WKIRelations,"array")&&e.Model[0].WKIRelations.length>0&&e.Model[0].WKIRelations.forEach((function(e){t&&e&&e.Instruction&&e.View&&(UWA.is(t.pid,"array")&&(t.pid.indexOf(e.Instruction.InstPhyID)>-1||e.Instruction.Row&&t.pid.indexOf(e.Instruction.Row.RowPhyID)>-1)?-1===n.indexOf(e.View.UUID)&&n.push(e.View.UUID):t.uuid&&e.View.UUID===t.uuid&&(n.push(UWA.is(e.Instruction.Row)?e.Instruction.Row.RowPhyID:e.Instruction.InstPhyID),UWA.is(e.Instruction.Row)&&n.push(e.Instruction.InstPhyID)))})),n};return{getStepViewJson:function(e){return new UWA.Promise((function(t,n){o.getWKIContentPromise(e,r.FILETYPES.DMUJSON).then((function(e){t({json:e})})).fail(n)}))},initStepViewSettings:function(e){return new UWA.Promise((function(t,u){o.getWKIContentPromise(e,r.FILETYPES.WKIVIEWINFO).then((function(e){if(e&&e[r.WKIKEYS.WKIVIEWINFO]&&e[r.WKIKEYS.WKIVIEWINFO][r.WKIKEYS.OPERATION]){let n=e[r.WKIKEYS.WKIVIEWINFO][r.WKIKEYS.OPERATION][r.WKIKEYS.VIEWS];o.setCurrentStepViewInfo({viewInfo:n}),t(n)}else i.error("WorkInstructionDataManager::initStepViewSettings View BuildUp Settings format is invalid, check the mapping"),u(n.getNLSValue("Error.ViewBuildUpSettingsFormatInvalid.Message"))})).fail(u)}))},getLocalGraphicData:function(n,u){var s,l=o.getViewInfo({viewUUID:u}),a=t.getInstance("BuildUpBehaviorModelService");return i.debug("WorkInstructionDataManager::getLocalGraphicData method invoked with parameters : ",u),l?s=function(t={}){var i=[],o=[],u=e.getParsedBuildUpSettings(t.BuildUpSettings);return n&&UWA.is(n.mfgAndResourceBuildup,"array")&&n.mfgAndResourceBuildup.forEach((function(t){var n,o=e.getGraphicProperties(u,t.category);o&&(n=UWA.merge({path:t.path},o),"OnlyAssignedResources"===u[e.getCategory(t.category)].filter&&"all"===t.category&&(n.visibility=!1),n.visibilityFree=!n.visibility,i.push(n))})),n&&UWA.is(n.ftaBuildup,"array")&&(t&&UWA.is(t[r.WKIKEYS.FTAReqHideOverloads],"array")&&t[r.WKIKEYS.FTAReqHideOverloads].forEach((e=>{let t=e[r.WKIKEYS.BuildupDefId];if(t){let e=a.getPathFromBuildupDef(r.BUILDUPKEYS.FTAREQ,t);UWA.is(e,"array")&&o.push(e.toString())}})),n.ftaBuildup.forEach((function(n){let u=e.getGraphicsPropertiesForFTA(t.BuildUpSettings);if(n.category){let e=!(o.indexOf(n.path.toString())>-1)&&u.visibility;n[r.GRAPHICPROPERTIES.VISIBILITY]=e,n[r.GRAPHICPROPERTIES.VISIBILITYFREE]=!e,n[r.GRAPHICPROPERTIES.COLOR]=u[r.GRAPHICPROPERTIES.COLOR]?u[r.GRAPHICPROPERTIES.COLOR]:null}i.push(n)}))),i}(l):i.warn("View Settings not found"),s},getLinkedViewUuids:function(e,t){return new UWA.Promise((function(n,i){o.getWKIContentPromise(e,r.FILETYPES.WKICONTENT).then((function(e){n(u(e,t))})).fail(i)}))},getLinkedTextualInstIds:function(e,t){return new UWA.Promise((function(n,i){o.getWKIContentPromise(e,r.FILETYPES.WKICONTENT).then((function(e){n(u(e,{uuid:t}))})).fail(i)}))},getWKIContent:function(e){return new UWA.Promise((function(t,n){o.getWKIContentPromise(e,r.FILETYPES.WKICONTENT).then((function(e){t(e)})).fail(n)}))},getCurrentStepViewInfo:function(){o.getCurrentStepViewInfo()},getViewInfo:function(e){return o.getViewInfo(e)},reset:function(){o.reset()},destroy:function(){o&&o.destroy(),i=o=r=u=null}}}})),define("DS/DELWebViewerWorkInstructionControllerV2/WorkInstructionController",["UWA/Core","DS/DELWebViewerCommon/DELCommonSlideServices","DS/DELWebViewerUtils/DELWebViewerSettingsMgt","DS/DELWebViewerWorkInstructionControllerV2/WorkInstructionDataManager","DS/DELWebViewerWorkInstructionControllerV2/DELImporter","DS/DELWebViewerWorkInstructionCommon/DELWKIContent/DELWKIContentController","DS/DELWeb3DViewerV2/NodeUtil","DS/DELWebViewerUtils/Utils"],(function(e,t,n,i,o,r,u,s){"use strict";return function(l,a,c,d){var I,g=d.getOption("logger"),w=d.getOption("eventCollection").getViewerCtrlEventHnd(),p=new i(c,d),f=new r({context:a.getContext()}),h=l.getInstance("BuildUpBehavior"),S=new o(a,d),W=d.getOption("mappingKeys"),v=function(){return a.getMode()===W.VIEWERMODES.WORKINSTRUCTIONS},C=function(e){var t,n;return h?t=(n=h.getCurrentBuildUpContent())?n[e]:null:g.error("BuildUpBehavior not found"),t},E=async function(){g.debug("WorkInstructionController::clean method invoked"),a.removeSceneGraphOverrideSet(W.SCENEGRAPHKEYS.PUBLIC),f.removeModel(),S.removeModel(),e.is(I)&&I.clean(),p.reset();let t=d.getOption("executionContext"),n=t&&t.getComponent?t.getComponent("PlaySnapShot"):null;n&&n.CloseReview&&await n.CloseReview()},m=async function(){let i=async function(){var i=function(n,i){n&&n.data&&(a.setGraphicProperties({graphicProperties:p.getLocalGraphicData(C("buildupData"),n.data.uuid)},W.SCENEGRAPHKEYS.BUILDUP),n.data.context=a.getContext(),t.applySlide(n.data),f.applySlide({uuid:n.data.uuid}),e.is(n.data.uuid)&&i&&p.getLinkedTextualInstIds(C(W.BUILDUPKEYS.PATHIDS),n.data.uuid).then((function(e){w.publish(w.events.onSelectView,{viewUUID:n.data.uuid,textualInstructionPIds:e,viewID:n.data.id,viewName:n.data.name})})))},o=function(e){var n={slides:t.getSlidesDefinition({context:a.getContext()}),wkiContent:e};I.clean(),I.display(n)},r=function(t){var r;p.initStepViewSettings(C(W.BUILDUPKEYS.PATHIDS)).then((function(){return p.getWKIContent(C(W.BUILDUPKEYS.PATHIDS))})).then((function(o){return f.importModel({wkiContent:o,...t}),new e.Promise((function(e,t){I?e(o):((r=Object.create(d)).setOption("onSlideSelectedCB",i),Object.assign(r,d.getOption("executionContext")?n.getDELViewerSetting("wkiview_opts"):n.getLayout_options("wkiview_opts")),a.getComponentPromise("DELSlideView",r).then((function(t){I=t,e(o)})).fail((function(e){throw g.error("DELSlideView Component Initialization failed due to -",e),t(e),new Error(e)})))}))})).then(o).fail((function(e){g.error("WorkInstructionController::addSlidePanel - Unable to create views panel due to -",e)}))};g.debug("WorkInstructionController::show method invoked"),E().then((function(){return p.getStepViewJson(C(W.BUILDUPKEYS.PATHIDS))})).then((function(t){g.debug("WorkInstructionController::importStepView method invoked"),t.onModelLoadedCB=r;let n=a.getRoots();t.rootIds=[],e.is(n,"array")&&(t.rootIds=n.map((e=>u.getNodeID(e)))),S.importModel(t)})).catch((function(t){e.is(I)&&I.hide(),a.render(),g.error("WorkInstructionController::show unable to show the work instructions due to - ",t),w.publish(w.events.onWKIFailed,{error:t})}))},o=d.getOption("dynamicBuildUp"),r=d.getOption("enableNextGenWorkInstructions");if(!0===o&&!0===r&&s.isCloud()){let e=d.getOption("executionContext"),t=e&&e.getComponent?e.getComponent("PlaySnapShot"):null,n=!1;if(t&&t.OpenReview){let e=C(W.BUILDUPKEYS.PATHIDS),i=e&&e.length>0?e[e.length-1]:null;if(i&&t&&t.OpenReview)try{await E(),n=await t.OpenReview(i)}catch(e){n=!1,g.error("WorkInstructionController::show unable to show the Next Gen Work Instructions due to - ",e),w.publish(w.events.onWKIFailed,{error:e})}}else g.warn("Next Gen work instruction cannot be shown as PlaySnapShot component is not available, include the component in App package file");!1===n&&await i()}else await i()};w.subscribe(w.events.onGlobalBuildUpComplete,(function(){v()&&m()})),w.subscribe(w.events.onHighlightComplete,(function(e){e.highlight?f.highlightNode(e):f.unHighlightNode(e)}));let D={show:m,reset:function(){g.debug("WorkInstructionController::remove method invoked"),E().then((function(){return new e.Promise((function(t){e.is(I)&&(f.removeModel(),I.reset(),I=null),t()}))})).catch((function(e){g.error("WorkInstructionController::remove not able to remove work instructions due to - ",e)}))},highlightLinkedViews:function(n){return g.info("WorkInstructionController::highlightLinkedViews API invoked with parameters : ",n),n&&e.is(n.pid,"string")&&(n.pid=[n.pid]),new e.Promise((function(i,o){v()&&n?p.getLinkedViewUuids(C(W.BUILDUPKEYS.PATHIDS),n).then((function(n){var o;I?e.is(n,"array")&&n.length>0?((o=t.getSlidesDefinition({context:a.getContext()}).find((function(e){return n.indexOf(e.uuid)>-1})))&&o.uuid&&I.activateView({viewUUID:o.uuid}),I.highlightViews(n)):(I.unHighlightViews(n),I.selectActiveView()):g.debug("Work Instruction views are not available, unable to highlight View"),i()})).fail((function(e){g.error("WorkInstructionController::highlightLinkedViews not able to highlight views due to ",e),o(e)})):(g.error("WorkInstructionController :: WorkInstruction mode is not active"),o(d.getNLSValue("Error.WorkInstModeNotActive.Message")))}))},highlightWKIViews:function(n){return g.info("WorkInstructionController::highlightWKIViews API invoked with parameters : ",n),new e.Promise((function(i,o){if(v())if(e.is(n.viewUUIDs,"array")||e.is(n.viewIDs,"array")){if(I){let i=[];if(e.is(n.viewUUIDs,"array")?i=n.viewUUIDs:e.is(n.viewIDs,"array")&&n.viewIDs.forEach((function(e){let t=I.getUuidFromViewId(e);t&&i.push(t)})),i.length>0){if(!0===n.activateFirstView){let e,n;e=t.getSlidesDefinition({context:a.getContext()}),n=e.find((function(e){return i.indexOf(e.uuid)>-1})),n&&n.uuid&&I.activateView({viewUUID:n.uuid})}I.highlightViews(i)}else I.unHighlightViews(i)}else g.debug("Work Instruction views are not available, unable to highlight View");i()}else g.error("WorkInstructionController :: highlightWKIViews Invalid input paramters"),o(d.getNLSValue("Error.InvalidInput.Message"));else g.error("WorkInstructionController :: WorkInstruction mode is not active"),o(d.getNLSValue("Error.WorkInstModeNotActive.Message"))}))},getCurrentView:function(){return g.info("WorkInstructionController::getCurrentView API invoked"),new e.Promise((function(e,t){var n;I&&v()?(n=I.getActiveView())?e(n):(g.error("WorkInstructionController :: getCurrentView No active View ID found"),t(d.getNLSValue("Error.ActiveViewIDNotFound.Message"))):t(d.getNLSValue("Error.WorkInstModeNotActive.Message"))}))},setCurrentView:function(t){return g.info("WorkInstructionController::setCurrentView API invoked with parameters : ",t),new e.Promise((function(n,i){v()?t&&(e.is(t.viewUUID,"string")||e.is(t.viewID,"number"))?(I.activateView(t),n()):(g.error("WorkInstructionController :: setCurrentView Invalid input paramters"),i(d.getNLSValue("Error.InvalidInput.Message"))):(g.error("WorkInstructionController :: WorkInstruction mode is not active"),i(d.getNLSValue("Error.WorkInstModeNotActive.Message")))}))},clean:E,getCurrentViewInfo:async function(){return p.getViewInfo(await D.getCurrentView())},getCurrentBuildUpSettings:async function(){let e;try{let t=p.getViewInfo(await D.getCurrentView());t&&(e=t.BuildUpSettings)}catch(t){g.log(t),g.debug("Views are not available, global build up settings is shown"),e=c.getInstance("BuildUpBehaviorModelService").getBuildUpGlobalSettings()}return e},streamPathWithType:function(t,n,i){let o=f.getID(t);e.is(o)&&e.is(n,"array")&&e.is(i,"object")&&(n.push([o]),i[o]={type:W.WKIKEYS.DRESSUP})},destroy:function(){S&&S.destroy(),I&&I.destroy(),p&&p.destroy(),g=w=p=h=S=I=W=null,f.destroy()}};return D}}));