define("DS/SocialUserMention/Controls/AbstractAutocomplete",["UWA/Core","UWA/Promise","UWA/Json","UWA/Utils/Client","DS/WAFData/WAFData","DS/UIKIT/Autocomplete","DS/Logger/Logger"],(function(e,t,n,r,i,o,s){"use strict";var a="sm-autocomplete",l=o.extend({_areSuggestsVisible:!1,_lastRange:null,name:"autocomplete",defaultOptions:{swymUrl:"",tenantId:"",swymServerToken:null,boundingElement:null,userGroups:null,defaultClassName:"",editorElement:null,allowFreeInput:!0,noResultsMessage:!1,itemMultiSelect:!0,minLengthBeforeSearch:1,typeDelayBeforeSearch:300},_get3DSwymServerToken:function(){var r=this.options;return new t((function(t,o){var s=r.swymUrl;r.swymServerToken?t(r.swymServerToken):s?i.authenticatedRequest(s+"/api/index/tk",{method:"GET",onComplete:function(i){(i=e.is(i,"string")?n.decode(i):i)&&i.result&&i.result.ServerToken?(r.swymServerToken=i.result.ServerToken,t(i.result.ServerToken)):o("3DSwym server token is missing from server response")},onFailure:function(){o("Error retrieving 3DSwym server token")},onTimeout:function(){o("Time out while trying to retrieve 3DSwym server token")}}):o("3DSwym URL could not be found!")}))},_initSocialMentionDataSet:function(){throw new Error("This method is supposed to be overridden!")},_positionComponent:function(e,t){var n=this.elements&&this.elements.container;n&&(n.style.setProperty("top",e+"px","important"),n.style.setProperty("left",t+"px","important"))},_getBoundingClientRect:function(e){var t=e.getBoundingClientRect();return r.Features.touchEvents&&0===t.top&&0===t.right&&0===t.bottom&&0===t.left&&(t=e.getClientRects()[0]),t},init:function(){if(this._parent.apply(this,arguments),!this.options.editorElement)throw new Error("Editor element is missing");this._initSocialMentionDataSet()},propagateKeyboardEventToInput:function(t){var n=null,i=t.type,o=this.elements&&this.elements.input;if(!t)throw new Error("The event to propagate is missing!");if(!o)throw new Error("Autocomplete input element is missing!");r.Engine.ie||!window.KeyboardEvent||r.Features.touchEvents?"function"==typeof document.createEvent&&((n=document.createEvent("KeyboardEvent")).initKeyEvent?function(t,n,r){t.initKeyEvent(n,!0,!0,window,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,e.is(r.keyCode)?r.keyCode:r.key||r.which,r.charCode)}(n,i,t):n.initKeyboardEvent(i,!0,!0,window,t.key,t.location,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.keyCode,t.charCode)):n=new KeyboardEvent(i,{bubbles:!0,cancelable:!0,view:window,key:t.key,code:t.code,ctrlKey:t.ctrlKey,altKey:t.altKey,shiftKey:t.shiftKey,metaKey:t.metaKey,which:e.is(t.which)?t.which:t.keyCode,charCode:t.charCode,keyCode:t.keyCode,isComposing:t.isComposing,repeat:t.repeat,location:t.location}),n?(r.Engine.webkit&&function(e,t){Object.defineProperty(e,"keyCode",{get:function(){return this.customKeyCode}}),Object.defineProperty(e,"which",{get:function(){return this.customKeyCode}}),e.customKeyCode=t}(n,t.keyCode),o.dispatchEvent(n)):s.error("Failed to link the editor to autocomplete component")},buildSkeleton:function(){var t=this._parent.apply(this,arguments),n=this.getOption("defaultClassName");if(!this.elements.container)throw new Error("Autocomplete container cannot be found");if(!this.options.editorElement.parentElement)throw new Error("Editable element has no parent");return n||(n=""),this.elements.container.addClassName((n?n+" ":"")+a),this.elements.userAutocompleteWrapper=e.createElement("div",{class:(n?n+"-wrapper ":"")+a+"-wrapper"}),this.inject(this.elements.userAutocompleteWrapper),this.elements.userAutocompleteWrapper.inject(this.options.containerElement||this.options.editorElement.parentElement),t},areSuggestsVisible:function(){return this._areSuggestsVisible},displayContextually:function(t){if(this.elements&&this.elements.suggestsContainer){var n=null,i=null,o=this.elements.userAutocompleteWrapper.parentElement;if(o){e.extendElement(o),e.extendElement(document.body),t?this._lastRange=t:t=this._lastRange,this.options.boundingElement&&(n=e.extendElement(this.options.boundingElement),i=this._getBoundingClientRect(n));var a,l,u,c,p,m,h,d,g,f=!1,y=document.body.getSize(),S=n?i.bottom:y.height,b=n?i.right:y.width,w=this.elements.suggestsContainer.getSize(),v=w.width,C=w.height;if(v&&C||(this.show(),f=!0,v=(w=this.elements.suggestsContainer.getSize()).width,C=w.height),g=C+10,!(u=this._getBoundingClientRect(t)))return void s.error("Range bounding element rectangle could not be computed!");p=u.top,m=u.bottom,h=u.left,d=u.right,c=this._getBoundingClientRect(o),a=u.top-c.top,l=u.left-c.left,a=r.Features.touchEvents?p>g?p-c.top-g:a+u.height+10:S-m>C?a+u.height+10:p>g?p-c.top-g:a+u.height+10,b-d>v||(l=h+v>b?b-v-c.left:0),this._positionComponent(a,l),!0!==f&&this.show()}}},onShowSuggests:function(){this._areSuggestsVisible=!0;var e=this._parent.apply(this,arguments);return this.displayContextually(),e},onHideSuggests:function(){return this._areSuggestsVisible=!1,this._parent.apply(this,arguments)},onHide:function(){return this._areSuggestsVisible=!1,this._parent.apply(this,arguments)},destroy:function(){return this._areSuggestsVisible=!1,this._parent.apply(this,arguments)}});return l.DEFAULT_CLASSNAME=a,l})),define("DS/SocialUserMention/Utils/Generic",["UWA/Core"],(function(e){"use strict";var t={throttle:function(t,n,r){if("function"==typeof t)return i=null,o=null,s=!1,a=!0,l=n||30,u=r?e.clone(r,!1):{},c=function(){for(;!0===a;)a=!1,t.apply(o,i);"function"==typeof u.after&&u.after.apply(o,i),s=!1},function(){a=!0,o=this,i=arguments,!1===s&&(s=!0,"function"==typeof u.before&&u.before.apply(o,i),setTimeout(c,l))};throw new Error("First argument is supposed to be a function");var i,o,s,a,l,u,c}};return t})),define("DS/SocialUserMention/AbstractSocialMention",["UWA/Core","UWA/Event","UWA/String","UWA/Promise","UWA/Utils","UWA/Utils/Client","UWA/Class/Events","UWA/Class/Listener","DS/SocialUserMention/Utils/Generic","DS/Logger/Logger","css!DS/UIKIT/UIKIT","css!DS/SocialUserMention/SocialUserMention"],(function(e,t,n,r,i,o,s,a,l,u){"use strict";var c="\\s|\\u200B|&#8203;",p="["+["!","?","$","^","*","+","|","\\","/",":",",","=","[","]","{","}","(",")"].map((function(e){return"\\"+e})).join("")+"]",m=c+"|$|"+p,h=c+"|"+("^|$|"+p),d=new RegExp("("+p+")"),g=new RegExp(m),f=new RegExp("^("+h+")$"),y={};var S=a.extend(s,{_autocompleteClass:null,_attributeForStoringAutocompleteId:null,_triggerCharacter:null,_appendTriggerCharacterToMention:!0,_queryMatcher:null,_removeEndingSlash:function(t){return e.is(t,"string")&&t.length>0&&"/"===t.charAt(t.length-1)?t.slice(0,t.length-1):t},_get3DSwymUrl:function(e){var t=this;return new r((function(n,r){var i=e["3DSwymUrl"];i?n(i):require(["DS/i3DXCompassServices/i3DXCompassServices"],(function(o){o.getPlatformServices({onComplete:function(o){var s=e.tenantId;Array.isArray(o)&&o.forEach((function(e){e.platformId===s&&(i=t._removeEndingSlash(e["3DSwym"]))})),i?n(i):r("There is no 3DSwym instance on this tenant")},onFailure:function(){r("Error calling MyApps. Please make sure the TopFrame is correctly configured.")}})}))}))},_getMailIDTriggerIndex:function(e,t){let n=-1,r=e.substring(0,t).lastIndexOf(this._triggerCharacter),i=e.substring(0,r-1).lastIndexOf(this._triggerCharacter);if(-1!==i){let r;r=e.substring(i,t);let o=r.search(g);-1!==o&&o+i!==t||(n=i)}return n},_handleAutoCompleteDisplay:function(){var e,t,n,r=null,i=0,o=null,s=null,a="",l=null,c=-1,p=!1;if(0!==(e=window.getSelection()).rangeCount){if(n=(t=e.getRangeAt(0))&&t.cloneRange(),"P"===e.anchorNode.nodeName){let e=n&&n.startContainer&&n.startContainer.firstChild;if(e&&"#text"===e.nodeName){let t=document.createRange();t.selectNodeContents(e),t.setStart(e,e.length),n=t}}if(n&&n.collapsed){if(i=n.endOffset,s=n.endContainer,l=s.nodeValue){const e=this._getMailIDTriggerIndex(l,i);c=-1!==e?e:l.substring(0,i).lastIndexOf(this._triggerCharacter)}if(-1!==c){if(l&&c<i)if(c+1===i)(r=l.substring(c,l.length).match(this._queryMatcher))&&"string"==typeof r[1]?a=r[1]:c=-1;else{if((o=i+l.substring(i).search(g))<i)throw new Error("Can't find the end of the word. This was not supposed to happen.");(r=l.substring(c+1,o).match(d))&&"string"==typeof r[1]?c=-1:(a=l.substring(c+1,o).split(/\s+/).slice(0,6).join(" "),i>c+a.length+1&&(c=-1))}-1!==c&&(0===c||(c>=1?(m=l[c-1].match(f))&&"string"==typeof m[1]:(u.error("Position of trigger-character is incorrect"),0))&&(c+1===i||l&&l[c+1].match(/^\S$/)))&&(p=!0)}}var m;return!0===p?(n.setStart(s,c+1),n.setEnd(s,c+1),{unalteredQuery:a,query:a.replace(/(\u200B|&#8203;)/g,""),container:s,triggerCharIndex:c,cursorIndex:i,range:n}):null}u.warn("Can't display list. There is no selection!")},getMention:function(t){var r,i,o,s="";if(!(t&&t.object&&t.object.value&&t.object.label))throw new Error("Required information are missing");if(o=t.linksExtraAttributes,i=(!1===this._appendTriggerCharacterToMention?"":this._triggerCharacter)+n.escapeHTML(t.object.label),!1===t.stringFormat)return(r=document.createDocumentFragment()).appendChild(e.createElement("a",e.merge({contenteditable:"false",html:i},t.linksExtraAttributes))),r.appendChild(document.createTextNode(!1===t.includeNonBreakableSpace?"":" ")),r;if(e.is(o,"object"))for(var a in o)o.hasOwnProperty(a)&&(s+=" "+a+'="'+o[a]+'"');return"<a"+s+' contenteditable="false">'+i+"</a>"+(!1===t.includeNonBreakableSpace?"":" ")},enableFeature:function(n){var r,o,s,a,c=this,p=null,m=null;if(!n||!n.editableElement||(s=e.extendElement(n.editableElement).getAttribute("contenteditable"))&&"true"!==s&&""!==s)throw new Error("An editable element is required");if(!n["3DSwymUrl"]&&!n.tenantId)throw new Error("Tenant (online instance) ID is required.");if(!this._autocompleteClass)throw new Error("Autocomplete class is missing!");if(!this._attributeForStoringAutocompleteId)throw new Error("Attribute for storing autocomplete ID is missing!");if(!this._triggerCharacter)throw new Error("The character supposed to trigger the display of suggestions is missing!");this._queryMatcher||(this._queryMatcher=new RegExp("^"+this._triggerCharacter+"(.*?)(?="+h+")")),r=n.editableElement,o=n.containerElement,a={keydown:l.throttle((function(e){p&&p.propagateKeyboardEventToInput(e)}),200),keyup:l.throttle((function(e){var n,i;if(p){switch(i=t.whichKey(e)){case"left":case"right":case"home":case"end":return}(n=p.elements&&p.elements.input)&&("del"!==i&&"backspace"!==i&&r.normalize(),(m=c._handleAutoCompleteDisplay())?(n.value=m.query.trim(),p.displayContextually(m.range),p.propagateKeyboardEventToInput(e)):(n.value="",p.hide()))}}),200),keypress:l.throttle((function(e){p&&p.propagateKeyboardEventToInput(e)}),200)},c.listenTo(n.editableElement,{keydown:function(e){switch(t.whichKey(e)){case"return":case"up":case"down":if(!p||!p.areSuggestsVisible())return;t.stopPropagation(e),t.preventDefault(e),e.stopImmediatePropagation()}a.keydown.apply(this,arguments)},keyup:function(e){switch(t.whichKey(e)){case"return":case"up":case"down":if(!p||!p.areSuggestsVisible())return;t.stopPropagation(e),t.preventDefault(e),e.stopImmediatePropagation(),p.propagateKeyboardEventToInput(e);break;default:a.keyup.apply(this,arguments)}},keypress:function(e){a.keypress.apply(this,arguments)}},1e3),c._get3DSwymUrl(n).then((function(t){if(!r[c._attributeForStoringAutocompleteId]){var s=i.getUUID();y[s]=p=new c._autocompleteClass(e.merge({editorElement:r,containerElement:o,tenantId:n.tenantId,swymUrl:t,swymServerToken:n["3DSwymServerToken"],boundingElement:n.boundingElement,events:{onSelect:function(t){var i,o,s,a;if(!m)throw new Error("Something went wrong...");s=m.container.parentElement||m.container.parentNode,o=m.container.nodeValue,a=m.triggerCharIndex+m.unalteredQuery.length+1===o.length,m.container.nodeValue=o.substring(0,m.triggerCharIndex)+o.substring(m.triggerCharIndex+m.unalteredQuery.length+1,o.length),i=m.container.splitText(m.triggerCharIndex),s.insertBefore(c.getMention({object:t,linksExtraAttributes:n.linksExtraAttributes,stringFormat:!1,includeNonBreakableSpace:a}),i),"function"==typeof(r&&r.focus)&&r.getChildren()[0].focus(),setTimeout((function(){!function(t,n){try{var r=document.createRange(),i=document.getSelection();t&&(e.is(n,"number")||(n=t.nodeValue.length),r.setStart(t,n),r.collapse(!0),i.removeAllRanges(),i.addRange(r))}catch(e){}}(i,0),e.is(n.events&&n.events.onInsert,"function")&&n.events.onInsert({cursorPosition:{node:i,offset:0}})}),0),m=null}}},n.autocompleteOptions)),r[c._attributeForStoringAutocompleteId]=s}}),(function(e){u.error(e)}))},disableFeature:function(e){var t;if(!e||!e.editableElement)throw new Error("An HTML element is required");this.stopListening(e.editableElement),(t=e.editableElement[this._attributeForStoringAutocompleteId]&&y[e.editableElement[this._attributeForStoringAutocompleteId]])&&(t.destroy(),e.editableElement[this._attributeForStoringAutocompleteId]=null)},resetCache(t){if(t&&e.is(t,"string")){const e=y[t];e&&e.datasets&&e.resetCache&&e.resetCache()}else Object.values(y).forEach((e=>{e.datasets&&e.resetCache&&e.resetCache()}))}});return S})),define("DS/SocialUserMention/Controls/UserAutocomplete",["UWA/Core","UWA/Json","UWA/Promise","UWA/Array","DS/WAFData/WAFData","DS/UWPClientCode/I18n","DS/SocialUserMention/Controls/AbstractAutocomplete","DS/Logger/Logger"],(function(e,t,n,r,i,o,s,a){"use strict";return s.extend({defaultOptions:{defaultClassName:"sum-user-autocomplete",fedSearchUrl:"",currentUserInfo:null},_isUsersGroupServiceAvailable:function(){var e=this;return new n((function(t){require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(n){n.getServiceUrl({serviceName:"usersgroup",platformId:e.options.tenantId,onComplete:function(e){t("string"==typeof e&&""!==e)},onFailure:function(){t(!1)}})}),(function(){t(!1)}))}))},_initSocialMentionDataSet:function(){var r=this;this.addDataset({name:"Users",items:[],searchUrl:this.options.fedSearchUrl+"/search",remoteSearchEngine:function(r,s){var a=this;return this._isUsersGroupServiceAvailable().then((function(l){return new n((function(n,u){var c,p=a.options.userGroups&&a.options.userGroups["3DSwymCommunity"];r.searchUrl&&(c={start:0,nresults:20,tenant:a.options.tenantId,source:["swym"].concat(!0===l?["usersgroup"]:[]),specific_source_parameter:{usersgroup:{additional_query:"AND [ds6w:label]:("+s.trim()+"*)"},swym:{additional_query:" AND personOrGroup:("+s+")"}},select_predicate:["ds6w:label","ds6w:type"],label:"SocialUserMention-"+a.options.currentUserInfo.userLogin+"-"+(new Date).getTime(),query:'[ds6w:type]:("foaf:Group" OR "pno:Person")',with_synthesis:!1,with_synthesis_attribute:!1,locale:o.getCurrentLanguage()},p&&(c.community_id=p),i.authenticatedRequest(r.searchUrl,{method:"POST",type:"json",proxy:"passport",headers:{"Content-Type":"application/json;charset=utf-8"},data:t.encode(c),onComplete:function(t){var i={matchingItems:[]};t&&(i.matchingItems=e.is(r.dataParser,"function")?r.dataParser.call(a,r,t):a.defaultDataParser(t)),i.dataset=r,n(i)},onFailure:function(e){e.type="error",e.dataset=r,u(e)},onTimeout:function(e){e.type="timeout",e.dataset=r,u(e)}}))}))}))},dataParser:function(e,t){return Array.isArray(t&&t.results)?t.results.reduce((function(e,t){var n=!1,r=!1,i=t.attributes.reduce((function(e,t){switch(t.name){case"ds6w:label":n=!0,t.value||(r=!0),e.label=t.value;break;case"resourceid":e.value=t.value;break;case"ds6w:type":case"ds6w:what/ds6w:type":"foaf:Group"===t.value&&(e.memberType="usersgroup")}return e}),{memberType:"user"});return n&&!r&&("user"===i.memberType&&(i.value=i.value.replace("iam:","")),e.push(i)),e}),[]):[]}},{templateEngine:function(t,n,i){var o;t.addClassName("user-template"),(o=e.createElement("span",{class:"item-label"})).setText(i.label),t.setContent(["user"===i.memberType?e.createElement("img",{src:r.getOption("swymUrl")+"/api/user/getpicture/login/"+i.value+"/format/mini"}):e.createElement("span",{class:"fonticon fonticon-users-group"}),o])},onError:function(){r.hide()},onTimeout:function(){r.hide()}})}})})),define("DS/SocialUserMention/SocialUserMention",["UWA/Core","UWA/Promise","DS/SocialUserMention/AbstractSocialMention","DS/SocialUserMention/Controls/UserAutocomplete","DS/Logger/Logger"],(function(e,t,n,r,i){"use strict";var o=n.singleton({_triggerCharacter:"@",_autocompleteClass:r,_attributeForStoringAutocompleteId:"_socialUserMentionAutocompleteId",_getFedSearchUrl:function(e){return new t((function(t,n){require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(r){r.getServiceUrl({serviceName:"3DSearch",platformId:e.tenantId,onComplete:function(e){e&&"string"==typeof e?t(e):n("Couldn't find 3DSearch instance on this tenant")},onFailure:function(){n("Error calling MyApps. Please make sure the TopFrame is correctly configured.")}})}))}))},_getUserInfo:function(e){return new t((function(t,n){e.userLogin&&e.userName?t({userLogin:e.userLogin,userName:e.userName}):require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(r){try{r.getUser({platformId:e.tenantId,onComplete:function(e){t({userLogin:e.id,userName:e.firstname+" "+e.lastname,userIsAdmin:e.admin})},onFailure:function(){n("Error retrieving user information. Please make sure that the TopFrame is correctly configured and that 3DCompass is up and running.")}})}catch(e){n("Error trying to call 3DCompass: "+e.message)}}))}))},getMention:function(t){var n=t?e.clone(t,!1):{},r={class:"sum-user-link sm-link"};return n.object&&(r["usersgroup"===n.object.memberType?"data-users-group-uri":"data-login"]=n.object.value),n.linksExtraAttributes=e.merge(r,"function"==typeof n.linksExtraAttributes?n.linksExtraAttributes.call(null,n.object):n.linksExtraAttributes),this._parent.call(this,n)},enableFeature:function(n){var r=void 0,i=this._parent,o=this;n?(r=e.clone(n,!1)).autocompleteOptions={userGroups:n.userGroups}:r={autocompleteOptions:{}},t.all([this._getFedSearchUrl(n),this._getUserInfo(n)]).then((function(e){r.autocompleteOptions.fedSearchUrl=e[0],r.autocompleteOptions.currentUserInfo=e[1],i.call(o,r)}))},disableFeature:function(){return this._parent.apply(this,arguments)}});return o}));