define("DS/ENOCharacteristicsApp/ENOCharacteristicsApp",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/XSRCommonComponents/utils/RequestUtil","DS/ENOCharacteristicsApp/CharacteristicsGridView/CharacteristicsGridView","DS/ENOCharacteristicsApp/controls/CharacteristicsControl","DS/ENOCharacteristicsApp/service/CharacteristicsServiceWrapper","DS/ENOCharacteristicsApp/utils/Constants","DS/ENOCharacteristicsApp/utils/CharacteristicsEvents","DS/ENOCharacteristicsApp/utils/CharacteristicsUtils","DS/XSRCommonComponents/utils/XSRMask","DS/SpecGridView/utils/GridUtil","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/TypeUtils","DS/PlatformAPI/PlatformAPI","DS/Windows/Dialog","DS/Controls/Button","text!DS/ENOCharacteristicsApp/assets/config/CharacteristicsColumnConfig.json","text!DS/ENOCharacteristicsApp/assets/config/CharacteristicsToolBarCommands.json","i18n!DS/ENOCharacteristicsApp/assets/nls/ENOCharacteristicsApp","css!DS/ENOCharacteristicsApp/ENOCharacteristicsApp.css"],(function(e,t,r,i,s,a,n,o,c,l,d,p,u,h,m,C,f,g,E,S){"use strict";return r.extend({init:function(e){var t=e;this.itemId=t.itemId,this.appCore=e.appCore,this.specModel=e.specModel,this.currentTabKey=e.currentTabKey,this.currentView=widget.getValue(o.VIEW_PERSISTANCE_KEY),this.currentView||(this.currentView=o.TOOLBAR_VIEW_REVISED);var r=t.specModel;r&&(this.itemTitle=r._options.title,this.accessOnItem=r._options.currentAccess,this.itemMaturity=r._options.maturity),this.container=t.container,e.appCore&&e.appCore.WorkUnderContext&&(i.workUnderIsSet=!0,i.setWorkUnderHeaders(e.appCore.WorkUnderContext.getWorkUnderHeaders())),this.modelEvents=new c,this.appCore.perfSpecAsPlugin&&!this.appCore.specViewerModelEvents&&(this.appCore.specViewerModelEvents=this.appCore.basicModelEvents),this._characteristicsColumns=JSON.parse(g),this._charSubscriptionList=[],this.appCoreSubList=[],this.specViewerEventList=[];var s={modelEvents:this.modelEvents,appCore:this.appCore};this.service=new n(s),this.setPreReqConfigs(),this._subscribeEvents()},_subscribeEvents:function(){var e=this;e.platformSubs=[],e._charSubscriptionList.push(e.modelEvents.subscribe({event:o.CHARACTERISTICS_GRID_TOTAL_SELECTED_NODES},(function(t){e.selectedGridCount=t.count,e.selectedGridNodes=t.currentModel,e.setToolbarCommandsState(t)}))),e._charSubscriptionList.push(e.appCore.basicModelEvents.subscribe({event:o.EVENT_LAUNCH_PREV_NEXT_COMMAND},(function(t){e.evt_LanchPrevNextCommand(t)}))),e._charSubscriptionList.push(e.modelEvents.subscribe({event:"chargrid-delete-node-successfull-characterstics"},(function(t){e.charGrid.removeRootNodes(t)}))),e.appCoreSubList.push(e.appCore.basicModelEvents.subscribe({event:o.EVENT_CREATE_PERF_CHAR},(t=>{t.select(),e.charControl.launchCreateForm({isSpecificationLimitsDisabled:e.appCore.isSpecificationLimitsDisabled,isRoutineReleaseLimitsDisabled:e.appCore.isRoutineReleaseLimitsDisabled,charContainer:e._charContainer},o.CHARACTERISTICS_CREATE)})),e.appCore.basicModelEvents.subscribe({event:"refresh-spec-viewer-or-grid"},(()=>{e.appCore&&e.appCore.WorkUnderContext&&(i.workUnderIsSet=!0,i.setWorkUnderHeaders(e.appCore.WorkUnderContext.getWorkUnderHeaders()))})),e.appCore.basicModelEvents.subscribe({event:"test-methods-floating-panel"},(t=>{e.charControl.testMethodsDialog({selectedNodes:e.selectedGridNodes,appCore:e.appCore}),console.log(t)}))),e.specViewerEventList.push(e.appCore.specViewerModelEvents.subscribe({event:o.TRIGGER_DELETE_SPEC_CHAR},(t=>{e.dataGrid.getTreeDocument().unselectAll(),t[0].select();var r={};r.parentId=e.itemId,r.modelEvents=e.modelEvents,r.container=e.container,e.charControl.deleteCharNodes(r)}))),e._charSubscriptionList.push(e.modelEvents.subscribe({event:"grid-toolbar-action-click-characterstics"},(function(t){let r={itemId:e.itemId};var i={};i.parentId=e.itemId,i.charContainer=e._charContainer,i.container=e.container;var s={};s.parentId=e.itemId,s.modelEvents=e.modelEvents,s.container=e.container;var a={};if(a.selectedGridCount=e.selectedGridCount,a.selectedGridNodes=e.selectedGridNodes,t)switch(t){case"CreateSpecification":e.charControl.launchCreateForm(i,t);break;case"CreateCharacteristics":i.isSpecificationLimitsDisabled=e.appCore.isSpecificationLimitsDisabled,i.isRoutineReleaseLimitsDisabled=e.appCore.isRoutineReleaseLimitsDisabled,e.charControl.launchCreateForm(i,t);break;case"DeleteCharacteristics":e.charControl.deleteCharNodes(s);break;case"Export":e.charControl.exportGrid();break;case"Personalize":e.charControl.personalize();break;case o.CMD_MATURITY:e.charControl.maturityStateControl(e.selectedGridNodes);break;case o.CMD_REVISION:e.charControl.revisionControl(e.selectedGridNodes);break;case o.TOOLBAR_VIEW_RELEASED:case o.TOOLBAR_VIEW_REVISED:case o.TOOLBAR_VIEW_ALL:e.currentView=widget.getValue("performanceSpecView"),e.toggleView();break;case"AssignTestMethod":let a=e.verifySelectedNodes(e.selectedGridNodes,t);if(a.message){var n=new C({immersiveFrame:e.appCore.immersiveFrame,title:S.label_AssignTestMethod,content:a.message,activeFlag:!0,buttons:{Cancel:new f({onClick:function(e){n.close()}}),Ok:new f({onClick:function(t){n.close(),a.proceed&&e.charControl.assignTestMethod(r)}})}});a.proceed||n.buttons.Cancel.hide()}else e.charControl.assignTestMethod(r);break;case"LinkRequirement":let c=e.verifySelectedNodes(e.selectedGridNodes,t);if(c.message){n=new C({immersiveFrame:e.appCore.immersiveFrame,title:S.label_LinkRequirement,content:c.message,activeFlag:!0,buttons:{Cancel:new f({onClick:function(e){n.close()}}),Ok:new f({onClick:function(t){n.close(),c.proceed&&e.charControl.linkRequirement(r)}})}});c.proceed||n.buttons.Cancel.hide()}else e.charControl.linkRequirement(r);break;case"DuplicateCharacteristics":e.charControl.duplicateCharNodes(e.selectedGridNodes);break;case"PerfSpec_Information_Panel":e.charControl.informationDialog(e.selectedGridNodes);break;case"SyncPerformanceSpecs":e.charControl.syncPerformanceSpecs(e.itemId);break;case"AddExtensions":e.charControl.addExtensions(e.itemId)}}))),e.platformMaturity=m.subscribe("DS/PADUtils/PADCommandProxy/refresh",(t=>e.evt_PostMaturityUpdate(t))),e.platformLifecycle=m.subscribe("Lifecycle.Modification",(t=>e.evt_PostLifecycleUpdate(t))),e.platformSubs.push(this.platformMaturity,this.platformLifecycle)},verifySelectedNodes:function(e,t){let r=null,i=!0;for(let s=0;s<e.length;s++){let a=e[s],n=h.isPerformanceSpecification(a.getTypeActualName());if(n&&!a.getChildren()){"AssignTestMethod"==t&&(r=S.Message_AssignTestMethod_NoPerformanceChar),"LinkRequirement"==t&&(r=S.Message_AssignTestMethod_NoPerformanceChar),i=!1;break}let o=n&&a.isInWork(),c=!n&&a.getParent().isInWork();if(!(o||c)){"AssignTestMethod"==t&&(r=S.Message_AssignTestMethod_NotInWork),"LinkRequirement"==t&&(r=S.Message_LinkRequirement_NotInWork),i=!1;break}n&&("AssignTestMethod"==t&&(r=S.Message_AssignTestMethod_SpecSelection),"LinkRequirement"==t&&(r=S.Message_LinkRequirement_SpecSelection))}return r?{message:r,proceed:i}:""},render:function(){this.initializeCharGrid()},initializeCharGrid:function(){var t=this;t._charContainer=e.createElement("div",{class:"datagrid-char-container"}),t._charContainer.inject(t.container);var r={appCore:this.appCore,currentTabKey:this.currentTabKey,itemId:this.itemId,enableInteractiveRightPanel:!0,enableCrossWidgetFeature:!0,itemId:this.itemId,itemTitle:this.itemTitle,container:t._charContainer,modelEvents:this.modelEvents,parentModel:this.specModel};this.charGrid=new s(r)},loadAllDimensionDisplayUnits:function(){var e=this;return new t((function(t,r){e.service.getDimensionDisplayUnitSet().then((function(e){l.allDimensionSet=JSON.parse(e),l.processDimensionDisplayUnit(),t()})).catch((function(e){var t=S.Message_ErrorFetchAllDimension;r(t)}))}))},loadParameterTemplatesAndArbitraryUnits:function(){let e=this;return new t(((t,r)=>{e.service.getParameterTemplatesAndArbitraryUnits().then((function(r){console.log(r),l.processTemplatesAndArbitraryUnits(r),e.appCore.parameterTemplates=l.parameterTemplates,e.appCore.arbitraryUnits=l.arbitraryUnits,t()})).catch((function(e){var t=S.Message_ErrorFetchAllDimension;r(t)}))}))},getAdminConfig:function(){var e=this;return new t((function(t,r){e.service.getMeasurementCharacteristicLimitsConfiguration().then((function(r){e.appCore.isRoutineReleaseLimitsDisabled=r.isRoutineReleaseLimitsDisabled,e.appCore.isSpecificationLimitsDisabled=r.isSpecificationLimitsDisabled,t()}),r)}))},initTypeList:function(){var e=this,r=[],i=[],s={};return new t((function(t,a){e.service.getType().then((function(e){var a=e;if(Object.keys(a).length>0){var n=a;Object.keys(a).forEach((function(e){r.push({labelItem:n[e],valueItem:e}),i.push(e),s[e]=n[e]}))}r.push({labelItem:S.type_PerformanceSpec,valueItem:o.TYPE_PERFORMANCE_SPEC}),s[o.TYPE_PERFORMANCE_SPEC]=S.type_PerformanceSpec,i.push("PerformanceSpec"),l.allTypeSet=r,l.allTypeList=i,l.allTypesMap=s,h.performanceSpec=i,t()}),a)}))},getCharacteristics:async function(e){var t=this;t.charGrid.setColumns(t._characteristicsColumns.columns.concat(e)),t.charGrid.render({withDefaultColumns:!1});let r=t.getToolbarCommands();t.charGrid.setToolBarActions({actions:r}),t.dataGrid=t.charGrid.gridManager.grid;let i={charGrid:t.charGrid,dataGrid:t.dataGrid,itemTitle:t.itemTitle,itemMaturity:t.itemMaturity,physicalPrdModel:t.specModel,modelEvents:t.modelEvents,specViewerModelEvents:t.appCore.specViewerModelEvents,appCore:t.appCore};t.charControl=new a(i);try{d.maskLoader(t.container,S.Loading);let e=(await t.service.getSpecData([t.itemId],!1)).listNodes;if(e&&e.length>0){d.isMasked(t.container)||d.maskLoader(t.container,S.Loading);let r=[];for(var s=0;s<e.length;s++){var n=e[s];n.appCore=t.appCore,r.push(n)}t.charGrid.addRootNodes(r,!1),t.charGrid.checkAndUpdatePersistency(),t.toggleView(),d.unmaskLoader(t.container)}t.setToolbarCommandsState({count:0}),d.unmaskLoader(t.container)}catch(e){console.log(e),console.log(e+S.Message_ErrorLoadCharacteristics),d.unmaskLoader(t.container)}},getToolbarCommands:function(){return JSON.parse(E).actions.filter((e=>!!widget.data.isPerfSpecDeployedAsFacet||"PerfSpec_Information_Panel"!==e.key&&"SyncPerformanceSpecs"!==e.key))},setPreReqConfigs:function(){var e=this,r=[],s=function(){var r=[];r.push(e.loadAllDimensionDisplayUnits()),r.push(e.loadParameterTemplatesAndArbitraryUnits()),r.push(e.initTypeList()),r.push(e.getAdminConfig()),t.all(r).then((async function(t){await e.getCharacteristics([])})).catch((function(t){console.log(t),console.error("Error in getting PreReqs for characteristics"),d.unmaskLoader(e.container)}))};i.getSecurityContext()?s():i.set3DSpaceURL().then((function(e){r.push(i.setSecurityContext()),r.push(i.setCSRFToken()),t.all(r).then((function(){s()})).catch((function(e){console.log(e),console.error("Error in getting PreReqs for characteristics")}))}))},setToolbarCommandsState:function(e){let t=this,r=[o.CMD_MATURITY,o.CMD_REVISION,o.CMD_DELETE,o.CMD_INFORMATION,o.CMD_DUPLICATE,o.CMD_ADDEXTENSIONS,o.CMD_ASSIGN_TEST_METHOD,o.CMD_LINK_REQUIREMENT],i=function(){if(e.count<=1)return!1;let t=null;return!e.currentModel.every((e=>null==t?(t=h.isPerformanceCharacteristics(e.getTypeActualName())?o.TYPE_PERFORMANCE_CHAR:e.getTypeActualName(),!0):h.isPerformanceCharacteristics(e.getTypeActualName())?t===o.TYPE_PERFORMANCE_CHAR:!(!h.isPerformanceSpecification(t)||!h.isPerformanceSpecification(e.getTypeActualName()))||t===e.getTypeActualName()))},s=function(){let t=[];for(let r=0;r<e.currentModel.length;r++){if(e.currentModel[r].getAttributeValue("isDerivedSpec")||!1){t.push(o.CMD_MATURITY,o.CMD_REVISION);break}}return t},a=function(){let r=!1,s=!1,a=!1,n=e.productMaturity?"IN_WORK"!=e.productMaturity:t.specModel.isBeyondInWork(),c=[],d=l.allTypeList.includes(e.currentModel[0].getTypeActualName()),p=0;return r=i(),r||(d?p=e.currentModel[0].getRevision():(a=function(){let t=null;return!e.currentModel.every((e=>null==t?(t=e.getParent().getID(),!0):t===e.getParent().getID()))}(),p=e.currentModel[0].getParent().getRevision())),s=0!==e.count&&!e.currentModel.every((e=>{let t=h.isPerformanceSpecification(e.getTypeActualName())&&e.isInWork(),r=h.isPerformanceCharacteristics(e.getTypeActualName())&&e.getParent().isInWork();return t||r})),(s||a||r||n&&(!d||1==p))&&c.push(o.CMD_DELETE,o.CMD_DUPLICATE),!r&&d&&c.push(o.CMD_DUPLICATE),(s||n)&&c.push(o.CMD_ADDEXTENSIONS),c};if(0===e.count)t.charGrid.toolbar.disableCommands(r);else if(e.count>1){let n=[o.CMD_INFORMATION,o.CMD_REVISION,o.CMD_ADDEXTENSIONS],c=a(),l=s();(i()||h.isPerformanceCharacteristics(e.currentModel[0].getTypeActualName()))&&n.push(o.CMD_MATURITY),c.includes(o.CMD_DELETE)&&n.push(o.CMD_DELETE),c.includes(o.CMD_DUPLICATE)&&n.push(o.CMD_DUPLICATE),l.length>0&&(n=[...n,...l]),t.charGrid.toolbar.enableCommands(r),t.charGrid.toolbar.disableCommands(n)}else{let i=[],n=a(),c=function(){let t=[];return h.isPerformanceCharacteristics(e.currentModel[0].getTypeActualName())&&t.push(o.CMD_INFORMATION,o.CMD_REVISION,o.CMD_MATURITY),h.isPerformanceSpecification(e.currentModel[0].getTypeActualName())&&t.push(o.CMD_DUPLICATE),t}(),l=function(){let t=[];return h.isPerformanceSpecification(e.currentModel[0].getTypeActualName())&&(e.currentModel[0].isInWork()||e.currentModel[0].isFrozen())&&t.push(o.CMD_REVISION),t}(),d=s();i=n.concat(c,l,d),i=new Set(i),i=Array.from(i),t.charGrid.toolbar.enableCommands(r),t.charGrid.toolbar.disableCommands(i)}},toggleView:function(){var e=this;let t=e.charGrid.model.getAllDescendants();const r=function(e){t.forEach((t=>{t&&t._canBeGrouped()&&h.isPerformanceSpecification(t.getTypeActualName())&&t.isObsolete()&&(e?t.show():t.hide())}))};e.currentView===o.TOOLBAR_VIEW_RELEASED?(t.forEach((e=>{e&&e._canBeGrouped()&&h.isPerformanceSpecification(e.getTypeActualName())?e.isReleased()?e.show():e.hide():e&&e._canBeGrouped()&&h.isPerformanceCharacteristics(e.getTypeActualName())&&(e.getParent().isReleased()?e.show():e.hide())})),r(!1)):e.currentView===o.TOOLBAR_VIEW_REVISED?(t.forEach((e=>{e&&e._canBeGrouped()&&h.isPerformanceSpecification(e.getTypeActualName())?e.isLastRevision()?e.show():e.hide():e&&e._canBeGrouped()&&h.isPerformanceCharacteristics(e.getTypeActualName())&&(e.getParent().isLastRevision()?e.show():e.hide())})),r(!1)):e.currentView===o.TOOLBAR_VIEW_ALL&&t.forEach((e=>{(e&&e._canBeGrouped&&h.isPerformanceSpecification(e.getTypeActualName())||e&&e._canBeGrouped()&&h.isPerformanceCharacteristics(e.getTypeActualName()))&&e.show()}))},evt_PostMaturityUpdate:function(e){var t=this;if(e.data.authored&&e.data.authored.modified){let i=e.data.authored.modified,s=new Map,a=t.charGrid.model.getAllDescendants();var r=[];for(let e=0;e<a.length;e++){let t=a[e].getAttributeValue(["ds6w:type_value"]);l.allTypeList.includes(t)&&r.push(a[e])}r.forEach((e=>{i.includes(e.getID())&&s.set(e.getID(),e)})),i.forEach((function(e){t.service.getSpecDataById(t.itemId,e,!1).then((r=>{let i=[];i.push(o.CMD_ADDEXTENSIONS),i.push(o.CMD_DELETE);var a=r.current;t.itemId==e&&(t.setToolbarCommandsState({count:t.selectedGridCount,currentModel:t.selectedGridNodes,productMaturity:a}),"IN_WORK"!==a?t.charGrid.toolbar.disableCommands(i):t.charGrid.toolbar.enableCommands(i));let n=s.get(e);void 0!==n&&(n.syncModel(r),"IN_WORK"!=n.getMaturityActualName()?t.charGrid.toolbar.disableCommands(i):t.charGrid.toolbar.enableCommands(i)),t.dataGrid.updateView({updateCellContent:!0,updateCellLayout:!1,updateCellAttributes:!1})})).catch((e=>console.log(e))).finally((()=>{console.log("Maturity updated."),t.dataGrid.getTreeDocument().acceptChanges(),t.toggleView()}))}))}},evt_PostLifecycleUpdate:function(e){let t=this;if(e&&"string"==typeof e&&(e=JSON.parse(e)),e.Refresh){let n=t.dataGrid.getTreeDocument().getSelectedNodes()[0];if(e.Refresh.created&&e.Refresh.created.length>0&&e.Refresh.created[0].sourceObjectId===n.getID()){var r=e.Refresh.created;Array.isArray(r)||(r=Array.from(r)),r.forEach((e=>{t.service.getSpecDataById(t.itemId,e.physicalid,!0).then((e=>{t.modelEvents.publish({event:"specification-created",data:{specRowData:e}})})).catch((e=>console.log(e))),t.service.getSpecDataById(t.itemId,e.sourceObjectId,!0).then((e=>{n.syncModel(e),t.toggleView()})).catch((e=>console.log(e)))}))}else if(e.Refresh.deleted&&e.Refresh.deleted.length>0)console.log("Deleted from lifecycle");else if(e.Refresh.modified&&e.Refresh.modified.length>0){var i="",s="";if(o.MATURITY_RELEASED==e.Refresh.modified[0].state){let r=t.charGrid.model.getAllDescendants();var a=[];for(let e=0;e<r.length;e++){let t=r[e].getAttributeValue(["ds6w:type_value"]);l.allTypeList.includes(t)&&a.push(r[e])}a.forEach((t=>{e.Refresh.modified[0].physicalid==t.getNextRevisionID()&&o.MATURITY_RELEASED==t.getMaturityActualName()&&(i=t,s=t.getPhysicalId())})),t.charGrid.toolbar.enableCommands([o.CMD_REVISION])}i&&o.MATURITY_RELEASED==i.getMaturityActualName()&&t.service.getSpecDataById(t.itemId,s,!0).then((e=>{i.syncModel(e),t.toggleView()})),console.log("modified from lifecycle")}}},evt_LanchPrevNextCommand:function(e){var t=this,r=e.move,i=e.itemId,s=t.selectedGridNodes,a=t.selectedGridCount;if(s&&!s||!(a<=0||a>1)?(s=Array.isArray(s)?s[0]:s)&&s.getID()!==i&&(s=(new p).getModelById(i,t.dataGrid)):s=(new p).getModelById(i,t.dataGrid),s&&s.getID()===i){var n=u.getValidPreviousorNextNode(s,r);n&&(t.charGrid.unselectAll(),t.gridViewInstance=t.charGrid.getGridViewInstance(),t.gridViewInstance&&t.gridViewInstance.ensureNodeModelVisible(n),n.select())}},destroy:function(){var e=this;console.log("Performance Specification destroyed"),e._charContainer&&e._charContainer.destroy(),e.charGrid&&e.charGrid.destroy(),this._charSubscriptionList&&(this.modelEvents.unsubscribeList(this._charSubscriptionList),this.appCore.specViewerModelEvents.unsubscribeList(this.specViewerEventList),this.appCore.basicModelEvents.unsubscribeList(this.appCoreSubList)),this.platformSubs&&this.platformSubs.length>0&&this.platformSubs.forEach((function(e){m.unsubscribe(e)}))}})}));