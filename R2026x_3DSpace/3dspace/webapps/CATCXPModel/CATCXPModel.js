define("DS/CATCXPModel/extensions/CATE3DX3DActorAsset",["UWA/Core","UWA/Class","UWA/Class/Listener","UWA/Class/Events","DS/CAT3DExpModel/XCTEWSTracesHelper","DS/CAT3DExpModel/CAT3DXModel"],(function(e,t,n,r,i,s){"use strict";return t.extend(n,r,{init:function(){},Build:function(){this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"ASSET_CHANGED",(()=>{this._clearActorAsset(),this.dispatchEvent("3DACTOR_CHANGED")}))},Dispose:function(){this._clearActorAsset()},_clearActorAsset:function(){delete this._node3D,delete this._node3DPromise,delete this._overrideChildren},getNode3D:async function(){if(this._node3D)return e.Promise.resolve(this._node3D);if(this._node3DPromise)return this._node3DPromise;const t=i.createTrace("EWS_Load3DActor_"+this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName"));return this._node3DPromise=this._getNode3D().then((e=>(this._node3D=e,delete this._node3DPromise,t.end(!0),this._node3D))).catch((t=>(delete this._node3DPromise,e.Promise.reject(t)))),this._node3DPromise},_getNode3D:async function(){const t=this.GetObject()._experienceBase.getManager("CAT3DXAVPComManager");if(t&&t.isAVPEnabled()){const t=this.QueryInterface("CATI3DXAssetHolder")._getLinkDescription();if(t.endsWith(".glb")){const n=t.slice(0,-4)+"_cs.glb",r=s._getExpCoreLinkManager(),i=await r.resolveLink(n).then((e=>e)).catch((t=>e.Promise.resolve(null)));if(i)return this._getNode3DFromAsset(i)}}return this.QueryInterface("CATI3DXAssetHolder")._resolveAsset().then((e=>this._getNode3DFromAsset(e)))},_getNode3DFromAsset:function(){return e.Promise.reject(new Error("CATE3DX3DActorAsset._getNode3DFromAsset : Must be implemented by derived class"))},getVisuParent:function(){return this.QueryInterface("CATI3DExperienceObject").GetParent()},getVisuOverrideChildren:function(){if(this._overrideChildren)return this._overrideChildren;var e=this.QueryInterface("CATI3DXAssetHolder")._getCache();return e&&e.OverrideChildren?this._overrideChildren=this._getOverrideChildrenInContext(e.OverrideChildren):this._overrideChildren=[],this._overrideChildren},getPositionInAssetContext:function(){return[1,0,0,0,1,0,0,0,1,0,0,0]},getParentPositionInAssetContext:function(){return[1,0,0,0,1,0,0,0,1,0,0,0]},_getOverrideChildrenInContext:function(e){for(var t=this._getProduct().QueryInterface("CATI3DExperienceObject").GetValueByName("overrides"),n=[],r=0;r<e.length;r++){var i=e[r].PathOfIds.slice().pop();n.push(this._getOverrideFromId(t,i))}return n},_getProduct:function(){return this.GetObject()},_getOverrideFromId:function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].QueryInterface("CATI3DExperienceObject").GetPathOfIds().popId())return e[n]}})})),define("DS/CATCXPModel/interfaces/CATICXPMaterialApplication",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPMaterialApplication",required:{SetMaterialLink:function(){},GetMaterialLink:function(){}},optional:{}})})),define("DS/CATCXPModel/extensions/CATE3DActorMovable",["UWA/Core","DS/MathematicsES/MathsDef","UWA/Class/Events","UWA/Class/Listener"],(function(e,t,n,r){"use strict";return e.Class.extend(n,r,{Dispose:function(){this._parent(),this.stopListening()},Build:function(){var e=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"_varposition.CHANGED",(function(t){e.dispatchEvent("TRANSFORM_CHANGED",[t])}))},GetLocalPosition:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition");e.setFromArray(t)},SetLocalPosition:function(e,t){this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",t.getArray())},GetAbsPosition:function(e){var n,r,i=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition");if(e.setFromArray(i),(n=this.QueryInterface("CATI3DExperienceObject").GetParent())&&(r=n.QueryInterface("CATIMovable")),r){var s=new t.Transformation;r.GetAbsPosition(s),e.setFromArray(t.Transformation.multiply(s,e).getArray())}},SetAbsPosition:function(e){var n,r;if((n=this.QueryInterface("CATI3DExperienceObject").GetParent())&&(r=n.QueryInterface("CATIMovable")),r){var i=new t.Transformation;r.GetAbsPosition(i);var s=t.Transformation.multiply(i.getInverse(),e);this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",s.getArray())}else this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",e.getArray())}})})),define("DS/CATCXPModel/interfaces/CATICXPScenariosMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPScenariosMgr",required:{CreateAndAddScenario:function(){},RemoveScenario:function(){},ListScenarios:function(){},SetStartupScenario:function(){},GetStartupScenario:function(){},IsStartupScenario:function(){}},optional:{}})})),define("DS/CATCXPModel/interfaces/CATI3DX3DActorAsset",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATI3DX3DActorAsset",required:{getNode3D:function(){},getVisuParent:function(){},getVisuOverrideChildren:function(){},getPositionInAssetContext:function(){},getParentPositionInAssetContext:function(){}},optional:{}})})),define("DS/CATCXPModel/extensions/CATECXPExperienceMaterialsMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel"],(function(e){"use strict";return e.Class.extend({CreateAndAddMaterialFromAsset:function(){},ListMaterials:function(e){if(Array.isArray(e)){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");e.splice(0,e.length),e.length=t.length;for(var n=t.length;n--;)e[n]=t[n];return t}console.error("oMaterialsList must be an array!")},ListMaterialApplications:function(){},RemoveMaterial:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");t.splice(t.indexOf(e),1),this.QueryInterface("CATI3DExperienceObject").SetValueByName("materials",t)},ApplyMaterial:function(){},GetActiveMaterialApplicationForVisualization:function(){}})})),define("DS/CATCXPModel/extensions/CATECXPActorsMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel","UWA/Class/Events","UWA/Class/Listener"],(function(e,t,n,r){"use strict";return e.Class.extend(n,r,{init:function(){this._parent()},Dispose:function(){this._parent(),this.stopListening()},Build:function(){var e=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",(function(t){e.dispatchEvent("ACTORS.CHANGED",[t])}))},CreateAndAddActor:function(e,n){return t.CreateActor(n,e,this.GetObject())},ListActors:function(t){var n=this.QueryInterface("CATI3DExperienceObject").GetValueByName("actors");if(t instanceof Array){t.splice(0,t.length),t.length=n.length;for(var r=n.length;r--;)t[r]=n[r]}else e.log("StuInstanceExperienceObject.ListActors ERROR : unable to fill parameters, not an array !")},RemoveActor:function(e){return t.DeleteActor(e)},Count:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("actors").length}})})),define("DS/CATCXPModel/extensions/CATECXPMaterialApplication",["UWA/Core"],(function(e){"use strict";return e.Class.extend({SetMaterialLink:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("linktomaterial",e)},GetMaterialLink:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("linktomaterial")}})})),define("DS/CATCXPModel/interfaces/CATICXPSceneMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPSceneMgr",required:{GetCurrentScene:function(){},SetCurrentScene:function(){}},optional:{}})})),define("DS/CATCXPModel/extensions/CATE3DGeoVisu",["UWA/Core","DS/Visualization/Node3D","UWA/Class/Events","UWA/Class/Listener"],(function(e,t,n,r){"use strict";return e.Class.extend(n,r,{init:function(){this._parent(),this._node3D=null,this._pathElement=null,this._override=null,this.frameVisuChanges=[]},Build:function(){this.setReady(!1)},Dispose:function(){if(this._node3D){this._node3D.removeChildren();for(var e=this._node3D.parents,t=e.length-1;t>=0;--t)e[t].remove(this._node3D);this._node3D=null}this._override&&this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getOverrideSet().deleteOverride(this._override);this._pathElement=null,this.frameVisuChanges=[],this._ready=!1,this.stopListening()},GetNode:function(){return this._node3D?this._node3D:this._CreateNode()},GetPathElement:function(){return this._pathElement?this._pathElement:this._CreatePathElement()},GetOverride:function(){return this._override?this._override:this._CreateOverride()},GetLocalNodes:function(){return null},_CreateNode:function(){return this._node3D=new t,this._Fill(this._node3D),this._node3D},_CreateOverride:function(){var e=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getOverrideSet(),t=this.GetPathElement();return this._override=e.createOverride(t),this._override},_Fill:function(e){var t=this.GetObject();e._components?(e._components.push(t),e.name=e.name+" ; "+t.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")):(e._components=[t],e.name=t.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")),this.RequestVisuRefresh()},RequestVisuRefresh:function(){this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").refreshGeoVisu(this)},Refresh:function(){let e=!1;for(let t=0;t<this.frameVisuChanges.length;++t){let n=this.frameVisuChanges[t].call(this);e=e||n}return this.frameVisuChanges.length=0,e},isReady:function(){return this._ready},Is3DNodeAttachedToSceneGraph:function(){if(!this._node3D)return!1;return this.GetPathElement().checkExternalPath()}})})),define("DS/CATCXPModel/interfaces/CATI3DXAssetProperties",["UWA/Class","DS/WebComponentModeler/CATWebInterface","DS/CAT3DExpModel/XCTExpAsset"],(function(e,t,n){"use strict";var r=t.singleton({interfaceName:"CATI3DXAssetProperties",required:{getPhysicalId:function(){},getAssetStatus:function(){}},optional:{}});return r.AssetStatus=n.AssetStatus,r})),define("DS/CATCXPModel/interfaces/CATICXPResourcesMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPResourcesMgr",required:{CreateBinaryResource:function(){},UpdateBinaryResource:function(){},UpdateBinaryResourceByName:function(){},CreateURLResource:function(){},UpdateURLResource:function(){},UpdateURLResourceByName:function(){},DeleteResource:function(){},DeleteResourceByName:function(){},ListResources:function(){},Count:function(){},GetResourceByName:function(){}},optional:{}})})),define("DS/CATCXPModel/extensions/CATECXPBehaviorsMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel","UWA/Class/Events","UWA/Class/Listener"],(function(e,t,n,r){"use strict";return e.Class.extend(n,r,{init:function(){this._parent()},Dispose:function(){this._parent(),this.stopListening()},Build:function(){var e=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"behaviors.CHANGED",(function(t){e.dispatchEvent("BEHAVIORS.CHANGED",[t])}))},ListBehaviors:function(e){if(e instanceof Array){e.length=0;for(var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("behaviors"),n=0;n<t.length;n++)e.push(t[n])}else console.log("CATECXPBehaviorsMgr.ListBehaviors ERROR : unable to fill parameters, not an array !")},RemoveBehavior:function(e){return t.DeleteBehavior(e)},CreateAndAddBehavior:function(e,n){return t.CreateBehavior(n,e,this.GetObject())}})})),define("DS/CATCXPModel/extensions/CATECXPExperienceScenesMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel","UWA/Class/Listener"],(function(e,t,n){"use strict";return e.Class.extend(n,{init:function(){this._parent()},Dispose:function(){this._parent(),this.stopListening()},Build:function(){this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"currentScene.CHANGED",(function(){var e=this.GetCurrentScene();e&&this._OnSceneChanged(e)}));var e=this.GetCurrentScene();e&&this._OnSceneChanged(e)},_OnSceneChanged:async function(e){await this._ApplyState(e)},_ApplyState:function(t){var n=t.QueryInterface("CATI3DExperienceObject").GetValueByName("_stateForPermanents"),r=[];if(n&&n.length>0)for(var i=0;i<n.length;i++)if("stateForPermanents"===n[i].QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")){r.push(n[i].QueryInterface("CATI3DExpState").ApplyStatedValues());break}return e.Promise.allSettled(r)},GetCurrentScene:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("currentScene")},SetCurrentScene:function(t){return this.QueryInterface("CATI3DExperienceObject").SetValueByName("currentScene",t),e.Promise.resolve()}})})),define("DS/CATCXPModel/extensions/CATECXP3DActorModifiable",["UWA/Core","DS/CAT3DExpModel/extensions/CATEModifiable","DS/VCXWebProperties/VCXPropertyValueFrame","DS/Visualization/ThreeJS_DS","DS/VCXWebTracks/VCXInterpolatorLinear","DS/VCXWebTracks/VCXInterpolatorCubic"],(function(e,t,n,r,i,s){"use strict";return t.extend({EInterpolatorType:{ELinear:0,ECubic:1},init:function(){this._actorPositionInterpolator=this.EInterpolatorType.ELinear,this._parent()},OnChangeProperty:function(e,t){"Actor.Position.Interpolator"===e&&(this._actorPositionInterpolator=t.GetValue()),this._parent(e,t)},GetInterpolator:function(e){if("_varposition"===e){if(this._actorPositionInterpolator===this.EInterpolatorType.ELinear)return new i;if(this._actorPositionInterpolator===this.EInterpolatorType.ECubic)return new s;console.warn("CATECXP3DActorModifiable Unknown interpolator")}return this._parent(e)},_getVCXProperty:function(e){return"_varposition"!==e||this.VCXProperties[e]||this._createVCXProperty(e),this._parent(e)},_getVCXPropertyValue:function(e){return"_varposition"===e?this._toVCXLocation(e):this._parent(e)},_getVariableValue:function(e,t){return"_varposition"===e?this._fromVCXLocation(t):this._parent(e,t)},_toVCXLocation:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName(e),i=new r.Matrix4(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1);return new n(i)},_fromVCXLocation:function(e){var t=e.GetValue().elements;return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10],t[12],t[13],t[14]]}})})),define("DS/CATCXPModel/extensions/CATECXPEnvironmentsMgr",["UWA/Core"],(function(e){"use strict";return e.Class.extend({init:function(){this._parent(),this._activeEnvironment=null},Dispose:function(){this._parent(),this._activeEnvironment=null},CreateAndAddEnvironmentFromAsset:function(){console.warn("not implemented")},RemoveEnvironment:function(){console.warn("not implemented")},ListEnvironments:function(e){if(Array.isArray(e)){if(e.splice(0,e.length),this.QueryInterface("CATI3DExperienceObject").HasVariable("environments")){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("environments");e.length=t.length;for(var n=t.length;n--;)e[n]=t[n]}return e}console.error("oEnvironments must be an array!")},SetStartupEnvironment:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("startupEnvironment",e)},GetStartupEnvironment:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("startupEnvironment")},SetStartupLocation:function(){console.warn("not implemented")},GetStartupLocation:function(){console.warn("not implemented")},SetAuthoringEnvironment:function(){console.warn("not implemented")},GetAuthoringEnvironment:function(){console.warn("not implemented")},SetActiveEnvironment:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("currentEnvironment",e)},GetActiveEnvironment:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("currentEnvironment")},DeActivateForExit:function(){console.warn("not implemented")},SetActiveLocation:function(){console.warn("not implemented")},GetActiveLocation:function(){console.warn("not implemented")},CheckLocationPositions:function(){console.warn("not implemented")},CheckLocationPosition:function(){console.warn("not implemented")}})})),define("DS/CATCXPModel/interfaces/CATICXPActorsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPActorsMgr",required:{CreateAndAddActor:function(){},ListActors:function(){},RemoveActor:function(){},Count:function(){}},optional:{}})})),define("DS/CATCXPModel/extensions/CATE3DXOverrideAssetProperties",["UWA/Core","DS/CAT3DExpModel/XCTExp3DSpaceVOAsset"],(function(e,t){"use strict";return e.Class.extend({getPathOfPhysicalId:function(){return this.QueryInterface("CATI3DXAssetHolder")._resolveAsset().then((n=>n instanceof t?n.getPathOfPhysicalId():e.Promise.reject(new Error("Cant retrieve path of physicalId for object "+this.GetObject().GetID()))))},getAssetStatus:function(){return this.QueryInterface("CATI3DXAssetHolder")._getAssetStatus()}})})),define("DS/CATCXPModel/extensions/CATECXP3DActorMaterialsMgr",["UWA/Core","UWA/Class"],(function(e){"use strict";return e.Class.extend({CreateAndAddMaterialFromAsset:function(){},ListMaterials:function(e){var t=[];this.ListMaterialApplications(t),e.splice(0,e.length),e.length=t.length;for(var n=t.length;n--;)e[n]=t[n].QueryInterface("CATICXPMaterialApplication").GetMaterialLink();return e},ListMaterialApplications:function(e){if(Array.isArray(e)){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");t||(t=[]),e.splice(0,e.length),e.length=t.length;for(var n=t.length;n--;)e[n]=t[n];return t}console.error("oMaterialsList must be an array!")},RemoveMaterial:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");t||(t=[]);var n=t.map((function(e){return e.QueryInterface("CATICXPMaterialApplication").GetMaterialLink()})).indexOf(e);t.splice(n,1),this.QueryInterface("CATI3DExperienceObject").SetValueByName("materials",t)},ApplyMaterial:function(){},GetActiveMaterialApplicationForVisualization:function(){var e=[];if(this.QueryInterface("CATI3DExperienceObject").HasVariable("materials")&&(e=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials")),1===e.length)return e[0]}})})),define("DS/CATCXPModel/interfaces/CATICXPEnvironmentActivate",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPEnvironmentActivate",required:{Activate:function(){},Deactivate:function(){}},optional:{}})})),define("DS/CATCXPModel/interfaces/CATICXPGroupCall",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPGroupCall",required:{GetCommonCapacities:function(){},GetNonCommonCapacities:function(){},GetRelatedCapacities:function(){},IsCapacityAllowed:function(){},GetObjects:function(){}},optional:{}})})),define("DS/CATCXPModel/CATCXPRefreshUtils",["UWA/Core"],(function(e){"use strict";return{compareColor:function(e,t){return!(!e||!t)&&(e.r===t.r&&e.g===t.g&&e.b===t.b)},syncExperienceAndVizuChildren:function(t){var n=t,r=!1,i=n._node3D.getChildren();let s=new Map;i.forEach((e=>s.set(e.id,e)));let a=new Map;var o=n.GetLocalNodes();o&&a.set(o.id,o);var c=n.QueryInterface("CATI3DExperienceObject").GetValueByName("actors");if(e.is(c))for(var u=0;u<c.length;u++){var l=c[u].QueryInterface("CATI3DGeoVisu");if(e.is(l)){var f=l.GetNode();a.set(f.id,f)}}if(s.size>0)for(const e of s.keys())a.get(e)?a.delete(e):(n._node3D.removeChild(s.get(e)),r=!0);if(a.size>0){r=!0;for(const e of a.values())n._node3D.addChild(e)}return r}}})),define("DS/CATCXPModel/extensions/CATE3DX3DActorGraphicalProperties",["UWA/Core","DS/VCXWebProperties/VCXColor"],(function(e,t){"use strict";return e.Class.extend({GetPickMode:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("clickable");return!e.is(t)||t},SetPickMode:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("clickable",e)},GetShowMode:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("visible");return!e.is(t)||t},SetShowMode:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("visible",e)},GetOpacity:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("opacity");return e.is(t)?t:255},SetOpacity:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("opacity",e)},GetRed:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("color");return e.is(t)?Math.ceil(255*t.r):255},GetGreen:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("color");return e.is(t)?Math.ceil(255*t.g):255},GetBlue:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("color");return e.is(t)?Math.ceil(255*t.b):255},SetColor:function(e,n,r){var i=(new t).FromRGBA(e/255,n/255,r/255,1);this.QueryInterface("CATI3DExperienceObject").SetValueByName("color",i)}})})),define("DS/CATCXPModel/extensions/CATECXPExperienceScenariosMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel"],(function(e,t){"use strict";return e.Class.extend({init:function(){this._parent()},Dispose:function(){this._parent()},CreateAndAddScenario:function(n){return t.CreateScenario(n).done((function(t){return e.Promise.resolve(t)}))},RemoveScenario:function(e){var t=this.QueryInterface("CATI3DExperienceObject"),n=t.GetValueByName("scenarios"),r=n.indexOf(e);r>=0&&(n.splice(r,1),t.SetValueByName("scenarios",n))},ListScenarios:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("scenarios")},SetStartupScenario:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("PlaySettings");t&&t.QueryInterface("CATI3DExperienceObject")&&t.QueryInterface("CATI3DExperienceObject").SetValueByName("startupScenario",e)},GetStartupScenario:function(){var e=this.QueryInterface("CATI3DExperienceObject").GetValueByName("PlaySettings");if(e&&e.QueryInterface("CATI3DExperienceObject"))return e.QueryInterface("CATI3DExperienceObject").GetValueByName("startupScenario")},IsStartupScenario:function(e){return this.GetStartupScenario()===e}})})),define("DS/CATCXPModel/extensions/CATECXPGroupCall",["UWA/Core"],(function(e){"use strict";const t=["SetAsCurrent","startAnimation","setCurrentConfiguration","starts","appliesTo"];return e.Class.extend({GetCommonCapacities:function(){var e=this.GetObjects(),t=this._retrieveCapacities(),n=[];for(var r in t)t[r].length===e.length&&n.push(r);return n},GetNonCommonCapacities:function(){var e=this.GetObjects(),t=this._retrieveCapacities(),n=[];for(var r in t)t[r].length!==e.length&&n.push(r);return n},GetRelatedCapacities:function(e){var t=this._retrieveCapacities();return t[e]?t[e]:[]},IsCapacityAllowed:function(e){return t.indexOf(e)<0},GetObjects:function(){console.warn("CATECXPGroupCall.GetObjects: Must be implemented by derived class.")},_retrieveCapacities:function(){var e=this.GetObjects(),t=[];for(let n=0;n<e.length;n++)t=t.concat(this._retrieveCapacitiesFromObject(e[n]));var n={};for(let e=0;e<t.length;e++){var r=t[e].QueryInterface("CATI3DExperienceObject").GetValueByName("_varName");this.IsCapacityAllowed(r)&&(n[r]?n[r].push(t[e]):n[r]=[t[e]])}return n},_retrieveCapacitiesFromObject:function(e){var t=e.QueryInterface("CATI3DExperienceObject"),n=[];if(n=n.concat(this._retrieveCapacitiesFromExpObject(t)),t.HasVariable("behaviors"))for(var r=t.GetValueByName("behaviors"),i=0;i<r.length;i++)n=n.concat(this._retrieveCapacitiesFromExpObject(r[i].QueryInterface("CATI3DExperienceObject")));return n},_retrieveCapacitiesFromExpObject:function(e){var t=[];return e.HasVariable("_functions")&&(t=t.concat(e.GetValueByName("_functions"))),e.HasVariable("_services")&&(t=t.concat(e.GetValueByName("_services"))),e.HasVariable("_events")&&(t=t.concat(e.GetValueByName("_events"))),t}})})),define("DS/CATCXPModel/extensions/CATE3DXAssetProperties",["UWA/Core","DS/CAT3DExpModel/XCTExp3DSpaceAsset"],(function(e,t){"use strict";return e.Class.extend({getPhysicalId:function(){return this.QueryInterface("CATI3DXAssetHolder")._resolveAsset().then((n=>n instanceof t?n.getPhysicalId():e.Promise.reject(new Error("Cant retrieve physicalId for object "+this.GetObject().GetID()))))},getAssetStatus:function(){return this.QueryInterface("CATI3DXAssetHolder")._getAssetStatus()}})})),define("DS/CATCXPModel/interfaces/CATICXPBehaviorsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPBehaviorsMgr",required:{ListBehaviors:function(){},RemoveBehavior:function(){},CreateAndAddBehavior:function(){}},optional:{}})})),define("DS/CATCXPModel/CATCXPRenderUtils",["UWA/Core","DS/MathematicsES/MathsDef","DS/Visualization/Viewpoint","UWA/Class"],(function(e,t,n){"use strict";return e.Class.singleton({getComponentsFromPathElement:function(e,t){for(var n=e.externalPath.slice(),r=[];n.length>0;){var i=n[n.length-1];if(i._components)for(var s=0;s<i._components.length;s++)if(n.equals(i._components[s].QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath)&&(r.push(i._components[s]),t))return r;n.pop()}return r},setCameraFromViewpoint:function(e,n){if(e&&n){var r=n.camera,i=r.matrix.elements,s=[i[8],i[9],i[10],i[0],i[1],i[2],i[4],i[5],i[6],i[12],i[13],i[14]],a=new t.Transformation;a.setFromArray(s),e.QueryInterface("CATIMovable").SetLocalPosition(null,a),e.QueryInterface("CATI3DExperienceObject").GetValueByName("farClip")!==r.near&&e.QueryInterface("CATI3DExperienceObject").SetValueByName("farClip",r.near),e.QueryInterface("CATI3DExperienceObject").GetValueByName("nearClip")!==r.far&&e.QueryInterface("CATI3DExperienceObject").SetValueByName("nearClip",r.far),e.QueryInterface("CATI3DExperienceObject").GetValueByName("viewAngle")!==r.fov&&e.QueryInterface("CATI3DExperienceObject").SetValueByName("viewAngle",n.getAngle()/2),e.QueryInterface("CATI3DGeoVisu").Refresh(n.viewer)}},setViewpointFromCamera:function(e,r,i){if(!r||!e)return;var s=i||0,a=new t.Transformation;r.QueryInterface("CATIMovable").GetAbsPosition(a);var o=!1,c=a.vector.clone();this._isVector3DEquals(c,e.getEyePosition())||(o=!0);var u=new t.Quaternion;a.matrix.getQuaternion(u);var l=new t.Point;l.set(-1,0,0);var f=l.applyQuaternion(u),h=new t.Vector3D;h.set(f.x,f.y,f.z),h.normalize(),o||this._isVector3DEquals(h,e.getSightDirection())||(o=!0);var C=new t.Point;C.set(0,0,1);var A=C.applyQuaternion(u),d=new t.Vector3D;d.set(A.x,A.y,A.z),d.normalize(),o||this._isVector3DEquals(d,e.getUpDirection())||(o=!0),o&&e.moveTo({eyePosition:c,upDirection:d,sightDirection:h,duration:s});var p=r.QueryInterface("CATI3DExperienceObject");const y=p.GetValueByName("focusDistance");e.TargetDistance!==y&&e.setTargetDistance(y);const D=0===p.GetValueByName("projectionType"),I=D?n.PERSPECTIVE:n.ORTHOGRAPHIC;let m;if(e.getProjectionType()!==I&&e.setProjectionType(I),D)m=2*p.GetValueByName("viewAngle");else{const e=p.GetValueByName("zoom");m=180*Math.atan(1/(y*e))/Math.PI*2}if(m!==e.getAngle()&&e.setAngle(m),p.GetValueByName("enableAutomaticClipping"))!0!==e.viewer.autoUpdateFrustum&&(e.viewer.autoUpdateFrustum=!0);else{!1!==e.viewer.autoUpdateFrustum&&(e.viewer.autoUpdateFrustum=!1);var T=p.GetValueByName("nearClip");T!==e.camera.near&&(e.camera.near=T);var v=p.GetValueByName("farClip");v!==e.camera.far&&(e.camera.far=v)}},setViewerRatioFromCamera:function(e,t){if(e&&t){var n=e.div,r=e.canvas,i=t.QueryInterface("CATI3DExperienceObject");if(i&&n&&r){let e=!0;const t=i.GetValueByName("aspectRatio");if(t&&3===t.length){const r=t[0],i=t[1];if(1!==t[2]){const e=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),t=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),s=t/i*r,a=e/r*i;s<e?(n.style.height="100%",n.style.width=s/e*100+"%"):s>=e&&(n.style.width="100%",n.style.height=a/t*100+"%"),n.parentNode.style.display="flex",n.parentNode.style.alignItems="center",n.parentNode.style.justifyContent="center"}else e=!1}e||(n.style.width="100%",n.style.height="100%",n.parentNode.style.display="",n.parentNode.style.alignItems="",n.parentNode.style.justifyContent="")}}},setViewerPostProcessFromCamera:function(e,t){if(e&&t){var n=t.QueryInterface("CATI3DExperienceObject");if(n){var r=e.getEffect("ToneMapping");if(r)if(n.GetValueByName("enableToneMapping")){switch(n.GetValueByName("toneMapping")){case 0:var i=n.GetValueByName("blacks"),s=n.GetValueByName("whites"),a=n.GetValueByName("saturation");r.setToneMapping(6,{crushblacks:i,burnhighlights:s,saturation:a});break;case 1:r.setToneMapping(4)}var o=n.GetValueByName("gamma");r.setGamma(o)}else r.setToneMapping(1)}}},_isVector3DEquals:function(e,t){return!!e.isEqual(t,1e-6)}})})),define("DS/CATCXPModel/interfaces/CATI3DXOverrideAssetProperties",["UWA/Class","DS/WebComponentModeler/CATWebInterface","DS/CAT3DExpModel/XCTExpAsset"],(function(e,t,n){"use strict";var r=t.singleton({interfaceName:"CATI3DXOverrideAssetProperties",required:{getPathOfPhysicalId:function(){},getAssetStatus:function(){}},optional:{}});return r.AssetStatus=n.AssetStatus,r})),define("DS/CATCXPModel/interfaces/CATICXPEnvironmentsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPEnvironmentsMgr",required:{CreateAndAddEnvironmentFromAsset:function(){},RemoveEnvironment:function(){},ListEnvironments:function(){},SetStartupEnvironment:function(){},GetStartupEnvironment:function(){},SetStartupLocation:function(){},GetStartupLocation:function(){},SetAuthoringEnvironment:function(){},GetAuthoringEnvironment:function(){},SetActiveEnvironment:function(){},GetActiveEnvironment:function(){},DeActivateForExit:function(){},SetActiveLocation:function(){},GetActiveLocation:function(){},CheckLocationPositions:function(){},CheckLocationPosition:function(){}},optional:{}})})),define("DS/CATCXPModel/interfaces/CATICXPMaterialsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],(function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPMaterialsMgr",required:{CreateAndAddMaterialFromAsset:function(){},ListMaterials:function(){},ListMaterialApplications:function(){},RemoveMaterial:function(){},ApplyMaterial:function(){},GetActiveMaterialApplicationForVisualization:function(){}},optional:{}})})),define("DS/CATCXPModel/extensions/CATECXPExperienceResourcesMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel"],(function(e,t){"use strict";return e.Class.extend({CreateBinaryResource:function(e,n,r,i=!1){return t.CreateBinaryResource(e,n,r).then((e=>(this._updateBinaryRessourceAsset(e,n,i),e)))},UpdateBinaryResource:function(e,n,r,i=!1){return t.UpdateBinaryResource(e,n,r).then((()=>{this._updateBinaryRessourceAsset(e,n,i)}))},UpdateBinaryResourceByName:function(n,r,i,s=!1){var a=this.GetResourceByName(n);return a?t.UpdateBinaryResource(a,r,i).then((()=>{this._updateBinaryRessourceAsset(a,r,s)})):e.Promise.reject(new Error("Cant find resource : "+n))},_updateBinaryRessourceAsset:function(e,t,n=!1){n&&(e.QueryInterface("CATI3DXPictureResourceAsset")&&e.QueryInterface("CATI3DXPictureResourceAsset")._updatePicture(t),e.QueryInterface("CATI3DXSoundResourceAsset")&&e.QueryInterface("CATI3DXSoundResourceAsset")._updateSound(t))},CreateURLResource:function(e,n){return t.CreateURLResource(e,n)},UpdateURLResource:function(e,n){return t.UpdateURLResource(e,n)},UpdateURLResourceByName:function(n,r){var i=this.GetResourceByName(n);return i?t.UpdateURLResource(i,r):e.Promise.reject(new Error("Cant find resource : "+n))},DeleteResource:function(e){return t.DeleteResource(e)},DeleteResourceByName:function(n){var r=this.GetResourceByName(n);return r?t.DeleteResource(r):e.Promise.reject(new Error("Cant find resource : "+n))},ListResources:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("resources")},Count:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("resources").length},GetResourceByName:function(e){for(var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("resources"),n=0;n<t.length;n++)if(t[n].QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")===e)return t[n]}})})),define("DS/CATCXPModel/extensions/CATEVPMOccurrenceMovable",["UWA/Core","DS/MathematicsES/MathsDef","DS/CATCXPModel/extensions/CATE3DActorMovable"],(function(e,t,n){"use strict";return n.extend({GetLocalPosition:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition");t&&12===t.length?e.setFromArray(t):e.setFromArray(this.QueryInterface("CATI3DX3DActorAsset").getPositionInAssetContext())},GetAbsPosition:function(e){var n=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition"),r=this.QueryInterface("CATI3DX3DActorAsset");n&&12===n.length?e.setFromArray(n):e.setFromArray(r.getPositionInAssetContext());var i=(new t.Transformation).setFromArray(r.getParentPositionInAssetContext());e.copy(t.Transformation.multiply(i,e));var s=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent().QueryInterface("CATIMovable");if(s){var a=new t.Transformation;s.GetAbsPosition(a),e.setFromArray(t.Transformation.multiply(a,e).getArray())}},SetAbsPosition:function(e){var n=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent().QueryInterface("CATIMovable");if(n){var r=new t.Transformation;n.GetAbsPosition(r);var i=t.Transformation.multiply(r.getInverse(),e),s=(new t.Transformation).setFromArray(this.QueryInterface("CATI3DX3DActorAsset").getParentPositionInAssetContext());i=t.Transformation.multiply(s.getInverse(),i),this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",i.getArray())}else this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",e.getArray())}})})),define("DS/CATCXPModel/extensions/CATECXPCollectionGroupCall",["UWA/Core","DS/CATCXPModel/extensions/CATECXPGroupCall"],(function(e,t){"use strict";return t.extend({GetObjects:function(){return this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DExperienceObject").GetValueByName("references")}})})),define("DS/CATCXPModel/extensions/CATEExperience3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DGeoVisu","DS/Visualization/PathElement","DS/CATCXPModel/CATCXPRefreshUtils"],(function(e,t,n,r){"use strict";return t.extend({_CreatePathElement:function(){return this._pathElement=new n([this.GetNode()]),this._pathElement},_Fill:function(e){this._parent(e);var t=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",(function(){t.frameVisuChanges.push(t._refreshChildrenNodes),t.RequestVisuRefresh(),t.setReady(t._isAllChildrenReady())})),this.QueryInterface("CATICXPScenesMgr")&&this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"currentScene.CHANGED",(function(){t.frameVisuChanges.push(t._refreshChildrenNodes),t.RequestVisuRefresh(),t.setReady(t._isAllChildrenReady())})),this.frameVisuChanges.push(this._refreshChildrenNodes),this.setReady(this._isAllChildrenReady())},_refreshChildrenNodes:function(){let t=r.syncExperienceAndVizuChildren(this);var n=this.QueryInterface("CATICXPScenesMgr");if(!n)return t;var i=n.GetCurrentScene();if(i){var s=i.QueryInterface("CATI3DGeoVisu");if(e.is(s)){var a=s.GetNode();this._node3D.addChild(a)}}return t},setReady:function(e){e!==this._ready&&(e&&!this._isAllChildrenReady()||(this._ready=e,this.dispatchEvent("readyChanged",e)))},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(var n=0;n<t.length;n++){var r=t[n].QueryInterface("CATI3DGeoVisu");if(r&&!r.isReady())return!1}}var i=this.QueryInterface("CATICXPScenesMgr");if(!i)return!0;var s=i.GetCurrentScene();if(s){var a=s.QueryInterface("CATI3DGeoVisu");if(a&&!a.isReady())return!1}return!0},GetBoundingBox:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingBox(null,t,"visibleSpace"):e.getBoundingBox(null,t,"invisibleSpace")},GetBoundingSphere:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingSphere(t,"visibleSpace"):e.getBoundingSphere(t,"invisibleSpace")}})})),define("DS/CATCXPModel/extensions/CATEScene3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DGeoVisu","DS/Visualization/PathElement","DS/CATCXPModel/CATCXPRefreshUtils"],(function(e,t,n,r){"use strict";return t.extend({_CreatePathElement:function(){var e=this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath.slice();return e.push(this.GetNode()),this._pathElement=new n(e),this._pathElement},_Fill:function(e){this._parent(e);var t=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",(function(){t.frameVisuChanges.push(t._refreshChildrenNodes),t.RequestVisuRefresh(),t.setReady(t._isAllChildrenReady())})),this.frameVisuChanges.push(this._refreshChildrenNodes),this.setReady(this._isAllChildrenReady())},_refreshChildrenNodes:function(){return r.syncExperienceAndVizuChildren(this)},setReady:function(e){e!==this._ready&&(e&&!this._isAllChildrenReady()||(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e)))},_setParentReady:function(e){var t=this.QueryInterface("CATI3DExperienceObject");if(t){var n=t.GetParent();n&&n.QueryInterface("CATI3DGeoVisu")&&n.QueryInterface("CATI3DGeoVisu").setReady(e)}},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(var n=0;n<t.length;n++){var r=t[n].QueryInterface("CATI3DGeoVisu");if(r&&!r.isReady())return!1}}return!0},GetBoundingBox:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingBox(null,t,"visibleSpace"):e.getBoundingBox(null,t,"invisibleSpace")},GetBoundingSphere:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingSphere(t,"visibleSpace"):e.getBoundingSphere(t,"invisibleSpace")}})})),define("DS/CATCXPModel/extensions/CATE3DScene3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DGeoVisu","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/MathematicsES/MathsDef","DS/SceneGraphOverrides/GenericOverride"],(function(e,t,n,r,i,s,a){"use strict";return t.extend({_CreatePathElement:function(){var e=this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath.slice();return e.push(this.GetNode()),this._pathElement=new r(e),this._pathElement},_Fill:function(e){this._parent(e);var t=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"_varposition.CHANGED",(function(){t.frameVisuChanges.push(t._RefreshVarPos),t.RequestVisuRefresh()})),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"visible.CHANGED",(function(){t.frameVisuChanges.push(t._RefreshVisibility),t.RequestVisuRefresh()})),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"clickable.CHANGED",(function(){t.frameVisuChanges.push(t._RefreshPickability),t.RequestVisuRefresh()})),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"opacity.CHANGED",(function(){t.frameVisuChanges.push(t._RefreshOpacity),t.RequestVisuRefresh()})),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"color.CHANGED",(function(){t.frameVisuChanges.push(t._RefreshColor),t.RequestVisuRefresh()})),this.frameVisuChanges.push(this._RefreshVarPos),this.frameVisuChanges.push(this._RefreshVisibility),this.frameVisuChanges.push(this._RefreshPickability),this.frameVisuChanges.push(this._RefreshOpacity),this.frameVisuChanges.push(this._RefreshColor)},_RefreshVarPos:function(){console.warn("_RefreshVarPos must be implemented by derived classes")},_RefreshVisibility:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("visible");return e.is(t)||(t=!0),this.GetOverride().getVisibility()!==t&&(this.GetOverride().setVisibility(t),!0)},_RefreshPickability:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("clickable");return e.is(t)||(t=!0),this.GetOverride().getPickability()!==t&&(this.GetOverride().setPickability(t?"PICKABLE":"NOT_PICKABLE"),!0)},_RefreshOpacity:function(){return this.GetOverride().getOpacity()!==a.NO_OPACITY&&(this.GetOverride().setOpacity(a.NO_OPACITY,!0),!0)},_RefreshColor:function(){return this.GetOverride().getColor()!==a.NO_COLOR&&(this.GetOverride().setColor(a.NO_COLOR,!0),!0)},setReady:function(e){e!==this._ready&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))},_setParentReady:function(e){var t=this.QueryInterface("CATI3DExperienceObject");if(t){var n=t.GetParent();n&&n.QueryInterface("CATI3DGeoVisu")&&n.QueryInterface("CATI3DGeoVisu").setReady(e)}},GetBoundingBox:function(e){var t,n=this.GetPathElement(),r=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();if(e=e||0,t=this.GetOverride().getVisibility()?n.getBoundingBox(null,r,"visibleSpace"):n.getBoundingBox(null,r,"invisibleSpace"),0===e){var a=new s.Transformation;this.QueryInterface("CATIMovable").GetAbsPosition(a);var o=a.getArray(),c=new i.Matrix4(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1);t.applyMatrix4(c)}return t},GetBoundingSphere:function(){var e,t=this.GetPathElement(),n=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();e=this.GetOverride().getVisibility()?t.getBoundingSphere(n,"visibleSpace"):t.getBoundingSphere(n,"invisibleSpace");const r=this.QueryInterface("CATIMovable");if(r){const t=new s.Transformation;r.GetLocalPosition(t);const n=t.getArray(),a=new i.Matrix4(n[0],n[3],n[6],n[9],n[1],n[4],n[7],n[10],n[2],n[5],n[8],n[11],0,0,0,1);e.applyMatrix4(a)}return e}})})),define("DS/CATCXPModel/extensions/CATEVPMOccurrence3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DScene3DGeoVisu","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/MathematicsES/MathsDef","DS/Visualization/Node3D"],(function(e,t,n,r,i,s){"use strict";return e.Class.extend(t,{init:function(){this._parent(),this._modelLoaded=!1},Dispose:function(){this._parent(),this._modelLoaded=!1,this._assetNode&&(this._assetNode.removeChildren(),this._assetNode=null)},_CreatePathElement:function(){var e=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent().QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath.slice();return e.push(this.GetNode()),this._pathElement=new n(e),this._pathElement},_Fill:function(e){var t=this;this._parent(e),this.QueryInterface("CATI3DX3DActorAsset").getNode3D().catch((function(){let e=new s;return e.setMatrix(null),e})).then((function(n){t._assetNode=n,e.addChild(n),t.RequestVisuRefresh(),t._modelLoaded=!0,t.setReady(!0)})).catch((function(e){console.error(e)})),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"materials.CHANGED",(function(){t.frameVisuChanges.push(t._refreshMaterialApplication),t.RequestVisuRefresh()})),this.frameVisuChanges.push(this._addOverrideChildrenNodes),this.frameVisuChanges.push(this._refreshMaterialApplication)},_addOverrideChildrenNodes:function(){for(var t=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),n=0;n<t.length;n++){var r=t[n].QueryInterface("CATI3DGeoVisu");if(e.is(r)){var i=r.GetNode();this._node3D.addChild(i)}}},_RefreshVarPos:function(){let e=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition"),t=this.QueryInterface("CATI3DX3DActorAsset");e=e&&12===e.length?e:t.getPositionInAssetContext();let n=(new i.Transformation).setFromArray(t.getParentPositionInAssetContext());var s=(new i.Transformation).setFromArray(e);let a=!1,o=(s=i.Transformation.multiply(n,s)).getArray(),c=this.GetOverride().getPosition();if(null===c&&(a=!0),!a){let e=[0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15],t=[];for(let n=0;n<16;n++)t[n]=c.elements[e[n]];for(let e=0;e<12;e++){let n,r,i=[0,3,6,9,1,4,7,10,2,5,8,11];n=t[e],r=o[i[e]];let s=1e-4;if(Math.abs(r-n)>s){a=!0;break}}}if(a){let e=new r.Matrix4(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1);this.GetOverride().setPosition(e)}return a},_refreshMaterialApplication:function(){const t=this.QueryInterface("CATICXPMaterialsMgr").GetActiveMaterialApplicationForVisualization();return t?(t.QueryInterface("CATI3DXMaterialApplicationVisu").initializeMaterialApplicationVisu(),!1):!!e.is(this.QueryInterface("CATI3DGeoVisu").GetOverride().getMaterial())&&(this.QueryInterface("CATI3DGeoVisu").GetOverride().setMaterial(null,!0),!0)},GetLocalNodes:function(){return this._assetNode},setReady:function(e){e!==this._ready&&(!e||this._isAllChildrenReady()&&this._modelLoaded)&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))},_setParentReady:function(e){var t=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent();t&&t.QueryInterface("CATI3DGeoVisu").setReady(e)},_isAllChildrenReady:function(){for(var e=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),t=0;t<e.length;t++){var n=e[t].QueryInterface("CATI3DGeoVisu");if(n&&!n.isReady())return!1}return!0}})})),define("DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DScene3DGeoVisu","DS/Visualization/ThreeJS_DS","DS/CATCXPModel/CATCXPRefreshUtils"],(function(e,t,n,r){"use strict";var i=t.extend({Dispose:function(){this._parent()},_Fill:function(e){this._parent(e),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",(()=>{this.frameVisuChanges.push(this._refreshChildrenNodes),this.RequestVisuRefresh(),this.setReady(this._ready&&this._isAllChildrenReady())})),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"materials.CHANGED",(()=>{this.frameVisuChanges.push(this._refreshMaterialApplication),this.RequestVisuRefresh()})),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"materialsRef.CHANGED",(()=>{this.frameVisuChanges.push(this._refreshMIACMaterials),this.RequestVisuRefresh()})),this.frameVisuChanges.push(this._refreshChildrenNodes),this.frameVisuChanges.push(this._refreshMaterialApplication),this.frameVisuChanges.push(this._refreshMIACMaterials),i.prototype===this.__proto__&&this.setReady(!0)},setReady:function(e){e!==this._ready&&(e&&!this._isAllChildrenReady()||(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e)))},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(let e=0;e<t.length;e++){if(t[e].QueryInterface("CATI3DGeoVisu")&&!t[e].QueryInterface("CATI3DGeoVisu").isReady())return!1}}return!0},_refreshChildrenNodes:function(){return r.syncExperienceAndVizuChildren(this)},_RefreshVarPos:function(){var e=!1;let t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition"),r=this.GetOverride().getPosition();if(null===r&&(e=!0),!e){let n=[0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15],i=[];for(let e=0;e<16;e++)i[e]=r.elements[n[e]];for(let n=0;n<12;n++){let r,s,a=[0,3,6,9,1,4,7,10,2,5,8,11];r=i[n],s=t[a[n]];let o=1e-4;if(Math.abs(s-r)>o){e=!0;break}}}if(e){var i=new n.Matrix4(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1);this.GetOverride().setPosition(i)}return e},_refreshMaterialApplication:function(){const t=this.QueryInterface("CATICXPMaterialsMgr");if(!t)return!1;const n=t.GetActiveMaterialApplicationForVisualization();return n?(n.QueryInterface("CATI3DXMaterialApplicationVisu").initializeMaterialApplicationVisu(),!1):!!e.is(this.QueryInterface("CATI3DGeoVisu").GetOverride().getMaterial())&&(this.QueryInterface("CATI3DGeoVisu").GetOverride().setMaterial(null,!0),!0)},_refreshMIACMaterials:function(){const e=this.QueryInterface("CATI3DExperienceObject");if(!e.HasVariable("materialsRef"))return!1;const t=e.GetValueByName("materialsRef").filter((e=>e.QueryInterface("CATI3DXMaterialVisu").isMIACMaterial()));for(let e=0;e<t.length;e++){const n=t[e].QueryInterface("CATI3DXMaterialVisu");n.isMiacVisuInitialized()||n.initializeMIACVisu()}if(this._previousMiacMaterials)for(let e=0;e<this._previousMiacMaterials.length;e++)t.includes(this._previousMiacMaterials[e])||this._previousMiacMaterials[e].QueryInterface("CATI3DXMaterialVisu").disposeMIACVisu();return this._previousMiacMaterials=t,!1}});return i})),define("DS/CATCXPModel/extensions/CATEVPMReference3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu","DS/Visualization/Node3D"],(function(e,t,n){"use strict";return t.extend({init:function(){this._parent(),this._modelLoaded=!1},Dispose:function(){this._parent(),this._modelLoaded=!1,this._assetNode&&(this._assetNode.removeChildren(),this._assetNode=null)},_Fill:function(e){var t=this;this._parent(e),this.QueryInterface("CATI3DX3DActorAsset").getNode3D().catch((function(){let e=new n;return e.setMatrix(null),e})).then((function(n){t._assetNode=n,e.addChild(n),t.RequestVisuRefresh(),t._modelLoaded=!0,t.setReady(!0)}))},_refreshChildrenNodes:function(){this._parent();for(var t=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),n=0;n<t.length;n++){var r=t[n].QueryInterface("CATI3DGeoVisu");if(e.is(r)){var i=r.GetNode();this._node3D.addChild(i)}}},GetLocalNodes:function(){return this._assetNode},setReady:function(e){e!==this._ready&&(!e||this._isAllChildrenReady()&&this._modelLoaded)&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(let e=0;e<t.length;e++){let n=t[e].QueryInterface("CATI3DGeoVisu");if(n&&!n.isReady())return!1}}var n=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren();for(let e=0;e<n.length;e++){let t=n[e].QueryInterface("CATI3DGeoVisu");if(t&&!t.isReady())return!1}return!0}})})),define("DS/CATCXPModel/extensions/CATE3DX3DActorAssetMedia",["UWA/Core","UWA/Class","DS/CATCXPModel/extensions/CATE3DX3DActorAsset","DS/Visualization/Node3D","DS/CAT3DExpModel/XCTExpUint8ArrayAsset"],(function(e,t,n,r,i){"use strict";return n.extend({_getNode3DFromAsset:async function(t){if(!(t instanceof i))return e.Promise.reject(new Error("Cant retrieve node3D asset for object "+this.GetObject().GetID()));if(t.getName().endsWith(".glb")){const n=e.Promise.deferred(),r=t.getUint8Array(),i=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager");(await i.getGLTFLoader()).loadWithMaterialLibrary(r).then((e=>{n.resolve(e)}));return await n.promise}const n=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager"),s=await n.getModelLoader();s.setFileType(this._getFileType(t));const a=new r,o=e.Promise.deferred();return s.setOnLoadedProductStructureCallback((()=>{a.children[0].name=t.name,o.resolve(a)})),s.loadModelFromBuffer(t.getUint8Array(),a),await o.promise,a},_getFileType:function(e){const t=e.getName();for(let e in this._typeExtMap)if(t.endsWith(e))return this._typeExtMap[e]},_typeExtMap:{".cgr":"cgr",".xcgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"}})})),define("DS/CATCXPModel/extensions/CATE3DX3DActorOverrideAsset",["UWA/Core","UWA/Class","DS/CATCXPModel/extensions/CATE3DX3DActorAsset"],(function(e,t,n){"use strict";return n.extend({_clearActorAsset:function(){delete this._visuParent,this._parent()},getVisuParent:function(){if(!this._visuParent){var e=this.QueryInterface("CATI3DExperienceObject").GetParent();this._visuParent=this._findVisuParent(e),this._visuParent=this._visuParent?this._visuParent:e}return this._visuParent},getPositionInAssetContext:function(){return this.QueryInterface("CATI3DXAssetHolder")._getCache().PositionInAssetContext},getParentPositionInAssetContext:function(){return this.QueryInterface("CATI3DXAssetHolder")._getCache().ParentPositionInAssetContext},_getProduct:function(){return this.QueryInterface("CATI3DExperienceObject").GetParent()},_findVisuParent:function(e){if(e)for(var t=e.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),n=0;n<t.length;n++){if(this.GetObject()===t[n])return e;var r=this._findVisuParent(t[n]);if(r)return r}}})})),define("DS/CATCXPModel/extensions/CATE3DX3DActorOverrideAssetMedia",["UWA/Core","UWA/Class","DS/CATCXPModel/extensions/CATE3DX3DActorOverrideAsset","DS/CATCXPModel/extensions/CATE3DX3DActorAssetMedia"],(function(e,t,n,r){"use strict";return n.extend({_getNode3DFromAsset:r.prototype._getNode3DFromAsset,_getFileType:r.prototype._getFileType,_typeExtMap:r.prototype._typeExtMap})}));