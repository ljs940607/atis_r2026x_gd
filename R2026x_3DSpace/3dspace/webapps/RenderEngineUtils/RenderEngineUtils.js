define("DS/RenderEngineUtils/StateSortingCacheItem",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";let t=null;var i=function({dlIndex:i,material:r,geometry:s,dg:n,dgInterval:a,renderVolumesOnly:o,renderLineMode:l,geomDisposeFunc:d,materialToUse:u,matApp:p,gasMaterial:c,cpInfos:f=null}){this._inheritanceSolverCache={material:r,geometry:s,dg:n,dgInterval:a,geomDisposeFunc:d,materialToUse:u,matApp:p,gasMaterial:c,cpInfos:f},o&&r&&(r.isWideLine||r.is2DLine)&&(this._inheritanceSolverCache.material=null),this._drawCallCache={polygonOffset:null,sideFunc:null,sideHandler:null,noZ:!1,updateLineInfos:!1,isFace:!1,webgpu:!1},this.materialPack=null,this.object=null,this.dlIndex=i,this.resetFrameIndex=-1,this.applyPolygonOffsetOnFaces=l>0,null===t&&(t=e.GLTypeEnum)};return i.prototype.addDrawable=function(e){if(!this._inheritanceSolverCache.material||!this.materialPack)return!0;if(this.resetFrameIndex<this._inheritanceSolverCache.material._resetFrameIndex)return!1;const i=this.object;if(i.renderPointsOnly&&this._inheritanceSolverCache.dg.glType!==t.POINTS)return!0;var r={object:i,geometry:this._inheritanceSolverCache.geometry,dg:this._inheritanceSolverCache.dg,dgInterval:this._inheritanceSolverCache.dgInterval,matApp:this._inheritanceSolverCache.matApp,gasMaterial:this._inheritanceSolverCache.gasMaterial,cpInfos:this._inheritanceSolverCache.cpInfos,materialPack:this.materialPack,tokenCache:this._drawCallCache};return e.addDrawable(r),!0},i})),define("DS/RenderEngineUtils/WebGPUComputeInterface",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";class t{constructor(e,t,i){var r={label:"compute pipeline Layout",bindGroupLayouts:t};this.pipelineLayout=e.createPipelineLayout(r),this.shaderModule=e.createShaderModule({label:"Compute Shader Module",code:i});var s={layout:this.pipelineLayout,compute:{module:this.shaderModule,entryPoint:"compute_main"}};this.wgpuPipeline=e.createComputePipeline(s)}}class i{constructor(e){if(this._setShaderContent(e.shaderContent),this._setWorkgroupSize(e.workgroupSize),this.bindingGroupsDesc=[],e.bindingDescriptions)for(let t=0;t<e.bindingDescriptions.length;t++)this._addBindingDescription(e.bindingDescriptions[t])}_setShaderContent(e){this.shaderContent=e,this._resetPipeline()}_setWorkgroupSize(t){this.workgroupSize=t||new e.Vector3(1,1,1),this._resetPipeline()}_addBindingDescription(e){let t=e.group||0,i=this.bindingGroupsDesc[t];i||(i=[],this.bindingGroupsDesc[t]=i),i[i.length]=e,this._resetPipeline()}_resetPipeline(){this.shader=null,this.bindgroupLayouts=null,this.pipeline=null}_getBindGroupLayout(e){if(!this.bindgroupLayouts){let t=[];for(let i=0;i<this.bindingGroupsDesc.length;i++){let r={label:"compute bindgroup "+i,entries:[]},s=this.bindingGroupsDesc[i];for(let e=0;e<s.length;e++)r.entries.push({binding:e,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}});let n=e.createBindGroupLayout(r);t.push(n)}this.bindgroupLayouts=t}return this.bindgroupLayouts}_getFullShader(){if(!this.shader){let e="";for(let t=0;t<this.bindingGroupsDesc.length;t++){let i=this.bindingGroupsDesc[t];for(let r=0;r<i.length;r++){let s=i[r];e+=`@group(${t}) @binding(${r}) var<storage, read_write> ${s.name}: array<${s.atomic?"atomic<":""}${s.dataType?s.dataType:"f32"}${s.atomic?">":""}>;\n                        `}}this.shader=`enable subgroups;\n                ${e}\n\n                var <private> workgroup_size : vec3u;\n            \n                @compute @workgroup_size(${this.workgroupSize.x},${this.workgroupSize.y},${this.workgroupSize.z}) fn compute_main(\n                    @builtin(global_invocation_id) global_invocation_id: vec3u,\n                    @builtin(local_invocation_id) local_id: vec3u,\n                    @builtin(local_invocation_index) local_index: u32,\n                    @builtin(workgroup_id) workgroup_id: vec3u,\n                    @builtin(num_workgroups) num_workgroups: vec3u,\n                    @builtin(subgroup_invocation_id) subgroup_invocation_id: u32,\n                    @builtin(subgroup_size) subgroup_size: u32,\n                ) {\n                    workgroup_size = vec3u(${this.workgroupSize.x},${this.workgroupSize.y},${this.workgroupSize.z});\n                    ${this.shaderContent}\n                }\n                `}return this.shader}getPipeline(e){return this.pipeline||(this.pipeline=new t(e,this._getBindGroupLayout(e),this._getFullShader())),this.pipeline}}class r{constructor(t){this.shader=new i(t),this.bindings=new Map,this.bindgroups=null,this.workgroupCount=t.workgroupCount||new e.Vector3(1,1,1),this.callback=t.callback||null}setBinding(e,t){this.bindgroups=null,this.bindings.set(e,t)}setWorkgroupCount(t){this.workgroupCount=t||new e.Vector3(1,1,1)}getBindGroups(e){if(!this.bindgroups){this.bindgroups=[];let t=this.shader._getBindGroupLayout();for(let i=0;i<this.shader.bindingGroupsDesc.length;i++){let r=this.shader.bindingGroupsDesc[i],s=[];for(let e=0;e<r.length;e++){if(!this.bindings.get(r[e].name))return console.error(`Layout buffer ${r[e].name} does not have a buffer bound to it !`),null;s.push({binding:e,resource:{buffer:this.bindings.get(r[e].name)}})}let n=e.createBindGroup({layout:t[i],entries:s});this.bindgroups.push(n)}}return this.bindgroups}encodeCompute(e,t){t.setPipeline(this.shader.getPipeline(e).wgpuPipeline);let i=this.getBindGroups(e);for(let e=0;e<i.length;e++)t.setBindGroup(e,i[e]);t.dispatchWorkgroups(this.workgroupCount.x,this.workgroupCount.y,this.workgroupCount.z)}setCallback(e){this.callback=e}}class s{constructor(e,t){this.device=e,this.USAGES=GPUBufferUsage,this.useTimeStampQuery=t,t&&(this._querySet=this.device.createQuerySet({type:"timestamp",count:2})),this.passesInfos=new Map}_addPass(e,t){this.passesInfos.set(e,t)}_endCommandEncoder(e){let t=this.passesInfos.get(e);t.queryBuffer&&t.commandEncoder.resolveQuerySet(this._querySet,0,2,t.queryBuffer,0),t.endCommandEncoder&&(this.device.queue.submit([t.commandEncoder.finish()]),t.callback&&this.device.queue.onSubmittedWorkDone().then(t.callback)),t.queryBuffer&&this.getMappedCopyOfStorageBufferAsync(t.queryBuffer,BigInt64Array).then((function(e){console.log("compute done in "+(e[1]-e[0])+" ns")})),this.passesInfos.delete(e)}getPassEncoder(e,t,i){let r=null,s=!1;i||(s=!0,r=this.device.createCommandEncoder({label:e}),i=r);let n={label:e},a=null;this.useTimeStampQuery&&(n.timestampWrites={querySet:this._querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},a=this.device.createBuffer({size:16,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}));let o=i.beginComputePass(n);return this._addPass(o,{endCommandEncoder:s,commandEncoder:i,callback:t,queryBuffer:a}),[o,i]}endPassEncoder(e){e.end(),this._endCommandEncoder(e)}getEmptyStorageBuffer(e,t,i){return this.device.createBuffer({label:i||"compute buffer",size:t,usage:GPUBufferUsage.STORAGE|(e||GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)})}getStorageBuffer(e,t,i){let r=0;for(let e=0;e<t.length;e++)r+=t[e].byteLength;let s=this.getEmptyStorageBuffer(e,r,i),n=0;for(let e=0;e<t.length;e++)this.device.queue.writeBuffer(s,n,t[e]),n+=t[e].byteLength;return s}updateStorageBuffer(e,t,i){this.device.queue.writeBuffer(e,i||0,t)}copyfromStorageBufferToMappableBuffer(e,t){let i=this.device.createBuffer({label:"result buffer",size:e.size,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});if(t)t.copyBufferToBuffer(e,0,i,0,i.size);else{let t=this.device.createCommandEncoder({label:"read from storage command encoder"});t.copyBufferToBuffer(e,0,i,0,i.size),this.device.queue.submit([t.finish()])}return i}getMappedCopyOfStorageBufferAsync(e,t){let i=this;return t=t||Float32Array,new Promise((function(r,s){let n=i.copyfromStorageBufferToMappableBuffer(e);n.mapAsync(GPUMapMode.READ).then((function(){r(new t(n.getMappedRange()))}))}))}createComputeDescriptor(e){return new r(e)}simpleCreateBindGroup(e){let t={label:"simple compute bindgroup",entries:[]},i=[];for(let r=0;r<e.length;r++){let s=r;t.entries.push({binding:s,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}),i.push({binding:s,resource:{buffer:e[r]}})}let r=this.device.createBindGroupLayout(t);return[r,this.device.createBindGroup({layout:r,entries:i})]}simpleCompute(e,i,r){let s=this;return new Promise((function(n,a){let o=s.getPassEncoder(),l=[];for(let t=0;t<e.length;t++)l.push(s.getStorageBuffer(null,[e[t]]));let[d,u]=s.simpleCreateBindGroup(l),p=new t(s.device,[d],i);o.setPipeline(p.wgpuPipeline),o.setBindGroup(0,u),o.dispatchWorkgroups(r.x,r.y,r.z),s.endPassEncoder(o);let c=[],f=[];for(let e=0;e<l.length;e++){let t=s.copyfromStorageBufferToMappableBuffer(l[e]);c.push(t.mapAsync(GPUMapMode.READ)),f.push(t)}Promise.all(c).then((function(){let e=[];for(let t=0;t<f.length;t++)e.push(new Float32Array(f[t].getMappedRange()));n(e)}))}))}executeCompute(e,t){let i=this,[r,s]=i.getPassEncoder(e.label,e.callback,t);e.encodeCompute(i.device,r),i.endPassEncoder(r)}}function n(e,t){const i={x:t,y:1};if(t>e.limits.maxComputeWorkgroupsPerDimension){const e=Math.floor(Math.sqrt(t)),r=Math.ceil(t/e);i.x=e,i.y=r}return i}const a="\n\n@group(0) @binding(0) var<storage, read> inputKeys: array<u32>;\n@group(0) @binding(1) var<storage, read_write> outputKeys: array<u32>;\n@group(0) @binding(2) var<storage, read> local_prefix_sum: array<u32>;\n@group(0) @binding(3) var<storage, read> prefix_block_sum: array<u32>;\n@group(0) @binding(4) var<storage, read> inputValues: array<u32>;\n@group(0) @binding(5) var<storage, read_write> outputValues: array<u32>;\n\noverride WORKGROUP_COUNT: u32;\noverride THREADS_PER_WORKGROUP: u32;\noverride WORKGROUP_SIZE_X: u32;\noverride WORKGROUP_SIZE_Y: u32;\noverride CURRENT_BIT: u32;\noverride ELEMENT_COUNT: u32;\n\n@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)\nfn radix_sort_reorder(\n    @builtin(workgroup_id) w_id: vec3<u32>,\n    @builtin(num_workgroups) w_dim: vec3<u32>,\n    @builtin(local_invocation_index) TID: u32, // Local thread ID\n) { \n    let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;\n    let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;\n    let GID = WID + TID; // Global thread ID\n\n    if (GID >= ELEMENT_COUNT) {\n        return;\n    }\n\n    let k = inputKeys[GID];\n    let v = inputValues[GID];\n\n    let local_prefix = local_prefix_sum[GID];\n\n    // Calculate new position\n    let extract_bits = (k >> CURRENT_BIT) & 0x3;\n    let pid = extract_bits * WORKGROUP_COUNT + WORKGROUP_ID;\n    let sorted_position = prefix_block_sum[pid] + local_prefix;\n    \n    outputKeys[sorted_position] = k;\n    outputValues[sorted_position] = v;\n}";class o{constructor({device:e,data:t,count:i,workgroup_size:r={x:16,y:16}}){if(this.device=e,this.workgroup_size=r,this.threads_per_workgroup=r.x*r.y,this.items_per_workgroup=2*this.threads_per_workgroup,Math.log2(this.threads_per_workgroup)%1!=0)throw new Error(`workgroup_size.x * workgroup_size.y must be a power of two. (current: ${this.threads_per_workgroup})`);this.pipelines=[],this.shaderModule=this.device.createShaderModule({label:"prefix-sum",code:"\n@group(0) @binding(0) var<storage, read_write> items: array<u32>;\n@group(0) @binding(1) var<storage, read_write> blockSums: array<u32>;\n\noverride WORKGROUP_SIZE_X: u32;\noverride WORKGROUP_SIZE_Y: u32;\noverride THREADS_PER_WORKGROUP: u32;\noverride ITEMS_PER_WORKGROUP: u32;\noverride ELEMENT_COUNT: u32;\n\nvar<workgroup> temp: array<u32, ITEMS_PER_WORKGROUP*2>;\n\n@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)\nfn reduce_downsweep(\n    @builtin(workgroup_id) w_id: vec3<u32>,\n    @builtin(num_workgroups) w_dim: vec3<u32>,\n    @builtin(local_invocation_index) TID: u32, // Local thread ID\n) {\n    let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;\n    let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;\n    let GID = WID + TID; // Global thread ID\n    \n    let ELM_TID = TID * 2; // Element pair local ID\n    let ELM_GID = GID * 2; // Element pair global ID\n    \n    // Load input to shared memory\n    temp[ELM_TID]     = select(items[ELM_GID], 0, ELM_GID >= ELEMENT_COUNT);\n    temp[ELM_TID + 1] = select(items[ELM_GID + 1], 0, ELM_GID + 1 >= ELEMENT_COUNT);\n\n    var offset: u32 = 1;\n\n    // Up-sweep (reduce) phase\n    for (var d: u32 = ITEMS_PER_WORKGROUP >> 1; d > 0; d >>= 1) {\n        workgroupBarrier();\n\n        if (TID < d) {\n            var ai: u32 = offset * (ELM_TID + 1) - 1;\n            var bi: u32 = offset * (ELM_TID + 2) - 1;\n            temp[bi] += temp[ai];\n        }\n\n        offset *= 2;\n    }\n\n    // Save workgroup sum and clear last element\n    if (TID == 0) {\n        let last_offset = ITEMS_PER_WORKGROUP - 1;\n\n        blockSums[WORKGROUP_ID] = temp[last_offset];\n        temp[last_offset] = 0;\n    }\n\n    // Down-sweep phase\n    for (var d: u32 = 1; d < ITEMS_PER_WORKGROUP; d *= 2) {\n        offset >>= 1;\n        workgroupBarrier();\n\n        if (TID < d) {\n            var ai: u32 = offset * (ELM_TID + 1) - 1;\n            var bi: u32 = offset * (ELM_TID + 2) - 1;\n\n            let t: u32 = temp[ai];\n            temp[ai] = temp[bi];\n            temp[bi] += t;\n        }\n    }\n    workgroupBarrier();\n\n    // Copy result from shared memory to global memory\n    if (ELM_GID >= ELEMENT_COUNT) {\n        return;\n    }\n    items[ELM_GID] = temp[ELM_TID];\n\n    if (ELM_GID + 1 >= ELEMENT_COUNT) {\n        return;\n    }\n    items[ELM_GID + 1] = temp[ELM_TID + 1];\n}\n\n@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)\nfn add_block_sums(\n    @builtin(workgroup_id) w_id: vec3<u32>,\n    @builtin(num_workgroups) w_dim: vec3<u32>,\n    @builtin(local_invocation_index) TID: u32, // Local thread ID\n) {\n    let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;\n    let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;\n    let GID = WID + TID; // Global thread ID\n\n    let ELM_ID = GID * 2;\n\n    if (ELM_ID >= ELEMENT_COUNT) {\n        return;\n    }\n\n    let blockSum = blockSums[WORKGROUP_ID];\n\n    items[ELM_ID] += blockSum;\n\n    if (ELM_ID + 1 >= ELEMENT_COUNT) {\n        return;\n    }\n\n    items[ELM_ID + 1] += blockSum;\n}"}),this.create_pass_recursive(t,i)}create_pass_recursive(e,t){const i=Math.ceil(t/this.items_per_workgroup),r=n(this.device,i),s=this.device.createBuffer({label:"prefix-sum-block-sum",size:4*i,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),a=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),o=this.device.createBindGroup({label:"prefix-sum-bind-group",layout:a,entries:[{binding:0,resource:{buffer:e}},{binding:1,resource:{buffer:s}}]}),l=this.device.createPipelineLayout({bindGroupLayouts:[a]}),d=this.device.createComputePipeline({label:"prefix-sum-scan-pipeline",layout:l,compute:{module:this.shaderModule,entryPoint:"reduce_downsweep",constants:{WORKGROUP_SIZE_X:this.workgroup_size.x,WORKGROUP_SIZE_Y:this.workgroup_size.y,THREADS_PER_WORKGROUP:this.threads_per_workgroup,ITEMS_PER_WORKGROUP:this.items_per_workgroup,ELEMENT_COUNT:t}}});if(this.pipelines.push({pipeline:d,bindGroup:o,dispatchSize:r}),i>1){this.create_pass_recursive(s,i);const e=this.device.createComputePipeline({label:"prefix-sum-add-block-pipeline",layout:l,compute:{module:this.shaderModule,entryPoint:"add_block_sums",constants:{WORKGROUP_SIZE_X:this.workgroup_size.x,WORKGROUP_SIZE_Y:this.workgroup_size.y,THREADS_PER_WORKGROUP:this.threads_per_workgroup,ELEMENT_COUNT:t}}});this.pipelines.push({pipeline:e,bindGroup:o,dispatchSize:r})}}get_dispatch_chain(){return this.pipelines.flatMap((e=>[e.dispatchSize.x,e.dispatchSize.y,1]))}dispatch(e,t,i=0){for(let r=0;r<this.pipelines.length;r++){const{pipeline:s,bindGroup:n,dispatchSize:a}=this.pipelines[r];e.setPipeline(s),e.setBindGroup(0,n),null==t?e.dispatchWorkgroups(a.x,a.y,1):e.dispatchWorkgroupsIndirect(t,i+3*r*4)}}}class l{constructor({device:e,keys:t,values:i,count:r,bit_count:s=32,workgroup_size:n={x:16,y:16},local_shuffle:a=!1}={}){if(null==e)throw new Error("No device provided");if(null==t)throw new Error("No keys buffer provided");if(!Number.isInteger(r)||r<=0)throw new Error("Invalid count parameter");if(!Number.isInteger(s)||s<=0||s>32)throw new Error(`Invalid bit_count parameter: ${s}`);if(!Number.isInteger(n.x)||!Number.isInteger(n.y))throw new Error("Invalid workgroup_size parameter");if(s%4!=0)throw new Error("bit_count must be a multiple of 4");this.device=e,this.count=r,this.bit_count=s,this.workgroup_size=n,this.local_shuffle=a,this.threads_per_workgroup=n.x*n.y,this.workgroup_count=Math.ceil(r/this.threads_per_workgroup),this.prefix_block_workgroup_count=4*this.workgroup_count,this.has_values=null!=i,this.dispatchSize={},this.shaderModules={},this.kernels={},this.pipelines=[],this.buffers={keys:t,values:i},this.create_shader_modules(),this.create_pipelines()}create_shader_modules(){const e=function(e){return e.split("\n").filter((e=>!e.toLowerCase().includes("values"))).join("\n")},t=this.local_shuffle?radixSortSource_LocalShuffle:"\n\n@group(0) @binding(0) var<storage, read> input: array<u32>;\n@group(0) @binding(1) var<storage, read_write> local_prefix_sums: array<u32>;\n@group(0) @binding(2) var<storage, read_write> block_sums: array<u32>;\n\noverride WORKGROUP_COUNT: u32;\noverride THREADS_PER_WORKGROUP: u32;\noverride WORKGROUP_SIZE_X: u32;\noverride WORKGROUP_SIZE_Y: u32;\noverride CURRENT_BIT: u32;\noverride ELEMENT_COUNT: u32;\n\nvar<workgroup> s_prefix_sum: array<u32, 2 * (THREADS_PER_WORKGROUP + 1)>;\n\n@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)\nfn radix_sort(\n    @builtin(workgroup_id) w_id: vec3<u32>,\n    @builtin(num_workgroups) w_dim: vec3<u32>,\n    @builtin(local_invocation_index) TID: u32, // Local thread ID\n) {\n    let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;\n    let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;\n    let GID = WID + TID; // Global thread ID\n\n    // Extract 2 bits from the input\n    let elm = select(input[GID], 0, GID >= ELEMENT_COUNT);\n    let extract_bits: u32 = (elm >> CURRENT_BIT) & 0x3;\n\n    var bit_prefix_sums = array<u32, 4>(0, 0, 0, 0);\n\n    // If the workgroup is inactive, prevent block_sums buffer update\n    var LAST_THREAD: u32 = 0xffffffff; \n\n    if (WORKGROUP_ID < WORKGROUP_COUNT) {\n        // Otherwise store the index of the last active thread in the workgroup\n        LAST_THREAD = min(THREADS_PER_WORKGROUP, ELEMENT_COUNT - WID) - 1;\n    }\n\n    // Initialize parameters for double-buffering\n    let TPW = THREADS_PER_WORKGROUP + 1;\n    var swapOffset: u32 = 0;\n    var inOffset:  u32 = TID;\n    var outOffset: u32 = TID + TPW;\n\n    // 4-way prefix sum\n    for (var b: u32 = 0; b < 4; b++) {\n        // Initialize local prefix with bitmask\n        let bitmask = select(0u, 1u, extract_bits == b);\n        s_prefix_sum[inOffset + 1] = bitmask;\n        workgroupBarrier();\n\n        var prefix_sum: u32 = 0;\n\n        // Prefix sum\n        for (var offset: u32 = 1; offset < THREADS_PER_WORKGROUP; offset *= 2) {\n            if (TID >= offset) {\n                prefix_sum = s_prefix_sum[inOffset] + s_prefix_sum[inOffset - offset];\n            } else {\n                prefix_sum = s_prefix_sum[inOffset];\n            }\n\n            s_prefix_sum[outOffset] = prefix_sum;\n            \n            // Swap buffers\n            outOffset = inOffset;\n            swapOffset = TPW - swapOffset;\n            inOffset = TID + swapOffset;\n            \n            workgroupBarrier();\n        }\n\n        // Store prefix sum for current bit\n        bit_prefix_sums[b] = prefix_sum;\n\n        if (TID == LAST_THREAD) {\n            // Store block sum to global memory\n            let total_sum: u32 = prefix_sum + bitmask;\n            block_sums[b * WORKGROUP_COUNT + WORKGROUP_ID] = total_sum;\n        }\n\n        // Swap buffers\n        outOffset = inOffset;\n        swapOffset = TPW - swapOffset;\n        inOffset = TID + swapOffset;\n    }\n\n    if (GID < ELEMENT_COUNT) {\n        // Store local prefix sum to global memory\n        local_prefix_sums[GID] = bit_prefix_sums[extract_bits];\n    }\n}";this.shaderModules={blockSum:this.device.createShaderModule({label:"radix-sort-block-sum",code:this.has_values?t:e(t)}),reorder:this.device.createShaderModule({label:"radix-sort-reorder",code:this.has_values?a:e(a)})}}create_pipelines(){this.create_prefix_sum_kernel(),this.calculate_dispatch_sizes(),this.create_buffers();for(let e=0;e<this.bit_count;e+=2){const t=e%4==0,i=t?this.buffers.keys:this.buffers.tmpKeys,r=t?this.buffers.values:this.buffers.tmpValues,s=t?this.buffers.tmpKeys:this.buffers.keys,n=t?this.buffers.tmpValues:this.buffers.values,a=this.create_block_sum_pipeline(i,r,e),o=this.create_reorder_pipeline(i,r,s,n,e);this.pipelines.push({blockSumPipeline:a,reorderPipeline:o})}}create_prefix_sum_kernel(){const e=this.device.createBuffer({label:"radix-sort-prefix-block-sum",size:4*this.prefix_block_workgroup_count,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),t=new o({device:this.device,data:e,count:this.prefix_block_workgroup_count,workgroup_size:this.workgroup_size});this.kernels.prefixSum=t,this.buffers.prefixBlockSum=e}calculate_dispatch_sizes(){const e=n(this.device,this.workgroup_count),t=this.kernels.prefixSum.get_dispatch_chain(),i=[e.x,e.y,1,...t];this.dispatchOffsets={radix_sort:0,prefix_sum:24},this.dispatchSize=e,this.initialDispatch=i}create_buffers(){const e=this.device.createBuffer({label:"radix-sort-tmp-keys",size:4*this.count,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),t=this.has_values?this.device.createBuffer({label:"radix-sort-tmp-values",size:4*this.count,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}):null,i=this.device.createBuffer({label:"radix-sort-local-prefix-sum",size:4*this.count,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST});this.buffers.tmpKeys=e,this.buffers.tmpValues=t,this.buffers.localPrefixSum=i}create_block_sum_pipeline(e,t,i){const r=this.device.createBindGroupLayout({label:"radix-sort-block-sum",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:this.local_shuffle?"storage":"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},...this.local_shuffle&&this.has_values?[{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]:[]]}),s=this.device.createBindGroup({layout:r,entries:[{binding:0,resource:{buffer:e}},{binding:1,resource:{buffer:this.buffers.localPrefixSum}},{binding:2,resource:{buffer:this.buffers.prefixBlockSum}},...this.local_shuffle&&this.has_values?[{binding:3,resource:{buffer:t}}]:[]]}),n=this.device.createPipelineLayout({bindGroupLayouts:[r]});return{pipeline:this.device.createComputePipeline({label:"radix-sort-block-sum",layout:n,compute:{module:this.shaderModules.blockSum,entryPoint:"radix_sort",constants:{WORKGROUP_SIZE_X:this.workgroup_size.x,WORKGROUP_SIZE_Y:this.workgroup_size.y,WORKGROUP_COUNT:this.workgroup_count,THREADS_PER_WORKGROUP:this.threads_per_workgroup,ELEMENT_COUNT:this.count,CURRENT_BIT:i}}}),bindGroup:s}}create_reorder_pipeline(e,t,i,r,s){const n=this.device.createBindGroupLayout({label:"radix-sort-reorder",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},...this.has_values?[{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]:[]]}),a=this.device.createBindGroup({layout:n,entries:[{binding:0,resource:{buffer:e}},{binding:1,resource:{buffer:i}},{binding:2,resource:{buffer:this.buffers.localPrefixSum}},{binding:3,resource:{buffer:this.buffers.prefixBlockSum}},...this.has_values?[{binding:4,resource:{buffer:t}},{binding:5,resource:{buffer:r}}]:[]]}),o=this.device.createPipelineLayout({bindGroupLayouts:[n]});return{pipeline:this.device.createComputePipeline({label:"radix-sort-reorder",layout:o,compute:{module:this.shaderModules.reorder,entryPoint:"radix_sort_reorder",constants:{WORKGROUP_SIZE_X:this.workgroup_size.x,WORKGROUP_SIZE_Y:this.workgroup_size.y,WORKGROUP_COUNT:this.workgroup_count,THREADS_PER_WORKGROUP:this.threads_per_workgroup,ELEMENT_COUNT:this.count,CURRENT_BIT:s}}}),bindGroup:a}}dispatch(e){this.#e(e)}#e(e){for(let t=0;t<this.bit_count/2;t++){const{blockSumPipeline:i,reorderPipeline:r}=this.pipelines[t];e.setPipeline(i.pipeline),e.setBindGroup(0,i.bindGroup),e.dispatchWorkgroups(this.dispatchSize.x,this.dispatchSize.y,1),this.kernels.prefixSum.dispatch(e),e.setPipeline(r.pipeline),e.setBindGroup(0,r.bindGroup),e.dispatchWorkgroups(this.dispatchSize.x,this.dispatchSize.y,1)}}}return s.PrefixSumKernel=o,s.RadixSortKernel=l,s.sortSplatIndexKernel=class{constructor({device:e,positionsTextureSize:t,positionsDataTexture:i,indices:r,count:s}={}){if(null==e)throw new Error("No device provided");if(null==t)throw new Error("No positions texture size provided");if(null==i)throw new Error("No positions DataTexture provided");if(null==r)throw new Error("No splat index buffer provided");if(!Number.isInteger(s)||s<=0)throw new Error("Invalid count parameter");this.device=e,this.count=s,this.positionsTextureSize=t,this.positionsDataTexture=i,this.indices=r,this.workgroup_size={x:16,y:16},this.threads_per_workgroup=this.workgroup_size.x*this.workgroup_size.y,this.workgroup_count=Math.ceil(s/this.threads_per_workgroup),this.dispatchSize=n(this.device,this.workgroup_count),this.shaderModule=this.device.createShaderModule({label:"map-positions-keys",code:"\nstruct Uniforms {\n    model_matrix: mat4x4<f32>,\n    view_projection_matrix: mat4x4<f32>,\n    centersTextureSize : vec2f,\n}\n@group(0) @binding(0) var<uniform> uniforms: Uniforms;\n@group(0) @binding(1) var centersRGTextureSampler: sampler;\n@group(0) @binding(2) var centersRGTexture: texture_2d<u32>;\n@group(0) @binding(3) var<storage, read_write> keys: array<u32>;\n@group(0) @binding(4) var<storage, read_write> values: array<u32>;\n\noverride THREADS_PER_WORKGROUP: u32;\noverride WORKGROUP_SIZE_X: u32;\noverride WORKGROUP_SIZE_Y: u32;\noverride ELEMENT_COUNT: u32;\n\nfn getDataUV(index: u32, stride: u32, offset: u32, dimensions: vec2u) -> vec2u {\nvar d: u32 = (index * stride + offset);\nvar samplerUV: vec2u = vec2u(d % dimensions.x, d / dimensions.x);\nreturn samplerUV;\n}\n\n@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_X, 1)\nfn map_positions_keys(\n    @builtin(workgroup_id) w_id: vec3<u32>,\n    @builtin(num_workgroups) w_dim: vec3<u32>,\n    @builtin(local_invocation_index) TID: u32, // Local thread ID\n) { \n    let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;\n    let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;\n    let GID = WID + TID; // Global thread ID\n\n    if (GID >= ELEMENT_COUNT) {\n        return;\n    }\n\n    var centersRG: vec4u = textureLoad(centersRGTexture, getDataUV(GID, 1, 0, vec2u(uniforms.centersTextureSize)), 0);\n    var pos = vec4(bitcast<vec3f>(centersRG.xyz), 1.0);\n    var world_pos: vec4f = uniforms.model_matrix * pos;\n    var homogenous_pos: vec4f = uniforms.view_projection_matrix * world_pos;\n    var clipSpacePos: vec4f = vec4(homogenous_pos.xyz, 1.0) / (homogenous_pos.w + 0.0000001);\n    // var key: u32 = 0xFFFFFFFFu;\n    // We don't do compute culling since we don't use indirect Draw\n    // if (isInFrustum(clipSpacePos.xyz)) {\n    // Vec3 to sortable u32\n    var key = u32(0xFFFFFFFF.0 - clipSpacePos.z * 0xFFFFFFFF.0);\n    // key |= u32(clipSpacePos.x * 0xFF.0) << 8u;\n    // key |= u32(clipSpacePos.y * 0xFF.0);\n    // }\n    keys[GID] = key;\n    // Reset indices to prevent double-sorting\n    values[GID] = GID;\n}"}),this.create_radixSort_kernel(),this.createPipeline()}create_radixSort_kernel(){this.keyStorage=this.device.createBuffer({label:"radix sort key buffer",size:this.count*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE}),this.radixSortKernel=new l({device:this.device,keys:this.keyStorage,values:this.indices,count:this.count})}createPipeline(){this.bindGroupLayout=this.device.createBindGroupLayout({label:"sortSplatIndex bindGroupLayout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,sampler:{type:"filtering"}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"uint",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]});let t=16*Float32Array.BYTES_PER_ELEMENT+16*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT;this.uniformValues=new Float32Array(t/Float32Array.BYTES_PER_ELEMENT),this.viewProj=new e.Matrix4,this.ubo=this.device.createBuffer({label:"map-positions-key-ubo",size:t,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST});const i=this.device.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayout]}),r=this.device.createComputePipeline({label:"map-positions-keys-pipeline",layout:i,compute:{module:this.shaderModule,entryPoint:"map_positions_keys",constants:{WORKGROUP_SIZE_X:this.workgroup_size.x,WORKGROUP_SIZE_Y:this.workgroup_size.y,THREADS_PER_WORKGROUP:this.threads_per_workgroup,ELEMENT_COUNT:this.count}}});this.pipeline={mapPipeline:r,bindGroup:null}}updateUniformBuffer(e,t,i){this.uniformValues.set(e.elements,0),this.viewProj.multiplyMatrices(i,t),this.uniformValues.set(this.viewProj.elements,16),this.uniformValues.set([this.positionsTextureSize.x,this.positionsTextureSize.y],32),this.device.queue.writeBuffer(this.ubo,0,this.uniformValues)}dispatch(e){let{mapPipeline:t,bindGroup:i}=this.pipeline;null===i&&null!==this.positionsDataTexture._wgpuTexture&&(this.pipeline.bindGroup=this.device.createBindGroup({label:"map-positions-key-bind-group",layout:this.bindGroupLayout,entries:[{binding:0,resource:{buffer:this.ubo}},{binding:1,sampler:this.positionsDataTexture._wgpuTexture._sampler,resource:this.positionsDataTexture._wgpuSampler},{binding:2,texture:this.positionsDataTexture._wgpuTexture._texture,resource:this.positionsDataTexture._wgpuTexture.textureView},{binding:3,resource:{buffer:this.keyStorage}},{binding:4,resource:{buffer:this.indices}}]}),i=this.pipeline.bindGroup),null!==i&&(e.setPipeline(t),e.setBindGroup(0,i),e.dispatchWorkgroups(this.dispatchSize.x,this.dispatchSize.y,1),this.radixSortKernel.dispatch(e))}},s})),define("DS/RenderEngineUtils/BufferUtils",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";var t=new e.Matrix4;function i(e){for(var t in e.attributes)if(e.attributes[t].needsUpdate)return!0;return!1}function r(e){for(var t in e.attributes)e.attributes[t].needsUpdate=!1}function s(t){return function(t){return t&&void 0!==t.shading&&t.shading===e.SmoothShading}(t)?e.SmoothShading:e.FlatShading}function n(e){return!!e.vertexColors&&e.vertexColors}function a(e){return!!(e.map||e.bumpMap||e.normalMap||e.specularMap||e._isDeprecatedMaterial)}function o(t,i){return t.material instanceof e.MeshFaceMaterial?t.material.materials[i.materialIndex]:t.material}function l(e,t){var i,r,l=t.geometry,d=e.faces3,u=e.faces4,p=3*d.length+4*u.length,c=1*d.length+2*u.length,f=3*d.length+4*u.length,h=o(t,e),g=a(h),_=s(h),y=n(h);if(e.__vertexArray=new Float32Array(3*p),_&&(e.__normalArray=new Float32Array(3*p)),l.hasTangents&&(e.__tangentArray=new Float32Array(4*p)),y&&(e.__colorArray=new Float32Array(3*p)),g&&((l.faceUvs.length>0||l.faceVertexUvs.length>0)&&(e.__uvArray=new Float32Array(2*p)),(l.faceUvs.length>1||l.faceVertexUvs.length>1)&&(e.__uv2Array=new Float32Array(2*p))),t.geometry.skinWeights.length&&t.geometry.skinIndices.length&&(e.__skinIndexArray=new Float32Array(4*p),e.__skinWeightArray=new Float32Array(4*p)),e.__faceArray=new Uint16Array(3*c),e.__lineArray=new Uint16Array(2*f),e.numMorphTargets)for(e.__morphTargetsArrays=[],i=0,r=e.numMorphTargets;i<r;i++)e.__morphTargetsArrays.push(new Float32Array(3*p));if(e.numMorphNormals)for(e.__morphNormalsArrays=[],i=0,r=e.numMorphNormals;i<r;i++)e.__morphNormalsArrays.push(new Float32Array(3*p));e.__webglFaceCount=3*c,e.__webglLineCount=2*f,e.__inittedArrays=!0}return function(d){var u=d,p=null,c=null;function f(e){var t,i;if(p.deleteBuffer(e.__webglVertexBuffer),p.deleteBuffer(e.__webglNormalBuffer),p.deleteBuffer(e.__webglTangentBuffer),p.deleteBuffer(e.__webglColorBuffer),p.deleteBuffer(e.__webglUVBuffer),p.deleteBuffer(e.__webglUV2Buffer),p.deleteBuffer(e.__webglSkinIndicesBuffer),p.deleteBuffer(e.__webglSkinWeightsBuffer),p.deleteBuffer(e.__webglFaceBuffer),p.deleteBuffer(e.__webglLineBuffer),e.numMorphTargets)for(t=0,i=e.numMorphTargets;t<i;t++)p.deleteBuffer(e.__webglMorphTargetsBuffers[t]);if(e.numMorphNormals)for(t=0,i=e.numMorphNormals;t<i;t++)p.deleteBuffer(e.__webglMorphNormalsBuffers[t]);c.geometries--}this.setInfo=function(e){c=e},this.setContext=function(e){p=e},this.dispose=function(){u=null};var h=function(e){var t=e.target;t.removeEventListener("dispose",h),function(e){if(e.__webglInit=void 0,void 0!==e.__webglVertexBuffer&&p.deleteBuffer(e.__webglVertexBuffer),void 0!==e.__webglNormalBuffer&&p.deleteBuffer(e.__webglNormalBuffer),void 0!==e.__webglTangentBuffer&&p.deleteBuffer(e.__webglTangentBuffer),void 0!==e.__webglColorBuffer&&p.deleteBuffer(e.__webglColorBuffer),void 0!==e.__webglUVBuffer&&p.deleteBuffer(e.__webglUVBuffer),void 0!==e.__webglUV2Buffer&&p.deleteBuffer(e.__webglUV2Buffer),void 0!==e.__webglTangentBuffer&&p.deleteBuffer(e.__webglTangentBuffer),void 0!==e.__webglBinormalBuffer&&p.deleteBuffer(e.__webglBinormalBuffer),void 0!==e.__webglSkinIndicesBuffer&&p.deleteBuffer(e.__webglSkinIndicesBuffer),void 0!==e.__webglSkinWeightsBuffer&&p.deleteBuffer(e.__webglSkinWeightsBuffer),void 0!==e.__webglFaceBuffer&&p.deleteBuffer(e.__webglFaceBuffer),void 0!==e.__webglLineBuffer&&p.deleteBuffer(e.__webglLineBuffer),void 0!==e.__webglLineDistanceBuffer&&p.deleteBuffer(e.__webglLineDistanceBuffer),void 0!==e.geometryGroups)for(var t in e.geometryGroups)f(e.geometryGroups[t])}(t),u&&c.geometries--};function g(t,s){var n,a,d,u=t.geometry;if(u)if(1===u._type);else if(2===u._type||u.length>=0);else if(t instanceof e.Mesh){for(var c=0,f=u.geometryGroupsList.length;c<f;c++)n=u.geometryGroupsList[c],d=s||o(t,n),u.buffersNeedUpdate&&l(n,t),a=d.attributes&&i(d),(u.verticesNeedUpdate||u.morphTargetsNeedUpdate||u.elementsNeedUpdate||u.uvsNeedUpdate||u.normalsNeedUpdate||u.colorsNeedUpdate||u.tangentsNeedUpdate||a)&&m(n,t,p.DYNAMIC_DRAW,!u.dynamic,d);u.verticesNeedUpdate=!1,u.morphTargetsNeedUpdate=!1,u.elementsNeedUpdate=!1,u.uvsNeedUpdate=!1,u.normalsNeedUpdate=!1,u.colorsNeedUpdate=!1,u.tangentsNeedUpdate=!1,u.buffersNeedUpdate=!1,d.attributes&&r(d)}else t instanceof e.Line?(a=(d=o(t,u)).attributes&&i(d),(u.verticesNeedUpdate||u.colorsNeedUpdate||u.lineDistancesNeedUpdate||a)&&function(e,t){var i,r,s,n,a,o,l=e.vertices,d=e.colors,u=e.lineDistances,c=l.length,f=d.length,h=u.length,g=e.__vertexArray,_=e.__colorArray,y=e.__lineDistanceArray,m=e.verticesNeedUpdate,S=e.colorsNeedUpdate,b=e.lineDistancesNeedUpdate;e.__webglCustomAttributesList;if(m){for(i=0;i<c;i++)n=l[i],g[a=3*i]=n.x,g[a+1]=n.y,g[a+2]=n.z;p.bindBuffer(p.ARRAY_BUFFER,e.__webglVertexBuffer),p.bufferData(p.ARRAY_BUFFER,g,t)}if(S){for(r=0;r<f;r++)o=d[r],_[a=3*r]=o.r,_[a+1]=o.g,_[a+2]=o.b;p.bindBuffer(p.ARRAY_BUFFER,e.__webglColorBuffer),p.bufferData(p.ARRAY_BUFFER,_,t)}if(b){for(s=0;s<h;s++)y[s]=u[s];p.bindBuffer(p.ARRAY_BUFFER,e.__webglLineDistanceBuffer),p.bufferData(p.ARRAY_BUFFER,y,t)}}(u,p.DYNAMIC_DRAW),u.verticesNeedUpdate=!1,u.colorsNeedUpdate=!1,u.lineDistancesNeedUpdate=!1,d.attributes&&r(d)):t instanceof e.ParticleSystem&&(a=(d=o(t,u)).attributes&&i(d),(u.verticesNeedUpdate||u.colorsNeedUpdate||t.sortParticles||a)&&y(u,p.DYNAMIC_DRAW,t),u.verticesNeedUpdate=!1,u.colorsNeedUpdate=!1,d.attributes&&r(d))}function _(e){var t,i;if(e.__webglVertexBuffer=p.createBuffer(),e.__webglNormalBuffer=p.createBuffer(),e.__webglTangentBuffer=p.createBuffer(),e.__webglColorBuffer=p.createBuffer(),e.__webglUVBuffer=p.createBuffer(),e.__webglUV2Buffer=p.createBuffer(),e.__webglSkinIndicesBuffer=p.createBuffer(),e.__webglSkinWeightsBuffer=p.createBuffer(),e.__webglFaceBuffer=p.createBuffer(),e.__webglLineBuffer=p.createBuffer(),e.numMorphTargets)for(e.__webglMorphTargetsBuffers=[],t=0,i=e.numMorphTargets;t<i;t++)e.__webglMorphTargetsBuffers.push(p.createBuffer());if(e.numMorphNormals)for(e.__webglMorphNormalsBuffers=[],t=0,i=e.numMorphNormals;t<i;t++)e.__webglMorphNormalsBuffers.push(p.createBuffer());c.geometries++}function y(e,i,r){var s,n,a,o,l,d=e.vertices,u=d.length,c=e.colors,f=c.length,h=e.__vertexArray,g=e.__colorArray,_=e.__sortArray,y=e.verticesNeedUpdate,m=(e.elementsNeedUpdate,e.colorsNeedUpdate);e.__webglCustomAttributesList;if(r.sortParticles){for(t.copy(_projScreenMatrix),t.multiply(r.matrixWorld),s=0;s<u;s++)a=d[s],_vector3.copy(a),_vector3.applyProjection(t),_[s]=[_vector3.z,s];for(_.sort(numericalSort),s=0;s<u;s++)a=d[_[s][1]],h[o=3*s]=a.x,h[o+1]=a.y,h[o+2]=a.z;for(n=0;n<f;n++)o=3*n,l=c[_[n][1]],g[o]=l.r,g[o+1]=l.g,g[o+2]=l.b}else{if(y)for(s=0;s<u;s++)a=d[s],h[o=3*s]=a.x,h[o+1]=a.y,h[o+2]=a.z;if(m)for(n=0;n<f;n++)l=c[n],g[o=3*n]=l.r,g[o+1]=l.g,g[o+2]=l.b}(y||r.sortParticles)&&(p.bindBuffer(p.ARRAY_BUFFER,e.__webglVertexBuffer),p.bufferData(p.ARRAY_BUFFER,h,i)),(m||r.sortParticles)&&(p.bindBuffer(p.ARRAY_BUFFER,e.__webglColorBuffer),p.bufferData(p.ARRAY_BUFFER,g,i))}function m(t,i,r,o,l){if(t.__inittedArrays){var d,u,c,f,h,g,_,y,m,S,b,P,E,v,D,w,R,O,L,T,I,M,U,x,B=s(l),G=n(l),A=a(l),C=B===e.SmoothShading,k=0,F=0,N=0,W=0,z=0,V=0,j=0,K=0,Y=t.__vertexArray,H=t.__uvArray,Z=t.__normalArray,$=t.__tangentArray,X=t.__colorArray,q=t.__faceArray,Q=t.__lineArray,J=i.geometry,ee=J.verticesNeedUpdate,te=J.elementsNeedUpdate,ie=J.uvsNeedUpdate,re=J.normalsNeedUpdate,se=J.tangentsNeedUpdate,ne=J.colorsNeedUpdate,ae=J.vertices,oe=t.faces3,le=t.faces4,de=J.faces,ue=J.faceVertexUvs[0];if(ee){for(d=0,u=oe.length;d<u;d++)S=ae[(c=de[oe[d]]).a],b=ae[c.b],P=ae[c.c],Y[F]=S.x,Y[F+1]=S.y,Y[F+2]=S.z,Y[F+3]=b.x,Y[F+4]=b.y,Y[F+5]=b.z,Y[F+6]=P.x,Y[F+7]=P.y,Y[F+8]=P.z,F+=9;for(d=0,u=le.length;d<u;d++)S=ae[(c=de[le[d]]).a],b=ae[c.b],P=ae[c.c],E=ae[c.d],Y[F]=S.x,Y[F+1]=S.y,Y[F+2]=S.z,Y[F+3]=b.x,Y[F+4]=b.y,Y[F+5]=b.z,Y[F+6]=P.x,Y[F+7]=P.y,Y[F+8]=P.z,Y[F+9]=E.x,Y[F+10]=E.y,Y[F+11]=E.z,F+=12;p.bindBuffer(p.ARRAY_BUFFER,t.__webglVertexBuffer),p.bufferData(p.ARRAY_BUFFER,Y,r)}if(ne&&G){for(d=0,u=oe.length;d<u;d++)g=(c=de[oe[d]]).vertexColors,_=c.color,3===g.length&&G===e.VertexColorType.RGBA?(O=g[0],L=g[1],T=g[2]):(O=_,L=_,T=_),X[K]=O.r,X[K+1]=O.g,X[K+2]=O.b,X[K+3]=L.r,X[K+4]=L.g,X[K+5]=L.b,X[K+6]=T.r,X[K+7]=T.g,X[K+8]=T.b,K+=9;for(d=0,u=le.length;d<u;d++)g=(c=de[le[d]]).vertexColors,_=c.color,4===g.length&&G===e.VertexColorType.RGBA?(O=g[0],L=g[1],T=g[2],I=g[3]):(O=_,L=_,T=_,I=_),X[K]=O.r,X[K+1]=O.g,X[K+2]=O.b,X[K+3]=L.r,X[K+4]=L.g,X[K+5]=L.b,X[K+6]=T.r,X[K+7]=T.g,X[K+8]=T.b,X[K+9]=I.r,X[K+10]=I.g,X[K+11]=I.b,K+=12;K>0&&(p.bindBuffer(p.ARRAY_BUFFER,t.__webglColorBuffer),p.bufferData(p.ARRAY_BUFFER,X,r))}if(se&&J.hasTangents){for(d=0,u=oe.length;d<u;d++)v=(y=(c=de[oe[d]]).vertexTangents)[0],D=y[1],w=y[2],$[V]=v.x,$[V+1]=v.y,$[V+2]=v.z,$[V+3]=v.w,$[V+4]=D.x,$[V+5]=D.y,$[V+6]=D.z,$[V+7]=D.w,$[V+8]=w.x,$[V+9]=w.y,$[V+10]=w.z,$[V+11]=w.w,V+=12;for(d=0,u=le.length;d<u;d++)v=(y=(c=de[le[d]]).vertexTangents)[0],D=y[1],w=y[2],R=y[3],$[V]=v.x,$[V+1]=v.y,$[V+2]=v.z,$[V+3]=v.w,$[V+4]=D.x,$[V+5]=D.y,$[V+6]=D.z,$[V+7]=D.w,$[V+8]=w.x,$[V+9]=w.y,$[V+10]=w.z,$[V+11]=w.w,$[V+12]=R.x,$[V+13]=R.y,$[V+14]=R.z,$[V+15]=R.w,V+=16;p.bindBuffer(p.ARRAY_BUFFER,t.__webglTangentBuffer),p.bufferData(p.ARRAY_BUFFER,$,r)}if(re&&B){for(d=0,u=oe.length;d<u;d++)if(f=(c=de[oe[d]]).vertexNormals,h=c.normal,3===f.length&&C)for(M=0;M<3;M++)U=f[M],Z[z]=U.x,Z[z+1]=U.y,Z[z+2]=U.z,z+=3;else for(M=0;M<3;M++)Z[z]=h.x,Z[z+1]=h.y,Z[z+2]=h.z,z+=3;for(d=0,u=le.length;d<u;d++)if(f=(c=de[le[d]]).vertexNormals,h=c.normal,4===f.length&&C)for(M=0;M<4;M++)U=f[M],Z[z]=U.x,Z[z+1]=U.y,Z[z+2]=U.z,z+=3;else for(M=0;M<4;M++)Z[z]=h.x,Z[z+1]=h.y,Z[z+2]=h.z,z+=3;p.bindBuffer(p.ARRAY_BUFFER,t.__webglNormalBuffer),p.bufferData(p.ARRAY_BUFFER,Z,r)}if(ie&&ue&&A){for(d=0,u=oe.length;d<u;d++)if(void 0!==(m=ue[oe[d]]))for(M=0;M<3;M++)x=m[M],H[N]=x.x,H[N+1]=x.y,N+=2;for(d=0,u=le.length;d<u;d++)if(void 0!==(m=ue[le[d]]))for(M=0;M<4;M++)x=m[M],H[N]=x.x,H[N+1]=x.y,N+=2;N>0&&(p.bindBuffer(p.ARRAY_BUFFER,t.__webglUVBuffer),p.bufferData(p.ARRAY_BUFFER,H,r))}if(te){for(d=0,u=oe.length;d<u;d++)q[W]=k,q[W+1]=k+1,q[W+2]=k+2,W+=3,Q[j]=k,Q[j+1]=k+1,Q[j+2]=k,Q[j+3]=k+2,Q[j+4]=k+1,Q[j+5]=k+2,j+=6,k+=3;for(d=0,u=le.length;d<u;d++)q[W]=k,q[W+1]=k+1,q[W+2]=k+3,q[W+3]=k+1,q[W+4]=k+2,q[W+5]=k+3,W+=6,Q[j]=k,Q[j+1]=k+1,Q[j+2]=k,Q[j+3]=k+3,Q[j+4]=k+1,Q[j+5]=k+2,Q[j+6]=k+2,Q[j+7]=k+3,j+=8,k+=4;p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,t.__webglFaceBuffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,q,r),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,t.__webglLineBuffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,Q,r)}o&&(delete t.__inittedArrays,delete t.__colorArray,delete t.__normalArray,delete t.__tangentArray,delete t.__uvArray,delete t.__uv2Array,delete t.__binormalArray,delete t.__faceArray,delete t.__vertexArray,delete t.__lineArray,delete t.__skinIndexArray,delete t.__skinWeightArray)}}d._inheritanceSolver.onGeometryDisposeDS=h,this.updateObject=g;var S=function(e){var t=e.target;t.removeEventListener("dispose",S);var i=u?u.info:null;t.deallocate(p,i)};function b(e,t,i,r){u.initObject(e.object);var s=r(e,t,i);s&&u.__glResources__&&u.__glResources__.geometry.push(s)}d.initObject=function(t){var s;if(t.geometry&&(2===t.geometry._type||t.geometry.length>=0)){if(t._normalMatrix=new e.Matrix3,2===(a=t.geometry)._type)a.addEventListener("dispose",S);else if(a.length)for(var n=0;n<a.length;n++)a[n].addEventListener("dispose",S)}else if(!t.__webglInit){t.__webglInit=!0,t._normalMatrix=new e.Matrix3,void 0!==t.geometry&&void 0===t.geometry.__webglInit&&(t.geometry.__webglInit=!0,t.geometry.addEventListener("dispose",h));var a=t.geometry;if(void 0===a);else if(1===a._type)!function(e){var t,i,r;for(t in e.attributes)r="index"===t?p.ELEMENT_ARRAY_BUFFER:p.ARRAY_BUFFER,(i=e.attributes[t]).buffer=p.createBuffer(),p.bindBuffer(r,i.buffer),p.bufferData(r,i.array,p.STATIC_DRAW)}(a);else if(t instanceof e.Mesh)for(s in u=t.material,void 0===a.geometryGroups&&function(t,i){var r,s,n,a,o,l,d={},u=t.morphTargets.length,p=t.morphNormals.length,c=i instanceof e.MeshFaceMaterial;for(t.geometryGroups={},r=0,s=t.faces.length;r<s;r++)n=t.faces[r],void 0===d[a=c?n.materialIndex:0]&&(d[a]={hash:a,counter:0}),l=d[a].hash+"_"+d[a].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],faces4:[],materialIndex:a,vertices:0,numMorphTargets:u,numMorphNormals:p}),o=n instanceof e.Face3?3:4,t.geometryGroups[l].vertices+o>65535&&(d[a].counter+=1,l=d[a].hash+"_"+d[a].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],faces4:[],materialIndex:a,vertices:0,numMorphTargets:u,numMorphNormals:p})),n instanceof e.Face3?t.geometryGroups[l].faces3.push(r):t.geometryGroups[l].faces4.push(r),t.geometryGroups[l].vertices+=o;for(var f in t.geometryGroupsList=[],t.geometryGroups)t.geometryGroups[f].id=e.GeometryIdCount++,t.geometryGroupsList.push(t.geometryGroups[f])}(a,u),a.geometryGroups){var d=a.geometryGroups[s];d.__webglVertexBuffer||(_(d),l(d,t),a.verticesNeedUpdate=!0,a.morphTargetsNeedUpdate=!0,a.elementsNeedUpdate=!0,a.uvsNeedUpdate=!0,a.normalsNeedUpdate=!0,a.tangentsNeedUpdate=!0,a.colorsNeedUpdate=!0)}else if(t instanceof e.Line)a.__webglVertexBuffer||(!function(e){e.__webglVertexBuffer=p.createBuffer(),e.__webglColorBuffer=p.createBuffer(),e.__webglLineDistanceBuffer=p.createBuffer(),c.geometries++}(a),function(e,t){var i=e.vertices.length;e.__vertexArray=new Float32Array(3*i),e.__colorArray=new Float32Array(3*i),e.__lineDistanceArray=new Float32Array(1*i),e.__webglLineCount=i}(a),a.verticesNeedUpdate=!0,a.colorsNeedUpdate=!0,a.lineDistancesNeedUpdate=!0);else if(t instanceof e.ParticleSystem){a.__webglVertexBuffer||(!function(e){e.__webglVertexBuffer=p.createBuffer(),e.__webglColorBuffer=p.createBuffer(),c.geometries++}(a),function(e,t){var i=e.vertices.length;e.__vertexArray=new Float32Array(3*i),e.__colorArray=new Float32Array(3*i),e.__sortArray=[],e.__webglParticleCount=i}(a),a.verticesNeedUpdate=!0,a.colorsNeedUpdate=!0);var u=o(t,a),f=u.attributes&&i(u);(a.verticesNeedUpdate||a.colorsNeedUpdate||t.sortParticles||f)&&y(a,p.DYNAMIC_DRAW,t),a.verticesNeedUpdate=!1,a.colorsNeedUpdate=!1,u.attributes&&r(u)}}t._updateWorldCenterAndRadius()},d.initWebGLObjects=function(t){t.initWebGLObjectFrameIndex!==d.currentFrameIndex&&(t.initWebGLObjectFrameIndex=d.currentFrameIndex,t.__webglObjects||(t.__webglObjects={main:new e.WebGLObjectManager},t.__webglObjectsAll=new e.WebGLObjectManager,t.__webglSprites=[],t.__webglFlares||(t.__webglFlares=[])),t.__objectsAdded.size&&t.__processAddedObjects(b),t.__objectsUpdated.size&&t.__processUpdatedObjects(b),t.__objectsRemoved.size&&t.__processRemovedObjects(u.__glResources__),u.bufferGPUManager.allocateShared(0==e.loadingModels,u.bufferGPUManager._gl?0:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,u.bufferGPUManager._gl?0:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST),u.bufferGPUManager.intermediaryArray=null,t.traverseObject3DWithCondition((function(e){return!e.isRoot3ds&&(g(e),!0)})))}}})),define("DS/RenderEngineUtils/DisplayRangeList",["DS/Mesh/ThreeJS_Base","DS/Visualization/FixedSizeArrayPool"],(function(e,t){"use strict";var i=null;e._VisuFilterType;const r={drawWireframe:function(e,t,i,r,s,n,a){const o=t.geometry.indexBufferGPU;e.drawElements(e.LINE_STRIP,i,o.glFormat,t.start*o.bytesPerIndex)},drawNonIndexedPoints:function(e,t,i,r,s,n,a){e.drawArrays(t.dg.glType,t.geometry.vertexIndexArray[t.start],i)},drawNonIndexedPointsInstanced:null,drawNonIndexed:function(e,t,i,r,s,n,a){e.drawArrays(t.dg.glType,t.start,i)},drawNonIndexedInstanced:null,drawRegular:function(e,t,i,r,s,n,a){const o=t.geometry,l=o.indexBufferGPU;e.drawElements(t.dg.glType,i,l.glFormat,(o.indexOffsetGPU+t.start)*l.bytesPerIndex)},drawWireframeInstanced:function(e,t,i,r,s,n,a){const o=t.geometry.indexBufferGPU,l=t.getNbInstance();s._setVertexAttribDivisors(1,n,a),s.drawElementsInstanced(e.LINE_STRIP,i,o.glFormat,t.start*o.bytesPerIndex,l),s._setVertexAttribDivisors(0,n,a)},drawRegularInstanced:function(e,t,i,r,s,n,a){const o=t.geometry,l=o.indexBufferGPU,d=t.getNbInstance();s._setVertexAttribDivisors(1,n,a),s.drawElementsInstanced(t.dg.glType,i,l.glFormat,(o.indexOffsetGPU+t.start)*l.bytesPerIndex,d),s._setVertexAttribDivisors(0,n,a)},drawWireframeMulti:function(e,t,i,r,s,n,a,o){const l=t.geometry.indexBufferGPU;let d=[];const u=t.multiStart.length;for(let e=0;e<u;e++)d[e]=(t.geometry.indexOffsetGPU+t.multiStart[e])*l.bytesPerIndex;r.multiDrawElements(e.LINE_STRIP,o,0,l.glFormat,d,0,u)},drawWireframeInstancedMulti:function(e,t,i,r,s,n,a,o){const l=t.geometry,d=l.indexBufferGPU,u=t.getNbInstance();let p=[],c=[];const f=t.multiStart.length;for(let e=0;e<f;e++)c[e]=(l.indexOffsetGPU+t.multiStart[e])*d.bytesPerIndex,p[e]=u;s._setVertexAttribDivisors(1,n,a),r.multiDrawElementsInstanced(e.LINE_STRIP,o,0,d.glFormat,c,0,p,0,f),s._setVertexAttribDivisors(0,n,a)},drawNonIndexedPointsMulti:null,drawNonIndexedPointsInstancedMulti:null,drawNonIndexedMulti:null,drawNonIndexedInstancedMulti:null,drawRegularMulti:function(e,t,i,r,s,n,a,o){const l=t.geometry,d=l.indexBufferGPU;let u=[];const p=t.multiStart.length;for(let e=0;e<p;e++)u[e]=(l.indexOffsetGPU+t.multiStart[e])*d.bytesPerIndex;r.multiDrawElements(t.dg.glType,o,0,d.glFormat,u,0,p)},drawRegularInstancedMulti:function(e,t,i,r,s,n,a,o){const l=t.geometry,d=l.indexBufferGPU,u=t.getNbInstance();let p=[],c=[];const f=t.multiStart.length;for(let e=0;e<f;e++)c[e]=(l.indexOffsetGPU+t.multiStart[e])*d.bytesPerIndex,p[e]=u;s._setVertexAttribDivisors(1,n,a),r.multiDrawElementsInstanced(t.dg.glType,o,0,d.glFormat,c,0,p,0,f),s._setVertexAttribDivisors(0,n,a)},drawCurvedPipes:function(e,t,i,r,s,n,a){if(a.specialMeshIds>=0){const r=t.geometry.indexBufferGPU;var o=t.autoInstancingData.updateData;t.autoInstancingData.updateData=!1,e.bindBuffer(e.ARRAY_BUFFER,t.autoInstancingData.idsBuffer),e.vertexAttribPointer(a.specialMeshIds,2,e.FLOAT,!1,0,0),o&&e.bufferData(e.ARRAY_BUFFER,t.autoInstancingData.idsArray,e.DYNAMIC_DRAW),s.vertexAttribDivisor(a.specialMeshIds,1),a.specialMeshPicking>=0&&(e.bindBuffer(e.ARRAY_BUFFER,t.autoInstancingData.pickingColorBuffer),e.vertexAttribPointer(a.specialMeshPicking,3,e.FLOAT,!1,0,0),o&&e.bufferData(e.ARRAY_BUFFER,t.autoInstancingData.pickingColorArray,e.DYNAMIC_DRAW),s.vertexAttribDivisor(a.specialMeshPicking,1));const n=t.autoInstancingData.lastId+1;s.drawElementsInstanced(t.dg.glType,i,r.glFormat,t.start*r.bytesPerIndex,n),s.vertexAttribDivisor(a.specialMeshIds,0),a.specialMeshPicking>=0&&s.vertexAttribDivisor(a.specialMeshPicking,0)}},drawCurvedPipesInstanced:null};r.drawNonIndexedPointsInstanced=r.drawRegularInstanced,r.drawNonIndexedInstanced=r.drawRegularInstanced,r.drawCurvedPipesInstanced=r.drawCurvedPipes;const s={drawIndirectBuffer:function(e,t,i){const r=t.dg;e.drawIndexedIndirect(r.indirectBuffer,r.indirectBufferOffset)},drawPoint:function(e,t,i){e.draw(6,i)},drawNonIndexed:function(e,t,i){e.draw(i,1,t.start)},drawRegular:function(e,t,i){const r=t.geometry;e.drawIndexed(i,1,t.start+r.indexOffsetGPU)},drawRegularInstanced:function(e,t,i){const r=t.geometry,s=t.getNbInstance();e.drawIndexed(i,s,t.start+r.indexOffsetGPU)}};return class{constructor(t,r){this.material=t,this.materialOverride=null,this.tree=new Map,this.dl=r,this.pack=null,null===i&&(i=e.Constants,e.MaterialToUse)}getSortId(e,t){return t.vertexBufferGPU?t.vertexBufferGPU.id+1:0}_insertToken(t,i,n,a,o){if(t.previous){const i=o.isFace;var l=a?a.glType:-1;if(a){o.polygonOffset&&(t.doRenderLineModePolygonOffset.doIt=o.polygonOffset.doIt,t.doRenderLineModePolygonOffset.enable=o.polygonOffset.enable,t.doRenderLineModePolygonOffset.unit=o.polygonOffset.unit,t.doRenderLineModePolygonOffset.factor=o.polygonOffset.factor);var d=null!==(t.getInstanceInfos()?t.getInstanceInfos().instanceAttribArrays:null);const e=null!==t.multiStart;if(o.webgpu){let e="";a.indirectBuffer?e="drawIndirectBuffer":0===l?e="drawPoint":a.nonIndexed?e="drawNonIndexed":(e="drawRegular",d&&(e+="Instanced")),t.draw=s[e]}else{let s="";s=this.material.wireframe&&i?"drawWireframe":0===l&&n.vertexPositionArray&&n.vertexPositionArray.nonindexedPoints?"drawNonIndexedPoints":a.nonIndexed?"drawNonIndexed":"drawRegular",d&&(s+="Instanced"),e&&(s+="Multi"),t.draw=r[s]}}return t.doSetMaterialFaces=o.sideFunc,t._sideHandler=o.sideHandler,o.noZ&&(t._programID|=e.ProgramIDs.NOZ_OBJECT),t.updateLineInfos=o.updateLineInfos,!0}return!1}insert(e,t,i,r,s,n,a,o){var l=this.getSortId(t,i);o&&l>0&&(l*=-1);var d=this.tree,u=d.get(l);if(u){var p=!0,c=u.next;if(r.cullingData||1!==r.glType||null!==e.multiStart||c.object.id===t.id&&c.geometry===i&&c.dg.glType===r.glType&&c.start+c.count===s&&(c.count+=n,p=!1),p){var f=u.next;u.next=e,e.previous=u,e.next=f,null!==f&&(f.previous=e)}}else u={tree:d,sortId:l,previous:null,next:e},e.previous=u,d.set(l,u);return this._insertToken(e,t,i,r,a)}_setRenderingInfos(t,i){var r=this.material;var s=(this.dl.ssr.overridableMaterial||r.deferrable)&&r.overridable&&i&&i.materialOverride?i.materialOverride:null;return s&&s.internalMaterialOverride&&s.internalMaterialOverride.material===r&&(s=null),this.materialOverride=s,!(r.overridable&&s&&0===s.getOpacity(r.__dimension,!1)||!s&&0===r.getOpacity())||e._isSelectionMaterial(t)}flagObjectsAsGSSOInvalidated(){this.tree.forEach((function(e,t){for(var i=e.next;null!==i;i=i.next)i.object._flagAsGSSOInvalidated()}))}add({object:i,geometry:r,dg:s,dgInterval:n,materialToUse:a,matApp:o,gasMaterial:l,cpInfos:d=null,tokenCache:u}){const p=this.dl.ssr.id;var c=n?n.start:0,f=n?n.count:0;let h=0,g=0,_=null,y=null;if(s&&s.numPlanarIndices>0){const P=s.start,E=s.start+s.count,v=E-s.numPlanarIndices,D=c,w=c+f;function R(e){return Math.min(Math.max(e,D),w)}_=[R(P),R(v)],y=[R(v)-_[0],R(E)-_[1]]}else h=c,g=f;if(_&&_.length&&u.webgpu){if((S=t.prototype.allocate(i,r,s,_[0],y[0],o,this.material.useGASColor?l:null,null,null)).next=null,this.insert(S,i,r,s,h,g,u,!1))(b=i._tokens[p])||(b=[],i._tokens[p]=b),b.push(S);var m=t.prototype.allocate(i,r,s,_[1],y[1],o,this.material.useGASColor?l:null,null,null);if(m.next=null,m._programID|=e.ProgramIDs.PLANAR_FACE,m.cullingDataId=1,this.insert(m,i,r,s,h,g,u,!0))(b=i._tokens[p])||(b=[],i._tokens[p]=b),b.push(m)}else{var S,b;if((S=t.prototype.allocate(i,r,s,h,g,o,this.material.useGASColor?l:null,_,y)).next=null,this.insert(S,i,r,s,h,g,u,!1))(b=i._tokens[p])||(b=[],i._tokens[p]=b),b.push(S)}}getFirstDrawable(){if(this.tree.values)var e=this.tree.values().next().value;else{e=null;this.tree.forEach((function(t,i){null===e&&(e=t)}))}return e?e.next:null}}})),define("DS/RenderEngineUtils/StateSortingCache",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";const t=e._VisuFilterType;let i=null,r=null;function s(e,t,i){let r=e.gpuStates;r.doubleSided||(e.setCullMode(e.cullings.NONE),r.doubleSided=!0);let s=t.orientation;!1===r.flipSided&&r.orientation===s||(e.setFrontFace(s>=0?1:0),r.orientation=s,r.flipSided=!1)}function n(e,t,i){let r=e.gpuStates;r.doubleSided||(e.setCullMode(e.cullings.NONE),r.doubleSided=!0);let s=-t.orientation;!1===r.flipSided&&r.orientation===s||(e.setFrontFace(s>=0?1:0),r.orientation=s,r.flipSided=!1)}function a(e,t,i){let r=e.gpuStates;const s=e.disableBackFaceCulling||i;r.doubleSided!==s&&(e.setCullMode(s?e.cullings.NONE:e.cullings.BACK),r.doubleSided=s);let n=t.orientation;!1===r.flipSided&&r.orientation===n||(e.setFrontFace(n>=0?1:0),r.orientation=n,r.flipSided=!1)}function o(e,t,i){let r=e.gpuStates;const s=e.disableBackFaceCulling||i;r.doubleSided!==s&&(e.setCullMode(s?e.cullings.NONE:e.cullings.BACK),r.doubleSided=s);let n=-t.orientation;!1===r.flipSided&&r.orientation===n||(e.setFrontFace(n>=0?1:0),r.orientation=n,r.flipSided=!1)}function l(e,t,i){let r=e.gpuStates;const s=e.disableBackFaceCulling||i;r.doubleSided!==s&&(e.setCullMode(s?e.cullings.NONE:e.cullings.BACK),r.doubleSided=s);let n=t.orientation;!0===r.flipSided&&r.orientation===n||(e.setFrontFace(n>=0?0:1),r.orientation=n,r.flipSided=!0)}function d(e,t,i){let r=e.gpuStates;const s=e.disableBackFaceCulling||i;r.doubleSided!==s&&(e.setCullMode(s?e.cullings.NONE:e.cullings.BACK),r.doubleSided=s);let n=-t.orientation;!0===r.flipSided&&r.orientation===n||(e.setFrontFace(n>=0?0:1),r.orientation=n,r.flipSided=!0)}function u(e,t,i){}class p{constructor(e=null,t=null,i=null,r=-1,s=null){this.material=e,this.gasMaterial=t,this.object=i,this.materialToUse=r,this.dg=s}getSideFunc(){const i=this.material;if(null===i)return u;const p=this.gasMaterial,c=this.object,f=this.materialToUse,h=this.dg,g=e.Constants,_=p||(h?h.gas:null),y=!(!_||i.forceSide)?_:i;let m=y.side,S=y.forceSide;const b=c._getFilter(t._SIDE);b&&(m=b.side,S=!0);let P=m===g.BackSide,E=m===g.FrontSide;c._isDecal()&&(P=f!==r.highlightMaterial&&f!==r.pickingMaterial,E=!1);const v=c.orientation;return!P&&!E||c._forceBackFacesOnSolid&&h._dimension>=2&&!S?v>=0?s:n:P?v>=0?l:d:v>=0?a:o}}e.__MaterialSideHandler=p;var c=function(t,s,n){this.object=t,this.resetFrameIndex=s,this.webgpu=n,null===i&&(r=e.MaterialToUse,i=e.DrawCallSorting)};return(c.prototype=Object.create(Array.prototype)).__addCacheItem=function(s,n,a,o){this.push(s);const l=s._inheritanceSolverCache,d=l.material;if(!d)return;s.resetFrameIndex=d._resetFrameIndex;const u=this.object;s.object=this.object,u._sgOrdered=u._sgOrdered||n.drawCallSort===i.NeverSort&&!(!u._occurrence||!u._occurrence.prev&&!u._occurrence.next);const c=l.gasMaterial,f=l.materialToUse;var h=n.buildDisplayRangeList({object:u,geometry:l.geometry,dg:l.dg,dgInterval:l.dgInterval,geomDisposeFunc:l.geomDisposeFunc,matApp:l.matApp,material:d,gasMaterial:c,materialToUse:f,oitActive:o,sectionCapping:a,webgpu:this.webgpu});if(!h.materialPack)return;s.materialPack=h.materialPack,h.dgInterval!==l.dgInterval&&(l.dgInterval=h.dgInterval,l.geometry=h.geometry,l.dg=h.dg);const g=l.dg;g&&n.canForceSideOnSolids&&f===r.originalMaterial&&d._autoForceSide&&(5===g._dimension||c&&0===c.side)&&u._setForceBackFacesOnSolid(!0);const _=s._drawCallCache;_.webgpu=this.webgpu;const y=!!g&&(4===g.glType||5===g.glType);{_.isFace=y;let e=null;var m=u._getFilter(t.POLYGON_OFFSET);m?e={doIt:!0,enable:m.enabled()&&y&&!(d.isWideLine||d.is2DLine),unit:m.unit,factor:m.factor}:y&&d.polygonBorderMode&&d.lineWidth>1?e={doIt:!0,enable:!0,unit:this.webgpu?-1:-10,factor:-1}:y&&!d.polygonOffset&&(e={doIt:!0,enable:s.applyPolygonOffsetOnFaces&&!(d.isWideLine||d.is2DLine),unit:1,factor:1}),_.polygonOffset=e,u._isDecal()&&(_.polygonOffset.doIt=!1)}_.sideHandler=new p(d,c,u,f,g),_.sideFunc=_.sideHandler.getSideFunc(),_.noZ=u._occurrence&&u._occurrence.isInNozPass()||n.noz,_.updateLineInfos=!1,r.pickingPassMaterial(f)||(_.updateLineInfos=d.isDashedLine&&d.isCPUPattern||g&&g._updateLineWithShapes);"OUTLINE"==n.name&&g._geomType===e.GeomTypeEnum._OUTLINE&&(_.updateLineInfos=!0)},c})),define("DS/RenderEngineUtils/DisplayRangeListBackToFront",["DS/RenderEngineUtils/DisplayRangeList"],(function(e){"use strict";return class extends e{constructor(e,t){super(e,t),this.root={tree:null,sortId:0,previous:null,next:null},this.tree.set(0,this.root)}getSortId(e,t){return 0}insert(e,t,i,r,s,n,a,o){var l=this.root;if(l.next){var d=!0,u=l.next;if(r.cullingData||1!==r.glType||1!==s.length||u.object.id===t.id&&u.geometry===i&&u.dg.glType===r.glType&&u.start+u.count===s&&(u.count+=n,d=!1),d){var p=l.next;l.next=e,e.previous=l,e.next=p,null!==p&&(p.previous=e)}}else l.next=e,e.previous=l;return this._insertToken(e,t,i,r,a)}sortDrawablesBackToFront(e){var t=e.matrixWorldInverse.elements,i=this.root,r=i?i.next:null;if(r)for(var s=null;null!==r;){if(null!==(s=r.object).renderDepth)s.z=s.renderDepth,r.zSortKey=s.z;else{const e=s.worldCenterAndRadius;var n=e.worldRadius,a=e.worldCenter,o=t[2]*a.x+t[6]*a.y+t[10]*a.z+t[14];s.z=o+n,r.zSortKey=s.z}for(var l=r.previous,d=!1;l!==i&&s.z<l.object.z;)l=l.previous,d=!0;var u=r.next;if(d){var p=r.previous;p.next=u,u&&(u.previous=p);var c=l.next;l.next=r,r.next=c,r.previous=l,c&&(c.previous=r)}r=u}}getFirstDrawable(){return this.root.next}}})),define("DS/RenderEngineUtils/DisplayRangeListNeverSort",["DS/RenderEngineUtils/DisplayRangeList"],(function(e){"use strict";return class extends e{constructor(e,t){super(e,t),this.root={tree:null,sortId:0,previous:null,next:null},this.tree.set(0,this.root)}getSortId(e,t){return 0}insert(e,t,i,r,s,n,a,o){var l=this.root;if(l.next){for(var d=!0,u=l.next;null!==u.next;)u=u.next;r.cullingData||1!==r.glType||u.object.id===t.id&&u.geometry===i&&u.dg.glType===r.glType&&u.start+u.count===s&&(u.count+=n,d=!1),d&&(u.next=e,e.previous=u)}else l.next=e,e.previous=l;return this._insertToken(e,t,i,r,a)}getFirstDrawable(){return this.root.next}}})),define("DS/RenderEngineUtils/DisplayList",["DS/Mesh/ThreeJS_Base","DS/Visualization/WidelinesHelper","DS/RenderEngineUtils/DisplayRangeList","DS/RenderEngineUtils/DisplayRangeListBackToFront","DS/RenderEngineUtils/DisplayRangeListNeverSort"],(function(e,t,i,r,s){"use strict";let n=0,a=0,o=null,l=null,d=null;const u="true"===localStorage.getItem("__WEBVISU_NEW_TRANSPARDL_SORTING__");function p(e){return!(e.vertexLineDistancesArray||e.vertexBufferGPU&&e.vertexBufferGPU.layout.has("lineDistance"))}class c{constructor(e,t,i,r,s,n,a,o,l,d,u){this.material=e,this.occurrenceRenderingOverride=i,this.id=r,this.occurrenceRenderingOverrideId=s,this.decalSortData=n,this.glType=a,this.materialToUse=o,this._objectsTransparentOnGPU=l,this.drawOnlyOnStaticFrames=d,this.displayRangeList=t,this._forceAlphaBlending=!1,this.sectionLines=u,t.pack=this}}return class{constructor(t){null===l&&(l=e.MaterialToUse,d=e.DrawCallSorting),o=e.displayListPriorityEnum,this.name="",this.string_id=n.toString(),n++,this.active=!0,this.priority=0,this.drawCallSort=d.FrontToBackSort,this.side=e.DoubleSide,this.clearDepth=!1,this.clearStencil=!1,this.pickingPriority=!1,this.depthTest=!0,this.depthWrite=!0,this.depthFunc=null,this.polygonOffset=!1,this.polygonOffsetFactor=1,this.polygonOffsetUnits=1,this.canForceSideOnSolids=!1,this.hasTranspar=!1,this.hasPoliteDepth=!0,this.hasOcclusionDepth=!0,this.noz=!1,this.isoSupport=!1,this.setValues(t),this.canOIT=this.priority<=e.displayListPriorityEnum._OITStart&&this.priority>=e.displayListPriorityEnum._OITEnd,this.postOIT=this.priority<=e.displayListPriorityEnum._PostOIT,this.sgOrdered=this.priority<=e.displayListPriorityEnum._RespectSGOrderStart&&this.priority>=e.displayListPriorityEnum._RespectSGOrderEnd,this._materialList=[],this._displayRangeLists=new Map,this.index=-1,this.ssrId=-1,this._sortByProgram=!0,this._sortByClippingContext=!1}buildDisplayRangeList({object:i,geometry:r,dg:s,dgInterval:n,geomDisposeFunc:f,matApp:h,material:g,gasMaterial:_,materialToUse:y,oitActive:m,sectionCapping:S,webgpu:b}){const P=s;let E=0;i&&(E|=i._programID),h&&(E|=h._programID);let v="pId"+E,D=null,w=null;i&&i.occurrenceRenderingOverride&&(w=i.occurrenceRenderingOverride,D=w.getGSSOId(w.isPurePGP()),v=v+"#"+D),g.useGASColor&&_&&(v+="gM"+_.id),h&&h._mappingOperator&&(v+="mA"+h.id),b&&g._hasDGUniform&&(v+="dg"+i.id+"-"+n.start+"-"+n.count);let R=!1;i&&i.sectionLinesBuilder&&g.__isSectionLine&&(R=!0,v+="sl");let O=null;if(this.drawCallSort===d.DecalSort){v=v+"do"+i.id,i._decalData.stencilID,i._decalData.key,i._decalData.internalSortKey,h&&(v+="l"+h._layer);const e=i._isDecal();O={_decalDataContainer:i,internalSortKey:e?i._decalData.internalSortKey:P.glType-512,layer:e?h?h._layer:i._decalData.layer:0}}let L=!1;if(i._vertexColors&&(g.useGASColor||g._isFromGAS)){v=v+"VC"+i._vertexColors;const t=i._vertexColors;L=(t&e.VertexColorType.A)>0||t<=e.VertexColorType.RGBA}let T=!1;g.useGASColor&&!g.transparent&&_&&_._opacity<1&&(v+="FT",T=!0),(this.drawCallSort===d.NeverSort||this.drawCallSort===d.RenderDepthSort||u&&this.priority===o.dlTranspar&&!m)&&(v+="ns"+a++);const I=i.getDynamicMode(y===l.pickingMaterial||y===l.pickingMaterialInstancing);I&&(v+="dyn"),S&&w&&w.clippingContext&&(this._sortByClippingContext=!0);let[M,U]=this._getDisplayRangeList(y,g,w,v);const x=r&&!r.vertexIndexArray,B=r&&r.noMeshInRAM;if(g.isWideLine||g.is2DLine){const e=r.computeWideLine(s,g);if(e){let i=!0;if(r.wideLinesLinker&&(r.wideLinesLinker.linkedGeometry.addEventListener("dispose",f),g.isDashedLine&&(g.isCPUPattern?B&&(i=!1,g=g._getBodyEdgeMaterial(),[M,U]=this._getDisplayRangeList(y,g,w,v)):p(r.wideLinesLinker.linkedGeometry)&&(x?(i=!1,g=g._getBodyEdgeMaterial(),[M,U]=this._getDisplayRangeList(y,g,w,v)):r.wideLinesLinker.subGeometries?r.wideLinesLinker.subGeometries.needsLineDistance=!0:t._computeWideLineDistances(r.wideLinesLinker.linkedGeometry)))),i){if(n===s)n=e;else{const t=e.getPrimitiveStart(n.primitiveStart),i=e.getPrimitiveStart(n.primitiveStart+n.primitiveCount-1),r=e.getPrimitiveCount(n.primitiveStart+n.primitiveCount-1);t>=0&&i>=0&&(n={start:t,count:i-t+r},e.getPrimitiveStart(0)!==e.start&&(n.start+=e.start))}s=e,r=r.wideLinesLinker.linkedGeometry}}else g=g._getBodyEdgeMaterial(),[M,U]=this._getDisplayRangeList(y,g,w,v)}else g.isDashedLine&&!g.is2DLine&&(g.isCPUPattern?B&&(g=g._getBodyEdgeMaterial(),[M,U]=this._getDisplayRangeList(y,g,w,v)):(p(r)||r.isAttributeStale("position"))&&(x?(g=g._getBodyEdgeMaterial(),[M,U]=this._getDisplayRangeList(y,g,w,v)):t._computeLineDistances(r)));if(M){let e=M.pack;if(e){if(e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride!==w){e.occurrenceRenderingOverride=w,e.occurrenceRenderingOverrideId=w?w.id:-1;!M._setRenderingInfos(y,w)&&(this._materialList.splice(this._materialList.indexOf(e),1),this._displayRangeLists.delete(U),M.material._removeDisplayRangeList(M),M=null)}}else{const e=new c(g,M,w,U,w?w.id:-1,O,P?P.glType:-1,y,L,I,R);e._forceAlphaBlending=T,this.drawCallSort===d.NeverSort&&i._sgOrdered||(this._materialList.push(e),this._displayRangeLists.set(U,M),M.material._addDisplayRangeList(M))}}return{materialPack:M?M.pack:null,dgInterval:n,geometry:r,dg:s}}_getDisplayRangeList(e,t,n,a){const o=(e+"-"+t.id+a).hashCode();let l=this._displayRangeLists.get(o);if(!l){l=this.drawCallSort===d.NeverSort?new s(t,this):this.drawCallSort===d.BackToFrontSort?new r(t,this):new i(t,this);l._setRenderingInfos(e,n)||(l=null)}return[l,o]}addDrawable({materialPack:e,object:t,geometry:i,dg:r,dgInterval:s,matApp:n,gasMaterial:a,cpInfos:o=null,tokenCache:l}){let u;this.drawCallSort===d.NeverSort&&t._sgOrdered?(u=e.displayRangeList,this._materialList.push(e),u.material._addDisplayRangeList(u)):(u=this._displayRangeLists.get(e.id),u||(u=e.displayRangeList,this._materialList.push(e),this._displayRangeLists.set(e.id,u),u.material._addDisplayRangeList(u))),this._sortByProgram=!0,u.add({object:t,geometry:i,dg:r,dgInterval:s,materialToUse:e.materialToUse,matApp:n,gasMaterial:a,cpInfos:o,tokenCache:l})}empty(){const e=this._materialList,t=e.length;for(let i=0;i<t;i++){const t=e[i].displayRangeList;t&&t.material._removeDisplayRangeList(t)}e.length=0,this._displayRangeLists.clear()}clearNeverSort(){if(this.drawCallSort!==d.NeverSort)return;const e=this._materialList,t=[],i=this._displayRangeLists;for(let r=0;r<e.length;r++){const s=e[r],n=s.displayRangeList;n&&n.getFirstDrawable()?t.push(s):(i.delete(s.id),n&&n.material._removeDisplayRangeList(n))}this._materialList=t}cleanMaterialListAndDRLs(){const e=this._materialList,t=this._displayRangeLists;if(e.filter((e=>!(e.displayRangeList&&e.displayRangeList.getFirstDrawable()))).length>0){const i=[];for(let r=0;r<e.length;r++){const s=e[r],n=s.displayRangeList;n&&n.getFirstDrawable()?i.push(s):(t.delete(s.id),n&&n.material._removeDisplayRangeList(n))}this._materialList=i}}setValues(e){if(void 0!==e)for(let t in e){const i=e[t];void 0!==i?t in this&&(this[t]=i):console.warn("DisplayList: '"+t+"' parameter is undefined.")}}}})),define("DS/RenderEngineUtils/InheritanceSolver",["DS/Mesh/ThreeJS_Base","DS/RenderEngineUtils/StateSortingCache","DS/RenderEngineUtils/StateSortingCacheItem"],(function(e,t,i){"use strict";const r=e._VisuFilterType;let s,n,a,o,l,d,u,p,c,f,h,g,_,y,m,S,b,P,E,v,D,w;const R=e.ProgramIDs;function O(e){return!(!e||!(e instanceof n||e instanceof a||e instanceof o||e instanceof l)||e.map)}let L=null,T=0;let I=null,M=null,U=null;function x(e,t){if(!e||!t)return null;let i=e;return 1!=t.glType&&3!=t.glType||!e.line||(i=e.line),0==t.glType&&e.point&&(i=e.point),i._deferredMaterialsInit||i.updateDeferredMaterials(),i}function B(e){if("true"===localStorage.getItem("forceCPUOutlines"))return e.isOrtho;return e._viewpoint&&e._viewpoint._2DMode&&e.isOrtho}function G(e,t,i){return e._viewpoint&&e._viewpoint.isNative2D()&&e._viewpoint._depthMode?t.gas&&t.gas._type!=d.NOZ?null:i?{depthPriority:{value:i._priority-4+t._depthPriority}}:{depthPriority:{value:t._depthPriority}}:null}let A=null;return class{constructor(t){this.renderer=t,this.context=null,this.reset(),this._objectsWithOutlines=null,this.camera=null,this.onGeometryDisposeDS=null,n=e.MeshBasicMaterial,o=e.MeshLambertMaterial,a=e.MeshPhongMaterial,l=e.PhysicalMaterial,s=e.Material,d=e.GASTypeEnum,u=e.MaterialToUse,p=e.GeomTypeEnum,T=p.FACE,c=e.PlaneViewMode,h=e.BackgroundViewMode,f=e.DefaultAppearanceMode,_=e._ForbidRenderableStates,y=e.RenderMode,g=e.Constants,m=e.Vector4,b=e.Vector3,S=e.Color,P=e.Matrix4,E=e.BodyLinesMask,v=e.OutlineMask,D=e.SectionLineMask,w=e.UnknownMask,U||(U=new n)}_useCPUOutlines(e){return B(e)}_getMaterialMode(e){return this.renderer.getMaterialMode(this.object,e,this.zOnlyPass)}enableOutlineHanding(e,t){if(!this.camera)throw"Globals are not set, camera not found";if(this.outlineStruct=null,e){const e=this.camera;this.outlineStruct=t;let i=null;B(e)&&(i=new m(0,0,1,0).applyMatrix4(e.matrixWorld)),t.outlinesCameraDirection=i;const r=this._objectsWithOutlines&&this._objectsWithOutlines.cameraDir,s=!!i!=!!r||i&&!i.equals(r);this._objectsWithOutlines&&s&&(this._objectsWithOutlines.cameraDir=i,this._objectsWithOutlines.objects.forEach((e=>e._flagAsGSSOInvalidated())),this._objectsWithOutlines.objects.clear())}}setContext(e,t,i){this.context=e,I=t,M=i}setFrameContext(e,t,i,r,s,n){this.getDLFromObject=e,this.camera=t,this.defaultAppearanceType=i,this.QAAutomationMode=i===f.__QA_AUTOMATION__,this.stateSortingResultID=r,this.zOnlyPass=s,this.pickingPass=n}reset(){this.getDLFromObject=null,this.QAAutomationMode=!1,this.defaultAppearanceType=-1,this.stateSortingResultID=-1,this.outlineStruct=null,this.object=null,this.cappingMaterial=null,this.zOnlyPass=!1,this.pickingPass=!1}_registerObjectWithOutlines(){this._objectsWithOutlines||(this._objectsWithOutlines={cameraDir:this.outlineStruct.outlinesCameraDirection,objects:new Set}),this._objectsWithOutlines.objects.add(this.object)}_handleOutlines(e){if(!this.outlineStruct||!I)return;const t=this.object,i=this.renderer,r=this.outlineStruct,s=(this.getDLFromObject,this.onGeometryDisposeDS);if(t.fromLoadedModel&&e&&e.getMask()&v)if(t.geometry&&t.geometry.length&&t.geometry[0]&&t.geometry[0].vertexIndexArray){let n=null;const a=r.outlinesCameraDirection;a&&(n=a.clone(),n.applyMatrix4((new P).getInverse(t.matrixWorld)),n=new b(n.x,n.y,n.z).normalize());let{outlineBG:o,created:l,invalidateGSSO:d}=I.prepareOutlines({object:t,width:e._outlineWidth,viewDirection:n,_sortCount:r.sortCount,_context:this.context,visibleSpace:i.visibleSpace,showHiddenOutlines:1===e._hiddenEdges});o.length>0&&(this._registerObjectWithOutlines(),d&&r.objectWithTransientGSSO.add(t),l&&(r.outlinesCreated=!0));for(let t=0;t<o.length;t++){const i=o[t];l&&i.addEventListener("dispose",s);const r=i.drawingGroups[0];this._addDGToDL({geometry:i,dg:r,dgInterval:r,material:r.material,originalMaterial:r.material,renderMode:e})}}else i._NoMeshInRamWarningCount<10&&(console.warn("OutlineBuilding unavailable, make sure noMeshInRAM is inactive"),i._NoMeshInRamWarningCount++)}_handleSectionLines(e){if(!M)return;let t=null;if(e&&e._maskWithDefault&D){const i=this.object,r=this.renderer,s=(this.getDLFromObject,this.onGeometryDisposeDS);if(i.geometry&&i.geometry.length&&i.geometry[0]&&i.geometry[0].vertexIndexArray){let n=i.sectionLinesBuilder&&i.sectionLinesBuilder.sectionLineGeometry;const a=i.occurrenceRenderingOverride&&i.occurrenceRenderingOverride.sectionLinesProperties,o=a?a.color:null,l=a?a.width:1,d=i.occurrenceRenderingOverride&&i.occurrenceRenderingOverride.clipPlanes;let u=null;i.occurrenceRenderingOverride&&i.occurrenceRenderingOverride.clippingContext&&(u=i.occurrenceRenderingOverride.clippingContext._getSectionLinesArray());const p=n&&i.layer&&!i.layer.upToDate,c=!p&&i.sectionLinesBuilder&&i.sectionLinesBuilder.update({width:l,color:o,clipPlanes:d,sectionLines:u});if(!p&&c||(i.sectionLinesBuilder&&i.sectionLinesBuilder.dispose(),i.sectionLinesBuilder=null,n=null,i.layer&&(i.layer.upToDate=!0)),!n&&!i.sectionLinesBuilder){const e=new M({renderable:i,renderer:r,lineWidth:l,color:o,clipPlanes:d,sectionLines:u});e.computeSectionLineGeometry(),n=e.sectionLineGeometry,n&&n.addEventListener("dispose",s),i.sectionLinesBuilder=e}if(n){const i=n.drawingGroups[0];null===o&&(t=i.material),this._addDGToDL({geometry:n,dg:i,dgInterval:i,material:i.material,originalMaterial:i.material,renderMode:e})}}else r._NoMeshInRamWarningCount<10&&(console.warn("SectionLineBuilding unavailable, make sure noMeshInRAM is inactive"),r._NoMeshInRamWarningCount++)}return t}_handleObjectSectionCapping(e,t,i,r){const s=this.renderer,n=this.object;let a=null;for(let t=0;t<e.length;t++){const n=e[t].drawingGroups;let o=0;for(let e=0;e<n.length;e++){const t=n[e];if(t._geomType===T){let e;e=i&&t.material?t.material:t.gas.isGAS?t.gas.getMaterial(null,4,t.gas,s):t.gas,!t._completeSolid||e.opacity>=1?t.count>o&&(a=e,o=t.count):r.add(t)}}}return t&&!s.cuttingScene&&a&&a.color&&(n.sectionLinesBuilder.setColor(a.color),a=null),a}_getModifiedOriginalMaterial(e,t,i,r,s){const n=this.renderer,a=this.object._occurrence;let o=t;if(!i&&a&&a.__solvedSubstituteMaterials){let e=t;for(;e;){if(a.__solvedSubstituteMaterials.has(e)){o=a.__solvedSubstituteMaterials.get(e).material;break}e=e._cloneOrigin}}this.zOnlyPass&&n.materialToUse===u.originalMaterial&&(e._geomType&p.FACE)>0&&(o=o.getZOnlyMaterial(n));let l=r;return i&&(o=o.getGeomTypeDeferredMaterial(e._geomType,{boundaryEdge:n.boundaryEdgeMaterialInfo,smoothEdge:s._halfVisibleSmoothEdges>0}),l=null),(i&&e._geomType===T||this.QAAutomationMode)&&(o=o.getPredefinedMaterial(n.noiseTexture3D,this.defaultAppearanceType,n._customMaterialModeParams),l=null),o._deferredMaterialsInit||o.updateDeferredMaterials(),[o,l]}_getBackgroundViewModeMaterial(e,t){return this.renderer._backgroundViewMode===h.GHOST&&e.applyBackgroundViewMode?A||(A=new n({force:!0,side:g.DoubleSide,color:new S(16711680),transparent:!0}),A.activatePDSFX("PDSFXBGViewModeGhost"),A.setPDSFXOverridableFunctions(null,{ProcessFinalColor:function(e,t){const i=e.variableHandler;return`\n                    ${i.dereference(t[0])} = ${i.vec4()}(1.0, 1.0, 1.0, 0.1);\n                `}}),A):t}checkGASStructCommon(e){const t=this.object,i=this.renderer;if(this.pickingPass&&e._noPick)return this._earlyExit(),null;const s=t._getFilter(r.ZMODE)||i._GlobalZModeFilter;return s&&(e._type===d.NOZ&&s.enableZ?(e=e.clone())._type=d._SKIN:e._type===d.NOZ||s.enableZ||((e=e.clone())._type=d.NOZ)),e}doLookFilter(e,t,i,s){const n=this.object._getFilter(r.LOOK);if(n){const r=x(n.material,s);r&&(e=null,t=!1,i=r)}return[e,t,i]}_handleOldWorkFlowCommon(e,t,i,r,s,n,a,o){const l=this.object,d=this.renderer;let u=null,p=!1,c=x(t.gas,t);if(n&&a)u=x(a,t);else{const e=l.material||U,i=s||!l.fromLoadedModel,r=e.force&&"forceGeomTypeFACE"!==e.force,n=e.force&&"forceGeomTypeFACE"===e.force,a=i&&r;u=x(e,t),a||(s&&t.material&&t.material.updateDeferredMaterials?u=x(t.material,t):(u=c,p=!0),n&&t._geomType===T&&(u=e,p=!1))}if(this.pickingPass&&t._noPick)return void this._earlyExit();u=this._getBackgroundViewModeMaterial(l,u),!n&&o&&t._geomType===T&&(u=o),[L,p,u]=this.doLookFilter(null,p,u,t),[u,L]=this._getModifiedOriginalMaterial(t,u,p,null,e);const f=d.materialToUse;let h=u._deferredMaterials[f];if(h){if(d.cuttingScene&&!O(h)&&(h=c||h),n&&d.cuttingScene&&t.glType>=4&&(null!==this.cappingMaterial?h=this.cappingMaterial:this.cappingMaterial=h),u.backMaterial){const n=u.backMaterial._deferredMaterials[f];n&&this._addDGToDL({geometry:r,dg:t,dgInterval:i,material:n,gasMaterial:c,originalMaterial:u,renderMode:e,materialMode:s})}this._addDGToDL({geometry:r,dg:t,dgInterval:i,material:h,gasMaterial:c,originalMaterial:u,renderMode:e,materialMode:s})}else this._earlyExit()}_handleLayerOldWorkflow(e,t,i,r){const s=e.drawableGroup,n=e.drawableInterval,a=e.geometry;this._handleOldWorkFlowCommon(i,s,n,a,r,!0,t,null)}_handleGeometryOldWorkflow(e,t,i,r){const s=this.object,n=this.renderer,a=s.material||U,o=i||!s.fromLoadedModel,l=a.force&&"forceGeomTypeFACE"!==a.force;let d=null,u=null;o&&l||!n.cuttingScene&&!r||(u=new Set,d=this._handleObjectSectionCapping(e,r,i,u)),d&&!n.cuttingScene&&("forceGeomTypeFACE"!==a.force||this.QAAutomationMode||(d=a));for(let r=0;r<e.length;r++){const s=e[r],n=s.drawingGroups;for(let e=0;e<n.length;e++){const r=n[e];let a=d;null!==u&&u.has(r)&&(a=null),this._handleOldWorkFlowCommon(t,r,r,s,i,!1,null,a)}}}_handleNewWorkFlowCommon(e,t,i,r,s,n,a,o,l,u){const c=this.object,f=this.renderer,h=t.glType;let g=!1,_=null;const y=c.gas;let m=null;m=y?n.isGAS?n.clone().merge(y):y:n.isGAS?n:null;let S=!1;if(!m||!o||a||0!==t.glType&&1!==t.glType||m._type!==d.SKIN||(a=o._getMaterialFromGLType(4,p.FACE),S=!0),!u){const e=c.material;a&&o||!s&&c.fromLoadedModel||!e||!e.force||"forceGeomTypeFACE"===e.force&&t._geomType!==T||(a=x(e,t))}if(_=y?y.getMaterial(n,h,t.gas.isGAS?t.gas:null,f,G(this.camera,c,n),a):n.isGAS?n.getMaterial(null,h,t.gas,f,G(this.camera,c,n),a):n,S&&a&&a.__dimension>1&&_&&1===_.__dimension&&(a=_._getLineMaterialFromFaceMaterial(a)),m&&(m=this.checkGASStructCommon(m),!m))return;_&&!a&&(a=_,g=!0),[o,g,a]=this.doLookFilter(o,g,a,t),a=this._getBackgroundViewModeMaterial(c,a),[a,o]=this._getModifiedOriginalMaterial(t,a,g,o,e);const b=f.materialToUse;let P=a._deferredMaterials[b];if(P){if(f.cuttingScene&&_&&!O(P)&&(P=_),a.backMaterial){const n=a.backMaterial._deferredMaterials[b];n&&this._addDGToDL({geometry:r,dg:t,dgInterval:i,material:n,originalMaterial:a,renderMode:e,matApp:o,gasMaterial:_,gasStruct:m,materialMode:s})}l&&f.cuttingScene&&h>=4&&(null!==this.cappingMaterial?(P=this.cappingMaterial,a=P):this.cappingMaterial=P),this._addDGToDL({geometry:r,dg:t,dgInterval:i,material:P,originalMaterial:a,renderMode:e,matApp:o,gasMaterial:_,gasStruct:m,materialMode:s})}else this._earlyExit()}_solveIntervalMaterialNewWorkflow(e,t,i){const r=this.object,n=r.matApp;let a=null,o=null;return e.isMatApp&&(a=e.solveInheritance(n,r._occurrence.depth),o=a===n?i:e._getMaterialFromGLType(t.glType,t._geomType)),o||e.isMatApp||(a=i?n:null,o=i,o||(o=e instanceof s?x(e,t):null)),[a,o]}_handleLayerNewWorkflow(e,t,i,r,s){const n=this.object,a=e.drawableGroup,o=a.glType;let l=null,d=null,u=!1;if(s){const e=n.matApp;let i=e&&e._getMaterialFromGLType(o,a._geomType);t?(u=!0,[l,d]=this._solveIntervalMaterialNewWorkflow(t,a,i)):a.material&&([l,d]=this._solveIntervalMaterialNewWorkflow(a.material,a,i)),d||(l=e,d=i)}this._handleNewWorkFlowCommon(r,a,e.drawableInterval,e.geometry,s,i,d,l,!0,u)}_handleGeometryNewWorkflow(e,t,i,r){const s=this.object,n=function(e){return e&&e.materialMode<2}(s);let a=null,o=null;(this.renderer.cuttingScene||r)&&(o=new Set,a=this._handleObjectSectionCapping(e,r,i,o));const l=n?i:i||!s.fromLoadedModel;for(let r=0;r<e.length;r++){const n=e[r],d=n.drawingGroups;for(let e=0;e<d.length;e++){const r=d[e],u=r.glType;let p=null,c=null;if(l){const e=s.matApp;let t=e&&e._getMaterialFromGLType(u,r._geomType);r.material&&([p,c]=this._solveIntervalMaterialNewWorkflow(r.material,r,t)),c||(p=e,c=t),!a||e&&p===e||r._geomType!==T||null!==o&&o.has(r)||(c=a)}this._handleNewWorkFlowCommon(t,r,r,n,i,r.gas,c,p,!1,!1)}}}_handleObjectWithLayers(e,t,i){const r=this.object,s=r.layer,n=this.renderer,a=s.layers.length;this.cappingMaterial=null;for(let o=0;o<a;o++){const a=s.layers[o];let l=a.drawableInterval.getMaterial();if(a.drawableInterval.skip(r,n.visibleSpace)){this._earlyExit();continue}const d=a.drawableGroup;if(e||l&&l.isMatApp){l||(l=d.material);let e=a.drawableInterval.gas;e||(e=d.gas),this._handleLayerNewWorkflow(a,l,e,t,i)}else this._handleLayerOldWorkflow(a,l,t,i)}}_handleObject(e,t,i,r){const s=this.object;s&&s.occurrenceRenderingOverride&&s.occurrenceRenderingOverride.materialOverride&&(s.occurrenceRenderingOverride.materialOverride.disablePGP=i);let n=s.geometry;n.length||0===n.length||(n=[n]),e?this._handleGeometryNewWorkflow(n,t,i,r):this._handleGeometryOldWorkflow(n,t,i,r)}_earlyExit(){const e=this.object,t=this.renderer,r=e._gsso_cache[this.stateSortingResultID];r.length||r.__addCacheItem(new i({dlIndex:-1,material:null,resetFrameIndex:t.resetGSSOCacheFrame,renderLineMode:0}),null)}_addDGToDL({material:t,originalMaterial:i,dg:r=null,dgInterval:s=null,geometry:n,renderMode:a=null,matApp:o=null,gasMaterial:l=null,gasStruct:d=null,materialMode:c=!1}){const f=this.object;let h=!0;{const t=this.renderer,i=t.materialToUse;let s=a?a._maskWithDefault:y.defaultMask;const n=i===u.pickingMaterial||i===u.highlightMaterial;if(n||(s&=~g.SurfacicPointRenderPointMask),r){var _=f&&f.getFilterGeomType(),m=_||r._geomType;if(m||(m=0===r.glType?p.UNKNOWN_0D:p.UNKNOWN),h=(m&s)>0,a&&a._repViewNothing&&!n&&(h=!1),t.renderVolumesOnly){var S=l?l.side:r.gas?r.gas.side:-1;(0===r.glType||1===r.glType||m&y.pointsMask||m&y.linesMask||S===g.DoubleSide)&&(h=!1)}if(this.QAAutomationMode){var b=e.__QA_AUTOMATION_MASK__;h&&(h=(m&b)>0),n&&(h=(m&(b|=E))>0)}}}h&&t.visible?this.renderer.addDGToDL({object:f,geometry:n||f.geometry,dg:r,dgInterval:s,material:t,originalMaterial:i,renderMode:a,matApp:o,gasMaterial:l,gasStruct:d,getDLFromObjectFunc:this.getDLFromObject,geomDisposeFunc:this.onGeometryDisposeDS,camera:this.camera,materialMode:c})||this._earlyExit():this._earlyExit()}solve(e){this.object=e;const i=this.object._occurrence,s=this.renderer,n=s.materialToUse,a=e.material;let o=null;const l=e.matApp,d=s.newMaterialInheritance||!!function(e){if(!e.geometry.length)return!1;const t=e.geometry[0].drawingGroups;return!(!t||!t.length)&&t[0].gas&&t[0].gas.isGAS}(e)||!!l;e._gsso_cache||(e._gsso_cache=s.createGSSOCache(e)),e._gsso_cache[this.stateSortingResultID]||(e._gsso_cache[this.stateSortingResultID]=new t(e,s.resetGSSOCacheFrame,s.use_webgpu));var p=e._getFilter(r._MATERIAL_TO_USE);if(p&&p.materialToUse!==n)return void this._earlyExit();var f=e._getFilter(r.NO_HIGHLIGHT);if(f&&n===u.highlightMaterial){const e=s.currentPass;if(e&&e.name&&e.name.includes("prehlRenderPass")){if(f.skipPreHL)return void this._earlyExit()}else if(f.skipHL)return void this._earlyExit()}if(i&&i._isFurtiveFiltered())return void this._earlyExit();if(n===u.originalMaterial&&e._setForceBackFacesOnSolid(!1),!d&&a&&(a._deferredMaterialsInit||a.updateDeferredMaterials(),a.line&&!a.line._deferredMaterialsInit&&a.line.updateDeferredMaterials(),a.point&&!a.point._deferredMaterialsInit&&a.point.updateDeferredMaterials(),o=a._deferredMaterials[n]),void 0===o&&(o=a),e._updateBackgroundViewMode(this.renderer._invertBackgroundNodes),s._backgroundViewMode===h.NO_DISPLAY&&e.applyBackgroundViewMode)return void this._earlyExit();let g=e._getFilter(r.PLANE_VIEW_MODE);if(e._applyPlaneViewMode=c.NORMAL,e._applyPlaneViewModeColor=!1,e._programID&=~R.PLANE_VIEW_MODE,g&&g.mode!==c.NORMAL){for(let t of g.planeFilters)if(e._updatePlaneViewMode(t.plane,t.mode),e._applyPlaneViewMode===c.NO_DISPLAY)return void this._earlyExit();if(e._applyPlaneViewMode!==c.LOWLIGHT_NO_PICK&&e._applyPlaneViewMode!==c.LOWLIGHT||(e._applyPlaneViewModeColor=!0,e._programID|=R.PLANE_VIEW_MODE),this.pickingPass&&(e._applyPlaneViewMode===c.LOWLIGHT_NO_PICK||e._applyPlaneViewMode===c.NO_PICK))return void this._earlyExit()}let _=s.getRenderMode(e);if(2===e.geometry._type||e.geometry.length>=0){const t=e.layer,i=this._getMaterialMode(_);this._handleOutlines(_);const r=this._handleSectionLines(_);t?this._handleObjectWithLayers(d,_,i):this._handleObject(d,_,i,r)}else d&&a?(a._deferredMaterialsInit||a.updateDeferredMaterials(),a.backMaterial&&this._addDGToDL({material:a.backMaterial._deferredMaterials[n],originalMaterial:a}),this._addDGToDL({material:a._deferredMaterials[n],originalMaterial:a})):(o.backMaterial&&this._addDGToDL({material:o.backMaterial._deferredMaterials[n],originalMaterial:a}),this._addDGToDL({material:o,originalMaterial:a}))}}})),define("DS/RenderEngineUtils/StateSortingResult",["DS/Mesh/ThreeJS_Base","DS/RenderEngineUtils/DisplayList","DS/Visualization/CullingSystem"],(function(e,t,i){"use strict";var r=null,s=null,n=null,a=i.__CullingSystemFactory;e.nbDisplayListPriority=73,e.displayListPriorityEnum={},e.displayListPriorityEnum.dlSolids_iso0=72.1,e.displayListPriorityEnum.dlSolids=72,e.displayListPriorityEnum.dlSolids_iso2=71.9,e.displayListPriorityEnum.dlSolids_iso3=71.8,e.displayListPriorityEnum.dlSurfaces_iso0=71.1,e.displayListPriorityEnum.dlSurfaces=71,e.displayListPriorityEnum.dlSurfaces_iso2=70.9,e.displayListPriorityEnum.dlSurfaces_iso3=70.8,e.displayListPriorityEnum.dlSurfacesCurvedPipes=70,e.displayListPriorityEnum.dlOutlines=69,e.displayListPriorityEnum.dlEdges_iso0=68.1,e.displayListPriorityEnum.dlEdges=68,e.displayListPriorityEnum.dlEdges_iso2=67.9,e.displayListPriorityEnum.dlEdges_iso3=67.8,e.displayListPriorityEnum.dlPoints_iso0=67.1,e.displayListPriorityEnum.dlPoints=67,e.displayListPriorityEnum.dlPoints_iso2=66.9,e.displayListPriorityEnum.dlPoints_iso3=66.8,e.displayListPriorityEnum.dlRenderDepthNegative=66.5,e.displayListPriorityEnum._OITStart=66,e.displayListPriorityEnum.dlDecals=66,e.displayListPriorityEnum.dlBack=65,e.displayListPriorityEnum.dlTranspar1D=64,e.displayListPriorityEnum.dlSurfacesCurvedPipesTranspar=63,e.displayListPriorityEnum.dlTranspar=62,e.displayListPriorityEnum._OITEnd=62,e.displayListPriorityEnum.dlEdgeAdjacenceSelection=61,e.displayListPriorityEnum.dlEdgePrimitiveSelection=60,e.displayListPriorityEnum.dlPointPrimitiveSelection=59,e.displayListPriorityEnum._PostOIT=59,e.displayListPriorityEnum.dlRenderDepthPositive=58.5,e.displayListPriorityEnum._RespectSGOrderStart=58,e.displayListPriorityEnum.dlNoZ=58,e.displayListPriorityEnum.dlNoZTranspar=57,e.displayListPriorityEnum.dlDepthValue=56,e.displayListPriorityEnum.dlDepthValue2=55,e.displayListPriorityEnum.OTHER3D_2DMODE=54,e.displayListPriorityEnum.OTHER3D=36,e.displayListPriorityEnum.priority0=53,e.displayListPriorityEnum.priority1=51,e.displayListPriorityEnum.priority2=49,e.displayListPriorityEnum.priority3=47,e.displayListPriorityEnum.priority4=45,e.displayListPriorityEnum.priority5=43,e.displayListPriorityEnum.priority6=41,e.displayListPriorityEnum.priority7=39,e.displayListPriorityEnum.priority8=37,e.displayListPriorityEnum.priority9=34,e.displayListPriorityEnum.priority10=32,e.displayListPriorityEnum.priority11=30,e.displayListPriorityEnum.priority12=28,e.displayListPriorityEnum.priority13=26,e.displayListPriorityEnum.priority14=24,e.displayListPriorityEnum.priority15=22,e.displayListPriorityEnum.priorityP0=52,e.displayListPriorityEnum.priorityP1=50,e.displayListPriorityEnum.priorityP2=48,e.displayListPriorityEnum.priorityP3=46,e.displayListPriorityEnum.priorityP4=44,e.displayListPriorityEnum.priorityP5=42,e.displayListPriorityEnum.priorityP6=40,e.displayListPriorityEnum.priorityP7=38,e.displayListPriorityEnum.priorityP8=35,e.displayListPriorityEnum.priorityP9=33,e.displayListPriorityEnum.priorityP10=31,e.displayListPriorityEnum.priorityP11=29,e.displayListPriorityEnum.priorityP12=27,e.displayListPriorityEnum.priorityP13=25,e.displayListPriorityEnum.priorityP14=23,e.displayListPriorityEnum.priorityP15=21,e.displayListPriorityEnum.HEDGE=20,e.displayListPriorityEnum.HOTHER=19,e.displayListPriorityEnum.FURTIVE_EDGE=18,e.displayListPriorityEnum.FURTIVE=17,e.displayListPriorityEnum.OTHER2D=16,e.displayListPriorityEnum.TRANSPAR2DP15=15,e.displayListPriorityEnum.TRANSPAR2DP14=14,e.displayListPriorityEnum.TRANSPAR2DP13=13,e.displayListPriorityEnum.TRANSPAR2DP12=12,e.displayListPriorityEnum.TRANSPAR2DP11=11,e.displayListPriorityEnum.TRANSPAR2DP10=10,e.displayListPriorityEnum.TRANSPAR2DP9=9,e.displayListPriorityEnum.TRANSPAR2DP8=8,e.displayListPriorityEnum.TRANSPAR2DP7=7,e.displayListPriorityEnum.TRANSPAR2DP6=6,e.displayListPriorityEnum.TRANSPAR2DP5=5,e.displayListPriorityEnum.TRANSPAR2DP4=4,e.displayListPriorityEnum.TRANSPAR2DP3=3,e.displayListPriorityEnum.TRANSPAR2DP2=2,e.displayListPriorityEnum.TRANSPAR2DP1=1,e.displayListPriorityEnum.TRANSPAR2DP0=0,e.displayListPriorityEnum._RespectSGOrderEnd=0,e.displayListPriorityEnum.priority=[e.displayListPriorityEnum.priority0,e.displayListPriorityEnum.priority1,e.displayListPriorityEnum.priority2,e.displayListPriorityEnum.priority3,e.displayListPriorityEnum.priority4,e.displayListPriorityEnum.priority5,e.displayListPriorityEnum.priority6,e.displayListPriorityEnum.priority7,e.displayListPriorityEnum.priority8,e.displayListPriorityEnum.priority9,e.displayListPriorityEnum.priority10,e.displayListPriorityEnum.priority11,e.displayListPriorityEnum.priority12,e.displayListPriorityEnum.priority13,e.displayListPriorityEnum.priority14,e.displayListPriorityEnum.priority15],e.displayListPriorityEnum.priorityP=[e.displayListPriorityEnum.priorityP0,e.displayListPriorityEnum.priorityP1,e.displayListPriorityEnum.priorityP2,e.displayListPriorityEnum.priorityP3,e.displayListPriorityEnum.priorityP4,e.displayListPriorityEnum.priorityP5,e.displayListPriorityEnum.priorityP6,e.displayListPriorityEnum.priorityP7,e.displayListPriorityEnum.priorityP8,e.displayListPriorityEnum.priorityP9,e.displayListPriorityEnum.priorityP10,e.displayListPriorityEnum.priorityP11,e.displayListPriorityEnum.priorityP12,e.displayListPriorityEnum.priorityP13,e.displayListPriorityEnum.priorityP14,e.displayListPriorityEnum.priorityP15];var o=0;class l{constructor(t,i){null===r&&(r=e.Constants,s=e.MaterialToUse,n=e.DrawCallSorting),this.id=o++,this._displayLists=[],this._resetGSSOCacheIndex=-1,this._lastDefragIndex=0,this._pickingPriorityMapping=null,this.pass=t,this.materialToUse=i,this.overridableMaterial=i===s.originalMaterial||i===s.oitAccumMaterial||i===s.oitRevealMaterial||i===s.transparentShadowMaterial,this.init()}init(){for(var i=new t({name:"SOLID",priority:e.displayListPriorityEnum.dlSolids,drawCallSort:n.FrontToBackSort,side:r.FrontSide,polygonOffset:!0,isoSupport:!0}),s=new t({name:"SOLID_ISO0",priority:e.displayListPriorityEnum.dlSolids_iso0,drawCallSort:n.FrontToBackSort,side:r.FrontSide,polygonOffset:!0}),a=new t({name:"SOLID_ISO2",priority:e.displayListPriorityEnum.dlSolids_iso2,drawCallSort:n.FrontToBackSort,side:r.FrontSide,polygonOffset:!0}),o=new t({name:"SOLID_ISO3",priority:e.displayListPriorityEnum.dlSolids_iso3,drawCallSort:n.FrontToBackSort,side:r.FrontSide,polygonOffset:!0}),l=new t({name:"SURFACE",priority:e.displayListPriorityEnum.dlSurfaces,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!0,isoSupport:!0}),d=new t({name:"SURFACE_ISO0",priority:e.displayListPriorityEnum.dlSurfaces_iso0,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!0}),u=new t({name:"SURFACE_ISO2",priority:e.displayListPriorityEnum.dlSurfaces_iso2,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!0}),p=new t({name:"SURFACE_ISO3",priority:e.displayListPriorityEnum.dlSurfaces_iso3,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!0}),c=new t({name:"EDGE",priority:e.displayListPriorityEnum.dlEdges,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,isoSupport:!0}),f=new t({name:"EDGE_ISO0",priority:e.displayListPriorityEnum.dlEdges_iso0,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),h=new t({name:"EDGE_ISO2",priority:e.displayListPriorityEnum.dlEdges_iso2,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),g=new t({name:"EDGE_ISO3",priority:e.displayListPriorityEnum.dlEdges_iso3,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),_=new t({name:"OUTLINE",priority:e.displayListPriorityEnum.dlOutlines,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),y=new t({name:"SURFACE_CURVED_PIPE",priority:e.displayListPriorityEnum.dlSurfacesCurvedPipes,drawCallSort:n.FrontToBackSort,side:e.DoubleSide,polygonOffset:!0}),m=new t({name:"SURFACE_CURVED_PIPE_TRANSPAR",priority:e.displayListPriorityEnum.dlSurfacesCurvedPipesTranspar,drawCallSort:n.BackToFrontSort,side:r.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0}),S=new t({name:"BACK",priority:e.displayListPriorityEnum.dlBack,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!0,depthWrite:!1,depthFunc:"GREATER",hasPoliteDepth:!1,hasOcclusionDepth:!1}),b=new t({name:"POINT",priority:e.displayListPriorityEnum.dlPoints,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,isoSupport:!0}),P=new t({name:"POINT_ISO0",priority:e.displayListPriorityEnum.dlPoints_iso0,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),E=new t({name:"POINT_ISO2",priority:e.displayListPriorityEnum.dlPoints_iso2,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),v=new t({name:"POINT_ISO3",priority:e.displayListPriorityEnum.dlPoints_iso3,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),D=new t({name:"DECALS",priority:e.displayListPriorityEnum.dlDecals,drawCallSort:n.DecalSort,side:r.DoubleSide,polygonOffset:!0,hasTranspar:!0,hasPoliteDepth:!1,hasOcclusionDepth:!1}),w=new t({name:"TRANSPAR1D",priority:e.displayListPriorityEnum.dlTranspar1D,drawCallSort:n.BackToFrontSort,side:r.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0,hasOcclusionDepth:!1}),R=new t({name:"TRANSPAR",priority:e.displayListPriorityEnum.dlTranspar,drawCallSort:n.BackToFrontSort,side:r.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0,canForceSideOnSolids:!0}),O=new t({name:"EDGEADJACENCESELECTION",priority:e.displayListPriorityEnum.dlEdgeAdjacenceSelection,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,hasPoliteDepth:!1,depthTest:!1}),L=new t({name:"EDGEPRIMITIVESELECTION",priority:e.displayListPriorityEnum.dlEdgePrimitiveSelection,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,hasPoliteDepth:!1,depthTest:!1}),T=new t({name:"POINTPRIMITIVESELECTION",priority:e.displayListPriorityEnum.dlPointPrimitiveSelection,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,hasPoliteDepth:!1,depthTest:!1}),I=new t({name:"RenderDepthNegative",priority:e.displayListPriorityEnum.dlRenderDepthNegative,drawCallSort:n.RenderDepthSort,side:r.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0,hasOcclusionDepth:!1,noz:!0,canForceSideOnSolids:!0}),M=new t({name:"RenderDepthPositive",priority:e.displayListPriorityEnum.dlRenderDepthPositive,drawCallSort:n.RenderDepthSort,side:r.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0,hasOcclusionDepth:!1,noz:!0,canForceSideOnSolids:!0}),U=new t({name:"NOZ",priority:e.displayListPriorityEnum.dlNoZ,drawCallSort:n.FrontToBackSort,side:r.DoubleSide,polygonOffset:!0,clearDepth:!0,hasPoliteDepth:!1,hasOcclusionDepth:!1,noz:!0}),x=new t({name:"DEPTHVALUE2",priority:e.displayListPriorityEnum.dlDepthValue2,drawCallSort:n.NeverSort,side:r.DoubleSide,hasPoliteDepth:!1,hasOcclusionDepth:!1,depthTest:!1,noz:!0}),B=new t({name:"DEPTHVALUE",priority:e.displayListPriorityEnum.dlDepthValue,drawCallSort:n.FrontToBackSort,side:r.DoubleSide}),G=new t({name:"NOZTRANSPAR",priority:e.displayListPriorityEnum.dlNoZTranspar,drawCallSort:n.BackToFrontSort,side:r.DoubleSide,polygonOffset:!0,hasPoliteDepth:!1,hasOcclusionDepth:!1,depthTest:!1,noz:!0}),A=new t({name:"OTHER2D",priority:e.displayListPriorityEnum.OTHER2D,drawCallSort:n.NeverSort,side:r.DoubleSide,noz:!0,depthTest:!0,depthWrite:!0,hasOcclusionDepth:!0,hasPoliteDepth:!1}),C=new t({name:"OTHER3D",priority:e.displayListPriorityEnum.OTHER3D,drawCallSort:n.NeverSort,side:r.DoubleSide,depthTest:!1,noz:!0,hasOcclusionDepth:!0,hasPoliteDepth:!1}),k=0;k<16;k++){var F=new t({name:"NOZPRIORITY"+k,priority:e.displayListPriorityEnum.priority[k],drawCallSort:n.NeverSort,side:r.DoubleSide,polygonOffset:!0,depthTest:!1,hasOcclusionDepth:!0,hasPoliteDepth:!1,noz:!0});this.addDisplayList(F)}for(k=0;k<16;k++){F=new t({name:"NOZPRIORITYP"+k,priority:e.displayListPriorityEnum.priorityP[k],drawCallSort:n.NeverSort,side:r.DoubleSide,polygonOffset:!0,depthTest:!1,depthFunc:"ALWAYS",hasOcclusionDepth:!0,hasPoliteDepth:!1,noz:!0});this.addDisplayList(F)}for(k=0;k<16;k++){F=new t({name:"TRANSPAR2DP"+k,priority:e.displayListPriorityEnum.TRANSPAR2DP0+k,drawCallSort:n.NeverSort,side:r.DoubleSide,depthTest:!0,noz:!0,depthWrite:!1,hasPoliteDepth:!1,hasOcclusionDepth:!1,hasTranspar:!0});this.addDisplayList(F)}this.addDisplayList(s),this.addDisplayList(i),this.addDisplayList(a),this.addDisplayList(o),this.addDisplayList(d),this.addDisplayList(l),this.addDisplayList(u),this.addDisplayList(p),this.addDisplayList(y),this.addDisplayList(m),this.addDisplayList(_),this.addDisplayList(f),this.addDisplayList(c),this.addDisplayList(h),this.addDisplayList(g),this.addDisplayList(S),this.addDisplayList(P),this.addDisplayList(b),this.addDisplayList(E),this.addDisplayList(v),this.addDisplayList(D),this.addDisplayList(R),this.addDisplayList(w),this.addDisplayList(O),this.addDisplayList(L),this.addDisplayList(T),this.addDisplayList(U),this.addDisplayList(G),this.addDisplayList(A),this.addDisplayList(C),this.addDisplayList(B),this.addDisplayList(x),this.addDisplayList(I),this.addDisplayList(M)}addDisplayList(e){var t,i=!1;if(this._displayLists.length&&void 0!==e.priority)for(t=0;t<this._displayLists.length&&!i;t++){var r=this._displayLists[t].priority;e.priority>r&&(this.insertDisplayList(e,t),i=!0)}for(i||this._displayLists.push(e),t=0;t<this._displayLists.length;t++)this._displayLists[t].index=t;return e.ssrId=this.id,e.ssr=this,e}insertDisplayList(e,t){this._displayLists.splice(t,0,e)}getDisplayListByPriority(e){for(var t=0;t<this._displayLists.length;t++)if(this._displayLists[t].priority===e)return this._displayLists[t];return null}getDisplayListByName(e){for(var t=0;t<this._displayLists.length;t++)if(this._displayLists[t].name===e)return this._displayLists[t];return null}}function d(t,i){return t?"c"+(t._renderingRole===e._CameraRoles.NONE||i&&i._checkCamera?t.id:t._renderingRole):"c"}var u={_getStateSortingResult:function(e,t,i,r,s){const n=s.pass;var a;i?(a="id"+i.id+d(r,i),t&&(a+="s"+t.id,s.addScene(t.id))):a="noid",n&&n.hideSurfacesAndUnclipedMeshes&&(a+="h");var o=s.getCache(a);if(o)return o;var u=new l(n,e);return s.addCache(a,u),u},_getCullingSystem:function(e,t,i,r,s){var n=r+d(e,i);return s&&s.hideSurfacesAndUnclipedMeshes&&(n+="h"),a.get(t,n)}};return u.StateSortingResultCache=class{constructor(e){this.pass=e,this.scenes=new Set,this.cache={}}getCache(e){return this.cache[e]}addCache(e,t){this.cache[e]=t}cleanCache(){this.scenes.clear(),this.cache={}}addScene(e){this.scenes.add(e)}nbScenes(){return this.scenes.size}},u})),define("DS/RenderEngineUtils/RenderEngineUtils",["DS/RenderEngineUtils/StateSortingResult","DS/RenderEngineUtils/DisplayList","DS/RenderEngineUtils/InheritanceSolver","DS/RenderEngineUtils/StateSortingCacheItem","DS/RenderEngineUtils/StateSortingCache"],(function(e,t,i,r,s){"use strict";return{StateSortingResult:e,DisplayList:t,InheritanceSolver:i,StateSortingCacheItem:r,StateSortingCache:s}}));