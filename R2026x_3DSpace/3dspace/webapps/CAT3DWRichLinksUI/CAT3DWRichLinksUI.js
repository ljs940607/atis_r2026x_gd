define("DS/CAT3DWRichLinksUI/CAT3DWLinkPlaceholderHtmlView",["UWA/Class","DS/CAT3DWInfraUI/CAT3DWCanvasServices"],(function(t,e){"use strict";var n=t.extend({init:function(t){this._mainContainerClassName="link-placeholder-view",this._mainContainer=null,this._viewParams=t,this._htmlElement=null},getHTML:function(){return this._htmlElement},getCanvasFromImage:function(t){var n=(new e).createCanvas({width:t.width,height:t.height,tag:"LinkPlaceholderHtmlViewCanvas"}),i=n.getContext("2d");return i.fillStyle="white",i.fillRect(0,0,t.width,t.height),i.drawImage(t,0,0,t.width,t.height),this._htmlElement=new Image,this._htmlElement.src=n.toDataURL(),n}});return UWA.namespace("DS/CAT3DWRichLinksUI/CAT3DWLinkPlaceholderHtmlView",n)})),define("DS/CAT3DWRichLinksUI/CAT3DWLinkFullHtmlView",["UWA/Class","UWA/Core","DS/VENWebHtml2Canvas/Html2Canvas","i18n!DS/CAT3DWRichLinksUI/assets/nls/CAT3DWLinkFullHtmlView","css!DS/CAT3DWRichLinksUI/CAT3DWRichLinksUI"],(function(t,e,n,i){"use strict";var a=t.extend({init:function(t){this._mainContainerClassName="link-full-view",this._mainContainer=null,this._viewParams=t,this._swymV3=t.swymv3},getHTML:async function(){return this._mainContainer||await this._build(this._viewParams),this._mainContainer},getCanvas:function(){return new Promise(((t,e)=>{const i=new n;this.getHTML().then((n=>{document.body.append(n),i.htmlToCanvas(n,{onclone:t=>{const e=t.getElementsByClassName(this._mainContainerClassName);e&&(e[e.length-1].style.opacity="1")},allowTaint:!0,useCORS:!0,scale:2}).then((e=>{this.clean(),t(e)})).catch((t=>{this.clean(),e(t)}))}))}))},clean:function(){this._mainContainer.remove(),this._mainContainer=null},_build:function(t){return new Promise((n=>{t||console.warn("[CAT3DWLinkFullHtmlView : no params to build link view]"),t.message&&(t.message=t.message.replaceAll(":upper-latin",":upper-alpha"),t.message=t.message.replaceAll(":lower-latin",":lower-alpha")),this._mainContainer=new e.Element("div",{class:this._mainContainerClassName}),this._swymV3&&this._mainContainer.addClassName("swymv3");var a=new e.Element("div",{class:"linkfull-header-container"}).inject(this._mainContainer),s=new e.Element("div",{class:"linkfull-body-container"}).inject(this._mainContainer),o=new e.Element("div",{class:"linkfull-title-container"}).inject(a),r=new e.Element("div",{class:"linkfull-subtitle-container"}).inject(s),l=new e.Element("div",{class:"linkfull-message-container"}).inject(s),c=this._getFonticon(t.type);new e.Element("div",{class:"preview-icon",html:{tag:"span",class:"fonticon "+c.name},styles:{color:c.color,"background-color":c.bkcolor}}).inject(o),new e.Element("div",{class:"preview-title",text:t.title}).inject(o);var u=[{tag:"span",text:i.get("authorPrep")+" "},{tag:"a",class:"author",text:t.author}];t.community&&(u.push({tag:"span",text:" "+i.get("communityPrep")+" "}),u.push({tag:"a",class:"community",text:t.community})),new e.Element("div",{class:"preview-author-community",html:u}).inject(r);var h=new e.Element("div",{class:"preview-message"}).inject(l);h.innerHTML=t.message;let m=h.querySelectorAll('[reversed="reversed"]');if(m&&m.length)for(let t=0;t<m.length;t++){let e=m[t].children.length;m[t].setAttribute("start",e)}let d=h.getElementsByTagName("code");if(d&&d.length)for(let t=0;t<d.length;t++)d[t].classList.contains("language-css")?d[t].parentNode.setAttribute("data-language","CSS"):d[t].classList.contains("language-plaintext")?d[t].parentNode.setAttribute("data-language","Plain text"):d[t].classList.contains("language-javascript")?d[t].parentNode.setAttribute("data-language","JavaScript"):d[t].classList.contains("language-c")?d[t].parentNode.setAttribute("data-language","C"):d[t].classList.contains("language-cs")?d[t].parentNode.setAttribute("data-language","C#"):d[t].classList.contains("language-cpp")?d[t].parentNode.setAttribute("data-language","C++"):d[t].classList.contains("language-diff")?d[t].parentNode.setAttribute("data-language","Diff"):d[t].classList.contains("language-html")?d[t].parentNode.setAttribute("data-language","HTML"):d[t].classList.contains("language-java")?d[t].parentNode.setAttribute("data-language","Java"):d[t].classList.contains("language-php")?d[t].parentNode.setAttribute("data-language","PHP"):d[t].classList.contains("language-python")?d[t].parentNode.setAttribute("data-language","Python"):d[t].classList.contains("language-ruby")?d[t].parentNode.setAttribute("data-language","Ruby"):d[t].classList.contains("language-typescript")?d[t].parentNode.setAttribute("data-language","TypeScript"):d[t].classList.contains("language-xml")&&d[t].parentNode.setAttribute("data-language","XML");var p=h.getElementsByTagName("img");if(!p.length)return void n();if(t.images)for(let e=0;e<p.length;e++)p[e].dataset.mediaId&&(p[e].src=t.images[p[e].dataset.mediaId].url);let g=setInterval((()=>{let t=!0;for(let e=0;e<p.length;e++)if(!p[e].complete){t=!1;break}t&&(clearInterval(g),g=void 0,n())}),10)}))},_getFonticon:function(t){switch(t){case"posts":case"post":return{name:"fonticon-newspaper",color:this._swymV3?"#3d3d3d":"white",bkcolor:this._swymV3?"white":"#adadad"};case"idea":return{name:"fonticon-lightbulb",color:this._swymV3?"#00b8de":"white",bkcolor:this._swymV3?"white":"#00b8de"};case"iquestion":return{name:this._swymV3?"fonticon-comment-question ":"fonticon-i-question",color:this._swymV3?"#e7b401":"white",bkcolor:this._swymV3?"white":"#ea4f37"};case"wiki":return{name:"fonticon-book-open",color:this._swymV3?"#00aa86":"white",bkcolor:this._swymV3?"white":"#00aa86"};default:return{name:"fonticon-globe",color:this._swymV3?"#3d3d3d":"#77797c",bkcolor:"white"}}}});return e.namespace("DS/CAT3DWRichLinksUI/CAT3DWLinkFullHtmlView",a)})),define("DS/CAT3DWRichLinksUI/CAT3DWLinkProcessingUtils",["UWA/Class","UWA/Core","DS/CAT3DWInfra/CAT3DWPlateformServices","DS/CAT3DWInfra/CAT3DWUrlServices","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices"],(function(t,e,n,i,a,s){"use strict";var o=t.extend({init:function(t){this._platformId=t.platformId,this._platformUrl=t.platformUrl;var n=t.appName;this._uwarequestor=e.Data,!n&&e.Data.proxies.ajax.contains("netvibes")&&window.parent&&window.parent.UWA&&window.parent.UWA.Data&&window.parent.UWA.Data.proxies&&(this._uwarequestor=window.parent.UWA.Data),this._debugMode=t.debugMode,this._urlService=new i},isHTTPLinkFormat:function(t){var e=t.trim();return!(!e.startsWith("http://")&&!e.startsWith("https://"))&&this.isLinkFormat(e)},isLinkFormat:function(t){return!(!this._urlService.isValidHttpUrl(t)||t.contains(" "))},processLink:function(t){return new Promise((e=>{this._debugMode&&console.time("[CAT3DWLinkProcessingUtils] Process link : "+t);var n=this.formatLink(t),i=function(n){this._debugMode&&console.timeEnd("[CAT3DWLinkProcessingUtils] Process link : "+t),e(n)}.bind(this);this.getLinkType(n).then(this.getContentType.bind(this)).then((t=>{t.type===o.LINK_INTERNAL?this.getPlatformContent(t).then((function(t){i(t)})).catch((t=>{t.type=o.LINK_EXTERNAL,this.getWebContent(t).then((function(t){i(t)})).catch((function(t){i(t)}))})):t.type===o.LINK_EXTERNAL&&this.getWebContent(t).then((function(t){i(t)})).catch((function(t){i(t)}))}))}))},formatLink:function(t){var e=t.trim();return e.startsWith("//")&&(e="https:"+e),e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e),e},getLinkType:function(t){return new Promise((e=>{this._getPlatformUrl().then((function(n){var i=!1,a=t.startsWith(n);if(!a){var s=null!==t.match("#app:X3DMCTY_AP")&&2===t.match(/content:url=(.*?(?=&))/i).length&&t.match(/content:url=(.*?(?=&))/i)[1].replace(/%3A/g,":").replace(/%2F/g,"/").replace(/%2e/g,".");i=n&&n===s}e(i||a?{url:t,type:o.LINK_INTERNAL}:{url:t,type:o.LINK_EXTERNAL})})).catch((function(){e({url:t,type:o.LINK_EXTERNAL})}))}))},getContentType:function(t){return new Promise((function(e){if(t.type===o.LINK_EXTERNAL)t.content_type=o.CONTENT_UNKNOWN,e(t);else if(t.type===o.LINK_INTERNAL){var n,i,a=t.url;a.contains("#app")?(i=a.match(/contentType=([^&]*)/i)[1],n=a.match(/contentId=([^&]*)/i)[1]):a.contains("post")?(i=o.CONTENT_POST,n=a.match(/post:([^/]{0,})/i)[1]):a.contains("iquestion")?(i=o.CONTENT_QUESTION,n=a.match(/iquestion:([^/]{0,})/i)[1]):a.contains("question")?(i=o.CONTENT_QUESTION,n=a.match(/question:([^/]{0,})/i)[1]):a.contains("ideation")?(i=o.CONTENT_IDEA,n=a.match(/ideation:([^/]{0,})/i)[1]):a.contains("idea")?(i=o.CONTENT_IDEA,n=a.match(/idea:([^/]{0,})/i)[1]):a.contains("wikitree")?(i=o.CONTENT_WIKI,n=a.match(/wikitree:([^/]{0,})/i)[1]):a.contains("wiki")?(i=o.CONTENT_WIKI,n=a.match(/wiki:([^/]{0,})/i)[1]):a.contains("media")?(i=o.CONTENT_MEDIA,n=a.match(/media:([^/]{0,})/i)[1]):a.contains("survey")?(i=o.CONTENT_SURVEY,n=a.match(/survey:([^/]{0,})/i)[1]):a.contains("wedo")?(i=o.CONTENT_WEDO,n=a.match(/wedo:([^/]{0,})/i)[1]):(i=o.CONTENT_UNKNOWN,n=null),t.content_type=i,t.content_id=n,e(t)}}))},getPlatformContent:function(t){return new Promise(function(e,i){if(t.content_type===o.CONTENT_UNKNOWN)return delete t.content_id,void i(t);this._getPlatformUrl().then(n.getCsrfToken.bind(this)).then(function(a){n.search({url:a.url,token:a.token,legacyFormat:!1,query:"#all",contentType:t.content_type,refineUsingQuery:'id:"'+t.content_id+'"',nresults:1,start:0}).then(async function(r){if(0!==r.nhits){var l=r.hits[0].metas;t.content={};for(let e=0;e<l.length;e++){if("id"===l[e].name&&t.content_id!==l[e].value)return t.content_type=o.CONTENT_UNKNOWN,delete t.content_id,void i(t);"title"===l[e].name&&(t.content.title=l[e].value),"name"===l[e].name&&(t.content.author=l[e].value),"ds6w_58_community"===l[e].name&&(t.content.community=l[e].value),"ds6w_58_description"===l[e].name&&(t.content.description=l[e].value),"preview_media_type"===l[e].name&&t.content_type===o.CONTENT_MEDIA&&(t.content.mediaType=l[e].value),"preview_media_id"===l[e].name&&l[e].value&&(t.content.thumbnail_id=l[e].value)}await new Promise((e=>{t.content.thumbnail_id?s.getMedia({mediaId:t.content.thumbnail_id}).then((function(n){t.content.thumbnail_url=n.previewurl,t.content.thumbnail_published=parseInt(n.published),e()})).catch((function(){e()})):e()})),await new Promise((e=>{var i={},r="";if(t.content_type===o.CONTENT_POST)r="/api/post/get",i.community_post_id=t.content_id;else if(t.content_type===o.CONTENT_QUESTION)r="/api/question/get",i.iQuestions_id=t.content_id;else if(t.content_type===o.CONTENT_IDEA)r="/api/idea/get",i.id=t.content_id;else{if(t.content_type!==o.CONTENT_WIKI)return void e();r="/api/wiki/get",i.id=t.content_id}n.callPlatformWebService({url:a.url,params:i,api:r,token:a.token,returnPromise:!1,onSuccessCB:n=>{if(t.content_type===o.CONTENT_QUESTION?t.content.message=n.result.question:t.content.message=n.result.message,!n.result.thumbnails_infos.length)return void e();let i=[],a=n.result.thumbnails_infos;for(let t=0;t<a.length;t++)!0===a[t].user_access&&"processed"===a[t].preview_media_processing_status&&i.push({mediaId:a[t].media_id});s.getMedias(i,(function(){})).then((n=>{t.content.images_infos={};for(let e=0;e<n.length;e++){var i=n[e].mediaId.split("media:")[1];t.content.images_infos[i]={url:n[e].previewurl,published:parseInt(n[e].published)}}e()})).catch((function(){e()}))},onFailCB:function(){e()}})})),e(t)}else t.content_unauthorized=!0,t.content_type=o.CONTENT_UNKNOWN,delete t.content_id,i(t)}.bind(this)).catch((function(){t.content_type=o.CONTENT_UNKNOWN,delete t.content_id,i(t)}))}.bind(this)).catch((function(){t.content_type=o.CONTENT_UNKNOWN,delete t.content_id,i(t)}))}.bind(this))},getWebContent:function(t){return new Promise(function(e,n){var i={};i.url=t.url,i.responseType="text",i.requestor=this.getUWARequestor(),i.proxy="ajax",this.requestExternalUrl(i).then(function(n){t.content={};var a=n.headers.get("content-type"),s=null;if(a.match(/text\/html/g)||a.match(/application\/xhtml/g)){var o=(new DOMParser).parseFromString(n.data,"text/html"),r=o.getElementsByTagName("meta");if(t.content.title=o.title,t.content.description=null,r){r.description&&(t.content.description=r.description.content);for(let e=0;e<r.length;e++)!t.content.title&&r[e].getAttribute("property")&&"og:title"===r[e].getAttribute("property")&&(t.content.title=r[e].getAttribute("content")),!t.content.description&&r[e].getAttribute("property")&&"og:description"===r[e].getAttribute("property")&&(t.content.description=r[e].getAttribute("content")),r[e].getAttribute("property")&&"og:image"===r[e].getAttribute("property")&&(s=r[e].getAttribute("content"))}}var l=new URL(i.url);t.content.hostname=l.hostname,t.content.title||(t.content.title=l.hash),s?this._getImageBlobExternalUrl(s).then((function(n){t.content.thumbnail_blob_url=n,e(t)})).catch((function(){e(t)})):e(t)}.bind(this)).catch((function(){t.notreachable=!0,n(t)}))}.bind(this))},requestExternalUrl:function(t){return new Promise((function(e,n){if(a.getPreferenceValue("ODTMockLink")){let n=new URL(t.url,document.baseURI).href;const i=new XMLHttpRequest;return i.onload=t=>{let a=new Headers;if(a.append("Content-Type",i.response.type),"text/html"===i.response.type)i.response.text().then((function(t){e({data:t,requestedUrl:n,headers:a})}));else if(i.response.type.includes("image/")){i.response;e({data:i.response,requestedUrl:n,headers:a})}},i.open("GET",n),i.responseType="blob",void i.send()}var i=t.requestor,s=t.proxy,o=t.responseType?t.responseType:"text",r=null;r=s?i.proxifyUrl(t.url,{proxy:s}):t.url,i.request(r,{proxy:s,timeout:1e4,type:o,onComplete:function(t,n){var i=new Headers(n);e({data:t,requestedUrl:r,headers:i})},onTimeout:function(t){t&&console.warn(t),n(new Error("[CAT3DWLinkProcessingUtils] requestExternalUrl() timeout"))},onFailure:function(){n(new Error("[CAT3DWLinkProcessingUtils] requestExternalUrl() failed"))}})}))},getUWARequestor:function(){return this._uwarequestor},_getImageBlobExternalUrl:function(t){return new Promise(function(e,n){this.getLinkType(t).then(function(t){var i={};i.url=t.url,i.responseType="blob",i.requestor=this.getUWARequestor(),i.proxy="ajax",this.requestExternalUrl(i).then((function(t){if(t.data&&t.data.type.includes("image/")){var i=URL.createObjectURL(t.data);e(i)}else n()})).catch((function(){n()}))}.bind(this))}.bind(this))},_getPlatformUrl:function(){return this._platformUrl?new Promise((t=>{t(this._platformUrl)})):new Promise(((t,e)=>{n.get3DSwym(this._platformId).then((e=>{this._platformUrl=e,t(this._platformUrl)})).catch((function(t){e(t)}))}))}});return o.LINK_INTERNAL="internal",o.LINK_EXTERNAL="external",o.CONTENT_UNKNOWN="unknown",o.CONTENT_POST="posts",o.CONTENT_QUESTION="iquestion",o.CONTENT_IDEA="idea",o.CONTENT_WIKI="wiki",o.CONTENT_MEDIA="media",o.CONTENT_SURVEY="survey",o.CONTENT_WEDO="WeDo",o})),define("DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView",["UWA/Class","UWA/Core","DS/VENWebHtml2Canvas/Html2Canvas","DS/WebappsUtils/WebappsUtils","i18n!DS/CAT3DWRichLinksUI/assets/nls/CAT3DWRichLinkHtmlView","css!DS/CAT3DWRichLinksUI/CAT3DWRichLinksUI"],(function(t,e,n,i,a){"use strict";var s=t.extend({init:function(t){this._mainContainerClassName="rich-link-preview",this._mainContainer=null,this._viewParams=t,this._swymV3=t.swymv3,this._viewParams.thumbnail||"internal"!==this._viewParams.linktype||(this._viewParams.thumbnail=i.getWebappsAssetUrl("CAT3DWInfra","placeholders/xl_thumb_default_community.png"))},getHTML:function(){return this._mainContainer||this._build(this._viewParams),this._mainContainer},getCanvas:function(){return new Promise(((t,e)=>{var i=new n,a=this.getHTML();document.body.append(a),i.htmlToCanvas(a,{onclone:t=>{var e=t.getElementsByClassName(this._mainContainerClassName);e&&(e[e.length-1].style.opacity="1")},allowTaint:!0,useCORS:!0,scale:2}).then((e=>{this.clean(),t(e)})).catch((t=>{this.clean(),e(t)}))}))},clean:function(){this._mainContainer.remove(),this._mainContainer=null},_build:function(t){t||console.warn("[CAT3DWRichLinkHTMLView : no params to build link view]"),this._mainContainer=new e.Element("div",{class:this._mainContainerClassName});const n=new e.Element("div",{class:"preview-image-container"}).inject(this._mainContainer),i=new e.Element("div",{class:"preview-data-container"}).inject(this._mainContainer);if(t.thumbnail&&new e.Element("img",{class:"preview-thumbnail",src:t.thumbnail}).inject(n),t.favicon&&!t.type)new e.Element("img",{class:"preview-favicon",src:t.favicon}).inject(n);else{const i=this._getFonticon(t.type,t.mediaType);new e.Element("div",{class:"preview-icon",html:{tag:"span",class:"fonticon "+i.name},styles:{color:i.color,"background-color":i.bkcolor}}).inject(n)}if(t.title&&new e.Element("span",{class:"preview-title",text:this._truncate(t.title,80)}).inject(i),t.url||t.author||t.community){const n=new e.Element("div",{class:"preview-domain"}).inject(i);if(t.author){const i=[{tag:"span",text:a.get("authorPrep")+" "},{tag:"a",text:t.author}];t.community&&(i.push({tag:"span",text:" "+a.get("communityPrep")+" "}),i.push({tag:"a",text:t.community})),new e.Element("div",{class:"preview-author-community",html:i}).inject(n)}else if(t.url||t.hash){const i=t.hash?t.hash:t.url;new e.Element("a",{text:i}).inject(n)}}t.description&&new e.Element("span",{class:"preview-description",text:this._truncate(t.description,150)}).inject(i)},_truncate:function(t,e){return t.length>e?t.substr(0,e-1)+"...":t},_getFonticon:function(t,e){switch(t){case"posts":case"post":return{name:"fonticon-newspaper",color:this._swymV3?"#3d3d3d":"white",bkcolor:this._swymV3?"white":"#adadad"};case"idea":return{name:"fonticon-lightbulb",color:this._swymV3?"#00b8de":"white",bkcolor:this._swymV3?"white":"#00b8de"};case"iquestion":return{name:this._swymV3?"fonticon-comment-question ":"fonticon-i-question",color:this._swymV3?"#e7b401":"white",bkcolor:this._swymV3?"white":"#ea4f37"};case"survey":return{name:"fonticon-clipboard",color:this._swymV3?"#e87b00":"white",bkcolor:this._swymV3?"white":"#e87b00"};case"WeDo":return{name:"fonticon-task",color:this._swymV3?"#005686":"white",bkcolor:this._swymV3?"white":"#005686"};case"media":var n=e;return"sketch"===e&&(n="app-3dsketch"),"whiteboard"===e&&(n="app-whiteboard"),"document"===e&&(n="doc"),"animatedPicture"===e&&(n="picture-animated"),"3d_model"===e&&(n="cube"),"story"===e&&(n="app-3dstory"),{name:"fonticon-"+n,color:this._swymV3?"#70036b":"white",bkcolor:this._swymV3?"white":"#70036b"};case"wiki":return{name:"fonticon-book-open",color:this._swymV3?"#00aa86":"white",bkcolor:this._swymV3?"white":"#00aa86"};default:return{name:"fonticon-globe",color:this._swymV3?"#3d3d3d":"#77797c",bkcolor:"white"}}}});return e.namespace("DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView",s)}));