/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/3DPlayCommonSimulation/3DPlayCommonSimulation",["DS/3DPlayExperienceModule/PlayExperience3D","DS/WebSystem/App","DS/WebUtils/ProbesManager","DS/WebSystem/Nls","DS/WebSystem/Environment","DS/WebInfraUI/Notification","DS/3DPlay/3DPlay","DS/WebUtils/ContextedSingleton","UWA/Core","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/SPYLoader/MSRLoader","DS/SPYUI/controllers/SPYContext"],(function(e,i,t,s,a,n,o,r,d,l,m,c,h){"use strict";let P=function(){return"X3DPLAW_AP"===i.getEmbeder()};const S=["ENOR3D_AP","ENOR3R_AP","ENOR3V_AP"];let u=!0;return e.extend({_postCreateSequenceCallback:function(e){let i=()=>{var i=this.frmWindow?this.frmWindow.getViewer():void 0;if(i){i.setMaterialMode(!0);let e=i.currentViewpoint;e&&(u=e.control.lockZ,e.control.lockZ=!1)}if(this.mySPMUI){let i=()=>{e&&e.state&&this.mySPMUI.setStateData(e.state),this.mySPMUI.activateDefaultContent(this.onDefaultDDActivation)},t=this.loader.getDMFactory();t&&t.isExtendedMode&&t.isExtendedMode()?this.mySPMUI.recomputeActiveDDIndex():this.mySPMUI.isThereAnExpectedSequence()?e&&this.mySPMUI.isTheExpectedSequence(e.seqId)&&i():-1===this.mySPMUI.getActiveSequence()&&i()}};if(this.loader.declareToPAD&&"EV6"===this._myAsset.provider)if(this.pad3DViewer&&!this._rootRequested){var t=this.pad3DViewer.subscribe({event:"onRootAdded"},function(e){this.pad3DViewer.unsubscribe(t),i()}.bind(this)),s=this._myAsset.physicalid,a=this.mySPM.getSimulationAlias();this.loader.declareToPAD(this.pad3DViewer,s,a),this._rootRequested=!0}else i();else i();this.loader.continueLoading()},_createSequenceErrorCallback:function(){var e=this.loader.getReport();if(e){var i=!1,t="NoValidStream";if(isNaN(e.streamNb)||isNaN(e.invalidStreamNb)||e.streamNb!==e.invalidStreamNb?e.filteredContent&&(i=!0,t="FilteredContent"):i=!0,i){var a=h.appNotificationTypes.info;s.nls("3DPlayCommonSimulation/Loading",t,function(e){h.sendAppNotification(a,{text:e})}.bind(this))}}this.loader.isLoadingComplete()&&(l.publish({event:this.ctx+"/SPY/PROGRESS/END",data:{value:0}}),this.mySPMUI.createFakeSphere(),this.markAssetLoaded()),this.loader.continueLoading()},_removeAmbiancesFromMab:function(){!isNaN(this._AmbiancesMabIdx)&&this.args.mabModel&&Array.isArray(this.args.mabModel.sections)&&this.args.mabModel.sections.splice(this._AmbiancesMabIdx,1),!isNaN(this._AmbiancesTabletMabIdx)&&this.args.tabletMabModel&&Array(this.args.tabletMabModel.sections)&&this.args.tabletMabModel.sections.splice(this._AmbiancesTabletMabIdx,1)},_removeHeaderFromMabSections:function(e){this.args.mabModel&&(this.args.mabModel.sections=this.args.mabModel.sections.filter((function(i){return i.id!==e})))},init:function(e){this._expProbe=t.createProbe("MsrEcCreateExperience"),this._expProbe.begin(),this._openPanel=!1,this._targetAppSupportsMSR=!1,h.setEmbeder(i.getEmbeder());var s=e.ctx;this._3DPlayEventProxy=Object.create(h.AppEventProxy),this._3DPlayEventProxy.convertNotification=function(e){return{msg:e.text}},this._3DPlayEventProxy.sendAppNotification=function(e,i){o.sendEvent(s,eventType.notif,this[e],this.convertNotification(i))},this._3DPlayEventProxy[h.appNotificationTypes.info]=n.info,this._3DPlayEventProxy[h.appNotificationTypes.warning]=n.warning,this._3DPlayEventProxy[h.appNotificationTypes.error]=n.error,h.setAppEventProxy(this._3DPlayEventProxy),e.options.propertiesFacet=h.getSidePanelFacets(),this.useSession=!0,this._parent(e),this._infoPanelSpeedDef={id:"RightSidePanel",rsc:"PADUtils/PADUtils"},this._infoPanelMabSectionDef={id:"RightSidePanel",rsc:"PADUtils/PADUtils",nls:"PADUtils/PADUtils"};var a=[{id:"VisuPureWhiteOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuWhiteMirrorOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuWhiteReviewOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuWhiteExperienceOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuStudioOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuDarkMirrorOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuDarkReviewOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuWhiteDesignOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuBlueDesignOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuDarkDesignOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuIndoorOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuCityOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuRoadOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuOutdoorOCACmd",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuBasicOCACmd",rsc:"ViewerCommands/ViewerCommands"}],r={workbenchs:[{name:"BasicSimulationPlayer",module:"3DPlayBasicSimulation"}],swapVisible:!0,selection:!0,preSelection:!0,visu:{showReferenceAxisSystem:!0,picking:!0,antiAliasing:!0,useShadowMap:!0,infinitePlane:!0,displayLines:!0,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1},ui:{displayTree:!1,displayActionBar:!0},options:{loadAnimation:5,splashscreen:{custom:""},enopad:{visuProgressiveTileModel:!0,interwidgetComAvailability:!1,windowOptions:{allowDnD:P(),defaultStatusBarVisibility:!1}}},mabModel:{speeddial:[{id:"CATSPYAnimateCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"CATSPYMSRAccessCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[{id:"CATSPYPublishTo3DSwYmCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]}],sections:[this._infoPanelMabSectionDef,{id:"CATSPYHideShowCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer",hideAB:!0,showBack:!0},{id:"CATSPYHideShowLegendCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer"},{id:"CATSPYShowHideExtremaCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer"},{id:"CATSPYTranspCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer",hideAB:!0,showBack:!0},{id:"CATSPYRHESwitchCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer",hideAB:!0,showBack:!0},{id:"Reframe",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D"},{id:"ViewSelector",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",hideAB:!0,showBack:!0},{id:"measure2CmdHdr",nls:"DMUBaseCommands/3DPlayPro",rsc:"DMUBaseCommands/3DPlayPro",hideAB:!0},{id:"section2CmdHdr",nls:"DMUBaseCommands/3DPlayPro",rsc:"DMUBaseCommands/3DPlayPro"},{id:"AnnotationCommands",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"},{id:"AnnotationCommand3DText",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"},{id:"AnnotationTour",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D",hideAB:!0,showBack:!0},{id:"Ambiance",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",flyout:a}]},tabletMabModel:{speeddial:[{id:"CATSPYAnimateCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"CATSPYMSRAccessCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"CATSPYHideShowCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"CATSPYHideShowLegendCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"Reframe",rsc:"3DPlay/3DPlayExperience3D"},{id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[{id:"CATSPYPublishTo3DSwYmCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]},this._infoPanelSpeedDef],sections:[{id:"CATSPYShowHideExtremaCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer"},{id:"CATSPYTranspCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer",hideAB:!0,showBack:!0},{id:"CATSPYRHESwitchCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer",hideAB:!0,showBack:!0},{id:"ViewSelector",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",hideAB:!0,showBack:!0},{id:"measure2CmdHdr",nls:"DMUBaseCommands/3DPlayPro",rsc:"DMUBaseCommands/3DPlayPro",hideAB:!0},{id:"section2CmdHdr",nls:"DMUBaseCommands/3DPlayPro",rsc:"DMUBaseCommands/3DPlayPro"},{id:"AnnotationCommands",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"},{id:"AnnotationCommand3DText",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"},{id:"AnnotationTour",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D",hideAB:!0,showBack:!0},{id:"Ambiance",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",flyout:a}]}};this._AmbiancesMabIdx=13,this._AmbiancesTabletMabIdx=9,this.args=d.extend(e,r,!0),this.loader=c,this.dataFactoryPath="DS/SPY/CATSimNavDataLWFactory",this.mediaDataFactoryPath="DS/SPY/CATSimNavDataMediaFactory",this.markAssetLoaded=function(){if(!this._assetMarkedAsLoaded){if(l.publish({event:this.ctx+"/SPY/ASSET/LOADINGCOMPLETE"}),!P()){var e={model:"",isDefault:this._myAsset.isDefaultModel,isNonSupportedEdge:this._edgeVersionKO};this.publish("MODEL/LOADINGFINISHED",e),this.publish("ASSET/LOADINGFINISHED",e)}this._assetMarkedAsLoaded=!0,this.stopLoadingPreview(),this._loadAssetProbe&&this._loadAssetProbe.end()}}.bind(this),this.args.options.callbacks&&this.args.options.callbacks.ui&&(this.onDefaultDDActivation=this.args.options.callbacks.ui.DefaultActivationFinished)},unload:function(e){e&&e.supportedTransition||(this.loader.removeFromPAD&&this.loader.removeFromPAD(this.pad3DViewer,this._myAsset.physicalid),this.loader.clean(),this.mySPMUI&&(this.mySPMUI.clean(e),this.mySPMUI.destroy(),delete this.mySPMUI),this.frmWindow&&this.frmWindow.SPMUI&&delete this.frmWindow.SPMUI,this.mySPM&&(this.mySPM.clean(),delete this.mySPM),this._rootRequested=!1)},dispose:function(e){this.frmWindow&&this.frmWindow.getContextualUIManager().unregister("MSR_3DPLAY_CTX_MENU");var i=e&&!1===e.disposeFrameWindow&&this._targetAppSupportsMSR;this.unload({supportedTransition:i}),this._parent(e),this._expProbe&&(this._expProbe.end(),delete this._expProbe),this._loadAssetProbe&&(this._loadAssetProbe.end(),delete this._loadAssetProbe)},acceptSwitch:function(e){return this._targetAppSupportsMSR=e&&e.options&&S.includes(e.options.id),this._targetAppSupportsMSR},manageTransitionFrom:function(){var e=this.frmWindow;this.isFromTransition&&e&&e.SPMUI&&(this.mySPMUI=e.SPMUI,this.mySPM=e.SPMUI.getSPM(),e.SPMUI.reduceToResults())},_loadAsset:function(e,i){if(this._myAsset){this._assetMarkedAsLoaded=!1,this.unload({newContent:!0});var n=this.frmWindow,o={window:n,context:this.ctx,msrID:this._myAsset.physicalid};this.mySPM=new e(o);var d={spm:this.mySPM,window:n,context:this.ctx,captureHidden3DElements:!0,forcePlay:a.isSet("3DPlay.ForceSimulationPlay"),onClean:function(){1!=this.isRestoring3DComment()&&r.remove(this.ctx,"ANNOTATION_MANAGER")},envOCA:a.get("3DPlay.Simulation.EnvOCA"),publishPCSEvent:function(){if(a.isSet("3DPlay.zzPCS")&&window.top){let e=window.top.document.createEvent("CustomEvent"),i=t.GetProcessedData({topWindow:!0,cleanNames:!0,only3DPlay:!0});i.probes.forEach((e=>{e.name=e.name.replaceAll(/[\s_]+/g,"")})),e.initCustomEvent("3DPlay.zzPCS",!0,!1,i),window.top.document.dispatchEvent(e)}},updateStats:function(){var e=this.stats;e&&setTimeout((function(){e.probesDone=!1,e.UpdateProbes=!0,e.updateProfile()}),1e3)},openSidePanel:this._openPanel,probesManager:t};this.mySPMUI=new i(d),n.SPMUI=this.mySPMUI;var m=this.ctx,c={data:"",ctx:m};this.publish("MODEL/LOADINGSTARTED",c),this.publish("ASSET/LOADINGSTARTED",c),l.publish({event:m+"/SPY/PROGRESS/INIT",data:{red:!0}}),this.loader.onQueryStart(this.ctx,(function(){l.publish({event:m+"/SPY/PROGRESS/UPDATE",data:{value:5,total:100}})})),this.loader.onQueryProgress(this.ctx,(function(e){l.publish({event:m+"/SPY/PROGRESS/UPDATE",data:{value:60*e/100,total:100}})})),this.loader.onQueryError(this.ctx,(function(e){l.publish({event:m+"/SPY/PROGRESS/END",data:{value:0}});var i,t;switch(e){case"NOSTREAM":i="NoLightWeightStream",t=h.appNotificationTypes.info;break;case"NOACCESS":i="NoDataAccess",t=h.appNotificationTypes.warning;break;default:i="Failed",t=h.appNotificationTypes.error}s.nls("3DPlayCommonSimulation/Loading",i,(function(e){h.sendAppNotification(t,{text:e})}))})),this.loader.onUnstreamStart(this.ctx,(function(){l.publish({event:m+"/SPY/PROGRESS/UPDATE",data:{value:60,total:100}})})),this.loader.onFileNotSupported(this.ctx,(function(){console.error("3DPlayCommonSimulation - File not supported")})),this.loader.onDicoThumbnailsReady(this.ctx,(function(){l.publish({event:m+"/SPY/LOADING/DICOTHUMBNAILSREADY"})})),this.loader.onFileTreeRegenerationSuggested(m,(function(){var e=h.appNotificationTypes.info;s.nls("3DPlayCommonSimulation/Loading","FileTreeRegeneration",(function(i){h.sendAppNotification(e,{text:i})}))})),this.loader.onUnstreamComplete(this.ctx,this._postCreateSequenceCallback.bind(this)),this.loader.onUnstreamError(this.ctx,this._createSequenceErrorCallback.bind(this)),this.loader.onTimeOut(this.ctx,(function(){var e=h.appNotificationTypes.warning;s.nls("3DPlayCommonSimulation/Loading","TimeOut",(function(i){h.sendAppNotification(e,{text:i})}))})),this.loader._defaultAssetType=this._myAsset.physicalid?"DesignSight":this._myAsset.format,this.mySPM.setPreferredStreamId(this.mySPMUI.getPreferredStreamId()),this.loader.load(this._myAsset,this.dataFactoryPath,this.mySPM)}},loadAsset:function(e){this._loadAssetProbe=t.createProbe("MsrEcLoadAsset"),this._loadAssetProbe.begin();var i=!0,a=navigator.userAgent,n=a.indexOf("Edge/");if(n>0&&(i=parseInt(a.substring(n+5,a.indexOf(".",n)),10)>16),i){if(this._myAsset=e.asset?e.asset:this.args.input.asset,!this._myAsset)return;require(["DS/SPY/SimulationPlayerModel","DS/SPYUI/controllers/SimulationPlayerUI"],this._loadAsset.bind(this))}else{var o="EdgeLevel";void 0!==window.WinJS&&(o="EdgeLevelWin10app");var r=h.appNotificationTypes.info;s.nls("3DPlayCommonSimulation/Loading",o,(function(e){h.sendAppNotification(r,{text:e})})),this._edgeVersionKO=!0,this._myAsset={},this.markAssetLoaded()}},onPreCreate:function(){this.args.mabModel&&(this.mabModel=this.args.mabModel),this.args.tabletMabModel&&(this.tabletMabModel=this.args.tabletMabModel)},_manageContextualMenu:function(){var e=this.frmWindow.getViewer();this.frmWindow.getContextualUIManager().register({subscriberId:"MSR_3DPLAY_CTX_MENU",workbenchName:this.args.workbenchs[0].name,module:this.args.workbenchs[0].module,cmdPrefix:"",onContextualMenuReady:function(i,t){if(t&&t.XmousePosition){var s=new m.Vector2(t.XmousePosition,t.YmousePosition),a=e.getMousePosition(s);if(0===e.pick(a,"mesh",!0).path.length){var n=[];return navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i)||n.push({name:"3DPlayDisplaySection",line:1,hdr_list:["VisuQMCommand"]}),n.push({name:"3DPlayAmbiencesSection",line:1,resourceFile:"3DPlay/3DPlay",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}),{cmdList:n}}}return null}})},onPostCreate:function(){h.setCurrentPad(this.pad3DViewer);var e=this.frmWindow.getActionBar().getContent().querySelector(".wux-afr-cmdstarter[data-name=SPYInfoAccess]");e&&e.remove(),this.PanelManager&&this.PanelManager.topBarProxy&&this.PanelManager.topBarProxy.setContent({help:[]});var i=this.frmWindow.getViewer();if(i.setAutoUpdateLights(!0),i.setLightOnViewpoint(!0),i.setGrid(!1),i.setPicking({trapSelection:"advanced"}),this._manageContextualMenu(),"SIMWPSR_AP"===widget.getValue("appId")){for(var t in this.widgetPreferences)this.widgetPreferences.hasOwnProperty(t)&&(this.widgetPreferences[t].type="hidden");widget.preferences.forEach((function(e){(e.name.includes("DisplayUnit")||e.name.includes("3DPlay.CGRPolicy"))&&(e.type="hidden")}))}this._expProbe.end(),this.isFromTransition&&this.manageTransitionFrom(),this.publish("COMMAND/READY/ANNONATIONTOUR")},isDefaultExperience:function(){return this._myAsset&&this._myAsset.isDefaultModel},_setScreenshotUI:function(e){var i=e.getContext("2d");if(i){var t=this.mySPMUI.frame2D;if(t){var s=this.mySPMUI.getActiveDD();if(s)for(var a=function(e){e&&e.drawToCanvas(i,t.offsetLeft,t.offsetTop)},n=s.getNavData2DViewList(),o=0;o<n.length;o++)n[o]&&n[o].visibility&&n[o].QI("CATISimNavDataSpecUI",a)}var r=this.mySPMUI.disclaimer;r&&r.drawToCanvas(i);var d=this.mySPMUI.watermark;d&&d.drawToCanvas(i)}},_cleanMediaProductionData:function(){this._mediaSequenceCreatedCB&&(l.unsubscribe(this._mediaSequenceCreatedCB),delete this._mediaSequenceCreatedCB),this._mediaSequenceErrorCB&&(l.unsubscribe(this._mediaSequenceErrorCB),delete this._mediaSequenceErrorCB),this._compatSequenceCreatedCB&&(l.unsubscribe(this._compatSequenceCreatedCB),delete this._compatSequenceCreatedCB),this._compatSequenceErrorCB&&(l.unsubscribe(this.__compatSequenceErrorCB),delete this._compatSequenceErrorCB)},getPublishingInfo:function(e){if(e&&e.onComplete){var i=this.mySPM.getSimulationTitle();this.mySPM.getCurrentContentDescription({onComplete:function(t){e.onComplete({title:i,description:t})},onError:function(i){e.onError&&e.onError(i)}})}},getExperienceMediaMeta:function(e){e&&s.nls("3DPlayCommonSimulation/Media","MediaTypeName",function(i){e({type:"swym:SimulationMedia",typeName:i,name:this.mySPM.getSimulationTitle(),format:"3dsim"})}.bind(this))},getExperienceMedia:function(e){if(e&&e.onComplete&&e.onFailed){require(["DS/ZipJS2/ZipJS2","DS/SPYLoader/MSRFileTreeProxy","DS/SPY/SimulationPlayerModel",this.mediaDataFactoryPath,"DS/SPY/CATSimNavData3DCamerasRoot","DS/SPY/CATSimNavData3DCamera","DS/SPY/SpaceURL","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(i,t,s,a,n,o,d,m){var c=this.mySPMUI.getActiveDD(),P=c.getLegend(),S=c.seq,u=c.id,p=this.mySPM,D=p.getZipEntries(S),y={},C=this.mySPMUI.getAnimationFrameIndex(),A=c.getGroupForFrame(C);if(A&&!isNaN(C)&&(y.time={groupId:A.group.id,groupIdNoMode:A.group.idNoMode,unit:A.group.unit,frameIdx:C,framePosition:A.frame.position},c.isPartialAnimationMode()&&(y.animationScope={lockStatus:!0})),P){var f=P.getUserMin(),g=P.getUserMax(),M=P.unit;isNaN(f)&&isNaN(g)||(y.customization={},isNaN(f)||(y.customization.userMin={value:f,unit:M}),isNaN(g)||(y.customization.userMax={value:g,unit:M}))}var b=JSON.stringify(y),E=new a({ddId:u});const w="ShareMediaCtx";var v=new s({context:w});this._mediaSequenceCreatedCB=l.subscribe({event:w+"/SPY/SEQUENCE/CREATED"},(t=>{if(t&&t.spm&&t.spm.importedDom){if(t.spm.importedSpecificContent){var s=new n;s.name="publish view camera root";var a=new o;a.name="publish view camera";var l=this.mySPMUI.getViewer().getViewpoints();a.setFromViewpoint(l[0]),s.addCamera(a),s.writeToXML(t.spm.importedSpecificContent)}new d(m).getUrl({asset:this._myAsset,onComplete:s=>{t.spm.importedDom.getRootNode().firstChild.setAttribute("originURL",s);var a=(new XMLSerializer).serializeToString(t.spm.importedDom),n=t.spm.getZipEntries(0);p.copyZipEntriesForTarget(S,t.spm,(()=>{n.root.addText("SimNavData.xml",a);n.exportBlob({onprogress:i=>{e.onProgress&&e.onProgress({currentStep:1,stepTotal:2,stepProgress:i})}}).then((t=>{var s=new i.fs.FS;s.root.addBlob("SimulationExperienceContent.simxml",t),s.root.addText("SimulationExperienceState.json",b),this.hideRefAxis(),this.getScreenShot({width:520,height:390,onSuccess:i=>{if(this.showRefAxis(),s.root.addData64URI("thumbnail.png",i),h.isEmbederPSR()){let e=r.get(this.ctx,"ANNOTATION_MANAGER");if(e){let i=e.saveAnnotationsToJSON();s.root.addText("annotations.json",i)}}s.exportBlob({onprogress:i=>{e.onProgress&&e.onProgress({currentStep:2,stepTotal:2,stepProgress:i})}}).then((i=>{this._cleanMediaProductionData(),e.onComplete(i)}),(i=>{this._cleanMediaProductionData(),e.onFailed(i)}))},onFail:()=>{this.showRefAxis(),this._cleanMediaProductionData(),e.onFailed()}})}),(i=>{e.onFailed(i)}))}))}})}})),this._mediaSequenceErrorCB=l.subscribe({event:w+"/SPY/SEQUENCE/ERROR"},(()=>{this._cleanMediaProductionData(),e.onFailed()})),!D&&Array.isArray(this.loader.items)&&this.loader.items.length>0?(async()=>{const i="compatMediaCtx";let a=new s({context:i});this._compatSequenceCreatedCB=l.subscribe({event:i+"/SPY/SEQUENCE/CREATED"},(e=>{e&&e.spm&&(p=e.spm,D=e.spm.getZipEntries(0),E.createSequence({src:{index:0},zipEntries:D,spm:v,shareZipEntries:!1}))})),this._compatSequenceErrorCB=l.subscribe({event:i+"/SPY/SEQUENCE/ERROR"},(()=>{this._cleanMediaProductionData(),e.onFailed()}));const n=await t.getSimulation(this._myAsset.serverurl,this._myAsset.physicalid),o=n.content.find((e=>"dsc_Result_Rep"===e.type))?.contentId,r=this.mySPM.getStreamId(S);a.setPhysicalId(this.mySPM.getPhysicalId()),a.setStreamIds(this.mySPM.getStreamIds()),a.setSeparator(this.mySPM.getSeparator()),a._primaryDico={},v.setPhysicalId(this.mySPM.getPhysicalId()),v.setStreamIds(this.mySPM.getStreamIds()),v.setSeparator(this.mySPM.getSeparator()),v._primaryDico={};const d=this.loader._report.suggestedTimeout;this.loader.loadOneStreamWithFileTree(this._myAsset,o,r,this.loader.items,d,(e=>{E.createSequence({...e,spm:a,shareZipEntries:!1})}),(i=>{e.onFailed(i)}),(()=>{onError("timeout")}))})():E.createSequence({zipEntries:D,spm:v,shareZipEntries:!1})}.bind(this))}},expworkbenchName:"",expmodule:""})}));