define("DS/WebPolyClashOper/WebPolyClashOper",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/SubElement","DS/Visualization/ThreeJS_DS","DS/WebPolyMaths/WebToolsSceneGraph","DS/WebPolyMaths/WebToolsMaths","DS/WebPolyMaths/WebMathsVector3D","DS/WebPolyMaths/WebMathPlucker","DS/WebPolyMaths/WebMathsBoundingGeometry","DS/WebPolyMaths/WebMeshIntersection","DS/WebPolyMaths/WebPolyCurves","DS/WebPolyMaths/WebPolyCurve","DS/Mesh/Mesh"],(function(e,t,r,i,n,s,o,a,u,l,h,f,c){"use strict";var v=["OPERANDS_INCLUSION"];return e.extend({init:function(e,t){return this._Viewer=e,this._Tol=t,this._stopAtFirstClash=!0,this._Buffer={productMatrix1:new i.Matrix4,productMatrix2:new i.Matrix4,inverse:new i.Matrix4},this},computeIntersectionCurves:function(e){this._stopAtFirstClash=!e},isComputingIntersectionCurves:function(){return 0==this._stopAtFirstClash},Run:function(e,t){var r={returnCode:0,interferences:[]};if(void 0!==this._Viewer)for(var i=0,n=e.length;i<n;i++)for(var s=0,o=t.length;s<o;s++){var a=this._computeClashPathPath(e[i],t[s]);if(0===a.returnCode){if(void 0!==a.curves){var u={first:e[i],second:t[s]};!1===this._stopAtFirstClash&&(u.curves=a.curves),r.interferences.push(u)}}else if(a.returnCode>1){var l={first:e[i],second:t[s],reason:v[a.returnCode-2]};void 0===r.warnings&&(r.warnings=new Array),r.warnings.push(l)}else if(1===a.returnCode)return r.returnCode=1,r}else r.returnCode=1;return r},_debugBoxes:!1,_computeClashPathPath:function(e,r){let i=[],s=[e,r],o=[],a=[];if(n.checkPathInclusion(e,r))return{returnCode:2};for(;null!=s;){s[0].getWorldMatrix(this._Viewer,this._Buffer.productMatrix1);var l=s[0].getLastElement(!0);s[1].getWorldMatrix(this._Viewer,this._Buffer.productMatrix2);var f=s[1].getLastElement(!0);this._Buffer.inverse.getInverse(this._Buffer.productMatrix2),this._Buffer.productMatrix1.multiplyMatrices(this._Buffer.inverse,this._Buffer.productMatrix1);var c=l.getBoundingBox("visibleSpace"),v=f.getBoundingBox("visibleSpace");if(this._debugBoxes){var m=[];return this._drawBox(c,m,this._Buffer.productMatrix1),this._drawBox(v,m,this._Buffer.productMatrix2),{returnCode:0,curves:new h(m)}}var p=u.areAABBInClash(c,this._Buffer.productMatrix1,v,this._Tol),d=this._Viewer.getCurrentSceneGraphState();if(p)if(n.isLeaf(l)&&n.isLeaf(f)){if(!1!==n.recursiveGetPathElementVisibility(this._Viewer,s[0])&&!1!==n.recursiveGetPathElementVisibility(this._Viewer,s[1])){var g=this._getRenderableElements(s[0]),x=this._getRenderableElements(s[1]);o.push([g,x]),a.push([this._Buffer.productMatrix1.clone(),this._Buffer.productMatrix2.clone()])}}else for(var _=!n.isLeaf(l)&&(n.isLeaf(f)||u.AABBVolume(c)>u.AABBVolume(v)),B=_?l.children:f.children,y=B.length,C=0;C<y;C++){var P=B[C];if(n.isReferenceOrInstance(P)){var S=new t;S.addElement(P);var M=this._Viewer.getVisibleSpace(),b=n.isVisible(this._Viewer,S);if(0!==M||b||(b=!0),d&&(b=d.getAppliedVisibility(S)),null===b||!0===b){var w=s[_?0:1].clone();w.addElement(P),i.push(_?[w,s[1]]:[s[0],w])}}}s=i.pop()}return this._ClashRenderables(o,a)},_getRenderableElements:function(e){let t=e.getLastElement();return t instanceof r?t:n.getRenderables(e)},_drawBox:function(e,t,r){var i=[[e.min.x,e.min.y,e.min.z],[e.min.x,e.min.y,e.max.z],[e.min.x,e.max.y,e.min.z],[e.min.x,e.max.y,e.max.z],[e.max.x,e.min.y,e.min.z],[e.max.x,e.min.y,e.max.z],[e.max.x,e.max.y,e.min.z],[e.max.x,e.max.y,e.max.z]];r&&(o.transformPoint(i[0],r.elements,i[0]),o.transformPoint(i[1],r.elements,i[1]),o.transformPoint(i[2],r.elements,i[2]),o.transformPoint(i[3],r.elements,i[3]),o.transformPoint(i[4],r.elements,i[4]),o.transformPoint(i[5],r.elements,i[5]),o.transformPoint(i[6],r.elements,i[6]),o.transformPoint(i[7],r.elements,i[7])),t.push(new f([i[0],i[1],i[3],i[2],i[0]])),t.push(new f([i[1],i[5],i[4],i[0]])),t.push(new f([i[3],i[7],i[6],i[2]])),t.push(new f([i[5],i[7]])),t.push(new f([i[4],i[6]]))},_ClashRenderables:function(e,t){let r={returnCode:e.length==t.length?0:1,curves:void 0};var i,n,s=[];if(0===r.returnCode)for(let o=0,a=e.length;o<a;++o){if(i=this._extractVertexBufferAndPrimitives(e[o][0],t[o][0]),n=this._extractVertexBufferAndPrimitives(e[o][1]),!i||!n)return r.returnCode=1,r;for(let e=0,a=i.length;e<a;++e){let a=i[e].primitives,u=i[e].vBuffer;for(let e=0,i=n.length;e<i;++e){let i=n[e].primitives,l=n[e].vBuffer,h=this._ClashPrimitives(u,a,t[o][0],l,i);if(0!==h.returnCode)return r.returnCode=1,r;if(void 0!==h.curves){if(this._stopAtFirstClash)return r.curves=null,r;if(!t[o][1].isIdentity())for(let e=0,r=h.curves.length;e<r;++e)h.curves[e].move(t[o][1]);s=s.concat(h.curves)}}}}return 0===r.returnCode&&0!=s.length&&(r.curves=new h(s)),r},_ClashPrimitives:function(e,t,r,n,s){let o={returnCode:void 0!==e&&void 0!==t&&void 0!==r&&void 0!==n&&void 0!==s?0:1,curves:void 0};if(0===o.returnCode){let C,P,S,M,b,w,A=[],T=new i.Sphere,V=!0,W=!1,D=[[0,0,0],[0,0,0],[0,0,0]],E=[[0,0,0],[0,0,0],[0,0,0]],k=0,I=0,z=t.length,G=s.length;var h=new Array(s.length),c=new Set;for(C=0;C<z;++C){var v=t[C].getBoundingSphere(),m=t[C].getCount()/3,p=t[C].getStart(),d=t[C].getGroup().geometry.vertexIndexArray,g=this._createTriangleBuffer(e,p,d,m,D,this._Tol);if(v)for(T.copy(v),T.center.applyMatrix4(r),T.radius+=this._Tol,P=0;P<G;++P){V=!1;var x=s[P].getBoundingSphere();if(v&&x&&(V=T.center.distanceTo(x.center)<=T.radius+x.radius),V){var _=s[P].getCount()/3,B=s[P].getStart(),y=s[P].getGroup().geometry.vertexIndexArray;for(h[P]||(h[P]=this._createTriangleBuffer(n,B,y,_,E)),c.clear(),M=0;M<_;++M)u.AABBSphereOverlap(h[P][M].box,T)&&c.add(M);if(0===c.size)continue;const t=Array.from(c);for(S=0;S<m;++S)if(null!==g[S].plucker&&u.AABBSphereOverlap(g[S].box,x))for(k=p+3*S,I=3*d[k],D[0][0]=e[I],D[0][1]=e[I+1],D[0][2]=e[I+2],I=3*d[k+1],D[1][0]=e[I],D[1][1]=e[I+1],D[1][2]=e[I+2],I=3*d[k+2],D[2][0]=e[I],D[2][1]=e[I+1],D[2][2]=e[I+2],b=0,w=t.length;b<w;++b)if(M=t[b],u.AABBOverlap(g[S].box,h[P][M].box)){if(k=B+3*M,I=3*y[k],E[0][0]=n[I],E[0][1]=n[I+1],E[0][2]=n[I+2],I=3*y[k+1],E[1][0]=n[I],E[1][1]=n[I+1],E[1][2]=n[I+2],I=3*y[k+2],E[2][0]=n[I],E[2][1]=n[I+1],E[2][2]=n[I+2],void 0===g[S].plucker&&(g[S].plucker=a.pluckerTriangle(D[0],D[1],D[2],this._Tol)),null===g[S].plucker)break;if(void 0===h[P][M].plucker&&(h[P][M].plucker=a.pluckerTriangle(E[0],E[1],E[2],this._Tol)),null===h[P][M].plucker)continue;let e=a.computeIntersectionTriangleTriangleBuf(D,g[S].plucker,E,h[P][M].plucker,!this._stopAtFirstClash,this._Tol);if(1==e.returnCode)if(W=!0,e.Segment)A.push(e.Segment);else if(this._stopAtFirstClash)return o.curves=null,o}}}}if(A.length>0){l._mergePolylines(A),void 0===o.curves&&(o.curves=[]);for(let e=0,t=A.length;e<t;++e)o.curves.push(new f(A[e]))}W&&void 0===o.curves&&(o.curves=[])}return o},_createTriangleBuffer:function(e,t,r,i,n,s=0){var o,a,u=new Array(i);for(let l=0;l<i;++l)a=3*r[o=t+3*l],n[0][0]=e[a],n[0][1]=e[a+1],n[0][2]=e[a+2],a=3*r[o+1],n[1][0]=e[a],n[1][1]=e[a+1],n[1][2]=e[a+2],a=3*r[o+2],n[2][0]=e[a],n[2][1]=e[a+1],n[2][2]=e[a+2],u[l]={box:[Math.min(n[0][0],n[1][0],n[2][0])-s,Math.min(n[0][1],n[1][1],n[2][1])-s,Math.min(n[0][2],n[1][2],n[2][2])-s,Math.max(n[0][0],n[1][0],n[2][0])+s,Math.max(n[0][1],n[1][1],n[2][1])+s,Math.max(n[0][2],n[1][2],n[2][2])+s],plucker:void 0};return u},_extractVertexBufferAndPrimitives:function(e,t){let i=[];if(e instanceof r){let r=e.getPrimitives();if(!r||!r.length)return;{const e=new Map,n=r.length;let s,o;for(let t=0;t<n;++t)s=r[t].getGroup(),s._geomType&&"FACE"===c.GeomTypeString[s._geomType]&&(this._setBoundingSphereToPrimitive(r[t]),o=e.get(s.geometry),o?o.push(r[t]):e.set(s.geometry,[r[t]]));e.forEach(((e,r,n)=>{var s={primitives:e,vBuffer:this._extractVertexBuffer(r,t)};i.push(s)}))}}else{let r;for(let n=0,s=e.length;n<s;++n){r=e[n].geometry;for(let e=0,n=r.length;e<n;e++){let n={primitives:this._extractPrimitives(r[e]),vBuffer:this._extractVertexBuffer(r[e],t)};i.push(n)}}}return i},_extractVertexBuffer:function(e,t){var r=e.vertexPositionArray;if(null==t||s.isIdentity(t))return r;var n=r.length,o=new Array(n),a=new i.Vector3(n);for(let e=0;e<n;e+=3)a.set(r[e],r[e+1],r[e+2]),a.applyMatrix4(t),o[e]=a.x,o[e+1]=a.y,o[e+2]=a.z;return o},_extractPrimitives:function(e){var t=[],r=e.drawingGroups,i=r.length,n=0;for(let e=0;e<i;e++)if(r[e]._geomType&&"FACE"===c.GeomTypeString[r[e]._geomType]){n=r[e].getPrimitivesCount();for(var s=0;s<n;s++){let i=new c.SGPrimitiveHelper;i.set(r[e],s),this._setBoundingSphereToPrimitive(i),t.push(i)}}return t},_setBoundingSphereToPrimitive:function(e){let t=e.getBoundingSphere();t||(t=e.computeBoundingSphere(),t&&e.setBoundingSphere(t))}})}));