/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
/*! based on Three.js Copyright Â© 2010-2014 three.js authors */
/*! Uses SMAA. Copyright (C) 2011 by Jorge Jimenez, Jose I. Echevarria,
Belen Masia, Fernando Navarro and Diego Gutierrez. */
define("DS/Visualization/Layers",["DS/Mesh/ThreeJS_Base"],(function(e){function t(e,t){if(t<=e.getPrimitiveStart(0))return 0;for(var i,r=e.getPrimitivesCount()-1,n=0;r-n>1;)i=Math.floor((r+n)/2),e.getPrimitiveStart(i)<t?n=i:r=i;return r}function i(e,t,i){for(var r,n=e.getPrimitivesCount()-1,s=i;n-s>1;)r=Math.floor((n+s)/2),e.getPrimitiveStart(r)+e.getPrimitiveCount(r)<t?s=r:n=r;return n}const r=e.__visibleInCurrentSpaceSimple;var n=function(e,t,i,r,n,s,a){this.layerNum=e||0,this.material=r||null,this.gas=null,n&&(this.gas=n.__getGAS(this.gas)),this.start=t||0,this.count=i||0,this.primitiveStart=0,this.primitiveCount=0,this.primitiveOverrideMaterial=s||null,this.noZ=void 0!==a?a:-1};n.prototype={constructor:n,clone:function(){var e=new n(this.layerNum,this.start,this.count,this.material,this.gas,void 0,this.noZ);return e.primitiveStart=this.primitiveStart,e.primitiveCount=this.primitiveCount,e},skip:function(e,t){return this.layerNum<=0||!!e&&(this.gas&&this.gas.isGAS?!this.gas.visibleInCurrentSpace(e,t):!r(e.visible,e.visibilityFree,t,null))},getMaterial:function(){return this.primitiveOverrideMaterial?this.primitiveOverrideMaterial:this.material}};var s=function(e,t,i){this.geometry=void 0!==e?e:null,this.drawableGroup=void 0!==t?t:null,this.drawableInterval=void 0!==i?i:null};s.prototype={constructor:s,clone:function(){var e=new s;return e.geometry=this.geometry,e.drawableGroup=this.drawableGroup,e.drawableInterval=this.drawableInterval.clone(),e},_computeOrientedBoundingBox:function(t){var i=!0,r=this.drawableInterval,n=this.geometry,s=n.vertexIndexArray,a=new e.Vector3,o=new e.Vector3,l=new e.Vector3;if(r.layerNum&&r.count){var h=r.start,c=r.start+r.count;if(i){i=!1;var d=s[h];n.getVertexPosition(d,l),a.set(l.x,l.y,l.z).applyMatrix4(t),o.set(l.x,l.y,l.z).applyMatrix4(t)}for(var u=h;u<c;u++){d=s[u];n.getVertexPosition(d,l),l.applyMatrix4(t),l.x<a.x&&(a.x=l.x),l.y<a.y&&(a.y=l.y),l.z<a.z&&(a.z=l.z),l.x>o.x&&(o.x=l.x),l.y>o.y&&(o.y=l.y),l.z>o.z&&(o.z=l.z)}}return new e.Box3(a,o)}};var a=function(e){this.layers=[],this.upToDate=!1,this.mesh=e};return a.prototype={constructor:a,clone:function(e){for(var t=new a(this.mesh),i=0;i<this.layers.length;i++){var r=this.layers[i].clone();e&&(r.drawableInterval.layerNum=0),t.addLayerInterval(r)}return t},getIntervals:function(e,t,i){for(var r=[],n=0;n<this.layers.length;n++){var s=this.layers[n];s.geometry!==e||t&&s.drawableGroup!==t||r.push(i?s:s.drawableInterval)}return r},getInterval:function(e){for(var t=e.group,i=t.geometry,r=this.getIntervals(i,t),n=0;n<r.length;n++){var s=r[n];if(e.start>=s.start&&e.start+e.count<=s.start+s.count)return s}return null},addLayerInterval:function(e){this.layers.push(e),this.upToDate=!1},removeIntervals:function(e,t){for(var i=void 0!==t,r=0,n=0;n<this.layers.length;n++){var s=this.layers[n];s.geometry==e&&(!i||i&&s.drawableGroup==t)?r++:r>0&&(this.layers.splice(n-r,r),n-=r,r=0)}r>0&&this.layers.splice(this.layers.length-r,r),this.upToDate=!1},addPrimitivesToLayersOpacity:function(e,t,i){var r=[];this.addPrimitivesToLayers_internal(e,t,(function(e){var t=r[e.id];return t||((t=e.clone()).opacity=i,t.transparent=!0,r[e.id]=t),t})),this.upToDate=!1},addPrimitivesToLayers:function(e,t,i,r,n,s){this.addPrimitivesToLayers_internal(e,t,(function(){return i}),r,n,s),this.upToDate=!1},addPrimitivesToLayers_internal:function(e,t,i,r,n,s){var a;this.mesh._flagAsGSSOInvalidated();var o=new Map;for(a=0;a<e.length;a++){var l=e[a],h=l.getGroup(),c=o.get(h);c||(c=[],o.set(h,c)),c.push(l)}var d=[];for(o.forEach(((e,t)=>{d.push(e)})),a=0;a<d.length;a++)d[a].sort((function(e,t){return e.getStart()<t.getStart()?-1:e.getStart()>t.getStart()?1:0}));for(a=0;a<d.length;a++){var u=d[a][0].getGroup(),p=u.geometry,f=i(u.gas);this.addPrimitivesToLayer(p,u,d[a],t,f,r,n,s)}},addPrimitivesToLayer:function(e,r,a,o,l,h,c,d){var u,p,f=this.getIntervals(e,r,!0),g=[],m=function(e){return h?h.__getGAS(e):e};if(f.length){var v=0,_=f[v].drawableInterval,y=void 0===o?_.layerNum:o,S=m(_.gas),b=void 0===l?_.material:l,x=void 0===c?_.primitiveOverrideMaterial:c,w=void 0===d?_.noZ:d;u=_.start,p=_.count;var P=0,C=!0;for(A=0;A<a.length;A++){var M=(D=a[A]).getStart(),E=D.getCount();if(E&&(C||P!==M)){for(C=!1,P=M;M+E>u+p;)p&&g.push(new n(_.layerNum,u,p,_.material,_.gas,_.primitiveOverrideMaterial,_.noZ)),_=f[++v].drawableInterval,y=void 0===o?_.layerNum:o,S=m(_.gas),b=void 0===l?_.material:l,x=void 0===c?_.primitiveOverrideMaterial:c,w=void 0===d?_.noZ:d,u=_.start,p=_.count;if(y!==_.layerNum||b!==_.material||S!==_.gas||x!==_.primitiveOverrideMaterial||w!==_.noZ){M>u&&g.push(new n(_.layerNum,u,M-u,_.material,_.gas,_.primitiveOverrideMaterial,_.noZ)),g.push(new n(y,M,E,b,S,x,w));var T=M+E;p=_.count-T+_.start,u=T}}}p>0&&g.push(new n(_.layerNum,u,p,_.material,_.gas,_.primitiveOverrideMaterial,_.noZ));for(var A=v+1;A<f.length;A++)g.push(f[A].drawableInterval);this.removeIntervals(e,r)}else for(A=0;A<a.length;A++){var D=a[A];g.push(new n(void 0===o?1:o,D.start,D.count,l||null,h||null,c||null,d))}var I=g[0].layerNum,R=g[0].material,O=g[0].gas,L=g[0].primitiveOverrideMaterial,B=g[0].noZ;for(u=g[0].start,p=0,A=0;A<g.length;A++){var F=g[A];if(F.layerNum===I&&F.material===R&&F.gas===O&&F.primitiveOverrideMaterial===L&&F.noZ===B)p+=F.count;else{var V=new n(I,u,p,R,O,L,B);this.addLayerInterval(new s(e,r,V)),I=F.layerNum,R=F.material,L=F.primitiveOverrideMaterial,O=F.gas,B=F.noZ,u=F.start,p=F.count}if(A==g.length-1){V=new n(I,u,p,R,O,L,B);this.addLayerInterval(new s(e,r,V))}}for(A=0;A<this.layers.length;A++){var G=this.layers[A],N=G.drawableGroup;if(N===r&&G.geometry===e){var U=G.drawableInterval,k=0,z=N.getPrimitivesCount();if(z){if(z<20)for(;U.start>N.getPrimitiveStart(k);)k++;else k=t(N,U.start);U.primitiveStart=k;var H=N.count/z;if(z-k<20||U.count/H<20)for(;U.start+U.count>N.getPrimitiveStart(k)+N.getPrimitiveCount(k);)k++;else k=i(N,U.start+U.count,k);U.primitiveCount=k-U.primitiveStart+1}else U.primitiveStart=0,U.primitiveCount=0}}},setDGToLayer:function(e,t,i,r,n,s,a){for(var o=this.getIntervals(e,t),l=0;l<o.length;l++){var h=o[l];void 0!==i&&(h.layerNum=i),void 0!==r&&(h.material=r),void 0!==n&&(h.gas=n.__getGAS(h.gas)),void 0!==a&&(h.noZ=a),void 0!==s&&(h.primitiveOverrideMaterial=s)}}},{DrawableInterval:n,LayerInterval:s,BufferLayer:a}}));var Stats=function(){var e,t,i,r,n,s,a,o,l=0,h=0,c=Date.now(),d=c,u=c,p=0,f=1e3,g=0,m=[[16,16,48],[0,255,255]],v=0,_=1e3,y=0,S=[[16,48,16],[0,255,0]];for((e=document.createElement("div")).style.cursor="pointer",e.style.width="80px",e.style.opacity="0.9",e.style.zIndex="10001",e.addEventListener("mousedown",(function(e){e.preventDefault(),0==(l=(l+1)%2)?(i.style.display="block",s.style.display="none"):(i.style.display="none",s.style.display="block")}),!1),(i=document.createElement("div")).style.textAlign="left",i.style.lineHeight="1.2em",i.style.backgroundColor="rgb("+Math.floor(m[0][0]/2)+","+Math.floor(m[0][1]/2)+","+Math.floor(m[0][2]/2)+")",i.style.padding="0 0 3px 3px",e.appendChild(i),(r=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",r.style.fontSize="9px",r.style.color="rgb("+m[1][0]+","+m[1][1]+","+m[1][2]+")",r.style.fontWeight="bold",r.innerHTML="FPS",i.appendChild(r),(n=document.createElement("div")).style.position="relative",n.style.width="74px",n.style.height="30px",n.style.backgroundColor="rgb("+m[1][0]+","+m[1][1]+","+m[1][2]+")",i.appendChild(n);n.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height="30px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+m[0][0]+","+m[0][1]+","+m[0][2]+")",n.appendChild(t);for((s=document.createElement("div")).style.textAlign="left",s.style.lineHeight="1.2em",s.style.backgroundColor="rgb("+Math.floor(S[0][0]/2)+","+Math.floor(S[0][1]/2)+","+Math.floor(S[0][2]/2)+")",s.style.padding="0 0 3px 3px",s.style.display="none",e.appendChild(s),(a=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",a.style.fontSize="9px",a.style.color="rgb("+S[1][0]+","+S[1][1]+","+S[1][2]+")",a.style.fontWeight="bold",a.innerHTML="MS",s.appendChild(a),(o=document.createElement("div")).style.position="relative",o.style.width="74px",o.style.height="30px",o.style.backgroundColor="rgb("+S[1][0]+","+S[1][1]+","+S[1][2]+")",s.appendChild(o);o.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height=30*Math.random()+"px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+S[0][0]+","+S[0][1]+","+S[0][2]+")",o.appendChild(t);return{domElement:e,update:function(){c=Date.now(),v=c-d,_=Math.min(_,v),y=Math.max(y,v),a.textContent=v+" MS ("+_+"-"+y+")";var e=Math.min(30,30-v/200*30);o.appendChild(o.firstChild).style.height=e+"px",d=c,h++,c>u+1e3&&(p=Math.round(1e3*h/(c-u)),f=Math.min(f,p),g=Math.max(g,p),r.textContent=p+" FPS ("+f+"-"+g+")",e=Math.min(30,30-p/100*30),n.appendChild(n.firstChild).style.height=e+"px",u=c,h=0)}}};define("DS/Visualization/Mixins/ViewerEffectMixins",["DS/Visualization/ThreeJS_DS","DS/Effects/BlurShadowEffect"],(function(e,t){"use strict";return{getEffect:function(e){var t=null;switch(e){case"xRevealStructure":t=this.renderer.XRevealStructureEffect;break;case"ToneMapping":case"Vignetting":t=this.renderer.ToneMappingEffect;break;case"Bloom":t=this.renderer.BloomEffect;break;case"DOF":t=this.renderer.BokehDOFEffect;break;case"SSLR":t=this.renderer.SSLREffect;break;case"SSLRDirect":t=this.renderer.SSLRDirectEffect;break;case"VolumeRendering":t=this.renderer.VolumeRenderingEffect;break;case"PointCloud":t=this.renderer.PointCloudEffect;break;case"SSAO":t=this.renderer.SSAOEffect;break;case"SSAOIterative":t=this.renderer.SSAOIterativeEffect;break;case"FakeOutlines":t=this.renderer.FakeOutlinesEffect;break;case"PreHighlight":t=this.renderer.PreHighlightEffect;break;case"PreHighlightMobile":t=this.renderer._PreHighlightMobileNonEffect;break;case"Canvas2DPreHighlight":t=this.renderer.Canvas2DPreHighlightEffect;break;case"Highlight":t=this.renderer.HighlightEffect;break;case"HighlightMobile":t=this.renderer._HighlightMobileNonEffect;break;case"Canvas2DHighlight":t=this.renderer.Canvas2DHighlightEffect;break;case"GaussianSplat":t=this.renderer.GaussianSplatEffect}return t},_setVisualSettings:function(e,t){if(!t)return this._setVisualSettings(e,"static"),void this._setVisualSettings(e,"dynamic");if("static"!==(t=t.toLowerCase())&&"dynamic"!==t&&(t="static"),"Iterative"===e.AntiAliasing&&(e.AntiAliasing="MSAA"),void 0!==e.AntiAliasing&&this.setAntiAliasing(e.AntiAliasing,t),void 0!==e.PixelCulling&&this.setPixelCulling(e.PixelCulling,t),void 0!==e.LOD&&this.setLOD(e.LOD,t),void 0!==e.Transparency&&this.setOIT(e.Transparency,t),void 0!==e.FlakesQuality&&this.setFlakesQuality(e.FlakesQuality,t),void 0!==e.DefaultMaterialQuality&&"dynamic"!==t&&this.setDefaultMaterialQuality(e.DefaultMaterialQuality),void 0!==e.Downsampling&&"dynamic"!==t&&this.setDownsamplingFactor(e.Downsampling),void 0!==e.AllowGroundShadows&&this.setAllowGroundShadow(e.AllowGroundShadows,t),void 0!==e.InterObjectShadows&&this.setShadow(e.InterObjectShadows,e.InterObjectShadowsLiSPSM,t),void 0!==e.AllowInterObjectShadows&&this.setAllowShadow(e.AllowInterObjectShadows,t),void 0!==e.ShadowQuality&&this.setShadowQuality(e.ShadowQuality,t),void 0!==e.ShadowFilter){var i="PCF"===e.ShadowFilter?"PCFOptimized":e.ShadowFilter;this.setShadowFilter(i,t)}if(void 0!==e.TransparentObjectShadows&&this.setransparentShadow(e.TransparentObjectShadows,t),void 0!==e.AllowTransparentObjectShadows&&this.setAllowTransparentShadow(e.AllowTransparentObjectShadows,t),void 0!==e.Bloom&&this.setBloom(e.Bloom,t),void 0!==e.AllowBloom&&this.setAllowBloom(e.AllowBloom,t),void 0!==e.DepthOfField&&this.setDOF(e.DepthOfField,t),void 0!==e.AllowDepthOfField&&this.setAllowDOF(e.AllowDepthOfField,t),void 0!==e.GroundReflection&&this.setMirror(e.GroundReflection,t),void 0!==e.AllowGroundReflection&&this.setAllowMirror(e.AllowGroundReflection,t),void 0!==e.InterObjectReflections&&this.setSSLR(e.InterObjectReflections,t),void 0!==e.AllowInterObjectReflections&&this.setAllowSSLR(e.AllowInterObjectReflections,t),void 0!==e.InterObjectRefractions&&this.setSSLRefraction(e.InterObjectRefractions,t),void 0!==e.AllowInterObjectRefractions&&this.setAllowSSLRefraction(e.AllowInterObjectRefractions,t),void 0!==e.AmbientOcclusion&&this.setSSAO(e.AmbientOcclusion,t),void 0!==e.AllowAmbientOcclusion&&this.setAllowSSAO(e.AllowAmbientOcclusion,t),void 0!==e.AmbientOcclusionNbSamples){var r=parseInt(e.AmbientOcclusionNbSamples);this.setSSAOParameters({nbOfSamples:r},t)}void 0!==e.DepthFlickeringReduction&&this.enableZPrePass(e.DepthFlickeringReduction,t),void 0!==e.SectionCapping&&this.setSectionCappingMode(e.SectionCapping,t)},_getVisualSetting:function(e){var t=this._viewerEffectSettings.settings[e];if(!t)return null;let i={static:t.static,dynamic:t.dynamic};return e.AntiAliasing&&"MSAA"===i.static&&(i.static="Iterative"),i},getVisualSetting:function(e){return this._getVisualSetting(e)},onVisualSettingModified:function(e){return this._modelEvent.subscribe({event:"VisualSettingModified"},e)},setAllowPolitenessOnHighlight:function(e,t){this._viewerEffectSettings.setAllowPolitenessOnHighlight(e,t)},getAllowPolitenessOnHighlight:function(e){return this._viewerEffectSettings.setAllowPolitenessOnHighlight(e)},setShadow:function(e,t,i){this._viewerEffectSettings.setShadow(e,t,i)},getShadow:function(e){return this._viewerEffectSettings.getShadow(e)},setAllowShadow(e,t){this._viewerEffectSettings.setAllowShadow(e,t)},getAllowShadow:function(e){return this._viewerEffectSettings.getAllowShadow(e)},setTransparentShadow:function(e,t){this._viewerEffectSettings.setTransparentShadow(e,t)},getTransparentShadow:function(e){return this._viewerEffectSettings.getTransparentShadow(e)},setAllowTransparentShadow(e,t){this._viewerEffectSettings.setAllowTransparentShadow(e,t)},getAllowTransparentShadow:function(e){return this._viewerEffectSettings.getAllowTransparentShadow(e)},setOIT:function(e,t){this._viewerEffectSettings.setOIT(e,t)},getOIT:function(e){return this._viewerEffectSettings.getOIT(e)},getOITMode:function(e){return this._viewerEffectSettings.getOITMode(e)},setFlakesQuality:function(e,t){this._viewerEffectSettings.setFlakesQuality(e,t)},getFlakesQuality:function(e){return this._viewerEffectSettings.getFlakesQuality(e)},setDownsamplingFactor:function(e){this._viewerEffectSettings.setDownsamplingFactor(e)},getDownsamplingFactor:function(){return this._viewerEffectSettings.getDownsamplingFactor()},setSectionCappingMode(e,t){this._viewerEffectSettings.setSectionCapping(e,t)},getSectionCappingMode(e){return this._viewerEffectSettings.getSectionCapping(e)},setDefaultMaterialQuality:function(e){this._viewerEffectSettings.setDefaultMaterialQuality(e)},getDefaultMaterialQuality:function(){return this._viewerEffectSettings.getDefaultMaterialQuality()},enableZPrePass:function(e,t){this._viewerEffectSettings.enableZPrePass(e,t)},zPrePassEnabled:function(e){return this._viewerEffectSettings.zPrePassEnabled(iOnOff,e)},setShadowFilter:function(e,t){this._viewerEffectSettings.setShadowFilter(e,t)},getShadowFilter:function(e){return this._viewerEffectSettings.getShadowFilter(e)},setShadowQuality:function(e,t){this._viewerEffectSettings.setShadowQuality(e,t)},getShadowQuality:function(e){return this._viewerEffectSettings.getShadowQuality(e)},setShadowCascade:function(e,t,i){this.renderer.resetGSSOCache();var r=this._directionalLight._occurrences[0].renderable,n=t||1024,s=!1;if(null!==r){this.getRenderer()&&(this.getRenderer().shadowMapCascade=e),this.shadowMapWidth===n&&this.shadowMapHeight===n||(s=!0,this.shadowMapWidth=n,this.shadowMapHeight=n,e||(r.shadowMap=null,r.shadowMapWidth=n,r.shadowMapHeight=n)),r.shadowCascade=e,r.shadowCascadeCount=i||3,r.shadowCascadeWidth=[],r.shadowCascadeHeight=[],r.shadowCascadeBias=[],r.shadowCascadeNearZ=[],r.shadowCascadeFarZ=[];for(var a=0;a<r.shadowCascadeCount;a++)r.shadowCascadeWidth[a]=n,r.shadowCascadeHeight[a]=n,r.shadowCascadeBias[a]=-.005;if(r.shadowCascadeOffset.set(0,0,-10),s&&r.shadowCascadeArray)for(a=0;a<r.shadowCascadeArray.length;a++){var o=r.shadowCascadeArray[a];o.shadowMap=null,o.shadowMapWidth=n,o.shadowMapHeight=n,o.shadowBias=-.005}this.renderer&&this.renderer.recompileAllShaders(null)}},setGroundShadow:function(e,t){this._viewerEffectSettings.setGroundShadow(e,t)},getGroundShadow:function(e){return this._viewerEffectSettings.getGroundShadow(e)},setAllowGroundShadow:function(e,t){this._viewerEffectSettings.setAllowGroundShadow(e,t)},getAllowGroundShadow:function(e){return this._viewerEffectSettings.getAllowGroundShadow(e)},setGroundShadowAutomaticUpdate:function(e){this._dirLightGroundShadow.blockShadowUpdates(!e),e&&this._dirLightGroundShadow.updateShadowMap()},setGroundShadowDirection:function(e,t){this.groundShadowLatitude=e,this.groundShadowLongitude=t,this._dirLightGroundShadow.updateShadowMap()},_setGroundShadow:function(){if(!this.blurShadowEffect){this.blurShadowEffect=new t(this.renderer.renderer,this.renderer.renderTargetPool),this._dirLightGroundShadow.light3js.blurShadowEffect=this.blurShadowEffect;for(var e=0;e<this._dirLightGroundShadow._occurrences.length;e++)this._dirLightGroundShadow._occurrences[e].renderable.blurShadowEffect=this.blurShadowEffect}var i=this._dirLightGroundShadow.light3js.groundMaterial;i&&(i.getPDSFXUniform("groundShadow").value||(i.defines.GROUND_SHADOW=1,i.needsUpdate=!0))},setMirror:function(e,t,i,r,n){this._viewerEffectSettings.setMirror(e,t,i,r,n)},getMirror:function(e){return this._viewerEffectSettings.getMirror(e)},setAllowMirror:function(e,t){this._viewerEffectSettings.setAllowMirror(e,t)},getAllowMirror:function(e){return this._viewerEffectSettings.getAllowMirror(e)},setAntiAliasing:function(e,t){this._viewerEffectSettings.setAntiAliasing(e,t)},getAntiAliasing:function(e){return this._viewerEffectSettings.getAntiAliasing(e)},setPixelCulling:function(e,t){this._viewerEffectSettings.setPixelCulling(e,t)},getPixelCulling:function(e){return this._viewerEffectSettings.getPixelCulling(e)},setLOD:function(e,t){this._viewerEffectSettings.setLOD(e,t)},getLOD:function(e){return this._viewerEffectSettings.getLOD(e)},setSSAO:function(e,t){this._viewerEffectSettings.setSSAO(e,t)},getSSAO:function(e){return this._viewerEffectSettings.getSSAO(e)},setAllowSSAO:function(e,t){this._viewerEffectSettings.setAllowSSAO(e,t)},getAllowSSAO:function(e){return this._viewerEffectSettings.getAllowSSAO(e)},setSSAOParameters:function(e,t){var i=this.ssaoParams;void 0!==e.dynamicRadius&&(i.dynamicRadius=e.dynamicRadius),void 0!==e.adaptativeRadius&&(i.adaptativeRadius=e.adaptativeRadius),void 0!==e.radius&&(i.radius=e.radius),void 0!==e.radiusMin&&(i.radiusMin=e.radiusMin),void 0!==e.radiusMax&&(i.radiusMax=e.radiusMax),void 0!==e.minPixelRadius&&(i.minPixelRadius=e.minPixelRadius),void 0!==e.attenuation&&(i.attenuation=e.attenuation),void 0!==e.contrast&&(i.contrast=e.contrast),void 0!==e.power&&(i.power=e.power),void 0!==e.thresholdAngle&&(i.thresholdAngle=e.thresholdAngle),0!==e.nbOfSamples&&8!==e.nbOfSamples&&16!==e.nbOfSamples&&32!==e.nbOfSamples||this._viewerEffectSettings.setSSAONbSamples(e.nbOfSamples,t)},setIterativeSSAO:function(e){this.useSSAOIterative=e},setDOF:function(e,t){return this._viewerEffectSettings.setDOF(e,t)},getDOF:function(e){return this._viewerEffectSettings.getDOF(e)},setAllowDOF:function(e,t){return this._viewerEffectSettings.setAllowDOF(e,t)},getAllowDOF:function(e){return this._viewerEffectSettings.getAllowDOF(e)},setIterativeDOF:function(e){this.useDOFIterative=e},setSSLR:function(e,t){this._viewerEffectSettings.setSSLR(e,t)},getSSLR:function(e){return this._viewerEffectSettings.getSSLR(e)},setAllowSSLR:function(e,t){this._viewerEffectSettings.setAllowSSLR(e,t)},getAllowSSLR:function(e){return this._viewerEffectSettings.getAllowSSLR(e)},setSSLRefraction:function(e,t){this._viewerEffectSettings.setSSLRefraction(e,t)},getSSLRefraction:function(e){return this._viewerEffectSettings.getSSLRefraction(e)},setAllowSSLRefraction:function(e,t){this._viewerEffectSettings.setAllowSSLRefraction(e,t)},getAllowSSLRefraction:function(e){return this._viewerEffectSettings.getAllowSSLRefraction(e)},setBloom:function(e,t){this._viewerEffectSettings.setBloom(e,t)},getBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setAllowBloom:function(e,t){this._viewerEffectSettings.setAllowBloom(e,t)},getAllowBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setRenderSettings:function(e){!e||void 0!==e.type&&"rasterizer"!==e.type||(e.ambientOcclusion&&e.ambientOcclusion.activation&&(this.setSSAOParameters({dynamicRadius:!1,adaptativeRadius:!0,radius:e.ambientOcclusion.radius?e.ambientOcclusion.radius:100,radiusMin:.005,radiusMax:.12,minPixelRadius:14,attenuation:.984,contrast:e.ambientOcclusion.intensity?e.ambientOcclusion.intensity:1,power:1,thresholdAngle:1.32645023152}),viewer.setSSAO(!0)),e.reflection&&e.reflection.activation&&viewer.setSSLR(!0))},setToneMapping:function(e){var t=this.renderer.ToneMappingEffect;if(t){var i=!0;void 0!==e.gamma&&(t.setGamma(e.gamma),i=!1),void 0!==e.enable&&(e.enable?t.setToneMapping(i?1:2):t.setToneMapping(0))}},setAutoExposure:function(e,t){var i=this.getEffect("ToneMapping");i&&(t||(t={}),i.setAutoExposure(e,t.weightTexture,t.clampMin,t.clampMax))},setVignetting:function(e){this.useVignetting!==e&&(this.renderer.setEffect("Vignetting",e),this.useVignetting=e,this.render())},setFlare:function(e){this.useFlare!==e&&(this.renderer.setEffect("Flare",e),this.useFlare=e,this.render())},setPointCloudAdvanced:function(e){this.pointCloudHQ!==e&&(this.renderer.setEffect("PointCloud",e),this.pointCloudHQ=e,this.render())},setFakeOutlines:function(e){this.useFakeOutlines!==e&&(this.renderer.setEffect("FakeOutlines",e),this.useFakeOutlines=e,this.render())}}})),define("DS/Visualization/Mixins/ViewerLightsAndAmbiancesMixins",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/Ambience","DS/SceneGraphNodes/DirectionalLightNode","DS/Visualization/PlaneGrid","DS/Visualization/Mixins/ViewerRenderModeMixins"],(function(e,t,i,r,n,s,a,o){"use strict";const l=o.NoShowData.noShowColor,h=(o.NoShowData.noShowAlpha,o.NoShowData.noShowSaturationRatio),c=o.NoShowData.noShowBlendingRatio,d=[81,81,81,128],u=[61,200,0,124],p=t._AmbianceGenerators,f={setAmbience:function(e,t){this.ambience.removeLights(this);var i="Custom";i!==this.visuEnv&&(this.visuEnv=i,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:"Custom"}})),this.ambience.isOCA&&this.ambience.dispose(),this.ambience=e,t&&(this.setGroundOptions({groundSize:100,groundShadow:!1,displayPlane:!1,displayGrid:!1,displayGridFromBelow:!1,gridNbSteps:5,gridLabels:null,gridLabelCallback:null,gridDisplayLabelCallback:null,planeMirror:!1,blurryMirror:!1,planeColor:"#EEEEEE",planeOpacity:1,planeTexture:null,planeTextureScale:1,gridColor:"#EEEEEE",gridFalloff:0,planeFalloff:0,planeBorder:!1,planeBorderColor:"#FFFFFF"}),this.setGroundOptions(e.getGroundOptions())),this.ambience.updateAmbience(this),this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer,this),this._modelEvent.publish({event:"_VisuEnvCalled",data:{viewer:this}})},onVisuAmbianceStateChange:function(e,i,r){var n=[],s=t._AmbianceGenerators,a=0,o=function(t){var n=s._needsUpdate();if(t)i&&i({initialization:!0,computing:n});else if(s.manager){for(var o=!1,l=0;l<s.viewers.length;l++)if(s.viewers[l].forceRender){o=!0;break}n||o?(i&&i({initialization:!1,computing:!0}),a=1):1===a?(r&&r(),a=2):(e&&e(),a=0)}else s.loading?i&&i({initialization:!0,computing:!1}):(e&&e(),a=0)};return n.push(this.onPostRender((function(){o(!1)}))),n.push(this._modelEvent.subscribe({event:"_VisuEnvCalled"},(function(){o(!0)}))),o(!1),n},setV6Ambience:function(){var e=t.AutomatedTests()&&!this.ODTMode?"V6":"None";this.setVisuEnv(e)},removeAmbience:function(){this.ambience.removeLights(this),this.removeEnvMap(),this.ambience.needUpdateIBL.delete(this),this.renderer.SkyScatteringEffect&&this.renderer.SkyScatteringEffect.setEnabled(!1),this.ambience.isOCA&&this.ambience.dispose();var e=new n({viewer:this,v2:!0});this.setAmbience(e,!0)},_cleanAmbience:function(){this.ambience._removePhysicalGround(),this.removePlaneV2(),this.setGradientBackground(),this.removeAmbience(),this.renderer.setEffect("ToneMapping",!0);var e=this.renderer.ToneMappingEffect;e&&(this.setBloom(!1),e.setBrightness(0),e.setToneMapping(2)),this.renderer.renderer.resetInlinedPostProcess(),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setGroundShadow(!1),this.setShadowPlane(!0),this.setSSLR(!1),this.setSSLRefraction(!1),this.setAmbientLight(3158064),this.setTriLights(!1),this.enableDefaultLights(!1)},updateForegroundColor:function(i){this.renderer.renderer.__A2XMode||(e.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{slot:t.COLORMAP_INDEX.FOREGROUND,color:new t.Color(i),viewer:this}}}),this.renderer.resetGSSOCache())},setVisuEnvOCA:function(r,o,p){var f=null,g=new n({viewer:this,v2:!0}),m=this;function v(i,r){m.renderer.renderer.__A2XMode||(e.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{slot:t.COLORMAP_INDEX.BACKGROUND,color:i,viewer:m}}}),e.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{slot:t.COLORMAP_INDEX.FOREGROUND,color:r,viewer:m}}}),m.renderer.resetGSSOCache())}g.keepIBLTexture=!1,g.keepBackgroundTexture=!1,g.isOCA=!0;m=this;var _=0,y=function(){if(--_<=0){m._cleanAmbience();var e=m.renderer.ToneMappingEffect,i=m.renderer.renderer.inlinedPostProcess;if(m.setAmbience(g),f){if(void 0!==f.backgroundColor&&m.setBackgroundColor(f.backgroundColor),f.grid&&(m.setGrid(!0),m.setGridColor(f.gridColor)),f.shadowPlane&&m.setShadowPlane(!0),f.ssao){m.setSSAO(!0);var n=m.ssaoParams;n.minPixelRadius=f.ssao.minPixelRadius,n.dynamicRadius=f.ssao.dynamicRadius,n.adaptativeRadius=f.ssao.adaptativeRadius,n.attenuation=f.ssao.attenuation,n.contrast=f.ssao.contrast,n.power=f.ssao.power,n.radius=f.ssao.radius,n.radiusMin=f.ssao.radiusMin,n.radiusMax=f.ssao.radiusMax,n.thresholdAngle=f.ssao.thresholdAngle}f.ambientLight&&m.setAmbientLight(f.ambientLight),e?(f.toneMapping&&e.setToneMapping(f.toneMapping.type,f.toneMapping.params),f.brightness&&e.setBrightness(f.brightness),f.bloom&&(m.setBloom(!0),m.getEffect("Bloom")._setBloom(f.bloom))):f.inlinedPostProcess&&(i.activated=f.inlinedPostProcess.activated,i.brightness=f.inlinedPostProcess.brightness,i.tonemapping=f.inlinedPostProcess.tonemapping,i.crushblacks=f.inlinedPostProcess.crushblacks,i.burnhighlights=f.inlinedPostProcess.burnhighlights),f.planeV2&&(m.planeV2=!0,m._requestedPlaneV2=!0,m.planeGrid||(m.planeGrid=new a(m)),m.setGroundOptions({displayPlane:!0,planeColor:f.planeV2.planeColor,planeFalloff:f.planeV2.planeFalloff,_onlyDiffuse:f.planeV2._onlyDiffuse})),f.shadow&&(m.setShadow(!0),m.setTransparentShadow(!0)),f.sslr&&m._useQM&&(m.setSSLR(!0),m.setSSLRefraction(!0))}if(m.ambience.updateAmbience(m),m.render({updateInfinitePlane:!0}),m.ambience.getBackground().hasGradient()){m.showGradientBackground=[];for(var s=m.ambience.getBackground().getColors(),d=[],u=0;u<s.length;u++)m.showGradientBackground.push(new t.Color(s[u])),m.visibleSpace||d.push(s[u].desaturate(h).alphaBlend(l,c));d.length&&m.ambience.getBackground().setColors(d)}var p=r+"OCA";p!==m.visuEnv&&(m.visuEnv=p,m._modelEvent.publish({event:"VisuEnv",data:{viewer:m,value:p}})),o&&o({ambiance:m.ambience})}},S=function(e,i,r,n){var s=2*(e/r-.5)*Math.PI,a=-((n-i)/n-1)*Math.PI;return new t.Vector3(Math.cos(s)*Math.sin(a),Math.sin(s)*Math.sin(a),Math.cos(a))};"NeoPureWhite"===r&&(r="WhiteExperience");let b=r;switch(b){case"Basic":v((new t.Color).setRGB(.9215686321258545,.9215686321258545,.9215686321258545),(new t.Color).setRGB(0,0,0)),this._cleanAmbience(),this._setVisuEnv("No"),this.useDefaultLights&&(this._directionalLight.castShadows(!1),this._directionalLight2.castShadows(!1));var x=b+"OCA";return void(x!==this.visuEnv&&(this.visuEnv=x,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:x}})));case"WhiteDesign":v((new t.Color).setRGB(.9019608497619629,.9019608497619629,.9019608497619629),(new t.Color).setRGB(0,0,0)),f={backgroundColor:15132390,grid:!0,gridColor:8355711,shadowPlane:!1},g.getBackground().setFromJson({colors:[[.980392217636108,.980392217636108,.980392217636108,1],[.921568691730499,.921568691730499,.921568691730499,1],[.901960849761963,.901960849761963,.901960849761963,1],[.901960849761963,.901960849761963,.901960849761963,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),t._vrDevice?g.generateIBLFromColor(u,t.LogLUV_Encoding):g.generateIBLFromColor(d),(A=new s({color:16777215,intensity:.628318548202515})).setDirection(new t.Vector3(0,0,1)),g.addLightNode(A),(E=new s({color:16777215,intensity:1.884955644607544})).setDirection(new t.Vector3(-.5,.5,.707107)),E.attachToViewpoint(!0),g.addLightNode(E),(w=new s({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(.683012,.183015,.707107)),w.attachToViewpoint(!0),g.addLightNode(w),(P=new s({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(-.5,.5,-.707107)),P.attachToViewpoint(!0),g.addLightNode(P);break;case"BlueDesign":v((new t.Color).setRGB(.2352941334247589,.40000003576278687,.501960813999176),(new t.Color).setRGB(1,1,1)),f={backgroundColor:3958400,grid:!0,gridColor:16777215,shadowPlane:!1},g.getBackground().setFromJson({colors:[[.39607846736908,.549019634723663,.643137276172638,1],[.243137270212173,.415686309337616,.521568655967712,1],[.235294133424759,.400000035762787,.501960813999176,1],[.235294133424759,.400000035762787,.501960813999176,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),(A=new s({color:16777215,intensity:.628318548202515})).setDirection(new t.Vector3(0,0,1)),g.addLightNode(A),(E=new s({color:16777215,intensity:1.884955644607544})).setDirection(new t.Vector3(-.5,.5,.707107)),E.attachToViewpoint(!0),g.addLightNode(E),(w=new s({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(.683012,.183015,.707107)),w.attachToViewpoint(!0),g.addLightNode(w),(P=new s({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(-.5,.5,-.707107)),P.attachToViewpoint(!0),g.addLightNode(P),t._vrDevice?g.generateIBLFromColor(u,t.LogLUV_Encoding):g.generateIBLFromColor(d);break;case"DarkDesign":v((new t.Color).setRGB(.1764705926179886,.1764705926179886,.1764705926179886),(new t.Color).setRGB(1,1,1)),f={backgroundColor:2960685,grid:!0,gridColor:8355711,shadowPlane:!1},g.getBackground().setFromJson({colors:[[.274509817361832,.274509817361832,.274509817361832,1],[.196078449487686,.196078449487686,.196078449487686,1],[.176470592617989,.176470592617989,.176470592617989,1],[.176470592617989,.176470592617989,.176470592617989,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),(A=new s({color:16777215,intensity:.628318548202515})).setDirection(new t.Vector3(0,0,1)),g.addLightNode(A),(E=new s({color:16777215,intensity:1.884955644607544})).setDirection(new t.Vector3(-.5,.5,.707107)),E.attachToViewpoint(!0),g.addLightNode(E),(w=new s({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(.683012,.183015,.707107)),w.attachToViewpoint(!0),g.addLightNode(w),(P=new s({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(-.5,.5,-.707107)),P.attachToViewpoint(!0),g.addLightNode(P),t._vrDevice?g.generateIBLFromColor(u,t.LogLUV_Encoding):g.generateIBLFromColor(d);break;case"Studio":var w,P;if(v((new t.Color).setRGB(.9254902601242065,.9254902601242065,.9294118285179138),(new t.Color).setRGB(0,0,0)),f={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:1.22,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0},(A=new s({color:16777215,intensity:1.572345066070557})).setDirection(new t.Vector3(0,0,1)),g.addLightNode(A),(E=new s({color:15774860,intensity:1.884955644607544})).setDirection(new t.Vector3(-.883779,-.413691,.218621)),E.attachToViewpoint(!0),g.addLightNode(E),(w=new s({color:4214874,intensity:2.04})).setDirection(new t.Vector3(.865806,-.442989,-.232682)),w.attachToViewpoint(!0),g.addLightNode(w),(P=new s({color:7895160,intensity:.9424})).setDirection(new t.Vector3(.099,.099,.99)),P.attachToViewpoint(!0),g.addLightNode(P),_=2,g.getBackground().setFromJson({colors:[[.921568691730499,.921568691730499,.9294117,1],[1,1,1,1]],intensity:1,type:"gradient"}),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1}),t._vrDevice){var C={url:i.getWebappsAssetUrl("Ambiances","OCA/ambianceStudioLowLogLUV.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);var M={url:i.getWebappsAssetUrl("Ambiances","OCA/ambianceStudioLowLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/ambianceStudio.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/ambianceStudio_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.792156934738159,type:"transparent"});break;case"PureWhite":var E;v((new t.Color).setRGB(.9254902601242065,.9254902601242065,.9294118285179138),(new t.Color).setRGB(0,0,0)),f={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0},(E=new s({color:7895160,intensity:.6911})).setDirection(new t.Vector3(.099,.099,.99)),E.attachToViewpoint(!0),g.addLightNode(E);var T=g._getEnvironmentLightMatrix(),A=new t.DirectionalPhongLight(16777215,1),D=new s({light:A});D.setDirection(S(171,416,2048,1024).applyMatrix4(T)),g.addLightNode(D);var I=new t.DirectionalPhongLight(16777215,1);(F=new s({light:I})).setDirection(S(852,416,2048,1024).applyMatrix4(T)),g.addLightNode(F);var R=new t.DirectionalPhongLight(16777215,1);(V=new s({light:R})).setDirection(S(1536,416,2048,1024).applyMatrix4(T)),g.addLightNode(V);var O=new t.DirectionalPhongLight(16777215,1);if((G=new s({light:O})).setDirection(S(1024,0,2048,1024).applyMatrix4(T)),g.addLightNode(G),g.getBackground().setFromJson({colors:[[.9254,.9254,.9294,1],[1,1,1,1]],intensity:1,type:"gradient"}),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1}),_=2,t._vrDevice){C={url:i.getWebappsAssetUrl("Ambiances","OCA/pureWhiteLowLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/pureWhiteLowLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/pureWhite.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/pureWhite_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"WhiteExperience":v((new t.Color).setRGB(.8705883026123047,.8901961445808411,.9019608497619629),(new t.Color).setRGB(0,0,0)),f={backgroundColor:14607334,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},ambientLight:10066329,sslr:!0,planeV2:{planeColor:"#FFFFFF",planeFalloff:.25,_onlyDiffuse:1}};T=g._getEnvironmentLightMatrix(),A=new t.DirectionalPhongLight(8956671,1);(B=new s({light:A})).setDirection(S(1957,651,2048,1024).applyMatrix4(T)),g.addLightNode(B);I=new t.DirectionalPhongLight(16755336,1);(F=new s({light:I})).setDirection(S(1151,511,2048,1024).applyMatrix4(T)),g.addLightNode(F);R=new t.DirectionalPhongLight(16777215,1);(V=new s({light:R})).setDirection(S(0,215,2048,1024).applyMatrix4(T)),g.addLightNode(V);O=new t.DirectionalPhongLight(16777215,1);(G=new s({light:O})).setDirection(S(1024,215,2048,1024).applyMatrix4(T)),g.addLightNode(G),g.getBackground().setIntensity(1),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),U.setSpecularIntensity(1),U.setDiffuseIntensity(1),_=3;var L={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhiteBackground.png"),mapping:new t.LatLongEnvMapping,doneCallback:y};if(g.setBackGroundMap(L),t._vrDevice){C={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhiteLowLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhiteLowLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhite.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhite_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}p&&p.from3dx?g.getBackgroundGeometry().setAutoUpdateSize(!1):g.getBackgroundGeometry().setAutoUpdateSize(!0),(k=g.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.569,type:"transparent"}),g.usePlaneV2=!0;break;case"WhiteMirror":v((new t.Color).setRGB(1,1,1),(new t.Color).setRGB(0,0,0)),f={backgroundColor:16777215,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.932,contrast:3.088,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},g.getBackground().setFromJson({colors:[[1,1,1,1],[1,1,1,1]],intensity:1,type:"gradient"}),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});T=g._getEnvironmentLightMatrix(),A=new t.DirectionalPhongLight(16777215,1);(B=new s({light:A})).setDirection(S(171,416,2048,1024).applyMatrix4(T)),g.addLightNode(B);I=new t.DirectionalPhongLight(16777215,1.5);(F=new s({light:I})).setDirection(S(852,416,2048,1024).applyMatrix4(T)),g.addLightNode(F);R=new t.DirectionalPhongLight(16777215,1);(V=new s({light:R})).setDirection(S(1536,416,2048,1024).applyMatrix4(T)),g.addLightNode(V);O=new t.DirectionalPhongLight(16777215,1.5);if((G=new s({light:O})).setDirection(S(1024,0,2048,1024).applyMatrix4(T)),g.addLightNode(G),_=2,t._vrDevice){C={url:i.getWebappsAssetUrl("Ambiances","OCA/whiteMirrorLowLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/whiteMirrorLowLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/whiteMirror.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/whiteMirror_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"WhiteReview":v((new t.Color).setRGB(.8627451658248901,.8627451658248901,.8627451658248901),(new t.Color).setRGB(0,0,0)),f={backgroundColor:14474460,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},g.getBackground().setFromJson({colors:[[.8627,.8627,.8627,1],[1,1,1,1]],intensity:1,type:"gradient"}),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});T=g._getEnvironmentLightMatrix(),A=new t.DirectionalPhongLight(16777215,1.1);(B=new s({light:A})).setDirection(S(171,416,2048,1024).applyMatrix4(T)),g.addLightNode(B);I=new t.DirectionalPhongLight(16777215,1.25);(F=new s({light:I})).setDirection(S(852,416,2048,1024).applyMatrix4(T)),g.addLightNode(F);R=new t.DirectionalPhongLight(16777215,1.1);(V=new s({light:R})).setDirection(S(1536,416,2048,1024).applyMatrix4(T)),g.addLightNode(V);O=new t.DirectionalPhongLight(16777215,1.25);if((G=new s({light:O})).setDirection(S(1024,0,2048,1024).applyMatrix4(T)),g.addLightNode(G),_=2,t._vrDevice){C={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReviewLowLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReviewLowLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:0,height:0,reflectivity:0,shadowIntensity:.423529446125031,type:"transparent"});break;case"DarkMirror":v((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),f={backgroundColor:1118481,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},toneMapping:{type:6,params:{crushblacks:.75,burnhighlights:.12,saturation:1}},brightness:1,bloom:{nbIterations:6,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.75,burnhighlights:.12},shadow:!0,sslr:!0},(A=new s({color:16777215,intensity:1.633628129959106})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),A.setDirection(new t.Vector3(-.588439,0,.808542)),g.addLightNode(A),(I=new s({color:16777215,intensity:1.633628129959106})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),I.setDirection(new t.Vector3(.588439,0,.808542)),g.addLightNode(I),g.getBackground().setIntensity(1),_=3;L={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:t.RGBE_Encoding,mapping:new t.LatLongEnvMapping,doneCallback:y};if(g.setBackGroundMap(L),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858}),t._vrDevice){C={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirrorLowLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirrorLowLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.5,shadowIntensity:0,type:"transparent"});break;case"DarkReview":v((new t.Color).setRGB(.19607844948768616,.19607844948768616,.19607844948768616),(new t.Color).setRGB(1,1,1)),_=2,f={backgroundColor:3289650,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},g.getBackground().setFromJson({colors:[[.196,.196,.196,1],[.3529,.3529,.3529,1]],intensity:1,type:"gradient"}),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});var B;T=g._getEnvironmentLightMatrix(),A=new t.DirectionalPhongLight(16777215,1);(B=new s({light:A})).setDirection(S(171,416,2048,1024).applyMatrix4(T)),g.addLightNode(B);var F;I=new t.DirectionalPhongLight(16777215,1);(F=new s({light:I})).setDirection(S(852,416,2048,1024).applyMatrix4(T)),g.addLightNode(F);var V;R=new t.DirectionalPhongLight(16777215,1);(V=new s({light:R})).setDirection(S(1536,416,2048,1024).applyMatrix4(T)),g.addLightNode(V);var G;O=new t.DirectionalPhongLight(16777215,1);if((G=new s({light:O})).setDirection(S(1024,0,2048,1024).applyMatrix4(T)),g.addLightNode(G),t._vrDevice){C={url:i.getWebappsAssetUrl("Visualization","OCA/darkReviewLowLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Visualization","OCA/darkReviewLowLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:.447058856487274,type:"transparent"});break;case"Outdoor":v((new t.Color).setRGB(.9215686917304993,.9568628072738647,1),(new t.Color).setRGB(0,0,0)),f={backgroundColor:15463679,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1,contrast:1.8,power:1,radius:.06,radiusMin:.001,radiusMax:.1,thresholdAngle:1.31},toneMapping:{type:6,params:{crushblacks:1,burnhighlights:.01,saturation:1}},bloom:{nbIterations:5,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:1,burnhighlights:.01},shadow:!0,sslr:!0},(A=new s({color:16704193,intensity:18.8})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),A.setDirection(new t.Vector3(-.182353,.741268,.645963)),g.addLightNode(A),g.getBackground().setIntensity(1),_=3;L={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoor.png"),pngHdr:t.RGBE_Encoding,mapping:new t.LatLongEnvMapping,doneCallback:y};if(g.setBackGroundMap(L),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),U.setSpecularIntensity(.6),U.setDiffuseIntensity(.5),t._vrDevice){C={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoorLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoorLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoor.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoor_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"physical",planeColor:new t.Color(16768178)});var N=g.getBackgroundGeometry();p&&p.from3dx?N.setAutoUpdateSize(!1):N.setAutoUpdateSize(!0),k.setGroundOutDoor();break;case"Indoor":v((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),f={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1,toneMapping:{type:6,params:{crushblacks:.5,burnhighlights:.01,saturation:1}},bloom:{nbIterations:4,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.5,burnhighlights:.01},shadow:!0,sslr:!0},(A=new s({color:16777215,intensity:1.256637096405029})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),A.setDirection(new t.Vector3(0,.516689,.856173)),g.addLightNode(A),(I=new s({color:16777215,intensity:2.513274192810059})).setDirection(new t.Vector3(0,.961181,.27592)),g.addLightNode(I),(R=new s({color:16777215,intensity:1.256637096405029})).setDirection(new t.Vector3(0,-.506721,.86211)),g.addLightNode(R),g.getBackground().setIntensity(1),_=3;L={url:i.getWebappsAssetUrl("Ambiances","OCA/indoor.png"),pngHdr:t.RGBE_Encoding,mapping:new t.LatLongEnvMapping,doneCallback:y};g.setBackGroundMap(L),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858});N=g.getBackgroundGeometry();if(p&&!p.from3dx&&N.setAutoUpdateSize(!0),p&&p.from3dx?N.setAutoUpdateSize(!1):N.setAutoUpdateSize(!0),N.setFromJson({shootPosition:[0,0,0]}),t._vrDevice){C={url:i.getWebappsAssetUrl("Ambiances","OCA/indoorLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/indoorLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/indoor.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/indoor_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:0,height:0,reflectivity:.400000005960464,shadowIntensity:0,type:"transparent"}),g.setAutoGroundOffset(!0),g.setGroundHeight(new t.Vector3(0,0,.2)),g.setSceneHeight(new t.Vector3(0,0,.2)),this.render({updateInfinitePlane:!0});break;case"City":v((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),f={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1.7,toneMapping:{type:6,params:{crushblacks:.24,burnhighlights:.08,saturation:1}},bloom:{nbIterations:6,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1.7,tonemapping:6,crushblacks:.24,burnhighlights:.08},shadow:!0,sslr:!0},(A=new s({color:16777215,intensity:1.25})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),A.setDirection(new t.Vector3(.727313,-.001712,.686304)),g.addLightNode(A),g.getBackground().setIntensity(1),_=3;L={url:i.getWebappsAssetUrl("Ambiances","OCA/city.png"),pngHdr:t.RGBE_Encoding,mapping:new t.LatLongEnvMapping,doneCallback:y};g.setBackGroundMap(L),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),U.setSpecularIntensity(1),U.setDiffuseIntensity(.6);N=g.getBackgroundGeometry();if(p&&p.from3dx?N.setAutoUpdateSize(!1):N.setAutoUpdateSize(!0),N.setFromJson({shootPosition:[0,0,.5]}),t._vrDevice){C={url:i.getWebappsAssetUrl("Ambiances","OCA/cityLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/cityLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/city.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/city_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"transparent"}),g.setAutoGroundOffset(!0),g.setGroundHeight(new t.Vector3(0,0,.2)),g.setSceneHeight(new t.Vector3(0,0,.2));break;case"Road":v((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),f={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:.8,toneMapping:{type:6,params:{crushblacks:.2,burnhighlights:.17,saturation:1}},bloom:{nbIterations:4,bloomFactor:.058,threshold:0},inlinedPostProcess:{activated:!0,brightness:.8,tonemapping:6,crushblacks:.2,burnhighlights:.17},shadow:!0,sslr:!0},(A=new s({color:16777215,intensity:2.51})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),A.setDirection(new t.Vector3(.46785,-.847623,.250302)),g.addLightNode(A),g.getBackground().setIntensity(1),_=3;var U;L={url:i.getWebappsAssetUrl("Ambiances","OCA/road.png"),pngHdr:t.RGBE_Encoding,mapping:new t.LatLongEnvMapping,doneCallback:y};g.setBackGroundMap(L),(U=g.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.8});var k;N=g.getBackgroundGeometry();if(p&&p.from3dx?N.setAutoUpdateSize(!1):N.setAutoUpdateSize(!0),N.setFromJson({shootPosition:[0,0,0]}),t._vrDevice){C={url:i.getWebappsAssetUrl("Ambiances","OCA/roadLogLUV.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/roadLogLUV_rmips.png"),pngHdr:t.LogLUV_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}else{C={url:i.getWebappsAssetUrl("Ambiances","OCA/road.png"),pngHdr:t.RGBE_Encoding,doneCallback:y};g.setIblMap(C);M={url:i.getWebappsAssetUrl("Ambiances","OCA/road_rmips.png"),pngHdr:t.RGBE_Encoding,doneCallback:y,hasDiffuse:!0};g.setRoughnessMap(M)}(k=g.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:1,type:"transparent"}),g.setAutoGroundOffset(!0),g.setGroundHeight(new t.Vector3(0,0,.17)),g.setSceneHeight(new t.Vector3(0,0,.43)),this.render({updateInfinitePlane:!0});break;default:return f={backgroundColor:0},g.updateAmbience(this),void y()}return 0==_&&(y(),!0)},_setVisuEnv:function(e){this.ambience._removePhysicalGround(),this.setGradientBackground(),this.ambience.removeLights(this),this._useDefaultAmbiancesIBL&&this.ambience.dispose(),this.removePlaneV2(),this.renderer.setEffect("ToneMapping",!0);var r=this.renderer.ToneMappingEffect;r&&(this.setBloom(!1),r.setBrightness(0),r.setToneMapping(this.renderer.tonemapping)),this.renderer.renderer.resetInlinedPostProcess();var n="SMAA",s=!0,a=null;switch(this._configAmbiences&&this._configAmbiences.effects&&(a=this._configAmbiences.effects),this.setGroundShadow(!1),e){case"None":case"No":if(this.ODTMode&&a&&!a.force){this.setGrid(!1),this.displayInfinitePlane(!1),this.setShadowPlane(!1),this.setBackgroundColor(14414586),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),s=!1;break}var o=!1,l=!1,h=!1,c=!1,p=!1,f=new t.Color,g=new t.Color,m=new t.Color;if(a){var v=a.BackgroundColor;"false"===a.AntiAliasing&&(n="NoAA"),o="false"!==a.Plane,l="false"!==a.Grid,h="false"!==a.Mirror,c="false"!==a.Shadow,p="false"!==a.SSAO,v&&(f.r=void 0!==v.red?v.red:1,f.g=void 0!==v.green?v.green:1,f.b=void 0!==v.blue?v.blue:1)}this.setGrid(l),this.displayInfinitePlane(o),this.setShadowPlane(o),this._preferenceBackgroundColor&&(f=this._preferenceBackgroundColor);var _=Math.min(Math.max(0,.2126*f.r+.7152*f.g+.0722*f.b),1)>=.5?0:1;g.r=.4*_+.6*f.r,g.g=.4*_+.6*f.g,g.b=.4*_+.6*f.b,m.r=.05*_+.95*f.r,m.g=.05*_+.95*f.g,m.b=.05*_+.95*f.b,this.renderer.renderer.__A2XMode&&(f=this.getColorFromColorMap(t.COLORMAP_INDEX.BACKGROUND)),this.setBackgroundColor(f.getHex()),this.setPlaneColor(m.getHex()),this.setGridColor(g.getHex()),this.setSSAO(p);var y=this.ssaoParams;p&&(y.dynamicRadius=!0,y.adaptativeRadius=!0,y.radius=.04,y.radiusMin=.01,y.radiusMax=.12,y.minPixelRadius=14,y.attenuation=1,y.contrast=2,y.power=1,y.thresholdAngle=1.35),this.setShadow(c),this.setTransparentShadow(c),this.setMirror(h,!0),this._useDefaultAmbiancesIBL&&(t._vrDevice?this.ambience.generateIBLFromColor(u,t.LogLUV_Encoding):this.ambience.generateIBLFromColor(d)),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"V6":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setGridColor(13421772),this.setSSAO(!0),(y=this.ssaoParams).dynamicRadius=!0,y.adaptativeRadius=!0,y.radius=.04,y.radiusMin=.01,y.radiusMax=.12,y.minPixelRadius=14,y.attenuation=1,y.contrast=2.5,y.power=1,y.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){var S={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(S);var b={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview_rmips.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(b)}break;case"CleanSpace":if(this.setGrid(!1),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setSSAO(!0),(y=this.ssaoParams).dynamicRadius=!0,y.adaptativeRadius=!0,y.radius=.04,y.radiusMin=.01,y.radiusMax=.12,y.minPixelRadius=14,y.attenuation=1,y.contrast=2.5,y.power=1,y.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){S={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(S);b={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview_rmips.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(b)}break;case"DarkBlue":this.setGrid(!0),this.displayInfinitePlane(!1),this.setBackgroundColor(3958400),this.setGradientBackground([6728399,3958400,1848912]),this.setGridColor(8362924),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this._useDefaultAmbiancesIBL&&(t._vrDevice?this.ambience.generateIBLFromColor(u,t.LogLUV_Encoding):this.ambience.generateIBLFromColor(d)),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"DarkGrey":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(3881787),this.setPlaneColor(2960685),this.setGridColor(7303023),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){S={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(S);b={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview_rmips.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(b)}break;case"Shiny":if(this.setGrid(!1),this.displayInfinitePlane(!0,!0),this.setBackgroundColor(1118481),this.setGradientBackground([6710886,2105376,0]),this.setPlaneColor(6710886),this.setSSAO(!0),(y=this.ssaoParams).dynamicRadius=!0,y.adaptativeRadius=!0,y.radius=.04,y.radiusMin=.01,y.radiusMax=.12,y.minPixelRadius=14,y.attenuation=1,y.contrast=2.8,y.power=1,y.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){S={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(S);b={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror_rmips.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(b)}break;case"Studio":if(this.setGrid(!1),this.displayInfinitePlane(!1),this.setBackgroundColor(15527148),this.setGradientBackground([7497556,15131615,9668981]),this.setPlaneColor(16119027),this.setSSAO(!0),(y=this.ssaoParams).dynamicRadius=!0,y.adaptativeRadius=!0,y.radius=.04,y.radiusMin=.01,y.radiusMax=.12,y.minPixelRadius=14,y.attenuation=1,y.contrast=2.5,y.power=1,y.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!0,!0),this._useDefaultAmbiancesIBL){S={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[0,153,153,153,126]};this.ambience.setIblMap(S);b={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror_rmips.png"),pngHdr:t.RGBE_Encoding,onlyOnRequest:!0,fallbackColor:[1,153,153,153,126],hasDiffuse:!0};this.ambience.setRoughnessMap(b)}this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;default:return}var x=e;x!==this.visuEnv&&(this.visuEnv=x,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:x}})),this.ODTMode&&!this.disableAutoSMAA&&this.setAntiAliasing(n),this.setTriLights(s),this.triLights?this.dirLightLatitude=.34:(this.setSecondaryLightColor(15527148),this.setDirectionalLight(.34,.16,16777215,.95*Math.PI))},setVisuEnv:function(e){this._setVisuEnv(e)},getVisuEnv:function(){return this.visuEnv},onVisuEnvChange:function(e){return this._modelEvent.subscribe({event:"VisuEnv"},e)},showEnvMap:function(e){var t=this.ambience.getBackground();t.isActivated()!==e&&(e?(t.withImage()||t.hasGradient())&&t.setActivated(e):t.setActivated(e))},setEnvMap:function(e,i,r){if(2===i){console.error("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");var n=this,s=0,a=2===e.length?e[0]:null,o=2===e.length?e[1]:null;a||(a=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping)),a.minFilter=t.NearestFilter,a.magFilter=t.NearestFilter,a.wrapS=t.RepeatWrapping,a.wrapT=t.RepeatWrapping,o||(o=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping)),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=function(){2===++s&&(n.internalSceneGraph.scene.envMipMap[0]=a,n.internalSceneGraph.scene.envMipMap[1]=o,p._decreaseSceneUseCount(n.internalSceneGraph.scene),n.render(),r&&r())};return a&&a.onLoadCallbacks.push(l),o&&o.onLoadCallbacks.push(l),a}null!==e?e.length||e instanceof t.Texture?(console.error("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation."),2===e.length?(this.ambience.setBackGroundMap({texture:e[0]}),this.ambience.setRoughnessMap({texture:e[1]})):this.ambience.setBackGroundMap({texture:e})):this._setEnvMap(e):console.error("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.")},_setSphereEnv:function(e){e&&(this.sphereEnv=e,this.sceneBackground.add(e))},_setEnvMap:function(e){var i=void 0,n=0,s=0,a=function(){++s===n&&e.doneCallback&&e.doneCallback()};e.roughnessMap instanceof t.Texture?(n++,this.ambience.setRoughnessMap({texture:e.roughnessMap,doneCallback:a}),i=!0):null===e.roughnessMap&&(i=null);if(e.IBLMap){if(e.IBLMap instanceof t.Texture)n++,this.ambience.setIblMap({texture:e.IBLMap,doneCallback:a});else if(""!==e.IBLMap){var o="dds"===r.getExtension(e.IBLMap);n++,o?this.ambience.setReflectionMap({url:e.IBLMap,doneCallback:a}):this.ambience.setIblMap({url:e.IBLMap+".hdr",mapping:new t.LatLongReflectionMapping,hdr:!0,doneCallback:a}),i||o||(n++,this.ambience.setRoughnessMap({url:e.IBLMap+"_rmips.hdr",doneCallback:a}))}}else null===e.IBLMap&&(null,i=null);if(e.envMap)if(e.envMap instanceof t.Texture)n++,this.ambience.setBackGroundMap({texture:e.envMap,doneCallback:a});else if(""!==e.envMap){(o="dds"===r.getExtension(e.envMap))?(n++,this.ambience.setBackGroundMap({url:e.envMap,hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:a})):(n++,this.ambience.setBackGroundMap({url:e.envMap+".hdr",hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:a}))}},setEnvMapBlur:function(e){console.warn("Warning: setEnvMapBlur is not handled")},setEnvMapOffset:function(e){},setEnvMapExposure:function(e){this.envMapExposure=e,this.ambience.setExposure(e),this.sphereEnv&&this.sphereEnv.material&&(this.sphereEnv.material.envMapExposure=e),this.internalSceneGraph.scene.envMipMap[0]&&(this.internalSceneGraph.scene.envMipMap[0].envMapExposureSpecular=e,this.internalSceneGraph.scene.envMipMap[0].envMapExposureDiffuse=e)},addReflectionProbe:function(e,i,r,n,s){this.removeReflectionProbes();var a=this,o=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping,s);o.onLoadCallbacks.push((function(){a.render()})),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping);l.onLoadCallbacks.push((function(){a.render()})),l.minFilter=t.NearestFilter,l.magFilter=t.NearestFilter,l.wrapS=t.RepeatWrapping,l.wrapT=t.RepeatWrapping;var h={position:i,box:new t.Box3(r,n)};p._decreaseSceneUseCount(this.internalSceneGraph.scene),this.internalSceneGraph.scene.envMipMap[0]=o,this.internalSceneGraph.scene.envMipMap[1]=l,this.internalSceneGraph.scene.reflectionProbes=h},removeReflectionProbes:function(){this.internalSceneGraph.scene.reflectionProbes&&(this.internalSceneGraph.scene.reflectionProbes=null,this.internalSceneGraph.scene.envMipMap[0].dispose(),this.internalSceneGraph.scene.envMipMap[1].dispose(),this.internalSceneGraph.scene.envMipMap=[],this.ambience&&this.ambience.needUpdateIBL.has(this)&&this.ambience.needUpdateIBL.delete(this))},setEnvMapAmbient:function(e){this.sphereEnv&&this.sphereEnv.material&&this.sphereEnv.material.ambient.copyToLinear(e,this.renderer.renderer.simpleGamma)},removeEnvMap:function(){var e=!1;return this.ambience.getBackground().isActivated()&&(e=!0,this.ambience.getBackground().setActivated(!1)),null!==this.sphereEnv&&(this.sphereEnv.visible=!1),e}},g={_updateShadowMaps:function(){this._shadowUpdated=!0;let e=this._getScenegraphs();for(let r=0;r<e.length;r++){var t=e[r].root3js;if(null!==t&&void 0!==typeof t)for(var i=0;i<t.parent.__lights.length;i++)t.parent.__lights[i].updateShadowMap=!0}},isShadowMap:function(){for(var e=(null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene).__lights,t=0;t<e.length;t++)if(!e[t].isVirtual&&(e[t].castShadow||e[t].castGroundShadow))return!0;return!1}},m={setSecondaryLightColor:function(e){var i;"number"==typeof e||"string"==typeof e?i=new t.Color(e):e&&(i=(new t.Color).copy(e)),i.copyToLinear(i,this.renderer.renderer.simpleGamma),null!==this._directionalLight2&&this._directionalLight2.setColor(i),this.render()},setAmbientLight:function(e){"number"==typeof e||"string"==typeof e?this.ambientLight.color=new t.Color(e):e&&(this.ambientLight.color=e)},setDirectionalLight:function(e,i,r,n){this.autoUpdateLights=!1,this.dirLightLatitude=e,this.dirLightLongitude=i;var s=this._directionalLight;if(this._updateDirectionalLightWorldOrientation(this._worldOrientation),this.useDefaultLights){let e=r;"number"!=typeof r&&"string"!=typeof r||(e=new t.Color(r)),s.setColor(e),s.setIntensity(n)}this.renderer.resetClippingScene(),this.render()},setLightParameters:function(e){var t=[this._directionalLight,this._directionalLight2,this._directionalLight3][e.lightIndex?e.lightIndex:0];return!!t&&(this.autoUpdateLights=!1,0==e.isPhysical?t.setPhysical(!1):t.setPhysical(!0),e.color&&t.setColor(e.color),void 0!==e.intensity&&t.setIntensity(e.intensity),e.direction&&t.setDirection(e.direction,this.renderer.renderer.baseLightDirection),e.directionType&&t.attachToViewpoint("camera"===e.directionType),this.renderer.resetClippingScene(),this.render(),!0)},setAutoUpdateLights:function(e){this.autoUpdateLights=e},setLightOnViewpoint:function(e){this._directionalLight&&this._directionalLight.attachToViewpoint(e)},_removeBackgroundLight:function(){},enableDefaultLights:function(e){this.useDefaultLights&&(e?(this.internalSceneGraph.addLightNode(this._directionalLight),this.internalSceneGraph.addLightNode(this._directionalLight2),this.triLights&&this.internalSceneGraph.addLightNode(this._directionalLight3)):(this.internalSceneGraph.removeLightNode(this._directionalLight),this.internalSceneGraph.removeLightNode(this._directionalLight2),this.triLights&&this.internalSceneGraph.removeLightNode(this._directionalLight3)))},setTriLights:function(e){if(this.useDefaultLights&&(this.enableDefaultLights(!0),e!==this.triLights)){this.triLights=e;var i=this._directionalLight,r=this._directionalLight2,n=this._directionalLight3;if(e){i&&(i.setIntensity(.49*Math.PI),i.setShadowOptions({darkness:.3}));let e=new t.Vector3(0,0,1);r&&(r.setIntensity(.49*Math.PI),r.setColor(new t.Color(16777215)),r.setDirection(e,this.renderer.renderer.baseLightDirection)),n||(this._directionalLight3=new s({color:16777215,intensity:.49*Math.PI},"defaultLight3"),n=this._directionalLight3,this.internalSceneGraph.addLightNode(n),this.internalSceneGraph&&this.internalSceneGraph.scene.add(n)),n.setDirection(e,this.renderer.renderer.baseLightDirection)}else i&&(i.setIntensity(.81*Math.PI),i.setShadowOptions({darkness:.65})),r&&(r.setIntensity(1*Math.PI),r.setColor(new t.Color(3827071)),r.setDirection(new t.Vector3(-2,1.5,2.5),this.renderer.renderer.baseLightDirection)),n&&(this.internalSceneGraph.removeLightNode(n),this._directionalLight3.dispose(),this._directionalLight3=null);this.infPlane&&this.infPlane.material&&(this.infPlane.material._firstDirOnly=e,this.infPlane.material.needsUpdate=!0)}},updateBackgroundLights:function(){for(var e=(null===this._safeInternalSceneGraph?this.temporaryEmptyScene:this._safeInternalSceneGraph.scene).__lights,t=[],i=-1,r=[],n=0;n<this.lights.length;n++){i=-1;for(var s=0;s<e.length;s++)if(this.lights[n].fgLight===e[s]){i=n;break}-1===i&&(this.sceneBackground.remove(this.lights[n].bgLight),r.push(n))}for(n=r.length-1;n>=0;n--)this.lights.splice(r[n],1);for(n=0;n<e.length;n++){var a=e[n];if(i=-1,!a.isVirtual){for(s=0;s<this.lights.length;s++)if(this.lights[s].fgLight===a){i=s;break}if(-1===i){var o=a.clone();o.castShadow=!1,this.sceneBackground.add(o),a._occurrence&&(o._occurrence=a._occurrence),t.push({fgLight:a,bgLight:o})}else{var l=this.lights[i].bgLight;a.clone(l),l.castShadow=!1}}}for(n=0;n<t.length;n++){var h=t[n];this.lights.push(h)}for(let e=0;e<this.lights.length;e++){let t=this.lights[e];t.fgLight._vptUp&&(t.bgLight._vptUp=t.fgLight._vptUp,t.bgLight._vptSight=t.fgLight._vptSight,t.bgLight._vptPosition=t.fgLight._vptPosition)}},getLightInfos:function(e){let i=(e&&e._internalSceneGraph?e._internalSceneGraph:this.internalSceneGraph).scene.__lights,r={totalCount:0,directionalLights:{totalCount:0,shadowing:0,hidden:0},spotLights:{totalCount:0,shadowing:0,hidden:0},pointLights:{totalCount:0,shadowing:0,hidden:0},rectangleLights:{totalCount:0,hidden:0},tubeLights:{totalCount:0,hidden:0},diskLights:{totalCount:0,hidden:0},sphereLights:{totalCount:0,hidden:0},iesLights:{totalCount:0,hidden:0},ambientLights:{totalCount:0,hidden:0},shadowing:0,hidden:0};for(let e=0;e<i.length;e++){let n=i[e],s=r.otherLights;n instanceof t.DirectionalLight||n instanceof t.DirectionalIBLLight||n instanceof t.DirectionalPhongLight?s=r.directionalLights:n instanceof t.SpotLight?s=r.spotLights:n instanceof t.PointLight?s=r.pointLights:n instanceof t.RectangleLight?s=r.rectangleLights:n instanceof t.TubeLight?s=r.tubeLights:n instanceof t.DiskLight?s=r.diskLights:n instanceof t.SphereLight?s=r.sphereLights:n instanceof t.IESLight?s=r.iesLights:n instanceof t.AmbientLight&&(s=r.ambientLights),r.totalCount++,s.totalCount++,n.isVirtual?(r.hidden++,s.hidden++):(0==n.intensity&&(r.hidden++,s.hidden++),(n.castShadow||n.castGroundShadow)&&(r.shadowing++,s.shadowing++))}return r}};let v={};return Object.assign(v,f),Object.assign(v,g),Object.assign(v,m),v})),define("DS/Visualization/Mixins/ViewerRenderModeMixins",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Materials/DeferredCaches"],(function(e,t,i,r,n){"use strict";const s=(new t.Color).setRGB(150/255,185/255,165/255),a=.5;var o={Shaded:["Shading","ShadingEdges","ShadingEdgesHiddenEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],Illustration:["ShadingIllustration"],IllustrationTransparent:["ShadingIllustrationTransparent"],Wireframe:["Wireframe"]},l={WithEdges:["ShadingEdges","ShadingIllustration","ShadingIllustrationTransparent","Wireframe","ShadingMaterialEdges"],NoEdges:["Shading","ShadingMaterial"],WithEdgesHiddenEdges:["ShadingEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges"],WithEdgesHalfSmoothEdges:["ShadingEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdges"],WithEdgesHalfSmoothEdgesHiddenEdges:["ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges"],WithEdgesNoSmoothEdges:["ShadingEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdges"],WithEdgesNoSmoothEdgesHiddenEdges:["ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"]},h={true:["ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],false:["Shading","ShadingEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingIllustration","ShadingIllustrationTransparent","Wireframe"]};const c={setDecalMode(e){this.renderer.renderer.renderDecalMode!==e&&(this.renderer.renderer.renderDecalMode=e,this.renderer.resetGSSOCache(),this.render())},getDecalMode(){return this.renderer.renderer.renderDecalMode}},d={displayFaces:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("Face",e),this.setRenderMode("AxisSystem",e),this.setRenderMode("InfiniteFace",e)},getDisplayFaces:function(){return!!(this.renderer.renderer.renderFaceMode&t.GeomTypeEnum.FACE)},setRenderFaceMode:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this._setInternalRenderFaceMode(e)}},u={displayLines:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("@Edge",e)},getDisplayLines:function(){return this.renderer.renderer.renderLineMode!==t.HideAllRenderLineMode},displayHiddenEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.renderHiddenEdges=e,this.render()},displayHalVisibleSmoothEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.halfVisibleSmoothEdges=e,this.render()},setRenderLineMode:function(e){switch(this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),e){case t.HideAllRenderLineMode:this.setRenderMode("@Edge",!1);break;case t.HideSmoothEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1),this.setRenderMode("_HighCurvatureEdge",!1);break;case t.HideWireEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("WireEdge",!1);break;case t.HideInternalEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1),this.setRenderMode("_HighCurvatureEdge",!1),this.setRenderMode("InternalSharpEdge",!1);break;case t.ShowAllRenderLineMode:this.setRenderMode("@Edge",!0);break;case t.SmoothEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSmoothEdge",!0),this.setRenderMode("_HighCurvatureEdge",!0);break;case t.SharpEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSharpEdge",!0);break;case t.WireEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("WireEdge",!0);break;case t.BoundaryEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("BoundaryEdge",!0)}}},p={displayPoints:function(e){this.renderer.resetGSSOCache(),e?(this.setRenderMode("@Point",!0),this.setRenderMode("SurfacicPoint",!1),i.defaultMask=i.defaultMask|t.GeomTypeEnum.UNKNOWN_0D):(this.setRenderMode("@Point",!1),i.defaultMask=i.defaultMask&~t.GeomTypeEnum.UNKNOWN_0D)},getDisplayPoints:function(){return this.renderer.renderer.renderPointMode>0},displaySurfacicPoints:function(e){this.renderer.resetGSSOCache(),this.setRenderMode("SurfacicPoint",e)}},f={setBoundaryEdgeColor:function(e){const t=this.renderer.renderer.boundaryEdgeMaterialInfo.color;t.copy(e),n.GeomTypeMaterials.forEach((e=>{e.material.color===t&&e.material._revision++})),this.render()},displayBoundaryEdgeColor:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.boundaryEdgeMaterialInfo.enabled=e,this.render()}},g={setMaterialMode:function(e){var t=this.renderer.renderer.materialMode!==e;this._renderStyle&&(this._renderStyle.setMaterialMode(e),this.internalSceneGraph.root.forceUpdate()),t&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.renderer.resetGSSOCache(),this.renderer.renderer.materialMode=!!e,this.render(),this._modelEvent.publish({event:"MaterialMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getMaterialMode:function(){return this.renderer.renderer.getMaterialMode()},onMaterialModeChange:function(e){return this._modelEvent.subscribe({event:"MaterialMode"},e)},setGasLookMode:function(e){this.setVisuAppearanceMode(e?t.DefaultAppearanceMode._GASLOOK_OLD:t.DefaultAppearanceMode.BASIC)},setVisuAppearanceMode:function(e){var i=this.renderer.renderer._defaultAppearanceType;if(this.renderer.renderer._defaultAppearanceType=e,i!==this.renderer.renderer._defaultAppearanceType){if(this.renderer.resetGSSOCache(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&i!==t.DefaultAppearanceMode.__QA_AUTOMATION__)switch(i){case t.DefaultAppearanceMode.GASLOOK:case t.DefaultAppearanceMode._GASLOOK_OLD:case t.DefaultAppearanceMode.GENERIC_PLASTIC:case t.DefaultAppearanceMode.GENERIC_METAL:case t.DefaultAppearanceMode._TRANSPARENT:t.cleanPredefinedMaterialCache();break;case t.DefaultAppearanceMode.CAST_ALUMINUM:case t.DefaultAppearanceMode.MACHINED_ALUMINUM:case t.DefaultAppearanceMode.CAST_STEEL:case t.DefaultAppearanceMode.BRUSHED_STEEL:case t.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL:case t.DefaultAppearanceMode.COPPER:case t.DefaultAppearanceMode.BRASS:t.cleanPredefinedMaterialTextureCache()}this.render(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._modelEvent.publish({event:"VisuAppearanceMode",data:{viewer:this,value:this.getVisuAppearanceMode()}})}},getVisuAppearanceMode:function(){for(var e=Object.keys(t.DefaultAppearanceMode),i=0;i<e.length;i++)if(t.DefaultAppearanceMode[e[i]]===this.renderer.renderer._defaultAppearanceType)return e[i];return""},onVisuAppearanceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuAppearanceMode"},e)},setCustomMaterialModeParameters:function(e){if(e&&this.renderer){var i=this.renderer.renderer._customMaterialModeParams,r=!1;if(void 0!==e.useColorFromGAS&&(e.useColorFromGAS!==i.colorFromGAS&&(t.cleanPredefinedMaterialCache(),r=!0),i.colorFromGAS=e.useColorFromGAS),void 0!==e.color){var n=new t.Color(e.color);r=r||i.color.getHex()!==n.getHex(),i.color.copy(n)}void 0!==e.shininess&&(r=r||i.shininess!==e.shininess,i.shininess=e.shininess),void 0!==e.opacity&&(r=r||i.opacity!==e.opacity,i.opacity=e.opacity),r&&(this.renderer.resetGSSOCache(),this.render(),this._modelEvent.publish({event:"CustomMaterialModeParameters",data:{viewer:this,value:i}}))}},getCustomMaterialModeParameters:function(){return this.renderer?this.renderer.renderer._customMaterialModeParams:null},onCustomMaterialModeParametersChange:function(e){return this._modelEvent.subscribe({event:"CustomMaterialModeParameters"},e)},_setDebugMaterial:function(e){this.renderer.renderer._debugMaterialMode!==e&&(this.renderer.renderer._debugMaterialMode=e,this.renderer.recompileAllShaders(null),this.renderer.resetGSSOCache(),this.render())}},m={setForcePickingFaces:function(e){this._pickingMode._setPickingMode(i.facesMask,e?1:2),this._setPickingMode()},setForcePickingLines:function(e){this._pickingMode._setPickingMode(i.linesPickingMask,e?1:2),this._setPickingMode()},setForcePickingPoints:function(e){this._pickingMode._setPickingMode(i.pointsMask,e?1:2),this._setPickingMode()}},v={setFacePickingMode:function(e){this._pickingMode._setPickingMode(i.facesMask,e),this._setPickingMode()},setLinePickingMode:function(e){this._pickingMode._setPickingMode(i.linesPickingMask,e),this._setPickingMode()},setPointPickingMode:function(e){this._pickingMode._setPickingMode(i.pointsMask,e),this._setPickingMode()},setPickingMode:function(e,t){this._pickingMode.setPickingMode(e,t),this._setPickingMode()},_setPickingMode:function(){this.renderer.renderer.pickingModeLSB=this._pickingMode.pickingModeLSB,this.renderer.renderer.pickingModeMSB=this._pickingMode.pickingModeMSB,this.invalidatePickingBuffer(!1),this.renderer.resetGSSOCache()},getPickingMode:function(){return this._pickingMode.clone()},setFromPickingMode:function(e){this._pickingMode=e.clone(),this._setPickingMode()}},_={getRenderMode:function(){return this.renderer.renderer.getRenderMode().clone()},_initRenderStyle:function(){if(!this._renderStyle){var e=new r;e.setFaceMode("COLOR"),e.setMaterialMode(!!this.renderer.renderer.materialMode),e._renderMode._setMask(this.renderer.renderer.renderPointMode|this.renderer.renderer.renderFaceMode|this.renderer.renderer.renderLineMode),e._renderMode._outlineWidth=this.renderer.renderer.outlineWidth,this.setRenderStyle(e)}},_setRenderMode:function(e,t){this.renderer.resetGSSOCache();var r=new i;r._setFromMasks(this.renderer.renderer.renderPointMode,this._getInternalRenderLineMode(),this._getInternalRenderFaceMode()),r.setRenderMode(e,t),this.renderer.renderer.renderPointMode=r.getMask()&i.pointsMask,this._setInternalRenderFaceMode(r.getMask()&i.facesMask),this._setInternalRenderLineMode(r.getMask()&i.linesMask)},setRenderMode:function(e,t){if(this._renderStyle)return this._renderStyle.setRenderMode(e,t),void this.setRenderStyle(this._renderStyle);this._setRenderMode(e,t),this.applyRenderModeLock()},setRenderStyle:function(e){this.renderer.resetGSSOCache(),this._renderStyle=e.clone(),this.setMaterialMode(e._materialMode);var t=this._renderStyle._renderMode;this.renderer.renderer.renderPointMode=t.getMask()&i.pointsMask,this.renderer.renderer.outlineWidth=t._outlineWidth,this._setInternalRenderFaceMode(t.getMask()&i.facesMask),this._setInternalRenderLineMode(t.getMask()&i.linesMask),this.applyRenderModeLock(),this.internalSceneGraph.root.forceUpdate()}},y={getPlanesFilter:function(){return!!this.planesFilterStatus},onPlanesFilterChange:function(e){return this._modelEvent.subscribe({event:"RefPlaneFilterMode"},e)},getVerticesFilter:function(){return!!this.verticesFilterStatus},_setVerticesFilter:function(e){e=!!e,this.addRenderModeLock("BoundaryPoint",e),this.addRenderModeLock("SharpPoint",e),this.addRenderModeLock("SmoothPoint",e)},setVerticesFilter:function(e){this.verticesFilterStatus!==e&&(this.verticesFilterStatus=e,!1!==this.linesFilterStatus&&this._setVerticesFilter(e),this.render(),this._modelEvent.publish({event:"VerticesFilterMode",data:{viewer:this,state:this.verticesFilterStatus}}))},onVerticesFilterChange:function(e){return this._modelEvent.subscribe({event:"VerticesFilterMode"},e)},getAxisFilter:function(){return!!this.axisFilterStatus},setAxisFilter:function(e){var i=this.axisFilterStatus!==e;if(t.__NoShowForAxisAndPlanesBags()){var r=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(r){var n=r.getChildrenByName("AxisSystems");n&&n.length>0&&n.forEach((function(t){t.setVisibility(e),t.setVisibilityFree(!e)}));var s=r.getChildrenByName("RefPlanes");s&&s.length>0&&s.forEach((function(t){t.setVisibility(e),t.setVisibilityFree(!e)}))}}i&&(this.axisFilterStatus=e,this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}}),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},onAxisFilterChange:function(e){return this._modelEvent.subscribe({event:"AxisFilterMode"},e)},setSmallCurvatureEdgesFilter:function(e){this.smallCurvatureEdgesFilterStatus!==e&&(this.smallCurvatureEdgesFilterStatus=e,this._modelEvent.publish({event:"SmallCurvatureEdgesFilterMode",data:{viewer:this,state:this.smallCurvatureEdgesFilterStatus}}),e?this.removeRenderModeLock("InternalSmoothEdge"):this.addRenderModeLock("InternalSmoothEdge",!1)),this.render()},onSmallCurvatureEdgesFilterChange:function(e){return this._modelEvent.subscribe({event:"SmallCurvatureEdgesFilterMode"},e)},getSmallCurvatureEdgesFilter:function(){return!!this.renderer.renderer.smallCurvatureEdges},getLinesFilter:function(){return!!this.linesFilterStatus},setLinesFilter:function(e){this.linesFilterStatus!==e&&(this.linesFilterStatus=e,this.addRenderModeLock("WireEdge",e),this._setVerticesFilter(!!e&&(null===this.verticesFilterStatus||this.verticesFilterStatus)),this.render(),this._modelEvent.publish({event:"LinesFilterMode",data:{viewer:this,state:this.linesFilterStatus}}))},onLinesFilterChange:function(e){return this._modelEvent.subscribe({event:"LinesFilterMode"},e)},getPointsFilter:function(){return!!this.pointsFilterStatus},setPointsFilter:function(e){this.pointsFilterStatus!==e&&(this.pointsFilterStatus=e,this.addRenderModeLock("FreePoint",e),this.render(),this._modelEvent.publish({event:"PointsFilterMode",data:{viewer:this,state:this.pointsFilterStatus}}))},onPointsFilterChange:function(e){return this._modelEvent.subscribe({event:"PointsFilterMode"},e)}},S={_solveVisuShadingPreset:function(){if(null===this.visuShadingMode.preset&&null!==this.visuShadingMode.face&&null!==this.visuShadingMode.edge){for(var e=this.getMaterialMode().toString(),t=h[e]||[],i=this.visuShadingMode.face,r=o[i]||[],n=this.visuShadingMode.edge,s=l[n]||[],a=0;a<t.length;a++)for(var c=t[a],d=0;d<r.length;d++){var u=r[d];if(u===c)for(var p=0;p<s.length;p++){var f=s[p];if(f===u)return this.visuShadingMode.preset=f,void this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:f}})}}this.visuShadingMode.preset="Unknown",this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:"Unknown"}})}}},b={setVisuShadingMode:function(t){if(t&&(this._initRenderStyle(),this.visuShadingMode.preset!==t)){switch(this.visuShadingMode.preset=null,t){case"NoShadingEdges":case"Wireframe":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Wireframe"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Shading":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingIllustration":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Illustration"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingIllustrationTransparent":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("IllustrationTransparent"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterial":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Unknown":break;default:throw"Unknown mode in setVisuShadingMode"}this.visuShadingMode.preset=t,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:t}}),e.publish({event:"/VISU/onViewModeChanged",data:{eventChannel:"/VISU/onViewModeChanged",eventType:"@onViewModeChanged",viewer:this}}),this.setRenderStyle(this._renderStyle),this.render()}},getVisuShadingMode:function(){return this.visuShadingMode.preset},onVisuShadingModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingMode"},e)}},x={setBackgroundViewMode(e){this._backgroundViewMode!==e&&(this._backgroundViewMode=e,this.renderer.renderer._backgroundViewMode=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},getBackgroundViewMode(){return this._backgroundViewMode},invertNodeBackgroundView(e){this._invertBackgroundNodes!==e&&(this._invertBackgroundNodes=e,this.renderer.renderer._invertBackgroundNodes=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},isNodeBackgroundViewInverted(){return this._invertBackgroundNodes},pickNodeBackgroundView(e){this._pickBackgroundNodes!==e&&(this._pickBackgroundNodes=e,this.renderer.renderer._pickBackgroundNodes=e,this.renderer.resetGSSOCache())},isNodeBackgroundViewPickable(){return this._pickBackgroundNodes}},w={getColorFromColorMap:function(e){if(!t._getColorMap)return null;var i=t._getColorMap(this.renderer.renderer)[e];return i?(new t.Color).setRGB(i.r,i.g,i.b):null},onColorMapUpdated:function(e){return this._modelEvent.subscribe({event:"ColorMapUpdated"},e)},onSwapVisibleSpace:function(e){return this._modelEvent.subscribe({event:"SwapVisibleSpace"},e)},swapVisibleSpace:function(){this.visibleSpace=(this.visibleSpace+1)%2,this.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.visibleSpace=this.visibleSpace;var e,i,r=new t.Color(this.showBgColor);if(this.ambience.setBackgroundAlpha(this.showBgAlpha),this.visibleSpace||r.desaturate(1).alphaBlend(s,a),this.ambience.setBackgroundColor(r.getHex()),this._setBackgroundColor(),this._svgMode&&this.svgRootNode)for(i="#"+s.getHexString(),this.svgRootNode.style.backgroundColor=this.visibleSpace?"#ffffff":i,e=0;e<this.internalSceneGraph.svgRoot.children.length;e++)this.internalSceneGraph.svgRoot.children[e]._updateSVGVisibility();if(this.ambience.getBackground().hasGradient()){var n=this.ambience.getBackground().getColors(),o=[];for(e=0;e<n.length;e++)this.visibleSpace?o.push(new t.Color(this.showGradientBackground[e].getHex())):o.push(n[e].desaturate(1).alphaBlend(s,a));this.ambience.getBackground().setColors(o)}this._displayGrid&&(this.visibleSpace?this.gridColor.copy(this.showGridColor):this.gridColor.desaturate(1).alphaBlend(s,a)),this._infinitePlane&&(this.visibleSpace?this.planeColor.copy(this.showPlaneColor):this.planeColor.desaturate(1).alphaBlend(s,a)),this.getRobot()&&this.getRobot().isTargetGone(this.visibleSpace)&&this.getRobot().setConnectionState(!1),this._updateShadowMaps(),this.render({updateInfinitePlane:!0}),this._modelEvent.publish({event:"SwapVisibleSpace",data:{viewer:this,visibleSpace:this.visibleSpace}})},getVisibleSpace:function(){return this.visibleSpace},setPlaneViewMode(e){let t,i;e&&(t=e.mode,i=e.plane),this.getRootNode().setPvmFilter({mode:t,plane:i})}};return Object.assign(w,d),Object.assign(w,u),Object.assign(w,p),Object.assign(w,f),Object.assign(w,g),Object.assign(w,m),Object.assign(w,v),Object.assign(w,_),Object.assign(w,{addRenderModeLock:function(e,t){this._initRenderStyle(),this.lockedRenderMode.set(e,t),this.setRenderStyle(this._renderStyle)},removeRenderModeLock:function(e){this._initRenderStyle(),this.lockedRenderMode.has(e)&&(this.lockedRenderMode.delete(e),this.setRenderStyle(this._renderStyle))},clearRenderModeLock:function(){this._initRenderStyle(),this.lockedRenderMode.clear(),this.setRenderStyle(this._renderStyle)},applyRenderModeLock:function(){var e=this;this.lockedRenderMode.forEach((function(t,i,r){e._setRenderMode(i,t)}))}}),Object.assign(w,y),Object.assign(w,S),Object.assign(w,b),Object.assign(w,{_setVisuShadingFaceMode:function(e){if(e){switch(this._initRenderStyle(),e){case"Shaded":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode(this.visuShadingMode.edge),this._setVisuShadingPointMode(this.visuShadingMode.point);break;case"Illustration":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",!0),this._renderStyle.setFaceMode("BACKGROUND"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("NoPoints");break;case"IllustrationTransparent":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",!0),this._renderStyle.setFaceMode("ZONLY"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("NoPoints");break;case"Wireframe":this._renderStyle.setRenderMode("Face",!1),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("WithPoints");break;default:throw"Unknown mode in setVisuShadingFaceMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingFaceMode:function(e){e&&e!==this.visuShadingMode.face&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.face=e,this._setVisuShadingFaceMode(e),this._modelEvent.publish({event:"VisuShadingFaceMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingFaceMode:function(){return this.visuShadingMode.face},onVisuShadingFaceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingFaceMode"},e)}}),Object.assign(w,{_setVisuShadingEdgeMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!0);break;case"WithEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!0);break;case"NoEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!1),this._renderStyle.setRenderMode("Edge",!1),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this._renderStyle.setRenderMode("BoundaryEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"NoEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!1),this._renderStyle.setRenderMode("Edge",!1),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this._renderStyle.setRenderMode("BoundaryEdge",!1),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesNoSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;default:throw"Unknown mode in setVisuShadingEdgeMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingEdgeMode:function(e){e&&e!==this.visuShadingMode.edge&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.edge=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&"IllustrationTransparent"!==this.visuShadingMode.face&&this._setVisuShadingEdgeMode(e),this._modelEvent.publish({event:"VisuShadingEdgeMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingEdgeMode:function(){return this.visuShadingMode.edge},onVisuShadingEdgeModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingEdgeMode"},e)}}),Object.assign(w,{_setVisuShadingPointMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithPoints":this._renderStyle.setRenderMode("BoundaryPoint",!0),this._renderStyle.setRenderMode("SharpPoint",!0),this._renderStyle.setRenderMode("SmoothPoint",!0),this._renderStyle.setRenderMode("SurfacicPoint",!0);break;case"NoPoints":this._renderStyle.setRenderMode("BoundaryPoint",!1),this._renderStyle.setRenderMode("SharpPoint",!1),this._renderStyle.setRenderMode("SmoothPoint",!1),this._renderStyle.setRenderMode("SurfacicPoint",!1);break;default:throw"Unknown mode in setVisuShadingPointMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingPointMode:function(e){e&&e!==this.visuShadingMode.point&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.point=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&"IllustrationTransparent"!==this.visuShadingMode.face&&this._setVisuShadingPointMode(e),this._modelEvent.publish({event:"VisuShadingPointMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingPointMode:function(){return this.visuShadingMode.point},onVisuShadingPointModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingPointMode"},e)}}),Object.assign(w,{_setVisuOutlineMode:function(e){if(this._initRenderStyle(),this.visuShadingMode.outline!==e){if(this.visuShadingMode.outline=e,this._modelEvent.publish({event:"VisuOutlineMode",data:{viewer:this,value:e}}),"Illustration"===this.visuShadingMode.face||"IllustrationTransparent"===this.visuShadingMode.face)return;this._renderStyle.setRenderMode("Outline",e),this.setRenderStyle(this._renderStyle),this.render()}},_getVisuOutlineMode:function(){return this.visuShadingMode.outline},_onVisuOutlineModeChange:function(e){return this._modelEvent.subscribe({event:"VisuOutlineMode"},e)}}),Object.assign(w,x),Object.assign(w,c),{Mixins:w,NoShowData:{noShowAlpha:.5,noShowBlendingRatio:a,noShowColor:s,noShowSaturationRatio:1}}})),define("DS/Visualization/Mixins/ViewerSelectionAndPickingMixins",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/Visualization/SubElement","DS/Visualization/Viewpoint","DS/Visualization/TrapSelection","DS/Manipulators/TrapSelectionManipulator","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/Intersection/VolumeIntersection","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/VisuEvents/EventsManager"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m){"use strict";const v="true"===localStorage.getItem("WebVisuForceHaloHL"),_=t.__visibleInCurrentSpace,y=function(e,t,i){return i.getPickParent()||e&&i._getPickParentWithPrimitives()&&0===t.internalPath.length},S={setDefaultPicking:function(i){this._defaultPicking=!!i;const n=t._AllowPickParentWithPrimitives;if(i){var l=g;this.centerMouseDownCB=function(e,t){},this.mouseMoveCB=function(t,i){let o=this.pPicking.disableWhileMoving&&this.currentViewpoint&&this.currentViewpoint.isMoving();if(o&&(l.empty(),this.lastAddedToPSO=null),t.event&&"dragover"==t.event.type&&!this._supportDragPrehighlight)return;var h=t.view;if(m.RecordEventsManager&&!h)return;var c,d,u,p,f=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(h!==f&&!h.renderable){for(;h!==f&&h.parentElement&&!h.renderable;)h=h.parentElement;if(!h.renderable)return void(this.lastAddedToPSO&&!this.lastAddedToPSO.ownedByUser?(l.remove(this.lastAddedToPSO),this.lastAddedToPSO=null):this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,pickingResult:null,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}}))}if(!i||i.isMiddleButtonPressed())return;c=this.getMousePosition(t.getCurrentPosition(this.canvas));let g=this.manipulatorManager&&this.manipulatorManager.isInManipulation(!0,!0);if(this.pPicking.activated&&!g&&!o){if(p="mesh",p=this.pPicking.gpu?2===this.pPicking.primitive?"repHybrid":this.pPicking.primitive?"primHybrid":"mesh":2===this.pPicking.primitive?"repCPU":this.pPicking.primitive?"primCPU":"mesh",d=this.pick(c,p,this.pPicking.computeNormalDepth),u=!1,l.isEmpty()&&!d.path.length||(u=!0),this._fillXSOMode)if(d.path.length){if(this.pPicking.displayHL){var v=null;if(d.path[0]&&(v=d.path[0].getLastElement(!0)),v instanceof r&&!v._getExcludeFromPreHL()&&!v._getExcludeFromPSO()){for(var _,S=d.path[0],b=null;S&&y(n,S,S.getLastElement(!0));)b=S,S=S.getParentPath();if(S||(S=b),!this.multiViewerFix&&!window.userRootOutOfPathElements)if((_=S)&&_.externalPath.length>1){var x=_.externalPath.concat([]);x.shift(),S=new s,void 0!==_.instanceId&&(S.instanceId=_.instanceId),S.setFromArray(x,_.internalPath)}var w={pathElement:S,event:t};if(!l.isIn(w)||l.get().length>1){var P=l.get().slice();l.remove(P),l.add(w)}this.lastAddedToPSO=w}}}else l.isEmpty()||(this.lastAddedToPSO=null,l.empty());var C=null;this.manipulatorManager&&(C=this.manipulatorManager.hoveredManipulator||this.manipulatorManager._getManipulatedManipulator()),this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,manipulator:C,pickingResult:d,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}})}u&&this.render({onlyPostProcess:!0});var M,E="@pickNothing";if(d&&d.path.length){var T=d.path[0].getLastElement();T instanceof a?"primitive"===T.getType()?E="@pickPrimitive":"rep"===T.getType()&&(E="@pickRep"):null!==T&&(E="@pickMesh")}M="@pickNothing"===E?{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:E,event:t}:{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:E,event:t,from:d.path[0],point:d.position,normal:d.normal,tangent:d.tangent,uv:d.uv,ray:d.ray},e.publish({event:"/VISU/",data:M}),this.debugEvents>=6&&console.log(M)},this.centerMouseUpCB=function(i,r){if(r&&r.isMiddleClick()){var n,s;if(n=this.getMousePosition(i.getCurrentPosition(this.canvas)),!r.lockPan&&!r.lockReframeOnDblTap&&null!==this.currentViewpoint)if(null!==(s=this.pick(n,"mesh",!0)).position){if(s.viewpoint.isMain())if(s.path.length)s.viewpoint.centerCamera(s.position);else{let e=s.viewpoint.control.distanceToTarget,i=s.ray.direction.clone().normalize(),r=null;s.viewpoint.projectionType===o.PERSPECTIVE?(i.setLength(e),r=(new t.Vector3).addVectors(s.viewpoint.control.position,i)):(i.setLength(e-s.viewpoint.camera.near),r=(new t.Vector3).addVectors(s.ray.origin,i));let n="zup"===this._worldOrientation._woName?new t.Vector3(0,0,1):new t.Vector3(0,1,0),a=this._viewpointManager.getViewpointScenegraph(s.viewpoint).getSavedSceneMin(),l=null;if(null!==a){l=new t.Plane(n,-a);let i=s.ray.distanceToPlane(l);void 0!==i&&i>0&&i<e&&s.ray.at(i,r)}s.viewpoint.centerCamera(r)}}else r._2DMode&&this.currentViewpoint.centerCameraSVG(new t.Vector2(.5*this.div.clientWidth,.5*this.div.clientHeight),new t.Vector2(n.xPix,n.yPix));var a={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@middleClick",event:i};e.publish({event:"/VISU/",data:a}),this.debugEvents>=6&&console.log(a)}},this.leftMouseDownCB=function(t,i){var r=t.view;if(!m.RecordEventsManager||r){var n=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,s=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(r===n&&(r=s),r!==s&&!r.renderable){for(;r!==s&&r.parentElement&&!r.renderable;)r=r.parentElement;if(!r.renderable)return}if(i&&!i.isMiddleButtonPressed()&&i.isLeftClick()){if(this.picking.trapSelection&&this.trapSelection){var a=this.getMousePosition(t.getCurrentPosition(this.canvas)),o=this.pick(a,"mesh",!1);if(o&&o.path&&o.path.length)for(var l=o.path[0].externalPath,h=0;h<l.length;h++)if(l[h].getIsManipulator()){this.trapSelection.interrupt();break}}var c={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@leftClickDown",event:t};e.publish({event:"/VISU/",data:c}),this.debugEvents>=6&&console.log(c)}}},this.leftMouseUpCB=function(t,i){this._doPickingFromMouseEvent(t,i,null);var r={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@leftClickUp",event:t};e.publish({event:"/VISU/",data:r})},this._doPickingFromMouseEvent=function(t,i,r){if(this._defaultPicking){var n,o=r||this.trapSelection,l=t.view;if(!m.RecordEventsManager||l){var h=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,c=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;l===h&&(l=c);var d=!1;if(this.picking.trapSelection&&o&&(d=void 0!==(n=o.getExtremities()).pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix)),!d&&l!==c&&!l.renderable){for(;l!==c&&l.parentElement&&!l.renderable;)l=l.parentElement;if(!l.renderable)return void null}if(i&&!i.isMiddleButtonPressed()){if(this.picking.activated){var u,p;null,null,null,null,d||(n=this.getMousePosition(t.getCurrentPosition(this.canvas)));var g=o&&o.isActive,v=this.magnifier&&this.magnifier.active&&"Touch"===t.getType(),_=t.contextButton?i.isRightClick():i.isLeftClick();if(!g&&(!v||window.magnifierCheckDistance&&!this.magnifier.displayed)&&!_)return;if(window.magnifierCheckDistance&&v&&this.magnifier.displayed){if(this.magnifier.displayed=!1,!this.magnifier.enableSelection)return;this.magnifier.enableSelection=!1}if(!r&&this.manipulatorManager&&this.manipulatorManager.isInManipulation())return;l!==c&&(n.event=t),p="mesh",p=d&&this.picking.trapSelection?this.picking.trapGPU?2===this.picking.trapPrimitive?"repHybrid":this.picking.trapPrimitive?"primHybrid":"mesh":2===this.picking.trapPrimitive?"repCPU":this.picking.trapPrimitive?"primCPU":"meshCPU":this.picking.gpu?2===this.picking.primitive?"repHybrid":this.picking.primitive?"primHybrid":"mesh":2===this.picking.primitive?"repCPU":this.picking.primitive?"primCPU":o&&n.pt?"meshCPU":"mesh",u=this.pick(n,p,this.picking.computeNormalDepth,void 0,r);var y,S,b=i.isShiftKeyPressed(),x=i.isCtrlKeyPressed()||this.forceMultiSel,w=(d=void 0!==n.pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix),0);if(!this.multiViewerFix&&!window.userRootOutOfPathElements)for(w=0;w<u.path.length;w++)if((y=u.path[w])&&y.externalPath.length>1){var P=y.externalPath.concat([]);P.shift(),u.path[w]=new s,u.path[w].setFromArray(P,y.internalPath),void 0!==y.instanceId&&(u.path[w].instanceId=y.instanceId)}if(this._fillXSOMode&&(S=this.addToCSOHSO(u,{event:t,multiSel:x,additiveMode:b,trapSel:d})),null!==this.internalSceneGraph){if(this._fillXSOMode){var C="@pickNothing";if(u.path.length){var M=u.path[0].getLastElement();M instanceof a?"primitive"===M.getType()?C="@pickPrimitive":"rep"===M.getType()&&(C="@pickRep"):null!==M&&(C="@pickMesh")}var E={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:C,event:t,from:u.path[0],addedToCSO:S.addedToCSO,removedFromCSO:S.removedFromCSO,point:u.position,normal:u.normal,tangent:u.tangent,uv:u.uv,ray:u.ray,trapSelection:d};e.publish({event:"/VISU/",data:E}),this.debugEvents>=6&&console.log(E)}var T=null;this.manipulatorManager&&(T=this.manipulatorManager.hoveredManipulator||this.manipulatorManager._getManipulatedManipulator()),this._modelEvent.publish({event:"Activate",data:{viewer:this,event:t,manipulator:T,pickingResult:u,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed(),trapSelection:d,contextButton:!!t.contextButton}})}this.render({onlyPostProcess:!0})}else{var A;(A=f).isEmpty()||(A.empty(),this.render({onlyPostProcess:!0}))}null}else null}}},this.rightMouseUpCB=function(t,i){if(t.view===this.canvas&&i&&!i.isMiddleButtonPressed()&&!i.isLeftButtonPressed()&&i.isRightClick()){this.picking.contextPick&&(t.contextButton=!0,this.leftMouseUpCB(t,i));var r={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@rightClick",event:t};e.publish({event:"/VISU/",data:r}),this._modelEvent.publish({event:"Context",data:{viewer:this,event:t,ctrl:i.isCtrlKeyPressed()}}),this.debugEvents>=6&&console.log(r)}}}else this.centerMouseDownCB=null,this.mouseMoveCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=function(e,t){var i=e.view;if(!m.RecordEventsManager||i){var r=e.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,n=e.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(i===r&&(i=n),i!==n&&!i.renderable){for(;i!==n&&i.parentElement&&!i.renderable;)i=i.parentElement;if(!i.renderable)return}if(t&&!t.isMiddleButtonPressed()&&(this.trapSelection&&(!this.trapSelection||this.trapSelection.isActive)||t.isLeftClick())&&(!this.manipulatorManager||!this.manipulatorManager.isInManipulation())){var s=null;this.manipulatorManager&&(s=this.manipulatorManager.hoveredManipulator||this.manipulatorManager._getManipulatedManipulator()),this._modelEvent.publish({event:"Activate",data:{viewer:this,event:e,manipulator:s,ctrl:t.isCtrlKeyPressed(),shift:t.isShiftKeyPressed()}})}}},this.rightMouseUpCB=null},getDefaultPicking:function(){return this._defaultPicking},invalidatePickingBuffer:function(e){if(this.renderer.pickingGPUComposerContext&&(this.renderer.pickingGPUComposerContext.needsUpdate=!0,this.renderer.meshesGPU={},e||this.renderer.resetGSSOCache()),this.renderer.normalComposerContext&&(this.renderer.normalComposerContext.needsUpdate=!0,this.renderer.normalsGPU={}),this.renderer.depthComposerContext&&(this.renderer.depthComposerContext.needsUpdate=!0,this.renderer.positionsGPU={}),this.gpuPositionComposerContext){for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].needsUpdate=!0;this.positionsFloatGPU={},this.heuristicNormalsGPU={}}},setPickingPriority:function(e){this.pickingPriorityMapping=e,this.renderer.resetGSSOCache()},pick:function(e,i,r,n,o,l){null!==this._pageObjectData&&(void 0!==e.x&&void 0!==e.y||(e=this.getMousePosition(new t.Vector2(e.xPix,e.yPix))));var h,c,d,u={ray:null},p=n||this.pickingPriorityMapping,f=!1;this.infPlaneSmall&&p&&(f=this.infPlaneSmall.visible,this.infPlaneSmall.visible=!1),c={path:[],position:null,normal:null,tangent:null,uv:null,viewpoint:null,positions:[],normals:[],tangents:[],uvs:[],viewpoints:[],ray:null},this.renderer.overrideUpdate(this.internalSceneGraph,this.getCurrentSceneGraphState());var g=!1;switch(i){case"mesh":for(h=this.computeIntersection(e,!0,!1,r,u,p,o,l),d=0;d<h.length;++d)h[d].object?(h[d].path=new s,h[d].path.setFromOccurrence(h[d].object._occurrence)):h[d].path=null;break;case"meshCPU":for(h=this.computeIntersection(e,!1,!1,r,u,p,o,l),g=!0,d=0;d<h.length;++d)h[d].object?(h[d].path=new s,h[d].path.setFromOccurrence(h[d].object._occurrence)):h[d].path=null;break;case"primHybrid":for(h=this.computeIntersection(e,!0,!0,r,u,p,o,l),d=0;d<h.length;++d){var m=h[d].object?h[d].object._occurrence:null;if(h[d].primitive&&m){var v=!0===h[d].primitive?null:a.getFromSGNode(h[d].primitive);h[d].path=new s,h[d].path.setFromOccurrence(m,v,void 0,!0)}else h[d].object&&h[d].object._instancingInfos&&h[d].object._instancingInfos.isInstanceNode3D||m&&m.node&&!m.node.getPrimitivePicking()?(h[d].path=new s,h[d].path.setFromOccurrence(m)):h[d].path=null}break;case"prim":case"primCPU":for(h=this.computeIntersection(e,!1,!0,r,u,p,o,l),g=!0,d=0;d<h.length;++d)if(h[d].primitive&&h[d].object._occurrence){v=!0===h[d].primitive?null:a.getFromSGNode(h[d].primitive);h[d].path=new s,h[d].path.setFromOccurrence(h[d].object._occurrence,v,void 0,!0)}else h[d].path=null;break;case"rep":case"repCPU":for(h=this.computeIntersection(e,!1,!0,r,u,p,o,l),g=!0,d=0;d<h.length;++d)if(h[d].primitive&&h[d].object._occurrence){v=!0===h[d].primitive?null:a.getFromSGNode(h[d].primitive.getRep());h[d].path=new s,h[d].path.setFromOccurrence(h[d].object._occurrence,v,void 0,!0)}else h[d].path=null;break;case"repHybrid":for(h=this.computeIntersection(e,!0,!0,!1,u,p,o,l),d=0;d<h.length;++d)if(h[d].primitive&&h[d].object._occurrence){v=!0===h[d].primitive?null:a.getFromSGNode(h[d].primitive.getRep());h[d].path=new s,h[d].path.setFromOccurrence(h[d].object._occurrence,v,void 0,!0)}else h[d].object&&h[d].object._instancingInfos&&h[d].object._instancingInfos.isInstanceNode3D?(h[d].path=new s,h[d].path.setFromOccurrence(h[d].object._occurrence)):h[d].path=null}c.ray=u.ray;var _=!1;for(d=0;d<h.length;++d)if(null!==h[d].path)void 0!==h[d].instanceId&&(h[d].path.instanceId=h[d].instanceId),c.path.push(h[d].path),_||(_=!0,c.position=h[d].point,c.normal=h[d].normal,c.tangent=h[d].tangent,c.uv=h[d].uv,c.viewpoint=h[d].viewpoint),c.positions.push(h[d].point?h[d].point:null),c.normals.push(h[d].normal?h[d].normal:null),c.tangents.push(h[d].tangent?h[d].tangent:null),c.uvs.push(h[d].uv?h[d].uv:null),c.viewpoints.push(h[d].viewpoint?h[d].viewpoint:null);else if(!g)break;if(!_)if(h.length&&3==r)c.position=h[0].point,c.normal=h[0].normal,c.viewpoint=h[0].viewpoint;else if((this._displayGrid||this._infinitePlane)&&c.ray&&c.ray.direction.z<0){c.normal=new t.Vector3(0,0,1);var y=new t.Plane(c.normal,this.offsetPlaneSmall.z);c.position=c.ray.intersectPlane(y),c.viewpoint=this.currentViewpoint}else h.length&&(c.position=h[0].point,c.normal=h[0].normal,c.viewpoint=h[0].viewpoint);return this.infPlaneSmall&&p&&(this.infPlaneSmall.visible=f),c},pickInVolume:function(e,i,r){if(this.renderer._needPerformanceSuite())return{inside:[],outside:[],partial:[]};if(!e||!i)return{inside:[],partial:[],outside:[]};var n=this.internalSceneGraph.scene,a=[];if(r)a=a.concat(r._getRenderableOccurrences(this,!1));else if(n instanceof t.Mesh)a=[n];else{for(var o=this._getUserPassManager()._getActiveRenderLists(),l=[],h=0;h<o.length;h++)l=l.concat(n.getWebGLObjects(o[h]));for(h=0;h<l.length;h++)null!==l[h]&&a.push(l[h].object)}var[c,d,p]=this.getRenderMode().getMasks(),f=new t.Sphere;if(e instanceof t.Box3){var g=e.getPoints(i),m=[[0,2,1],[4,0,5],[6,4,7],[2,6,3],[5,1,7],[4,6,0]],v=[],y=new t.Vector3,S=new t.Vector3;for(h=0;h<m.length;h++){var b=m[h];y.copy(g[b[1]]).sub(g[b[0]]),S.copy(g[b[2]]).sub(g[b[0]]),y.cross(S).normalize(),v.push((new t.Plane).setFromNormalAndCoplanarPoint(y,g[b[0]]))}f=new t.Frustum(v[0],v[1],v[2],v[3],v[4],v[5])}else{if(!(e instanceof t.Sphere))return{inside:[],partial:[],outside:[]};(f=e.clone()).applyMatrix4(i)}var x=[{path:[]},{path:[]},{path:[]}],w=[],P=[],C=[],M=[w,P,C];for(h=0;h<a.length;h++){var E=a[h];_(E.visible,E.visibilityFree,this.visibleSpace,E.layer,E._occurrence)&&!1!==E.noPickThrough&&((void 0===E.pickable||E.pickable)&&u._meshIntersectVolume(E,f,c,p,d,w,P,C,this.visibleSpace))}for(var T=0;T<M.length;T++){var A=M[T];for(h=0;h<A.length;++h)A[h].object?(A[h].path=new s,A[h].path.setFromOccurrence(A[h].object._occurrence)):A[h].path=null}for(T=0;T<M.length;T++)for(A=M[T],h=0;h<A.length;++h)null!==A[h].path&&(void 0!==A[h].instanceId&&(A[h].path.instanceId=A[h].instanceId),x[T].path.push(A[h].path));return{inside:x[0],outside:x[1],partial:x[2]}},_enablePickParentWithPrimitives:function(e){t._AllowPickParentWithPrimitives=e},setPicking:function(e,t){"boolean"==typeof e&&console.log("boolean is DEPRECATED in setPicking() method.\n Use object instead."),void 0!==e.activated&&(this.picking.activated=e.activated);var i=e.divTrap,r=function(){var e=this.picking.trapSelection;!1!==window.enableNewTrapSelection?e?(this.trapSelectionManipulator||(this.trapSelectionManipulator=new h(this),this.trapSelectionManipulator._linkToViewer()),this.trapSelectionManipulator.enable(),this.trapSelectionManipulator.setAdvanced("advanced"===e),void 0!==i?this.trapSelectionManipulator.setShowDivTrap(!!i):this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)):this.trapSelectionManipulator&&this.trapSelectionManipulator.disable():(this.trapSelection||(this.trapSelection=new l(this)),this.trapSelection.set(e))};void 0!==e.contextPick&&(this.picking.contextPick=e.contextPick),void 0!==e.displayHL&&(this.picking.displayHL=e.displayHL),void 0!==e.gpu&&(this.picking.gpu=e.gpu),void 0!==e.trapGPU&&(this.picking.trapGPU=e.trapGPU),void 0!==e.computeNormalDepth&&(this.picking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.picking.primitive=e.primitive,this.picking._trapPrimitiveUsed||(this.picking.trapPrimitive=!!e.primitive)),void 0!==e.pickingTolerance&&(this.renderer.gpuPickingTolerance=e.pickingTolerance,this.picking.tolerance=e.pickingTolerance),void 0!==e.forceVisibility&&this.picking.forceVisibility!==e.forceVisibility&&(this.picking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forceHighlightVisibility(e.forceVisibility)),void 0!==e.trapSelection&&(this.picking.trapSelection=e.trapSelection,r.call(this)),void 0!==e.trapSelectionMesh&&(console.error("DEPRECATED: please use trapPrimitive to control trap selection granularity instead"),this.picking.trapSelection=e.trapSelectionMesh,this.picking._trapPrimitiveUsed=!e.trapSelectionMesh,this.picking.trapPrimitive=!this.picking.trapSelection&&this.picking.trapPrimitive,r.call(this)),void 0!==e.trapPrimitive&&(this.picking.trapPrimitive=e.trapPrimitive,this.picking._trapPrimitiveUsed=!0),void 0!==e.showDivTrap&&(this.picking.showDivTrap=e.showDivTrap,this.trapSelectionManipulator&&this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)),this.renderer&&(this.renderer._postProHighlight?(this.renderer.setEffect("Highlight",this.picking.activated&&this.picking.displayHL),this.renderer.setEffect("Canvas2DHighlight",this.picking.activated&&this.picking.displayHL)):this.renderer.setEffect("HighlightMobile",this.picking.activated&&this.picking.displayHL));var n=!0;void 0!==t&&(n=t),this.setDefaultPicking(n)},setPrePicking:function(e,t){void 0!==e.activated&&(this.pPicking.activated=e.activated),void 0!==e.trapSelection&&(this.pPicking.trapSelection=e.trapSelection),void 0!==e.displayHL&&(this.pPicking.displayHL=e.displayHL),void 0!==e.gpu&&(this.pPicking.gpu=e.gpu),void 0!==e.computeNormalDepth&&(this.pPicking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.pPicking.primitive=e.primitive),void 0!==e.disableWhileMoving&&(this.pPicking.disableWhileMoving=e.disableWhileMoving),void 0!==e.forceVisibility&&this.pPicking.forceVisibility!==e.forceVisibility&&(this.pPicking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forcePreHighlightVisibility(e.forceVisibility)),this.renderer&&(this.renderer._postProHighlight?(this.renderer.setEffect("PreHighlight",this.pPicking.activated&&this.pPicking.displayHL),this.renderer.setEffect("Canvas2DPreHighlight",this.pPicking.activated&&this.pPicking.displayHL)):this.renderer.setEffect("PreHighlightMobile",this.pPicking.activated&&this.pPicking.displayHL));var i=!0;void 0!==t&&(i=t),this.setDefaultPicking(i)},setPickingGPU:function(e){this.picking.gpu!==e&&(this.picking.gpu=e)},setSmallRenderTargetPicking:function(e){this.renderer.smallTargetPicking!==e&&(this.renderer.smallTargetPicking=e)},setForceMultiSelection:function(e){this.forceMultiSel=e}},b={setCurrentHighlightSet:function(e){this.highlightColor=e?e.highlightData:null},createHighlightSet:function(e,t,i,r){i=null==i?!(v||this.ODTMode):!!i;var n=null;if(!(!t&&r)&&(n=this._getHighlightSet(e,t,i)))return n;((n=new c(this)).setHighlightData(i,e),n.setMultiColorMode(!0),this.renderer._postProHighlight)?(this.getEffect("Highlight").addScene(n),this.getEffect("Canvas2DHighlight").addScene(n)):this.getEffect("HighlightMobile").addScene(n);return t||n.detachToHSO(),this.highlightSets.push(n),n},removeHighlightSet:function(e){this._removeHighlightSet(e.getHighlightData(),e.linkToHSO);this.renderer._postProHighlight?(this.getEffect("Highlight").removeScene(e),this.getEffect("Canvas2DHighlight").removeScene(e)):this.getEffect("HighlightMobile").removeScene(e);e.detachToHSO(),e.clearAll()},_getHighlightSet:function(e,t,i){for(var r=this.highlightSets,n=0;n<r.length;n++){var s=r[n];if(s.linkToHSO==t&&s.getHighlightData().isEqual(e)&&s.getHighlightData()._needsDepth===i)return s}return null},_removeHighlightSet:function(e,t){for(var i=this.highlightSets,r=0;r<i.length;r++){var n=i[r];if(n.linkToHSO==t&&n.getHighlightData().isEqual(e))return i.splice(r,1),!0}return!1},activatePreHighlightOnDrag:function(e){this._supportDragPrehighlight=e},setHighlight:function(e){this.displayHighlight!==e&&(this.displayHighlight=e,this.setPicking({activated:e,displayHL:e}),this.renderer._postProHighlight?(this.renderer.setEffect("Highlight",e),this.renderer.setEffect("Canvas2DHighlight",e)):this.renderer.setEffect("HighlightMobile",e),this.render())},showHighlight:function(e){this._showHighlight!==e&&(this._showHighlight=e,this.render())},setAdvancedPoliteHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!0,e),r&&r.setHighlightData(!0,t),this.render()},setHaloHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!1,e),r&&r.setHighlightData(!1,t),this.render()},getHighlightData:function(){var e=this.internalSceneGraph.selectionHL,t=this.internalSceneGraph.selectionPreHL,i={highlightData:null,preHighlightData:null};return e&&(i.highlightData=e.getHighlightData()),t&&(i.preHighlightData=t.getHighlightData()),i},setPreHighlightColor:function(e,i){console.warn("Warning: Deprecated API, please use setAdvancedPoliteHighlight or setHaloHighlight instead"),this.internalSceneGraph.selectionPreHL&&(e instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:e,outlineThickness:1}):i instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:i,outlineThickness:1}),i instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:i,haloIntensity:500,haloThickness:1}):e instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:e,haloIntensity:500,haloThickness:1}))},_dbgQuickHighlight:function(e){if(e){var t=new s([e]);f.add({pathElement:t})}else f.empty()}},x={addToCSOHSO:function(e,i){const r=t._AllowPickParentWithPrimitives;function n(t,r,n,a){var o,l,h={removed:[],added:[]};n&&(h.removed=function(e){for(var t=e.get(),i=[],r=0;r<t.length;r++){var n=t[r],s=n.pathElement;!s&&n.options&&(s=n.options.pathElement),s&&i.push(s)}return i}(r),r.empty());var c,d,u,p,f=[],g=[],m={highlightColor:s.highlightColor};for(c=r.get(),o=0;o<t.length;o++){for(d=t[o].pathElement,u=!1,l=0;l<c.length&&!u;l++)!(p=c[l]).pathElement&&p.options&&p.options.pathElement,d.isEqual(c[l].pathElement)&&(c[l].position&&(c[l].position=e.position),f.push(c[l]),u=!0);u||g.push({pathElement:d,event:i.event,position:e.position,parameters:m})}if(a)for(f.length>0&&r.remove(f),o=0;o<f.length;o++)h.removed.push(f[o].pathElement);for(g.length>0&&r.add(g),o=0;o<g.length;o++)h.added.push(g[o].pathElement);return h}var s=this,a=f,o=p,l=function(t){var i,n,s=[],a=!1;for(i=0;i<e.path.length&&!a;i++)(n=e.path[i]).getLastElement(!0)._getExcludeFromCSO()||(s.push(n),t||(a=!0));if(!s.length&&e.path.length)return null;var o,l,h,c,d={CSO:[],HSO:[]},u=[];for(i=0;i<s.length;i++){n=s[i],o=!1;for(var p=null;n&&y(r,n,n.getLastElement(!0));)p=n,n=n.getParentPath(),o=o||!!n;if(n||(n=p),h=!1,o){for(l=0;l<u.length;l++)u[l].isEqual(n)&&(h=!0);h||u.push(n)}h||(d.CSO.push({pathElement:n}),(c=n.getLastElement(!0))._getExcludeFromHL()||c._getExcludeFromHSO()||d.HSO.push({pathElement:n}))}return d}(i.trapSel);if(!l)return{addedToCSO:[],removedFromCSO:[]};s._modelEvent.publish({event:"PreAddRemoveXSO",data:l.CSO}),s._modelEvent.publish({event:"PreAddRemoveXSO",data:l.HSO});var h=!i.multiSel,c=!i.additiveMode,d=n(l.CSO,o,h,c);return this.picking.displayHL&&n(l.HSO,a,h,c),{addedToCSO:d.added,removedFromCSO:d.removed}},setFillXSOMode:function(e){this._fillXSOMode=e}},w={computeIntersection:function(e,r,s,a,l,h,c,d){if(this.renderer._needPerformanceSuite())return[];var u,p,f,g,m,v,_,y,S,b,x,w=this.trapSelection||c,P=[];if(p=new t.Projector,_=void 0!==r&&r,v=void 0!==s&&s,y=void 0!==a&&a,this.debugPickHybrid&&(y=!0),x=!(!this.picking.trapSelection||!w||void 0===e.pt||e.pt.xPix===e.xPix&&e.pt.yPix===e.yPix),null===this.currentViewpoint||null===this.internalSceneGraph)return P;var C=this.devicePixelRatio;if(u=new t.Vector2(e.xPix/C,e.yPix/C),f=this.currentViewpoint.create3DRayFrom2DPoint(u),void 0!==l&&void 0!==l.ray&&(l.ray=f),!x&&e.event){var M=e.event.getView(),E=M.renderable;if(!E)for(;M!==this.canvas&&(M.parentElement||M.parentNode)&&!E;)E=(M=M.parentElement||M.parentNode).renderable;if(E&&E.noPickThrough){var T,A;if(E instanceof t.CSS3DNode){var D=(new t.Matrix4).multiplyMatrices(E.matrixWorld,E.scaleCSS),I=e.event.getCurrentPosition(M);(T=new t.Vector3(I.x,I.y,0)).applyMatrix4(D);var R=D.elements;A=new t.Vector3(R[8],R[9],R[10])}else{var O=E.position.clone(),L=(this.currentViewpoint.camera.getLookAt(),(new t.Plane).setFromNormalAndCoplanarPoint(this.currentViewpoint.camera.getLookAt(),O)),B=(E.element.getBoundingClientRect(),this.getMousePosition(new t.Vector2(e.xPix,e.yPix)));B=new t.Vector3(B.x,B.y,1),p.unprojectVector(B,this.currentViewpoint.camera),T=new t.Ray(this.currentViewpoint.camera.position,B.clone().sub(this.currentViewpoint.camera.position).normalize()).intersectPlane(L),A=L.normal}return P[0]={object:E,primitive:!(!E||!E.primitive),point:T,normal:A},P}}let F=this._viewpointManager.getVpList(!0),V=!this.renderer.pickingGPUComposerContext||this.renderer.pickingGPUComposerContext.needsUpdate,G=!this.renderer.normalComposerContext||this.renderer.normalComposerContext.needsUpdate,N=!this.renderer.depthComposerContext||this.renderer.depthComposerContext.needsUpdate,U=!this.renderer.gpuPositionComposerContext||this.renderer.gpuPositionComposerContext[0].needsUpdate,k=0,z=1,H=P;this.renderer.smallTargetPicking||(this.renderer.renderer.RTTmatchViewport=!0);let W=this,j=this.currentViewpoint,X=function(){if(W._setupViewpoint(null),W.currentViewpoint=j,W.renderer.pickingGPUComposerContext&&W.renderer.pickingGPUComposerContext.setPassClear(W.renderer.initClearPass,!0),W.renderer.normalComposerContext&&W.renderer.normalComposerContext.setPassClear(W.renderer.initClearPass,!0),W.renderer.depthComposerContext&&W.renderer.depthComposerContext.setPassClear(W.renderer.initClearPass,!0),W.renderer.gpuPositionComposerContext)for(let e=0;e<W.renderer.gpuPositionComposerContext.length;e++)W.renderer.gpuPositionComposerContext[e].setPassClear(W.renderer.initClearPass,!0)};for(let i=0;i<F.length;i++){let r=F[i];if(this._setupViewpoint(r,!0),this.renderer._pickingVPid=""+i,f=r.create3DRayFrom2DPoint(u),i>0&&!this.renderer.smallTargetPicking&&(this.renderer.pickingGPUComposerContext&&(this.renderer.pickingGPUComposerContext.needsUpdate=V,this.renderer.pickingGPUComposerContext.setPassClear(this.renderer.initClearPass,!1)),this.renderer.normalComposerContext&&(this.renderer.normalComposerContext.needsUpdate=G,this.renderer.normalComposerContext.setPassClear(this.renderer.initClearPass,!1)),this.renderer.depthComposerContext&&(this.renderer.depthComposerContext.needsUpdate=N,this.renderer.depthComposerContext.setPassClear(this.renderer.initClearPass,!1)),this.renderer.gpuPositionComposerContext))for(let e=0;e<W.renderer.gpuPositionComposerContext.length;e++)this.renderer.gpuPositionComposerContext[e].needsUpdate=U,this.renderer.gpuPositionComposerContext[e].setPassClear(this.renderer.initClearPass,!1);let n=this._viewpointManager.getViewpointViewport(r),a=n?n.width:this.renderer.deviceWidth,l=n?n.height:this.renderer.deviceHeight,c=new t.Vector2(e.xPix,e.yPix),d=new t.Vector2(e.pt?e.pt.xPix:0,e.pt?e.pt.yPix:0);if(c.divideScalar(this.devicePixelRatio),d.divideScalar(this.devicePixelRatio),c=r._convertViewportToNDC(c),d=r._convertViewportToNDC(d),x){if(y=!1,c.x===d.x||c.y===d.y)return X(),P;if(v||!_){var q,Z,Y,K,$,Q;b=new t.Vector3(c.x,d.y,1);var J=r.camera,ee=J.position,te=J.getLookAt();if($=(new t.Plane).setFromNormalAndCoplanarPoint(te,ee.clone().add(te.clone().multiplyScalar(J.near))),Q=(new t.Plane).setFromNormalAndCoplanarPoint(te.clone().multiplyScalar(-1),ee.clone().add(te.clone().multiplyScalar(J.far))),r.getProjectionType()===o.PERSPECTIVE){var ie=new t.Vector3(c.x,c.y,1);p.unprojectVector(ie,J),ie.sub(ee).normalize();var re=new t.Vector3(d.x,c.y,1);p.unprojectVector(re,J),re.sub(ee).normalize();var ne=new t.Vector3(d.x,d.y,1);p.unprojectVector(ne,J),ne.sub(ee).normalize();var se=new t.Vector3(c.x,d.y,1);p.unprojectVector(se,J),se.sub(ee).normalize();var ae=new t.Vector3;ae.copy(ie),Y=(new t.Plane).setFromNormalAndCoplanarPoint(ie.cross(re).normalize(),ee),Z=(new t.Plane).setFromNormalAndCoplanarPoint(re.cross(ne).normalize(),ee),K=(new t.Plane).setFromNormalAndCoplanarPoint(ne.cross(se).normalize(),ee),q=(new t.Plane).setFromNormalAndCoplanarPoint(se.cross(ae).normalize(),ee)}else{var oe=J.up.clone(),le=new t.Vector3(1,0,0).applyQuaternion(J.quaternion),he=new t.Vector3(c.x,c.y,1);p.unprojectVector(he,J);var ce=new t.Vector3(d.x,d.y,1);p.unprojectVector(ce,J),Y=(new t.Plane).setFromNormalAndCoplanarPoint(oe.clone().negate(),he),Z=(new t.Plane).setFromNormalAndCoplanarPoint(le.clone().negate(),ce),K=(new t.Plane).setFromNormalAndCoplanarPoint(oe,ce),q=(new t.Plane).setFromNormalAndCoplanarPoint(le,he)}S=new t.Frustum(q,Z,Y,K,$,Q)}}var de,[ue,pe,fe]=this.getRenderMode().getMasks(),ge=t.getDevicePixelRatio();if(_){if(r._updateRobotCamera(this.internalSceneGraph),P=this.renderer.computeIntersectionGPU(this.internalSceneGraph,r,e,y,x,null,null,null,h,_&&v&&!x,!!this._pageObjectData,this.renderer.smallTargetPicking,f),this.renderer.smallTargetPicking&&r.camera.fullWidth&&(this.lockRenderIteration(),this.internalSceneGraph.onViewpointChange(),this.unlockRenderIteration()),P.length&&v){for(var me=[],ve=0;ve<P.length;++ve){var _e=P[ve];_e.object&&_e.object._instancingInfos&&_e.object._instancingInfos.isInstanceNode3D?me.push(_e):_e.object instanceof t.Mesh&&(!_e.object._occurrence||!_e.object._occurrence.node||_e.object._occurrence.node.getPrimitivePicking())&&(de=this._getUserPassManager()._getActiveRenderLists(),me=x?me.concat(f.intersectMeshInstancesZones3D(_e.object,r.camera,new t.Vector3(c.x,c.y,1),b,S,s,ue,pe,fe,a,l,!w.forwardSelect,{renderLists:de,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):me.concat(f.intersectMeshInstances(_e,r.camera,new t.Vector3(c.x,c.y,1),ue,pe,fe,a,this.renderer.deviceHeight,this.picking.tolerance,{debugPickHybrid:this.debugPickHybrid,renderLists:de,inVisibleSpace:this.visibleSpace,devicePixelRatio:ge,candidatesOnly:!1,useViewerPickingRules:!0})))}me.length&&(P=me),f._cleanIntersectionsList(P,!x)}}else{if(de=this._getUserPassManager()._getActiveRenderLists(),P=x?P.concat(f.intersectMeshInstancesZones3D(this.internalSceneGraph.scene,r.camera,new t.Vector3(c.x,c.y,1),b,S,s,ue,pe,fe,a,l,!w.forwardSelect,{renderLists:de,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):f.intersectMeshInstances({object:this.internalSceneGraph.scene},r.camera,new t.Vector3(c.x,c.y,1),ue,pe,fe,a,l,this.picking.tolerance,{debugPickHybrid:!1,renderLists:de,inVisibleSpace:this.visibleSpace,devicePixelRatio:ge,candidatesOnly:!1,useViewerPickingRules:!0}),h){for(var ye=[],Se=0;Se<h.length;Se++)ye[h[Se].id]=h[Se].priority;P.sort((function(e,t){var i=0,r=0;if(e.object.pickingPriorityID){var n=e.object.pickingPriorityID.points;!e.primitive||!e.primitive.getGroup||e.primitive.getGroup().glType>=4?n=e.object.pickingPriorityID.faces:e.primitive.getGroup().glType>=1&&(n=e.object.pickingPriorityID.edges),n&&ye[n]&&(i=ye[n])}if(t.object.pickingPriorityID){var s=t.object.pickingPriorityID.points;!t.primitive||!t.primitive.getGroup||t.primitive.getGroup().glType>=4?s=t.object.pickingPriorityID.faces:t.primitive.getGroup().glType>=1&&(s=t.object.pickingPriorityID.edges),s&&ye[s]&&(r=ye[s])}return i>r?-1:i<r?1:e.distance-t.distance}))}f._cleanIntersectionsList(P,!x)}X();for(let e=0;e<P.length;e++)P[e].viewpoint=r;z==k?H=P.concat(H):(!H.length||P.length&&null!=P[0].object)&&(H=P)}this.renderer.renderer.RTTmatchViewport=!1,P=H;var be=this.getRootNode();if(be&&this.debugPicking&&(null===this.debugPickingNode?(this.debugPickingNode=new i,this.debugPickingNode.exludeFromBounding(!0),be.addChild(this.debugPickingNode)):0===this.debugPickingNode.parents.length&&be.addChild(this.debugPickingNode)),this.debugPicking){if(this.debugPickingNode.removeChildren(),P.length>0&&P[0].object&&P[0].point){g=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.8,transparent:!0,force:!0,forceSide:!0});var xe=n.createSphereNode({radius:1,sag:32,material:g});xe.setPickable(2),xe._setRatio(4),xe.setFrustumCulled(!1),xe.setMatrix((new t.Matrix4).setPosition(P[0].point)),xe.setSSAO(!1),xe.setMirror(!1),xe.setShadow(!1),this.debugPickingNode.addChild(xe),m=t.MaterialUtils.createMatteFaceMaterial({color:4474111,opacity:1,transparent:!1,force:!0,forceSide:!0});var we=n.createSphereNode({radius:1,sag:32,material:m});if(we.setPickable(2),we._setRatio(8),we.setFrustumCulled(!1),we.setSSAO(!1),we.setMirror(!1),we.setShadow(!1),we.setMatrix((new t.Matrix4).setPosition(this.currentViewpoint.camera.position)),this.debugPickingNode.addChild(we),P[0]&&(P[0].point&&console.log(" x "+P[0].point.x+" y "+P[0].point.y+" z "+P[0].point.z),P[0].normal&&console.log(" nx "+P[0].normal.x+" ny "+P[0].normal.y+" nz "+P[0].normal.z)),P[0].normal){var Pe=new t.LineBasicMaterial({color:4474111,opacity:1,force:!0,lineWidth:2}),Ce=new t.Vector3(P[0].normal.x,P[0].normal.y,P[0].normal.z);Ce.multiplyScalar(.2*P[0].object.boundingSphere.radius);var Me=(new t.Vector3).addVectors(P[0].point,Ce);(Oe=n.createLineNode({points:[P[0].point,Me],material:Pe}))._occurrences[0].renderable,Oe.setPickable(2),Oe.setSSAO(!1),Oe.setMirror(!1),Oe.setShadow(!1),this.debugPickingNode.addChild(Oe)}var Ee=P[0].primitive,Te=Ee&&Ee.getBoundingSphere();if(Te){var Ae=t.MaterialUtils.createMatteFaceMaterial({color:4521796,opacity:.2,transparent:!1,force:!0,forceSide:!0}),De=n.createSphereNode({radius:1,sag:32,material:Ae});De.setPickable(2),De.setFrustumCulled(!1),De.setSSAO(!1),De.setMirror(!1),De.setShadow(!1);var Ie=new t.Sphere(new t.Vector3(Te.center.x,Te.center.y,Te.center.z),Te.radius);Ie.applyMatrix4(P[0].object.matrix);var Re=(new t.Matrix4).setPosition(Ie.center);Re.scale(new t.Vector3(Ie.radius,Ie.radius,Ie.radius)),De.setMatrix(Re),this.debugPickingNode.addChild(De)}var Oe;Pe=new t.LineBasicMaterial({color:16729156,opacity:1,force:!0,lineWidth:1});(Oe=n.createLineNode({points:[f.origin,P[0].point],material:Pe}))._occurrences[0].renderable,Oe.setPickable(2),Oe.setSSAO(!1),Oe.setMirror(!1),Oe.setShadow(!1),this.debugPickingNode.addChild(Oe)}this.render()}for(ve=P.length-1;ve>=0;ve--){var Le=P[ve];if(!Le.object&&Le.length>1)P.splice(ve,1);else if(Le.primitive){var Be=Le.object.getSelectionGroup(Le.primitive);Be&&(Le.primitive=Be)}}return 0===P.length&&P.push({object:null,viewpoint:this.currentViewpoint}),_&&!s||(P=this._filterClippedIntersections(P)),P},_castRayFunc:function(e,t,i,r){return this.renderer._needPerformanceSuite()?[]:(console.warning("Internal method: use castRay or castRayOnOccurrence instead"),e._cast(t,i,r,s))},castRay:function(e,t,i,r){if(this.renderer._needPerformanceSuite())return[];var n,a=0,o=0,l=(r=r||{}).iDoNotUseDefaultRenderPasses?[]:["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];if(r.iAdditionalRenderPasses)for(o=0;o<r.iAdditionalRenderPasses.length;o++)n=r.iAdditionalRenderPasses[o],l.push(n&&n._getIdString?n._getIdString():n);var h=[];if(t)for(a=0;a<t._occurrences.length;a++)h=h.concat(t._occurrences[a]._getRenderableOccurrences());else{var c=this.internalSceneGraph.scene;for(o=0;o<l.length;o++)h=h.concat(c.getWebGLObjects(l[o]))}return e._cast(h,i,r,s)},castRayOnOccurrence:function(e,t,i,r){var n=0,a=["main","noz","noEffectNoZ","afterHighlightNoZ"],o=[];if(t){o=t._getRenderableOccurrences(this,!1);var l=t._getUniqueOccurrence(this);null===l?console.log("castRayIntoOccurrences ERROR: the path element is either invalid or doesn't define a unique occurrence."):l.node._tryOverridesUpdate(this)}else{var h=this.internalSceneGraph.scene;for(n=0;n<a.length;n++)o=o.concat(h.getWebGLObjects(a[n]))}return e._cast(o,i,r,s)}};let P={};return Object.assign(P,S),Object.assign(P,b),Object.assign(P,w),Object.assign(P,x),P})),define("DS/Visualization/Info",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";const t=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0,this.ubos=0,this.totalUBOSize=0,this.pipelines=0};t.prototype.reset=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0,this.ubos=0,this.totalUBOSize=0,this.pipelines=0},t.prototype.getMemory=function(){let e={programs:this.programs,geometries:this.geometries,textures:this.textures,renderTargets:this.renderTargets,sharedbuffers:this.sharedbuffers};return this.ubos>0&&(e.ubos=this.ubos,e.totalUBOSize=this.totalUBOSize),this.pipelines>0&&(e.pipelines=this.pipelines),e};const i=function(e){this.name=e||"",this._duration=0,this._parent=null,this.children=[]};i.prototype.push=function(e){e._parent=this,this.children.push(e)},i.prototype.start=function(){this._duration=performance.now()},i.prototype.end=function(){this._duration=performance.now()-this._duration};const r=function(){this.activated=!1,this.curNode=null,this.frameTypeMap=new Map};r.prototype.enable=function(e){this.activated=e,this.curNode=null,e&&this.frameTypeMap.clear()},r.prototype.pushRoot=function(e){this.activated&&(this.curNode=new i,this.frameTypeMap.set(e,this.curNode),this.curNode.start())},r.prototype.popRoot=function(){this.activated&&(this.curNode&&this.curNode.end(),this.curNode=null)},r.prototype.push=function(e){if(this.curNode){var t=new i(e);this.curNode.push(t),this.curNode=t,this.curNode.start()}},r.prototype.pop=function(){this.curNode&&(this.curNode.end(),this.curNode=this.curNode._parent)};const n=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.globalUniformCalls=0,this.materialUniformCalls=0,this.lightUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.swapBindgroups=0,this.writeUBOs=0,this.bindGroupsCreated=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.occludedMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0,this.nbRenderCuttingElement=0,this.dlTraversed=0,this.materialPackTraversed=0,this.sortIDTraversed=0,this.tokenTraversed=0};return n.prototype.reset=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.globalUniformCalls=0,this.materialUniformCalls=0,this.lightUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.swapBindgroups=0,this.writeUBOs=0,this.bindGroupsCreated=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.occludedMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0,this.nbRenderCuttingElement=0,this.dlTraversed=0,this.materialPackTraversed=0,this.sortIDTraversed=0,this.tokenTraversed=0},n.prototype.getRendering=function(){var e={swapMaterials:this.swapMaterials,swapPrograms:this.swapPrograms,swapScenes:this.swapScenes,swapBuffers:this.swapBuffers,objectUniformCalls:this.objectUniformCalls,materialUniformCalls:this.materialUniformCalls,globalUniformCalls:this.globalUniformCalls,lightUniformCalls:this.lightUniformCalls,dlTraversed:this.dlTraversed,materialPackTraversed:this.materialPackTraversed,sortIDTraversed:this.sortIDTraversed,tokenTraversed:this.tokenTraversed};return 0!==this.writeUBOs&&(e.writeUBOs=this.writeUBOs),0!==this.unsharedBuffers&&(e.unsharedBuffers=this.unsharedBuffers),0!==this.nbRenderCuttingElement&&(e.nbRenderCuttingElement=this.nbRenderCuttingElement),0!==this.swapBindgroups&&(e.swapBindgroups=this.swapBindgroups),0!==this.bindGroupsCreated&&(e.bindGroupsCreated=this.bindGroupsCreated),e},n.prototype.getGeometries=function(){var e={calls:this.calls,vertices:this.vertices,faces:this.faces,lines:this.lines,points:this.points,nbDGs:this.nbDGs};return 0!==this.nbReps&&(e.nbReps=this.nbReps),0!==this.nbDGsSSBProcessed&&(e.nbDGsSSBProcessed=this.nbDGsSSBProcessed),e},n.prototype.getCulling=function(){var e={cullingCalls:this.cullingCalls,culledMeshes:this.culledMeshes};return this.occludedMeshes&&(e.occludedMeshes=this.occludedMeshes),0===this.culledGeometries&&0===this.culledDGTriangles&&0===this.culledDGLines||(e.culledGeometries=this.culledGeometries,e.culledDGTriangles=this.culledDGTriangles,e.culledDGLines=this.culledDGLines),e},{MemoryInfo:t,RenderTimeInfo:r,RenderInfo:n}})),define("DS/Visualization/SubsurfaceGenerator",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";var t=function(){this.computedTextures=new Map,this.size=64,this.radiusR=null,this.depthR=null,this.radiusG=null,this.depthG=null,this.radiusB=null,this.depthB=null;var e=this.utilities.linspace(-1,1,this.size);this.theta=this.utilities.applyToArray(e,(function(e){return Math.acos(e)})),this.sinTheta=this.utilities.applyToArray(this.theta,(function(e){return e>.5*Math.PI?0:Math.sin(e)})),this.aux=Math.PI*Math.PI*Math.sqrt(.31830988618)/this.size};return t.prototype={constructor:t,modelFunction:function(e){var t=e.scatteringCoeffs,i=Math.max(Math.min(e.subsurfaceAnisotropy,.99),-.99);t=this.utilities.applyToArray(t,(function(e){return e*(1-i)}));var r=this.utilities.sumArray(e.absorptionCoeffs,t),n=this.utilities.applyToArray(this.utilities.multiplyArray(e.absorptionCoeffs,r),(function(e){return Math.sqrt(3*e)})),s=-1.44/(e.eta*e.eta)+.71/e.eta+.668+.0636*e.eta,a=(1+s)/(1-s),o=this.utilities.applyToArray(r,(function(e){return 1/Math.max(e,1e-20)})),l=this.utilities.applyToArray(o,(function(e){return 4*a/3*e})),h=this.utilities.applyToArray(o,(function(e){return 5*e}));this.depthR=this.utilities.linspace(0,15*o[0],this.size),this.radiusR=this.utilities.linspace(.5*o[0],7.5*o[0],this.size),this.depthG=this.utilities.linspace(0,15*o[1],this.size),this.radiusG=this.utilities.linspace(.5*o[1],7.5*o[1],this.size),this.depthB=this.utilities.linspace(0,15*o[2],this.size),this.radiusB=this.utilities.linspace(.5*o[2],7.5*o[2],this.size);var c=this.utilities.multiplyArray(t,o),d=function(e,t){return(t*e+1)*Math.exp(-t*e)/(e*e*e)},u=.25/Math.PI,p=function(e,t){for(var i=n[e],r=o[e],s=l[e],a=h[e],p=0,f=-2;f<=2;f++){var g=2*f*(a+s),m=g+r,v=g-r-s,_=Math.sqrt(t*t+m*m),y=Math.sqrt(t*t+v*v);p+=m*d(_,i)-v*d(y,i)}var S=c[e];return p*u*S};return{red:function(e){return p(0,e)},green:function(e){return p(1,e)},blue:function(e){return p(2,e)}}},sssLUTBuilder:function(e,t,i){return this.utilities.integrate((function(r){var n=t*Math.abs(2*Math.sin(.5*r));return Math.max(Math.cos(i+r),0)*e(n)}),-Math.PI,Math.PI)/Math.max(this.utilities.integrate((function(i){var r=t*Math.abs(2*Math.sin(.5*i));return e(r)}),-Math.PI,Math.PI),1e-20)},translucencyLUTBuilder:function(e,t,i){return this.utilities.integrateT((function(i){return 2*Math.PI*i*e(Math.sqrt(i*i+t*t))}),i[this.size-1])},setTexture:function(t,i,r){var n=new e.DataTexture(t,i,r,e.RGBAFormat,e.FloatType);return n.minFilter=e.LinearFilter,n.magFilter=e.LinearFilter,n.generateMipmaps=!1,n.flipY=!1,n.needsUpdate=!0,n},decreaseUseCount:function(e){if(this.computedTextures.has(e)){var t=this.computedTextures.get(e);t.useCount--,0===t.useCount&&(t.textures.sssLUT.dispose(),this.computedTextures.delete(e))}},dispose:function(){this.computedTextures.forEach((function(e,t,i){e.textures.sssLUT.dispose()})),this.computedTextures.clear()},_getComputedTextures:function(e){var t=-1;return this.computedTextures.forEach((function(i,r,n){var s,a,o,l,h,c,d;s=i.options,a=e,o=Math.abs(s.scatteringCoeffs[0]-a.scatteringCoeffs[0])<1e-6&&Math.abs(s.scatteringCoeffs[1]-a.scatteringCoeffs[1])<1e-6&&Math.abs(s.scatteringCoeffs[2]-a.scatteringCoeffs[2])<1e-6,l=Math.abs(s.absorptionCoeffs[0]-a.absorptionCoeffs[0])<1e-6&&Math.abs(s.absorptionCoeffs[1]-a.absorptionCoeffs[1])<1e-6&&Math.abs(s.absorptionCoeffs[2]-a.absorptionCoeffs[2])<1e-6,h=Math.abs(s.color[0]-a.color[0])<1e-6&&Math.abs(s.color[1]-a.color[1])<1e-6&&Math.abs(s.color[2]-a.color[2])<1e-6,c=Math.abs(s.eta-a.eta)<1e-6,d=Math.abs(s.subsurfaceAnisotropy-a.subsurfaceAnisotropy)<1e-6,o&&l&&c&&h&&d&&(i.useCount++,t=r)})),t>-1?this.computedTextures.get(t).textures:null},compute:function(t){var i=this._getComputedTextures(t);if(null!==i)return i;for(var r=Date.now(),n=this.modelFunction(t),s=this.size+2+3+2+3,a=new Float32Array(this.size*s*4),o=this.size+2,l=this.size+7,h=t.color,c=0;c<this.size;c++){for(var d=this.radiusR[c],u=this.radiusG[c],p=this.radiusB[c],f=0,g=0,m=0,v=0;v<this.size;v++){var _,y,S,b=this.theta[v];_=h[0]*this.sssLUTBuilder(n.red,d,b),S=h[1]*this.sssLUTBuilder(n.green,u,b),y=h[2]*this.sssLUTBuilder(n.blue,p,b),a[4*this.size*c+4*v+0]=_,a[4*this.size*c+4*v+1]=S,a[4*this.size*c+4*v+2]=y,c==this.size-1&&(a[4*this.size*this.size+4*v+0]=_,a[4*this.size*this.size+4*v+1]=S,a[4*this.size*this.size+4*v+2]=y),f+=_*this.sinTheta[v],g+=S*this.sinTheta[v],m+=y*this.sinTheta[v]}f*=this.aux,g*=this.aux,m*=this.aux;for(var x=this.depthR[c],w=this.depthG[c],P=this.depthB[c],C=this.translucencyLUTBuilder(n.red,x,this.depthR),M=this.translucencyLUTBuilder(n.green,w,this.depthG),E=this.translucencyLUTBuilder(n.blue,P,this.depthB),T=0;T<3;T++){var A=this.size*(o+T);a[4*A+4*c+0]=f,a[4*A+4*c+1]=g,a[4*A+4*c+2]=m;var D=this.size*(l+T);a[4*D+4*c+0]=C,a[4*D+4*c+1]=M,a[4*D+4*c+2]=E}}var I=this.setTexture(a,this.size,this.size+5+5),R=Date.now();e.VisualizationTraces.info((R-r)/1e3);var O={sssLUT:I,translucencyDepth:[this.depthR[this.size-1],this.depthG[this.size-1],this.depthB[this.size-1]]};return this.computedTextures.set(I.id,{textures:O,options:{eta:t.eta,absorptionCoeffs:t.absorptionCoeffs.slice(0),scatteringCoeffs:t.scatteringCoeffs.slice(0),subsurfaceAnisotropy:t.subsurfaceAnisotropy,color:t.color.slice(0)},useCount:1}),O},toImage:function(){var e=document.createElement("canvas");document.body.appendChild(e);var t=e.getContext("2d"),i=this;this.computedTextures.forEach((function(r,n,s){!function(r,n,s,a){e.height=s,e.width=n;for(var o=0;o<s;++o)for(var l=0;l<n;++l)t.fillStyle="rgb("+255*r[3*i.size*o+3*l]+", "+255*r[3*i.size*o+3*l+1]+",+"+255*r[3*i.size*o+3*l+2]+")",t.fillRect(l,o,1,1);var h=e.toDataURL("image/png"),c=document.createElement("a");c.download=a,c.innerHTML="Download File",c.href=h,c.click()}(r.textures.sssLUT.image.data,r.textures.sssLUT.image.width,r.textures.sssLUT.image.height,"sssLUT")}))},utilities:{linspace:function(e,t,i){var r=Math.floor(i);if(r<=1)return[t];for(var n=(t-e)/(i-1),s=[],a=0;a<r;a++)s[a]=e+a*n;return s},sumElements:function(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t},multiplyArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]*t[n];return r},sumArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]+t[n];return r},applyToArray:function(e,t){for(var i=[],r=0;r<e.length;r++)i[r]=t(e[r]);return i},integrate:function(e,t,i){var r=this.linspace(t,i,120),n=this.applyToArray(r,e);return.5*(i-t)/120*(2*this.sumElements(n)-n[119]-n[0])},integrateT:function(e,t){var i=1e3,r=this.linspace(0,t,i),n=this.applyToArray(r,e);return.5*t/i*(2*this.sumElements(n)-n[999]-n[0])}}},t})),define("DS/Visualization/CGRReader",["DS/VisuLoaders/CGRReader"],(function(e){"use strict";return e})),define("Visualization/CGRReader",["DS/Visualization/CGRReader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/CGRReader"),e})),window.ConvergeWebVisuNoGlobals||(window.i=0),function(){for(var e=["DeferrableMaterial","DeferredCaches","LineBasicMaterial","LineDSMaterial","Material","MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","ParticleBasicMaterial","PhysicalMaterial","CATGraphicalMaterial","ShaderMaterial","DSPBR19x","DSPBR21x","DSPBR22x","DSPBR25x","GASPBR","OutlineMaterial","SectionBuilderMaterial","CubeMapMaterial","FiniteEnvMapMaterial","FiniteTransitionEnvMapMaterial","GradientBackgroundMaterials","LatLongMapMaterial","SimpleMapMaterial","GridMaterial","SmallPlaneMaterial","PlaneMaterial","HatchingMaterials","ShaderDynamicPrefixBuilder"],t=0;t<e.length;t++)e[t]="DS/Materials/"+e[t];e.push("DS/Mesh/ThreeJS_Base"),define("DS/Visualization/Materials",e,(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D){"use strict";var I=function(e){console.error("ShaderMaterialDS has been removed, using MeshBasicMaterial instead"),s.call(this,e)};(I.prototype=Object.create(s.prototype)).getType=function(){return"Deprecated Material"},I.prototype.clone=function(e){return e||(e=new I),s.prototype.clone.call(this,e),e};var R={cleanPredefinedMaterialTextureCache:function(){for(var e=t._loadPredefinedMaterialTextures(!0,(function(){}),!0),i=0;i<e.length;i++)e[i]._canBeUsed()&&e[i].dispose()},cleanPredefinedMaterialCache:function(){for(var e=[t.PredefinedMaterials],i=0;i<e.length;i++)e[i].forEach((function(e,t,i){var r,n;if(e.material.dispose)e.material.dispose();else for(r in e.material)(n=e.material[r])&&n.dispose&&n.dispose();i.delete(t)}))},cleanDeferredCache:function(e){for(var i=[t.DefaultMaterials,t.GeomTypeMaterials,t.PredefinedMaterials],r=0;r<i.length;r++)i[r].forEach((function(t,i,r){if(t.usedBy.delete(e),t.usedBy.size<1){var n,s;if(t.material.dispose)t.material.dispose();else for(n in t.material)(s=t.material[n])&&s.dispose&&s.dispose();r.delete(i)}}))},DeferrableMaterial:e,LineBasicMaterial:i,LineDSMaterial:r,Material:n,MeshBasicMaterial:s,MeshLambertMaterial:a,MeshPhongMaterial:o,ParticleBasicMaterial:l,PhysicalMaterial:h,_CATGraphicalMaterial:c,ShaderMaterialDS:I,DSPBR19xMaterial:u,DSPBR21xMaterial:p,DSPBR22xMaterial:f,DSPBR25xMaterial:g,_GASPBRMaterial:m,_OutlineMaterial:v._OutlineMaterial,_WideOutlineMaterial:v._WideOutlineMaterial,_SectionMaterial:_._SectionMaterial,_WideSectionMaterial:_._WideSectionMaterial,CubeMapMaterial:y,FiniteEnvMapMaterial:S,FiniteTransitionEnvMapMaterial:b,GradientBackgroundMaterial2:x.GradientBackgroundMaterial2,GradientBackgroundMaterial3:x.GradientBackgroundMaterial3,GradientBackgroundMaterial4:x.GradientBackgroundMaterial4,LatLongMapMaterial:w,SimpleMapMaterial:P,GridMaterial:C,SmallPlaneMaterial:M,PlaneMaterial:E,ShaderDynamicPrefixBuilder:A,HatchingMeshMaterial:T.HatchingMeshMaterial,ScreenSizeHatchingMeshMaterial:T.ScreenSizeHatchingMeshMaterial};return Object.defineProperty(R,"ShaderMaterial",{get:function(){return console.warn("Warning: deprecated material type ShaderMaterial, please migrate. This field will point towards a MeshBasicMaterial in 27x and will be removed in 28x."),d},set:function(e){}}),R}))}(),function(){var e=[];"file:"!==window.location.protocol&&(e.push("text!Visualization/assets/ambiences.json"),e.push("text!Visualization/assets/compare.json")),define("DS/Visualization/JSONSettings",e,(function(e,t){"use strict";return{configAmbiences:e?JSON.parse(e):null,compareSettings:t?JSON.parse(t):null,getDefaultViewSettings:function(){return this.configAmbiences?this.configAmbiences.defaultViews:null},getEmulateScreenDoorTransparency:function(){return!!this.configAmbiences&&this.configAmbiences.emulateScreenDoorTransparency},_dbg_forceEmulateScreenDoorTransparency:function(e){this.configAmbiences&&this.configAmbiences.hasOwnProperty("emulateScreenDoorTransparency")&&(this.configAmbiences.emulateScreenDoorTransparency=e)}}}))}(),define("DS/Visualization/IdPathWatcher",["DS/CoreEvents/Events"],(function(e){"use strict";var t=function(t){this.viewer=t.viewer,this.oocManager=this.viewer._oocManager,this.onIdPathActiveCB=t.onIdPathActiveCB,this.onIdPathInactiveCB=t.onIdPathInactiveCB,this.listenToSceneGraphOnly=!!t.listenToSceneGraphOnly,this.idPathes=new Map,this.macroNodes=new Map,this.token=e.subscribe({event:"/VISU/onSceneGraphUpdate"},this.onSceneGraphUpdate.bind(this))};t.prototype.addIdPath=function(e,t){var r=this.idPathes.get(t);r||(r=new i(t),this.idPathes.set(t,r),this.addIdPath_internal(e,r))},t.prototype.removeIdObject=function(e){var t=this.idPathes.get(e);if(t){var i,r,n=t.firstNode;if(n.single)(i=n.macroNode).removeSingleNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null;else for(;null!==n;)(i=n.macroNode).removeNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null,r=n.nextNode,n.nextNode=null,n=r;t.firstNode=null,this.idPathes.delete(e)}},t.prototype.addIdPath_internal=function(e,t){var i,r=e.ids,n=1===r.length;if(t.count+=r.length,0===r.length)return;var a=this.viewer.getIdPathMatcher(),o=null,l=this.createNode(r[0],t,n),h=null,c=a.idToNode(r[0]);for(t.firstNode=l,i=0;i<r.length-1;i++)o=l,l=this.createNode(r[i+1],t),o.nextNode=l,(s(h=c,c=a.idToNode(l.macroNode.id))||!this.listenToSceneGraphOnly&&this.areCandidateParentChild(r[i],r[i+1]))&&(o.active=!0,t.count--);let d=this.oocManager;o=l,h=c,n?o.single=!0:t.count--,o.single&&(h&&h._hasOccurrenceInViewer(this.viewer)||!this.listenToSceneGraphOnly&&this.oocManager&&(this.oocManager.isRegistered(r[0])||d.isExternalNodeId(r[0])))&&(o.active=!0,t.count--),0===t.count&&this.onIdPathActiveCB(t.idObject)},t.prototype.getMacroNode=function(e){var t=this.macroNodes.get(e);return t||(t=new r(e),this.macroNodes.set(e,t)),t},t.prototype.createNode=function(e,t,i){var r=this.getMacroNode(e);return i?r.createSingleNode(t):r.createNode(t)},t.prototype.onSceneGraphUpdate=function(e){"ADD"===e.eventType?this.onAddChild(e.fromNode,e.toNode):"REMOVE"===e.eventType&&this.onRemoveChild(e.fromNode,e.toNode)},t.prototype.onAddChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),s=this.macroNodes.get(r),a=this.macroNodes.get(n);(this.listenToSceneGraphOnly||!this.areCandidateParentChild(r,n))&&a&&s&&s.onAddChild(a,this,e);let o=this.oocManager;!a||!this.listenToSceneGraphOnly&&o&&o.isRegistered(n)||a.onAddSingle(this)},t.prototype.onCandidateAddChild=function(e,t){var i=this.macroNodes.get(e),r=this.macroNodes.get(t);r&&i&&i.onAddChild(r,this,parent)},t.prototype.onCandidateAddSingle=function(e){var t=this.macroNodes.get(e);t&&t.onAddSingle(this)},t.prototype.onRemoveChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),s=this.macroNodes.get(r),a=this.macroNodes.get(n);if(a&&s&&(!this.listenToSceneGraphOnly&&this.areCandidateParentChild(r,n)||s.onRemoveChild(a,this)),a){let e=this.oocManager;!this.listenToSceneGraphOnly&&e&&e.isRegistered(n)||a.onRemoveSingle(this)}},t.prototype.onCandidateRemoveChild=function(e,t){if(!this.listenToSceneGraphOnly){var i=this.macroNodes.get(e),r=this.macroNodes.get(t);r&&i&&i.onRemoveChild(r,this)}},t.prototype.onCandidateRemoveSingle=function(e){var t=this.macroNodes.get(e);t&&t.onRemoveSingle(this)},t.prototype.getIdPathMatcher=function(){return this.viewer.getIdPathMatcher()},t.prototype.dispose=function(){this.token&&(e.unsubscribe(this.token),this.token=null)},t.prototype.areCandidateParentChild=function(e,t){if(!this.oocManager)return!1;let i=this.oocManager._getLDHReference(e,!0);if(i&&i.getChild(t))return!0;i=this.oocManager._getInstance(e,!0);let r=i&&i.getChild(e);if(r&&r.reference.referenceId===t)return!0;let n=this.oocManager.getExternalNode(e);if(n&&n===this.oocManager.getTargetNode()){let e=this.oocManager._getLDHReference(t,!0);if(e&&e.isRoot)return!0}return!1};var i=function(e){this.idObject=e,this.count=0,this.candidateCount=0,this.firstNode=null},r=function(e){this.id=e,this.nodeSet=null,this.singleNodeSet=null};r.prototype.getNode3D=function(e){return e.getIdPathMatcher().idToNode(this.id)},r.prototype.createNode=function(e){var t=new n(this);return t.idPath=e,this.nodeSet||(this.nodeSet=new Set),this.nodeSet.add(t),t},r.prototype.createSingleNode=function(e){var t=new n(this);return t.idPath=e,this.singleNodeSet||(this.singleNodeSet=new Set),this.singleNodeSet.add(t),t},r.prototype.onAddChild=function(e,t,i){this.nodeSet&&this.nodeSet.forEach((i=>{i.nextNode&&i.nextNode.macroNode===e&&i.activate(t)}))},r.prototype.onAddSingle=function(e){this.singleNodeSet&&this.singleNodeSet.forEach((t=>{t.activate(e)}))},r.prototype.onRemoveChild=function(e,t){this.nodeSet&&this.nodeSet.forEach((i=>{i.nextNode&&i.nextNode.macroNode===e&&i.deactivate(t)}))},r.prototype.onRemoveSingle=function(e){let t=null,i=e.oocManager;this.singleNodeSet&&this.singleNodeSet.forEach((r=>{r.single&&r.active&&(null===t&&(t=this.getNode3D(e)),null!=t&&0!==t.parents.length||i&&i.isRegistered(this.id)||r.deactivate(e))}))},r.prototype.removeNode=function(e){this.nodeSet&&this.nodeSet.delete(e)},r.prototype.removeSingleNode=function(e){this.singleNodeSet&&this.singleNodeSet.delete(e)},r.prototype.isEmpty=function(){return!(this.nodeSet&&0!==this.nodeSet.size||this.singleNodeSet&&0!==this.singleNodeSet.size)};var n=function(e){this.macroNode=e,this.idPath=null,this.nextNode=null,this.active=!1,this.single=!1,this.started=!1};function s(e,t){var i;if(e&&t)if(e.children.length<t.parents.length){for(i=0;i<e.children.length;i++)if(e.children[i]===t)return!0}else for(i=0;i<t.parents.length;i++)if(t.parents[i]===e)return!0;return!1}return n.prototype.activate=function(e,t){this.active||(this.active=!0,t?this.started||(this.idPath.count--,this.started=!0):this.idPath.count--,0===this.idPath.count&&e.onIdPathActiveCB(this.idPath.idObject))},n.prototype.deactivate=function(e){var t=this.idPath.count;this.active&&(this.active=!1,this.idPath.count++,0===t&&e.onIdPathInactiveCB(this.idPath.idObject))},t})),function(){var e="file:"!==window.location.protocol?"text!Visualization/assets/svgmode.json":null;define("DS/Visualization/GetSVGMode",[e],(function(e){var t=e&&JSON.parse(e);return{getWebGLMode:function(){return!(t&&"svg"===t.svgMode||window.v6ViewerSVGBrowserMode)}}}))}(),define("DS/Visualization/SceneGraphConverter",["DS/VisuLoaders/SceneGraphConverter"],(function(e){"use strict";return e})),define("Visualization/SceneGraphConverter",["DS/Visualization/SceneGraphConverter","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/SceneGraphConverter"),e})),define("DS/Visualization/ImageLoaders/DDS",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats"],(function(e,t){"use strict";let i=function(e,t,i,r,n){for(var s=i*r*n,a=(4-n*i%4)%4,o=s+r*a,l=new Uint8Array(e,t,s),h=new Uint8Array(o),c=0,d=0,u=0;u<r;u++){for(var p=0;p<i;p++){var f,g=l[d],m=l[++d],v=l[++d];d++,4===n&&(f=l[d],d++),h[c]=g,h[++c]=m,h[++c]=v,c++,4===n&&(h[c]=f,c++)}c+=a}return h},r=function(e){for(var t=e,i=0;!(1&t);)t>>=1,i++;return i},n=function(e,t,i,n,s,a,o){for(var l=new Int32Array(e,t,i/4),h=new Uint8Array(i),c=r(n),d=r(s),u=r(a),p=r(o),f=0;f<i/4;f++){var g=l[f];h[4*f]=(g&n)>>c,h[4*f+1]=(g&s)>>d,h[4*f+2]=(g&a)>>u,h[4*f+3]=(g&o)>>p}return h};return function(t){t.streamDDS=function(t){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}for(var r=128,n=i("DXT1"),s=i("DXT3"),a=i("DXT5"),o=0,l=0;l<t.mipmaps.length;l++)o+=t.mipmaps[l].data.length;var h=new ArrayBuffer(r+o),c=new Int32Array(h,0,32);switch(c[0]=542327876,c[1]=124,c[2]=659463,c[3]=t.image.height,c[4]=t.image.width,c[5]=65536,c[7]=t.mipmaps.length,c[19]=32,c[20]=4,t.format){case e.RGB_S3TC_DXT1_Format:c[21]=n;break;case e.RGB_S3TC_DXT3_Format:c[21]=s;break;case e.RGB_S3TC_DXT5_Format:c[21]=a;break;case e.RGBAFormat:c[20]|=1;case e.RGBFormat:c[20]|=64,c[23]=255,c[24]=65280,c[25]=16711680,c[26]=4278190080;break;default:return void console.error("ImageUtils.streamDDS(): Unsupported FourCC code: ")}c[27]=4198408;var d=new Uint8Array(h,r,o),u=0;for(l=0;l<t.mipmaps.length;l++){for(var p=t.mipmaps[l].data,f=0;f<p.length;f++)d[u+f]=p[f];u+=p.length}return h},t.parseDDS=function(t,r,s){void 0===s&&(s=!0);var a={mipmaps:[],width:0,height:0,sRGB:!1,format:null,mipmapCount:1};function o(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function l(e){var t=e[4];e[4]=e[7],e[7]=t,t=e[5],e[5]=e[6],e[6]=t}function h(e){var t=e[4];e[4]=e[5],e[5]=t}function c(e){var t=e[0];e[0]=e[6],e[6]=t,t=e[1],e[1]=e[7],e[7]=t,t=e[2],e[2]=e[4],e[4]=t,t=e[3],e[3]=e[5],e[5]=t,l(e.subarray(8,16))}function d(e){var t=e[0];e[0]=e[2],e[2]=t,t=e[1],e[1]=e[3],e[3]=t,l(e.subarray(8,16))}function u(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,l(e.subarray(8,16))}function u(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,l(e.subarray(8,16))}function p(e){var t=(4095&e[2]+256*(e[3]+256*e[4]))<<12;e[2]=255&t,e[3]=(65280&t)>>8,e[4]=(16711680&t)>>8,l(e.subarray(8,16))}function f(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}var g=o("DXT1"),m=o("DXT3"),v=o("DXT5"),_=o("DX10"),y=new Int32Array(t,0,36);if(542327876!==y[0])return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),a;var S,b=y[23],x=y[24],w=y[25],P=y[26],C=y[21];if(C===_){var M=y[32];(4&y[34]||6===y[35])&&(a.isCubemap=!0),28===M?(a.format=e.RGBAFormat,S=4):6===M&&(a.format=e.RGBFormat,S=12,a.type=e.FloatType,s=!1)}else{switch(C){case g:S=8,a.format=e.RGB_S3TC_DXT1_Format;break;case m:S=16,a.format=e.RGBA_S3TC_DXT3_Format;break;case v:S=16,a.format=e.RGBA_S3TC_DXT5_Format;break;default:if(s=!1,116===C)a.format=e.RGBAFormat,a.type=e.FloatType,S=16;else if(113==C);else if(32===y[22]&&16711680&y[23]&&65280&y[24]&&255&y[25]&&4278190080&y[26])a.format=e.RGBAFormat,S=4;else{if(!(64&y[20]))return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}(C)),a;1&y[20]?(a.format=e.RGBAFormat,S=4):(a.format=e.RGBFormat,S=3)}}var E=y[28];if(a.isCubemap=!!(512&E),a.isCubemap&&(!(1024&E)||!(2048&E)||!(4096&E)||!(8192&E)||!(16384&E)||!(32768&E)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),a}a.mipmapCount=1,131072&y[2]&&!1!==r&&(a.mipmapCount=Math.max(1,y[7])),a.width=y[4],a.height=y[3];var T=y[1]+4;C===_&&(T+=20);for(var A=a.isCubemap?6:1,D=C===g||C===m||C===v,I=0;I<A;I++){var R=a.width,O=a.height,L=R*O;D&&(L=Math.ceil(R/4)*Math.ceil(O/4)),L*=S;for(var B=0;B<a.mipmapCount;B++){var F=null;D?(T+L>t.byteLength&&console.log("dxterror"),F=new Uint8Array(t,T,L)):F=16===S||12===S?new Float32Array(t,T,L/4):0===C&&3!==S?n(t,T,L,b,x,w,P):i(t,T,R,O,S);var V={data:F,width:R,height:O};a.mipmaps.push(V),T+=L,(R/=2)<1&&(R=1),(O/=2)<1&&(O=1),L=D?Math.ceil(R/4)*Math.ceil(O/4):R*O,L*=S}}return s&&function(t,i,r,n,s){var a,o,g,m,v,_,y,S,b,x,w,P,C,M,E,T;switch(n){case e.RGB_S3TC_DXT1_Format:g=8,a=l,o=h;break;case e.RGBA_S3TC_DXT3_Format:g=16,a=c,o=d;break;case e.RGBA_S3TC_DXT5_Format:g=16,a=u,o=p;break;default:return console.error("flip dds error"),s}for(m=t,v=i,b=0;b<r&&(w=s[b].data,S=(_=Math.floor((m+3)/4))*(y=Math.floor((v+3)/4)),1!=v);++b){if(2==v)for(E=0;E<_;E++)o(w.subarray(x,E*g)),x=+g;else{for(x=0,E=1;E<=S;E++)a(w.subarray(x,E*g)),x+=g;T=g*_,M=new Uint8Array(T);for(var A=0;A<y/2;++A)P=w.subarray(A*T,(A+1)*T),C=w.subarray((y-A-1)*T,(y-A)*T),f(M,P),f(P,C),f(C,M)}(m/=2)<1&&(t=1),(v/=2)<1&&(i=1)}}(a.width,a.height,a.mipmapCount,a.format,a.mipmaps),a}}})),define("DS/Visualization/ParticlesLoader",["DS/VisuLoaders/ParticlesLoader"],(function(e){"use strict";return e})),define("Visualization/ParticlesLoader",["DS/Visualization/ParticlesLoader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/ParticlesLoader"),e})),define("DS/Visualization/UniformsLib",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";return{common:{diffuse:{type:"c",value:new e.Color(16777215)},opacity:{type:"f",value:1},colorBufferType:{type:"f",value:0},map:{type:"t",value:null},mapHDRSize:{type:"v2",value:new e.Vector4(2048,1024)},offsetBumpMap:{type:"v2",value:new e.Vector4(0,0)},repeatBumpMap:{type:"v2",value:new e.Vector4(1,1)},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},envMapExposureSpecular:{type:"f",value:1},envMapExposureDiffuse:{type:"f",value:1},envMapHDRSize:{type:"v2",value:new e.Vector4(2048,1024)},envMapHDRToMipsRatio:{type:"f",value:1},ambienceMatrix:{type:"m4",value:new e.Matrix4},flipEnvMap:{type:"f",value:1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},refractionRatioMap:{type:"t",value:null},combine:{type:"i",value:0},reflectivityEnvMap:{type:"t",value:null},morphTargetInfluences:{type:"f",value:0},renderIteration:{type:"i",value:0},mappingType:{type:"i",value:0},mappingTransformSemantic:{type:"i",value:1},mappingNormTransformation:{type:"m3",value:new e.Matrix3},mappingObjTransformation:{type:"m4",value:new e.Matrix4},mappingUVTransformation:{type:"m3",value:new e.Matrix3},invScreenSize:{type:"v2",value:new e.Vector2},aoTexture:{type:"t",value:null},aoParams:{type:"v2",value:new e.Vector2}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new e.Vector2(1,1)}},lights:{ambientLightColor:{type:"fv3",value:[],lightUniform:!0},directionalLightDirection:{type:"fv3",value:[],lightUniform:!0},directionalLightColor:{type:"fv3",value:[],lightUniform:!0},directionalIBLLightDirection:{type:"fv3",value:[],lightUniform:!0},directionalIBLLightColor:{type:"fv3",value:[],lightUniform:!0},directionalPhongLightDirection:{type:"fv3",value:[],lightUniform:!0},directionalPhongLightColor:{type:"fv3",value:[],lightUniform:!0},pointLightColor:{type:"fv3",value:[],lightUniform:!0},pointLightPosition:{type:"fv3",value:[],lightUniform:!0},pointLightDistance:{type:"fv1",value:[],lightUniform:!0},spotLightColor:{type:"fv3",value:[],lightUniform:!0},spotLightPosition:{type:"fv3",value:[],lightUniform:!0},spotLightDirection:{type:"fv3",value:[],lightUniform:!0},spotLightDistance:{type:"fv1",value:[],lightUniform:!0},spotLightAngleCos:{type:"fv1",value:[],lightUniform:!0},spotLightInnerAngleCos:{type:"fv1",value:[],lightUniform:!0},iesLightColor:{type:"fv3",value:[],lightUniform:!0},iesLightPosition:{type:"fv3",value:[],lightUniform:!0},iesLightDistance:{type:"fv1",value:[],lightUniform:!0},iesLightTexture:{type:"tv2",value:[],lightUniform:!0},matrixWorldInv:{type:"m4v",value:[],lightUniform:!0},sphereLightColor:{type:"fv3",value:[],lightUniform:!0},sphereLightPosition:{type:"fv3",value:[],lightUniform:!0},sphereLightData:{type:"fv3",value:[],lightUniform:!0},diskLightColor:{type:"fv3",value:[],lightUniform:!0},diskLightPosition:{type:"fv3",value:[],lightUniform:!0},diskLightData:{type:"fv3",value:[],lightUniform:!0},diskLightNormal:{type:"fv3",value:[],lightUniform:!0},diskLightUp:{type:"fv3",value:[],lightUniform:!0},tubeLightColor:{type:"fv3",value:[],lightUniform:!0},tubeLightPosition:{type:"fv3",value:[],lightUniform:!0},tubeLightData:{type:"fv3",value:[],lightUniform:!0},tubeLightRight:{type:"fv3",value:[],lightUniform:!0},rectangleLightColor:{type:"fv3",value:[],lightUniform:!0},rectangleLightPosition:{type:"fv3",value:[],lightUniform:!0},rectangleLightNormal:{type:"fv3",value:[],lightUniform:!0},rectangleLightUp:{type:"fv3",value:[],lightUniform:!0},rectangleLightData:{type:"fv3",value:[],lightUniform:!0},precomputedAreaTexture:{type:"t",value:null,lightUniform:!0}},clipPlanes:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:!0},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:!0},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:!0},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:!0},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:!0},polygonSize:{type:"iv4",value:[0,0,0,0],clipPlanesUniform:!0},polygonPoints:{type:"t",value:null,clipPlanesUniform:!0},extrusionPlaneU:{type:"fv3",value:[0,0,1],clipPlanesUniform:!0},extrusionPlaneV:{type:"fv3",value:[1,0,0],clipPlanesUniform:!0},cylinderClipZone:{type:"i",value:0,clipPlanesUniform:!0},cylinderCenter:{type:"v3",value:null,clipPlanesUniform:!0},cylinderAxisU:{type:"v3",value:new e.Vector3(0,0,1),clipPlanesUniform:!0},cylinderAxisV:{type:"v3",value:new e.Vector3(1,0,0),clipPlanesUniform:!0},scissorSize:{type:"iv4",value:[0,0,0,0],clipPlanesUniform:!0},scissorPoints:{type:"t",value:null,clipPlanesUniform:!0}},particle:{diffuse:{type:"c",value:new e.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null}},shadowmap:{shadowMap:{type:"tv2",value:[],shadowUniform:!0},transparentShadowMap:{type:"tv2",value:[],shadowUniform:!0},shadowMapSize:{type:"v2v",value:[],shadowUniform:!0},shadowMapNearFar:{type:"fv4",value:[],shadowUniform:!0},shadowMapCube:{type:"tcv",value:[],shadowUniform:!0},transparentShadowMapCube:{type:"tcv",value:[],shadowUniform:!0},shadowPointPosition:{type:"fv3",value:[],shadowUniform:!0},shadowCubeInfos:{type:"fv4",value:[],shadowUniform:!0},shadowMatrix:{type:"m4v",value:[],shadowUniform:!0},shadowCameraPosition:{type:"fv3",value:[],shadowUniform:!0},lowPartShadowCameraPosition:{type:"fv3",value:[],shadowUniform:!0},directionalLightColorNoIntensity:{type:"fv3",value:[],shadowUniform:!0},spotLightColorNoIntensity:{type:"fv3",value:[],shadowUniform:!0},pointLightColorNoIntensity:{type:"fv3",value:[],shadowUniform:!0}},lines:{scale:{type:"f",value:1},totalSize:{type:"f",value:0},halfWidth:{type:"f",value:.5},pixelSize:{type:"v2",value:new e.Vector2(.01,.01)},dashPattern:{type:"fv1",value:new Float32Array(2)},patternOffset:{type:"f",value:0}},postprocess:{brightness:{type:"f",value:0},crushblacks:{type:"f",value:0},burnhighlights:{type:"f",value:0},saturation:{type:"f",value:1},colorCorrection:{type:"v3",value:{x:1,y:1,z:1}}},deferred:{pickingColor:{type:"c",value:new e.Color(0)},rgbaDepth:{type:"t",value:null},highlightID:{type:"f",value:1},iHighlightColor:{type:"v4",value:new e.Vector4(0,.6,1,1)},iHighlightLineicColor:{type:"v4",value:new e.Vector4(0,1,1,1)},iHighlightIntensity:{type:"v2",value:new e.Vector2(1,-1)},positionComponent:{type:"v3",value:new e.Vector3(1,0,0)}}}})),define("DS/Visualization/Curves",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";let t={LineCurve:function(e,t){this.v1=e,this.v2=t}};return t.LineCurve.prototype=Object.create(e.Curve.prototype),t.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},t.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},t.LineCurve.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},t.QuadraticBezierCurve=function(e,t,i){this.v0=e,this.v1=t,this.v2=i},t.QuadraticBezierCurve.prototype=Object.create(e.Curve.prototype),t.QuadraticBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),new e.Vector2(i,r)},t.QuadraticBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x),r=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.CubicBezierCurve=function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r},t.CubicBezierCurve.prototype=Object.create(e.Curve.prototype),t.CubicBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new e.Vector2(i,r)},t.CubicBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.SplineCurve=function(e){this.points=null==e?[]:e},t.SplineCurve.prototype=Object.create(e.Curve.prototype),t.SplineCurve.prototype.getPoint=function(t){var i,r,n,s=new e.Vector2,a=[],o=this.points;return n=(i=(o.length-1)*t)-(r=Math.floor(i)),a[0]=0==r?r:r-1,a[1]=r,a[2]=r>o.length-2?o.length-1:r+1,a[3]=r>o.length-3?o.length-1:r+2,s.x=e.Curve.Utils.interpolate(o[a[0]].x,o[a[1]].x,o[a[2]].x,o[a[3]].x,n),s.y=e.Curve.Utils.interpolate(o[a[0]].y,o[a[1]].y,o[a[2]].y,o[a[3]].y,n),s},t.EllipseCurve=function(e,t,i,r,n,s,a){this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=r,this.aStartAngle=n,this.aEndAngle=s,this.aClockwise=a},t.EllipseCurve.prototype=Object.create(e.Curve.prototype),t.EllipseCurve.prototype.getPoint=function(t){var i=this.aEndAngle-this.aStartAngle;this.aClockwise||(t=1-t);var r=this.aStartAngle+t*i,n=this.aX+this.xRadius*Math.cos(r),s=this.aY+this.yRadius*Math.sin(r);return new e.Vector2(n,s)},t.LineCurve3=e.Curve.create((function(e,t){this.v1=e,this.v2=t}),(function(t){var i=new e.Vector3;return i.subVectors(this.v2,this.v1),i.multiplyScalar(t),i.add(this.v1),i})),t.QuadraticBezierCurve3=e.Curve.create((function(e,t,i){this.v0=e,this.v1=t,this.v2=i}),(function(t){var i,r,n;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),n=e.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z),new e.Vector3(i,r,n)})),t.CubicBezierCurve3=e.Curve.create((function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r}),(function(t){var i,r,n;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),n=e.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new e.Vector3(i,r,n)})),t.SplineCurve3=e.Curve.create((function(e){this.points=null==e?[]:e}),(function(t){var i,r,n,s=new e.Vector3,a=[],o=this.points;n=(i=(o.length-1)*t)-(r=Math.floor(i)),a[0]=0==r?r:r-1,a[1]=r,a[2]=r>o.length-2?o.length-1:r+1,a[3]=r>o.length-3?o.length-1:r+2;var l=o[a[0]],h=o[a[1]],c=o[a[2]],d=o[a[3]];return s.x=e.Curve.Utils.interpolate(l.x,h.x,c.x,d.x,n),s.y=e.Curve.Utils.interpolate(l.y,h.y,c.y,d.y,n),s.z=e.Curve.Utils.interpolate(l.z,h.z,c.z,d.z,n),s})),e.ClosedSplineCurve3=e.Curve.create((function(e){this.points=null==e?[]:e}),(function(t){var i,r,n,s=new e.Vector3,a=[],o=this.points;return n=(i=(o.length-0)*t)-(r=Math.floor(i)),r+=r>0?0:(Math.floor(Math.abs(r)/o.length)+1)*o.length,a[0]=(r-1)%o.length,a[1]=r%o.length,a[2]=(r+1)%o.length,a[3]=(r+2)%o.length,s.x=e.Curve.Utils.interpolate(o[a[0]].x,o[a[1]].x,o[a[2]].x,o[a[3]].x,n),s.y=e.Curve.Utils.interpolate(o[a[0]].y,o[a[1]].y,o[a[2]].y,o[a[3]].y,n),s.z=e.Curve.Utils.interpolate(o[a[0]].z,o[a[1]].z,o[a[2]].z,o[a[3]].z,n),s})),t.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},t.CurvePath.prototype=Object.create(e.Curve.prototype),t.CurvePath.prototype.add=function(e){this.curves.push(e)},t.CurvePath.prototype.checkConnection=function(){},t.CurvePath.prototype.closePath=function(){var t=this.curves[0].getPoint(0),i=this.curves[this.curves.length-1].getPoint(1);t.equals(i)||this.curves.push(new e.LineCurve(i,t))},t.CurvePath.prototype.getPoint=function(e){for(var t,i=e*this.getLength(),r=this.getCurveLengths(),n=0;n<r.length;){if(r[n]>=i){var s=1-(r[n]-i)/(t=this.curves[n]).getLength();return t.getPointAt(s)}n++}return null},t.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},t.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e,t=[],i=0,r=this.curves.length;for(e=0;e<r;e++)i+=this.curves[e].getLength(),t.push(i);return this.cacheLengths=t,t},t.CurvePath.prototype.getBoundingBox=function(){var t,i,r,n,s,a,o,l,h,c,d=this.getPoints();t=i=Number.NEGATIVE_INFINITY,n=s=Number.POSITIVE_INFINITY;var u=d[0]instanceof e.Vector3;for(c=u?new e.Vector3:new e.Vector2,l=0,h=d.length;l<h;l++)(o=d[l]).x>t?t=o.x:o.x<n&&(n=o.x),o.y>i?i=o.y:o.y<s&&(s=o.y),u&&(o.z>r?r=o.z:o.z<a&&(a=o.z)),c.add(o);var p={minX:n,minY:s,maxX:t,maxY:i,centroid:c.divideScalar(h)};return u&&(p.maxZ=r,p.minZ=a),p},t.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createGeometry=function(t){for(var i=new e.Geometry,r=0;r<t.length;r++)i.vertices.push(new e.Vector3(t[r].x,t[r].y,t[r].z||0));return i},t.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},t.CurvePath.prototype.getTransformedPoints=function(e,t){var i,r,n=this.getPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var i,r,n=this.getSpacedPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getWrapPoints=function(e,t){var i,r,n,s,a,o,l=this.getBoundingBox();for(i=0,r=e.length;i<r;i++){s=(n=e[i]).x,a=n.y,o=s/l.maxX,o=t.getUtoTmapping(o,s);var h=t.getPoint(o),c=t.getNormalVector(o).multiplyScalar(a);n.x=h.x+c.x,n.y=h.y+c.y}return e},t.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},t.Path=function(e){t.CurvePath.call(this),this.actions=[],e&&this.fromPoints(e)},t.Path.prototype=Object.create(t.CurvePath.prototype),t.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y)},t.Path.prototype.moveTo=function(t,i){var r=Array.prototype.slice.call(arguments);this.actions.push({action:e.PathActions.MOVE_TO,args:r})},t.Path.prototype.lineTo=function(t,i){var r=Array.prototype.slice.call(arguments),n=this.actions[this.actions.length-1].args,s=n[n.length-2],a=n[n.length-1],o=new e.LineCurve(new e.Vector2(s,a),new e.Vector2(t,i));this.curves.push(o),this.actions.push({action:e.PathActions.LINE_TO,args:r})},t.Path.prototype.quadraticCurveTo=function(t,i,r,n){var s=Array.prototype.slice.call(arguments),a=this.actions[this.actions.length-1].args,o=a[a.length-2],l=a[a.length-1],h=new e.QuadraticBezierCurve(new e.Vector2(o,l),new e.Vector2(t,i),new e.Vector2(r,n));this.curves.push(h),this.actions.push({action:e.PathActions.QUADRATIC_CURVE_TO,args:s})},t.Path.prototype.bezierCurveTo=function(t,i,r,n,s,a){var o=Array.prototype.slice.call(arguments),l=this.actions[this.actions.length-1].args,h=l[l.length-2],c=l[l.length-1],d=new e.CubicBezierCurve(new e.Vector2(h,c),new e.Vector2(t,i),new e.Vector2(r,n),new e.Vector2(s,a));this.curves.push(d),this.actions.push({action:e.PathActions.BEZIER_CURVE_TO,args:o})},t.Path.prototype.splineThru=function(t){var i=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,n=r[r.length-2],s=r[r.length-1],a=[new e.Vector2(n,s)];Array.prototype.push.apply(a,t);var o=new e.SplineCurve(a);this.curves.push(o),this.actions.push({action:e.PathActions.CSPLINE_THRU,args:i})},t.Path.prototype.arc=function(e,t,i,r,n,s){var a=this.actions[this.actions.length-1].args,o=a[a.length-2],l=a[a.length-1];this.absarc(e+o,t+l,i,r,n,s)},t.Path.prototype.absarc=function(e,t,i,r,n,s){this.absellipse(e,t,i,i,r,n,s)},t.Path.prototype.ellipse=function(e,t,i,r,n,s,a){var o=this.actions[this.actions.length-1].args,l=o[o.length-2],h=o[o.length-1];this.absellipse(e+l,t+h,i,r,n,s,a)},t.Path.prototype.absellipse=function(t,i,r,n,s,a,o){var l=Array.prototype.slice.call(arguments),h=new e.EllipseCurve(t,i,r,n,s,a,o);this.curves.push(h);var c=h.getPoint(o?1:0);l.push(c.x),l.push(c.y),this.actions.push({action:e.PathActions.ELLIPSE,args:l})},t.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);for(var i=[],r=0;r<e;r++)i.push(this.getPoint(r/e));return i},t.Path.prototype.getPoints=function(t,i){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(t,i);t=t||12;var r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b=[];for(r=0,n=this.actions.length;r<n;r++)switch(a=(s=this.actions[r]).action,o=s.args,a){case e.PathActions.MOVE_TO:case e.PathActions.LINE_TO:b.push(new e.Vector2(o[0],o[1]));break;case e.PathActions.QUADRATIC_CURVE_TO:for(l=o[2],h=o[3],u=o[0],p=o[1],b.length>0?(f=(m=b[b.length-1]).x,g=m.y):(f=(m=this.actions[r-1].args)[m.length-2],g=m[m.length-1]),v=1;v<=t;v++)_=v/t,y=e.Shape.Utils.b2(_,f,u,l),S=e.Shape.Utils.b2(_,g,p,h),b.push(new e.Vector2(y,S));break;case e.PathActions.BEZIER_CURVE_TO:for(l=o[4],h=o[5],u=o[0],p=o[1],c=o[2],d=o[3],b.length>0?(f=(m=b[b.length-1]).x,g=m.y):(f=(m=this.actions[r-1].args)[m.length-2],g=m[m.length-1]),v=1;v<=t;v++)_=v/t,y=e.Shape.Utils.b3(_,f,u,c,l),S=e.Shape.Utils.b3(_,g,p,d,h),b.push(new e.Vector2(y,S));break;case e.PathActions.CSPLINE_THRU:m=this.actions[r-1].args;var x=[new e.Vector2(m[m.length-2],m[m.length-1])],w=t*o[0].length;x=x.concat(o[0]);var P=new e.SplineCurve(x);for(v=1;v<=w;v++)b.push(P.getPointAt(v/w));break;case e.PathActions.ARC:var C=o[0],M=o[1],E=o[2],T=o[3],A=o[4],D=!!o[5],I=A-T,R=2*t;for(v=1;v<=R;v++)_=v/R,D||(_=1-_),O=T+_*I,y=C+E*Math.cos(O),S=M+E*Math.sin(O),b.push(new e.Vector2(y,S));break;case e.PathActions.ELLIPSE:C=o[0],M=o[1];var O,L=o[2],B=o[3];T=o[4],A=o[5],D=!!o[6],I=A-T,R=2*t;for(v=1;v<=R;v++)_=v/R,D||(_=1-_),O=T+_*I,y=C+L*Math.cos(O),S=M+B*Math.sin(O),b.push(new e.Vector2(y,S))}var F=b[b.length-1];return Math.abs(F.x-b[0].x)<1e-10&&Math.abs(F.y-b[0].y)<1e-10&&b.splice(b.length-1,1),i&&b.push(b[0]),b},t.Path.prototype.toShapes=function(){var i,r,n,s,a,o=[],l=new t.Path;for(i=0,r=this.actions.length;i<r;i++)a=(n=this.actions[i]).args,(s=n.action)==e.PathActions.MOVE_TO&&0!=l.actions.length&&(o.push(l),l=new t.Path),l[s].apply(l,a);if(0!=l.actions.length&&o.push(l),0==o.length)return[];var h,c,d=[],u=!e.Shape.Utils.isClockWise(o[0].getPoints());if(1==o.length)return h=o[0],(c=new e.Shape).actions=h.actions,c.curves=h.curves,d.push(c),d;if(u)for(c=new e.Shape,i=0,r=o.length;i<r;i++)h=o[i],e.Shape.Utils.isClockWise(h.getPoints())?(c.actions=h.actions,c.curves=h.curves,d.push(c),c=new e.Shape):c.holes.push(h);else{for(i=0,r=o.length;i<r;i++)h=o[i],e.Shape.Utils.isClockWise(h.getPoints())?(c&&d.push(c),(c=new e.Shape).actions=h.actions,c.curves=h.curves):c.holes.push(h);d.push(c)}return d},t})),define("DS/Visualization/OccurrencePath",["UWA/Class"],(function(e){"use strict";var t=e.extend({init:function(e){this.path=[],this.setFromArray(e)},getSize:function(){return this.path.length},getNodeName:function(e){return e<0||e>=this.path.length?null:this.path[e]},add:function(e){this.path.push(e)},setFromArray:function(e){var t;if(void 0!==e&&Array.isArray(e))for(t=0;t<e.length;t++)""!==e[t]&&this.path.push(e[t])},isEqual:function(e){var t;if(this.path.length!==e.path.length)return!1;for(t=0;t<e.path.length;t++)if(this.path[t]!==e.path[t])return!1;return!0},isIncludedIn:function(e){var t,i,r,n=!1;for(i=0;i<this.path.length;i++){for(t=this.path[i],n=!1,r=0;r<e.path.length;r++)if(t===e.path[r]){n=!0;break}if(!n)return!1}return!0}});return UWA.namespace("THREEDS/OccurrencePath",t)})),define("Visualization/OccurrencePath",["DS/Visualization/OccurrencePath","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/OccurrencePath"),e})),define("DS/Visualization/ThreeDXLoader",["DS/VisuLoaders/ThreeDXLoader"],(function(e){"use strict";return e})),define("DS/Visualization/ImplicitGeometries",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";const t=new e.Vector3;var i,r,n,s,a,o={};class l{constructor(t,i){this.origin=void 0!==t?t:new e.Vector3,this.axis=void 0!==i?i.normalize():new e.Vector3}at(t,i=void 0){return i||(i=new e.Vector3),i.copy(this.axis).multiplyScalar(t).add(this.origin)}parameter(t,i=void 0){return(i||new e.Vector3).subVectors(t,this.origin).dot(this.axis)}project(t,i=void 0){i||(i=new e.Vector3);const r=this.parameter(t,i);return this.at(r/this.axis.lengthSq(),i)}distanceToSquared(e,t=void 0){return this.project(e,t).distanceToSquared(e)}distanceTo(e,t=void 0){return Math.sqrt(this.distanceToSquared(e,t))}applyMatrix4(e){return this.origin.applyMatrix4(e),this.axis.transformDirection(e),this}clone(){return new l(this.origin,this.axis)}}o.InfiniteLine3=l,o.Line3=function(t,i){this.start=void 0!==t?t:new e.Vector3,this.end=void 0!==i?i:new e.Vector3},o.Line3.prototype={constructor:o.Line3,set:function(e,t){return this.start.copy(e),this.end.copy(t),this},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},center:function(t){return(t||new e.Vector3).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){return(t||new e.Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,i){var r=i||new e.Vector3;return this.delta(r).multiplyScalar(t).add(this.start)},closestPointToPointParameter:(i=new e.Vector3,r=new e.Vector3,function(t,n){i.subVectors(t,this.start),r.subVectors(this.end,this.start);var s=r.dot(r),a=r.dot(i)/s;return n&&(a=e.Math.clamp(a,0,1)),a}),closestPointToPoint:function(t,i,r){var n=this.closestPointToPointParameter(t,i),s=r||new e.Vector3;return this.delta(s).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)},clone:function(){return(new o.Line3).copy(this)}},o.Box2=function(t,i){this.min=void 0!==t?t:new e.Vector2(1/0,1/0),this.max=void 0!==i?i:new e.Vector2(-1/0,-1/0)},o.Box2.prototype={constructor:o.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y)}else this.makeEmpty();return this},setFromCenterAndSize:(n=new e.Vector2,function(e,t){var i=n.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}),copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y},center:function(t){return(t||new e.Vector2).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector2).subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(t){return new e.Vector2((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(t,i){return(i||new e.Vector2).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector2;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new o.Box2).copy(this)}},o.Box3=function(t,i){this.min=void 0!==t?t:new e.Vector3(1/0,1/0,1/0),this.max=void 0!==i?i:new e.Vector3(-1/0,-1/0,-1/0)},o.Box3.prototype={constructor:o.Box3,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setValues:function(e,t,i,r,n,s){this.min.x=e,this.min.y=t,this.min.z=i,this.max.x=r,this.max.y=n,this.max.z=s},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y),t.z<this.min.z?this.min.z=t.z:t.z>this.max.z&&(this.max.z=t.z)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var t=new e.Vector3;return function(e,i){var r=t.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}}(),createJSON:function(){return[this.min.x,this.min.y,this.min.z,this.max.x,this.max.y,this.max.z]},setFromJSON:function(e){this.min.set(e[0],e[1],e[2]),this.max.set(e[3],e[4],e[5])},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y&&this.max.z<=this.min.z},center:function(t){return(t||new e.Vector3).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector3).subVectors(this.max,this.min)},getArea:function(){var e=this.size();return 2*(e.x*e.y+e.x*e.z+e.y*e.z)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(t){return new e.Vector3((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},clampPoint:function(t,i){return(i||new e.Vector3).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector3;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),getBoundingSphere:function(){var t=new e.Vector3;return function(e){var i=e||new o.Sphere;return i.center=this.center(),i.radius=.5*this.size(t).length(),i}}(),isIntersectingWith:function(t,i){function r(e,t){let i=1/0,r=-1/0;for(let n=0;n<t.length;n++){const s=e.dot(t[n]);s<i&&(i=s),s>r&&(r=s)}return[i,r]}const n=t.getPoints(i).map((e=>e.clone())),s=this.getPoints();function a(e){if(e.lengthSq()<=1e-6)return!1;const t=r(e,s),i=r(e,n);return t[1]<=i[0]||i[1]<=t[0]}const o=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1),(new e.Vector3).copy(n[4]).sub(n[0]),(new e.Vector3).copy(n[2]).sub(n[0]),(new e.Vector3).copy(n[1]).sub(n[0])];for(let e=0;e<6;e++)if(a(o[e]))return!1;const l=new e.Vector3;for(let e=0;e<3;e++){l.copy(o[e]);for(let e=0;e<3;e++)if(l.cross(o[e+3]),a(l))return!1}return!0},intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:(s=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3],function(e){return s[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),s[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),s[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),s[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),s[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),s[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),s[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),s[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.makeEmpty(),this.setFromPoints(s),this}),getPoints:function(){var t=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3];return function(e){return t[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),t[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),t[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),t[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),t[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),t[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),t[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),t[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),t}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new o.Box3).copy(this)},mergeWithBox:function(e){this.expandByPoint(e.min),this.expandByPoint(e.max)},isNaN:function(){return!(!this.min.isNaN()&&!this.max.isNaN())},fromDGBoundingBoxArray:function(e){var t=this,i=e.length;if(i>1){var r=function(t){for(var r=e[0],n=1;n<i;n++){var s=e[n];r.fastBBox.min[t]>s.fastBBox.min[t]&&(r=s)}return r},n=function(t){for(var r=e[0],n=1;n<i;n++){var s=e[n];r.fastBBox.max[t]<s.fastBBox.max[t]&&(r=s)}return r},s=function(e){for(var i=r(e);t.min[e]>=i.fastBBox.min[e];)i.flagMinAttr(e),t.min[e]=Math.min(i.getMinAttr(e),t.min[e]),i=r(e)};s("x"),s("y"),s("z");var a=function(e){for(var i=n(e);t.max[e]<=i.fastBBox.max[e];)i.flagMaxAttr(e),t.max[e]=Math.max(i.getMaxAttr(e),t.max[e]),i=n(e)};a("x"),a("y"),a("z")}else if(i>0){var o=e[0];this.union(o.getRealBBox())}return this},getPlanes:function(){var t=new e.Vector3,i=new e.Vector3,r=null,n=[];return t.set(this.min.x,this.max.y,this.min.z),i.set(this.min.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.min.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,t,i),n.push(r),i.set(this.min.x,this.max.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.max.y,this.min.z),i.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),i.set(this.min.x,this.max.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,t,i),n.push(r),t.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),n}},o.DGBoundingBoxArray=class{constructor(e){this.fastBBox=e.fastBBox.clone(),this._realBBox=e.fastBBox.singlePoint()?e.fastBBox.clone():null,this.matrix=e.matrix.clone(),this.renderable=e.renderable,this.obj=[]}computeFunction(){for(var t=new e.Box3,i=0;i<this.obj.length;i++){var r=this.obj[i]._computeOrientedBoundingBox(this.matrix,-1,0,!1,null,null,0);t.union(r)}this._realBBox=t}getRealBBox(){return null===this._realBBox&&this.computeFunction(),this._realBBox}getMinAttr(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.min[e]}getMaxAttr(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.max[e]}flagMaxAttr(e){this.fastBBox.max[e]=-1/0}flagMinAttr(e){this.fastBBox.min[e]=1/0}addDG(e){this.obj.push(e)}setDGs(e){this.obj=e}empty(){return 0===this.obj.length}},o.Sphere=function(t,i){this.center=void 0!==t?t:new e.Vector3,this.radius=void 0!==i?i:0,this.pixelRadius=0},o.Sphere.prototype={constructor:o.Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setSimple:function(e,t,i,r){return this.center.set(e,t,i),this.radius=r,this.pixelRadius=0,this},reset:function(){return this.setSimple(0,0,0,0)},createJSON:function(){return[this.center.x,this.center.y,this.center.z,this.radius]},setFromJSON:function(e){this.center.set(e[0],e[1],e[2]),this.radius=e[3]},setFromCenterAndPoints:function(e,t){for(var i=0,r=0,n=t.length;r<n;r++){var s=e.distanceToSquared(t[r]);i=Math.max(i,s)}return this.center=e,this.radius=Math.sqrt(i),this},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this.pixelRadius=e.pixelRadius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius+1e-6},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},containsSphere:function(e){return this.center.distanceTo(e.center)<=this.radius-e.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsLine:function(e){var t=e[1].clone().sub(e[0]),i=this.center.clone().sub(e[0]),r=t.dot(i),n=t.dot(t),s=e[0].clone().add(t.clone().multiplyScalar(r/n));if(!this.containsPoint(s))return!1;var a=s.sub(e[0]).dot(t);return a>=0&&a<=n},intersectsTriangle:function(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])},clampPoint:function(t,i){var r=this.center.distanceToSquared(t),n=i||new e.Vector3;return n.copy(t),r>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n},getBoundingBox:function(t){var i=t||new e.Box3;return i.set(this.center,this.center),i.expandByScalar(this.radius),i},applyMatrix4:function(e){return e&&(this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis()),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius},clone:function(){return(new o.Sphere).copy(this)},mergeWithSphere:function(e,t){var i,r,n;this.radius<e.radius?(i=this,r=e):(i=e,r=this);var s,a=r.center.distanceTo(i.center),o=Math.max(e.pixelRadius,this.pixelRadius);a+i.radius<=r.radius?t.copy(r):(s=((n=.5*(i.radius+r.radius+a))-r.radius)/a,t.radius=n,t.center.x=s*i.center.x+(1-s)*r.center.x,t.center.y=s*i.center.y+(1-s)*r.center.y,t.center.z=s*i.center.z+(1-s)*r.center.z),t.pixelRadius=o},isNaN:function(){return!(isFinite(this.radius)&&!this.center.isNaN())},_updateRatio:function(t){0!==t&&(this.pixelRadius+=this.center.length()*t,this.set(new e.Vector3,this.radius+this.center.length()),this.radius*=t,this.pixelRadius=Math.max(this.pixelRadius,this.radius),this.radius=0)}},o.BoundingSphere=function(e,t,i){o.Sphere.call(this,e,t),this.state=0,i&&this.setState(i)},o.BoundingSphere.prototype=Object.create(o.Sphere.prototype),o.BoundingSphere.prototype.states=["EMPTY","NORMAL","INFINITE"],o.BoundingSphere.prototype.setState=function(e){this.state=this.states.indexOf(e)},o.BoundingSphere.prototype.getState=function(){return this.states[this.state]},o.Triangle=function(t,i,r){this.a=void 0!==t?t:new e.Vector3,this.b=void 0!==i?i:new e.Vector3,this.c=void 0!==r?r:new e.Vector3},o.Triangle.normal=(a=new e.Vector3,function(t,i,r,n){var s=n||new e.Vector3;s.subVectors(r,i),a.subVectors(t,i),s.cross(a);var o=s.lengthSq();return o>0?s.multiplyScalar(1/Math.sqrt(o)):s.set(0,0,0)}),o.Triangle.barycoordFromPoint=function(){var t=new e.Vector3,i=new e.Vector3,r=new e.Vector3;return function(n,s,a,o,l){t.subVectors(o,s),i.subVectors(a,s),r.subVectors(n,s);var h=t.dot(t),c=t.dot(i),d=t.dot(r),u=i.dot(i),p=i.dot(r),f=h*u-c*c,g=l||new e.Vector3;if(0==f)return g.set(-2,-1,-1);var m=1/f,v=(u*d-c*p)*m,_=(h*p-c*d)*m;return g.set(1-v-_,_,v)}}(),o.Triangle.containsPoint=function(){var t=new e.Vector3;return function(e,i,r,n){var s=o.Triangle.barycoordFromPoint(e,i,r,n,t);return s.x>=0&&s.y>=0&&s.x+s.y<=1}}(),o.Triangle.prototype={constructor:o.Triangle,set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var t=new e.Vector3,i=new e.Vector3;return function(){return t.subVectors(this.c,this.b),i.subVectors(this.a,this.b),.5*t.cross(i).length()}}(),midpoint:function(t){return(t||new e.Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return o.Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new o.Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return o.Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return o.Triangle.containsPoint(e,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)},clone:function(){return(new o.Triangle).copy(this)}},o.Spline=function(t){this.points=t;var i,r,n,s,a,o,l,h,c,d=[],u={x:0,y:0,z:0};function p(e,t,i,r,n,s,a){var o=.5*(i-e),l=.5*(r-t);return(2*(t-i)+o+l)*a+(-3*(t-i)-2*o-l)*s+o*n+t}this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return i=(this.points.length-1)*e,r=Math.floor(i),n=i-r,d[0]=0===r?r:r-1,d[1]=r,d[2]=r>this.points.length-2?this.points.length-1:r+1,d[3]=r>this.points.length-3?this.points.length-1:r+2,o=this.points[d[0]],l=this.points[d[1]],h=this.points[d[2]],c=this.points[d[3]],a=n*(s=n*n),u.x=p(o.x,l.x,h.x,c.x,n,s,a),u.y=p(o.y,l.y,h.y,c.y,n,s,a),u.z=p(o.z,l.z,h.z,c.z,n,s,a),u},this.getControlPointsArray=function(){var e,t,i=this.points.length,r=[];for(e=0;e<i;e++)t=this.points[e],r[e]=[t.x,t.y,t.z];return r},this.getLength=function(t){var i,r,n,s,a=0,o=0,l=0,h=new e.Vector3,c=new e.Vector3,d=[],u=0;for(d[0]=0,t||(t=100),n=this.points.length*t,h.copy(this.points[0]),i=1;i<n;i++)r=i/n,s=this.getPoint(r),c.copy(s),u+=c.distanceTo(h),h.copy(s),a=(this.points.length-1)*r,(o=Math.floor(a))!=l&&(d[o]=u,l=o);return d[d.length]=u,{chunks:d,total:u}},this.reparametrizeByArcLength=function(t){var i,r,n,s,a,o,l,h,c=[],d=new e.Vector3,u=this.getLength();for(c.push(d.copy(this.points[0]).clone()),i=1;i<this.points.length;i++){for(o=u.chunks[i]-u.chunks[i-1],l=Math.ceil(t*o/u.total),s=(i-1)/(this.points.length-1),a=i/(this.points.length-1),r=1;r<l-1;r++)n=s+r*(1/l)*(a-s),h=this.getPoint(n),c.push(d.copy(h).clone());c.push(d.copy(this.points[i]).clone())}this.points=c}},o.Plane=function(t,i){this.normal=void 0!==t?t:new e.Vector3(1,0,0),this.constant=void 0!==i?i:0},o.Plane.prototype={constructor:o.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var t=new e.Vector3,i=new e.Vector3;return function(e,r,n){var s=t.subVectors(n,r).cross(i.subVectors(e,r)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}}(),copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToPointSquared:function(e){const t=this.distanceToPoint(e);return t*t},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(t,i){var r=this.distanceToPoint(t);return(i||new e.Vector3).copy(this.normal).multiplyScalar(r)},isIntersectionLine:function(e){var t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectLine:function(){var t=new e.Vector3;return function(i,r){var n=r||new e.Vector3,s=i.delta(t),a=this.normal.dot(s);if(0==a)return 0==this.distanceToPoint(i.start)?n.copy(i.start):void 0;var o=-(i.start.dot(this.normal)+this.constant)/a;return o<0||o>1?void 0:n.copy(s).multiplyScalar(o).add(i.start)}}(),containsPoint(e,t=1e-9){return this.distanceToPointSquared(e)<t},containsInfiniteLine(e,t=1e-9){return this.normal.dot(e.axis)<t&&this.containsPoint(e.origin,t)},containsPlane(e,t=1e-9){return Math.abs(this.normal.dot(e.normal))>1-t&&e.containsPoint(this.coplanarPoint())},coplanarPoint:function(t){return(t||new e.Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var t=new e.Vector3,i=new e.Vector3;return function(r,n){n=n||(new e.Matrix3).getInverse(r).transpose();var s=t.copy(this.normal).applyMatrix3(n),a=this.coplanarPoint(i);return a.applyMatrix4(r),this.setFromNormalAndCoplanarPoint(s,a),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant==this.constant},clone:function(){return(new o.Plane).copy(this)}};class h{constructor(){}performFrustumCulling(e,t,i){return!0}_performFastFrustumCulling(e,t,i){return!0}}o.Frustum=class extends h{constructor(e,t,i,r,n,s){super(),this.planes=[void 0!==e?e:new o.Plane,void 0!==t?t:new o.Plane,void 0!==i?i:new o.Plane,void 0!==r?r:new o.Plane,void 0!==n?n:new o.Plane,void 0!==s?s:new o.Plane],this.radius=0,this.center=null}set(e,t,i,r,n,s){var a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(r),a[4].copy(n),a[5].copy(s),this}copy(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromMatrix(t,i){i=void 0!==i?i:e.WebGPU;var r=this.planes,n=t.elements,s=n[0],a=n[1],o=n[2],l=n[3],h=n[4],c=n[5],d=n[6],u=n[7],p=n[8],f=n[9],g=n[10],m=n[11],v=n[12],_=n[13],y=n[14],S=n[15];return r[0].setComponents(l-s,u-h,m-p,S-v).normalize(),r[1].setComponents(l+s,u+h,m+p,S+v).normalize(),r[2].setComponents(l+a,u+c,m+f,S+_).normalize(),r[3].setComponents(l-a,u-c,m-f,S-_).normalize(),r[4].setComponents(l-o,u-d,m-g,S-y).normalize(),i?r[5].setComponents(o,d,g,y).normalize():r[5].setComponents(l+o,u+d,m+g,S+y).normalize(),this}setFromCamera(e){return e.getFrustum(this),this}setFromCameraWithViewMatrix(e){return e.getFrustumWithView(this),this}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const r=t[i];if(_vector.x=r.normal.x>0?e.max.x:e.min.x,_vector.y=r.normal.y>0?e.max.y:e.min.y,_vector.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(_vector)<0)return!1}return!0}intersectsSphere(e){for(var t=this.planes,i=e.center,r=-e.radius,n=0;n<6;n++){if(t[n].distanceToPoint(i)<r)return!1}return!0}containsSphere(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e.center)-e.radius<0)return!1;return!0}containsPoint(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return(new o.Frustum).copy(this)}computeOutcode(e){var t=0;return e.dot(this.planes[0].normal)+this.planes[0].constant<0&&(t|=1),e.dot(this.planes[1].normal)+this.planes[1].constant<0&&(t|=2),e.dot(this.planes[2].normal)+this.planes[2].constant<0&&(t|=4),e.dot(this.planes[3].normal)+this.planes[3].constant<0&&(t|=8),e.dot(this.planes[4].normal)+this.planes[4].constant<0&&(t|=16),e.dot(this.planes[5].normal)+this.planes[5].constant<0&&(t|=32),t}intersectsLine(t){var i=[],r=[new e.Vector3,new e.Vector3];r[0].copy(t[0]),r[1].copy(t[1]),i[0]=this.computeOutcode(r[0]),i[1]=this.computeOutcode(r[1]);for(var n=0;n<4;n++){if(0===i[0]||0===i[1])return!0;if(0!=(i[0]&i[1]))break;var s=new e.Vector3(r[0].x-r[1].x,r[0].y-r[1].y,r[0].z-r[1].z),a=0,o=null;1&i[0]?o=this.planes[0]:2&i[0]?o=this.planes[1]:4&i[0]?o=this.planes[2]:8&i[0]?o=this.planes[3]:16&i[0]?o=this.planes[4]:32&i[0]&&(o=this.planes[5]),o&&(a=-(r[0].dot(o.normal)+o.constant)/s.dot(o.normal)),r[0].add(s.multiplyScalar(a)),i[0]=this.computeOutcode(r[0])}return!1}intersectsTriangle(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])}intersectsObject(e,i,r){var n=this.planes,s=e._getMMMatrix(),a=e.geometry.boundingSphere,o=-a.radius*s.getMaxScaleOnAxis(),l=t;null!==a?l.copy(a.center):l.set(0,0,0),l.applyMatrix4(s);for(var h=0;h<6;h++)if(n[h].distanceToPoint(l)<=o)return!1;return!0}_performFastFrustumCulling(e,t,i){var r=this.radius+e;return t.distanceToSquared(this.center)<=r*r}performFrustumCulling(e,t,i){for(var r=this.planes,n=-e,s=null,a=null,o=0;o<6;o++)if((a=(s=r[o]).normal).x*t.x+a.y*t.y+a.z*t.z+s.constant<=n)return!1;return!0}performFrustumCullingNoNearFar(e,t){for(var i=this.planes,r=-e,n=null,s=null,a=0;a<4;a++)if((s=(n=i[a]).normal).x*t.x+s.y*t.y+s.z*t.z+n.constant<=r)return!1;return!0}_updateSphere(){for(var t=this.getCorners(),i=0;i<t.length;i++)t[i]=(new e.Vector3).copy(t[i]);var r=(new o.Box3).setFromPoints(t).getBoundingSphere();this.radius=r.radius,this.center=r.center}getCorners(){var t=[],i=new e.Matrix4,r=new e.Matrix4,n=this;function s(t,s,a){var o=n.planes[t],l=n.planes[s],h=n.planes[a];i.set(o.normal.x,o.normal.y,o.normal.z,0,l.normal.x,l.normal.y,l.normal.z,0,h.normal.x,h.normal.y,h.normal.z,0,0,0,0,1),r.getInverse(i);var c=(new e.Vector4).set(-o.constant,-l.constant,-h.constant,1);return c.applyMatrix4(r),c}return t[0]=s(1,2,5),t[1]=s(0,2,5),t[2]=s(0,3,5),t[3]=s(1,3,5),t[4]=s(1,2,4),t[5]=s(0,2,4),t[6]=s(0,3,4),t[7]=s(1,3,4),t}intersectsObject(e,i,r){var n=this.planes,s=e._getMMMatrix(),a=e.geometry.boundingSphere,o=-a.radius*s.getMaxScaleOnAxis(),l=t;null!==a?l.copy(a.center):l.set(0,0,0),l.applyMatrix4(s);for(var h=0;h<6;h++)if(n[h].distanceToPoint(l)<=o)return!1;return!0}};return o.FrustumWithClippingPlanes=class extends h{constructor(e,t,i){super(),this.frustum=e,this.resetClippingStatusFrame=t,this.hasCapping=i}performFrustumCulling(e,t,i){return i.getClippingVisible(this.resetClippingStatusFrame,this.hasCapping,e,t)&&this.frustum.performFrustumCulling(e,t,i)}_performFastFrustumCulling(e,t,i){return i.getClippingVisible(this.resetClippingStatusFrame,this.hasCapping,e,t)&&this.frustum._performFastFrustumCulling(e,t,i)}},o.Face4=function(t,i,r,n,s,a,o){this.a=t,this.b=i,this.c=r,this.d=n,this.normal=s instanceof e.Vector3?s:new e.Vector3,this.vertexNormals=s instanceof Array?s:[],this.color=a instanceof e.Color?a:new e.Color,this.vertexColors=a instanceof Array?a:[],this.vertexTangents=[],this.materialIndex=void 0!==o?o:0,this.centroid=new e.Vector3},o.Face4.prototype={constructor:o.Face4,clone:function(){var e,t,i=new o.Face4(this.a,this.b,this.c,this.d);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},o.Face3=function(t,i,r,n,s,a){this.a=t,this.b=i,this.c=r,this.normal=n instanceof e.Vector3?n:new e.Vector3,this.vertexNormals=n instanceof Array?n:[],this.color=s instanceof e.Color?s:new e.Color,this.vertexColors=s instanceof Array?s:[],this.vertexTangents=[],this.materialIndex=void 0!==a?a:0,this.centroid=new e.Vector3},o.Face3.prototype={constructor:o.Face3,clone:function(){var e,t,i=new o.Face3(this.a,this.b,this.c);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},o.mergeBoundingSphereInto=function(e,t,i,r){if(t&&!t.isNaN()){var n=t.clone();r&&n._updateRatio(r),i&&n.applyMatrix4(i),e?e.mergeWithSphere(n,e):e=n}return e},o.mergeBoundingBoxInto=function(t,i,r,n){if(i&&!i.isNaN()){var s=i.clone();n&&(s.max=new e.Vector3(0,0,0),s.min=new e.Vector3(0,0,0)),r&&s.applyMatrix4(r),t?t.mergeWithBox(s):t=s}return t},o})),define("DS/Visualization/OcclusionShaders",[],(function(){"use strict";const e="\n            struct CbConstants {\n                world: mat4x4f,\n                view: mat4x4f,\n                proj: mat4x4f,\n\n                near: f32,\n                far: f32,\n                boxCount: u32,\n                wordCount: u32,\n            };\n            struct BoundingBox {\n                minX: f32, minY: f32, minZ: f32,\n                maxX: f32, maxY: f32, maxZ: f32,\n            };\n            struct BoundingBox3f {\n                min: vec3f,\n                max: vec3f,\n            };\n            struct Vertex {\n                pos: vec3f,\n                normal: vec3f\n            };\n        ",t="\n            fn generateUnitCube(vertexIndex: u32) -> Vertex {\n                let tri = vertexIndex / 3u;\n                let idx = vertexIndex % 3u;\n                let face = tri / 2u;\n                let top = tri % 2u;\n\n                let dir = face % 3u;\n                let pos = face / 3u;\n\n                let nz = dir >> 1u;\n                let ny = dir & 1u;\n                let nx = 1u ^ (ny | nz);\n\n                let d = vec3f(f32(nx), f32(ny), f32(nz));\n                let flip = 1.0 - 2.0 * f32(pos);\n\n                let n = flip * d;\n                let u = -d.yzx;\n                let v = flip * d.zxy;\n\n                let mirror = -1.0 + 2.0 * f32(top);\n                let xyz = n + mirror * (1.0 - 2.0 * f32(idx & 1u)) * u + mirror * (1.0 - 2.0 * f32(idx >> 1u)) * v;\n\n                var out: Vertex;\n                out.pos = xyz;\n                out.normal = n;\n                return out;\n            }\n        ",i="\n            fn inflateToBBox(xyz: vec3f, bbox: BoundingBox) -> vec3f {\n                let bboxMin = vec3f(bbox.minX, bbox.minY, bbox.minZ);\n                let bboxMax = vec3f(bbox.maxX, bbox.maxY, bbox.maxZ);\n                let bboxSize = (bboxMax - bboxMin) * 0.5;\n                let bboxCenter = (bboxMin + bboxMax) * 0.5;\n                return (xyz * bboxSize) + bboxCenter;\n            }\n        ";return{DepthDownsample_CS:function(){return"\n                    @group(0) @binding(0) var txSrc: texture_depth_2d;\n                    @group(0) @binding(1) var txDst: texture_storage_2d<r32float, write>;\n\n                    @compute @workgroup_size(8, 8)\n                    fn main(@builtin(global_invocation_id) GlobalInvocationID: vec3u) {\n\n                        // 1 thread per dst pixel\n                        let dstPixel = GlobalInvocationID.xy;\n                        let txSize = textureDimensions(txDst);\n\n                        if (any(dstPixel >= txSize)) {\n                            return;\n                        }\n\n                        let srcBasePixel = vec2i(dstPixel * 2u);\n                        var value = textureLoad(txSrc, srcBasePixel, 0);\n            \n                        let srcIsOdd = vec2i(textureDimensions(txSrc) & vec2u(1));\n                        let isLastColRow = vec2i(dstPixel >= txSize - vec2u(1));\n                        let needExtraSample = vec2<bool>(srcIsOdd * isLastColRow);\n            \n                        // unrolled depth sampling\n                        value = max(textureLoad(txSrc, srcBasePixel + vec2i(1, 0), 0), value);\n                        value = max(textureLoad(txSrc, srcBasePixel + vec2i(0, 1), 0), value);\n                        value = max(textureLoad(txSrc, srcBasePixel + vec2i(1, 1), 0), value);\n\n                        if (needExtraSample.x) {\n                            value = max(textureLoad(txSrc, srcBasePixel + vec2i(2, 0), 0), value);\n                            value = max(textureLoad(txSrc, srcBasePixel + vec2i(2, 1), 0), value);\n                        }\n                        if (needExtraSample.y) {\n                            value = max(textureLoad(txSrc, srcBasePixel + vec2i(0, 2), 0), value);\n                            value = max(textureLoad(txSrc, srcBasePixel + vec2i(1, 2), 0), value);\n                        }\n                        if (needExtraSample.x && needExtraSample.y) {\n                            value = max(textureLoad(txSrc, srcBasePixel + vec2i(2, 2), 0), value);\n                        }\n                        textureStore(txDst, dstPixel, vec4f(value, 0.0, 0.0, 1.0));\n                    }\n                ".split("\n").map((e=>e.trim())).join("\n")},VisibilityReset_CS:function(){return`\n                    ${e}\n                    \n            fn transformAABB(bbox: BoundingBox, transform: mat4x4f) -> BoundingBox3f {\n                let mx = transform[0].xyz;\n                let my = transform[1].xyz;\n                let mz = transform[2].xyz;\n                let t  = transform[3].xyz;\n\n                let xa = mx * bbox.minX;\n                let xb = mx * bbox.maxX;\n                let ya = my * bbox.minY;\n                let yb = my * bbox.maxY;\n                let za = mz * bbox.minZ;\n                let zb = mz * bbox.maxZ;\n\n                let bbMin = min(xa, xb) + min(ya, yb) + min(za, zb) + t;\n                let bbMax = max(xa, xb) + max(ya, yb) + max(za, zb) + t;\n                return BoundingBox3f(bbMin, bbMax);\n            }\n        \n\n                    @group(0) @binding(0) var<uniform> cbConstants: CbConstants;\n                    @group(0) @binding(1) var<storage, read> bfObjectAABBs : array<BoundingBox>;\n                    @group(0) @binding(2) var<storage, read> bfWorldMatrices : array<mat4x4f>;\n                    @group(0) @binding(3) var<storage, read_write> bfVisibility : array<u32>;\n\n                    @compute @workgroup_size(64, 1, 1)\n                    fn main(@builtin(global_invocation_id) GlobalInvocationID: vec3u) {\n\n                        // 1 thread per bounding box\n                        let boxIndex = GlobalInvocationID.x;\n                        if (boxIndex >= cbConstants.boxCount) {\n                            return;\n                        }\n\n                        let bbox = bfObjectAABBs[boxIndex];\n                        let bboxMin = vec3f(bbox.minX, bbox.minY, bbox.minZ);\n                        let bboxMax = vec3f(bbox.maxX, bbox.maxY, bbox.maxZ);\n                        let bboxCenter = (bboxMin + bboxMax) * 0.5;\n                        let bboxSize = (bboxMax - bboxMin) * 0.5;\n\n                        let allCenterNull = all(abs(bboxCenter) < vec3f(1e-5));\n                        let allSizeNull = all(abs(bboxSize) < vec3f(1e-5));\n\n                        // early accept if bbox is degenerated\n                        if (allCenterNull && allSizeNull) {\n                            bfVisibility[boxIndex] = 1;\n                            return;\n                        }\n\n                        let worldView = cbConstants.view * bfWorldMatrices[boxIndex];\n                        let bbView = transformAABB(bbox, worldView);\n\n                        // early accept if bbox is crossing near plane\n                        if (bbView.max.z >= -cbConstants.near) {\n                            bfVisibility[boxIndex] = 1;\n                            return;\n                        }\n\n                        // otherwise reset to 0 (occluded by default)\n                        bfVisibility[boxIndex] = 0;\n                    }\n                `.split("\n").map((e=>e.trim())).join("\n")},OcclusionTest_VS:function(){return`\n                    ${e}\n                    ${t}\n                    ${i}\n\n                    struct VertexIn {\n                        @builtin(vertex_index) vertexIndex: u32,\n                        @builtin(instance_index) instanceIndex : u32,\n                    };\n                    struct VertexOut {\n                        @builtin(position) pos: vec4f,\n                        @location(0) @interpolate(flat) boxIndex: u32\n                    };\n\n                    @group(0) @binding(0) var<uniform> cbConstants: CbConstants;\n                    @group(0) @binding(1) var<storage, read> bfObjectAABBs : array<BoundingBox>;\n                    @group(0) @binding(2) var<storage, read> bfWorldMatrices : array<mat4x4f>;\n\n                    @vertex\n                    fn main(in: VertexIn) -> VertexOut {\n                        var out: VertexOut;\n                        // generate unit cube vertex\n                        let unitVertex = generateUnitCube(in.vertexIndex);\n                        // inflate vertex to fit the object AABB\n                        let bbox = bfObjectAABBs[in.instanceIndex];\n                        let bboxVertex = inflateToBBox(unitVertex.pos, bbox);\n                        // apply world/view/proj transformations a usual\n                        let worldMatrix = bfWorldMatrices[in.instanceIndex];\n                        out.pos = cbConstants.proj * cbConstants.view * worldMatrix * vec4f(bboxVertex, 1.0);\n                        // pass box index to fragment shader\n                        out.boxIndex = in.instanceIndex;\n                        return out;\n                    }\n                `.split("\n").map((e=>e.trim())).join("\n")},OcclusionTest_FS:function(){return"\n                    struct FragmentIn {\n                        @builtin(position) fragCoord: vec4f,\n                        @location(0) @interpolate(flat) boxIndex: u32,\n                    };\n\n                    @group(0) @binding(3) var<storage, read_write> bfVisibility : array<u32>;\n                    @group(0) @binding(4) var txWorkingDepth: texture_2d<f32>;\n\n                    @fragment\n                    fn main(in: FragmentIn) {\n                        let pixel = vec2i(in.fragCoord.xy);\n                        let boxDepth = in.fragCoord.z - 0.0001; // small depth bias\n                        let sceneDepth = textureLoad(txWorkingDepth, pixel, 0).x;\n\n                        if (boxDepth < sceneDepth) {\n                            bfVisibility[in.boxIndex] = 1;\n                        }\n                    }\n                ".split("\n").map((e=>e.trim())).join("\n")},ResultPacking_CS:function(){return`\n                    ${e}\n\n                    @group(0) @binding(0) var<uniform> cbConstants: CbConstants;\n                    @group(0) @binding(1) var<storage, read> bfVisibility : array<u32>;\n                    @group(0) @binding(2) var<storage, read_write> bfPackedResults : array<u32>;\n\n                    @compute @workgroup_size(64, 1, 1)\n                    fn main(@builtin(global_invocation_id) GlobalInvocationID: vec3u) {\n\n                        // 1 thread per CPU word (= 32bit uint)\n                        let wordIndex = GlobalInvocationID.x;\n                        if (wordIndex >= cbConstants.wordCount) {\n                            return;\n                        }\n\n                        var word: u32 = 0u;\n                        for (var i = 0u; i < 32u; i++) {\n                            let boxIndex = 32u * wordIndex + i;\n                            if (boxIndex >= cbConstants.boxCount) {\n                                break;\n                            }\n                            word |= (bfVisibility[boxIndex] << i);\n                        }\n                        bfPackedResults[wordIndex] = word;\n                    }\n                `.split("\n").map((e=>e.trim())).join("\n")},WorkingDepthDebug_VS:function(){return"\n                    \n            fn generateFullscreenTriangle(vertexIndex: u32) -> vec2f {\n                let texCoord = vec2u((vertexIndex << 1u) & 2u, vertexIndex & 2u);\n                return 2.0 * vec2f(texCoord) - 1.0;\n            }\n        \n\n                    struct VertexIn {\n                        @builtin(vertex_index) vertexIndex: u32,\n                    };\n                    struct VertexOut {\n                        @builtin(position) pos: vec4f,\n                    };\n\n                    @vertex\n                    fn main(in: VertexIn) -> VertexOut {\n                        var out: VertexOut;\n                        let vertex = generateFullscreenTriangle(in.vertexIndex);\n                        out.pos = vec4f(vertex.xy, 0.0, 1.0);\n                        return out;\n                    }\n                ".split("\n").map((e=>e.trim())).join("\n")},WorkingDepthDebug_FS:function(){return`\n                    ${e}\n                    \n            fn linearizeDepth(depth: f32, near: f32, far: f32) -> f32 {\n                return near * far / (far - depth * (far - near)); // perspective\n                // return near + depth * (far - near); // orthographic\n            }\n        \n\n                    struct FragmentIn {\n                        @builtin(position) fragCoord: vec4f,\n                    };\n                    struct FragmentOut {\n                        @location(0) color: vec4f,\n                    };\n\n                    @group(0) @binding(0) var<uniform> cbConstants: CbConstants;\n                    @group(0) @binding(1) var txWorkingDepth: texture_2d<f32>;\n\n                    @fragment\n                    fn main(in: FragmentIn) -> FragmentOut {\n                        let pixel = vec2i(floor(in.fragCoord.xy / 2));\n                        let depth = textureLoad(txWorkingDepth, pixel, 0).x;\n\n                        var res = linearizeDepth(depth, cbConstants.near, cbConstants.far);\n                        res = saturate(res / (cbConstants.far - cbConstants.near));\n\n                        var out: FragmentOut;\n                        out.color = vec4f(res, res, res, 1.0);\n                        return out;\n                    }\n                `.split("\n").map((e=>e.trim())).join("\n")},OccludedBboxDebug_VS:function(){return`\n                    ${e}\n                    ${t}\n                    ${i}\n\n                    struct VertexIn {\n                        @builtin(vertex_index) vertexIndex: u32,\n                        @builtin(instance_index) instanceIndex : u32,\n                    };\n                    struct VertexOut {\n                        @builtin(position) pos: vec4f,\n                        @location(0) normal: vec3f,\n                    };\n\n                    @group(0) @binding(0) var<uniform> cbConstants: CbConstants;\n                    @group(0) @binding(1) var<storage, read> bfObjectAABBs : array<BoundingBox>;\n                    @group(0) @binding(2) var<storage, read> bfWorldMatrices : array<mat4x4f>;\n                    @group(0) @binding(3) var<storage, read> bfOccludedIndices : array<u32>;\n\n                    @vertex\n                    fn main(in: VertexIn) -> VertexOut {\n                        var out: VertexOut;\n                        // generate unit cube vertex\n                        let unitVertex = generateUnitCube(in.vertexIndex);\n                        // inflate the cube to fit the object AABB\n                        let bboxIndex = bfOccludedIndices[in.instanceIndex];\n                        let bbox = bfObjectAABBs[bboxIndex];\n                        let bboxVertex = inflateToBBox(unitVertex.pos, bbox);\n                        // apply world/view/proj transformations a usual\n                        let worldMatrix = bfWorldMatrices[bboxIndex];\n                        out.pos = cbConstants.proj * cbConstants.view * worldMatrix * vec4f(bboxVertex, 1.0);\n                        out.normal = (worldMatrix * vec4f(unitVertex.normal, 0.f)).xyz;\n                        return out;\n                    }\n                `.split("\n").map((e=>e.trim())).join("\n")},OccludedBboxDebug_FS:function(){return`\n                    ${e}\n\n                    struct FragmentIn {\n                        @location(0) normal: vec3f,\n                    };\n                    struct FragmentOut {\n                        @location(0) color: vec4f,\n                    };\n\n                    @group(0) @binding(0) var<uniform> cbConstants: CbConstants;\n\n                    @fragment\n                    fn main(in: FragmentIn) -> FragmentOut {\n                        var out: FragmentOut;\n                        let N = normalize(in.normal);\n                        let V = cbConstants.world[2].xyz;\n                        let fakeLighting = mix(0.5, 1.0, dot(N, V));\n                        out.color = vec4f(fakeLighting * vec3f(1, 0, 0), 0.25);\n                        return out;\n                    }\n                `.split("\n").map((e=>e.trim())).join("\n")}}})),define("DS/Visualization/PLMMaterialServicesItf",[],(function(){"use strict";var e=function(){this.implementation=null};return e.prototype.setImplementation=function(e){this.implementation=e},e.prototype.loadMaterials=function(e,t,i){this.implementation.loadMaterials(e,t,i)},e.prototype.loadMaterialConnections=function(e,t){this.implementation.loadMaterialConnections(e,t)},new e})),define("DS/Visualization/IdPathMatcher",[],(function(){"use strict";var e=function(e){this._idToNodeCB=e.idToNodeCB,this._nodeToIdCB=e.nodeToIdCB,this._isNodeRepRefCB=e.isNodeRepRefCB};return e.prototype.idToNode=function(e){return this._idToNodeCB(e)},e.prototype.nodeToId=function(e){return this._nodeToIdCB(e)},e.prototype.isNodeRepRef=function(e){return this._isNodeRepRefCB(e)},e})),define("DS/Visualization/StreamVisuLoader",["DS/VisuLoaders/StreamVisuLoader"],(function(e){"use strict";return e})),define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/StreamVisuLoader"),e})),define("DS/Visualization/UniformsUtils",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";return{merge:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=this.clone(e[t]))n[i]=r[i];return n},mergeNoClone:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=e[t])n[i]=r[i];return n},clone:function(t){var i,r,n,s={};for(i in t)for(r in s[i]={},t[i])(n=t[i][r])instanceof e.Color||n instanceof e.Vector2||n instanceof e.Vector3||n instanceof e.Vector4||n instanceof e.Matrix4?s[i][r]=n.clone():s[i][r]=n instanceof Array?n.slice():n;return s}}})),define("DS/Visualization/TaskManager",[],(function(){"use strict";class e{constructor(e,t){let i;for(this.callback=e,this.args=[],i=0;i<t.length;i++)this.args.push(t[i])}run(){this.callback.apply(null,this.args)}}var t=new class{constructor(){this.manipulations=new Set,this.tasks=[]}postponeAfterManipulation(t,i){let r=this;return function(){0===r.manipulations.size||i?t.apply(null,arguments):r.tasks.push(new e(t,arguments))}}startManipulation(e){this.manipulations.add(e)}endManipulation(e){this.manipulations.delete(e),this.runNextTask()}runNextTask(){if(0===this.manipulations.size&&this.tasks.length>0){let e=this.tasks.shift();e&&e.run(),setTimeout(this.runNextTask.bind(this),0)}}hasPendingTasks(){return this.tasks.length>0}};return t})),define("DS/Visualization/DAEReader",["DS/VisuLoaders/DAEReader"],(function(e){"use strict";return e})),define("Visualization/DAEReader",["DS/Visualization/DAEReader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/DAEReader"),e})),define("DS/Visualization/Detector",[],(function(){"use strict";return{canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!(!window.WebGLRenderingContext||!document.createElement("canvas").getContext("experimental-webgl")&&!document.createElement("canvas").getContext("webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e;return this.webgl||(e=window.WebGLRenderingContext?'Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />':'Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>',e+='Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'),e}}})),define("Visualization/Detector",["DS/Visualization/Detector","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/Detector"),e})),define("DS/Visualization/StaticOverrideSet",["DS/Mesh/MeshUtils"],(function(e){"use strict";var t=1;function i(e,i){this.id=t++,this.path=e,this.materialApplication=i}i.prototype.deactivate=function(){this.apply(!1)},i.prototype.apply=function(e){this.path.internalPath.length>0?this.apply_internal(e):this.apply_external(e)},i.prototype.apply_external=function(e){var t,i,r,n,s,a,o;if(e)for(t=this.path.externalPath[0]._occurrences,i=0;i<t.length;i++)o=(r=t[i]).depth,(n=this.path._getOccurrenceFromRootOccurrence(r))&&(s=n.matAppOverride,(a=this.materialApplication)._depth=o,s&&!a.isPrioritary(s,o)||(n.matAppOverride=a.clone()),a._depth=-1);else for(t=this.path._getOccurrences(null),i=0;i<t.length;i++)(n=t[i]).matAppOverride=null},i.prototype.apply_internal=function(t){var i,r,n=this.path.externalPath[0]._occurrences,s=this.path.getLastElement(),a=s&&s instanceof e.SGPrimitiveHelper?[s]:s.getPrimitives();for(r=0;r<n.length;r++)i=n[r],this.applyToRootOccurrence_internal(t,i,a)},i.prototype.applyToRootOccurrence_internal=function(e,t,i){var r=this.path._getOccurrenceFromRootOccurrence(t);if(r){for(var n=r._getRenderableOccurrences(),s=n.length,a=0;a<s;a++){var o=n[a];o&&o._flagAsGSSOInvalidated()}if(i){var l=e?this.materialApplication.clone():null;l&&(l._depth=t.depth);for(a=0;a<n.length;a++)this.applyToRenderable(n[a],i,l)}}},i.prototype.applyToRenderable=function(e,t,i){null===e.layer&&e.initLayers(1),e.layer.addPrimitivesToLayers(t,void 0,void 0,void 0,i)};var r=function(e){this.root=e,this._overrides=[]};return r.prototype.addStaticOverride=function(e,t){if(e.externalPath[0]===this.root){var r=new i(e,t);return this._overrides.push(r),r.id}return-1},r.prototype.clear=function(){this._deactivateStaticOverrides(),this._overrides=[]},r.prototype.applyStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!0)},r.prototype._deactivateStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!1)},r})),define("DS/Visualization/JSONReader",["DS/VisuLoaders/JSONReader"],(function(e){"use strict";return e})),define("Visualization/JSONReader",["DS/Visualization/JSONReader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/JSONReader"),e}));var __ModelLoader_prereqs=["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/SceneGraph","DS/VisuEvents/EventsManager","DS/Visualization/WorldOrientation","DS/Visualization/MaterialManager"];"file:"!==window.location.protocol&&__ModelLoader_prereqs.push("text!Visualization/assets/ambiences.json"),define("DS/Visualization/ModelLoader",__ModelLoader_prereqs,(function(e,t,i,r,n,s,a,o){"use strict";var l=e.extend({init:function(e,i){(this._viewer=null,this.fileType="xmlv43",this.geometryMode="3dxmlgeometry",this.smartLoading=!1,this.filterNavReps=!1,this.modelName="",this._internalTarget=null,this.Ox4MQLV6Loader=null,this.cgrLoader=null,this.uvrLoader=null,this.xmlv43Loader=null,this.xmlv6Loader=null,this.xmlv6SmartLoader=null,this.colladaLoader=null,this.jsonLoader=null,this.objLoader=null,this.xcadLoader=null,this.particlesLoader=null,this.streamVisuLoader=null,this.threeDXLoader=null,this.multipartMode=!1,this.CGRNewInfra=!0,this.keepLoaderMode=!1,this.expandMode=!1,this._fromOOC=!1,this.readDecoration=!1,this.primitiveWithBS=!1,this._sceneGraphOrderPriority=localStorage.getItem("sceneGraphOrder2DPriority")&&"true"===localStorage.getItem("sceneGraphOrder2DPriority"),o)&&(JSON.parse(o).sceneGraphOrder2DPriority&&(this._sceneGraphOrderPriority=!0));this.repWithBS=!1,this.withSAG=!1,this.useDefaultTCSet=!1,this.accuracyInfo={sag2D:0,sag3D:0},this.withBagUUID=!1,this.useUvrWorker=!0,this.withSceneGraph=!1,this.udlMode=!1,this.depthMode2D=!1,this.withBlanking=!1,this.sceneGraphOrderMode=0,this.smartStaticBatching=!0,this.edgeTransparency=!0,this.sharedBuffers=!0,this.noMeshInRAM=!1,this.processText=!1,this.accelStruct=!1,this.GPUPlanarFace=!1,this.materialManager=null,this.targetNode=null,this.glContext=e,this.renderer=null,this.renderCB=null;var r=this;return this._onLoadedCBInternal=function(){n.RecordEventsManager&&n.RecordEventsManager.sendSynchroPoint("ModelLoaded"),window.webVisuPerfo.endPerfo("load"),t.loadingModels=!1;const e=new Set;r.targetNode&&r.targetNode._invalidateGSSOUnder&&r.targetNode._invalidateGSSOUnder(e),r._internalTarget&&r._internalTarget._invalidateGSSOUnder&&r._internalTarget._invalidateGSSOUnder(e)},this.onLoadedCB=function(){r._onLoadedCBInternal()},this.onLoadedPrdCB=null,this.onProgressCB=null,this.onErrorCB=null,this.refreshTime=2e3,this.debugBBox=void 0!==i&&i,this.forceNoWorkerForSTEP=localStorage.getItem("NoWorkerForSTEP")?"true"===localStorage.getItem("NoWorkerForSTEP"):null,this.poolOfModels={xmlv43:{loading:!1,models:[]},xmlv6:{loading:!1,models:[]},Ox4MQLV6:{loading:!1,models:[]},OxMQLV5:{loading:!1,models:[]},cgr:{loading:!1,models:[]},streamvisu:{loading:!1,models:[]},"3dx":{loading:!1,models:[]},step:{loading:!1,models:[]}},this._Ox4ProxyAbstraction=null,this},setSceneGraph:function(e){this.targetNode=e},setOOCLoader:function(e){this._fromOOC=e},isOOCLoader:function(){return this._fromOOC},setSceneGraphOrderMode:function(e){this.sceneGraphOrderMode=e},getSceneGraphOrderMode:function(){return this.sceneGraphOrderMode},setViewer:function(e){this._viewer=e},setTargetNode:function(e){this.targetNode=e},setWebGLContext:function(e){this.glContext=e},getCGROptions:function(){return{readDeco:this.readDecoration,primWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG()||this.getUDLMode(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),fromOOC:this.isOOCLoader(),withSAG:this.withSAG,withBagUUID:this.withBagUUID,sagInfo:this.accuracyInfo,withSceneGraph:this.getCGRWithSG()||this.getUDLMode(),udlMode:this.getUDLMode(),depthMode2D:this.getDepthMode2D(),withBlanking:this.getCGRWithBlanking(),uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),processText:this.processText,GPUPlanarFace:this.GPUPlanarFace}},setRenderCallback:function(e,t){this.renderCB=e,this.refreshTime=t||2e3},setOnLoadedCallback:function(e){var t=this;this.onLoadedCB=function(i){if(t._onLoadedCBInternal(),t._internalTarget){var r=new Set,n=new Set;t._internalTarget._compactHierarchy(r,n)}t._internalTarget=null,e&&e.call(this,i)}},setOnLoadedProductStructureCallback:function(e){this.onLoadedPrdCB=e},setOnProgressCallback:function(e){this.onProgressCB=e},setOnErrorCallback:function(e){this.onErrorCB=e},activateSmartLoading:function(e){null!==e&&(this.renderer=e,this.smartLoading=!0)},deactivateSmartLoading:function(){this.smartLoading=!1},setFilterNavReps:function(e){this.filterNavReps=e},getFileType:function(){return this.fileType},setFileType:function(e){this.fileType=e},getGeometryMode:function(){return this.geometryMode},setGeometryMode:function(e){this.geometryMode=e,null!==this.xmlv6Loader&&this.xmlv6Loader.setGeometryMode(e)},getMultipartMode:function(){return this.multipartMode},setMultipartMode:function(e){this.multipartMode=e},getCGRNewInfra:function(){return this.CGRNewInfra},setKeepLoaderMode:function(e){this.cgrLoader&&this.cgrLoader.setKeepLoaderMode(e),this.keepLoaderMode=e},getKeepLoaderMode:function(){return this.keepLoaderMode},setCGRNewInfra:function(e){this.CGRNewInfra=e},setPrimitivesWithBoundingSphere:function(e){t._BinaryPrimitives||!e?this.primitiveWithBS=!!e:console.warn("Primitives must be in binary form for primitive bounding spheres")},getPrimitivesWithBoundingSphere:function(){return this.primitiveWithBS&&t._BinaryPrimitives},setRepsWithBoundingSphere:function(e){this.repWithBS=!!e},getRepsWithBoundingSphere:function(){return this.repWithBS},getCGRWithSG:function(){return this.withSceneGraph},getUDLMode:function(){return this.udlMode},getDepthMode2D:function(){return this.depthMode2D},getCGRWithBlanking:function(){return this.withBlanking},setCGRWithBlanking:function(e){this.withBlanking=e},setCGRWithSG:function(e){this.withSceneGraph=e},setUDLMode:function(e){this.udlMode=e},setDepthMode2D:function(e){this.depthMode2D=e},getCGRWithUUID:function(){return this.withBagUUID},set3DAccuracy:function(e){this.accuracyInfo.sag3D=e},setCGRWithUUID:function(e){this.withBagUUID=e},getOptimizeCurvedPipes:function(){return!1},getSceneGraphOrderPriority:function(){return!(!this._sceneGraphOrderPriority||!this.udlMode)},setOptimizeCurvedPipes:function(e){},set2DAccuracy:function(e){this.accuracyInfo.sag2D=e},getEdgeTransparency:function(){return this.edgeTransparency},setEdgeTransparency:function(e){this.edgeTransparency=e},getSharedBuffers:function(){return this.sharedBuffers},setSharedBuffers:function(e){this.sharedBuffers=e},getNoMeshInRAM:function(){return this.noMeshInRAM},setNoMeshInRAM:function(e){this.noMeshInRAM=e},getExpandMode:function(){return this.expandMode},setExpandMode:function(e){this.expandMode=e},setAccelerationStructure:function(e){this.accelStruct=e},setGPUPlanarFaces:function(e){this.GPUPlanarFace=e},enableLDH:function(e,t,i,r,n,s){var a=this;require(["DS/SelectiveLoading/SelectiveLoadingAsync"],(function(o){a.LDH=o,a.LDH.Helpers._enableLDH(a,e,t,i,n,s),void 0!==a.LDHAsyncDestruction?a.destructLDH():r&&r()}),(function(e){var t=e.requireModules&&e.requireModules[0];console.error("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB()}))},getLDHInterface:function(){return this._ldhInterface},destructLDH:function(){void 0===this.LDH?this.LDHAsyncDestruction=!0:(this.LDH.Helpers._ldhCleanup(this),delete this.LDHAsyncDestruction,delete this.LDH)},_onModuleError:function(e,t){return function(i){var r=i.requireModules&&i.requireModules[0];console.log("Module "+r+" is missing."),e&&e({url:t,type:"FORMAT"})}},_xmlv43LoaderCB:function(e){var t=this,i={isBuffer:e.isBuffer,destination:e.destination,isMultipartMode:e.cgrMultipartMode,isExpandMode:e.cgrExpandMode,isCGRNewInfra:e.cgrNewInfra,readDeco:e.readDecoration,primWithBS:e.primitiveWithBS,repWithBS:e.repWithBS,smartStaticBatching:e.smartStaticBatching,sceneGraphOrderMode:e.sceneGraphOrderMode,withSAG:e.cgrWithSAG,useDefaultTCSet:e.useDefaultTCSet,withBagUUID:e.cgrWithBagUUID,sagInfo:e.accuracyInfo,edgeTransparency:e.edgeTransparency,sharedBuffers:e.sharedBuffers,noMeshInRAM:e.noMeshInRAM,withSceneGraph:e.cgrWithSG,udlMode:e.udlMode,withBlanking:e.withBlanking,applicativeContainers:e.applicativeContainers,mode2D:e.mode2D,processText:e.processText,accelStruct:e.accelStruct,OOCSmartStaticInfo:e.OOCSmartStaticInfo,keepCompression:e.keepCompression,GPUPlanarFace:e.GPUPlanarFace,filterNavReps:e.filterNavReps,refreshTime:e.refreshTime,useUvrWorker:e.uvrWorker},r={readyCallback:function(i,r){t._viewer&&(1===r?t._viewer.setWorldOrientation(s.YUpXRight):t._viewer.setWorldOrientation(s.ZUpYRight)),e.destination.addChild(i),null!==e.loadedProductCB&&e.loadedProductCB(i),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null},doneCallback:e.loadedCB,errorCallback:e.errorCB,progressCallback:e.progressCB,loadedProductCB:e.loadedProductCB};this.xmlv43Loader.load(e.jsonSettings,r,i)},_xmlv6LoaderCB:function(e){this.xmlv6Loader.load(e.modelName,(function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!0}),e.destination=null}),e.progressCB,e.loadedCB)},_Ox4MQLV6LoaderCB:function(e){this.Ox4MQLV6Loader.load(e.jsonSettings,(function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null}),e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_OxMQLV5LoaderCB:function(e){this.OxMQLV5Loader.load(e.jsonSettings,(function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1})}),e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_cgrLoaderCB:function(e){var t={isBuffer:e.isBuffer,destination:e.destination,isMultipartMode:e.cgrMultipartMode,isExpandMode:e.cgrExpandMode,isCGRNewInfra:e.cgrNewInfra,readDeco:e.readDecoration,primWithBS:e.primitiveWithBS,repWithBS:e.repWithBS,smartStaticBatching:e.smartStaticBatching,sceneGraphOrderMode:e.sceneGraphOrderMode,fromOOC:e.fromOOC,withSAG:e.cgrWithSAG,useDefaultTCSet:e.useDefaultTCSet,withBagUUID:e.cgrWithBagUUID,sagInfo:e.accuracyInfo,edgeTransparency:e.edgeTransparency,sharedBuffers:e.sharedBuffers,noMeshInRAM:e.noMeshInRAM,withSceneGraph:e.cgrWithSG,udlMode:e.udlMode,sceneGraphOrderPriority:e.sceneGraphOrderPriority,depthMode2D:e.depthMode2D,withBlanking:e.withBlanking,applicativeContainers:e.applicativeContainers,mode2D:e.mode2D,processText:e.processText,accelStruct:e.accelStruct,linkableBagRepUUID:e.linkableBagRepUUID,OOCSmartStaticInfo:e.OOCSmartStaticInfo,keepCompression:e.keepCompression,forceNoShowCGR:e.forceNoShowCGR,GPUPlanarFace:e.GPUPlanarFace},i={readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,progressCallback:e.progressCB};this.cgrLoader.load(e.jsonSettings,i,t),e.destination=null},_streamVisuLoaderCB:function(e){this.streamVisuLoader.load(e.modelName,(function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)}),null,e.loadedCB,e.destination)},_xcadLoaderCB:function(e){var t={isBuffer:e.isBuffer,destination:e.destination},i={readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,progressCallback:e.progressCB};this.xcadLoader.load(e.jsonSettings,i,t),e.destination=null},_threeDXLoaderCB:function(e){this.threeDXLoader.setMode("3dxc"===e.fileType?"concat":"zipped"),this.threeDXLoader.setSharedBuffers(e.sharedBuffers),this.threeDXLoader.setNoMeshInRAM(e.noMeshInRAM);var t=!0,i=!1,r=!1,n=this.accelStruct,s=e.jsonSettings&&e.jsonSettings.loaderSettings;s&&(t=s.primitives,i=s.reps,r=s.ssb,n=s.accelerationStructure),this.threeDXLoader.load({url:e.modelName,primitives:t,reps:i,ssb:r,accelStruct:n,lightMapAsIrradiance:s&&s.lightMapAsIrradiance,destinationNode:e.destination,readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,gasSharing:!(!s||!s.gasSharing)})},_buildFileInfos:function(e){var t=this.buildPath(e);return this.modelName=t.serverurl?t.serverurl:"",this.modelName+=t.filename?t.filename:"",this.setFileTypeFromSpec(t),t},loadModelFromBuffer:function(e,t,i){return this.loadModel(e,t,!0,i)},loadModel:function(e,r,n,s){if(window.webVisuPerfo.startPerfo("load",-1),t.loadingModels=!0,void 0!==this.LDH&&void 0!==e.localAABox)return this.LDH.Helpers._onLoadModel(this,e,r,n);var a=this,o=null,l=void 0!==r?r:a.targetNode;if(null===l)return!1;(n=void 0!==n&&n)||(o=this._buildFileInfos(e)),this._internalTarget=l;var h={modelName:this.modelName,fileType:this.fileType,jsonSettings:o,destination:l,isBuffer:n,geometryMode:this.geometryMode,renderCB:this.renderCB,loadedProductCB:this.onLoadedPrdCB,progressCB:this.onProgressCB,loadedCB:this.onLoadedCB,errorCB:this.onErrorCB,filterNavReps:this.filterNavReps,refreshTime:this.refreshTime,readDecoration:this.readDecoration,cgrNewInfra:this.getCGRNewInfra(),primitiveWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG()||this.getUDLMode(),udlMode:this.getUDLMode(),depthMode2D:this.getDepthMode2D(),sceneGraphOrderPriority:this.getSceneGraphOrderPriority(),withBlanking:this.getCGRWithBlanking(),useDefaultTCSet:this.useDefaultTCSet,sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),fromOOC:this.isOOCLoader(),cgrWithSAG:this.withSAG,cgrWithBagUUID:this.withBagUUID,accuracyInfo:this.accuracyInfo,uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),waitMaterial:this.waitMaterial,processText:this.processText,accelStruct:this.accelStruct,GPUPlanarFace:this.GPUPlanarFace,applicativeContainers:s&&s.applicativeContainers?s.applicativeContainers:null,linkableBagRepUUID:s&&s.linkableBagRepUUID?s.linkableBagRepUUID:null,OOCSmartStaticInfo:s&&s.OOCSmartStaticInfo?s.OOCSmartStaticInfo:null,mode2D:!(!s||!s.mode2D)&&s.mode2D,keepCompression:!(!s||!s.keepCompression)&&s.keepCompression,forceNoShowCGR:!(!s||!s.forceNoShowCGR)&&s.forceNoShowCGR};if("xmlv43"===this.fileType){if(n)return!1;if(this.xmlv43Loader)this._xmlv43LoaderCB(h);else if(this.poolOfModels.xmlv43.models.push(h),!this.poolOfModels.xmlv43.loading){this.poolOfModels.xmlv43.loading=!0;var c=["DS/VisuLoaders/XMLV43Loader"];require(c,(function(e){a.poolOfModels.xmlv43.loading=!1,a.xmlv43Loader=new e(a.glContext,a.renderCB);for(var t=a.poolOfModels.xmlv43.models,i=0;i<t.length;i++)a._xmlv43LoaderCB(t[i]);a.poolOfModels.xmlv43.models=[]}),this._onModuleError(h.errorCB,h.modelName))}}else if("xmlv6"===this.fileType){if(n)return!1;this.xmlv6Loader?this._xmlv6LoaderCB(h):(this.poolOfModels.xmlv6.models.push(h),this.poolOfModels.xmlv6.loading||(this.poolOfModels.xmlv6.loading=!0,require(["DS/VisuLoaders/XMLV6Loader","DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],(function(e,t){a.poolOfModels.xmlv6.loading=!1,a.xmlv6Loader=new e(a.glContext,a.renderCB,a.debugBBox,a.geometryMode),a.smartLoading&&null===a.xmlv6SmartLoader?(a.xmlv6SmartLoader=new t(a.xmlv6Loader),a.xmlv6SmartLoader.enabled=!0,a.xmlv6SmartLoader.renderTarget=null,a.renderer.addPrePlugin(a.xmlv6SmartLoader)):a.smartLoading||null===a.xmlv6SmartLoader?null!==a.xmlv6SmartLoader&&(a.xmlv6SmartLoader.enabled=!0):a.xmlv6SmartLoader.enabled=!1;for(var i=a.poolOfModels.xmlv6.models,r=0;r<i.length;r++)a._xmlv6LoaderCB(i[r]);a.poolOfModels.xmlv6.models=[]}),this._onModuleError(h.errorCB,h.modelName))))}else if("Ox4MQLV6"==this.fileType)this.Ox4MQLV6Loader?(i.setProxyFromSpec(h.jsonSettings,this._Ox4ProxyAbstraction),this._Ox4MQLV6LoaderCB(h)):(this.poolOfModels.Ox4MQLV6.models.push(h),this.poolOfModels.Ox4MQLV6.loading||(this.poolOfModels.Ox4MQLV6.loading=!0,require(["DS/VisuDataAccess/Ox4MQLV6Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],(function(e,t){a.poolOfModels.Ox4MQLV6.loading=!1,a._Ox4ProxyAbstraction=t,a.Ox4MQLV6Loader=new e(a.glContext,a.renderCB,a.debugBBox,a.geometryMode);for(var r=a.poolOfModels.Ox4MQLV6.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),a._Ox4MQLV6LoaderCB(r[n]);a.poolOfModels.Ox4MQLV6.models=[]}),this._onModuleError(h.errorCB,h.modelName))));else if("svg"==this.fileType)require(["DS/SVGLoader/SVGLoader"],(function(e){new e({renderCB:a.renderCB,onProgressCB:a.onProgressCB,onLoadedCB:a.onLoadedCB,onErrorCB:a.onErrorCB}).load(o,l)}));else if("OxMQLV5"==this.fileType){if(this.OxMQLV5Loader)i.setProxyFromSpec(h.jsonSettings,a._Ox4ProxyAbstraction),this._OxMQLV5LoaderCB(h);else if(this.poolOfModels.OxMQLV5.models.push(h),!this.poolOfModels.OxMQLV5.loading){this.poolOfModels.OxMQLV5.loading=!0;c=["DS/EV53DPlay/OxMQLV5Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"];require(c,(function(e,t){a.poolOfModels.OxMQLV5.loading=!1,a._Ox4ProxyAbstraction=t,a.OxMQLV5Loader=new e(a.glContext,a.renderCB);for(var r=a.poolOfModels.OxMQLV5.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),a._OxMQLV5LoaderCB(r[n]);a.poolOfModels.OxMQLV5.models=[]}),this._onModuleError(h.errorCB,h.modelName))}}else if("cgr"===this.fileType||"uvr"===this.fileType)this.cgrLoader?(n&&(h.jsonSettings=e),this._cgrLoaderCB(h)):(n&&(h.jsonSettings=e),this.poolOfModels.cgr.models.push(h),this.poolOfModels.cgr.loading||(this.poolOfModels.cgr.loading=!0,require(["DS/VisuLoaders/CGRReader"],(function(e){a.poolOfModels.cgr.loading=!1,a.cgrLoader=new e(a.glContext,a.renderCB,{keepLoader:a.getKeepLoaderMode()});for(var t=a.poolOfModels.cgr.models,i=0;i<t.length;i++)a._cgrLoaderCB(t[i]);a.poolOfModels.cgr.models=[]}),this._onModuleError(h.errorCB,h.modelName))));else if("dae"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/DAEReader"],(function(e){null===a.colladaLoader&&(a.colladaLoader=new e(a.glContext,a.renderCB)),a.waitMaterial&&a.colladaLoader.setWaitMaterial(a.waitMaterial),a.colladaLoader.loadFromSpec(o,(function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null}),null,a.onLoadedCB)}),(function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})}))}else if("json"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/JSONReader"],(function(e){null===a.jsonLoader&&(a.jsonLoader=new e(a.glContext,a.renderCB)),a.jsonLoader.load(a.modelName,(function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null}),null,a.onLoadedCB)}),(function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})}))}else if("obj"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/OBJReader"],(function(e){null===a.objLoader&&(a.objLoader=new e(a.glContext,a.renderCB,s)),a.objLoader.load(o,(function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null}),null,a.onLoadedCB)}),(function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})}))}else if("streamvisu"===this.fileType){if(n)return!1;this.streamVisuLoader?this._streamVisuLoaderCB(h):(this.poolOfModels.streamvisu.models.push(h),this.poolOfModels.streamvisu.loading||(this.poolOfModels.streamvisu.loading=!0,require(["DS/VisuLoaders/StreamVisuLoader"],(function(e){a.poolOfModels.streamvisu.loading=!1,a.streamVisuLoader=new e(a.renderCB);for(var t=a.poolOfModels.streamvisu.models,i=0;i<t.length;i++)a._streamVisuLoaderCB(t[i]);a.poolOfModels.streamvisu.models=[]}),this._onModuleError(h.errorCB,h.modelName))))}else if("3dx"===this.fileType||"3dxc"===this.fileType||"3dxm"===this.fileType){if(n)return!1;this.threeDXLoader?this._threeDXLoaderCB(h):(this.poolOfModels["3dx"].models.push(h),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],(function(e){a.poolOfModels["3dx"].loading=!1,a.threeDXLoader=new e;for(var t=a.poolOfModels["3dx"].models,i=0;i<t.length;i++)a._threeDXLoaderCB(t[i]);a.poolOfModels["3dx"].models=[]}),this._onModuleError(h.errorCB,h.modelName))))}else if("stp"===this.fileType||"step"===this.fileType||"stl"===this.fileType||"ifc"===this.fileType){if(1!=n||1==this.forceNoWorkerForSTEP){c=["DS/XCADLoader/XCADModelLoaderPlug"];require(c,(function(t){for(var i=[new t],r=function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1})},s=0;s<i.length;s++)if(i[s].isManagedType(a.fileType)){var h=null;n&&(h=e),i[s].loadModel(a.fileType,a.glContext,a.renderCB,a.modelName,r,a.onProgressCB,a.onLoadedCB,a.onErrorCB,a.filterNavReps,a.refreshTime,l,o,h)}}),(function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})}))}else if("string"==typeof e&&(e=(new TextEncoder).encode(e)),this.xcadLoader)h.jsonSettings=e,this._xcadLoaderCB(h);else if(h.jsonSettings=e,this.poolOfModels.step.models.push(h),!this.poolOfModels.step.loading){this.poolOfModels.step.loading=!0;c=["DS/XCADLoader/XCADReader"];require(c,(function(e){a.poolOfModels.step.loading=!1,a.xcadLoader=new e(a.glContext,a.renderCB,{keepLoader:!0});for(var t=a.poolOfModels.step.models,i=0;i<t.length;i++)a._xcadLoaderCB(t[i]);a.poolOfModels.step.models=[]}),this._onModuleError(h.errorCB,h.modelName))}}else"particles"===this.fileType?require(["DS/VisuLoaders/ParticlesLoader"],(function(t){null===a.particlesLoader&&(a.particlesLoader=new t(a.sceneGraph,a.renderCB));var i=o;n&&(i=e),a.particlesLoader.load(i,(function(e){l.add(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null}),null,a.onLoadedCB)}),(function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})})):require(["DS/ModelLoader_"+this.fileType.toLowerCase()+"/loader"],(function(t){var i=new t,r=o;n&&(r=e),i.load(r,(function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),l=null}),a.onProgressCB,a.onLoadedCB,a.onErrorCB,a.renderCB)}),(function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})}));return!0},addRessourceLibrary(e,t,i){this.materialManager||(this.materialManager=new a),i||this.clearRessourceLibrary();var r=this,n=this._buildFileInfos(e),s={modelName:this.modelName,fileType:this.fileType,jsonSettings:n,destination:null,isBuffer:!1,geometryMode:!1,renderCB:null,loadedProductCB:null,progressCB:null,loadedCB:function(e){for(var i=e.materials,n=0;n<i.length;n++)r.materialManager.setCGRSharedMaterial(n,i[n]);t&&t()},errorCB:this.onErrorCB};this.threeDXLoader?this._threeDXLoaderCB(s):(this.poolOfModels["3dx"].models.push(s),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],(function(e){r.poolOfModels["3dx"].loading=!1,r.threeDXLoader=new e;for(var t=r.poolOfModels["3dx"].models,i=0;i<t.length;i++)r._threeDXLoaderCB(t[i]);r.poolOfModels["3dx"].models=[]}),this._onModuleError(s.errorCB,s.modelName))))},clearRessourceLibrary(){this.materialManager||(this.materialManager=new a),this.materialManager.CGRSharedMaterials.clear()},getRessourceLibraryItem(e,t){return this.materialManager?this.materialManager.getCGRSharedMaterial(e,t):null},getLoader:function(e,t){var i=this;if("3dx"===e)require(["DS/VisuLoaders/ThreeDXLoader"],(function(e){null===i.threeDXLoader&&(i.threeDXLoader=new e),t&&t(i.threeDXLoader)}));return this.threeDXLoader},setLineTypes:function(e){this.materialManager||(this.materialManager=new a),this.materialManager.setLineTypes(e)},clearLineTypes:function(){this.materialManager&&this.materialManager.clearLineTypes()},buildPath:function(e){if("string"==typeof e){var t="",r="";if("blob:"===e.substring(0,5))return{provider:"FILE",serverurl:"",filename:e,requiredAuth:null,proxyurl:"none"};if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else if("ms-appx://"===e.substring(0,10))t=e;else if("file://"===e.substring(0,7))t=e;else{var n=location.href,s=n.indexOf("?");-1!==s&&(n=n.substring(0,s));var a=n.lastIndexOf("/");-1!==a&&(n=n.substring(0,a+1)),t=n+e}r=(t=i.parseUrl(t)).protocol,""!==t.protocol&&(r+="://"),r+=t.authority+t.path.substring(0,t.path.lastIndexOf("/"))+"/";var o=t.path.substring(t.path.lastIndexOf("/")+1,t.path.length);return""!==t.query&&(o=o+"?"+t.query),e={provider:"FILE",serverurl:r,filename:o,requiredAuth:null,proxyurl:"none"}}return"EV6"===e.provider&&(t=i.parseUrl(e.serverurl),e.serverdefinition={},e.serverdefinition.protocol=t.protocol,e.serverdefinition.hostname=""!==t.user?t.user+"@"+t.domain:t.domain,e.serverdefinition.port=t.port,e.serverdefinition.rooturi=t.path,"/"===e.serverdefinition.rooturi.slice(0,1)&&(e.serverdefinition.rooturi=e.serverdefinition.rooturi.slice(1,e.serverdefinition.rooturi.length))),e},setFileTypeFromSpec:function(e){var t="";if("string"==typeof e)t=i.getExtension(e);else if(e.provider&&"FILE"!==e.provider)"EV6"===e.provider?this.fileType="Ox4MQLV6":"EV5"===e.provider?this.fileType="OxMQLV5":this.fileType=e.provider;else if(e.format&&""!==e.format)t=e.format;else{var r=e.serverurl?e.serverurl:"";r+=e.filename?e.filename:"",t=i.getExtension(r)}""!==t&&(t.toLowerCase&&(t=t.toLowerCase()),this.fileType="3dxml"===t?"xmlv43":t)},reloadUVR:function(e,t,r,n){var s=this;require(["DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Visualization/ProxyAbstraction"],(function(a,o,l){var h=s.buildPath(e),c=new l;i.setProxyFromSpec(h,c);var d=h.serverurl?h.serverurl:"";d+=h.filename?h.filename:"";for(var u=[],p=0;p<t.length;p++)u.push(t[p].name);c.executeGetHttpRequest(d,"blob",null,(function(e){for(var i=0;i<u.length;i++){var l=new o(e,u[i]);!function(e){a.getTask("CGR",l,t[e],(function(i){var a=s.getCGROptions();n&&n.applicativeContainers&&(a.applicativeContainers=n.applicativeContainers),a.unlinkToSG=!0,a.destination=[];for(var o=0;o<t[e].parents.length;o++)a.destination.push(t[e].parents[o]);i.run((function(i){var r=i.nodes;if(t&&t[e]&&t[e].parents)for(var n=t[e].parents.length,s=0;s<n;s++){var a=t[e].parents[s];a.removeChildren();for(var o=0;o<r.length;o++)a.addChild(r[o])}}),r?r.onLoadedCB:null,r?r.onErrorCB:null,a)}))}(i)}}),s.onErrorCB)}))},setWaitMaterial:function(e){this.waitMaterial=e.clone()},abort:function(){null!==this.cgrLoader&&this.cgrLoader.abort(),null!==this.xmlv43Loader&&this.xmlv43Loader.abort()}});return UWA.namespace("THREEDS/ModelLoader",l)})),define("Visualization/ModelLoader",["DS/Visualization/ModelLoader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/ModelLoader"),e})),define("DS/Visualization/WidelinesHelper",["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh"],(function(e,t){"use strict";const i=[];return{_computeLineDistances:function(t,i){for(var r,n,s=[],a=t.vertexIndexArray,o=i&&i.length===a.length,l=new e.Vector3,h=new e.Vector3,c=0;c<t.drawingGroups.length;c++)for(var d=t.drawingGroups[c],u=d.start,p=d.count,f=0;f<p;f++){var g=f+u,m=0;if(o&&(m=i[g]),f>0){if((r=a[g])===(n=a[g-1]))continue;t.getVertexPosition(r,l),t.getVertexPosition(n,h);var v=l.distanceTo(h);Math.abs(v)>1e-6&&!(f%2)?(s[2*r]=m,s[2*r+1]=m):(s[2*r]=m+v+s[2*n],s[2*r+1]=m+v+s[2*n])}else{var _=a[g];s[2*_]=m,s[2*_+1]=m}}t.needsUpdate=!0,t.vertexLineDistancesArray=new Float32Array(s)},_computeWideLineDistances:function(e){const t=e.wideLinesLinker.parentGeometry;t.vertexLineDistancesArray&&!t.isAttributeStale("position")||this._computeLineDistances(t,[]);for(var i=[],r=t.vertexLineDistancesArray,n=e.wideLinesLinker.lineStructureMap,s=0;s<e.drawingGroups.length;s++)for(var a=e.drawingGroups[s],o=n.get(a),l=o.sides,h=o.primitives,c=0,d=0;d<h.length;d++)for(var u=h[d],p=0;p<u.length;p++)for(var f=u[p],g=!f.endLine&&!f.begLine||f.isLoopedWith||f.fusedWith?4:2,m=0;m<g;m++){var v=r[2*f.cur];if(l[c]%2==0)if(i.push(v),f.isLoopedWith)i.push(v);else if(f.fusedWith){var _=h[f.fusedWith.primIndex][0];_=r[2*_.cur],Math.abs(_-v)<1e-6?i.push(r[2*f.next]):i.push(v)}else i.push(r[2*f.next]);else i.push(r[2*f.prev]),i.push(v);c++}e.needsUpdate=!0,e.vertexLineDistancesArray=new Float32Array(i)},_computePixelLineDistances:function(t,i,r,n){var s=new e.Matrix4;s.multiplyMatrices(r,i);var a=!!t.vertexLinePixelDistancesArray,o=!t.cpuPatternMatrix||!t.cpuPatternMatrix.equals(s);if(a&&!o)return!1;t.cpuPatternMatrix=s;for(var l,h,c=[],d=t.vertexIndexArray,u=new e.Vector4,p=new e.Vector4,f=new e.Vector2,g=new e.Vector2,m=0;m<t.drawingGroups.length;m++)for(var v=t.drawingGroups[m],_=v.start,y=0,S=v.count;y<S;y++){var b=y+_;if(y>0){if((l=d[b])===(h=d[b-1]))continue;t.getVertexPosition(l,u),t.getVertexPosition(h,p);var x=u.distanceTo(p);if(Math.abs(x)>1e-6&&!(y%2))c[2*l]=0,c[2*l+1]=0;else{u.w=1,u.applyMatrix4(s),p.w=1,p.applyMatrix4(s),f.x=.5*(u.x/u.w+1)*n.width,f.y=.5*(u.y/u.w+1)*n.height,g.x=.5*(p.x/p.w+1)*n.width,g.y=.5*(p.y/p.w+1)*n.height;var w=f.distanceTo(g);c[2*l]=w+c[2*h],c[2*l+1]=w+c[2*h]}}else{var P=d[b];c[2*P]=0,c[2*P+1]=0}}return t.needsUpdate=!0,t.vertexLinePixelDistancesArray=new Float32Array(c),!0},_computePixelWideLineDistances:function(e,t,i,r){var n=!!e.vertexLinePixelDistancesArray,s=this._computePixelLineDistances(e.wideLinesLinker.parentGeometry,t,i,r);if(n&&!s)return!1;e.cpuPatternMatrix=e.wideLinesLinker.parentGeometry.cpuPatternMatrix;for(var a=[],o=e.wideLinesLinker.parentGeometry.vertexLinePixelDistancesArray,l=e.wideLinesLinker.lineStructureMap,h=0;h<e.drawingGroups.length;h++)for(var c=e.drawingGroups[h],d=l.get(c),u=d.sides,p=d.primitives,f=0,g=0;g<p.length;g++)for(var m=p[g],v=0;v<m.length;v++)for(var _=m[v],y=!_.endLine&&!_.begLine||_.isLoopedWith||_.fusedWith?4:2,S=0;S<y;S++){var b=o[2*_.cur];if(u[f]%2==0)if(a.push(b),_.isLoopedWith)a.push(b);else if(_.fusedWith){var x=p[_.fusedWith.primIndex][0];x=o[2*x.cur],Math.abs(x-b)<1e-6?a.push(o[2*_.next]):a.push(b)}else a.push(o[2*_.next]);else a.push(o[2*_.prev]),a.push(b);f++}return e.needsUpdate=!0,e.vertexLinePixelDistancesArray=new Float32Array(a),!0},_computeWideLineDG:function(r,n,s,a){const o=r.wideLinesLinker;let l=o.originalDGToWideDG.get(s);if(l)return l;if(!r.vertexIndexArray)return null;l=new t.DrawingGroup,s instanceof t.DrawingGroup?l=s.clone():(l.gas=s.gas,l.gasIndex=s.gasIndex,l._geomType=s._geomType,l.layers=s.layers,l.material=s.material,l.copyPrimitives(s.primitives),l.count=s.count),l.geometry=n,l.glType=4,o.originalDGToWideDG.set(s,l);const h=new e.Vector3,c=new e.Vector3,d=function(e,t){const i=1e-6;return r.getVertexPosition(e,h),r.getVertexPosition(t,c),Math.abs(h.x-c.x)<i&&Math.abs(h.y-c.y)<i&&Math.abs(h.z-c.z)<i};let u=function(){const e=[];let i=0;const n=new t.SGPrimitiveHelper;for(let t=0;t<s.getPrimitivesCount();t++){n.set(s,t),e.push([]);for(let s=n.getStart();s<n.getStart()+n.getCount();s++){const a=(s-n.getStart())%2;i=r.vertexIndexArray[s];const o={cur:i,prev:a?r.vertexIndexArray[s-1]:i,next:a?i:r.vertexIndexArray[s+1],begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};e[t].push(o)}}return e}();u=function(e){const t=[];for(let r=0;r<e.length;r++){t.push([]);const n=e[r];if(!(n.length<1))for(let e=0;e<n.length;e++){const s=n[e];if(s.cur!==s.next)t[r].push(s);else if(e<n.length-1){const a=e+1;let o=n[a];if(s.cur===o.cur){for(var i=e+2;i<n.length&&s.cur===n[i].cur;i++)a=i;o=n[a];const l={cur:s.cur,next:o.next,prev:s.prev,begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};e=a,t[r].push(l)}else t[r].push(s)}else t[r].push(s)}}return t}(u);const p=function(e,t){for(let i=0;i<e.length;i++){const r=e[i];if(!(r.length<1))for(let e=0;e<r.length;e++){t(r[e],r,e)}}};p(u,(function(e){e.next===e.cur?e.endLine=!0:e.prev===e.cur&&(e.begLine=!0)}));p(u,(function(e,t,i){if(e.endLine&&i<t.length-1){const r=t[i+1];r.begLine&&d(e.cur,r.cur)&&(e.endLine=!1,r.begLine=!1)}}));p(u,(function(e,t,i){if(d(e.cur,e.next)&&!e.endLine&&!e.begLine)for(let r=i+1;r<t.length;r++){const i=t[r];if(!d(e.cur,i.cur))break;if(i.prev=e.prev,i.endLine)break;d(i.next,i.cur)?i.colorIndex||(i.colorIndex=e.cur):(e.next=i.next,e.endSkip=!0,i.baseSkip=!0)}}));!function(e){if(e.length<2)return;const t=[];for(let i=0;i<e.length;i++){const n=e[i];if(n.length<1)continue;const s=n[n.length-1],a=n[0];d(s.cur,s.next)&&(r.getVertexPosition(s.cur,h),t.push([h.x,h.y,h.z,i,1])),d(a.prev,a.cur)&&(r.getVertexPosition(a.cur,h),t.push([h.x,h.y,h.z,i,0]))}t.sort((function(e,t){const i=e[0]-t[0];if(Math.abs(i)<1e-6){const i=e[1]-t[1];if(Math.abs(i)<1e-6){const i=e[2]-t[2];if(Math.abs(i)<1e-6){const i=e[3]-t[3];return 0===i?0:i>0?1:-1}return i>0?1:-1}return i>0?1:-1}return i>0?1:-1}));for(let i=0;i<t.length;i++){const r=t[i];if(0!==r[4])for(let n=i+1;n<t.length;n++){const i=t[n];if(1===i[4]||i[3]===r[3])continue;if(Math.abs(r[0]-i[0])<1e-6){if(Math.abs(r[1]-i[1])<1e-6){if(Math.abs(r[2]-i[2])<1e-6){const t=e[r[3]],n=t[t.length-1],s=e[i[3]][0];if(!s.fusedBack){n.next=s.next,s.prev=n.prev,n.fusedWith={primIndex:i[3]},s.fusedBack=!0;break}}}}break}}}(u);p(u,(function(e,t,i){const r=t.length;if(e.begLine)for(let n=i+1;n<r;n++){const r=t[n];if(r.endLine){n-i>1&&d(r.cur,e.cur)&&(r.isLoopedWith=!0,e.prev=r.prev,r.next=e.next);break}}}));const f=[],g=[],m=[],v=[];let _=0;const y=new e.Vector3,S=new e.Vector3,b=new e.Vector3;for(let e=0;e<u.length;e++){const t=u[e];for(let e=0;e<t.length;e++){const i=t[e],n=!i.endLine&&!i.begLine||i.isLoopedWith||i.fusedWith?4:2;i.indRef=_,i.inds=[];for(let e=0;e<n;e++)i.inds.push(_),v[_]=e%2==0?1:-1,4===n?v[_]*=e<2?1:2:i.begLine&&(v[_]*=2),r.getVertexPosition(i.cur,y),r.getVertexPosition(i.prev,S),r.getVertexPosition(i.next,b),f[3*_]=y.x,f[3*_+1]=y.y,f[3*_+2]=y.z,g[3*_]=S.x,g[3*_+1]=S.y,g[3*_+2]=S.z,m[3*_]=b.x,m[3*_+1]=b.y,m[3*_+2]=b.z,_++}}o.lineStructureMap.set(l,{sides:v.slice(0),primitives:u.slice(0)});let x=null;if(r.vertexColorArray){const t=new e.Vector4;x=[];let i=0;for(let e=0;e<u.length;e++){const n=u[e];for(let e=0;e<n.length;e++){const s=n[e],a=!s.endLine&&!s.begLine||s.isLoopedWith||s.fusedWith?4:2;for(let e=0;e<a;e++){const e=s.colorIndex>=0?s.colorIndex:s.cur;r.getVertexColor(e,t),x[4*i]=t.x,x[4*i+1]=t.y,x[4*i+2]=t.z,x[4*i+3]=t.w,i++}}}}let w=null;const P=r.vertexPatternStartEndArray;if(P){w=[];let e=0;for(let t=0;t<u.length;t++){const i=u[t];for(let t=0;t<i.length;t++){const r=i[t],n=!r.endLine&&!r.begLine||r.isLoopedWith||r.fusedWith?4:2;for(let t=0;t<n;t++){const t=r.cur;for(let i=0;i<2;i++)w[2*e+i]=P[2*t+i];e++}}}}let C=!1;a.isCPUPattern||(a.isDashedLine&&(C=!0),a.politeMaterial&&(C=!0),r.vertexLineDistancesArray&&(C=!0));const M=[];let E=0;for(let e=0;e<u.length;e++){const t=u[e];if(t.length<1)continue;l._setPrimitiveCount(0,e);let i=0;for(i=0;i<t.length;i++){const r=t[i],n=r.inds;if(r.endLine||r.begLine){if(r.endLine){r.isLoopedWith&&(M.push(n[0]),M.push(n[1]),M.push(n[2]),M.push(n[3]),M.push(n[2]),M.push(n[1]),l._setPrimitiveCount(l.getPrimitiveCount(e)+6,e));continue}const s=t[i+1].inds;M.push(n[0]),M.push(n[1]),M.push(s[0]),M.push(s[1]),M.push(s[0]),M.push(n[1]),l._setPrimitiveCount(l.getPrimitiveCount(e)+6,e)}else if(r.baseSkip||(M.push(n[0]),M.push(n[1]),M.push(n[2]),M.push(n[3]),M.push(n[2]),M.push(n[1]),l._setPrimitiveCount(l.getPrimitiveCount(e)+6,e)),!r.endSkip){var T=t[i+1].inds;M.push(n[2]),M.push(n[3]),M.push(T[0]),M.push(T[1]),M.push(T[0]),M.push(n[3]),l._setPrimitiveCount(l.getPrimitiveCount(e)+6,e)}}if(t[t.length-1].fusedWith){const r=t[i-1].inds;M.push(r[0]),M.push(r[1]),M.push(r[2]),M.push(r[3]),M.push(r[2]),M.push(r[1]),l._setPrimitiveCount(l.getPrimitiveCount(e)+6,e)}l._setPrimitiveStart(E,e),E+=l.getPrimitiveCount(e)}o.subGeometries||(n.vertexPositionArray?o.subGeometries={vertices:[n.vertexPositionArray],verticesCount:n.vertexPositionArray.length,indices:[n.vertexIndexArray],indicesCount:n.vertexIndexArray.length,prev:[n.vertexPreviousPositionArray],next:[n.vertexNextPositionArray],sides:[n.vertexSideExtrusionArray],colors:[n.vertexColorArray||i],hasColors:!!n.vertexColorArray,patternStartEnds:[n.vertexPatternStartEndArray||i],hasPatternStartEnds:!!n.vertexPatternStartEndArray,needsLineDistance:!!n.vertexLineDistancesArray}:o.subGeometries={vertices:[],verticesCount:0,indices:[],indicesCount:0,prev:[],next:[],sides:[],colors:[],hasColors:!1,patternStartEnds:[],hasPatternStartEnds:!1,needsLineDistance:!1});const A=o.subGeometries;var D=A.verticesCount/3;return A.verticesCount+=f.length,A.vertices.push(f),A.prev.push(g),A.next.push(m),A.sides.push(v),A.colors.push(x||i),A.patternStartEnds.push(w||i),A.hasColors=A.hasColors||!!x,A.hasPatternStartEnds=A.hasPatternStartEnds||!!w,A.needsLineDistance=A.needsLineDistance||C,l.start=A.indicesCount,l.count=M.length,A.indicesCount+=M.length,M.forEach((function(e,t,i){i[t]+=D})),A.indices.push(M),n.drawingGroups.push(l),n.needsUpdate=!0,l}}}));var isA2X=localStorage.getItem("A2XFullWhiteList")||localStorage.getItem("A2XWhiteList"),preqs=isA2X?[]:["DS/VisualizationUI/CSIViewer"];function HighlightMeshData(e,t){this.selectionId=e,this.renderable=t}define("DS/Visualization/CSIViewer",preqs,(function(e){return e})),define("DS/Visualization/OBJReader",["DS/VisuLoaders/OBJReader"],(function(e){"use strict";return e})),define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/OBJReader"),e})),window.ConvergeWebVisuNoGlobals||(window.i=0,window.modules=null),function(){for(var e=[],t=["AlphaShaders","ClipShaders","ColorShaders","CoreShaders","EnvMapShaders","FogShaders","MappingShaders","PDSFXShaders","ScenegraphShaders","ShadowingShaders","VerticeShaders"],i=0;i<t.length;i++)e.push("DS/ShaderBuilders/Commons/"+t[i]);define("DS/Visualization/ShaderChunk",e,(function(e,t,i,r,n,s,a,o,l,h,c){"use strict";var d={};return Object.assign(d,r),Object.assign(d,l),Object.assign(d,o),Object.assign(d,h),Object.assign(d,s),Object.assign(d,t),Object.assign(d,a),Object.assign(d,n),Object.assign(d,e),Object.assign(d,i),Object.assign(d,c),d}))}(),define("DS/Visualization/ExplicitGeometries",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object","DS/Object3D/Mesh"],(function(e,t,i){"use strict";var r={LegacyGeometry:function(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this.name="",this._type=0,this.vertices=[],this.colors=[],this.normals=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.dynamic=!0,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.tangentsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.buffersNeedUpdate=!1}};return r.LegacyGeometry.prototype={constructor:r.LegacyGeometry,layout:{_computeLayoutKey:function(){},_layoutKey:null},applyMatrix:function(t){for(var i=(new e.Matrix3).getInverse(t).transpose(),r=0,n=this.vertices.length;r<n;r++){this.vertices[r].applyMatrix4(t)}for(r=0,n=this.faces.length;r<n;r++){var s=this.faces[r];s.normal.applyMatrix3(i).normalize();for(var a=0,o=s.vertexNormals.length;a<o;a++)s.vertexNormals[a].applyMatrix3(i).normalize();s.centroid.applyMatrix4(t)}},computeCentroids:function(){var t,i,r;for(t=0,i=this.faces.length;t<i;t++)(r=this.faces[t]).centroid.set(0,0,0),r instanceof e.Face3?(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.divideScalar(3)):r instanceof e.Face4&&(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.add(this.vertices[r.d]),r.centroid.divideScalar(4))},computeFaceNormals:function(){for(var t=new e.Vector3,i=new e.Vector3,r=0,n=this.faces.length;r<n;r++){var s=this.faces[r],a=this.vertices[s.a],o=this.vertices[s.b],l=this.vertices[s.c];t.subVectors(l,o),i.subVectors(a,o),t.cross(i),t.normalize(),s.normal.copy(t)}},computeVertexNormals:function(t){var i,r,n,s,a,o;if(void 0===this.__tmpVertices){for(this.__tmpVertices=new Array(this.vertices.length),o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i]=new e.Vector3;for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?a.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3]:a instanceof e.Face4&&(a.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3])}else for(o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i].set(0,0,0);if(t){var l,h,c,d,u=new e.Vector3,p=new e.Vector3,f=new e.Vector3,g=new e.Vector3,m=new e.Vector3;for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?(l=this.vertices[a.a],h=this.vertices[a.b],c=this.vertices[a.c],u.subVectors(c,h),p.subVectors(l,h),u.cross(p),o[a.a].add(u),o[a.b].add(u),o[a.c].add(u)):a instanceof e.Face4&&(l=this.vertices[a.a],h=this.vertices[a.b],c=this.vertices[a.c],d=this.vertices[a.d],f.subVectors(d,h),p.subVectors(l,h),f.cross(p),o[a.a].add(f),o[a.b].add(f),o[a.d].add(f),g.subVectors(d,c),m.subVectors(h,c),g.cross(m),o[a.b].add(g),o[a.c].add(g),o[a.d].add(g))}else for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?(o[a.a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal)):a instanceof e.Face4&&(o[a.a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal),o[a.d].add(a.normal));for(i=0,r=this.vertices.length;i<r;i++)o[i].normalize();for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?(a.vertexNormals[0].copy(o[a.a]),a.vertexNormals[1].copy(o[a.b]),a.vertexNormals[2].copy(o[a.c])):a instanceof e.Face4&&(a.vertexNormals[0].copy(o[a.a]),a.vertexNormals[1].copy(o[a.b]),a.vertexNormals[2].copy(o[a.c]),a.vertexNormals[3].copy(o[a.d]))},computeTangents:function(){var t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T=[],A=[],D=new e.Vector3,I=new e.Vector3,R=new e.Vector3,O=new e.Vector3,L=new e.Vector3;for(r=0,n=this.vertices.length;r<n;r++)T[r]=new e.Vector3,A[r]=new e.Vector3;function B(e,t,i,r,n,s,a){h=e.vertices[t],c=e.vertices[i],d=e.vertices[r],u=l[n],p=l[s],f=l[a],g=c.x-h.x,m=d.x-h.x,v=c.y-h.y,_=d.y-h.y,y=c.z-h.z,S=d.z-h.z,b=p.x-u.x,x=f.x-u.x,w=p.y-u.y,P=f.y-u.y,C=1/(b*P-x*w),D.set((P*g-w*m)*C,(P*v-w*_)*C,(P*y-w*S)*C),I.set((b*m-x*g)*C,(b*_-x*v)*C,(b*S-x*y)*C),T[t].add(D),T[i].add(D),T[r].add(D),A[t].add(I),A[i].add(I),A[r].add(I)}for(t=0,i=this.faces.length;t<i;t++)o=this.faces[t],l=this.faceVertexUvs[0][t],o instanceof e.Face3?B(this,o.a,o.b,o.c,0,1,2):o instanceof e.Face4&&(B(this,o.a,o.b,o.d,0,1,3),B(this,o.b,o.c,o.d,1,2,3));var F=["a","b","c","d"];for(t=0,i=this.faces.length;t<i;t++)for(o=this.faces[t],s=0;s<o.vertexNormals.length;s++)L.copy(o.vertexNormals[s]),a=o[F[s]],M=T[a],R.copy(M),R.sub(L.multiplyScalar(L.dot(M))).normalize(),O.crossVectors(o.vertexNormals[s],M),E=O.dot(A[a])<0?-1:1,o.vertexTangents[s]=new e.Vector4(R.x,R.y,R.z,E);this.hasTangents=!0},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new e.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere),this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var t,i,r,n,s,a,o,l,h,c={},d=[],u=[],p=Math.pow(10,4);for(this.__tmpVertices=void 0,r=0,n=this.vertices.length;r<n;r++)t=this.vertices[r],void 0===c[i=[Math.round(t.x*p),Math.round(t.y*p),Math.round(t.z*p)].join("_")]?(c[i]=r,d.push(this.vertices[r]),u[r]=d.length-1):u[r]=u[c[i]];var f=[];for(r=0,n=this.faces.length;r<n;r++)if((s=this.faces[r])instanceof e.Face3){s.a=u[s.a],s.b=u[s.b],s.c=u[s.c],a=[s.a,s.b,s.c];for(var g=-1,m=0;m<3;m++)if(a[m]==a[(m+1)%3]){g=m,f.push(r);break}}else if(s instanceof e.Face4){s.a=u[s.a],s.b=u[s.b],s.c=u[s.c],s.d=u[s.d],a=[s.a,s.b,s.c,s.d];for(g=-1,m=0;m<4;m++)a[m]==a[(m+1)%4]&&(g>=0&&f.push(r),g=m);if(g>=0){a.splice(g,1);var v=new e.Face3(a[0],a[1],a[2],s.normal,s.color,s.materialIndex);for(o=0,l=this.faceVertexUvs.length;o<l;o++)(h=this.faceVertexUvs[o][r])&&h.splice(g,1);s.vertexNormals&&s.vertexNormals.length>0&&(v.vertexNormals=s.vertexNormals,v.vertexNormals.splice(g,1)),s.vertexColors&&s.vertexColors.length>0&&(v.vertexColors=s.vertexColors,v.vertexColors.splice(g,1)),this.faces[r]=v}}for(r=f.length-1;r>=0;r--)for(this.faces.splice(r,1),o=0,l=this.faceVertexUvs.length;o<l;o++)this.faceVertexUvs[o].splice(r,1);var _=this.vertices.length-d.length;return this.vertices=d,_},clone:function(){for(var t=new r.LegacyGeometry,i=this.vertices,n=0,s=i.length;n<s;n++)t.vertices.push(i[n].clone());var a=this.faces;for(n=0,s=a.length;n<s;n++)t.faces.push(a[n].clone());var o=this.faceVertexUvs[0];for(n=0,s=o.length;n<s;n++){for(var l=o[n],h=[],c=0,d=l.length;c<d;c++)h.push(new e.Vector2(l[c].x,l[c].y));t.faceVertexUvs[0].push(h)}return t},dispose:function(){this.dispatchEvent({type:"dispose"})}},r.ParticleSystem=class extends t{constructor(t,i){super(),this.geometry=t,this.material=void 0!==i?i:new e.ParticleBasicMaterial({color:16777215*Math.random()}),this.sortParticles=!1,this.geometry&&null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere(),this.frustumCulled=!1,console.log("ExplicitGeometries.ParticleSystem is deprecated. Please use SceneGraphFactory.createMeshNode instead.")}clone(e){return void 0===e&&(e=new r.ParticleSystem(this.geometry,this.material)),e.sortParticles=this.sortParticles,t.prototype.clone.call(this,e),e}},r.Line=class extends t{constructor(t,i,r){super(),this.geometry=t,this.material=void 0!==i?i:new e.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==r?r:e.LineStrip,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere())}static call(e,t,i,n){console.warn("Old school inheritance on Line, please migrate to ES6 classes");var s=new r.Line(t,i,n);Object.assign(e,s)}clone(e){return void 0===e&&(e=new r.Line(this.geometry,this.material,this.type)),t.prototype.clone.call(this,e),e}},r.SkinnedMesh=class extends i{constructor(t,i,r){super(t,i,!0),this.useVertexTexture=void 0===r||r,this.identityMatrix=new e.Matrix4,this.bones=[],this.boneMatrices=[],window.sealWebVisuObjects&&Object.seal(this)}},r.CircleGeometry=function(t,i,n,s){r.LegacyGeometry.call(this),t=t||50,n=void 0!==n?n:0,s=void 0!==s?s:2*Math.PI,i=void 0!==i?Math.max(3,i):8;var a,o=[],l=new e.Vector3,h=new e.Vector2(.5,.5);for(this.vertices.push(l),o.push(h),a=0;a<=i;a++){var c=new e.Vector3,d=n+a/i*s;c.x=t*Math.cos(d),c.y=t*Math.sin(d),this.vertices.push(c),o.push(new e.Vector2((c.x/t+1)/2,-(c.y/t+1)/2+1))}var u=new e.Vector3(0,0,-1);for(a=1;a<=i;a++){var p=a,f=a+1;this.faces.push(new e.Face3(p,f,0,[u,u,u])),this.faceVertexUvs[0].push([o[a],o[a+1],h])}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.CircleGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CubeGeometry=function(t,i,n,s,a,o){r.LegacyGeometry.call(this);var l=this;this.width=t,this.height=i,this.depth=n,this.widthSegments=s||1,this.heightSegments=a||1,this.depthSegments=o||1;var h=this.width/2,c=this.height/2,d=this.depth/2;function u(t,i,r,n,s,a,o,h){var c,d,u,p=l.widthSegments,f=l.heightSegments,g=s/2,m=a/2,v=l.vertices.length;"x"===t&&"y"===i||"y"===t&&"x"===i?c="z":"x"===t&&"z"===i||"z"===t&&"x"===i?(c="y",f=l.depthSegments):("z"===t&&"y"===i||"y"===t&&"z"===i)&&(c="x",p=l.depthSegments);var _=p+1,y=f+1,S=s/p,b=a/f,x=new e.Vector3;for(x[c]=o>0?1:-1,u=0;u<y;u++)for(d=0;d<_;d++){var w=new e.Vector3;w[t]=(d*S-g)*r,w[i]=(u*b-m)*n,w[c]=o,l.vertices.push(w)}for(u=0;u<f;u++)for(d=0;d<p;d++){var P=d+_*u,C=d+_*(u+1),M=d+1+_*(u+1),E=d+1+_*u,T=new e.Face4(P+v,C+v,M+v,E+v);T.normal.copy(x),T.vertexNormals.push(x.clone(),x.clone(),x.clone(),x.clone()),T.materialIndex=h,l.faces.push(T),l.faceVertexUvs[0].push([new e.Vector2(d/p,1-u/f),new e.Vector2(d/p,1-(u+1)/f),new e.Vector2((d+1)/p,1-(u+1)/f),new e.Vector2((d+1)/p,1-u/f)])}}u("z","y",-1,-1,this.depth,this.height,h,0),u("z","y",1,-1,this.depth,this.height,-h,1),u("x","z",1,1,this.width,this.depth,c,2),u("x","z",1,-1,this.width,this.depth,-c,3),u("x","y",1,-1,this.width,this.height,d,4),u("x","y",-1,-1,this.width,this.height,-d,5),this.computeCentroids(),this.mergeVertices()},r.CubeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CylinderGeometry=function(t,i,n,s,a,o){r.LegacyGeometry.call(this),t=void 0!==t?t:20,i=void 0!==i?i:20;var l,h,c=(n=void 0!==n?n:100)/2,d=s||8,u=a||1,p=[],f=[];for(h=0;h<=u;h++){var g=[],m=[],v=h/u,_=v*(i-t)+t;for(l=0;l<=d;l++){var y=l/d,S=new e.Vector3;S.x=_*Math.sin(y*Math.PI*2),S.y=-v*n+c,S.z=_*Math.cos(y*Math.PI*2),this.vertices.push(S),g.push(this.vertices.length-1),m.push(new e.Vector2(y,1-v))}p.push(g),f.push(m)}var b,x,w=(i-t)/n;for(l=0;l<d;l++)for(0!==t?(b=this.vertices[p[0][l]].clone(),x=this.vertices[p[0][l+1]].clone()):(b=this.vertices[p[1][l]].clone(),x=this.vertices[p[1][l+1]].clone()),b.setY(Math.sqrt(b.x*b.x+b.z*b.z)*w).normalize(),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*w).normalize(),h=0;h<u;h++){var P=p[h][l],C=p[h+1][l],M=p[h+1][l+1],E=p[h][l+1],T=b.clone(),A=b.clone(),D=x.clone(),I=x.clone(),R=f[h][l].clone(),O=f[h+1][l].clone(),L=f[h+1][l+1].clone(),B=f[h][l+1].clone();this.faces.push(new e.Face4(P,C,M,E,[T,A,D,I])),this.faceVertexUvs[0].push([R,O,L,B])}if(!o&&t>0)for(this.vertices.push(new e.Vector3(0,c,0)),l=0;l<d;l++){P=p[0][l],C=p[0][l+1],M=this.vertices.length-1,T=new e.Vector3(0,1,0),A=new e.Vector3(0,1,0),D=new e.Vector3(0,1,0),R=f[0][l].clone(),O=f[0][l+1].clone(),L=new e.Vector2(O.u,0);this.faces.push(new e.Face3(P,C,M,[T,A,D])),this.faceVertexUvs[0].push([R,O,L])}if(!o&&i>0)for(this.vertices.push(new e.Vector3(0,-c,0)),l=0;l<d;l++){P=p[h][l+1],C=p[h][l],M=this.vertices.length-1,T=new e.Vector3(0,-1,0),A=new e.Vector3(0,-1,0),D=new e.Vector3(0,-1,0),R=f[h][l+1].clone(),O=f[h][l].clone(),L=new e.Vector2(O.u,1);this.faces.push(new e.Face3(P,C,M,[T,A,D])),this.faceVertexUvs[0].push([R,O,L])}this.computeCentroids(),this.computeFaceNormals()},r.CylinderGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry=function(e,t){void 0!==e?(r.LegacyGeometry.call(this),e=e instanceof Array?e:[e],this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()):e=[]},r.ExtrudeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry.prototype.addShapeList=function(e,t){for(var i=e.length,r=0;r<i;r++){var n=e[r];this.addShape(n,t)}},r.ExtrudeGeometry.prototype.addShape=function(t,i){var n,s,a,o,l,h,c,d,u=void 0!==i.amount?i.amount:100,p=void 0!==i.bevelThickness?i.bevelThickness:6,f=void 0!==i.bevelSize?i.bevelSize:p-2,g=void 0!==i.bevelSegments?i.bevelSegments:3,m=void 0===i.bevelEnabled||i.bevelEnabled,v=void 0!==i.curveSegments?i.curveSegments:12,_=void 0!==i.steps?i.steps:1,y=i.extrudePath,S=!1,b=i.material,x=i.extrudeMaterial,w=void 0!==i.UVGenerator?i.UVGenerator:r.ExtrudeGeometry.WorldUVGenerator;this.shapebb;y&&(n=y.getSpacedPoints(_),S=!0,m=!1,s=void 0!==i.frames?i.frames:new e.TubeGeometry.FrenetFrames(y,_,!1),a=new e.Vector3,o=new e.Vector3,l=new e.Vector3),m||(g=0,p=0,f=0);var P=this,C=this.vertices.length,M=t.extractPoints(v),E=M.shape,T=M.holes,A=!e.Shape.Utils.isClockWise(E);if(A){for(E=E.reverse(),c=0,d=T.length;c<d;c++)h=T[c],e.Shape.Utils.isClockWise(h)&&(T[c]=h.reverse());A=!1}var D=e.Shape.Utils.triangulateShape(E,T),I=E;for(c=0,d=T.length;c<d;c++)h=T[c],E=E.concat(h);function R(e,t,i){return t||console.log("die"),t.clone().multiplyScalar(i).add(e)}var O,L,B,F,V,G,N=E.length,U=D.length;I.length,Math.PI;function k(t,i,n){return function(t,i,n){var s,a,o,l,h,c,d=r.ExtrudeGeometry.__v1,u=r.ExtrudeGeometry.__v2,p=r.ExtrudeGeometry.__v3,f=r.ExtrudeGeometry.__v4,g=r.ExtrudeGeometry.__v5,m=r.ExtrudeGeometry.__v6;if(d.set(t.x-i.x,t.y-i.y),u.set(t.x-n.x,t.y-n.y),s=d.normalize(),a=u.normalize(),p.set(-s.y,s.x),f.set(a.y,-a.x),g.copy(t).add(p),m.copy(t).add(f),g.equals(m))return f.clone();g.copy(i).add(p),m.copy(n).add(f),o=s.dot(f),l=m.sub(g).dot(f),0===o&&(console.log("Either infinite or no solutions!"),0===l?console.log("Its finite solutions."):console.log("Too bad, no solutions."));if(h=l/o,h<0)return function(t,i,r){var n=Math.atan2(i.y-t.y,i.x-t.x),s=Math.atan2(r.y-t.y,r.x-t.x);n>s&&(s+=2*Math.PI);var a=(n+s)/2,o=-Math.cos(a),l=-Math.sin(a);return new e.Vector2(o,l)}(t,i,n);return c=s.multiplyScalar(h).add(g),c.sub(t).clone()}(t,i,n)}for(var z=[],H=0,W=I.length,j=W-1,X=H+1;H<W;H++,j++,X++){j===W&&(j=0),X===W&&(X=0);I[H],I[j],I[X];z[H]=k(I[H],I[j],I[X])}var q,Z,Y=[],K=z.concat();for(c=0,d=T.length;c<d;c++){for(h=T[c],q=[],H=0,j=(W=h.length)-1,X=H+1;H<W;H++,j++,X++)j===W&&(j=0),X===W&&(X=0),q[H]=k(h[H],h[j],h[X]);Y.push(q),K=K.concat(q)}for(O=0;O<g;O++){for(F=p*(1-(B=O/g)),L=f*Math.sin(B*Math.PI/2),H=0,W=I.length;H<W;H++)Q((V=R(I[H],z[H],L)).x,V.y,-F);for(c=0,d=T.length;c<d;c++)for(h=T[c],q=Y[c],H=0,W=h.length;H<W;H++)Q((V=R(h[H],q[H],L)).x,V.y,-F)}for(L=f,H=0;H<N;H++)V=m?R(E[H],K[H],L):E[H],S?(o.copy(s.normals[0]).multiplyScalar(V.x),a.copy(s.binormals[0]).multiplyScalar(V.y),l.copy(n[0]).add(o).add(a),Q(l.x,l.y,l.z)):Q(V.x,V.y,0);for(Z=1;Z<=_;Z++)for(H=0;H<N;H++)V=m?R(E[H],K[H],L):E[H],S?(o.copy(s.normals[Z]).multiplyScalar(V.x),a.copy(s.binormals[Z]).multiplyScalar(V.y),l.copy(n[Z]).add(o).add(a),Q(l.x,l.y,l.z)):Q(V.x,V.y,u/_*Z);for(O=g-1;O>=0;O--){for(F=p*(1-(B=O/g)),L=f*Math.sin(B*Math.PI/2),H=0,W=I.length;H<W;H++)Q((V=R(I[H],z[H],L)).x,V.y,u+F);for(c=0,d=T.length;c<d;c++)for(h=T[c],q=Y[c],H=0,W=h.length;H<W;H++)V=R(h[H],q[H],L),S?Q(V.x,V.y+n[_-1].y,n[_-1].x+F):Q(V.x,V.y,u+F)}function $(e,t){var i,r;for(H=e.length;--H>=0;){i=H,(r=H-1)<0&&(r=e.length-1);var n=0,s=_+2*g;for(n=0;n<s;n++){var a=N*n,o=N*(n+1);ee(t+i+a,t+r+a,t+r+o,t+i+o,e,n,s,i,r)}}}function Q(t,i,r){P.vertices.push(new e.Vector3(t,i,r))}function J(r,n,s,a){r+=C,n+=C,s+=C,P.faces.push(new e.Face3(r,n,s,null,null,b));var o=a?w.generateBottomUV(P,t,i,r,n,s):w.generateTopUV(P,t,i,r,n,s);P.faceVertexUvs[0].push(o)}function ee(r,n,s,a,o,l,h,c,d){r+=C,n+=C,s+=C,a+=C,P.faces.push(new e.Face4(r,n,s,a,null,null,x));var u=w.generateSideWallUV(P,t,o,i,r,n,s,a,l,h,c,d);P.faceVertexUvs[0].push(u)}!function(){if(m){var e=0,t=N*e;for(H=0;H<U;H++)J((G=D[H])[2]+t,G[1]+t,G[0]+t,!0);for(t=N*(e=_+2*g),H=0;H<U;H++)J((G=D[H])[0]+t,G[1]+t,G[2]+t,!1)}else{for(H=0;H<U;H++)J((G=D[H])[2],G[1],G[0],!0);for(H=0;H<U;H++)J((G=D[H])[0]+N*_,G[1]+N*_,G[2]+N*_,!1)}}(),function(){var e=0;for($(I,e),e+=I.length,c=0,d=T.length;c<d;c++)$(h=T[c],e),e+=h.length}()},r.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(t,i,r,n,s,a){var o=t.vertices[n].x,l=t.vertices[n].y,h=t.vertices[s].x,c=t.vertices[s].y,d=t.vertices[a].x,u=t.vertices[a].y;return[new e.Vector2(o,l),new e.Vector2(h,c),new e.Vector2(d,u)]},generateBottomUV:function(e,t,i,r,n,s){return this.generateTopUV(e,t,i,r,n,s)},generateSideWallUV:function(t,i,r,n,s,a,o,l,h,c,d,u){var p=t.vertices[s].x,f=t.vertices[s].y,g=t.vertices[s].z,m=t.vertices[a].x,v=t.vertices[a].y,_=t.vertices[a].z,y=t.vertices[o].x,S=t.vertices[o].y,b=t.vertices[o].z,x=t.vertices[l].x,w=t.vertices[l].y,P=t.vertices[l].z;return Math.abs(f-v)<.01?[new e.Vector2(p,1-g),new e.Vector2(m,1-_),new e.Vector2(y,1-b),new e.Vector2(x,1-P)]:[new e.Vector2(f,1-g),new e.Vector2(v,1-_),new e.Vector2(S,1-b),new e.Vector2(w,1-P)]}},r.ExtrudeGeometry.__v1=new e.Vector2,r.ExtrudeGeometry.__v2=new e.Vector2,r.ExtrudeGeometry.__v3=new e.Vector2,r.ExtrudeGeometry.__v4=new e.Vector2,r.ExtrudeGeometry.__v5=new e.Vector2,r.ExtrudeGeometry.__v6=new e.Vector2,r.ShapeGeometry=function(e,t){r.LegacyGeometry.call(this),e instanceof Array==!1&&(e=[e]),this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()},r.ShapeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ShapeGeometry.prototype.addShapeList=function(e,t){for(var i=0,r=e.length;i<r;i++)this.addShape(e[i],t);return this},r.ShapeGeometry.prototype.addShape=function(t,i){void 0===i&&(i={});var n,s,a,o=void 0!==i.curveSegments?i.curveSegments:12,l=i.material,h=void 0===i.UVGenerator?r.ExtrudeGeometry.WorldUVGenerator:i.UVGenerator,c=(this.shapebb,this.vertices.length),d=t.extractPoints(o),u=d.shape,p=d.holes,f=!e.Shape.Utils.isClockWise(u);if(f){for(u=u.reverse(),n=0,s=p.length;n<s;n++)a=p[n],e.Shape.Utils.isClockWise(a)&&(p[n]=a.reverse());f=!1}var g=e.Shape.Utils.triangulateShape(u,p),m=u;for(n=0,s=p.length;n<s;n++)a=p[n],u=u.concat(a);var v,_,y=u.length,S=g.length;m.length;for(n=0;n<y;n++)v=u[n],this.vertices.push(new e.Vector3(v.x,v.y,0));for(n=0;n<S;n++){var b=(_=g[n])[0]+c,x=_[1]+c,w=_[2]+c;this.faces.push(new e.Face3(b,x,w,null,null,l)),this.faceVertexUvs[0].push(h.generateBottomUV(this,t,i,b,x,w))}},r.PlaneGeometry=function(t,i,n,s){var a,o;r.LegacyGeometry.call(this),this.width=t,this.height=i,this.widthSegments=n||1,this.heightSegments=s||1;var l=t/2,h=i/2,c=this.widthSegments,d=this.heightSegments,u=c+1,p=d+1,f=this.width/c,g=this.height/d,m=new e.Vector3(0,0,1);for(o=0;o<p;o++)for(a=0;a<u;a++){var v=a*f-l,_=o*g-h;this.vertices.push(new e.Vector3(v,-_,0))}for(o=0;o<d;o++)for(a=0;a<c;a++){var y=a+u*o,S=a+u*(o+1),b=a+1+u*(o+1),x=a+1+u*o,w=new e.Face4(y,S,b,x);w.normal.copy(m),w.vertexNormals.push(m.clone(),m.clone(),m.clone(),m.clone()),this.faces.push(w),this.faceVertexUvs[0].push([new e.Vector2(a/c,1-o/d),new e.Vector2(a/c,1-(o+1)/d),new e.Vector2((a+1)/c,1-(o+1)/d),new e.Vector2((a+1)/c,1-o/d)])}this.computeCentroids()},r.PlaneGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.SphereGeometry=function(t,i,n,s,a,o,l){r.LegacyGeometry.call(this),this.radius=t||50,this.widthSegments=Math.max(3,Math.floor(i)||8),this.heightSegments=Math.max(2,Math.floor(n)||6),s=void 0!==s?s:0,a=void 0!==a?a:2*Math.PI,o=void 0!==o?o:0,l=void 0!==l?l:Math.PI;var h,c,d=[],u=[];for(c=0;c<=this.heightSegments;c++){var p=[],f=[];for(h=0;h<=this.widthSegments;h++){var g=h/this.widthSegments,m=c/this.heightSegments,v=new e.Vector3;v.x=-this.radius*Math.cos(s+g*a)*Math.sin(o+m*l),v.y=this.radius*Math.cos(o+m*l),v.z=this.radius*Math.sin(s+g*a)*Math.sin(o+m*l),this.vertices.push(v),p.push(this.vertices.length-1),f.push(new e.Vector2(g,1-m))}d.push(p),u.push(f)}for(c=0;c<this.heightSegments;c++)for(h=0;h<this.widthSegments;h++){var _=d[c][h+1],y=d[c][h],S=d[c+1][h],b=d[c+1][h+1],x=this.vertices[_].clone().normalize(),w=this.vertices[y].clone().normalize(),P=this.vertices[S].clone().normalize(),C=this.vertices[b].clone().normalize(),M=u[c][h+1].clone(),E=u[c][h].clone(),T=u[c+1][h].clone(),A=u[c+1][h+1].clone();Math.abs(this.vertices[_].y)===this.radius?(this.faces.push(new e.Face3(_,S,b,[x,P,C])),this.faceVertexUvs[0].push([M,T,A])):Math.abs(this.vertices[S].y)===this.radius?(this.faces.push(new e.Face3(_,y,S,[x,w,P])),this.faceVertexUvs[0].push([M,E,T])):(this.faces.push(new e.Face4(_,y,S,b,[x,w,P,C])),this.faceVertexUvs[0].push([M,E,T,A]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.SphereGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.TextGeometry=function(t,i){var n=e.FontUtils.generateShapes(t,i);i.amount=void 0!==i.height?i.height:50,void 0===i.bevelThickness&&(i.bevelThickness=10),void 0===i.bevelSize&&(i.bevelSize=8),void 0===i.bevelEnabled&&(i.bevelEnabled=!1),r.ExtrudeGeometry.call(this,n,i)},r.TextGeometry.prototype=Object.create(r.ExtrudeGeometry.prototype),r})),define("DS/Visualization/ImageLoaders/Basis",["DS/WAFData/WAFData","DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats"],(function(e,t,i){"use strict";var r=null,n="DS/BasisLoader/BasisLoader",s=function(e,i,r,n,s,a){var o=r.s3tcSupport,l=r.astcSupport,h=r.astcHDRSupport,c=r.etcSupport,d=r.etc1Support,u=r.pvrtcSupport,p=r.rgtcSupport,f=r.bptcSupport,g=r.basisUsage,m=r.noRGB,v=!1,_=!1;switch(g){case 0:return r.orignalBasisUsage===t.RGB_BPTC_UNSIGNED_FLOAT_Format?(e.textureFormat=m?t.RGBAFormat:t.RGBFormat,e.transcodeFormat=m?i.cTFRGBA_HALF:i.cTFRGB_HALF,void(e.textureType=t.HalfFloatType)):(e.textureFormat=t.RGBAFormat,e.transcodeFormat=i.cTFRGBA32,void(e.textureType=t.UnsignedByteType));case t.RGB_S3TC_DXT1_Format:if(o)return e.textureFormat=g,e.transcodeFormat=i.cTFBC1_RGB,void(m&&(e.textureFormat=t.RGBA_S3TC_DXT5_Format,e.transcodeFormat=i.cTFBC3_RGBA));break;case t.RGBA_S3TC_DXT5_Format:if(o)return e.textureFormat=g,void(e.transcodeFormat=i.cTFBC3_RGBA);break;case t.RED_RGTC1_Format:if(p)return e.textureFormat=g,void(e.transcodeFormat=i.cTFBC4_R);v=!0;break;case t.REDGREEN_RGTC2_Format:if(p)return e.textureFormat=g,void(e.transcodeFormat=i.cTFBC5_RG);v=!0;break;case t.RGBA_BPTC_UNORM_Format:if(f)return e.textureFormat=g,void(e.transcodeFormat=n||m?i.cTFBC7_M5_RGBA:i.cTFBC7_M6_RGB);if(o)return e.textureFormat=n||m?t.RGBA_S3TC_DXT5_Format:t.RGB_S3TC_DXT1_Format,void(e.transcodeFormat=n||m?i.cTFBC3_RGBA:i.cTFBC1_RGB);v=!0;break;case t.RGB_BPTC_UNSIGNED_FLOAT_Format:if(f)return e.textureFormat=g,void(e.transcodeFormat=i.cTFBC6H);_=!0}if(_){if(l&&h)return e.textureFormat=t.RGBA_ASTC_4x4_Format,void(e.transcodeFormat=i.cTFASTC_HDR_4x4_RGBA);e.textureFormat=m?t.RGBAFormat:t.RGBFormat,e.transcodeFormat=m?i.cTFRGBA_HALF:i.cTFRGB_HALF,e.textureType=t.HalfFloatType}else{if(l)return e.textureFormat=t.RGBA_ASTC_4x4_Format,void(e.transcodeFormat=i.cTFASTC_4x4_RGBA);if(u)if(e.textureFormat=t.RGB_PVRTC_4BPPV1_Format,e.transcodeFormat=i.cTFPVRTC1_4_RGB,(n||m)&&(e.textureFormat=t.RGBA_PVRTC_4BPPV1_Format,e.transcodeFormat=i.cTFPVRTC1_4_RGBA),0!=(s&s-1)||0!=(a&a-1))console.error("ERROR: PVRTC1 requires square power of 2 textures");else{if(s==a)return;console.error("ERROR: PVRTC1 requires square power of 2 textures")}else{if(d&&!n&&!m)return e.textureFormat=t.RGB_ETC1_Format,void(e.transcodeFormat=i.cTFETC1_RGB);if(c)return e.textureFormat=t.RGBA8_ETC2_EAC_Format,void(e.transcodeFormat=i.cTFETC2_RGBA)}v||m?(t.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 8888 fallback"),e.textureFormat=t.RGBAFormat,e.transcodeFormat=i.cTFRGBA32,e.textureType=t.UnsignedByteType):n?(t.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 4444 fallback"),e.textureFormat=t.RGBAFormat,e.transcodeFormat=i.cTFRGBA4444,e.textureType=t.UnsignedShort4444Type):(t.VisualizationTraces.info("No supported compression format for basis/ktx2, rgb ushort565 fallback"),e.textureFormat=t.RGBFormat,e.transcodeFormat=i.cTFRGB565,e.textureType=t.UnsignedShort565Type)}},a=function(e,t,i,r,n){var s=document.createElement("canvas");s.width=t,s.height=i;var a=s.getContext("2d"),o=a.getImageData(0,0,t,i);o.data.set(new Uint8ClampedArray(e)),a.putImageData(o,0,0);var l=document.createElement("canvas"),h=l.getContext("2d");return l.width=r,l.height=n,h.drawImage(s,0,0,t,i,0,0,r,n),o=h.getImageData(0,0,r,n),new Uint8Array(o.data)};return function(o){const l={NOT_BASIS:-1,NO_TRANSCODE:0,RGB:i.RGB_S3TC_DXT1_Format,RGBA:i.RGBA_S3TC_DXT5_Format,RGBHQ:i.RGBA_BPTC_UNORM_Format,NORMAL_MAP:i.REDGREEN_RGTC2_Format,GRAYSCALE:i.RED_RGTC1_Format,BC1:i.RGB_S3TC_DXT1_Format,BC3:i.RGBA_S3TC_DXT5_Format,BC7:i.RGBA_BPTC_UNORM_Format,BC5:i.REDGREEN_RGTC2_Format,BC4:i.RED_RGTC1_Format};t.BasisUsage=l,o.__initBasis__=function(e){null===r?require([n],(function(t){(r=t)((function(){e()}))})):r((function(){e()}))},o.loadKTX2Texture=function(e,i,h,c,d,u,p){var f=!!t.supportedExtensions.compressedTextureS3TC,g=!!t.supportedExtensions.compressedTextureRGTC,m=!t.supportedExtensions.compressedTextureBPTC,v=!!t.supportedExtensions.compressedTextureASTC,_=!!t.supportedExtensions.compressedTextureASTCHDR,y=!!t.supportedExtensions.compressedTextureETC,S=!!t.supportedExtensions.compressedTextureETC1,b=!!t.supportedExtensions.compressedTexturePVRTC,x=t.supportedExtensions.noRGBTextures,w=new t.CompressedTexture;if(w.image={},i&&(w.mapping=i),null===u||u===l.NOT_BASIS)return w.loadEndStatus=t.AssetLoadingStatus.ERROR,console.error("Missing required format parameter"),w;var P=function(){var i;i=function(i,r){if(!i)return w.loadEndStatus=t.AssetLoadingStatus.ERROR,console.error("Missing KTX2File in BasisLoader"),void(c&&c());!function(e,i,r,n,l,h,c,d){var u=function(n){var l=function(e,i){console.warn(i),r.loadEndStatus=t.AssetLoadingStatus.ERROR,c&&c(),e.close(),e.delete()},u=new e(new Uint8Array(n));if(!1!==r.flipY&&(console.warn("Non matching image convention for ktx2 texture, full rgba 8888 decompression for flipping"),d.basisUsage=0),u.isValid()){var p=u.getLevels();if(p<1)l(u,"No levels in .ktx2 file");else{var f=u.getFaces();if(f>1)if(6!==f)f=1;else{r.extraFaces=new Array(5);for(var g=0;g<5;g++)r.extraFaces[g]=new t.Texture.Face(null,[])}if(u.getHeader().pixelDepth>0)l(u,"Non 2D textures are not supported in .ktx2 files");else if(u.getLayers()>0)l(u,"Array textures are not supported in .ktx2 files");else if(u.startTranscoding()){var m=u.getWidth(),v=u.getHeight(),_={textureFormat:0,transcodeFormat:0,textureType:0},y=!1;o.is_pow2(m)&&o.is_pow2(v)||(console.warn("Non power of two compressed ktx2 texture, full rgba 8888 decompression for resizing"),y=!0,d.basisUsage=0);var S=u.getHasAlpha();s(_,i,d,S,m,v),r.format=_.textureFormat,0!==_.textureType&&(r.flipY=!1!==r.flipY,r.type=_.textureType),r.sRGB=2===u.getDFDTransferFunc(),r.premultipliedAlpha=(1&u.getDFDFlags())>0;for(var b=0;b<f;b++){const e=0===b?r.mipmaps:r.extraFaces[b-1].mipmaps;for(var x=0;x<p;x++){var w=u.getImageLevelInfo(x,0,b);m=w.origWidth,v=w.origHeight;var P={data:null,width:0,height:0};e.push(P);var C=u.getImageTranscodedSizeInBytes(x,0,b,_.transcodeFormat),M=new Uint8Array(C);if(!u.transcodeImage(M,x,0,b,_.transcodeFormat,S,-1,-1))return void l(u,"transcodeImage failed");var E=m>=4?m+3&-4:m,T=v>=4?v+3&-4:v;if(P.width=E,P.height=T,y)if(o.is_pow2(m)&&o.is_pow2(v))P.data=M;else{if(_.textureType===t.HalfFloatType)return void l(u,"Can not resize float textures");t.VisualizationTraces.info("Resizing ktx2 texture to power of two"),P.width=o.nearest_smaller_pow2(m),P.height=o.nearest_smaller_pow2(v),P.data=a(M,m,v,P.width,P.height)}else _.textureType===t.HalfFloatType||_.textureType===t.UnsignedShort565Type||_.textureType===t.UnsignedShort4444Type?P.data=new Uint16Array(M.buffer):P.data=M}}for(u.close(),u.delete(),r.loadEndStatus=t.AssetLoadingStatus.READY,r.needsUpdate=!0,h&&h(r),g=0;g<r.onLoadCallbacks.length;g++)r.onLoadCallbacks[g](r)}else l(u,"startTranscoding failed")}}else l(u,"Invalid .ktx2 file")};if("string"==typeof n){var p=new XMLHttpRequest;p.withCredentials=!!l,p.responseType="arraybuffer",p.open("GET",n,!0),p.onload=function(){o.nbTexturesBeingLoaded--,u(p.response)},p.onerror=function(){r.loadEndStatus=t.AssetLoadingStatus.ERROR,c&&c(),o.nbTexturesBeingLoaded--},o.nbTexturesBeingLoaded++,r.loadEndStatus=t.AssetLoadingStatus.LOADING,p.send(null)}else{if(!(n instanceof Uint8Array))return void console.error("Invalid ktx2 data: returning empty texture");u(n.buffer)}}(i,r,w,e,d,h,c,{s3tcSupport:f,astcSupport:v,astcHDRSupport:_,etc1Support:S,etcSupport:y,pvrtcSupport:b,rgtcSupport:g,bptcSupport:m,basisUsage:u,orignalBasisUsage:u,noRGB:x})},null===r?require([n],(function(e){(r=e)((function(e){i(e.KTX2File,e.BasisFormat)}))})):r((function(e){i(e.KTX2File,e.BasisFormat)}))};return p?(w.loadEndStatus=t.AssetLoadingStatus.PAUSED,w.onRequest=function(){w.loadEndStatus=t.AssetLoadingStatus.LOADING,P(),w.onRequest=null}):(w.loadEndStatus=t.AssetLoadingStatus.LOADING,P()),w},o.loadBasisTexture=function(i,h,c,d,u,p,f,g){var m=!!t.supportedExtensions.compressedTextureS3TC,v=!!t.supportedExtensions.compressedTextureRGTC,_=!!t.supportedExtensions.compressedTextureBPTC,y=!!t.supportedExtensions.compressedTextureASTC,S=!!t.supportedExtensions.compressedTextureASTCHDR,b=!!t.supportedExtensions.compressedTextureETC,x=!!t.supportedExtensions.compressedTextureETC1,w=!!t.supportedExtensions.compressedTexturePVRTC,P=t.supportedExtensions.noRGBTextures,C=g||new t.CompressedTexture;if(C.image={},h&&(C.mapping=h),null===p||p===l.NOT_BASIS)return C.loadEndStatus=t.AssetLoadingStatus.ERROR,console.error("Missing required format parameter"),C;var M=function(){var l;l=function(r,n){if(!r)return C.loadEndStatus=t.AssetLoadingStatus.ERROR,console.error("Missing BasisFile in BasisLoader"),void(d&&d());!function(i,r,n,l,h,c,d,u){var p=function(e){var l=function(e,i){console.warn(i),n.loadEndStatus=t.AssetLoadingStatus.ERROR,d&&d(),e.close(),e.delete()},h=new i(new Uint8Array(e)),p=h.getFileDesc().yFlipped;p!==n.flipY&&(console.warn("Non matching image convention for basis texture, full rgba 8888 decompression for flipping"),u.basisUsage=0);var f=h.getNumImages(),g=h.getNumLevels(0);if(f&&g)if(h.startTranscoding()){var m=h.getImageWidth(0,0),v=h.getImageHeight(0,0);if(f>1)if(6!==f)f=1;else{for(var _=!1,y=0;y<f;y++){var S=h.getNumLevels(y),b=h.getImageWidth(y,0),x=h.getImageHeight(y,0);if(_=S!==g||b!==m||x!==v)break}if(_)f=1;else{n.extraFaces=new Array(5);for(var w=0;w<5;w++)n.extraFaces[w]=new t.Texture.Face(null,[])}}var P={textureFormat:0,transcodeFormat:0,textureType:0},C=!1;o.is_pow2(m)&&o.is_pow2(v)||(console.warn("Non power of two compressed basis texture, full rgba 8888 decompression for resizing"),C=!0,u.basisUsage=0);var M=h.getHasAlpha();for(s(P,r,u,M,m,v),n.format=P.textureFormat,0!==P.textureType&&(n.flipY=p!==n.flipY,n.type=P.textureType),y=0;y<f;y++){const e=0===y?n.mipmaps:n.extraFaces[y-1].mipmaps;for(var E=0;E<g;E++){m=h.getImageWidth(y,E),v=h.getImageHeight(y,E);var T={data:null,width:0,height:0};e.push(T);var A=h.getImageTranscodedSizeInBytes(y,E,P.transcodeFormat),D=new Uint8Array(A);if(!h.transcodeImage(D,y,E,P.transcodeFormat,0,M))return void l(h,"transcodeImage failed");var I=m>=4?m+3&-4:m,R=v>=4?v+3&-4:v;if(T.width=I,T.height=R,C)if(o.is_pow2(m)&&o.is_pow2(v))T.data=D;else{if(P.textureType===t.HalfFloatType)return void l(h,"Can not resize float textures");t.VisualizationTraces.info("Resizing basis texture to power of two"),T.width=o.nearest_smaller_pow2(m),T.height=o.nearest_smaller_pow2(v),T.data=a(D,m,v,T.width,T.height)}else P.textureType===t.HalfFloatType||P.textureType===t.UnsignedShort565Type||P.textureType===t.UnsignedShort4444Type?T.data=new Uint16Array(D.buffer):T.data=D}}for(h.close(),h.delete(),n.loadEndStatus=t.AssetLoadingStatus.READY,n.needsUpdate=!0,c&&c(n),w=0;w<n.onLoadCallbacks.length;w++)n.onLoadCallbacks[w](n)}else l(h,"startTranscoding failed");else l(h,"Invalid .basis file")};if("string"==typeof l)o.nbTexturesBeingLoaded++,n.loadEndStatus=t.AssetLoadingStatus.LOADING,e.authenticatedRequest(l,{method:"GET",cors:!0,timeout:36e5,type:"arraybuffer",onComplete:(e,t,i)=>{o.nbTexturesBeingLoaded--,p(i.response)},onFailure:e=>{n.loadEndStatus=t.AssetLoadingStatus.ERROR,d&&d(),o.nbTexturesBeingLoaded--}});else{if(!(l instanceof Uint8Array))return void console.error("Invalid basis data: returning empty texture");p(l.buffer)}}(r,n,C,i,0,c,d,{s3tcSupport:m,astcSupport:y,astcHDRSupport:S,etc1Support:x,etcSupport:b,pvrtcSupport:w,rgtcSupport:v,bptcSupport:_,basisUsage:p,orignalBasisUsage:p,noRGB:P})},null===r?require([n],(function(e){(r=e)((function(e){l(e.BasisFile,e.BasisFormat)}))})):r((function(e){l(e.BasisFile,e.BasisFormat)}))};return f?(C.loadEndStatus=t.AssetLoadingStatus.PAUSED,C.onRequest=function(){C.loadEndStatus=t.AssetLoadingStatus.LOADING,M(),C.onRequest=null}):(C.loadEndStatus=t.AssetLoadingStatus.LOADING,M()),C}}})),define("DS/Visualization/ImageLoaders/HDR",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats"],(function(e,t){"use strict";return function(t){t.loadHDRTexture=function(i,r,n,s,a,o,l,h,c,d){var u=d||new e.DataTexture;u.loadEndStatus=e.AssetLoadingStatus.LOADING,u.hdr=!0,u.sRGB=!1,a||(u.encoding=e.RGBE_Encoding,u.magFilter=e.NearestFilter,u.minFilter=e.NearestFilter),u.mapping=r,u.needsSH=!1,u.shFactorsR=null,u.shFactorsG=null,u.shFactorsB=null;var p=new XMLHttpRequest;return p.onload=function(){t.nbTexturesBeingLoaded--;var i=function(t,i,r,n,s){var a,o={data:null,width:0,height:0,format:r?e.RGBFormat:e.RGBAFormat,type:r?e.FloatType:e.UnsignedByteType},l={offset:0,data:new Uint8Array(t)},h="";for(a=0;a<10;a++)h+=String.fromCharCode(l.data[l.offset++]);if("#?RADIANCE"!==h)return o;for(var c,d=0;c=d,10!=(d=l.data[l.offset++])||10!=c;);for(var u="";10!=(d=l.data[l.offset++]);)u+=String.fromCharCode(d);if(null===new RegExp(/[-,+][X,Y]\s+([0-9]+)\s+[-,+][X,Y]\s+([0-9]+)/i).exec(u))return o;o.height=RegExp.$1,o.width=RegExp.$2,o.data=r?new Float32Array(o.width*o.height*3):new Uint8Array(o.width*o.height*4);for(var p=new Uint8Array(4*o.width),f=n?(o.height-1)*(r?3:4)*o.width:0,g=function(e,t){return.00390625*t*e},m=function(e,t,i,r){for(s&&(r+=3*(t-1));t-- >0;){var n=Math.pow(2,e[4*t+3]-128);i[r++]=g(n,e[4*t]),i[r++]=g(n,e[4*t+1]),i[r++]=g(n,e[4*t+2]),s&&(r-=6)}},v=function(e,t,i,r){for(;t-- >0;)i[r++]=e[4*t],i[r++]=e[4*t+1],i[r++]=e[4*t+2],i[r++]=e[4*t+3]},_=function(e,t,i){var r,n;if(t<8||t>32767)return y(e,0,t,i);if(2!==(r=i.data[i.offset]))return y(e,0,t,i);if(i.offset++,e[1]=i.data[i.offset++],e[2]=i.data[i.offset++],r=i.data[i.offset++],2!=e[1]||128&e[2])return e[0]=2,e[3]=r,y(e,1,t-1,i);for(r=0;r<4;r++)for(n=0;n<t;){var s=i.data[i.offset++];if(s>128){s&=127;for(var a=i.data[i.offset++];s--;)e[4*n+r]=a,n++}else for(;s--;)e[4*n+r]=i.data[i.offset++],n++}return!(i.data.length===i.offset)},y=function(e,t,i,r){for(var n,s=0;i>0;)if(e[4*t]=r.data[r.offset++],e[4*t+1]=r.data[r.offset++],e[4*t+2]=r.data[r.offset++],e[4*t+3]=r.data[r.offset++],1===e[4*t]&&1===e[4*t+1]&&1===e[4*t+2]){for(n=e[4*t+3]<<s;n>0;n--)e[4*t]=e[4*(t-1)],e[4*t+1]=e[4*(t-1)+1],e[4*t+2]=e[4*(t-1)+2],e[4*t+3]=e[4*(t-1)+3],t++,i--;s+=8}else t++,i--,s=0;return!0},S=o.height-1;S>=0;S--)_(p,o.width,l),r?(m(p,o.width,o.data,f),n?f-=3*o.width:f+=3*o.width):(v(p,o.width,o.data,f),f+=4*o.width);return o}(p.response,0,a,o,l);if(!t.is_pow2(i.width)||!t.is_pow2(i.height)){var r=t.nearest_pow2(i.width),s=t.nearest_pow2(i.height);!function(e,t,i,r){if(t){for(var n=new Float32Array(3*i*r),s=(e.width-1)/(i-1),a=(e.height-1)/(r-1),o=0;o<r;o++)for(var l=0;l<i;l++){var h=i*o+l,c=s*l,d=a*o,u=e.width*Math.floor(d)+Math.floor(c);n[3*h]=e.data[3*u],n[3*h+1]=e.data[3*u+1],n[3*h+2]=e.data[3*u+2]}e.data=n,e.width=i,e.height=r}}(i,a,r,s)}u.format=i.format,u.type=i.type,u.image.data=i.data,u.image.width=i.width,u.image.height=i.height,u.loadEndStatus=e.AssetLoadingStatus.READY,u.needsSH&&function(t){t.mapping;var i,r,n=t.image.data,s=t.image.width,a=t.image.height;if(void 0!==n){if(null===t.shFactorsR){var o=[];for(i=0;i<3;i++)for(o[i]=[],r=0;r<9;r++)o[i][r]=0;var l=function(e){return Math.abs(e)<1e-4?1:Math.sin(e)/e},h=function(e,t,i,r,a,l){var h,c=4*(s*t+e),d=Math.pow(2,n[c+3]-128);for(h=0;h<3;h++){var u,p=1/256*n[c+h]*d;u=.282095,o[h][0]+=p*u*i,u=.488603,o[h][1]+=p*(u*a)*i,o[h][2]+=p*(u*l)*i,o[h][3]+=p*(u*r)*i,u=1.092548,o[h][4]+=p*(u*r*a)*i,o[h][5]+=p*(u*a*l)*i,o[h][7]+=p*(u*r*l)*i,u=.315392,o[h][6]+=p*(u*(3*l*l-1))*i,u=.546274,o[h][8]+=p*(u*(r*r-a*a))*i}return o};if(t.mapping instanceof e.LatLongReflectionMapping)for(r=0;r<a;r++)for(i=0;i<s;i++)c=i/s,d=r/a,f=Math.PI*(2*c-1),p=Math.PI*d,g=Math.sin(p)*Math.cos(f),m=Math.sin(p)*Math.sin(f),v=Math.cos(p),h(i,r,Math.PI/s*2*(Math.PI/a)*Math.sin(p),g,m,v);else for(i=0;i<s;i++)for(r=0;r<s;r++){var c,d,u,p,f,g,m,v;d=(s/2-i)/(s/2),c=(r-s/2)/(s/2),(u=Math.sqrt(c*c+d*d))>1||(p=Math.PI*u,f=Math.atan2(d,c),g=Math.sin(p)*Math.cos(f),m=Math.sin(p)*Math.sin(f),v=Math.cos(p),h(i,r,2*Math.PI/s*(2*Math.PI/s)*l(p),g,m,v))}var _=function(){var t,i,r;i=.429043,r=.511664;var n=[];for(n[0]=new e.Matrix4,n[1]=new e.Matrix4,n[2]=new e.Matrix4,t=0;t<3;t++)n[t].elements[0]=i*o[t][8],n[t].elements[1]=i*o[t][4],n[t].elements[2]=i*o[t][7],n[t].elements[3]=r*o[t][3],n[t].elements[4]=i*o[t][4],n[t].elements[5]=-i*o[t][8],n[t].elements[6]=i*o[t][5],n[t].elements[7]=r*o[t][1],n[t].elements[8]=i*o[t][7],n[t].elements[9]=i*o[t][5],n[t].elements[10]=.743125*o[t][6],n[t].elements[11]=r*o[t][2],n[t].elements[12]=r*o[t][3],n[t].elements[13]=r*o[t][1],n[t].elements[14]=r*o[t][2],n[t].elements[15]=.886227*o[t][0]-.247708*o[t][6];return n}();null!==_&&(t.shFactorsR=_[0],t.shFactorsG=_[1],t.shFactorsB=_[2])}}else t.needsSH=!0}(u),u.generateMipmaps=!0,u.needsUpdate=!0,n&&n(u);for(var h=0;h<u.onLoadCallbacks.length;h++)u.onLoadCallbacks[h](u)},p.onerror=function(){u.loadEndStatus=e.AssetLoadingStatus.ERROR,s&&s(),t.nbTexturesBeingLoaded--},c?(u.loadEndStatus=e.AssetLoadingStatus.PAUSED,u.onRequest=function(){u.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,p.open("GET",i,!0),p.responseType="arraybuffer",p.withCredentials=!!h,p.send(null),u.onRequest=null}):(u.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,p.open("GET",i,!0),p.responseType="arraybuffer",p.withCredentials=!!h,p.send(null)),u},t.streamHDRFormat=function(e,t,i){for(var r=function(e,t){var i=function(e,t,i){for(var r=0;r<t.length;r++)e[i++]=t.charCodeAt(r);return i},r="#?RADIANCE",n="# Made with Dassault Systemes HDR mipmap roughness generator - TZW",s="FORMAT=32-bit_rle_rgbe",a="-Y "+t+" +X "+e,o=new Uint8Array(102+a.length+1+e*t*4),l=0;return l=i(o,r,l),o[l++]=10,l=i(o,n,l),o[l++]=10,l=i(o,s,l),o[l++]=10,o[l++]=10,l=i(o,a,l),o[l++]=10,{buffer:o,offset:l,width:e,height:t}}(t,i),n=r.buffer,s=r.offset,a=i-1,o=0;o<i;o++){for(var l=t-1,h=0;h<t;h++){for(var c=0;c<4;c++)n[s+4*(t*o+h)+c]=e[4*(t*a+l)+c];l--}a--}return function(e){for(var t=function(e){for(var t=new Uint8Array(2*e.length),i=0;i<e.length;i++)t[i]=e[i];return t},i=e.offset,r=i,n=new Uint8Array(e.buffer.length),s=0;s<i;s++)n[s]=e.buffer[s];for(var a=new Uint8Array(4+5*e.width),o=0;o<e.height;o++){var l=0;a[l++]=2,a[l++]=2,a[l++]=e.width>>8,a[l++]=255&e.width;for(var h=0;h<4;h++){var c=[];for(s=0;s<e.width;){for(var d=0,u=e.buffer[i+4*(o*e.width+s)+h],p=u;s<e.width&&p===u&&d<127;)d++,s++,u=p,p=e.buffer[i+4*(o*e.width+s)+h];if(d>3){if(c.length){a[l++]=c.length;for(var f=0;f<c.length;f++)a[l++]=c[f];c=[]}a[l++]=128+d,a[l++]=u}else{if(c.length+d>127){for(a[l++]=c.length,f=0;f<c.length;f++)a[l++]=c[f];c=[]}c.push(u),d>1&&c.push(u),d>2&&c.push(u)}}if(c.length)for(a[l++]=c.length,f=0;f<c.length;f++)a[l++]=c[f]}r+l>=n.length&&(n=t(n));for(var g=0;g<l;g++)n[r++]=a[g]}var m=new Uint8Array(r);for(s=0;s<r;s++)m[s]=n[s];e.buffer=m}(r),new Blob([r.buffer],{type:"application/octet-binary"})},t.generateBlankHDRTexture=function(t,i){var r=new e.DataTexture;r.hdr=!0,r.sRGB=!1,r.mapping=new e.LatLongReflectionMapping,r.needsSH=!1,r.shFactorsR=null,r.shFactorsG=null,r.shFactorsB=null,r.format=e.RGBAFormat,r.type=e.UnsignedByteType,r.image.width=t,r.image.height=i,r.loadEndStatus=e.AssetLoadingStatus.READY,r.generateMipmaps=!0,r.needsUpdate=!0;for(var n=new Uint8Array(4*t*i),s=0;s<t*i;s++)n[4*s]=255,n[4*s+1]=255,n[4*s+2]=255,n[4*s+3]=127;return r.image.data=n,r}}})),define("DS/Visualization/SectionBuilder",["DS/Mesh/Mesh"],(function(e){"use strict";var t;function i({geom:e,index_ranges:t,plane:i,deduplication:r=null}){const n=e.vertexPositionArray;function s(e){const t=3*e;return i.x*n[t]+i.y*n[t+1]+i.z*n[t+2]+i.w}const a=[];function o(e){const t=3*e;a.push(n[t],n[t+1],n[t+2])}function l(e,t,i){const r=3*e,s=3*t,o=(1-i)*n[r]+i*n[s],l=(1-i)*n[r+1]+i*n[s+1],h=(1-i)*n[r+2]+i*n[s+2];a.push(o,l,h)}const h=e.vertexIndexArray,c=r?e=>r[h[e]]:e=>h[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=c(e),i=c(e+1),r=c(e+2),n=s(t),a=s(i),h=s(r),d=n*a<=0?-n/(a-n):null,u=a*h<=0?-a/(h-a):null,p=h*n<=0?-h/(n-h):null;if(null===d&&null===u&&null===p)continue;let f=!1;Number.isNaN(d)&&(o(t),o(i),f=!0),Number.isNaN(u)&&(o(i),o(r),f=!0),Number.isNaN(p)&&(o(r),o(t),f=!0),f||(null!==d&&d<1&&l(t,i,d),null!==u&&u<1&&l(i,r,u),null!==p&&p<1&&l(r,t,p))}}return new Float32Array(a)}function r(e,t){const i=e.length;for(let r=0;r<i;r+=3)e[r]+=t.x,e[r+1]+=t.y,e[r+2]+=t.z}function n({renderable:n,clipPlanes:s,sectionLines:a,lineWidth:o=1,color:l="#000000",visibleSpace:h}){if(0===s.length)return null;const c=(new t.Matrix4).copy(n.matrixWorld).transpose(),d=s.map((e=>new t.Vector4(e.normal.x,e.normal.y,e.normal.z,e.constant).applyMatrix4(c))),u=function(e,i){let r=new Map;function n(e,t,i){const n=r.get(e);n?n.push([t,t+i]):r.set(e,[[t,t+i]])}if(e.layer)for(let r=0;r<e.layer.layers.length;r++){const s=e.layer.layers[r].drawableGroup;if(s._geomType!==t.GeomTypeEnum.FACE)continue;const a=e.layer.layers[r].drawableInterval;a.skip(e,i)||n(s.geometry,a.start,a.count)}else{const i=e.geometry.length;for(let r=0;r<i;r++){const i=e.geometry[r];for(let e=0;e<i.drawingGroups.length;e++){const r=i.drawingGroups[e];r._geomType===t.GeomTypeEnum.FACE&&n(i,r.start,r.count)}}}return r}(n,h),p=[];u.forEach(((e,n)=>{const s=function({geom:e,index_ranges:n,planes:s,clipPlanes:a,sectionLines:o,deduplication:l=null}){const h=[];for(let a=0;a<s.length;a++)if(o[a]){const o=s[a],c=i({geom:e,index_ranges:n,plane:o,deduplication:l});r(c,new t.Vector3(o.x,o.y,o.z).normalize().multiplyScalar(5e-4)),h.push(c)}else h.push([]);const c=[];for(let e=0;e<h.length;e++){const t=h[e];let i=t.length;for(let r=0;r<s.length;r++){if(r===e)continue;const n=s[r];let a=0;for(let e=0;e<i;e+=6){const i=t[e],r=t[e+1],s=t[e+2],o=t[e+3],l=t[e+4],h=t[e+5],c=n.x*i+n.y*r+n.z*s+n.w,d=n.x*o+n.y*l+n.z*h+n.w;let u=null;c*d<=0?(u=-c/(d-c),(0===u&&d<0||1===u&&c<0)&&(u=null)):c>0&&(u=NaN),Number.isNaN(u)?a!==e?(t[a++]=i,t[a++]=r,t[a++]=s,t[a++]=o,t[a++]=l,t[a++]=h):a+=6:null!==u&&(t[a++]=(1-u)*i+u*o,t[a++]=(1-u)*r+u*l,t[a++]=(1-u)*s+u*h,c>0?(t[a++]=i,t[a++]=r,t[a++]=s):(t[a++]=o,t[a++]=l,t[a++]=h))}i=a}0!==i&&c.push(t.subarray(0,i))}return c}({geom:n,index_ranges:e=function(e){if(e.length<2)return e;e.sort(((e,t)=>e[0]-t[0]));let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}(e),planes:d,sectionLines:a});p.push(...s)}));let f=0;for(let e=0;e<p.length;e++)f+=p[e].length;const g=new Float32Array(f);let m=0;for(let e=0;e<p.length;e++)g.set(p[e],m),m+=p[e].length;let v=[];for(let e=0;e<f/3;e++)v.push(e);v=new Uint32Array(v);const _=new t.BufferGeometryDS;_.vertexPositionArray=g,_.vertexIndexArray=v,_.boundingSphere=n.boundingSphere,_.boundingBox=n.boundingBox;const y=new t.LineBasicMaterial({color:l,lineWidth:o,force:!0});y.enableClipPlanes=!1,y.side=t.DoubleSide,y.polygonOffset=!0,y.polygonOffsetFactor=-1.5,y.polygonOffsetUnits=-10;const S={start:0,count:_.vertexIndexArray.length},b=new e.DrawingGroup(y,y,1,0,_.vertexIndexArray.length,[S],void 0,0);return _.drawingGroups=[b],b.geometry=_,_}var s=function(e){for(var t=1;t<e;)t*=2;return t};let a=-1;return class{constructor({renderable:e,renderer:i,lineWidth:r,color:n,clipPlanes:s,sectionLines:o}){t=THREEDS.Core,a<0&&(a=localStorage.getItem("useCPUSection")||window.WebVisuUseCPUSection?1:0),this._color=new t.Color(n||0),this.lineWidth=r||1,this.wide=this.lineWidth>1,this._renderable=e,this.clipPlanes=s,this.sectionLines=this.computeInternalSectionLineArray(s,o),this.resetBuffers(),this.renderer=i,this.sectionLineGeometry=null}resetBuffers(){this.indexArray=null,this.currentsArray=null,this.edgeLastIndexArray=null,this._Id=0,this._edgeId=0,this.halfEdges=[],this.halfEdgesStructure=null,this._positionArray=null}allocateArrays(e){if(this.wide){this.indexArray=new Uint32Array(3*e*2);var t=6*e;this.currentsArray=new Float32Array(2*t),this.edgeLastIndexArray=new Float32Array(6*e*2)}else{this.indexArray=new Uint32Array(2*e);t=6*e;this.currentsArray=new Float32Array(t),this.edgeLastIndexArray=new Float32Array(6*e)}}addEdgeIndices(e,t,i){var r=this.indexArray,n=this.currentsArray,s=this.edgeLastIndexArray,a=this._edgeId;if(this.wide){var o=4*a,l=4*a+1,h=4*a+2,c=4*a+3;r[6*a]=o,r[6*a+1]=h,r[6*a+2]=c,r[6*a+3]=o,r[6*a+4]=c,r[6*a+5]=l,n[12*a]=e,n[12*a+1]=t,n[12*a+2]=i,n[12*a+3]=e,n[12*a+3+1]=t,n[12*a+3+2]=i,n[12*a+6]=t,n[12*a+6+1]=i,n[12*a+6+2]=e,n[12*a+9]=t,n[12*a+9+1]=i,n[12*a+9+2]=e,s[12*a]=1,s[12*a+1]=1,s[12*a+2]=0,s[12*a+3]=1,s[12*a+3+1]=-1,s[12*a+3+2]=0,s[12*a+6]=-1,s[12*a+6+1]=1,s[12*a+6+2]=0,s[12*a+9]=-1,s[12*a+9+1]=-1,s[12*a+9+2]=0}else r[2*a]=2*a,r[2*a+1]=2*a+1,n[6*a]=e,n[6*a+1]=t,n[6*a+2]=i,n[6*a+3]=t,n[6*a+4]=i,n[6*a+5]=e,s[6*a]=1,s[6*a+1]=0,s[6*a+2]=0,s[6*a+3]=-1,s[6*a+4]=0,s[6*a+5]=0;this._edgeId++}processTriangleIndices(e,t,i){this.addEdgeIndices(e,t,i),this.addEdgeIndices(t,i,e),this.addEdgeIndices(i,e,t)}computeSectionLineGeometry(){0===a&&(this.clipPlanes=null),this.clipPlanes?this.sectionLineGeometry=n({renderable:this._renderable,clipPlanes:this.clipPlanes,sectionLines:this.sectionLines,lineWidth:this.lineWidth,color:this._color,visibleSpace:this.renderer.visibleSpace}):this.computeSectionLineGeometry_old()}setColor(e){if(null===e)return;const t=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;t&&t.color.set(e)}computeInternalSectionLineArray(e,t){let i=null;if(t||!e)i=t;else{let t;for(i=[],t=0;t<e.length;t++)i.push(!0)}return i}update({width:e,color:t,clipPlanes:i,sectionLines:r}){this.setColor(t);const n=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;if(this.clipPlanes){if(n){if(!i||this.clipPlanes.length!==i.length)return!1;const t=this.computeInternalSectionLineArray(i,r);for(let e=0;e<this.clipPlanes.length;e++)if(!this.clipPlanes[e].equals(i[e])||this.sectionLines[e]!==t[e])return!1;return n.setLineWidth(e),!0}return!1}return this.lineWidth===e}dispose(){this.sectionLineGeometry&&this.sectionLineGeometry.dispose(),this.sectionLineGeometry=null}computeSectionLineGeometry_old(){var e,t,i,r,n,s,a=THREEDS.Core,o=this._renderable,l=[],h=this.renderer.visibleSpace,c=0;if(o.layer){var d={};for(u=0;u<o.layer.layers.length;u++){M=o.layer.layers[u].drawableGroup;(w=o.layer.layers[u].drawableInterval).skip(o,h)||(d[M.geometry.id]=M.geometry,c+=M._geomType===a.GeomTypeEnum.FACE?w.count:0)}for(var u in d)l.push(d[u])}else{l=o.geometry;for(var p=o.geometry.length,u=0;u<p;u++){(C=o.geometry[u]).drawingGroups.length;for(var f=0;f<C.drawingGroups.length;f++){c+=(M=C.drawingGroups[f])._geomType===a.GeomTypeEnum.FACE?M.count:0}}}if(0===c)return null;this.allocateArrays(c);var g=0,m=0,v=[],_=[];for(u=0;u<l.length;u++)v[u]=g,_[u]=m,g+=l[u].vertexIndexArray.length,m+=l[u].vertexPositionArray.length;if(1===l.length)e=l[0].vertexIndexArray,t=l[0].vertexPositionArray;else{e=new Uint32Array(g),t=new Float32Array(m);var y=0,S=0;for(u=0;u<l.length;u++){for(var b=l[u],x=0;x<b.vertexIndexArray.length;x++)e[y]=_[u]/3+b.vertexIndexArray[x],y++;for(x=0;x<b.vertexPositionArray.length;x++)t[S]=b.vertexPositionArray[x],S++}}if(this.halfEdgesStructure={},s=e.length,this.maxIndices=s,this._positionArray=t,o.layer)for(u=0;u<o.layer.layers.length;u++){var w;M=o.layer.layers[u].drawableGroup;if(!(w=o.layer.layers[u].drawableInterval).skip(o,h)&&M._geomType===a.GeomTypeEnum.FACE){var P=l.indexOf(M.geometry);for(E=v[P]+w.start;E<v[P]+w.start+w.count;E+=3)i=e[E],r=e[E+1],n=e[E+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,s)}}else for(p=l.length,u=0;u<p;u++){var C=l[u];for(f=0;f<C.drawingGroups.length;f++){var M;if((M=C.drawingGroups[f])._geomType===a.GeomTypeEnum.FACE)for(var E=v[u]+M.start;E<v[u]+M.start+M.count;E+=3)i=e[E],r=e[E+1],n=e[E+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,s)}}this.sectionLineGeometry=this.createNewGeometry(),this.resetBuffers()}createNewGeometry(t){var i,r=THREEDS.Core,n=this.indexArray.length,a=[],o=r.supportedExtensions.maxTextureSize,l=o*o,h=this._positionArray.length/3,c=Math.ceil(h/l),d=h-Math.floor(h/l)*l,u=Math.sqrt(d),p=s(u),f=s(d/p),g=3*((c-1)*l+p*f),m=new Float32Array(g);m.set(this._positionArray);for(var v=0;v<c-1;v++){var _;(_=new r.DataTexture(m.subarray(v*l*3,(v+1)*l*3),o,o,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,_.magFilter=r.NearestFilter,_.generateMipmaps=!1,_.flipY=!1,_.needsUpdate=!0,a.push(_)}(_=new r.DataTexture(m.subarray((c-1)*l*3,g),p,f,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,_.magFilter=r.NearestFilter,_.generateMipmaps=!1,_.flipY=!1,_.needsUpdate=!0,a.push(_);var y={NB_OUTLINE_MAPS:c,MAX_OUTLINE_MAP_SIZE:o.toFixed(1),LAST_OUTLINE_MAP_SIZE_X:p.toFixed(1),LAST_OUTLINE_MAP_SIZE_Y:f.toFixed(1)};(i=this.wide?new r._WideSectionMaterial(y,a,.5*this.lineWidth):new r._SectionMaterial(y,a)).color.set(this._color);var S=new e.DrawingGroup(i,i,this.wide?4:1,0,n),b=new r.BufferGeometryDS;return b.drawingGroups=[],S.geometry=b,b.drawingGroups.push(S),b.vertexPositionArray=this.currentsArray,b.vertexUvArray=this.edgeLastIndexArray,b.vertexIndexArray=this.indexArray,b.boundingSphere=this._renderable.boundingSphere,b.boundingBox=this._renderable.boundingBox,b}}})),define("DS/Visualization/BufferGPUManager",["UWA/Class","DS/Mesh/ThreeJS_Base"],(function(e,t){"use strict";const i=t.IsFirefox;var r=e.extend({init:function(){return this.__builder__=null,this.reset(),this.__fake=!1,this},reset:function(){this._gl=null,this._device=null,this._computeInterface=null,this.interleaveThroughCompute=!1,this._infos=new Map,this.initAtLoading=!1,this.sharedGeometriesToInit=new Map,this.intermediaryArray=null,this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null,this.fillMapGeomBufferSize=!1,this.mapGeomBufferSize=new Map},addToMapGeomBufferSize:function(e){this.fillMapGeomBufferSize&&this.mapGeomBufferSize.set(e.id,e.getBuffersMemorySize())},addGeometryFromObject:function(e){if(e.geometry&&!(2!==e.geometry._type&&e.geometry.length<0)){var t=e.geometry;if(2===t._type&&(t=[t]),t[0]&&(!this.__fake||!e.fromLoadedModel))if(t[0].sharedBuffers)this.sharedGeometriesToInit.has(t[0].id)||(this.sharedGeometriesToInit.set(t[0].id,t),this.initAtLoading&&this.allocateShared(!1,0,0));else if(this.initAtLoading)for(var i=0;i<t.length;i++){let r=this._device?GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST:0;this.allocateDirect(t[i],r,r),this.allocateInstancingBuffers(e,null)}}},geometryInfoDecrement:function(){this._infos.forEach((function(e,t,i){e.memory.geometries--}))},geometryInfoIncrement:function(){this._infos.forEach((function(e,t,i){e.memory.geometries++}))},sharedBufferInfoIncrement:function(){this._infos.forEach((function(e,t,i){e.memory.sharedbuffers++}))},doInterleavingThroughCompute:function(e,i,r){let n=[],s=i.pickAnyAttribute().stride;i.forEach((t=>{n.push(e.buffers[e.layout.get(t.name).bufferId])}));let a=this._computeInterface.getStorageBuffer(null,n),o=new t.WEBGPUVertexBuffer(this._device,0),l=GPUBufferUsage.VERTEX;o.buffer=this._computeInterface.getEmptyStorageBuffer(l,s*r);let h="interleavedBuffer",c="inputBuffer",d=i.size(),u=i.getMaxAttributeComponents(),p={shaderContent:`\n\t\t\t\t\t\tlet vertexId = workgroup_id.x+num_workgroups.x*workgroup_id.y+num_workgroups.x*num_workgroups.y*workgroup_id.z;\n\t\t\t\t\t\tlet workGroupCount = num_workgroups.x*num_workgroups.y*num_workgroups.z;\n\t\t\t\t\t\tlet vertexCount = workGroupCount;//false if we go other 65535 vertices as there are unused workgroups by approximation\n\n\n\t\t\t\t\t\tif(vertexId>=vertexCount){\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tlet attributeId = local_id.x;\n\t\t\t\t\t\tlet componentId = local_id.y;\n\n\t\t\t\t\t\tlet attributeCount = workgroup_size.x;\n\t\t\t\t\t\tlet componentCount = workgroup_size.y;\n\n\t\t\t\t\t\tlet inputIndex = attributeId*vertexCount*componentCount+vertexId*componentCount+componentId;\n\t\t\t\t\t\tlet outputIndex = vertexId*attributeCount*componentCount+attributeId*componentCount+ componentId;\n\n\t\t\t\t\t\tlet v = ${c}[inputIndex];\n\t\t\t\t\t\t${h}[outputIndex]=v;\n\t\t\t\t\t`,workgroupSize:new t.Vector3(d,u,1),bindingDescriptions:[{name:c},{name:h}]},f=this._computeInterface.createComputeDescriptor(p),g=Math.min(r,65535),m=Math.ceil(r/g),v=Math.min(m,65535),_=Math.ceil(r/(g*v));return f.setWorkgroupCount(new t.Vector3(g,v,_)),f.setBinding(c,a),f.setBinding(h,o.buffer),this._computeInterface.executeCompute(f),o},allocateDirect:function(e,i,r){e.wideLinesLinker&&!e.wideLinesLinker._isParent(e)&&e.__setTypedArraysForWidelines();let n=!1;if(!e.vertexBufferGPU){const r=e.getVertexCount(),s=r>0?e.layout.clone():null;if(r>0&&s&&s.size()>0){this.addToMapGeomBufferSize(e);let a,o,l=null,h=s.getFullInterleaving();if(h)a=e.buffers[h.bufferId],o=h.stride;else{s.interleave(),o=s.getFullInterleaving().stride;const t=o*r;!e.editable&&this.interleaveThroughCompute&&this._computeInterface&&s.isOnlyFloat32()?l=this.doInterleavingThroughCompute(e,s,r):(!e.editable&&this.intermediaryArray&&this.intermediaryArray.byteLength>=t?a=this.intermediaryArray.subarray(0,t):(a=new Uint8Array(t),e.editable||(this.intermediaryArray=a)),e.exportRaw({target_array:a,target_layout:s}))}if(!l)if(this._device){l=new t.WEBGPUVertexBuffer(this._device,Math.max(a.byteLength,256),e.editable?GPUBufferUsage.COPY_DST|i:i);const r=new Uint8Array(l.buffer.getMappedRange());if(l.buffer._ab=r,a instanceof ArrayBuffer){const e=new Uint8Array(a,0,a.byteLength);r.set(e)}else{const e=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);r.set(e)}l.buffer.unmap()}else l=new t.GLVertexBuffer({gl:this._gl}),this._gl&&this._gl.bindBuffer(this._gl.ARRAY_BUFFER,l.buffer),this._gl&&this._gl.bufferData(this._gl.ARRAY_BUFFER,a,e.editable?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW);e.editable&&(l.interleavedData=a),l.nbGeometries=1,l.numVertices=r,l.layout=s,e.vertexBufferGPU=l,e.vertexOffsetGPU=0,e.vertexCountGPU=l.numVertices,e.layout._computeLayoutKey(),this.geometryInfoIncrement(),e._markAllAttributesClean(),n=!0}}if(!e.indexBufferGPU){let i=e.vertexIndexArray;if(0!==e.vertexOffsetGPU){const t=e.vertexOffsetGPU;i=e.vertexIndexArray.map((e=>e+t))}let s=null;if(this._device){if(s=new t.WEBGPUIndexBuffer(this._device,i?Math.max(4*Math.ceil(i.byteLength/4),256):0,e.editable?GPUBufferUsage.COPY_DST|r:r),i){const e=new Uint8Array(s.buffer.getMappedRange());s.buffer._ab=e,e.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),s.buffer.unmap()}}else s=new t.GLIndexBuffer({gl:this._gl}),i&&(this._gl&&this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,s.buffer),this._gl&&this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.STATIC_DRAW));s.use32bitIndexBuffer=!!i&&i instanceof Uint32Array,s.numIndices=i?i.length:0,s.nbGeometries=1,e.indexBufferGPU=s,e.indexOffsetGPU=0,e.indexCountGPU=s.numIndices,e._markIndexClean(),n=!0}n&&e.noMeshInRAM&&!e.sharedBuffers&&!e.editable&&e.clearMeshInRAM(!1)},allocateInstancingBuffers:function(e,t){let i=t&&t._instancingInfos?t._instancingInfos:e&&e._instancingInfos?e._instancingInfos:null;if(i&&i.instanceAttribArrays){var r=i.instanceAttribArrays;for(var n in r){const t=r[n];null!==t.array&&null===t.buffer&&(this._device?(t.buffer=this._device.createBuffer({label:e.name+n,size:t.array.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this._device.queue.writeBuffer(t.buffer,0,t.array)):(t.buffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,t.buffer),t.isDynamic?this._gl.bufferData(this._gl.ARRAY_BUFFER,t.array,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,t.array,this._gl.STATIC_DRAW)),r[n].buffer.itemSize=r[n].itemSize,r[n].buffer.numItems=i.nbInstances)}}},updateInstancingAttributeBuffer:function(e,t,i){let r=t._instancingInfos?t._instancingInfos:e._instancingInfos;if(this._device)if(r.nbInstances<=i.buffer.numItems){var n=i.itemSize;i.isMat4&&(n*=4),this._device.queue.writeBuffer(i.buffer,0,i.array,0,r.drawCount*n)}else{const e=i.buffer.label;i.buffer=this._device.createBuffer({label:e,size:i.array.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this._device.queue.writeBuffer(i.buffer,0,i.array),i.buffer.numItems=r.nbInstances}else if(this._gl.bindBuffer(this._gl.ARRAY_BUFFER,i.buffer),r.nbInstances<=i.buffer.numItems){n=i.itemSize;i.isMat4&&(n*=4),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,i.array.subarray(0,r.drawCount*n))}else this._gl.bufferData(this._gl.ARRAY_BUFFER,i.array,this._gl.DYNAMIC_DRAW),i.buffer.numItems=r.nbInstances;i.isDynamic=!1},allocateShared:function(e,r,n){if(0==this.sharedGeometriesToInit.size)return;let s=Number.MAX_SAFE_INTEGER;if(i){parseFloat(navigator.userAgent.substr(navigator.userAgent.length-4))>=60&&(s=250)}const a=[],o={};if(this.sharedGeometriesToInit.forEach((e=>{let t=0;for(let i=0;i<e.length;i++){const r=e[i];if(!r){t++;continue}if(r.vertexBufferGPU&&r.vertexBufferGPU.isShared){t++;continue}if(!r.vertexIndexArray){t++,console.warn("no geometry available, are you trying to reattach a mesh while noMeshInRAM has been activated?");continue}const n=r.layout.getSignature();let l=o[n];l||(l={geoms:[],dgCount:0,vertexCount:0,indexCount:0,editable:!1},o[n]=l),r.editable&&(l.editable=!0),l.geoms.push(r),l.vertexCount+=r.getVertexCount(),l.indexCount+=r.vertexIndexArray.length,l.dgCount+=r.drawingGroups.length,(l.vertexCount>2097152||l.dgCount>s)&&(a.push(l),o[n]=null)}t==e.length&&this.sharedGeometriesToInit.delete(e[0].id)})),e)for(let e in o){const t=o[e];t&&t.dgCount>0&&a.push(t)}for(let e=0;e<a.length;e++){const i=a[e];let s=i.geoms[0].layout.clone();s.interleave();const o=s.getFullInterleaving().stride,h=o*i.vertexCount;let c=i.vertexCount>65535&&t.supportedExtensions.elementIndexUint;const d=i.indexCount*(c?4:2);let u=null,p=null,f=null,g=null;this._device?(u=new t.WEBGPUVertexBuffer(this._device,h,i.editable?GPUBufferUsage.COPY_DST|r:r),f=new Uint8Array(u.buffer.getMappedRange()),u.buffer._ab=f,p=new t.WEBGPUIndexBuffer(this._device,4*Math.ceil(d/4),i.editable?GPUBufferUsage.COPY_DST|n:n),p.numIndices=i.indexCount,p.use32bitIndexBuffer=c,g=new Uint8Array(p.buffer.getMappedRange()),p.buffer._ab=g):(u=new t.GLVertexBuffer({gl:this._gl}),p=new t.GLIndexBuffer({gl:this._gl,numIndices:i.indexCount,use32bitIndexBuffer:c})),u.numVertices=i.vertexCount,u.nbGeometries=i.geoms.length,u.isShared=!0,u.layout=s,p.nbGeometries=i.geoms.length,p.isShared=!0,this.sharedBufferInfoIncrement();for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e];this.sharedGeometriesToInit.delete(t.id),(t.vertexBufferGPU||t.indexBufferGPU)&&(t.deallocate(this._gl,null),this.geometryInfoDecrement()),t.vertexBufferGPU=u,t.indexBufferGPU=p,t.layout._computeLayoutKey();for(var l=0;l<t.meshList.length;l++)t.meshList[l]._flagAsGSSOInvalidated()}this._device||(this._gl.bindBuffer(this._gl.ARRAY_BUFFER,u.buffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,h,this._gl.STATIC_DRAW));let m=0;for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e],r=t.getVertexCount(),n=r*o;t.vertexOffsetGPU=m/o,t.vertexCountGPU=r;let s=null;this.sharingIntermediaryArray&&this.sharingIntermediaryArray.length>=n?s=this.sharingIntermediaryArray.subarray(0,n):(s=new Uint8Array(n),this.sharingIntermediaryArray=s),t.exportRaw({target_array:s,target_layout:u.layout}),this._device?f.set(new Uint8Array(s.buffer,s.byteOffset,s.byteLength),m):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,m,s),m+=n,t.noMeshInRAM&&t.clearMeshInRAM(!0),this.geometryInfoIncrement()}this._device||(this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,p.buffer),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,d,this._gl.STATIC_DRAW));let v=0;for(let e=0;e<i.geoms.length;e++){let t=i.geoms[e];const r=t.vertexIndexArray.length;t.indexOffsetGPU=v,t.indexCountGPU=r;let n=null,s=p.use32bitIndexBuffer?this.sharingIntermediaryIndex32Array:this.sharingIntermediaryIndex16Array;s&&s.length>=r?n=s.subarray(0,r):p.use32bitIndexBuffer?(n=new Uint32Array(r),this.sharingIntermediaryIndex32Array=n):(n=new Uint16Array(r),this.sharingIntermediaryIndex16Array=n);for(let e=0;e<r;e++)n[e]=t.vertexOffsetGPU+t.vertexIndexArray[e];this._device?g.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),v*p.bytesPerIndex):this._gl.bufferSubData(this._gl.ELEMENT_ARRAY_BUFFER,v*p.bytesPerIndex,n),v+=r,t.noMeshInRAM&&(t.vertexIndexArray=null)}this._device&&(u.buffer.unmap(),p.buffer.unmap())}e&&(this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null)},_updateWebGPUBuffer(e,t,i){this._device.queue.writeBuffer(e,t,i)},updateEditableBuffers:function(e){if(e.staleIndices){const[t,i]=e.staleIndices;e._markIndexClean();const r=e.indexBufferGPU;if(r){let n=e.vertexIndexArray.subarray(t,i);if(0!==e.vertexOffsetGPU){const t=e.vertexOffsetGPU;n=n.map((e=>e+t))}this._gl?(this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,r.buffer),this._gl.bufferSubData(this._gl.ELEMENT_ARRAY_BUFFER,(e.indexOffsetGPU+t)*r.bytesPerIndex,n)):this._device&&this._updateWebGPUBuffer(r.buffer,(e.indexOffsetGPU+t)*r.bytesPerIndex,n)}}if(!e.staleAttributes)return;const i=e.staleAttributes;e._markAllAttributesClean();const r=e.vertexBufferGPU;if(!r)return;let n=2**32,s=-(2**32);if(i.forEach(((i,a)=>{i[0]<n&&(n=i[0]),i[1]>s&&(s=i[1]),t.BufferGeometryDS.copyRawAttribute({source_bgds:e,source_attr:a,source_vertex_offset:i[0],target_array:r.interleavedData,target_attr:r.layout.get(a),target_vertex_offset:i[0]+e.vertexOffsetGPU,num_vertices:i[1]-i[0]})})),r.needsUpdate=!1,n>=s)return;const a=r.layout.pickAnyAttribute().stride,o=e.vertexOffsetGPU+a*n,l=e.vertexOffsetGPU+a*s,h=new Uint8Array(r.interleavedData.buffer,r.interleavedData.byteOffset+o,l-o);this._gl?(this._gl.bindBuffer(this._gl.ARRAY_BUFFER,r.buffer),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,o,h)):this._device&&this._updateWebGPUBuffer(r.buffer,o,h)},deallocate:function(e){if(null!=e)for(let t=0;t<e.length;t++)this._device?e[t].destroy():this._gl.deleteBuffer(e[t])},setGLContext:function(e,t,i){this._gl=t,this._infos.set(e,i)},setWEBGPUContext:function(e,t,i,r){this._device=t,this._computeInterface=i,this._infos.set(e,r)},dispose:function(e){this._infos.delete(e),0==this._infos.size&&this.reset()}}),n=new r;return n.__builder__=r,n})),define("DS/Visualization/ImageLoaders/TGA",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats"],(function(e,t){"use strict";return function(t){t.loadTGATexture=function(i,r,n,s,a,o){var l=new e.DataTexture(new Uint8Array(16),2,2,e.RGBAFormat,e.UnsignedByteType);l.mapping=r;var h=new XMLHttpRequest;return h.onload=function(){t.nbTexturesBeingLoaded--;var i=new Uint8Array(h.response),r=12,s=i[r]+256*i[r+1],a=i[r+=2]+256*i[r+1];r+=4,l.image.data=new Uint8Array(4*s*a);var o=l.image.data;l.image.width=s,l.image.height=a;for(var c=0;c<a;c++)for(var d=0;d<s;d++){var u=c*s+d;o[4*u]=i[r+4*u+2],o[4*u+1]=i[r+4*u+1],o[4*u+2]=i[r+4*u],o[4*u+3]=i[r+4*u+3]}l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.needsUpdate=!0,n&&n(l);for(var p=0;p<l.onLoadCallbacks.length;p++)l.onLoadCallbacks[p](l)},h.onerror=function(){s&&s(),t.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="arraybuffer",h.withCredentials=!!a,h.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="arraybuffer",h.withCredentials=!!a,h.send(null)),l}}})),define("DS/Visualization/SectionCappingPassCreator",["UWA/Class"],(function(e){"use strict";return e.extend({init:function(){},setupViewer:function(e){}})})),define("Visualization/SectionCappingPassCreator",["DS/Visualization/SectionCappingPassCreator","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/SectionCappingPassCreator"),e})),define("DS/Visualization/SessionNodesWithSectionProfile",[],(function(){"use strict";return null})),define("DS/Visualization/Logger",[],(function(){"use strict";function e(){let e=(new Error).stack.toString().split("\n").slice(1),t=[];for(let i of e)i.contains("Visualization/Logger.js")||t.push(i);return t}const t={"THREE.Box3":5,"THREE.Camera":4,"THREE.Color":5,"THREE.Curve":5,"THREE.defineSlowProperty":5,"THREE.Frustum":4,"THREE.getDevicePixelRatio":5,"THREE.Matrix3":5,"THREE.Matrix4":5,"THREE.Quaternion":5,"THREE.Sphere":5,"THREE.SplitFloat32":5,"THREE.Vector2":5,"THREE.Vector3":5,"THREE.Vector4":5};const i={get(r,n,s){const a=r[n];if("function"==typeof a){let s=function(e,t){let i=e;e.REVISION&&(i="THREE"),"function"==typeof e&&(i="f()");let r=t,n=null;return"Symbol"===t.constructor.name?(r=t.toString(),n=`${i}.${r}`,"Symbol(Symbol.hasInstance)"===r&&(n="instanceof")):n=`${i}.${r}`,n}(r,n),o=null;return a.prototype&&a.prototype.constructor?(a.prototype.constructor.name===n&&function(i){if(void 0===t[i]||t[i]<=1){let t=e();console.groupCollapsed(`${i}() ${t[0]}`),console.log(t.join("\n")),console.groupEnd()}}(s),new Proxy(a,i)):(o=function(...i){return function(i,...r){if("instanceof"!==i&&(void 0===t[i]||t[i]<=1)){let t=e();console.groupCollapsed(`Call ${i} with:`,...r,t[0]),console.log(t.join("\n")),console.groupEnd()}}(s,i),a.apply(r,i)},o)}return a},set:(e,t,i,r)=>(e[t]=i,!0),apply:(e,t,i)=>e.apply(e,i)};return class{static log_class(e){let t=e.name;return void 0===t&&e.REVISION&&(t="THREE"),console.log(`Logging ${t}`),new Proxy(e,i)}}})),define("DS/Visualization/ProxyAbstraction",["DS/WAFData/WAFData"],(function(e){"use strict";return class{useNoProxy(e){this.proxyUsage=0,this.server=null,this.sport=null,this.withCredentials=e}useProxyDefinedBy(e,t){this.proxyUsage=1,this.server=e,this.sport=t}useUWAProxy(e){this.proxyUsage=2,this.server=null,this.sport=null,this.proxymode=e.proxymode,this.requestsOptions=e.requestsOptions}rewriteUrlUsingProxyDef(e,t,i){var r=e.indexOf("/"),n=e.indexOf("/",r+2);return e.slice(0,r)+"//"+t+":"+i+e.slice(n,e.length)}executeGetHttpRequest(t,i,r,n,s,a){var o,l,h=(o=s,l=t,function(e){o&&o({url:l,type:"LOAD",responseCode:e})});if(2===this.proxyUsage){var c=this.requestsOptions||{};c.headers=c.headers||new Object,a&&(c.headers.Accept=a),c.data&&(c.data.GET=c.data.GET||r),c.method=c.method||"GET",c.timeout=36e5,c.async=!0,c.onComplete=n,c.onFailure=function(e){for(var t=e.message.split('"'),i=null,r=0;r<t.length-1;r++)-1!=t[r].search("return ResponseCode with value")&&(i=parseInt(t[r+1]));i&&h(i)},c.onTimeout=function(e){h(408)},c.type=i,c.proxymode&&(c.authentication=c.proxymode);e.handleRequest(t,c)}else{1===this.proxyUsage&&(t=this.rewriteUrlUsingProxyDef(t,this.server,this.sport));var d=new XMLHttpRequest;d.open("GET",t,!0),d.onload=function(e){var t=d.status;200===t||0===t&&this.response&&this.response.byteLength>0?n(this.response):h(t)},d.onerror=function(e){h(d.status)},d.ontimeout=function(e){h(408)},d.timeout=36e5,this.withCredentials&&(d.withCredentials=!0),"arraybuffer"===i&&(d.responseType=i),"blob"===i&&(d.responseType=i),d.send(r)}}fetchUint8Array(e,t,i,r){return new Promise(((n,s)=>{this.executeGetHttpRequest(e,t,i,(e=>n(new Uint8Array(e))),s,r)}))}}})),define("DS/Visualization/SkinningTransformation",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";const t=function(){this.useEulerAngles=!1,this.skinningMap=null,this.skinningMapWidth=0,this.skinningMapWidth=0,this.nbBones=0};t.prototype.setSkinningMatrices=function(t,i){var r;(this.nbBones||(this.nbBones=i||t.length/12),this.skinningMapWidth&&this.skinningMapHeight)||(r=this.nbBones>256?64:this.nbBones>64?32:this.nbBones>16?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!1,this.skinningMap)this.skinningMap.image.data.set(new Float32Array(t.buffer,0,12*this.nbBones),0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(new Float32Array(t.buffer,0,12*this.nbBones),0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.setSkinningEulerAngles=function(t,i){var r;this.skinningMapWidth&&this.skinningMapHeight||(r=i>512?64:i>128?32:i>32?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!0,this.skinningMap)this.skinningMap.image.data.set(t,0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(t,0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.dispose=function(){this.skinningMap&&this.skinningMap.dispose()};const i=function(){this.useEulerAngles=!1,this.skinningInstancingMaps=null,this.skinningInstancingMapsInfo=null};return i.prototype.setInstancingSkinningMatrices=function(t,i,r){var n,s;if(this.useEulerAngles=!1,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var a=function(e){for(var t=1;t<e;)t*=2;return t},o=e.supportedExtensions.maxTextureSize,l=o*o,h=i*r*4,c=Math.ceil(h/l),d=h-Math.floor(h/l)*l,u=a(Math.sqrt(d)),p=a(d/u),f=3*((c-1)*l+u*p);n={nbBones:i,maxTextureSize:o,nbTextures:c,lastTextureSizeX:u,lastTextureSizeY:p},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(s=new Float32Array(f)).set(t,0));for(var g=0;g<n.nbTextures-1;g++){var m;if(this.skinningInstancingMaps[g])this.skinningInstancingMaps[g].image.data.set(t.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),0);else(m=new e.DataTexture(s.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,m.magFilter=e.NearestFilter,m.generateMipmaps=!1,m.flipY=!1,this.skinningInstancingMaps[g]=m;this.skinningInstancingMaps[g].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((m=new e.DataTexture(s.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,s.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,m.magFilter=e.NearestFilter,m.generateMipmaps=!1,m.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=m);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.setInstancingSkinningEulerAngles=function(t,i,r){var n,s;if(this.useEulerAngles=!0,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var a=function(e){for(var t=1;t<e;)t*=2;return t},o=e.supportedExtensions.maxTextureSize,l=o*o,h=i*r*2,c=Math.ceil(h/l),d=h-Math.floor(h/l)*l,u=a(Math.sqrt(d)),p=a(d/u),f=3*((c-1)*l+u*p);n={nbBones:i,maxTextureSize:o,nbTextures:c,lastTextureSizeX:u,lastTextureSizeY:p},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(s=new Float32Array(f)).set(t,0));for(var g=0;g<n.nbTextures-1;g++){var m;if(this.skinningInstancingMaps[g])this.skinningInstancingMaps[g].image.data.set(t.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),0);else(m=new e.DataTexture(s.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,m.magFilter=e.NearestFilter,m.generateMipmaps=!1,m.flipY=!1,this.skinningInstancingMaps[g]=m;this.skinningInstancingMaps[g].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((m=new e.DataTexture(s.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,s.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,m.magFilter=e.NearestFilter,m.generateMipmaps=!1,m.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=m);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.dispose=function(){if(this.skinningInstancingMaps)for(var e=0;e<this.skinningInstancingMaps.length;e++){var t=this.skinningInstancingMaps[e];t&&t.dispose()}},{SkinningTransformations:t,SkinningTransformationsInstancing:i}})),define("DS/Visualization/OccurrenceInterfaceFactory",["UWA/Class"],(function(e){"use strict";return e.extend({init:function(e,t){this._occurrenceExplorer=e,this.viewer=t},getOccurrenceItf:function(e){var t=e._getUniqueOccurrence(this.viewer);return t?this._occurrenceExplorer.getOccurrenceInterface(t):null},getOccurrenceItfMulti:function(e){var t,i=e._getOccurrences(this.viewer),r=[];for(t=0;t<i.length;t++)r.push(this._occurrenceExplorer.getOccurrenceInterface(i[t]));return r},getUserRootOccurrenceItf:function(){var e=this.viewer.internalSceneGraph.userRoot._occurrences[0];return this._occurrenceExplorer.getOccurrenceInterface(e)}})})),define("DS/Visualization/RenderPriorityManager",["UWA/Class","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],(function(e,t,i){"use strict";return e.extend({init:function(e){this.viewer=e,this.enabled=!1,this.passes=this._createPasses(e)},setEnabled:function(e){e=!!e,this.enabled!==e&&(this.enabled=e,this._enablePasses(this.enabled),this.viewer.internalSceneGraph.root._forceUpdate())},_enablePasses:function(e){if(this.passes){var t,i=this.viewer;if(e)for(t=0;t<this.passes.length;t++)i.renderer.mainComposer.addPass(this.passes[t]);else i.renderer.mainComposer.removePasses(this.passes)}},_createPasses:function(e){var r=[],n=new i("renderPriorityClear");n.defaults.clear=!1,n.setClearStencil(!0),n.clearStencilValue=0,n.idString="renderPriority",r.push(n);var s,a,o;for(s=0;s<=4;s++)(a=new t(null,null,null,null,null,null,"renderPriorityStencilP"+s)).idString="p"+s,a.stencilRef=s,a.enableStencilTest=!0,a.setStencilFunc("GEQUAL"),a.setStencilOps("REPLACE","REPLACE"),a.setEnableStencilWrite(!0),r.push(a),4!==s&&((o=new t(null,null,null,null,null,null,"renderPriorityDrawP"+s)).idString="p"+s,o.stencilRef=s,o.enableStencilTest=!0,o.setStencilFunc("LESS"),o.setStencilOps("KEEP","KEEP"),o.useRenderPriorityOpacity=!0,o.setEnableStencilWrite(!1),r.push(o));return r}})})),define("DS/Visualization/XMLV6Loader",["DS/VisuLoaders/XMLV6Loader"],(function(e){"use strict";return e})),define("Visualization/XMLV6Loader",["DS/Visualization/XMLV6Loader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/XMLV6Loader"),e})),define("DS/Visualization/HighlightData",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";var t="true"===localStorage.getItem("__1x3HL__");class i{constructor(){this._needsDepth=!1,this.outlineEnabled=!0,this.outlineColor=(new e.Color).setRGB(1,1,1),this.outlineAlpha=1,this.outlineThickness=1,this.haloEnabled=!0,this.haloColor=(new e.Color).setRGB(1,1,1),this.haloIntensity=2,this.haloThickness=4,this.color=(new e.Color).setRGB(1,1,1),this.colorEnabled=!0,this._id=0,this.priority=1,this.clearDepth=!1}_setOutlineData(e){this.outlineEnabled=void 0!==e.outlineEnabled?e.outlineEnabled:this.outlineEnabled,void 0!==e.outlineColor&&this.outlineColor.copy(e.outlineColor),this.outlineAlpha=void 0!==e.outlineAlpha?e.outlineAlpha:this.outlineAlpha,this.outlineThickness=void 0!==e.outlineThickness?Math.floor(e.outlineThickness):this.outlineThickness}_setHaloData(e){this.haloEnabled=void 0!==e.haloEnabled?e.haloEnabled:this.haloEnabled,void 0!==e.haloColor&&this.haloColor.copy(e.haloColor),this.haloIntensity=void 0!==e.haloIntensity?e.haloIntensity:this.haloIntensity,this.haloThickness=void 0!==e.haloThickness?Math.floor(e.haloThickness):this.haloThickness,this.haloThickness=Math.min(this.haloThickness,4)}_setGenericData(e){void 0!==e.priority&&0!==this.priority&&0!==e.priority&&(this.priority=e.priority),void 0!==e.clearDepth&&0!==this.priority&&(this.clearDepth=e.clearDepth)}_setColorData(e){this.colorEnabled=void 0!==e.colorEnabled?e.colorEnabled:this.colorEnabled,void 0!==e.color&&this.color.copy(e.color)}isEqual(e){return(void 0===e.outlineEnabled||e.outlineEnabled===this.outlineEnabled)&&((void 0===e.outlineAlpha||e.outlineAlpha===this.outlineAlpha)&&((void 0===e.haloEnabled||e.haloEnabled===this.haloEnabled)&&((void 0===e.haloIntensity||e.haloIntensity===this.haloIntensity)&&(!(void 0!==e.outlineColor&&!this.outlineColor.equals(e.outlineColor))&&((void 0===e.outlineThickness||this.outlineThickness===e.outlineThickness)&&(!(void 0!==e.haloColor&&!this.haloColor.equals(e.haloColor))&&(!(void 0!==e.color&&!this.color.equals(e.color))&&((void 0===e.colorEnabled||e.colorEnabled===this.colorEnabled)&&((void 0===e.priority||e.priority===this.priority)&&(void 0===e.clearDepth||e.clearDepth===this.clearDepth))))))))))}_updateMixPassUniforms(e,t){this._id=t;var i=4*(t-1);const r=e.getUniform("iHaloColors"),n=e.getUniform("iOutlineColors"),s=e.getUniform("iLineicOutlineColors"),a=e.getUniform("iColors");r[i]=this.haloEnabled?this.haloColor.r:0,r[i+1]=this.haloEnabled?this.haloColor.g:0,r[i+2]=this.haloEnabled?this.haloColor.b:0,n[i]=this.outlineEnabled?this.outlineColor.r:0,n[i+1]=this.outlineEnabled?this.outlineColor.g:0,n[i+2]=this.outlineEnabled?this.outlineColor.b:0,n[i+3]=this.outlineEnabled?this.outlineAlpha:-1,s[i]=0,s[i+1]=0,s[i+2]=0,s[i+3]=this.outlineEnabled?this.outlineThickness:0,a[i]=this.colorEnabled?this.color.r:0,a[i+1]=this.colorEnabled?this.color.g:0,a[i+2]=this.colorEnabled?this.color.b:0}_updateMaterialUniforms(e,t,i){e.iHighlightColor||e.iHighlightLineicColor?(t.uniform4f(e.iHighlightColor,this.color.r,this.color.g,this.color.b,1),t.uniform4f(e.iHighlightLineicColor,this.outlineColor.r,this.outlineColor.g,this.outlineColor.b,1)):t.uniform1f(e.highlightID,this._id),e.rgbaDepth&&i.loadTexture(t,e.rgbaDepth,i.politeDepthBuffer)}_fillUBO(e,t){const i=e.layout;i.iHighlightColor||i.iHighlightLineicColor?(e.setColorPlusF(i.iHighlightColor,this.color,1,!1,!1),e.setColorPlusF(i.iHighlightLineicColor,this.outlineColor,1,!1,!1)):e.setF(i.highlightID,this._id),i.rgbaDepth&&e.setTexture(i.rgbaDepth,t.politeDepthBuffer)}}class r extends i{constructor(e){super(),this.intensity=1,this._setData(e)}_updateMixPassUniforms(e,t){super._updateMixPassUniforms(e,t);var i=4*(t-1);const r=e.getUniform("iHaloColors"),n=e.getUniform("iLineicHaloColors"),s=e.getUniform("iColors");r[i+3]=this.haloEnabled?this.haloIntensity*this.haloIntensity:0,s[i+3]=this.colorEnabled?this.intensity:0,n[i]=0,n[i+1]=0,n[i+2]=0,n[i+3]=-1}isEqual(e){return!!super.isEqual(e)&&(void 0===e.intensity||e.intensity===this.intensity)}_updateMaterialUniforms(e,t,i){super._updateMaterialUniforms(e,t,i),e.iHighlightIntensity&&t.uniform2f(e.iHighlightIntensity,this.colorEnabled?this.intensity:0,-1)}_fillUBO(e,t){super._fillUBO(e,t);const i=e.layout;i.iHighlightIntensity&&e.setFlatV2(i.iHighlightIntensity,this.colorEnabled?this.intensity:0,-1)}_setColorData(e){super._setColorData(e),this.intensity=void 0!==e.intensity?e.intensity:this.intensity}_setData(e){e=e||{},this._setColorData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e)}}class n extends i{constructor(t){super(),this._needsDepth=!0,this.visibleAlpha=1,this.occludedAlpha=1,this.lineicOutlineColor=(new e.Color).setRGB(1,1,1),this.lineicHaloColor=(new e.Color).setRGB(1,1,1),this._setData(t)}isEqual(e){return!!super.isEqual(e)&&((void 0===e.visibleAlpha||e.visibleAlpha===this.visibleAlpha)&&((void 0===e.occludedAlpha||e.occludedAlpha===this.occludedAlpha)&&(!(void 0!==e.lineicOutlineColor&&!this.lineicOutlineColor.equals(e.lineicOutlineColor))&&!(void 0!==e.lineicHaloColor&&!this.lineicHaloColor.equals(e.lineicHaloColor)))))}_updateMixPassUniforms(e,t){super._updateMixPassUniforms(e,t);var i=4*(t-1);const r=e.getUniform("iHaloColors"),n=e.getUniform("iLineicHaloColors"),s=e.getUniform("iLineicOutlineColors"),a=e.getUniform("iColors");r[i+3]=this.haloEnabled?1.4*this.haloIntensity:0,a[i+3]=this.colorEnabled?this.visibleAlpha:0,n[i+3]=this.colorEnabled?this.occludedAlpha:0,s[i]=this.outlineEnabled?this.lineicOutlineColor.r:0,s[i+1]=this.outlineEnabled?this.lineicOutlineColor.g:0,s[i+2]=this.outlineEnabled?this.lineicOutlineColor.b:0,n[i]=this.haloEnabled?this.lineicHaloColor.r:0,n[i+1]=this.haloEnabled?this.lineicHaloColor.g:0,n[i+2]=this.haloEnabled?this.lineicHaloColor.b:0}_updateMaterialUniforms(e,t,i){super._updateMaterialUniforms(e,t,i),e.iHighlightIntensity&&t.uniform2f(e.iHighlightIntensity,Math.max(this.visibleAlpha,.3),Math.max(this.occludedAlpha,.1))}_fillUBO(e,t){super._fillUBO(e,t);const i=e.layout;i.iHighlightIntensity&&e.setFlatV2(i.iHighlightIntensity,Math.max(this.visibleAlpha,.3),Math.max(this.occludedAlpha,.1))}_setPoliteData(e){super._setColorData(e),this.visibleAlpha=void 0!==e.visibleAlpha?e.visibleAlpha:this.visibleAlpha,this.occludedAlpha=void 0!==e.occludedAlpha?e.occludedAlpha:this.occludedAlpha}_setData(e){e=e||{},this._setPoliteData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e),void 0!==e.lineicOutlineColor&&this.lineicOutlineColor.copy(e.lineicOutlineColor),void 0!==e.lineicHaloColor&&this.lineicHaloColor.copy(e.lineicHaloColor)}}return{DefaultHighlightData:{halo:new r({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloThickness:4,haloIntensity:2,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),visibleAlpha:.6,occludedAlpha:.15,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),lineicHaloColor:t?(new e.Color).setRGB(0,.85,1):(new e.Color).setRGB(0,1,1),haloIntensity:2,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),lineicOutlineColor:t?(new e.Color).setRGB(0,1,1):(new e.Color).setRGB(0,.6,1),outlineAlpha:1,outlineThickness:1})},DefaultPreHighlightData:{halo:new r({colorEnabled:!1,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloIntensity:2,haloThickness:1,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(.97,.97,.97),visibleAlpha:.3,occludedAlpha:0,haloEnabled:!0,haloColor:(new e.Color).setRGB(.67,.67,.69),lineicHaloColor:t?(new e.Color).setRGB(.7,.7,.72):(new e.Color).setRGB(1,1,1),haloIntensity:1.3,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(.97,.97,.97),lineicOutlineColor:t?(new e.Color).setRGB(1,1,1):(new e.Color).setRGB(.7,.7,.72),outlineAlpha:1,outlineThickness:1})},HaloHighlightData:r,AdvancedPoliteHighlightData:n}})),define("DS/Visualization/ShaderLib",["DS/ShaderBuilders/MeshPhongShaderBuilder","DS/ShaderBuilders/LineBasicShaderBuilder","DS/ShaderBuilders/ParticleBasicShaderBuilder","DS/ShaderBuilders/MeshBasicShaderBuilder","DS/ShaderBuilders/MeshLambertShaderBuilder","DS/ShaderBuilders/PBRShaderBuilder","DS/ShaderBuilders/CubeMapShaderBuilder","DS/ShaderBuilders/SimpleMapShaderBuilder","DS/ShaderBuilders/GradientBackgroundShaderBuilder","DS/ShaderBuilders/LatLongMapShaderBuilder","DS/ShaderBuilders/FiniteTransitionEnvMapShaderBuilder","DS/ShaderBuilders/FiniteEnvMapShaderBuilder","DS/ShaderBuilders/GaussianSplatShaderBuilder"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u){"use strict";return{basic:r,lambert:n,phong:e,particle_basic:i,line:t,physicalDS:s,finiteenvmap:d,gradient2:l.Gradient2Builder,gradient3:l.Gradient3Builder,gradient4:l.Gradient4Builder,latlong:h,cubemap:a,finitetransition:c,simplemap:o,gaussianSplat:u}})),define("DS/Visualization/XMLV43Loader",["DS/VisuLoaders/XMLV43Loader"],(function(e){"use strict";return e})),define("Visualization/XMLV43Loader",["DS/Visualization/XMLV43Loader","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/XMLV43Loader"),e})),define("DS/Visualization/Utils",["UWA/Class","UWA/Utils","DS/Visualization/ProxyAbstraction","WebappsUtils/WebappsUtils"],(function(e,t,i,r){"use strict";var n=e.extend({init:function(){}});return n.parseUrl=function(e){return t.parseUrl(e)},n.getWorkerAssets=function(){var e=t.matchUrl(r.getWebappsBaseUrl(),window.location)?null:"Passport",i={provider:"FILE",filename:"AmdLoader.js",serverurl:r.getWebappsBaseUrl()+"AmdLoader/",module:"AmdLoader",requiredAuth:e},n={provider:"FILE",filename:"Mesh.js",serverurl:r.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:e};return[i,{provider:"FILE",filename:"ThreeJS_Base.js",serverurl:r.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:e},n]},n.getCGRLoaderAssets=function(){var e=t.matchUrl(r.getWebappsBaseUrl(),window.location)?null:"Passport";return[{provider:"FILE",filename:"GaussianSplattingParsing.js",serverurl:r.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:e},{provider:"FILE",filename:"CGRFile.js",serverurl:r.getWebappsBaseUrl()+"Formats/",module:"Formats",requiredAuth:e}]},n.getEasysaxAssets=function(){var e=t.matchUrl(r.getWebappsBaseUrl(),window.location)?null:"Passport";return[{provider:"FILE",filename:"EasySax.js",serverurl:r.getWebappsBaseUrl()+"EasySax/",module:"EasySax",requiredAuth:e}]},n.getExtension=function(e){var t=e.replace(/\.\./g,"");if(1===(t=t.split(".")).length||""===t[0]&&2===t.length)return"";var i=t.pop(),r=i.indexOf("?")+1;return t=r?i.substring(0,r-1):i,null!==new RegExp(/^[a-zA-Z0-9_]+$/).exec(t)?t:""},n.getDomain=function(e){var i=e;return t.isAbsoluteUrl(e)||(i=window.location),n.parseUrl(i).hostname},n.getWorkerFromSpec=function(e,t){var r=window.URL||window.webkitURL,s=new i;n.setProxyFromSpec(e,s);var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"";s.executeGetHttpRequest(a,"blob",null,(function(e){var i=r.createObjectURL(e),n=new Worker(i);t&&t(n)}))},n.getJSFromSpec=function(e,t){var r=new i;n.setProxyFromSpec(e,r);var s=e.serverurl?e.serverurl:"";s+=e.filename?e.filename:"",e.module&&e.filename&&(s=require.toUrl("DS/"+e.module+"/"+e.filename));r.executeGetHttpRequest(s,"text",null,(function(e){t&&t(e)}),null,"text/plain, text/javascript, application/javascript, application/x-javascript")},n.getWorkerFromSpecs=function(e,t){var i=window.URL||window.webkitURL,r="",s=function(a){n.getJSFromSpec(e[a],(function(n){if(r+=n,a<e.length-1)s(a+1);else if(t){var o=new Blob([r],{type:"application/javascript"}),l=i.createObjectURL(o),h=new Worker(l);t(h)}}))};s(0)},n.getWorkerBlobFromSpecs=function(e,t){var i=window.URL||window.webkitURL,r="",s=function(a){n.getJSFromSpec(e[a],(function(n){if(r+=n,a<e.length-1)s(a+1);else if(t){var o=new Blob([r],{type:"application/javascript"}),l=i.createObjectURL(o);t(l)}}))};s(0)},n.getFileURLFromSpec=function(e,t){var r=window.URL||window.webkitURL,s=new i;n.setProxyFromSpec(e,s);var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"";s.executeGetHttpRequest(a,"blob",null,(function(e){var i=r.createObjectURL(e);t&&t(i)}))},n.getFilesURLFromSpec=function(e,t){var i=[],r=function(s){n.getFileURLFromSpec(e[s],(function(n){i.push(n),s<e.length-1?r(s+1):t&&t(i)}))};r(0)},n.setProxyFromSpec=function(e,t){if(e.proxyurl)if("none"===e.proxyurl)t.useNoProxy(e.withCredentials);else{var i=n.parseUrl(e.proxyurl);if(null===i)t.useUWAProxy();else if(null!=i.hostname)t.useProxyDefinedBy(i.hostname,i.port);else if(0==(r=e.proxyurl.indexOf("http://127.0.0.1"))){var r=e.proxyurl.lastIndexOf(":"),s=e.proxyurl.slice(r+1,e.proxyurl.length);s=s.replace("/",""),t.useProxyDefinedBy("127.0.0.1",8023)}}else t.useUWAProxy({proxymode:e.requiredAuth,requestsOptions:e.requestsOptions,login:e.login,contextid:e.contextid})},UWA.namespace("THREEDS/Utils",n)})),define("Visualization/Utils",["DS/Visualization/Utils","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/Utils"),e})),define("DS/Visualization/WebGLObjectManager",["DS/Mesh/ThreeJS_Base","DS/Visualization/WidelinesHelper"],(function(e,t){"use strict";const i=Math.abs;class r{constructor(e){this.object=e,this.worldCenterAndRadius=e.worldCenterAndRadius,this.frustumCulled=e.frustumCulled}_performCulling(e,t,r){const n=this.object,s=this.worldCenterAndRadius;var a=s.worldCenter,o=s.worldRadius;r.currentRenderPointsOnly=!1;var l=!1;if(e.pixelCulling>0){var h=e.pixelCullingCst;if(!e.isOrtho){var c=e.matrixWorldInverse.elements;h*=i(c[2]*a.x+c[6]*a.y+c[10]*a.z+c[14])}o<h&&(!1===n.hasPoint?l=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.rebuildDisplayLists=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!l&&t.performFrustumCulling(o,a,n)}}class n extends r{constructor(e){super(e)}_performCulling(e,t,r){const n=this.object,s=this.worldCenterAndRadius;var a=s.worldCenter,o=s.worldRadius;if(e.pixelCulling>0){var l=e.pixelCullingCst;if(!e.isOrtho){var h=e.matrixWorldInverse.elements;l*=i(h[2]*a.x+h[6]*a.y+h[10]*a.z+h[14])}if(o<l)return!1}return t.performFrustumCulling(o,a,n)}}const s=e._VisuFilterType;let a=null;function o(e){return e._occurrence?e._occurrence:e}var l=function(){this._prevs=[],this._nexts=[],this._objects=[],this._emptySpace=null,this._emptySpaceSize=0,this._fragmentationSize=0,this._lastDefrag=0,this._first=-1,this._last=-1,this.size=0,this._orderedObjects=null,this._lookUpMap=new Map};return l.prototype.getObjects=function(){if(this._tryDefrag(),null===this._orderedObjects&&(this._orderedObjects=[],!this._isEmpty())){this._orderedObjects.push(this._objects[this._first]);for(var e=this._nexts[this._first];e>=0;e=this._nexts[e])this._objects[e]&&this._orderedObjects.push(this._objects[e])}return this._orderedObjects},l.prototype._defrag=function(){this._emptySpaceSize=0,this._emptySpace=null,this._fragmentationSize=0;var e=this.getObjects();this._first=e.length>0?0:-1,this._last=e.length-1,this._objects=new Array(e.length),this._prevs=new Array(e.length),this._nexts=new Array(e.length),this._lookUpMap=new Map;for(let r=0;r<e.length;r++){var t=e[r];this._objects[r]=t,this._setPrevious(r,r-1),r===e.length-1?this._setNext(r,-1):this._setNext(r,r+1);var i=o(t.object);this._lookUpMap.has(i)?this._lookUpMap.get(i).push(r):this._lookUpMap.set(i,[r])}},l.prototype._tryDefrag=function(){this._lastDefrag++,this._lastDefrag>100&&(this._lastDefrag=0,(this._emptySpaceSize>0||this._fragmentationSize>0)&&this._defrag())},l.prototype.getLinkedList=function(){return this._isEmpty()?null:(this._tryDefrag(),{first:this._first,nexts:this._nexts,objects:this._objects})},l.prototype._isEmpty=function(){return-1===this._first},l.prototype._hasEmpty=function(){return null!==this._emptySpace},l.prototype._pop=function(){this._hasEmpty()&&this._emptySpaceSize--,this._emptySpace=this._emptySpace?this._emptySpace.prev:null},l.prototype._push=function(e){this._emptySpace={index:e,prev:this._emptySpace},this._emptySpaceSize++},l.prototype._getInsertionIndex=function(){var e=-1;return this._hasEmpty()?(e=this._emptySpace.index,this._pop()):e=this._objects.length,e},l.prototype._getNext=function(e){return this._nexts[e]},l.prototype._hasNext=function(e){return-1!==this._nexts[e]},l.prototype._setNext=function(e,t){this._nexts[e]=t},l.prototype._getPrevious=function(e){return this._prevs[e]},l.prototype._hasPrevious=function(e){return-1!==this._prevs[e]},l.prototype._setPrevious=function(e,t){this._prevs[e]=t},l.prototype.add=function(e){if(null!==e){var t=this._getInsertionIndex();if(this._isEmpty())this._objects[t]=e,this._setNext(t,-1),this._setPrevious(t,-1),this._first=t,this._last=t;else{var i=this._getInsertionStructure(e.object);if(i){if(i.before>-1||i.after>-1){if(this._objects[t]=e,this._nexts[t]=-1,this._prevs[t]=-1,i.after>-1){var r=i.after;this._setNext(t,this._getNext(r)),this._setPrevious(t,r),this._hasNext(t)?this._setPrevious(this._getNext(r),t):this._last=t,this._setNext(r,t)}else{var n=i.before;this._setNext(t,n),this._setPrevious(t,this._getPrevious(n)),this._hasPrevious(t)?this._setNext(this._getPrevious(n),t):this._first=t,this._setPrevious(n,t)}(this._getNext(t)!==t+1&&-1!==this._getNext(t)||this._getPrevious(t)!==t-1&&-1!==this._getPrevious(t))&&this._fragmentationSize++}}else this._objects[t]=e,this._setNext(t,-1),this._setPrevious(t,this._last),this._setNext(this._last,t),this._last=t}var s=o(e.object);this._lookUpMap.has(s)?this._lookUpMap.get(s).push(t):this._lookUpMap.set(s,[t]),this._orderedObjects=null,this.size++}},l.prototype._getInsertionStructure=function(e){var t=e._occurrence;if(t&&(t.prev||t.next)){if(!t.prev)return{before:this._first,after:-1};if(!t.next)return{before:-1,after:this._last};for(var i=!1,r=t.prev,n=t.next,s={before:-1,after:-1};;){var a;if(r&&!i)if(a=this._lookUpMap.get(r)){for(var o=a.length-1;o>=0&&(s.after=a[o],!(s.after>-1));o--);i=!0}else r=r.prev;if(n&&!i)if(a=this._lookUpMap.get(n)){for(o=0;o<a.length&&(s.before=a[o],!(s.before>-1));o++);i=!0}else n=n.next;if(i){if(s.after<0&&s.before<0)throw"Hol'up";return s}if(null===r&&null===n)break}return{before:this._first,after:-1}}return null},l.prototype._shuffle=function(){var e=this.size,t=this._prevs,i=this._objects,r=this._nexts,n=Math.ceil(Math.random()*(e-2)),s=Math.ceil(Math.random()*(e-2));if(0!==n&&0!==s&&n!=s&&r[n]!==s&&r[s]!==n){var a=t[n],o=r[n],l=t[s],h=r[s],c=i[n],d=i[s];c&&d&&(this._first===n?this._first=s:this._first===s&&(this._first=n),this._last===n?this._last=s:this._last===s&&(this._last=n),r[a]=s,t[o]=s,r[l]=n,t[h]=n,r[n]=h,t[n]=l,r[s]=o,t[s]=a,i[n]=d,i[s]=c,(this._getNext(n)!==n+1&&-1!==this._getNext(n)||this._getPrevious(n)!==n-1&&-1!==this._getPrevious(n))&&this._fragmentationSize++)}},l.prototype._applyToObject=function(e,t){if(null!==e){var i=o(e);if(this._lookUpMap.has(i))for(var r=this._lookUpMap.get(i),n=0;n<r.length;n++)r[n]>-1&&t(this._objects[r[n]])}},l.prototype._remove=function(e){if(null===e)return!1;var t=o(e);if(this._lookUpMap.has(t)){for(var i=this._lookUpMap.get(t),r=0,n=0,s=0;s<i.length;s++){var a=i[s],l=this._objects[a];l?l.object===e&&(this._objects[a]=null,i[s]=-1,this._hasPrevious(a)?this._hasNext(a)?(this._setNext(this._getPrevious(a),this._getNext(a)),this._setPrevious(this._getNext(a),this._getPrevious(a))):(this._setNext(this._getPrevious(a),-1),this._last=this._getPrevious(a)):this._hasNext(a)?(this._setPrevious(this._getNext(a),-1),this._first=this._getNext(a)):(this._first=-1,this._last=-1),this._push(a),r++,this.size--):n++}return r+n===i.length&&this._lookUpMap.delete(t),r>0}return!1},l.prototype.remove=function(e){this._remove(e)&&(this._orderedObjects=null,(this._emptySpaceSize>1e3||this._fragmentationSize>1e3)&&this._defrag())},l.prototype.removeCollection=function(e){var t=0,i=this;e.forEach((function(e,r,n){i._remove(e)&&t++})),t>0&&(this._orderedObjects=null,(this._emptySpaceSize>1e3||this._fragmentationSize>1e3)&&this._defrag())},l.prototype.clear=function(){this._prevs=[],this._nexts=[],this._objects=[],this._emptySpace=null,this._emptySpaceSize=0,this._fragmentationSize=0,this._lastDefrag=0,this._orderedObjects=null,this.size=0,this._lookUpMap.clear()},l.__WebGLObject=r,l.__WebGLObjectNoPoints=n,l.__WebGLObjectCurvedPipe=class extends n{constructor(e){super(e)}_performCulling(e,t,i){var r=super._performCulling(e,t,i);return r&&this.object._computeLOD(e,i),r}},l.__WebGLObjectFixedSize=class extends r{constructor(e){super(e)}_performCulling(e,t,r){const n=this.object,s=this.worldCenterAndRadius;var a=s.worldCenter,o=s.pixelRadius;r.currentRenderPointsOnly=!1;var l=!1,h=e.pixelCulling;if(h>0&&o<h&&(!1===n.hasPoint?l=!0:r.currentRenderPointsOnly=!0),r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.rebuildDisplayLists=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),l)return!1;var c=o*e._pixelToWorldSizeCst;if(!e.isOrtho){var d=e.matrixWorldInverse.elements;c*=i(d[2]*a.x+d[6]*a.y+d[10]*a.z+d[14])}return t.performFrustumCulling(c,a,n)}},l.__WebGLObjectHybrid=class extends r{constructor(e){super(e)}_performCulling(e,t,r){const n=this.object,s=this.worldCenterAndRadius;var a=s.worldCenter,o=s.worldRadius,l=s.pixelRadius*e._pixelToWorldSizeCst,h=1;if(!e.isOrtho){var c=e.matrixWorldInverse.elements;l*=h=i(c[2]*a.x+c[6]*a.y+c[10]*a.z+c[14])}o+=l,r.currentRenderPointsOnly=!1;var d=!1;if(e.pixelCulling>0){var u=e.pixelCullingCst;e.isOrtho||(u*=h),o<u&&(!1===n.hasPoint?d=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.rebuildDisplayLists=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!d&&t.performFrustumCulling(o,a,n)}},l.__WebGLObjectHybridNoPoints=class extends r{constructor(e){super(e)}_performCulling(e,t,r){const n=this.object,s=this.worldCenterAndRadius;var a=s.worldCenter,o=s.worldRadius,l=s.pixelRadius*e._pixelToWorldSizeCst,h=1;if(!e.isOrtho){var c=e.matrixWorldInverse.elements;l*=h=i(c[2]*a.x+c[6]*a.y+c[10]*a.z+c[14])}if(o+=l,e.pixelCulling>0){var d=e.pixelCullingCst;if(e.isOrtho||(d*=h),o<d)return!1}return t.performFrustumCulling(o,a,n)}},l.__WebGLObjectInstancing=class extends r{constructor(e){super(e)}_performCulling(e,t,r){const n=this.object;let s=n._occurrence;for(;s&&!s.node._instancingInfos;)s=s.parent;const a=this.worldCenterAndRadius;var o=a.worldCenter,l=a.worldRadius,h=s?s.node.getPixelCullingRadius(n,s):l,c=a.pixelRadius*e._pixelToWorldSizeCst,d=1;if(!e.isOrtho){var u=e.matrixWorldInverse.elements;d=i(u[2]*o.x+u[6]*o.y+u[10]*o.z+u[14]),c*=d=Math.max(0,d-l)}l+=c,h+=c,r.currentRenderPointsOnly=!1;var p=!1;if(e.pixelCulling>0){var f=e.pixelCullingCst;e.isOrtho||(f*=d),h<f&&(!1===n.hasPoint?p=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.rebuildDisplayLists=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!p&&t.performFrustumCulling(l,o,n)}},l.__WebGLObjectInstancingNoPoints=class extends r{constructor(e){super(e)}_performCulling(e,t,r){const n=this.object;let s=n._occurrence;for(;s&&!s.node._instancingInfos;)s=s.parent;const a=this.worldCenterAndRadius;var o=a.worldCenter,l=a.worldRadius,h=s?s.node.getPixelCullingRadius(n,s):l,c=a.pixelRadius*e._pixelToWorldSizeCst,d=1;if(!e.isOrtho){var u=e.matrixWorldInverse.elements;d=i(u[2]*o.x+u[6]*o.y+u[10]*o.z+u[14]),c*=d=Math.max(0,d-l)}if(l+=c,h+=c,e.pixelCulling>0){var p=e.pixelCullingCst;if(e.isOrtho||(p*=d),h<p)return!1}return t.performFrustumCulling(l,o,n)}},l.__WebGLObjectLOD=class extends r{constructor(e,t){super(t),this.webGLObject=e,this.lodFilter=this.object._occurrence._getFilter(s._LOD_BRANCH)}get frustumCulled(){return!0}set frustumCulled(e){this.webGLObject&&(this.webGLObject.frustumCulled=e)}_performCulling(e,t,i){return!!this.lodFilter.canRender()&&(!this.webGLObject.frustumCulled||this.webGLObject._performCulling(e,t,i))}},l.__WebGLObjectEditable=class extends r{constructor(t,i){super(i),this.webGLObject=t,a||(a=e._currentGPUUtils)}get frustumCulled(){return!0}set frustumCulled(e){this.webGLObject&&(this.webGLObject.frustumCulled=e)}_performCulling(e,i,r){if(!this.webGLObject.frustumCulled||this.webGLObject._performCulling(e,i,r)){const e=a.currentBufferGPUManager;if(e){const i=this.object.geometry.length?this.object.geometry:[this.object.geometry];for(let r=0;r<i.length;r++){let n=i[r];if(null!==n.staleIndices||null!==n.staleAttributes){const i=n.isAttributeStale("position");e.updateEditableBuffers(n),n.vertexLineDistancesArray&&i&&t._computeLineDistances(n)}}}return!0}return!1}},l})),define("DS/Visualization/ImageUtils",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats","DS/Visualization/ImageLoaders/Basis","DS/Visualization/ImageLoaders/HDR","DS/Visualization/ImageLoaders/TGA","DS/Visualization/ImageLoaders/DDS"],(function(e,t,i,r,n,s){"use strict";let a={};var o={};return a.Utils=o,o.nbTexturesBeingLoaded=0,o.crossOrigin="anonymous",o.is_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)===t},o.nearest_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))},o.nearest_greater_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.ceil(t))},o.nearest_smaller_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.floor(t))},o._loadTextureWithProxy=function(t,i,r,n,s,a,o,l){return window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(t=UWA.Data.proxifyUrl(t,{proxy:"passport"})),e.ImageUtils.loadTexture(t,i,r,n,s,a,o,l)},o.loadTexture=function(t,i,r,n,s,a,l,h,c,d,u,p,f){var g=document.createElement("canvas");g.width=16,g.height=16;var m=h;m?(m.image=g,m.mapping=i):m=new e.Texture(g,i,d,u,p,f),m.loadEndStatus=e.AssetLoadingStatus.LOADING;var v=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),_=!t.startsWith("data:");if(v&&_&&(void 0===s||!1===s)){var y={headers:new Object,method:"GET",authentication:"ajax",timeout:36e5,async:!0,type:"blob",onComplete:function(t){var i=URL.createObjectURL(t),s=new Image,l=new e.ImageLoader;l.addEventListener("load",(function(t){o.nbTexturesBeingLoaded--,m.needsUpdate=!0,m.loadEndStatus=e.AssetLoadingStatus.READY;var i,n,l,h;if(h=c&&(s.width>c||s.height>c),l=a&&(!o.is_pow2(s.width)||!o.is_pow2(s.height)),h||l){if(i=s.width,n=s.height,l&&(i=o.nearest_pow2(s.width),n=o.nearest_pow2(s.height)),h){for(;i>c||n>c;)i/=2,n/=2;i=Math.floor(i),n=Math.floor(n)}m.image.width=i,m.image.height=n,m.image.getContext("2d").drawImage(s,0,0,i,n)}else m.image=s;r&&r(m);for(var d=0;d<m.onLoadCallbacks.length;d++)m.onLoadCallbacks[d](m)})),l.addEventListener("error",(function(t){o.nbTexturesBeingLoaded--,n&&n(t.message),m.loadEndStatus=e.AssetLoadingStatus.ERROR})),l.load(i,s)},onFailure:function(t){o.nbTexturesBeingLoaded--,n&&n(event.message),m.loadEndStatus=e.AssetLoadingStatus.ERROR},onTimeout:function(){o.nbTexturesBeingLoaded--,n&&n(event.message),m.loadEndStatus=e.AssetLoadingStatus.ERROR}};UWA.Data.request(t,y)}else{var S=new Image;null!==s&&(S.crossOrigin=s?"use-credentials":"anonymous");var b=new e.ImageLoader;b.addEventListener("load",(function(t){o.nbTexturesBeingLoaded--,m.needsUpdate=!0,m.loadEndStatus=e.AssetLoadingStatus.READY;var i,n,s,l;if(l=c&&(S.width>c||S.height>c),s=a&&(!o.is_pow2(S.width)||!o.is_pow2(S.height)),l||s){if(i=S.width,n=S.height,s&&(i=o.nearest_pow2(S.width),n=o.nearest_pow2(S.height)),l){for(;i>c||n>c;)i/=2,n/=2;i=Math.floor(i),n=Math.floor(n)}m.image.width=i,m.image.height=n,m.image.getContext("2d").drawImage(S,0,0,i,n)}else m.image=S;r&&r(m);for(var h=0;h<m.onLoadCallbacks.length;h++)m.onLoadCallbacks[h](m)})),b.addEventListener("error",(function(t){o.nbTexturesBeingLoaded--,n&&n(t.message),m.loadEndStatus=e.AssetLoadingStatus.ERROR})),S.crossOrigin&&(b.crossOrigin=S.crossOrigin),l?(m.loadEndStatus=e.AssetLoadingStatus.PAUSED,m.onRequest=function(){m.loadEndStatus=e.AssetLoadingStatus.LOADING,b.load(t,S),o.nbTexturesBeingLoaded++,m.onRequest=null}):(b.load(t,S),o.nbTexturesBeingLoaded++),m.sourceFile=t}return m},o.loadTexture2=function(e,t,i,r,n){return console.warn("loadTexture2 is deprecated, use loadTexture with forcePowerOfTwo parameter activated"),o.loadTexture(e,t,i,r,n,!0)},o._loadTextureVisu=function(e,t,i,r,n,s,a){var l=require.toUrl("DS/"+e+"/assets/"+t);return o.loadTexture(l,i,r,n,s,a)},o.loadTextureCube=function(t,i,r,n){var s={images:[],loadCount:0},a=new e.Texture;a.loadEndStatus=e.AssetLoadingStatus.LOADING,void 0!==i&&(a.mapping=i),a.flipY=!1;for(var l=0;l<t.length;++l){var h=new Image;s.images[l]=h,h.onload=function(){if(s.loadCount+=1,o.nbTexturesBeingLoaded--,6===s.loadCount){a.loadEndStatus!==e.AssetLoadingStatus.ERROR&&(a.loadEndStatus=e.AssetLoadingStatus.READY),a.needsUpdate=!0,a.image=s.images[0],a.extraFaces=new Array(5);for(var t=1;t<s.images.length;t++)a.extraFaces[t-1]=new e.Texture.Face(s.images[t],null);r&&r(a);for(t=0;t<a.onLoadCallbacks.length;t++)a.onLoadCallbacks[t](a)}},h.onerror=function(){s.loadCount+=1,o.nbTexturesBeingLoaded--,a.loadEndStatus=e.AssetLoadingStatus.ERROR,n&&n()},h.crossOrigin=this.crossOrigin,o.nbTexturesBeingLoaded++,h.src=t[l]}return a},o.crossOriginPolicy=!0,o.loadTextureFromFormat=function(e,t,i,r){var n;return"dds"===t?n=o.loadCompressedTexture(blobUrl,null,(function(){i&&i(n)}),(function(){r&&r(n)}),!0):"hdr"===t?n=o.loadHDRTexture(blobUrl,null,(function(){i&&i(n)}),(function(){r&&r(n)}),!0,!1,!0):(n=o.loadTexture(blobUrl,null,(function(){i&&i(n)}),(function(){r&&r(n)}),void 0,!0)).flipY=!0,n},o.loadCompressedTexture=function(t,i,r,n,s,a,l){var h=l||new e.CompressedTexture;h.mapping=i;var c=new XMLHttpRequest;return c.onload=function(){o.nbTexturesBeingLoaded--;var t=c.response,i=o.parseDDS(t,!0,s);if(h.sRGB=i.sRGB,h.format=i.format,i.type&&(h.type=i.type),h.width=i.width,h.height=i.height,i.isCubemap){h.image={data:null,width:i.width,height:i.height};var n=i.mipmaps.length/i.mipmapCount;h.extraFaces=new Array(n-1);for(var a=0;a<n;a++){var l=h;a>0&&(l=new e.Texture.Face(null,[]),h.extraFaces[a-1]=l);for(var d=0;d<i.mipmapCount;d++)l.mipmaps.push(i.mipmaps[a*i.mipmapCount+d])}var u=h.extraFaces[2];h.extraFaces[2]=h.extraFaces[1],h.extraFaces[1]=u}else h.mipmaps=i.mipmaps,h.image.width=i.width,h.image.height=i.height;h.generateMipmaps=!1,(!h.mipmaps||h.mipmaps&&h.mipmaps.length<2)&&(1003!=h.magFilter&&1006!=h.magFilter&&(h.magFilter=1006),1003!=h.minFilter&&1006!=h.minFilter&&(h.minFilter=1006)),h.needsUpdate=!0,h.loadEndStatus=e.AssetLoadingStatus.READY,r&&r(h);for(d=0;d<h.onLoadCallbacks.length;d++)h.onLoadCallbacks[d](h)},a?(h.loadEndStatus=e.AssetLoadingStatus.PAUSED,h.onRequest=function(){h.loadEndStatus=e.AssetLoadingStatus.LOADING,o.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.send(null),h.onRequest=null}):(h.loadEndStatus=e.AssetLoadingStatus.LOADING,o.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.send(null)),h},o.loadCompressedTextureFromBuffer=function(t,i){var r=new e.CompressedTexture;r.loadEndStatus=e.AssetLoadingStatus.READY,r.mapping=i;var n=o.parseDDS(t,!0);return r.format=n.format,r.mipmaps=n.mipmaps,r.image.width=n.width,r.image.height=n.height,r.generateMipmaps=!1,r.needsUpdate=!0,r},o.loadVideoTexture=function(t,i,r){var n=new e.Texture(t,i);return n.forceUpdate=!0,n.generateMipmaps=!1,n.minFilter=1006,n.flipY=void 0!==r?r:n.flipY,n.loadEndStatus=e.AssetLoadingStatus.READY,n},o.loadVideoTextureFrame=function(t,i,r,n){var s=n||new e.Texture(t,i);return s.image=t,s.needsUpdate=!0,s.generateMipmaps=!1,s.minFilter=1006,s.flipY=void 0!==r?r:s.flipY,s.loadEndStatus=e.AssetLoadingStatus.READY,s},o.loadFromCanvas=function({width:t,height:i,draw:r}){const n=document.createElement("canvas");n.width=t,n.height=i;const s=n.getContext("2d");s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,t,i),s.globalAlpha=1;try{r(s)}catch(e){console.log(e)}const a=new e.Texture(n,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter);return a.needsUpdate=!0,a},i(o),r(o),n(o),s(o),a})),define("DS/Visualization/OcclusionSystem",["DS/Visualization/OcclusionShaders","DS/Object3D/Mesh"],(function(e,t){"use strict";const i=Object.freeze({NONE:0,WORKING_DEPTH:1,OCCLUDED_BBOX:2});class r{constructor(e){this.contextCount=e,this.contexts=new Array(this.contextCount);for(let e=0;e<this.contextCount;++e)this.contexts[e]={contextIndex:e,resultBuffers:null,resultBuffersDirty:!0,timestampQueries:null,isReadingBack:!1,objectCount:0,objectIDs:[]};this.currentFrameIndex=-1,this.currentContextIndex=-1,this.lastFrameReadBack=-1,this.debugView=i.NONE,this.capacity=0,this.objectCount=0,this.objectMap=Object.create(null),this.objectIDs=new Uint32Array(0),this.objectAABBs=new Float32Array(0),this.dirtyAABBRange={min:0,max:-1},this.worldMatrices=new Float32Array(0),this.dirtyMatrixRange={min:0,max:-1},this.visibilityStates=new Uint8Array(0),this.pipelines=null,this.bindGroupLayouts=null,this.bindGroups=null,this.inputBuffers=null,this.inputBuffersDirty=!0,this.renderSize={x:0,y:0},this.renderTextures=null,this.cpuProfilingEnabled=!1,this.gpuProfilingEnabled=!1,this.timestampHistory={},this.cpuProfilingEnabled&&(this.timestampHistory.cpu={frame:new Array(64).fill(0),ctxUpdate:new Array(64).fill(0),cmdEncoding:new Array(64).fill(0),readbackSubmit:new Array(64).fill(0)}),this.gpuProfilingEnabled&&(this.timestampHistory.gpu={frame:new Array(64).fill(0),downsample:new Array(64).fill(0),reset:new Array(64).fill(0),test:new Array(64).fill(0),pack:new Array(64).fill(0)})}registerObjects(e){this._resize(this.objectCount+e.length);for(const t of e)this._registerObject(t)}unregisterObjects(e){for(const t of e)this._unregisterObject(t)}execute(e,t,r,n){if(0==this.objectCount)return;if(this.currentFrameIndex>=e.currentFrameIndex)return void console.warn("[Occlusion] culling was already executed this frame.");this.currentFrameIndex=e.currentFrameIndex,this.debugView=n?i.OCCLUDED_BBOX:i.NONE;const s=(this.currentContextIndex+1)%this.contextCount,a=this.contexts[s];if(a.isReadingBack)return;this.currentContextIndex=s,this._beginCpuProfileScope("frame"),this._beginCpuProfileScope("ctxUpdate"),a.objectIDs=this.objectIDs.slice(),a.objectCount=this.objectCount,a.wordCount=Math.ceil(a.objectCount/32);const o=e.webGPUDevice,l=r.__colorTextures[0],h=r.__depthTexture;this.pipelines||(this.bindGroupLayouts=this._createBindGroupLayouts(o),this.pipelines=this._createPipelines(o)),this.gpuProfilingEnabled&&!a.timestampQueries&&(a.timestampQueries=this._createTimestampQueries(o)),this.inputBuffersDirty&&(this.inputBuffers&&Object.values(this.inputBuffers).forEach((e=>e.destroy())),this.inputBuffers=this._allocateInputBuffers(o,this.capacity),this.inputBuffersDirty=!1),a.resultBuffersDirty&&(a.resultBuffers&&Object.values(a.resultBuffers).forEach((e=>e.destroy())),a.resultBuffers=this._allocateResultBuffers(o,this.capacity),a.resultBuffersDirty=!1),this.renderSize.x==h.width&&this.renderSize.y==h.height||(this.renderSize={x:h.width,y:h.height},this.renderTextures&&Object.values(this.renderTextures).forEach((e=>e.texture.destroy())),this.renderTextures=this._allocateRenderTextures(o,this.renderSize)),this._updateInputBuffers(o,a,t),this._updateBindGroups(o,a,h),this._endCpuProfileScope("ctxUpdate"),this._beginCpuProfileScope("cmdEncoding");let c=o.createCommandEncoder({label:"occlusionEncoder"});this._dispatchDepthDownsample(c,a),this._dispatchVisibilityReset(c,a),this._paintOcclusionTest(c,a),this._dispatchResultPacking(c,a),this._copyToReadableBuffer(c,a),this.debugView==i.WORKING_DEPTH?this._paintWorkingDepthDebug(c,l):this.debugView==i.OCCLUDED_BBOX&&this._paintOccludedBboxDebug(c,l),o.queue.submit([c.finish()]),this._endCpuProfileScope("cmdEncoding"),this._beginCpuProfileScope("readbackSubmit"),o.queue.onSubmittedWorkDone().then((()=>this._handleAsyncReadback(a))),a.isReadingBack=!0,this._endCpuProfileScope("readbackSubmit"),this._endCpuProfileScope("frame"),this.cpuProfilingEnabled&&this.currentFrameIndex%64==0&&this._dumpProfilingResults("CPU",this.timestampHistory.cpu,"color:rgb(245, 212, 82)"),this.gpuProfilingEnabled&&this.lastFrameReadBack%64==0&&this._dumpProfilingResults("GPU",this.timestampHistory.gpu,"color:rgb(242, 76, 245)")}notifyObjectChanged(e){const t=this.objectMap[e.id];void 0!==t&&this._setWorldMatrix(t,e.matrixWorld)}getOcclusionResult(e){const t=this.objectMap[e.id];return void 0===t||this.visibilityStates[t]>0}destroy(){this.inputBuffers&&Object.values(this.inputBuffers).forEach((e=>e.destroy())),this.renderTextures&&Object.values(this.renderTextures).forEach((e=>e.texture.destroy()));for(let e of this.contexts)e.resultBuffers&&Object.values(e.resultBuffers).forEach((e=>e.destroy())),e.timestampQueries&&Object.values(e.timestampQueries).forEach((e=>e.destroy()))}_resize(e){if(!(this.capacity>=e)){this.capacity=e,this.objectIDs=this._resizeTypedArray(this.objectIDs,this.capacity),this.visibilityStates=this._resizeTypedArray(this.visibilityStates,this.capacity),this.objectAABBs=this._resizeTypedArray(this.objectAABBs,6*this.capacity),this.dirtyAABBRange={min:0,max:this.objectCount-1},this.worldMatrices=this._resizeTypedArray(this.worldMatrices,16*this.capacity),this.dirtyMatrixRange={min:0,max:this.objectCount-1},this.inputBuffersDirty=!0;for(let e of this.contexts)e.resultBuffersDirty=!0}}_registerObject(e){if(e.id in this.objectMap)return void console.warn(`[Occlusion] object with ID ${e.id} is already registered.`);if(this.objectCount>=this.capacity)return void console.warn(`[Occlusion] registration failed: capacity ${this.capacity} exceeded.`);if(!(e instanceof t))return void console.warn(`[Occlusion] invalid object type: expected Mesh, got ${e?.constructor?.name||typeof e}.`);const i=this.objectCount;return this.objectCount++,this.objectMap[e.id]=i,this.objectIDs[i]=e.id,this.visibilityStates[i]=1,this._setObjectAABB(i,e.geometry.boundingBox),this._setWorldMatrix(i,e.matrixWorld),i}_unregisterObject(e){const t=this.objectMap[e.id];if(void 0===t)return;const i=this.objectCount-1;if(t!==i){const e=this.objectIDs[i];this.objectMap[e]=t,this.objectIDs[t]=e,this.objectAABBs.set(this.objectAABBs.subarray(6*i,6*(i+1)),6*t),this.worldMatrices.set(this.worldMatrices.subarray(16*i,16*(i+1)),16*t),this.visibilityStates[t]=this.visibilityStates[i],this.dirtyAABBRange.min=Math.min(this.dirtyAABBRange.min,t),this.dirtyAABBRange.max=Math.max(this.dirtyAABBRange.max,t),this.dirtyMatrixRange.min=Math.min(this.dirtyMatrixRange.min,t),this.dirtyMatrixRange.max=Math.max(this.dirtyMatrixRange.max,t)}this.objectMap[e.id]=void 0,this.objectCount--}_resizeTypedArray(e,t){const i=new e.constructor(t);return i.set(e.subarray(0,Math.min(e.length,t))),i}_setObjectAABB(e,t){this.objectAABBs.set([t.min.x,t.min.y,t.min.z,t.max.x,t.max.y,t.max.z],6*e),this.dirtyAABBRange.min=Math.min(this.dirtyAABBRange.min,e),this.dirtyAABBRange.max=Math.max(this.dirtyAABBRange.max,e)}_setWorldMatrix(e,t){this.worldMatrices.set(t.elements,16*e),this.dirtyMatrixRange.min=Math.min(this.dirtyMatrixRange.min,e),this.dirtyMatrixRange.max=Math.max(this.dirtyMatrixRange.max,e)}_allocateInputBuffers(e,t){return{cbConstants:e.createBuffer({size:52*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),bfObjectAABBs:e.createBuffer({size:6*t*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),bfWorldMatrices:e.createBuffer({size:16*t*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),bfOccludedIndices:e.createBuffer({size:t*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST})}}_allocateResultBuffers(e,t){const i=Math.ceil(t/32);return{bfVisibility:e.createBuffer({size:t*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE}),bfPackedResults:e.createBuffer({size:i*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),bfReadbackResults:e.createBuffer({size:i*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST})}}_allocateRenderTextures(e,t){const i={x:Math.floor(t.x/2),y:Math.floor(t.y/2)};return{workingDepth:this._createTexture(e,"txWorkingDepth",i,"r32float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING),dummyColorTarget:this._createTexture(e,"txDummyColorTarget",i,"r8unorm",GPUTextureUsage.RENDER_ATTACHMENT),debugDepth:this._createTexture(e,"txDebugDepth",t,"depth24plus",GPUTextureUsage.RENDER_ATTACHMENT)}}_createTexture(e,t,i,r,n){const s=e.createTexture({label:t,size:[i.x,i.y],format:r,usage:n}),a=s.createView({label:t});return{texture:s,view:a,width:i.x,height:i.y}}_createTimestampQueries(e){return{querySet:e.createQuerySet({type:"timestamp",count:8}),bfQueryResolve:e.createBuffer({size:8*BigInt64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),bfReadbackTimestamps:e.createBuffer({size:8*BigInt64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST})}}_createBindGroupLayouts(e){return{depthDownsample:e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"depth"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"r32float"}}]}),occlusionTest:e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}]}),resultPacking:e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),workingDepthDebug:e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}]}),occludedBboxDebug:e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]})}}_createPipelines(t){const i=t.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayouts.depthDownsample]}),r=t.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayouts.occlusionTest]}),n=t.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayouts.resultPacking]}),s=t.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayouts.workingDepthDebug]}),a=t.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayouts.occludedBboxDebug]});return{depthDownsample:t.createComputePipeline({layout:i,compute:{entryPoint:"main",module:t.createShaderModule({code:e.DepthDownsample_CS()})}}),visibilityReset:t.createComputePipeline({layout:r,compute:{entryPoint:"main",module:t.createShaderModule({code:e.VisibilityReset_CS()})}}),occlusionTest:t.createRenderPipeline({layout:r,vertex:{entryPoint:"main",module:t.createShaderModule({code:e.OcclusionTest_VS()})},fragment:{entryPoint:"main",targets:[{format:"r8unorm",writeMask:0}],module:t.createShaderModule({code:e.OcclusionTest_FS()})},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"}}),resultPacking:t.createComputePipeline({layout:n,compute:{entryPoint:"main",module:t.createShaderModule({code:e.ResultPacking_CS()})}}),workingDepthDebug:t.createRenderPipeline({layout:s,vertex:{entryPoint:"main",module:t.createShaderModule({code:e.WorkingDepthDebug_VS()})},fragment:{entryPoint:"main",targets:[{format:"rgba16float",writeMask:GPUColorWrite.ALL}],module:t.createShaderModule({code:e.WorkingDepthDebug_FS()})},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"}}),occludedBboxDebug:t.createRenderPipeline({layout:a,vertex:{entryPoint:"main",module:t.createShaderModule({code:e.OccludedBboxDebug_VS()})},fragment:{entryPoint:"main",targets:[{format:"rgba16float",writeMask:GPUColorWrite.ALL,blend:{color:{srcFactor:"src-alpha",dstFactor:"one",operation:"add"},alpha:{srcFactor:"zero",dstFactor:"one",operation:"add"}}}],module:t.createShaderModule({code:e.OccludedBboxDebug_FS()})},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less-equal",format:"depth24plus"}})}}_updateInputBuffers(e,t,r){{const i=new ArrayBuffer(this.inputBuffers.cbConstants.size),n=new Float32Array(i),s=new Uint32Array(i);n.set(r.matrixWorld.elements,0),n.set(r.matrixWorldInverse.elements,16),n.set(r.projectionMatrix.elements,32),n[48]=r.near,n[49]=r.far,s[50]=t.objectCount,s[51]=t.wordCount,e.queue.writeBuffer(this.inputBuffers.cbConstants,0,i,0,i.byteLength)}if(this.dirtyAABBRange.max>=this.dirtyAABBRange.min){let t=6*this.dirtyAABBRange.min*Float32Array.BYTES_PER_ELEMENT,i=6*(this.dirtyAABBRange.max-this.dirtyAABBRange.min+1)*Float32Array.BYTES_PER_ELEMENT;e.queue.writeBuffer(this.inputBuffers.bfObjectAABBs,t,this.objectAABBs.buffer,t,i),this.dirtyAABBRange={min:this.capacity,max:-1}}if(this.dirtyMatrixRange.max>=this.dirtyMatrixRange.min){let t=16*this.dirtyMatrixRange.min*Float32Array.BYTES_PER_ELEMENT,i=16*(this.dirtyMatrixRange.max-this.dirtyMatrixRange.min+1)*Float32Array.BYTES_PER_ELEMENT;e.queue.writeBuffer(this.inputBuffers.bfWorldMatrices,t,this.worldMatrices.buffer,t,i),this.dirtyMatrixRange={min:this.capacity,max:-1}}if(this.debugView==i.OCCLUDED_BBOX){let t=new Uint32Array(this.objectCount);this.occludedCount=0;for(let e=0;e<this.objectCount;e++)0===this.visibilityStates[e]&&(t[this.occludedCount]=e,this.occludedCount++);if(this.occludedCount>0){let i=this.occludedCount*Uint32Array.BYTES_PER_ELEMENT;e.queue.writeBuffer(this.inputBuffers.bfOccludedIndices,0,t.buffer,0,i)}}}_updateBindGroups(e,t,r){this.bindGroups={downsample:null,test:null,packing:null,debug:null},this.bindGroups.downsample=e.createBindGroup({layout:this.bindGroupLayouts.depthDownsample,entries:[{binding:0,resource:r.textureView},{binding:1,resource:this.renderTextures.workingDepth.view}]}),this.bindGroups.test=e.createBindGroup({layout:this.bindGroupLayouts.occlusionTest,entries:[{binding:0,resource:{buffer:this.inputBuffers.cbConstants,label:"cbConstants"}},{binding:1,resource:{buffer:this.inputBuffers.bfObjectAABBs,size:6*t.objectCount*Float32Array.BYTES_PER_ELEMENT,label:"bfObjectAABBs"}},{binding:2,resource:{buffer:this.inputBuffers.bfWorldMatrices,size:16*t.objectCount*Float32Array.BYTES_PER_ELEMENT,label:"bfWorldMatrices"}},{binding:3,resource:{buffer:t.resultBuffers.bfVisibility,size:t.objectCount*Uint32Array.BYTES_PER_ELEMENT,label:"bfVisibility"}},{binding:4,resource:this.renderTextures.workingDepth.view}]}),this.bindGroups.packing=e.createBindGroup({layout:this.bindGroupLayouts.resultPacking,entries:[{binding:0,resource:{buffer:this.inputBuffers.cbConstants,label:"cbConstants"}},{binding:1,resource:{buffer:t.resultBuffers.bfVisibility,size:t.objectCount*Uint32Array.BYTES_PER_ELEMENT,label:"bfVisibility"}},{binding:2,resource:{buffer:t.resultBuffers.bfPackedResults,size:t.wordCount*Uint32Array.BYTES_PER_ELEMENT,label:"bfPackedResults"}}]}),this.debugView==i.WORKING_DEPTH?this.bindGroups.debug=e.createBindGroup({layout:this.bindGroupLayouts.workingDepthDebug,entries:[{binding:0,resource:{buffer:this.inputBuffers.cbConstants,label:"cbConstants"}},{binding:1,resource:this.renderTextures.workingDepth.view}]}):this.debugView==i.OCCLUDED_BBOX&&this.occludedCount>0&&(this.bindGroups.debug=e.createBindGroup({layout:this.bindGroupLayouts.occludedBboxDebug,entries:[{binding:0,resource:{buffer:this.inputBuffers.cbConstants,label:"cbConstants"}},{binding:1,resource:{buffer:this.inputBuffers.bfObjectAABBs,size:6*this.objectCount*Float32Array.BYTES_PER_ELEMENT,label:"bfObjectAABBs"}},{binding:2,resource:{buffer:this.inputBuffers.bfWorldMatrices,size:16*this.objectCount*Float32Array.BYTES_PER_ELEMENT,label:"bfWorldMatrices"}},{binding:3,resource:{buffer:this.inputBuffers.bfOccludedIndices,size:this.occludedCount*Uint32Array.BYTES_PER_ELEMENT,label:"bfOccludedIndices"}}]}))}_dispatchDepthDownsample(e,t){const i=this.renderTextures.workingDepth,r=Math.ceil(i.width/8),n=Math.ceil(i.height/8);let s={label:"Occlusion::DepthDownsample"};this._addGpuProfileScope(t,s,0);const a=e.beginComputePass(s);a.setPipeline(this.pipelines.depthDownsample),a.setBindGroup(0,this.bindGroups.downsample),a.dispatchWorkgroups(r,n),a.end()}_dispatchVisibilityReset(e,t){const i=Math.ceil(t.objectCount/64);let r={label:"Occlusion::VisibilityReset"};this._addGpuProfileScope(t,r,1);const n=e.beginComputePass(r);n.setPipeline(this.pipelines.visibilityReset),n.setBindGroup(0,this.bindGroups.test),n.dispatchWorkgroups(i),n.end()}_paintOcclusionTest(e,t){const i=this.renderTextures.dummyColorTarget;let r={label:"Occlusion::OcclusionTest",colorAttachments:[{view:i.view,loadOp:"load",storeOp:"discard"}]};this._addGpuProfileScope(t,r,2);const n=e.beginRenderPass(r);n.setViewport(0,0,i.width,i.height,0,1),n.setPipeline(this.pipelines.occlusionTest),n.setBindGroup(0,this.bindGroups.test),n.draw(36,t.objectCount,0,0),n.end()}_dispatchResultPacking(e,t){const i=Math.ceil(t.wordCount/64);let r={label:"Occlusion::ResultPacking"};this._addGpuProfileScope(t,r,3);const n=e.beginComputePass(r);n.setPipeline(this.pipelines.resultPacking),n.setBindGroup(0,this.bindGroups.packing),n.dispatchWorkgroups(i),n.end()}_copyToReadableBuffer(e,t){const i=t.wordCount*Uint32Array.BYTES_PER_ELEMENT;if(e.copyBufferToBuffer(t.resultBuffers.bfPackedResults,0,t.resultBuffers.bfReadbackResults,0,i),!this.gpuProfilingEnabled)return;const r=t.timestampQueries;e.resolveQuerySet(r.querySet,0,r.querySet.count,r.bfQueryResolve,0),e.copyBufferToBuffer(r.bfQueryResolve,0,r.bfReadbackTimestamps,0,r.bfReadbackTimestamps.size)}_handleAsyncReadback(e){let t=e.resultBuffers.bfReadbackResults;const i=e.wordCount*Uint32Array.BYTES_PER_ELEMENT;if(t.mapAsync(GPUMapMode.READ,0,i).then((()=>{let r=new Uint32Array(t.getMappedRange(0,i));for(let t=0;t<e.objectCount;t++){const i=t%32,n=r[Math.floor(t/32)]&1<<i,s=e.objectIDs[t],a=this.objectMap[s];void 0!==a&&(this.visibilityStates[a]=0!==n?1:0)}t.unmap(),e.isReadingBack=!1})).catch((t=>{console.error("[Occlusion] mapAsync failed with error:",t),e.isReadingBack=!1})),!this.gpuProfilingEnabled)return;let r=e.timestampQueries.bfReadbackTimestamps;r.mapAsync(GPUMapMode.READ).then((()=>{this.lastFrameReadBack++;const e=this.lastFrameReadBack%64,t=new BigInt64Array(r.getMappedRange()),i=this.timestampHistory.gpu;i.frame[e]=Number(t[7]-t[0])/1e6,i.downsample[e]=Number(t[1]-t[0])/1e6,i.reset[e]=Number(t[3]-t[2])/1e6,i.test[e]=Number(t[5]-t[4])/1e6,i.pack[e]=Number(t[7]-t[6])/1e6,r.unmap()})).catch((e=>{console.error("[Occlusion] mapAsync failed with error:",e)}))}_paintWorkingDepthDebug(e,t){const i={label:"Occlusion::DebugView",colorAttachments:[{view:t.colorAttachmentsView,loadOp:"load",storeOp:"store"}]},r=e.beginRenderPass(i);r.setViewport(0,0,t.width,t.height,0,1),r.setPipeline(this.pipelines.workingDepthDebug),r.setBindGroup(0,this.bindGroups.debug),r.draw(3,1,0,0),r.end()}_paintOccludedBboxDebug(e,t){if(0===this.occludedCount)return;const i={label:"Occlusion::DebugView",colorAttachments:[{view:t.colorAttachmentsView,loadOp:"load",storeOp:"store"}],depthStencilAttachment:{view:this.renderTextures.debugDepth.view,depthLoadOp:"clear",depthStoreOp:"discard",depthClearValue:1}},r=e.beginRenderPass(i);r.setViewport(0,0,t.width,t.height,0,1),r.setPipeline(this.pipelines.occludedBboxDebug),r.setBindGroup(0,this.bindGroups.debug),r.draw(36,this.occludedCount,0,0),r.end()}_beginCpuProfileScope(e){if(!this.cpuProfilingEnabled)return;const t=this.timestampHistory.cpu,i=this.currentFrameIndex%64;t[e][i]=performance.now()}_endCpuProfileScope(e){if(!this.cpuProfilingEnabled)return;const t=this.timestampHistory.cpu,i=this.currentFrameIndex%64,r=t[e][i];t[e][i]=Number(performance.now()-r)}_addGpuProfileScope(e,t,i){this.gpuProfilingEnabled&&(t.timestampWrites={querySet:e.timestampQueries.querySet,beginningOfPassWriteIndex:2*i,endOfPassWriteIndex:2*i+1})}_dumpProfilingResults(e,t,i){const r=e=>e.reduce(((e,t)=>e+t),0)/e.length,n=t.frame?r(t.frame).toFixed(2):null,s=[];for(const e in t){if("frame"===e)continue;const i=r(t[e]).toFixed(2);s.push(`${e}: ${i} ms`)}const a=s.length>0?` (${s.join(" | ")})`:"";console.log(`%c [${e.toUpperCase()}] ${n} ms${a}`,i)}}return{__OcclusionSystemFactory:new class{constructor(){this.systems=new Map}_makeKey(e,t){return`${t.id}_${e._renderingRole}`}getOrCreate(e,t,i){const n=this._makeKey(t,i);if(!this.systems.has(n)){const t=new r(e);t.registerObjects(i.getMeshInstances()),i._occlusionSystem=t,this.systems.set(n,t)}return this.systems.get(n)}get(e,t){const i=this._makeKey(e,t);return this.systems.get(i)||null}dispose(){for(const e of this.systems.values())e.destroy();this.systems.clear()}}}})),define("DS/Visualization/Shapes",["DS/Mesh/ThreeJS_Base","DS/Visualization/Curves"],(function(e,t){"use strict";let i={};var r,n,s;return i.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase(),i=this;i.faces[t]=i.faces[t]||{},i.faces[t][e.cssFontWeight]=i.faces[t][e.cssFontWeight]||{},i.faces[t][e.cssFontWeight][e.cssFontStyle]=e;i.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(e){var i,r=this.getFace(),n=this.size/r.resolution,s=0,a=String(e).split(""),o=a.length,l=[];for(i=0;i<o;i++){var h=new t.Path,c=this.extractGlyphPoints(a[i],r,n,s,h);s+=c.offset,l.push(c.path)}return{paths:l,offset:s/2}},extractGlyphPoints:function(e,t,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P=[],C=t.glyphs[e]||t.glyphs["?"];if(C){if(C.o)for(c=(h=C._cachedOutline||(C._cachedOutline=C.o.split(" "))).length,d=r,u=r,a=0;a<c;)switch(h[a++]){case"m":p=h[a++]*d+n,f=h[a++]*u,s.moveTo(p,f);break;case"l":p=h[a++]*d+n,f=h[a++]*u,s.lineTo(p,f);break;case"q":if(g=h[a++]*d+n,m=h[a++]*u,y=h[a++]*d+n,S=h[a++]*u,s.quadraticCurveTo(y,S,g,m),w=P[P.length-1])for(v=w.x,_=w.y,o=1,l=this.divisions;o<=l;o++){var M=o/l;i.Shape.Utils.b2(M,v,y,g),i.Shape.Utils.b2(M,_,S,m)}break;case"b":if(g=h[a++]*d+n,m=h[a++]*u,y=h[a++]*d+n,S=h[a++]*-u,b=h[a++]*d+n,x=h[a++]*-u,s.bezierCurveTo(g,m,y,S,b,x),w=P[P.length-1])for(v=w.x,_=w.y,o=1,l=this.divisions;o<=l;o++)M=o/l,i.Shape.Utils.b3(M,v,y,b,g),i.Shape.Utils.b3(M,_,S,x,m)}return{offset:C.ha*r,path:s}}}},i.FontUtils.generateShapes=function(e,t){var r=void 0!==(t=t||{}).size?t.size:100,n=void 0!==t.curveSegments?t.curveSegments:4,s=void 0!==t.font?t.font:"helvetiker",a=void 0!==t.weight?t.weight:"normal",o=void 0!==t.style?t.style:"normal";i.FontUtils.size=r,i.FontUtils.divisions=n,i.FontUtils.face=s,i.FontUtils.weight=a,i.FontUtils.style=o;for(var l=i.FontUtils.drawText(e).paths,h=[],c=0,d=l.length;c<d;c++)Array.prototype.push.apply(h,l[c].toShapes());return h},r=i.FontUtils,n=function(e){for(var t=e.length,i=0,r=t-1,n=0;n<t;r=n++)i+=e[r].x*e[n].y-e[n].x*e[r].y;return.5*i},s=function(e,t,i,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_,y,S;if(o=e[s[t]].x,l=e[s[t]].y,h=e[s[i]].x,c=e[s[i]].y,d=e[s[r]].x,1e-10>(h-o)*((u=e[s[r]].y)-l)-(c-l)*(d-o))return!1;for(g=d-h,m=u-c,v=o-d,_=l-u,y=h-o,S=c-l,a=0;a<n;a++)if(a!==t&&a!==i&&a!==r&&(p=e[s[a]].x,g*((f=e[s[a]].y)-c)-m*(p-h)>=0&&v*(f-u)-_*(p-d)>=0&&y*(f-l)-S*(p-o)>=0))return!1;return!0},r.Triangulate=function(e,t){var i=e.length;if(i<3)return null;var r,a,o,l=[],h=[],c=[];if(n(e)>0)for(a=0;a<i;a++)h[a]=a;else for(a=0;a<i;a++)h[a]=i-1-a;var d=i,u=2*d;for(a=d-1;d>2;){if(u--<=0)return console.log("Warning, unable to triangulate polygon!"),t?c:l;if(d<=(r=a)&&(r=0),d<=(a=r+1)&&(a=0),d<=(o=a+1)&&(o=0),s(e,r,a,o,d,h)){var p,f,g,m,v;for(p=h[r],f=h[a],g=h[o],l.push([e[p],e[f],e[g]]),c.push([h[r],h[a],h[o]]),m=a,v=a+1;v<d;m++,v++)h[m]=h[v];u=2*--d}}return t?c:l},r.Triangulate.area=n,i.Shape=function(){t.Path.apply(this,arguments),this.holes=[]},i.Shape.prototype=Object.create(t.Path.prototype),i.Shape.prototype.extrude=function(t){return new e.ExtrudeGeometry(this,t)},i.Shape.prototype.makeGeometry=function(t){return new e.ShapeGeometry(this,t)},i.Shape.prototype.getPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedPoints(e,this.bends);return r},i.Shape.prototype.getSpacedPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return r},i.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},i.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},i.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},i.Shape.Utils={removeHoles:function(t,i){var r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y=t.concat(),S=y.concat(),b=[];for(o=0;o<i.length;o++){for(h=i[o],Array.prototype.push.apply(S,h),c=Number.POSITIVE_INFINITY,l=0;l<h.length;l++){p=h[l];var x=[];for(u=0;u<y.length;u++)f=y[u],d=p.distanceToSquared(f),x.push(d),d<c&&(c=d,s=l,a=u)}r=a-1>=0?a-1:y.length-1,n=s-1>=0?s-1:h.length-1;var w=[h[s],y[a],y[r]],P=e.FontUtils.Triangulate.area(w),C=[h[s],h[n],y[a]],M=e.FontUtils.Triangulate.area(C),E=a,T=s;s+=-1,(a+=1)<0&&(a+=y.length),a%=y.length,s<0&&(s+=h.length),s%=h.length,r=a-1>=0?a-1:y.length-1,n=s-1>=0?s-1:h.length-1,w=[h[s],y[a],y[r]];var A=e.FontUtils.Triangulate.area(w);C=[h[s],h[n],y[a]],P+M>A+e.FontUtils.Triangulate.area(C)&&(s=T,(a=E)<0&&(a+=y.length),a%=y.length,s<0&&(s+=h.length),s%=h.length,r=a-1>=0?a-1:y.length-1,n=s-1>=0?s-1:h.length-1),g=y.slice(0,a),m=y.slice(a),v=h.slice(s),_=h.slice(0,s);var D=[h[s],y[a],y[r]],I=[h[s],h[n],y[a]];b.push(D),b.push(I),y=g.concat(v).concat(_).concat(m)}return{shape:y,isolatedPts:b,allpoints:S}},triangulateShape:function(t,r){var n,s,a,o,l,h,c=i.Shape.Utils.removeHoles(t,r),d=c.shape,u=c.allpoints,p=c.isolatedPts,f=e.FontUtils.Triangulate(d,!1),g={};for(n=0,s=u.length;n<s;n++)void 0!==g[l=u[n].x+":"+u[n].y]&&console.log("Duplicate point",l),g[l]=n;for(n=0,s=f.length;n<s;n++)for(o=f[n],a=0;a<3;a++)void 0!==(h=g[l=o[a].x+":"+o[a].y])&&(o[a]=h);for(n=0,s=p.length;n<s;n++)for(o=p[n],a=0;a<3;a++)void 0!==(h=g[l=o[a].x+":"+o[a].y])&&(o[a]=h);return f.concat(p)},isClockWise:function(t){return e.FontUtils.Triangulate.area(t)<0},b2p0:function(e,t){var i=1-e;return i*i*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,i,r){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,r)},b3p0:function(e,t){var i=1-e;return i*i*i*t},b3p1:function(e,t){var i=1-e;return 3*i*i*e*t},b3p2:function(e,t){return 3*(1-e)*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,i,r,n){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,r)+this.b3p3(e,n)}},i})),define("DS/Visualization/AnnotationServices",["UWA/Class","DS/Visualization/Utils","DS/Formats/CGRFile","DS/Visualization/ModelLoader","DS/Visualization/ProxyAbstraction","DS/ZipJS2/LoaderInflate"],(function(e,t,i,r,n,s){"use strict";var a=null,o=e.extend({init:function(){return null!==a?(this.loader=a.loader,this.modelLoader=a.modelLoader,this):(this.loader=new i,this.modelLoader=new r,a=this,this)},cleanAll:function(){this.loader=null,this.modelLoader=null},getApplicativeContainerNew:function(e,i,r,s){var a=this.modelLoader.buildPath(e),o=new n;t.setProxyFromSpec(a,o);var l=a.serverurl?a.serverurl:"";l+=a.filename?a.filename:"";var h,c=this,d=(h=i,function(e){c.loader.setFileBuffer(new Uint8Array(e));var t=c.loader.getApplicativeContainer(h);r(t)});o.executeGetHttpRequest(l,"arraybuffer",null,d,s)},processFTABuffer:function(e){if(!e)return null;var t=e.buffer.subarray(e.options.offset,e.options.compressed+e.options.offset);if(t.length<=2)return null;if(120!==t[0])return null;if(218!==t[1])return null;var i=t.subarray(2,e.options.compressed);return function(e){var t,i,r,n,s,a;for(t="",r=e.length,i=0;i<r;)switch((n=e[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:s=e[i++],t+=String.fromCharCode((31&n)<<6|63&s);break;case 14:s=e[i++],a=e[i++],t+=String.fromCharCode((15&n)<<12|(63&s)<<6|(63&a)<<0)}return t}((new s).Inflate(i))},getFTAContainer:function(e,t,i,r){var n=this;this.getApplicativeContainerNew(e,t,(function(e){var t=n.processFTABuffer(e);t?i({xml:t}):i()}),r)},openSceneGraph:function(e){return this.loader.openSceneGraph(e)}});return UWA.namespace("THREEDS/AnnotationServices",o)})),define("Visualization/AnnotationServices",["DS/Visualization/AnnotationServices","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/AnnotationServices"),e})),define("DS/Visualization/CullingSystem",["DS/Visualization/WebGLObjectManager","DS/Object3D/Camera"],(function(e,t){"use strict";var i=0,r={_INVISIBLE:0,_VISIBLE:1,_FRESH:2},n={_GSSO:0,_REMOVE_AND_GSSO:1,_REMOVE:2,_NOTHING:3,_SKIP:4,_MAYBE_REMOVE_AND_GSSO:5,_REMOVE_AND_GSSO_AND_RESTORE_ACTION:6,_REMOVE_AND_RESTORE_ACTION:7},s=function(e){this.webglObject=e,this.rebuildDisplayLists=!0,this.previousCullingStatus=r._FRESH,this.action=n._NOTHING,this.previousRenderPointsOnly=!1,this.currentRenderPointsOnly=!1,this.object=e.object},a=function(){this.map=new Map};a.prototype.get=function(e,t){var i=null,r=this.map.get(e.id);return r||(r=new Map,this.map.set(e.id,r)),(i=r.get(t))||(i=new l(e),r.set(t,i),e._cullingSystems.push(i)),i},a.prototype.resetCullingStatuses=function(e){this.map.forEach((function(t,i){t.forEach((function(t,i){t._resetCullingStatuses(e)}))}))},a.prototype.dispose=function(){this.map.clear()};var o=new a,l=function(e){this.id=i++,this.scene=e,this.objectManagers={},this.lastComposerContextsSeen=new Set,this.currComposerContextsSeen=new Set};return l.prototype.isSet=function(e){return!!this.objectManagers[e]},l.prototype.setFromIdString=function(t){this.objectManagers[t]={list:new e,frame:-1};var i=this.objectManagers[t].list,r=this.scene.getWebGLObjectsLinkedList(t);if(r)for(var n=r.first;n>-1;n=r.nexts[n])i.add(new s(r.objects[n]))},l.prototype.getWebGLObjectsLinkedList=function(e){return this.scene.getWebGLObjectsLinkedList(e),this.scene.getWebGLObjectsLinkedList(null),this.objectManagers&&this.objectManagers[e]&&this.objectManagers[e].list?this.objectManagers[e].list.getLinkedList():null},l.prototype.getWebGLObjects=function(e){return this.scene.getWebGLObjectsLinkedList(e),this.scene.getWebGLObjectsLinkedList(null),this.objectManagers&&this.objectManagers[e]&&this.objectManagers[e].list?this.objectManagers[e].list.getObjects():[]},l.prototype._resetCullingStatuses=function(){for(var e in this.objectManagers)this.objectManagers[e].frame=-1;if(this.currComposerContextsSeen.size>0){var t=this;this.lastComposerContextsSeen.clear(),this.currComposerContextsSeen.forEach((function(e){t.lastComposerContextsSeen.add(e)})),this.currComposerContextsSeen.clear()}},{WebGLObjectCullingStatus:s,__CullingSystemFactory:o,VISIBILITY_STATUS:r,INCREMENTAL_ACTIONS:n}})),define("DS/Visualization/RendererGlobals",["DS/Mesh/ThreeJS_Base","DS/RenderEngineUtils/RenderEngineUtils","DS/GPUFormats/GPUFormats","DS/Visualization/ImplicitGeometries","DS/Visualization/ExplicitGeometries","DS/Object3D/Object","DS/Object3D/Light","DS/Object3D/Camera","DS/Object3D/Mesh","DS/Object3D/Scene","DS/Visualization/WebGLObjectManager","DS/ShaderBuilders/Commons/DefaultShaders","DS/Visualization/ShaderChunk","DS/ShaderBuilders/Commons/DeferrableShaders","DS/Visualization/UniformsUtils","DS/Visualization/UniformsLib","DS/Visualization/ImageUtils","DS/Visualization/Shapes","DS/Visualization/Curves","DS/Visualization/HighlightData","DS/Visualization/SubsurfaceGenerator"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S){"use strict";String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};var b=new e.Color;Object.assign(e,i);var x={FrontSide:0,BackSide:1,DoubleSide:2};x.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,x.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,x.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,x.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,x.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,x.AllPointsRenderPointMask=x.BoundaryPointRenderPointMask|x.SharpPointRenderPointMask|x.SmoothPointRenderPointMask|x.SurfacicPointRenderPointMask|x.FreePointRenderPointMask,x.AllPointsButSurfacicPointsRenderPointMask=x.BoundaryPointRenderPointMask|x.SharpPointRenderPointMask|x.SmoothPointRenderPointMask|x.FreePointRenderPointMask,e.Constants=x,e.FrontSide=x.FrontSide,e.BackSide=x.BackSide,e.DoubleSide=x.DoubleSide,e.NoOccurrences="true"===localStorage.getItem("WebVisuPrivate_NoOccurrences"),e.disableJHGDev=!0,e.WebGLVersion=1,e.BlockPoints={FRAME:0,OBJECT:1},e._setForceDevicePixelRatio=function(e){this._forceDevicePixelRatio=e},e._forceDevicePixelRatio=-1,e.getDevicePixelRatio=function(){return-1!==this._forceDevicePixelRatio?this._forceDevicePixelRatio:window.devicePixelRatio},e.getColorHex=function(e){return b.set(e),b.getHex()},e._createDummyTexture=function(t){for(var i=new Uint8Array(16),r=0;r<4;r++)i[4*r]=t[0],i[4*r+1]=t[1],i[4*r+2]=t[2],i[4*r+3]=t[3];var n=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);return n.generateMipmaps=!1,n.needsUpdate=!0,n};class w{constructor(){this.viewers=[],this.manager=null}addViewer(e){this.viewers.indexOf(e)<0&&this.viewers.push(e)}dispose(e){var t=this.viewers.indexOf(e);t>-1&&this.viewers.splice(t,1)}}e._AmbianceGenerators=new class extends w{constructor(){super(),this.loading=!1,this._available=!1,this.cb=null,this.errorCount=0,this._onViewerAvailableCBs=[],this._dummyRoughnessTextureRGBE=e._createDummyTexture([81,81,81,128]),this._dummyRoughnessTextureLogLUV=e._createDummyTexture([61,200,0,124]),this._dummyRoughnessTextureRGBM=e._createDummyTexture([81,81,81,128]),this._dummyRoughnessTextureRGBE.hasDiffuse=!0,this._dummyRoughnessTextureLogLUV.hasDiffuse=!0,this._dummyRoughnessTextureRGBM.hasDiffuse=!0}init(e){if(!this.loading&&!this.manager&&null===this.manager){this.loading=!0;var t=this;require(["DS/Visualization/AmbianceGenerator"],(function(i){t.loading=!1,t.manager=new i(t.cb),t._available=t.available(e);for(var r=0;r<t.viewers.length;r++)t.viewers[r].forceRender=!0}))}}_needsUpdate(){return!!this._available&&this.manager._needsUpdate()}addViewer(e){if(super.addViewer(e),this.viewers.length&&this._onViewerAvailableCBs.length){for(let e=0;e<this._onViewerAvailableCBs.length;e++)this._onViewerAvailableCBs[e](this.viewers[0]);this._onViewerAvailableCBs=[]}}onViewerAvailable(e){this.viewers.length?e(this.viewers[0]):this._onViewerAvailableCBs.push(e)}available(t){var i=!!e.supportedExtensions.textureHalfFloat&&!!e.supportedExtensions.renderToHalfFloatTexture&&!!e.supportedExtensions.textureHalfFloatLinear||!!e.supportedExtensions.textureFloat&&!!e.supportedExtensions.renderToFloatTexture&&!!e.supportedExtensions.textureFloatLinear;return i||(0===t&&this.errorCount<10?console.warn("Warning: device does not support automatic mip map generation for hdrs, please set one yourself"):1===t&&this.errorCount<11&&console.warn("Warning: device does not support fabrics under ibl"),this.errorCount++),i}getAmbiance(t,i,r,n){if(!this._available){const t=r.hdr;let i=this._dummyRoughnessTextureRGBE;return t.encoding===e.LogLUV_Encoding?i=this._dummyRoughnessTextureLogLUV:t.encoding===e.RGBM_Encoding&&(i=this._dummyRoughnessTextureLogRGBM),i}return this.manager.getAmbiance(t,i,r,n).ambiance}update(e,t){return!!this._needsUpdate()&&this.manager.update(e,t)}decreaseUseCount(e){this._available&&this.manager.decreaseUseCount(e)}_decreaseSceneUseCount(e){this.decreaseUseCount(e.envMipMapID),e.envMipMapID=null,this.decreaseUseCount(e.envMipMapSheenID),e.envMipMapSheenID=null}keep(e){return this._available?this.manager.keep(e):null}setCallBack(e){this.cb=e,this._available&&this.manager._setCB(e)}dispose(e){super.dispose(e),0===this.viewers.length&&(this.manager&&(this.manager.dispose(),this.manager=null),this._available=!1,this._dummyRoughnessTextureRGBE&&this._dummyRoughnessTextureRGBE.dispose(),this._dummyRoughnessTextureLogLUV&&this._dummyRoughnessTextureLogLUV.dispose(),this._dummyRoughnessTextureRGBM&&this._dummyRoughnessTextureRGBM.dispose())}};e._SSSGenerator=new class extends w{constructor(){super()}init(){null===this.manager&&(this.manager=new S)}getTextures(e){return this.manager?this.manager.compute(e):null}decreaseUseCount(e){this.manager&&this.manager.decreaseUseCount(e)}dispose(e){super.dispose(e),0===this.viewers.length&&this.manager&&(this.manager.dispose(),this.manager=null)}},e.__renderTargetID=0,e.FrontFaceDirectionCW=0,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=1,e.PCFSoftShadowMap=2,e.PCFInterpolShadowMap=3,e.PCFPoissonShadowMap=4,e.PCFOptimizedShadowMap=5,e.ESMShadowMap=6,e.ESMImprovedShadowMap=7,e.LowQuality=0,e.MediumQuality=1,e.HighQuality=2,e.NoShading=0,e.FlatShading=1,e.SmoothShading=2,e.FrontToBack=0,e.BackToFront=1,e.DrawCallSorting={FrontToBackSort:e.FrontToBack,BackToFrontSort:e.BackToFront,RenderDepthSort:2,NeverSort:3,DecalSort:4,GLTypeSort:5},e.VertexColorType={NoColors:0,Face:1,RGBA:2,RGB:3,A:4,R:8,G:16,B:32},e.NoColors=e.VertexColorType.NoColors,e.FaceColors=e.VertexColorType.Face,e.VertexColors=e.VertexColorType.RGBA,e.VertexColorsRGBA=e.VertexColorType.RGBA,e.VertexColorsRGB=e.VertexColorType.RGB,e.VertexColorsA=e.VertexColorType.A;{let t=["NoBlending","NormalBlending","AdditiveBlending","SubtractiveBlending","MultiplyBlending","CustomBlending","NormalDepthBlending","AlphaBlending","GroundShadowBlending","TransparentShadowBlending","OITAccumBlending","OITRevealBlending","PreMultipliedBlending"];e.Blendings={};for(let i=0;i<t.length;i++)e.Blendings[t[i]]=i,e[t[i]]=i}e.AddEquation=100,e.SubtractEquation=101,e.ReverseSubtractEquation=102,e.MinEquation=103,e.MaxEquation=104,e.ZeroFactor=200,e.OneFactor=201,e.SrcColorFactor=202,e.OneMinusSrcColorFactor=203,e.SrcAlphaFactor=204,e.OneMinusSrcAlphaFactor=205,e.DstAlphaFactor=206,e.OneMinusDstAlphaFactor=207,e.DstColorFactor=208,e.OneMinusDstColorFactor=209,e.SrcAlphaSaturateFactor=210,e.MultiplyOperation=0,e.MixOperation=1,e.AddOperation=2,e.SmoothEdgeRenderLineModeMask=e.GeomTypeEnum.SMOOTH_EDGE,e.SharpEdgeRenderLineModeMask=e.GeomTypeEnum.SHARP_EDGE,e.WireEdgeRenderLineModeMask=e.GeomTypeEnum.WIRE_EDGE,e.BoundaryEdgeRenderLineModeMask=e.GeomTypeEnum.BOUNDARY_EDGE,e.HideAllRenderLineMode=0,e.OutlineMask=e.GeomTypeEnum._OUTLINE,e.SectionLineMask=e.GeomTypeEnum._SECTION_LINE,e.HideWireEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideSmoothEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideInternalEdgesRenderLineMode=e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowAllRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowOutlinesAndEdgesRenderLineMode=e.OutlineMask|e.ShowAllRenderLineMode,e.ShowOutlinesHideEdgesRenderLineMode=e.OutlineMask|e.HideAllRenderLineMode,e.BodyLinesMask=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.NoNoZPriorityMask=e.GeomTypeEnum.EDGE|e.GeomTypeEnum.SHARP_EDGE|e.GeomTypeEnum.BOUNDARY_EDGE|e.GeomTypeEnum.SMOOTH_EDGE|e.GeomTypeEnum.HIDDEN_SEAM_EDGE,e.HideAllModelFaces=0,e.ShowAllFaces=e.GeomTypeEnum.FACE|e.GeomTypeEnum.INFINITE_FACE|e.GeomTypeEnum.AXIS_SYSTEM,e.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,e.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,e.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,e.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,e.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,e.AllPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask|e.FreePointRenderPointMask,e.AllPointsButSurfacicPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.FreePointRenderPointMask,e.BodyPointsMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask,e.__QA_AUTOMATION_MASK__=e.GeomTypeEnum.FACE|e.GeomTypeEnum.UNKNOWN_0D|e.GeomTypeEnum.UNKNOWN_1D|e.GeomTypeEnum.UNKNOWN_2D|e.GeomTypeEnum.UNKNOWN,e.NoDecalMask=e.GeomTypeEnum.INFINITE_FACE|e.GeomTypeEnum.AXIS_SYSTEM|e.GeomTypeEnum.FREE_POINT|e.GeomTypeEnum.UNKNOWN_0D|e.GeomTypeEnum.UNKNOWN_1D|e.GeomTypeEnum.WIRE_EDGE,e.UnknownMask=e.GeomTypeEnum.UNKNOWN|e.GeomTypeEnum.UNKNOWN_1D|e.GeomTypeEnum.UNKNOWN_2D|e.GeomTypeEnum.UNKNOWN_0D,e.loadingModels=!1;{let t=["NO_TRANSPARENT","NO_INVISIBLE_PLANE","NO_UNKNOWN","ONLY_LIGHTED","NO_EDGES_IF_HAS_FACES","DISABLE_KEEP_OCCLUSION_OPACITY_OVERRIDES","NO_MIRRORDISABLED"];if(t.length>e._MaxBitMask)throw"too many forbid renderable states";let i=new Object;for(var P=0;P<t.length;P++)i[t[P]]=1<<P;e._ForbidRenderableStates=i}{let t=["NO_IGNORE","IGNORE_OVERRIDEN","IGNORE_ALL"];if(t.length>e._MaxBitMask)throw"too many decal rendering modes";let i=new Object;for(P=0;P<t.length;P++)i[t[P]]=1<<P;e.DecalRenderingMode=i}e._SaveGeneratedRoughnessMaps=!1,e._SaveGeneratedRoughnessMapsAsPNG=!1,e._DownloadGeneratedRoughnessMaps=!0,e.glStates={currentFramebuffer:void 0,currentWidth:0,currentHeight:0,currentXOffset:0,currentYOffset:0},e.DefaultAppearanceMode={BASIC:0,_GASLOOK_OLD:.5,GASLOOK:1,_TRANSPARENT:2,CLAY:3,WHITE_MAT_PLASTER:4,GREY_SHINY_PLASTIC:5,CAST_ALUMINUM:6,MACHINED_ALUMINUM:7,CAST_STEEL:8,BRUSHED_STEEL:9,MACHINED_STAINLESS_STEEL:10,COPPER:11,BRASS:12,GENERIC_PLASTIC:13,GENERIC_METAL:14,__QA_AUTOMATION__:15},e._DebugMaterialMode={NO_DEBUG:0,NORMAL:1,DEPTH:2,SHADOW:3,GEOM_UV:4,MAPPING_UV:5,GEOM_UV2:6,MAPPING_UV2:7,COLOR:8,AO:9,OCT22_NORMAL:10,FLOAT16_DEPTH:11,GEOM_UV3:12,MAPPING_UV3:13};{const t=[{name:"originalMaterial",priority:!1},{name:"normalMaterial",priority:!0},{name:"depthMaterial",priority:!0},{name:"normalDepthIoRRoughnessMaterial",priority:!0},{name:"shadowMapDepthMaterial",priority:!0},{name:"highlightMaterial",priority:!0},{name:"pickingMaterial",priority:!0},{name:"pickingMaterialInstancing",priority:!0},{name:"oitAccumMaterial",priority:!1},{name:"oitRevealMaterial",priority:!1},{name:"oitLinkedListMaterial",priority:!1},{name:"depthRGBAMaterial",priority:!0},{name:"normalDepthMaterial",priority:!0},{name:"decalNormalStencilDepthMaterial",priority:!0},{name:"transparentShadowMaterial",priority:!0},{name:"texCoordMaterial",priority:!0},{name:"_fakeOriginalMaterial",priority:!1},{name:"gpuPositionMaterial",priority:!0}];if(e.MaterialToUse={},e.MaterialHasPriority=[],e.MaterialToUse._materialToUseShift=64,t.length>e.MaterialToUse._materialToUseShift-1)throw"Too many materials to use";e.MaterialToUse.totalMaterial=t.length;for(P=0;P<t.length;P++){var C=t[P];e.MaterialToUse[C.name]=P,e.MaterialHasPriority.push(C.priority)}}const M=e.MaterialToUse;M.pickingPassMaterial=function(e){return e===M.pickingMaterial||e===M.pickingMaterialInstancing||e===M.normalMaterial||e===M.depthMaterial||e===M.gpuPositionMaterial},M.mainMaterial=function(e){return e===M.originalMaterial||e===M.oitAccumMaterial||e===M.oitRevealMaterial||e===M.oitLinkedListMaterial},e._isSelectionMaterial=function(e){switch(e){case M.normalMaterial:case M.depthMaterial:case M.highlightMaterial:case M.pickingMaterial:case M.pickingMaterialInstancing:return!0;default:return!1}},e.HaloHighlightData=y.HaloHighlightData,e.AdvancedPoliteHighlightData=y.AdvancedPoliteHighlightData,e.DefaultHighlightData=y.DefaultHighlightData,e.DefaultPreHighlightData=y.DefaultPreHighlightData,e.OITMode={None:0,WeightedAverage:1,PerPixelLinkedList:2};var E,T,A=e.GeomTypeEnum,D={};!function(){var e,t,i=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM","_OUTLINE"],r={EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,HIDDEN_SEAM_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,HIDDEN_SEAM_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:2,FACE:2,UNKNOWN:2,AXIS_SYSTEM:2,_OUTLINE:1};for(e=0;e<i.length;e++)D[A[t=i[e]]]=r[t];D[A.SMOOTH_EDGE|A._HIGH_CURVATURE_EDGE]=r.SMOOTH_EDGE}(),e.dimensionMapping=D,e.Line3=r.Line3,e.Box2=r.Box2,e.Box3=r.Box3,e.mergeBoundingBoxInto=r.mergeBoundingBoxInto,e.DGBoundingBoxArray=r.DGBoundingBoxArray,e.Sphere=r.Sphere,e.mergeBoundingSphereInto=r.mergeBoundingSphereInto,e.BoundingSphere=r.BoundingSphere,e.Frustum=r.Frustum,e.FrustumWithClippingPlanes=r.FrustumWithClippingPlanes,e.Plane=r.Plane,e.Math={clamp:function(e,t,i){return e<t?t:e>i?i:e},clampBottom:function(e,t){return e<t?t:e},mapLinear:function(e,t,i,r,n){return r+(e-t)*(n-r)/(i-t)},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return e<0?-1:e>0?1:0},degToRad:(T=Math.PI/180,function(e){return e*T}),radToDeg:(E=180/Math.PI,function(e){return e*E})},e.Spline=r.Spline,e.Triangle=r.Triangle,e.Vertex=function(e){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),e},e.UV=function(t,i){return console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead."),new e.Vector2(t,i)},e.Clock=function(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},e.extend(e.Clock.prototype,{start:function(){this.startTime=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),this.oldTime=this.startTime,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}}),e.Object3D=s,e.Projector=function(){var t=new e.Matrix4;this.projectVector=function(e,i){return i.matrixWorldInverse.getInverse(i.matrixWorld),t.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),e.applyProjection(t)},this.unprojectVector=function(e,i){return i.projectionMatrixInverse.getInverse(i.projectionMatrix),t.multiplyMatrices(i.matrixWorld,i.projectionMatrixInverse),e.applyProjection(t)},this.pickingRay=function(t,i){t.z=i.getProjectedDepthNear?i.getProjectedDepthNear():-1;var r=new e.Vector3(t.x,t.y,1);return this.unprojectVector(t,i),this.unprojectVector(r,i),r.sub(t).normalize(),new e.Raycaster(t,r)}},e.Face3=r.Face3,e.Face4=r.Face4,e.Geometry=n.LegacyGeometry,e.GeometryIdCount=0,e._CameraRoles=o._CameraRoles,e._FrameTypes=o._FrameTypes,e.Camera=o.BaseCamera,e.OrthographicCamera=o.OrthographicCamera,e.PerspectiveCamera=o.PerspectiveCamera,e.Light=a.BaseLight,e.AmbientLight=a.AmbientLight,e.AreaLightUnits=a.AreaLightUnits,e.SphereLight=a.SphereLight,e.DiskLight=a.DiskLight,e.TubeLight=a.TubeLight,e.RectangleLight=a.RectangleLight,e.DirectionalLight=a.DirectionalLight,e.DirectionalIBLLight=a.DirectionalIBLLight,e.DirectionalPhongLight=a.DirectionalPhongLight,e.PointLight=a.PointLight,e.SpotLight=a.SpotLight,e.IESLight=a.IESLight,e.ImageLoader=function(){e.EventDispatcher.call(this),this.crossOrigin=null},e.ImageLoader.prototype={constructor:e.ImageLoader,load:function(e,t){var i=this;void 0===t&&(t=new Image),t.addEventListener("load",(function(){i.dispatchEvent({type:"load",content:t})}),!1),t.addEventListener("error",(function(){i.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})}),!1),i.crossOrigin&&(t.crossOrigin=i.crossOrigin),t.src=e}},e.MeshFaceMaterial=function(e){this.materials=e instanceof Array?e:[]},e.MeshFaceMaterial.prototype.clone=function(){return new e.MeshFaceMaterial(this.materials.slice(0))};e.Particle=class extends s{constructor(e){super(),this.material=e}clone(t){return void 0===t&&(t=new e.Particle(this.material)),super.clone(t),t}},e.ParticleSystem=n.ParticleSystem,e.Line=n.Line,e.LineStrip=0,e.LinePieces=1,e.Mesh=l;e.CSS3DNode=class extends s{constructor(t){super(),this.element=t||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.geometry=new e.Geometry,this.geometry.boundingSphere=new e.Sphere}};e.Bone=class extends s{constructor(t){e.Object3D.call(this)}},e.SkinnedMesh=n.SkinnedMesh,e.Sprite=function(t){e.Object3D.call(this)},e.Sprite.prototype=Object.create(e.Object3D.prototype),e.WebGLObjectManager=c,e.Scene=h,e.StateSortingResult=t.StateSortingResult;return e.VertexStage=0,e.FragmentStage=1,e.VaryingInterpolationTypes={PERSPECTIVE:0,NO_PERSPECTIVE:1,FLAT:2},e.PDSFXPolygonOffsetParams={Backward2:[4,4],Backward1:[2,2.3],Backward0:[1,1],Neutral:[0,0],Frontward0:[-.9,-1],Frontward1:[-2,-2]},e._DefaultShaderChunk=d,e._ShaderChunk=u,e._DeferredShaderChunk=p,e.UniformsUtils=f,e.UniformsLib=g,e.ShaderLib={},e.lastContextId=-1,e.RendererMode={static:0,dynamic:1,override:2,_count:3},e.GeometryUtils={center:function(t){t.computeBoundingBox();var i=t.boundingBox,r=new e.Vector3;return r.addVectors(i.min,i.max),r.multiplyScalar(-.5),t.applyMatrix((new e.Matrix4).makeTranslation(r.x,r.y,r.z)),t.computeBoundingBox(),r}},e.ImageUtils=m.Utils,e.FontUtils=v.FontUtils,e.LineCurve=_.LineCurve,e.QuadraticBezierCurve=_.QuadraticBezierCurve,e.CubicBezierCurve=_.CubicBezierCurve,e.SplineCurve=_.SplineCurve,e.EllipseCurve=_.EllipseCurve,e.LineCurve3=_.LineCurve3,e.QuadraticBezierCurve3=_.QuadraticBezierCurve3,e.CubicBezierCurve3=_.CubicBezierCurve3,e.SplineCurve3=_.SplineCurve3,e.ClosedSplineCurve3=_.ClosedSplineCurve3,e.CurvePath=_.CurvePath,e.Path=_.Path,e.PathActions=_.PathActions,e.Shape=v.Shape,e.CubeGeometry=n.CubeGeometry,e.CircleGeometry=n.CircleGeometry,e.CylinderGeometry=n.CylinderGeometry,e.ExtrudeGeometry=n.ExtrudeGeometry,e.ShapeGeometry=n.ShapeGeometry,e.PlaneGeometry=n.PlaneGeometry,e.SphereGeometry=n.SphereGeometry,e.TextGeometry=n.TextGeometry,e.CameraHelper=class extends e.Line{constructor(t){super(),this._tokens={},this.geometry=new e.Geometry,this.material=new e.LineBasicMaterial({color:16777215,vertexColors:e.VertexColorType.Face}),this.type=e.LinePieces,this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,this.frustumCulled=!1,this.pointMap={};var i=16755200,r=16711680,n=43775,s=3355443;this.addLine("n1","n2",i),this.addLine("n2","n4",i),this.addLine("n4","n3",i),this.addLine("n3","n1",i),this.addLine("f1","f2",i),this.addLine("f2","f4",i),this.addLine("f4","f3",i),this.addLine("f3","f1",i),this.addLine("n1","f1",i),this.addLine("n2","f2",i),this.addLine("n3","f3",i),this.addLine("n4","f4",i),this.addLine("p","n1",r),this.addLine("p","n2",r),this.addLine("p","n3",r),this.addLine("p","n4",r),this.addLine("u1","u2",n),this.addLine("u2","u3",n),this.addLine("u3","u1",n),this.addLine("c","t",16777215),this.addLine("p","c",s),this.addLine("cn1","cn2",s),this.addLine("cn3","cn4",s),this.addLine("cf1","cf2",s),this.addLine("cf3","cf4",s),this.camera=t,this.update(t)}addLine(e,t,i){this.addPoint(e,i),this.addPoint(t,i)}addPoint(t,i){this.geometry.vertices.push(new e.Vector3),this.geometry.colors.push(new e.Color(i)),void 0===this.pointMap[t]&&(this.pointMap[t]=[]),this.pointMap[t].push(this.geometry.vertices.length-1)}update(){e.CameraHelper.prototype.__c.projectionMatrix.copy(this.camera.projectionMatrix),this.setPoint("c",0,0,-1),this.setPoint("t",0,0,1),this.setPoint("n1",-1,-1,-1),this.setPoint("n2",1,-1,-1),this.setPoint("n3",-1,1,-1),this.setPoint("n4",1,1,-1),this.setPoint("f1",-1,-1,1),this.setPoint("f2",1,-1,1),this.setPoint("f3",-1,1,1),this.setPoint("f4",1,1,1),this.setPoint("u1",.7,1.1,-1),this.setPoint("u2",-.7,1.1,-1),this.setPoint("u3",0,2,-1),this.setPoint("cf1",-1,0,1),this.setPoint("cf2",1,0,1),this.setPoint("cf3",0,-1,1),this.setPoint("cf4",0,1,1),this.setPoint("cn1",-1,0,-1),this.setPoint("cn2",1,0,-1),this.setPoint("cn3",0,-1,-1),this.setPoint("cn4",0,1,-1),this.geometry.verticesNeedUpdate=!0}setPoint(t,i,r,n){e.CameraHelper.prototype.__v.set(i,r,n),e.CameraHelper.prototype.__projector.unprojectVector(e.CameraHelper.prototype.__v,e.CameraHelper.prototype.__c);var s=this.pointMap[t];if(void 0!==s)for(var a=0,o=s.length;a<o;a++)this.geometry.vertices[s[a]].copy(e.CameraHelper.prototype.__v)}},e.CameraHelper.prototype.__projector=new e.Projector,e.CameraHelper.prototype.__v=new e.Vector3,e.CameraHelper.prototype.__c=new e.Camera,e})),define("DS/Visualization/GeometryProcessing",["DS/Mesh/ThreeJS_Base","DS/Visualization/ImplicitGeometries"],(function(e,t){"use strict";const i=new Uint32Array(2),r=new Float64Array(i.buffer);function n(e,t){return e>t?(i[0]=e,i[1]=t):(i[0]=t,i[1]=e),Number.isFinite(r[0])?r[0]:`${e}:${t}`}const s=(1+Math.sqrt(5))/2,a=2*Math.PI*s,o=Math.PI*Math.sqrt(5),l=1/Math.sqrt(5),h=1/Math.log(s+1),c={PLANE:3,AXIS:2,POINT:1,NONE:0,space_none:()=>({type:c.NONE}),space_point:e=>({type:c.POINT,point:e}),space_axis:e=>({type:c.AXIS,axis:e}),space_plane:e=>({type:c.PLANE,plane:e}),compute(i,r=null){if(r||(r=[0,i.vertexIndexArray.length]),2!==r.length||r[1]<=r[0])return this.space_none();const n=1e-6,s=i.vertexIndexArray;let a=r[0];const o=r[1];function l(e){return i.getVertexPosition(s[a],e),e}const h=new e.Vector3;l(h),a++;const c=new e.Vector3;for(;a<o&&l(c).distanceToSquared(h)<n;)a++;if(a>=o)return this.space_point(h);const d=new t.InfiniteLine3(h,(new e.Vector3).subVectors(c,h));a++;const u=new e.Vector3;for(;a<o&&d.distanceToSquared(l(c),u)<n;)a++;if(a>=o)return this.space_axis(d);const p=(new e.Vector3).crossVectors(d.axis,u.subVectors(c,h)).normalize(),f=new t.Plane(p,-p.dot(h));for(a++;a<o&&f.distanceToPointSquared(l(c))<n;)a++;return a>=o?this.space_plane(f):this.space_none()},combine(e,t,i=1e-9){if(!e||!t)return e||t;switch(e.type){case c.POINT:switch(t.type){case c.POINT:return this._combine_point_point(e.point,t.point,i);case c.AXIS:return this._combine_point_axis(e.point,t.axis,i);case c.PLANE:return this._combine_point_plane(e.point,t.plane,i)}case c.AXIS:switch(t.type){case c.POINT:return this._combine_point_axis(t.point,e.axis,i);case c.AXIS:return this._combine_axis_axis(e.axis,t.axis,i);case c.PLANE:return this._combine_axis_plane(e.axis,t.plane,i)}case c.PLANE:switch(t.type){case c.POINT:return this._combine_point_plane(t.point,e.plane,i);case c.AXIS:return this._combine_axis_plane(t.axis,e.plane,i);case c.PLANE:return this._combine_plane_plane(e.plane,t.plane,i)}}return this.space_none()},fit({plane:e,space:t,transform:i}){switch(t.type){case c.NONE:return!1;case c.POINT:return e.containsPoint(t.point.clone().applyMatrix4(i));case c.AXIS:return e.containsInfiniteLine(t.axis.clone().applyMatrix4(i));case c.PLANE:return e.containsPlane(t.plane.clone().applyMatrix4(i));default:return!1}},_combine_point_point(t,i,r){return t.distanceToSquared(i)<r?this.space_point(t):this.space_axis(t,(new e.Vector3).subVectors(i,t))},_combine_point_axis(i,r,n){const s=new e.Vector3;return r.distanceToSquared(i,s)<n?this.space_axis(r):(s.subVectors(i,r.origin).cross(r.axis).normalize(),this.space_plane(new t.Plane(s,-s.dot(i))))},_combine_point_plane(e,t,i){return t.containsPoint(e,i)?this.space_plane(t):this.space_none()},_combine_axis_axis(i,r,n){const s=new e.Vector3;return i.distanceToSquared(r.origin,s)<n&&Math.abs(i.axis.dot(r.axis))>1-n?this.space_axis(i):(s.crossVectors(i.axis,r.axis).normalize(),this.space_plane(new t.Plane(s,-s.dot(i.origin))))},_combine_axis_plane(e,t,i){return t.containsInfiniteLine(e,i)?this.space_plane(t):this.space_none()},_combine_plane_plane(e,t,i){return e.containsPlane(t,i)?this.space_plane(e):this.space_none()}};return{deduplicateVerticesExactMatch:function(e,t=3){const i=e.length/t,r=new Float32Array(t),n=new Uint16Array(r.buffer);let s=null;switch(t){case 2:s=function(t){const i=2*t;return r[0]=e[i],r[1]=e[i+1],String.fromCharCode(n[0],n[1],n[2],n[3])};break;case 3:s=function(t){const i=3*t;return r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],String.fromCharCode(n[0],n[1],n[2],n[3],n[4],n[5])};break;default:s=function(i){const s=i*t;for(let i=0;i<t;i++)r[i]=e[s+i];return String.fromCharCode(...n)}}const a=new Map,o=i>65535?new Uint32Array(i):new Uint16Array(i);for(let e=0;e<i;e++){const t=s(e);let i=a.get(t);void 0===i&&a.set(t,i=e),o[e]=i}return o},mergeIndexBuffers:function(e){let t=!1,i=0;for(let r=0;r<e.length;r++)e[r]instanceof Uint32Array&&(t=!0),i+=e[r].length;const r=t?new Uint32Array(i):new Uint16Array(i);let n=0;for(let t=0;t<e.length;t++)r.set(e[t],n),n+=e[t].length;return r},computeFaceNormals:function({geom:t,index_ranges:i,alloc_output:r=null}){const n=t.vertexPositionArray,s=t.vertexIndexArray,a=r?r(s.length):new Float32Array(s.length);function o(e,t){e*=3,t.x=n[e],t.y=n[e+1],t.z=n[e+2]}const l=new e.Vector3,h=new e.Vector3,c=new e.Vector3;for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3)o(s[e],l),o(s[e+1],h),o(s[e+2],c),c.sub(h),h.sub(l),h.cross(c),a[e]=h.x,a[e+1]=h.y,a[e+2]=h.z}return a},FitPlaneSpace:c,FibonacciSpiral:{get:function(t,i,r=null){const n=1-(2*t+1)/i,s=Math.sqrt(1-n*n),o=t*a,l=s*Math.cos(o),h=s*Math.sin(o);return r?r.set(l,h,n):r=new e.Vector3(l,h,n),r},inv:function(t,i){const r=1-1/i,n=Math.min(Math.atan2(t.y,t.x),Math.PI),a=t.z,c=e=>e-Math.floor(e),d=Math.max(2,Math.floor(Math.log(i*(1-a*a)*o)*h)),u=Math.pow(s,d)*l,p=Math.round(u),f=Math.round(u*s),g=2*p/i,m=2*f/i,v=2*Math.PI*(c((p+1)*s)-(s-1)),_=2*Math.PI*(c((f+1)*s)-(s-1)),y=1/(m*v-g*_),S=Math.floor(y*(m*n+_*(a-r))),b=Math.floor(y*(-g*n-v*(a-r)));let x=8,w=0,P=new e.Vector3;for(let e=0;e<4;e++){const r=Math.floor(e/2),n=e-2*r,s=Math.floor(p*(n+S)+f*(r+b));this.get(s,i,P);const a=t.distanceToSquared(P);a<x&&(x=a,w=s)}return w}},computeAdjacencyTriangleToTriangle:function({geom:e,index_ranges:t,deduplication:i=null,bijective:r=!0,result:s=null}){s||(s=new Uint32Array(e.vertexIndexArray.length));const a=new Map;function o(e,t,i,o){const l=n(e,t),h=a.get(l);if(void 0===h)a.set(l,4*i+o);else{s[(h>>>2)+h%4]=1+4*i+o,r&&(s[i+o]=1+h),a.delete(l)}}const l=e.vertexIndexArray,h=i?e=>i[l[e]]:e=>l[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=h(e+0),i=h(e+1),r=h(e+2);o(t,i,e,0),o(i,r,e,1),o(r,t,e,2)}}return{adjacency:s,boundary:a}},extractBoundaryEdges:function(e,t){let i=e.values(),r=i.next();const n=[];for(;!r.done;){const e=r.value>>>2,s=r.value%4;n.push(t[e+s]),n.push(t[e+(s+1)%3]),r=i.next()}return Uint32Array.from(n)},edgeKey:n}})),define("DS/Visualization/OutlineBuilder",["DS/Mesh/Mesh","DS/Visualization/GeometryProcessing","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,i){"use strict";var r;const n=i.BridgeFunctions,s=(e,t,r)=>i.FunctionHandler.callFunction(e,t,r),a="";class o{constructor(e){this.type=e,this.array=null}get(e=0){return(!this.array||this.array.length<e)&&(this.array=new this.type(this._alloc_size(e))),0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}realloc(e=0){if(!this.array)return this.get(e);if(0===e||this.array.length<e){const t=new this.type(this._alloc_size(e));t.set(this.array),this.array=t}return 0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}_alloc_size(e){return Math.max(this.array?2*this.array.length:10,e)}}function l(e){if(e.length<2)return e;e.sort(((e,t)=>e[0]-t[0]));let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}new o(Uint32Array),new o(Uint32Array);function h({geom:e,adjTri2Tri:t,index_ranges:i=null}){const r=e.vertexIndexArray,n=e.vertexPositionArray;function s(e){const t=3*r[e+0],i=3*r[e+1],s=3*r[e+2],a=n[t],o=n[t+1],l=n[t+2],h=n[i],c=n[i+1],d=n[i+2],u=n[s]-a,p=n[s+1]-o,f=n[s+2]-l,g=h-a,m=c-o,v=d-l;return[p*v-f*m,f*g-u*v,u*m-p*g]}let a=[];function o(e,i,r){const n=t[i+r];if(!n)return;(function(e,t){const i=e[1]*t[2]-e[2]*t[1],r=e[2]*t[0]-e[0]*t[2],n=e[0]*t[1]-e[1]*t[0];return 0===i&&0===r&&0===n})(e,s(n-1>>>2))||a.push(4*i+r)}for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3){const t=s(e);o(t,e,0),o(t,e,1),o(t,e,2)}}return new Uint32Array(a)}function c(e,t,i,r,n,s,a,o){for(let l=i;l<r;l+=3){const i=3*t[l],r=3*t[l+1],h=3*t[l+2],c=e[i],d=e[i+1],u=e[i+2],p=e[r],f=e[r+1],g=e[r+2],m=e[h]-c,v=e[h+1]-d,_=e[h+2]-u,y=p-c,S=f-d,b=g-u,x=n*(v*b-_*S)+s*(_*y-m*b)+a*(m*S-v*y);o[l+1]=x<0?-1:x>0?1:0}}const d=new o(Int8Array);new o(Uint32Array);const u=new o(Uint32Array);function p(e,i,r,n){const s=performance.now();let a=e.__deduplication;a||(a=e.__deduplication=t.deduplicateVerticesExactMatch(e.vertexPositionArray,e.compressedVertices?2:3));const o=performance.now();e.__segmentEdges||(e.__segmentEdges=new Map);let l=e.__segmentEdges.get(r);if(!l){const n=t.computeAdjacencyTriangleToTriangle({geom:e,index_ranges:i,deduplication:a,bijective:!1,result:e.__adjTri2Tri});l={boundary:t.extractBoundaryEdges(n.boundary,e.vertexIndexArray),inner:h({geom:e,adjTri2Tri:n.adjacency,index_ranges:i})},e.__adjTri2Tri=n.adjacency,e.__segmentEdges.set(r,l)}const p=e.__adjTri2Tri,f=performance.now(),g=function({geom:e,view_direction:t,index_ranges:i}){const r=e.vertexIndexArray,n=e.vertexPositionArray,s=d.get(e.vertexIndexArray.length);for(let e=0;e<i.length;e++)c(n,r,i[e][0],i[e][1],t.x,t.y,t.z,s);return s}({geom:e,view_direction:n,index_ranges:i}),m=performance.now(),v=function({indices:e,adjTri2Tri:t,grouped_edges:i,tri_visibility:r}){let n=u.get(),s=0;function a(t){s+1>=n.length&&(n=u.realloc());const i=t>>>2,r=t%4;n[s++]=e[i+r],n[s++]=e[i+(r+1)%3]}const o=i.boundary,l=o.length;if(l>0)for(let e=0;e<l;e++)s>=n.length&&(n=u.realloc()),n[s++]=o[e];const h=i.inner,c=h.length;for(let e=0;e<c;e++){const i=h[e],n=i>>>2,s=t[n+i%4],o=s-1>>>2;s&&r[n+1]*r[o+1]<=0&&a(i)}return n.slice(0,s)}({indices:e.vertexIndexArray,adjTri2Tri:p,grouped_edges:l,index_ranges:i,tri_visibility:g}),_=performance.now();return window.time_outlines.dedup+=o-s,window.time_outlines.adj+=f-o,window.time_outlines.visibility+=m-f,window.time_outlines.outlines+=_-m,v}function f(e,t,i=!1){let n=e.__outline_segments;return n||(n=e.__outline_segments=function(e,t,i=!1){let n=new Map;function s(e,t,i,r){const s=n.get(e),a=s.get(t);a?a.push([i,i+r]):s.set(t,[[i,i+r]])}function a(e){n.get(e)||n.set(e,new Map)}if(e.layer)for(let i=0;i<e.layer.layers.length;i++){const n=e.layer.layers[i].drawableGroup,o=e.layer.layers[i].drawableInterval;o.skip(e,t)||(a(n.geometry),n._geomType===r.GeomTypeEnum.FACE&&s(n.geometry,0,o.start,o.count))}else{const t=e.geometry.length;for(let i=0;i<t;i++){const t=e.geometry[i];a(t);for(let e=0;e<t.drawingGroups.length;e++){const i=t.drawingGroups[e];if(i._geomType!==r.GeomTypeEnum.FACE)continue;const n=i.getPrimitivesCount();for(let e=0;e<n;e++){const r=i.getPrimitiveRep(e);s(t,r?r.cgmId:0,i.getPrimitiveStart(e),i.getPrimitiveCount(e))}0===n&&s(t,0,i.start,i.count)}}}const o=[];return n.forEach(((e,t)=>{const r=[];e.forEach(((e,t)=>r.push({ranges:l(e),id:t}))),(i||r.length>0)&&o.push({geom:t,components:r})})),o.sort(((e,t)=>e.geom.id-t.geom.id)),o}(e,t,i)),n}function g({geom:e,new_indices:t=null,context:i,bufferGPUManager:r}){if(t){e.indexBufferGPU&&e.indexBufferGPU.numIndices<t.length?(e.indexBufferGPU.deallocate(i),e.indexBufferGPU=null,e.revision++):(e.markIndexStale(0,t.length),r.updateEditableBuffers(e),e.vertexBufferGPU&&(e.vertexBufferGPU.needsUpdate=!0)),e.vertexIndexArray=t;const n=e.drawingGroups[0];n.count=n._primitives[0].count=e.vertexIndexArray.length,e.wideLinesLinker&&e.wideLinesLinker.linkedGeometry.dispose()}return e}function m({width:e,color:t="#000000",show_hidden:i=!1,polite_color:o="#aaaaaa"}){const l=new r.Color(t),h=new r.Color(o),c=i?{ComputeAlbedo:function(e,t){const i=e.variableHandler,r=e.functionHandler;return`                 \n                        ${(e=>i.bool(e))("occluded")}  = ${r.cF("correctZFighting","b",[])};\n                        ${(e=>i.vec3(e))("color")}  = ${e.vGetAlbedo()};\n                        if (occluded) {\n                            color = ${(t=>e.getUniform(t))("occludedColor")};\n                            ${e.vSetFragDepth("0.001")};\n                        } else {        \n                            ${e.vSetFragDepth("0.0")};\n                        }\n                        return color;\n                    `}}:{ComputeDiscard:function(e,t){return`\n                        return ${e.functionHandler.cF("correctZFighting","b",[])};\n                    `}};let d=new r.LineBasicMaterial({color:l,lineWidth:e,depthTest:i,force:!0});return d.activatePDSFX("PDSFXCPUOutlines"),i&&(d._PDSFXData._uniqueID="hidden"+d._PDSFXData._uniqueID),d.setPDSFXGlobalShaderCode(null,(function(e){const t=e.variableHandler,i=e.functionHandler,r=e.bridgeFunctions,o=t=>e.getTextureUniform(t),l=t=>e.getUniform(t),h=t=>e.getVarying(t),c=e=>t.float(e),d=e=>t.vec2(e),u=e=>t.vec3(e),p=e=>t.vec4(e);let f;f=!!e.pdsfxDefines.renderToFloatTexture?`\n                ${i.dF("getNormalDepth","v4",[i.prmV2("coord")])}{\n\t\t\t\t\t${p("res")} = ${r.sample2DTexture(o("depthBuffer"),"coord")};\n\t\t\t\t\t${u("normal")}  = normalize(2.0 * res.xyz - 1.0);\n\t\t\t\t\t${c("depth")}  = res.w;\n\t\t\t\t\tif (depth < 0.01) {\n                        depth = 1.0;\n                    }\n\t\t\t\t\treturn ${p()}(normal,depth);\n\t\t\t\t}\n\n                ${i.dF("getPolygonOffset","f",[i.prmV2("coord"),i.prmV3("vN"),i.prmF("depth")])} {\n                    ${(e=>t.mat4(e))("P")} = ${e.vGetProjectionMatrix()};\n                    ${(e=>t.bool(e))("isPersp")}  = P[3][3] < 0.5;\n\n                    ${c("slopeFactor")} = 0.1;\n                    if (isPersp) {\n                        slopeFactor = 1.0;\n                    }\n\n                    ${d("sr")}  = 2.0 / ${l("depthMapSize")};\n                    ${d("vC")}  = (${e.vGetFragCoord()}.xy - 0.5) / ${l("depthMapSize")};\n                    vC = 2.0*vC - 1.0;\n\n                    ${c("K")}  = dot(${u()}(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);\n                    ${d("offset")}  = ${d()}(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);\n\n                    ${c("factor")}  = (-depth - 0.5 * (P[2][2] - 1.0)) / K;\n                    ${c("dFdxOfZ")}  = abs(offset.x * factor);\n                    ${c("dFdyOfZ")}  = abs(offset.y * factor);\n\n                    ${c("slope")}  = max(dFdxOfZ, dFdyOfZ);\n                    slope = min(max(slope, 1e-6), 1e-3);\n\n                    return (slope * slopeFactor) + (DEPTH_PRECISION * 1.5);\n                }\n\n\t\t\t\t${i.dF("getDepth","f",[i.prmV2("coord")])} {\n                    ${p("nDepth")}  = ${i.cF("getNormalDepth","v4",[i.prmV2("coord")])};\n                    ${c("offset")}  =  ${i.cF("getPolygonOffset","f",[i.prmV2("coord"),i.prmV3("nDepth.xyz"),i.prmF("nDepth.w")])};\n\n                    return nDepth.w + offset;\n                }\n                `:`      \n                    ${i.dF("getDepth","f",[i.prmV2("coord")])} {\n                        ${p("rgba_depth")}  = ${r.sample2DTexture(o("depthBuffer"),"coord")};\n                        ${c("depth")}  = ${s("unpackRGBA","f",[i.prmV4("rgba_depth")])};\n                        if (depth > 1e-6) {\n                            return depth + DEPTH_PRECISION;\n                        }\n                        return 1.0;\n\n                    }\n                `;let g=a;for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++)0===e&&e===t||(g=`\n                        ${g}\n                        coordtoUse = coord + ${d()}(${c()}(${e}), ${c()}(${t})) * ${d()}(dx, dy);\n                        num_closer += ${i.cF("depthSampleTest","f",[i.prmV2("coordtoUse"),i.prmF("delta"),i.prmF("depth")])};\n                    `);return`\n                ${f}\n                ${i.dF("depthSampleTest","f",[i.prmV2("coord"),i.prmF("delta"),i.prmF("depth")])}{\n                    ${c("fDepth")}  = ${i.cF("getDepth","f",[i.prmV2("coord")])};\n                    if (fDepth < depth) {\n                        return delta;\n                    }\n                    return 0.0;\n                }\n\n                ${i.dF("correctZFighting","b",[])}{\n                    ${d("coord")}   = 0.5 + 0.5 * ${h("cP")}.xy / ${h("cP")}.w;\n                    ${c("depth")}  = ${n.setDepthWithConvention(`${h("cP")}.z / ${h("cP")}.w`)} - 0.00002;\n\n                    ${d("coordtoUse")} = coord;\n                    if(depth <= ${i.cF("getDepth","f",[i.prmV2("coordtoUse")])}){\n                        return false;\n                    }\n                    ${c("delta")}  = 1.0/8.0;\n                    ${c("dx")}  = 0.5/${l("depthMapSize")}.x;\n                    ${c("dy")}  = 0.5/${l("depthMapSize")}.y;\n\n                    ${c("num_closer")}  = 0.0;\n                    ${g}\n                    // if at this point enough tests failed, discard\n                    return num_closer > 0.8;\n                }\n            `})),d.setPDSFXOverridableFunctions({ProcessClipSpacePosition:function(e,t){const i=e.variableHandler,r=e.pdsfxDefines,n=t=>e.getVarying(t),s=i.dereference(t[0]);return`\n                    ${r.wideLine?`\n                        ${n("cP")} =  ${e.vGetProjectionMatrix()} * ${e.vGetWorldViewMatrix()} * ${(e=>i.vec4(e))()}(${e.vGetAttribPosition()}, 1.0);\n                        `:`\n                        ${n("cP")} = ${s};\n                        `}\n                `}},c),d.setPDSFXUniforms({depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new r.Vector2(.01,.01)},occludedColor:{type:"v3",value:new r.Vector3(h.r,h.g,h.b)}}),d.setPDSFXVaryings({cP:{type:"v4"}}),d._refreshPDSFXUniforms_private=function(e,t){e.requestRealDepthBuffer(),e.dBuffer&&(d.updatePDSFXUniform("depthBuffer",e.dBuffer),d.updatePDSFXUniform("depthMapSize",new r.Vector2(e.dBuffer.width,e.dBuffer.height)))},d}window.time_outlines={dedup:0,adj:0,visibility:0,outlines:0,total:0,old_setup:0,old_add_edges:0,old_sort_edges:0,old_process_edges:0,old_total:0,print_cpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["dedup".padStart(e),"adj".padStart(e),"visibility".padStart(e),"outlines".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.dedup),t(this.adj),t(this.visibility),t(this.outlines),t(this.total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (CPU):\n${i}\n${r}\n\n`)},print_gpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["setup".padStart(e),"add".padStart(e),"sort".padStart(e),"process".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.old_setup),t(this.old_add_edges),t(this.old_sort_edges),t(this.old_process_edges),t(this.old_total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (GPU):\n${i}\n${r}\n\n`)},print:function(e=10){this.print_cpu(e),this.print_gpu(e)}};let v=null,_=null,y=null,S=null;function b({width:e,showHiddenOutlines:t}){if(e>1){t&&!S?S=m({width:e,show_hidden:!0}):t||y||(y=m({width:e,show_hidden:!1}));const i=t?S:y;return i.setLineWidth(e),i}t&&!_?_=m({width:e,show_hidden:!0}):t||v||(v=m({width:e,show_hidden:!1}));return t?_:v}var x=function(e){for(var t=1;t<e;)t*=2;return t},w=[];class P{constructor(e){this._renderable=e,this.indexArray=null,this.firstIndicesArray=null,this.lastIndexArray=null,this._Id=0,this._edgeId=0,this.width=1}createNewGeometry(e){const t=THREEDS.Core,i=this.createMaterial(),r=this.createDg(i),n=new t.BufferGeometryDS;return n.drawingGroups=[],r.geometry=n,n.drawingGroups.push(r),n.vertexPositionArray=this.firstIndicesArray,n.vertexNormalArray=this.lastIndexArray,n.vertexIndexArray=this.indexArray,n.boundingSphere=this._renderable.boundingSphere,n.boundingBox=this._renderable.boundingBox,n}}class C extends P{constructor(e){super(e),this.width=1}initArrays(){this._Id=0,this._edgeId=0,this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.firstIndicesArray,s=this.lastIndexArray,a=this._edgeId;n[6*a]=e,n[6*a+1]=t,n[6*a+2]=i,n[6*a+3]=t,n[6*a+4]=e,n[6*a+5]=r,s[6*a]=r,s[6*a+1]=0,s[6*a+2]=0,s[6*a+3]=i,s[6*a+4]=0,s[6*a+5]=0,this._edgeId++}createMaterial(){return E.TexturesManager.createSimpleMaterial()}createDg(t){const i=this.firstIndicesArray.length/3,r=THREEDS.Core,n=new e.DrawingGroup(t,t,1,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE);return n.nonIndexed=!0,n}}class M extends P{constructor(e,t){super(e),this.width=t,this.curr_Id=0}initArrays(){this._Id=0,this._edgeId=0,this.curr_Id=0,this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.indexArray,s=this.firstIndicesArray,a=this.lastIndexArray;n[this._Id++]=this.curr_Id,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+3,this.curr_Id+=4;const o=this._edgeId;s[12*o]=e,s[12*o+1]=t,s[12*o+2]=i,s[12*o+3]=t,s[12*o+4]=e,s[12*o+5]=r,s[12*o+6]=e,s[12*o+7]=t,s[12*o+8]=i,s[12*o+9]=t,s[12*o+10]=e,s[12*o+11]=r,a[12*o]=r,a[12*o+1]=-1,a[12*o+2]=0,a[12*o+3]=i,a[12*o+4]=2,a[12*o+5]=0,a[12*o+6]=r,a[12*o+7]=1,a[12*o+8]=0,a[12*o+9]=i,a[12*o+10]=-2,a[12*o+11]=0,this._edgeId++}createMaterial(){return E.TexturesManager.createWideMaterial(.5*this.width)}createDg(t){const i=this.indexArray.length,r=THREEDS.Core;return new e.DrawingGroup(t,t,4,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE)}}class E{constructor(e,t,i,r){this._renderable=e,this._oGeometry=1===t?new C(e):new M(e,t),E.TexturesManager.sortCount!==i&&(E.TexturesManager.clean(r),E.TexturesManager.sortCount=i)}computeOutlineGeometry(e){var t=this,i=0,n=0,s=0,a=this._renderable,o=[],l=[],h=[];if(a.layer){for(var c={},d=0;d<a.layer.layers.length;d++){var u=a.layer.layers[d].drawableGroup;if(!(I=a.layer.layers[d].drawableInterval).skip(a,e)&&u._geomType===r.GeomTypeEnum.FACE){var p=c[u.geometry.id];p?p.intervals.push(I):c[u.geometry.id]={geometry:u.geometry,intervals:[I]}}}var f=[];for(var d in c)f.push(c[d]);f.sort((function(e,t){return e.geometry.id-t.geometry.id}));for(d=0;d<f.length;d++)o[d]=f[d].geometry,l[d]=f[d].intervals}else o=a.geometry;var g=function(e,t,i,r){var n=o[e].vertexPositionArray,s=o[t].vertexPositionArray,a=0;return n[3*i]<s[3*r]?a=-1:n[3*i]>s[3*r]?a=1:n[3*i+1]<s[3*r+1]?a=-1:n[3*i+1]>s[3*r+1]?a=1:n[3*i+2]<s[3*r+2]?a=-1:n[3*i+2]>s[3*r+2]&&(a=1),a},m=function(e,t,i,r){if(g(r,r,e,t)>0){var n=e;e=t,t=n}return{i1:e,i2:t,i3:i,geomId:r}},v=function(e,t){var i=o[e.geomId].vertexPositionArray,r=o[t.geomId].vertexPositionArray;return i[3*e.i1]<r[3*t.i1]?-1:i[3*e.i1]>r[3*t.i1]?1:i[3*e.i1+1]<r[3*t.i1+1]?-1:i[3*e.i1+1]>r[3*t.i1+1]?1:i[3*e.i1+2]<r[3*t.i1+2]?-1:i[3*e.i1+2]>r[3*t.i1+2]?1:i[3*e.i2]<r[3*t.i2]?-1:i[3*e.i2]>r[3*t.i2]?1:i[3*e.i2+1]<r[3*t.i2+1]?-1:i[3*e.i2+1]>r[3*t.i2+1]?1:i[3*e.i2+2]<r[3*t.i2+2]?-1:i[3*e.i2+2]>r[3*t.i2+2]?1:e.i1===t.i1?e.i2===t.i2?0:t.i2-e.i2:t.i1-e.i1},_=w,y=0,S=function(e,t,r){for(var a=t.start;a<t.start+t.count;a+=3)if(i=e[a],n=e[a+1],s=e[a+2],i!==n&&n!==s&&i!==s){var o=m(i,n,s,r);_[y++]=o;var l=m(n,s,i,r);_[y++]=l;var h=m(s,i,n,r);_[y++]=h}},b=function(e){for(var i=0,r=0,n=0,s=0,a=0,o=null,l=null;i<y-1;)o=_[i],l=_[i+1],s=o.geomId,a=l.geomId,r=e?e[s]/3:0,0===g(s,a,o.i1,l.i1)&&0===g(s,a,o.i2,l.i2)?(n=e?e[a]/3:0,t._oGeometry.addFullEdgeIndices(r+o.i1,r+o.i2,r+o.i3,n+l.i3),i+=2):(t._oGeometry.addFullEdgeIndices(r+o.i1,r+o.i2,r+o.i3,r+o.i3),i++);y&&i===y-1&&(s=(o=_[i]).geomId,r=e?e[s]/3:0,t._oGeometry.addFullEdgeIndices(r+o.i1,r+o.i2,r+o.i3,r+o.i3))},x=[],P=0;for(d=0;d<o.length;d++)x[d]=P,o[d].vertexIndexArray.length,P+=o[d].vertexPositionArray.length;this._oGeometry.initArrays();var C=o.length;for(d=0;d<C;d++){var M,T=(M=o[d]).vertexIndexArray;if(a.layer)for(var A=l[d],D=0;D<A.length;D++){var I;S(T,I=A[D],d)}else for(var R=0;R<M.drawingGroups.length;R++){(u=M.drawingGroups[R])._geomType===r.GeomTypeEnum.FACE&&S(T,u,d)}}return 0===y?null:(_.length=y,_.sort(v),b(x),this._oGeometry.createFinalArrays(),h.push(this._oGeometry.createNewGeometry(e)),E.TexturesManager.addRenderableGeometries(this._renderable,o,h),h)}}E.halfEdgesArray=[],E.convertOutlineGeometry=function(t,i,r,n){E.ConversionMaterialsManager.sortCount!==n&&(E.ConversionMaterialsManager.clean(),E.ConversionMaterialsManager.sortCount=n);var s=THREEDS.Core,a=null,o=null,l=null,h=0,c=0,d=t.vertexPositionArray,u=t.vertexNormalArray,p=t.vertexPositionArray.length,f=0,g=t.drawingGroups[0].material,m=0,v=0,_=0,y=0,S=0,b=0,x=0,w=0,P=null,C=0;if(i<r){C=4,m=(f=p/3)/2,h=2*p,c=3*f,a=new Float32Array(h),o=new Float32Array(h),l=new Uint32Array(c);for(var M=0;M<m;M++)l[x++]=w,l[x++]=w+1,l[x++]=w+2,l[x++]=w+2,l[x++]=w+1,l[x++]=w+3,w+=4,v=d[6*M],_=d[6*M+1],y=d[6*M+2],S=u[6*M],b=u[6*M+2],a[12*M]=v,a[12*M+1]=_,a[12*M+2]=y,a[12*M+3]=_,a[12*M+4]=v,a[12*M+5]=S,a[12*M+6]=v,a[12*M+7]=_,a[12*M+8]=y,a[12*M+9]=_,a[12*M+10]=v,a[12*M+11]=S,o[12*M]=S,o[12*M+1]=-1,o[12*M+2]=b,o[12*M+3]=y,o[12*M+4]=2,o[12*M+5]=b,o[12*M+6]=S,o[12*M+7]=1,o[12*M+8]=b,o[12*M+9]=y,o[12*M+10]=-2,o[12*M+11]=b;P=E.ConversionMaterialsManager.createWideMaterialFromOther(g,.5*r)}else{C=1,m=(f=t.vertexIndexArray.length)/6,h=p/2,c=f/3,a=new Float32Array(h),o=new Float32Array(h);for(M=0;M<m;M++)v=d[12*M],_=d[12*M+1],y=d[12*M+2],S=u[12*M],b=u[12*M+2],a[6*M]=v,a[6*M+1]=_,a[6*M+2]=y,a[6*M+3]=_,a[6*M+4]=v,a[6*M+5]=S,o[6*M]=S,o[6*M+1]=0,o[6*M+2]=b,o[6*M+3]=y,o[6*M+4]=0,o[6*M+5]=b;P=E.ConversionMaterialsManager.createSimpleMaterialFromWide(g)}s=THREEDS.Core;var T=new e.DrawingGroup(P,P,C,0,c,void 0,void 0,s.GeomTypeEnum._OUTLINE);T.nonIndexed=1===C;var A=new s.BufferGeometryDS;return A.drawingGroups=[],T.geometry=A,A.drawingGroups.push(T),A.vertexPositionArray=a,A.vertexNormalArray=o,A.vertexIndexArray=l,A.boundingSphere=t.boundingSphere,A.boundingBox=t.boundingBox,t.dispose(),t=null,A},E.convertWideWidth=function(e,t,i){E.ConversionMaterialsManager.sortCount!==i&&(E.ConversionMaterialsManager.clean(),E.ConversionMaterialsManager.sortCount=i);for(var r=e[0].drawingGroups[0].material,n=E.ConversionMaterialsManager.createWideMaterialFromOther(r,.5*t),s=0;s<e.length;s++)e[s].drawingGroups[0].material=n},E.TexturesManager={sortCount:-1,nbVertices:0,newSimpleMaterial:function(e,t){return new THREEDS.Core._OutlineMaterial(e,t)},newWideMaterial:function(e,t,i){return new THREEDS.Core._WideOutlineMaterial(e,t,i)},addRenderableGeometries:function(e,t,i){this.isClean=!1;let r=0;for(let n=0;n<t.length;n++){const s=t[n];this.geometriesAssociated.push({renderable:e,geom:s,renderableOffset:this.nbVertices,outlineGeom:i[0],finalizeOutlines:!n}),r+=s.vertexPositionArray.length/3}this.nbVertices+=r,this._updateTextureDefines()},_updateTextureDefines:function(){var e=this.nbVertices;this.textureDefines.NB_OUTLINE_MAPS=Math.ceil(e/this.maxTextureTotalSize);var t=e-Math.floor(e/this.maxTextureTotalSize)*this.maxTextureTotalSize,i=Math.sqrt(t),r=x(i),n=x(t/r);this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=r,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=n},geometriesAssociated:[],textureDefines:{NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:-1,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0},maxTextureSize:-1,maxTextureTotalSize:-1,isClean:!0,simpleOutlineMaterial:null,wideOutlineMaterials:null,createSimpleMaterial:function(){if(null!==this.simpleOutlineMaterial)return this.simpleOutlineMaterial;var e=this.newSimpleMaterial(null,null);return this.simpleOutlineMaterial=e,e},createWideMaterial:function(e){if(null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={}),this.wideOutlineMaterials[e])return this.wideOutlineMaterials[e];var t=this.newWideMaterial(null,null,e);return this.wideOutlineMaterials[e]=t,t},finalize:function(){var e=THREEDS.Core,t=this.textureDefines.NB_OUTLINE_MAPS;if(0!==t){for(var i=this.maxTextureSize,r=this.maxTextureTotalSize,n=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X,s=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y,a=[],o=0;o<t;o++){var l=o===t-1?n*s:r;a.push(new Float32Array(3*l))}var h=0,c=0,d=this.geometriesAssociated,u=d.length,p=null,f=0;for(o=0;o<u;o++){var g=d[o];p=g.geom,f=g.renderableOffset,g.renderable;var m=a[h];if(c+p.vertexPositionArray.length<=3*r)m.set(p.vertexPositionArray,c),c+=p.vertexPositionArray.length;else{for(var v=0;v<3*r-c;v++)m[c+v]=p.vertexPositionArray[v];m=a[++h];var _=p.vertexPositionArray.length-3*r+c;for(v=0;v<_;v++)m[v]=p.vertexPositionArray[3*r-c+v];c=_}if(g.finalizeOutlines)for(var y=g.outlineGeom,S=y.vertexPositionArray,b=y.vertexNormalArray,x=b.length/3,w=0;w<x;w++){var P=S[3*w]+f,C=S[3*w+1]+f,M=S[3*w+2]+f,E=b[3*w]+f,T=Math.floor(P/r),A=Math.floor(C/r),D=Math.floor(M/r),I=Math.floor(E/r);S[3*w]=P-T*r,S[3*w+1]=C-A*r,S[3*w+2]=M-D*r,b[3*w]=E-I*r,b[3*w+2]=16*(16*(16*I+D)+A)+T}}for(var R=[],O=0;O<t-1;O++){(L=new e.DataTexture(a[O],i,i,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,L.magFilter=e.NearestFilter,L.generateMipmaps=!1,L.flipY=!1,L.needsUpdate=!0,R.push(L)}var L;if((L=new e.DataTexture(a[O],n,s,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,L.magFilter=e.NearestFilter,L.generateMipmaps=!1,L.flipY=!1,L.needsUpdate=!0,R.push(L),null!==this.simpleOutlineMaterial){this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,this.simpleOutlineMaterial.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);var B={occludedColor:{type:"v3",value:new e.Vector3(this.simpleOutlineMaterial.occludedColor.r,this.simpleOutlineMaterial.occludedColor.g,this.simpleOutlineMaterial.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:R,length:this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)}};this.simpleOutlineMaterial.setPDSFXUniforms(B)}if(null!==this.wideOutlineMaterials){var F=null;for(var V in this.wideOutlineMaterials){(F=this.wideOutlineMaterials[V]).defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,F.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),F.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),F.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);B={occludedColor:{type:"v3",value:new e.Vector3(F.occludedColor.r,F.occludedColor.g,F.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:R,length:F.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)},outlineHalfWidth:{type:"f",value:parseFloat(V)},pixelSize:{type:"v2",value:new e.Vector2}};F.setPDSFXUniforms(B)}}}},clean:function(e){if(this.isClean=!0,this.simpleOutlineMaterial=null,this.wideOutlineMaterials=null,this.nbVertices=0,this.textureDefines.MAX_OUTLINE_MAP_SIZE<0){if(e.getParameter){let t=e;this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}else{let t=e;this.maxTextureSize=t.limits.maxTextureDimension2D}this.maxTextureSize=Math.min(this.maxTextureSize,4096),this.textureDefines.MAX_OUTLINE_MAP_SIZE=this.maxTextureSize,this.maxTextureTotalSize=this.maxTextureSize*this.maxTextureSize}this.textureDefines.NB_OUTLINE_MAPS=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=0,this.geometriesAssociated.length=0}},E.ConversionMaterialsManager={sortCount:-1,simpleOutlineMaterials:null,wideOutlineMaterials:null,createSimpleMaterialFromWide:function(e){null===this.simpleOutlineMaterials&&(this.simpleOutlineMaterials={});var t=e.getPDSFXUniform("outlinePositionMaps").value;if(this.simpleOutlineMaterials[t[0].id])return this.simpleOutlineMaterials[t[0].id];var i=e.defines,r=E.TexturesManager.newSimpleMaterial(i,t);return this.simpleOutlineMaterials[t[0].id]=r,r},createWideMaterialFromOther:function(e,t){null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={});var i=e.getPDSFXUniform("outlinePositionMaps").value;if(this.wideOutlineMaterials[t]||(this.wideOutlineMaterials[t]={}),this.wideOutlineMaterials[t][i[0].id])return this.wideOutlineMaterials[t][i[0].id];var r=e.defines,n=E.TexturesManager.newWideMaterial(r,i,t);return this.wideOutlineMaterials[t][i[0].id]=n,n},clean:function(){this.simpleOutlineMaterials=null,this.wideOutlineMaterials=null}};const T={fetchFromOccurrences({object:e,width:t,viewDirection:i}){let r=e.outlinesGeometry;if(r&&r.geometry||e.layer)return r;const n=e._occurrence.node._occurrences;for(let s=0;s<n.length;s++){const a=n[s].renderable,o=a.outlinesGeometry;if(a!==e&&o&&o.geometry&&!a.layer&&(t===o.outlineWidth&&!i==!o.viewDirection&&(!i||i.equals(o.viewDirection)))){r&&r.dispose(),e.outlinesGeometry=r=o,r.refs++;break}}return r},implementation(e){const t=e.outlinesGeometry;if(t)return t.viewDirection?"cpu":"gpu"},isOutdated({object:e,viewDirection:t}){let i=e.outlinesGeometry;return!!i&&(!i.upToDate||e.layer&&!e.layer.upToDate||i.viewDirection&&!t)},updateMaterialGPU({object:e,width:t,showHiddenOutlines:i,_sortCount:r}){const n=e.outlinesGeometry;let s=n&&n.geometry;if(!s)return;for(var a=0;a<s.length;a++)s[a].drawingGroups[0].material.setShowHiddenOutlines(i);const o=n.outlineWidth;o!==t&&(n.outlineWidth=t,1===o||1===t?(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)):E.convertWideWidth(n.geometry,t,r))},updateMaterialCPU({object:e,width:t,showHiddenOutlines:i}){const r=e.outlinesGeometry;let n=r&&r.geometry;if(!n)return;if(!(r.outlineWidth!==t||r.showHiddenOutlines!==i))return;r.outlineWidth=t,r.showHiddenOutlines=i;const s=b({width:t,showHiddenOutlines:i});for(let e=0;e<n.length;e++)n[e].drawingGroups[0].material=s},create({object:t,viewDirection:i,width:n,_sortCount:s,_context:a,showHiddenOutlines:o,visibleSpace:l}){let h=null;if(i){const i=b({width:n,showHiddenOutlines:o});h=f(t,l).map((n=>function({renderable:t,material:i,vertexSourceGeometry:n=null,indices:s=null}){const a=new r.BufferGeometryDS;a.vertexIndexArray=s,n&&(a.vertexPositionArray=n.vertexPositionArray,a.vertexBufferGPU=n.vertexBufferGPU,a.vertexOffsetGPU=n.vertexOffsetGPU),a.vertexBufferGPU&&a.vertexBufferGPU.nbGeometries++,a.boundingSphere=t.boundingSphere,a.boundingBox=t.boundingBox;const o=s?s.length:0,l={start:0,count:o},h=new e.DrawingGroup(i,i,1,0,o,[l],void 0,r.GeomTypeEnum._OUTLINE);return a.drawingGroups=[h],h.geometry=a,a}({renderable:t,material:i,vertexSourceGeometry:n.geom}))),E.TexturesManager.sortCount!==s&&(E.TexturesManager.clean(a),E.TexturesManager.sortCount=s)}else{if(h=new E(t,n,s,a).computeOutlineGeometry(l),h)for(var c=0;c<h.length;c++)h[c].noMeshInRAM=!0,h[c].drawingGroups[0].material.setShowHiddenOutlines(o)}return h?(t.outlinesGeometry={geometry:h,outlineWidth:n,showHiddenOutlines:o,viewDirection:i,upToDate:!0,refs:1,dispose(){this.refs--,0===this.refs&&(Array.isArray(this.geometry)?this.geometry.forEach((e=>e.dispose())):this.geometry&&this.geometry.dispose()),this.geometry=null}},h):null},prepare({object:e,width:t,viewDirection:i,_sortCount:n,_context:s,showHiddenOutlines:a,visibleSpace:o}){if(r=THREEDS.Core,e._isDecal())return{outlineBG:[],created:!1,invalidateGSSO:!1};switch(T.fetchFromOccurrences({object:e,width:t,viewDirection:i}),T.isOutdated({object:e,viewDirection:i})&&(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)),T.implementation(e)){case"cpu":T.updateMaterialCPU({object:e,width:t,showHiddenOutlines:a});break;case"gpu":T.updateMaterialGPU({object:e,width:t,showHiddenOutlines:a,_sortCount:n})}let l=e.outlinesGeometry&&e.outlinesGeometry.geometry,h=!1;l||(l=T.create({object:e,viewDirection:i,width:t,_sortCount:n,_context:s,showHiddenOutlines:a,visibleSpace:o}),h=!!l);const c=l&&!e.outlinesGeometry.viewDirection;return l?Array.isArray(l)||(l=[l]):l=[],{outlineBG:l,created:h,invalidateGSSO:c}},refresh({object:e,viewDirection:i,width:n,context:s,visibleSpace:a,bufferGPUManager:o}){r=THREEDS.Core;let l=e.outlinesGeometry;if(!l)return;let h=l.geometry;if(h)if(!i==!l.viewDirection){if(i){if(0===h.length)return;T.updateMaterialCPU({object:e,width:n,showHiddenOutlines:l.showHiddenOutlines});let r=!1;for(let e=0;e<h.length;e++)h[e].vertexIndexArray||(r=!0);if(!r&&l.viewDirection.equals(i))return;!function({renderable:e,view_direction:i,geometry:r=null,context:n,visibleSpace:s,bufferGPUManager:a}){const o=performance.now();let l=f(e,s);r||(r=Array(l.length));for(let e=0;e<l.length;e++){const s=l[e],o=s.geom;let h=[];for(let e=0;e<s.components.length;e++){const t=s.components[e];h.push(p(o,t.ranges,t.id,i))}h=t.mergeIndexBuffers(h),g({geom:r[e],new_indices:h,context:n,bufferGPUManager:a})}const h=performance.now();window.time_outlines.total+=h-o}({renderable:e,view_direction:i,geometry:h,context:s,visibleSpace:a,bufferGPUManager:o}),l.viewDirection=i}else if(l.outlineWidth!==n)return void e._flagAsGSSOInvalidated()}else e._flagAsGSSOInvalidated()}};return E.prepareOutlines=function(e){return T.prepare(e)},E.refreshOutlines=function(e){return T.refresh(e)},E})),define("DS/Visualization/FixedSizeArrayPool",["DS/Visualization/WidelinesHelper","DS/Visualization/OutlineBuilder","DS/Mesh/ThreeJS_Base"],(function(e,t,i){var r=function(){},n=0,s=0,a=new Map,o=null,l=null;localStorage.getItem("curvedPipesDebug")&&"true"===localStorage.getItem("curvedPipesDebug")&&(l={nbTokens:0,nbInstData:0,tokens:{},tokenPool:o,instData:{},maxNbInstances:{},instDataPool:a},window._debugTokenPool=l);var h=function(e,t,i){this.id=n++,this.idsArray=new Float32Array(2*e),this.idsBuffer=null,this.includesPicking=t,this.pickingColorArray=t?new Float32Array(3*e):null,this.pickingColorBuffer=null,this.lastId=-1,this.igId=i,this._maxNbInstances=e,this.key="",this.objectToIdInArray=new Map,this.idToObjectArray=new Map,this.updateData=!0,this._next=null,l&&(l.nbInstData++,l.instData[this.id]=this,l.maxNbInstances[e]?l.maxNbInstances[e]++:l.maxNbInstances[e]=1)};h.prototype.addInstance=function(e,t,i,r,n){if(this.lastId!==this._maxNbInstances-1){this.lastId++;var s=i.dgIndex+"_"+i.index,a=this.objectToIdInArray.get(s);void 0===a?(this.objectToIdInArray.set(s,this.lastId),this.idToObjectArray.set(this.lastId,s),a=this.lastId):console.log("what!!");var o=t.idInMaps,l=t.matrixId4,h=2*a;if(this.idsArray[h]=l,this.idsArray[h+1]=o*n,this.pickingColorArray){var c=3*a;this.pickingColorArray[c]=r.r,this.pickingColorArray[c+1]=r.g,this.pickingColorArray[c+2]=r.b}this.updateData=!0}else console.error("there has been an issue : not enough room to add instances")},h.prototype.removeInstances=function(e,t,i){for(var r=0;r<i.length&&-1!==this.lastId;r++){i[r].bin===this.igId&&this.removeInstance(e,t,r)}return-1===this.lastId},h.prototype.removeInstance=function(e,t,i){var r=e+"_"+t+"_"+i,n=this.objectToIdInArray.get(r),s=this.idToObjectArray.get(this.lastId);if(void 0!==n){if(this.objectToIdInArray.delete(r),this.idToObjectArray.delete(n),n!==this.lastId){var a=this.idsArray[2*this.lastId],o=this.idsArray[2*this.lastId+1];if(this.idsArray[2*n]=a,this.idsArray[2*n+1]=o,this.pickingColorArray){var l=this.pickingColorArray[3*this.lastId],h=this.pickingColorArray[3*this.lastId+1],c=this.pickingColorArray[3*this.lastId+2];this.pickingColorArray[3*n]=l,this.pickingColorArray[3*n+1]=h,this.pickingColorArray[3*n+2]=c}var d=this.objectToIdInArray.get(s);this.objectToIdInArray.set(s,n),this.idToObjectArray.delete(d),this.idToObjectArray.set(n,s),this.updateData=!0}this.lastId--}},h.prototype.copyDataTo=function(e){for(var t=this.idsArray.length,i=0;i<t;i++)e.idsArray[i]=this.idsArray[i];if(this.pickingColorArray){var r=this.pickingColorArray.length;for(i=0;i<r;i++)e.pickingColorArray[i]=this.pickingColorArray[i]}this.objectToIdInArray.forEach((function(t,i){e.objectToIdInArray.set(i,t)})),this.idToObjectArray.forEach((function(t,i){e.idToObjectArray.set(i,t)})),e.lastId=this.lastId,e.includesPicking=this.includesPicking,e.updateData=!0},h.prototype.resetForReuse=function(e){this.lastId=-1,this.igId=e,this.objectToIdInArray?this.objectToIdInArray.clear():this.objectToIdInArray=new Map,this.idToObjectArray?this.idToObjectArray.clear():this.idToObjectArray=new Map,null===this.idsArray&&(this.idsArray=new Float32Array(2*this._maxNbInstances)),this.includesPicking&&null===this.pickingColorArray&&(this.pickingColorArray=new Float32Array(3*this._maxNbInstances)),this.updateData=!0};class c{constructor(){this.doIt=!1,this.enable=!1,this.unit=1,this.factor=1}reset(){this.doIt=!1,this.enable=!1,this.unit=1,this.factor=1}}const d=new i.Matrix4;class u{constructor(e,t,n,a,o,h,d,u,p){this.object=e,this.geometry=t,this.dg=n,this.start=a,this.count=o,this.multiStart=u||null,this.multiCount=p||null,this.previous=null,this.next=null,this.doRenderLineModePolygonOffset=new c,this._sideHandler=new i.__MaterialSideHandler,this.doSetMaterialFaces=this._sideHandler.getSideFunc(),this.zSortKey=0,this.draw=r,this.updateLineInfos=!1,this.matApp=h,this.gas=d,this._programID=0,e&&(this._programID|=e._programID),h&&(this._programID|=h._programID),l&&(this.__id=s++),this.cullingDataId=0}getNbInstance(){const e=this.dg,t=this.object;return e&&e._instancingInfos?e._instancingInfos.nbInstances:t&&t._instancingInfos?t._instancingInfos.drawCount:1}getInstanceInfos(){const e=this.dg,t=this.object;return e&&e._instancingInfos?e._instancingInfos:t&&t._instancingInfos?t._instancingInfos:null}reset(){this.object=null,this.geometry=null,this.dg=null,this.start=0,this.count=0,this.multiStart=null,this.multiCount=null,this.previous=null,this.next=null,this.doRenderLineModePolygonOffset.reset(),this._sideHandler=new i.__MaterialSideHandler,this.doSetMaterialFaces=this._sideHandler.getSideFunc(),this.zSortKey=0,this.draw=r,this.updateLineInfos=!1,this.matApp=null,this.gas=null,this._programID=0,this.cullingDataId=0}_updateWideLineAndPatternStuff(r,n,s,a){const o=n.domElement,l=this.object;if(r.isDashedLine&&r.isCPUPattern)if(r.isWideLine||r.is2DLine){if(!n.renderVolumesOnly)if(c=this.geometry){var h=(new i.Matrix4).multiplyMatrices(s.matrixWorldInverse,l._getMMMatrix());e._computePixelWideLineDistances(c,h,s.projectionMatrix,o)}}else{h=(new i.Matrix4).multiplyMatrices(s.matrixWorldInverse,l._getMMMatrix());var c=this.geometry;e._computePixelLineDistances(c,h,s.projectionMatrix,o)}const u=this.dg;if(u&&u._updateLineWithShapes&&u._updateLineWithShapes.frameIndex!==n.currentFrameIndex){u._updateLineWithShapes.frameIndex=n.currentFrameIndex;let e=d,t=1;if(u._updateLineWithShapes.needProjectionMatrix){e=new i.Matrix4(o.width/2,0,0,0,0,o.height/2,0,0,0,0,1,0,0,0,0,1).multiply(s.projectionMatrix).multiply(s.matrixWorldInverse).multiply(this.object._getMMMatrix())}else t=l._getMMMatrix().getScaleOnAxisX();u._updateLineWithShapes.cb(e,t)}if(a&&l.outlinesGeometry&&u._geomType===i.GeomTypeEnum._OUTLINE){let e=null;if(n.useCPUOutlines(s)){let t=new i.Vector4(0,0,1,0).applyMatrix4(s.matrixWorld);t.applyMatrix4((new i.Matrix4).getInverse(l._getMMMatrix())),e=new i.Vector3(t.x,t.y,t.z).normalize()}t.refreshOutlines({object:l,viewDirection:e,width:n.getRenderMode(l)._outlineWidth,context:n.context,visibleSpace:n.visibleSpace,bufferGPUManager:n.bufferGPUManager}),this.start=u.start,this.count=u.count}}}class p extends u{constructor(e,t,i,r,n,s,a,o,h,c){super(e,t,i,r,n,s,a),l&&(l.nbTokens++,l.tokens[this.__id]=this),this.autoInstancingData=g.prototype.allocate_autoInstData(o,h,c),this.instanced=!0}releaseAutoInstData(){var e=a.get(this.autoInstancingData.key)||null;this.autoInstancingData._next=e,a.set(this.autoInstancingData.key,this.autoInstancingData),l&&(l.nbInstData--,l.maxNbInstances[this.autoInstancingData._maxNbInstances]--,delete l.instData[this.autoInstancingData.id])}}let f=null;class g{constructor(){this.bySizePools={},this.pool5=this.bySizePools[5]={list:[],nextAvailable:0,lastCount:0},this.timerClean=void 0}allocate(e,t,n,s,a,o,l,h,c){var d=null;if(f){d=f;f=f.next,d.object=e,d.geometry=t,d.dg=n,d.start=s,d.count=a,d.multiStart=h,d.multiCount=c,d.previous=null,d.next=null,d.doRenderLineModePolygonOffset.reset(),d._sideHandler=new i.__MaterialSideHandler,d.doSetMaterialFaces=d._sideHandler.getSideFunc(),d.draw=r,d.zSortKey=0,d.matApp=o,d.gas=l,d._programID=0,e&&(d._programID|=e._programID),o&&(d._programID|=o._programID),d.cullingDataId=0}else d=new u(e,t,n,s,a,o,l,h,c);return d}release(e){e.next=f,f=e,e.reset()}allocateInstancedCurvedPipeSection(e,t,n,s,a,h,c,d,u,f){var m=null;if(o){m=o;o=o.next,m.object=e,m.geometry=t,m.dg=n,m.start=s,m.count=a,m.previous=null,m.next=null,m.higher=null,m.lower=null,m.doRenderLineModePolygonOffset.reset(),m._sideHandler=new i.__MaterialSideHandler,m.doSetMaterialFaces=m._sideHandler.getSideFunc(),m.draw=r,m.zSortKey=0,m.matApp=h,m.gas=c,m._programID=0,e&&(m._programID|=e._programID),h&&(m._programID|=h._programID),m.autoInstancingData=g.prototype.allocate_autoInstData(d,u,f),l&&(l.nbTokens++,l.tokens[m.__id]=m)}else m=new p(e,t,n,s,a,h,c,d,u,f);return m}releaseInstanced(e){e.releaseAutoInstData(),e.autoInstancingData=null,e.next=o,o=e,l&&(l.nbTokens--,delete l.tokens[e.__id])}allocate_autoInstData(e,t,i){var r=e.toString()+(t?"p":""),n=a.get(r)||null,s=null;n?(s=n,a.set(r,n._next),s._next=null,s.resetForReuse(i),l&&(l.nbInstData++,l.maxNbInstances[e]?l.maxNbInstances[e]++:l.maxNbInstances[e]=1,l.instData[s.id]=s)):(s=new h(e,t,i)).key=r;var o=debugWebGLV6Viewer.renderer.renderer.context;return s.idsBuffer||(s.idsBuffer=o.createBuffer()),o.bindBuffer(o.ARRAY_BUFFER,s.idsBuffer),o.bufferData(o.ARRAY_BUFFER,s.idsArray,o.DYNAMIC_DRAW),t&&(s.pickingColorBuffer||(s.pickingColorBuffer=o.createBuffer()),o.bindBuffer(o.ARRAY_BUFFER,s.pickingColorBuffer),o.bufferData(o.ARRAY_BUFFER,s.pickingColorArray,o.DYNAMIC_DRAW)),s}dispose(){f=null,o=null,a.clear()}}return g})),define("Visualization/FixedSizeArrayPool",["DS/Visualization/FixedSizeArrayPool","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/FixedSizeArrayPool"),e})),define("DS/Visualization/ThreeJS_R57",["DS/Visualization/RendererGlobals","DS/Visualization/FixedSizeArrayPool","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","DS/Visualization/BufferGPUManager","DS/Visualization/ShaderChunk","UWA/Data","WebappsUtils/WebappsUtils","DS/Object3D/Light","DS/Visualization/Materials","DS/Visualization/ShaderLib","DS/Visualization/CullingSystem","DS/Visualization/OcclusionSystem","DS/GPUFormats/GPUFormats","DS/RenderEngineUtils/RenderEngineUtils","DS/Visualization/SkinningTransformation","DS/Visualization/Info","DS/RenderEngineUtils/BufferUtils","DS/ShaderBuilders/ShaderUtils/UniformUtils","DS/ShaderBuilders/ShaderUtils/ShaderInOutUtils","DS/ShaderBuilders/ShaderUtils/TypeUtils","DS/ShaderBuilders/ShaderUtils/AttributeUtils","DS/ShaderBuilders/ShaderUtils/FunctionUtils","DS/ShaderBuilders/WebGPUShaderBuilder","DS/GPUFormats/WebGPURenderPipelines","DS/ShaderBuilders/PDSFXShaderBuilder","DS/CoreEvents/Events"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M){"use strict";window.SIMULATE_EXPERIENCE_PLAYER;var E=e.Constants;const T=e.BodyLinesMask,A=e.BodyPointsMask,D=e.UnknownMask,I=e.OITMode;self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array;const R={TRIANGLE_STRIP:5,TRIANGLES:4,LINE_STRIP:3,LINES:1,POINTS:0};e.GLTypeEnum=R;const O=new e.Matrix4;var L=new e.Color;new e.Vector3;const B=new e.Color;e.__pickingColor=B;const F=e.__visibleInCurrentSpace,V=e.__visibleInCurrentSpaceSimple;e.__DefaultUVTransform__=e.__DefaultUVTransform__||new e.Matrix3,e._currentGPUUtils={currentBufferGPUManager:null};const G=e._currentGPUUtils,N=e.ProgramIDs,U=e.GlobalProgramIDs,k=e.Blendings,z=e.PolygonOffsetForceStatus;var H,W;!function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(t){var i=Date.now(),r=Math.max(0,16-(i-e)),n=window.setTimeout((function(){t(i+r,!1)}),r);return e=i+r,n}),window.cancelAnimationFrame=window.cancelAnimationFrame||function(e){window.clearTimeout(e)}}();const j=e.dimensionMapping,X=e.GeomTypeEnum,q=(e.PlaneViewMode,e._ForbidRenderableStates),Z=e._toFastProperties,Y=e._AmbianceGenerators,K=(e._SSSGenerator,e.TextureBlendOperations),$=new C.Fragment,Q=new C.Vertex;{let t=["modelMatrix","modelViewMatrix","modelViewInvTranspMatrix","modelInvTranspMatrix","normalMatrix","quantizedVector","fixedSizeCenterRatio","billboardType","decalStencilValue","displacementRadius","backgroundViewModeControl","objectColorBufferType","backgroundViewModeNearFar","belowInstancingModelMatrix","_Stride0","_instancingDataSize","lightMap","skinningMap","skinningInstancingMaps","compressionContext"];if(t.length>e._MaxBitMask-3)throw"Too many enums in ObjectUniforms";let i=new Object;for(var J=0;J<t.length;J++)i[t[J]]=1<<J+3;i._TexturedLimit=i.lightMap,i._IgnoreForFunction=0,e.ObjectUniformEnum=i}{let t=["projectionMatrix","viewMatrix","cameraPosition","projectionInvMatrix","viewInvMatrix","viewInvTranspMatrix","lowlightColor","nearFarLogFactor","viewportSize","pixelToWorldSizeCst","billCameraPos","billCameraLookAt","brightness","nbClipPlanes","cylinderClipZone","pixelSize","iHighlightIntensity","highlightID","oitLinkedListHeads","aoTexture","refractionColorTexture","reflectionColorTexture","viewInfo","rgbaDepth","polygonSize","scissorSize"];if(t.length>e._MaxBitMask)throw"Too many enums in GlobalUniforms";let i=new Object;for(J=0;J<t.length;J++)i[t[J]]=1<<J;i._TexturedLimit=i.viewInfo,i._IgnoreForFunction=i.nbClipPlanes|i.scissorSize|i.polygonSize|i.cylinderClipZone|i.rgbaDepth|i.brightness|i.pixelSize|i.oitLinkedListHeads|i.aoTexture|i.refractionColorTexture|i.reflectionColorTexture,e.GlobalUniformEnum=i}e.ProgramObject=class{constructor(){this.program=null,this.id=0,this.uvOrBinOrTan=!1,this._clipPlanesVersion=-1,this._lightsKey=0,this._ambianceKey=0,this._materialToUse=0,this.shaderID=null,this.pdsfx_uniqueID=null,this.layoutSignature=null,this.attributes={position:-1,normal:-1,uv:-1,uv2:-1,tangent:-1,binormal:-1,color:-1,skinIndex:-1,skinWeight:-1,lineDistance:-1,linePixelDistance:-1,previousPos:-1,followingPos:-1,sideExtrusion:-1,patternStartEnd:-1},this.instanceAttributes={}}clean(e){}delete(e){this.program=null}};const ee=e.DefaultAppearanceMode,te=e._DebugMaterialMode,ie=e.MaterialToUse,re=e._isSelectionMaterial,ne=d.VISIBILITY_STATUS,se=d.INCREMENTAL_ACTIONS,ae=d.__CullingSystemFactory,oe=u.__OcclusionSystemFactory,le=e.DecalRenderingMode;Object.assign(e,h),Object.defineProperty(e,"ShaderMaterial",{get:function(){return h.ShaderMaterial},set:function(e){}});const he=new e.DSPBR19xMaterial({color:14540253,roughness:.34,specular:16777215,ior:1.4,metalness:0,specularContrib:1,opacity:1,transparency:0}),ce=h.ShaderDynamicPrefixBuilder._VertexPrefixBuilder,de=h.ShaderDynamicPrefixBuilder._FragmentPrefixBuilder,ue=e.FragmentStage;Object.assign(e,g);const pe={set(){},get:()=>"SHADERCHUNK_ACCESS_NON_COMPILING_CODE;"};Object.defineProperty(e,"ShaderChunk",{get:function(){return new Proxy({},pe)},set:function(){throw"NO"}});const fe={set(e,t,i){throw"You can't do that"},get(e,t,i){const r=e[t];return null!=r&&"object"==typeof r?new Proxy(r,fe):r}};e._ShaderChunk=s,e.ShaderLib=c;let ge=0,me={program:null};const ve=e.RendererMode,_e=new Array(ve._count);for(J=0;J<ve._count;J++)_e[J]=J;class ye{constructor(e){this.renderer=e,this.currentNormalStencilDepthBuffer=null,this.currentTexCoordBuffer=null,this.currentRGBADepthBuffer=null,this.oldClearAlpha=null,this.oldClearColor=null}reset(){const e=this.renderer;e.materialToUseList.shadowPassMaterial?(this.currentNormalStencilDepthBuffer&&this.currentNormalStencilDepthBuffer.dispose(),this.currentTexCoordBuffer&&this.currentTexCoordBuffer.dispose(),this.currentRGBADepthBuffer&&this.currentRGBADepthBuffer.dispose()):(e.renderTargetPool.pushRenderTarget(this.currentNormalStencilDepthBuffer,null),e.renderTargetPool.pushRenderTarget(this.currentTexCoordBuffer,null),e.renderTargetPool.pushRenderTarget(this.currentRGBADepthBuffer,null)),this.currentNormalStencilDepthBuffer=null,this.currentTexCoordBuffer=null,this.currentRGBADepthBuffer=null,this.oldClearAlpha=null,this.oldClearColor=null}_clear(e,t,i,r){const n=this.renderer;n.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((()=>{n.setClearColor(t,i),n.clearTarget(e,!0,!0,!0)}),r)}clear(t){const i=this.renderer,r=this;this.currentNormalStencilDepthBuffer&&this._clear(this.currentNormalStencilDepthBuffer,new e.Color(0),1,"decalStencilClear"),this.currentRGBADepthBuffer&&this._clear(this.currentRGBADepthBuffer,new e.Color(16777215),1,"decalRGBAClear"),this.currentTexCoordBuffer&&this._clear(this.currentTexCoordBuffer,new e.Color(0),0,"decalUVsClear"),i.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((()=>{i.setClearColor(r.oldClearColor,r.oldClearAlpha),i.clearTarget(t,!1,!1,!1)})),this.reset()}init(t){this.reset();const i=this.renderer,r=this;this.oldClearColor=i.getClearColor(),this.oldClearAlpha=i.getClearAlpha();const n=i.getViewportSize();i.materialToUseList.shadowPassMaterial&&(n.width=t.width,n.height=t.height),this.currentNormalStencilDepthBuffer=i.renderTargetPool.buildRenderTarget(n.width,n.height,"decal"),this._clear(this.currentNormalStencilDepthBuffer,new e.Color(0),1,"decalStencilClear"),i.supportsFloatTextures()||(this.currentRGBADepthBuffer=i.renderTargetPool.buildRenderTarget(n.width,n.height,"uintNearest"),this._clear(this.currentRGBADepthBuffer,new e.Color(16777215),1,"decalRGBAClear")),i.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((()=>{i.setClearColor(r.oldClearColor,r.oldClearAlpha),i.clearTarget(t,!1,!1,!1)}))}prepareDecals(t,i,r){const n=this.renderer,s=this;if(t)n.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((()=>{n.clearTarget(s.currentNormalStencilDepthBuffer,!1,!1,!1)}),"decalStencil");else if(i){if(null==this.currentTexCoordBuffer){const t=n.getViewportSize();this.currentTexCoordBuffer=n.renderTargetPool.buildRenderTarget(t.width,t.height,"decalTex"),this._clear(this.currentTexCoordBuffer,new e.Color(0),0,"decalUVsClear")}n.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((()=>{n.clearTarget(s.currentTexCoordBuffer,!1,!1,!1)}),"decalUVs")}else r&&n.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((()=>{n.clearTarget(s.currentRGBADepthBuffer,!1,!1,!1)}),"decalRGBA")}restoreDecals(e,t){if(!t)return;const i=this.renderer;i.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((()=>{i.clearTarget(e,!1,!1,!1)}))}}const Se=f.StateSortingCacheItem,be={vertexBuffer:null,indexBuffer:null,updateBuffers:!1,instanceAttribArrays:null};e._lastMinuteHandlingResult=be;const xe=e.DrawCallSorting;class we{constructor(){this.usedBy=new Set,this.programs=[],this.tryCleanPrograms=!1}}const Pe={pools:new Map,get(e){const t=e.getContextId(null);if(this.pools.has(t)){let i=this.pools.get(t);return i.usedBy.add(e),i}let i=new we;return i.usedBy.add(e),this.pools.set(t,i),i},remove(e){const t=e.getContextId(null);if(this.pools.has(t)){let i=this.pools.get(t);return i.usedBy.delete(e),0===i.usedBy.size&&(this.pools.delete(t),!0)}return!1}};return e.WebRenderer=class{constructor(i){this._viewer=null,this.context=null,this.currentProgram=me,this.newMaterialInheritance=!1,this.use_webgpu=!1,this.ODTMode=!!i.ODTMode,this._pbrCheck=null,this.supportedFeatures={},this.renderPointMode=0,this.renderLineMode=e.ShowAllRenderLineMode,this.renderFaceMode=e.ShowAllFaces,this.renderDecalMode=le.NO_IGNORE,this.clippingSphereOptim=void 0===window.WUXClippingSphereOptim||window.WUXClippingSphereOptim,this.renderHiddenEdges=!1,this.halfVisibleSmoothEdges=!1,this.outlineWidth=1,this.ratioSSB=100,this.colorizeSSB=!1;var r=new e.PickingMode;this.pickingModeMSB=r.pickingModeMSB,this.pickingModeLSB=r.pickingModeLSB,this.generateInfos=!1,this.__A2XMode=!1,this.currentFrameIndex=0,this._currentFrameType=-1,this.renderIteration=0,this.sortCount=0,this._VRCompatible=!1,this._VRFrameBuffer=null,this.resetGSSOCacheFrame=0,this.resetClippingStatusFrame=0,this.useBackfaceCullingWithNoCapping=!1,this.useCustomCappingForClipPolyline=!1,this.shaderVersions=new Array(ve._count);for(var s=0;s<ve._count;s++)this.shaderVersions[s]=0;this.currentRendererMode=ve.static,this.forcePolygonOffset=z.DEFAULT,this.overrideWireframeFix=!1,this.depthFuncs=null,i=i||{},this._texturesToResize=new Set,this.positionComponent=new e.Vector3(1,0,0),this.precision=void 0!==i.precision?i.precision:"highp",this.precisionInt=void 0!==i.precision?i.precision:"highp",this.divCSS3DRoot=void 0!==i.divCSS?i.divCSS:document.createElement("div"),this.useCompositing=i.useCompositing;var a=!(!navigator.webdriver||localStorage.getItem("WebVisuEnableAAWithWebdriver"));this._sortRenderListByBuffer=void 0!==i.sortRenderListByBuffer&&i.sortRenderListByBuffer,this.canvas=void 0!==i.canvas?i.canvas:document.createElement("canvas"),this.alpha=void 0===i.alpha||i.alpha,this.premultipliedAlpha=void 0===i.premultipliedAlpha||i.premultipliedAlpha,this.antialias=void 0!==i.antialias&&!a&&i.antialias,this.stencil=void 0===i.stencil||i.stencil,this.preserveDrawingBuffer=void 0!==i.preserveDrawingBuffer&&i.preserveDrawingBuffer,this.width=0,this.height=0,this.widthHalf=0,this.heightHalf=0,this.domElement=this.canvas,this.currentPass=null,this.id=ge++,this.id>e._MaxRendererID&&console.error("Too many renderers"),this._globalProgramID=0,this.useRenderPriorityOpacity=!1,this.renderPriorityDefaultOpacity=1,this.devicePixelRatio=void 0!==i.devicePixelRatio?i.devicePixelRatio:e.getDevicePixelRatio()||1,this.splitScreenMode=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sectionCappingEnabled=!1,this.occlusionCullingEnabled=!1,this.occlusionDebugEnabled=!1,this.kNumOcclusionContexts=8,this.materialToUseList={originalMaterial:null,mainMaterial:null,lightedMaterial:null,isDecalNotPossiblePass:null,depthMaterial:null,depthRGBAMaterial:null,normalDepthReflMaterial:null,normalDepthMaterial:null,normalMaterial:null,zOnlyPass:null,dialogPass:null,outlineFriendly:null,pickingMaterial:null,pickingPassMaterial:null,shadowMaterial:null,highlightMaterial:null,oitMaterial:null,oitLinkedListMaterial:null,transparentShadowMaterial:null,positionMaterial:null,shadowPassMaterial:null},this.decalBuffers=new ye(this),this.lastRenderTarget,this.visibleSpace=void 0!==i.visibleSpace?i.visibleSpace:1,this.sortObjects=!0,this.autoUpdateObjects=!0,this.autoUpdateScene=!0,this.gammaInput=!1,this.gammaOutput=!1,this.renderTargetPool=null,this.simpleGamma=!0,this.lensFlareEnabled=!0,this.baseLightDirection=new e.Vector3(0,0,1),this.shadowMapEnabled=!1,this.transparentShadowEnabled=!1,this.shadowMapAutoUpdate=!0,this.shadowMapType=e.PCFShadowMap,this.shadowMapQuality="Low",this.shadowMapCullFace=e.CullFaceFront,this.shadowMapDebug=!1,this.shadowMapCascade=!1,this._renderScale=1,this._internalPixelScale=1,this.flakesMode=0,this.gasAsPhong=!1,this._useIBLColor=!1,this.clipPlanesEnabled=!1,this.clipPlanes=[],this.clipPlanesTolerance=.005,this.disableBackFaceClipPlanes=0,this.maxMorphTargets=8,this.maxMorphNormals=4,this.disableDepthWrite=!1,this.disableDepthTest=!1,this.disableColorWrite=!1,this.enableStencilWrite=!1,this.disableBackFaceCulling=!1,this.disableSetColorWrite=!1,this._inheritanceSolver=new f.InheritanceSolver(this),this.renderVolumesOnly=!1,this.materialMode=!0,this._defaultAppearanceType=ee.BASIC,this._debugMaterialMode=te.NO_DEBUG,this._backgroundViewMode=e.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._backgroundColor=null,this._customMaterialModeParams={colorFromGAS:!1,color:new e.Color,shininess:1,opacity:1},this._GlobalZModeFilter=null,this.useCPUOutlines=this._inheritanceSolver._useCPUOutlines,this._fixedPointSize=null,this.enableRenderPluginsPre=!0,this.enableRenderPluginsPost=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.refractionColorBuffer=null,this.reflectionColorBuffer=null,this.aoBuffer=null,this.ambianceGenerators=null,this.needsExtractIBLLight=!1,this.sssGenerator=null,this.dBuffer=null,this.requestDBuffer=!1,this._dBufferNextFrame=!1,this.requestRealDepthBuffer=function(){this._dBufferNextFrame=!0},this._requestPoliteDepthBuffer=!1,this._politeDBufferNextFrame=!1,this._politeBufferRequestsCBs=[],this.requestPoliteDepthBuffer=function(e){this._politeDBufferNextFrame=!0,this._requestPoliteDepthBuffer=!0,e&&this._politeBufferRequestsCBs.push(e)},this.politeDepthBuffer=null,this._usePolitenessOnHighlight=!0,this._NoMeshInRamWarningCount=0,this.maxPolyLineSize=0,this.maxNbPolyLine=0,this.maxScissorSize=0,this.maxNbScissor=0,this.useClippingCylinder=!1,this.info={memory:new m.MemoryInfo,renderMap:new Map,render:null,renderTime:new m.RenderTimeInfo},this.memoryInfo=this.info.memory,this.currentRenderInfo=null,this.inlinedPostProcess={activated:!1,brightness:0,tonemapping:2,filmic_A:.22,filmic_B:.3,filmic_C:.1,filmic_D:.2,filmic_E:.01,filmic_F:.3,filmic_W:11.2,crushblacks:0,burnhighlights:0,saturation:1,colorCorrection:{x:1,y:1,z:1}},this.resetInlinedPostProcess=function(){this.inlinedPostProcess.activated=!1,this.inlinedPostProcess.brightness=0,this.inlinedPostProcess.tonemapping=2,this.inlinedPostProcess.filmic_A=.22,this.inlinedPostProcess.filmic_B=.3,this.inlinedPostProcess.filmic_C=.1,this.inlinedPostProcess.filmic_D=.2,this.inlinedPostProcess.filmic_E=.01,this.inlinedPostProcess.filmic_F=.3,this.inlinedPostProcess.filmic_W=11.2,this.inlinedPostProcess.crushblacks=0,this.inlinedPostProcess.burnhighlights=0,this.inlinedPostProcess.saturation=1,this.inlinedPostProcess.colorCorrection={x:1,y:1,z:1}},this._enableClearScissor=!1,this.frameUBOArray=null,this.frameUBOBuffer=null,this.float32Matrix4x3Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[12]=e[12],t[13]=e[13],t[14]=e[14],this},this.float32Matrix4x4Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x4Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},this.float32Matrix3x3Temp=new Float32Array([1,0,0,0,1,0,0,0,1]),this.float32Matrix3x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},this._dummyTexture=e._createDummyTexture([0,0,0,255]),this._dummyMat3=new e.Matrix3,this._dummyMat4=new e.Matrix4;const o=this;this.forceCPUTBCompute=!1,this._clipPlanesState={uniforms:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:!0},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:!0},clipPlaneActive:{type:"iv4",value:[],clipPlanesUniform:!0},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:!0},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:!0},scissorSize:{type:"iv4",value:[0,0,0,0],clipPlanesUniform:!0},scissorPoints:{type:"t",value:null,clipPlanesUniform:!0},polygonSize:{type:"iv4",value:[0,0,0,0],clipPlanesUniform:!0},polygonPoints:{type:"t",value:null,clipPlanesUniform:!0},extrusionPlaneU:{type:"fv3",value:[0,0,1],clipPlanesUniform:!0},extrusionPlaneV:{type:"fv3",value:[1,0,0],clipPlanesUniform:!0},cylinderClipZone:{type:"i",value:0,clipPlanesUniform:!0},cylinderCenter:{type:"v3",value:null,clipPlanesUniform:!0},cylinderAxisU:{type:"v3",value:new e.Vector3(0,0,1),clipPlanesUniform:!0},cylinderAxisV:{type:"v3",value:new e.Vector3(1,0,0),clipPlanesUniform:!0}},version:-1,disabled:!1,update:function(t,i,r,n,s,a){if(r||t!==i||this.disabled&&n.enableClipPlanes){var l=t&&t.clipPlanes,h=o.clipPlanesEnabled?o.clipPlanes:[];l&&(h=l);var c,d,u,p=[];for(u=0;u<h.length&&p.length<6;u++)(d=(c=h[u])&&c.clippingContext&&c.clippingContext[o.id])&&d.clippingPlaneAdded&&p.push(c);var f=-1,g=t&&t.getClippingSettings();for(g&&0===g.frontOpacity&&(f=1),u=0;u<p.length;u++){var m,v=o.clipPlanesEnabled||l;m=s instanceof e.OrthographicCamera?-p[u].normal.dot(s.getLookAt()):p[u].distanceToPoint(s.position),p[u].enabled=v&&(0==o.disableBackFaceClipPlanes||f*m>0)}o.setupClipPlanes(null,p,s,t),o.refreshUniformsClipPlanes(this.uniforms,o._clipPlanes,n&&n.clipPlaneIndex,t,a),o.refreshUniformsClipPolyLine(this.uniforms,t?t.clipPolyLine:null,s,o.currentFrameIndex,o.maxNbPolyLine,t,a),t&&t.scissor&&"polyline"===t.scissor.type?o.refreshUniformsScissorPolyLine(this.uniforms,t.scissor,s,o.currentFrameIndex,o.maxNbScissor):o.refreshUniformsScissorPolyLine(this.uniforms,null),o.refreshUniformsClipCylinder(this.uniforms,t?t.getClipCylinder():null),this.disabled=!1,this.version++}else o.disabled||n.enableClipPlanes||(this.disabled=!0,o.refreshUniformsClipPlanes(this.uniforms,{length:0,eqs:[],states:[]},0))}},this.currentModelMatrix=null,this.currentCamera=null,this.currentVertexBuffer=null,this.currentIndexBuffer=null,this.programPool=null,this.programs_counter=0,this.lightsKey=0,this.lightsKeys=null,this.ambianceKey=0,this.currentGeometryGroupHash=null,this.currentMaterialId=-1,this.currentGASMatId=-1,this.currentMatAppId=-1,this.currentMaterialOverrideId=-1,this.lightsNeedUpdate=!0,this.tryCleanPrograms=!1,this.currentProgramID=-1,this.currentLayoutSignature=-1,this.usedTextureUnits=0,this.scene=null,this.currentScene=null,this.camera=null,this.currentSSRID=-1,this.cameraPosition=new e.Vector3,this.lowPartCameraPosition=new e.Vector3,this.frustum=new e.Frustum,this.resetLightInfos(),this.shadows={shadowMap:[],transparentShadowMap:[],shadowMapSizeDarknessBias:[],shadowMapNearFar:[],shadowMatrix:[],shadowCameraPosition:[],lowPartShadowCameraPosition:[],shadowMapCube:[],transparentShadowMapCube:[],shadowPointPosition:[],shadowCubeInfos:[]},this.currentInstanceAttribsId=-1,this.projScreenMatrix=new e.Matrix4,i.gpuStates?this.gpuStates=i.gpuStates:this.gpuStates={doubleSided:-1,flipSided:-1,orientation:1,blendEquation:-1,blendSrc:-1,blendDst:-1,depthTest:-1,depthFunc:-1,colorWrite:-1,depthWrite:-1,stencilTest:-1,stencilWrite:-1,polygonOffset:null,polygonOffsetFactor:null,polygonOffsetUnits:null,lineWidth:1,scissor:!1,scissorRect:{x:-1/0,y:-1/0,width:0,height:0},clearColor:void 0!==i.clearColor?new e.Color(i.clearColor):new e.Color(0),clearAlpha:void 0!==i.clearAlpha?i.clearAlpha:0,cullFace:e.CullFaceBack,frontFace:e.FrontFaceDirectionCCW},this.viewportData={viewportX:0,viewportY:0,viewportWidth:0,viewportHeight:0,viewportInvWidth:0,viewportInvHeight:0,viewportScale:1},this._clipPlanes={length:0,eqs:[],states:[],sectionLines:[],hasCapping:!1},this.rendererInfo={gpu:"Unknown",vendor:"Unknown",driver:"Unknown",backend:"Unknown",architecture:"Unknown"},this.fixedSizeArrayPool=new t,this.bufferGPUManager=n,this.bufferUtils=new v(this),this.bufferUtils.setInfo(this.info.memory),this.dummySSLRTexture=new e.DataTexture(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),2,2,e.RGBAFormat,e.UnsignedByteType),this.dummySSLRTexture.needsUpdate=!0,this.dummySSAOTexture=new e.DataTexture(new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]),2,2,e.RGBAFormat,e.UnsignedByteType),this.dummySSAOTexture.needsUpdate=!0,this.monoTransparDL=!1,this.newHLPOC=!1,this.visuFilterType=e._VisuFilterType,this.outlineGeomType=X._OUTLINE,this._pixelSize=new e.Vector2,this.objectsToGSSO=[],this.packESM=!1,this._gpuPickingTolerance=0,this._smallTargetPicking=0,this._heuristicNormalRadius=0,this.oitMode=I.None,this.oitMaxFragments=0,this.oitOpaqueDepth=null,this.oitLinkedListHeads=null,this.oitLinkedListElements=null,this.useSSLR=!1,this.useSSAO=!1,this.useSSAOIterative=!1,this.ssaoParams=null,this.useSSLRefraction=!1,this.precomputedTexture=null,this.boundaryEdgeMaterialInfo={color:new e.Color(255),enabled:!1},this.precomputedAreaTexture=null,this.materialToUse=e.MaterialToUse.originalMaterial,this._forbidRenderableState=0,this.shadowMapSoft=!1,this.gpuAntiAliasing=!1,this.forceMaterialDoubleSide=!0,this.cuttingScene=null,this.backupCuttingMaterial=null,this.cameraSystem_cameraIndex=-1,this.onTextureDispose=function(e){var t=e.target;t.removeEventListener("dispose",o.onTextureDispose),o.deallocateTexture(t),t.textures&&(t.usedTexture=-1),o.memoryInfo.textures--;var i=o&&o.__glResources__?o.__glResources__.texture.indexOf(t):-1;i>=0&&o.__glResources__.texture.splice(i,1)},this.onRenderTargetDispose=function(e){var t=e.target;t.removeEventListener("dispose",o.onRenderTargetDispose),o.deallocateRenderTarget(t),o.memoryInfo.renderTargets--;var i=o&&o.__glResources__?o.__glResources__.renderTarget:null;i&&i[t.uniqueID]&&delete i[t.uniqueID]},this.onMaterialDispose=function(e){var t=e.target;t.removeEventListener("dispose",o.onMaterialDispose);var i=null!==t.program?t.program.program:null;o.deallocateMaterial(t,i,!0)},this.deallocateTexture=function(e){if(!e._initialized)return;e._initialized=!1;let t=o.gl;if(this.use_webgpu)e._wgpuTexture&&e._wgpuTexture.destroy();else if(t)for(let i=0;i<e.__webglTexture.length;i++)t.deleteTexture(e.__webglTexture[i]);e.needsUpdate=!0},this.deallocateRenderTarget=function(t){let i=o.gl;if(t&&t.__webglTexture){for(let e=0;e<t.__webglTexture.length;e++)i.deleteTexture(t.__webglTexture[e]);if(t instanceof e.WebGLRenderTargetCube)for(var r=0;r<6;r++)i.deleteFramebuffer(t.__webglFramebuffer[r]),i.deleteRenderbuffer(t.__webglRenderbuffer[r]);else i.deleteFramebuffer(t.__webglFramebuffer),i.deleteRenderbuffer(t.__webglRenderbuffer)}},this.deallocateMaterial=function(e,t,i){if(null===t||null===o.programPool)return;if(i)return e.programManager.disposeAllPrograms(o.deallocateMaterial),void e._deallocate(o);const r=o.programPool.programs;for(var n=0;n<r.length;n++){var s=r[n];if(null!==s.program&&s.program.program===t){s.usedTimes--,s.program.clean(e),0===s.usedTimes&&(o.programPool.tryCleanPrograms=!0);break}}},this.result={dbgColor:0,totalCount:0,starts:[0,0],counts:[0,0]}}resetLightInfos(){this.lights={ambient:[0,0,0,0],directional:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[]},directionalIBL:{length:0,colors:[],positions:[]},directionalPhong:{length:0,colors:[],positions:[]},point:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[]},spot:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[],physicalAttenuations:[],directions:[]},sphere:{length:0,colors:[],positions:[]},rectangle:{length:0,colors:[],positions:[],normals:[],ups:[]},disk:{length:0,colors:[],positions:[],normals:[],ups:[]},tube:{length:0,colors:[],positions:[],rights:[]},ies:{length:0,colors:[],positions:[],distances:[],iesLightTexture:[],matrixWorldInv:[]}}}_initProgramPool(){this.context&&(this.programPool=Pe.get(this))}_buildSupportedExtensionsFromFeatures(){let t=this.supportedFeatures;e.supportedExtensions={},Object.assign(e.supportedExtensions,t)}paramThreeToGL(e){}_setWorldOrientation(e){this.baseLightDirection=e.upVector.clone()}initFrameUBO(){}updateFrameUBO(e){}readPixelCustom(e,t,i,r,n,s,a,o){}dispose(){for(var e=0;e<this.renderPluginsPre.length;e++)this.renderPluginsPre[e].dispose&&this.renderPluginsPre[e].dispose();for(e=0;e<this.renderPluginsPost.length;e++)this.renderPluginsPost[e].dispose&&this.renderPluginsPost[e].dispose();this.ambianceGenerators&&(this.ambianceGenerators=null),this.sssGenerator&&(this.sssGenerator=null),Pe.remove(this)&&this._clearProgramPool(),this.programPool=null,this.dummySSLRTexture.dispose(),this.dummySSAOTexture.dispose(),this.renderPluginsPre=[],this.renderPluginsPost=[],this.bufferGPUManager.dispose(this.id),ae.dispose(),oe.dispose(),this.fixedSizeArrayPool=null,this.getContext=null,this.divCSS3DRoot=null,this.canvas=null,this.__glResources__=null,this._viewer=null,this.context=null,this.currentCamera=null,this.currentVertexBuffer=null,this.currentIndexBuffer=null,this.bufferUtils.dispose()}clearCurrentBuffer(){this.currentVertexBuffer=null,this.currentIndexBuffer=null}setPickingPriorityMapping(t,i){if(t){t.sort((function(e,t){return e.priority<t.priority?-1:e.priority>t.priority?1:0}));for(var r={},n=null,s=0,a=0;a<t.length;a++){if((o=t[a]).priority>0){if(!n||n.priority!==o.priority)s++,(l=i.getDisplayListByName("PICKING_H"+s))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_H"+s,priority:-s,drawCallSort:xe.FrontToBackSort,side:E.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache());r[o.id]=l}else 0===o.priority&&(r[o.id]=null);n=o}n=null,s=0;for(a=t.length-1;a>=0;a--){var o;if((o=t[a]).priority<0){var l;if(!n||n.priority!==o.priority)s--,(l=i.getDisplayListByName("PICKING_L"+-s))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_L"+-s,priority:2048-s,drawCallSort:xe.FrontToBackSort,side:E.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache());r[o.id]=l}n=o}i._pickingPriorityMapping=r}else i._pickingPriorityMapping=null}setCurrentPass(e){this.currentPass=e}setDisableColorWrite(e){this.disableColorWrite=e}setDisableDepthWrite(e){this.disableDepthWrite=e}setDisableDepthTest(e){this.disableDepthTest=e}setEnableStencilWrite(e){this.enableStencilWrite=e}setDisableBackFaceCulling(e){this.disableBackFaceCulling=e}setFaceCulling(e,t=1){let i=this.gpuStates;i.orientation=0,i.flipSided=void 0,i.doubleSided=void 0,e!=this.cullings.NONE&&this.setFrontFace(t),this.setCullMode(e)}_hasClippingWithoutCapping(){return this.maxPolyLineSize>0?!this.useBackfaceCullingWithNoCapping&&!this.useCustomCappingForClipPolyline:this.useClippingCylinder&&this._clipPlanesState.value?!this.useBackfaceCullingWithNoCapping:!this.useBackfaceCullingWithNoCapping&&!(this.sectionCappingEnabled&&this._clipPlanes.hasCapping)&&this._clipPlanes.length>0}setMaterialFaces(e,t,i,r){var n=r&&3===t._bodyDim,s=e.side===E.BackSide,a=!n&&!s&&e.side!==E.FrontSide||this.disableBackFaceCulling,o=void 0!==t?t.orientation:1;void 0!==i&&(o*=i.orientation);let l=this.gpuStates;l.doubleSided!==a&&(a?this.setCullMode(this.cullings.NONE):this.setCullMode(this.cullings.BACK),l.doubleSided=a),l.flipSided===s&&l.orientation===o||(s?o>=0?this.setFrontFace(0):this.setFrontFace(1):o>=0?this.setFrontFace(1):this.setFrontFace(0),l.orientation=o,l.flipSided=s)}getDepthFunc(){return this.gpuStates.depthFunc}setDepthFunc(e){this.gpuStates.depthFunc=e}setDepthTest(e){this.gpuStates.depthTest=e}setStencilTest(e){this.gpuStates.stencilTest=e}setStencilFunc(e,t,i){this.gpuStates.stencilFunc=e,this.gpuStates.ref=t||0,this.gpuStates.mask=i||255}setStencilOp(e,t,i){this.gpuStates.stencilOp=[e,t,i],this.gpuStates.stencilOpFront=null,this.gpuStates.stencilOpBack=null}setStencilOpFront(e,t,i){this.gpuStates.stencilOpFront=[e,t,i]}setStencilOpBack(e,t,i){this.gpuStates.stencilOpBack=[e,t,i]}setColorWrite(e){}setDepthWrite(e){}setStencilWrite(e){}setFrontFace(e){this.gpuStates.frontFace=e}setCullMode(e){e===this.cullings.NONE?this.gpuStates.doubleSided=!0:this.gpuStates.doubleSided=!1,this.gpuStates.cullMode=e}setLineWidth(e){let t=this.gpuStates;null!=e&&e!==t.lineWidth&&(this.gl.lineWidth(e),t.lineWidth=e)}setPolygonOffset(e,t,i){}_setBlending(e,t,i,r,n,s,a){}setBlending(e,t,i,r){let n=this.gpuStates,s=!0,a=null,o=null,l=null,h=null,c=null,d=null;switch(e){case k.NoBlending:s=!1;break;case k.AdditiveBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.SRC_ALPHA,c=this.blendingFactors.ONE;break;case k.SubtractiveBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.ZERO,c=this.blendingFactors.ONE_MINUS_SRC;break;case k.MultiplyBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.ZERO,c=this.blendingFactors.SRC;break;case k.CustomBlending:break;case k.NormalDepthBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.ZERO,c=this.blendingFactors.ONE,o=this.blendingFuncs.ADD,h=this.blendingFactors.ONE,d=this.blendingFactors.ZERO;break;case k.AlphaBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.SRC_ALPHA,c=this.blendingFactors.ONE_MINUS_SRC_ALPHA;break;case k.GroundShadowBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.ZERO,c=this.blendingFactors.SRC,o=this.blendingFuncs.ADD,h=this.blendingFactors.ONE,d=this.blendingFactors.ONE_MINUS_SRC_ALPHA;break;case k.TransparentShadowBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.SRC_ALPHA,c=this.blendingFactors.ONE_MINUS_SRC_ALPHA,o=this.blendingFuncs.ADD,h=this.blendingFactors.ZERO,d=this.blendingFactors.ONE_MINUS_SRC_ALPHA;break;case k.OITAccumBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.ONE,c=this.blendingFactors.ONE;break;case k.OITRevealBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.ZERO,c=this.blendingFactors.ONE_MINUS_SRC;break;case k.PreMultipliedBlending:a=this.blendingFuncs.ADD,l=this.blendingFactors.ONE,c=this.blendingFactors.ONE_MINUS_SRC_ALPHA;break;default:a=this.blendingFuncs.ADD,l=this.blendingFactors.SRC_ALPHA,c=this.blendingFactors.ONE_MINUS_SRC_ALPHA,o=this.blendingFuncs.ADD,h=this.blendingFactors.ONE,d=this.blendingFactors.ONE_MINUS_SRC_ALPHA}let u=!1;e!==n.blending&&(n.blending=e,u=!0),e===k.CustomBlending?(a=null!==t?t:this.blendingFuncs.ADD,l=null!==i?i:this.blendingFactors.SRC_ALPHA,c=null!==r?r:this.blendingFactors.ONE_MINUS_SRC_ALPHA,a!==n.blendEquation&&(n.blendEquation=a,u=!0),l===n.blendSrc&&c===n.blendDst||(n.blendSrc=l,n.blendDst=c,u=!0)):(n.blendEquation=null,n.blendSrc=null,n.blendDst=null),u&&this._setBlending(s,a,l,c,o,h,d)}generateDefines(e){var t,i,r=[];for(var n in e)!1!==(t=e[n])&&(i="#define "+n+" "+t,r.push(i));return r.join("\n")}_setShaderUtilsContext(e=null,t=null,i=null,r=null,n=null,s=null){var a={isWebGPU:e&&e.WebGPU,__features__:e,__uniforms__:t,__attributes__:i,__customAttributes__:{},__varyings__:r,__builtins__:n,__functions__:s,__fetchedUniforms__:t?{}:null};return b._context=a,S._context=a,y._context=a,x.FunctionHandler._context=a,x.BridgeFunctions._context=a,_._context=a,a}buildProgram(t,i,r,n,a,o){let l=this.materialToUseList,h=this.gl,c=this.supportedFeatures;var d,u,p="",f="",g={},m={},v={},x=i.defines||{};null===t&&(p=i.fragmentShader,f=i.vertexShader,g=i.uniforms,m=i.varyings,v=i.attributes,x=i.defines,u=[p,f].join());var w=r.WebGPU&&"POINTS"===i.targetPrimitiveType?{input:{vertexIndex:!0}}:{},P="SHADOWMAP_TYPE_BASIC";r.shadowMapType===e.PCFShadowMap?P="SHADOWMAP_TYPE_PCF":r.shadowMapType===e.PCFSoftShadowMap?P="SHADOWMAP_TYPE_PCF_SOFT":r.shadowMapType===e.PCFInterpolShadowMap?P="SHADOWMAP_TYPE_PCF_INTERPOL":r.shadowMapType===e.PCFPoissonShadowMap?P="SHADOWMAP_TYPE_PCF_POISSON":r.shadowMapType===e.PCFOptimizedShadowMap?P="SHADOWMAP_TYPE_PCF_OPTI":r.shadowMapType===e.ESMShadowMap?P="SHADOWMAP_TYPE_ESM":r.shadowMapType===e.ESMImprovedShadowMap&&(P="SHADOWMAP_TYPE_ESM_IMPROVED");var C="SHADOWMAP_QUALITY_LOW";r.shadowMapQuality===e.MediumQuality?C="SHADOWMAP_QUALITY_MEDIUM":r.shadowMapQuality===e.HighQuality&&(C="SHADOWMAP_QUALITY_HIGH"),r.shadowMapTypeDefine=P,r.shadowMapQualityDefine=C,r.useMRT=!!c.drawBuffers||r.WebGPU;var M=this.generateDefines(x);r.customDefines=x,Z(r);var E={WebGL:!!r.WebGL,WebGLVersion:r.WebGLVersion>=0?r.WebGLVersion:-1,WebGPU:!!r.WebGPU,Linux:!!r.Linux,vertexTextures:c.supportsVertexTextures,renderToFloatTexture:c.renderToFloatTexture,renderToHalfFloatTexture:c.renderToHalfFloatTexture,maxTextureSize:c.maxTextureSize.toFixed(1),fragDepth:c.fragDepth,extTextureLODs:c.textureLODs,drawBuffers:c.drawBuffers,depthBits:c.depthBits,multiDraw:c.multiDraw};let T=this._setShaderUtilsContext(E,g,v,m,w,new Map,null);var A="",D="",I=!1,R=null;if(r.PDSFX){var O={pixelLineDistance:!!r.cpuPattern,worldSizePattern:!!r.worldSizePattern,wideLine:!!r.wideLine,gammaOutput:r.gammaOutput,gammaInput:r.gammaInput,simpleGamma:r.simpleGamma,extDerivatives:r.extDerivatives,extFragDepth:r.extFragDepth,fixedSize:r.fixedSize,billboard:r.billboard,highlightMaterial:l.highlightMaterial};Object.assign(O,E);const Se=e=>r.WebGPU&&0===i.__dimension?b.addPDSFXCustomAttribute(e):b.addPDSFXAttribute(e),be=e=>r.WebGPU&&0===i.__dimension?(console.error(`Pdsfx custom accessor ${e.attributeName} is not available with instancing`),""):b.addPDSFXInstancingAttribute(e);var L;R=(L=i._PDSFXData)._uniqueID,$._initContext(r.customDefines,O,r),Q._initContext(r.customDefines,O,r);var B="",F="",V="";if(L.pdsfxUniforms){var G=L.pdsfxUniforms;for(var N in G){var U=G[N],k=e.ToGLSLTypes[U.type];if(k){var z=`\n                    ${_.addPDSFXUniform({uniformName:N,uniformType:U.type,size:U.length?U.length:0})}            \n                `;k.isInt?U.stage===ue?V=`\n                            ${V}\n                            ${z}\n                        `:F=`\n                            ${F}\n                            ${z}\n                        `:B=`\n                        ${B}\n                        ${z}\n                    `}}}var H="";if(L.pdsfxVaryings){var W=L.pdsfxVaryings;for(var j in W){var X=W[j];H=`\n                    ${H}\n                    ${y.addVarying({varyingName:"_IPCV"+j,varyingType:X.type,varyingInterpolationType:X.interpolationType,size:X.length?X.length:0,checkName:!1,pdsfx:!0})}\n                `}}var q="";if(L.pdsfxAttributes){var Y=L.pdsfxAttributes;for(var K in Y){q=`\n                            ${q}\n                            ${(ee=Y[K]).instancing?be({attributeName:K,attributeType:ee.type,geomLayoutGPU:o}):Se({attributeName:K,attributeType:ee.type,geomLayoutGPU:o})}\n                        `}}if(L.pdsfxAttributesInternal){var J=L.pdsfxAttributesInternal;for(var K in J){var ee;q=`\n                            ${q}\n                            ${(ee=J[K]).instancing?be({attributeName:K,attributeType:ee.type,geomLayoutGPU:o}):Se({attributeName:K,attributeType:ee.type,geomLayoutGPU:o})}\n                        `}}var te=s.PDSFX_common_pars(r),ie=te,re=L._getGlobalVertexCode(Q);I=re.includes("attribute ");var ne=[q,H,B,F,te,s.PDSFX_getters_vertex(r),re,`           \n                ${S.createStruct({structName:"TangentSpace",attributes:[{type:"v3",name:"Position"},{type:"v3",name:"Normal"},{type:"v3",name:"Tangent"},{type:"v3",name:"Binormal"}]})}\n                `,L._getPDSFXOverridableFunctions_VS(Q)].join("\n");ne=e.SplitTrimStickString(ne);var se=L._getGlobalFragmentCode($);r.pdsfxUseDiscard=L.PDSFX_OverridableFunctions_FS.ComputeDiscard&&L.PDSFX_OverridableFunctions_FS.ComputeDiscard!==s.PDSFXComputeDiscard_FS;var ae=[H,B,V,ie,s.PDSFX_getters_fragment(r),se,L._getPDSFXOverridableFunctions_FS($)].join("\n");if(ae=e.SplitTrimStickString(ae),!r.pdsfxShaderBuilderUsed){if(r.largeScale){var oe="vGetWorldViewMatrix",le=[...ne.matchAll(oe)],he=[...ae.matchAll(oe)];(le&&le.length>1||he&&he.length>1)&&(r.largeScale=!1)}function xe(e,t){var i=[...ne.matchAll(e)];i&&i.length>1&&(r[t]=!0)}function we(e,t){var i=[...ae.matchAll(e)];i&&i.length>1&&(r[t]=!0)}r.useUV||xe("vGetAttribTexCoord0","useUV"),r.pdsfxUseUv2||(xe("vGetAttribTexCoord1","pdsfxUseUv2"),r.useUV|=!!r.pdsfxUseUv2),r.pdsfxUseUv3||(xe("vGetAttribTexCoord2","pdsfxUseUv3"),r.useUV|=!!r.pdsfxUseUv3),r.pdsfxUseTangentBinormal||xe("vGetAttribTangent","pdsfxUseTangentBinormal"),r.pdsfxUseTangentBinormal||xe("vGetAttribBinormal","pdsfxUseTangentBinormal"),r.pdsfxUseVertexColors||xe("vGetAttribColor","pdsfxUseVertexColors"),r.pdsfxUseVertexColors||xe("vGetAttribColorAlpha","pdsfxUseVertexColors"),r.useUV||we("vGetTexCoord0","useUV"),r.pdsfxUseUv2||(we("vGetTexCoord1","pdsfxUseUv2"),r.useUV|=!!r.pdsfxUseUv2),r.pdsfxUseUv3||(we("vGetTexCoord2","pdsfxUseUv3"),r.useUV|=!!r.pdsfxUseUv3),r.pdsfxUseMappedUv||(we("vGetMappingOperatorTexCoord0","pdsfxUseMappedUv"),r.useUV|=!!r.pdsfxUseMappedUv),r.pdsfxUseMappedUv2||(we("vGetMappingOperatorTexCoord1","pdsfxUseMappedUv2"),r.pdsfxUseUv2=!!r.pdsfxUseUv2||!!r.pdsfxUseMappedUv2,r.useUV|=!!r.pdsfxUseMappedUv2),r.pdsfxUseMappedUv3||(we("vGetMappingOperatorTexCoord2","pdsfxUseMappedUv3"),r.pdsfxUseUv3=!!r.pdsfxUseUv3||!!r.pdsfxUseMappedUv3,r.useUV|=!!r.pdsfxUseMappedUv3),r.pdsfxUseTangentBinormal||we("vGetViewTangent","pdsfxUseTangentBinormal"),r.pdsfxUseTangentBinormal||we("vGetViewBinormal","pdsfxUseTangentBinormal"),r.pdsfxUseFragDepth||we("vSetFragDepth","pdsfxUseFragDepth")}r.pdsfxUseMappedUv=!1,r.pdsfxUseMappedUv2=!1,r.pdsfxUseMappedUv3=!1,$.dispose(),Q.dispose(),A=ne,D=ae}var pe=t;"custom"===t?pe=t+"_"+i.postProBuilder.getUniqueID():null===t&&(I=!0);var fe=[2===E.WebGLVersion?"#version 300 es":"",2===E.WebGLVersion?"#define GLSL300ES":"",E.multiDraw?"#extension GL_ANGLE_multi_draw : enable":"",1===E.WebGLVersion&&r.extTextureLODs?"#extension GL_EXT_shader_texture_lod: enable":"","precision "+this.precision+" float;","precision "+this.precisionInt+" int;",M,E.vertexTextures?"#define VERTEX_TEXTURES":"",E.renderToFloatTexture?"#define RENDER_TO_FLOAT_TEXTURE":"",E.renderToHalfFloatTexture?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"",ce(r),S.float({name:"MAX_TEXTURE_SIZE",constant:!0})+"="+E.maxTextureSize+";"].join("\n"),ge=[2===E.WebGLVersion?"#version 300 es":"",2===E.WebGLVersion?"#define GLSL300ES":"",E.fragDepth&&1===E.WebGLVersion?"#extension GL_EXT_frag_depth : enable":"",1===E.WebGLVersion?"#extension  GL_OES_standard_derivatives : enable":"",1===E.WebGLVersion&&r.extTextureLODs?"#extension GL_EXT_shader_texture_lod: enable":"",E.drawBuffers?"#extension GL_EXT_draw_buffers : require":"",E.multiDraw?"#extension GL_ANGLE_multi_draw : enable":"",E.renderToFloatTexture?"#define RENDER_TO_FLOAT_TEXTURE":"",E.renderToHalfFloatTexture?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"","precision "+this.precision+" float;","precision "+this.precisionInt+" int;",M,de(r),S.float({name:"DEPTH_PRECISION",constant:!0})+"="+E.depthBits+";",S.float({name:"MAX_TEXTURE_SIZE",constant:!0})+"="+E.maxTextureSize+";"].join("\n");let me=n&&n._layoutKey;const ve=this.programPool.programs;for(L=0,d=ve.length;L<d;L++){var _e=ve[L];if(_e.contextID===(h?h.contextId:0)&&_e.program._materialToUse===r.materialToUse&&_e.program.shaderID===pe&&_e.pdsfx===r.PDSFX&&_e.program.pdsfx_uniqueID===R&&_e.code===u&&_e.prefix_vertex===fe&&_e.prefix_fragment===ge&&(R||_e.pdsfx_fragment===D&&_e.pdsfx_vertex===A)&&(!this.use_webgpu||_e.program.layoutSignature===me))return _e.usedTimes<=0&&(_e.program.id=this.programs_counter++),_e.usedTimes++,_e.program}var ye=this.createProgramObject();return ye._lightsKey=this.lightsKey,ye._ambianceKey=this.ambianceKey,ye._materialToUse=r.materialToUse,ye.shaderID=pe,ye.pdsfx_uniqueID=R,ye.layoutSignature=me,ye.id=this.programs_counter++,this.buildShader(i,t,r,ye,f,p,fe,ge,A,D,n,a,I,T,o),ve.push({program:ye,code:u,usedTimes:1,prefix_vertex:fe,prefix_fragment:ge,pdsfx_fragment:D,pdsfx_vertex:A,pdsfx:r.PDSFX,contextID:h?h.contextId:0}),this.memoryInfo.programs=ve.length,ye}createProgramObject(){}createGSSOCache(e){}addLineNumbers(e){for(var t=e.split("\n"),i=0,r=t.length;i<r;i++)t[i]=i+1+": "+t[i];return t.join("\n")}isPowerOfTwo(e){return 0==(e&e-1)}setRenderTarget(t){let i=this.viewportData;var r,n,s,a;t?this.RTTmatchViewport?(r=i.viewportWidth,n=i.viewportHeight,s=i.viewportX,a=i.viewportY):(r=t.width,n=t.height,s=0,a=0):(r=i.viewportWidth,n=i.viewportHeight,s=i.viewportX,a=i.viewportY),e.glStates.currentWidth===r&&e.glStates.currentHeight===n&&e.glStates.currentXOffset===s&&e.glStates.currentYOffset===a||(this.gl&&this.gl.viewport(s,a,r,n),this.gl&&this.gl.scissor(s,a,r,n),e.glStates.currentWidth=r,e.glStates.currentHeight=n,e.glStates.currentXOffset=s,e.glStates.currentYOffset=a,this.setScissor(s,a,r,n))}updateRenderTargetMipmap(t){let i=this.gl;if(t instanceof e.WebGLRenderTargetCube){for(let e=0;e<t.__webglTexture.length;e++)i.bindTexture(i.TEXTURE_CUBE_MAP,t.__webglTexture[e]),i.generateMipmap(i.TEXTURE_CUBE_MAP);i.bindTexture(i.TEXTURE_CUBE_MAP,null)}else{for(let e=0;e<t.__webglTexture.length;e++)i.bindTexture(i.TEXTURE_2D,t.__webglTexture[e]),i.generateMipmap(i.TEXTURE_2D);i.bindTexture(i.TEXTURE_2D,null)}}allocateLights(e){var t,i,r,n={dirLights:0,dirIBLLights:0,dirPhongLights:0,pointLights:0,spotLights:0,sphereLights:0,rectangleLights:0,iesLights:0,tubeLights:0,diskLights:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).onlyShadow||r.allocate(n);return{directional:n.dirLights,directionalIBL:n.dirIBLLights,directionalPhong:n.dirPhongLights,point:n.pointLights,spot:n.spotLights,sphere:n.sphereLights,rectangle:n.rectangleLights,ies:n.iesLights,tube:n.tubeLights,disk:n.diskLights}}allocateShadows(e){var t,i,r,n={dirLight:0,dirIBLLight:0,spotLight:0,tex2d:0,texCube:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).castShadow&&r.allocateShadows(this,n);return n}getSupportedExtensions(){return e.supportedExtensions}loadUniformsGeneric(e,t){}restoreGLContext(){}getContext(){return this.gl}supportsVertexTextures(){return this.supportedFeatures.supportsVertexTextures}supportsFloatTextures(){let e=this.supportedFeatures;return e.textureFloat&&(e.colorBufferFloat||e.renderToFloatTexture)}supportsFloatRGBTextures(){let e=this.supportedFeatures;return this.supportsFloatTextures()&&e.renderToFloatRGBTexture}supportsHalfFloatTextures(){let e=this.supportedFeatures;return e.textureHalfFloat&&(e.colorBufferHalfFloat||e.renderToHalfFloatTexture)}supportsHalfFloatRGBTextures(){let e=this.supportedFeatures;return this.supportsHalfFloatTextures()&&e.renderToHalfFloatRGBTexture}getRendererInfo(){return this.rendererInfo}supportsFloatLinearTextures(){return this.supportedFeatures.textureFloatLinear}supportsHalfFloatLinearTextures(){return this.supportedFeatures.textureHalfFloatLinear}supportsStandardDerivatives(){return this.supportedFeatures.standardDerivatives}supportsCompressedTextureS3TC(){return this.supportedFeatures.compressedTextureS3TC}supportsMinMaxBlending(){return this.supportedFeatures.blendMinMax}supportsElementIndexUint(){return this.supportedFeatures.elementIndexUint||2===e.WebGLVersion}supportsDrawBuffers(){return this.supportedFeatures.drawBuffers}getMaxAnisotropy(){return this.supportedFeatures.maxAnisotropy}getPrecision(){return this.precision}setGLSize(t,i,r,n,s,a){this.devicePixelRatio=this._renderScale*(e.getDevicePixelRatio()||1),this.canvas.width=Math.floor(t*this.devicePixelRatio),this.canvas.height=Math.floor(i*this.devicePixelRatio),this._VRCompatible?(this.canvas.style.width="100%",this.canvas.style.height="100%"):(this.canvas.style.width=s+"px",this.canvas.style.height=a+"px"),this.setViewport(0,0,Math.floor(r*this.devicePixelRatio),Math.floor(n*this.devicePixelRatio)),this.width=t,this.height=i,this.widthHalf=this.width/2,this.heightHalf=this.height/2,this.divCSS3DRoot.style.width=t+"px",this.divCSS3DRoot.style.height=i+"px";for(var o=0;o<this.divCSS3DRoot.childNodes.length;o++){var l=this.divCSS3DRoot.childNodes[o];l.style.width=t+"px",l.style.height=i+"px"}}setViewport(t,i,r,n){let s=this.viewportData;s.viewportX=void 0!==t?t:0,s.viewportY=void 0!==i?i:0,s.viewportWidth=void 0!==r?r:this.canvas.width,s.viewportHeight=void 0!==n?n:this.canvas.height;let a=!1;return e.glStates.currentXOffset===s.viewportX&&e.glStates.currentYOffset===s.viewportY&&e.glStates.currentWidth===s.viewportWidth&&e.glStates.currentHeight===s.viewportHeight||(this.gl&&this.gl.viewport(s.viewportX,s.viewportY,s.viewportWidth,s.viewportHeight),a=!0),e.glStates.currentWidth=s.viewportWidth,e.glStates.currentHeight=s.viewportHeight,e.glStates.currentXOffset=s.viewportX,e.glStates.currentYOffset=s.viewportY,s.viewportInvWidth=1/s.viewportWidth,s.viewportInvHeight=1/s.viewportHeight,a}removeSplitScreenMode(){this.splitScreenMode&&(this.activateSplitScreenMode(!1),this.splitScreenMode=null)}setSplitScreenMode(e,t){this.splitScreenMode={x:e,y:t,active:!1},this.activateSplitScreenMode(!0)}activateSplitScreenMode(e){let t=this.viewportData;this.splitScreenMode&&e!==this.splitScreenMode.active&&(e?(this.setScissor(this.splitScreenMode.x,this.splitScreenMode.y,t.viewportWidth,t.viewportHeight),this.enableScissorTest(!0),this.setViewport(this.splitScreenMode.x,this.splitScreenMode.y,t.viewportWidth,t.viewportHeight)):(this.enableScissorTest(!1),this.setViewport(0,0,t.viewportWidth,t.viewportHeight)),this.splitScreenMode.active=!!e)}getViewportSize(){let e=this.viewportData;return{width:e.viewportWidth,height:e.viewportHeight}}getViewport(){let e=this.viewportData;return{width:e.viewportWidth,height:e.viewportHeight,x:e.viewportX,y:e.viewportY}}setScissor(e,t,i,r){let n=this.gpuStates;n.scissorRect.x=e,n.scissorRect.y=t,n.scissorRect.width=i,n.scissorRect.height=r}enableScissorTest(e){this.gpuStates.scissor=e}getScissorTest(){return this.gpuStates.scissor}setClearColor(e,t){let i=this.gpuStates;i.clearColor.copy(e),i.clearAlpha=t}setClearDepth(e){this.gpuStates.clearDepth=e}setClearStencil(e){this.gpuStates.clearStencil=e}getClearColor(){return this.gpuStates.clearColor}getClearAlpha(){return this.gpuStates.clearAlpha}clear(e,t,i){}clearTarget(e,t,i,r){this.setRenderTarget(e),this.clear(t,i,r)}_getReflectionColorBufferResult(e){return this.reflectionColorBuffer&&!e?this.reflectionColorBuffer.getResult("RayMarching"):this.dummySSLRTexture}_getRefractionColorBufferResult(e){return this.refractionColorBuffer&&!e?this.refractionColorBuffer.getResult("RayMarching"):this.dummySSLRTexture}_getAOBufferResult(e){return this.aoBuffer&&!e?this.aoBuffer.getResult("SSAO"):this.dummySSAOTexture}addPostPlugin(e){e.init(this),this.renderPluginsPost.push(e)}addPrePlugin(e){e.init(this),this.renderPluginsPre.push(e)}updateShadowMap(e,t){let i=this.gpuStates;this.currentProgram.program=null,i.blending=-1,i.depthTest=-1,i.colorWrite=-1,i.depthWrite=-1,this.currentGeometryGroupHash=-1,this.currentVertexBuffer=null,this.currentIndexBuffer=null,this.currentMaterialId=-1,this.currentGASMatId=-1,this.currentMatAppId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0,i.doubleSided=-1,i.flipSided=-1,this.shadowMapPlugin.update(e,t)}epsilon(e){return Math.abs(e)<1e-6?0:e}getCameraCSSMatrix(e){var t=e.elements;return"matrix3d("+this.epsilon(t[0])+","+this.epsilon(-t[1])+","+this.epsilon(t[2])+","+this.epsilon(t[3])+","+this.epsilon(t[4])+","+this.epsilon(-t[5])+","+this.epsilon(t[6])+","+this.epsilon(t[7])+","+this.epsilon(t[8])+","+this.epsilon(-t[9])+","+this.epsilon(t[10])+","+this.epsilon(t[11])+","+this.epsilon(t[12])+","+this.epsilon(-t[13])+","+this.epsilon(t[14])+","+this.epsilon(t[15])+")"}getObjectCSSMatrix(e){var t=e.elements;return"translate3d(-50%,-50%,0) matrix3d("+this.epsilon(t[0])+","+this.epsilon(t[1])+","+this.epsilon(t[2])+","+this.epsilon(t[3])+","+this.epsilon(-t[4])+","+this.epsilon(-t[5])+","+this.epsilon(-t[6])+","+this.epsilon(-t[7])+","+this.epsilon(t[8])+","+this.epsilon(t[9])+","+this.epsilon(t[10])+","+this.epsilon(t[11])+","+this.epsilon(t[12])+","+this.epsilon(t[13])+","+this.epsilon(t[14])+","+this.epsilon(t[15])+")"}_cleanProgramPool(e){const t=this.programPool;if(e&&t.tryCleanPrograms){if(t.programs.filter((e=>e.usedTimes<=0||null===e.program)).length>0){for(var i=[],r=0;r<t.programs.length;r++){var n=t.programs[r];null!==n.program&&(n.usedTimes<=0?(n.program.delete(this),this&&this.memoryInfo.programs--):i.push(n))}t.programs=i}return t.tryCleanPrograms=!1,!0}return!1}_clearProgramPool(){var e=this.programPool.programs;if(e.length>0){for(var t=0;t<e.length;t++){e[t].program.delete(this),this&&this.memoryInfo.programs--}this.programPool.programs=[]}}initSharedBuffersDS(e,t){}renderBufferDirect(t,i,r,n,s){if(!1===r.visible)return;let a=this.gl;var o,l,h,c,d,u,p,f=!1;l=(o=this.setProgramWithUniforms(t,i,r,s,null,n,null,r.programManager.getProgramID(s,null),null,null,this.materialToUse,null)).attributes,h=n.attributes;var g=!1,m=r.wireframe?1:0,v=16777215*n.id+2*o.id+m;if(v!==this.currentGeometryGroupHash&&(this.currentGeometryGroupHash=v,g=!0),g&&this.disableAttributes(),s instanceof e.Mesh){var _=h.index;if(_){var y=n.offsets;y.length>1&&(g=!0);for(var S=0,b=y.length;S<b;S++){var x=y[S].index;if(g){for(d in h)"index"!==d&&(u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,x*p*4)));a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,_.buffer)}a.drawElements(R.TRIANGLES,y[S].count,a.UNSIGNED_SHORT,2*y[S].start),this.currentRenderInfo.calls++,this.currentRenderInfo.vertices+=y[S].count,this.currentRenderInfo.faces+=y[S].count/3,f=!0}}else{if(g)for(d in h)"index"!==d&&(u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,0)));var w=n.attributes.position;a.drawArrays(R.TRIANGLES,0,w.numItems/3),f=!0,this.currentRenderInfo.calls++,this.currentRenderInfo.vertices+=w.numItems/3,this.currentRenderInfo.faces+=w.numItems/3/3}}else if(s instanceof e.ParticleSystem){if(g){for(d in h)u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,0));w=h.position;a.drawArrays(a.POINTS,0,w.numItems/3),f=!0,this.currentRenderInfo.calls++,this.currentRenderInfo.points+=w.numItems/3}}else if(s instanceof e.Line&&g){for(d in h)u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,0));this.setLineWidth(r.lineWidth);w=h.position;a.drawArrays(R.LINE_STRIP,0,w.numItems/3),f=!0,this.currentRenderInfo.calls++,this.currentRenderInfo.points+=w.numItems}return f}getRenderMode(t=null,i=!1){let r=this.materialToUseList;var n=e.RenderMode;H||(H=new n);var s=e.PickingMode;W||(W=new s);var a=this.renderLineMode||0,o=this.renderPointMode||0,l=this.renderFaceMode,h=this.outlineWidth,c=this.halfVisibleSmoothEdges?1:0,d=this.renderHiddenEdges?1:0;let u=!1;var p=H;if(t){var f=null,g=t._occurrence;if(g){var m=g.renderMode;if(m){if(m._repViewNothing&&(u=!0),h=m._outlineWidth,m._halfVisibleSmoothEdges>-1&&(c=m._halfVisibleSmoothEdges),m._hiddenEdges>-1&&(d=m._hiddenEdges),m._hasReplaceMask&&m._hasReplaceMask()){H._setFromMasks(o,a,l);var v=new n;v._setReplace(H,m),m=v}m._useRenderLineMask&&(a=m.getMasks()[1]),m._useRenderPointMask&&(o=m.getMasks()[2]),m._useRenderFaceMask&&(l=m.getMasks()[0])}f=g.pickingMode}i||!r.highlightMaterial&&!r.pickingPassMaterial||(f||(f=W)._fromRenderer(this),p._setFromMasks(o,a,l),[l,a,o]=f.getPickingMasks(p),r.normalMaterial&&(a&=~T,o&=~A),r.highlightMaterial&&(l|=X.FACE))}return p.setRepViewNothing(u),p._setFromMasks(o,a,l),p.setOutlineWidth(h),p.setHalfVisibleSmoothEdges(c),p.setHiddenEdges(d),p}getMaterialMode(e=null,t=null,i=!1){if(e){if(e._occurrence&&null!==e._occurrence.faceMode)return e._occurrence.faceMode.material;if(e.materialMode<2)return!!e.materialMode}var r=!1;return null!==t&&(r=!t.areFacesVisible()),!i&&(this.materialMode&&!r)}getRenderLineMode(e){var t=e&&e._occurrence&&e._occurrence.renderMode;return t&&t._useRenderLineMask?t.getMasks()[1]:this.renderLineMode}recompileAllShaders(e){e=e||_e;for(var t=0;t<e.length;t++)this.shaderVersions[e[t]]++}setupPickingMaterial(e,t,i){var r=i.pickingID>>16&255,n=(i.pickingID>>8&255)/255,s=(255&i.pickingID)/255;if(t==R.LINES||e&&e.lineWidth){r|=64}else if(t==R.TRIANGLES||null==t){r|=128}return B.setRGB(r/255,n,s),B}enableAttributes(e){let t=this.gl;if(t){for(var i in e)t._enabledAttributes[i]||(t.enableVertexAttribArray(i),t._enabledAttributes[i]=!0);for(var i in t._enabledAttributes)t._enabledAttributes[i]&&!e[i]&&(t.disableVertexAttribArray(i),t._enabledAttributes[i]=!1)}}_cullDGSSB(e,t,i,r,n,s,a,o,l){let h=r.glType;if(!r.cullingData||e.isOrtho||0===h)return null;const c=this.currentRenderInfo;c.nbDGsSSBProcessed++;let d=r.cullingData.repArraysToCull,u=this.result;if(u.totalCount=0,null!==o)for(let r=0;r<o.length;r++){let n=o[r],s=a[r],l=o[r];n=e.performPixelCullingOnDG(t,i,d[r],s,l),h===R.TRIANGLES?c.culledDGTriangles+=(l-n)/3:h===R.LINES&&(c.culledDGLines+=(l-n)/2),u.totalCount+=n,u.starts[r]=s,u.counts[r]=n}else{let r=s;r=e.performPixelCullingOnDG(t,i,d[l.cullingDataId],n,s),h===R.TRIANGLES?c.culledDGTriangles+=(s-r)/3:h===R.LINES&&(c.culledDGLines+=(s-r)/2),u.totalCount+=r,u.starts[0]=n,u.counts[0]=r}return u}_renderInterval_lastMinuteBufferHandling(e,t,i,r,n,s,a){let o=this.gl;var l=r?r.getInstanceInfos():null,h=l?l.instanceAttribArrays:null,c=null!==h,d=t.vertexBufferGPU,u=t.indexBufferGPU,p=!1,f=!1;if(this.bufferGPUManager.__fake&&e.fromLoadedModel)d=null,u=null;else{l&&(this.bufferGPUManager.deallocate(l.staleGLBuffers),l.staleGLBuffers=[],c||(i._instancingInfos?i._instancingInfos=null:e._instancingInfos&&(e._instancingInfos=null))),t.needsUpdate&&(t.needsUpdate=!1,t.deallocate(o,this.info),p=!0);var g=(n&&n._mappingOperator?n._mappingOperator.mappingType:s.mappingType)<1;!(a&&a.uvOrBinOrTan&&g)||t.compressedNormals||t.vertexBufferGPU&&t.vertexBufferGPU.layout.has("uv")||(t.vertexIndexArray?(t.computeUVs(),t.deallocate(o,this.info),p=!0):this._NoMeshInRamWarningCount<1&&(console.warn("uv computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++));var m=g&&(s.requireVertexTangentBinormal()||this.forceCPUTBCompute);if(t.vertexBufferGPU?!(m&&t.vertexBufferGPU.layout.has("uv")&&t.vertexBufferGPU.layout.has("normal"))||t.vertexBufferGPU.layout.has("binormal")&&t.vertexBufferGPU.layout.has("tangent")||(t.vertexIndexArray?(t.computeTangents(),t.deallocate(o,this.info),p=!0):this._NoMeshInRamWarningCount<2&&(console.warn("tangent binormal computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++)):!(t.vertexUvArray&&t.vertexNormalArray&&m)||t.vertexBinormalArray&&t.vertexTangentArray||(t.computeTangents(),t.deallocate(o,this.info),p=!0),d&&u||(p=!0),p){let e=this.use_webgpu?GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST:0;this.bufferGPUManager.allocateDirect(t,e,e),d=t.vertexBufferGPU,u=t.indexBufferGPU}if(c)for(var v in this.currentInstanceAttribsId!==l.instanceAttribArrays_id&&(this.currentInstanceAttribsId=l.instanceAttribArrays_id,f=!0),h){const t=h[v];if(!t.buffer){this.bufferGPUManager.allocateInstancingBuffers(e,i);break}t.isDynamic&&this.bufferGPUManager.updateInstancingAttributeBuffer(e,i,t)}}be.vertexBuffer=d,be.indexBuffer=u,be.updateBuffers=f,be.instanceAttribArrays=h}renderInterval(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m){return!1}renderSectionLines(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f){var g=0;for(g=0;g<this._clipPlanes.length;g++)if(this._clipPlanes.sectionLines[g]){var m=r.program;r.clipPlaneIndex=g+1,m&&m.program===this.currentProgram.program&&this.gl.uniform1i(m.pdsfxUniformLocations.currentClipPlane,g),this._clipPlanesState.update(l,null,!0,r,e,!0),this.renderInterval.apply(this,arguments)}r.clipPlaneIndex=0,this._clipPlanesState.update(l,null,!0,r,e,!1)}renderBuffer(t,i,r,n,s,a){if(!1===r.visible)return!1;let o=this.gl;var l,h,c,d,u,p;h=(l=this.setProgramWithUniforms(t,i,r,s,a,null,null,r.programManager.getProgramID(s,null),null,null,this.materialToUse,null)).attributes;var f=!1,g=r.wireframe?1:0,m=16777215*n.id+2*l.id+g;if(m!==this.currentGeometryGroupHash&&(this.currentGeometryGroupHash=m,f=!0),f&&this.disableAttributes(),!r.morphTargets&&h.position>=0?f&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglVertexBuffer),this.enableAttribute(h.position),o.vertexAttribPointer(h.position,3,o.FLOAT,!1,0,0)):s.morphTargetBase&&this.setupMorphTargets(r,n,s),f){if(n.__webglCustomAttributesList)for(u=0,p=n.__webglCustomAttributesList.length;u<p;u++)h[(d=n.__webglCustomAttributesList[u]).buffer.belongsToAttribute]>=0&&(o.bindBuffer(o.ARRAY_BUFFER,d.buffer),this.enableAttribute(h[d.buffer.belongsToAttribute]),o.vertexAttribPointer(h[d.buffer.belongsToAttribute],d.size,o.FLOAT,!1,0,0));h.color>=0&&n.__colorArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglColorBuffer),this.enableAttribute(h.color),o.vertexAttribPointer(h.color,3,o.FLOAT,!1,0,0)),h.normal>=0&&n.__normalArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglNormalBuffer),this.enableAttribute(h.normal),o.vertexAttribPointer(h.normal,3,o.FLOAT,!1,0,0)),h.tangent>=0&&n.__tangentArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglTangentBuffer),this.enableAttribute(h.tangent),o.vertexAttribPointer(h.tangent,4,o.FLOAT,!1,0,0)),h.uv>=0&&n.__uvArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglUVBuffer),this.enableAttribute(h.uv),o.vertexAttribPointer(h.uv,2,o.FLOAT,!1,0,0)),h.uv2>=0&&n.__uv2Array&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglUV2Buffer),this.enableAttribute(h.uv2),o.vertexAttribPointer(h.uv2,2,o.FLOAT,!1,0,0)),s._skinningData&&h.skinIndex>=0&&h.skinWeight>=0&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglSkinIndicesBuffer),this.enableAttribute(h.skinIndex),o.vertexAttribPointer(h.skinIndex,4,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,n.__webglSkinWeightsBuffer),this.enableAttribute(h.skinWeight),o.vertexAttribPointer(h.skinWeight,4,o.FLOAT,!1,0,0)),h.lineDistance>=0&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglLineDistanceBuffer),this.enableAttribute(h.lineDistance),o.vertexAttribPointer(h.lineDistance,2,o.FLOAT,!1,0,0))}return s instanceof e.Mesh?(r.wireframe?(this.setLineWidth(1),f&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,n.__webglLineBuffer),o.drawElements(R.LINES,n.__webglLineCount,o.UNSIGNED_SHORT,0)):(f&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,n.__webglFaceBuffer),o.drawElements(R.TRIANGLES,n.__webglFaceCount,o.UNSIGNED_SHORT,0)),this.currentRenderInfo.calls++,this.currentRenderInfo.vertices+=n.__webglFaceCount,this.currentRenderInfo.faces+=n.__webglFaceCount/3):s instanceof e.Line?(c=s.type===e.LineStrip?R.LINE_STRIP:R.LINES,this.setLineWidth(r.lineWidth),o.drawArrays(c,0,n.__webglLineCount),this.currentRenderInfo.calls++):s instanceof e.ParticleSystem&&(o.drawArrays(o.POINTS,0,n.__webglParticleCount),this.currentRenderInfo.calls++,this.currentRenderInfo.points+=n.__webglParticleCount),!0}enableAttribute(e){let t=this.gl;t._enabledAttributes[e]||(t.enableVertexAttribArray(e),t._enabledAttributes[e]=!0)}disableAttributes(){let e=this.gl;for(var t in e._enabledAttributes)e._enabledAttributes[t]&&(e.disableVertexAttribArray(t),e._enabledAttributes[t]=!1)}setupMorphTargets(e,t,i){}isQAAutomationMode(){return this._defaultAppearanceType===e.DefaultAppearanceMode.__QA_AUTOMATION__}_getDefaultAppearanceType(){let e=this.materialToUseList;var t=this._defaultAppearanceType;return(e.zOnlyPass||e.dialogPass)&&(t=ee.BASIC),t}getStateSortedObjects(t,r){let n=this.materialToUseList;var s=this.camera,a=this.scene;this.sortCount++;var o=r.getDisplayListByName("DEPTHVALUE"),l=r.getDisplayListByName("DEPTHVALUE2"),h=r.getDisplayListByName("EDGE"),c=r.getDisplayListByName("OUTLINE"),d=r.getDisplayListByName("POINT"),u=r.getDisplayListByName("SOLID"),p=r.getDisplayListByName("SURFACE"),f=r.getDisplayListByName("SURFACE_CURVED_PIPE"),g=r.getDisplayListByName("SURFACE_CURVED_PIPE_TRANSPAR"),m=r.getDisplayListByName("BACK"),v=r.getDisplayListByName("NOZ"),_=r.getDisplayListByName("DECALS"),y=r.getDisplayListByName("RenderDepthPositive"),S=r.getDisplayListByName("RenderDepthNegative"),b=r.getDisplayListByName("TRANSPAR"),x=r.getDisplayListByName("TRANSPAR1D"),w=r.getDisplayListByName("NOZTRANSPAR"),P=r.getDisplayListByName("EDGEPRIMITIVESELECTION"),C=(r.getDisplayListByName("EDGEADJACENCESELECTION"),r.getDisplayListByName("POINTPRIMITIVESELECTION")),M=this._getDefaultAppearanceType(),E=M===e.DefaultAppearanceMode.__QA_AUTOMATION__,D=[d,h,p,p,v,u],I=[this.monoTransparDL?b:x,this.monoTransparDL?b:x,b,b,w,b],R=(n.originalMaterial&&!this._debugMaterialMode||n.transparentShadowMaterial||n.pickingPassMaterial)&&!this.cuttingScene,O=this.newHLPOC&&!e.__unrolledHighlight()||E,L=X._OUTLINE;const B=this;const F={outlinesCreated:!1,objectWithTransientGSSO:new Set,sortCount:this.sortCount,outlinesCameraDirection:null};this._inheritanceSolver.setFrameContext((function(t,i,s,v,w,M){if(s._sceneGraphOrderMode)return 2==s._sceneGraphOrderMode?{mainDL:o,subDL:null}:{mainDL:l,subDL:null};if(i&&i._geomType===L||s.defines&&void 0!==s.defines.NB_OUTLINE_MAPS)return{mainDL:c,subDL:null};if(s.isBackMaterial)return{mainDL:m,subDL:null};var F;if(n.pickingPassMaterial&&r._pickingPriorityMapping&&t.pickingPriorityID){var V=t.pickingPriorityID.points;if(i.glType>=4?V=t.pickingPriorityID.faces:i.glType>=1&&(V=t.pickingPriorityID.edges),V&&(F=r._pickingPriorityMapping[V]),F)return{mainDL:F,subDL:null}}var G=t._priorityMode,U=v&&v!==i?v.noZ:-1,k=U>=0?U:i&&i._noZPriority!=-1/0?i._noZPriority:t&&t._noZPriority?4:-1;-1==k&&w&&w._type==e.GASTypeEnum.NOZ&&(k=w._priority);var z=null;if(k>=0&&!(i._geomType&e.NoNoZPriorityMask))switch(G){case e.PriorityMode.ClassicPriority2D:if(k>15){z=r.getDisplayListByPriority(e.displayListPriorityEnum.priorityP[k-16]);break}z=w&&w._type==e.GASTypeEnum.NOZ&&w._transparent?r.getDisplayListByPriority(k):r.getDisplayListByPriority(e.displayListPriorityEnum.priority[k]);break;case e.PriorityMode.ClassicPriority:if(k>15){z=r.getDisplayListByPriority(e.displayListPriorityEnum.priorityP[k-16]);break}z=r.getDisplayListByPriority(e.displayListPriorityEnum.priority[k]);break;case e.PriorityMode.Advanced:z=r.getDisplayListByPriority(e.displayListPriorityEnum.priorityP[k]);break;case e.PriorityMode.SceneGraphOrder:z=r.getDisplayListByPriority(e.displayListPriorityEnum.OTHER3D);break;case e.PriorityMode.DepthPriority:z=w&&w._type==e.GASTypeEnum.NOZ&&w._transparent?r.getDisplayListByPriority(k):r.getDisplayListByPriority(e.displayListPriorityEnum.OTHER2D)}var H=null;if(n.highlightMaterial&&(a.highlightData._needsDepth||E))if((t._programID&N.PRIMITIVE_HIGHLIGHT)>0)O&&(0==i.glType&&(H=C),1!=i.glType||s.is2DLine||(H=P));else{if(0==i.glType&&(i._geomType&A)>0&&!E)return{mainDL:null,subDL:null};if(1==i.glType&&(i._geomType&T)>0&&!E)return{mainDL:null,subDL:null}}if(z)return{mainDL:z,subDL:null};if(H)return{mainDL:H,subDL:null};if(null!==t.renderDepth&&!B.scene.isBackground)return{mainDL:t.renderDepth>0?y:S,subDL:null};var W,X=function(t,i,r){var s=2;if(t)return t._getDimension||(t._getDimension=function(e,t){var i=2,r=this;if(r._geomType)i=e[r._geomType];else switch(r.glType){case 0:i=0;break;case 1:i=1;break;default:i=2}return 2===i&&(i=r.gas&&0===r.gas.side?5:2),this._dimension=i,i}),s=-1,2===(s=n.originalMaterial||-1===t._dimension?t._getDimension(j,i):t._dimension)&&r&&0===r.side&&(s=5),s;return i instanceof e.Line&&(s=1),s}(i,t,w),q=s,Z=s.overridable&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,Y=null;(!Z||s.isPhysicalMaterial&&0!==s.transparency||Z.internalMaterialOverride&&s===Z.internalMaterialOverride.material||null!==(W=Z.getOpacity(X,M))&&(Y=W<1),B.useRenderPriorityOpacity)&&(B.computeRenderPriorityOpacity(1,Z)<1&&(Y=!0));if(t._vertexColors&&(s.useGASColor||s._isFromGAS)){var K=t._vertexColors;Y=Y||(K&e.VertexColorType.A)>0||K<=e.VertexColorType.RGBA}var $=s.useGASColor&&w&&w._transparent&&w._alpha<1;F=R&&(Y||null===Y&&!s.iterative&&q.getOpacity()<1||q.transparent||$)?I[X]:D[X];var Q=null;if(n.isDecalNotPossiblePass||!t._isInDecalPass(i)||!s._deferredMaterials[ie.decalNormalStencilDepthMaterial]||F!==b&&F!==x&&F!==p&&F!==u&&F!==h&&F!==d&&F!==f&&F!==g||(0==(B.renderDecalMode&le.IGNORE_ALL)?0==(B.renderDecalMode&le.IGNORE_OVERRIDEN)?(Q=F,F=_):Z||(Q=F,F=_):t._isDecal()&&(F=null)),t._occurrence){let e=t._occurrence._isoLayer;F&&F.isoSupport&&null!==e&&1!==e&&(F=r.getDisplayListByName(F.name+"_ISO"+e)),Q&&Q.isoSupport&&null!==e&&1!==e&&(Q=r.getDisplayListByName(Q.name+"_ISO"+e))}return{mainDL:F,subDL:Q}}),s,M,r.id,n.zOnlyPass,n.pickingPassMaterial),this._inheritanceSolver.enableOutlineHanding(n.outlineFriendly,F);for(var V=this.resetGSSOCacheFrame,G=(s&&s.isOrtho,0);G<t.length;++G){var U=t[G];if(U){var k=U.object,z=k._gsso_cache?k._gsso_cache[r.id]:null;if(!k.filtered){var H=z?z.length:0;if(H>0&&z.resetFrameIndex>=V)for(var W=0;W<z.length;W++){var q=z[W],Z=r._displayLists[q.dlIndex];q.addDrawable(Z)||(k._removeFromStateSortingResult(r.id),k._flagAsGSSOInvalidated(),H=0)}else H>0&&(k._gsso_cache[r.id]=null),!n.originalMaterial&&k instanceof e.Line||n.pickingPassMaterial&&!k.noPickThrough||n.pickingPassMaterial&&k.applyBackgroundViewMode&&!this._pickBackgroundNodes||this._inheritanceSolver.solve(k)}}}F.outlinesCreated&&i.TexturesManager.finalize(),F.objectWithTransientGSSO.forEach((e=>e._flagAsGSSOInvalidated())),this._inheritanceSolver.reset()}addDGToDL({object:t,geometry:i,dg:r=null,dgInterval:n=null,material:s,originalMaterial:a,renderMode:o=null,getDLFromObjectFunc:l,geomDisposeFunc:h,camera:c,matApp:d=null,gasMaterial:u=null,gasStruct:p=null,materialMode:f=!1}){i.layout._layoutKey||i.layout._computeLayoutKey();this.gl;let g=this.materialToUseList,m=!!this.cuttingScene;var v=s,_=a;if(this.gasAsPhong&&v.isPhysicalMaterial&&null!==v._phongFallbackMaterial&&((v=v._phongFallbackMaterial)._deferredMaterialsInit||v.updateDeferredMaterials(),!(v=v._deferredMaterials[this.materialToUse])))return!1;var y=!this.isQAAutomationMode()&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.getFullMaterial(f),S=null,b=v._allowFullMaterialOverride;if((v.overridable||b>0)&&b>=0&&y&&(y.isMatApp?(S=y._getMaterialFromGLType(r.glType,r._geomType)||null)&&(v=S,_=S,d=y):(S=y,(g.originalMaterial||g.oitMaterial||g.transparentShadowMaterial||v.deferrable)&&(r.glType===R.POINTS?"POINTS"===S.targetPrimitiveType:r.glType===R.LINES||r.glType===R.POINTS?"LINES"===S.targetPrimitiveType:"FACES"===S.targetPrimitiveType)&&(g.originalMaterial||(!S._deferredMaterialsInit&&S.updateDeferredMaterials(),S=S._deferredMaterials[this.materialToUse]),v=S,_=S))),!v)return!1;var x=!g.isDecalNotPossiblePass&&t._isReceivingDecal(),w=!1;if(g.shadowPassMaterial&&!t.castShadow){if(!x)return!1;w=!0}if(g.normalDepthMaterial&&!t.enableNormalDepth){if(!x)return!1;w=!0}if(g.normalDepthMaterial||g.shadowPassMaterial){if(t._noZPriority||r._noZPriority>=0)return!1;if(r.glType<=R.LINE_STRIP)return!1}if((this._forbidRenderableState&q.NO_MIRRORDISABLED)>0&&t.disableMirror){if(!x)return!1;w=!0}if(r&&(this._forbidRenderableState&q.NO_UNKNOWN)>0&&(0===r._geomType||(r._geomType&D)>0)&&"Small Plane"!==v.getType()){if(!x)return!1;w=!0}if((this._forbidRenderableState&q.NO_INVISIBLE_PLANE)>0&&"Small Plane"===v.getType())return!1;if((this._forbidRenderableState&q.ONLY_LIGHTED)>0&&(!v._canUseLights()||g.zOnlyPass)){if(!x)return!1;w=!0}var P=s.useGASColor&&p&&p._transparent&&p._alpha<1;if(!_.deferrable||!_._transparencyOnGPU(t)){if(((this._forbidRenderableState&q.NO_TRANSPARENT)>0||g.shadowMaterial&&!_._forceOpaqueShadowMapPass())&&_)if(t.occurrenceRenderingOverride){var C=null;if((E=t.occurrenceRenderingOverride.materialOverride)&&(C=E.getOpacity(_.__dimension,this.getDisableKeepOcclusionOpacityOverrides())),null!==C){if(C<1){if(!x)return!1;w=!0}}else if(S){if(S.getOpacity()<1||S.transparent){if(!x)return!1;w=!0}}else if(_.getOpacity()<1||_.transparent||P){if(!x)return!1;w=!0}}else if(_.getOpacity()<1||_.transparent||P){if(!x)return!1;w=!0}if(g.transparentShadowMaterial&&_){var M=_.transparent||P;if(t.occurrenceRenderingOverride){var E;C=null;(E=t.occurrenceRenderingOverride.materialOverride)&&(C=E.getOpacity(_.__dimension,this.getDisableKeepOcclusionOpacityOverrides())),null!==C?C<1&&(M=!0):S?(S.getOpacity()<1||S.transparent)&&(M=!0):_.getOpacity()<1&&(M=!0)}else _.getOpacity()<1&&(M=!0);if(!M||_._forceOpaqueShadowMapPass()){if(!x)return!1;w=!0}}}if((this.__A2XMode&&(v.isWideLine||v.isDashedLine)||v._isLineWithShapes)&&r&&(r._geomType&T)>0&&(_=v=v._getBodyEdgeMaterial()),r&&!g.pickingPassMaterial&&!g.shadowPassMaterial&&!this.renderVolumesOnly&&(_._isLineWithShapes||1===_.__dimension&&r._dependentDGs)){let i=O,s=1;if(_._worldSizePattern)s=t._getMMMatrix().getScaleOnAxisX();else{i=new e.Matrix4(this.domElement.width/2,0,0,0,0,this.domElement.height/2,0,0,0,0,1,0,0,0,0,1).multiply(c.projectionMatrix).multiply(c.matrixWorldInverse).multiply(t._getMMMatrix())}let a=_._computeDependentDGs(r,n,i,s);for(let e=0;e<a.length;e++){let i=a[e].material;i._deferredMaterialsInit||i.updateDeferredMaterials(),this.addDGToDL({object:t,geometry:a[e].geometry,dg:a[e],dgInterval:a[e],material:i._deferredMaterials[this.materialToUse],originalMaterial:i,renderMode:o,getDLFromObjectFunc:l,geomDisposeFunc:h,camera:c,matApp:d,gasMaterial:u,gasStruct:p,materialMode:f})}}if(!g.pickingPassMaterial&&_._isLineWithShapes&&_._isBidimLine)return!1;for(var A=o?o._hiddenEdges>0:this.renderHiddenEdges,I=v.polite||A&&r&&r._geomType&&(r._geomType&T)>0?2:1,L=0;L<I;L++){L&&(v.politeMaterial||(v.politeMaterial=v.clone(),g.highlightMaterial||(v.politeMaterial.transparent=!0,v.politeMaterial.opacity=.3,v.politeMaterial.depthTest=!1,v.politeMaterial.depthWrite=!1)),v=v.politeMaterial);var B=l(t,r,v,n,p,this.getDisableKeepOcclusionOpacityOverrides()),F=B.mainDL,V=B.subDL;if(F){var G,N=t._gsso_cache[F.ssrId],U=F.drawCallSort===xe.DecalSort,k=this.currentPass&&this.currentPass.isOITPass,z=this.supportsFloatTextures();if(U&&x){if(f&&(G=new Se({dlIndex:F.index,renderLineMode:o&&o.getMasks()[1],material:_._deferredMaterials[ie.decalNormalStencilDepthMaterial],geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:ie.decalNormalStencilDepthMaterial,matApp:d,gasMaterial:u,sectionCapping:m}),N.__addCacheItem(G,F,m,k),G.addDrawable(F),t._decalData.needDrawUvs&&(G=new Se({dlIndex:F.index,renderLineMode:o&&o.getMasks()[1],material:_._deferredMaterials[ie.texCoordMaterial],geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:ie.texCoordMaterial,matApp:d,gasMaterial:u}),N.__addCacheItem(G,F,m,k),G.addDrawable(F)),z||(G=new Se({dlIndex:F.index,renderLineMode:o&&o.getMasks()[1],material:_._deferredMaterials[ie.depthRGBAMaterial],geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:ie.depthRGBAMaterial,matApp:d,gasMaterial:u}),N.__addCacheItem(G,F,m,k),G.addDrawable(F))),!w){var H=t._gsso_cache[V.ssrId];G=new Se({dlIndex:V.index,renderLineMode:o&&o.getMasks()[1],material:v,geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:d,gasMaterial:u}),H.__addCacheItem(G,V,m,k),G.addDrawable(V)}}else G=new Se({dlIndex:F.index,renderLineMode:o&&o.getMasks()[1],dlIndex:F.index,material:v,geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:d,gasMaterial:u}),N.__addCacheItem(G,F,m,k),G.addDrawable(F)}}return!0}getDisableKeepOcclusionOpacityOverrides(){return(this._forbidRenderableState&e._ForbidRenderableStates.DISABLE_KEEP_OCCLUSION_OPACITY_OVERRIDES)>0}resetGSSOCache(){this.resetGSSOCacheFrame++}resetClippingStatus(){this.resetClippingStatusFrame++}_setToneMapping(e){this.gammaInput=e>0,this.simpleGamma=e<2}resetUpdatedUBOs(){}increaseFrameCount(e,t){ae.resetCullingStatuses(this.currentFrameIndex),this.currentFrameIndex++,this._currentFrameType=e,this.info.render=this.info.renderMap.get(e),this.info.render||(this.info.render=new m.RenderInfo,this.info.renderMap.set(e,this.info.render)),this.currentRenderInfo=this.info.render,t||this.info.render.reset()}setMaterialShaders(e,t,i,r,n){var s;return[(s=this.ODTMode?e.buildLib(t,new Proxy(i,fe),r,n):e.buildLib(t,i,r,n)).vertexShader,s.fragmentShader]}getTextureUnit(){var e=this.usedTextureUnits;return e>=this.supportedFeatures.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+this.supportedFeatures.maxTextures),this.usedTextureUnits+=1,e}setProgram(e,t,i,r,n,s,a,o,l,h,c,d){return null}setProgramWithUniforms(e,t,i,r,n,s,a,o,l,h,c,d){return null}refreshUniformsClipPlanes(e,t,i,r,n){if(e.nbClipPlanes){e.nbClipPlanes.value=t.length,e.clipPlaneEquations.value=t.eqs;let a=t.states.slice(0);i&&(a[i-1]=0),a.length=8,e.clipPlaneActive.value=a;var s=r&&r.getClippingSettings();!s||n?(e.clipFrontOpacity.value=1,e.clipBackOpacity.value=0):(e.clipFrontOpacity.value=s.frontOpacity<.5?0:1,e.clipBackOpacity.value=s.backOpacity<.5?0:1)}}refreshUniformsClipPolyLine(e,t,i,r,n,s,a){if(e.polygonPoints){t&&t.updateCamera(i,r),e.polygonPoints.value=t?t.getTexture():null;var o,l,h=[],c=[],d=[];for(o=0;o<n;o++)t&&o<t.getCount()?(l=t.polyLines[o],h.push(l.closedPoints2d?l.closedPoints2d.length:0),c.push(l.viewPlaneU.x),c.push(l.viewPlaneU.y),c.push(l.viewPlaneU.z),d.push(l.viewPlaneV.x),d.push(l.viewPlaneV.y),d.push(l.viewPlaneV.z)):(h.push(0),c.push(0),c.push(0),c.push(0),d.push(0),d.push(0),d.push(0));h.length%4!=0&&(h.length=4*Math.ceil(h.length/4)),e.polygonSize.value=h.length>0?h:[0,0,0,0],e.extrusionPlaneU.value=c,e.extrusionPlaneV.value=d;let p=!1;var u=s&&s.getClippingSettings();p=!(!u||a)&&!(u.backOpacity<.5);let f=t&&t.needsInvert()?!p:p;e.clipBackOpacity.value=f?1:0}}refreshUniformsScissorPolyLine(e,t,i,r,n){if(e.scissorPoints){t&&t.updateTexture(i,r),e.scissorPoints.value=t?t.texture:null;var s,a=t?t.getNbVertices():[];for(s=a.length;s<n;s++)a.push(0);a.length%4!=0&&(a.length=4*Math.ceil(a.length/4)),e.scissorSize.value=a.length>0?a:[0,0,0,0]}}refreshUniformsClipCylinder(e,t){e.cylinderClipZone&&(e.cylinderClipZone.value=t?t.clipOutside?1:-1:0,t&&t.center&&(e.cylinderCenter.value=t.center),t&&t.axisU&&(e.cylinderAxisU.value=t.axisU.clone().multiplyScalar(1/t.axisU.lengthSq())),t&&t.axisV&&(e.cylinderAxisV.value=t.axisV.clone().multiplyScalar(1/t.axisV.lengthSq())))}setColorGamma(e,t,i,r,n,s){var a=L.copyToLinear(i,n);e[t]=a.r*r,e[t+1]=a.g*r,e[t+2]=a.b*r,e[t+3]=0,s&&(s[t]=a.r,s[t+1]=a.g,s[t+2]=a.b,s[t+3]=0)}setColorLinear(e,t,i,r,n){e[t]=i.r*r,e[t+1]=i.g*r,e[t+2]=i.b*r,e[t+3]=0,n&&(n[t]=i.r,n[t+1]=i.g,n[t+2]=i.b,n[t+3]=0)}setupLights(e,t){this.resetLightInfos();var i,r,n=this.lights,s={ambient:[0,0,0],directional:{dirCount:0,dirLength:0,dirColors:n.directional.colors,dirColorsPhong:n.directional.colorsPhong,dirPositions:n.directional.positions,dirColorsNoIntensity:n.directional.colorsNoIntensity},directionalIBL:{dirIBLCount:0,dirIBLLength:0,dirIBLColors:n.directionalIBL.colors,dirIBLPositions:n.directionalIBL.positions},directionalPhong:{dirPhongCount:0,dirPhongLength:0,dirPhongColors:n.directionalPhong.colors,dirPhongPositions:n.directionalPhong.positions},point:{pointCount:0,pointLength:0,pointColors:n.point.colors,pointColorsPhong:n.point.colorsPhong,pointPositions:n.point.positions,pointColorsNoIntensity:n.point.colorsNoIntensity},spot:{spotCount:0,spotLength:0,spotColors:n.spot.colors,spotColorsPhong:n.spot.colorsPhong,spotPositions:n.spot.positions,spotPhysicalAttenuations:n.spot.physicalAttenuations,spotDirections:n.spot.directions,spotColorsNoIntensity:n.spot.colorsNoIntensity},ies:{iesCount:0,iesLength:0,iesColors:n.ies.colors,iesPositions:n.ies.positions,iesDistances:n.ies.distances,iesLightTexture:n.ies.iesLightTexture,matrixWorldInv:n.ies.matrixWorldInv},rectangle:{rectangleCount:0,rectangleLength:0,rectangleColors:n.rectangle.colors,rectanglePositions:n.rectangle.positions,rectangleNormals:n.rectangle.normals,rectangleUps:n.rectangle.ups},sphere:{sphereCount:0,sphereLength:0,sphereColors:n.sphere.colors,spherePositions:n.sphere.positions},disk:{diskCount:0,diskLength:0,diskColors:n.disk.colors,diskNormals:n.disk.normals,diskUps:n.disk.ups,diskPositions:n.disk.positions},tube:{tubeCount:0,tubeLength:0,tubeColors:n.tube.colors,tubeRights:n.tube.rights,tubePositions:n.tube.positions},camera:t};for(i=0,r=e.length;i<r;i++){var a=e[i];a.onlyShadow||a.setup(s,this.setColorGamma,this.setColorLinear,this)}var o=function(e,t){let a=4*s[e][t+"Length"],o=s[e][t+"Colors"].length,l=Math.max(o,4*s[e][t+"Count"]);for(i=a,r=l;i<r;i++)((i+1)%4||o<l)&&(s[e][t+"Colors"][i]=0);n[e].length=s[e][t+"Length"]};o("directional","dir"),o("directionalIBL","dirIBL"),o("directionalPhong","dirPhong"),o("point","point"),o("spot","spot"),o("ies","ies"),o("rectangle","rectangle"),o("disk","disk"),o("sphere","sphere"),o("tube","tube"),n.ambient[0]=s.ambient[0],n.ambient[1]=s.ambient[1],n.ambient[2]=s.ambient[2]}setupShadows(t,i){let r=this.shadows;var n=0;r.shadowMap=[],r.transparentShadowMap=[],r.shadowMapSizeDarknessBias=[],r.shadowMapNearFar=[],r.shadowMatrix=[],r.shadowCameraPosition=[],r.lowPartShadowCameraPosition=[];var s=0;r.shadowMapCube=[],r.transparentShadowMapCube=[],r.shadowPointPosition=[],r.shadowCubeInfos=[];for(var a=0,o=t.length;a<o;a++){var h=t[a];if(h.castShadow)if(h instanceof e.SpotLight||h instanceof e.DirectionalLight&&!h.shadowCascade&&(!h.isVirtual||this.shadowMapCascade)){if(h._sortKey===l.DirectionalIBLLight.prototype._sortKey&&!i._needsIBLLightExtraction())continue;if(h.shadowMap){r.shadowMap[n]=h.shadowMap,r.transparentShadowMap[n]=h.transparentShadowMap,r.shadowMapSizeDarknessBias[n]=new e.Vector4(h.shadowMapSize.x,h.shadowMapSize.y,h.shadowDarkness,h.shadowBias),r.shadowMapNearFar[n]=new e.Vector4(h.shadowCamera.near,h.shadowCamera.far,0,0),r.shadowMatrix[n]=h.shadowMatrix;var c=(new e.Vector3).getPositionFromMatrix(h.shadowCamera.matrixWorld);if(h.isVirtual){var d=e._SplitFloat32PositiveError(c.x),u=e._SplitFloat32PositiveError(c.y),p=e._SplitFloat32PositiveError(c.z);r.shadowCameraPosition[4*n]=d.high,r.shadowCameraPosition[4*n+1]=u.high,r.shadowCameraPosition[4*n+2]=p.high,r.lowPartShadowCameraPosition[4*n]=d.low,r.lowPartShadowCameraPosition[4*n+1]=u.low,r.lowPartShadowCameraPosition[4*n+2]=p.low}else r.shadowCameraPosition[4*n]=c.x,r.shadowCameraPosition[4*n+1]=c.y,r.shadowCameraPosition[4*n+2]=c.z,r.lowPartShadowCameraPosition[4*n]=e.SplitFloat32(c.x).low,r.lowPartShadowCameraPosition[4*n+1]=e.SplitFloat32(c.y).low,r.lowPartShadowCameraPosition[4*n+2]=e.SplitFloat32(c.z).low;r.shadowCameraPosition[4*n+3]=0,r.lowPartShadowCameraPosition[4*n+3]=0}n++}else h instanceof e.PointLight&&(h.shadowMap&&(r.shadowMapCube[s]=h.shadowMap,r.transparentShadowMapCube[s]=h.transparentShadowMap,r.shadowCubeInfos.push(h.shadowDarkness,h.shadowBias,h.shadowCameraNear,h.shadowCameraFar),h.setupShadowPositions(r.shadowPointPosition),r.shadowPointPosition.push(h.shadowMapWidth)),s++)}}setupClipPlanes(t,i,r,n){this._clipPlanes.hasCapping=!0;var s,a,o,l=0,h=0,c=n&&n.clippingContext;for(s=0,a=i.length;s<a;s++){o=i[s],h=4*l,(new e.Matrix4).copy(r.matrixWorld).transpose();var d=(new e.Plane).copy(o);d.constant+=this.clipPlanesTolerance,d.applyMatrix4(r.matrixWorldInverse),this._clipPlanes.eqs[h]=d.normal.x,this._clipPlanes.eqs[h+1]=d.normal.y,this._clipPlanes.eqs[h+2]=d.normal.z,this._clipPlanes.eqs[h+3]=d.constant,this._clipPlanes.states[s]=o.enabled?1:0,this._clipPlanes.sectionLines[s]=!c||c._hasPlaneSectionLine(o),c&&!c._hasPlaneCapping(o)&&(this._clipPlanes.hasCapping=!1),l++}this._clipPlanes.length=l}_initializeRenderTarget(e,t){this.lastRenderTarget=e,this._initializePassStates(t),this._finalizePassStates()}render(t,i,r,n,s,a){if(i instanceof e.Camera==!1)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");e._mobileDevice,this.supportsFloatTextures(),e._vrDevice;const o=e._mobileHighlight;let l=!!this.cuttingScene,h=(this.gl,this.materialToUseList);this.initFrameUBO(),this.updateFrameUBO(i),this.scene=t,this.camera=i,this.currentSSRID=s.id,this.cameraPosition.getPositionFromMatrix(this.camera.matrixWorld),this.lowPartCameraPosition.x=e.SplitFloat32(this.cameraPosition.x).low,this.lowPartCameraPosition.y=e.SplitFloat32(this.cameraPosition.y).low,this.lowPartCameraPosition.z=e.SplitFloat32(this.cameraPosition.z).low,this.lastRenderTarget=r,this._initGlobals(),this._cleanProgramPool(this.currentFrameIndex%100==0&&this.materialToUseList.originalMaterial);var c=t.__lights;t.__lights.sort(t._lightSort);var d=t.computeLightsKey();this.lightsKeys=d.keys,this.lightingSet=!1,this._updateSceneAndCamera(),this._initializePassStates(n);var u=this.currentPass?this.currentPass.idString:null;"main"===t.defaultRenderList||"main"!==u&&u||(u=t.defaultRenderList);var p=this.currentPass.composer?this.currentPass.composer.composerContext:null,f=e.StateSortingResult._getCullingSystem(i,t,p,this._currentFrameType,this.currentPass),g=this.occlusionCullingEnabled?oe.get(i,t):null,m=s._resetGSSOCacheIndex>-1&&this.resetGSSOCacheFrame>s._resetGSSOCacheIndex,v=!1,_=p?p.id:"mtU_"+this.materialToUse;f.lastComposerContextsSeen.has(_)&&-1!==s._resetGSSOCacheIndex||(v=!0),f.currComposerContextsSeen.add(_);var y=this.currentFrameIndex;f.isSet(u)||f.setFromIdString(u);var S=f.getWebGLObjectsLinkedList(u);const b=this.currentRendererMode===ve.dynamic;var x=this.objectsToGSSO;if(a&&(s._resetGSSOCacheIndex=this.resetGSSOCacheFrame),null!==S&&a){var w=s.id,P=S.first,C=S.nexts,M=S.objects;window.webVisuPerfo.startPerfo("cull");var E=f.objectManagers[u],A=y>E.frame;E.frame=y;const e=ne._INVISIBLE,t=ne._VISIBLE,r=(ne._FRESH,se._GSSO),n=se._REMOVE_AND_GSSO,a=se._REMOVE,o=se._NOTHING,l=se._SKIP,c=se._MAYBE_REMOVE_AND_GSSO,d=se._REMOVE_AND_GSSO_AND_RESTORE_ACTION,p=se._REMOVE_AND_RESTORE_ACTION;for(var D=0,R=0,O=0,L=0,B=0,F=null,G=!1,N=this.visibleSpace,H=P;H>-1;H=C[H]){var W=(F=M[H]).webglObject,j=W.object,q=o;if(A){var Z=F.previousCullingStatus;F.action=o;let s=V(j.visible,j.visibilityFree,N,j.layer);s&&W.frustumCulled&&(s=W._performCulling(i,this.frustum,F),++B),s&&g&&(s=g.getOcclusionResult(j),L+=s?0:1),s?(F.previousCullingStatus=t,F.rebuildDisplayLists||m?(F.rebuildDisplayLists=!1,F.action=n):v?(F.action=d,Z!==t?q=r:j._sgOrdered&&(q=c)):Z!==t?F.action=r:j._sgOrdered&&(F.action=c)):(F.previousCullingStatus=e,O++,F.rebuildDisplayLists||m?(F.rebuildDisplayLists=!1,F.action=a):v?(F.action=p,q=Z!==e?a:l):F.action=Z!==e?a:l)}else v&&(q=F.action,F.previousCullingStatus===t?F.action=d:F.action=p);switch(F.action){case o:break;case l:continue;case r:x[D++]=W,j.renderPointsOnly=F.currentRenderPointsOnly;break;case n:j._removeFromStateSortingResult(w),x[D++]=W,j.renderPointsOnly=F.currentRenderPointsOnly;break;case d:var Y=j._gsso_cache?j._gsso_cache[w]:null,K=j._tokens[w]&&j._tokens[w].length>0,$=Y&&Y.length>0;!K||!$||K&&$&&Y.resetFrameIndex<this.resetGSSOCacheFrame?(j._removeFromStateSortingResult(w),x[D++]=W):q===c&&(G=!0,R++,x[D++]=W),j.renderPointsOnly=F.currentRenderPointsOnly,F.action=q;break;case c:G=!0,R++,x[D++]=W,j.renderPointsOnly=F.currentRenderPointsOnly;break;case a:j._removeFromStateSortingResult(w);continue;case p:F.action=q,j._removeFromStateSortingResult(w);continue}F.previousCullingStatus===t&&(j.beforeRenderCB&&!h.pickingPassMaterial&&j.beforeRenderCB(j,{viewpoint:i._viewpoint,camera:i}),this.setupMatrices(j,i))}if(this.currentRenderInfo.culledMeshes+=O,this.currentRenderInfo.occludedMeshes+=L,this.currentRenderInfo.cullingCalls+=B,window.webVisuPerfo.endPerfo("cull"),window.webVisuPerfo.startPerfo("sort"),window.webVisuPerfo.endPerfo("sort"),window.webVisuPerfo.startPerfo("gsso"),D-R>0){if(x.length=D,G){for(var Q=0;Q<D;Q++)x[Q].object._removeFromStateSortingResult(w);for(Q=0;Q<s._displayLists.length;Q++)s._displayLists[Q].clearNeverSort()}this.getStateSortedObjects(x,s)}this._sortDisplayLists(s),window.webVisuPerfo.endPerfo("gsso")}var J=!1;window.webVisuPerfo.startPerfo("draw");var ee=null,te=this.materialToUse===ie.oitAccumMaterial,re=this.materialToUse===ie.oitRevealMaterial,ae=h.mainMaterial,le=this.oitMode!==I.None&&this.currentPass.isOITPass&&h.mainMaterial,ce=!h.mainMaterial&&!h.outlineFriendly,de=h.highlightMaterial&&t.highlightData,ue=de&&o,pe=this.materialToUse,fe=!1,ge=!1,me=!1,_e=-1;if(!this.useCompositing&&h.oitMaterial){var ye=0,Se=s._displayLists.filter((e=>e.canOIT));for(Q=0;Q<Se.length;Q++){var be=Se[Q];ye+=be._materialList.length,ge=ge||be.drawCallSort===xe.DecalSort&&be._materialList.length>0||be._materialList.filter((e=>e._objectsTransparentOnGPU||e.material._transparencyOnGPU(null))).length>0}fe=0===ye}const we=this.forcePolygonOffset!==z.DEFAULT,Pe=this.forcePolygonOffset===z.ENABLED,Ce=!!l&&this.getClipPlanesUseObjectMaterial(),Me=this.use_webgpu;let Ee=0,Te=0,Ae=0,De=0,Ie=0;if(!fe){const e=s._displayLists.length;for(let n=0;n<e;n++){const a=s._displayLists[n],o=a.drawCallSort===xe.DecalSort,u=a._materialList;let p=a.active?u.length:0;if(-1===_e&&0===p)continue;Ee++;const f=!this.disableDepthTest&&a.depthTest;o&&this.decalBuffers.init(r);let g=null;if(a.depthFunc&&(g=this.gpuStates.depthFunc,this.setDepthFunc(this.depthFuncs[a.depthFunc])),h.pickingMaterial){if(n>0&&(a.pickingPriority||J)){let e=this;this.__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances((function(){e.clear(!1,!0,!1)}),"pickingPriority")}J=!!a.pickingPriority}let m=a.depthWrite;a.hasTranspar&&le&&(m=!0);let v=re&&a.canOIT,_=te&&a.canOIT,y=le&&a.canOIT;ge&&(a.canOIT?(-1===_e&&(_e=n),this.setColorWrite(!1),this.disableSetColorWrite=!0,v=!1,_=!1,pe=ie._fakeOriginalMaterial,me=!o):_e>-1&&(p=0)),!a.canOIT&&h.oitMaterial&&(this.setColorWrite(!1),this.disableSetColorWrite=!0,pe=ie._fakeOriginalMaterial);const S="OUTLINE"==a.name;let x=null,w=null,P=null,C=!1;for(var Re=0;Re<p;Re++){const e=u[Re];if(e.drawOnlyOnStaticFrames&&b)continue;const n=e.displayRangeList,s=n.getFirstDrawable(),p=e.material;if(!s||me&&!e._objectsTransparentOnGPU&&!p._transparencyOnGPU(null)){Ae++;continue}Te++;let g=!1,M=!1,E=!1,A=v,D=_,I=y,R=pe,O=ce;if(h.mainMaterial=ae,o){let t=!1;switch(e.materialToUse){case ie.decalNormalStencilDepthMaterial:g=!0,t=!0;break;case ie.texCoordMaterial:M=!0,t=!0;break;case ie.depthRGBAMaterial:E=!0,t=!0;break;default:if(ge){let e=this.disableSetColorWrite;this.disableSetColorWrite=!1,this.setColorWrite(!1),this.disableSetColorWrite=e}}if(t){if(R=e.materialToUse,ge){let e=this.disableSetColorWrite;this.disableSetColorWrite=!1,this.setColorWrite(!0),this.disableSetColorWrite=e}h.mainMaterial=!1,I=!1,A=!1,D=!1,O=!0}}const L=n.materialOverride;if(Me&&(L?this._globalProgramID|=U.HAS_OVERRIDES:this._globalProgramID&=~U.HAS_OVERRIDES),l){let t=e.occurrenceRenderingOverride,r=t&&t.clippingContext,n=x?x._isCappingUsingPlaneMaterial():0;C&&(!x||r!==x||Ce&&1===n||2===n)&&(this.renderCuttingElements(P,i,c,w.occurrenceRenderingOverride)&&(ee=null),C=!1),w=e,x=r,P=p}if(this.currentGeometryGroupHash=null,!this.clipPlanesEnabled&&this.cuttingScene&&(!e.occurrenceRenderingOverride||!e.occurrenceRenderingOverride.clipPlanes))continue;I?this._globalProgramID|=U.OIT:this._globalProgramID&=~U.OIT;let B=p;if(!p.areTexturesLoaded()&&h.mainMaterial){if(p.transparent||p.getOpacity()<1)continue;B=he}if(A)this.setBlending(k.OITRevealBlending);else if(D)this.setBlending(k.OITAccumBlending);else if(h.transparentShadowMaterial)this.setBlending(k.TransparentShadowBlending);else if(O)ue?this.setBlending(k.NormalBlending):this.setBlending(k.NoBlending);else if(p.useBlending||!p.iterative&&(p.transparent||p.getOpacity()<1))this.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst);else{let t=e._forceAlphaBlending;if(L&&L.hasTransparency(p.__dimension,this.getDisableKeepOcclusionOpacityOverrides()))t=!0;else if(this.useRenderPriorityOpacity)this.computeRenderPriorityOpacity(1,L)<1&&(t=!0);this._renderToCanvas&&this._doBlendingOnCanvas&&(t=!0),t?this.setBlending(k.NormalBlending):this.setBlending(k.NoBlending)}de?this.setDepthTest(f):s.dg&&!s.dg.glType&&s.dg._geomType===X.SURFACIC_POINT&&a.depthTest?this.setDepthTest(!0):O?this.setDepthTest(f):this.setDepthTest(p.depthTest&&f);const F=m;!m&&this.currentPass&&(!this.currentPass.isRobotPass&&a.hasTranspar&&(B.opacityMap||B.map||(1===B.getOpacity()||h.pickingPassMaterial)&&null===L||L&&(1===L.getOpacity(p.__dimension,this.getDisableKeepOcclusionOpacityOverrides())||h.pickingPassMaterial))&&(m=!0),this.currentPass.isRobotPass&&h.pickingPassMaterial&&(m=!0)),O?(this.setDepthWrite(m&&!this.disableDepthWrite),this.setColorWrite(!this.disableColorWrite)):D||A?(this.setDepthWrite(!1),this.setColorWrite(p.colorWrite&&!this.disableColorWrite)):(this.setDepthWrite(p.depthWrite&&m&&!this.disableDepthWrite),this.setColorWrite(p.colorWrite&&!this.disableColorWrite)),m=F,l||!h.mainMaterial||this.gpuStates.colorWrite?this._globalProgramID&=~U.NO_COLOR_WRITE:this._globalProgramID|=U.NO_COLOR_WRITE;let V=null;if(p.depthFunc&&(V=this.gpuStates.depthFunc,this.setDepthFunc(this.depthFuncs[p.depthFunc])),p.polygonOffset&&!we&&this.setPolygonOffset(p.polygonOffset,p.polygonOffsetFactor,p.polygonOffsetUnits),h.lightedMaterial=h.mainMaterial&&B._canUseLights()&&pe!==ie._fakeOriginalMaterial&&0==(this._globalProgramID&U.NO_COLOR_WRITE),this._clipPlanesState.update(e.occurrenceRenderingOverride,ee,!1,B,i,!!this.cuttingScene),ee=e.occurrenceRenderingOverride,this.ambianceKey=B._computeAmbianceKeyAndProcessMaterial(h.lightedMaterial,t,d,this,i),this.lightsKey=B._getLightsKey(this.lightsKeys),this.useRenderPriorityOpacity)if(0===this.computeRenderPriorityOpacity(1,L))continue;let G=!1,N=!0;const z=this._hasClippingWithoutCapping(),H=e.sectionLines,W=n.tree;let j=W.size,q=W.values();De+=j,o&&this.decalBuffers.prepareDecals(g,M,E);for(var Oe=0;Oe<j;++Oe){for(let t=q.next().value.next;null!==t;t=t.next){const r=t.dg,n=t.object,s=t.geometry,a=t.matApp,o=t.gas;if(Ie++,t.updateLineInfos&&t._updateWideLineAndPatternStuff(B,this,i,S),t.doRenderLineModePolygonOffset.doIt&&(we?this.setPolygonOffset(Pe,2*t.doRenderLineModePolygonOffset.factor,2*t.doRenderLineModePolygonOffset.unit):this.setPolygonOffset(t.doRenderLineModePolygonOffset.enable,t.doRenderLineModePolygonOffset.factor,t.doRenderLineModePolygonOffset.unit)),t.doSetMaterialFaces(this,i,z),2===s._type){let l=!1;if(L&&L.colorOverride){let e=!1;if((L.colorOverride.hasASMInherit()||n._occurrence.gas&&n._occurrence.gas.hasASMInherit())&&(e=!0),e&&(L._setDisableColorOverride(!1),r&&((r._geomType&T)>0||r._geomType===X._OUTLINE))){const e=this.getRenderMode(n);this.overrideWireframeFix&&e&&!e.areFacesVisible()||(L._setDisableColorOverride(!0),l=!0)}}H&&s===n.sectionLinesBuilder.sectionLineGeometry?this.renderSectionLines(i,c,n,B,s,r,t.start,t.count,e.occurrenceRenderingOverride,L,N,t,a,o,R,t.multiStart,t.multiCount):G=this.renderInterval(i,c,n,B,s,r,t.start,t.count,e.occurrenceRenderingOverride,L,N,t,a,o,R,t.multiStart,t.multiCount),l&&L._setDisableColorOverride(!1),G&&(N=!1)}else G=1===s._type?this.renderBufferDirect(i,c,p,s,n):this.renderBuffer(i,c,p,s,n);l&&G&&(C=!0)}}o&&this.decalBuffers.restoreDecals(r,g||M||E),this._globalProgramID&=~U.NO_COLOR_WRITE,V&&this.setDepthFunc(V)}l&&C&&P&&this.renderCuttingElements(P,i,c,w.occurrenceRenderingOverride)&&(ee=null),!a.canOIT&&h.oitMaterial&&(this.disableSetColorWrite=!1,this.setColorWrite(!0),pe=this.materialToUse),ge&&_e>-1&&(!a.canOIT||n===e-1)&&(n=_e-1,ge=!1,_e=-1,this.disableSetColorWrite=!1,this.setColorWrite(!0),pe=this.materialToUse,me=!1),g&&this.setDepthFunc(g),o&&this.decalBuffers.clear(r)}}this.currentRenderInfo.dlTraversed+=Ee,this.currentRenderInfo.materialPackTraversed+=Te,this.currentRenderInfo.sortIDTraversed+=De,this.currentRenderInfo.tokenTraversed+=Ie;let Le=!1;if(this.currentFrameIndex-s._lastDefragIndex>120&&(s._lastDefragIndex=this.currentFrameIndex,Le=!0),Ae>100||Ae>0&&Le)for(Q=0;Q<s._displayLists.length;Q++)s._displayLists[Q].cleanMaterialListAndDRLs();h.mainMaterial=ae,window.webVisuPerfo.endPerfo("draw"),this._finalizePassStates()}doRenderPlugins(e,t,i,r,n){this.initWebGLObjects(t);var s=0;for(s=0;s<e.length;s++)e[s].noRenderTarget||this.setRenderTarget(r);this.renderPlugins(e,t,i,n)}processOcclusionCulling(e,t,i){if(!this.occlusionCullingEnabled)return;let r=oe.getOrCreate(this.kNumOcclusionContexts,t,e);window.webVisuPerfo.startPerfo("cull"),r.execute(this,t,i,this.occlusionDebugEnabled),window.webVisuPerfo.endPerfo("cull")}renderObjects(t,i,r,n,s,a,o,l,h){var c,d,u,p,f,g,m;i?(f=t.length-1,g=-1,m=-1):(f=0,g=t.length,m=1),2===e.WebGLVersion&&this.updateFrameUBO(n),this.currentVertexBuffer=null,this.currentIndexBuffer=null;for(var v=f;v!==g;v+=m)if(null!==(c=t[v])){if(u=(d=c.object).geometry.geometryGroupsList?d.geometry.geometryGroupsList[0]:d.geometry.length?d.geometry[0]:d.geometry,o)p=o;else{if(void 0===(p=c.object.material[this.materialToUse])&&(p=c.object.material),!p)continue;a||p.useBlending?this.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst):this.setBlending(k.NoBlending),this.setDepthTest(p.depthTest&&!this.disableDepthTest),this.setDepthWrite(p.depthWrite&&!this.disableDepthWrite),this.forcePolygonOffset===z.DEFAULT&&setPolygonOffset(p.polygonOffset,p.polygonOffsetFactor,p.polygonOffsetUnits)}if(this.setMaterialFaces(p),1===u._type)this.renderBufferDirect(n,s,p,u,d);else if(2===u._type||u.length>=0){var _=d.geometry.length||1,y=d.geometry.length?d.geometry[0]:d.geometry;for(v=0;v<_;v++){for(var S=y.drawingGroups,b=0;b<S.length;b++)this.renderInterval(n,s,d,p,y,S[b],S[b].start,S[b].count,null,l,!0,null,null,null,h);if(1===_)break;y=d.geometry[v+1]}}else this.renderBuffer(n,s,p,u,d,l)}}__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances(e,t){e()}_commonShaderOptionsBuilder(t,i,r,n,s,a,o,l){let h=this.materialToUseList,c=this.supportedFeatures,d=this._globalProgramID;const u=r&&r._instancingInfos;var p={antialias:t.useMSAA,extDerivatives:!!c.standardDerivatives,extTextureLODs:!!c.textureLODs,extFragDepth:!!c.fragDepth,extMultiDraw:!!c.multiDraw,materialToUse:o,selectionMaterial:re(o),mobile:e.mobileVersion,mobileDevice:e._mobileDevice,vrDevice:e._vrDevice,appleDevice:e._appleDevice,renderToFloatTexture:this.supportsFloatTextures(),noCompositing:!this.useCompositing,mobileHL:e._mobileHighlight,deferrable:t.deferrable,depthDebugMaterial:l&&this._debugMaterialMode===te.DEPTH,normalDebugMaterial:l&&this._debugMaterialMode===te.NORMAL,shadowMapDebugMaterial:l&&this._debugMaterialMode===te.SHADOW,geomUVDebug:l&&this._debugMaterialMode===te.GEOM_UV,mappingUVDebug:l&&this._debugMaterialMode===te.MAPPING_UV,geomUV2Debug:l&&this._debugMaterialMode===te.GEOM_UV2,mappingUV2Debug:l&&this._debugMaterialMode===te.MAPPING_UV2,geomUV3Debug:l&&this._debugMaterialMode===te.GEOM_UV3,mappingUV3Debug:l&&this._debugMaterialMode===te.MAPPING_UV3,colorDebugMaterial:l&&this._debugMaterialMode===te.COLOR,aoDebugMaterial:l&&this._debugMaterialMode===te.AO,float16DepthDebugMaterial:l&&this._debugMaterialMode===te.FLOAT16_DEPTH,oct22NormalDebugMaterial:l&&this._debugMaterialMode===te.OCT22_NORMAL,useOIT:(this._globalProgramID&U.OIT)>0,oitOpaqueUseMSAA:this.oitOpaqueDepth&&this.oitOpaqueDepth.multisample,maxDirLights:0,maxDirIBLLights:0,maxDirPhongLights:0,maxPointLights:0,maxSpotLights:0,maxSphereLights:0,maxTubeLights:0,maxDiskLights:0,maxRectangleLights:0,maxIESLights:0,lightMapMode:0,useLighting:!1,maxDirShadows:0,maxDirIBLShadows:0,maxSpotShadows:0,maxShadows:0,maxShadowsCube:0,uintESM:this.packESM,shadowMapType:this.shadowMapType,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,fixedSize:r&&r._ratioData&&r._ratioData.ratio>0,alphaTest:t.alphaTest,discardOrOpaque:t.alphaTest&&t.alphaTestMode===e.AlphaTestMode.DISCARD_OR_OPAQUE,doubleSided:t.side===E.DoubleSide,flipSided:t.side===E.BackSide,vertexColors:t.vertexColors>0,objectVertexColors:r._vertexColors>0&&(t.useGASColor||t._isFromGAS),sizeAttenuation:t.sizeAttenuation,largeScale:(s&N.LARGE_SCALE)>0,useNormalMatrix:(s&N.NON_UNIFORM_SCALE)>0,planeViewModeColor:(s&N.PLANE_VIEW_MODE)>0,noZObject:(s&N.NOZ_OBJECT)>0,highFrequencyColors:this.use_webgpu&&(t.useGASColor||(d&U.HAS_OVERRIDES)>0),politeHighlight:(d&U.POLITE_HIGHLIGHT)>0,useDepthForPoliteHighlight:(d&U.POLITE_HIGHLIGHT)>0&&this._usePolitenessOnHighlight,primitiveHighlight:(d&U.POLITE_HIGHLIGHT)>0&&(s&N.PRIMITIVE_HIGHLIGHT)>0,clipPlanesEnabled:this.clipPlanes.length>0&&t.enableClipPlanes,useClippingCylinder:this.useClippingCylinder&&t.enableClipPlanes,maxPolygonSize:t.enableClipPlanes?Math.max(this.maxPolyLineSize,this.maxScissorSize):0,maxPolyLineSize:t.enableClipPlanes?this.maxPolyLineSize:0,maxNbPolyLine:t.enableClipPlanes?this.maxNbPolyLine:0,maxScissorSize:t.enableClipPlanes?this.maxScissorSize:0,maxNbScissor:t.enableClipPlanes?this.maxNbScissor:0,billboard:r&&r._billboardData&&r._billboardData.type>=1,isMultiInstanced:u&&u.isInstanceNode3D,defaultInstancing:u&&u.useDefaultInstancing,instancingMeshSelectionMode:u&&"mesh"===u.instancingSelectionMode,compressedVertices:n&&n.compressedVertices,compressedNormals:n&&n.compressedNormals,oct16Normals:n&&n.compressedNormals&&n.oct16Normals,compressedUVs:n&&n.compressedUVs,compressedColors:n&&n.compressedColors,useCompressionContext:n&&n.compressedVertices&&n.useCompressionContext,gpuTangentBinormal:!this.forceCPUTBCompute&&n&&!n.hasTangentBinormal(),map:t._isTextureAvailable("map"),mapHDR:!!t.map&&t.map.hdr,sslrefractionEnabled:this.useSSLRefraction,sslreflectionEnabled:this.useSSLR,useSSAO:!1,shadowPass:h.shadowPassMaterial,skipTranspar:(d&U.SKIP_TRANSPAR)>0,inlinedPostProActivated:this.inlinedPostProcess.activated&&this.enableInlinedPostProcess,inlinedPostProTonemapping:this.inlinedPostProcess.tonemapping,gammaInput:this.gammaInput,gammaOutput:this.gammaOutput,simpleGamma:this.simpleGamma,fogViewMode:this._backgroundViewMode===e.BackgroundViewMode.FOG||this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT,lowlightViewMode:this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT,emulatedMultiDraw:this.use_webgpu||c.DSMultiDraw&&c.DSMultiDraw.isEmulated,doPlanarFace:(s&N.PLANAR_FACE)>0,enablePlanarNormals:!0,forcePlanarNormals:!1};if(p.vertexColors=p.vertexColors||p.objectVertexColors,p.alphaTest||re(o)||t._disableForcedAlphaTest||!t._isTransparent(r)||(p.alphaTest=1e-5),r._skinningData){const e=r._skinningData;e.skinning?Object.assign(p,{skinning:!0,useEulerAngles:e.skinning.useEulerAngles,skinningMapWidth:e.skinning.skinningMapWidth,skinningMapHeight:e.skinning.skinningMapHeight}):e.skinningInstancing&&Object.assign(p,{skinning:!0,useEulerAngles:e.skinningInstancing.useEulerAngles,skinningInstancingMapsInfo:e.skinningInstancing.skinningInstancingMapsInfo})}return p.Linux=e._isLinux,this.use_webgpu?(p.WebGPU=!0,p.WebGL=!1):(p.WebGPU=!1,p.WebGL=!0,p.WebGLVersion=e.WebGLVersion),p}_lightedShaderOptionsBuilder(t,i,r,n,s,a,o){var l=this.allocateLights(i),h=this.allocateShadows(i),c=h.dirLight,d=h.dirIBLLight,u=h.spotLight,p=h.tex2d,f=h.texCube,g=0,m=!1,v=null;if(t.envMap){var _=t.envMap.mapping;switch(_ instanceof e.SphericalReflectionMapping?g=1:_ instanceof e.LatLongReflectionMapping&&(g=2),m=t.envMap.magFilter===e.LinearFilter,t.envMap.encoding){case e.RGBA_Encoding:v="RGBA";break;case e.RGBE_Encoding:v="RGBE";break;case e.LogLUV_Encoding:v="LOGLUV";break;case e.RGBM_Encoding:v="RGBM"}}var y=!1,S=0,b=!1;a&&a._lightMap&&a._lightMap.texture?(y=!0,S=a._lightMap.mode,b=a._lightMap.linear):(y=r&&!!r.lightMapData,S=r&&!!r.lightMapData&&r.lightMapData.lightMapMode,b=!0);const x=this.shadowMapEnabled&&this.transparentShadowEnabled;var w={maxDirLights:l.directional,maxDirIBLLights:l.directionalIBL,maxDirPhongLights:l.directionalPhong,maxPointLights:l.point,maxSpotLights:l.spot,maxSphereLights:l.sphere,maxTubeLights:l.tube,maxDiskLights:l.disk,maxRectangleLights:l.rectangle,maxIESLights:l.ies,lightMap:y,lightMapMode:S,lightMapLinear:!!y&&b,lightMapMappingType:-1,useLighting:!0,reflectivityEnvMap:t._isTextureAvailable("reflectivityEnvMap"),maxDirShadows:c,_maxDirIBLShadows:d,maxDirIBLShadows:0,maxSpotShadows:u,maxShadows:p,maxShadowsCube:f,_shadowMapEnabled:this.shadowMapEnabled&&r.receiveShadow,shadowMapEnabled:this.shadowMapEnabled&&p>0&&r.receiveShadow,shadowMapCubeEnabled:this.shadowMapEnabled&&f>0&&r.receiveShadow,transparentShadowEnabled:x&&!(t.transparent||t.getOpacity()<1),useSSAO:this.useSSAO||this.useSSAOIterative,metal:t.metal,wrapAround:t.wrapAround,reflectionProbes:t.reflectionProbes,useFiniteEnvMap:this.scene.useFiniteEnvMap,envMap:!!t.envMap,envMapSheen:!!t.envMap&&t._sheenData&&null!==t._sheenData.envMipMap,envMapDiffuse:t.envMipMap&&t.envMipMap[1]&&t.envMipMap[1].hasDiffuse,envMapHDR:t.envMap&&t.envMap.hdr,envMapsRGB:t.envMap&&t.envMap.sRGB,envMapping:g,useIBLColor:this._useIBLColor,useLinearSampling:m,envMapEncoding:v,flakesMode:this.flakesMode,sslrefraction:!1,sslreflection:!1,specularMap:t._isTextureAvailable("specularMap"),specularMapLinear:!!t.specularMap&&t.specularMap.hdr};return w.transparentShadowDeclarationEnabled=w.transparentShadowEnabled||x&&this.use_webgpu,(w.maxRectangleLights||w.maxSphereLights||w.maxDiskLights)&&(w.hasAreaLights=!0),w}_textureShaderOptionsBuilder(e,t,i,r,n,s,a,o){var l=!1;(!this.use_webgpu||this.use_webgpu&&!e.__dontUseUVAttributes)&&(l=e._getTextures(!0).filter((function(e){return!!e})).length>0||a===ie.texCoordMaterial||o&&this._debugMaterialMode===te.GEOM_UV||o&&this._debugMaterialMode===te.MAPPING_UV||o&&this._debugMaterialMode===te.GEOM_UV2||o&&this._debugMaterialMode===te.MAPPING_UV2||o&&this._debugMaterialMode===te.GEOM_UV3||o&&this._debugMaterialMode===te.MAPPING_UV3,l=s&&s._lightMap?l||!!s._lightMap.texture:l||i&&!!i.lightMapData);const h=s&&s._mappingOperator;return{useUV:l,mappingFromMatApp:this.use_webgpu&&h,mappingType:h?s._mappingOperator.mappingType:e.mappingType,mappingUseFragment:!!(h||i&&i.lightMapData)||e.mappingUseFragment,textureBlending:e.textureBlending,textureFormat:e.textureBlending===K.REPLACE&&e.map?e.map.format:0,needTangent:e.needTangent,needTangentBinormal:e.requireTangentBinormal(),needTangentBinormalVertex:e.requireVertexTangentBinormal()}}getContextId(e){let t=this.gl?this.gl.contextId:0;return t+=512*(e&&e._viewpoint?e._viewpoint.id+1:0),t}initMaterial(e,t,i,r,n,s,a,o,l,h){t.addEventListener("dispose",this.onMaterialDispose),t._revision++;const c=t.programManager;let d=this.materialToUseList;var u=t._shaderID,p=d.mainMaterial,f=this._commonShaderOptionsBuilder(t,i,r,n,o,l,h,p);if(d.lightedMaterial?(Object.assign(f,this._lightedShaderOptionsBuilder(t,i,r,n,o,l,h)),f.sslrefractionEnabled&&!f.skipTranspar&&(f.sslrefraction=!0),f.sslreflectionEnabled&&(f.sslreflection=!0),f.isDeferredMaterial=!1):f.isDeferredMaterial=!p,Object.assign(f,this._textureShaderOptionsBuilder(t,i,r,n,o,l,h,p)),d.pickingMaterial&&(f.specialPickingInstancing=!1,f._definePickingInstancing=t._definePickingInstancing),(d.lightedMaterial||d.shadowPassMaterial)&&(f.shadowMapQuality=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapQuality,f.shadowMapDebug=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapDebug,f.shadowMapCascade=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapCascade),f._isDecal=(o&N.DECALS)>0,f._isDecal&&!d.isDecalNotPossiblePass&&(f.isDecal=!0,f.mappingUseFragment=!0),t._setMaterialShaderOptions(f,d.lightedMaterial,d.normalDepthMaterial||d.normalMaterial,d.shadowPassMaterial,d.normalDepthReflMaterial,d.pickingPassMaterial),f._isDecal&&d.isDecalNotPossiblePass&&(f.map=null,f.opacityMap=null,f.alphaTest=0),t._PDSFXData&&t._PDSFXData.PDSFX){var g=t._PDSFXData;f.PDSFX=!0,!1===f.mappingUseFragment&&(f.mappingUseFragment=!0),f.pdsfxShaderBuilderUsed=!1,f.pdsfxUseFragDepth=!1,f.pdsfxUseUv2=!1,f.pdsfxUseUv3=!1,f.pdsfxUseMappedUv=!1,f.pdsfxUseMappedUv2=!1,f.pdsfxUseMappedUv3=!1,f.pdsfxUseTangentBinormal=!1,f.pdsfxUseVertexColors=!1,f.pdsfxUseMap=g.pdsfxTextures&&g.pdsfxTextures.length>0}"Custom"===t.getType()&&(f.custom=!0,f.useUV=!0,f.needTangent=!0,f.needTangentBinormal=!0,f.gpuTangentBinormal=!1,f.needTangentBinormalVertex=!1),t.enableReceiveShadowOnCapping=f.shadowMapEnabled,t.program=this.buildProgram(u,t,f,n?n.layout:null,a&&a.getInstanceInfos(),n&&n.vertexBufferGPU?n.vertexBufferGPU.layout:null),this._setShaderUtilsContext(),c.addProgram(o,t.program,this.shaderVersions[this.currentRendererMode]),!this.use_webgpu&&t.buildUniformsList()}_initGlobals(){this.currentRenderInfo||(this.currentRenderInfo=new m.RenderInfo),G.currentBufferGPUManager=this.bufferGPUManager;let e=this.materialToUseList;e.originalMaterial=this.materialToUse===ie.originalMaterial,e.mainMaterial=ie.mainMaterial(this.materialToUse),e.lightedMaterial=!1,e.depthMaterial=this.materialToUse===ie.depthMaterial,e.depthRGBAMaterial=this.materialToUse===ie.depthRGBAMaterial,e.normalDepthReflMaterial=this.materialToUse===ie.normalDepthIoRRoughnessMaterial,e.normalDepthMaterial=e.normalDepthReflMaterial||this.materialToUse===ie.normalDepthMaterial,e.normalMaterial=this.materialToUse===ie.normalMaterial,e.shadowMaterial=this.materialToUse===ie.shadowMapDepthMaterial,e.outlineFriendly=e.originalMaterial,e.pickingMaterial=this.materialToUse===ie.pickingMaterial||this.materialToUse===ie.pickingMaterialInstancing,e.highlightMaterial=this.materialToUse===ie.highlightMaterial,e.positionMaterial=this.materialToUse===ie.gpuPositionMaterial,e.pickingPassMaterial=ie.pickingPassMaterial(this.materialToUse),e.oitMaterial=this.materialToUse===ie.oitAccumMaterial||this.materialToUse===ie.oitRevealMaterial,e.oitLinkedListMaterial=this.materialToUse===ie.oitLinkedListMaterial,e.isDecalNotPossiblePass=e.pickingPassMaterial||e.highlightMaterial,e.transparentShadowMaterial=this.materialToUse===ie.transparentShadowMaterial,e.shadowPassMaterial=e.shadowMaterial||e.transparentShadowMaterial,e.zOnlyPass=!!this.currentPass&&("ZOnly"===this.currentPass.idString||"background"===this.currentPass.idString),e.dialogPass=!!this.currentPass&&"dialogPass"===this.currentPass.name,this.monoTransparDL="true"===localStorage.getItem("__WEBVISU_MONO_TRANSPARDL__")||!0===localStorage.getItem("__WEBVISU_NEW_TRANSPARDL_SORTING__"),this.newHLPOC="true"===localStorage.getItem("__WEBVISU_NEWHL_POC__"),this.currentGeometryGroupHash=null,this.currentMaterialId=-1,this.currentGASMatId=-1,this.currentMatAppId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0,this._globalProgramID=0,e.highlightMaterial&&this.scene.highlightData&&this.scene.highlightData._needsDepth&&(this._globalProgramID|=U.POLITE_HIGHLIGHT),this._forbidRenderableState&q.NO_TRANSPARENT&&(this._globalProgramID|=U.SKIP_TRANSPAR),this.gammaInput&&(this._globalProgramID|=U.GAMMA_INPUT),this.gammaOutput&&(this._globalProgramID|=U.GAMMA_OUTPUT),this.simpleGamma&&(this._globalProgramID|=U.GAMMA_SIMPLE),this.currentProgram.program=null,this.currentVertexBuffer=null,this.currentIndexBuffer=null,this.viewportData.viewportScale=this.currentPass&&this.currentPass.composer&&this.currentPass.composer.composerContext?this.currentPass.composer.composerContext._internalScaleForViewport:1}_sortDisplayLists(t){if(this.scene.isBackground)for(i=0;i<t._displayLists.length;i++){(r=t._displayLists[i])._materialList.sort((function(e,t){var i=e.displayRangeList.getFirstDrawable(),r=t.displayRangeList.getFirstDrawable(),n=i?i.object.renderDepth:0,s=r?r.object.renderDepth:0;return s?n?s!==n?s-n:i.object.id!==r.object.id?r.object.id-i.object.id:e.material.id-t.material.id:1:-1}))}else for(var i=0;i<t._displayLists.length;i++){var r;if((r=t._displayLists[i]).drawCallSort!==xe.NeverSort)if(r.drawCallSort===xe.DecalSort){r._materialList.sort((function(e,t){var i=e.decalSortData._decalDataContainer._decalData?e.decalSortData._decalDataContainer._decalData.key:0,r=t.decalSortData._decalDataContainer._decalData?t.decalSortData._decalDataContainer._decalData.key:0;if(i===r){if((i=e.decalSortData.layer)===(r=t.decalSortData.layer))i=e.decalSortData.internalSortKey,r=t.decalSortData.internalSortKey;else{var n=Number(BigInt.asUintN(32,i>>32n)),s=Number(BigInt.asUintN(32,r>>32n));s===n?(i=Number(BigInt.asUintN(32,i)),r=Number(BigInt.asUintN(32,r))):(i=n,r=s)}return r-i}return i-r}));let e=0;const t=new Map;let i=1e6;for(let n=0;n<r._materialList.length;n++){let s=r._materialList[n];const a=s.decalSortData;if(a.internalSortKey>=0&&s.displayRangeList.tree.size>0){const r=a._decalDataContainer._decalData;t.has(r.depth)||t.set(r.depth,{offset:0,key:r.key});let n=t.get(r.depth);if(r.depth!==i)if(r.depth>i)e=0;else{const s=t.get(i)||{offset:0,key:-1};t.set(r.depth,{offset:Math.max(s.offset,n.offset),key:n.key}),n=t.get(r.depth),e=n.key!==r.key?s.offset:n.offset}else r.key!==n.key&&(e=0);i=r.depth,n.key=r.key,r.depthOffset=e++,n.offset=Math.max(e,n.offset)}}}else if(r.drawCallSort===xe.RenderDepthSort){const t={worldRadius:0,worldCenter:new e.Vector3,renderDepth:0,id:0};r._materialList.sort((function(e,i){const r=e.displayRangeList.getFirstDrawable(),n=i.displayRangeList.getFirstDrawable(),s=r?r.object:t,a=n?n.object:t,o=s.renderDepth,l=a.renderDepth;if(o!==l)return o-l;const h=s.id,c=a.id;if(h!==c)return h-c;const d=e.glType,u=i.glType;return d!==u?u-d:e.material.id-i.material.id}))}else if(r.drawCallSort===xe.GLTypeSort)r._materialList.sort((function(e,t){var i=e.glType;return t.glType-i}));else if(r.drawCallSort!==xe.BackToFrontSort||this.currentPass.isOITPass&&r.canOIT)r._sortByClippingContext?r._materialList.sort((function(e,t){var i=e.material,r=t.material,n=e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.clippingContext,s=t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.clippingContext;let a=n?n.id:-1,o=s?s.id:-1;return o!==a?o-a:i.program&&r.program?r.program!==i.program?i.program.id-r.program.id:e.occurrenceRenderingOverrideId!==t.occurrenceRenderingOverrideId?e.occurrenceRenderingOverrideId-t.occurrenceRenderingOverrideId:i.id-r.id:r.id-i.id})):r._sortByProgram&&(r._sortByProgram=!1,r._materialList.sort((function(e,t){var i=e.material,r=t.material;return i.program&&r.program?r.program!==i.program?i.program.id-r.program.id:e.occurrenceRenderingOverrideId!==t.occurrenceRenderingOverrideId?e.occurrenceRenderingOverrideId-t.occurrenceRenderingOverrideId:i.id-r.id:r.id-i.id})));else{for(var n=0;n<r._materialList.length;n++){r._materialList[n].displayRangeList.sortDrawablesBackToFront(this.camera)}r._materialList.sort((function(e,t){var i=e.displayRangeList.getFirstDrawable(),r=t.displayRangeList.getFirstDrawable(),n=i?i.zSortKey:0,s=r?r.zSortKey:0;return s!==n?n-s:i&&r&&i.object.id!==r.object.id?i.object.id-r.object.id:t.material.id-e.material.id}))}}}renderCuttingElements(t,i,r,n){function s(t){return!(!t||!(t instanceof e.MeshBasicMaterial||t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)||t.map)}if(this.cuttingScene){const v=this.use_webgpu;var a;let _=this.materialToUseList;var o=n&&n.getClippingSettings();let y=this.enableStencilWrite,S=this.disableColorWrite,b=this.disableDepthWrite;this.setStencilFunc(this.depthFuncs.NOTEQUAL,100,255),this.setColorWrite(!0),this.setStencilWrite(!1),this.setDepthWrite(!0),o&&0===o.frontOpacity?this.setCullMode(this.cullings.FRONT):this.setCullMode(this.cullings.BACK);var l=this.disableBackFaceClipPlanes;this.disableBackFaceClipPlanes=0;var h=n&&n.clipPlanes,c=this.cuttingScene.getWebGLObjects("main");if(h){let e,t,i=[],r=new Map;for(e=0;e<c.length;e++)r.set(c[e].object,c[e]);for(e=0;e<h.length;e++)if(t=h[e].clippingContext&&h[e].clippingContext[this.id],t&&t.clippingMesh){let e=r.get(t.clippingMesh);e&&i.push(e)}c=i}var d,u,p=0,f=n&&n.clippingContext,g=this.materialToUse===ie.depthRGBAMaterial||this.materialToUse===ie.normalDepthIoRRoughnessMaterial||this.materialToUse===ie.normalDepthMaterial;for(p=c.length-1;p>=0;p-=1)if(null!==c[p]&&(!f||f._hasPlaneCapping(c[p].object.clippingPlane))){if(u=null,a=null,n&&n.sectionCappingMaterials){for(u=n.sectionCappingMaterials.defaultMaterial,d=0;d<n.sectionCappingMaterials.length;d++)if(n.sectionCappingMaterials[d].clippingPlane===c[p].object.clippingPlane){u=n.sectionCappingMaterials[d].material;break}u&&(u.clipPlaneIndex=p+1,c[p].object.geometry.normalsNeedUpdate=!0)}if(this.setupMatriceswithModelMatrix(c[p].object,i),t&&t.enableReceiveShadowOnCapping&&(c[p].object.receiveShadow=!0),g||!u&&c[p].object.material.clipPlaneUseModelMaterial)g||s(t)?(u=t,a=n&&!g&&n.materialOverride):(this.backupCuttingMaterial||(this.backupCuttingMaterial=e.MaterialUtils.createShinyFaceMaterial({color:"black"})),u=this.backupCuttingMaterial),u.clipPlaneIndex=p+1;else if((u=u||c[p].object.material)&&(u.clipPlaneIndex=p+1),e.HatchingMeshMaterial&&(u instanceof e.HatchingMeshMaterial||u instanceof e.ScreenSizeHatchingMeshMaterial)){var m;let i=null,r=null;u.autoSpaceColor&&(i=s(t)?(m=n&&n.getOverrideColor(t))||t.color:(m=n&&n.getOverrideColor())||new e.Color(16777215)),u.autoStripesColor&&(r=s(t)?m||t.color:m||new e.Color(0)),(i||r)&&(u=u.getAutoColorVersion(i,r))}if(this._clipPlanesState.update(n,null,!0,u,i,!0),this.bufferUtils.updateObject(c[p].object,u),u._renderedClipPlane=c[p].object.clippingPlane,this.setPolygonOffset(!0,1,1),!u.transparent&&u.opacity>=1){this.currentRenderInfo&&this.currentRenderInfo.nbRenderCuttingElement++,_.lightedMaterial=_.mainMaterial&&u._canUseLights()&&0==(this._globalProgramID&U.NO_COLOR_WRITE);let e=this.disableBackFaceCulling;this.disableBackFaceCulling=!1,v&&(a?this._globalProgramID|=U.HAS_OVERRIDES:this._globalProgramID&=~U.HAS_OVERRIDES),!c[p].object._bindingGroups&&this.createGSSOCache(c[p].object),this.renderObjects([c[p]],!1,"",i,r,!0,u,a,this.materialToUse),this.disableBackFaceCulling=e}u._renderedClipPlane=null,(g||c[p].object.material.clipPlaneUseModelMaterial)&&(u.clipPlaneIndex=0)}return o&&0===o.frontOpacity&&this.setCullMode(this.cullings.BACK),this.setCullMode(this.cullings.NONE),this.setStencilFunc(this.depthFuncs.ALWAYS,100,255),this.disableColorWrite=S,this.enableStencilWrite=y,this.disableDepthWrite=b,this.setDepthWrite(!b),this.setColorWrite(!S),this.setStencilWrite(y),this.clear(!1,!1,!0),this.disableBackFaceClipPlanes=l,this._clipPlanesState.update(null,null,!0,t,i),!0}return!1}getClipPlanesUseObjectMaterial(){if(this.cuttingScene){let t,i=this.cuttingScene.getWebGLObjects("main",this.currentFrameIndex);for(t=0;t<i.length;t++){let r=i[t].object.material;if(!r||r.clipPlaneUseModelMaterial)return!0;if(r instanceof e.HatchingMeshMaterial&&(r.autoSpaceColor||r.autoStripesColor))return!0}}return!1}_cleanRenderableAssets(e){}_sendEvent(e,t){t=t||{},M.publish({event:"/VISU/"+e,data:{eventChannel:"/VISU/"+e,eventType:"@"+e,extraData:t}})}renderAssets(){var e=!1,t=this.lastRenderTarget;null!==this.ambianceGenerators&&(e=e||Y.update(this.currentFrameIndex,this)),this.needsExtractIBLLight&&(this.needsExtractIBLLight=!1,e=!0,this._sendEvent("requestIBLLightExtraction",{rendererID:this.id})),e&&this.setRenderTarget(t)}updateCSSNodes(t,i){var r=t.getWebGLObjectsLinkedList("css2d"),n=t.getWebGLObjectsLinkedList("css3d");if(i.matrixWorldInverse.getInverse(i.matrixWorld),n&&i._viewpoint){var s=i.isOrtho?i.projectionMatrix.elements[5]*this.heightHalf:.5/Math.tan(e.Math.degToRad(.5*i.fov))*this.height,a=i._viewpoint.divCameraCSSElement;if(i.isOrtho?(this.divCSS3DRoot.style.WebkitPerspective="",this.divCSS3DRoot.style.MozPerspective="",this.divCSS3DRoot.style.oPerspective="",this.divCSS3DRoot.style.perspective=""):(this.divCSS3DRoot.style.WebkitPerspective=s+"px",this.divCSS3DRoot.style.MozPerspective=s+"px",this.divCSS3DRoot.style.oPerspective=s+"px",this.divCSS3DRoot.style.perspective=s+"px"),i.isOrtho)w="scale("+s+")translate("+this.epsilon(-(i.right+i.left)/2)+"px,"+this.epsilon((i.top+i.bottom)/2)+"px)"+this.getCameraCSSMatrix(i.matrixWorldInverse)+"translate("+this.widthHalf+"px,"+this.heightHalf+"px)";else w="translate3d(0,0,"+s+"px)"+this.getCameraCSSMatrix(i.matrixWorldInverse)+" translate3d("+this.widthHalf+"px,"+this.heightHalf+"px, 0)";a.style.WebkitTransform=w,a.style.MozTransform=w,a.style.oTransform=w,a.style.transform=w}var o=null;if(r)for(var l=r.first,h=r.nexts,c=r.objects,d=l;d>-1;d=h[d]){if(null!==(y=c[d]))if((!(b=(S=y.object)._getFilter(this.visuFilterType._MATERIAL_TO_USE))||b.materialToUse===this.materialToUse)&&F(S.visible,S.visibilityFree,this.visibleSpace,void 0,S._occurrence)){if(this.renderIteration>0)continue;var u=new e.Vector3;u.copy(S.position);var p=!1;if(this.clipPlanesEnabled)for(var f=0;f<this.clipPlanes.length;f++){var g=this.clipPlanes[f];if(g.normal.x*S.position.x+g.normal.y*S.position.y+g.normal.z*S.position.z+g.constant<0){p=!0;break}}if((i.isOrtho||i.getLookAt().dot(i.position.clone().sub(u))<0)&&!p){(new e.Projector).projectVector(u,i),S.element.style.display="block";var m=e.getDevicePixelRatio()||1,v=S.offset.x/m,_=S.offset.y/m;S.element.style.left=v+.5*(u.x+1)*this.domElement.clientWidth+"px",S.element.style.top=_-.5*(u.y-1)*this.domElement.clientHeight+"px",o||(o=[]),o.push({domElement:S.element,z:u.z,alwaysOnTopIndex:S._occurrence?S._occurrence.node._alwaysOnTopIndex:null})}else S.element.style.display="none"}}if(n)for(l=n.first,h=n.nexts,c=n.objects,d=l;d>-1;d=h[d]){var y,S,b;if(null!==(y=c[d]))if((!(b=(S=y.object)._getFilter(this.visuFilterType._MATERIAL_TO_USE))||b.materialToUse===this.materialToUse)&&F(S.visible,S.visibilityFree,this.visibleSpace,void 0,S._occurrence)){if(this.renderIteration>0)continue;if(i._viewpoint){var x=(new e.Matrix4).multiplyMatrices(S.matrixWorld,S.scaleCSS),w=this.getObjectCSSMatrix(x),P=S.element;P.style.WebkitTransform=w,P.style.MozTransform=w,P.style.oTransform=w,P.style.transform=w,P.style.pointerEvents="auto",P.style.display="block",P.parentNode!==a&&a.appendChild(P)}}}if(o){o.sort((function(e,t){var i=null!==e.alwaysOnTopIndex,r=null!==t.alwaysOnTopIndex;if(i||r){if(!i)return-1;if(!r)return 1;if(e.alwaysOnTopIndex!==t.alwaysOnTopIndex)return e.alwaysOnTopIndex-t.alwaysOnTopIndex}return t.z-e.z}));for(var C=0;C<o.length;C++)o[C].domElement.style.zIndex=20+C}}setupMatrices(t,i){t._modelViewMatrix&&t._modelViewMatrix._multiplyMatricesMV(i.matrixWorldInverse,t.matrixWorld),t.isUniformlyScaled||(t._normalMatrix.getInverse((new e.Matrix4).multiplyMatrices(i.matrixWorldInverse,t.matrixWorld)),t._normalMatrix.transpose()),t.modelViewInvMatrix&&t.modelViewInvMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld),t.modelViewInvTranspMatrix&&t.modelViewInvTranspMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld).transpose()}setupMatriceswithModelMatrix(e,t){this.setupMatrices(e,t),e._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(e.matrixWorld)}renderPlugins(t,i,r,n){if(!t.length)return;this.gl;let s=this.currentProgram,a=this.gpuStates;for(var o=0,l=t.length;o<l;o++)s.program=null,this.currentCamera=null,this.currentVertexBuffer=null,this.currentIndexBuffer=null,a.blending=-1,a.depthTest=-1,a.colorWrite=-1,a.depthWrite=-1,a.doubleSided=-1,a.flipSided=-1,this.currentGeometryGroupHash=-1,this.currentMaterialId=-1,this.currentGASMatId=-1,this.currentMatAppId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0,t[o].render(i,r,e.glStates.currentWidth,e.glStates.currentHeight,n),s.program=null,this.currentCamera=null,this.currentVertexBuffer=null,this.currentIndexBuffer=null,a.blending=-1,a.depthTest=-1,a.colorWrite=-1,a.depthWrite=-1,a.doubleSided=-1,a.flipSided=-1,this.currentGeometryGroupHash=-1,this.currentMaterialId=-1,this.currentGASMatId=-1,this.currentMatAppId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0}_initializePassStates(e,t=null){this.enableRenderPluginsPre&&this.renderPlugins(this.renderPluginsPre,this.scene,this.camera),this.setRenderTarget(this.lastRenderTarget),(this.autoClear||e)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.setStencilWrite(this.enableStencilWrite),this.setBlending(k.NoBlending),this._clipPlanesState.update(null,null,!0,null,this.camera)}_finalizePassStates(){this.enableRenderPluginsPost&&this.renderPlugins(this.renderPluginsPost,this.scene,this.camera),this.lastRenderTarget&&this.lastRenderTarget.generateMipmaps&&this.lastRenderTarget.minFilter!==e.NearestFilter&&this.lastRenderTarget.minFilter!==e.LinearFilter&&updateRenderTargetMipmap(this.lastRenderTarget),this.setColorWrite(!0),this.setDepthTest(!0),this.setDepthWrite(!0)}_updateSceneAndCamera(){this.autoUpdateScene&&this.scene.updateMatrixWorld(),this.cuttingScene&&this.cuttingScene.updateMatrixWorld(),this.autoUpdateObjects&&this.initWebGLObjects(this.scene),this.cuttingScene&&this.initWebGLObjects(this.cuttingScene);let t=this.camera;void 0===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),t.orientation||(t.orientation=t.matrixWorld.determinant()>0?1:-1),this.projScreenMatrix.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);let i=new e.Frustum;i.setFromCameraWithViewMatrix(t),this.clipPlanes.length>0?this.frustum=new e.FrustumWithClippingPlanes(i,this.resetClippingStatusFrame,!!this.cuttingScene):this.frustum=i;let r=this.viewportData.viewportScale;var n=t.getCameraConstant(this.devicePixelRatio,e.glStates.currentHeight/r);t.fullWidth?(n*=t.height/t.fullHeight,t.useRealSize?t.useRealSize&&t.visualizedHeight&&(t._pixelToWorldSizeCst=t.getCameraConstant(this.devicePixelRatio,t.fullHeight/r)):t._pixelToWorldSizeCst=n):t._pixelToWorldSizeCst=n,t.pixelCullingCst=t.pixelCulling*n,t._cstLOD=n;var s=this.domElement;this._pixelSize.x=2/s.width,this._pixelSize.y=2/s.height,t.fullWidth&&t.pickingRatioW&&(this._pixelSize.x/=t.pickingRatioW,this._pixelSize.y/=t.pickingRatioH)}computeRenderPriorityOpacity(e,t){var i=t?t.getRenderPriorityOpacity():null;return(null===i||i<0)&&(i=this.renderPriorityDefaultOpacity),i*e}},self._typeface_js={faces:e.FontUtils.faces,loadFace:e.FontUtils.loadFace},e})),define("Visualization/ThreeJS_R57",["DS/Visualization/ThreeJS_R57","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/ThreeJS_R57"),e})),define("DS/Visualization/AmbianceGenerator",["DS/CoreEvents/Events","UWA/Class","DS/Effects/ConvertLatLongToDualParaboloid","DS/Effects/GenerateMipMaps","DS/Effects/ComputeMipMapRoughness","DS/Visualization/ThreeJS_R57"],(function(e,t,i,r,n,s){"use strict";var a=s._AmbianceGenerators,o=t.extend({init:function(t,n){this.nbSamples=n,this.onDoneCallBack=null,this.texture=null,this.mode=null,s.EventDispatcher.call(this),this.finished=!1;var o=this;this.addEventListener("done",(function(t){if(t.isDone&&a.viewers.forEach((function(e){e.render()})),t.isDone){var i=Date.now();s.VisualizationTraces.info("INFO: Finished computing ambiance in "+(i-t.initTime)/1e3+" seconds"),e.publish({event:"/VISU/IBLComputed",data:{eventChannel:"/VISU/IBLComputed",eventType:"@onIBLComputed"}})}o.onDoneCallBack&&t.isDone&&o.onDoneCallBack()})),this.renderer=t.renderer.renderer,this.convertEffect=new i(this.renderer,t.renderer.renderTargetPool),this.mipMapEffect=new r(this.renderer,t.renderer.renderTargetPool),this.computeEffect=null,this.frameIndex=0,this.init=!1},dispose:function(){this.convertEffect.dispose(),this.convertEffect=null,this.mipMapEffect.dispose(),this.mipMapEffect=null,this.computeEffect.dispose(),this.computeEffect=null,this.init=!1},_setNbSamples:function(){console.warn("A virtual function has been called")},setValues:function(e,t){if(e){this.texture=e;var i=0,r=0;if(e instanceof s.Texture){if(!e._isReady())return;i=e.image.width,r=e.image.height}else{if(!(e instanceof s._AbstractRenderTarget))throw"Expected RenderTarget or Texture";i=e.width,r=e.height}this.convertEffect.setSize(i,r),this.mipMapEffect.setSize(i,r),this.computeEffect.setSize(i,r),this.convertEffect.setEnvMap(e),this.mipMapEffect.setInput(this.convertEffect.composers[0]),this.mode=t,this.init=!0}},_execute:function(e){this.init&&(e&&(this.convertEffect.execute(),this.mipMapEffect.execute(),this.computeEffect.setLatLongMipsInput(this.mipMapEffect.getResult().composerContext.getResult(void 0,!0),this.texture),this._setNbSamples(),this.computeEffect.setMode(this.mode)),this.computeEffect.execute())},_getResult:function(){if(!this.init)return{};var e=this.isDone();e&&(s._SaveGeneratedRoughnessMaps||s._SaveGeneratedRoughnessMapsAsPNG)&&this.computeEffect._saveResult(s._SaveGeneratedRoughnessMapsAsPNG);var t=this.computeEffect.composers[this.computeEffect.nbMipMaps].composerContext.getResult(void 0,e);return t&&(t.hdr=!0,t.hasDiffuse=0===this.computeEffect.modeValue,t.mapping=new s.LatLongReflectionMapping),t},setCallBack:function(e){this.onDoneCallBack=e},isDone:function(){return this.finished}}),l=o.extend({init:function(e,t){this._parent(e,t),this.computeEffect=new n.ComputeMipMapRoughnessFIS(this.renderer,e.renderer.renderTargetPool)},_isExecuteReady:function(){var e=!this.texture.loadEndStatus||this.texture.loadEndStatus===s.AssetLoadingStatus.READY;return a.viewers.forEach((function(t){e=e&&!t._renderingToTarget&&!t.renderer._needPerformanceSuite()})),e},execute:function(){var e=Date.now(),t=this._isExecuteReady();return t&&(this._execute(!0),this.finished=!0,this.dispatchEvent({type:"done",time:e,initTime:Date.now(),isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}}),h=o.extend({init:function(e,t){this._parent(e,t),this.timeFactor=s._mobileDevice?1.5:1,this.computeEffect=new n.ComputeMipMapRoughnessIterative(this.renderer,e.renderer.renderTargetPool),this.initTime=0},_isExecuteReady:function(e){var t=0===this.computeEffect.iter||!this.texture.loadEndStatus||this.texture.loadEndStatus===s.AssetLoadingStatus.READY,i=this;return a.viewers.forEach((function(r){t=t&&!r._QMMode&&r.renderIteration>0&&e-r.timeIter0>i.timeFactor*r.delayBeforeIteration&&!r.renderer._needPerformanceSuite()&&!r._renderingToTarget})),t},execute:function(){var e=Date.now(),t=this._isExecuteReady(e);return t&&(this._execute(0===this.computeEffect.iter),this.finished=this.computeEffect.iter>=this.computeEffect.nbIterations,this.dispatchEvent({type:"done",time:e,initTime:this.initTime,iteration:this.computeEffect.iter,isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});return t.extend({init:function(e){this.generators=new Map,this.generated=new Map,this.toCompute=[],this.cb=e},_getViewer:function(){return a.viewers[0]},_getGenerator:function(e,t){if(t&&(e+="-iterative"),!this.generators.has(e)){var i=this._getViewer(),r=t?new h(i,512):new l(i,512);this.cb&&r.setCallBack(this.cb),this.generators.set(e,r)}return this.generators.get(e)},_getAmbiance:function(e,t){return t&&(e+="-iterative"),this.generated.get(e)},_updateAmbiance:function(e,t,i,r,n){i&&(t+="-iterative"),this.generated.set(t,{ambiance:e,complete:r,usedBy:n})},_disposeGenerator:function(e,t){if(t&&(e+="-iterative"),this.generators.has(e)){var i=this.generators.get(e);this.generators.delete(e),i.dispose()}},_setCB:function(e){this.cb=e,this.generators.forEach((function(t,i,r){t.setCallBack(e)}))},getAmbiance:function(e,t,i,r){var n=e;if(t&&(e+="-iterative"),!this.generated.has(e)){const r=i.hdr;let o=a._dummyRoughnessTextureRGBE;r.encoding===s.LogLUV_Encoding?o=a._dummyRoughnessTextureLogLUV:r.encoding===s.RGBM_Encoding&&(o=a._dummyRoughnessTextureLogRGBM),this.generated.set(e,{ambiance:o,complete:!1,usedBy:new Set}),this.toCompute.push({name:n,iterative:t,hdr:r,brdf:i.brdf})}var o=this.generated.get(e);return o.usedBy.add(r),o},keep:function(e){var t=null;return this.generated.forEach((function(i,r,n){i.usedBy.has(e)&&(1!==i.usedBy.size?console.error("Internal roughness map, access refused"):i.ambiance!==a._dummyRoughnessTextureRGBE&&i.ambiance!==a._dummyRoughnessTextureLogLUV&&i.ambiance.complete?(i.usedBy.delete(e),t=i.ambiance,n.delete(r)):console.error("Roughness map not finished, access refused"))})),t},decreaseUseCount:function(e){if(e){var t=this;this.generated.forEach((function(i,r,n){if(i.usedBy.delete(e),i.usedBy.size<1&&(i.ambiance&&i.ambiance.dispose(),n.delete(r),t.generators.has(r))){var s=t.generators.get(r);t.generators.delete(r),s.dispose()}}))}},dispose:function(){this.generated.forEach((function(e,t,i){e.ambiance.dispose()})),this.generated.clear(),this.generators.forEach((function(e,t,i){e.dispose()})),this.generators.clear(),this.toCompute=[]},_needsUpdate:function(){for(var e=this.toCompute,t=0;t<e.length;t++){var i=e[t],r=this._getAmbiance(i.name,i.iterative);if(r&&!r.complete)return!0}return!1},update:function(e,t){for(var i=this.toCompute,r=0,n=!1,s=0;s<i.length;s++){var o=i[s],l=this._getAmbiance(o.name,o.iterative);if(l&&!l.complete){var h=this._getGenerator(o.name,o.iterative);if(h.init||h.setValues(o.hdr,o.brdf),h.init&&h.renderer===t&&h.frameIndex<e&&!h.isDone()){var c=h.execute();c&&(n=!0,this._updateAmbiance(c,o.name,o.iterative,h.isDone(),l.usedBy)),h.frameIndex=e,h.isDone()&&(this._disposeGenerator(o.name,o.iterative),r++)}}else this._disposeGenerator(o.name,o.iterative),r++}return r===i.length&&(this.toCompute=[],this.generators.clear(),a.viewers.forEach((function(e){e.renderer.renderTargetPool.resetRenderTargetPool((e=>!!e&&("maxPrecisionLinearNoStencilHFMobile"===e.optionsId?0===e.useCount:e.optionsId.toLowerCase().includes("ibl"))))}))),a.viewers.forEach((function(e){e.forceRender=!0})),n}})})),define("DS/Visualization/OccurrenceRenderingOverride",["UWA/Class","DS/Visualization/ThreeJS_R57"],(function(e,t){"use strict";var i,r=function(e,t){this.id=i.getNewId(),this.materialOverride=t instanceof r?t.materialOverride:t,this.opacity=e.opacity,this.renderPriorityActivated=!1};r.prototype.getOpacity=function(e,t){return this.materialOverride?this.materialOverride.getOpacity(e,t):null},r.prototype.getColor=function(){return this.materialOverride?this.materialOverride.getColor():null},r.prototype.getFullMaterial=function(){return this.materialOverride?this.materialOverride.getFullMaterial():null},r.prototype.clone=function(){return new r({opacity:this.opacity},this.materialOverride)},r.prototype.getRenderPriorityOpacity=function(){return null===this.opacity?null:this.opacity},r.prototype.hasTransparency=function(e,t){var i=this.getOpacity(e,t);return null!==i&&i<1},r.prototype.isPGPOnly=function(){return!1};var n=0,s=new WeakMap;function a(e){var t;return s.has(e)?t=s.get(e):(t=n++,s.set(e,t)),t}var o=0,l=e.extend({init:function(){this.id=o++,this.clipPlanes=[],this.clippingContext=null,this.clipPolyLine=null,this.scissor=null,this.materialOverride=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null},clone:function(){var e=new l;return e.clipPlanes=this.clipPlanes,e.clippingContext=this.clippingContext,e.clipPolyLine=this.clipPolyLine,e.scissor=this.scissor,e.sectionLinesProperties=this.sectionLinesProperties,this.materialOverride instanceof r?e.materialOverride=this.materialOverride.clone():e.materialOverride=this.materialOverride,e},getFullMaterial:function(e){return this.materialOverride&&this.materialOverride.getFullMaterial(e)},getClippingSettings:function(){return this.clippingContext&&this.clippingContext.clippingSettings},setRenderPriority:function(e){e&&null!==e.opacity&&(this.materialOverride=new r(e,this.materialOverride))},getOverrideColor:function(e){if(!this.materialOverride)return null;if(e&&!e.overridable)return e.overridable;var i=this.getFullMaterial();if(i&&!i.overridable)return i.color;var r=this.materialOverride.getColor();return 0!==r&&r?new t.Color(r):null},isPurePGP:function(){return!this.clipPolyLine&&!this.scissor&&this.materialOverride&&this.materialOverride.isPGPOnly()&&!this.sectionCappingMaterials},getGSSOId:function(e){if(e){var t,i="";if(this.clipPlanes)for(t=0;t<this.clipPlanes.length;t++)i+="p"+a(this.clipPlanes[t]);return this.clippingContext&&(i+="k"+this.clippingContext.id),i+=this.materialOverride.getPGPGSSOId()}return""+this.id},getClipCylinder:function(){return this.clippingContext&&this.clippingContext.cylinder}});return l.setOverrideLink2Class=function(e){i=e},l})),define("Visualization/OccurrenceRenderingOverride",["DS/Visualization/OccurrenceRenderingOverride","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/OccurrenceRenderingOverride"),e})),define("DS/Visualization/Polygon",["DS/Visualization/ThreeJS_R57"],(function(e){"use strict";var t={};const i=function(){this.corner=[]};i.prototype={constructor:i,clone:function(e){var t=e||new i;t.empty();for(var r=0;r<this.corner.length;r++)t.addPoint(this.corner[r]);return t},empty:function(){this.corner=[]},applyMatrix4:function(e){for(var t=0;t<this.corner.length;t++)this.corner[t].applyMatrix4(e);return this},addPoint:function(t){return this.corner.push((new e.Vector3).copy(t)),this},addPoints:function(e){return this.corner=e,this},addPointAtIndex:function(t,i){return this.corner[t]=new e.Vector3,this.corner[t].copy(i),this},clipByPlane:function(t,r){var n=new i,s=this.corner.length;if(s<3)return n;for(var a=[],o=0;o<s;o++)a[o]=t.distanceToPoint(this.corner[o])>0;for(o=0;o<s;o++){var l=(o+1)%s;if(!a[o]||!a[l])if(a[o]){var h=new e.Vector3,c=new e.Line3(this.corner[o],this.corner[l]);void 0!==t.intersectLine(c,h)&&(r.addPoint(h),n.addPoint(h)),r.addPoint(this.corner[l])}else if(a[l]){h=new e.Vector3,c=new e.Line3(this.corner[o],this.corner[l]);void 0!==t.intersectLine(c,h)&&(r.addPoint(h),n.addPoint(h))}else r.addPoint(this.corner[l])}return n.corner.length&&2!==n.corner.length&&(this.clone(r),n.empty()),n}},t.CGPolygon=i;const r=function(){return this.polygon=[],this};r.prototype={constructor:r,addPolygon:function(e){this.polygon.push(e)},removePolygon:function(e){e>=this.polygon.length||e<0?console.log("CGPoly: trying to remove a polygon which does not exist !"):this.polygon.splice(e,1)},empty:function(){this.polygon=[]},clone:function(e){var t=e||new r;t.empty();for(var i=0;i<this.polygon.length;i++)t.addPolygon(this.polygon[i].clone());return t},applyMatrix4:function(e){for(var t=0;t<this.polygon.length;t++)this.polygon[t].applyMatrix4(e);return this},setFromBox:function(t){var i;(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.min)),i.addPoint(new e.Vector3(t.min.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.min.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.min)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.min.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.min)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.min.y,t.max.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.max)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.max.y,t.min.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.max)),i.addPoint(new e.Vector3(t.max.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.max.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.max)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.max.z)),this.addPolygon(i)},setFromFrustumPoints:function(t){for(var i=new e.CGPolygon,r=0;r<4;r++)i.addPoint((new e.Vector3).copy(t[r]));this.addPolygon(i),i=new e.CGPolygon;for(r=4;r<8;r++)i.addPointAtIndex(r-4,(new e.Vector3).copy(t[11-r]));this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[0]),i.addPoint(t[3]),i.addPoint(t[7]),i.addPoint(t[4]),this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[1]),i.addPoint(t[5]),i.addPoint(t[6]),i.addPoint(t[2]),this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[4]),i.addPoint(t[5]),i.addPoint(t[1]),i.addPoint(t[0]),this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[6]),i.addPoint(t[7]),i.addPoint(t[3]),i.addPoint(t[2]),this.addPolygon(i)},clipByPlane:function(t){var i,n,s=new r,a=new r;for(i=0;i<this.polygon.length;i++){var o=new e.CGPolygon,l=this.polygon[i].clipByPlane(t,o);o.corner.length&&(s.addPolygon(o),l.corner.length&&2===l.corner.length?a.addPolygon(l):l.corner.length>0&&console.log("plane / polygon intersection is not a segment : "+l.corner.length+" points"))}if(a.polygon.length>=3){var h=new e.CGPolygon,c=a.polygon[a.polygon.length-1];for(h.addPoint(c.corner[0]),h.addPoint(c.corner[1]),a.removePolygon(a.polygon.length-1);a.polygon.length>0;){var d=h.corner[h.corner.length-1],u=1/0,p=-1,f=-1;for(i=0;i<a.polygon.length;i++){var g=a.polygon[i];if(2===g.corner.length){for(n=0;n<g.corner.length;n++){var m=g.corner[n].distanceToSquared(d);if(m<1e-4)break;m<u&&(u=m,p=i,f=n)}if(n<g.corner.length){h.addPoint(g.corner[(n+1)%2]);break}}else console.log("convex hull clipping : intersection segment has length > 2")}if(i<a.polygon.length)a.removePolygon(i);else{if(!(p>=0)){console.log("failed to build the intersection polygon btw polyhedra and plane");break}h.addPoint(a.polygon[p].corner[(f+1)%2]),a.removePolygon(p)}}h.corner.splice(h.corner.length-1,1),s.addPolygon(h)}return s},clipByPlanes:function(e){if(!e.length)return null;for(var t=this.clipByPlane(e[0]),i=1;i<e.length;i++)t=t.clipByPlane(e[i]);return t},clipByBox:function(e){for(var t=e.getPlanes(),i=this.clipByPlane(t[0]),r=1;r<6;r++)i=i.clipByPlane(t[r]);return i},getPoints:function(){var e,t,i,r=[];for(t=0;t<this.polygon.length;t++)for(e=this.polygon[t],i=0;i<e.corner.length;i++)r.push(e.corner[i]);return r}},t.CGPoly=r;class n extends e.Line{constructor(t){super(),this._tokens={},this.frustumCulled=!1,this.geometry=new e.Geometry,this.material=new e.LineBasicMaterial({color:16777215,vertexColors:e.VertexColorType.Face}),this.type=e.LinePieces,this.matrixWorld=new e.Matrix4,this.matrixAutoUpdate=!1;for(var i=0;i<1e3;i++)this.geometry.vertices.push(new e.Vector3),this.geometry.colors.push(new e.Color(16711680));this.update(t,new e.Color(16711680))}update(t,i){var r,n=0;for(r=0;r<t.polygon.length;r++)for(var s=t.polygon[r],a=s.corner.length,o=0;o<a;o++){var l=s.corner[o];this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(i),n++,l=s.corner[(o+1)%a],this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(i),n++}var h=n>0?this.geometry.vertices[n-1]:new e.Vector3;for(r=n;r<1e3;r++)this.geometry.vertices[r].copy(h),this.geometry.colors[r].copy(i);this.geometry.verticesNeedUpdate=!0,this.geometry.colorsNeedUpdate=!0}}return t.CGPolyHelper=n,t})),define("DS/Visualization/BufferGeometry",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Visualization/WidelinesHelper","DS/GPUFormats/VertexAttribute","DS/CoreEvents/Events"],(function(e,t,i,r,n){"use strict";let s=0;class a{constructor(){this.buffer=null,this.nbGeometries=0,this.isShared=!1}_deleteBuffer(e){}deallocate(e,t){this.nbGeometries--,0===this.nbGeometries&&(t&&this.isShared&&t.memory.sharedbuffers--,this._deleteBuffer(e),this.buffer=null)}}class o extends a{constructor(e,t,i,r){super(),t?this.buffer=e.createBuffer({label:r,size:t,usage:i,mappedAtCreation:!0}):console.warn("WEBGPUBuffer has byteSize of 0")}_deleteBuffer(e){this.buffer&&this.buffer.destroy()}}e.WEBGPUBuffer=o;e.WEBGPUIndexBuffer=class extends o{constructor(e,t,i){super(e,t,i|=GPUBufferUsage.INDEX,"Index Buffer"),this.use32bitIndexBuffer=!1,this.numIndices=0}get byteLength(){return this.numIndices*this.bytesPerIndex}get bytesPerIndex(){return this.use32bitIndexBuffer?4:2}get format(){return this.use32bitIndexBuffer?"uint32":"uint16"}};e.WEBGPUVertexBuffer=class extends o{constructor(e,t,i){super(e,t,i|=GPUBufferUsage.VERTEX,"Vertex Buffer"),this.numVertices=0,this.interleavedData=null,this.id=s++,this.layout=null,this.needsUpdate=!1}};class l extends a{constructor({gl:e}){super(),this.buffer=e&&e.createBuffer()}_deleteBuffer(e){e&&e.deleteBuffer(this.buffer)}}e.GLBuffer=l;e.GLIndexBuffer=class extends l{constructor({gl:e,numIndices:t=0,use32bitIndexBuffer:i=!1}){super({gl:e}),this.use32bitIndexBuffer=i,this.numIndices=t}get byteLength(){return this.numIndices*this.bytesPerIndex}get bytesPerIndex(){return this.use32bitIndexBuffer?4:2}get glFormat(){return this.use32bitIndexBuffer?5125:5123}};e.GLVertexBuffer=class extends l{constructor({gl:e}){super({gl:e}),this.numVertices=0,this.interleavedData=null,this.id=s++,this.layout=null,this.needsUpdate=!1}};let h=[];class c{constructor(){this.clear()}clear(){this._attributes=new Map,this._cached_signature=null,this._layoutKey=null}clone(){const e=new c;return this._attributes.forEach(((t,i)=>e._attributes.set(i,Object.assign({},t)))),e._cached_signature=this._cached_signature,e._layoutKey=this._layoutKey,e}set(e){for(let t in e)this.setAttribute(Object.assign({name:t},e[t]))}setAttribute({name:t,type:i,offset:r,stride:n,bufferId:s=0}){if(!e.VertexAttribute[i])throw new Error(`Vertex attribute '${t}': unknown type (${i}), see GPUFormats.VertexAttribute for acceptable data types`);if(r<0||r>=n)throw new Error(`Invalid offset/stride, expected 0 <= offset (${r}) < stride (${n})`);this._attributes.set(t,{name:t,type:i,offset:r,bufferId:s,stride:n}),this._computeSignature()}remove(e){this._attributes.delete(e),this._computeSignature()}get(e){return this._attributes.get(e)}has(e){return this._attributes.has(e)}getNames(){return[...this._attributes.keys()]}size(){return this._attributes.size}forEach(e){this._attributes.forEach((t=>e(t)))}_computeLayoutKey(){this._layoutKey=null;let e=-1;for(let t=0;t<h.length;t++)if(this.hasSameContent(h[t])){e=t;break}-1==e&&(h.push(this.clone()),e=h.length-1),this._layoutKey=e}_computeSignature(){let e=[];this._attributes.forEach((t=>e.push(`|${t.name}:${t.type}>`))),this._cached_signature=e.sort().join()}getSignature(){return this._cached_signature}getBufferStrides(){const e=[];return this._attributes.forEach((t=>e[t.bufferId]=t.stride)),e}getBufferAttributes(){const e=[];return this._attributes.forEach((t=>{e[t.bufferId]?e[t.bufferId].push(t.name):e[t.bufferId]=[t.name]})),e}pickAnyAttribute({bufferId:e=-1}={}){if(0===this.size())return null;const t=this._attributes.values();if(e<0)return t.next().value;for(let i=t.next();!i.done;i=t.next())if(i.value.bufferId===e)return i.value;return null}isFullInterleaved(){return!!this.getFullInterleaving()}getFullInterleaving(){if(0===this._attributes.size)return;const e=this._attributes.values();let t=e.next().value,i=t.bufferId,r=t.stride;for(let n=e.next();!n.done;n=e.next())if(t=n.value,i!==t.bufferId||r!==t.stride)return;return{bufferId:i,stride:r}}interleave({order:t=null,targetBufferId:i=0,allAttributes:r=!0}={}){if(r)if(t){const e=new Set(t);for(let i of this._attributes.keys())e.has(i)||t.push(i)}else t=this.getNames();else if(!t)return;let n=0;for(let r=0;r<t.length;r++){const s=this._attributes.get(t[r]);s&&(s.offset=n,s.bufferId=i,n+=e.VertexAttribute[s.type].size)}for(let e=0;e<t.length;e++){const i=this._attributes.get(t[e]);i&&(i.stride=n)}}isOnlyFloat32(){return this._attributes.forEach((e=>{if("float32"!==r[e.type].base)return!1})),!0}getMaxAttributeComponents(){let e=0;return this._attributes.forEach((t=>{let i=r[t.type].components;i>e&&(e=i)})),e}hasSameContent(e){if(this.size()!==e.size())return!1;let t=!0;return this.forEach((function(i){let r=e.get(i.name);r&&i.type===r.type||(t=!1)})),t}}e.VertexLayout=c;class d{constructor(e,t,i){let r,n;this.parentGeometry=e,this.linkedGeometry=t,this.attrName=i,this.parentGeometry[i]=this,this.linkedGeometry[i]=this,r=()=>{this.parentGeometry.removeEventListener("dispose",r),this.linkedGeometry.dispose()},this.parentGeometry.addEventListener("dispose",r),n=()=>{this.linkedGeometry.removeEventListener("dispose",n),this.parentGeometry[i]=null,this.linkedGeometry[i]=null},this.linkedGeometry.addEventListener("dispose",n)}_isStale(){return this.parentGeometry.revision>this.linkedGeometry.revision}_isParent(e){return this.parentGeometry===e}}class u extends d{constructor(e,t){super(e,t,"wideLinesLinker"),this.lineStructureMap=new Map,this.originalDGToWideDG=new Map,this.subGeometries=null}}const p={no_access(){throw new Error("No data for this attribute")},raw_vec3:e=>function(t,i){const r=3*t;i.x=e[r],i.y=e[r+1],i.z=e[r+2]},quantized_vec3:(e,t,i)=>function(r,n){const s=2*r,a=e[s],o=e[s+1];n.x=t.x*(Math.floor(a/256)+i.x),n.z=t.z*(Math.floor(o/256)+i.z),n.y=t.y*(a%256*256+o%256+i.y)},comp_context_vec4:(t,i)=>function(r,n){const s=4*r,a=t[s],o=t[s+1],l=t[s+2];let h=15*t[s+3];const c=new e.Vector3(i.image.data[h],i.image.data[h+1],i.image.data[h+2]);h+=3;const d=new e.Vector3(i.image.data[h],i.image.data[h+1],i.image.data[h+2]);h+=3,n.x=c.x*(a+d.x),n.y=c.y*(o+d.y),n.z=c.z*(l+d.z)}};class f{constructor(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this._type=2,this.needsUpdate=!1,this.decorations=null,this.indexBufferGPU=null,this.indexOffsetGPU=0,this.indexCountGPU=0,this.vertexBufferGPU=null,this.vertexOffsetGPU=0,this.vertexCountGPU=0,this.sharedBuffers=!1,this.noMeshInRAM=!1,this.vertexIndexArray=null,this.buffers=[],this.layout=new c,this.staleIndices=null,this.staleAttributes=null,this.revision=0,this.getVertexPosition=p.no_access,this.getVertexNormal=p.no_access,this.getVertexColor=p.no_access,this.getUV=p.no_access,this.getUV2=p.no_access,this.dynamic=!1,this.boundingBox=null,this.boundingSphere=null,this.lightMap=null,this.drawingGroups=[],this.meshList=[],this.wideLinesLinker=null,this.cpuPatternMatrix=null,this.editable=!1,this.__impl_compressedNormals=void 0,this.__impl_compressedVertices=void 0,this.__impl_compressedUVs=void 0,this.__impl_compressedColors=void 0,this.compressedVertices=!1,this.useCompressionContext=!1,this.quantizedVector=null,this.offsetVector=null,this.compressionContext=null,this.compressedNormals=!1,this.oct16Normals=!1}static copyRaw({count:e,size:t,src_buffer:i,src_offset:r,src_stride:n,tgt_buffer:s,tgt_offset:a,tgt_stride:o}){let l=Uint8Array;t%4==0&&n%4==0&&o%4==0?(l=Uint32Array,t/=4,n/=4,o/=4):t%2==0&&n%2==0&&o%2==0&&(l=Uint16Array,t/=2,n/=2,o/=2);const h=new l(i,r),c=new l(s,a);for(let i=0;i<e;i++){const e=i*n,r=i*o;for(let i=0;i<t;i++)c[r+i]=h[e+i]}}static copyRawAttribute({source_bgds:t,source_attr:i,source_vertex_offset:r=0,target_array:n,target_attr:s,target_vertex_offset:a=0,num_vertices:o}){if(i.type||(i=t.layout.get(i)),i.type!==s.type)throw new Error(`Cannot copy attributes with different types (${i.type} -> ${s.type})`);if(o||(o=t.getVertexCount(i)),!o)return;const l=i.stride,h=s.stride,c=t.buffers[i.bufferId];f.copyRaw({count:o,size:e.VertexAttribute[i.type].size,src_buffer:c.buffer,tgt_buffer:n.buffer,src_offset:c.byteOffset+r*l+i.offset,tgt_offset:n.byteOffset+a*h+s.offset,src_stride:l,tgt_stride:h})}exportRaw({target_array:e,target_layout:t}){t.forEach((t=>{f.copyRawAttribute({source_bgds:this,source_attr:t.name,target_array:e,target_attr:t})}))}markIndexStale(e,t){return e||(e=0),t||(t=this.vertexIndexArray.length),this.staleIndices?(this.staleIndices[0]=Math.min(this.staleIndices[0],e),this.staleIndices[1]=Math.max(this.staleIndices[1],t)):this.staleIndices=[e,t],this.revision++,this.cpuPatternMatrix=null,!!(this.wideLinesLinker||this.vertexLineDistancesArray||this.vertexLinePixelDistancesArray||this.drawingGroups.filter((e=>null!==e._dependentDGs)).length>0)&&(n.publish({event:"/VISU/_LINESHAPES_DG_UPDATE",data:{eventChannel:"/VISU/_LINESHAPES_DG_UPDATE",eventType:"@_LINESHAPES_DG_UPDATE",extraData:{geometry:this}}}),!0)}isStale(){return this.staleIndices||this.staleAttributes}isAttributeStale(e){return!(!this.staleAttributes||!this.staleAttributes.get(e))}markAttributeStale(e,t,i){t||(t=0),i||(i=this.getVertexCount()),this.staleAttributes||(this.staleAttributes=new Map);let r=this.staleAttributes.get(e);return r?(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i)):this.staleAttributes.set(e,[t,i]),this.revision++,!!("position"===e&&(this.cpuPatternMatrix=null,this.wideLinesLinker||this.vertexLineDistancesArray||this.vertexLinePixelDistancesArray||this.drawingGroups.filter((e=>null!==e._dependentDGs)).length>0))&&(n.publish({event:"/VISU/_LINESHAPES_DG_UPDATE",data:{eventChannel:"/VISU/_LINESHAPES_DG_UPDATE",eventType:"@_LINESHAPES_DG_UPDATE",extraData:{geometry:this}}}),!0)}markAllAttributesStale(e,t){e||(e=0),t||(t=this.getVertexCount()),this.layout.forEach((i=>this.markAttributeStale(i.name,e,t)))}_markIndexClean(){this.staleIndices=null}_markAttributeClean(e){this.staleAttributes.delete(e),0===this.staleAttributes.size&&(this.staleAttributes=null)}_markAllAttributesClean(){this.staleAttributes=null}getBuffersMemorySize(){let e=this.vertexIndexArray?this.vertexIndexArray.byteLength:0;for(let t=0;t<this.buffers.length;t++)this.buffers[t]&&(e+=this.buffers[t].byteLength);return this.compressionContext&&this.compressionContext.image&&this.compressionContext.image.data&&(e+=this.compressionContext.image.data.byteLength),e}getBufferWithAttribute(e,t){const i=this.layout.get(e);if(i){const e=this.buffers[i.bufferId];if(!t&&e&&e.buffer&&e.buffer instanceof ArrayBuffer){const t=r[i.type],n=t.size/t.components;return new t.className(e.buffer,e.byteOffset,e.byteLength/n)}return e}return null}getBufferIdWithAttribute(e){const t=this.layout.get(e);return t?t.bufferId:-1}_compactArrays(e){if(!e.has(this)){e.add(this);var t=this.drawingGroups;this.drawingGroups=new Array(t.length);for(var i=0;i<t.length;i++)this.drawingGroups[i]=t[i],t[i]._compactArrays();var r=this.meshList;this.meshList=new Array(r.length);for(i=0;i<r.length;i++)this.meshList[i]=r[i]}}getVertexCount(e){if(0===this.buffers.length)return 0;const t=e||this.layout.pickAnyAttribute();return t&&this.buffers[t.bufferId]?this.buffers[t.bufferId].byteLength/t.stride:0}_updateAccessors(){this._updateVertexPositionAccessor(),this._updateVertexNormalAccessor(),this._updateVertexColorAccessor(),this._updateVertexUVAccessor(),this._updateVertexUV2Accessor()}_getVertexPositionAccessor(){const e=this.getBufferWithAttribute("position",this.compressedVertices);return e?this.useCompressionContext?p.comp_context_vec4(e,this.compressionContext):this.compressedVertices?p.quantized_vec3(e,this.quantizedVector,this.offsetVector):p.raw_vec3(e):p.no_access}_updateVertexPositionAccessor(){this.getVertexPosition=this._getVertexPositionAccessor()}hasTangentBinormal(){return this.layout.has("tangent")&&this.layout.has("binormal")}clearMeshInRAM(e){e||(this.vertexIndexArray=null),this.buffers=[],this._updateAccessors()}clear(){this.clearMeshInRAM(),this.layout.clear(),this.needsUpdate=!0}_getVertexNormalAccessor(){const t=this.getBufferWithAttribute("normal",this.compressedNormals);if(!t)return p.no_access;function i(e,i,r){const n=function(e,t){return t?{x:Math.floor(e/256)/255,y:e%256/255}:{x:Math.floor(e/4096)/4095,y:e%4096/4095}}(t[e],r);if(i.x=2*n.x-1,i.y=2*n.y-1,i.z=1-Math.abs(i.x)-Math.abs(i.y),i.z<=0){const e=(s=i.x,a=i.y,{x:s>=0?1:-1,y:a>=0?1:-1}),t=i.x;i.x=-Math.abs(i.y)*e.x+e.x,i.y=-Math.abs(t)*e.y+e.y}var s,a;i.normalize()}if(this.useCompressionContext){const r=this.getBufferWithAttribute("position");if(!r)return p.no_access;function n(t,n){i(t,n,this.oct16Normals);let s=15*r[4*t+3]+6,a=new e.Matrix3;for(let e=0;e<9;++e)a.elements[e]=this.compressionContext.image.data[s+e];n.applyMatrix3(a),n.normalize()}return n}return this.compressedNormals?i:p.raw_vec3(t)}_updateVertexNormalAccessor(){this.getVertexNormal=this._getVertexNormalAccessor()}_getVertexColorAccessor(){const e=this.getBufferWithAttribute("color",this.compressedColors);if(!e)return p.no_access;return this.compressedColors?function(t,i){const r=e[2*t],n=e[2*t+1],s=Math.floor(r/65536),a=Math.floor(r/256)%256,o=r%256,l=n;return i.x=s/255,i.y=a/255,i.z=o/255,i.w=l/255,i}:function(t,i){const r=4*t;return i.x=e[r],i.y=e[r+1],i.z=e[r+2],i.w=e[r+3],i}}_updateVertexColorAccessor(){this.getVertexColor=this._getVertexColorAccessor()}_getVertexUVAccessor(e){if(!e)return p.no_access;return this.compressedUVs?function(t,i){var r=e[2*t],n=e[2*t+1],s=Math.floor(r/256),a=Math.floor(n/256),o=r%256*256+n%256;return i.x=s/65535,i.y=o/65535,i.z=a/65535,i}:p.raw_vec3(e)}_updateVertexUVAccessor(){this.getUV=this._getVertexUVAccessor(this.getBufferWithAttribute("uv",this.compressedUVs))}_updateVertexUV2Accessor(){this.getUV2=this._getVertexUVAccessor(this.getBufferWithAttribute("uv2",this.compressedUVs))}startIteration(){return!0}endIteration(){return!0}getDGRange(){const e=this.drawingGroups;let t=1/0,i=-1/0;for(let r=0;r<e.length;r++){const{start:n,count:s}=e[r];t=Math.min(t,n),i=Math.max(i,n+s)}return[t,i]}computeBoundingBox(){var t=[0,0,0],i=[0,0,0],r=this.getVertexCount();if(r>=1){t=[1/0,1/0,1/0],i=[-1/0,-1/0,-1/0];for(var n=new e.Vector3,s=0;s<r;s++)this.getVertexPosition(s,n),isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||(n.x<t[0]&&(t[0]=n.x),n.y<t[1]&&(t[1]=n.y),n.z<t[2]&&(t[2]=n.z),n.x>i[0]&&(i[0]=n.x),n.y>i[1]&&(i[1]=n.y),n.z>i[2]&&(i[2]=n.z))}return t=new e.Vector3(t[0],t[1],t[2]),i=new e.Vector3(i[0],i[1],i[2]),this.boundingBox=new e.Box3(t,i),this.boundingBox}_computeOrientedBoundingBox(t,i){if(!t)return null;var r=t.isIdentity(),n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,o=this.vertexIndexArray,l=this.getVertexCount();if(l>=1){var h=new e.Vector3;if(i)for(var c=!0,d=0;d<i.length;d++){var u=i[d];if(u.layerNum&&u.count){if(c){c=!1;var p=o[u.start];this.getVertexPosition(p,h),s.set(h.x,h.y,h.z),a.set(h.x,h.y,h.z),r||(s.applyMatrix4(t),a.applyMatrix4(t))}for(var f=u.start;f<u.start+u.count;f++){p=o[f];this.getVertexPosition(p,h),n.set(h.x,h.y,h.z),r||n.applyMatrix4(t),n.x<s.x&&(s.x=n.x),n.y<s.y&&(s.y=n.y),n.z<s.z&&(s.z=n.z),n.x>a.x&&(a.x=n.x),n.y>a.y&&(a.y=n.y),n.z>a.z&&(a.z=n.z)}}}else{this.getVertexPosition(0,h),s.set(h.x,h.y,h.z),a.set(h.x,h.y,h.z),r||(s.applyMatrix4(t),a.applyMatrix4(t));for(var g=1;g<l;g++)this.getVertexPosition(g,h),n.set(h.x,h.y,h.z),r||n.applyMatrix4(t),n.x<s.x&&(s.x=n.x),n.y<s.y&&(s.y=n.y),n.z<s.z&&(s.z=n.z),n.x>a.x&&(a.x=n.x),n.y>a.y&&(a.y=n.y),n.z>a.z&&(a.z=n.z)}}return new e.Box3(s,a)}computeBoundingSphere(){this.boundingSphere||(this.boundingSphere=new e.Sphere);var t=this.boundingBox;t&&(this.boundingSphere.radius=t.max.clone().sub(t.min).multiplyScalar(.5).length(),this.boundingSphere.center=t.max.clone().add(t.min).multiplyScalar(.5))}computeUVs(t){if(!this.vertexUvArray){var i=new Float32Array(3*this.getVertexCount());this.vertexUvArray=i;var r=new e.Vector3;if(this.vertexNormalArray){t||(t=this.computeBoundingBox());for(var n=[t.min.x,t.min.y,t.min.z],s=[t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z],a=0;a<i.length/3;a++){var o=3*a,l=new e.Vector3;this.getVertexNormal(a,l);var h=Math.abs(l.x),c=Math.abs(l.y),d=0;c>h&&(h=c,d=1),(c=Math.abs(l.z))>h&&(h=c,d=2);var u=(d+1)%3,p=(d+2)%3;this.getVertexPosition(a,r);var f=[r.x,r.y,r.z];i[o]=(f[u]-n[u])/Math.min(s[u],s[p]),i[o+1]=(f[p]-n[p])/Math.min(s[u],s[p]),i[o+2]=0}}}}_computeUV(t,i,r){var n=new e.Vector3,s=new e.Vector3;this.getVertexNormal(t,n),this.getVertexPosition(t,s);var a=Math.abs(n.x),o=Math.abs(n.y),l=0;o>a&&(a=o,l=1),(o=Math.abs(n.z))>a&&(a=o,l=2);var h=(l+1)%3,c=(l+2)%3,d=[i.min.x,i.min.y,i.min.z],u=[i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z],p=[s.x,s.y,s.z];r.set((p[h]-d[h])/Math.min(u[h],u[c]),(p[c]-d[c])/Math.min(u[h],u[c]))}computeTangents(t){let i=this.vertexTangentArray,r=this.vertexBinormalArray;if(r&&i)return;if(i){var n=new e.Vector3,s=new e.Vector3,a=new e.Vector3;r=this.vertexBinormalArray=new Float32Array(i.length);for(var o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),n.normalize(),s.set(i[o],i[o+1],i[o+2]),s.normalize(),a.crossVectors(n,s),r[o]=a.x,r[o+1]=a.y,r[o+2]=a.z;return}o=0;var l=0,h=0,c=0,d=new e.Vector3,u=new e.Vector3,p=new e.Vector3,f=new e.Vector2,g=new e.Vector2,m=new e.Vector2,v=new e.Vector2,_=new e.Vector2,y=new e.Vector3,S=new e.Vector3,b=new e.Vector3,x=(n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,new e.Vector3),w=0,P=0,C=0,M=0,E=0,T=0,A=0,D=3*this.getVertexCount();for(i||(i=this.vertexTangentArray=new Float32Array(D)),r||(r=this.vertexBinormalArray=new Float32Array(D)),o=0;o<i.length;o++)i[o]=0,r[o]=0;var I=this.computeBoundingBox(),R=this.vertexIndexArray;const O=this.vertexUvArray;for(var L=0;L<this.drawingGroups.length;L++){var B=this.drawingGroups[L];if(4===B.glType)for(o=B.start;o<B.start+B.count;o+=3){l=R[o],h=R[o+1],c=R[o+2],this.getVertexPosition(l,d),this.getVertexPosition(h,u),this.getVertexPosition(c,p),O?(this.getUV(l,f),this.getUV(h,g),this.getUV(c,m)):(this._computeUV(l,I,f),this._computeUV(h,I,g),this._computeUV(c,I,m)),y.subVectors(u,d),S.subVectors(p,d),v.subVectors(g,f),_.subVectors(m,f);var F=v.x*_.y-_.x*v.y;Math.abs(F)>1e-8?(w=(F=1/F)*(_.y*y.x-v.y*S.x),P=F*(_.y*y.y-v.y*S.y),C=F*(_.y*y.z-v.y*S.z),M=F*(v.x*S.x-_.x*y.x),E=F*(v.x*S.y-_.x*y.y),T=F*(v.x*S.z-_.x*y.z)):(w=1,P=0,C=0,M=0,E=1,T=0),i[3*l]+=w,i[3*h]+=w,i[3*c]+=w,i[3*l+1]+=P,i[3*h+1]+=P,i[3*c+1]+=P,i[3*l+2]+=C,i[3*h+2]+=C,i[3*c+2]+=C,r[3*l]+=M,r[3*h]+=M,r[3*c]+=M,r[3*l+1]+=E,r[3*h+1]+=E,r[3*c+1]+=E,r[3*l+2]+=T,r[3*h+2]+=T,r[3*c+2]+=T}}for(o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),s.set(i[o],i[o+1],i[o+2]),a.set(r[o],r[o+1],r[o+2]),s.normalize(),a.normalize(),A=n.dot(s),(x=(new e.Vector3).copy(s)).sub(b.copy(n).multiplyScalar(A)),x.normalize(),i[o]=x.x,i[o+1]=x.y,i[o+2]=x.z,r[o]=a.x,r[o+1]=a.y,r[o+2]=a.z}computeLineDistances(e){i._computeLineDistances(this,e)}computeWideLine(t,r){var n;return!this.wideLinesLinker||this.wideLinesLinker._isStale()?(this.wideLinesLinker&&this.wideLinesLinker.linkedGeometry.dispose(),(n=new e.BufferGeometryDS).revision=this.revision,n.editable=this.editable,new u(this,n)):n=this.wideLinesLinker.linkedGeometry,i._computeWideLineDG(this,n,t,r)}__setTypedArraysForWidelines(){const t=this.wideLinesLinker;if(!t.subGeometries)return;const r=t.subGeometries,n=r.verticesCount,s=r.indicesCount,a=new Float32Array(n),o=new Float32Array(n),l=new Float32Array(n),h=new Float32Array(n/3),c=r.hasColors?new Float32Array(4*n/3):null,d=r.hasPatternStartEnds?new Float32Array(2*n/3):null;let u;u=a.length>196608&&e.supportedExtensions.elementIndexUint?new Uint32Array(s):new Uint16Array(s);let p=0,f=0;for(let e=0;e<r.vertices.length;e++){const t=r.vertices[e],i=r.prev[e],n=r.next[e],s=r.sides[e],g=r.colors[e],m=r.patternStartEnds[e];for(let e=0;e<t.length/3;e++){for(let r=0;r<3;r++){const s=3*(e+p)+r,h=3*e+r;a[s]=t[h],o[s]=i[h],l[s]=n[h]}if(h[e+p]=s[e],c)for(let t=0;t<4;t++){const i=4*e+t;c[4*(e+p)+t]=g[i]||0}if(d)for(let t=0;t<2;t++){const i=2*e+t;d[2*(e+p)+t]=m[i]||0}}const v=r.indices[e];for(let e=0;e<v.length;e++)u[e+f]=v[e];p+=t.length/3,f+=v.length}this.vertexPositionArray=a,this.vertexPreviousPositionArray=o,this.vertexNextPositionArray=l,this.vertexSideExtrusionArray=h,this.vertexIndexArray=u;r.needsLineDistance&&i._computeWideLineDistances(this),c&&(this.vertexColorArray=c),d&&(this.vertexPatternStartEndArray=d),t.subGeometries=null}deallocate(e,t){t&&(this.vertexBufferGPU||this.indexBufferGPU)&&t.memory.geometries--,this.vertexBufferGPU&&(this.vertexBufferGPU.deallocate(e,t),this.vertexBufferGPU=null),this.indexBufferGPU&&(this.indexBufferGPU.deallocate(e,t),this.indexBufferGPU=null)}addRefVBO(t,i){i||this.meshList.push(t);var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount++;for(var i=t._getTextures(!1),n=0;n<i.length;n++){(s=i[n])&&s._source===e.AssetSource.MATERIAL_MANAGER&&s._useCount++}if(t._PDSFXData&&t._PDSFXData.pdsfxTextures)for(let i=0;i<t._PDSFXData.pdsfxTextures.length;i++){var s;(s=t._PDSFXData.pdsfxTextures[i].value)&&s._source===e.AssetSource.MATERIAL_MANAGER&&s._useCount++}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}};r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&t.matApp._lightMap.texture._useCount++);for(var n=0;n<this.drawingGroups.length;n++){var s=this.drawingGroups[n];r(s.material),r(s.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&this.lightMap._useCount++}releaseVBO(t,i){var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount--,t._useCount<=0&&t.dispose();for(var i=t._getTextures(!1),n=0;n<i.length;n++){(s=i[n])&&s._source===e.AssetSource.MATERIAL_MANAGER&&(s._useCount--,s._useCount<=0&&s.dispose())}if(t._PDSFXData&&t._PDSFXData.pdsfxTextures)for(let i=0;i<t._PDSFXData.pdsfxTextures.length;i++){var s;(s=t._PDSFXData.pdsfxTextures[i].value)&&s._source===e.AssetSource.MATERIAL_MANAGER&&(s._useCount--,s._useCount<=0&&s.dispose())}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}},s=this.meshList.indexOf(t);if(-1!==s){i||this.meshList.splice(s,1),r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&(t.matApp._lightMap.texture._useCount--,t.matApp._lightMap.texture._useCount<=0&&t.matApp._lightMap.texture.dispose()));for(var a=0;a<this.drawingGroups.length;a++){var o=this.drawingGroups[a];r(o.material),r(o.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&(this.lightMap._useCount--,this.lightMap._useCount<=0&&this.lightMap.dispose())}else console.warn("BufferGeometryDS tried to break the link with a THREE.Mesh, but it failed !");0===this.meshList.length&&(n.publish({event:"/VISU/_LINESHAPES_DG_UPDATE",data:{eventChannel:"/VISU/_LINESHAPES_DG_UPDATE",eventType:"@_LINESHAPES_DG_UPDATE",extraData:{geometry:this}}}),this.dispose())}dispose(){this.dispatchEvent({type:"dispose"})}clone(i,r){var n=new e.BufferGeometryDS;for(let e=0;e<this.buffers.length;e++)n.buffers.push(i?this.buffers[e]:this.buffers[e].slice());if(i&&(n.vertexBufferGPU=this.vertexBufferGPU,n.indexBufferGPU=this.indexBufferGPU,n.meshList=this.meshList),n.layout=i?this.layout:this.layout.clone(),n._updateAccessors(),n.compressedNormals=this.compressedNormals,n.compressedVertices=this.compressedVertices,n.useCompressionContext=this.useCompressionContext,n.compressedUVs=this.compressedUVs,n.compressedColors=this.compressedColors,this.vertexIndexArray&&(n.vertexIndexArray=i?this.vertexIndexArray:this.vertexIndexArray.slice()),n.boundingBox=this.boundingBox?this.boundingBox.clone():null,n.boundingSphere=this.boundingSphere?this.boundingSphere.clone():null,n.offsetVector=this.offsetVector,n.quantizedVector=this.quantizedVector,n.drawingGroups=[],!r)for(var s=0;s<this.drawingGroups.length;s++){var a=this.drawingGroups[s],o=[],l=new t.DrawingGroup(a.gas,a.material,a.glType,a.start,a.count,null,null,a._geomType,a.gasIndex);if(a instanceof t.DrawingGroup)for(h=0;h<a.getPrimitivesCount();h++){d=new t.SGPrimitive({type:a.getPrimitiveType(h),cgmId:a.getPrimitiveCgmId(h),rep:a.getPrimitiveRep(h),group:l,start:a.getPrimitiveStart(h),count:a.getPrimitiveCount(h)});o.push(d)}else for(var h=0;h<a._primitives.length;h++){var c=a._primitives[h],d=new t.SGPrimitive({type:c.type,cgmId:c.cgmId,rep:c.rep,group:l,start:c.start,count:c.count});o.push(d)}l.geometry=n,l._primitives=o,n.drawingGroups.push(l)}return n}merge(t,i,r){if(!t.layout||!this.layout)throw new Error("Need vertex layout to be able to merge buffers");if(t.layout.getSignature()!==this.layout.getSignature())throw new Error("Cannot merge buffers with different layouts");const n=this.getVertexCount(),s=t.getVertexCount(),a=this.layout.getBufferAttributes(),o=this.layout.getBufferStrides();for(let e=0;e<this.buffers.length;e++){const i=o[e],r=new Uint8Array(i*(n+s));r.set((l=this.buffers[e],new Uint8Array(l.buffer,l.byteOffset,l.byteLength)));const h=a[e];for(let e=0;e<h.length;e++)f.copyRawAttribute({source_bgds:t,source_attr:t.layout.get(h[e]),source_vertex_offset:0,target_array:r,target_attr:this.layout.get(h[e]),target_vertex_offset:n,num_vertices:s});this.buffers[e]=new Float32Array(r.buffer)}var l;this.markAllAttributesStale();const h=this.vertexIndexArray.length,c=t.vertexIndexArray.length,d=h+c>=65536?new Uint32Array(h+c):new Uint16Array(h+c);function u(e){e&&(e.isShared?(e.nbGeometries--,0===e.nbGeometries&&e.deallocate(i,r)):e.deallocate(i,r))}d.set(this.vertexIndexArray,0),d.set(t.vertexIndexArray.map((e=>e+n)),h),this.vertexIndexArray=d,u(this.vertexBufferGPU),this.vertexBufferGPU=null,u(this.indexBufferGPU),this.indexBufferGPU=null;for(let e=0;e<t.drawingGroups.length;e++){let i=t.drawingGroups[e];i.geometry=this,i.start+=h;for(let e=0;e<i.getPrimitivesCount();e++)i._setPrimitiveStart(i.getPrimitiveStart(e)+h,e);this.drawingGroups.push(i)}for(let i=0;i<this.meshList.length;i++){let r=this.meshList[i];if(r.layer)for(let i=0;i<t.drawingGroups.length;i++){let n=t.drawingGroups[i],s=new e.DrawableInterval(1,n.start,n.count);s.primitiveStart=0,s.primitiveCount=n.getPrimitivesCount();let a=new e.LayerInterval(this,n,s);r.layer.layers.push(a)}}return this}}function g(t,i,r,n){!t.buffers[i]&&t.buffers.length?t.layout.remove(r):t.layout.setAttribute({name:r,type:n,offset:0,stride:e.VertexAttribute[n].size,bufferId:i})}e.BufferGeometryDS=f;const m=new Map([["vertexPositionArray",(e,t)=>{e.compressedVertices?g(e,t,"position",e.useCompressionContext?"uint16x4":"float32x2"):g(e,t,"position","float32x3"),e._updateVertexPositionAccessor()}],["vertexNormalArray",(e,t)=>{g(e,t,"normal",e.compressedNormals?"float32":"float32x3"),e._updateVertexNormalAccessor()}],["vertexUvArray",(e,t)=>{g(e,t,"uv",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUVAccessor()}],["vertexUv2Array",(e,t)=>{g(e,t,"uv2",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUV2Accessor()}],["vertexColorArray",(e,t)=>{g(e,t,"color",e.compressedColors?"float32x2":"float32x4"),e._updateVertexColorAccessor()}],["vertexTangentArray",(e,t)=>g(e,t,"tangent","float32x3")],["vertexBinormalArray",(e,t)=>g(e,t,"binormal","float32x3")],["vertexLineDistancesArray",(e,t)=>g(e,t,"lineDistance","float32x2")],["vertexLinePixelDistancesArray",(e,t)=>g(e,t,"linePixelDistance","float32x2")],["vertexPatternStartEndArray",(e,t)=>g(e,t,"patternStartEnd","float32x2")],["vertexPreviousPositionArray",(e,t)=>g(e,t,"previousPos","float32x3")],["vertexNextPositionArray",(e,t)=>g(e,t,"followingPos","float32x3")],["vertexSideExtrusionArray",(e,t)=>g(e,t,"sideExtrusion","float32")],["vertexSkinIndexArray",(e,t)=>g(e,t,"skinIndex","float32x4")],["vertexSkinWeightArray",(e,t)=>g(e,t,"skinWeight","float32x4")]]),v=new Map([["vertexPositionArray","position"],["vertexNormalArray","normal"],["vertexUvArray","uv"],["vertexUv2Array","uv2"],["vertexColorArray","color"],["vertexTangentArray","tangent"],["vertexBinormalArray","binormal"],["vertexLineDistancesArray","lineDistance"],["vertexLinePixelDistancesArray","linePixelDistance"],["vertexPatternStartEndArray","patternStartEnd"],["vertexPreviousPositionArray","previousPos"],["vertexNextPositionArray","followingPos"],["vertexSideExtrusionArray","sideExtrusion"],["vertexSkinIndexArray","skinIndex"],["vertexSkinWeightArray","skinWeight"]]);function _(t){const i=v.get(t);Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){return this.getBufferWithAttribute(i,!0)},set:function(e){let r=this.getBufferIdWithAttribute(i);-1===r&&(r=this.buffers.length),this.buffers[r]=e,m.get(t)(this,r)}})}function y(t,i,r=!1){const n=`__impl_${t}`,s=i.map((e=>v.get(e)));Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){return void 0===this[n]&&(this[n]=r),this[n]},set:function(e){this[n]=e;for(let e=0;e<s.length;e++){const t=this.getBufferIdWithAttribute(s[e]);-1!==t&&m.get(i[e])(this,t)}}})}function S(e,t){Object.defineProperty(e.prototype,t,{get:()=>{throw new Error(`(GET) Invalid property: ${t}`)},set:()=>{throw new Error(`(SET) Invalid property: ${t}`)}})}return y("compressedNormals",["vertexNormalArray"]),y("compressedVertices",["vertexPositionArray"]),y("compressedUVs",["vertexUvArray","vertexUv2Array"]),y("compressedColors",["vertexColorArray"]),_("vertexPositionArray"),_("vertexNormalArray"),_("vertexUvArray"),_("vertexUv2Array"),_("vertexTangentArray"),_("vertexBinormalArray"),_("vertexColorArray"),_("vertexLineDistancesArray"),_("vertexLinePixelDistancesArray"),_("vertexPatternStartEndArray"),_("vertexPreviousPositionArray"),_("vertexNextPositionArray"),_("vertexSideExtrusionArray"),_("vertexSkinIndexArray"),_("vertexSkinWeightArray"),S(e.GLVertexBuffer,"indexBuffer"),S(e.GLVertexBuffer,"indexNumItems"),S(e.GLVertexBuffer,"indexData"),S(e.GLVertexBuffer,"numItems"),S(e.GLVertexBuffer,"geometries"),S(e.GLVertexBuffer,"start"),S(e.GLVertexBuffer,"count"),S(e.BufferGeometryDS,"glFormatTypeIndex"),S(e.BufferGeometryDS,"use32bitIndexBuffer"),S(e.BufferGeometryDS,"itemSize"),S(e.BufferGeometryDS,"numItems"),e})),define("DS/Visualization/ThreeJS_DS",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/Ray","DS/Intersection/Raycaster","DS/Visualization/BufferGeometry","DS/Materials/DeferredCaches","DS/RenderEngineUtils/RenderEngineUtils","DS/Visualization/Layers","DS/Object3D/Object","DS/Object3D/Mesh","DS/Visualization/Polygon"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u){"use strict";var p,f;window.SIMULATE_EXPERIENCE_PLAYER,new i.Color;i.mobileVersion=!1,i._mobileHighlight=!0,i._mobileDevice=!1,i._isLinux=!1,i._vrDevice=!1,i._appleDevice=!1,i._visuFaceMaterialsAsPBR=!1,i._CATGraphicalAsPBR=!0,i._GASFaceMaterialsAsPBR=!1,i._NREGASOnNodeInit=!1,i._AllowPickParentWithPrimitives=!0,i.__AllowMipsForTextures=!0,i.DefaultNormalDepthMaterials=o.DefaultNormalDepthMaterials,i.DefaultShadowDepthMaterials=o.DefaultShadowDepthMaterials,i.DefaultPickingMaterials=o.DefaultPickingMaterials,i.DefaultHighlightMaterials=o.DefaultHighlightMaterials,i.DefaultMaterials=o.DefaultMaterials,i.PredefinedMaterials=o.PredefinedMaterials,i.GeomTypeMaterials=o.GeomTypeMaterials,i.DeferredMaterial=o.DeferredMaterial,i.__tmpIsA2X=!1,window.webVisuPerfo||(window.webVisuPerfo={startPerfo:function(){},endPerfo:function(){},setStats:function(){}}),i.getPixelsPerMM=function(){return 96/25.4},Object.assign(i,u),i.BackgroundViewMode={NORMAL:0,FOG:1,LOWLIGHT:2,GHOST:3,NO_DISPLAY:4},i._loadPredefinedMaterialTextures=o._loadPredefinedMaterialTextures,i.MaterialUtils={_addParameters:function(e,t,i){for(var r=0;r<i.length;r++)void 0!==t[i[r]]&&(e[i[r]]=t[i[r]]);var n=["line","point","depthWrite","depthTest","colorWrite","side","forceSide","force","transparent","polite","enableClipPlanes","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","overridable","iterative","name"];for(r=0;r<n.length;r++)void 0!==t[n[r]]&&(e[n[r]]=t[n[r]])},convertShininessToIoRRoughness:function(e){return null==e?{ior:1.5,roughness:.34}:(e>1&&(e=Math.min(e/128,1)),{ior:1.5,roughness:1-e})},createShinyFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshPhongMaterial(e);var t={shininess:30};e&&this._addParameters(t,e,["color","map","shininess","opacity","alphaTest","vertexColors","useLighting"]);var r=this.convertShininessToIoRRoughness(t.shininess);return Object.assign(t,r),new i.DSPBR19xMaterial(t)},createMatteFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshLambertMaterial(e);var t={specularContrib:0};return e&&this._addParameters(t,e,["color","map","opacity","alphaTest","vertexColors","useLighting"]),new i.DSPBR19xMaterial(t)}},i.TangentToWorld=(p=new i.Vector3,f=new i.Vector3,function(e,t){var i=Math.abs(t.z)<.999?p.set(0,0,1):p.set(1,0,0);f.crossVectors(i,t);var r=f.normalize(),n=p.crossVectors(t,r);return r.multiplyScalar(e.x),n.multiplyScalar(e.y),r.add(n),n.copy(t),n.multiplyScalar(e.z),r.add(n),r}),i.RandomLib={_tmpVec2:new i.Vector2,_tmpVec3:new i.Vector3,HaltonSequence:function(e,t){for(var i=0,r=1/t,n=r;e>0;){i+=e%t*n,e=Math.floor(e/t),n*=r}return i},LowDiscrepancy2D:function(e,t,i,r){var n=this._tmpVec2;return n.x=this.HaltonSequence(e,2),n.y=this.HaltonSequence(e,5),n},computeHaltonSequence4D:function(e){for(var t=e*e,r=new Float32Array(4*t),n=0;n<t;n++)r[4*n]=this.HaltonSequence(n,2),r[4*n+1]=this.HaltonSequence(n,5),r[4*n+2]=this.HaltonSequence(n,7),r[4*n+3]=this.HaltonSequence(n,9);return new i.DataTexture(r,e,e,i.RGBAFormat,i.FloatType)}};i.CSS2DNode=class extends c{constructor(e,t,r){super(),this.element=e||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.position=t||(this.position?this.position:new i.Vector3),this.pickable=!0,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere,this.offset=r||(this.offset?this.offset:new i.Vector2)}},i.DisplayList=l.DisplayList,i.Ray=n,i.Raycaster=s,i.KDTree=null;i.LensFlare=class extends c{constructor(e,t,r,n,s){super(),this.lensFlares=[],this.positionScreen=new i.Vector3,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,r,n,s)}add(e,t,r,n,s,a){void 0===t&&(t=-1),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=new i.Color(16777215)),void 0===n&&(n=i.NormalBlending),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:e,size:t,distance:r,x:0,y:0,z:0,scale:1,rotation:1,opacity:a,color:s,blending:n})}updateLensFlares(){var e,t,i=this.lensFlares.length,r=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<i;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+r*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}clone(e){void 0===e&&(e=new i.LensFlare),super.clone(e),e.positionScreen.copy(this.positionScreen),e.customUpdateCallback=this.customUpdateCallback;for(var t=0;t<this.lensFlares.length;t++){var r=this.lensFlares[t],n={texture:r.texture,size:r.size,distance:r.distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:r.opacity,color:r.color.clone(),blending:r.blending};e.lensFlares.push(n)}return e}};var g={vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 screenPositionFlare;","uniform sampler2D tNormalDepth;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","float visibility = 0.0;","float depth1 = texture2D( tNormalDepth, screenPositionFlare.xy ).w;","float depth2 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005,  0.005) ).w;","float depth3 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005, -0.005) ).w;","float depth4 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005,  0.005) ).w;","float depth5 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005, -0.005) ).w;","if ((depth1 == 0.0) || (screenPositionFlare.z < depth1)) visibility += 0.2;","if ((depth2 == 0.0) || (screenPositionFlare.z < depth2)) visibility += 0.2;","if ((depth3 == 0.0) || (screenPositionFlare.z < depth3)) visibility += 0.2;","if ((depth4 == 0.0) || (screenPositionFlare.z < depth4)) visibility += 0.2;","if ((depth5 == 0.0) || (screenPositionFlare.z < depth5)) visibility += 0.2;","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}"].join("\n")};return i.LensFlarePlugin=function(){var e,t,r;this._lensFlare={},this.init=function(i){if(e=i.context){t=i;var n=this._lensFlare;r=i.getPrecision(),n.vertices=new Float32Array(16),n.faces=new Uint16Array(6);var s,a,o,l,h,c,d=0;n.vertices[d++]=-1,n.vertices[d++]=-1,n.vertices[d++]=0,n.vertices[d++]=0,n.vertices[d++]=1,n.vertices[d++]=-1,n.vertices[d++]=1,n.vertices[d++]=0,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=-1,n.vertices[d++]=1,n.vertices[d++]=0,n.vertices[d++]=1,d=0,n.faces[d++]=0,n.faces[d++]=1,n.faces[d++]=2,n.faces[d++]=0,n.faces[d++]=2,n.faces[d++]=3,n.vertexBuffer=e.createBuffer(),n.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,n.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n.faces,e.STATIC_DRAW),n.program=(s=g,a=r,o=e.createProgram(),l=e.createShader(e.FRAGMENT_SHADER),h=e.createShader(e.VERTEX_SHADER),c="precision "+a+" float;\n",e.shaderSource(l,c+s.fragmentShader),e.shaderSource(h,c+s.vertexShader),e.compileShader(l),e.compileShader(h),e.attachShader(o,l),e.attachShader(o,h),e.linkProgram(o),e.deleteShader(l),e.deleteShader(h),o),n.attributes={},n.uniforms={},n.attributes.vertex=e.getAttribLocation(n.program,"position"),n.attributes.uv=e.getAttribLocation(n.program,"uv"),n.uniforms.map=e.getUniformLocation(n.program,"map"),n.uniforms.tNormalDepth={location:null,value:null},n.uniforms.tNormalDepth.location=e.getUniformLocation(n.program,"tNormalDepth"),n.uniforms.opacity=e.getUniformLocation(n.program,"opacity"),n.uniforms.color=e.getUniformLocation(n.program,"color"),n.uniforms.scale=e.getUniformLocation(n.program,"scale"),n.uniforms.rotation=e.getUniformLocation(n.program,"rotation"),n.uniforms.screenPosition=e.getUniformLocation(n.program,"screenPosition"),n.uniforms.screenPositionFlare=e.getUniformLocation(n.program,"screenPositionFlare")}},this.dispose=function(){e&&(e.deleteBuffer(this._lensFlare.vertexBuffer),e.deleteBuffer(this._lensFlare.elementBuffer),e.deleteProgram(this._lensFlare.program))},this.render=function(r,n,s,a){var o=r.__webglFlares,l=o.length;if(l&&t.lensFlareEnabled){var h,c,d,u,p,f=this._lensFlare,g=new i.Vector3,m=a/s,v=.5*s,_=.5*a,y=16/a,S=new i.Vector2(y*m,y),b=new i.Vector3(1,1,0),x=new i.Vector2(1,1),w=f.uniforms,P=f.attributes;for(e.useProgram(f.program),e.enableVertexAttribArray(f.attributes.vertex),e.enableVertexAttribArray(f.attributes.uv),t.setTexture(w.tNormalDepth.value,0),e.uniform1i(w.tNormalDepth.location,0),e.uniform1i(w.map,1),e.bindBuffer(e.ARRAY_BUFFER,f.vertexBuffer),e.vertexAttribPointer(P.vertex,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(P.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.elementBuffer),e.disable(e.CULL_FACE),e.depthMask(!1),h=0;h<l;h++)if(y=16/a,S.set(y*m,y),u=o[h],g.set(u.matrixWorld.elements[12],u.matrixWorld.elements[13],u.matrixWorld.elements[14]),g.applyMatrix4(n.matrixWorldInverse),!(g.z>0)){g.applyProjection(n.projectionMatrix);var C=.5+.5*g.z;if(b.copy(g),x.x=b.x*v+v,x.y=b.y*_+_,x.x>0&&x.x<s&&x.y>0&&x.y<a)for(e.disable(e.DEPTH_TEST),e.uniform3f(w.screenPositionFlare,.5*(b.x+1),.5*(b.y+1),C),u.positionScreen.copy(b),u.customUpdateCallback?u.customUpdateCallback(u):u.updateLensFlares(),e.uniform1i(w.renderType,2),e.enable(e.BLEND),c=0,d=u.lensFlares.length;c<d;c++)(p=u.lensFlares[c]).opacity>.001&&p.scale>.001&&(b.x=p.x,b.y=p.y,b.z=p.z,y=p.size*p.scale/a,S.x=y*m,S.y=y,e.uniform3f(w.screenPosition,b.x,b.y,b.z),e.uniform2f(w.scale,S.x,S.y),e.uniform1f(w.rotation,p.rotation),e.uniform1f(w.opacity,p.opacity),e.uniform3f(w.color,p.color.r,p.color.g,p.color.b),t.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst),t.setTexture(p.texture,1),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}}},i.createPlaneGeometryDS=function(e,t,n){var s=new i.BufferGeometryDS;s.vertexIndexArray=new Uint16Array(6),s.vertexPositionArray=new Float32Array(12),s.vertexNormalArray=new Float32Array(12),s.vertexUvArray=new Float32Array(12);var a=new r.SGRep({solid:!1}),o=[],l=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,4,0,6,o,void 0,i.GeomTypeEnum.UNKNOWN,0);l.geometry=s,s.drawingGroups.push(l);var h=new r.SGPrimitive({start:0,count:6,cgmId:0,rep:a,group:l});o.push(h),a._primitives.push(h);var c=s.vertexIndexArray;c[0]=0,c[1]=1,c[2]=3,c[3]=1,c[4]=2,c[5]=3;var d=s.vertexPositionArray;d[0]=-.5*e,d[1]=.5*t,d[2]=0,d[3]=-.5*e,d[4]=-.5*t,d[5]=0,d[6]=.5*e,d[7]=-.5*t,d[8]=0,d[9]=.5*e,d[10]=.5*t,d[11]=0;for(var u=s.vertexNormalArray,p=0;p<4;p++)u[3*p]=0,u[3*p+1]=0,u[3*p+2]=1;var f=s.vertexUvArray;return f[0]=0,f[1]=n?0:1,f[2]=0,f[3]=0,f[4]=n?1:0,f[5]=0,f[6]=1,f[7]=n?1:0,f[8]=0,f[9]=1,f[10]=n?0:1,f[11]=0,s.computeBoundingBox(),s.computeBoundingSphere(),s},i.convertParticleSystemToBufferGeometryDS=function(e){if(e&&0===e._type&&e.vertices){var t=e.vertices.length,n=new i.BufferGeometryDS;n.vertexPositionArray=new Float32Array(3*t),n.vertexPositionArray.nonindexedPoints=!0,n.vertexIndexArray=new Uint16Array(1),n.vertexIndexArray[0]=0;var s=new r.SGRep({solid:!1}),a=[],o=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,0,0,t,a,void 0,i.GeomTypeEnum.UNKNOWN,0);o.geometry=n,n.drawingGroups.push(o);var l=new r.SGPrimitive({start:0,count:t,cgmId:0,rep:s,group:o});a.push(l),s._primitives.push(l);for(var h=n.vertexPositionArray,c=0;c<t;c++)h[3*c]=e.vertices[c].x,h[3*c+1]=e.vertices[c].y,h[3*c+2]=e.vertices[c].z;return n.computeBoundingBox(),n.computeBoundingSphere(),n}},i.DrawableInterval=h.DrawableInterval,i.LayerInterval=h.LayerInterval,i.BufferLayer=h.BufferLayer,i.EventTarget=function(){var e={};this.addEventListener=function(t,i){null==e[t]&&(e[t]=[]),-1===e[t].indexOf(i)&&e[t].push(i)},this.dispatchEvent=function(t){for(var i in e[t.type])e[t.type].hasOwnProperty(i)&&e[t.type][i](t)},this.removeEventListener=function(t,i){var r=e[t].indexOf(i);-1!==r&&e[t].splice(r,1)}},i.CSSSVGNode=class extends c{constructor(e){super(),this.element=e,this.element.renderable=this,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere}},UWA.namespace("THREEDS/Core",i)})),define("Visualization/ThreeJS_DS",["DS/Visualization/ThreeJS_DS","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/ThreeJS_DS"),e})),define("DS/Visualization/IESUtils",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadIESTexture:function(i,r,n,s,a,o){var l=new e.DataTexture(null,128,128,e.RFormat,e.FloatType);l.mapping=r,l.generateMipmaps=!1,l.loadEndStatus=e.AssetLoadingStatus.LOADING;var h=new XMLHttpRequest;return h.onload=function(){t.nbTexturesBeingLoaded--;var i,r=t.parserIES(h.response);for(l.image.data=r,l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.minFilter=e.LinearFilter,l.magFilter=e.LinearFilter,l.needsUpdate=!0,n&&n(l),i=0;i<l.onLoadCallbacks.length;i++)l.onLoadCallbacks[i](l)},h.onerror=function(){s(),t.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="text",h.withCredentials=!!a,h.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="text",h.withCredentials=!!a,h.send(null)),l},parserIES:function(e){var t=e.lastIndexOf("TILT="),i=e.slice(t);t=i.indexOf("\n"),i=(i=(i=(i=i.slice(t+1)).replace(/\n|\s|\r/g,"_")).replace("__","_")).split("_");for(var r=[],n=0;n<i.length;n++)""!=i[n]&&(r[r.length]=parseFloat(i[n]));i=null;var s,a,o,l,h,c,d,u=-1,p=-1,f=-1;r[0],r[1],r[2],s=r[3],a=r[4],o=r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],c=13,d=128,l=[s],h=[a];for(var g=[],m=new Float32Array(16384),v=0;v<d;v++)for(var _=0;_<128;_++)m[128*v+_]=0;for(var y=0;y<s;y++)l[y]=r[y+c];c+=parseInt(s);for(var S=0;S<a;S++)h[S]=r[S+c];if(c+=parseInt(a),1==o){90==l[s-1]?p=1:180==l[s-1]&&(p=2),1==a&&0==h[0]?u=0:90==h[a-1]?u=1:180==h[a-1]&&(u=2);for(S=0;S<a;S++)for(y=0;y<s;y++){var b=r[y+S*s+c];f=f<b?b:f}if(0==u){a=2,h[1]=180;for(y=0;y<s;y++)r[y+s+c]=r[y+c]}if(1==u){if(1==p){for(S=0;S<a;S++){var x=90-(h[S]-90);g[h[S]]=[2*s],g[x]=[2*s];for(y=0;y<s;y++){var w=90-(l[y]-90);g[h[S]][l[y]]=g[x][l[y]]=g[h[S]][w]=g[x][w]=r[y+S*s+c]/f}}for(y=0;y<s-1;y++)l.push(90-(l[y]-90))}else if(2==p)for(S=0;S<a;S++){x=90-(h[S]-90);g[h[S]]=[2*s],g[x]=[2*s];for(y=0;y<s;y++)g[h[S]][l[y]]=g[x][l[y]]=r[y+S*s+c]/f}for(S=0;S<a-1;S++)h.push(90-(h[S]-90))}else if(0==u||2==u){if(1==p){for(S=0;S<a;S++){g[h[S]]=[2*s];for(y=0;y<s;y++){w=90-(l[y]-90);g[h[S]][l[y]]=g[h[S]][w]=r[y+S*s+c]/f}}for(y=0;y<s-1;y++)l.push(90-(l[y]-90))}else if(2==p)for(S=0;S<a;S++){g[h[S]]=[s];for(y=0;y<s;y++)g[h[S]][l[y]]=r[y+S*s+c]/f}}else console.log("Erreur symetricHType "+u);h=h.sort((function(e,t){return e-t})),l=l.sort((function(e,t){return e-t}));var P=1.40625,C=h[0],M=h[1],E=1;for(S=0;S<180;S+=P){for(;S>M;)C=M,M=h[E+1],E++;var T=l[0],A=l[1],D=1,I=(S-C)/(M-C);for(y=0;y<180;y+=P){for(;y>A;)T=A,A=l[D+1],D++;var R=(y-T)/(A-T),O=(1-R)*g[C][T]+R*g[C][A],L=(1-R)*g[M][T]+R*g[M][A];m[S/P*d+y/P]=(1-I)*O+I*L}}}else console.log("Mauvais Gonio Type");return m}};return t})),define("DS/Visualization/ColladaLoader",["DS/VisuLoaders/ColladaLoader","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";return t})),define("DS/Visualization/CameraSystem",["UWA/Class","DS/ShaderBuilders/PostPro/StereoShaderBuilders","DS/Plugins/ShaderPass_New","DS/Plugins/RenderPass","DS/Materials/PostProMaterial","DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass"],(function(e,t,i,r,n,s,a){"use strict";var o=e.extend({init:function(){this._computeCameraArrayCB=null,this._predefinedCombineShader=null,this._shaderParameters=null,this._extFrameBuffer=null},setComputeCameraArrayCB:function(e,t){this._computeCameraArrayCB=e,this.useExternalProjectionMatrix=!!t},setUsePredefinedCombineShader:function(e,t){this._predefinedCombineShader=e,this._shaderParameters=t;var i=l[this._predefinedCombineShader];i.warmup&&i.warmup()},getViewportSize:function(e,t){return l[this._predefinedCombineShader].getViewportSize.apply(this,arguments)},computeCameraArray:function(e,t,i){var r,n=this._computeCameraArrayCB(e,t,i);for(r=0;n&&r<n.length;r++)n[r].updateMatrix(),n[r].updateMatrixWorld(),n[r].updateProjectionMatrix(),n[r].projectionMatrixInverse.getInverse(n[r].projectionMatrix);return n},getUniformName:function(e){return l[this._predefinedCombineShader].uniformsName[e]},applyShaderParameters:function(e){var t;if(e&&this._shaderParameters)for(t in this._shaderParameters)e.setUniform(t,this._shaderParameters[t])},isReady:function(){var e=l[this._predefinedCombineShader];return"ShaderPass"===e.type||e.ready},createPasses:function(e){var t=l[this._predefinedCombineShader];"ShaderPass"===t.type?(this.stereoPass=new i(t.combineShader,"stereoPass"),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)):"RenderPass"===t.type&&(this.clearPass=new a("combineClearPass"),e.addPass(this.clearPass),e.composerContext.setPassRenderToCanvas(this.clearPass,!0),this.stereoPass=new r(null,null,null,null,null,null,"combineStereoPass"),this.stereoPass.setDepthFunc("ALWAYS"),this.stereoPass.setDisableBackFaceCulling(!0),this.stereoScene=new s.Scene,this.stereoScene.renderResultIndices={},t.fillScene(this.stereoScene),this.stereoPass.scene=this.stereoScene,e.composerContext.setPassClear(this.clearPass,!0,new s.Color(0),1),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)),e.addPass(this.stereoPass)},updatePasses:function(e,t,i){var r,n=l[this._predefinedCombineShader];if("ShaderPass"===n.type){for(r=0;r<e.length;r++){var s=this.getUniformName(r);this.stereoPass.material.setUniform(s,i[e[r]])}this.applyShaderParameters(this.stereoPass.material)}else if("RenderPass"===n.type){var a=this.stereoPass.scene;for(r=0;r<a.myMeshes.length;r++){var o;for(o in a.myMeshes[r].material.setUniform("tEye",i[e[a.renderResultIndices[a.myMeshes[r].id]]]),n.parameters[r])a.myMeshes[r].material.setUniform(o,n.parameters[r][o]);if(this._shaderParameters)for(o in this._shaderParameters[r])a.myMeshes[r].material.setUniform(o,this._shaderParameters[r][o])}}this.stereoPass.renderToScreen=t},isStereo:function(){return!0},setExternalFrameBuffer:function(e){this._extFrameBuffer=e},getExternalFrameBuffer:function(){return this._extFrameBuffer}}),l={leftRight:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:t.LeftRight,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK1:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:t.OculusDK1,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},anaglyph:{getViewportSize:function(e,t){return{width:e,height:t}},combineShader:t.Anaglyph,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK2:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},ready:!1,warmup:function(){require(["DS/OculusDK2/OculusDK2DeformationMeshCreator"],(function(e){l.oculusDK2.ready=!0,l.oculusDK2.OculusDK2DeformationMeshCreator=e}))},fillScene:function(e){var i=l.oculusDK2,r=new n({postProContext:t.OculusDK2});i.OculusDK2DeformationMeshCreator.fillScene(e,r)},parameters:[{eyeToSourceUVScale:new s.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new s.Vector2(.492164134,.5)},{eyeToSourceUVScale:new s.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new s.Vector2(.507835866,.5)}],type:"RenderPass"}};return o})),define("DS/Visualization/TrapSelection",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent"],(function(e,t,i,r,n,s,a){"use strict";var o=function(e){this.extremities={xPix:0,x:0,yPix:0,y:0},this.originPoint=null,this.isActive=!1,this.isInterrupted=!1,this.advancedSelection=!1,this.userTransformationCB=null,this.createCallbacks(),e&&(this.viewer=e),this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap);var t=this.viewer.currentViewpoint?this.viewer.currentViewpoint.getControl():null;this.mode=t?t._mode:1,this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown"};return o.prototype.set=function(e){switch(e){case!0:this.activate(!1);break;case"advanced":this.activate(!0);break;case!1:this.disable()}},o.prototype.setUserTransformation=function(e){this.userTransformationCB=e},o.prototype.updateMode=function(e,t){var i=this.viewer.picking.trapSelection;e.setSpinnerOnHold(!(0===this.mode||!i)),t!==this.mode&&(this.mode=t,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",i&&n.addEvent(this.viewer.canvas,this.downEvent,this.downCB))},o.prototype.setDiv=function(e){this.divTrap=e,this.divTrap.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black"}),this.divTrap.hide()},o.prototype.activate=function(e){this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",this.forwardSelect=null,this.advancedSelection=e,!this.divTrap&&this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap),n.addEvent(this.viewer.canvas,this.downEvent,this.downCB),n.addEvent(this.viewer.canvas,"onHold",this.downCB),n.addEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.disable=function(){this.userTransformationCB=null,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),n.removeEvent(this.viewer.canvas,"onHold",this.downCB),n.removeEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.getExtremities=function(){return this.extremities},o.prototype.setExtremities=function(e,t){if(t){var i,r={},n={},s=!0;if(e.xPix<t.xPix?(s=!0,r.xPix=e.xPix,r.x=e.x,n.xPix=t.xPix,n.x=t.x):(s=!1,r.xPix=t.xPix,r.x=t.x,n.xPix=e.xPix,n.x=e.x),e.yPix<t.yPix?(r.yPix=e.yPix,r.y=e.y,n.yPix=t.yPix,n.y=t.y):(r.yPix=t.yPix,r.y=t.y,n.yPix=e.yPix,n.y=e.y),this.extremities=r,this.extremities.pt=n,this.advancedSelection&&this.divTrap&&this.forwardSelect!==s)i=s?{border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}:{border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"},this.divTrap.setStyles(i),this.forwardSelect=s}else this.extremities=e},o.prototype.createCallbacks=function(){var e=this;this.interrupt=function(){e.softInterrupt(),e.viewer.setCursor("Auto")},this.softInterrupt=function(){e.isActive=!1,e.isInterrupted=!0,n.removeEvent(document,"onMouseMove",e.moveCB),n.removeEvent(document,"onLeftMouseUp",e.upCB),n.removeEvent(document,"onSwipe",e.moveCB),n.removeEvent(document,"onRelease",e.upCB),e.setExtremities({x:-1,y:-1})},this.downCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i)),e.originPoint=e.viewer.getMousePosition(i),e.setExtremities(e.originPoint),e.startTime=Date.now(),e.isActive=!0,e.isInterrupted||(e.viewer.setCursor("TrapSelection",100),n.addEvent(document,"onMouseMove",e.moveCB),n.addEvent(document,"onLeftMouseUp",e.upCB),n.addEvent(document,"onSwipe",e.moveCB),n.addEvent(document,"onRelease",e.upCB)),e.isInterrupted=!1},this.moveCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i));var r=e.viewer.getMousePosition(i);e.setExtremities(e.originPoint,r);var n=e.viewer.devicePixelRatio;e.divTrap&&(e.divTrap.show(),e.divTrap.setStyles({width:(e.extremities.pt.xPix-e.extremities.xPix)/n,height:(e.extremities.pt.yPix-e.extremities.yPix)/n,left:e.extremities.xPix/n,top:e.extremities.yPix/n,pointerEvents:"none"}))},this.upCB=function(t){e.divTrap&&(e.divTrap.hide(),e.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"})),e.interrupt(),e.isInterrupted=!1}},o})),define("DS/Visualization/Filters/VisuFilter",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";return class{constructor(){}solveInherit(e,t,i){return this}}})),define("DS/Visualization/Filters/PolygonOffsetFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e,t){super(),this.factor=e,this.unit=t}enabled(){return 0!==this.factor&&0!==this.unit}}})),define("DS/Visualization/Filters/SideFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this.side=e}}})),define("DS/Visualization/Filters/LODNodeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t,i){"use strict";class r extends t{constructor(e,t){super(),this.rootFilter=e,this.occ=t;const i=t.parent.children.indexOf(t);this.isLastLOD=!1,this.lodIndex=i,t.parent.children.length>e.lods.length?this.isLastLOD=i>=e.lods.length:i>=0&&e.lods[0].index===i&&(this.isLastLOD=!0)}solveInherit(e,t){throw"LODOccurrenceFilter: not heritable"}canRender(){var e=this.rootFilter.getCurrrentLOD();return-1===e?this.isLastLOD:this.rootFilter.lods[e].index===this.lodIndex}}class n{constructor(e,t){this.filters=[],e&&t&&this.filters.push(new r(e,t))}_add(e,t){var i=new n;for(let e=0;e<this.filters.length;e++)i.filters.push(this.filters[e]);return i.filters.push(new r(e,t)),i}canRender(){for(let e=0;e<this.filters.length;e++)if(!this.filters[e].canRender())return!1;return!0}isLastLOD(){for(let e=0;e<this.filters.length;e++)if(!this.filters[e].isLastLOD)return!1;return!0}solveInherit(e,t){return this}}class s{constructor(){this.frameIndex=0,this.selectedLODIndex=-1}}const a={currentFrameIndex:-1};class o{constructor(e,t){this.occ=t,this.lods=e.lods,this._cache=new Map}_getSAG(t){if(!t)return 0;const i=this.occ,r=i.scene3js.viewer,n=r.renderer.renderer||a,s=i._getViewpoint()||r.currentViewpoint,o=s.camera,l=r._viewpointManager.getViewpointViewport(s)||{height:r.renderer.deviceHeight},h=o.position,c=(new e.Plane).setFromNormalAndCoplanarPoint(o.getLookAt(),h.clone().add(o.getLookAt().clone().multiplyScalar(o.near)));let d=o.getCameraConstant(n.devicePixelRatio,l.height/n.viewportData.viewportScale);o.fullWidth&&(d*=o.height/o.fullHeight);const u=t.center,p=t.radius+t.pixelRadius/d,f=r._currentLOD;return f*d*(-c.normal.x*(h.x-u.x)+-c.normal.y*(h.y-u.y)+-c.normal.z*(h.z-u.z)+p*(.5*f-1))}getCurrrentLOD(){const t=this.occ,i=this.lods,r=t.scene3js.viewer;if(!r)return-1;const n=t._getViewpoint()||r.currentViewpoint;if(!n||!n.camera)return-1;const o=r.renderer.renderer||a;let l=this._cache.get(o);l||(l=new s,this._cache.set(o,l));const h=o.currentFrameIndex;if(l.frameIndex===h&&h>=0)return l.selectedLODIndex;l.frameIndex=h;let c=null;const d=t.getBoundingSphere("visibleSpace",!0),u=t.getBoundingSphere("invisibleSpace",!0);d&&!u?c=d:u&&!d?c=u:d&&u&&(c=new e.Sphere,d.mergeWithSphere(u,c));const p=l.selectedLODIndex;if(l.selectedLODIndex=-1,c){const e=this._getSAG(c);if(e<=0)l.selectedLODIndex=-1;else{l.selectedLODIndex=i.length-1;for(let t=0;t<i.length;t++)if(e<i[t].sag){l.selectedLODIndex=t-1;break}}}return p!==l.selectedLODIndex&&r._updateShadowMaps(),l.selectedLODIndex}_getContainer(e,t){return t?t._add(this,e):new n(this,e)}solveInherit(e,t){return null}}return class extends t{constructor(e){super(),this.lods=[];for(let t=0;t<e.length;t++)this.lods.push({sag:e[t],index:t});this.lods=this.lods.sort(((e,t)=>e.sag-t.sag))}solveInherit(e,t){return new o(this,e)}}})),define("DS/Visualization/Filters/LookFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this.material=e,this.shadowReceive=-1,this.shadowCast=-1}usingShadowReceive(e){return this.shadowReceive=!0===e?1:!1===e?0:-1,this}usingShadowCast(e){return this.shadowCast=!0===e?1:!1===e?0:-1,this}}})),define("DS/Visualization/Filters/DynamicModeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e,t){super(),this.draw=e,this.pick=t}}})),define("DS/Visualization/Filters/ZModeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this.enableZ=e}}})),define("DS/Visualization/Filters/NoHighlightFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";class i extends t{constructor(e,t){super(),this.skipHL=e,this.skipPreHL=t}isEqual(e){return this.skipHL===e.skipHL&&this.skipPreHL===e.skipPreHL}solveInherit(e,t,r){if(!t)return this;var n=new i(this.skipHL||t.skipHL,this.skipPreHL||t.skipPreHL);return n.isEqual(t)?t:n.isEqual(this)?this:n}}return i})),define("DS/Visualization/Filters/DoNotPickUnderFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this._doNotPickUnder=e}}})),define("DS/Visualization/Filters/FurtiveFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this.state=e}}})),define("DS/Visualization/SubElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/VisuIdentification/Node","DS/VisuIdentification/Pattern"],(function(e,t,i,r,n){"use strict";var s={},a=30,o=0,l=e.extend({init:function(e,t){if(t!==s&&a>0){var i=(new Error).stack;i=i&&i.substring(i.indexOf("\n")+1),console.warn("Use of deprecated constructor.\nUse SubElement.getFromSGNode() instead.\n"+i),a--}this.sgNode=e,this._internalGeometryData=null,this.id=o++},getDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return"point";case 1:case 2:case 3:return"line";case 4:case 5:case 6:return"surface";default:return""}}return""},getCellDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return 0;case 1:case 2:case 3:return 1;case 4:case 5:case 6:return 2;default:return-1}}return-1},getBodyDimension:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t=e.getRep?e.getRep():e.rep;return t&&t.solid?3:2}return-1},getType:function(){if(this.sgNode){var e=this.sgNode;if(e.getFirstPrimitive)return"selectionGroup";switch(e.getType?e.getType():e.type){case 0:return"node";case 1:return"bag";case 2:return"rep";case 3:return"primitive";default:return""}}return""},getGeometricType:function(){if(this.sgNode&&"primitive"===this.getType()){var e=this.sgNode.getGroup();if(e)return i.GeomTypeString[e._geomType]}return null},getParent:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t="primitive"===this.getType()?e.getRep():e.parents?e.parents[0]:null;if(t)return THREEDS.SubElement.getFromSGNode(t)}return null},getChildren:function(){var e,t=[];if(this.sgNode){var r=this.getType();if("rep"===r)for(e=0;e<this.sgNode.getPrimitivesCount();e++){var n=new i.SGPrimitiveHelper;n.set(this.sgNode,e),t.push(THREEDS.SubElement.getFromSGNode(n))}else if("selectionGroup"===r){var s=this.sgNode.getPrimitives();for(e=0;e<s.length;e++)t.push(THREEDS.SubElement.getFromSGNode(s[e]))}else for(e=0;e<this.sgNode.children.length;e++)t.push(THREEDS.SubElement.getFromSGNode(this.sgNode.children[e]))}return t},getPrimitives:function(e){var t=e||[],r=this.getType();if("primitive"===r)t.push(this.sgNode);else if("rep"===r)for(var n=0;n<this.sgNode.getPrimitivesCount();n++){var s=new i.SGPrimitiveHelper;s.set(this.sgNode,n),t.push(s)}else for(n=0;n<this.sgNode.children.length;n++)THREEDS.SubElement.getFromSGNode(this.sgNode.children[n]).getPrimitives(t);return t},getCGMID:function(){return this.sgNode&&!this.sgNode.getFirstPrimitive?this.sgNode.getCgmId?this.sgNode.getCgmId():this.sgNode.cgmId:""},getModelIdentification:function(){return this.getIdentificationObject()},getIdentificationObject:function(){var e,t=this.sgNode;return t&&(t.getFirstPrimitive&&(t=t.getFirstPrimitive()),t.getIdentificationObject&&(e=t.getIdentificationObject())),e},getMeshes:function(){var e=[],t=[];if(this.sgNode&&"primitive"===this.getType()){var i=this.sgNode.getGroup();if(i&&i.geometry)for(var r=i.geometry.meshList,n=0;n<r.length;n++){var s=r[n];t.push(s._occurrence.node)}}var a=-1,o=null;t.length&&(t.sort((function(e,t){return e.id-t.id})),a=t[0].id,e.push(t[0]));for(var l=1;l<t.length;l++)a!==(o=t[l]).id&&(a=o.id,e.push(o));return e},getReps:function(){var e,t=[];if("rep"===this.getType())t.push(this);else for(e=0;e<this.children.length;e++)t=t.concat(this.children[e].getReps());return t}});return l.getFromSGNode=function(e){if(e instanceof i.SGPrimitive){var t=e.group,r=t._primitives.indexOf(e);(e=new i.SGPrimitiveHelper).set(t,r)}return e._setInternalNode?(e._getInternalNode()||e._setInternalNode(new THREEDS.SubElement(e,s)),e._getInternalNode()):(e.internalNode||(e.internalNode=new THREEDS.SubElement(e,s)),e.internalNode)},UWA.namespace("THREEDS/SubElement",l)})),define("Visualization/SubElement",["DS/Visualization/SubElement","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/SubElement"),e})),define("DS/Visualization/PathElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],(function(e,t,i,r,n){"use strict";var s=0,a=t.__visibleInCurrentSpace,o=e.extend({init:function(e){this._uid=s++,this.externalPath=[],this.internalPath=[],this._key=null,this.setFromArray(e)},getUID:function(){return this._uid},getLength:function(){return this.externalPath.length+this.internalPath.length},getLastElement:function(e,t){return!e&&this.internalPath.length?this.internalPath[this.internalPath.length-1]:!t&&this.externalPath.length?this.externalPath[this.externalPath.length-1]:null},getElement:function(e,t){return e<this.externalPath.length?this.externalPath[e]:!t&&e<this.getLength()?this.internalPath[e-this.externalPath.length]:null},isEqual:function(e){var t;if(!e)return!1;if(this.externalPath.length!==e.externalPath.length)return!1;if(this.internalPath.length!==e.internalPath.length)return!1;if(this.instanceId!==e.instanceId)return!1;for(t=0;t<this.externalPath.length;t++)if(this.externalPath[t]!==e.externalPath[t])return!1;for(t=0;t<this.internalPath.length;t++){var i=this.internalPath[t].sgNode,n=e.internalPath[t].sgNode;if(i instanceof r.SGPrimitive||i instanceof r.SGPrimitiveHelper){if(!(n instanceof r.SGPrimitive||n instanceof r.SGPrimitiveHelper))return!1;if(!i.isEqual(n))return!1}else if(i!==n)return!1}return!0},empty:function(){this.externalPath=[],this.internalPath=[]},clone:function(){for(var e=new THREEDS.PathElement(this.externalPath),t=0;t<this.internalPath.length;t++){var i=this.internalPath[t];i&&e.internalPath.push(i)}return this._key&&(e._key=this._key),this.instanceId&&(e.instanceId=this.instanceId),e},copy:function(e){this.externalPath=e.externalPath.slice(),this.internalPath=e.internalPath.slice()},addElement:function(e){return e&&(e.getNotAllowedInPathElement?e.getNotAllowedInPathElement()&&l():e.notAllowedInPathElement&&l()),this._key&&delete this._key,e instanceof THREEDS.Nodes.Node3D?(this.externalPath.push(e),!0):e instanceof n&&(this.internalPath.push(e),!0)},setFromArray:function(e,t){var i;if(this._key=null,void 0===e||!Array.isArray(e))return!1;var r=[];for(i=0;i<e.length;i++){var n=e[i];if(n.getNotAllowedInPathElement&&n.getNotAllowedInPathElement()||n.notAllowedInPathElement)l();else{if(null===n)return!1;r.push(n)}}var s=[];if(t&&Array.isArray(t))for(i=0;i<t.length;i++){var a=t[i];if(null===a)return!1;s.push(a)}return this.getLength()&&this.empty(),this.externalPath=r,this.internalPath=s,!0},setFromOccurrence:function(e,t,i,r){if(null==e)return!1;var n=e.node,s=n&&n._getDisablePrimPicking(),a=e.parent;this.externalPath=[n];for(var o=!1;null!==a&&!o&&(n=a.node,a=a.parent,!n.getNotAllowedInPathElement());)this.externalPath.unshift(n),i&&n===i&&(o=!0);var l=i&&o||!i;if(null==t||s&&r)return l;a=t.getParent();for(this.internalPath=[t];null!==a;)this.internalPath.unshift(a),a=a.getParent();return l},setFromOccurrencePath:function(e,t){if(null==e)return!1;var i=e.getSize();if(!i)return!1;for(var r=[],n=0;n<i;n++){var s=e.getNodeName(n);if(null===s)return!1;var a=t.getChildByName(s);if(null===a)return!1;a.getNotAllowedInPathElement()?l():r.push(a)}return this.getLength()&&this.empty(),this.externalPath=r,!0},addSubstituteMaterial:function(e,t,i,r=!1){this._getOccurrences(e).forEach(((e,n,s)=>e._addSubstituteMaterial(t,i,r)))},removeSubstituteMaterial:function(e,t){this._getOccurrences(e).forEach(((e,i,r)=>e._removeSubstituteMaterial(t)))},_getOccurrences:function(e){var t,i,r,n,s,a,o,l;if(!this.externalPath.length)return[];if(null===(t=this.externalPath[0]))return[];if(!(n=t._occurrences))return[];for(e&&(n=n.filter((function(t){return t.scene3js&&t.scene3js.viewer===e}))),s=[],l=1;l<this.externalPath.length;l++){for(t=this.externalPath[l],a=0;a<n.length;a++)for(i=n[a].children,o=0;o<i.length;o++)(r=i[o]).node===t&&s.push(r);n=s,s=[]}return n},_getOccurrenceFromRootOccurrence:function(e){if(e.node!==this.externalPath[0])return null;var t,i,r,n,s,a=e;for(t=1;t<this.externalPath.length;t++){for(r=this.externalPath[t],s=null,i=0;i<a.children.length&&null==s;i++)(n=a.children[i]).node===r&&(s=n);if(null===s)return null;a=s}return a},_getRenderableOccurrences:function(e,t){var i,r,n,s,a;if(r=[],i=this._getOccurrences(e))for(s=0;s<i.length;s++)for(n=i[s]._getRenderableOccurrences(t),a=0;a<n.length;a++)r.push(n[a]);return r},_getUniqueOccurrence:function(e){var t=this._getOccurrences(e);if(t&&1===t.length)return t[0];var i,r,n=[];for(i=0;i<t.length;i++){if(r=t[i],n.indexOf(r.scene3js)>=0)return null;n.push(r.scene3js)}return t[0]||null},getKey:function(){if(!this._key){var e=0,t="";for(e=0;e<this.externalPath.length;e++)t+=(0===e?"":"/")+this.externalPath[e].id;for(t+="//",e=0;e<this.internalPath.length;e++)t+=(0===e?"":"/")+this.internalPath[e].id;this._key=t}return this._key},hash:function(){if(!this._hash){var e,t=0,i="";if(this.internalPath.length){if(!((e=this.internalPath[this.internalPath.length-1])instanceof n))throw new Error("Unknown node");var r=e.sgNode;r&&(r.getStart?i+=r.getStart()+"/":r.start&&(i+=r.start+"/"))}for(t=this.externalPath.length-1;t>=0;t--)i+=this.externalPath[t].id+"/";this._hash=i}return this._hash},getParentPath:function(){var e=this.externalPath.concat(this.internalPath);if(e.length<=1)return null;var t,i=new THREEDS.PathElement;for(t=0;t<e.length-1;t++)i.addElement(e[t]),e[t]._instancingInfos&&(i.instanceId=this.instanceId);return i},getChildrenPathes:function(e){var t,i,r=[],n=this.getLastElement(),s=e?e.getKey():null;if(null===n)return!1;if(n.children)for(t=0;t<n.children.length;t++)(i=this.clone()).addElement(n.children[t]),i.getKey()!==s&&r.push(i);return r},getSiblingsPathes:function(){var e=this.getParentPath();return e?e.getChildrenPathes(this):[]},getAncestorsPathes:function(){for(var e=this,t=[];e;)t.unshift(e),e=e.getParentPath();return t},getSubPath:function(e){if(this.internalPath.length>0)return null;var t,i=null,r=null;for(t=this.externalPath.length-2;t>=0&&null===i;t--)e(this.externalPath[t])&&(i=t);if(null!==i)for(r=new o,t=0;t<=i;t++)r.addElement(this.externalPath[t]);return r},getPathesFromSelectionGroupPath:function(){var e=this.getLastElement(!1);if(!(e&&e.sgNode&&e.sgNode instanceof r.SelectionGroup))return null;for(var t=[],i=e.sgNode.getPrimitives(),s=0;s<i.length;s++){var a=i[s],o=this.getParentPath();o.addElement(n.getFromSGNode(a)),t.push(o)}return t},toJSON:function(e){for(var t,i={},r=[],n=this.externalPath[0];n;)r=[n].concat(r),n=n.parents.length&&n!==e?n.parents[0]:null;function s(e){return e.getPersistentId?{persistent:!0,value:e.getPersistentId()}:{persistent:!1,value:e.parents[0].children.indexOf(e)}}for(i.firstElementPath=[],t=0;t<r.length;t++)((n=r[t]).parents.length||n!==e)&&i.firstElementPath.push(s(n));for(i.externalPathRest=[],t=1;t<this.externalPath.length;t++)i.externalPathRest.push(s(this.externalPath[t]));return i},setFromJSON:function(e,t){var i,r=t;function n(e,t){var i,r;if(!t.persistent)return e.children[t.value];for(i=0;i<e.children.length;i++)if((r=e.children[i]).getPersistentId&&r.getPersistentId()===t.value)return r;return null}for(i=0;i<e.firstElementPath.length;i++)r=n(r,e.firstElementPath[i]);var s=[r];for(i=0;i<e.externalPathRest.length;i++)s.push(n(s[s.length-1],e.externalPathRest[i]));for(i=0;i<s.length;i++)s[i].getNotAllowedInPathElement()||this.addElement(s[i])},_dbgPrint:function(){for(var e="ext:[",t=this.externalPath.length,i=0;i<t;i++){(r=this.externalPath[i])&&(e+=r.name),i<t-1&&(e+=", ")}e+="] int:[",t=this.internalPath.length;for(i=0;i<t;i++){var r;(r=this.internalPath[i])&&(e+=r.getCGMID()),i<t-1&&(e+=", ")}return e+="]"},getMatrix:function(e){var t=this._getUniqueOccurrence(e);if(!t)return null;let i=t.getOriginalOverrideSetToUse();if(i){var r=i.getSubstituteMatrix();if(r)return r.clone()}var n=this.getLastElement(!0);return null===n?null:n.getMatrix()},getWorldMatrix:function(e,t){var i=this._getUniqueOccurrence(e);if(i&&i.matrix){i._tryOverridesUpdateWithAncestors(e);let r=i.matrix;if(this.instanceId&&i._instancingInfos&&i._instancingInfos.useDefaultInstancing){let e=i;for(;e&&!e.node._instancingInfos;)e=e.parent;e&&(r=e.node._getInstanceWorldMatrixFromInstanceId(this.instanceId,e,i))}return t?(t.copy(r),t):r.clone()}return null},getMatrixInAxisSystem:function(e,i){var r=this.getWorldMatrix(i);if(!r)return null;var n=new t.Matrix4,s=new t.Matrix4;return s.getInverse(e),n.multiplyMatrices(s,r),n},getBoundingSphere:function(e,t,i){"show"===t&&(console.error("DEPRECATED: use visibleSpace instead of show"),t="visibleSpace"),"noShow"===t&&(console.error("DEPRECATED: use invisibleSpace instead of noShow"),t="invisibleSpace");var r=this.getWorldMatrix(e);if(!r)return null;var n=this._getUniqueOccurrence(e);if(!n)return null;e=e||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(e);var s=null;i&&0!==this.internalPath.length?s=this.getLastElement().sgNode.computeBoundingSphere().clone():s=n.getBoundingSphere(t).clone();return s.center.applyMatrix4(r),s},getBoundingBox:function(e,t,i){if(t){"show"===i&&(console.error("DEPRECATED: use visibleSpace instead of show"),i="visibleSpace"),"noShow"===i&&(console.error("DEPRECATED: use invisibleSpace instead of noShow"),i="invisibleSpace");var r=this.getWorldMatrix(t);if(!r)return null;e&&e.copy(r);var n=this._getUniqueOccurrence(t);return n?(t=t||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(t),n.getBoundingBox(i).clone()):null}},getFilterGeomType:function(e){if(!e)return 0;var t=this._getUniqueOccurrence(e);if(!t)return 0;var i=t.renderable;return i?i.getFilterGeomType():0},getOrientedBoundingBox:function(e,i,r,n,s,o){if(!i)return null;var l=n||(1===i.visibleSpace?"visibleSpace":"invisibleSpace"),h=this._getUniqueOccurrence(i);if(o=!!o,!h)return null;r=r||t.FixedSizeFiltering.Include,s=s||[];for(var c=0,d=0;d<s.length;d++){c|=s[d]}if(h._tryOverridesUpdateWithAncestors(i),o&&0!==this.internalPath.length){var u=h.renderable;if(!u)return h.computeAccurateBoundingBox(l,e,r,c);if(!a(u.visible,u.visibilityFree,"visibleSpace"===l,h))return new t.Box3;var p=h._isFixedSize();if(p&&r===t.FixedSizeFiltering.Exclude)return new t.Box3;var f=new t.Matrix4;null!==e?f.multiplyMatrices((new t.Matrix4).getInverse(e),u._getMMMatrix()):f=u._getMMMatrix();var g=h._getRenderModes(),m=u.getFilterGeomType();return this.getLastElement().sgNode._computeOrientedBoundingBox(f,g&~c,r,p,m?m._geomType:0)}return h.computeAccurateBoundingBox(l,e,r,c)},checkExternalPath:function(){var e,t,i,r=!0;for(e=0;e<this.externalPath.length-1&&r;e++)t=this.externalPath[e],i=this.externalPath[e+1],t.children.indexOf(i)<0&&(r=!1);return r},isAParentOf:function(e){function t(e,t){var i=[],r=(e[0],e[0]);if(1===r.parents.length&&r!==t){for(r=r.parents[0];1===r.parents.length&&r!==t;)i.unshift(r),r=r.parents[0];i.unshift(r)}return i=i.concat(e)}var i,r,n,s=this.externalPath[0],a=e.externalPath[0];if(s===a?(i=this.externalPath,r=e.externalPath):this.externalPath.indexOf(a)>0?(i=this.externalPath,r=t(e.externalPath,s)):(i=t(this.externalPath,a),r=e.externalPath),r[0]===i[0]){if(i.length<=r.length){for(n=0;n<i.length&&i[n]===r[n];)n++;return n===i.length}return!1}return!1},concatenatePathes:function(e,t){var i=e.externalPath.concat(t.externalPath);this.setFromArray(i)},substractPath:function(e,t){var i,r=t.externalPath.concat([]),n=e.externalPath;r.indexOf(n[n.length-1]);for(i=0;i<n.length;i++)if(n[i]!==r[i])return!1;return r.splice(0,n.length-1),this.setFromArray(r),!0},setRenderPasses:function(e){for(var t=this._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].setVisibleInPasses(e)},getParentOccurrencePath:function(){return this.getParentPath.apply(this,arguments)},getChildrenOccurrencePathes:function(){return this.getChildrenPathes.apply(this,arguments)},getSiblingsOccurrencePathes:function(){return this.getSiblingsPathes.apply(this,arguments)},getAncestorsOccurrencePathes:function(){return this.getAncestorsPathes.apply(this,arguments)},_getIndexFromNode:function(e){return this.externalPath.indexOf(e)},_findSGNodeByLocalId:function(e,t){var i,r=e.getIdentificationObject?e.getIdentificationObject():null;r&&(r.getLocalId()===t&&(i=e));if(!i&&e.children)for(var n=e.children,s=0;s<n.length&&void 0===(i=this._findSGNodeByLocalId(n[s],t));s++);return i},findAssociatedSGNode:function(e,t){var i;if(e.parents)for(var r=e.parents,n=0;n<r.length;n++)if(r[n]instanceof THREEDS.Nodes.CGRNode)i=this._findSGNodeByLocalId(r[n].internalSceneGraph,t);else if(void 0!==(i=this.findAssociatedSGNode(r[n],t)))break;return i}});function l(){console.warn("An attempt to add an unauthorized node to a PathElement has been countered.\nPlease remove the node from your PathElement creation.\nNode returned by viewer.getRootNode() and any of its parents may not be part of a PathElement")}return UWA.namespace("THREEDS/PathElement",o)})),define("Visualization/PathElement",["DS/Visualization/PathElement","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/PathElement"),e})),define("DS/Visualization/MaterialManager",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events"],(function(e,t,i,r,n,s){"use strict";function a(e,t){return i.ImageUtils.loadTextureCube(e,t)}function o(e,t){return i.ImageUtils.loadTexture(e,void 0,null,null,t)}class l{constructor(){this.map=new Map,this._internalKey={}}set(){for(var e=[...arguments],t=e[e.length-1],i=this.map,r=0;r<e.length-1;r++){var n=e[r];i.has(n)||i.set(n,new Map),i=i.get(n)}var s=this._internalKey;i.set(s,t)}get(){for(var e=[...arguments],t=this.map,i=0;i<e.length;i++){var r=e[i];if(!t.has(r))return;t=t.get(r)}var n=this._internalKey;return t.get(n)}has(){for(var e=[...arguments],t=this.map,i=0;i<e.length-1;i++){var r=e[i];if(!t.has(r))return!1;t=t.get(r)}var n=e[i];return t.has(n)}delete(){for(var e=[...arguments],t=[[null,this.map]],i=this.map,r=0;r<e.length;r++){var n=e[r];if(!i.has(n))return!1;i=i.get(n),t.push([n,i])}var s=i.delete(this._internalKey);for(r=t.length-1;r>0;r--){var a=t[r];if(a[1].delete(a[0]),0!==a[1].size)break;t[r-1][1].delete(a[0])}return s}forEach(e){var t=this._internalKey,i=this,r=function(n,s){n.keys();n.forEach(((n,a)=>{if(a===t)e(s,n,i);else{var o=s.concat([a]);r(n,o)}}))};r(this.map,[])}clear(){this.forEach((function(e,t,i){i.delete(...e)}))}}i.ParticleBasicMaterial,i.LineBasicMaterial,i.DSPBR22xMaterial,i.MeshBasicMaterial;var h=["Generic","Metal","Glass","Plastic","Textile","Leather","Car Paint","Emissive","Basic","Wood"],c=["CATCrDBallPointShader","CATCrDFeltPenShader","CATCrDImageTextureShader"],d=[1,1,2,3,4,5,6,7,8],u=["NO_TRANSCODE","RGB","RGBA","RGBHQ","NORMAL_MAP","GRAYSCALE"],p=null,f=function(e){return 3&e},g=new i.Matrix3,m=null,v=null,_=e.extend({init:function(e,t,r,s,a){if(null!==m){var o=0===m.viewerList.size&&s;if(this.maxTextureSize=m.maxTextureSize,this.viewerList=m.viewerList,s&&this.viewerList.set(s.id,s),a||m.multiViewer||!t){if(o&&(void 0===m.ODTMode&&(m.ODTMode=e),m.offscreenAPI=s.offscreenAPI,m.debugWebgl2=s.debugWebgl2,!m.context&&this.initContext3D(e,t,r,a),m.multiViewer=this.multiViewer,m.multiViewerAuto=this.multiViewerAuto,m.canvas=this.canvas,m.context=this.context),this.ODTMode=m.ODTMode,this.offscreenAPI=m.offscreenAPI,this.debugWebgl2=m.debugWebgl2,this.multiViewer=m.multiViewer,this.multiViewerAuto=m.multiViewerAuto,this.canvas=m.canvas,!this.context&&m.context&&(this.context=m.context),this.materials=m.materials,this.gasMaterialsMap=m.gasMaterialsMap,this.lineTypeMaterialMap=m.lineTypeMaterialMap,this.threeDXSharedGas=m.threeDXSharedGas,this.CGRSharedMaterials=m.CGRSharedMaterials,this.textures=m.textures,this.texturesPoint=m.texturesPoint,this.resources=[],this.PointSymbolEnum=m.PointSymbolEnum,this._modelEvent=m._modelEvent,this.colorInit=m.colorInit,this.foregroundColorMaterials=m.foregroundColorMaterials,this.foregroundColor=m.foregroundColor,this.backgroundColor=m.backgroundColor,this.backgroundColorMaterial=m.backgroundColorMaterial,this.backgroundColorMaterials=m.backgroundColorMaterials,this.blankingRepMaterials=m.blankingRepMaterials,this.transparentBlankingRepMaterials=m.transparentBlankingRepMaterials,!this.colorInit.background&&s&&this.initBackgroundColor(s),!this.colorInit.foreground&&s&&this.initForegroundColor(s),this.blanking=m.blanking,this.lineTypes=m.lineTypes,this.precomputedTexture=m.precomputedTexture,this.noiseTexture3D=m.noiseTexture3D,this.precomputedAreaTexture=m.precomputedAreaTexture,!i.WebGPU&&a&&this.hasMultipleViewers()){let e=this.viewerList[Symbol.iterator]();for(let t of e){let e=t[1],i=e.canvas;if(this.canvas===i){var h=e.createCanvas();e.attachCanvas(h),e.create2DContext()}}}return this}m.precomputedTexture&&m.precomputedTexture.dispose(),m.noiseTexture3D&&m.noiseTexture3D.dispose(),m.precomputedAreaTexture&&m.precomputedAreaTexture.dispose()}else this.viewerList=new Map,s&&this.viewerList.set(s.id,s);return this.ODTMode=e,this.offscreenAPI=s&&s.offscreenAPI,this.gasMaterialsMap=new l,this.lineTypeMaterialMap=new l,this.materials=[],this.threeDXSharedGas=new Map,this.CGRSharedMaterials=new Map,this.textures=[],this.texturesPoint=new Array(10),this.resources=[],this._currentMatHasTexture=!1,this._modelEvent=new n,v=null,this.backgroundColorMaterial=null,this.backgroundColorMaterials=[],this.blankingRepMaterials=[],this.transparentBlankingRepMaterials=[],this.blanking={display:!1},this.colorInit={foreground:!1,background:!1},this.foregroundColorMaterials=[],this.foregroundColor=new i.Color,this.backgroundColor=new i.Color,this.lineTypes={shapes:[],shapesOffset:0,patterns:[],patternsOffset:0,widths:[],lineTypes:[]},this.PointSymbolEnum=_.PointSymbolEnum,this.PointSymbolEnumSize=_.PointSymbolEnumSize,m=this,_.singleton=m,this.debugWebgl2=s&&s.debugWebgl2,s&&this.initContext3D(e,t,r,a),this.initResources(),this.maxTextureSize=16384,s&&(this.initBackgroundColor(s),this.initForegroundColor(s),s.renderer&&s.renderer.gl&&s.renderer.gl.getParameter(s.renderer.gl.MAX_TEXTURE_SIZE)),this},removeViewer:function(e){if(this.viewerList.delete(e.id),this.cleanAll(),!i.WebGPU&&this.multiViewerAuto&&!this.hasMultipleViewers()){const e=this.viewerList[Symbol.iterator]().next().value;if(!e)return m.canvas=null,m.context=null,void(i.glStates&&(i.glStates.currentWidth=0));const t=e[1];t.attachCanvas(this.canvas),t.context2D=null}},cleanAll:function(){m.materials.splice(0),m.gasMaterialsMap.clear(),m.lineTypeMaterialMap.clear(),m.threeDXSharedGas.clear(),m.CGRSharedMaterials.clear(),m.backgroundColorMaterial=null,m.backgroundColorMaterials.splice(0),m.blankingRepMaterials.splice(0),m.transparentBlankingRepMaterials.splice(0),m.precomputedTexture&&m.precomputedTexture.dispose(),m.noiseTexture3D&&m.noiseTexture3D.dispose(),m.precomputedAreaTexture&&m.precomputedAreaTexture.dispose(),p&&p.dispose(),this.deallocateSharedMaterials()},clearLineTypes:function(){for(var e=0;e<this.lineTypes.shapes.length;e++)this.lineTypes.shapes[e].geometry.dispose();this.lineTypes.shapes=[],this.lineTypes.shapesOffset=0,this.lineTypes.patterns=[],this.lineTypes.patternsOffset=0,this.lineTypes.widths=[],this.lineTypes.lineTypes=[],this.gasMaterialsMap.forEach((function(e,t,i){1===f(e[2])&&(t.dispose(),i.delete(...e))})),this.lineTypeMaterialMap.forEach((function(e,t,i){1===f(e[2])&&(t.dispose(),i.delete(...e))}))},hasLineTypes:function(){return this.lineTypes.widths.length>0},getPDSFX:function(e){require(["DS/"+e.name+"/"+e.name],(function(t){t(e.material,e.parameters,e.technique||null)}))},setLineTypes:function(e){if(this.clearLineTypes(),null==e)return;if(e.type=e.type||"CATIA",1!==e.version&&2!==e.version)throw new Error(`Unsupported custom lines specifications (version ${e.version}, expected 1 or 2)`);const t="AutoCAD"===e.type&&2===e.version;function n(e,t){return!!e||(console.error(t),!1)}e.shapes||(e.shapes=[]),e.patterns||(e.patterns=[]),e.widths||(e.widths=[]),e.lineTypes||(e.lineTypes=[]),e.patternsVisu||(e.patternsVisu=[]),e.shapesVisu||(e.shapesVisu=[]);const s=(e,t)=>n(void 0!==e,`Missing ${t}`),a=(e,t)=>n(Number.isFinite(e),`Invalid ${t}, expected a finite number, got '${e}'`);let o=[];function l(e,t){let s=null,a=null;if(e instanceof i.BufferGeometryDS)s=e,a=s.drawingGroups[0];else{if(s=new i.BufferGeometryDS,e.triangles){if(!n(e.triangles.length%3==0,`Invalid shape ${t}, indices do not form a set of triangles`))return;s.vertexPositionArray=new Float32Array(e.vertices),s.vertexPositionArray.length>=196608?s.vertexIndexArray=new Uint32Array(e.triangles):s.vertexIndexArray=new Uint16Array(e.triangles),a=new r.DrawingGroup(void 0,void 0,4,0,s.vertexIndexArray.length)}else if(e.polylines){for(let i=0;i<e.polylines.length;i++)if(!n(e.polylines[i].length%3==0,`Invalid shape ${t}, polyline nÂ°${i} does not form a set of 3D vertices`))return;const{vertices:i,indices:o}=function(e){let t=0,i=0;for(let r=0;r<e.length;r++)t+=e[r].length,i+=2*(e[r].length/3-1);const r=new Float32Array(t),n=t>196608?new Uint32Array(i):new Uint16Array(i);let s=0,a=0;for(let t=0;t<e.length;t++){const i=e[t].length/3,o=s/3;for(let e=0;e+1<i;e++)n[a++]=o+e,n[a++]=o+e+1;r.set(e[t],s),s+=e[t].length}return{vertices:r,indices:n}}(e.polylines);s.vertexPositionArray=i,s.vertexIndexArray=o,a=new r.DrawingGroup(null,null,1,0,s.vertexIndexArray.length)}if(!n(0!==s.vertexPositionArray.length,`Invalid shape ${t}, missing vertices`))return;if(!n(0!==s.vertexIndexArray.length,`Invalid shape ${t}, missing indices`))return;a&&(a._primitives=[{group:a,start:a.start,count:a.count}],a.geometry=s,s.drawingGroups.push(a))}o.push(a)}for(let t=0;t<e.shapes.length;t++){l(e.shapes[t],t)}const h=o.length;for(let t=0;t<e.shapesVisu.length;t++){l(e.shapesVisu[t],t+h)}let c=[];function d(e,r,n){let l={zoomable:void 0===e.zoomable||e.zoomable,description:[]};for(let h=0;h<e.description.length;h++){const c=e.description[h];if(!a(c.length,`length of segment ${h} of pattern ${n}`))return;const d=void 0!==c.shape&&null!==c.shape;if(d&&!s(o[c.shape+r],`shape of segment ${h} of pattern ${n}`))return;let u;try{16===c.matrix.length?u=new i.Matrix4(c.matrix[0],c.matrix[4],c.matrix[8],c.matrix[12],c.matrix[1],c.matrix[5],c.matrix[9],c.matrix[13],c.matrix[2],c.matrix[6],c.matrix[10],c.matrix[14],c.matrix[3],c.matrix[7],c.matrix[11],c.matrix[15]):9===c.matrix.length&&(u=new i.Matrix3(c.matrix[0],c.matrix[3],c.matrix[6],c.matrix[1],c.matrix[4],c.matrix[7],c.matrix[2],c.matrix[5],c.matrix[8]))}catch(e){}l.description.push({length:c.length,shape:d?c.shape+r:null,matrix:u&&d?u:null,upright:d&&!!c.upright,onSolidLine:d&&!1,noFit:t&&d})}c.push(l)}for(let t=0;t<e.patterns.length;t++)d(e.patterns[t],0,t);const u=c.length;for(let t=0;t<e.patternsVisu.length;t++)d(e.patternsVisu[t],h,t+u);let p=[];for(let t=0;t<e.widths.length;t++){let i=e.widths[t];if(!a(i.pixelWidth,`pixel width of type ${t}`))return;if(!a(i.printWidth,`print width of type ${t}`))return;p.push({pixelWidth:i.pixelWidth,printWidth:i.printWidth})}let f=[];for(let t=0;t<e.lineTypes.length;t++){let i=e.lineTypes[t];if(null!==i.pattern&&void 0!==i.pattern&&!s(c[i.pattern],`pattern of type ${t}`))return;if(null!==i.patternVisu&&void 0!==i.patternVisu&&!s(c[i.patternVisu+u],`pattern visu of type ${t}`))return;f.push({pattern:i.pattern,patternVisu:i.patternVisu})}this.lineTypes.shapes=o,this.lineTypes.shapesOffset=h,this.lineTypes.patterns=c,this.lineTypes.patternsOffset=u,this.lineTypes.widths=p,this.lineTypes.lineTypes=f},_createLineTypeMaterial:function(e,t,r,n){if(!this.hasLineTypes())return console.error(`Cannot create material for width '${e}' and pattern ${t}: no line types defined`),null;if(!this.lineTypes.widths[e])return console.warn(`Cannot create material for width '${e}' material: unknown width`),null;const s=this.lineTypes.widths[e].pixelWidth;if(!this.lineTypes.lineTypes[t])return console.warn(`Cannot create material for patterns '${t}' material: unknown pattern`),null;n||(n={});const a=this.lineTypes.lineTypes[t];let o=a.pattern;null!==a.patternVisu&&void 0!==a.patternVisu&&(o=a.patternVisu+this.lineTypes.patternsOffset);const l=this.lineTypes.patterns[o];return n._wholePatternsOnly=!1,n._worldSizePattern=l.zoomable||!this.ODTMode&&l.description.filter((e=>null!==e.shape)).length>0,n.force=!0,n.lineWidth=Math.max(Math.round(s),1),n.pattern=l.description,n.patternShapes=this.lineTypes.shapes,n.scale=r||1,new i.LineBasicMaterial(n)},deallocateSharedMaterials:function(){for(var e=["Invisible","Normal","Depth","NormalDepth","ShadowMapDepth","Picking","Highlight","PreHighlight","HighlightMobile"],t=["Face","Line","Point"],r=["0","1","2"],n=["true","false"],s=[1],a=0;a<e.length;a++){var o=i.DefaultMaterials[e[a]];if(o)for(var l=0;l<t.length;l++){var h=o[t[l]];if(h)for(var c=0;c<r.length;c++){var d=h[r[c]];if(d)for(var u=0;u<n.length;u++){var p=d[n[u]];if(p){var f=p[s[0]];f&&(f.needsUpdate=!0)}}}}}},initForegroundColor:function(e){var t=this;if(this.colorInit.foreground=!0,s.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE"},(function(e){if(e.parameters.viewer.getRenderer()){var r=i._getColorMap(e.parameters.viewer.getRenderer())[i.COLORMAP_INDEX.FOREGROUND];t.foregroundColor.setRGB(r.r,r.g,r.b),t.updateForegroundColorMaterial()}})),e&&e.renderer&&e.renderer.renderer){var r=e.getColorFromColorMap(i.COLORMAP_INDEX.FOREGROUND);this.foregroundColor.setRGB(r.r,r.g,r.b),this.updateForegroundColorMaterial()}},initBackgroundColor:function(e){this.colorInit.background=!0;var t=this,r=e.ambience.getBackgroundColor();this.backgroundColor.setRGB(r.r,r.g,r.b),e.onBackgroundModify((function(e){var r=new i.Color(e);t.backgroundColor.setRGB(r.r,r.g,r.b),t.updateBackgroundColorMaterial()}))},updateForegroundColorMaterial:function(){for(var e=0;e<this.foregroundColorMaterials.length;e++)this.foregroundColorMaterials[e].setColor(this.foregroundColor)},updateBackgroundColorMaterial:function(){for(var e=0;e<this.blankingRepMaterials.length;e++)this.blankingRepMaterials[e].setColor(this.backgroundColor);for(e=0;e<this.backgroundColorMaterials.length;e++)this.backgroundColorMaterials[e].setColor(this.backgroundColor);this.backgroundColorMaterial&&this.backgroundColorMaterial.setColor(this.backgroundColor)},initContext3D:function(e,t,r,n){if(this.multiViewer=t,this.multiViewerAuto=n,!i.WebGPU&&(t||n)){if(n&&!this.hasMultipleViewers()){let e=this.viewerList[Symbol.iterator]().next().value[1].canvas;this.canvas=e}else this.offscreenAPI?this.canvas=new OffscreenCanvas(256,256):this.canvas=document.createElement("canvas");var s=null;if(this.debugWebgl2&&(s=this.canvas.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,antialias:r,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()}),i.WebGLVersion=2),!s){var a={alpha:!0,premultipliedAlpha:!1,antialias:r,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()};s=this.canvas.getContext("webgl",a)||this.canvas.getContext("experimental-webgl",a),i.WebGLVersion=1}this.context=s}},getGPUStates:function(){var e=this.viewerList.size?this.viewerList.values().next().value:null;return e&&e.renderer?e.renderer.renderer.gpuStates:null},initResources:function(){var e=t.getWebappsAssetUrl("Effects",""),r=i.ImageUtils.loadTGATexture(e+"precomputedTexture.bin",new i.UVMapping,null,null,!0,!0);r.minFilter=i.NearestFilter,r.magFilter=i.NearestFilter,this.precomputedTexture=r,this.noiseTexture3D=new i.DataTexture(new Uint8Array(16),2,2,i.RGBAFormat,i.UnsignedByteType,new i.LatLongReflectionMapping,i.ClampToEdgeWrapping,i.ClampToEdgeWrapping,i.LinearFilter,i.LinearFilter),this.noiseTexture3D.generateMipmaps=!1,this.noiseTexture3D.needsUpdate=!0,this.noiseTexture3D.onRequest=function(){this.loadEndStatus=i.AssetLoadingStatus.READY;for(var e=new Uint8Array(1048576),t=0;t<262144;t++){var r=255*Math.random();e[4*t]=r,e[4*t+1]=r,e[4*t+2]=r,e[4*t+3]=255}this.image.data=e,this.image.width=512,this.image.height=512,this.needsUpdate=!0,this.onRequest=null};var n=i.ImageUtils.loadCompressedTexture(e+"AreaLight.dds",new i.UVMapping,null,null,!1,!0);n.minFilter=i.LinearFilter,n.magFilter=i.LinearFilter,this.precomputedAreaTexture=n},setCanvasSize:function(e,t,r){if(!i.WebGPU&&(this.multiViewer||this.multiViewerAuto)){var n=t,s=r;for(var a of this.viewerList.values())if(e!==a){var o=a.getCanvasSize();n=Math.max(o.width,n),s=Math.max(o.height,s)}this.canvas.width=n,this.canvas.height=s}},getCanvas:function(){return this.canvas},getContext:function(){return this.context},hasMultipleViewers:function(){return this.viewerList.size>1},onPDSFXMaterial:function(e){return this._modelEvent.subscribe({event:"PDSFXMaterial"},e)},cleanResources:function(){m.textures=[],this.textures=[],this.materials=this.materials.filter((function(e){return!e.hasTexture}))},getMaterialById:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.id===e)return this.materials[t].threejs_mat;return null},getMaterialByName:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.name===e)return this.materials[t].threejs_mat;return null},getBackgroundColorMaterial:function(){return this.backgroundColorMaterial||(this.backgroundColorMaterial=new i.MeshBasicMaterial({side:i.DoubleSide,color:this.backgroundColor})),this.backgroundColorMaterial},displayBlankingPolygon:function(e,t){this.blanking.display=e;for(var i=0;i<this.blankingRepMaterials.length;i++)this.blankingRepMaterials[i].opacity=e?1:0},setBlankingPolygonVisibility:function(e){for(var t=0;t<this.blankingRepMaterials.length;t++)this.blankingRepMaterials[t].visible=e},getBlankingRepMaterial:function(e){var t=new i.MeshBasicMaterial({name:"blankingMat",color:this.backgroundColor,overridable:!1,side:i.DoubleSide,opacity:e?0:this.blanking.display?1:0,depthTest:!1,shading:i.FlatShading});return e?this.transparentBlankingRepMaterials.push(t):this.blankingRepMaterials.push(t),t},_getDashPattern:function(e){var t;switch(console.error("Error: accessing private method on MaterialManager"),e){case r.LinePatternEnum.DOTTED:(t=new Float32Array(2))[0]=2,t[1]=2;break;case r.LinePatternEnum.DASHED:(t=new Float32Array(2))[0]=3,t[1]=1;break;case r.LinePatternEnum.DOTDASHED:(t=new Float32Array(4))[0]=3,t[1]=2,t[2]=1,t[3]=2;break;case r.LinePatternEnum.PHANTOM:(t=new Float32Array(6))[0]=6,t[1]=2,t[2]=2,t[3]=2,t[4]=2,t[5]=2;break;case r.LinePatternEnum.SMALLDOTTED:(t=new Float32Array(2))[0]=1,t[1]=1;break;case r.LinePatternEnum.JISAXIS:(t=new Float32Array(4))[0]=2,t[1]=1,t[2]=12,t[3]=2;break;default:(t=new Float32Array(1))[0]=-1}return t},extractMaterialApplicationMappingInfos(e,t,r){if(e)if(t.isPhysicalMaterial&&"CATGraphicalMaterial"!=t.getType()){var n=t.__physicalMode>=1,s=!!e.type,a=!e.UvTransfoInfos||e.type||!!e.UvTransformation,o=null;e.ObjectTransformation&&((o=new i.Matrix4).elements=e.ObjectTransformation);var l=!1,h=!1;n?(h=!0,s||(l=!0)):(l=!0,s&&(h=!0));var c=null;h&&e.UvTransformation&&((c=new i.Matrix3).elements=e.UvTransformation);var d=null;if(l&&e.UvTransfoInfos){d=new i.Matrix3;var u=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],g=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];d.set(f*u,-f*p,g[0],f*p,f*u,g[1],0,0,1)}c&&d?c.multiplyMatrices(c,d):d&&(c=d);var m=e.type;n||("SPHERICAL_NORMALIZED"===m&&(m="SPHERICAL"),"INFINITE_CYLINDRICAL_NORMALIZED"===m&&(m="INFINITE_CYLINDRICAL")),a||-1==t.mappingType?t.setMappingOperator(m,o,c,!0):t.mappingUVTransformation.multiplyMatrices(c,t.mappingUVTransformation),t.mappingTransformSemantic=null!=e.transformSemantic?e.transformSemantic:1}else{c=null;if(e.UvTransfoInfos){c=new i.Matrix3;u=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],g=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];c.set(f*u,-f*p,g[0],f*p,f*u,g[1],0,0,1),r&&c.multiplyMatrices(uvTransfo,r),t.setMappingOperator(0,null,c,!0)}else r&&t.setMappingOperator(0,null,r,!0)}},getMaterialCgr:function(e,t,r,n,s){var a,o,l;if("true"===localStorage.getItem("NoCGRMaterials"))return null;if(void 0!==e.backgoundColor)return this.getBackgroundColorMaterial();if(void 0!==e.blankingRep)return this.getBlankingRepMaterial();if(void 0!==e.external3DXid){var h=this.getCGRSharedMaterial(e.external3DXid,!0);return h&&this.extractMaterialApplicationMappingInfos(e.mapping,h),h}var c=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material"===(l=(a=this.materials[o]).params).type&&!l.shaderMaterial&&l.ambientCoef===e.ambientCoef&&l.diffuseCoef===e.diffuseCoef&&l.specularCoef===e.specularCoef&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2]&&(void 0===l.url||-1!==e.textureId)&&(void 0!==l.url||-1===e.textureId)&&-1===e.textureId&&l.transparent===e.transparent&&l.shininess===e.shininess&&l.textureImageNumberComposante===e.textureImageNumberComposante&&l.textureBlending===e.textureBlending&&l.magFilter===e.magFilter&&l.minFilter===e.minFilter&&l.mappingFunction===e.mappingFunction&&l.textureWrapS===e.textureWrapS&&l.textureWrapT===e.textureWrapT&&l.addedComposantInTexEnv===e.addedComposantInTexEnv&&(!1!==l._pbr||!c)&&(!0!==l._pbr||c)&&(!l.mapping||e.mapping&&l.mapping.type===e.mapping.type&&l.mapping.ObjectTransformation===e.mapping.ObjectTransformation&&l.mapping.UvTransformation===e.mapping.UvTransformation))return a.threejs_mat;return(a=this.createMaterial(e,t,r,n,null,s))&&(a._source=i.AssetSource.MATERIAL_MANAGER),a},getMaterial3DXML:function(e,t,r,n,s){var a,o,l,h=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material3DXML"===(l=(a=this.materials[o]).params).type&&l.shading===e.shading&&l.reflectivityCoef===e.reflectivityCoef&&l.shininess===e.shininess&&l.specularCoef===e.specularCoef&&l.WrappingModeU===e.WrappingModeU&&l.WrappingModeV===e.WrappingModeV&&l.FlipU===e.FlipU&&l.FlipV===e.FlipV&&l.transparency===e.transparency&&l.transparent===e.transparent&&l.alphaTest===e.alphaTest&&l.mappingFunction===e.mappingFunction&&l.MappingType===e.MappingType&&l.TextureDimension===e.TextureDimension&&l.TextureFunction===e.TextureFunction&&l.DiffuseMap===e.DiffuseMap&&l.DiffuseMapRepeat[0]===e.DiffuseMapRepeat[0]&&l.DiffuseMapRepeat[1]===e.DiffuseMapRepeat[1]&&l.DiffuseMapWrap[0]===e.DiffuseMapWrap[0]&&l.DiffuseMapWrap[1]===e.DiffuseMapWrap[1]&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&!(!l.colorSpecular&&e.colorSpecular||l.colorSpecular&&!e.colorSpecular)&&(!l.colorSpecular||!e.colorSpecular||l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2])&&(!1!==l._pbr||!h)&&(!0!==l._pbr||h))return s&&(0===l.__nbTexturesToLoad?s(a.threejs_mat):(l.__cbLoadedImages||(l.__cbLoadedImages=[]),l.__cbLoadedImages.push(s))),a.threejs_mat;return(a=this.createMaterial(e,t,r,null,s))._source=i.AssetSource.MATERIAL_MANAGER,a},getTexture:function(e){this._currentMatHasTexture=!0;var t,r,n,s,a=[];if(e.offset||(e.offset=[0,0]),e.repeat||(e.repeat=[1,1]),e.wrap&&!e.overrideWrap||(e.resources&&e.resources.wrap?e.wrap=e.resources.wrap:e.wrap||(e.wrap=[i.CGR_WRAPPING.REPEAT,i.CGR_WRAPPING.REPEAT])),e.filter||(e.resources&&e.resources.filter?e.filter=e.resources.filter:e.filter=[5,1]),e.borderColor&&!e.overrideBorderColor||(e.resources&&e.resources.borderColor?e.borderColor=new i.Vector4(e.resources.borderColor[0],e.resources.borderColor[1],e.resources.borderColor[2],e.resources.borderColor[3]):e.borderColor||(e.borderColor=null)),void 0!==e.resourceId&&this.textures[e.resourceId]&&(a=this.textures[e.resourceId]),a.length){for(n=0;n<a.length;n++)if(s=t=a[n],r=t.params,e.texturePoint===r.texturePoint&&e.offset[0]===r.offset[0]&&e.offset[1]===r.offset[1]&&e.repeat[0]===r.repeat[0]&&e.repeat[1]===r.repeat[1]&&e.wrap[0]===r.wrap[0]&&e.wrap[1]===r.wrap[1]&&e.filter[0]===r.filter[0]&&e.filter[1]===r.filter[1]&&(e.borderColor&&r.borderColor&&e.borderColor.equals(r.borderColor)||!e.borderColor&&!r.borderColor))return t.threejs_texture;switch((t=s.threejs_texture.clone()).offset.set(e.offset[0],e.offset[1]),t.repeat.set(e.repeat[0],e.repeat[1]),t.borderColor=e.borderColor,e.wrap[0]){case i.CGR_WRAPPING.CLAMP_TO_EDGE:t.wrapS=i.ClampToEdgeWrapping;break;case i.CGR_WRAPPING.REPEAT:t.wrapS=i.RepeatWrapping;break;case i.CGR_WRAPPING.CLAMP_TO_BORDER:t.wrapS=i._ClampToBorderWrapping;break;case i.CGR_WRAPPING.MIRRORED_REPEAT:t.wrapS=i.MirroredRepeatWrapping;break;default:t.wrapS=i.ClampToEdgeWrapping}switch(e.wrap[1]){case i.CGR_WRAPPING.CLAMP_TO_EDGE:t.wrapT=i.ClampToEdgeWrapping;break;case i.CGR_WRAPPING.REPEAT:t.wrapT=i.RepeatWrapping;break;case i.CGR_WRAPPING.CLAMP_TO_BORDER:t.wrapT=i._ClampToBorderWrapping;break;case i.CGR_WRAPPING.MIRRORED_REPEAT:t.wrapT=i.MirroredRepeatWrapping;break;default:t.wrapT=i.ClampToEdgeWrapping}switch(e.filter[0]){case 0:t.min=i.NearestFilter;break;case 1:t.min=i.LinearFilter;break;case 2:t.min=i.NearestMipMapNearestFilter;break;case 3:t.min=i.NearestMipMapLinearFilter;break;case 4:t.min=i.LinearMipMapNearestFilter;break;case 5:t.min=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:t.mag=i.NearestFilter;break;case 1:t.mag=i.LinearFilter;break;case 2:t.mag=i.NearestMipMapNearestFilter;break;case 3:t.mag=i.NearestMipMapLinearFilter;break;case 4:t.mag=i.LinearMipMapNearestFilter;break;case 5:t.mag=i.LinearMipMapLinearFilter}var o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint,borderColor:e.borderColor};return this.textures[e.resourceId]=[{params:o,threejs_texture:t}],t._source=i.AssetSource.MATERIAL_MANAGER,t}if(t=this.createTexture(e),void 0!==e.resourceId){o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint};this.textures[e.resourceId]=[{params:o,threejs_texture:t}]}return t._source=i.AssetSource.MATERIAL_MANAGER,t},createMaterial:function(e,r,n,s,l,d){function u(){return Y}function f(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}this._currentMatHasTexture=!1,e.__nbTexturesToLoad=0,e.__cbLoadedImages=[],l&&e.__cbLoadedImages.push(l);var m="MeshPhongMaterial",_={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,blending:i.NormalBlending,side:i.DoubleSide};if(e.physicalMaterial){var y={},S=e.physicalMaterial.PhysicalMaterial,b=i.PhysicalMaterial;if(S.isVisDescription){var x=this,w="Visu.DSPBR@21x"===S.type,P="Visu.EVisuPBR"===S.type,C="Visu.DSPBR@22x"===S.type,M="Visu.DSPBR@25x"===S.type,E="Visu.SpecularGlossiness@21x"===S.type||P||w||C||M,T=e.mapping&&e.mapping.type||E,A=function(e,t,r){var n=null;r&&(n=r);var s=S[t];if(s&&(n=s),n){var a=new i.Matrix3;a.set(n[0],n[2],n[4],n[1],n[3],n[5],0,0,1),y[e]=a.isIdentity()?g:a}},D=function(e,t,r,n){var a=S[t];if(void 0!==a){if(a.length)return y[e]=new i.Color,void y[e].setRGB(a[0],a[1],a[2]);if(void 0!==a.MADCoefficients){var o=a.MADCoefficients;y[e+"MulCoef"]=new i.Vector3(o[0],o[1],o[2]),y[e+"AddCoef"]=new i.Vector3(o[3],o[4],o[5])}void 0!==a.value?(y[e]=new i.Color,y[e].setRGB(a.value[0],a.value[1],a.value[2])):void 0!==a.texture&&n?(y[e+"Map"]=x.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[a.texture],resourceId:a.texture}),null!==r&&y[e+"Map"].withSubstituteTexture(r.x,r.y,r.z),T&&A(e+"UvTransform",t+"UvTransform",s[a.texture].uvTransform)):null!==r&&(y[e]=new i.Color,y[e].setRGB(r.x,r.y,r.z))}else null!==r&&(y[e]=new i.Color,y[e].setRGB(r.x,r.y,r.z))},I=function(e,t,i,r){var n=S[t];if(void 0!==n){if("object"!=typeof n)return void(y[e]=n);if(void 0!==n.MADCoefficients){var a=n.MADCoefficients;y[e+"MulCoef"]=a[0],y[e+"AddCoef"]=a[1]}void 0!==n.value?y[e]=n.value:void 0!==n.texture&&r?(y[e+"Map"]=x.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[n.texture],resourceId:n.texture}),y.transparent=y.transparent||"opacity"===e||"transparency"===e,null!==i&&y[e+"Map"].withSubstituteTexture(i),T&&A(e+"UvTransform",t+"UvTransform",s[n.texture].uvTransform)):null!==i&&(y[e]=i)}else null!==i&&(y[e]=i)};if("Visu.SpecularGlossiness"===S.type||"Visu.SpecularGlossiness@21x"===S.type){var R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];S.RepeatU&&(R[0]=i.CGR_WRAPPING.REPEAT),S.RepeatV&&(R[1]=i.CGR_WRAPPING.REPEAT)}else R=null;if(P||w||C||M){D("diffuse","albedo",new i.Vector3(1,1,1),!0),b=i.DSPBR19xMaterial;var O=function(e,t,r){var n=S[t];if(void 0!==n){if(void 0!==n.MADCoefficients){var a=n.MADCoefficients;y[e+"MulCoef"]=new i.Vector3(a[0],a[1],a[2]),y[e+"AddCoef"]=new i.Vector3(a[3],a[4],a[5])}void 0!==n.texture&&(y[e+"Map"]=x.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[n.texture],resourceId:n.texture}),null!==r&&y[e+"Map"].withSubstituteTexture(r.x,r.y,r.z),A(e+"UvTransform",e+"UvTransform",s[n.texture].uvTransform))}};I("metalness","metallic",0,!0),I("roughness","roughness",0,!0),I("anisotropyAngle","anisotropyRotation",0,!0),O("normal","normal",new i.Vector3(.5,.5,1)),I("opacity","cutoutOpacity",1,!0),I("thickness","thickness",0,!0),P||(I("translucency","translucency",0,!0),O("displacement","displacement",new i.Vector3(0,0,0)),I("subsurfaceAnisotropy","subsurfaceAnisotropy",0,!1),w?(b=i.DSPBR21xMaterial,D("sheenColor","sheenColor",new i.Vector3(1,1,1),!0),I("sheenRoughness","sheenRoughness",.3,!0)):(b=i.DSPBR22xMaterial,D("sheenColor","sheenColor",new i.Vector3(0,0,0),!0),I("sheenRoughness","sheenRoughness",.5,!0),D("flipFlopColor","flipFlopColor",new i.Vector3(1,1,1),!0),I("flipFlop","flipFlop",0,!0),void 0!==S.subtype&&(y._subtype=i.DSPBRSubTypes[h[S.subtype]]),M&&(b=i.DSPBR25xMaterial,S.translucencyColor?(y.useTranslucencyColorFromAlbedo=!1,D("translucencyColor","translucencyColor",new i.Vector3(0,0,0),!0)):y.useTranslucencyColorFromAlbedo=!0,I("iridescence","thinFilm",0,!0),I("iridescenceThickness","thinFilmThickness",.4,!0),I("iridescenceIoR","thinFilmIOR",1.3,!1)))),(P||w)&&I("sheen","sheen",0,!0),I("specularContribution","specular",1,!0),D("specular","specularTint",new i.Vector3(1,1,1),!0),D("flakesColor","flakeColor",new i.Vector3(1,1,1),!0),I("flakesCoverage","flakeCoverage",0,!0),I("flakesCoverage","flakeDensity",null,!0),I("flakesSize","flakeSize",.5,!0),I("flakesRoughness","flakeRoughness",0,!0),I("clearCoat","clearcoat",0,!0),O("clearCoatNormal","clearcoatNormal",null),I("clearCoatRoughness","clearcoatRoughness",0,!0),I("orangePeel","orangePeel",!1,!1),I("orangePeelScale","orangePeelScale",0,!1),D("emissionColor","emissionColor",new i.Vector3(1,1,1),!0),I("emissionValue","emissionValue",0,!1),I("emissionNormalized","emissionEnergyNormalization",!1,!1),I("thinWalled","thinWalled",!1,!1),I("ior","ior",1.5,!1),D("attenuationColor","attenuationColor",new i.Vector3(1,1,1),!1),D("subsurfaceColor","subsurfaceColor",new i.Vector3(0,0,0),!1),I("attenuationDistance","attenuationDistance",1e8,!1),S.cutoutFromAlbedoAlpha||S.UseAlphaDiffuseChannel?(y.transparent=y.transparent||!!y.diffuseMap,y.useAlphaFromDiffuseMap=!0):y.useAlphaFromDiffuseMap=!1}else{D("diffuse","diffuse",new i.Vector3(0,0,0),!0),y.specGlossNRE=!0;O=function(e,t,i){var r=S[t+"Map"];void 0!==r&&(y[e+"Map"]=x.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[r.texture],resourceId:r.texture}),null!==i&&y[e+"Map"].withSubstituteTexture(i.x,i.y,i.z),T&&A(e+"UvTransform",t+"MapUvTransform",s[r.texture].uvTransform))};D("specular","fresnelCoefficient",new i.Vector3(.04,.04,.04),!0),D("emissionColor","emissive",new i.Vector3(0,0,0),!0),y.emissionValue=1,D("flakesColor","flakesColor",new i.Vector3(0,0,0),!1),y.flakesColorMulCoef=new i.Vector3(.12,.12,.12),y.flakesColorAddCoef=new i.Vector3(0,0,0),D("pearlFlakesColor","pearlFlakesColor",new i.Vector3(0,0,0),!1),y.pearlFlakesColorMulCoef=new i.Vector3(.08,.08,.08),y.pearlFlakesColorAddCoef=new i.Vector3(0,0,0),D("clearCoatColor","coatingFresnelCoefficient",new i.Vector3(.04,.04,.04),!0),I("glossiness","glossiness",1,!0),I("opacity","opacity",1,!0),I("anisotropyAngle","anisotropyAngle",0,!0),I("clearCoat","Coating",0,!1),function(e,t,r,n){var a=S[t];if(void 0!==a){if(void 0!==a.MADCoefficients){var o=a.MADCoefficients;y[e+"MulCoef"]=o[0],y[e+"AddCoef"]=o[1]}void 0!==a.value?y[e]=new i.Vector2(a.value,a.value):void 0!==a.texture&&n?(y[e+"Map"]=x.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[a.texture],resourceId:a.texture}),null!==r&&y[e+"Map"].withSubstituteTexture(r.x,r.y),T&&A(e+"UvTransform",t+"UvTransform",s[a.texture].uvTransform)):null!==r&&(y[e]=r)}else null!==r&&(y[e]=r)}("normalScale","bumpScale",new i.Vector2(1,1),!0),I("coatingGlossiness","coatingGlossiness",1,!1),I("clearCoatNormalScale","coatingBump",0,!1),I("orangePeel","ProceduralCoating",!1,!1),I("orangePeelScale","coatingScale",1,!1),I("flakes","Flakes",!1,!1),I("flakesDensity","flakesDensity",0,!0),I("flakesBump","flakesBump",1,!1),I("flakesScale","flakesScale",.5,!1),I("flakesRoughness","flakesRoughness",.25,!1),I("pearlFlakesBump","pearlFlakesBump",1,!1),I("pearlFlakesDensity","pearlFlakesDensity",1,!1),O("normal","normal",new i.Vector3(.5,.5,1)),S.NormalMapConventionPositiveY?y.normalMapFlipY=!0:y.normalMapFlipY=!1,O("clearCoatNormal","coatingNormal",new i.Vector3(.5,.5,1)),S.CoatingNormalMapConventionPositiveY?y.clearCoatNormalMapFlipY=!0:y.clearCoatNormalMapFlipY=!1,I("displacement","displacement",0,!0);var L=S.displacement;if(void 0!==L&&void 0!==L.MADCoefficients){var B=L.MADCoefficients;y.displacementScale=B[0],y.displacementBias=B[1]}S.UseAlphaDiffuseChannel?(y.transparent=y.transparent||!!y.diffuseMap,y.useAlphaFromDiffuseMap=!0):y.useAlphaFromDiffuseMap=!1}I("anisotropy","anisotropy",0,!0),I("anisotropyAngle","anisotropyAngle",0,!0),I("transparency","transparency",0,!0),(1==y.opacity&&y.transparency>0||y.opacityMap)&&(y.transparent=!0),S.IsAlphaTestEnabled&&(y.transparent=!1,y.alphaTest=.5)}else{y.specGlossNRE=!0;var F=S.MappingOperator.Type;if("None"!=F&&(y.mappingUseFragment=!0,y.mappingObjTransformation=new i.Matrix4,y.mappingObjTransformation.elements=S.MappingOperator.ObjectTransformation,"Planar"==F?y.mappingType=1:"Spherical"==F||"Spherical Normalized"==F?y.mappingType=2:"Cubic"==F?y.mappingType=3:"FiniteCylindrical"==F?y.mappingType=4:("InfiniteCylindrical"==F||"InfiniteCylindrical Normalized"==F)&&(y.mappingType=5)),y.mappingUVTransformation=new i.Matrix3,y.mappingUVTransformation.elements=S.MappingOperator.UvTransformation,S.Float3Parameter){var V=S.Float3Parameter;if(V.diffuse){B=V.diffuse.MADCoefficients;if(0==V.diffuse.AsTexture)y.color=new i.Color,y.color.setRGB(V.diffuse.Value[0],V.diffuse.Value[1],V.diffuse.Value[2]),y.diffuseMulCoef=new i.Vector3(B[0],B[1],B[2]),y.diffuseAddCoef=new i.Vector3(B[3],B[4],B[5]);else{R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==V.diffuse.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==V.diffuse.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),V.diffuse.UvTransform&&"None"!=F){var G=V.diffuse.UvTransform;y.diffuseUvTransform=new i.Matrix3(G[0],G[4],G[8],G[1],G[5],G[9],G[2],G[6],G[10])}y.diffuseMulCoef=new i.Vector3(B[0],B[1],B[2]),y.diffuseAddCoef=new i.Vector3(B[3],B[4],B[5]),y.map=this.getTexture({wrap:R,type:"data",resources:s[V.diffuse.Texture],resourceId:V.diffuse.Texture})}}if(V.fresnelCoefficient){B=V.fresnelCoefficient.MADCoefficients;if(0==V.fresnelCoefficient.AsTexture)y.specular=new i.Color,y.specular.setRGB(V.fresnelCoefficient.Value[0],V.fresnelCoefficient.Value[1],V.fresnelCoefficient.Value[2]),y.specularMulCoef=new i.Vector3(B[0],B[1],B[2]),y.specularAddCoef=new i.Vector3(B[3],B[4],B[5]);else{R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==V.fresnelCoefficient.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==V.fresnelCoefficient.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),V.fresnelCoefficient.UvTransform&&"None"!=F){var N=V.fresnelCoefficient.UvTransform;y.specularUvTransform=new i.Matrix3(N[0],N[4],N[8],N[1],N[5],N[9],N[2],N[6],N[10])}y.specularMulCoef=new i.Vector3(B[0],B[1],B[2]),y.specularAddCoef=new i.Vector3(B[3],B[4],B[5]),y.specularMap=this.getTexture({wrap:R,type:"data",resources:s[V.fresnelCoefficient.Texture],resourceId:V.fresnelCoefficient.Texture})}}if(V.emissive){B=V.emissive.MADCoefficients;if(0==V.emissive.AsTexture)y.emissive=new i.Color,y.emissive.setRGB(V.emissive.Value[0],V.emissive.Value[1],V.emissive.Value[2]),y.emissiveMulCoef=new i.Vector3(B[0],B[1],B[2]),y.emissiveAddCoef=new i.Vector3(B[3],B[4],B[5]);else{y.emissive=new i.Color,y.emissive.setRGB(1,1,1);R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==V.emissive.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==V.emissive.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),V.emissive.UvTransform&&"None"!=F){var U=V.emissive.UvTransform;y.emissiveUvTransform=new i.Matrix3(U[0],U[4],U[8],U[1],U[5],U[9],U[2],U[6],U[10])}y.emissiveMulCoef=new i.Vector3(B[0],B[1],B[2]),y.emissiveAddCoef=new i.Vector3(B[3],B[4],B[5]),y.emissiveMap=this.getTexture({wrap:R,type:"data",resources:s[V.emissive.Texture],resourceId:V.emissive.Texture})}}if(V.coatingFresnelCoefficient&&!1===V.coatingFresnelCoefficient.AsTexture&&(y.coatingSpecularColor=new i.Color,y.coatingSpecularColor.setRGB(V.coatingFresnelCoefficient.Value[0],V.coatingFresnelCoefficient.Value[1],V.coatingFresnelCoefficient.Value[2])),V.flakesColor){B=V.flakesColor.MADCoefficients;!1===V.flakesColor.AsTexture&&(y.flakesColor=new i.Color,y.flakesColor.setRGB(V.flakesColor.Value[0],V.flakesColor.Value[1],V.flakesColor.Value[2]),y.flakesColorMulCoef=new i.Vector3(B[0],B[1],B[2]),y.flakesColorAddCoef=new i.Vector3(B[3],B[4],B[5]))}if(V.pearlFlakesColor){B=V.pearlFlakesColor.MADCoefficients;!1===V.pearlFlakesColor.AsTexture&&(y.pearlFlakesColor=new i.Color,y.pearlFlakesColor.setRGB(V.pearlFlakesColor.Value[0],V.pearlFlakesColor.Value[1],V.pearlFlakesColor.Value[2]),y.pearlFlakesColorMulCoef=new i.Vector3(B[0],B[1],B[2]),y.pearlFlakesColorAddCoef=new i.Vector3(B[3],B[4],B[5]))}}if(S.FloatParameter){var k=S.FloatParameter;if(k.glossiness){B=k.glossiness.MADCoefficients;if(0==k.glossiness.AsTexture)y.glossiness=k.glossiness.Value,y.glossinessMulCoef=B[0],y.glossinessAddCoef=B[1];else{R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==k.glossiness.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==k.glossiness.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),k.glossiness.UvTransform&&"None"!=F){var z=k.glossiness.UvTransform;y.glossinessUvTransform=new i.Matrix3(z[0],z[4],z[8],z[1],z[5],z[9],z[2],z[6],z[10])}y.glossinessMulCoef=B[0],y.glossinessAddCoef=B[1],y.glossinessMap=this.getTexture({wrap:R,type:"data",resources:s[k.glossiness.Texture],resourceId:k.glossiness.Texture})}}if(k.bumpScale){B=k.bumpScale.MADCoefficients;if(0==k.bumpScale.AsTexture){var H=k.bumpScale.Value;y.normalScale=new i.Vector2(H,H),y.normalScaleMulCoef=B[0],y.normalScaleAddCoef=B[1]}}if(k.opacity){B=k.opacity.MADCoefficients;if(0==k.opacity.AsTexture)y.opacity=k.opacity.Value,y.opacityMulCoef=B[0],y.opacityAddCoef=B[1];else{R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==k.opacity.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==k.opacity.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),k.opacity.UvTransform&&"None"!=F){var W=k.opacity.UvTransform;y.opacityUvTransform=new i.Matrix3(W[0],W[4],W[8],W[1],W[5],W[9],W[2],W[6],W[10])}y.opacityMulCoef=B[0],y.opacityAddCoef=B[1],y.opacityMap=this.getTexture({wrap:R,type:"data",resources:s[k.opacity.Texture],resourceId:S.MapParameter.normalMap.Texture})}}if(k.transparency){B=k.transparency.MADCoefficients;0==k.transparency.AsTexture&&(y.transparency=k.transparency.Value,y.transparencyMulCoef=B[0],y.transparencyAddCoef=B[1])}if(k.anisotropy){B=k.anisotropy.MADCoefficients;if(0==k.anisotropy.AsTexture)y.anisotropy=k.anisotropy.Value,y.anisotropyMulCoef=B[0],y.anisotropyAddCoef=B[1];else{R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==k.anisotropy.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==k.anisotropy.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),k.anisotropy.UvTransform&&"None"!=F){var j=k.anisotropy.UvTransform;y.anisotropyUvTransform=new i.Matrix3(j[0],j[4],j[8],j[1],j[5],j[9],j[2],j[6],j[10])}y.anisotropyMulCoef=B[0],y.anisotropyAddCoef=B[1],y.anisotropyMap=this.getTexture({wrap:R,type:"data",resources:s[k.anisotropy.Texture],resourceId:k.anisotropy.Texture})}}if(k.anisotropyAngle)if(0==k.anisotropyAngle.AsTexture){B=k.anisotropyAngle.MADCoefficients;y.anisotropyAngle=k.anisotropyAngle.Value,y.anisotropyAngleMulCoef=B[0],y.anisotropyAngleAddCoef=B[1]}else{R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==k.anisotropyAngle.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==k.anisotropyAngle.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),k.anisotropyAngle.UvTransform&&"None"!=F){var X=k.anisotropyAngle.UvTransform;y.anisotropyAngleUvTransform=new i.Matrix3(X[0],X[4],X[8],X[1],X[5],X[9],X[2],X[6],X[10])}y.anisotropyAngleMulCoef=B[0],y.anisotropyAngleAddCoef=B[1],y.anisotropyAngleMap=this.getTexture({wrap:R,type:"data",resources:s[k.anisotropyAngle.Texture],resourceId:k.anisotropyAngle.Texture})}if(k.coatingGlossiness){B=k.coatingGlossiness.MADCoefficients;if(!1===k.coatingGlossiness.AsTexture){H=B[1]+k.coatingGlossiness.Value*B[0];y.coatingGlossiness=H}else{R=[i.CGR_WRAPPING.CLAMP_TO_EDGE,i.CGR_WRAPPING.CLAMP_TO_EDGE];if("eRepeat"==k.coatingGlossiness.Sampling.TexCoordUWrap&&(R[0]=i.CGR_WRAPPING.REPEAT),"eRepeat"==k.coatingGlossiness.Sampling.TexCoordVWrap&&(R[1]=i.CGR_WRAPPING.REPEAT),k.coatingGlossiness.UvTransform&&"None"!=F){var q=k.coatingGlossiness.UvTransform;y.coatingGlossinessUvTransform=new i.Matrix3(q[0],q[4],q[8],q[1],q[5],q[9],q[2],q[6],q[10])}y.coatingGlossinessMulCoef=B[0],y.coatingGlossinessAddCoef=B[1],y.coatingGlossinessMap=this.getTexture({wrap:R,type:"data",resources:s[k.coatingGlossiness.Texture],resourceId:k.coatingGlossiness.Texture})}}if(k.coatingBump){B=k.coatingBump.MADCoefficients;if(!1===k.coatingBump.AsTexture){H=B[1]+k.coatingBump.Value*B[0];y.clearCoatNormalScale=H}}if(k.coatingScale){B=k.coatingScale.MADCoefficients;if(!1===k.coatingScale.AsTexture){H=B[1]+k.coatingScale.Value*B[0];y.orangePeelScale=H}}if(k.flakesBump){B=k.flakesBump.MADCoefficients;if(!1===k.flakesBump.AsTexture){H=B[1]+k.flakesBump.Value*B[0];y.flakesBump=H}}if(k.flakesDensity){B=k.flakesDensity.MADCoefficients;if(!1===k.flakesDensity.AsTexture){H=B[1]+k.flakesDensity.Value*B[0];y.flakesDensity=H}}if(k.flakesScale){B=k.flakesScale.MADCoefficients;if(!1===k.flakesScale.AsTexture){H=B[1]+k.flakesScale.Value*B[0];y.flakesScale=H}}if(k.flakesRoughness){B=k.flakesRoughness.MADCoefficients;if(!1===k.flakesRoughness.AsTexture){H=B[1]+k.flakesRoughness.Value*B[0];y.flakesRoughness=H}}if(k.pearlFlakesBump){B=k.pearlFlakesBump.MADCoefficients;if(!1===k.pearlFlakesBump.AsTexture){H=B[1]+k.pearlFlakesBump.Value*B[0];y.pearlFlakesBump=H}}if(k.pearlFlakesDensity){B=k.pearlFlakesDensity.MADCoefficients;if(!1===k.pearlFlakesDensity.AsTexture){H=B[1]+k.pearlFlakesDensity.Value*B[0];y.pearlFlakesDensity=H}}}if(y.useAlphaFromDiffuseMap=!1,"eDiffuseChannel"==S.AlphaMode?(y.transparent=y.transparent||!!y.map,y.useAlphaFromDiffuseMap=!0):(1==y.opacity&&y.transparency>0||y.opacityMap)&&(y.transparent=!0),1==S.AlphaTest&&(y.transparent=!1,y.alphaTest=.5),!0===S.Coating&&(y.coating=1),!0===S.ProceduralCoating&&(y.orangePeel=!0),!0===S.Flakes&&(y.flakes=!0),S.NormalMap&&1==S.NormalMap.UseNormalMap&&(y.normalMap=this.getTexture({type:"data",resources:s[S.NormalMap.Texture],resourceId:S.NormalMap.Texture})),S.MapParameter&&S.MapParameter.normalMap&&1==S.MapParameter.normalMap.Enabled){if(y.normalMap=this.getTexture({type:"data",resources:s[S.MapParameter.normalMap.Texture],resourceId:S.MapParameter.normalMap.Texture}),S.MapParameter.normalMap.UvTransform&&"None"!=F){var Z=S.MapParameter.normalMap.UvTransform;y.normalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=S.NormalMapConvention?y.normalMapFlipY=!1:y.normalMapFlipY=!0}if(S.MapParameter&&S.MapParameter.coatingBumpMap&&1==S.MapParameter.coatingBumpMap.Enabled){if(y.clearCoatNormalMap=this.getTexture({type:"data",resources:s[S.MapParameter.coatingBumpMap.Texture],resourceId:S.MapParameter.coatingBumpMap.Texture}),S.MapParameter.coatingBumpMap.UvTransform&&"None"!=F){Z=S.MapParameter.coatingBumpMap.UvTransform;y.clearCoatNormalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=S.CoatingBumpMapConvention?y.clearCoatNormalMapFlipY=!1:y.clearCoatNormalMapFlipY=!0}}var Y=new b(y);return this.extractMaterialApplicationMappingInfos(e.mapping,Y),Y}if(e.shaderMaterial)return e.shaderMaterial.PDSFX?(Y=function(e,t,r,n,s){var a=0,o=e.param;for(a in o){var l=o[a].imgId;void 0!==l&&(t[l]&&t[l].url&&(o[a].url=t[l].url),o[a].map=r.getTexture({type:"data",resources:t[l],resourceId:l}),r.resources[l]=o[a].map)}var h={name:e.name,parameters:e.param,material:null},d=localStorage.getItem("A2XPDSFXConvention");-1==c.indexOf(e.name)&&(d=!0);var u="DS/Shaders/"+e.name;return d&&(u="DS/"+e.name+"/"+e.name),require([u],(function(t){if(s.material=i.MaterialUtils.createShinyFaceMaterial(),t(s.material,e.param,null),s.material&&(s.material.needsUpdate=!0),s.geometry&&s.geometry.meshList)for(var r=0;r<s.geometry.meshList.length;r++)s.geometry.meshList[r]._flagAsGSSOInvalidated()})),r._modelEvent.publish({event:"PDSFXMaterial",data:h}),h.material?h.material:null}(e.shaderMaterial,s,this,e.transparent,d),Y||null):Y=function(e,r,n,s){if(null!=e){var l=e.param,h=0;null!=l.transparency_multiply_blend&&(h=l.transparency_multiply_blend);var c,d=t.getWebappsAssetUrl("Visualization","");switch(null==v&&(v=a(u=[d+"studio_pure_white_Specular_Map/posx.jpg",d+"studio_pure_white_Specular_Map/negx.jpg",d+"studio_pure_white_Specular_Map/posy.jpg",d+"studio_pure_white_Specular_Map/negy.jpg",d+"studio_pure_white_Specular_Map/posz.jpg",d+"studio_pure_white_Specular_Map/negz.jpg"])),e.name){case"MPM_basic":case"MPM_material":case"MPM_colored_glass":case"MPM_diffuse":case"MPM_soft_plastic":case"MPM_polished_plastic":case"MPM_clear_glass":case"MPM_frosted_glass":case"MPM_diamond":case"MPM_satinated_metal":case"MPM_anisotropic_metal":case"MPM_polished_metal":case"MPM_emissive":var u=[(d=t.getWebappsAssetUrl("Visualization",""))+"studio_pure_white_Diffuse_Map/posx.jpg",d+"studio_pure_white_Diffuse_Map/negx.jpg",d+"studio_pure_white_Diffuse_Map/posy.jpg",d+"studio_pure_white_Diffuse_Map/negy.jpg",d+"studio_pure_white_Diffuse_Map/posz.jpg",d+"studio_pure_white_Diffuse_Map/negz.jpg"],p=l.mapping_world_to_object_position_1st_column,f=l.mapping_world_to_object_position_2nd_column,g=l.mapping_world_to_object_position_3rd_column,m=l.mapping_world_to_object_position_4th_column,_=new i.Matrix4(p[0],p[1],p[2],p[3],f[0],f[1],f[2],f[3],g[0],g[1],g[2],g[3],m[0],m[1],m[2],m[3]);(new i.Matrix4).getInverse(_),a(u);var y={};!function(e,i,r,n){var s=t.getWebappsAssetUrl("Visualization",""),a=o(s+"default_white_color.png"),l=o(s+"slot_normal_default.jpg"),h=o(s+"slot_specular_anisotropy_direction_default.jpg");e.AmbientOcclusion2D&&"slot_ambient_occlusion_default.tif"==e.AmbientOcclusion2D.url?r.AmbientOcclusion2D=a:r.AmbientOcclusion2D=n.getTexture({type:"data",resources:i[e.AmbientOcclusion2D.imgId],resourceId:e.AmbientOcclusion2D.imgId}),e.Clarity2D&&"slot_clarity_default.tif"==e.Clarity2D.url?r.Clarity2D=a:r.Clarity2D=n.getTexture({type:"data",resources:i[e.Clarity2D.imgId],resourceId:e.Clarity2D.imgId}),e.Diffuse2D&&"slot_diffuse_default.tif"==e.Diffuse2D.url?r.Diffuse2D=a:r.Diffuse2D=n.getTexture({type:"data",resources:i[e.Diffuse2D.imgId],resourceId:e.Diffuse2D.imgId,checkTransparency:!0}),e.Emissive2D&&"slot_emissive_default.tif"==e.Emissive2D.url?r.Emissive2D=a:r.Emissive2D=n.getTexture({type:"data",resources:i[e.Emissive2D.imgId],resourceId:e.Emissive2D.imgId}),e.Height2D&&"slot_displacement_default.tif"==e.Height2D.url?r.Height2D=a:r.Height2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Normal2D&&"slot_normal_default.tif"==e.Normal2D.url?r.Normal2D=l:r.Normal2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Specular2D&&"slot_specular_default.tif"==e.Specular2D.url?r.Specular2D=a:r.Specular2D=n.getTexture({type:"data",resources:i[e.Specular2D.imgId],resourceId:e.Specular2D.imgId}),e.SpecularAnisotropyDirection2D&&"slot_specular_anisotropy_direction_default.tif"==e.SpecularAnisotropyDirection2D.url?r.SpecularAnisotropyDirection2D=h:r.SpecularAnisotropyDirection2D=n.getTexture({type:"data",resources:i[e.SpecularAnisotropyDirection2D.imgId],resourceId:e.SpecularAnisotropyDirection2D.imgId}),e.SpecularGlossiness2D&&"slot_specular_glossiness_default.tif"==e.SpecularGlossiness2D.url?r.SpecularGlossiness2D=a:r.SpecularGlossiness2D=n.getTexture({type:"data",resources:i[e.SpecularGlossiness2D.imgId],resourceId:e.SpecularGlossiness2D.imgId}),e.Transparency2D&&"slot_transparency_default.tif"==e.Transparency2D.url?r.Transparency2D=a:r.Transparency2D=n.getTexture({type:"data",resources:i[e.Transparency2D.imgId],resourceId:e.Transparency2D.imgId})}(l,r,y,n),(E=new Array(3))[0]=l.default_generic_brdf_diffuse_color[0]*l.default_generic_brdf_diffuse_weight,E[1]=l.default_generic_brdf_diffuse_color[1]*l.default_generic_brdf_diffuse_weight,E[2]=l.default_generic_brdf_diffuse_color[2]*l.default_generic_brdf_diffuse_weight,E[0]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[0],E[1]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[1],E[2]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[2],c=new i.DSPBR22xMaterial({needTangentBinormal:!0,diffuseMulCoef:(new i.Vector3).setFromArray(E),diffuseAddCoef:new i.Vector3(0,0,0),specularMulCoef:(new i.Vector3).setFromArray(l.default_generic_brdf_specular_color),specularAddCoef:new i.Vector3(0,0,0),emissionColorMulCoef:(new i.Vector3).setFromArray(l.default_generic_edf_diffuse_color),emissionColorAddCoef:new i.Vector3(0,0,0),opacity:l.default_sp_opacity,ior:l.default_generic_brdf_ior,roughness:1-l.default_generic_brdf_specular_glossiness,specularContribution:l.default_generic_brdf_specular_weight,anisotropy:l.default_generic_brdf_specular_anisotropy/Math.PI,anisotropyAngle:l.default_generic_brdf_specular_anisotropy_rotation/Math.PI,emissionValue:l.default_generic_edf_diffuse_weight,transparency:l.default_generic_btdf_transparency_weight,metalness:0,normalUvSlot:l.default_slot_normal,opacityUvSlot:l.default_slot_opacity,diffuseUvSlot:l.default_slot_diffuse_color,specularUvSlot:l.default_slot_specular_color,roughnessUvSlot:l.default_slot_specular_glossiness,anisotropyAngleUvSlot:l.default_slot_specular_anisotropy_direction,transparencyUvSlot:l.default_slot_transparency,emissionColorUvSlot:l.default_slot_emissive_color,thinWalled:!!l.thin_walled,map:y.Diffuse2D,emissionColorMap:y.Emissive2D,specularMap:y.Specular2D,roughnessMap:y.SpecularGlossiness2D,roughnessAddCoef:y.SpecularGlossiness2D?1:null,roughnessMulCoef:y.SpecularGlossiness2D?-1:null,anisotropyAngleMap:y.SpecularAnisotropyDirection2D,opacityMap:y.Opacity2D,transparent:y.Opacity2D||y.Transparency2D,mappingType:l.mapping_type,mappingUVTransformation:new i.Matrix3(l.mapping_scale_u,0,l.mapping_offset_u,0,l.mapping_scale_v,l.mapping_offset_v,0,0,1)});break;case"mia_phen_polished_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,T[1]=l.diffuse?l.diffuse[1]:1,T[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:l.reflectivity,specular:new i.Color(T),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h});break;case"mia_phen_satinated_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,T[1]=l.diffuse?l.diffuse[1]:1,T[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:l.reflectivity,specular:new i.Color(T),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_anisotropic_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,T[1]=l.diffuse?l.diffuse[1]:1,T[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h,needTangentBinormal:!0,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:.1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:0});break;case"mia_phen_soft_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.7,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_polished_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.75,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_diffuse":(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:0,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_frosted_glass":(E=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,E[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,E[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_clear_glass":c=new i.DSPBR22xMaterial({color:new i.Color(8947848),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:0,transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_colored_glass":l.reflectivity=null!=l.reflectivity?l.reflectivity:.66,(E=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,E[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,E[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"diamond":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.refr_color?l.refr_color[0]:1,E[1]=l.refr_color?l.refr_color[1]:1,E[2]=l.refr_color?l.refr_color[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,transparency:.5,ior:null!=l.refr_ior?l.refr_ior:2.4,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_emissive":c=new i.DSPBR22xMaterial({color:new i.Color(0),specularContribution:0,emissionColor:new i.Color(null!=l.color?l.color:[1,1,1,1]),emissionValue:null!=l.intensity?l.intensity:1e3,opacity:1-h,needTangentBinormal:!0});break;case"CATIATemplateUseMapCubic":case"CATIATemplateUseMapSpheric":var S;S=n.getTexture({type:"data",resources:r[l.KdText.imgId],resourceId:l.KdText.imgId,checkTransparency:!0}),l.Kd=null!=l.Kd?l.Kd:1,l.KsShi=null!=l.KsShi?l.KsShi:.75,l.Ks=null!=l.Ks?l.Ks:.75,(E=new Array(3))[0]=l.KdColor?l.KdColor[0]:1,E[1]=l.KdColor?l.KdColor[1]:1,E[2]=l.KdColor?l.KdColor[2]:1,E[0]*=l.Kd,E[1]*=l.Kd,E[2]*=l.Kd,(T=new Array(3))[0]=l.KsColor?l.KsColor[0]:1,T[1]=l.KsColor?l.KsColor[1]:1,T[2]=l.KsColor?l.KsColor[2]:1,c=new i.DSPBR22xMaterial({diffuseMulCoef:(new i.Vector3).setFromArray(E),diffuseAddCoef:new i.Vector3,map:S,specular:new i.Color(T),specularContribution:l.Ks,roughness:l.KsShi,metalness:0,transparency:null!=l.Kt?l.Kt:0,ior:2+(null!=l.Kr?l.Kr:1),opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_material":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:0;var b=null!=l.transparency?l.transparency:0;(E=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight*(1-b),E[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight*(1-b),E[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight*(1-b),E[0]+=(l.refr_color?l.refr_color[0]:1)*b,E[1]+=(l.refr_color?l.refr_color[1]:1)*b,E[2]+=(l.refr_color?l.refr_color[2]:1)*b,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1;var x=1-(null!=l.refl_gloss?l.refl_gloss:0),w=b*(1-(null!=l.refl_gloss?l.refr_gloss:1))+(1-b)*x;c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:w,metalness:0,transparency:b,ior:null!=l.refr_ior?l.refr_ior:1.5,opacity:1-h,alphaTest:null!=l.cutout_opacity?l.cutout_opacity:1,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:1,needTangentBinormal:!0});break;case"mia_phen_reflective_translucent":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:0,b=null!=l.transparency?l.transparency:.8,(E=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight,E[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight,E[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight;var P=new Array(3);P[0]=l.refr_trans_color?l.refr_trans_color[0]:1,P[1]=l.refr_trans_color?l.refr_trans_color[1]:1,P[2]=l.refr_trans_color?l.refr_trans_color[2]:1,w=1-(null!=l.refl_gloss?l.refr_gloss:1),c=new i.DSPBR25xMaterial({color:new i.Color(E),translucency:null!=l.refr_trans_weight?l.refr_trans_weight:1,translucencyColor:new i.Color(P),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:w,metalness:0,transparency:b,ior:null!=l.refr_ior?l.refr_ior:1.3,opacity:1-h,needTangentBinormal:!0});break;case"mip_metallic_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,w=(null!=l.spec_exp?l.spec_exp:60)/150;var C=null!=l.spec_sec_weight?l.spec_sec_weight:.25,M=(null!=l.spec_sec_exp?l.spec_sec_exp:25)/150;(E=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,E[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,E[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(T=new Array(3))[0]=l.spec?l.spec[0]:1,T[1]=l.spec?l.spec[1]:1,T[2]=l.spec?l.spec[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.spec_weight,clearCoat:C,clearCoatRoughness:M,roughness:w,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mip_car_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,w=(null!=l.spec_exp?l.spec_exp:60)/150;var E,T,A=(null!=l.flake_exp?l.flake_exp:45)/150;(E=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,E[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,E[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(T=new Array(3))[0]=l.spec?l.spec[0]:1,T[1]=l.spec?l.spec[1]:1,T[2]=l.spec?l.spec[2]:1;var D=new Array(3);D[0]=l.flake_color?l.spec[0]:1,D[1]=l.flake_color?l.spec[1]:1,D[2]=l.flake_color?l.spec[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),flakesColor:new i.Color(T),specularContribution:l.spec_weight,clearCoat:1,clearCoatRoughness:.05,roughness:w,flakesRoughness:A,flakesCoverage:null!=l.flake_density?l.flake_density:.5,flakesSize:null!=l.flake_scale?l.flake_scale:5,metalness:0,opacity:1-h,ior:null!=l.__incident_ior?l.__incident_ior:1,needTangentBinormal:!0});break;default:return i.MaterialUtils.createShinyFaceMaterial()}return c.force=!0,c.uniforms&&c.uniforms.ReflectionCUBEMap&&(c.uniforms.ReflectionCUBEMap.value=v),void 0!==s&&0!==s&&(c.transparent=!0),c}return i.MaterialUtils.createShinyFaceMaterial()}(e.shaderMaterial,s,this,e.transparent);if(null===e)return i.MaterialUtils.createShinyFaceMaterial();void 0!==e.wireframe&&(_.wireframe=e.wireframe),void 0!==e.transparent&&(_.opacity=1-e.transparent,1!==_.opacity&&(_.transparent=!0));var K,$=i._CATGraphicalAsPBR;if(e.shading&&("Phong"===e.shading?m="MeshPhongMaterial":"Basic"===e.shading&&($=!1,m="MeshBasicMaterial")),e.blending&&("Additive"===e.blending?_.blending=i.AdditiveBlending:"Subtractive"===e.blending?_.blending=i.SubtractiveBlending:"Multiply"===e.blending&&(_.blending=i.MultiplyBlending)),void 0!==e.depthTest&&(_.depthTest=e.depthTest),void 0!==e.vertexColors&&("face"===e.vertexColors?_.vertexColors=i.VertexColorType.Face:e.vertexColors&&(_.vertexColors=i.VertexColorType.RGBA)),e.colorDiffuse?void 0!==e.diffuseCoef?(K=[e.colorDiffuse[0]*e.diffuseCoef,e.colorDiffuse[1]*e.diffuseCoef,e.colorDiffuse[2]*e.diffuseCoef],_.color=f(K)):_.color=f(e.colorDiffuse):e.DbgColor&&(_.color=e.DbgColor),e.colorSpecular&&(void 0!==e.specularCoef?(K=[e.colorSpecular[0]*e.specularCoef,e.colorSpecular[1]*e.specularCoef,e.colorSpecular[2]*e.specularCoef],_.specular=f(K)):_.specular=f(e.colorSpecular)),e.colorAmbient&&(void 0!==e.ambientCoef?(K=[e.colorAmbient[0]*e.ambientCoef,e.colorAmbient[1]*e.ambientCoef,e.colorAmbient[2]*e.ambientCoef],_.ambient=f(K)):_.ambient=f(e.colorAmbient)),e.transparency&&(_.opacity=e.transparency,1!==_.opacity&&(_.transparent=!0)),e.shininess&&(_.shininess=e.shininess,$&&(_.shininess/="material3DXML"===e.type?128:255)),e.reflectivityCoef&&(_.reflectivity=e.reflectivityCoef),e.alphaTest&&(_.alphaTest=e.alphaTest),e.reflectivityCoef>.1&&void 0===e.ReflectionMap){if(null===p){var Q=o(t.getWebappsAssetUrl("Visualization","")+"defaultEnvMap.png",i.ImageUtils.crossOriginPolicy);Q.flipY=!0,Q.mapping=new i.SphericalReflectionMapping,p=Q}_.envMap=p,_.combine=i.MixOperation}var J=null;if(_.textureBlending=i.TextureBlendOperations.MODULATE,void 0!==e.textureId&&-1!==e.textureId)if(void 0!==e.textureBlending&&(_.textureBlending=e.textureBlending),"SPHERICAL_ENV_MAP"===e.mappingFunction)_.sphereMap=!0;else{_.map=this.getTexture({type:"data",resources:s[e.textureId],filter:[e.minFilter,e.magFilter],wrap:[e.textureWrapS,e.textureWrapT],resourceId:e.textureId,checkTransparency:!0}),_.map.transparent&&(_.transparent=!0,_.alphaTest=1e-4);var ee=s[e.textureId].uvTransform;ee&&(J=new i.Matrix3).set(ee[0],ee[1],ee[4],ee[2],ee[3],ee[5],0,0,1)}if(e.DiffuseMap&&r&&(_.map=this.getTexture({type:"url",sourceFile:e.DiffuseMap,texturePath:r,material:e,cb:u,repeat:e.DiffuseMapRepeat,offset:e.DiffuseMapOffset,wrap:e.DiffuseMapWrap,checkTransparency:!0,format:n})),e.mapLight&&r&&(_.lightMap=this.getTexture({type:"url",sourceFile:e.mapLight,material:e,cb:u,texturePath:r,repeat:e.mapLightRepeat,offset:e.mapLightOffset,wrap:e.mapLightWrap})),e.mapNormal&&r&&(_.normalMap=this.getTexture({type:"url",sourceFile:e.mapNormal,material:e,cb:u,texturePath:r,repeat:e.mapNormalRepeat,offset:e.mapNormalOffset,wrap:e.mapNormalWrap})),e.mapSpecular&&r&&(_.specularMap=this.getTexture({type:"url",sourceFile:e.mapSpecular,material:e,cb:u,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e.ReflectionMap&&r&&(_.envMap=this.getTexture({type:"url_envMap",sourceFile:e.mapSpecular,material:e,cb:u,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e._pbr=!1,_.envMap&&_.envMap.withSubstituteTexture(1,1,1),_.map&&_.map.withSubstituteTexture(1,1,1),_.specularMap&&_.specularMap.withSubstituteTexture(1,1,1),_.normalMap&&_.normalMap.withSubstituteTexture(.5,.5,1),$){var te=i.MaterialUtils.convertShininessToIoRRoughness(_.shininess?_.shininess:0);_.roughness=te.roughness,_.reflectivityEnvMap=_.envMap,_.envMap=null,_.ior=te.ior,m="_CATGraphicalMaterial",e._pbr=!0,_.diffuseUvTransform=J,J=null}if(Y=new i[m](_),this.extractMaterialApplicationMappingInfos(e.mapping,Y,J),void 0!==e.DbgName&&(Y.name=e.DbgName),void 0!==e.textureId&&-1!==e.textureId&&(e.url=s[e.textureId].url),this.materials.push({params:e,threejs_mat:Y,hasTexture:this._currentMatHasTexture}),0===e.__nbTexturesToLoad)for(var ie=0;ie<e.__cbLoadedImages.length;ie++)e.__cbLoadedImages[ie](Y);return Y.map&&Y.map.needToCheckTransparency&&(Y.map.transparentCb=function(e){Y.transparent=e}),Y},_getPointMaterial:function(e){var r=this,n=function(e,t){return r.texturesPoint[e]||(r.texturesPoint[e]=o(t,i.ImageUtils.crossOriginPolicy)),r.texturesPoint[e]},s=e.symbol?_.PointSymbolEnumSize[e.symbol]:9,a=e.color,l=null,h=!1,c=t.getWebappsAssetUrl("Visualization","");switch(e.symbol){case _.PointSymbolEnum.NOSPRITE:l=null;break;case _.PointSymbolEnum.CROSS:l=n(1,c+"textures/point/cross.png"),h=!0;break;case _.PointSymbolEnum.PLUS:l=n(2,c+"textures/point/plus.png"),h=!0;break;case _.PointSymbolEnum.COINCIDENT:l=n(3,c+"textures/point/concentric.png"),h=!0;break;case _.PointSymbolEnum.CONCENTRIC:l=n(4,c+"textures/point/coincident.png"),h=!0;break;case _.PointSymbolEnum.FULLCIRCLE:l=n(5,c+"textures/point/fullCircle.png"),h=!0;break;case _.PointSymbolEnum.FULLSQUARE:l=n(6,c+"textures/point/fullSquare.png");break;case _.PointSymbolEnum.STAR:l=n(7,c+"textures/point/star.png"),h=!0;break;case _.PointSymbolEnum.DOT:l=n(8,c+"textures/point/dot.png");break;case _.PointSymbolEnum.SMALLDOT:l=n(9,c+"textures/point/smallDot.png");break;case _.PointSymbolEnum.MISC1:l=n(10,c+"textures/point/misc1.png"),h=!0;break;case _.PointSymbolEnum.MISC2:l=n(11,c+"textures/point/misc2.png"),h=!0;break;case _.PointSymbolEnum.FULLCIRCLE2:l=n(12,c+"textures/point/fullCircle2.png"),h=!0;break;case _.PointSymbolEnum.FULLSQUARE2:l=n(13,c+"textures/point/fullSquare2.png");break;case _.PointSymbolEnum.LOSANGEBORDER:l=n(14,c+"textures/point/losangeBorder.png"),h=!0;break;case _.PointSymbolEnum.FULLLOSANGE:l=n(15,c+"textures/point/fullLosange.png"),h=!0;break;case _.PointSymbolEnum.FULLCIRCLE3:l=n(16,c+"textures/point/fullCircle3.png"),h=!0;break;case _.PointSymbolEnum.OUTLINE_DOUBLEROTATEARROW:l=n(17,c+"textures/point/outline_doubleRotateArrow.png"),h=!0;break;case _.PointSymbolEnum.FILLED_DOUBLEROTATEARROW:l=n(18,c+"textures/point/filled_doubleRotateArrow.png"),h=!0;break;case _.PointSymbolEnum.OUTLINE_SQUARE:l=n(19,c+"textures/point/outline_square.png"),h=!0;break;case _.PointSymbolEnum.FILLED_SQUARE:l=n(20,c+"textures/point/filled_square.png");break;case _.PointSymbolEnum.OUTLINE_DIAMOND:l=n(21,c+"textures/point/outline_diamond.png"),h=!0;break;case _.PointSymbolEnum.FILLED_DIAMOND:l=n(22,c+"textures/point/filled_diamond.png"),h=!0;break;default:l=null}return e.size&&(s=e.size),e.withoutDPR||(s=Math.round(s*(i.getDevicePixelRatio()||1))),e.scale&&(s=e.scale*s),new i.ParticleBasicMaterial({size:s,color:a,map:l,sizeAttenuation:!1,blending:i.NormalBlending,depthTest:!1,transparent:h,alphaTest:.01,hasSymbol:!0})},createPointMaterial:function(e){var r=this;if(!e._cgr)return this._getPointMaterial(e);var n,s=function(e,t){return r.texturesPoint[e]||(r.texturesPoint[e]=o(t,i.ImageUtils.crossOriginPolicy)),r.texturesPoint[e]},a=null,l=9,h=e.color,c=e.opacity,d=!1,u=!!e.isNoz,p=t.getWebappsAssetUrl("Visualization","");if(void 0!==e.symbol){switch(l=_.PointSymbolEnumSize[e.symbol],e.symbol){case _.PointSymbolEnum.NOSPRITE:n=null,e.size&&(l=e.size);break;case _.PointSymbolEnum.CROSS:n=s(1,p+"textures/point/cross.png"),d=!0;break;case _.PointSymbolEnum.PLUS:n=s(2,p+"textures/point/plus.png"),d=!0;break;case _.PointSymbolEnum.CONCENTRIC:n=s(3,p+"textures/point/concentric.png"),d=!0;break;case _.PointSymbolEnum.COINCIDENT:n=s(4,p+"textures/point/coincident.png"),d=!0;break;case _.PointSymbolEnum.FULLCIRCLE:n=s(5,p+"textures/point/fullCircle.png"),d=!0;break;case _.PointSymbolEnum.FULLSQUARE:n=s(6,p+"textures/point/fullSquare.png");break;case _.PointSymbolEnum.STAR:n=s(7,p+"textures/point/star.png"),d=!0;break;case _.PointSymbolEnum.DOT:n=s(8,p+"textures/point/dot.png");break;case _.PointSymbolEnum.SMALLDOT:n=s(9,p+"textures/point/smallDot.png");break;case _.PointSymbolEnum.MISC1:n=s(10,p+"textures/point/misc1.png"),d=!0;break;case _.PointSymbolEnum.MISC2:n=s(11,p+"textures/point/misc2.png"),d=!0;break;case _.PointSymbolEnum.FULLCIRCLE2:n=s(12,p+"textures/point/fullCircle2.png"),d=!0;break;case _.PointSymbolEnum.FULLSQUARE2:n=s(13,p+"textures/point/fullSquare2.png");break;case _.PointSymbolEnum.LOSANGEBORDER:n=s(14,p+"textures/point/losangeBorder.png"),d=!0;break;case _.PointSymbolEnum.FULLLOSANGE:n=s(15,p+"textures/point/fullLosange.png"),d=!0;break;case _.PointSymbolEnum.FULLCIRCLE3:n=s(16,p+"textures/point/fullCircle3.png"),d=!0;break;case _.PointSymbolEnum.OUTLINE_DOUBLEROTATEARROW:n=s(17,p+"textures/point/outline_doubleRotateArrow.png"),d=!0;break;case _.PointSymbolEnum.FILLED_DOUBLEROTATEARROW:n=s(18,p+"textures/point/filled_doubleRotateArrow.png"),d=!0;break;case _.PointSymbolEnum.OUTLINE_SQUARE:n=s(19,p+"textures/point/outline_square.png"),d=!0;break;case _.PointSymbolEnum.FILLED_SQUARE:n=s(20,p+"textures/point/filled_square.png");break;case _.PointSymbolEnum.OUTLINE_DIAMOND:n=s(21,p+"textures/point/outline_diamond.png"),d=!0;break;case _.PointSymbolEnum.FILLED_DIAMOND:n=s(22,p+"textures/point/filled_diamond.png"),d=!0;break;default:n=s(1,p+"textures/point/cross.png"),d=!0}l=Math.round(l*(i.getDevicePixelRatio()||1))}else l=e.size;return a=new i.ParticleBasicMaterial({size:l,color:h,map:n,blending:i.NormalBlending,depthTest:!u,sizeAttenuation:!1,transparent:d,alphaTest:.01,hasSymbol:!0}),c&&(a.opacity=c),a},createTexture:function(e){function t(t,r){var n,s,a=new Image;i.ImageUtils.nbTexturesBeingLoaded++,e.material.__nbTexturesToLoad++,t.loadEndStatus=i.AssetLoadingStatus.LOADING,a.onload=function(){t.loadEndStatus=i.AssetLoadingStatus.READY,i.ImageUtils.is_pow2(a.width)&&i.ImageUtils.is_pow2(a.height)?t.image=a:(n=i.ImageUtils.nearest_pow2(a.width),s=i.ImageUtils.nearest_pow2(a.height),t.image.width=n,t.image.height=s,t.image.getContext("2d").drawImage(a,0,0,n,s)),t.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--;for(var r=0;r<t.onLoadCallbacks.length;r++)t.onLoadCallbacks[r](t);if(0===e.material.__nbTexturesToLoad)for(r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},a.onerror=function(){if(i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--,t.loadEndStatus=i.AssetLoadingStatus.ERROR,0===e.material.__nbTexturesToLoad)for(var r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},a.crossOrigin="anonymous",a.src=r}function r(e,t,i,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_=t/r,y=new Float32Array(i*r*s);if(1!==_)for(d=_/2,u=0;u<r;u++,d+=_)for(o=(a=Math.floor(d))>=i-1?0:s,l=d-a,h=u*s,c=a*s,p=0;p<i;p++,h+=r*s,c+=t*s)for(f=0;f<s;f++)y[h+f]=e[c+f]*(1-l)+e[c+o+f]*l;else for(g=0;g<i*r*s;g++)y[g]=e[g];if(m=i/n,v=new Uint8Array(n*r*s),1!==m)for(d=m/2,p=0;p<n;p++,d+=m)for(o=(a=Math.floor(d))>=i-1?0:s*r,l=d-a,h=p*r*s,c=a*r*s,u=0;u<r;u++,h+=s,c+=s)for(f=0;f<s;f++)v[h+f]=y[c+f]*(1-l)+y[c+o+f]*l;else for(g=0;g<n*r*s;g++)v[g]=y[g];return v}function n(e){var t;for(t=3;t<e.length;t+=4)if(255!=e[t])return!0;return!1}var s,a,o,l,h;switch(e.wrap[0]){case i.CGR_WRAPPING.CLAMP_TO_EDGE:s=i.ClampToEdgeWrapping;break;case i.CGR_WRAPPING.REPEAT:s=i.RepeatWrapping;break;case i.CGR_WRAPPING.CLAMP_TO_BORDER:s=i._ClampToBorderWrapping;break;case i.CGR_WRAPPING.MIRRORED_REPEAT:s=i.MirroredRepeatWrapping;break;default:s=i.ClampToEdgeWrapping}switch(e.wrap[1]){case i.CGR_WRAPPING.CLAMP_TO_EDGE:a=i.ClampToEdgeWrapping;break;case i.CGR_WRAPPING.REPEAT:a=i.RepeatWrapping;break;case i.CGR_WRAPPING.CLAMP_TO_BORDER:a=i._ClampToBorderWrapping;break;case i.CGR_WRAPPING.MIRRORED_REPEAT:a=i.MirroredRepeatWrapping;break;default:s=i.ClampToEdgeWrapping}switch(e.filter[0]){case 0:l=i.NearestFilter;break;case 1:l=i.LinearFilter;break;case 2:l=i.NearestMipMapNearestFilter;break;case 3:l=i.NearestMipMapLinearFilter;break;case 4:l=i.LinearMipMapNearestFilter;break;case 5:l=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:o=i.NearestFilter;break;case 1:o=i.LinearFilter;break;case 2:o=i.NearestMipMapNearestFilter;break;case 3:o=i.NearestMipMapLinearFilter;break;case 4:o=i.LinearMipMapNearestFilter;break;case 5:o=i.LinearMipMapLinearFilter}switch(e.type){case"url":if("dds"===(c=/(?:\.([^.]+))?$/.exec(e.sourceFile.filename)[1])?h=i.ImageUtils.loadCompressedTextureFromBuffer(e.sourceFile.buffer):(d=document.createElement("canvas"),h=new i.Texture(d),"XMLV6"===e.format?h.sourceFile=e.sourceFile:h.sourceFile=window.URL.createObjectURL(e.sourceFile.buffer)),h.wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l,e.offset&&h.offset.set(e.offset[0],e.offset[1]),"dds"===c){h&&h.mipmaps&&(1==(p=h.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(l=o=i.LinearFilter)),h.flipY=!0;break}"XMLV6"===e.format?t(h,e.texturePath+"/"+e.sourceFile):t(h,h.sourceFile),h&&(h.flipY=!0);break;case"url_envMap":var c,d,p;if("dds"===(c=/(?:\.([^.]+))?$/.exec(sourceFile.filename)[1])?h=i.ImageUtils.loadCompressedTextureFromBuffer(sourceFile.buffer):(d=document.createElement("canvas"),h=new i.Texture(d),"XMLV6"===e.format?h.sourceFile=sourceFile:h.sourceFile=window.URL.createObjectURL(sourceFile.buffer)),h.wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l,e.offset&&h.offset.set(e.offset[0],e.offset[1]),"dds"===c){h&&h.mipmaps&&(1==(p=h.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(h.minFilter=h.magFilter=i.LinearFilter)),h.flipY=!0;break}!function(e,t){var r;for(e.image=[],i.ImageUtils.nbTexturesBeingLoaded++,e.image.loadCount=0,r=0;r<6;++r)e.image[r]=new Image,e.image[r].onload=function(){if(e.image.loadCount+=1,6===e.image.loadCount){e.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--;for(var t=0;t<e.onLoadCallbacks.length;t++)e.onLoadCallbacks[t](e)}},e.image[r].onerror=function(){e.image.loadCount+=1,6===e.image.loadCount&&i.ImageUtils.nbTexturesBeingLoaded--},e.image[r].crossOrigin="anonymous",e.image[r].src=t}(h,e.texturePath+"/"+sourceFile),h&&(h.flipY=!0);break;case"data":var f=!1,g=!1,m=e.resources.img,v=e.resources.format,_=!1;switch((e.filter[0]>1||e.filter[1]>1)&&(_=!0),s!=i.RepeatWrapping&&a!=i.RepeatWrapping||(_=!0),e.resources.imgType){case 1:var y=e.resources.width,S=e.resources.height,b=i.UnsignedByteType;switch(v){case 0:v=i.LuminanceFormat;break;case 1:v=i.LuminanceAlphaFormat;break;case 2:v=i.RGBFormat;break;case 3:v=i.RGBAFormat,e.checkTransparency&&(f=n(m));break;case 14:v=i.LuminanceFormat,b=i.FloatType,m=new Float32Array(m.buffer)}if(b===i.UnsignedByteType&&((!i.ImageUtils.is_pow2(y)||!i.ImageUtils.is_pow2(S))&&_||y>this.maxTextureSize||S>this.maxTextureSize)){var x=y,w=S;if(_&&(x=i.ImageUtils.nearest_pow2(y),w=i.ImageUtils.nearest_pow2(S)),x>this.maxTextureSize||w>this.maxTextureSize)for(;x>this.maxTextureSize||w>this.maxTextureSize;)x/=2,w/=2;v===i.RGBAFormat?m=r(m,y,S,x,w,4):v===i.RGBFormat?m=r(m,y,S,x,w,3):v===i.LuminanceFormat&&(m=r(m,y,S,x,w,1)),y=x,S=w}if(h=new i.DataTexture(m,y,S,v,b,void 0,s,a,o,l)){if(h.size=y,h.flipY=!1,f&&(h.transparent=!0),v==i.RGBFormat){var P=3*y;P%4&&(h.unpackAlignment=2,P%2&&(h.unpackAlignment=1))}v==i.LuminanceFormat&&(h.unpackAlignment=1)}h.needsUpdate=!0;break;case 2:var C=e.resources,M=0;switch(C.format){case 3:M=i.RGBAFormat;break;case 6:M=i.RGB_S3TC_DXT1_Format,g=!0;break;case 7:M=i.RGBA_S3TC_DXT1_Format,g=!0;break;case 8:M=i.RGBA_S3TC_DXT3_Format,g=!0;break;case 9:M=i.RGBA_S3TC_DXT5_Format,g=!0}g&&function(e,t,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M;function E(e){b=e[4],e[4]=e[7],e[7]=b,b=e[5],e[5]=e[6],e[6]=b}function T(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}switch(n){case i.RGB_S3TC_DXT1_Format:l=8,a=E,o=function(e){b=e[4],e[4]=e[5],e[5]=b};break;case i.RGBA_S3TC_DXT3_Format:l=16,a=function(e){b=e[0],e[0]=e[6],e[6]=b,b=e[1],e[1]=e[7],e[7]=b,b=e[2],e[2]=e[4],e[4]=b,b=e[3],e[3]=e[5],e[5]=b,E(e.subarray(8,16))},o=function(e){b=e[0],e[0]=e[2],e[2]=b,b=e[1],e[1]=e[3],e[3]=b,E(e.subarray(8,16))};break;case i.RGBA_S3TC_DXT5_Format:l=16,a=function(e){w=e[2]+256*(e[3]+256*e[4]),C=e[5]+256*(e[6]+256*e[7]),P=(4095&w)<<12|(16773120&w)>>12,M=(4095&C)<<12|(16773120&C)>>12,e[2]=255&M,e[3]=(65280&M)>>8,e[4]=(16711680&M)>>8,e[5]=255&P,e[6]=(65280&P)>>8,e[7]=(16711680&P)>>8,E(e.subarray(8,16))},o=function(e){w=e[2]+256*(e[3]+256*e[4]),P=(4095&w)<<12,e[2]=255&P,e[3]=(65280&P)>>8,e[4]=(16711680&P)>>8,E(e.subarray(8,16))};break;default:return console.error("flip dds error"),s}for(h=e,c=t,f=0;f<r&&(v=s[f].data,p=(d=Math.floor((h+3)/4))*(u=Math.floor((c+3)/4)),1!=c);++f){if(2==c)for(g=0;g<d;g++)o(v.subarray(m,g*l)),m=+l;else{for(m=0,g=1;g<=p;g++)a(v.subarray(m,g*l)),m+=l;x=l*d,S=new Uint8Array(x);for(var A=0;A<u/2;++A)_=v.subarray(A*x,(A+1)*x),y=v.subarray((u-A-1)*x,(u-A)*x),T(S,_),T(_,y),T(y,S)}(h/=2)<1&&(e=1),(c/=2)<1&&(t=1)}}(C.width,C.height,C.mipmapCount,M,C.mipmaps),(h=new i.CompressedTexture(C.mipmaps,C.width,C.height,M,void 0,new i.UVMapping,s,a,o,l)).flipY=!1,h.generateMipmaps=!1,h.needsUpdate=!0;break;case 3:var E=new Blob([m],{type:"image/png"}),T=URL.createObjectURL(E);return h=i.ImageUtils.loadTexture(T,void 0,(function(e){var t=e.image;if((h=e).needsUpdate=!0,h.transparentCb){var i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0,t.width,t.height);var r=i.getContext("2d").getImageData(0,0,t.width,t.height);h.transparent=n(r.data),h.transparent&&h.transparentCb(h.transparent)}}),null,i.ImageUtils.crossOriginPolicy,_,null,null,this.maxTextureSize,s,a,o,l),h.needToCheckTransparency=!!e.checkTransparency,h&&e.borderColor&&(h.borderColor=e.borderColor),h;case 4:var A=new Uint32Array(m.buffer);return(h=i.ImageUtils.loadCompressedTextureFromBuffer(A)).wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l,h&&e.borderColor&&(h.borderColor=e.borderColor),h;case 5:(h=i.ImageUtils.loadBasisTexture(e.resources.img,null,null,null,null,i.BasisUsage[u[e.resources.format]])).wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l;break;case 6:(h=i.ImageUtils.loadKTX2Texture(e.resources.img,null,null,null,null,i.BasisUsage[u[e.resources.format]])).wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l;break;default:h=null}break;default:h=null}return h&&e.borderColor&&(h.borderColor=e.borderColor),h},set3DXSharedGas:function(e,t){this.threeDXSharedGas.set(e,t)},get3DXSharedGas:function(e){return this.threeDXSharedGas.has(e)?this.threeDXSharedGas.get(e):null},getDashPatternArrayMaterial:function(e){var t,n,s;for(null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1),s=0;s<this.materials.length;s++)if("color"===(n=(t=this.materials[s]).params).type&&!(void 0!==e.pattern&&n.pattern!==e.pattern||n.color.r!==e.color.r||n.color.g!==e.color.g||n.color.b!==e.color.b||n.opacity!==e.opacity||void 0!==e.lineWidth&&n.lineWidth!==e.lineWidth))return t.threejs_mat;return void 0!==e.lineWidth?(n={type:"color",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},t=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(t.setDashPatternArray(e.pattern),t.setScale(1)):(t.setDashPatternType(e.pattern),t.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4)),this.materials.push({params:n,threejs_mat:t,hasTexture:!1}),t._source=i.AssetSource.MATERIAL_MANAGER,t):(console.warn("getMaterialFromGAS"),new i.LineBasicMaterial)},getMaterialFromGAS:function(e){if(this._currentMatHasTexture=!1,void 0!==e.pattern&&e.pattern instanceof Array)return this.getDashPatternArrayMaterial(e);var t=null;e.depthPriority?(t=new r.GraphicAttributeSetForDepth(4278456352,-1,2,e.depthPriority.value)).setDepthPriority(e.depthPriority.value):t=new r.GraphicAttributeSet(4278456352,-1,2);var i=255,n=[255,255,255];void 0!==e.solid&&e.solid?t.setType(3):t.setType(2),void 0!==e.color&&null!==e.color&&(n[0]=255*e.color.r,n[1]=255*e.color.g,n[2]=255*e.color.b),void 0!==e.symbol&&(t._setConnectivity(0),t.setType(0),t.setSymbol(e.symbol),void 0!==e.size&&t.setPointSize(e.size)),void 0!==e.lineWidth&&(t._setConnectivity(1),t.setType(1),t.setLineThickness(e.lineWidth),void 0!==e.pattern&&t.setLineType(e.pattern)),e.basic&&t.setBasic(!0),void 0!==e.opacity&&(i=255*e.opacity);var s=n[0]<<24^n[1]<<16^n[2]<<8^i<<0;t.setRGBAColor(s);var a={};return e.originalMaterial&&(a.originalMaterial=e.originalMaterial),this._getMaterialFromGAS(t,a)},setCGRSharedMaterial:function(e,t){this.CGRSharedMaterials.set(e,t)},getCGRSharedMaterial:function(e,t){return this.CGRSharedMaterials.has(e)?t?this.CGRSharedMaterials.get(e).clone():this.CGRSharedMaterials.get(e):null},getMaterialFromGAS2:function(e){var t,n;this._currentMatHasTexture=!1,null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1);var s=!!i._GASFaceMaterialsAsPBR;for(n=0;n<this.materials.length;n++)if("color"===(t=(a=this.materials[n]).params).type&&(void 0===e.symbol||"point"===t.style)&&(void 0===e.lineWidth||"line"===t.style)&&(void 0!==e.lineWidth||void 0!==e.symbol||"fill"===t.style)&&(void 0===e.pattern||t.pattern===e.pattern)&&t.color.r===e.color.r&&t.color.g===e.color.g&&t.color.b===e.color.b&&t.opacity===e.opacity&&(void 0===e.lineWidth||t.lineWidth===e.lineWidth)&&(void 0===e.symbol||t.symbol===e.symbol)&&(void 0===e.size||t.size===e.size)&&(void 0===e.solid||t.solid===e.solid)&&(!e.basic||t.basic===e.basic)&&(!1!==t._pbr||!s)&&(!0!==t._pbr||s))return a.threejs_mat;if(void 0!==e.symbol){t={type:"color",style:"point",color:e.color,opacity:e.opacity,symbol:e.symbol,size:e.size};var a=this.createPointMaterial({symbol:e.symbol,color:e.color,opacity:e.opacity,resource:e.resource,size:e.size,_cgr:!0})}else if(void 0!==e.lineWidth)t={type:"color",style:"line",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},a=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(a.setDashPatternArray(e.pattern),a.setScale(1)):(a.setDashPatternType(e.pattern),a.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4));else if(e.basic){t={type:"color",style:"fill",color:e.color,opacity:e.opacity,basic:e.basic,solid:e.solid};var o={color:e.color.getHex(),side:1===e.solid?i.FrontSide:i.DoubleSide,opacity:e.opacity,transparent:e.opacity<1};a=new i.MeshBasicMaterial(o)}else{t={type:"color",style:"fill",color:e.color,opacity:e.opacity,solid:e.solid,_pbr:!1};o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,specular:16777215,shininess:76};if(a=new i.MeshPhongMaterial(o),s){var l=a;t._pbr=!0;var h=i.MaterialUtils.convertShininessToIoRRoughness(null);o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,ior:h.ior,specular:16777215,roughness:h.roughness},a=new i._GASPBRMaterial(o,l)}}return this.materials.push({params:t,threejs_mat:a,hasTexture:this._currentMatHasTexture}),a._source=i.AssetSource.MATERIAL_MANAGER,a},_getLineWidth:function(e){var t=e.getThickness();return t=t>d.length?1:d[t]},_gasAllowNMIR:function(e){return!(e.getLineType()>1||this._getLineWidth(e)>1)},_getNbGasMaterial:function(){var e=0;return this.gasMaterialsMap.forEach((function(t,i,r){e++})),this.lineTypeMaterialMap.forEach((function(t,i,r){e++})),e},_getMaterialFromGAS:function(e,t){var n=this,s=function(e){var t=e.getDisplayedColor();return t[0]=t[0]/255,t[1]=t[1]/255,t[2]=t[2]/255,t[3]=t[3]/255,t},a=null,o=!0,l=!!i._GASFaceMaterialsAsPBR;if(e.setCacheValue(),t&&t.lineType){const i=t.lineType.lineType,r=t.lineType.lineWeight;1==t.lineType.lineTypeScale&&Number.isInteger(i)&&Number.isInteger(r)&&i<64&&r<64?(e.setLineType(i),e.setLineThickness(r),t.lineType=null):o=!1}var h=e.getConnectivity(),c=e.isBasic(),d=e.getType(),u=e.isBlankingRep();h>1&&!c&&l&&e.setPBR();var p=null;if(p=e.depthMode?[e.set,e.rgba,e.webOverride,e.depthPriority]:[e.set,e.rgba,e.webOverride],o&&this.gasMaterialsMap.has(...p)&&this.gasMaterialsMap.get(...p))a=this.gasMaterialsMap.get(...p);else{switch(h){case 0:a=function(e,t){var r=s(e),a=(new i.Color).setRGB(r[0],r[1],r[2]),o=e.getSymbol(),l=e.getPointSize(),h=e.getVertexColor(),c=e.getType(),d=e.isNoZ(),u=(3==c?i.FrontSide:i.DoubleSide,n.createPointMaterial({symbol:o,color:a,opacity:r[3],size:l,_cgr:!0,isNoz:d,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0}));return h&&(u.vertexColors=i.VertexColorType.RGB),u}(e,t);break;case 1:a=function(e,t){var a=s(e);let o={lineWidth:1,color:(new i.Color).setRGB(a[0],a[1],a[2]).getHex(),opacity:a[3],transparent:a[3]<1,linecap:"butt",_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0};if(n.hasLineTypes()){let r=null,s=e.getLineType(),a=e.getLineThicknessID(),h=1;if(t&&t.lineType){let i=null,s=t.lineType.lineType,a=t.lineType.lineWeight,h=t.lineType.lineTypeScale;var l=e.getLineTypeKeys();i=e.depthMode?[l[0],l[1],s,a,h,e.depthPriority]:[l[0],l[1],s,a,h],n.lineTypeMaterialMap.has(...i)&&n.lineTypeMaterialMap.get(...i)?r=n.lineTypeMaterialMap.get(...i):(r=n._createLineTypeMaterial(a,s,h,o),r&&n.lineTypeMaterialMap.set(...i,r))}else r=n._createLineTypeMaterial(a,s,h,o);return r||new i.LineBasicMaterial(o)}{const t=e.getLineType(),n=e.getLineThickness();o.lineWidth=n;let s=new i.LineBasicMaterial(o);return s.setDashPatternType(t),s.setScale(t===r.LinePatternEnum.SMALLDOTTED?2:4),s}}(e,t);break;case 2:case 3:a=u?this.getBlankingRepMaterial(e.isTransparentBlankingRep()):c||d<2?function(e,t){var r=s(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),o=3==e.getType()?i.FrontSide:i.DoubleSide,l={color:n.getHex(),side:o,opacity:r[3],transparent:r[3]<1,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0};return a=new i.MeshBasicMaterial(l)}(e,t):function(e,t){var r=s(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),a=3==e.getType()?i.FrontSide:i.DoubleSide,o=e.isPBR(),l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:a,specular:16777215,shininess:76,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},h=new i.MeshPhongMaterial(l);if(o){var c=h,d=i.MaterialUtils.convertShininessToIoRRoughness(null);l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:a,specular:16777215,ior:d.ior,roughness:d.roughness,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},h=new i._GASPBRMaterial(l,c)}return h}(e,t)}a._source=i.AssetSource.MATERIAL_MANAGER,a._isFromGAS=!0,e.isBackgroundColor()&&(a.color=this.backgroundColor,this.backgroundColorMaterials.push(a)),e.isForegroundColor()&&(a.color=this.foregroundColor,this.foregroundColorMaterials.push(a)),2==e.getSceneGraphOrder()&&function(e){e.activatePDSFX("PDSFXSGOrder"),e.setPDSFXVaryings({depthSGOrder:{type:"f"}}),e.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                                ${(t=>e.getVarying(t))("depthSGOrder")} =${e.vGetAttribPosition()}.z;\n                            `},ComputeObjectPosition:function(e,t){const i=e.variableHandler;return`\n                                return ${(e=>i.vec3(e))()}(${e.vGetAttribPosition()}.xy, 0.0);\n                            `},ComputeObjectFollowingPosition:function(e,t){const i=e.variableHandler;return`\n                            return ${(e=>i.vec3(e))()}(${e.vGetAttribFollowingPosition()}.xy, 0.0);\n                            `},ComputeObjectPreviousPosition:function(e,t){const i=e.variableHandler;return`\n                            return ${(e=>i.vec3(e))()}(${e.vGetAttribPreviousPosition()}.xy, 0.0);\n                            `}},{ComputeCommonValues:function(e,t){return`\n                                ${e.vSetFragDepth(`(16777216.0 -${(t=>e.getVarying(t))("depthSGOrder")})/16777216.0`)};\n                            `}})}(a),e.depthMode&&this._setPDSFXDepthPriority(a,e.getDepthPriority(),!0),o&&this.gasMaterialsMap.set(...p,a)}return e.depthMode&&t.originalMaterial&&t.originalMaterial.defines&&0==t.originalMaterial.defines.DEPTH_PRIORITY&&(t.originalMaterial.defines.DEPTH_PRIORITY=!0,t.originalMaterial.updatePDSFXUniform("depthPriority",e.getDepthPriority()),t.originalMaterial.needsUpdate=!0),a},_setPDSFXDepthPriority:function(e,t,i){e.depthTest=!0,e.activatePDSFX("PDSFXDepthPriority");var r={depthPriority:{type:"f",value:t}};e.setPDSFXUniforms(r);e.setPDSFXOverridableFunctions(null,{ComputeCommonValues:function(e,t){return e.userDefines.DEPTH_PRIORITY?`\n                            ${e.vSetFragDepth(`(16777000.0 -${(t=>e.getUniform(t))("depthPriority")})/16777216.0`)};\n                            `:""}}),e.defines||(e.defines={}),e.defines.DEPTH_PRIORITY=!!i},recompileShaders:function(){for(var e=0;e<this.materials.length;e++){var t=this.materials[e];t&&t.threejs_mat&&t.threejs_mat.recompileShaders(!1)}}});return _.PointSymbolEnum={NOSPRITE:0,CROSS:1,PLUS:2,CONCENTRIC:3,COINCIDENT:4,FULLCIRCLE:5,FULLSQUARE:6,STAR:7,DOT:8,SMALLDOT:9,MISC1:10,MISC2:11,FULLCIRCLE2:12,FULLSQUARE2:13,LOSANGEBORDER:14,FULLLOSANGE:15,FULLCIRCLE3:16,OUTLINE_DOUBLEROTATEARROW:17,FILLED_DOUBLEROTATEARROW:18,OUTLINE_SQUARE:19,FILLED_SQUARE:20,OUTLINE_DIAMOND:21,FILLED_DIAMOND:22},_.PointSymbolEnumSize=[1,9,9,9,9,5,7,9,3,2,9,9,7,9,9,7,7,15,13,9,7,11,9],UWA.namespace("THREEDS/MaterialManager",_)})),define("Visualization/MaterialManager",["DS/Visualization/MaterialManager","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/MaterialManager"),e})),define("DS/Visualization/GraphicAttributeSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/CoreEvents/Events"],(function(e,t,i,r){"use strict";const n=e.__visibleInCurrentSpaceSimple;e.GASEnum={NO_INHERIT:0,RESET_INHERITANCE:0,HIGHLIGHT_INHERITANCE_ON:1,HIGHLIGHT_INHERITANCE_OFF:2,COLOR_INHERITANCE_ON:4,COLOR_INHERITANCE_OFF:8,LINEWIDTH_INHERITANCE_ON:16,LINEWIDTH_INHERITANCE_OFF:32,LINETYPE_INHERITANCE_ON:64,LINETYPE_INHERITANCE_OFF:128,BACKGROUND3DVIEWMODE_ON:256,BACKGROUND3DVIEWMODE_OFF:512,ASMCOLOR_INHERITANCE_ON:1024,ASMCOLOR_INHERITANCE_OFF:2048,ALPHA_INHERITANCE_ON:4096,ALPHA_INHERITANCE_OFF:8192,DEFAULTLOOK_INHERITANCE_ON:16384,DEFAULTLOOK_INHERITANCE_OFF:32768,TOP_PRIORITY_ON:65536,TOP_PRIORITY_OFF:1<<17,_2DMODE_INHERITANCE_ON:1<<18,_2DMODE_INHERITANCE_OFF:1<<19,_FORCE_COLOR:1<<20};const s=e.GASEnum;e.GASEnumCustom={TRANSITION:1,_FORCE_EDGE_OPACITY:2,_TYPE_FROM_PARENT:8,_COLOR_INDEX_WITH_OPACITY:16,_FORCE_COLOR_AND_OPACITY:32,_ANNOTATION_BACKGROUND:64};const a=e.GASEnumCustom;s.COLOR_INHERIT=s.COLOR_INHERITANCE_ON,s.ALPHA_INHERIT=s.ALPHA_INHERITANCE_ON,s.LINEWIDTH_INHERIT=s.LINEWIDTH_INHERITANCE_ON,s.LINETYPE_INHERIT=s.LINETYPE_INHERITANCE_ON,s.ASMCOLOR_INHERIT=s.ASMCOLOR_INHERITANCE_ON,s.RGBA_INHERITANCE_ON=s.COLOR_INHERITANCE_ON|s.ALPHA_INHERITANCE_ON,s.RGBA_INHERIT=s.RGBA_INHERITANCE_ON,s.RGBA_INHERITANCE_OFF=s.COLOR_INHERITANCE_OFF|s.ALPHA_INHERITANCE_OFF,e.GASTypeEnum={NOZ:0,EDGE:1,SKIN:2,VOLUME:3,_SKIN:255};const o=e.GASTypeEnum;e.COLORMAP_INDEX={EDGE_HIGHLIGHT:239,UPDATENEEDED:240,HANDLECOLOR:241,CYAN:242,MAGENTA:243,YELLOW:244,BLUE:245,GREEN:246,RED:247,WHITE:248,BLACK:249,PREHIGHLIGHT:250,HIGHLIGHT:251,LOWLIGHT:252,FOREGROUND:253,BACKGROUND:254,TRUECOLOR:255};const l=e.COLORMAP_INDEX,h=new e.Color(0),c=(new e.Color(16448250),new e.Color),d=[0,0,0,.25999999046325684,.4000000059604645,.33000001311302185,1,.46000000834465027,0,1,1,1,1,0,0,0,1,0,0,.4000000059604645,1,.8600000143051147,.8600000143051147,0,.05999999865889549,.05999999865889549,.05999999865889549,.12999999523162842,.12999999523162842,.12999999523162842,.20000000298023224,.20000000298023224,.20000000298023224,.25999999046325684,.25999999046325684,.25999999046325684,.33000001311302185,.25999999046325684,.25999999046325684,.4000000059604645,.4000000059604645,.4000000059604645,.46000000834465027,.46000000834465027,.46000000834465027,.5299999713897705,.5299999713897705,.5299999713897705,.6000000238418579,.6000000238418579,.6000000238418579,.6600000262260437,.6600000262260437,.6600000262260437,.7300000190734863,.7300000190734863,.7300000190734863,.800000011920929,.800000011920929,.800000011920929,.8600000143051147,.8600000143051147,.8600000143051147,.9300000071525574,.9300000071525574,.9300000071525574,1,1,1,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,0,.05999999865889549,0,.05999999865889549,.12999999523162842,0,.12999999523162842,.20000000298023224,0,.20000000298023224,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.4000000059604645,0,.4000000059604645,.46000000834465027,0,.46000000834465027,.5299999713897705,0,.5299999713897705,.6000000238418579,0,.6000000238418579,.6600000262260437,0,.6600000262260437,.7300000190734863,0,.7300000190734863,.800000011920929,0,.800000011920929,.8600000143051147,0,.8600000143051147,.9300000071525574,0,.9300000071525574,1,0,1,0,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,1,0,0,1,0,0,0,1,0,0,.8999999761581421,.8999999761581421,.8999999761581421,0,.8999999761581421,.8600000143051147,.8600000143051147,0,0,.4000000059604645,1,0,1,0,1,0,0,1,1,1,0,0,0,.8235294818878174,.8235294818878174,1,0,.7843137383460999,.7843137383460999,.26274511218070984,.4000000059604645,.3333333432674408,1,1,1,.2352941334247589,.40000003576278687,.501960813999176,0,0,0],u=new Map;e._getColorMap=function(t){if(u.has(t))return u.get(t);for(var i=new Array(256),r=0;r<i.length;r++){var n=d[3*r],s=d[3*r+1],a=d[3*r+2];i[r]=(new e.Color).setRGB(n,s,a)}return i[l.FOREGROUND]=(new e.Color).setRGB(0,0,0),i[l.HIGHLIGHT]=(new e.Color).setRGB(0,.784313738,.784313738),i[l.LOWLIGHT]=(new e.Color).setRGB(.262745112,.400000006,.333333343),i[l.BACKGROUND]=(new e.Color).setRGB(.92549026,.92549026,.92549026),u.set(t,i),i};const p=e._getColorMap;r.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE"},(function(e){const t=e.parameters,i=t.viewer,n=i.renderer.renderer;var s=p(n);if(!(t.slot<0||t.slot>255)){if(t.slot>=0)s[t.slot]=t.color;else for(var a=0;a<t.colorMap.length;a++)s[a]=t.colorMap[a];i._modelEvent.publish({event:"ColorMapUpdated"}),r.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE",eventType:"@AFTER_COLOR_MAP_UPDATE",parameters:{viewer:i}}})}})),r.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},(function(e){var t=e.parameters.viewer.renderer.renderer;u.delete(t)}));const f=[t.PointSymbolEnum.CROSS,t.PointSymbolEnum.PLUS,t.PointSymbolEnum.CONCENTRIC,t.PointSymbolEnum.COINCIDENT,t.PointSymbolEnum.FULLCIRCLE,t.PointSymbolEnum.FULLSQUARE,t.PointSymbolEnum.STAR,t.PointSymbolEnum.DOT,t.PointSymbolEnum.SMALLDOT,t.PointSymbolEnum.MISC1,t.PointSymbolEnum.MISC2,t.PointSymbolEnum.FULLCIRCLE2,t.PointSymbolEnum.FULLSQUARE2,t.PointSymbolEnum.LOSANGEBORDER,t.PointSymbolEnum.FULLLOSANGE,t.PointSymbolEnum.FULLCIRCLE3,t.PointSymbolEnum.OUTLINE_DOUBLEROTATEARROW,t.PointSymbolEnum.FILLED_DOUBLEROTATEARROW,t.PointSymbolEnum.OUTLINE_SQUARE,t.PointSymbolEnum.FILLED_SQUARE,t.PointSymbolEnum.OUTLINE_DIAMOND,t.PointSymbolEnum.FILLED_DIAMOND],g=[t.PointSymbolEnumSize[t.PointSymbolEnum.CROSS],t.PointSymbolEnumSize[t.PointSymbolEnum.PLUS],t.PointSymbolEnumSize[t.PointSymbolEnum.CONCENTRIC],t.PointSymbolEnumSize[t.PointSymbolEnum.COINCIDENT],t.PointSymbolEnumSize[t.PointSymbolEnum.FULLCIRCLE],t.PointSymbolEnumSize[t.PointSymbolEnum.FULLSQUARE],t.PointSymbolEnumSize[t.PointSymbolEnum.STAR],t.PointSymbolEnumSize[t.PointSymbolEnum.DOT],t.PointSymbolEnumSize[t.PointSymbolEnum.SMALLDOT],t.PointSymbolEnumSize[t.PointSymbolEnum.MISC1],t.PointSymbolEnumSize[t.PointSymbolEnum.MISC2],t.PointSymbolEnumSize[t.PointSymbolEnum.FULLCIRCLE2],t.PointSymbolEnumSize[t.PointSymbolEnum.FULLSQUARE2],t.PointSymbolEnumSize[t.PointSymbolEnum.LOSANGEBORDER],t.PointSymbolEnumSize[t.PointSymbolEnum.FULLLOSANGE],t.PointSymbolEnumSize[t.PointSymbolEnum.FULLCIRCLE3],t.PointSymbolEnumSize[t.PointSymbolEnum.OUTLINE_DOUBLEROTATEARROW],t.PointSymbolEnumSize[t.PointSymbolEnum.FILLED_DOUBLEROTATEARROW],t.PointSymbolEnumSize[t.PointSymbolEnum.OUTLINE_SQUARE],t.PointSymbolEnumSize[t.PointSymbolEnum.FILLED_SQUARE],t.PointSymbolEnumSize[t.PointSymbolEnum.OUTLINE_DIAMOND],t.PointSymbolEnumSize[t.PointSymbolEnum.FILLED_DIAMOND]];var m=new Float64Array(1),v=new Uint8Array(m.buffer),_=new Uint32Array(m.buffer);class y{constructor(e){this._attr=0,this._rgba=0,this._inheritanceInternal=0,this._color=null,this._colorSet=!1,this._colorIndex=l.TRUECOLOR,this._alpha=1,this._lineWidth=1,this._lineType=i.LinePatternEnum.SOLID,this._symbolType=i.PointSymbolEnum.UNKNOWN,this._basic=!1,this._lowlight=!1,this._highlight=!1,this._show=!0,this._showFree=!1,this._noPick=!1,this._transparent=!0,this._inheritance=s.RGBA_INHERITANCE_ON,this._type=o._SKIN,this._priority=4,e&&e.NREInit&&(this._type=o.NOZ,this._transparent=!1,this._inheritance=s.NO_INHERIT,this._colorIndex=l.FOREGROUND,this._lineWidth=0,this._color=h),e&&this.setParameters(e)}setParameters(e){return void 0!==e.colorRGB&&(this._color=e.colorRGB),void 0!==e.colorIndex&&(this._colorIndex=e.colorIndex),void 0!==e.colorA&&(this._alpha=e.colorA),void 0!==e.lineWidth&&(this._lineWidth=e.lineWidth),void 0!==e.lineType&&(this._lineType=e.lineType),void 0!==e.symbolType&&(this._symbolType=e.symbolType),void 0!==e.side&&(this.side=e.side),void 0!==e.inheritance&&(this._inheritance=e.inheritance),void 0!==e.inheritanceCustom&&(this._inheritanceCustom=e.inheritanceCustom),void 0!==e.lowlight&&(this._lowlight=e.lowlight),void 0!==e.highlight&&(this._highlight=e.highlight),void 0!==e.noPick&&(this._noPick=e.noPick),void 0!==e.show&&(this._show=e.show),void 0!==e.showFree&&(this._showFree=e.showFree),void 0!==e.transparent&&(this._transparent=e.transparent),void 0!==e.type&&(this._type=e.type),void 0!==e.basic&&(this._basic=e.basic),void 0!==e.priority&&(this._priority=e.priority),this}merge(e,t){var r=!!t&&t.canBeUsed(),n=this;function o(){(t.getInheritance()&s.ASMCOLOR_INHERITANCE_ON)>0&&(n._color=e._color,n._colorIndex=e._colorIndex,n._inheritance|=s.ASMCOLOR_INHERITANCE_ON,e._doesInherit(s.ASMCOLOR_INHERITANCE_ON)||(n._color=t._asmGAS._color,n._colorIndex=t._asmGAS._colorIndex)),(t.getInheritance()&s.COLOR_INHERITANCE_ON)>0&&(n._color=e._color,n._colorIndex=e._colorIndex,n._inheritance|=s.COLOR_INHERITANCE_ON,e._doesInherit(s.COLOR_INHERITANCE_ON)||(n._color=t._GAS._color,n._colorIndex=t._GAS._colorIndex))}var l=this._symbolType!==i.PointSymbolEnum.UNKNOWN?this._symbolType:e._symbolType;return this._doesInheritCustom(a.TRANSITION)?(this.copy(e),r&&(this._inheritance&=~s.COLOR_INHERITANCE_ON,this._inheritance&=~s.ASMCOLOR_INHERITANCE_ON,o())):(this._doesInheritCustom(a._FORCE_COLOR_AND_OPACITY)||(r?o():(e._doesInherit(s.COLOR_INHERITANCE_ON)&&(this._color=e._color,this._colorIndex=e._colorIndex,this._inheritance|=s.COLOR_INHERITANCE_ON),e._doesInherit(s.ASMCOLOR_INHERITANCE_ON)&&(this._color=e._color,this._colorIndex=e._colorIndex,this._inheritance|=s.ASMCOLOR_INHERITANCE_ON)),e._doesInherit(s.ALPHA_INHERITANCE_ON)&&(this._alpha=e._alpha,this._transparent=e._transparent,this._inheritance|=s.ALPHA_INHERITANCE_ON),this._lowlight=this._lowlight||e._lowlight,this._highlight=this._highlight||e._highlight),e._doesInherit(s.LINEWIDTH_INHERITANCE_ON)&&(this._lineWidth=e._lineWidth,this._inheritance|=s.LINEWIDTH_INHERITANCE_ON),e._doesInherit(s.LINETYPE_INHERITANCE_ON)&&(this._lineType=e._lineType,this._inheritance|=s.LINETYPE_INHERITANCE_ON),e._doesInherit(s.DEFAULTLOOK_INHERITANCE_ON)&&(this._inheritance|=s.DEFAULTLOOK_INHERITANCE_ON),e._doesInheritCustom(a._FORCE_EDGE_OPACITY)&&(this._inheritanceCustom|=a._FORCE_EDGE_OPACITY),this._doesInheritCustom(a._TYPE_FROM_PARENT)&&(this._inheritanceCustom|=a._TYPE_FROM_PARENT,this._type=e._type,this._priority=e._priority),this._doesInheritCustom(a._COLOR_INDEX_WITH_OPACITY)&&(this._inheritanceCustom|=a._COLOR_INDEX_WITH_OPACITY),this._doesInheritCustom(a._FORCE_COLOR_AND_OPACITY)&&(this._inheritanceCustom|=a._FORCE_COLOR_AND_OPACITY)),this._symbolType=l,this}copy(e){this._inheritanceInternal=e._inheritanceInternal,this._rgba=e._rgba,this._attr=e._attr}clone(){var e=new y;return e.copy(this),e}getJSON(){return{attr:this._attr,rgba:this._rgba}}_dump(){var e=this.getJSON();return e.type="StructGAS",e}getPointSize(){if(this._symbolType===i.PointSymbolEnum.UNKNOWN)return 1;var t=this._symbolType;return Math.round(g[t]*(e.getDevicePixelRatio()||1))}getLineType(){return this._lineType}getLineThicknessID(){return this._lineWidth}getLineThickness(){let e=this.getLineThicknessID();var r=new t,n=r.hasLineTypes()?r.lineTypes.widths.map((e=>e.pixelRadius)):i.ThicknessTable;return e>n.length?1:n[e]}getLineGap(){var e=new t;if(e.hasLineTypes()){let t=this.getLineType();const i=e.lineTypes.lineTypes[t];let r=i.pattern;null!==i.patternVisu&&void 0!==i.patternVisu&&(r=i.patternVisu+e.lineTypes.patternsOffset);const n=e.lineTypes.patterns[r];if(n&&n.lineGap)return n.lineGap}return 0}getMaterialParameters(t,r,n,c,d,u){var g={},m=t&&t.isGAS,v=m&&t._symbolType!==i.PointSymbolEnum.UNKNOWN?t._symbolType:this._symbolType;m&&t._doesInheritCustom(a.TRANSITION)&&(t=this,m=!0);var _=m&&t._doesInheritCustom(a._FORCE_COLOR_AND_OPACITY);if(g.opacity=1,!_&&this._doesInherit(s.ALPHA_INHERITANCE_ON)?g.opacity=this._transparent?this._alpha:1:t&&(g.opacity=m?t._transparent?t._alpha:1:t.opacity),!_&&this._doesInherit(s.COLOR_INHERITANCE_ON|s.ASMCOLOR_INHERITANCE_ON)?t&&m&&t._doesInherit(s._FORCE_COLOR)?(g.color=t._color,t._colorIndex!==l.TRUECOLOR&&(g.color=p(c)[t._colorIndex],t._doesInheritCustom(a._COLOR_INDEX_WITH_OPACITY)||(g.opacity=1))):(g.color=this._color,this._colorIndex!==l.TRUECOLOR&&(g.color=p(c)[this._colorIndex],this._doesInheritCustom(a._COLOR_INDEX_WITH_OPACITY)||(g.opacity=1))):t&&(g.color=m?t._color:t.color,m&&t._colorIndex!==l.TRUECOLOR&&(g.color=p(c)[t._colorIndex],t._doesInheritCustom(a._COLOR_INDEX_WITH_OPACITY)||(g.opacity=1))),t?m||"Basic"!==t.getType()&&"GASBasic"!==t.getType()?m&&(g.basic=t._basic):(g.basic=!0,"blankingMat"===t.name&&(g.opacity=0)):g.basic=this._basic,n&&n._basic&&(g.basic=!0),r>1)if(t)if(m){var y=t._doesInheritCustom(a._TYPE_FROM_PARENT)?this._type:t._type;g.solid=y===o.VOLUME?1:0,y===o.NOZ&&(g.basic=!0)}else g.solid=t.side===e.FrontSide?1:0;else g.solid=this._type===o.VOLUME?1:0,this._type===o.NOZ&&(g.basic=!0);if(1===r&&(g.lineWidth=1,this._doesInheritCustom(a._FORCE_EDGE_OPACITY)||(g.opacity=1),this._doesInherit(s.ASMCOLOR_INHERITANCE_ON)&&(g.color=h),this._doesInherit(s.LINEWIDTH_INHERITANCE_ON)?g.lineWidth=this._lineWidth:t&&(g.lineWidth=m?t._lineWidth:t.lineWidth),g.lineWidth||(g.lineWidth=1),this._doesInherit(s.LINETYPE_INHERITANCE_ON)?g.pattern=this._lineType:t&&(g.pattern=m?t._lineType:t.dashPattern),g.pattern||(g.pattern=i.LinePatternEnum.SOLID)),0===r){var S=v!==i.PointSymbolEnum.UNKNOWN?v:i.PointSymbolEnum.DOT;g.symbol=f[S]}return _||((this._highlight||m&&t._highlight)&&(g.color=p(c)[l.HIGHLIGHT],g.opacity=1),(this._lowlight||m&&t._lowlight)&&(g.color=p(c)[l.LOWLIGHT],g.opacity=1)),d&&(g.depthPriority=d.depthPriority),u&&(g.originalMaterial=u),g}getMaterial(e,i,r,n,s,a){return(new t).getMaterialFromGAS(this.getMaterialParameters(e,i,r,n,s,a))}hasASMInherit(){return(this._inheritance&s.ASMCOLOR_INHERITANCE_ON)>0}_doesInherit(e){return(this._inheritance&e)>0}_doesInheritCustom(e){return(this._inheritanceCustom&e)>0}__updateGAS(e){return e&&e.isGAS?(e.copy(this),e):this.__getGAS(e).clone()}__getGAS(e){return this}_isEqual(e){return!!e&&(e._attr===this._attr&&e._rgba===this._rgba&&e._inheritanceInternal===this._inheritanceInternal)}visibleInCurrentSpace(e,t){return n(e.visible&&this._show,e.visibilityFree||this._showFree,t,null)}static _createFromGASAttributes(t){var i={colorRGB:t.color,colorA:t.opacity,side:1===t.solid?e.FrontSide:e.DoubleSide,inheritance:s.RGBA_INHERITANCE_ON,inheritanceCustom:0};return t.lineWidth&&(i.lineWidth=t.lineWidth,i.inheritance|=s.LINEWIDTH_INHERITANCE_ON),t.linewidth&&(i.lineWidth=t.linewidth,i.inheritance|=s.LINEWIDTH_INHERITANCE_ON),t.pattern&&(i.lineType=t.pattern,i.inheritance|=s.LINETYPE_INHERITANCE_ON),void 0!==t.symbol&&(i.symbolType=t.symbol),new y(i)}static getLowLightColor(e){return p(e)[l.LOWLIGHT]}get _colorIndex(){return m[0]=this._attr,v[0]}set _colorIndex(e){m[0]=this._attr,v[0]=e,this._attr=m[0]}get _lineWidth(){return m[0]=this._attr,v[1]}set _lineWidth(e){m[0]=this._attr,v[1]=e,this._attr=m[0]}get _lineType(){return m[0]=this._attr,v[2]}set _lineType(e){m[0]=this._attr,v[2]=e,this._attr=m[0]}get _basic(){return m[0]=this._attr,(1&v[3])>0}set _basic(e){m[0]=this._attr,e?v[3]|=1:v[3]&=-2,this._attr=m[0]}get _lowlight(){return m[0]=this._attr,(2&v[3])>0}set _lowlight(e){m[0]=this._attr,e?v[3]|=2:v[3]&=-3,this._attr=m[0]}get _highlight(){return m[0]=this._attr,(4&v[3])>0}set _highlight(e){m[0]=this._attr,e?v[3]|=4:v[3]&=-5,this._attr=m[0]}get _noPick(){return m[0]=this._attr,(8&v[3])>0}set _noPick(e){m[0]=this._attr,e?v[3]|=8:v[3]&=-9,this._attr=m[0]}get _show(){return m[0]=this._attr,(16&v[3])>0}set _show(e){m[0]=this._attr,e?v[3]|=16:v[3]&=-17,this._attr=m[0]}get _showFree(){return m[0]=this._attr,(32&v[3])>0}set _showFree(e){m[0]=this._attr,e?v[3]|=32:v[3]&=-33,this._attr=m[0]}get _transparent(){return m[0]=this._attr,(64&v[3])>0}set _transparent(e){m[0]=this._attr,e?v[3]|=64:v[3]&=-65,this._attr=m[0]}get _colorSet(){return m[0]=this._attr,(128&v[3])>0}set _colorSet(e){m[0]=this._attr,e?v[3]|=128:v[3]&=-129,this._attr=m[0]}get _type(){return m[0]=this._attr,v[4]}set _type(e){m[0]=this._attr,v[4]=e,this._attr=m[0]}get _priority(){return m[0]=this._attr,v[5]}set _priority(e){m[0]=this._attr,v[5]=e,this._attr=m[0]}get _symbolType(){return m[0]=this._attr,v[6]}set _symbolType(e){m[0]=this._attr,v[6]=e,this._attr=m[0]}get _color(){return this._colorSet?(m[0]=this._rgba,c.setRGB(v[0]/255,v[1]/255,v[2]/255),c):null}set _color(e){this._colorSet=!!e,m[0]=this._rgba,v[0]=e?255*e.r:0,v[1]=e?255*e.g:0,v[2]=e?255*e.b:0,this._rgba=m[0]}get _alpha(){return m[0]=this._rgba,v[3]/255}set _alpha(e){m[0]=this._rgba,v[3]=255*e,this._rgba=m[0]}get _inheritance(){return m[0]=this._inheritanceInternal,_[0]}set _inheritance(e){m[0]=this._inheritanceInternal,_[0]=e,this._inheritanceInternal=m[0]}get _inheritanceCustom(){return m[0]=this._inheritanceInternal,_[1]}set _inheritanceCustom(e){m[0]=this._inheritanceInternal,_[1]=e,this._inheritanceInternal=m[0]}get side(){return this._type===o.VOLUME?e.FrontSide:e.DoubleSide}set side(t){this._type=t===e.FrontSide?o.VOLUME:o._SKIN}}y.prototype.isGAS=!0;return y.IncrementalGraphicAttributeSet=class{constructor(e){e=e||{},this.NREInit=!1,this.colorRGB=e.colorRGB,this.colorIndex=e.colorIndex,this.colorA=e.colorA,this.lineWidth=e.lineWidth,this.lineType=e.lineType,this.symbolType=e.symbolType,this.inheritance=e.inheritance,this.inheritanceCustom=e.inheritanceCustom,this.lowlight=e.lowlight,this.highlight=e.highlight,this.noPick=e.noPick,this.type=e.type,this.basic=e.basic,this.priority=e.priority,this.show=e.show,this.showFree=e.showFree,this.transparent=e.transparent}usingNREInit(e){return this.NREInit=!!e,this}__getGAS(e){var t;return e&&e.isGAS?(t=e.clone()).setParameters(this):t=new y(this),t}__updateGAS(e){return e&&e.isGAS?(e.setParameters(this),e):this.__getGAS(e)}},y.DefaultGASs={volume:new y({NREInit:!0,type:o.VOLUME}),skin:new y({NREInit:!0,type:o.SKIN}),edge:new y({NREInit:!0,type:o.EDGE}),defaultGAS:new y({NREInit:!0}),transition:new y({inheritanceCustom:a.TRANSITION})},e.GraphicAttributeSet=y,y})),define("DS/Visualization/Filters/GASInheritFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter","DS/Visualization/GraphicAttributeSet"],(function(e,t,i){"use strict";var r=i.DefaultGASs.defaultGAS;return class extends t{constructor(){super(),this._inheritance=e.GASEnum.NO_INHERIT,this._GAS=r,this._asmGAS=r}usingColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.COLOR_INHERITANCE_ON:e.GASEnum.COLOR_INHERITANCE_OFF),this._GAS=t||r,this}usingASMColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.ASMCOLOR_INHERITANCE_ON:e.GASEnum.ASMCOLOR_INHERITANCE_OFF),this._asmGAS=t||r,this}getInheritance(){return this._inheritance}canBeUsed(){return this._inheritance!==e.GASEnum.NO_INHERIT}solveInherit(e,t,i){return null}}})),define("DS/Visualization/MaterialApplication",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";e.MaterialLayer32BitsUndefined=4294967295,e.MaterialLayer32BitsMax=e.MaterialLayer32BitsUndefined-1,e.MaterialLayerUndefined=BigInt(4294967295)+(BigInt(4294967295)<<32n),e.MaterialLayerMax=e.MaterialLayerUndefined-1n;const t=e.MaterialLayerMax;e.__DefaultUVTransform__=e.__DefaultUVTransform__||new e.Matrix3;var i=e.__DefaultUVTransform__,r=new e.Matrix4,n=function(e){e=e||{},this.mappingType=-1,this.mappingObjTransformation=r,this.mappingUVTransformation=i,this.mappingNormTransformation=i,this.mappingUVSlot=1,this.mappingTransformSemantic=1,this._set(e)};n.prototype._set=function(t){void 0!==t.mappingType&&(this.mappingType=t.mappingType),void 0!==t.mappingObjTransformation&&(this.mappingObjTransformation=t.mappingObjTransformation,(null===this.mappingObjTransformation||this.mappingObjTransformation.isIdentity())&&(this.mappingObjTransformation=r)),void 0!==t.mappingUVTransformation&&(this.mappingUVTransformation=t.mappingUVTransformation,(null===this.mappingUVTransformation||this.mappingUVTransformation.isIdentity())&&(this.mappingUVTransformation=i)),void 0!==t.mappingUVSlot&&(this.mappingUVSlot=t.mappingUVSlot),void 0!==t.mappingTransformSemantic&&(this.mappingTransformSemantic=t.mappingTransformSemantic),this.mappingObjTransformation&&(this.mappingObjTransformation!==r?this.mappingNormTransformation=(new e.Matrix3).getInverse(this.mappingObjTransformation).transpose():this.mappingNormTransformation=i)};var s=function(e){this.uvSlot=1,this.mode=1,this.linear=!0,this.texture=null,this.uvTransform=i,this._set(e)};s.prototype._set=function(e){void 0!==e.uvSlot&&(this.uvSlot=e.uvSlot),void 0!==e.mode&&(this.mode=e.mode),void 0!==e.linear&&(this.linear=e.linear),void 0!==e.texture&&(this.texture=e.texture),void 0!==e.uvTransform&&(this.uvTransform=e.uvTransform),(null===this.uvTransform||this.uvTransform.isIdentity())&&(this.uvTransform=i)};const a=0,o=1,l=2;let h=0;var c=function(e){this.id=h++,this.isMatApp=!0,this._checkForceFlag=!1,this._material=null,this._materialGeomFace=null,this._materialLine=null,this._materialPoint=null,this._lightMap=null,this._mappingOperator=null,this._programID=0,this._inheritance=o,this._layer=t,this._depth=-1,this._enableDepth=!1,this._usedBy=new Set,this.setParameters(e)};c.prototype._dump=function(){return{layer:Number(BigInt.asUintN(32,this._layer)),layerHigh:Number(BigInt.asUintN(32,this._layer>>32n)),inheritance:this._inheritance,material:this._material?this._material._dump():null,materialGeomFace:this._materialGeomFace?this._materialGeomFace._dump():null,materialLine:this._materialLine?this._materialLine._dump():null,materialPoint:this._materialPoint?this._materialPoint._dump():null,lightMap:!!this._lightMap&&!!this._lightMap.texture,defaultMapping:!this._mappingOperator||this._mappingOperator.mappingType<=0}},c.prototype.copy=function(e){this._checkForceFlag=e._checkForceFlag,this._material=e._material,this._materialGeomFace=e._materialGeomFace,this._materialLine=e._materialLine,this._materialPoint=e._materialPoint,this._lightMap=e._lightMap,this._mappingOperator=e._mappingOperator,this._programID=e._programID,this._inheritance=e._inheritance,this._layer=e._layer,this._depth=e._depth,this._enableDepth=e._enableDepth},c.prototype.clone=function(){var e=new c({faceMaterial:this._material,geometricalFaceMaterial:this._materialGeomFace,lineMaterial:this._materialLine,pointMaterial:this._materialPoint,inheritance:this._inheritance,lightMap:this._lightMap,layer:this._layer,mappingOperator:this._mappingOperator});return e._checkForceFlag=this._checkForceFlag,e._depth=this._depth,e._enableDepth=this._enableDepth,e},c.prototype.setParameters=function(t){t.faceMaterial&&(this._material=t.faceMaterial),t.geometricalFaceMaterial&&(this._materialGeomFace=t.geometricalFaceMaterial),t.lineMaterial&&(this._materialLine=t.lineMaterial),t.pointMaterial&&(this._materialPoint=t.pointMaterial),void 0!==t.inheritance&&(this._inheritance=t.inheritance),void 0!==t.layer&&("number"!=typeof t.layer&&"bigint"!=typeof t.layer&&(console.error("Expected unsigned integer as layer in Material Application, got "+t.layer),console.error("Defaulting to 0"),t.layer=0),"number"!=typeof t.layer||Number.isInteger(t.layer)||(console.error("Expected unsigned integer as layer in Material Application, got "+t.layer),console.error("Defaulting to 0"),t.layer=0),this._layer=BigInt(t.layer),this._layer<0n&&(console.error("Expected unsigned integer as layer in Material Application, got "+this._layer),console.error("Defaulting to 0"),this._layer=0n)),t.lightMap&&(this._lightMap=new s(t.lightMap)),t.mappingOperator&&(this._mappingOperator=new n(t.mappingOperator)),void 0!==t.enableDepth&&(this._enableDepth=t.enableDepth),this._lightMap&&this._lightMap.texture&&(this._programID|=e.ProgramIDs.LIGHT_MAP),this._mappingOperator&&(this._programID|=e.ProgramIDs.MAPPING_OPERATOR),this._usedBy.forEach((e=>{e._updateMaterialApplication(!1)}))},c.prototype._getParametersFromMaterial=function(t){const i=this._mappingOperator||this._lightMap||this._layer>0||this._inheritance!==o,r={lineMaterial:null,pointMaterial:null,geometricalFaceMaterial:null,faceMaterial:null,layer:0};return t.line||t.point?(t.line&&(r.lineMaterial=t.line),t.point&&(r.pointMaterial=t.point),"forceGeomTypeFACE"===t.force?r.geometricalFaceMaterial=t:r.faceMaterial=t):"forceGeomTypeFACE"===t.force?r.geometricalFaceMaterial=t:t instanceof e.LineBasicMaterial?r.lineMaterial=t:t instanceof e.ParticleBasicMaterial?r.pointMaterial=t:r.faceMaterial=t,r.faceMaterial!==this._material||r.pointMaterial!==this._materialPoint||r.lineMaterial!==this._materialLine||r.geometricalFaceMaterial!==this._materialGeomFace||i?r:null},c.prototype.updateMappingOperator=function(e){if(null!==this._mappingOperator){e=e||{};var t={};Object.assign(t,this._mappingOperator),Object.assign(t,e),this._mappingOperator._set(t)}},c.prototype._getMaterialFromGLType=function(t,i){var r=null;if(4===t?r=i===e.GeomTypeEnum.FACE&&this._materialGeomFace?this._materialGeomFace:this._material:1===t?r=this._materialLine:0===t&&(r=this._materialPoint),this._checkForceFlag){if(this._material||this._materialGeomFace)return this._material&&this._material.force||this._materialGeomFace&&this._materialGeomFace.force?r:null;if(r&&!r.force)return null}return r},c._isPrioritary=function(e,i,r,n){if(e===a)return!1;if(r<n)return!0;if(r===n){if(r<t)return!0;if(e===l)return!0;if(e===o&&i===a)return!0}return!1},c.prototype.isPrioritary=function(e,t){if(!e)return!0;var i=this.getLayer(t),r=e.getLayer(t);return c._isPrioritary(this._inheritance,e._inheritance,i,r)},c.prototype.getLayer=function(e){var i=this._enableDepth?this._depth<0?e:this._depth:0,r=32768n*BigInt(i)+this._layer;return r>t?t:r},c.prototype.solveInheritance=function(e,t){return this.isPrioritary(e,t)?this:e},c.prototype.getMaterial=function(e,t,i){throw new Error("coucou")},c.prototype.recompileShaders=function(e){for(var t=[this._material,this._materialGeomFace,this._materialLine,this._materialPoint],i=0;i<t.length;i++){var r=t[i];if(r&&(e&&e.onlyDeferred||(e&&e.callback&&e.callback(r),r.needsUpdate=!0),r._deferredMaterialsInit)){var n=r._deferredMaterials,s=e?e.deferredChannels:null;if(s&&s.length>0)for(var a=0;a<s.length;a++){(o=n[s[a]])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}else for(a=0;a<n.length;a++){var o;(o=n[a])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}}}};return c.prototype._loadMappingOperatorUniforms=function(e,t,i){var r=e.program.uniformLocations;r.uvSlot&&i.uniform1i(r.uvSlot,this._mappingOperator.mappingUVSlot),e._loadMappingInfo(this._mappingOperator,t,i,r)},c.prototype._fillMappingOperatorUBO=function(e,t,i){const r=e.layout;r.uvSlot&&e.setI(r.uvSlot,this._mappingOperator.mappingUVSlot),t._fillMappingUBO(e,this._mappingOperator,i)},e.MaterialApplication=c,c})),define("DS/Visualization/RenderMode",["UWA/Class","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";var i=e.extend({init:function(e){this._mask=0,this._maskWithDefault=0,this._replaceMask=-1,this._setFromMasks(0,0,t.GeomTypeEnum.FACE),this._useRenderLineMask=!0,this._useRenderFaceMask=!0,this._useRenderPointMask=!0,this._repViewNothing=!1,this._halfVisibleSmoothEdges=-1,this._hiddenEdges=-1,this._outlineWidth=1,e&&void 0!==e.renderLineMode&&this._setRenderLineMode(e.renderLineMode)},clone:function(){var e=new i;return e._mask=this._mask,e._maskWithDefault=this._maskWithDefault,e._replaceMask=this._replaceMask,e._useRenderLineMask=this._useRenderLineMask,e._useRenderPointMask=this._useRenderPointMask,e._useRenderFaceMask=this._useRenderFaceMask,e._outlineWidth=this._outlineWidth,e._halfVisibleSmoothEdges=this._halfVisibleSmoothEdges,e._hiddenEdges=this._hiddenEdges,e._repViewNothing=this._repViewNothing,e},combine:function(e){e&&(this._mask=e._mask)},setOutlineWidth:function(e){this._outlineWidth=e},setHalfVisibleSmoothEdges:function(e){this._halfVisibleSmoothEdges=e},setHiddenEdges:function(e){this._hiddenEdges=e},setRenderMode:function(e,i){if("@InternalEdge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i),this.setRenderMode("_HighCurvatureEdge",i);else if("@Edge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i),this.setRenderMode("_HighCurvatureEdge",i),this.setRenderMode("BoundaryEdge",i),this.setRenderMode("WireEdge",i),this.setRenderMode("Edge",i);else if("@Point"===e)this.setRenderMode("BoundaryPoint",i),this.setRenderMode("SharpPoint",i),this.setRenderMode("SmoothPoint",i),this.setRenderMode("SurfacicPoint",i),this.setRenderMode("FreePoint",i);else{var r={Edge:"EDGE",InternalSharpEdge:"SHARP_EDGE",InternalSmoothEdge:"SMOOTH_EDGE",BoundaryEdge:"BOUNDARY_EDGE",_HighCurvatureEdge:"_HIGH_CURVATURE_EDGE",WireEdge:"WIRE_EDGE",Outline:"_OUTLINE",SectionLine:"_SECTION_LINE",Face:"FACE",BoundaryPoint:"BOUNDARY_POINT",SharpPoint:"SHARP_POINT",SurfacicPoint:"SURFACIC_POINT",SmoothPoint:"SMOOTH_POINT",FreePoint:"FREE_POINT",AxisSystem:"AXIS_SYSTEM",InfiniteFace:"INFINITE_FACE"}[e];if(r){var n,s,a=t.GeomTypeEnum[r];n=this._mask||0,s=i?n|a:n&~a,this._setMask(s)}else console.warn(e+"unknown category")}},setRepViewNothing:function(e){this._repViewNothing=e},_setRenderLineMode:function(e){e=e||0;var t,r=this._mask,n=i.linesMask;t=e&n|(r&=~n),this._setMask(t)},_setFromMasks:function(e,t,i){this._setMask(e&r|t&n|i&a)},getMask:function(){return this._mask},getMasks:function(){return[this._mask&a,this._mask&n,this._mask&r]},areFacesVisible:function(){return!!(this._mask&t.GeomTypeEnum.FACE)},_displayNothing:function(){this._setMask(0)},_setMask:function(e){this._mask=e,this._maskWithDefault=e|i.defaultMask},setReplaceMask:function(e){this._replaceMask=e},_hasReplaceMask:function(){return-1!==this._replaceMask},_setReplace:function(e,t){var i,r,n;i=t.getMask(),r=e.getMask(),n=t._replaceMask,this._setMask(r&~n|i&n),this._replaceMask=e._replaceMask|n}});i.createChild=function(e,t){var i=null;return(e||t)&&(e?(i=e.clone()).combine(t):i=t),i},i.defaultMask=t.GeomTypeEnum.UNKNOWN|t.GeomTypeEnum.UNKNOWN_1D|t.GeomTypeEnum.UNKNOWN_2D;var r=t.GeomTypeEnum.BOUNDARY_POINT|t.GeomTypeEnum.SHARP_POINT|t.GeomTypeEnum.SMOOTH_POINT|t.GeomTypeEnum.SURFACIC_POINT|t.GeomTypeEnum.FREE_POINT|t.GeomTypeEnum.HIDDEN_SEAM_POINT;i.pointsMask=r;var n=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE|t.GeomTypeEnum._OUTLINE|t.GeomTypeEnum._SECTION_LINE;i.linesMask=n;var s=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE;i.linesPickingMask=s;var a=t.GeomTypeEnum.INFINITE_FACE|t.GeomTypeEnum.FACE|t.GeomTypeEnum.AXIS_SYSTEM;return i.facesMask=a,i.unknownMask=t.UnknownMask,t.RenderMode=i,i})),define("DS/Visualization/KDTree",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],(function(e,t,i){"use strict";var r=4294967295,n=new t.Box3,s=function(e,t,i){return e.setValues(t[i],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5]),e},a=function(e,i){this.renderable=null,this.nodesUint8=null,this.nodesUint32=null,this.nodesFloat32=null,this.nbAllocatedNodes=0,this.nextFreeNode=0,this.aabb=new t.Box3,this.eltsAsBinary=!0,this.elts=this.eltsAsBinary?null:[],this.eltIndices=null,this.nextFreeIndex=0,this.nbAllocatedIndices=0,this.maxElts=void 0!==e?e:100,this.maxDepth=void 0!==i?i:8,this.intersectionCost=80,this.traversalCost=1,this.emptyBonus=.5,this.debugInfos={initTime:0,totalTime:0,computeCostTime:0,sortTime:0,nbLeafNodesBiggerThanMaxElts:0}};return a.prototype={constructor:a,resetDebugInfos:function(){this.debugInfos.initTime=0,this.debugInfos.totalTime=0,this.debugInfos.computeCostTime=0,this.debugInfos.sortTime=0,this.debugInfos.nbLeafNodesBiggerThanMaxElts=0},printDebugInfos:function(){console.log("init time: "+this.debugInfos.initTime+" ms"),console.log("total time: "+this.debugInfos.totalTime+" ms"),console.log("cost time: "+this.debugInfos.computeCostTime+" ms"),console.log("sort time: "+this.debugInfos.sortTime+" ms"),console.log("number of allocated nodes: "+this.nbAllocatedNodes),console.log("number of used nodes: "+this.nextFreeNode),console.log("number of leaf nodes above maxElts: "+this.debugInfos.nbLeafNodesBiggerThanMaxElts),console.log("number of stored indices: "+this.nbAllocatedIndices);var e=this.eltsAsBinary?this.elts?4*this.elts.length:0:8*this.elts.length,t=8*this.nbAllocatedNodes+e+4*this.nbAllocatedIndices;console.log("estimated kd-tree allocation = "+t/1048576+" MB")},reallocateTreeNodes:function(e){var t=new ArrayBuffer(8*e),i=new Uint8Array(t),r=new Uint32Array(t),n=new Float32Array(t);if(this.nbAllocatedNodes>0)for(var s=0;s<8*this.nbAllocatedNodes;s++)i[s]=this.nodesUint8[s];this.nbAllocatedNodes=e,this.nodesUint8=i,this.nodesUint32=r,this.nodesFloat32=n},reallocateIndices:function(e){var t=new Uint32Array(e);if(this.nbAllocatedIndices>0)for(var i=0;i<this.nbAllocatedIndices;i++)t[i]=this.eltIndices[i];this.nbAllocatedIndices=e,this.eltIndices=t},optimizeMemory:function(){this.nbAllocatedNodes>this.nextFreeNode&&this.reallocateTreeNodes(this.nextFreeNode),this.nbAllocatedIndices>this.nextFreeIndex&&this.reallocateIndices(this.nextFreeIndex)},buildFast:function(e,t){var i=this.eltsAsBinary?e.length/4:e.length;this.elts=e,this.resetDebugInfos();var r=performance.now();if(this.eltsAsBinary)for(var a=0;a<i;a++)s(n,t,6*a),this.aabb.union(n);else for(a=0;a<i;a++)this.aabb.union(t[a]);var o=new Uint32Array(i),l=new Uint32Array((this.maxDepth+1)*i),h=new Uint32Array(i);for(a=0;a<i;a++)h[a]=a;this.debugInfos.initTime=performance.now()-r,this._buildFast(0,this.aabb,t,{ptr:h,offset:0},i,this.maxDepth,{ptr:o,offset:0},{ptr:l,offset:0}),this.optimizeMemory(),this.debugInfos.totalTime=performance.now()-r},_buildFast:function(e,t,i,r,a,o,l,h){if(this.nextFreeNode===this.nbAllocatedNodes&&this.reallocateTreeNodes(Math.max(512,2*this.nbAllocatedNodes)),this.nextFreeNode++,a<=this.maxElts||0===o)this.initLeafNode(e,r,a);else{for(var c=t.size().getMaxAxis(),d=.5*(t.min.getComponent(c)+t.max.getComponent(c)),u=0,p=0,f=0;f<a;f++){var g,m=r.ptr[r.offset+f];(g=this.eltsAsBinary?s(n,i,6*m):i[m]).min.getComponent(c)<=d&&(l.ptr[l.offset+u++]=m),g.max.getComponent(c)>=d&&(h.ptr[h.offset+p++]=m)}if((u+p-a)/a>.5)this.initLeafNode(e,r,a);else{var v=t.clone(),_=t.clone();v.max.setComponent(c,d),_.min.setComponent(c,d),this._buildFast(e+1,v,i,l,u,o-1,l,{ptr:h.ptr,offset:h.offset+a});var y=this.nextFreeNode;this.initInteriorNode(e,c,y,d),this._buildFast(y,_,i,h,p,o-1,l,{ptr:h.ptr,offset:h.offset+a})}}},initInteriorNode:function(e,t,i,r){var n=i<<2;n|=t,this.nodesUint32[2*e]=n,this.nodesFloat32[2*e+1]=r},initLeafNode:function(e,t,i){var r=i<<2;r|=3,this.nodesUint32[2*e]=r,i>this.maxElts&&this.debugInfos.nbLeafNodesBiggerThanMaxElts++;var n=0;if(0===i)n=0;else if(1===i)n=t.ptr[t.offset];else{n=this.nextFreeIndex,this.nextFreeIndex+i>=this.nbAllocatedIndices&&this.reallocateIndices(Math.max(512,2*this.nbAllocatedIndices));for(var s=0;s<i;s++)this.eltIndices[this.nextFreeIndex+s]=t.ptr[t.offset+s];this.nextFreeIndex+=i}this.nodesUint32[2*e+1]=n},isLeafNode:function(e){return 3==(3&this.nodesUint32[2*e])},getSplitAxis:function(e){return 3&this.nodesUint32[2*e]},getSplitPosition:function(e){return this.nodesFloat32[2*e+1]},getNbElts:function(e){return this.nodesUint32[2*e]>>2},getNbTotalElts:function(){return this.eltsAsBinary?this.elts?this.elts.length/4:0:this.elts.length},getNbNodes:function(){return this.nbAllocatedNodes},getEltIndices:function(e){return this.nodesUint32[2*e+1]},getAboveChild:function(e){return this.nodesUint32[2*e]>>2},setBoundEdge:function(e,t,i,r,n){var s=r<<1;s|=n,e.float32View[2*t]=i,e.uint32View[2*t+1]=s},getBoundEdgeValue:function(e,t){return e.float32View[2*t]},getBoundEdgeEltNum:function(e,t){return e.uint32View[2*t+1]>>1},getBoundEdgeType:function(e,t){return 1&e.uint32View[2*t+1]},intersect:function(e,i,n,s){var a=new t.Vector2;if(!e.intersectBox(this.aabb,void 0,a))return!1;for(var o=new t.Vector3(1/e.direction.x,1/e.direction.y,1/e.direction.z),l=[],h=0,c=0,d=this.aabb.clone();c>=0&&!(s&&s<a.x);)if(n&&n({aabb:d,nodeId:c}),this.isLeafNode(c)){var u=this.getNbElts(c);if(1===u){var p,f=this.getEltIndices(c);if(this.eltsAsBinary){var g=this.renderable.geometry[this.elts[4*f]],m=this.elts[4*f+3];p={dg:g.drawingGroups[this.elts[4*f+1]],primitive:this.elts[4*f+2],offset:m===r?-1:m}}else p=this.elts[f];i&&i(p,c,f)}else for(var v=0;v<u;v++){f=this.eltIndices[this.getEltIndices(c)+v];if(this.eltsAsBinary){g=this.renderable.geometry[this.elts[4*f]],m=this.elts[4*f+3];p={dg:g.drawingGroups[this.elts[4*f+1]],primitive:this.elts[4*f+2],offset:m===r?-1:m}}else p=this.elts[f];i&&i(p,c,f)}if(!(h>0))break;c=l[--h].nodeId,a.copy(l[h].tMinMax),d=l[h].aabb}else{var _,y,S,b,x=this.getSplitAxis(c),w=this.getSplitPosition(c),P=e.origin.getComponent(x),C=(w-P)*o.getComponent(x),M=d.clone(),E=d.clone();M.max.setComponent(x,w),E.min.setComponent(x,w),P<w||P===w&&e.direction.getComponent(x)<=0?(_=c+1,y=this.getAboveChild(c),S=M,b=E):(_=this.getAboveChild(c),y=c+1,S=E,b=M),C>a.y||C<=0?(c=_,d=S):C<a.x?(c=y,d=b):(l[h]={nodeId:y,tMinMax:new t.Vector2(C,a.y),aabb:b},h++,c=_,d=S,a.y=C)}return!1},buildFromMesh:function(e,n,s,a,o,l){this.renderable=e;var h=!s||s.isIdentity(),c=null,d=0,u=new i.SGPrimitiveHelper;if(e.geometry.length>=0?(c=e.geometry[0],d=e.geometry.length):2===e.geometry._type&&(c=e.geometry,d=1),!c||c.vertexIndexArray){for(var p=0,f=1024,g=a||(this.eltsAsBinary?new Uint32Array(4096):[]),m=o||(this.eltsAsBinary?new Float32Array(6144):[]),v=new t.Vector3,_=new t.Vector3,y=new t.Vector3,S=new t.Box3,b=new t.Box3,x=0;x<d;x++){for(var w=c.drawingGroups,P=w.length,C=c.vertexIndexArray,M=0;M<P;M++)for(var E=w[M],T=E.getPrimitivesCount(),A=0;A<T;A++){u.set(E,A);var D=u.getStart(),I=D+u.getCount(),R=this.eltsAsBinary?S:new t.Box3;switch(this.eltsAsBinary&&R.makeEmpty(),E.glType){case 4:case 5:for(var O=D;O<I;O+=3){var L,B,F;if(E.nonIndexed?(L=O,B=O+1,F=O+2):(L=C[O],B=C[O+1],F=C[O+2]),c.getVertexPosition(L,v),c.getVertexPosition(B,_),c.getVertexPosition(F,y),h||(v.applyMatrix4(s),_.applyMatrix4(s),y.applyMatrix4(s)),n)R.expandByPoint(v),R.expandByPoint(_),R.expandByPoint(y);else{var V=this.eltsAsBinary?b:new t.Box3;if(V.setFromPoints([v,_,y]),this.eltsAsBinary){if(p>=f){var G=new Uint32Array(2*f*4),N=new Float32Array(2*f*6);G.set(g),N.set(m),f*=2,g=G,m=N}g[4*p]=x,g[4*p+1]=M,g[4*p+2]=A,g[4*p+3]=O,m[6*p]=V.min.x,m[6*p+1]=V.min.y,m[6*p+2]=V.min.z,m[6*p+3]=V.max.x,m[6*p+4]=V.max.y,m[6*p+5]=V.max.z,p++}else g.push({dg:E,primitive:A,offset:O}),m.push(V)}}}if(n)if(this.eltsAsBinary){if(p>=f){G=new Uint32Array(2*f*4),N=new Float32Array(2*f*6);G.set(g),N.set(m),f*=2,g=G,m=N}g[4*p]=x,g[4*p+1]=M,g[4*p+2]=A,g[4*p+3]=r,m[6*p]=R.min.x,m[6*p+1]=R.min.y,m[6*p+2]=R.min.z,m[6*p+3]=R.max.x,m[6*p+4]=R.max.y,m[6*p+5]=R.max.z,p++}else g.push({dg:E,primitive:A,offset:-1}),m.push(R)}c=e.geometry[x+1]}if(!l){if(this.eltsAsBinary&&p<f){G=new Uint32Array(4*p),N=new Float32Array(6*p);for(var U=0;U<6*p;U++)N[U]=m[U];for(U=0;U<4*p;U++)G[U]=g[U];g=G,m=N}this.buildFast(g,m)}return this}console.warn("kdtree build impossible, make sure noMeshInRAM is inactive")}},t.KDTree=a,a})),define("DS/Visualization/RenderStyle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode"],(function(e,t,i){"use strict";var r=e.extend({init:function(e){if(e=e||{},this._renderMode=new i,this._renderMode._setMask(t.ShowAllRenderLineMode|t.ShowAllFaces),e.hasOwnProperty("faceMode")){this._materialMode=!1;var n=e.faceMode;"MATERIAL"!==n&&"GAS"!==n||(this._materialMode="MATERIAL"===n,n="COLOR"),this._faceMode=n?r.FaceModes[n]:r.FaceModes.unset}else this._materialMode=!0,this._faceMode=r.FaceModes.COLOR;this._materialMode=e.hasOwnProperty("materialMode")?!!e.materialMode:this._materialMode,this._combineRenderModeValue=e.combineRenderMode?r.CombineRenderMode[e.combineRenderMode]:r.CombineRenderMode.REPLACE,this._locked=!1},setOutlineWidth:function(e){this._renderMode.setOutlineWidth(e)},setHalfVisibleSmoothEdges:function(e){this._renderMode.setHalfVisibleSmoothEdges(e)},setHiddenEdges:function(e){this._renderMode.setHiddenEdges(e)},setRenderMode:function(e,t){return!this._locked&&(this._renderMode.setRenderMode(e,t),!0)},setFaceMode:function(e){if(this._locked)return!1;var t=e;return"MATERIAL"!==t&&"GAS"!==t||(this._materialMode="MATERIAL"===e,t="COLOR"),this._faceMode=r.FaceModes[t],!0},setMaterialMode:function(e){return!this._locked&&(this._materialMode=!!e,!0)},clone:function(){var e=new r;return e._renderMode=this._renderMode.clone(),e._faceMode=this._faceMode,e._materialMode=this._materialMode,e._combineRenderModeValue=this._combineRenderModeValue,e},dumpToJSON:function(){return{version:1,renderModeMask:this._renderMode.getMask(),faceMode:this._faceMode,materialMode:this._materialMode,combineMode:this._combineRenderModeValue,outlineWidth:this._renderMode._outlineWidth}},setRepViewNothing:function(e){this._renderMode.setRepViewNothing(e)},_lock:function(){this._locked=!0},_combineFaceMode:function(e){return 0!==this._faceMode?{face:this._faceMode,material:this._faceMode===r.FaceModes.COLOR&&this._materialMode}:e},_combineRenderMode:function(e,t){var r,n;switch(this._combineRenderModeValue){case 0:return t||e;case 1:return this._renderMode&&e&&this._renderMode._hasReplaceMask()?((r=new i)._setReplace(e,this._renderMode),this._renderMode._repViewNothing&&(r._repViewNothing=!0),r):this._renderMode;case 2:return e?(n=(r=this._renderMode.clone()).getMask()|e.getMask(),r._setMask(n),r):this._renderMode;case 3:return e?(n=(r=this._renderMode.clone()).getMask()&e.getMask(),r._setMask(n),r):this._renderMode}return null},_displayNothingRenderMode:function(){this._renderMode._displayNothing()},setReplaceMask:function(e){this._renderMode.setReplaceMask(e)}});return r.FaceModes={unset:0,COLOR:1,ZONLY:2,BACKGROUND:3},r.CombineRenderMode={IGNORE:0,REPLACE:1,OR:2,AND:3},r.compareDumpJSON=function(e,t){return e.renderModeMask===t.renderModeMask&&e.faceMode===t.faceMode&&e.materialMode===t.materialMode&&e.combineMode===t.combineMode&&e.outlineWidth===t.outlineWidth},t.RenderStyle=r,r})),define("DS/Visualization/TrackballControls",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/VisuEvents/MouseEvent","DS/WebRecordEnabler/Adapter","DS/Visualization/TaskManager"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u){"use strict";const p=t.IsFirefox;var f=0,g=function(e,i){this.currentDocument=e.viewer.contextDocument,void 0===o._isInit?o.init():o.addDocument(this.currentDocument),this.manipulatedViewList=[i],t.EventTarget.call(this),this.viewpoint=e,this.viewer=e.viewer,this.domElement=void 0!==i?i:this.currentDocument,this.isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0,this.camera=e.camera,this.id=f++,window.DSWebRecord&&o._record_registerObject(this,"TrackballControls"),this.viewer.forceRenderTargetSize?(this.radius=.5*Math.max(this.viewer._getDivClientWidth(),this.viewer._getDivClientHeight()),this.radiusZoom=.25*(this.viewer._getDivClientWidth()+this.viewer._getDivClientHeight())):(this.radius=.5*Math.max(this.domElement.clientWidth,this.domElement.clientHeight),this.radiusZoom=.25*(this.domElement.clientWidth+this.domElement.clientHeight)),this.panSpeed=1,this.rotateSpeed=1,this.zoomSpeed=5,this.lockZ=!1,this.rollingForTouchAvailable=!1,this.lockRotation=!1,this.lockMouseRotation=!1,this.lockTouchRotation=!1,this.lockMouseRotationForSimpleMode=!1,this.lockMouseZoomForCtrlKeyWheelMode=!1,this.lockNativeBehaviorOnMouseMiddleTriggers=!0,this.lockRotationOverTrapSelection=!0,this.lockMouseWheel=!1,this.lockZoom=!1,this.lockPan=!1,this.lockMouse=!1,this.lockTouch=!1,this.lockKeyboard=!1,this.lockReframe=!1,this.lockReframeOnDblTap=!1,this.lockPreventDefaultForCtrlKeyWheel=!0,this.mouseInertia=!1,this.touchInertia=!0,this.rotateDirection=1,this.lastLockZState=null,this.lockZRotationSpeed=.002,this._invertHeadRotation=!1,this.target=e.target,this.position=e.position,this.orientation=new t.Quaternion,this.distanceToTarget=700,this._state=g.State.NONE,this._clickTimer=null,this._leftClicking=!1,this._middleClicking=!1,this._rightClicking=!1,this._leftButtonPressed=!1,this._middleButtonPressed=!1,this._rightButtonPressed=!1,this._ctrlKeyPressed=!1,this._shiftKeyPressed=!1,this._clickTolerancy=10,this._blockVptOnHold=!0,this._showSpinnerOnHold=!1,this._pickingCB=!0,this._avatarDistance=0,this._forcePan=!1,this._forceRotate=!1,this._forceZoom=!1,this._forcePanCmd=null,this._forceRotateCmd=null,this._forceZoomCmd=null,this._rotationAroundPoint=!1,this._showRotationPointOnMove=!1,this._rotationAroundPointTarget={isSet:!1,isShown:!1,dim2:null,dim3:null},this._pivotRotateSpeed=1,this._deg2Rad=.01745,this._touchPos=null,this._continuousZoom=!1,this._debugTarget=!1,this._forceCameraToTargetMinDist=!1,this._target3DNode=void 0,this._cameraToTargetMaxDistRatio=.015,this._cameraToTargetMaxDist=this.distanceToTarget*this._cameraToTargetMaxDistRatio,this._cameraToTargetMinDistRatio=.1,this._cameraToTargetMinDist=100,this._cameraToTargetSetDist=null,this._wheelToSlideZoomFactor=10,this._wheelToSlideInverted=-1,this._isZoomParamsComputed=!1,this._cameraSensor={zoomT0:null,zoomT1:null,delta:function(){return null!==this.zoomT0&&null!==this.zoomT1&&this.zoomT0!==this.zoomT1},value:function(){if(null!==this.zoomT0&&null!==this.zoomT1)return this.zoomT1-this.zoomT0}},this._2DMode=!1,this._lockUpDirection=null,this._lockUpMode=null,this.oldManipActive=!1,this._mode=g.Mode.COMBINED,this._zoomType=g.ZoomType.ZOOM_POS_CHANGE,this._FOVZoomMinAngle=.01;var r=this;this._panWithTrackPadSupport=function(e){let t=-1;if(e)if("string"==typeof e)switch(e.toLowerCase()){case"auto":t=0;break;case"forced":case"true":case"yes":t=1}else"number"==typeof e&&(0!=e&&1!=e||(t=e));return 0==t?console.log("Automatic trackpad support on."):1==t?console.log("Trackpad support is forced."):console.log("Trackpad is NOT supported."),t},this._trackPadData={isActive:!1,isOnOffAuto:-1,position:null,positionPrev:null,autoState:!1},this._isFromTrackPadAutoDetect=function(e){let t=!1;return this._trackPadData?(this.isMac?e.wheelDeltaY?e.wheelDeltaY===-3*e.deltaY&&(t=!0):0===e.deltaMode&&(t=!0):(e.wheelDeltaY&&120!==Math.abs(e.wheelDeltaY)&&(t=!0),e.wheelDeltaX&&120!==Math.abs(e.wheelDeltaX)&&(t=!0),t||(0===e.deltaMode&&(t=!0),e.ctrlKey&&(t=!0))),t):t},this._isFromTrackPad=function(e){return 0>this._trackPadData.isOnOffAuto?-1:0==this._trackPadData.isOnOffAuto?this._isFromTrackPadAutoDetect(e)?1:0:2},this._onWindowResize=function(e){r._resize(e)},this._onContextMenu=function(e){e.preventDefault()},this._onBlurCB=function(){r._ctrlKeyPressed=!1,r._shiftKeyPressed=!1},this._onDragEndCB=function(e){var t=o._getMouseButton(e.button);let i=new c(t,e);r._onLeftMouseUp({from:[i]})},this._dragX=0,this._dragY=0,this._onDragCB=function(e){if((e.screenX!=r._dragX||e.screenY!=r._dragY)&&(r._dragX=e.screenX,r._dragY=e.screenY,r._pickingCB&&r.viewer&&r.viewer.mouseMoveCB)){let t=new l(e),i=t.event.clientX,n=t.event.clientY;t._currentPosition.set(i,n),r.viewer.mouseMoveCB(t,r)}},this.basicEventID=0,this.editEventBeginID=0,this.editEventKOID=0,this.infiniteRender=!1,this._mouseDownPos=null,this._oldCursor="",this._modelEvent=new a,this.attachEvents(),this.setMode(g.Mode.COMBINED),this._createShortHoldSpinner(1,"#3da4e0"),this._createRotationPointElem(),this._customZoomTokens=[],this._customPanTokens=[],this._customRotateTokens=[],this.needsRotationFinalized=!1,this.deltaPosition=null,this.previousTime=0,this.deltaTime=0,this._isIE11=t.IsIE11,this._wheelMoving=!1,this._wheelTimer=null,this._flyWalkStateInfo={bActive:!1,forceStopRequests:0,oldControlState:g.State.NONE}};return Object.defineProperty(g.prototype,"_finalizeRotateLockZ",{set:function(e){this._finalizeRotateLockWorldUpVector=e}}),g.Mode={CATIA:0,SIMPLE:1,COMBINED:2,LOOKAROUND:3},g.State={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,FORCE_ROTATE:3,FORCE_ZOOM:4,FORCE_PAN:5,HOLD:6,ZOOM_PAN_ROTATE:7,STOP:8},g.changeEvent={type:"change"},g.prototype.setActive=function(e){e instanceof Object?(void 0!==e.viewpoint&&this._changeState(e.viewpoint?g.State.NONE:g.State.STOP),void 0!==e.picking&&(this._pickingCB=e.picking)):this._changeState(e?g.State.NONE:g.State.STOP)},g.prototype.setMouseActive=function(e){this.lockMouse=!e},g.prototype.getMouseActive=function(){return!this.lockMouse},g.prototype.setTouchActive=function(e){this.lockTouch=!e},g.prototype.getTouchActive=function(){return!this.lockTouch},g.prototype.setKeyboardActive=function(e){this.lockKeyboard=!e},g.prototype.getKeyboardActive=function(){return!this.lockKeyboard},g.prototype.setRotationActive=function(e){this.lockRotation=!e},g.prototype.setMouseRotationActive=function(e){this.lockMouseRotation=!e},g.prototype.setTouchRotationActive=function(e){this.lockTouchRotation=!e},g.prototype.setMouseRotationForSimpleModeActive=function(e){this.lockMouseRotationForSimpleMode=!e},g.prototype.setMouseZoomForCtrlKeyWheelActive=function(e){this.lockMouseZoomForCtrlKeyWheelMode=!e},g.prototype.setNativeBehaviorOnMouseMiddleTriggers=function(e){this.lockNativeBehaviorOnMouseMiddleTriggers=!e},g.prototype.isNativeBehaviorOnMouseMiddleTriggers=function(){return!this.lockNativeBehaviorOnMouseMiddleTriggers},g.prototype.setRotationOverTrapSelection=function(e){"boolean"==typeof e&&this.viewpoint&&this.viewpoint.viewer&&this.viewpoint.viewer.trapSelectionManipulator&&(this.lockRotationOverTrapSelection=!e,!1===this.lockRotationOverTrapSelection?this.viewpoint.viewer.trapSelectionManipulator.disable():this.viewpoint.viewer.trapSelectionManipulator.enable(),this._forceRotate=e)},g.prototype.isRotationOverTrapSelection=function(){return!this.lockRotationOverTrapSelection},g.prototype.setMouseWheelActive=function(e){this.lockMouseWheel=!e},g.prototype.getMouseWheelActive=function(){return!this.lockMouseWheel},g.prototype.getMouseRotationActive=function(){return this.lockMouseRotation},g.prototype.getTouchRotationActive=function(){return this.lockTouchRotation},g.prototype.setZoomActive=function(e){this.lockZoom=!e},g.prototype.setPanActive=function(e){this.lockPan=!e},g.prototype.setReframeActive=function(e){this.lockReframe=!e},g.prototype.setReframeOnDoubleTap=function(e){this.lockReframeOnDblTap=!e},g.prototype.setRotationRolling=function(e){this.lockZ=!e},g.prototype.setRotationAroundPoint=function(e){this._2DMode||(this._rotationAroundPoint=e)},g.prototype.getRotationAroundPoint=function(){return this._rotationAroundPoint},g.prototype.setContinuousZoom=function(e){this._2DMode||(this._continuousZoom=e),this._forceCameraToTargetMinDist=!this._continuousZoom},g.prototype.getContinuousZoom=function(){return this._continuousZoom},g.prototype.setforceCameraToTargetMinDist=function(e){this._2DMode||(this._forceCameraToTargetMinDist=e)},g.prototype.getforceCameraToTargetMinDist=function(){return this._forceCameraToTargetMinDist},g.prototype.setTarget3DNode=function(e){this._target3DNode=e,this._updateTarget3DNode()},g.prototype.getTarget3DNode=function(){return this._target3DNode},g.prototype.setDebugTarget=function(e){this._debugTarget=e},g.prototype.getDebugTarget=function(){return this._debugTarget},g.prototype.setLockUpDirection=function(e,t){this._lockUpDirection=e,this._lockUpMode=t},g.prototype.setNativeGravity=function(e,t,i){0!=e?(this.setRotationRolling(!1),this.setLockUpDirection(t,e)):(this.setRotationRolling(!0),this.setLockUpDirection(null,null))},g.prototype.setRollingForTouchAvailable=function(e){this.rollingForTouchAvailable=e},g.prototype.setPreventDefaultForCtrlKeyWheelActive=function(e){this.lockPreventDefaultForCtrlKeyWheel=!e},g.prototype.setRotationInertia=function(e){void 0!==e.mouse&&(this.mouseInertia=e.mouse),void 0!==e.touch&&(this.touchInertia=e.touch)},g.prototype.setRotationSpeed=function(e){this.rotateSpeed=e,this.lockZRotationSpeed=.0015*e},g.ZoomType={ZOOM_POS_CHANGE:0,ZOOM_FOV_CHANGE:1},g.prototype.setZoomType=function(e){this._zoomType=e},g.prototype.setFOVZoomMinAngle=function(e){this._FOVZoomMinAngle=e},g.prototype.onPan=function(e){if(e){var t=this._modelEvent.subscribe({event:"Pan"},e);return this._customPanTokens.push(t),t}for(var i=0;i<this._customPanTokens.length;i++)this._modelEvent.unsubscribe(this._customPanTokens[i]);this._customPanTokens=[]},g.prototype.onRotate=function(e){if(e){var t=this._modelEvent.subscribe({event:"Rotate"},e);return this._customRotateTokens.push(t),t}for(var i=0;i<this._customRotateTokens.length;i++)this._modelEvent.unsubscribe(this._customRotateTokens[i]);this._customRotateTokens=[]},g.prototype.onZoom=function(e){if(e){var t=this._modelEvent.subscribe({event:"Zoom"},e);return this._customZoomTokens.push(t),t}for(var i=0;i<this._customZoomTokens.length;i++)this._modelEvent.unsubscribe(this._customZoomTokens[i]);this._customZoomTokens=[]},g.prototype.blockViewpointOnHold=function(e){this._blockVptOnHold=e},g.prototype.setSpinnerOnHold=function(e){this._showSpinnerOnHold=e},g.prototype.isCurrentViewpoint=function(){return this.viewpoint.viewer._viewpointManager.getManipulatedViewpoint()==this.viewpoint},g.prototype.isLeftButtonPressed=function(){return this._leftButtonPressed},g.prototype.isMiddleButtonPressed=function(){return this._middleButtonPressed},g.prototype.isRightButtonPressed=function(){return this._rightButtonPressed},g.prototype.isCtrlKeyPressed=function(){return this._ctrlKeyPressed},g.prototype.isShiftKeyPressed=function(){return this._shiftKeyPressed},g.prototype.isLeftClick=function(){return this._leftClicking},g.prototype.isMiddleClick=function(){return this._middleClicking},g.prototype.isRightClick=function(){return this._rightClicking},g.prototype.startLeftClick=function(){var e=this;this._leftClicking=!0,this._clickTimer&&clearTimeout(this._clickTimer),d.isReplaying()||(this._clickTimer=setTimeout((function(){o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(e.viewer,"TrackballControls","TrackballControlCancelLeftClick"),e.cancelLeftClick()}),300))},g.prototype.cancelLeftClick=function(){this._leftClicking=!1},g.prototype.cancelMiddleClick=function(){this._middleClicking=!1},g.prototype.cancelRightClick=function(){this._rightClicking=!1},g.prototype.resetLeftClick=function(){this._leftClicking=!1,this._clickTimer&&clearTimeout(this._clickTimer),this._clickTimer=null},g.prototype.getManipulationState=function(){return this._state},g.prototype.isMoving=function(){return this._state!==g.State.NONE&&this._state!==g.State.STOP&&this._state!==g.State.HOLD&&!(this._targetAnim&&!this._targetAnim.isRunning())},g.prototype.updateEditGesture=function(){var e=o._getGesture(this.currentDocument,"onEdit");e&&e.setTimerMouse(this._mode>0?o.getHoldTime():0)},g.prototype.setMode=function(e){void 0!==e&&e!==this._mode&&(this._mode=e,this.updateEditGesture(),this.viewer.trapSelection&&this.viewer.trapSelection.updateMode(this,this._mode))},g.prototype.setDebugEvents=function(e){o.setDebugEvents(e)},g.prototype.attachEvents=function(){this.initGestureCB(),this.domElement.addEventListener("contextmenu",this._onContextMenu,!1),window.addEventListener("blur",this._onBlurCB),window.addEventListener("dragend",this._onDragEndCB),this.domElement.addEventListener("dragover",this._onDragCB)},g.prototype.detachEvents=function(){this.resetGestureCB(),this.domElement.removeEventListener("contextmenu",this._onContextMenu,!1),window.removeEventListener("blur",this._onBlurCB),window.removeEventListener("dragend",this._onDragEndCB),this.domElement.removeEventListener("dragover",this._onDragCB)},g.prototype.overrideRotationViaLongHold=function(e){1===e?(this.viewer&&this.viewer.setManipulators({activated:!0}),this._forceRotate=!1):(this._forceRotate=!0,this.viewer&&this.viewer.setManipulators({activated:!1}))},g.prototype._setCapture=function(){var e=this.viewer?this.viewer.div:null;e&&(!e.setCapture||!(this._isIE11||p&&!e.draggable)||e.tagName&&"input"===e.tagName.toLowerCase()||e.setCapture(!1))},g.prototype._releaseCapture=function(){(this._isIE11||p)&&this.currentDocument.releaseCapture&&this.currentDocument.releaseCapture()},g.prototype.initGestureCB=function(){if(!this.gestureCBReady){var e=this;this._onLeftMouseDownCB=function(t){e._onLeftMouseDown.call(e,t)},this._onMiddleMouseDownCB=function(t){e._onMiddleMouseDown.call(e,t)},this._onRightMouseDownCB=function(t){e._onRightMouseDown.call(e,t)},this._onLeftMouseUpCB=function(t){e._onLeftMouseUp.call(e,t)},this._onMiddleMouseUpCB=function(t){e._onMiddleMouseUp.call(e,t)},this._onRightMouseUpCB=function(t){e._onRightMouseUp.call(e,t)},this._onMouseMoveCB=function(t){e._onMouseMove.call(e,t)},this._onMouseOutCB=function(t){e._onMouseOut.call(e,t)},this._onSwipeCB=function(t){e._onSwipe.call(e,t)},this._onTapCB=function(t){e._onTap.call(e,t)},this._onPinchPanRotateCB=function(t){e._onPinchPanRotate.call(e,t)},this._onDoubleTapCB=function(t){e._onDoubleTap.call(e,t)},this._onDoublePinchTapCB=function(t){e._onDoublePinchTap.call(e,t)},this._onHoldCB=function(t){e._onHold.call(e,t)},this._onTouchCB=function(t){e._onTouch.call(e,t)},this._onReleaseCB=function(t){e._onRelease.call(e,t)},this._onEditCB=function(t){e._onStopManip.call(e,t)},o.addEvent(this.currentDocument,"onLeftMouseDown",this._onLeftMouseDownCB),o.addEvent(this.currentDocument,"onRightMouseDown",this._onRightMouseDownCB),o.addEvent(this.currentDocument,"onLeftMouseUp",this._onLeftMouseUpCB),o.addEvent(this.currentDocument,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.addEvent(this.currentDocument,"onRightMouseUp",this._onRightMouseUpCB),o.addEvent(this.currentDocument,"onMouseMove",this._onMouseMoveCB),o.addEvent(this.currentDocument,"onMouseOut",this._onMouseOutCB),o.addEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.addEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(this.domElement,"onHold",this._onHoldCB),o.addEvent(this.currentDocument,"onRelease",this._onReleaseCB),o.addEvent(this.currentDocument,"onEdit",this._onEditCB),this.updateEditGesture(),this.addViewToGestures(this.domElement),this.viewer&&this.viewer.divCssElement&&this.addViewToManipulation(this.viewer.divCssElement),this.basicEventID=s.subscribe({event:"/VISU/onBasicEvent"},(function(t){e._onBasicEvent.call(e,t)})),this.editEventBeginID=s.subscribe({event:"/VISU/onEditEventBegin"},(function(t){e._showSpinnerOnHold&&e._onEditEventBegin.call(e,t)})),this.editEventKOID=s.subscribe({event:"/VISU/onEditEventKO"},(function(t){e._onEditEventKO.call(e,t)})),this.gestureCBReady=!0}},g.prototype.resetGestureCB=function(){if(this.gestureCBReady){o.removeEvent(this.currentDocument,"onLeftMouseDown",this._onLeftMouseDownCB),o.removeEvent(this.currentDocument,"onRightMouseDown",this._onRightMouseDownCB),o.removeEvent(this.currentDocument,"onLeftMouseUp",this._onLeftMouseUpCB),o.removeEvent(this.currentDocument,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.removeEvent(this.currentDocument,"onRightMouseUp",this._onRightMouseUpCB),o.removeEvent(this.currentDocument,"onMouseMove",this._onMouseMoveCB),o.removeEvent(this.currentDocument,"onMouseOut",this._onMouseOutCB),o.removeEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(this.domElement,"onHold",this._onHoldCB),o.removeEvent(this.currentDocument,"onRelease",this._onReleaseCB),o.removeEvent(this.currentDocument,"onEdit",this._onEditCB);for(var e=0;e<this.manipulatedViewList.length;e++){var t=this.manipulatedViewList[e];this.removeViewFromGestures(t)}s.unsubscribe(this.basicEventID),s.unsubscribe(this.editEventBeginID),s.unsubscribe(this.editEventKOID),this.gestureCBReady=!1}},g.prototype.addViewToGestures=function(e){o.addEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.addEvent(e,"onTouch",this._onTouchCB),o.addEvent(e,"onSwipe",this._onSwipeCB),o.addEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.addEvent(e,"onTap",this._onTapCB)},g.prototype.removeViewFromGestures=function(e){o.removeEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.removeEvent(e,"onTouch",this._onTouchCB),o.removeEvent(e,"onSwipe",this._onSwipeCB),o.removeEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.removeEvent(e,"onTap",this._onTapCB)},g.prototype.addViewToManipulation=function(e){return-1===this.manipulatedViewList.indexOf(e)&&(this.manipulatedViewList.push(e),this.addViewToGestures(e),!0)},g.prototype.removeViewFromManipulation=function(e){var t=this.manipulatedViewList.indexOf(e);return-1!==t&&(this.manipulatedViewList.splice(t,1),this.removeViewFromGestures(e),!0)},g.prototype.setTarget=function(e){this.target.copy(e)},g.prototype.onMove=function(e){return this._modelEvent.subscribe({event:"ViewpointMove"},e)},g.prototype.unsubscribe=function(e){var t=this._customZoomTokens.indexOf(e);-1!==t?this._customZoomTokens.splice(t,1):-1!==(t=this._customPanTokens.indexOf(e))?this._customPanTokens.splice(t,1):-1!==(t=this._customRotateTokens.indexOf(e))&&this._customRotateTokens.splice(t,1),this._modelEvent.unsubscribe(e)},g.prototype.updateNativeZoom=function(e){if(this.camera.isOrtho&&null!=this.viewpoint._nativeZoomType){this.camera.setVisualizedHeight(e);let t=1/this.viewpoint.getMMInSupportUnit();switch(this.viewpoint._nativeZoomType){case this.viewpoint.NativeZoomTypes.MillimeterScreenBased:this.viewpoint._nativeZoom=this.viewer.SCREEN_HEIGHT*t/(this.camera.top-this.camera.bottom);break;case this.viewpoint.NativeZoomTypes.HalfWindowHeightBased:case this.viewpoint.NativeZoomTypes.HalfWindowWidthAndHeigthBased:this.viewpoint._nativeZoom=2/(this.camera.top-this.camera.bottom)}let i=!1;if(this.viewpoint._nativeMinZoom&&this.viewpoint._nativeZoom<this.viewpoint._nativeMinZoom&&(this.viewpoint._nativeZoom=this.viewpoint._nativeMinZoom,i=!0),this.viewpoint._nativeMaxZoom&&this.viewpoint._nativeZoom>this.viewpoint._nativeMaxZoom&&(this.viewpoint._nativeZoom=this.viewpoint._nativeMaxZoom,i=!0),i){let e=2/this.viewpoint._nativeZoom;this.viewpoint._nativeZoomType==this.viewpoint.NativeZoomTypes.MillimeterScreenBased&&(e=this.viewer.SCREEN_HEIGHT*t/this.viewpoint._nativeZoom);let i=e/(2*Math.tan(Math.PI*this.fov/360));this.camera.setVisualizedHeight(i)}this.update()}},g.prototype.update=function(){var e=this.camera.position.clone(),i=this.camera.quaternion.clone(),r=new t.Vector3(0,0,1),n=!1;if(this.camera.useQuaternion=!0,r.applyQuaternion(this.orientation),r.setLength(this.distanceToTarget),this.camera.position.addVectors(this.target,r),this.camera.isOrtho&&null==this.viewpoint._nativeZoomType&&(this.camera.setVisualizedHeight(this.distanceToTarget),this.camera.updateProjectionMatrix()),null!=this.viewpoint._nativeZoomType){let e=this.viewpoint.updateNative2D(),t=.5*(this.camera.top-this.camera.bottom)/Math.tan(this.camera.fov*Math.PI/360);this.distanceToTarget=t,r.setLength(t);var a=e.clone().sub(r);this.setTarget(a),this.camera.position.addVectors(this.target,r)}this.camera.quaternion.copy(this.orientation),this.camera.up=new t.Vector3(0,1,0),this.camera.up.applyQuaternion(this.orientation),e.sub(this.camera.position),i.sub(this.camera.quaternion),this.position.copy(this.camera.position),this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera.updateProjectionMatrix(),this.viewpoint._updateFrustum(),(this.infiniteRender||e.lengthSq()>1e-7||i.lengthSq()>1e-7||this.camera._hasChanged)&&(n=!0,this.dispatchEvent(g.changeEvent),this._modelEvent.publish({event:"ViewpointMove",context:this}),this._2DMode&&this.viewer.svgRoot&&this.viewer._updateSVGVisu(),this.viewer&&(this.viewer.renderIteration=0)),this.camera._hasChanged=!1,this._updateTarget3DNode();var o={eventChannel:n?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this.viewpoint,cameraEye:this.position,cameraTarget:this.target,cameraUp:this.camera.up};return s.publish({event:n?"/VISU/":"/VISU/SpriteNodeInit",data:o}),n},g.prototype.moveTo=function(e){console.log("TrackballControls.prototype.moveTo is DEPRECATED: use Viewpoint.moveTo instead.");var a,o,l,h={position:e.position,target:e.target||this.target.clone(),orientation:e.orientation||this.orientation.clone(),distanceToTarget:e.distanceToTarget||this.distanceToTarget,duration:e.duration||0};if(e instanceof t.Vector3&&(console.warn("TrackballControls.prototype.moveTo now uses options litteral object as argument."),h.target=arguments[0],arguments[1]&&(h.orientation=arguments[1]),void 0!==arguments[2]&&(h.distanceToTarget=arguments[2]),void 0!==arguments[3]&&(h.duration=arguments[3])),this._targetAnim&&this._targetAnim.stop(),this._orientationAnim&&this._orientationAnim.stop(),this._distanceToTargetAnim&&this._distanceToTargetAnim.stop(),h.position&&e.target){var c=(new t.Vector3).subVectors(e.target,h.position);if(h.distanceToTarget=c.length(),!e.orientation){var d=(new t.Matrix4).lookAt(h.position,e.target,new t.Vector3(0,0,1));h.orientation.setFromRotationMatrix(d)}}else if(h.position){var u=new t.Vector3(0,0,1);u.applyQuaternion(h.orientation),u.setLength(h.distanceToTarget);var p=(new t.Vector3).subVectors(h.position,u);h.target=p}if(0===h.duration)this.setTarget(h.target),this.orientation=h.orientation,this.distanceToTarget=h.distanceToTarget,this.update();else{(a=new r(this.target.clone(),h.target,h.duration)).setInterpolator((function(e,t,i){var r=t.clone();return r.lerp(i,e),r}));var f=this;this._targetAnim=new n(this,"setTarget",a,(function(e){if(e===i.State.STOPPED){var t={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:f.viewpoint,cameraEye:f.camera.position,cameraUp:f.camera.up};s.publish({event:"/VISU/",data:t})}})),(o=new r(this.orientation,h.orientation,h.duration)).setInterpolator((function(e,i,r){var n=new t.Quaternion;return t.Quaternion.slerp(i,r,n,e),n})),this._orientationAnim=new n(this,"orientation",o),l=new r(this.distanceToTarget,h.distanceToTarget,h.duration),this._distanceToTargetAnim=new n(this,"distanceToTarget",l),this._targetAnim.start(),this._orientationAnim.start(),this._distanceToTargetAnim.start()}},g.prototype.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},g.prototype.startPan=function(e){this.endRotate(),this.endZoom(),this._forcePan=!0,e&&(this._forcePanCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Pan",0))},g.prototype.startRotate=function(e){this.endPan(),this.endZoom(),this._forceRotate=!0,e&&(this._forceRotateCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Rotate",0))},g.prototype.startZoom=function(e){this.endPan(),this.endRotate(),this._forceZoom=!0,e&&(this._forceZoomCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Zoom",0))},g.prototype.endPan=function(e){this._forcePan&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forcePan=!1,this._forcePanCmd&&(this._forcePanCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(g.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},g.prototype.endRotate=function(e){this._forceRotate&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceRotate=!1,this._forceRotateCmd&&(this._forceRotateCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(g.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},g.prototype.endZoom=function(e){this._forceZoom&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceZoom=!1,this._forceZoomCmd&&(this._forceZoomCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(g.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},g.prototype._getMouseProjectionOnBall=function(e){var i,r,n,s;let a=.5*this.domElement.clientWidth,o=.5*this.domElement.clientHeight,l=this.radius,h=this.viewer._viewpointManager.getViewpointViewport(this.viewpoint);return h&&(a=h.x+h.width/(2*this.viewer.devicePixelRatio),o=this.domElement.clientHeight-(h.y+h.height/(2*this.viewer.devicePixelRatio)),l=.5*Math.max(h.width,h.height)),(r=(i=new t.Vector3((e.x-a)/l,(o-e.y)/l,0)).length())>1?i.normalize():i.z=Math.sqrt(1-r*r),n=(new t.Vector3).subVectors(this.camera.position,this.target),(s=new t.Vector3).add(this.camera.up.clone().cross(n).setLength(i.x)),s.add(this.camera.up.clone().setLength(i.y)),s.add(n.clone().setLength(i.z)),s},g.prototype._pan=function(e,t){this.update(),this._doPan(e.x-t.x,e.y-t.y)},g.prototype._doPan=function(e,i){var r,n,s;0===e&&0===i||(r=(new t.Vector3).copy(this.camera.position).sub(this.target),this.camera.isOrtho?n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight():(n=2*this.distanceToTarget*Math.tan(.5*this.camera.fov*Math.PI/180)/this.viewer._getDivClientHeight(),this._mode===g.Mode.LOOKAROUND&&(n=-n)),(s=new t.Vector3).add(r.clone().cross(this.camera.up).setLength(n*e)),s.add(this.camera.up.clone().setLength(n*i)),this.target.add(s))},g.prototype._rotate=function(e,i){var r,n,s,a,o;this.update(),r=this._getMouseProjectionOnBall(i),n=this._getMouseProjectionOnBall(e),(s=Math.acos(r.dot(n)/(r.length()*n.length())))&&(a=(new t.Vector3).crossVectors(r,n).normalize(),s*=this.rotateSpeed,o=(new t.Quaternion).setFromAxisAngle(a,-s),this.orientation.multiplyQuaternions(o,this.orientation.clone()))},g.prototype._rotateLockZ=function(e,t){this._rotateLockWorldUpVector(e,t)},g.prototype._getAvatarPositionFromCamera=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.add(t.clone().multiplyScalar(this._avatarDistance))),i},g.prototype._getCameraFromAvatarPosition=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.sub(t.clone().multiplyScalar(this._avatarDistance))),i},g.prototype._turnHeadLockWorldUpVector=function(e,i,r){this.update(),this._stopRotation();var n=this.distanceToTarget,s=this.camera.getLookAt(),a=this.camera.up,o=this.camera.position,l=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(l=new t.Vector3(0,1,0));var h=this.viewpoint.getAngle()*Math.PI/180,c=o.clone();this._getAvatarPositionFromCamera&&(c=this._getAvatarPositionFromCamera(o,s));var d=-e*h/this.viewer.SCREEN_HEIGHT,u=-i*h/this.viewer.SCREEN_HEIGHT;this._invertHeadRotation&&(d=-d,u=-u);var p=new t.Vector3(0,0,0);p.crossVectors(s,a);var f=l.angleTo(a),g=new t.Vector3(0,0,0);g.crossVectors(l,a),g.dot(p)<0&&(f=-f),f+u>Math.PI/2&&(u=Math.PI/2-f),f+u<-Math.PI/2&&(u=-Math.PI/2-f),p.applyAxisAngle(l,d),s.applyAxisAngle(l,d),0!==u&&s.applyAxisAngle(p,u),a.crossVectors(p,s);var m=new t.Vector3(0,0,0);if(m.crossVectors(s,l),m&&m.length()>.1){var v=a.dot(m);m.setLength(v),m.multiplyScalar(-1),a.add(m),a.normalize()}this._getCameraFromAvatarPosition&&(o=this._getCameraFromAvatarPosition(c,s));var _=o.clone().add(s.clone().multiplyScalar(n)),y=new t.Quaternion,S=new t.Matrix4;S.lookAt(o,_,a),y.setFromRotationMatrix(S),this.setTarget(_),this.orientation=y,this.needsRotationFinalized=!0,this.deltaPosition=r.deltaPosition.clone(),this.previousTime>0&&(this.deltaTime=r.currentTime-this.previousTime),this.previousTime=r.currentTime},g.prototype._finalizeTurnHeadLockWorldUpVector=function(e,s){if(this.update(),this._stopRotation(),this.needsRotationFinalized&&(this.needsRotationFinalized=!1,(!this.viewpoint._viewpointAnimation||this.viewpoint._viewpointAnimation.state()!==i.State.RUNNING)&&!this.lockRotation&&(!s||!this.lockTouchRotation)&&(s||!this.lockMouseRotation))){var a=new t.Vector2;a.copy(this.deltaPosition),a.multiplyScalar(1/this.deltaTime);if(!(a.length()<.3)){a.length()>6&&a.setLength(6);var o=this.distanceToTarget,l=this.camera.position,h=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(h=new t.Vector3(0,1,0));var c=this.viewpoint.getAngle()*Math.PI/180,d=this.viewer.SCREEN_HEIGHT,u=new r(0,0,800),p=this.camera.getLookAt(),f=this.camera.up,g=(new t.Quaternion).copy(this.orientation),m=l.clone(),v=l.clone().add(p.clone().multiplyScalar(o)),_=0,y=this;u.setInterpolator((function(e,i,r){var n=m.clone();y._getAvatarPositionFromCamera&&(n=y._getAvatarPositionFromCamera(m,p));var s=a.clone().multiplyScalar(1-e);e*=800;var l=s.x*(e-_),u=s.y*(e-_);_=e;var S=-l*c/d,b=-u*c/d;y._invertHeadRotation&&(S=-S,b=-b);var x=new t.Vector3(0,0,0);x.crossVectors(p,f);var w=h.angleTo(f),P=new t.Vector3(0,0,0);P.crossVectors(h,f),P.dot(x)<0&&(w=-w),w+b>Math.PI/2&&(b=Math.PI/2-w),w+b<-Math.PI/2&&(b=-Math.PI/2-w),x.applyAxisAngle(h,S),p.applyAxisAngle(h,S),0!==b&&p.applyAxisAngle(x,b),f.crossVectors(x,p);var C=new t.Vector3(0,0,0);if(C.crossVectors(p,h),C&&C.length()>.1){var M=f.dot(C);C.setLength(M),C.multiplyScalar(-1),f.add(C),f.normalize()}y._getCameraFromAvatarPosition&&(m=y._getCameraFromAvatarPosition(n,p)),v=m.clone().add(p.clone().multiplyScalar(o));var E=new t.Matrix4;E.lookAt(m,v,f),g.setFromRotationMatrix(E)}));var S={me:this,setOrientation:function(e){this.me.setTarget(v),this.me.orientation=g}};this._orientationAnim=new n(S,"setOrientation",u),this._orientationAnim.start()}}},g.prototype._rotateLockWorldUpVector=function(e,t){this.update(),this._stopRotation();var i=this.viewpoint._worldOrientation.upAttribute;if(this._state===g.State.ZOOM_PAN_ROTATE){if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.getLookAt()[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(-this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}else{var r;if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.up[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}this.lastLockZState=this._state,this.needsRotationFinalized=!0},g.prototype._finalizeRotateLockZ=function(e,t){this._finalizeRotateLockWorldUpVector(e,t)},g.prototype._getSpaceSphereCenter=function(){let e=this.viewpoint.viewer.visibleSpace?"visibleSpace":"invisibleSpace";return this.viewpoint.getBoundingSphere(e,void 0).center},g.prototype._rotateAroundPoint=function(e,i){if(!this._rotationAroundPointTarget.isSet)return void(this.lockZ?this._rotateLockWorldUpVector(e.x-i.x,e.y-i.y):this._rotate(e,i));!0===this._showRotationPointOnMove&&this._setRotationPointElem(!0);let r=new t.Vector3,n=new t.Vector3(1,0,0),s=new t.Vector3(0,0,1),a=new t.Vector3;r.copy(this._rotationAroundPointTarget.dim3),n.applyQuaternion(this.camera.quaternion),a.copy(n);let o=(e.x-i.x)*(-1*this._pivotRotateSpeed),l=(e.y-i.y)*(-1*this._pivotRotateSpeed);this._pivot(r,s,o),this._pivot(r,a,l)},g.prototype._pivot=function(e,i,r){let n=new t.Vector3,s=new t.Quaternion,a=new t.Vector3,o=new t.Quaternion;n.copy(this.camera.position),o.copy(this.camera.quaternion),this.camera.useQuaternion=!0,s.setFromAxisAngle(i,r*this._deg2Rad),a.subVectors(n,e),a.copy(a.applyQuaternion(s)),n.addVectors(e,a),this.camera.position.copy(n),this.camera.up=new t.Vector3(0,1,0),this.camera.quaternion.multiplyQuaternions(s,o),this.position.copy(this.camera.position),this.orientation.copy(this.camera.quaternion),this.camera._hasChanged=!0,this.viewpoint.moveTo({eyePosition:this.position,orientation:this.orientation}),this.update()},g.prototype._updateTarget3DNode=function(e){this._debugTarget&&this._target3DNode&&(e?this._target3DNode.setMatrix((new t.Matrix4).setPosition(new t.Vector3(e.x,e.y,e.z))):this._target3DNode.setMatrix((new t.Matrix4).setPosition(new t.Vector3(this.target.x,this.target.y,this.target.z))))},g.prototype.updateCameraToTargetDist=function(e,t){this._cameraToTargetMaxDist=t*this._cameraToTargetMaxDistRatio,this._cameraToTargetSetDist=t<this._cameraToTargetMinDist?t:null,this._updateTarget3DNode(e)},g.prototype._dumpTargetData=function(){this._debugTarget&&console.log(`DistanceToTarget=${this.distanceToTarget.toFixed(3)} | CameraToTargetMaxDist=${this._cameraToTargetMaxDist.toFixed(3)} | cameraToTargetMinDist=${this._cameraToTargetMinDist} | cameraToTargetSetDist=${this._cameraToTargetSetDist?this._cameraToTargetSetDist.toFixed(3):null}`)},g.prototype._finalizeRotateLockWorldUpVector=function(e,i){this._stopRotation();var s=this.viewpoint._worldOrientation,a=s.upAttribute;s.frontAttribute,s.rightAttribute;if(this.needsRotationFinalized&&!this.lockRotation&&(!i||!this.lockTouchRotation)&&(i||!this.lockMouseRotation)){var o=e.currentTime-e.startTime,l=new t.Vector2;if(l.copy(e.offsetPosition),l.multiplyScalar(.003/o),!(l.length()<1e-7)){l.length()>.01&&l.setLength(.01);var h=(new t.Quaternion).copy(this.orientation),c=l.clone().normalize().multiplyScalar(6e-6),d=l.length()/c.length(),u=new r(0,0,d),p=0,f=this.camera.up[a];p=0===(f=+f)||isNaN(f)?f:f>0?1:-1,u.setInterpolator((function(e,t,i){e*=d;var r=l.x*e-.5*c.x*e*e,n=l.y*e-.5*c.y*e*e;return s.getOrientationForLockedRotation(p*r,n,h)}));var g={me:this,setOrientation:function(e){this.me.orientation=e}};this._orientationAnim=new n(g,"setOrientation",u),this._orientationAnim.start(),this.needsRotationFinalized=!1}}},g.prototype._zoom=function(e,i){var r,n;this.update(),r=e.y-i.y,1!==(n=1+(r*=.5/this.radiusZoom)*this.zoomSpeed)&&n>0&&(this._zoomType===g.ZoomType.ZOOM_FOV_CHANGE?this._zoomFOVChange(new t.Vector2(Math.floor(.5*this.viewer.SCREEN_WIDTH),Math.floor(.5*this.viewer.SCREEN_HEIGHT)),n<1,n):r<0&&1==this._forceCameraToTargetMinDist&&!this.camera.isOrtho&&!this._continuousZoom&&this.distanceToTarget<=this._cameraToTargetMaxDist||(this.distanceToTarget*=n)),this.updateNativeZoom(this.distanceToTarget)},g.prototype._zoomPanRotate=function(e,i){this.update(),this._stopRotation();var r=e.getEvents(),n=r[0],s=r[1];if(!(this.lockZoom||i&&1!==i)){var a;a=e.distance-e.lastDistance;var o={gesture:e,factor:h=1-(a*=.5/this.radiusZoom)*this.zoomSpeed,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:o,context:this}),o.defaultBehavior&&1!==h&&h>0){var l=(new t.Vector2).addVectors(n.lastPosition,s.lastPosition).multiplyScalar(.5);if(this._zoomType===g.ZoomType.ZOOM_FOV_CHANGE)this._zoomFOVChange(l,h<1,h);else if(this._mode===g.Mode.LOOKAROUND){var h=this._getZoomFOVOnCursorFactorForTwoPointers(n.currentPosition,s.currentPosition,n.lastPosition,s.lastPosition);this._zoomFOVOnCursor(l,h<0,180*h/Math.PI)}else this._zoomSimple(l,h<1,h)}}if(!(this.lockPan||i&&2!==i)){var c,d=n.getCurrentPosition(this.domElement),u=s.getCurrentPosition(this.domElement),p=n.getLastPosition(this.domElement),f=s.getLastPosition(this.domElement);c=.5*(d.x+u.x)-.5*(p.x+f.x),a=.5*(d.y+u.y)-.5*(p.y+f.y);var m={gesture:e,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:m,context:this}),m.defaultBehavior&&this._doPan(c,a)}if(!(this.lockRotation||this.lockTouchRotation||i&&3!==i||this._mode===g.Mode.LOOKAROUND)){var v={gesture:e,defaultBehavior:!0};if(this._modelEvent.publish({event:"Rotate",data:v,context:this}),v.defaultBehavior)if(this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable)this._rotateLockWorldUpVector(-200*e.getDeltaAngle(),0);else{d=n.getCurrentPosition(this.domElement),u=s.getCurrentPosition(this.domElement),n.getLastPosition(this.domElement),s.getLastPosition(this.domElement);for(var _=new t.Vector2,y=0;y<2;y++)_.add(r[y].getCurrentPosition(this.domElement)),_.add(r[y].getLastPosition(this.domElement));_.divideScalar(4);var S=e.getDeltaAngle();this._rotateTwoTouch(S,_)}}},g.prototype._intersectLines=function(e,i,r,n){var s=new t.Vector2;s.subVectors(i,e);var a=new t.Vector2;a.subVectors(r,n);var o=s.y,l=-s.x,h=s.x*e.y-s.y*e.x,c=a.y,d=-a.x,u=a.x*r.y-a.y*r.x,p=o*d-l*c;if(0===p)return null;var f=(l*u-h*d)/p,g=-(o*u-h*c)/p;return new t.Vector2(f,g)},g.prototype._rotateTwoTouch=function(e,i){this.update();var r=this.viewpoint.create3DRayFrom2DPoint(i).origin;if(Number.isFinite(e)){var n=this.camera.getLookAt();n.negate();var s=(new t.Quaternion).setFromAxisAngle(n,e),a=this.camera.position,o=(new t.Vector3).subVectors(a,r),l=(new t.Vector3).addVectors(r,o.applyQuaternion(s));this.viewpoint.moveTo({eyePosition:l,orientation:s.multiply(this.orientation.clone())})}},g.prototype._zoomSimpleOnCenter=function(e,t,i){var r;r=void 0!==i?i:t?.9:1.1;var n=this.distanceToTarget*r;this.distanceToTarget=n,this.updateNativeZoom(this.distanceToTarget)},g.prototype._zoomSimple=function(e,i,r){if(i&&this._forceCameraToTargetMinDist&&!this.camera.isOrtho&&!this._continuousZoom&&this.distanceToTarget<=this._cameraToTargetMaxDist)return;var n,s=new t.Projector,a=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1.1;a=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,h=this.target.clone().sub(o.clone().multiplyScalar(this.distanceToTarget*n));let c=a.x,d=a.y,u=this.viewer._viewpointManager.getViewpointViewport(this.viewpoint);if(u){c=(a.xPix-u.x)/u.width*2-1;let e=this.domElement.clientHeight*this.viewer.devicePixelRatio-(u.y+u.height);d=-(a.yPix-e)/u.height*2+1}var p=new t.Vector3(c,d,.5),f=new t.Vector3(c,d,.5);s.unprojectVector(p,this.camera);var m=null;if(this.camera instanceof t.OrthographicCamera)this.camera.setVisualizedHeight(this.distanceToTarget*n),this.updateNativeZoom(this.distanceToTarget*n),s.unprojectVector(f,this.camera),m=p.sub(f);else{var v,_;this.camera.matrixWorld.setPosition(h),s.unprojectVector(f,this.camera),this.camera.matrixWorld.setPosition(l),v=new t.Ray(l,p.clone().sub(l).normalize()),_=new t.Ray(h,f.clone().sub(h).normalize());var y=this.viewpoint.getBoundingSphere(),S=v.at(this.camera.near/v.direction.clone().dot(o)),b=v.direction.clone().dot(y.center.clone().sub(S)),x=Math.max(0,b-y.radius),w=Math.max(0,b+y.radius),P=S.add(v.direction.clone().multiplyScalar(.5*(x+w))),C=o.negate(),M=-C.clone().dot(P),E=new t.Plane(C,M),T=_.intersectPlane(E);m=P.clone().sub(T)}h.add(m);var A=this.distanceToTarget*n;if(this._state===g.State.ZOOM_PAN_ROTATE){var D=this.camera.getLookAt();this.setTarget((new t.Vector3).addVectors(h,D.clone().multiplyScalar(A))),this.distanceToTarget=A,this.update()}else this.viewpoint.moveTo({eyePosition:h,distanceToTarget:A});this.updateNativeZoom(A)},g.prototype._zoomSimpleOnCursor=function(e,i,r){var n;n=void 0!==r?r:i?.9:1.1;var s=this.distanceToTarget*n,a=this.viewer.getMousePosition(e),o=this.camera.getLookAt(),l=this.camera.position,h=new t.Vector3(a.x,a.y,.5),c=new t.Vector3(a.x,a.y,.5),d=new t.Projector;d.unprojectVector(h,this.camera);var u=null;if(this.camera instanceof t.OrthographicCamera){u=this.target.clone().sub(o.clone().multiplyScalar(s)),this.camera.setVisualizedHeight(s),d.unprojectVector(c,this.camera);var p=h.sub(c);u.add(p)}else{p=(new t.Vector3).subVectors(h,l).normalize().multiplyScalar(this.distanceToTarget-s);u=this.camera.position.clone().add(p)}this.viewpoint.moveTo({eyePosition:u,distanceToTarget:s}),this.updateNativeZoom(s)},g.prototype._getZoomFOVAngle=function(e,i){var r=this.viewer.getMousePosition(i),n=this.viewer.getMousePosition(e),s=new t.Vector3(r.x,r.y,.5),a=new t.Vector3(n.x,n.y,.5),o=new t.Projector;o.unprojectVector(s,this.camera),o.unprojectVector(a,this.camera);var l=this.camera.position,h=s.clone().sub(l),c=a.clone().sub(l);return h.angleTo(c)},g.prototype._getZoomFOVOnCursorFactorForOnePointer=function(e,t){var i=e,r=t;i.x=r.x;var n=this._getZoomFOVAngle(i,r);return r.y<i.y&&(n=-n),2*n},g.prototype._getZoomFOVOnCursorFactorForTwoPointers=function(e,t,i,r){var n=this._getZoomFOVAngle(r,i);return this._getZoomFOVAngle(t,e)-n},g.prototype._zoomFOVOnCursor=function(e,i,r){var n=4;n=void 0!==r?-r:i?-n:n;var s=null;e&&(s=this.viewer.getMousePosition(e));var a=this.distanceToTarget,o=this.camera.getLookAt(),l=this.camera.position,h=this.camera.up,c=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(c=new t.Vector3(0,1,0));var d=this.viewer.SCREEN_WIDTH,u=this.viewer.SCREEN_HEIGHT,p=this.viewpoint.getAngle(),f=null;if(!(p>=100&&n>=0||p<=20&&n<=0)){if((f=p+n)>100?f=100:f<20&&(f=20),s){var g=.03*n,m=.03*n*u/d,v=s.x/2*g,_=-s.y/2*m,y=new t.Vector3(0,0,0);y.crossVectors(o,h);var S=c.angleTo(h),b=new t.Vector3(0,0,0);b.crossVectors(c,h),b.dot(y)<0&&(S=-S),S+_>Math.PI/2&&(_=Math.PI/2-S),S+_<-Math.PI/2&&(_=-Math.PI/2-S),y.applyAxisAngle(c,v),o.applyAxisAngle(c,v),0!==_&&o.applyAxisAngle(y,_),h.crossVectors(y,o)}var x=new t.Vector3(0,0,0);if(x.crossVectors(o,c),x&&x.length()>.1){var w=h.dot(x);x.setLength(w),x.multiplyScalar(-1),h.add(x),h.normalize()}var P=l.clone().add(o.clone().multiplyScalar(a)),C=new t.Quaternion,M=new t.Matrix4;M.lookAt(l,P,h),C.setFromRotationMatrix(M),s&&(this.setTarget(P),this.orientation=C),this.viewpoint.setAngle(f),this.camera.updateProjectionMatrix()}},g.prototype._zoomFOVChange=function(e,i,r){var n,s=new t.Projector,a=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1/.9;a=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,h=l.clone(),c=new t.Vector3(a.x,a.y,.5),d=new t.Vector3(a.x,a.y,.5);s.unprojectVector(c,this.camera);var u,p,f,g,m=this.viewpoint.getBoundingSphere(),v=this.viewpoint.getAngle()/2,_=22.5,y=o.clone().dot(m.center.clone().sub(l)),S=2*m.radius;if(y<S){var b=S-y,x=o.clone().multiplyScalar(-b),w=Math.tan(t.Math.degToRad(.5*this.viewpoint.getAngle())),P=t.Math.radToDeg(Math.atan(w*Math.abs(y)/S));(P>_||P<0)&&(P=_),l.add(x),h=l.clone(),v=P,this.viewpoint.setAngle(2*P),this.camera.updateProjectionMatrix(),y=S}if(i){T=v*n;var C=n;if(y>S){var M=y-S,E=S/y;if(E<n)M=y-y*n,C=1;else C=T/(v*E);M>0&&h.add(o.clone().multiplyScalar(M))}if(1!=C){let e=C*v*2;this.viewpoint.setAngle(e),this.camera.updateProjectionMatrix()}}else{var T,A=1;if(v<_)(T=v*n)>_?(this.viewpoint.setAngle(45),A=T/_):this.viewpoint.setAngle(2*T),this.camera.updateProjectionMatrix();else A=n;if(1!=A){var D=A*y;x=o.clone().multiplyScalar(y-D);h.add(x)}}g=this.target.clone().sub(h).length(),this.camera.matrixWorld.setPosition(h),s.unprojectVector(d,this.camera),this.camera.matrixWorld.setPosition(l),p=new t.Ray(l,c.clone().sub(l).normalize()),f=new t.Ray(h,d.clone().sub(h).normalize());var I=p.at(this.camera.near/p.direction.clone().dot(o)),R=p.direction.clone().dot(m.center.clone().sub(I)),O=Math.max(0,R-m.radius),L=Math.max(0,R+m.radius),B=I.add(p.direction.clone().multiplyScalar(.5*(O+L))),F=o.negate(),V=-F.clone().dot(B),G=new t.Plane(F,V),N=f.intersectPlane(G);u=B.clone().sub(N),h.add(u),this.viewpoint.setAngle(Math.max(Math.min(this.viewpoint.getAngle(),45),this._FOVZoomMinAngle)),this.camera instanceof t.OrthographicCamera&&this.camera.setVisualizedHeight(g),this.viewpoint.moveTo({eyePosition:h,distanceToTarget:g})},g.prototype._mouseWheel=function(e){if(this.lockMouseWheel)return;e.event.preventDefault();var t=UWA.Event.wheelDelta(e.getJSEvent());this.isMac&&(t*=-1);var i={evt:e,factor:t,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:i,context:this}),!this.isCurrentViewpoint())return;var r=this;this._wheelMoving=!0,this._wheelTimer&&clearTimeout(this._wheelTimer),this._wheelTimer=setTimeout((function(){r._wheelMoving=!1,clearTimeout(r._wheelTimer),r._wheelTimer=null}),300);let n=this._isFromTrackPad(e.getJSEvent());if(0<=n){if(!this._onTrackPadDragTwoFingers(e)){let e=2==n;return e||(e=1==n),void(this._trackPadData.autoState!=e&&(this._trackPadData.fAutoCb&&this._trackPadData.fAutoCb(e),this._trackPadData.autoState=e))}}else 0!=this._trackPadData.autoState&&(this._trackPadData.fAutoCb&&this._trackPadData.fAutoCb(!1),this._trackPadData.autoState=!1);if(i.defaultBehavior){var s=!1;if(this.lockMouseZoomForCtrlKeyWheelMode){var a=e.getJSEvent();a&&!0===a.ctrlKey&&(s=!0)}this._zoomType===g.ZoomType.ZOOM_FOV_CHANGE?!this.lockZoom&&!s&&this._zoomFOVChange(e.getCurrentPosition(this.domElement),t>0):this._mode===g.Mode.LOOKAROUND?!this.lockZoom&&!s&&this._zoomFOVOnCursor(e.getCurrentPosition(this.domElement),t>0):this._continuousZoom?!this.lockZoom&&!s&&this._zoomOnWheel(e.getCurrentPosition(this.domElement),t):!this.lockZoom&&!s&&this._zoomSimple(e.getCurrentPosition(this.domElement),t>0)}},g.prototype._zoomOnWheel=function(e,t){let i={x:e.x,y:e.y};e.y+=t*this._wheelToSlideZoomFactor*this._wheelToSlideInverted,this._zoom(e,i),this.distanceToTarget<=this._cameraToTargetMinDist/2&&(this.update(),this._updateContinuousZoom(t>0))},g.prototype._updateContinuousZoom=function(e){this._continuousZoom&&e&&(null!==this._cameraToTargetSetDist?this.distanceToTarget<this._cameraToTargetSetDist&&this.viewpoint.setTargetDistance(this._cameraToTargetSetDist):this.distanceToTarget<this._cameraToTargetMinDist&&this.viewpoint.setTargetDistance(this._cameraToTargetMinDist))},g.prototype._computeZoomParams=function(e){if(e!==g.State.ZOOM&&e!==g.State.PAN&&e!==g.State.ROTATE)return;let t=this.viewer.getSceneBoundingSphere();this._cameraToTargetMaxDist=this.distanceToTarget*this._cameraToTargetMaxDistRatio,this._cameraToTargetMinDist=t.radius*this._cameraToTargetMinDistRatio,this.viewer.getSceneBoundingSphere().radius,this._isZoomParamsComputed=!0},g.prototype._resize=function(e,t){this.radius=.5*Math.max(e,t),this.radiusZoom=.25*(e+t)},g.prototype._stopRotation=function(e){this._orientationAnim&&this._orientationAnim.stop()},g.prototype._changeState=function(e){var t=this._state;function i(e){return e===g.State.NONE||e===g.State.STOP||e===g.State.HOLD}switch(i(this._state)&&!i(e)&&(u.startManipulation("TrackballControls_"+this.id),performance.mark("start-manip")),i(e)&&!i(this._state)&&(performance.mark("end-manip"),performance.measure("manipulation","start-manip","end-manip"),u.endManipulation("TrackballControls_"+this.id)),this._state===g.State.NONE&&(this._oldCursor=this.viewer.getCursor()),this.rotateDirection=0,this.onChangeState(e),this._state=e,e){case g.State.ZOOM:case g.State.FORCE_ZOOM:!this.lockZoom&&this.viewer.setCursor("Zoom",100);break;case g.State.PAN:case g.State.FORCE_PAN:!this.lockPan&&this.viewer.setCursor("Pan",100);break;case g.State.ROTATE:case g.State.FORCE_ROTATE:if(!this.lockRotation&&!this.lockMouseRotation&&!this.lockTouchRotation){this.viewer.setCursor("Rotate",100),!0===this._rotationAroundPoint&&!1===this._rotationAroundPointTarget.isShown&&!0===this._retieveRotationPointTarget()&&(this._showRotationPointOnMove=!0);break}case g.State.HOLD:break;default:this.viewer.setCursor(this._oldCursor,0,!0),this._setRotationPointElem(!1)}if(this.viewpoint){var r=e!==g.State.NONE&&e!==g.State.HOLD&&e!==g.State.STOP;if(this.viewpoint._isMoving===r)return;this.viewpoint._isMoving=r;var n={eventChannel:"/VISU/",eventType:r?"@onViewpointBeginMove":"@onViewpointEndMove",viewpoint:this.viewpoint,cameraEye:this.viewpoint.camera.position,cameraUp:this.viewpoint.camera.up,from:"controller"};s.publish({event:"/VISU/",data:n})}!d.isRecording()||this._state!==g.State.NONE||this._state===t||this.isLeftClick()||this.isRightClick()||(window.WebVisuCurrentGesture.highLevelRecordJSON||(window.WebVisuCurrentGesture.highLevelRecordJSON={}),window.WebVisuCurrentGesture.highLevelRecordJSON.TrackBallControls={name:this._recordRegisterName,setViewPoint:this.positionToJSON()})},g.prototype.onChangeState=function(e){if(!this._continuousZoom)return;let t=this._state;this._isZoomParamsComputed||this._computeZoomParams(e),t!==g.State.ZOOM&&e===g.State.ZOOM?this.onStartZoomStateCB():t===g.State.ZOOM&&e!==g.State.ZOOM&&this.onStopZoomStateCB(),this._dumpTargetData()},g.prototype.onStartZoomStateCB=function(){this._cameraSensor.zoomT0=this.distanceToTarget,this._cameraSensor.zoomT1=this._cameraSensor.zoomT0},g.prototype.onStopZoomStateCB=function(){this._cameraSensor.zoomT1=this.distanceToTarget,this._cameraSensor.delta()&&this._updateContinuousZoom(this._cameraSensor.value()<-1)},g.prototype._onBasicEvent=function(e){if(e.from)for(var t=0;t<e.from.length;t++){var i=e.from[t],r=i.getType(),n=i.getState();if("Keyboard"===r){if(this.lockKeyboard)continue;var s=i.getKey();if(n===l.State.BEGIN){if(s===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!0),s===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!0,this._mode>0)(a=o._getGesture(this.currentDocument,"onEdit"))&&a.setTimerMouse(0);this._mode>0?this._ctrlKeyPressed&&this._state===g.State.ROTATE&&this._changeState(g.State.FORCE_PAN):this._middleButtonPressed&&this._ctrlKeyPressed&&!this.lockNativeBehaviorOnMouseMiddleTriggers&&setTimeout(((e,t,i,r)=>{e._middleButtonPressed&&(e._ctrlKeyPressed?e._changeState(i):e._changeState(r))}),150,this,i,g.State.ROTATE,g.State.ZOOM)}else if(n===l.State.END){var a;if(s===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!1),s===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!1,this._mode>0)(a=o._getGesture(this.currentDocument,"onEdit"))&&a.setTimerMouse(o.getHoldTime());this._mode>0?this._ctrlKeyPressed||this._state!==g.State.PAN||this.isCurrentViewpoint()&&this._changeState(g.State.ROTATE):this._middleButtonPressed&&s===l.KeyboardKey.CTRL&&!this.lockNativeBehaviorOnMouseMiddleTriggers&&this._changeState(g.State.ZOOM)}o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this,"TrackballControls","UpdateControlKeys",{ctrl:this._ctrlKeyPressed,shift:this._shiftKeyPressed})}else if("Mouse"===r){if(this.lockMouse)continue;var h=i.button;if(n===l.State.BEGIN){var c=!1;if(h!==l.MouseButton.MIDDLE&&h!==l.MouseButton.WHEEL||!i.isInView(this.manipulatedViewList)||(c=!0,i.getJSEvent().stopPropagation&&i.getJSEvent().stopPropagation()),h===l.MouseButton.WHEEL&&this._mode>0&&i.isInView(this.manipulatedViewList)&&this._state!==g.State.STOP&&this._mouseWheel(i),!c||h===l.MouseButton.WHEEL&&this._mode===g.Mode.CATIA){if(c&&!this.lockPreventDefaultForCtrlKeyWheel&&h===l.MouseButton.WHEEL){var d=i.getJSEvent();d&&!0===d.ctrlKey&&UWA.Event.preventDefault(i.getJSEvent())}}else UWA.Event.preventDefault(i.getJSEvent())}else n===l.State.MOVE&&i.offsetPosition.length()>this._clickTolerancy&&(h===l.MouseButton.LEFT&&this._leftButtonPressed&&(this._leftClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelLeftClick"),this.resetLeftClick()),h===l.MouseButton.MIDDLE&&this._middleButtonPressed&&(this._middleClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelMiddleClick"),this._middleClicking=!1),h===l.MouseButton.RIGHT&&this._rightButtonPressed&&(this._rightClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelRightClick"),this._rightClicking=!1))}}},g.prototype._onEditEventBegin=function(e){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){var i=t instanceof h;if(this._mode>0||i){var r=t.getCurrentPosition(this.domElement),n=i?80:40;this._setPositionSpinner(this.ShortHoldSpinner,r,n),this._shortHoldCircleAnim=this._showSpinner(this.ShortHoldSpinner,this.SVGCircle,n,6)}}},g.prototype._onEditEventKO=function(e){this._hideSpinner(this.ShortHoldSpinner,this._shortHoldCircleAnim)},g.prototype._onLeftMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}var r=t.isInView(this.manipulatedViewList);if(this._publishWUXEvent("PrimaryPointerDown",e,!1),this._leftButtonPressed=!0,this.startLeftClick(),this.isCurrentViewpoint()){this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas));var n=this._forcePan||this._forceRotate||this._forceZoom;this._state===g.State.STOP||this._state===g.State.HOLD&&!n?this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&this.viewer.leftMouseDownCB(t,this):(r&&n&&(this._state===g.State.NONE||this._state===g.State.HOLD)?(this._setCapture(),this._forcePan?this._changeState(g.State.FORCE_PAN):this._forceRotate?this._changeState(g.State.FORCE_ROTATE):this._forceZoom&&this._changeState(g.State.FORCE_ZOOM)):this._2DMode&&this._mode>0?r&&(this._setCapture(),this._changeState(g.State.PAN)):this._mode===g.Mode.SIMPLE?r&&!this.lockMouseRotationForSimpleMode&&(this._setCapture(),this._changeState(g.State.ROTATE)):this._mode===g.Mode.LOOKAROUND?r&&(this._setCapture(),this._changeState(g.State.ROTATE)):(this._state!==g.State.PAN&&this._state!==g.State.ZOOM||(r&&this._setCapture(),this._changeState(g.State.ROTATE)),this._mode===g.Mode.CATIA&&this.viewer.trapSelection&&this.viewer.trapSelection.interrupt(),this._mode!==g.Mode.COMBINED||!r||this.lockRotation||this.lockMouseRotationForSimpleMode||(this._setCapture(),this._changeState(g.State.ROTATE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&(this.viewer.leftMouseDownCB(t,this),this.viewer.trapSelection&&n&&this.viewer.trapSelection.softInterrupt()),this.tagEventIfModeNotNONE(e))}}}},g.prototype._onMiddleMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._middleButtonPressed=!0,this._middleClicking=!0,this.isCurrentViewpoint()&&(this._state!==g.State.STOP&&this._state!==g.State.HOLD?(this._mode>0?this._changeState(g.State.PAN):this._state===g.State.NONE&&(this._leftButtonPressed||this._rightButtonPressed||(this._ctrlKeyPressed&&!this.lockNativeBehaviorOnMouseMiddleTriggers?this._changeState(g.State.ZOOM):this._changeState(g.State.PAN))),this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this))}}},g.prototype._onRightMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._rightClicking=!0,this._rightButtonPressed=!0,this.isCurrentViewpoint()&&(this._rotationAroundPoint&&this._middleButtonPressed&&(this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas))),this._state!==g.State.STOP&&this._state!==g.State.HOLD&&(this._mode===g.Mode.LOOKAROUND?this._changeState(g.State.ZOOM):this._mode>0&&this._state===g.State.NONE?t.isInView(this.manipulatedViewList)&&this._changeState(g.State.ZOOM):this._state!==g.State.PAN&&this._state!==g.State.ZOOM||this._changeState(g.State.ROTATE),this.tagEventIfModeNotNONE(e)))}}},g.prototype._onLeftMouseUp=function(e){if(this.handleRecordData(e))return this._leftButtonPressed=!1,void(this._mouseDownPos=null);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._publishWUXEvent("PrimaryPointerUp",e,!1),this._leftButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===g.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),void this.resetLeftClick();this._state===g.State.FORCE_PAN||this._state===g.State.FORCE_ROTATE||this._state===g.State.FORCE_ZOOM||this._mode===g.Mode.SIMPLE||this._2DMode&&this._mode===g.Mode.COMBINED||this._state===g.State.HOLD?this._changeState(g.State.NONE):this._state===g.State.ROTATE&&(this._mode===g.Mode.CATIA||this._mode===g.Mode.COMBINED&&this._middleButtonPressed?this._rightButtonPressed||this._changeState(g.State.ZOOM):(this._mode===g.Mode.LOOKAROUND?this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this._finalizeTurnHeadLockWorldUpVector&&this._finalizeTurnHeadLockWorldUpVector(t,!1):this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(g.State.NONE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this._mouseDownPos=null,this.tagEventIfModeNotNONE(e)}else this.resetLeftClick()}}},g.prototype._onMiddleMouseUp=function(e){if(this.handleRecordData(e))return this._middleButtonPressed=!1,void(this._middleClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}this._releaseCapture();var r=t.isInView(this.manipulatedViewList);if(this._middleButtonPressed=!1,this.isCurrentViewpoint()){if(t.currentTime-t.startTime>300&&(this._middleClicking=!1),this._state===g.State.STOP)return r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),void(this._middleClicking=!1);this._changeState(g.State.NONE),r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e)}else this._middleClicking=!1}}},g.prototype._onRightMouseUp=function(e){if(this.handleRecordData(e))return this._rightButtonPressed=!1,void(this._rightClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._rightButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===g.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),void(this._rightClicking=!1);this._mode>0&&this._state===g.State.ZOOM?this._mode===g.Mode.LOOKAROUND&&this._middleButtonPressed&&!this._leftButtonPressed||this._changeState(g.State.NONE):this._state===g.State.HOLD?this._changeState(g.State.NONE):this._state===g.State.ROTATE&&(this._mode===g.Mode.CATIA||this._mode===g.Mode.COMBINED&&this._middleButtonPressed?this._leftButtonPressed||this._changeState(g.State.ZOOM):(this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(g.State.NONE),this.endRotate())),this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),this._rightClicking=!1,this.tagEventIfModeNotNONE(e)}else this._rightClicking=!1}}},g.prototype._onMouseMove=function(e){if(this.handleRecordData(e))return;if(this.lockMouse)return;var t=e.from&&e.from.length?e.from[0]:null;if(null===t)return;let i=2==this._isFromTrackPad(t.getJSEvent());if(this._trackPadData.autoState!=i&&(this._trackPadData.fAutoCb&&this._trackPadData.fAutoCb(i),this._trackPadData.autoState=i),this._state===g.State.STOP||this._state===g.State.NONE||t.event._simul||0!==t.event.buttons||this._changeState(g.State.NONE),this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint()){if(this._state!==g.State.STOP&&this._state!==g.State.HOLD){for(var r=t.getCurrentPosition(this.domElement),n=t.getLastPosition(this.domElement),s=0;s<e.from.length;s++){var a=e.from[s];if(a.getButton&&a.getButton()!==l.MouseButton.NONE){r=a.getCurrentPosition(this.domElement),n=a.getLastPosition(this.domElement);break}}if(!d.isReplaying())if(this.lockPan||this._state!==g.State.PAN&&this._state!==g.State.FORCE_PAN)if(this.lockRotation||this.lockMouseRotation||this._state!==g.State.ROTATE&&this._state!==g.State.FORCE_ROTATE){if(!this.lockZoom&&(this._state===g.State.ZOOM||this._state===g.State.FORCE_ZOOM)){var o={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:o,context:this}),o.defaultBehavior)if(this._mode===g.Mode.LOOKAROUND){var h=this._getZoomFOVOnCursorFactorForOnePointer(r,n);this._zoomFOVOnCursor(null,h<0,180*h/Math.PI)}else this._zoom(r,n)}}else{var c={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:c,context:this}),c.defaultBehavior&&(this._mode===g.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(r.x-n.x,r.y-n.y,t):this._rotationAroundPoint?this._rotateAroundPoint(r,n):this.lockZ?this._rotateLockWorldUpVector(r.x-n.x,r.y-n.y):this._rotate(r,n))}else{var u={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:u,context:this}),u.defaultBehavior&&this._pan(r,n)}this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this.tagEventIfModeNotNONE(e)}else this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this)}},g.prototype._onMouseOut=function(e){if(!this.handleRecordData(e)&&!this.lockMouse&&(this._leftButtonPressed=!1,this._rightButtonPressed=!1,this._middleButtonPressed=!1,this.isCurrentViewpoint())){var t=e.from&&e.from.length?e.from[0]:null;if(t){var i=t.getJSEvent(),r=i.target;if(r||(r=i.srcElement),r!==this.viewer.canvas)return;for(var n=i.toElement;n;){if(n===this.viewer.divCssElement)return;n=n.parentNode}}this._state!==g.State.STOP&&this._changeState(g.State.NONE),this.tagEventIfModeNotNONE(e)}},g.prototype._onTrackPadDragTwoFingers=function(e){var i=e?e.getJSEvent():null;if(!i)return!1;if(i.ctrlKey)return!0;var r=this;let n=0,s=0,a=1;return r._trackPadData&&r._trackPadData.scrollDir?a=r._trackPadData.scrollDir:this.isMac&&(a=-1),"DOMMouseScroll"==i.type||("mousewheel"!=i.type&&"wheel"!=i.type||(n=i.deltaX*a,s=i.deltaY*a),i.shiftKey&&0===n&&([n,s]=[s,n]),i.deltaMode===WheelEvent.DOM_DELTA_LINE?(n*=8,s*=8):i.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(n*=24,s*=24),r._trackPadData.isActive?(r._trackPadData.postion.x=r._trackPadData.positionPrev.x+n,r._trackPadData.postion.y=r._trackPadData.positionPrev.y+s,r._pan(r._trackPadData.postion,r._trackPadData.positionPrev),r._trackPadData.positionPrev.x=r._trackPadData.postion.x,r._trackPadData.positionPrev.y=r._trackPadData.postion.y):(r._trackPadData.postion||(r._trackPadData.postion=new t.Vector2(0,0)),r._trackPadData.postion.x=i.x+n,r._trackPadData.postion.y=i.y+s,r._trackPadData.positionPrev||(r._trackPadData.positionPrev=new t.Vector2(0,0),r._trackPadData.positionPrev.x=r._trackPadData.postion.x,r._trackPadData.positionPrev.y=r._trackPadData.postion.y),r._trackPadData.dummycmd||(r._trackPadData.dummycmd={end:function(e){}}),r.startPan(r._trackPadData.dummycmd),r._trackPadData.isActive=!0),clearTimeout(this._DummyTimer),this._DummyTimer=setTimeout((function(){r.endPan(),r._trackPadData.isActive=!1}),100),!1)},g.prototype.setTrackPadSupport=function(e,t=null,i=null){this.isCurrentViewpoint()&&this.viewpoint&&"COMBINED"==this.viewpoint.getDefaultController()&&(this._trackPadData.isOnOffAuto=this._panWithTrackPadSupport(e),t&&"number"==typeof t&&(this._trackPadData.scrollDir=t),(this._trackPadData.fAutoCb=i)&&this._trackPadData.fAutoCb(this._trackPadData.isActive))},g.prototype._onSwipe=function(e){if(!this.handleRecordData(e)&&!this.lockTouch){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t&&(this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint()&&(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this._state!==g.State.STOP&&this._state!==g.State.HOLD))){var i=t.currentPosition,r=t.lastPosition;if(this.lockPan||this._state!==g.State.FORCE_PAN)if(this.lockRotation||this.lockTouchRotation||this._state!==g.State.ROTATE&&this._state!==g.State.FORCE_ROTATE){if(!this.lockZoom&&this._state===g.State.FORCE_ZOOM){var n={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:n,context:this}),n.defaultBehavior)if(this._mode===g.Mode.LOOKAROUND){var s=this._getZoomFOVOnCursorFactorForOnePointer(i,r);this._zoomFOVOnCursor(null,s<0,180*s/Math.PI)}else this._zoom(i,r)}}else{var a={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:a,context:this}),a.defaultBehavior&&(this._mode===g.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(i.x-r.x,i.y-r.y,t):this._rotationAroundPoint?this._rotateAroundPoint(i,r):this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable?this._rotateLockWorldUpVector(i.x-r.x,i.y-r.y):this._rotate(i,r))}else{var o={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:o,context:this}),o.defaultBehavior&&this._pan(i,r)}this.tagEventIfModeNotNONE(e)}}},g.prototype._onTap=function(e){if(!this.handleRecordData(e)&&!this.lockTouch){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this.startLeftClick(),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this.tagEventIfModeNotNONE(e))}},g.prototype._onDoubleTap=function(e){if(!this.handleRecordData(e)&&!this.lockTouch){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this._middleClicking=!0,this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e))}},g.prototype._onDoublePinchTap=function(e){if(!this.handleRecordData(e)&&!this.lockTouch&&!this.lockReframe){var t=e.gesture.getEvents();if(t.length&&this.isCurrentViewpoint()&&this._state!==g.State.STOP){this._stopRotation();var i=this.viewer.getMousePosition(t[0].currentPosition),r=this.viewer.pick(i,"mesh",!1),n=null;if(r.length){var s=r.path[0]._getRenderableOccurrences();s.length&&(n=s[0])}this.viewpoint.reframe(null,void 0,n),this.tagEventIfModeNotNONE(e)}}},g.prototype._onHold=function(e){this.handleRecordData(e)||this.lockTouch||this.isCurrentViewpoint()&&((2===o.debugEvents||o.debugEvents>=4)&&console.log(data),this.tagEventIfModeNotNONE(e))},g.prototype._onStopManip=function(e){this.handleRecordData(e)||this.lockTouch||this._blockVptOnHold&&this.isCurrentViewpoint()&&(this._state!==g.State.STOP&&this._state!==g.State.FORCE_PAN&&this._state!==g.State.FORCE_ZOOM&&this._state!==g.State.FORCE_ROTATE&&this._changeState(g.State.HOLD),this.tagEventIfModeNotNONE(e))},g.prototype._onPinchPanRotate=function(e,t){if(!this.handleRecordData(e)&&!this.lockTouch){var i=e.gesture;this.isCurrentViewpoint()&&this._state!==g.State.HOLD&&this._state!==g.State.STOP&&"end"!==e.state&&(this._changeState(g.State.ZOOM_PAN_ROTATE),this._zoomPanRotate(i,t),this.tagEventIfModeNotNONE(e))}},g.prototype._onTouch=function(e){if(!this.handleRecordData(e)&&!this.lockTouch&&(this._publishWUXEvent("PrimaryPointerDown",e,!1),this.isCurrentViewpoint()&&this._state!==g.State.HOLD&&this._state!==g.State.STOP)){if(this._rotationAroundPoint){let t=e.from&&e.from.length?e.from[0]:null;t&&(this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas)),this._touchPos={xPix:t.currentPosition.x,yPix:t.currentPosition.y})}this._forcePan?this._changeState(g.State.FORCE_PAN):this._forceRotate?this._changeState(g.State.FORCE_ROTATE):this._forceZoom?this._changeState(g.State.FORCE_ZOOM):this.lockRotation||this.lockTouchRotation||this._changeState(g.State.ROTATE),this.tagEventIfModeNotNONE(e)}},g.prototype._onRelease=function(e){if(!this.handleRecordData(e)&&!this.lockTouch){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&(this._publishWUXEvent("PrimaryPointerUp",e,!1),this.isCurrentViewpoint()&&(this._state!==g.State.STOP?(this._state!==g.State.ROTATE&&this._state!==g.State.ZOOM_PAN_ROTATE||(this._mode===g.Mode.LOOKAROUND?this._finalizeTurnHeadLockWorldUpVector(t,!0):this.touchInertia&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!0)),this._state===g.State.HOLD&&this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this._rotationAroundPoint&&(this._mouseDownPos=null,this._touchPos=null),this._changeState(g.State.NONE),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this)))}},g.prototype._publishWUXEvent=function(e,t,i){var r={eventChannel:"/VISU/",eventType:"@on"+e,eventID:"",from:t.from};s.publish({event:"/VISU/on"+e,data:r}),(!i&&(2===o.debugEvents||o.debugEvents>=4)||i&&o.debugEvents>=3)&&console.log(r)},g.prototype._createShortHoldSpinner=function(e,t){var i=this.currentDocument.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("id","svgNode"),i.style.position="absolute",i.style.top=0,i.style.left=0,i.style.right=0,i.style.bottom=0,i.style.setProperty("pointer-events","none"),i.style.setProperty("z-index",1e4);var r=this.currentDocument.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("id","svgCircle"),r.setAttribute("fill","none"),r.style.fill="none",r.style.stroke=t,r.style.setProperty("stroke-linecap","square"),e?(this.SVGCircle=r,this.ShortHoldSpinner=i):(this.SVGCircleLarge=r,this.ShortHoldSpinnerLarge=i),i.appendChild(r),this.viewer.div.appendChild(i)},g.prototype._showSpinner=function(e,t,i,r){var s=i-.5*r;e.style.display="block",e.setAttribute("width",2*i+"px"),e.setAttribute("height",2*i+"px"),t.setAttribute("cx",i),t.setAttribute("cy",i),t.setAttribute("r",s),t.setAttribute("transform","rotate(-90, "+i+","+i+")"),t.style.setProperty("stroke-width",r),t.style.setProperty("stroke-dasharray",2*Math.PI*s+1),t.style.setProperty("stroke-dashoffset",2*Math.PI*s+1);var a=!0,l=2*Math.PI*s+1,h=new n({circle:t,setOffset:function(t){t===l?a&&(e.style.display="none",a=!1):(a||(e.style.display="block",a=!0),this.circle.style.setProperty("stroke-dashoffset",t))}},"setOffset",new function(e,t,i,r,n){this._nbLoops=1,this._duration=i,this.duration=function(){return this._duration},this.valueAt=function(i){var s=this._duration,a=i%s/s;if(a>=0&&a<r)return e;if(a<1-n){var o=(a-r)/(1-r-n);return e*(1-o)+t*o}return t}}(l,0,1.2*o.getHoldTime(),.6,0));return h.start(),h},g.prototype._hideSpinner=function(e,t){t&&t.stop(),e.style.display="none"},g.prototype._setPositionSpinner=function(e,t,i){e.style.left=t.x-i+"px",e.style.top=t.y-i+"px"},g.prototype._createRotationPointElem=function(){let e=this.currentDocument.createElement("div");e.setAttribute("id","rotationPoint"),e.setAttribute("style","background: #ff0000;  border-radius: 50%;  width: 6px;  height: 6px;  position: absolute;  left: 50%;  top: 50%;  opacity: 1;  box-shadow: 0 0 2px 2px #f8f8ff;"),e.style.setProperty("pointer-events","none"),this.rotationPointElem=e,this.viewer.div.appendChild(e),this._hideRotationPointElem()},g.prototype._showRotationPointElem=function(){this.rotationPointElem&&(this.rotationPointElem.style.display="block",this._rotationAroundPointTarget.isShown=!0,this._showRotationPointOnMove=!1)},g.prototype._hideRotationPointElem=function(){this.rotationPointElem&&(this.rotationPointElem.style.display="none",this._rotationAroundPointTarget.isShown=!1,this._showRotationPointOnMove=!1)},g.prototype._retieveRotationPointTarget=function(){if(!this.rotationPointElem||!this._mouseDownPos)return;this._rotationAroundPointTarget.dim2=this._mouseDownPos;let e=this.viewer.pick(this._rotationAroundPointTarget.dim2,"mesh",!0);if(e&&e.path.length>0&&e.position){this._rotationAroundPointTarget.dim3=e.position,this._rotationAroundPointTarget.isSet=!0;let t=this._touchPos?this._touchPos.xPix:this._rotationAroundPointTarget.dim2.xPix,i=this._touchPos?this._touchPos.yPix:this._rotationAroundPointTarget.dim2.yPix;this.rotationPointElem.style.left=t-parseInt(this.rotationPointElem.style.width)/2+"px",this.rotationPointElem.style.top=i-parseInt(this.rotationPointElem.style.height)/2+"px"}else this._rotationAroundPointTarget.isSet=!1,this._rotationAroundPointTarget.dim3=null;return this._rotationAroundPointTarget.isSet},g.prototype._setRotationPointElem=function(e){!0===e?this._showRotationPointElem():this._hideRotationPointElem()},g.prototype._setCursor=function(t){var i="auto";if("Auto"!==t){var r=e.getWebappsAssetUrl("Visualization","")+"icons/";i="url('"+r+"WebViewer"+t+".png'), url('"+r+"WebViewer"+t+".cur'), auto"}this.viewer.canvas.style.cursor=i},g.prototype.tagEventIfModeNotNONE=function(e){d.isRecording()&&this._state!==g.State.NONE&&e.gesture&&(e.gesture.highLevelRecordJSON||(e.gesture.highLevelRecordJSON={}),e.gesture.highLevelRecordJSON.TrackBallControls={ignore:!0})},g.prototype.handleRecordData=function(e){if(d.isReplaying()&&this.testRecordMoveViewpoint(e))return!0},g.prototype.getRecordData=function(e,t){var i=e.gesture&&e.gesture.highLevelRecordJSON&&e.gesture.highLevelRecordJSON.TrackBallControls;return i&&(!i.name||i.name===this._recordRegisterName)&&i[t]},g.prototype.testRecordMoveViewpoint=function(e){if(this.getRecordData(e,"setViewPoint")){var t=this.getRecordData(e,"setViewPoint");return this.setPositionFromJSON(t),this.viewer.render(),!0}return!1},g.prototype.positionToJSON=function(){return{target:this.target.createJSON(),orientation:this.orientation.createJSON(),distanceToTarget:this.distanceToTarget}},g.prototype.setPositionFromJSON=function(e){this.target.setFromJSON(e.target),this.orientation.setFromJSON(e.orientation),this.distanceToTarget=e.distanceToTarget},g.prototype.setFlyWalkState=function(e){e?(this._flyWalkStateInfo.oldControlState=this._state,this._flyWalkStateInfo.forceStopRequests||this._changeState(g.State.STOP)):this._flyWalkStateInfo.bActive&&this._changeState(this._flyWalkStateInfo.oldControlState),this._flyWalkStateInfo.bActive=!!e},g.prototype.setForceFlyWalkState=function(e){e?(this._flyWalkStateInfo.forceStopRequests++,this._flyWalkStateInfo.bActive&&1===this._flyWalkStateInfo.forceStopRequests&&this._changeState(this._flyWalkStateInfo.oldControlState)):(this._flyWalkStateInfo.forceStopRequests--,this._flyWalkStateInfo.bActive&&!this._flyWalkStateInfo.forceStopRequests&&(this._flyWalkStateInfo.oldControlState=this._state,this._changeState(g.State.STOP)))},g.prototype.isFlyWalkForcedStop=function(){return this._flyWalkStateInfo.forceStopRequests>0},g.prototype.getFlyWalkStateInfo=function(){return this._flyWalkStateInfo},g.prototype._switchCanvas=function(e){var t=this.domElement;t.removeEventListener("contextmenu",this._onContextMenu,!1),t.removeEventListener("dragover",this._onDragCB),this.removeViewFromManipulation(t),o.removeEvent(t,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(t,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(t,"onHold",this._onHoldCB),o.removeEvent(t,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(t,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(t,"onHold",this._onHoldCB),this.removeViewFromGestures(t),e.addEventListener("contextmenu",this._onContextMenu,!1),e.addEventListener("dragover",this._onDragCB),this.addViewToManipulation(e),o.addEvent(e,"onDoubleTap",this._onDoubleTapCB),o.addEvent(e,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(e,"onHold",this._onHoldCB),o.addEvent(e,"onDoubleTap",this._onDoubleTapCB),o.addEvent(e,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(e,"onHold",this._onHoldCB),this.addViewToGestures(e),this.domElement=e},g.prototype.setInvertHeadRotationActive=function(e){this._invertHeadRotation=!!e},g.prototype.getInvertHeadRotationActive=function(){return this._invertHeadRotation},g})),define("Visualization/TrackballControls",["DS/Visualization/TrackballControls","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/TrackballControls"),e})),define("DS/Visualization/WorldOrientation",["DS/Visualization/ThreeJS_DS","DS/Visualization/JSONSettings","DS/VisuMePreferences/MePreferences"],(function(e,t,i){var r=function(r){this._woName=r.name,this.upVector=r.upVector,this.rightVector=r.rightVector,this.frontVector=(new e.Vector3).crossVectors(this.rightVector,this.upVector),this.fromZUpMatrix=r.fromZUpMatrix,this.upAttribute=r.upAttribute,this.rightAttribute=r.rightAttribute,this.frontAttribute=r.frontAttribute,this._anglesOrderForLockedRotation=r.anglesOrderForLockedRotation,this._eulerOrderForReframe=r.eulerOrderForReframe,this._defaultViewsSettings=t.getDefaultViewSettings();let n=this;this._mePreferenceToken=i.subscribe(i.PREFERENCES.DEFAULTVIEWS,(function(e){n._defaultViewsSettings=e}))};return r.prototype.getOrientationForLockedRotation=function(t,i,r){var n=this.upAttribute,s=this.rightAttribute,a=this.frontAttribute,o=this._anglesOrderForLockedRotation,l=(new e.Matrix4).makeRotationFromQuaternion(r),h=(new e.Vector3).setEulerFromRotationMatrix(l,o);return h[n]-=t,"y"===n?(h[s]-=i,h[a]=0):"z"===n&&(h[a]-=i,h[s]=0),(new e.Quaternion).setFromEuler(h,o)},r.prototype.getAxisForSideRotation=function(t){var i=new e.Vector3,r=this._eulerOrderForReframe;if("ZXY"!==r&&"YZX"!==r)throw"Unsupported euler order";return"right"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,Math.PI):"YZX"===r&&(i=new e.Vector3(0,.5*Math.PI,0)):"left"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,0):"YZX"===r&&(i=new e.Vector3(0,-.5*Math.PI,0)):"top"===t?"ZXY"===r?i=new e.Vector3(0,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(-.5*Math.PI,0,0)):"bottom"===t?"ZXY"===r?i=new e.Vector3(Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(.5*Math.PI,0,0)):"front"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,0,0)):"back"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,-.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,-Math.PI,0)):"iso"===t&&("ZXY"===r?i=new e.Vector3(.35*Math.PI,0,.75*Math.PI):"YZX"===r&&(i=new e.Vector3(-.15*Math.PI,.25*Math.PI,0))),i},r.prototype.getMatrixForSideRotation=function(t){var i=new e.Vector3,r=new e.Vector3,n=new e.Vector3(0,0,1),s=new e.Matrix4,a=new e.Vector3(0,0,0),o=this._eulerOrderForReframe;if("ZXY"!==o&&"YZX"!==o)throw"Unsupported euler order";if(null==this._defaultViewsSettings||null==this._defaultViewsSettings.right||null==this._defaultViewsSettings.left||null==this._defaultViewsSettings.top||null==this._defaultViewsSettings.bottom||null==this._defaultViewsSettings.front||null==this._defaultViewsSettings.back||null==this._defaultViewsSettings.iso)return null;try{"right"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.right.right),r=(new e.Vector3).copy(this._defaultViewsSettings.right.sight)),n=(new e.Vector3).crossVectors(i,r)):"left"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.left.right),r=(new e.Vector3).copy(this._defaultViewsSettings.left.sight)),n=(new e.Vector3).crossVectors(i,r)):"top"===t?this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.top.right),r=(new e.Vector3).copy(this._defaultViewsSettings.top.sight),n=(new e.Vector3).crossVectors(i,r)):"bottom"===t?this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.bottom.right),r=(new e.Vector3).copy(this._defaultViewsSettings.bottom.sight),n=(new e.Vector3).crossVectors(i,r)):"front"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.front.right),r=(new e.Vector3).copy(this._defaultViewsSettings.front.sight)),n=(new e.Vector3).crossVectors(i,r)):"back"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.back.right),r=(new e.Vector3).copy(this._defaultViewsSettings.back.sight)),n=(new e.Vector3).crossVectors(i,r)):"iso"===t&&(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.iso.right),r=(new e.Vector3).copy(this._defaultViewsSettings.iso.sight)),n=(new e.Vector3).crossVectors(i,r))}catch(e){return console.warn("Error while parsing view json"),null}s.lookAt(a,r,n);var l=(new e.Matrix4).copy(s);return"YZX"===o&&(l=(new e.Matrix4).copy(this.fromZUpMatrix)).multiply(s),l},r.prototype.setCustomViewSettings=function(e){this._defaultViewsSettings=e},r.prototype.buildSnapRobotMatrix=function(e){return"zup"===this._woName?this.buildSnapRobotMatrix_zup(e):"yup"===this._woName?this.buildSnapRobotMatrix_yup(e):void 0},r.prototype.buildSnapRobotMatrix_zup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(1,0,0).projectOnPlane(r),s=n.length(),a=new e.Vector3(0,1,0).projectOnPlane(r),o=a.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,0,1),r),h=new e.Vector3(0,0,1).dot(r);return Math.abs(h)>.999?Math.abs(s-o)<5e-4?(n.normalize(),a.normalize()):s<o?((a=new e.Vector3(0,1,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(a,r).normalize()):((n=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(n.x,a.x,r.x,0,n.y,a.y,r.y,0,n.z,a.z,r.z,0,0,0,0,1)).setPosition(t.position),i},r.prototype.buildSnapRobotMatrix_yup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(0,0,1).projectOnPlane(r),s=n.length(),a=new e.Vector3(1,0,0).projectOnPlane(r),o=a.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,1,0),r),h=new e.Vector3(0,1,0).dot(r);return Math.abs(h)>.999?Math.abs(s-o)<5e-4?(n.normalize(),a.normalize()):s<o?((a=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(a,r).normalize()):((n=new e.Vector3(0,0,1).projectOnPlane(r)).normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(a.x,r.x,n.x,0,a.y,r.y,n.y,0,a.z,r.z,n.z,0,0,0,0,1)).setPosition(t.position),i},{YUpXRight:new r({name:"yup",upVector:new e.Vector3(0,1,0),rightVector:new e.Vector3(1,0,0),fromZUpMatrix:(new e.Matrix4).setRotationFromEuler(new e.Vector3(-Math.PI/2,0,-Math.PI/2),"XYZ"),upAttribute:"y",rightAttribute:"x",frontAttribute:"z",anglesOrderForLockedRotation:"YZX",eulerOrderForReframe:"YZX"}),ZUpYRight:new r({name:"zup",upVector:new e.Vector3(0,0,1),rightVector:new e.Vector3(0,1,0),fromZUpMatrix:new e.Matrix4,upAttribute:"z",rightAttribute:"y",frontAttribute:"x",anglesOrderForLockedRotation:"ZYX",eulerOrderForReframe:"ZXY"})}})),define("DS/Visualization/RenderTargetPool",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";const t=e.WebGPURenderTarget,i=e.WebGPURenderTargetCube,r=e.WebGLRenderTarget,n=e.WebGLRenderTargetCube;class s{constructor(){this.type="webgl",this.renderTargetPool=[],this.rtpStats={nbCreation:0},this.renderTargetClass=null,this.renderTargetCubeClass=null}areRenderTargetOptionsEqual(e,t){return e&&t?e.height===t.height&&e.width===t.width&&e.options===t.options:e===t}dumpPool(){var e,t="dumpPool: [";for(e=0;e<this.renderTargetPool.length;e++)e>0&&(t+=", "),t+=this.renderTargetPool[e].uniqueID;t+="]",console.log(t)}resetRenderTargetPool(e=null){if(e){for(var t=0;t<this.renderTargetPool.length;t++)e(this.renderTargetPool[t])&&this.renderTargetPool[t].dispose();this.renderTargetPool=this.renderTargetPool.filter((e=>!e._disposed))}else{for(t=0;t<this.renderTargetPool.length;t++)this.renderTargetPool[t].dispose();this.renderTargetPool=[]}}pushRenderTarget(e,t){if(e){for(var i=!1,r=0;r<this.renderTargetPool.length;r++)this.renderTargetPool[r].uniqueID==e.uniqueID&&(i=!0);i||this.renderTargetPool.push(e)}}buildRenderTarget(e,t,i,r,n,s){var a,o,l=this.rtOptionsMap[i],h=null,c=-1,d=r||1;for(n="webgpu"===this.type&&!!n,s="webgpu"===this.type&&!!s,o=0;o<this.renderTargetPool.length&&c<0;o++)(a=this.rtOptionsMap[this.renderTargetPool[o].optionsId])&&a.type===l.type&&i===this.renderTargetPool[o].optionsId&&this.renderTargetPool[o].width===e&&this.renderTargetPool[o].height===t&&this.renderTargetPool[o].multisample===n&&this.renderTargetPool[o].depthSampled===s&&this.renderTargetPool[o].colorCount===d&&((h=this.renderTargetPool[o]).passIsLastMultisampled=!1,h.reset(l),c=o);return c>=0&&this.renderTargetPool.splice(c,1),h||(h="cubelinear"===i?new this.renderTargetCubeClass(e,t,l,1,n):new this.renderTargetClass(e,t,l,d,n,s),e>0&&t>0&&this.rtpStats.nbCreation++),h.optionsId=i,h}}class a extends s{constructor(r){super(),this.type="webgpu",this.renderTargetClass=t,this.renderTargetCubeClass=i,this._screenRenderTarget=null,this._formats=new Map;let n=new Map,s=new Map,a=new Map;this._formats.set("float",n),this._formats.set("float16",s),this._formats.set("int8",a),n.set("RGBA","rgba32float"),s.set("RGBA","rgba16float"),a.set("RGBA","rgba8unorm"),a.set("BGRA","bgra8unorm"),a.set("RGB","rgba8unorm"),a.set("R","r8unorm"),a.set("RG","rg8unorm");var o="float",l="float16",h="float",c=e._mobileDevice?"float16":"float";this.rtOptionsMap={linear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get(l).get("RGBA"),type:o},nearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get(o).get("RGBA"),type:o},maxPrecisionLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get(h).get("RGBA"),type:h},maxPrecisionNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get(h).get("RGBA"),type:h},halfLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get(l).get("RGBA"),type:l},halfNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get(l).get("RGBA"),type:l},uint:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGBA"),type:"int8"},uintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGBA"),type:"int8"},uintRGBLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGB"),type:"int8"},uintRGBLinearNoStencil:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGB"),type:"int8"},uintRGBNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGB"),type:"int8"},uintRGBNearestNoStencil:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGB"),type:"int8"},cubelinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get(o).get("RGBA"),type:o},decal:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get(h).get("RGBA"),type:h},decalTex:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get(h).get("RGBA"),type:h},maxPrecisionLinearNoStencilHFMobile:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get(c).get("RGBA"),type:c},iblUintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGBA"),type:"int8"},iblUintLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGBA"),type:"int8"},iblHFNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get(l).get("RGBA"),type:l},iblHFLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get(l).get("RGBA"),type:l},oitAccumLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get(l).get("RGBA"),type:l},oitRevealLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("int8").get("R"),type:"int8"},oitLinkedList:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get(l).get("RGBA"),type:l}}}}class o extends s{constructor(t){super(),this.renderTargetClass=r,this.renderTargetCubeClass=n;var i=e.FloatType,s=e.HalfFloatType,a=e.FloatType,o=e._mobileDevice?e.HalfFloatType:e.FloatType;t.supportsFloatTextures()||(i=e.UnsignedByteType,a=e.HalfFloatType,o=e.HalfFloatType),t.supportsHalfFloatTextures()||(a=e.UnsignedByteType,o=e.UnsignedByteType,s=e.UnsignedByteType),t.supportsFloatTextures()&&!t.supportsHalfFloatTextures()&&(a=e.FloatType,o=e.FloatType,s=e.FloatType),e.IsIE11&&(s=i,a=i,o=i),this.rtOptionsMap={linear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:i},nearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:i},maxPrecisionLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:a},maxPrecisionNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:a},halfLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:s},halfNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:s},uint:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:e.UnsignedByteType},uintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:e.UnsignedByteType},uintRGBLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBFormat,type:e.UnsignedByteType},uintRGBLinearNoStencil:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:e.RGBFormat,type:e.UnsignedByteType},uintRGBNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBFormat,type:e.UnsignedByteType},uintRGBNearestNoStencil:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBFormat,type:e.UnsignedByteType},cubelinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:i},decal:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBAFormat,type:a},decalTex:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBAFormat,type:a},maxPrecisionLinearNoStencilHFMobile:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:e.RGBAFormat,type:o},iblUintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBAFormat,type:e.UnsignedByteType},iblUintLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:e.RGBAFormat,type:e.UnsignedByteType},iblHFNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:(s===e.FloatType?t.supportsFloatRGBTextures():t.supportsHalfFloatRGBTextures())?e.RGBFormat:e.RGBAFormat,type:s},iblHFLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:(s===e.FloatType?t.supportsFloatRGBTextures():t.supportsHalfFloatRGBTextures())?e.RGBFormat:e.RGBAFormat,type:s},oitAccumLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:s},oitRevealLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBFormat,type:e.UnsignedByteType}}}}return{get:function(e){return e.use_webgpu?new a(e):new o(e)},createNewRenderTarget:function(e,i,n,s,a,o){return e.use_webgpu?new t(i,n,s,a,o):new r(i,n,s,a,o)},createNewRenderTargetCube:function(e,t,r,s,a,o){return e.use_webgpu?new i(t,r,s,a,o):new n(t,r,s,a,o)}}})),define("Visualization/RenderTargetPool",["DS/Visualization/RenderTargetPool","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/RenderTargetPool"),e})),define("DS/Visualization/ClippingPolyLineData",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/PolyLineSectionUtils"],(function(e,t){"use strict";function i(e){this.polyLines=null,this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.hasTransform=!1,this.lastFrameIndex=-1,this.lastCamera=null,this.csiMode=!1,e&&this.setParams(e)}function r(){this.transform=!1,this.planeU=null,this.planeV=null,this.points2d=null,this.closedPoints2d=null,this.isOpen=!1,this.viewPlaneU=null,this.viewPlaneV=null,this.viewPoints2d=null,this.matrix=null,this.clockwise=!1}return i.prototype.setParams=function(e){this.polyLines=[],this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.lastFrameIndex=-1,this.lastCamera=null,this.hasTransform=e.csiParams&&e.csiParams.transform||!1,e.csiParams?this.setCSI(e.csiParams):this.setSingle(e)},i.prototype.getForOccurrenceOverride=function(e){if(this.hasTransform){var t,r=new i(null,e);for(r.csiMode=this.csiMode,r.hasOpenPolyLine=this.hasOpenPolyLine,r.polyLines=[],t=0;t<this.polyLines.length;t++)r.polyLines.push(this.polyLines[t].getForOccurrenceOverride(e));return r.hasTransform=this.hasTransform,r}return this},i.prototype.setCSI=function(e){this.csiMode=!0,this.polyLinePoints=[];var t,i=[];for(t=0;t<e.vertexCounts.length;t++)i.push(e.vertexCounts[t]);var r,n=0;e.vertices.length;for(t=0;t<e.curveCount;t++)r=this.createPolyLineFromCSI(e,t,n,i[t]),this.polyLines.push(r),n+=i[t]},i.prototype.createPolyLineFromCSI=function(t,i,n,s){var a,o,l=new e.Vector3(t.normals[3*i],t.normals[3*i+1],t.normals[3*i+2]);l.normalize(),a=new e.Vector3(1,0,0),(o=new e.Vector3(0,0,0)).crossVectors(l,a),o.length()<.001&&(a=new e.Vector3(0,1,0),o.crossVectors(l,a)),o.normalize(),a.crossVectors(o,l);var h,c,d=[],u=new e.Vector3;for(h=0;h<s;h++)c=3*(n+h),u.x=t.vertices[c],u.y=t.vertices[c+1],u.z=t.vertices[c+2],d.push(new e.Vector2(u.dot(a),u.dot(o)));var p=!1;d[0].distanceTo(d[d.length-1])<1e-9?d.splice(d.length-1,1):(this.hasOpenPolyLine=!0,p=!0);var f=new r;return f.set(a,o,new e.Vector3,d,p,t.transform),f},i.prototype.createTexture=function(){this.clippingPolygonTexture&&(this.clippingPolygonTexture.dispose(),this.clippingPolygonTexture=null);var t,i,r=0;for(t=0;t<this.polyLines.length;t++)r+=(i=this.polyLines[t]).viewPoints2d.length;var n,s,a=new Float32Array(4*r),o=0;for(t=0;t<this.polyLines.length;t++)for(s=(i=this.polyLines[t]).viewPoints2d.length,n=0;n<s;n++)a[o]=i.viewPoints2d[n].x,a[o+1]=i.viewPoints2d[n].y,a[o+2]=0,a[o+3]=1,o+=4;this.clippingPolygonTexture=new e.DataTexture(a,r,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this.clippingPolygonTexture.needsUpdate=!0},i.prototype.setSingle=function(t){var i=t.planeOrigin?t.planeOrigin.clone():new e.Vector3,n=t.planeU.clone();n.normalize();var s=t.planeV.clone();s.normalize();var a=new r;a.set(n,s,i,t.polyLinePoints,!1,!1),this.polyLines.push(a)},i.prototype.getMaxSize=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e].getClosedSize();i>t&&(t=i)}return t},i.prototype.updateCamera=function(t,i){if(t!==this.lastCamera||this.lastFrameIndex!==i||!this.clippingPolygonTexture){var r,n=t.matrixWorldInverse,s=null,a=null,o=null;for(r=0;r<this.polyLines.length;r++)(o=this.polyLines[r]).transform?(o.matrix!==a&&((s=new e.Matrix4).multiplyMatrices(t.matrixWorldInverse,o.matrix),a=o.matrix),o.applyViewMatrix(s)):o.applyViewMatrix(n);this.lastCamera=t,this.lastFrameIndex=i,this.clippingPolygonTexture=null}},i.prototype.getTexture=function(e,t){return this.clippingPolygonTexture||this.createTexture(),this.clippingPolygonTexture},i.prototype.needsInvert=function(){if(this.csiMode){let e=this.polyLines[0];return!(!e||!e.clockwise)}return!1},i.prototype.updateBoundingSphere=function(e){var t,i;if(e&&this.hasOpenPolyLine&&(!this.boundingSphere||!e.equals(this.boundingSphere)))for(this.boundingSphere=e.clone(),i=0;i<this.polyLines.length;i++)(t=this.polyLines[i]).isOpen&&(t.applyBoundingSphere(e),this.clippingPolygonTexture=null)},i.prototype.dbgDump=function(){var e,t={count:this.polyLines.length,planeU:[],planeV:[],polyLineSize:[]};for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e];t.planeU.push(i.planeU),t.planeV.push(i.planeV),t.polyLineSize.push(i.points2d.length)}return t},i.prototype.getCount=function(){return this.polyLines.length},i.merge=function(e,t){var r=null;return e&&t?((r=new i(null,null)).csiMode=e.csiMode||t.csiMode,r.polyLines=e.polyLines.concat(t.polyLines),r.hasOpenPolyLine=e.hasOpenPolyLine||t.hasOpenPolyLine,r.hasTransform=e.hasTransform||t.hasTransform):r=e||t,r},r.prototype.set=function(i,r,n,s,a,o){var l;for(this.transform=!!o,this.planeU=i,this.planeV=r,this.points2d=[],l=0;l<s.length;l++)this.points2d.push(new e.Vector2(s[l].x+i.dot(n),s[l].y+r.dot(n)));this.closedPoints2d=a?null:this.points2d,this.isOpen=a,a||(this.clockwise=t.computePolyLineOrientation(s)>0),this.viewPlaneU=new e.Vector3,this.viewPlaneV=new e.Vector3,this.viewPoints2d=[]},r.prototype.getClosedSize=function(){return this.closedPoints2d.length},r.prototype.applyViewMatrix=function(t){if(!this.closedPoints2d)return;this.viewPlaneU.copy(this.planeU),this.viewPlaneV.copy(this.planeV),this.viewPlaneU.applyRotation(t),this.viewPlaneV.applyRotation(t);let i=this.viewPlaneU.length(),r=this.viewPlaneV.length();var n=new e.Vector3;n.applyMatrix4(t),this.viewPoints2d=[];var s,a=new e.Vector2,o=new e.Vector2(n.dot(this.viewPlaneU)/i,n.dot(this.viewPlaneV)/r);for(s=0;s<this.closedPoints2d.length;s++)a=this.closedPoints2d[s],this.viewPoints2d.push(new e.Vector2(o.x+a.x*i,o.y+a.y*r));this.viewPlaneU.divideScalar(i),this.viewPlaneV.divideScalar(r)},r.prototype.applyBoundingSphere=function(i){if(this.isOpen){var r=t.makeClosedPolyLine({planeOrigin:new e.Vector3,planeU:this.planeU,planeV:this.planeV,polyLinePoints:this.points2d},i,!1);this.closedPoints2d=r.polyLinePoints}},r.prototype.getForOccurrenceOverride=function(e){if(e){var t=new r;return t.transform=this.transform,t.planeU=this.planeU,t.planeV=this.planeV,t.points2d=this.points2d,t.closedPoints2d=this.closedPoints2d,t.isOpen=this.isOpen,t.viewPlaneU=this.viewPlaneU,t.viewPlaneV=this.viewPlaneV,t.viewPoints2d=this.viewPoints2d,t.matrix=this.matrix||e,t.clockwise=this.clockwise,t}return this},i})),define("DS/Visualization/GeometryHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],(function(e,t,i){"use strict";var r=document.createElement("canvas");r.width=512,r.height=64;var n=e.extend({init:function(){return this},CreateVis3DCuboid:function(e,r,n,s,a,o,l){var h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.fill=void 0!==o?o:1,this.cornerPoint=void 0!==e?e:new t.Vector3(0,0,0),this.firstAxis=void 0!==r?r:new t.Vector3(1,0,0),this.secondAxis=void 0!==n?n:new t.Vector3(0,1,0),this.thirdAxis=void 0!==s?s:new t.Vector3(0,0,1),this.color=void 0!==a?a:new i.Color(.5,.5,.5,1),P=l||0):(this.fill=void 0!==e.fill?e.fill:1,this.cornerPoint=void 0!==e.cornerPoint?e.cornerPoint:new t.Vector3(0,0,0),this.firstAxis=void 0!==e.firstAxis?e.firstAxis:new t.Vector3(1,0,0),this.secondAxis=void 0!==e.secondAxis?e.secondAxis:new t.Vector3(0,1,0),this.thirdAxis=void 0!==e.thirdAxis?e.thirdAxis:new t.Vector3(0,0,1),this.color=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),P=e.layerNb?e.layerNb:0),(h=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,h.lineAttr=new i.LineAttributes,h.pointAttr=new i.PointAttributes,(c=new i.Buffer).size=24,c.component=i.VertexComponentEnum.POSITION,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(24),(d=new i.Buffer).size=18,d.component=i.VertexComponentEnum.NORMAL,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(18),(u=new i.Buffer).size=12,u.component=i.VertexComponentEnum.TEX_COORD_0,u.format=i.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(12),(p=new i.Buffer).indexBuffer=!0,p.size=24,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(24),(f=new i.Buffer).indexBuffer=!0,f.size=24,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(24),(g=new i.Buffer).indexBuffer=!0,g.size=24,g.format=i.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(24),h.addBuffer(0,c),h.addBuffer(1,d),h.addBuffer(2,u),h.addBuffer(3,p),h.addBuffer(4,f),h.addBuffer(5,g),m=c.data,v=0,(y=new t.Vector3).addVectors(this.cornerPoint,this.thirdAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.add(this.firstAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.add(this.secondAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.addVectors(this.cornerPoint,this.thirdAxis),y.add(this.secondAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.addVectors(this.cornerPoint,this.secondAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.add(this.firstAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.addVectors(this.cornerPoint,this.firstAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,m[v++]=this.cornerPoint.x,m[v++]=this.cornerPoint.y,m[v++]=this.cornerPoint.z,this.fill){for(v=0,_=0,(m=p.data)[v++]=0,m[v++]=1,m[v++]=3,m[v++]=2,m[v++]=4,m[v++]=5,m[v++]=7,m[v++]=6,m[v++]=0,m[v++]=3,m[v++]=7,m[v++]=4,m[v++]=6,m[v++]=5,m[v++]=1,m[v++]=2,m[v++]=5,m[v++]=4,m[v++]=2,m[v++]=3,m[v++]=7,m[v++]=6,m[v++]=0,m[v++]=1,m=f.data,v=0,_=0;_<6;_++)m[v++]=_,m[v++]=_,m[v++]=_,m[v++]=_;for(m=g.data,v=0,_=0;_<6;_++)m[v++]=2,m[v++]=3,m[v++]=0,m[v++]=1,m[v++]=1,m[v++]=0,m[v++]=3,m[v++]=2,m[v++]=3,m[v++]=1,m[v++]=2,m[v++]=0,m[v++]=3,m[v++]=1,m[v++]=2,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=3,m[v++]=2,m[v++]=2,m[v++]=3,m[v++]=0,m[v++]=1;v=0,(m=d.data)[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=-1,m[v++]=-1,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=-1,m[v++]=0,v=0,(m=u.data)[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=1,m[v++]=1,m[v++]=0}else v=0,_=0,(m=p.data)[v++]=0,m[v++]=3,m[v++]=3,m[v++]=2,m[v++]=2,m[v++]=1,m[v++]=1,m[v++]=0,m[v++]=7,m[v++]=4,m[v++]=4,m[v++]=5,m[v++]=5,m[v++]=6,m[v++]=6,m[v++]=7,m[v++]=0,m[v++]=7,m[v++]=3,m[v++]=4,m[v++]=2,m[v++]=5,m[v++]=1,m[v++]=6;for(_=0;_<6;_++)(S=new i.Primitive).nbIndices=4,S.connectivity=this.fill?i.ConnectivityTypeEnum.TRIANGLE_STRIP:i.ConnectivityTypeEnum.LINES,S.attr={fill:new i.FillAttributes(this.color,1),line:new i.LineAttributes,point:new i.PointAttributes},(b=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,b.nbVertices=4,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=0,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=4*_,S.addVertexComponent(b),this.fill&&((x=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=1,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=4,x.indices.offset=4*_,(w=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,w.nbVertices=4,w.nbValuesPerVertex=3,w.format=i.DataTypeEnum.FLOAT,w.cardinality=0,w.bufferId=2,w.indices=new i.IndexArray,w.indices.format=i.DataTypeEnum.UINT,w.indices.bufferId=5,w.indices.offset=4*_,S.addVertexComponent(x),S.addVertexComponent(w)),h.addPrimitive(S);return h.noz=P>0,h},CreateVis3DSphere:function(e,r,n,s,a,o,l,h,c){var d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O,L,B,F,V,G,N,U=!1;for(e instanceof t.Matrix4||void 0===e?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.matrix=void 0!==e?e:null,this.radius=void 0!==r?r:1,this.meridianStart=void 0!==n?n:0,this.meridianEnd=void 0!==s?s:2*Math.PI,this.parallelStart=void 0!==a?a:0,this.parallelEnd=void 0!==o?o:2*Math.PI,this.sag=void 0!==l?l:80,L=void 0!==h?h:new i.Color(.5,.5,.5,1),N=c||0):(this.matrix=void 0!==e.matrix?e.matrix:null,this.radius=void 0!==e.radius?e.radius:1,this.meridianStart=void 0!==e.meridianStart?e.meridianStart:0,this.meridianEnd=void 0!==e.meridianEnd?e.meridianEnd:2*Math.PI,this.parallelStart=void 0!==e.parallelStart?e.parallelStart:0,this.parallelEnd=void 0!==e.parallelEnd?e.parallelEnd:2*Math.PI,this.sag=void 0!==e.sag?e.sag:80,L=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),N=e.layerNb?e.layerNb:0,U=!!e.tgtBinorm&&e.tgtBinorm),this.parallelStart<0&&(this.parallelStart=0),this.parallelStart>Math.PI&&(this.parallelStart=Math.PI),(d=this.parallelEnd-this.parallelStart)<0&&(d=0),this.parallelStart+d>Math.PI&&(d=Math.PI-this.parallelStart),this.meridianStart<0&&(this.meridianStart=0),this.meridianStart>2*Math.PI&&(this.meridianStart=2*Math.PI),(u=this.meridianEnd-this.meridianStart)<0&&(u=0),this.meridianStart+u>2*Math.PI&&(u=2*Math.PI-this.meridianStart),p=3*(this.sag+1)*this.sag,f=6*this.sag*(this.sag-1),(g=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,g.lineAttr=new i.LineAttributes,g.pointAttr=new i.PointAttributes,(m=new i.Buffer).size=3*p,m.component=i.VertexComponentEnum.POSITION,m.format=i.DataTypeEnum.FLOAT,m.dimension=3,m.data=new Float32Array(m.size),(v=new i.Buffer).size=3*p,v.component=i.VertexComponentEnum.NORMAL,v.format=i.DataTypeEnum.FLOAT,v.dimension=3,v.data=new Float32Array(v.size),(_=new i.Buffer).size=3*p,_.component=i.VertexComponentEnum.TEX_COORD_0,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(_.size),U&&((y=new i.Buffer).size=3*p,y.component=i.VertexComponentEnum.TEX_COORD_2,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(y.size),(S=new i.Buffer).size=3*p,S.component=i.VertexComponentEnum.TEX_COORD_3,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(S.size),g.addBuffer(5,y),g.addBuffer(6,S)),(b=new i.Buffer).indexBuffer=!0,b.size=f,b.format=i.DataTypeEnum.UINT,b.dimension=1,b.data=new Uint16Array(b.size),g.addBuffer(0,m),g.addBuffer(1,v),g.addBuffer(2,_),g.addBuffer(3,b),x=b.data,E=0,T=0;T<this.sag-1;T++)for(A=0;A<this.sag;A++)x[E++]=T*(this.sag+1)+A,x[E++]=(T+1)*(this.sag+1)+A,x[E++]=(T+1)*(this.sag+1)+A+1,x[E++]=T*(this.sag+1)+A,x[E++]=(T+1)*(this.sag+1)+A+1,x[E++]=T*(this.sag+1)+A+1;for(x=m.data,w=v.data,P=_.data,U&&(C=y.data,M=S.data),E=0,D=1/(this.sag-1),I=new t.Vector3,T=0;T<this.sag;T++)for(R=T*D,A=0;A<=this.sag;A++,E+=3)O=A/this.sag,w[E]=Math.sin(this.parallelStart+R*d)*Math.cos(this.meridianStart+O*u),I.x=this.radius*w[E],P[E]=A/this.sag,w[E+1]=Math.sin(this.parallelStart+R*d)*Math.sin(this.meridianStart+O*u),I.y=this.radius*w[E+1],P[E+1]=T/this.sag,w[E+2]=Math.cos(this.parallelStart+R*d),I.z=this.radius*w[E+2],P[E+2]=0,U&&(C[E]=w[E+1],C[E+1]=-w[E],C[E+2]=0,M[E]=w[E]*w[E+2],M[E+1]=w[E+1]*w[E+2],M[E+2]=-w[E]*w[E]-w[E+1]*w[E+1]),this.matrix&&I.applyMatrix4(this.matrix),x[E]=I.x,x[E+1]=I.y,x[E+2]=I.z;if((B=new i.Primitive).nbIndices=f,B.connectivity=i.ConnectivityTypeEnum.TRIANGLES,B.attr={fill:new i.FillAttributes(L,1),line:new i.LineAttributes,point:new i.PointAttributes},(F=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,F.nbVertices=p,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=0,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,(V=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,V.nbVertices=p,V.nbValuesPerVertex=3,V.format=i.DataTypeEnum.FLOAT,V.cardinality=0,V.bufferId=1,V.indices=new i.IndexArray,V.indices.format=i.DataTypeEnum.UINT,V.indices.bufferId=3,V.indices.offset=0,(G=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,G.nbVertices=p,G.nbValuesPerVertex=3,G.format=i.DataTypeEnum.FLOAT,G.cardinality=0,G.bufferId=2,G.indices=new i.IndexArray,G.indices.format=i.DataTypeEnum.UINT,G.indices.bufferId=3,G.indices.offset=0,B.addVertexComponent(F),B.addVertexComponent(V),B.addVertexComponent(G),U){var k=new i.VertexComponent;k.component=i.VertexComponentEnum.TEX_COORD_2,k.nbVertices=p,k.nbValuesPerVertex=3,k.format=i.DataTypeEnum.FLOAT,k.cardinality=0,k.bufferId=5,k.indices=new i.IndexArray,k.indices.format=i.DataTypeEnum.UINT,k.indices.bufferId=3,k.indices.offset=0;var z=new i.VertexComponent;z.component=i.VertexComponentEnum.TEX_COORD_3,z.nbVertices=p,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=6,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,B.addVertexComponent(k),B.addVertexComponent(z)}return g.addPrimitive(B),g.noz=N>0,g},CreateVis3DTube:function(e,r,n,s,a,o,l){var h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O,L,B,F,V;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),h=e,(c=new t.Vector3(0,0,0)).addVectors(e,r),d=s||1,u=n||1,D=void 0!==o?o:new i.Color(.2,.8,.2,1),F=l||0,V=a):(h=e.bottomCenterPoint,(c=new t.Vector3(0,0,0)).addVectors(e.bottomCenterPoint,e.extrusionVector),d=e.externalRadius?e.externalRadius:1,u=e.internalRadius?e.internalRadius:1,V=e.sag?e.sag:0,D=void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),F=e.layerNb?e.layerNb:0),u===d)return this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:d,topRadius:d,sag:V,bottomCap:!1,topCap:!1,internal:!1,layerNb:F});p=this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:d,topRadius:d,sag:V,bottomCap:!1,topCap:!1,internal:!1,layerNb:F}),f=this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:u,topRadius:u,sag:V,bottomCap:!1,topCap:!1,internal:!0,layerNb:F}),g=3*(V+1)*8,m=3*(V+1)*8,v=24*V,(_=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,_.lineAttr=new i.LineAttributes,_.pointAttr=new i.PointAttributes,(y=new i.Buffer).size=g,y.component=i.VertexComponentEnum.POSITION,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(y.size),(S=new i.Buffer).size=m,S.component=i.VertexComponentEnum.NORMAL,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(S.size),(b=new i.Buffer).size=g,b.component=i.VertexComponentEnum.TEX_COORD_0,b.format=i.DataTypeEnum.FLOAT,b.dimension=3,b.data=new Float32Array(b.size),(x=new i.Buffer).indexBuffer=!0,x.size=v,x.format=i.DataTypeEnum.UINT,x.dimension=1,x.data=new Uint16Array(x.size),y.data.set(p.buffers[0].data.subarray(0,6*(V+1)),0),y.data.set(f.buffers[0].data.subarray(0,6*(V+1)),6*(V+1)),y.data.set(p.buffers[0].data.subarray(0,3*(V+1)),12*(V+1)),y.data.set(f.buffers[0].data.subarray(0,3*(V+1)),15*(V+1)),y.data.set(p.buffers[0].data.subarray(3*(V+1),6*(V+1)),18*(V+1)),y.data.set(f.buffers[0].data.subarray(3*(V+1),6*(V+1)),21*(V+1)),b.data.set(p.buffers[2].data.subarray(0,6*(V+1)),0),b.data.set(f.buffers[2].data.subarray(0,6*(V+1)),6*(V+1)),b.data.set(p.buffers[2].data.subarray(0,3*(V+1)),12*(V+1)),b.data.set(f.buffers[2].data.subarray(0,3*(V+1)),15*(V+1)),b.data.set(p.buffers[2].data.subarray(3*(V+1),6*(V+1)),18*(V+1)),b.data.set(f.buffers[2].data.subarray(3*(V+1),6*(V+1)),21*(V+1)),S.data.set(p.buffers[1].data.subarray(0,3*(V+1)*2),0),S.data.set(f.buffers[1].data.subarray(0,3*(V+1)*2),3*(V+1)*2),w=3*(V+1)*4;for(var G=0;G<2*(V+1);G++)S.data[w++]=0,S.data[w++]=0,S.data[w++]=-1;for(G=0;G<2*(V+1);G++)S.data[w++]=0,S.data[w++]=0,S.data[w++]=1;for(x.data.set(p.buffers[3].data,0),C=p.buffers[3].size,M=p.buffers[0].size/3,p.buffers[1].size/3,P=0;P<C;P++)x.data[P+C]=f.buffers[3].data[P]+M;for(w=p.buffers[3].size+f.buffers[3].size,M*=2,(p.buffers[1].size+f.buffers[1].size)/3,E=0;E<V;++E)T=E+1,x.data[w++]=E+M,x.data[w++]=V+1+E+M,x.data[w++]=T+M,x.data[w++]=V+1+E+M,x.data[w++]=V+1+T+M,x.data[w++]=T+M;for(1,M+=2*(V+1),E=0;E<V;++E)T=E+1,x.data[w++]=V+1+E+M,x.data[w++]=E+M,x.data[w++]=T+M,x.data[w++]=T+M,x.data[w++]=V+1+T+M,x.data[w++]=V+1+E+M;for(_.addBuffer(0,y),_.addBuffer(1,S),_.addBuffer(2,b),_.addBuffer(3,x),_.addPrimitive(p.primitives[0]),_.addPrimitive(f.primitives[0]),A=f.primitives[0].vertexComponents,P=0;P<A.length;P++)A[P].indices.offset+=C;return(I=new i.Primitive).nbIndices=6*this.sag,I.connectivity=i.ConnectivityTypeEnum.TRIANGLES,I.attr={fill:new i.FillAttributes(D,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size,(O=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=1,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size,(L=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=2,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size,I.addVertexComponent(R),I.addVertexComponent(O),I.addVertexComponent(L),_.addPrimitive(I),(B=new i.Primitive).nbIndices=6*this.sag,B.connectivity=i.ConnectivityTypeEnum.TRIANGLES,B.attr={fill:new i.FillAttributes(D,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size+6*V,(O=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=1,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size+6*V,(L=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=2,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size+6*V,B.addVertexComponent(R),B.addVertexComponent(O),B.addVertexComponent(L),_.addPrimitive(B),_.noz=F>0,_},CreateVis3DCylinder:function(e,i,r,n,s){var a;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),a={bottomCenterPoint:e,topCenterPoint:i,bottomRadius:r,topRadius:r,sag:n,bottomCap:!0,topCap:!0,internal:!1,layerNb:s}):a={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:e.radius,topRadius:e.radius,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:e.color,layerNb:e.layerNb},this.CreateVis3DCylinderCustom(a)},CreateVis3DCone:function(e,r,n,s,a,o,l){var h;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),h={bottomCenterPoint:e,topCenterPoint:r,bottomRadius:void 0!==n?n:1,topRadius:void 0!==s?s:1,sag:a,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==o?o:new i.Color(.2,.8,.2,1),layerNb:l||0}):h={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:void 0!==e.bottomRadius?e.bottomRadius:1,topRadius:void 0!==e.topRadius?e.topRadius:1,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),layerNb:e.layerNb||0},h.topRadius<=0&&(h.topCap=!1),h.bottomRadius<=0&&(h.bottomCap=!1),this.CreateVis3DCylinderCustom(h)},CreateVis3DCylinderCustom:function(e,r,n,s,a,o,l,h,c,d){var u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O,L,B,F,V,G,N,U,k,z,H,W,j,X,q,Z;e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.bottomCenterPoint=void 0!==e?e:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==r?r:new t.Vector3(0,5,0),this.bottomRadius=void 0!==n?n:1,this.topRadius=void 0!==s?s:1,this.sag=void 0!==a?a:80,u=void 0===l||l,p=void 0===o||o,f=void 0!==h&&h,Z=d||0,U=c||new i.Color(.2,.8,.2,1)):(this.bottomCenterPoint=void 0!==e.bottomCenterPoint?e.bottomCenterPoint:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==e.topCenterPoint?e.topCenterPoint:new t.Vector3(0,5,0),this.bottomRadius=void 0!==e.bottomRadius?e.bottomRadius:1,this.topRadius=void 0!==e.topRadius?e.topRadius:1,this.sag=void 0!==e.sag?e.sag:80,u=void 0===e.topCap||e.topCap,p=void 0===e.bottomCap||e.bottomCap,f=void 0!==e.internal&&e.internal,Z=e.layerNb?e.layerNb:0,U=e.color?e.color:new i.Color(.2,.8,.2,1)),(g=new t.Vector4(0,0,0,0)).subVectors(this.topCenterPoint,this.bottomCenterPoint),g.w=0,g.normalize(),m=new t.Matrix4,0===g.x&&0===g.y?m.identity():m.set(g.x/Math.sqrt(g.x*g.x+g.y*g.y),g.y/Math.sqrt(g.x*g.x+g.y*g.y),0,0,-g.y/Math.sqrt(g.x*g.x+g.y*g.y),g.x/Math.sqrt(g.x*g.x+g.y*g.y),0,0,0,0,1,0,0,0,0,1),v=new t.Matrix4,0===g.x&&0===g.y&&0===g.z?v.identity():v.set(g.z/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,-Math.sqrt(g.x*g.x+g.y*g.y)/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,0,1,0,0,Math.sqrt(g.x*g.x+g.y*g.y)/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,g.z/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,0,0,0,1),(_=new t.Matrix4).multiplyMatrices(v,m),_.transpose(),_.clone(),S=new t.Vector3(this.bottomCenterPoint.x,this.bottomCenterPoint.y,this.bottomCenterPoint.z),y=_.clone(),_.elements[12]=S.x,_.elements[13]=S.y,_.elements[14]=S.z,b=Math.sqrt((this.bottomCenterPoint.x-this.topCenterPoint.x)*(this.bottomCenterPoint.x-this.topCenterPoint.x)+(this.bottomCenterPoint.y-this.topCenterPoint.y)*(this.bottomCenterPoint.y-this.topCenterPoint.y)+(this.bottomCenterPoint.z-this.topCenterPoint.z)*(this.bottomCenterPoint.z-this.topCenterPoint.z)),x=(this.bottomRadius-this.topRadius)/b,w=6*this.sag,P=2*(this.sag+1),C=2*(this.sag+1);var Y=P;if(u&&(w+=3*(this.sag-2),Y+=this.sag,C+=this.sag,P+=this.sag),p&&(w+=3*(this.sag-2),Y+=this.sag,C+=this.sag,P+=this.sag),(M=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,M.lineAttr=new i.LineAttributes,M.pointAttr=new i.PointAttributes,(E=new i.Buffer).size=3*P,E.component=i.VertexComponentEnum.POSITION,E.format=i.DataTypeEnum.FLOAT,E.dimension=3,E.data=new Float32Array(E.size),(T=new i.Buffer).size=3*C,T.component=i.VertexComponentEnum.NORMAL,T.format=i.DataTypeEnum.FLOAT,T.dimension=3,T.data=new Float32Array(T.size),(A=new i.Buffer).size=3*Y,A.component=i.VertexComponentEnum.TEX_COORD_0,A.format=i.DataTypeEnum.FLOAT,A.dimension=3,A.data=new Float32Array(A.size),(D=new i.Buffer).indexBuffer=!0,D.size=w,D.format=i.DataTypeEnum.UINT,D.dimension=1,D.data=new Uint16Array(D.size),M.addBuffer(0,E),M.addBuffer(1,T),M.addBuffer(2,A),M.addBuffer(3,D),I=D.data,R=0,f)for(L=0;L<this.sag;++L)B=L+1,I[R++]=B,I[R++]=L,I[R++]=this.sag+1+L,I[R++]=B,I[R++]=this.sag+1+L,I[R++]=this.sag+1+B;else for(L=0;L<this.sag;++L)B=L+1,I[R++]=L,I[R++]=B,I[R++]=this.sag+1+L,I[R++]=this.sag+1+L,I[R++]=B,I[R++]=this.sag+1+B;if(u)for(L=0;L<this.sag-2;L++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+L+1,I[R++]=2*this.sag+2+L+2;if(p)if(u)for(L=0;L<this.sag-2;L++)I[R++]=3*this.sag+2,I[R++]=3*this.sag+2+L+1,I[R++]=3*this.sag+2+L+2;else for(L=0;L<this.sag-2;L++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+L+1,I[R++]=2*this.sag+2+L+2;F=E.data,V=A.data;var K=0;for(L=0;L<this.sag+1;L++,K+=3)G=L/this.sag*2*Math.PI,F[K]=this.bottomRadius*Math.cos(G),F[K+1]=this.bottomRadius*Math.sin(G),F[K+2]=0,V[K]=L/this.sag,V[K+1]=1,V[K+2]=0;for(K=3*(this.sag+1),L=0;L<this.sag+1;L++,K+=3)G=L/this.sag*2*Math.PI,F[K]=this.topRadius*Math.cos(G),F[K+1]=this.topRadius*Math.sin(G),F[K+2]=b,V[K]=L/this.sag,V[K+1]=0,V[K+2]=0;if(u)for(G=0,O=0;O<this.sag;O++)G=O/this.sag*2*Math.PI,F[K]=F[3*(this.sag+O+1)],V[K++]=(Math.cos(G)+1)/2,F[K]=F[3*(this.sag+O+1)+1],V[K++]=1-(Math.sin(G)+1)/2,F[K]=F[3*(this.sag+O+1)+2],V[K++]=0;if(p)for(G=0,O=0;O<this.sag;O++)G=O/this.sag*2*Math.PI,F[K]=F[3*(this.sag-1-O)],V[K++]=(Math.cos(G)+1)/2,F[K]=F[3*(this.sag-1-O)+1],V[K++]=1-(Math.sin(G)+1)/2,F[K]=F[3*(this.sag-1-O)+2],V[K++]=0;F=T.data,K=0;for(var $=0;$<2;$++)for(L=0;L<this.sag+1;L++)G=L/this.sag*2*Math.PI,(N=new t.Vector3).x=E.data[3*L],N.y=E.data[3*L+1],N.z=E.data[3*L+2],N.z=Math.sqrt(N.x*N.x+N.y*N.y)*x,N.normalize(),f?(F[K++]=-N.x,F[K++]=-N.y,F[K++]=-N.z):(F[K++]=N.x,F[K++]=N.y,F[K++]=N.z);if(u)for($=0;$<this.sag;$++)F[K++]=0,F[K++]=0,F[K++]=1;if(p)for($=0;$<this.sag;$++)F[K++]=0,F[K++]=0,F[K++]=-1;for(O=0;O<P;O++)(N=new t.Vector3).x=E.data[3*O],N.y=E.data[3*O+1],N.z=E.data[3*O+2],N.applyMatrix4(_),E.data[3*O]=N.x,E.data[3*O+1]=N.y,E.data[3*O+2]=N.z;for(O=0;O<C;O++)(N=new t.Vector3).x=T.data[3*O],N.y=T.data[3*O+1],N.z=T.data[3*O+2],N.applyMatrix4(y),T.data[3*O]=N.x,T.data[3*O+1]=N.y,T.data[3*O+2]=N.z;return(k=new i.Primitive).nbIndices=6*this.sag,k.connectivity=i.ConnectivityTypeEnum.TRIANGLES,k.attr={fill:new i.FillAttributes(U,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=2*this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=2*this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=0,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=2*this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.indices=new i.IndexArray,W.indices.format=i.DataTypeEnum.UINT,W.indices.bufferId=3,W.indices.offset=0,k.addVertexComponent(z),k.addVertexComponent(H),k.addVertexComponent(W),M.addPrimitive(k),u&&((j=new i.Primitive).nbIndices=3*(this.sag-2),j.connectivity=i.ConnectivityTypeEnum.TRIANGLES,j.attr={fill:new i.FillAttributes(U,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=6*this.sag,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=6*this.sag,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=2*(this.sag+1),j.addVertexComponent(z),j.addVertexComponent(H),j.addVertexComponent(W),M.addPrimitive(j)),p&&(X=6*this.sag,u&&(X+=3*(this.sag-2)),(q=new i.Primitive).nbIndices=3*(this.sag-2),q.connectivity=i.ConnectivityTypeEnum.TRIANGLES,q.attr={fill:new i.FillAttributes(U,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=X,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=X,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag+2,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=u?this.sag:0,W.offset+=2*(this.sag+1),q.addVertexComponent(z),q.addVertexComponent(H),q.addVertexComponent(W),M.addPrimitive(q)),M.noz=Z>0,M},createLine:function(e,t,r,n){var s,a,o,l,h,c,d,u,p=i.ConnectivityTypeEnum.LINE_STRIP,f=!1,g=!1,m=!1;if(Array.isArray(e))console.warn("DEPRECATED: Please use a litteral object to define your primitive."),s=e,h=r,a=[],o=[],d=void 0!==t?t:new i.Color(.5,.5,.5,1),u=n||0;else if("[object Object]"===Object.prototype.toString.call(e)){if(s=e.points,a=e.colors?e.colors:[],o=e.idx?e.idx:[],p=e.drawMode?e.drawMode:p,f=!!e.editable&&e.editable,l=e.patternOffsets?e.patternOffsets:[],p!==i.ConnectivityTypeEnum.LINES&&p!==i.ConnectivityTypeEnum.LINE_STRIP&&(console.warn("Invalid draw mode for the line, passing to strip mode"),p=i.ConnectivityTypeEnum.LINE_STRIP),p===i.ConnectivityTypeEnum.LINES&&0===o.length)for(var v=0;v<s.length-1;v++)o.push(v),o.push(v+1);if(e.hasOwnProperty("material")){h=e.material.lineWidth,g=function(){if(0===o.length)return!1;if(e.material.is2DLine)return e.material.isDashedLine;for(var t=new Set,i=0,r=0;r<o.length;r++){var n=o[r];if(t.has(n)&&n!==i)return!0;i=n,t.add(n)}return!1}(),d=void 0!==e.material.color?e.material.color:new i.Color(.5,.5,.5,1),l.length&&l.length===o.length&&(m=!0)}else h=e.width,d=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1);u=e.layerNb?e.layerNb:0}if(g){var _=[],y=[],S=[];for(v=0;v<o.length;v++){var b=o[v];_.push(s[b]),a.length&&y.push(a[b]),m&&S.push(l[b]),o[v]=v}s=_,a=y,l=S}var x=s.length,w=a.length,P=o.length;if(!x)return null;var C=function(e,t,r,n,s){var a=new i.Buffer;return a.size=e*t,a.component=r,a.format=n,a.dimension=e,a.data=new Float32Array(a.size),a},M=new i.PrimitiveGroup;M.fillAttr=new i.FillAttributes,M.lineAttr=new i.LineAttributes(d,h),M.pointAttr=new i.PointAttributes;var E=0,T=C(3,x,i.VertexComponentEnum.POSITION,i.DataTypeEnum.FLOAT),A=E++;M.addBuffer(A,T),c=T.data;for(v=0;v<x;v++){var D=s[v];c[3*v]=D.x,c[3*v+1]=D.y,c[3*v+2]=D.z}var I=!1,R=0;if(w===x){I=C(4,w,i.VertexComponentEnum.DIFFUSE_COLOR,i.DataTypeEnum.FLOAT),R=E++,M.addBuffer(R,I),c=I.data;for(v=0;v<w;v++){var O=a[v];c[4*v]=O.x,c[4*v+1]=O.y,c[4*v+2]=O.z,c[4*v+3]=O.w}}var L,B,F=!1,V=0;if(P){V=E++,L=o.length,(B=new i.Buffer).indexBuffer=!0,B.size=L,B.format=i.DataTypeEnum.UINT,B.dimension=1,B.data=L>65535?new Uint32Array(B.size):new Uint16Array(B.size),F=B,M.addBuffer(V,F),c=F.data;for(v=0;v<P;v++)c[v]=o[v]}m&&(M.patternOffsets=l);var G=new i.Primitive;G.nbIndices=P||x,G.connectivity=p,G.attr={fill:new i.FillAttributes(d),line:new i.LineAttributes(d,h),point:new i.PointAttributes};var N,U=function(e,t,r,n,s,a){var o=new i.VertexComponent;return o.component=e.component,o.nbValuesPerVertex=e.dim,o.format=e.format,o.nbVertices=r,o.cardinality=0,o.bufferId=t,n&&(o.indices=new i.IndexArray,o.indices.format=n.format,o.indices.bufferId=s,o.indices.offset=a),o},k=U(T,A,x,F,V,0);return G.addVertexComponent(k),w&&(N=U(I,R,w,F,V,0),G.addVertexComponent(N)),M.addPrimitive(G),M.noz=u>0,M.editable=f,M},createRectangle:function(e,r,n,s,a,o){var l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A;"[object Object]"===Object.prototype.toString.call(e)?(w=e.width?e.width:1,P=e.height?e.height:1,C=!!e.fill&&e.fill,v=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),M=!!e.noEdge&&e.noEdge,E=e.layerNb?e.layerNb:0,T=!!e.sharing&&e.sharing,A=e.cornerPoint?e.cornerPoint:new t.Vector2(0,0)):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),w=e||1,P=r||1,C=n||!1,v=void 0!==s?s:new i.Color(.5,.5,.5,1),M=a||!1,E=o||0,A=new t.Vector2(0,0),T=!1),(l=new i.PrimitiveGroup).sharing=T,l.fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(h=new i.Buffer).size=15,h.component=i.VertexComponentEnum.POSITION,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(c=new i.Buffer).size=3,c.component=i.VertexComponentEnum.NORMAL,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(d=new i.Buffer).size=12,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(u=new i.Buffer).indexBuffer=!0,u.size=C?9:5,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(u.size),(p=new i.Buffer).indexBuffer=!0,p.size=5,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=C?4:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,h),l.addBuffer(1,c),l.addBuffer(2,u),l.addBuffer(3,p),l.addBuffer(4,d),l.addBuffer(5,f),m=0,(g=u.data)[m++]=0,g[m++]=1,g[m++]=2,g[m++]=3,g[m++]=4,C&&(g[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2),m=0,(g=p.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=0,g[m++]=0,g=f.data,m=0,C&&(g[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2),g=h.data,m=0;var D=e.delta&&e.delta.x?e.delta.x:0,I=e.delta&&e.delta.y?e.delta.y:0;return g[m++]=A.x+D,g[m++]=A.y+I,g[m++]=0,g[m++]=w+A.x+D,g[m++]=A.y+I,g[m++]=0,g[m++]=w+A.x+D,g[m++]=P+A.y+I,g[m++]=0,g[m++]=A.x+D,g[m++]=P+A.y+I,g[m++]=0,g[m++]=A.x+D,g[m++]=A.y+I,g[m++]=0,m=0,(g=c.data)[m++]=0,g[m++]=0,g[m++]=1,m=0,(g=d.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,M||((_=new i.Primitive).nbIndices=5,_.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,_.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes(v),point:new i.PointAttributes},(y=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,y.nbVertices=5,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=0,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=2,y.indices.offset=0,(x=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,x.nbVertices=1,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=1,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=0,_.addVertexComponent(y),_.addVertexComponent(x),l.addPrimitive(_)),C&&((b=new i.Primitive).nbIndices=4,b.connectivity=i.ConnectivityTypeEnum.TRIANGLE_STRIP,b.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes,point:new i.PointAttributes},(y=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,y.nbVertices=4,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=0,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=2,y.indices.offset=5,(x=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,x.nbVertices=1,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=1,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=0,(S=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,S.nbVertices=4,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=4,S.indices=new i.IndexArray,S.indices.format=i.DataTypeEnum.UINT,S.indices.bufferId=5,S.indices.offset=0,b.addVertexComponent(y),b.addVertexComponent(x),b.addVertexComponent(S),l.addPrimitive(b)),l.noz=E>0,l},createCircle:function(e,t,r,n,s,a,o){var l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O;for("[object Object]"===Object.prototype.toString.call(e)?(D=e.radius?e.radius:1,I=e.segments?e.segments:24,E=void 0!==e.startAngle?e.startAngle:0,T=void 0!==e.endAngle?e.endAngle:2*Math.PI,R=!!e.fill&&e.fill,S=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),A=!!e.noEdge&&e.noEdge,O=e.layerNb?e.layerNb:0):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),D=e||1,I=t||24,E=void 0!==n?n:0,T=void 0!==s?s:2*Math.PI,R=r||!1,A=!1,S=void 0!==a?a:new i.Color(.5,.5,.5,1),O=o||0),M=T-E,(l=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(h=new i.Buffer).size=3*(I+2),h.component=i.VertexComponentEnum.POSITION,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(c=new i.Buffer).size=3,c.component=i.VertexComponentEnum.NORMAL,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(d=new i.Buffer).size=6,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(u=new i.Buffer).indexBuffer=!0,u.size=R?2*(I+1)+1:I+1,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(u.size),(p=new i.Buffer).indexBuffer=!0,p.size=I+2,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=R?I+2:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,h),l.addBuffer(1,c),l.addBuffer(2,d),l.addBuffer(3,u),l.addBuffer(4,p),l.addBuffer(5,f),g=u.data,m=0,v=1;v<I+2;v++)g[m++]=v;if(R)for(m=I+1,g[m++]=0,v=1;v<I+2;v++)g[m++]=v;for(g=p.data,m=0,m=0;m<=I+2;m++)g[m++]=0;if(R)for((g=f.data)[0]=0,m=1;m<=I+2;m++)g[m]=1;for(m=0,(g=h.data)[m++]=0,g[m++]=0,g[m++]=0,v=0;v<I+2;v++)y=v/I*M+E,g[m++]=D*Math.cos(y),g[m++]=D*Math.sin(y),g[m++]=0;return _=0,(g=c.data)[_++]=0,g[_++]=0,g[_++]=1,_=0,(g=d.data)[_++]=0,g[_++]=0,g[_++]=0,g[_++]=1,g[_++]=0,g[_++]=0,A||((b=new i.Primitive).nbIndices=I+1,b.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,b.attr={fill:new i.FillAttributes(S),line:new i.LineAttributes,point:new i.PointAttributes},(x=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,x.nbVertices=I+2,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=0,(P=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,P.nbVertices=1,P.nbValuesPerVertex=3,P.format=i.DataTypeEnum.FLOAT,P.cardinality=0,P.bufferId=1,P.indices=new i.IndexArray,P.indices.format=i.DataTypeEnum.UINT,P.indices.bufferId=4,P.indices.offset=0,b.addVertexComponent(x),b.addVertexComponent(P),l.addPrimitive(b)),R&&((w=new i.Primitive).nbIndices=I+2,w.connectivity=i.ConnectivityTypeEnum.TRIANGLE_FAN,w.attr={fill:new i.FillAttributes(S),line:new i.LineAttributes,point:new i.PointAttributes},(x=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,x.nbVertices=I+2,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=I+1,(P=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,P.nbVertices=1,P.nbValuesPerVertex=3,P.format=i.DataTypeEnum.FLOAT,P.cardinality=0,P.bufferId=1,P.indices=new i.IndexArray,P.indices.format=i.DataTypeEnum.UINT,P.indices.bufferId=4,P.indices.offset=0,(C=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,C.nbVertices=2,C.nbValuesPerVertex=3,C.format=i.DataTypeEnum.FLOAT,C.cardinality=0,C.bufferId=2,C.indices=new i.IndexArray,C.indices.format=i.DataTypeEnum.UINT,C.indices.bufferId=5,C.indices.offset=0,w.addVertexComponent(x),w.addVertexComponent(P),w.addVertexComponent(C),l.addPrimitive(w)),l.noz=O>0,l},createTorus:function(e,r,n,s,a,o,l,h){var c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O,L,B,F,V,G;for(e instanceof t.Matrix4?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.axis=e||null,this.majorRadius=r||100,this.minorRadius=n||40,this.majorStartAngle=s||0,this.majorEndAngle=a||2*Math.PI,this.sag=o||8,O=void 0!==l?l:new i.Color(.5,.5,.5,1),G=h||0):"[object Object]"===Object.prototype.toString.call(e)&&(this.axis=e.axis||null,this.majorRadius=e.majorRadius||100,this.minorRadius=e.minorRadius||40,this.majorStartAngle=e.majorStartAngle||0,this.majorEndAngle=e.majorEndAngle||2*Math.PI,this.sag=e.sag||8,O=e.color||(void 0!==l?l:new i.Color(.5,.5,.5,1)),G=h||0),c=(this.majorEndAngle-this.majorStartAngle)/this.sag,d=(this.sag+1)*(this.sag+1),u=6*this.sag*this.sag,(p=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,p.lineAttr=new i.LineAttributes,p.pointAttr=new i.PointAttributes,(f=new i.Buffer).size=3*d,f.component=i.VertexComponentEnum.POSITION,f.format=i.DataTypeEnum.FLOAT,f.dimension=3,f.data=new Float32Array(f.size),(I=new i.Buffer).size=3*d,I.component=i.VertexComponentEnum.NORMAL,I.format=i.DataTypeEnum.FLOAT,I.dimension=3,I.data=new Float32Array(I.size),(g=new i.Buffer).size=3*d,g.component=i.VertexComponentEnum.TEX_COORD_0,g.format=i.DataTypeEnum.FLOAT,g.dimension=3,g.data=new Float32Array(g.size),(m=new i.Buffer).indexBuffer=!0,m.size=u,m.format=i.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(m.size),p.addBuffer(0,f),p.addBuffer(1,I),p.addBuffer(2,g),p.addBuffer(3,m),v=m.data,S=0,w=0;w<this.sag;++w)for(A=w+1,P=0;P<this.sag;++P)D=P+1,v[S]=w*(this.sag+1)+P,v[S+1]=A*(this.sag+1)+P,v[S+2]=w*(this.sag+1)+D,v[S+3]=A*(this.sag+1)+D,v[S+4]=w*(this.sag+1)+D,v[S+5]=A*(this.sag+1)+P,S+=6;for(v=f.data,_=I.data,y=g.data,b=0,x=new t.Vector3,w=0;w<this.sag+1;w++)for(C=this.majorStartAngle+w*c,P=0;P<this.sag+1;P++,b+=3)M=P/this.sag*2*Math.PI,x.x=this.majorRadius*Math.cos(C),x.y=this.majorRadius*Math.sin(C),(E=new t.Vector3).x=(this.majorRadius+this.minorRadius*Math.cos(M))*Math.cos(C),E.y=(this.majorRadius+this.minorRadius*Math.cos(M))*Math.sin(C),E.z=this.minorRadius*Math.sin(M),T=E.clone(),this.axis&&E.applyMatrix4(this.axis),v[b]=E.x,v[b+1]=E.y,v[b+2]=E.z,(R=new t.Vector3).subVectors(T,x).normalize(),this.axis&&R.applyMatrix4(this.axis),R.normalize(),_[b]=R.x,_[b+1]=R.y,_[b+2]=R.z,y[b]=w/this.sag,y[b+1]=1-P/this.sag,y[b+2]=0;return(L=new i.Primitive).nbIndices=u,L.connectivity=i.ConnectivityTypeEnum.TRIANGLES,L.attr={fill:new i.FillAttributes(O,1),line:new i.LineAttributes,point:new i.PointAttributes},(B=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,B.nbVertices=d,B.nbValuesPerVertex=3,B.format=i.DataTypeEnum.FLOAT,B.cardinality=0,B.bufferId=0,B.indices=new i.IndexArray,B.indices.format=i.DataTypeEnum.UINT,B.indices.bufferId=3,B.indices.offset=0,(V=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,V.nbVertices=d,V.nbValuesPerVertex=3,V.format=i.DataTypeEnum.FLOAT,V.cardinality=0,V.bufferId=1,V.indices=new i.IndexArray,V.indices.format=i.DataTypeEnum.UINT,V.indices.bufferId=3,V.indices.offset=0,(F=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,F.nbVertices=d,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=2,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,L.addVertexComponent(B),L.addVertexComponent(V),L.addVertexComponent(F),p.addPrimitive(L),p.noz=G>0,p},createPoints:function(e,t,r,n){var s=this.createMesh(e,void 0,void 0,void 0,i.ConnectivityTypeEnum.POINTS,t,n,void 0,void 0,void 0,r);return s.pointAttr.size=r,s.noz=n>0,s},createMesh:function(e,r,n,s,a,o,l,h,c,d,u){var p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R;if(C=new t.Vector3,M=new t.Vector3,this.bufferPosition=void 0!==e?e:[],this.bufferNormal=void 0!==r?r:[],this.bufferUV=void 0!==n?n:[],this.bufferColor=void 0!==d?d:[],this.bufferIndex=void 0!==s?s:[],this.glType=void 0!==a?a:i.ConnectivityTypeEnum.TRIANGLES,p=this.bufferPosition.length,f=this.bufferNormal.length,g=this.bufferUV.length,m=this.bufferColor.length,v=this.bufferIndex.length,(_=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,_.lineAttr=new i.LineAttributes,_.pointAttr=new i.PointAttributes,S=null,b=null,x=null,(y=new i.Buffer).size=p,y.component=i.VertexComponentEnum.POSITION,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(this.bufferPosition),_.addBuffer(0,y),f&&((S=new i.Buffer).size=f,S.component=i.VertexComponentEnum.NORMAL,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(this.bufferNormal),_.addBuffer(1,S)),g&&((b=new i.Buffer).size=g,b.component=i.VertexComponentEnum.TEX_COORD_0,b.format=i.DataTypeEnum.FLOAT,b.dimension=3,b.data=new Float32Array(this.bufferUV),_.addBuffer(2,b)),m&&((x=new i.Buffer).size=m,x.component=i.VertexComponentEnum.DIFFUSE_COLOR,x.format=i.DataTypeEnum.FLOAT,x.dimension=3,x.data=new Float32Array(this.bufferColor),_.addBuffer(4,x)),v&&((w=new i.Buffer).indexBuffer=!0,w.size=v,w.format=i.DataTypeEnum.UINT,w.dimension=1,w.data=v>65535?new Uint32Array(this.bufferIndex):new Uint16Array(this.bufferIndex),_.addBuffer(3,w)),h){for(P=0;P<p/3;P++)C.x=y.data[3*P],C.y=y.data[3*P+1],C.z=y.data[3*P+2],h.multiplyVector3(C),y.data[3*P]=C.x,y.data[3*P+1]=C.y,y.data[3*P+2]=C.z;for(P=0;P<f/3;P++)M.x=S.data[3*P],M.y=S.data[3*P+1],M.z=S.data[3*P+2],h.multiplyVector3(M),S.data[3*P]=M.x,S.data[3*P+1]=M.y,S.data[3*P+2]=M.z}E="undefined"!==o?o:new i.Color(.5,.5,.5,1);var O=u||1;return(T=new i.Primitive).nbIndices=v||p/3,T.connectivity=this.glType,T.attr={fill:new i.FillAttributes(E),line:new i.LineAttributes(E),point:new i.PointAttributes(E,O)},(A=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,A.nbVertices=p/3,A.nbValuesPerVertex=3,A.format=i.DataTypeEnum.FLOAT,A.cardinality=0,A.bufferId=0,A.indices=null,v&&(A.indices=new i.IndexArray,A.indices.format=i.DataTypeEnum.UINT,A.indices.bufferId=3,A.indices.offset=0),T.addVertexComponent(A),f&&((D=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,D.nbVertices=f/3,D.nbValuesPerVertex=3,D.format=i.DataTypeEnum.FLOAT,D.cardinality=0,D.bufferId=1,D.indices=null,v&&(D.indices=new i.IndexArray,D.indices.format=i.DataTypeEnum.UINT,D.indices.bufferId=3,D.indices.offset=0),T.addVertexComponent(D)),g&&((I=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,I.nbVertices=g/3,I.nbValuesPerVertex=3,I.format=i.DataTypeEnum.FLOAT,I.cardinality=0,I.bufferId=2,I.indices=null,v&&(I.indices=new i.IndexArray,I.indices.format=i.DataTypeEnum.UINT,I.indices.bufferId=3,I.indices.offset=0),T.addVertexComponent(I)),m&&((R=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,R.nbVertices=m/3,R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=4,R.indices=null,v&&(R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=0),T.addVertexComponent(R)),_.addPrimitive(T),l&&(l.force=!0,_.material=l),_.noz=c>0,_},createText:function(e,i,n,s,a,o){var l,h,c,d,u,p,f,g,m;void 0===a&&(a=32),l="font-family: "+i+"; font-size: "+a+"px;",u=(c=(h=this._determineTextSize(e,l)).width)/(d=h.height),(p=r).width=c,p.height=d,(f=p.getContext("2d")).fillStyle="#"+s.getHexString(),f.lineWidth=0,f.strokeStyle="#"+s.getHexString(),f.font=a+"px "+i,f.textAlign="left",f.textBaseline="top",f.fillText(e,0,0),f.restore(),g=c/a,m=this.createRectangle(n*g,n*g/u,!0,void 0,void 0,o);var v=void 0;if(0!=p.width||0!=p.height){for(var _=f.getImageData(0,0,p.width,p.height),y=new ArrayBuffer(_.data.length),S=new Uint8Array(y),b=0;b<4*p.width*p.height;++b)S[b]=_.data[b];(v=new t.DataTexture(S,p.width,p.height,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter)).needsUpdate=!0}return m.material=new t.MeshBasicMaterial({map:v,transparent:!0}),m.material.force=!0,m.noz=o>0,m},convertFromTHREEMesh:function(e){if(e instanceof t.Mesh){var r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O=1e-5,L=function(e,t,i,r){return Math.abs(e.x-t[i])<O&&Math.abs(e.y-t[i+1])<O&&(2===r||Math.abs(e.z-t[i+2])<O)},B={x:0,y:0};if(0===(R=e.geometry)._type){D=[],I=[],T=!1;var F=R.faces,V=R.faceVertexUvs[0];for(r=0;r<F.length;r++)I[r]={face:F[r],uv:V?V[r]:null};for(e.material instanceof t.MeshFaceMaterial&&(T=!0,I.sort((function(e,t){return e.face.materialIndex-t.face.materialIndex}))),o=0,l=0,C=0,P=[],M=0,A=I.length&&void 0!==I[0].face.materialIndex?I[0].face.materialIndex:-1,r=0;r<I.length;r++){var G=I[r].face;T&&A!==G.materialIndex&&(P[C]={nbIndices:o,nbVertices:l,start:M,end:r,material:T?e.material.materials[A]:e.material},C+=1,M=r,o=0,l=0,A=G.materialIndex),G instanceof t.Face3?(o+=3,l+=3):(o+=6,l+=4)}0!=o&&(P[C]={nbIndices:o,nbVertices:l,start:M,end:r,material:T?e.material.materials[A]:e.material}),f=R.vertices;var N=new Int32Array(f.length),U=["a","b","c","d"];for(a=0;a<P.length;a++){var k=P[a],z=!1;l=k.nbVertices,o=k.nbIndices,h=new Float32Array(3*l),c=new Float32Array(3*l),d=new Float32Array(3*l),u=new Float32Array(3*l),p=new Uint32Array(o);var H=0;for(r=0;r<N.length;r++)N[r]=-1;for(M=k.start,E=k.end,s=0,r=M;r<E;r++){g=I[r].face,x=I[r].uv,v=g.vertexNormals&&g.vertexNormals.length?g.vertexNormals:null,_=g.vertexColors&&g.vertexColors.length?g.vertexColors:null,y=g.normal,null,v&&v.length||(v=null),_&&_.length||(_=null);var W=g instanceof t.Face4?4:3;for(n=0;n<W;n++){var j;S=v?v[n]:y,b=_?_[n]:null,w=x?x[n]:B,-1===(j=N[g[U[n]]])||!L(S,c,3*j,3)||!L(w,u,3*j,2)||b&&!L(b,d,3*j,3)?(N[g[U[n]]]=H,m=f[g[U[n]]],h[3*H]=m.x,h[3*H+1]=m.y,h[3*H+2]=m.z,c[3*H]=S.x,c[3*H+1]=S.y,c[3*H+2]=S.z,b&&(z=!0,d[3*H]=b.r,d[3*H+1]=b.g,d[3*H+2]=b.b),u[3*H]=w.x,u[3*H+1]=w.y,u[3*H+2]=0,3===n&&(p[s++]=p[s-4],p[s++]=p[s-3]),p[s++]=H++):(3===n&&(p[s++]=p[s-4],p[s++]=p[s-3]),p[s++]=j)}}var X=new Float32Array(3*H),q=new Float32Array(3*H),Z=new Float32Array(3*H),Y=new Float32Array(3*H);for(r=0;r<3*H;r++)X[r]=h[r],q[r]=c[r],Z[r]=d[r],Y[r]=u[r];h=X,c=q,d=z?Z:null,u=Y,z&&(k.material.vertexColors=t.VertexColorType.RGBA),D[D.length]={bufPos:h,bufNorm:c,bufCol:d,bufUV:u,bufInd:p,connectivity:i.ConnectivityTypeEnum.TRIANGLES,material:k.material}}return this.createPrimGroup(D)}}},createPrimGroup:function(e){var t,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y;for((o=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,o.lineAttr=new i.LineAttributes,o.pointAttr=new i.PointAttributes,p=0;p<e.length;p++){var S=(b=!!e[p].bufCol)?5:4;t=e[p].bufPos.length,r=e[p].bufNorm.length,b&&(n=e[p].bufCol.length),s=e[p].bufUV.length,a=e[p].bufInd.length,(l=new i.Buffer).size=t,l.component=i.VertexComponentEnum.POSITION,l.format=i.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(e[p].bufPos),(h=new i.Buffer).size=r,h.component=i.VertexComponentEnum.NORMAL,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(e[p].bufNorm),b&&((c=new i.Buffer).size=n,c.component=i.VertexComponentEnum.DIFFUSE_COLOR,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(e[p].bufCol)),(d=new i.Buffer).size=s,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(e[p].bufUV),(u=new i.Buffer).indexBuffer=!0,u.size=a,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint32Array(e[p].bufInd),o.addBuffer(p*S,l),o.addBuffer(1+p*S,h),o.addBuffer(2+p*S,d),o.addBuffer(3+p*S,u),b&&o.addBuffer(4+p*S,c)}for(f=new i.Color(.5,.5,.5,1),p=0;p<e.length;p++){var b;S=(b=!!e[p].bufCol)?5:4;switch(t=e[p].bufPos.length,r=e[p].bufNorm.length,b&&(n=e[p].bufCol.length),s=e[p].bufUV.length,a=e[p].bufInd.length,(g=new i.Primitive).nbIndices=a,g.connectivity=e[p].connectivity,g.connectivity){case i.ConnectivityTypeEnum.TRIANGLES:case i.ConnectivityTypeEnum.TRIANGLE_FAN:case i.ConnectivityTypeEnum.TRIANGLE_STRIP:g.geomType="FACE";break;case i.ConnectivityTypeEnum.LINES:case i.ConnectivityTypeEnum.LINE_STRIP:case i.ConnectivityTypeEnum.LINE_LOOP:g.geomType="WIRE_EDGE";break;case i.ConnectivityTypeEnum.POINTS:g.geomType="FREE_POINT";break;default:g.geomType=null}g.attr={fill:new i.FillAttributes(f),line:new i.LineAttributes,point:new i.PointAttributes},(m=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,m.nbVertices=t/3,m.nbValuesPerVertex=3,m.format=i.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=p*S,m.indices=new i.IndexArray,m.indices.format=i.DataTypeEnum.UINT,m.indices.bufferId=3+p*S,m.indices.offset=0,(v=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,v.nbVertices=r/3,v.nbValuesPerVertex=3,v.format=i.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=1+p*S,v.indices=new i.IndexArray,v.indices.format=i.DataTypeEnum.UINT,v.indices.bufferId=3+p*S,v.indices.offset=0,b&&((_=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,_.nbVertices=n/3,_.nbValuesPerVertex=3,_.format=i.DataTypeEnum.FLOAT,_.cardinality=0,_.bufferId=4+p*S,_.indices=new i.IndexArray,_.indices.format=i.DataTypeEnum.UINT,_.indices.bufferId=3+p*S,_.indices.offset=0),(y=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,y.nbVertices=s/3,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=2+p*S,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=3+p*S,y.indices.offset=0,g.addVertexComponent(m),g.addVertexComponent(v),b&&g.addVertexComponent(_),g.addVertexComponent(y),g.material=e[p].material,o.addPrimitive(g)}return e[0]&&e[0].material&&(o.material=e[0].material),o},CreateVis3DCuboidFromBox3:function(e,t){var r,n,s,a,o,l,h,c,d,u,p=void 0!==t.color?t.color:new i.Color(.5,.5,.5,1);for((r=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,r.lineAttr=new i.LineAttributes,r.pointAttr=new i.PointAttributes,(n=new i.Buffer).size=72,n.component=i.VertexComponentEnum.POSITION,n.format=i.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(s=new i.Buffer).size=72,s.component=i.VertexComponentEnum.NORMAL,s.format=i.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(a=new i.Buffer).indexBuffer=!0,a.size=36,a.format=i.DataTypeEnum.UINT,a.dimension=1,a.data=new Uint16Array(36),r.addBuffer(0,n),r.addBuffer(1,s),r.addBuffer(2,a),o=a.data,l=0,h=0;h<6;h++)o[l++]=4*h,o[l++]=4*h+1,o[l++]=4*h+2,o[l++]=4*h,o[l++]=4*h+2,o[l++]=4*h+3;var f=e.min.x,g=e.max.x,m=e.min.y,v=e.max.y,_=e.min.z,y=e.max.z;for(l=0,(o=n.data)[l++]=g,o[l++]=m,o[l++]=_,o[l++]=g,o[l++]=v,o[l++]=_,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=_,o[l++]=g,o[l++]=m,o[l++]=_,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=m,o[l++]=_,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=_,o[l++]=f,o[l++]=m,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=g,o[l++]=v,o[l++]=_,o=s.data,l=0,h=0;h<4;h++)o[l++]=1,o[l++]=0,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=1,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=0,o[l++]=1;for(h=0;h<4;h++)o[l++]=0,o[l++]=-1,o[l++]=0;for(h=0;h<4;h++)o[l++]=-1,o[l++]=0,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=0,o[l++]=-1;for(h=0;h<6;h++)c=new i.Primitive({nbIndices:6,connectivity:i.ConnectivityTypeEnum.TRIANGLES,fillGAS:new i.FillAttributes(p,1),lineGAS:new i.LineAttributes,pointGAS:new i.PointAttributes}),d=new i.VertexComponent({nbVertices:4,bufferId:0,indices:new i.IndexArray({bufferId:2,offset:6*h})}),u=new i.VertexComponent({nbVertices:4,bufferId:1,indices:new i.IndexArray({bufferId:2,offset:6*h})}),c.addVertexComponent(d),c.addVertexComponent(u),r.addPrimitive(c);return r},_determineTextSize:function(e,t,i){var r,n,s,a,o;r=document.getElementsByTagName("body")[0],(n=document.createElement("div")).setAttribute("style",t);var l=i||"nowrap";return(s=document.createElement("span")).setAttribute("style","white-space: "+l),a=document.createTextNode(e),s.appendChild(a),n.appendChild(s),r.appendChild(n),(o={width:0,height:0}).width=s.offsetWidth,o.height=s.offsetHeight,r.removeChild(n),o}});return UWA.namespace("THREEDS/GeometryHelper",n)})),define("Visualization/GeometryHelper",["DS/Visualization/GeometryHelper","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/GeometryHelper"),e})),define("DS/Visualization/Filters/MaterialToUseFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this.materialToUse=e}}})),define("DS/Visualization/WebGPURenderer",["DS/Visualization/ThreeJS_DS","DS/ShaderBuilders/Commons/DefaultShaders","DS/Visualization/ShaderChunk","DS/ShaderBuilders/MultiDrawShaderBuilder","DS/Visualization/BufferGPUManager","DS/ShaderBuilders/WebGPUShaderBuilder","DS/GPUFormats/WebGPURenderPipelines","DS/RenderEngineUtils/WebGPUComputeInterface","DS/GPUFormats/WebGPUBindGroupUtils","DS/Visualization/OutlineBuilder"],(function(e,t,i,r,n,s,a,o,l,h){"use strict";e._MultiDrawShaderBuilder=r;var c=new e.Color;new e.Vector3;let d=null,u=!1,p=null;const f="validation",g=(e.AutomatedTests()||localStorage.getItem("__WEBVISU_DEBUGGER_ON_COMPIL_FAIL__"),e.AutomatedTests()),m=1/4,v=e.WebGPURenderTarget,_=(e.WebGPURenderTargetCube,e.WebGPUFormatEnums),y=e.MaterialToUse._materialToUseShift,S=e.GLTypeEnum,b=(l.WebGPUBindingGroup,l.WebGPUBindingGroupRevision),x=l.WebGPUBindingGroupSharedRevision,w=l.WebGPUBindingGroupGlobalRevision,P=l.WebGPUBindingGroupLight,C=l.WebGPUBindingGroupObject,M=l.WebGPUGenericBindingGroupCache,E=l.WebGPUMaterialBindingGroupCache,T=e._lastMinuteHandlingResult;e._toFastProperties;const A={LOAD:"load",CLEAR:"clear"};e.WebGPULoadOperations=A;const D={STORE:"store",DISCARD:"discard"};e.WebGPUStoreOperations=D;class I{constructor(e){this._webgpu=null,this._initialization=async function(e){const t=await navigator.gpu.requestAdapter();let i=["texture-compression-bc","depth-clip-control","depth32float-stencil8","texture-compression-bc-sliced-3d","texture-compression-etc2","texture-compression-astc","indirect-first-instance","shader-f16","rg11b10ufloat-renderable","bgra8unorm-storage","float32-filterable","float32-blendable","clip-distances","dual-source-blending","subgroups"];e&&i.push("timestamp-query");let r=[];for(let e=0;e<i.length;e++)t.features.has(i[e])&&r.push(i[e]);let n=[{name:"maxBufferSize",value:536870912},{name:"maxStorageBufferBindingSize",value:536870912}],s={};for(let e=0;e<n.length;e++){let i=n[e].name;t.limits[i]&&(s[i]=Math.min(t.limits[i],n[e].value))}const a=await t.requestDevice({requiredFeatures:r,requiredLimits:s});return{adapter:t,device:a}}(e).then((e=>{this._webgpu=e,this._initialization=null}),(e=>{throw console.warn("Failed to initialize WebGPU device: ",e),this._webgpu=null,this._initialization=null,e}))}initialized(){return this._initialization||(this.getGPUDevice()?Promise.resolve():Promise.reject())}getGPUAdapter(){return this._webgpu&&this._webgpu.adapter}getGPUDevice(){return this._webgpu&&this._webgpu.device}}class R{constructor(e,t){this.canvas=e,this.device=t,this.size={width:-1,height:-1},this.format=navigator.gpu.getPreferredCanvasFormat(),this._context=this.canvas.getContext("webgpu"),this.resize()}resize(e=null){e||(e=this.canvas.getBoundingClientRect()),e.width===this.size.width&&e.height===this.size.height||(this.size.width=e.width,this.size.height=e.height,this.canvas.width=this.size.width,this.canvas.height=this.size.height,this._context.configure({device:this.device,format:this.format,alphaMode:"opaque",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.SHADER_READ}))}getGPUTexture(){return this._context.getCurrentTexture()}createTextureView(){return this._context.getCurrentTexture().createView()}}const O=BigInt(e._WebGPUFormatShift),L=30n,B=13n,F=23n+B,V=F+24n,G=3n,N=(1n<<L)-1n,U=V+G;class k extends e.ProgramObject{constructor(){super(),this.shaderIO=null,this.uniforms=null,this.materialBindingGroups=new E,this.wgslShaderModuleVertex=null,this.wgslShaderModuleFragment=null,this.bufferLayouts=null,this.bindingGroups={Object:null,Material:null,Light:null,Global:null},this.hasHighFrequencyUniforms=0}clean(e){super.clean(e),this.materialBindingGroups.clean(e)}delete(e){const t=e.wgpuRenderPipelines.pipelines,i=this;t.forEach(((r,n)=>{(BigInt(n)>>U&N)==i.program&&(t.set(n,null),r&&e.memoryInfo.pipelines--)})),super.delete(e),this.materialBindingGroups.cleanAll()}}class z{constructor(){this.colorLoadOp=A.LOAD,this.depthLoadOp=A.LOAD,this.stencilLoadOp=A.LOAD,this.colorStoreOp=D.STORE,this.depthStoreOp=D.STORE,this.stencilStoreOp=D.STORE,this.clearColor={r:0,g:0,b:0,a:0},this.clearDepth=1,this.clearStencil=0,this.doDrawClear=!1,this.viewport={x:0,y:0,width:0,height:0},this.enableScissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.locked=!1,this.renderTarget=null,this.descriptorGPU=null}reset(e){this.colorLoadOp=A.LOAD,this.depthLoadOp=A.LOAD,this.stencilLoadOp=A.LOAD,this.colorStoreOp=D.STORE,this.depthStoreOp=D.STORE,this.stencilStoreOp=D.STORE,this.clearColor={r:e.clearColor.r,g:e.clearColor.g,b:e.clearColor.b,a:e.clearAlpha},this.clearDepth=1,this.clearStencil=0,this.doDrawClear=!1,this.viewport={x:0,y:0,width:0,height:0},this.enableScissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.locked=!1,this.renderTarget=null,this.descriptorGPU=null}}class H{constructor(e){this.pInfo=e,this.enable=!1,this.eq1=null,this.src1=null,this.dst1=null,this.eq2=null,this.src2=null,this.dst2=null,this.blendKey=0}setEnable(e){this.enable=e,this.blendKey=-2&this.blendKey,this.enable&&(this.blendKey|=1),this.pInfo._updateStateKey()}setEq1(e){this.eq1=e,this.blendKey=-15&this.blendKey,this.blendKey|=2*e,this.pInfo._updateStateKey()}setSrc1(e){this.src1=e,this.blendKey=-241&this.blendKey,this.blendKey|=16*e,this.pInfo._updateStateKey()}setDst1(e){this.dst1=e,this.blendKey=-3841&this.blendKey,this.blendKey|=256*e,this.pInfo._updateStateKey()}setEq2(e){this.eq2=e,this.blendKey=-28673&this.blendKey,this.blendKey|=4096*e,this.pInfo._updateStateKey()}setSrc2(e){this.src2=e,this.blendKey=-491521&this.blendKey,this.blendKey|=32768*e,this.pInfo._updateStateKey()}setDst2(e){this.dst2=e,this.blendKey=-7864321&this.blendKey,this.blendKey|=524288*e,this.pInfo._updateStateKey()}}class W{constructor(){this.rtKey=0n,this.rtProgramKey=0n,this.rtProgramGLTypeKey=0n,this.stateKey=0,this.stencilKey=0,this.stateStencilBlendKey=0,this.finalKey=BigInt(0),this.blendingState=new H(this),this.depthWriteEnabled=!1,this.setDepthWrite(!0),this.depthCompare=null,this.stencilCompare=null,this.stencilReadMask=0,this.setStencilRead(255),this.stencilWriteMask=0,this.setStencilWrite(255),this.stencilFunc=null,this.stencilRef=0,this.stencilOpFront=null,this.stencilOpBack=null,this.colorWriteMask=-1,this.frontFace=-1,this.cullMode=null,this.needsHardUpdate=!0,this.locked=!1}_updateStateKey(){this.stateStencilBlendKey=(BigInt(this.blendingState.blendKey)<<F)+(BigInt(this.stencilKey)<<B)+BigInt(this.stateKey),this.finalKey=this.stateStencilBlendKey+this.rtProgramGLTypeKey}_updateRTProgramGLTypeKey(e){this.rtProgramGLTypeKey=this.rtProgramKey+BigInt(e+1)<<V,this.finalKey=this.stateStencilBlendKey+this.rtProgramGLTypeKey}reset(e){this.rtKey=0n,this.rtProgramKey=0n,this.rtProgramGLTypeKey=0n,this.stateKey=0,this.stencilKey=0,this.stateStencilBlendKey=0,this.finalKey=BigInt(0),this.blendingState=new H(this),this.setDepthWrite(!0),this.setDepthCompare(e._getGPUDepthCompareValue()),this.setStencilCompare(e._getGPUStencilCompareValue()),this.setStencilRead(255),this.setStencilWrite(255),this.stencilFunc=e._getGPUStencilCompareValue(),this.stencilRef=0;const t=e._getGPUStencilOpValues();this.setStencilOpFront(t[0],t[1],t[2]),this.setStencilOpBack(t[0],t[1],t[2]),this.colorWriteMask=-1,this.frontFace=-1,this.cullMode=null,this.needsHardUpdate=!0,this.locked=!1}setDepthWrite(e){this.depthWriteEnabled=e,this.stateKey=-2&this.stateKey,this.depthWriteEnabled&&(this.stateKey|=1),this._updateStateKey()}setDepthCompare(e){this.depthCompare=e,this.stateKey=-15&this.stateKey,this.stateKey|=2*(e-1),this._updateStateKey()}setFrontFace(e){this.frontFace=e,this.stateKey=-17&this.stateKey,this.stateKey|=16*e,this._updateStateKey()}setCullMode(e){this.cullMode=e,this.stateKey=-97&this.stateKey,this.stateKey|=32*e,this._updateStateKey()}setPolygonOffset(e){this.stateKey=-129&this.stateKey,this.stateKey|=128*e,this._updateStateKey()}setPolygonOffsetFactorAndUnits(e,t){switch(this.stateKey=-3841&this.stateKey,e){case 0:case 1:case 2:this.stateKey|=256*e;break;default:this.needsHardUpdate=!0}switch(t){case 0:case 1:case 2:this.stateKey|=1024*t;break;default:this.needsHardUpdate=!0}this._updateStateKey()}setColorWrite(e){this.stateKey=-4097&this.stateKey,this.colorWriteMask=e,15!==e&&0!==e?this.needsHardUpdate=!0:this.stateKey|=4096*(e>0?1:0),this._updateStateKey()}setStencilOpFront(e,t,i){this.stencilKey=-512&this.stencilKey,this.stencilOpFront=[e,t,i],this.stencilKey|=64*(e-1),this.stencilKey|=8*(t-1),this.stencilKey|=1*(i-1),this._updateStateKey()}setStencilOpBack(e,t,i){this.stencilKey=-261633&this.stencilKey,this.stencilOpBack=[e,t,i],this.stencilKey|=32768*(e-1),this.stencilKey|=4096*(t-1),this.stencilKey|=512*(i-1),this._updateStateKey()}setStencilCompare(e){this.stencilCompare=e,this.stencilKey=-1835009&this.stencilKey,this.stencilKey|=262144*(e-1),this._updateStateKey()}setStencilWrite(e){this.stencilWriteMask=e,this.stencilKey=-2097153&this.stencilKey,255!==e&&0!==e?this.needsHardUpdate=!0:this.stencilKey|=2097152*(e>0?1:0),this._updateStateKey()}setStencilRead(e){this.stencilReadMask=e,this.stencilKey=-4194305&this.stencilKey,255!==e&&0!==e?this.needsHardUpdate=!0:this.stencilKey|=4194304*(e>0?1:0),this._updateStateKey()}}class j{constructor(){this.passInfo=new z,this.pipelineInfo=new W,this.encoderGPU=null,this.currentPassGPU=null}}class X extends e.WebRenderer{constructor(t){super(t),this.webGPUDevice=null,this.webGPUAdapter=null,this.webGPUInitCallback=null,this.buildDepthFunctionValues(),this.buildStencilOpValues(),this.buildFaceCullingValues(),this.buildBlendingFunctionValues(),this.buildBlendingFactorValues(),this.bindGroupOrder=["Global","Light","Material","Object"],this.bindGroupNeedsUpdate=!0,this.currentSetBindGroups=[null,null,null,null],this.sceneBindingGroupCache=new M,this.lightBindingGroupCache=new M,this.lightPBRBindingGroupCache=new M,this.lightPhongBindingGroupCache=new M,this.objectBindingGroupCaches=new Map,this.materialBindingGroupCaches=new Map,this.uboArray=new Float32Array(100),this.emptyUBOObject=null,this.textureSamplerCache=new Map,this._dummyStorageBuffer=null,this._dummyVertexBuffer=null,this.use_webgpu=!0,this.wgpuShaderBuilder=new s,this.wgpuRenderPipelines=new a(this),this.depthTexture=null,this.currentRenderState=new j,this._screenRenderTarget=null,this._computeInterface=null,this.timestampQuery=t.timestampQuery,this.context&&!this.currentProgram.program&&(this.currentProgram.program=null),this.resetPipelineInfo(),this.resetPassInfo(!0),this.setDefaultWebGPUState(),this.supportedFeatures={depthBits:Math.pow(2,-24),textureFloat:!e._mobileDevice,colorBufferFloat:!e._mobileDevice,textureFloatLinear:!e._mobileDevice,floatBlend:!0,renderToFloatTexture:!e._mobileDevice,renderToFloatRGBTexture:!1,textureHalfFloat:!0,colorBufferHalfFloat:!0,textureHalfFloatLinear:!0,renderToHalfFloatTexture:!0,renderToHalfFloatRGBTexture:!1,standardDerivatives:!0,fragDepth:!0,textureLODs:!0,KHRParallelShaderCompile:!1,completionStatusValue:null,compressedTextureETC1:!1,compressedTexturePVRTC:!1,textureFilterAnisotropic:!0,maxAnisotropy:16,instancedArrays:!1,DSInstancedArrays:null,elementIndexUint:!0,multiDraw:!1,DSMultiDraw:null,highpAvailable:!0,mediumpAvailable:!0,highpIntAvailable:!0,mediumpIntAvailable:!0,supportsVertexTextures:!0,noRGBTextures:!0,blendMinMax:!0,drawBuffers:!1},this._buildSupportedExtensionsFromFeatures(),this.lastTryCleanUnusedIndex=0,d||(d=new I(this.timestampQuery));const i=this;d.initialized().then((()=>{i.initWebGPUContext(d)}),(()=>{console.error("Cannot setup WebGPU")})),this.frameConstantUBOsResetIndex=0,this.currentPipelineKey=-1,this.currentPipeline=null,this.currentGLType=-1,this.currentObjectProgramKey=-1,this.currentFillObjectBufferFunc=()=>{},this.currentObjectBindingGroup=null}dispose(){super.dispose(),this.emptyUBOObject&&this.emptyUBOObject.destroy(!0),this.sceneBindingGroupCache.clean(),this.lightBindingGroupCache.clean(),this.lightPhongBindingGroupCache.clean(),this.lightPBRBindingGroupCache.clean(),this.objectBindingGroupCaches.forEach((e=>{e.clean()})),this.objectBindingGroupCaches.clear(),this.materialBindingGroupCaches.clear()}initWebGPUContext(t){const i=this.canvas;this.webGPUDevice=t.getGPUDevice(),this.webGPUDevice.lost.then((e=>{if("destroyed"!==e.reason){console.error(`WebGPU device was lost: ${e.message}`);const t=new Event("WebVisu_contextlost");i.dispatchEvent(t)}})),this.webGPUAdapter=t.getGPUAdapter();const r=this.webGPUAdapter.info;this.rendererInfo.gpu=r.description,this.rendererInfo.vendor=r.vendor,this.rendererInfo.architecture=r.architecture,this.rendererInfo.driver=r.driver,this.rendererInfo.backend=r.backend,this.webGPUCanvas=new R(i,this.webGPUDevice),this.context=this.webGPUDevice,(this.bufferGPUManager._device&&this.bufferGPUManager._device!==this.webGPUDevice||this.bufferGPUManager._gl)&&(e.VisualizationTraces.info("WebGLRenderer: creating BufferGPUManager for TODO: find replacement for gl.contextId"),this.bufferGPUManager=new n.__builder__),this.bufferGPUManager.setWEBGPUContext(this.id,this.webGPUDevice,this.getComputeInterface(),this.info);const s=this.webGPUDevice.features,a=this.webGPUDevice.limits;if(Object.assign(this.supportedFeatures,{depth32Stencil8:s.has("depth32float-stencil8"),float16InShader:s.has("shader-f16"),compressedTextureS3TC:s.has("texture-compression-bc"),compressedTextureRGTC:s.has("texture-compression-bc"),compressedTextureBPTC:s.has("texture-compression-bc"),compressedTextureBC3D:s.has("texture-compression-bc-sliced-3d"),compressedTextureASTC:s.has("texture-compression-astc"),compressedTextureASTCHDR:!1,compressedTextureETC:s.has("texture-compression-etc2"),maxTextures:a.maxSampledTexturesPerShaderStage,maxVertexTextures:a.maxSampledTexturesPerShaderStage,maxTextureSize:a.maxTextureDimension2D,maxCubemapSize:a.maxTextureDimension3D,maxBufferSize:a.maxBufferSize,maxStorageBufferBindingSize:a.maxStorageBufferBindingSize}),!u){u=!0;const e=this;this.webGPUDevice.queue._writeBuffer=this.webGPUDevice.queue.writeBuffer,this.webGPUDevice.queue.writeBuffer=function(...t){e.currentRenderInfo.writeUBOs++,this._writeBuffer(...t)},this._adjustTextureFormats(),this._buildSupportedExtensionsFromFeatures(),this._inheritanceSolver.setContext(this.webGPUDevice,h,null),console.log("WebGPU initialized")}this._initProgramPool(),this._dummyStorageBuffer=this.webGPUDevice.createBuffer({label:"dummy storage",size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.webGPUInitCallback&&(this.webGPUInitCallback(),this.webGPUInitCallback=null)}getComputeInterface(){if(!this._computeInterface){if(!this.webGPUDevice)return null;this._computeInterface=new o(this.webGPUDevice,this.timestampQuery)}return this._computeInterface}setDefaultWebGPUState(){this.setDepthTest(!0),this.setDepthFunc(this.depthFuncs.LEQUAL)}initFrameUBO(){}resetUpdatedUBOs(){this.frameConstantUBOsResetIndex++}increaseFrameCount(e,t){super.increaseFrameCount(e,t),this.resetUpdatedUBOs()}updateFrameUBO(e){super.updateFrameUBO(e),this.webGPUDevice&&(e!==this.camera&&this.resetUpdatedUBOs(),this.currentPipelineKey=-1)}resetPassInfo(e){if(e||this.currentRenderState.passInfo.locked){this.currentRenderState.passInfo.reset(this.gpuStates)}}resetPipelineInfo(){this.currentRenderState.pipelineInfo.reset(this)}_getScreenRenderTarget(e){var t=e.size.width,i=e.size.height;return this._screenRenderTarget&&this._screenRenderTarget.width==t&&this._screenRenderTarget.height==i||(this._screenRenderTarget=new v(t,i,{format:e.format},1,!1),this._screenRenderTarget.setCanvas(e)),this._screenRenderTarget}_initGlobals(){super._initGlobals(),this.currentObjectProgramKey=-1,this.currentObjectBindingGroup=null,this.bindGroupNeedsUpdate=!0,this.materialToUseList.pickingMaterial?this.currentFillObjectBufferFunc=a.fillObjectPickingBuffer:this.currentFillObjectBufferFunc=a.fillObjectBuffer}_preprocessPassInfo(t){let i=this.currentRenderState.passInfo,r=i.viewport;if(r.width=Math.floor(e.glStates.currentWidth),r.height=Math.floor(e.glStates.currentHeight),r.x=e.glStates.currentXOffset,r.y=Math.floor(t.height)-r.height-e.glStates.currentYOffset,this.gpuStates.scissor){let e=this.gpuStates.scissorRect,n=i.scissorRect;n.x=Math.min(t.width,Math.max(0,Math.max(e.x,r.x)));let s=Math.floor(t.height)-e.height-e.y;n.y=Math.min(t.height,Math.max(0,Math.max(s,r.y))),n.width=Math.min(t.width-n.x,Math.max(0,Math.min(e.x+e.width-n.x,r.width))),n.height=Math.min(t.height-n.y,Math.max(0,Math.min(s+e.height-n.y,r.height))),0==n.x&&0==n.y&&n.width==t.width&&n.height==t.height||i.colorLoadOp==A.CLEAR&&(i.doDrawClear=!0,i.colorLoadOp=A.LOAD)}}_initializePassStates(e,t=null){if(super._initializePassStates(e,t),!this.webGPUDevice)return;const i=this.currentRenderState;let r=this.lastRenderTarget||this._getScreenRenderTarget(this.webGPUCanvas,this.antialias);r.materialToUse=this.materialToUse,r.init(this.webGPUDevice),i.passInfo.renderTarget=r;let n=BigInt(r.depthStencilFormatClass.id);n<<=O,n+=BigInt(r.formatClass.id),n<<=4n,n+=BigInt(r.colorCount),n<<=1n,n+=BigInt(r.multisample?1:0),n<<=L,i.pipelineInfo.rtKey!==n&&(this.currentProgram.program=null),i.pipelineInfo.rtKey=n,this._preprocessPassInfo(r),i.passInfo.descriptorGPU=r.getRenderPassDescriptor(i.passInfo,t||this.currentPass.name),i.passInfo.locked=!0,i.encoderGPU=this.webGPUDevice.createCommandEncoder({label:this.currentPass.name}),i.currentPassGPU=i.encoderGPU.beginRenderPass(i.passInfo.descriptorGPU),i.currentPassGPU.descriptorGPU=i.passInfo.descriptorGPU;let s=i.passInfo.viewport;if(i.currentPassGPU.setViewport(s.x,s.y,s.width,s.height,0,1),this.gpuStates.scissor){let e=i.passInfo.scissorRect;i.currentPassGPU.setScissorRect(e.x,e.y,e.width,e.height)}i.passInfo.doDrawClear&&this._drawClear(),i.locked=!0,this.currentSetBindGroups=[null,null,null,null]}_finalizePassStates(e){super._finalizePassStates(),this._tryCleanBindGroups(this.currentFrameIndex);const t=this.currentRenderState;t.currentPassGPU&&t.currentPassGPU.end(),e||this.resetPassInfo(),t.encoderGPU&&this.webGPUDevice.queue.submit([t.encoderGPU.finish()])}__superSecretInTheMiddleOfAPassSettingChangeToUseOnlyInTheMostDireOfCircumstances(e,t){this._finalizePassStates(!0),this.currentRenderState.passInfo.locked=!1,e(),this._initializePassStates(!1,t)}_drawClear(){let e=this.currentRenderState.passInfo.renderTarget,t=e.format+"_"+e.colorCount;if(this._drawClearPipeline||(this._drawClearPipeline={}),!this._drawClearPipeline[t]){let i=this.webGPUDevice.createShaderModule({label:" draw clear frame",code:"\n                            var<private> pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(\n                            vec2<f32>(-1.0, -1.0), vec2<f32>(-1.0, 3.0), vec2<f32>(3.0, -1.0));\n\n                            struct VertexOutput {\n                            @builtin(position) position : vec4<f32>\n                            };\n\n                            @vertex\n                            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                            var output : VertexOutput;\n                            output.position = vec4<f32>(pos[vertexIndex], 0.0, 1.0);\n                            return output;\n                            }\n\n                            @fragment\n                            fn fragmentMain() -> @location(0) vec4<f32> {\n                            return vec4f(1.0, 1.0, 1.0, 1.0);//overriden by blending constant\n                            }\n                        "}),r=this.webGPUDevice.createPipelineLayout({label:"draw clear layout",bindGroupLayouts:[]}),n=[];for(let t=0;t<e.colorCount;t++)n.push({format:e.format,blend:{color:{srcFactor:"constant",dstFactor:"zero"},alpha:{srcFactor:"constant",dstFactor:"zero"}}});this._drawClearPipeline[t]=this.webGPUDevice.createRenderPipeline({label:" draw clear pipeline",layout:r,vertex:{module:i,entryPoint:"vertexMain"},fragment:{module:i,entryPoint:"fragmentMain",targets:n},depthStencil:{format:e.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"always"}})}this.currentRenderState.currentPassGPU.setBlendConstant(this.currentRenderState.passInfo.clearColor),this.currentRenderState.currentPassGPU.setPipeline(this._drawClearPipeline[t]),this.currentRenderState.currentPassGPU.draw(3)}buildShader(n,s,o,l,h,c,d,u,p,v,_,y,S,b,x){let w=this.materialToUseList;if(l.program=l.id,!o.WebGPU)return;o.shaderContext=b,o.shaderIO={objectUBOKey:-1,globalUBOKey:-1,objectUBOFillFunc:null,objectUBOUpdateFunc:null,globalUBOFillFunc:null,uniformLayouts:{},orderedUniforms:{},attribute:{},structSize:{}};for(var P=o.shaderIO.attribute,C={position:{name:"aPosition",type:o.compressedVertices?o.useCompressionContext?"v4":"v2":"v3"},normal:{name:"aNormal",type:o.compressedNormals?"f":"v3"},uv:{name:"aUv",type:"v4"},uv2:{name:"aUv2",type:"v4"},tangent:{name:"aTangent",type:"v3"},binormal:{name:"aBinormal",type:"v3"},color:{name:"aColor",type:o.compressedColors?"v2":"v4"},lineDistance:{name:"aLineDistance",type:"v2"},linePixelDistance:{name:"aLinePixelDistance",type:"v2"},patternStartEnd:{name:"aPatternStartEnd",type:"v2"},previousPos:{name:"aPreviousPos",type:"v3"},followingPos:{name:"aFollowingPos",type:"v3"},sideExtrusion:{name:"aSideExtrusion",type:"f"},instanceId:{name:"aInstanceId",type:"f"},defaultInstancingMatrix:{name:"aDefaultInstancingMatrix",type:"m4"},skinIndex:{name:"aSkinIndex",type:"v4"},skinWeight:{name:"aSkinWeight",type:"v4"},morphTarget0:{name:"aMorphTarget0",type:"v3"},morphTarget1:{name:"aMorphTarget1",type:"v3"},morphTarget2:{name:"aMorphTarget2",type:"v3"},morphTarget3:{name:"aMorphTarget3",type:"v3"},morphNormals0:{name:"aMorphNormals0",type:"v3"},morphNormals1:{name:"aMorphNormals1",type:"v3"},morphNormals2:{name:"aMorphNormals2",type:"v3"},morphNormals3:{name:"aMorphNormals3",type:"v3"},morphTarget4:{name:"aMorphTarget4",type:"v3"},morphTarget5:{name:"aMorphTarget5",type:"v3"},morphTarget6:{name:"aMorphTarget6",type:"v3"},morphTarget7:{name:"aMorphTarget7",type:"v3"}},M=_.getBufferAttributes(),E=0;E<M.length;E++)if(M[E]){var T=M[E][0];C[T]?P[C[T].name]=C[T]:P[T]=T}o.isMultiInstanced&&(P[C.instanceId.name]=C.instanceId),o.defaultInstancing&&(P[C.defaultInstancingMatrix.name]=C.defaultInstancingMatrix);var A=`\n                    ${i.Default_uniforms_declaration(o)}\n                    ${i.normalMatrix_uniforms_declaration(o)}\n                    ${i.double_emulation_utilities(o)}\n                    ${i.double_emulation(o)}\n\n                    ${i.math_utils_pars(o)}\n\n                    ${i.sRGB_conversion(o)}\n                    ${i.gpu_scenegraph_nodes(o)}\n                    \n                    ${t.model_view_transformation_pars(o)}\n                    ${t.model_view_unit_transformation_pars(o)}\n                    \n                    ${i.rgba_packing_pars(o)}\n                    ${i.decompress_vertices_pars(o)}\n                    ${i.decompress_normals_pars(o)}\n                    ${i.decompress_uvs_pars(o)}\n                    ${i.decompress_colors_pars(o)}\n\n                    ${r.multidraw_pars_vertex(o)}\n\n                    const DEPTH_PRECISION = ${this.supportedFeatures.depthBits};\n                    const MAX_TEXTURE_SIZE = ${this.supportedFeatures.maxTextureSize};\n                `,D=`\n                    ${i.attribute_uniforms_pars_vertex(o)}\n                    ${A}\n\n                    ${o.PDSFX?`\n                        ${i.PDSFX_header_vertex(o)}\n                        `:""}\n                `,I=`\n\n                    ${A}\n                    ${t.planar_normal_pars_fragment(o)}\n\n                    var<private> tangent: vec3f;\n                    var<private> binormal: vec3f;\n                    \n                `;"custom"===s?[h,c]=this.setMaterialShaders(n.postProBuilder,w.lightedMaterial,o,_,x):null!==s&&([h,c]=this.setMaterialShaders(e.ShaderLib[s],w.lightedMaterial,o,_,x)),this.wgpuShaderBuilder.computeLayoutInfos(o);for(let e in o.shaderIO.structSize)this.updateUniformBufferArray(o.shaderIO.structSize[e]*m);var R=h,O=c;(!s||"gaussianSplat"===s)&&(R=R.replace(/(var out: VertexOutput;)/,"$&"+i.attribute_vertex(o)+"\n"+i.large_scale_VS(o)),O=O.replace(/(var out: FragmentOutput;)/,"$&"+i.large_scale_FS(o)));var L=this.wgpuShaderBuilder.getVertexInCode(o)+this.wgpuShaderBuilder.getVertexOutCode(o)+this.wgpuShaderBuilder.getFragmentInCode(o)+this.wgpuShaderBuilder.getFragmentOutCode(o)+this.wgpuShaderBuilder.getUniformsCode(o,this.bindGroupOrder),B=L+"\n"+D+"\n"+p+"\n"+R,F=L+"\n"+I+"\n"+v+"\n"+O;F=e.SplitTrimStickString(F),B=e.SplitTrimStickString(B),l.shaderIO=o.shaderIO,l.uniforms=b.__uniforms__,this.handleError(f,(()=>{l.wgslShaderModuleVertex=this.webGPUDevice.createShaderModule({label:`vertex ${n.constructor.name}`,code:"diagnostic(off,derivative_uniformity);\n"+B})}),(e=>{if(console.error(`[Invalid Vertex shader] ${n.constructor.name}`),console.error(e.message),console.error(this.addLineNumbers(B)),g)throw"A shader has failed to compile"})),this.handleError(f,(()=>{l.wgslShaderModuleFragment=this.webGPUDevice.createShaderModule({label:`fragment ${n.constructor.name}`,code:"diagnostic(off,derivative_uniformity);\n"+F})}),(e=>{if(console.error(`[Invalid Fragment shader] ${n.constructor.name}`),console.error(e.message),console.error(this.addLineNumbers(F)),g)throw"A shader has failed to compile"})),l.bufferLayouts=a.createBufferLayouts(_,P,y)}handleError(e,t,i){this.webGPUDevice.pushErrorScope(e),t(),this.webGPUDevice.popErrorScope().then((e=>{e&&i(e)}))}createProgramObject(){return new k}createGSSOCache(e){let t=!0,i=e;if(e.selectionParentMesh&&(e=e.selectionParentMesh,t=!1),e._resetCurrentBindingGroups(),e._bindingGroups&&t)e._bindingGroups.clean();else if(!e._bindingGroups&&(e._bindingGroups=new M,e.preHighlight&&(e.preHighlight._bindingGroups=e._bindingGroups),e.highlightMeshes))for(let t=0;t<e.highlightMeshes.length;t++){e.highlightMeshes[t].renderable._bindingGroups=e._bindingGroups}return!i._bindingGroups&&i.selectionParentMesh&&(console.error("ERROR: link between parent and highlight mesh has been broken!!!"),i._bindingGroups=e._bindingGroups),{renderer:this}}getUniformBufferObject(e,t,i){const r=this;if(i<=0){if(!this.emptyUBOObject){this.memoryInfo.ubos++;const e=this.webGPUDevice.createBuffer({label:"Empty",size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});e._ab=null,e.destroyed=!1,e.sizeFloat32=e.size*m,this.memoryInfo.totalUBOSize+=e.size,e._destroy=e.destroy,e.destroy=function(e){e&&(r._ab=null,r.memoryInfo.ubos--,r.memoryInfo.totalUBOSize-=this.size,this._destroy(),this.destroyed=!0)},this.emptyUBOObject=e}return this.emptyUBOObject}this.memoryInfo.ubos++;const n=this.webGPUDevice.createBuffer({label:e,size:i,usage:t});return n.destroyed=!1,n._ab=null,n.sizeFloat32=n.size*m,this.memoryInfo.totalUBOSize+=n.size,n._destroy=n.destroy,n.destroy=function(){r._ab=null,r.memoryInfo.ubos--,r.memoryInfo.totalUBOSize-=this.size,this._destroy(),this.destroyed=!0},n}updateUniformBufferArray(e){this.uboArray.length<e&&(this.uboArray=new Float32Array(e))}setBindGroup(e,t){this.currentSetBindGroups[e]!==t&&(this.currentSetBindGroups[e]=t,this.currentRenderState.currentPassGPU.setBindGroup(e,t))}prepareObjectBindGroup(e,t,i,r,n){if(this.currentModelMatrix!==e.matrixWorld){const s=i.program,a=s.bindingGroups,o=this.currentObjectProgramKey;if(e._currentBindingGroupKey!==o){if(a.Object=e._bindingGroups.get(o),!a.Object){let t=s.shaderIO.structSize.object,i=`Object ${e.id}-${o}-${t}`;this.materialToUseList.pickingMaterial&&(i+="p"+n);let r=this.getUniformBufferObject(i,GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,t);a.Object=new C(r,i),e._bindingGroups.set(o,a.Object),this.objectBindingGroupCaches.set(e.selectionParentMesh?e.selectionParentMesh.id:e.id,e._bindingGroups)}e._currentBindingGroup=a.Object,e._currentBindingGroupKey=o}else a.Object=e._currentBindingGroup;if(this.currentObjectBindingGroup=a.Object,this.currentFillObjectBufferFunc(e,t,n,i,r,this,a.Object)){let e=a.Object.uniformBuffer;this.webGPUDevice.queue.writeBuffer(e,0,e._ab,0,e.sizeFloat32),a.Object.needsUpdate&&a.Object.createBindGroup(this)}if(!this.bindGroupNeedsUpdate){const e=this.currentPipeline,t=this.currentFrameIndex;this.setBindGroup(e.layoutOrder.Object,a.Object.bindGroup),a.Object.lastUsedFrameIndex=t}}}prepareGlobalBindGroup(e){const t=e.program,i=t.bindingGroups;if(!i.Global){this.bindGroupNeedsUpdate=!0;const e=t.shaderIO.globalUBOKey;if(i.Global=this.sceneBindingGroupCache.get(e),!i.Global){let r=t.shaderIO.structSize.global,n=`Global ${e}-${r}`,s=this.getUniformBufferObject(n,GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,r);i.Global=new w(s,n),this.sceneBindingGroupCache.set(e,i.Global)}}if(a.fillGlobalBuffer(e,this,i.Global)){let e=i.Global.uniformBuffer;this.webGPUDevice.queue.writeBuffer(e,0,e._ab,0,e.sizeFloat32),i.Global.needsUpdate&&i.Global.createBindGroup(this)}}prepareLightBindGroup(e,t){if(!this.materialToUseList.lightedMaterial)return;const i=e.program,r=i.bindingGroups;if(!r.Light){this.bindGroupNeedsUpdate=!0;const t=this.lightsKey,n=e._getLightsUBOCache(this);if(r.Light=n.get(t),!r.Light){let e=i.shaderIO.structSize.light,s=`Light ${t}-${e}`,a=this.getUniformBufferObject(s,GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,e);r.Light=new P(a,s),n.set(t,r.Light)}}if(a.fillLightBuffer(t,e,this,r.Light)){let e=r.Light.uniformBuffer;this.webGPUDevice.queue.writeBuffer(e,0,e._ab,0,e.sizeFloat32),r.Light.needsUpdate&&r.Light.createBindGroup(this)}}prepareMaterialBindGroup(e,t,i,r,n,s,o){const l=e.program,h=l.bindingGroups;if(h.Material=l.materialBindingGroups.get(e,t,n,i,r,s),!h.Material){this.bindGroupNeedsUpdate=!0;const a=l.shaderIO.structSize.material,o=l.shaderIO.structSize.materialhigh,c=`Material ${e.constructor.name}-${e.id}-${l.id}-${l.shaderID}-${a}-${o}`;let d=l.materialBindingGroups.getMaterialUBO(e),u=!0;d||(d=this.getUniformBufferObject(c+"-base",GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,a),u=!1),l.materialBindingGroups.setMaterialUBO(e,d);let p=o?this.getUniformBufferObject(c+"-high",GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,o):null;if(null!=p&&(l.hasHighFrequencyUniforms=l.materialBindingGroups._isVeryHighFrequency(e,n,t,i,r,s)?2:1),h.Material=0!==l.hasHighFrequencyUniforms?new x(d,c,p):new b(d,c),u){let t=l.materialBindingGroups._getFirstUpdateBindingGroupForMaterial(e);t&&h.Material.shareFrom(t)}l.materialBindingGroups.set(e,t,n,i,r,h.Material,s),this.materialBindingGroupCaches.set(l.id,l.materialBindingGroups)}if(a.fillMaterialBuffer(t,e,this,h.Material,s,o)){let e=l.bindingGroups.Material.uniformBuffer;this.webGPUDevice.queue.writeBuffer(e,0,e._ab,0,e.sizeFloat32),h.Material.needsUpdate&&0===l.hasHighFrequencyUniforms&&h.Material.createBindGroup(this)}1===l.hasHighFrequencyUniforms&&this.prepareMaterialHighBindGroup(e,i,r,n,t,s,o,!1)}prepareMaterialHighBindGroup(e,t,i,r,n,s,o,l){const h=e.program,c=h.bindingGroups;if(a.fillMaterialHighBuffer(e,r,i,this,c.Material,t,n,s,o,l)){let e=h.bindingGroups.Material.uniformBufferHighFrequency;this.webGPUDevice.queue.writeBuffer(e,0,e._ab,0,e.sizeFloat32),c.Material.needsUpdate&&c.Material.createBindGroup(this)}}_cleanProgramPool(e){if(super._cleanProgramPool(e)){const e=this.wgpuRenderPipelines.pipelines,t=new Map;return e.forEach(((e,i)=>{e&&t.set(i,e)})),this.wgpuRenderPipelines.pipelines=t,this.memoryInfo.pipelines=t.size,!0}return!1}_tryCleanBindGroups(e){if(e-this.lastTryCleanUnusedIndex<5e3)return;this.lastTryCleanUnusedIndex=e,this.sceneBindingGroupCache.cleanUnused(e),this.lightBindingGroupCache.cleanUnused(e),this.lightPhongBindingGroupCache.cleanUnused(e),this.lightPBRBindingGroupCache.cleanUnused(e);let t=[];this.materialBindingGroupCaches.forEach(((e,i,r)=>{0===e.size()&&t.push(i)}));for(let e=0;e<t.length;e++)this.materialBindingGroupCaches.delete(t[e])}_cleanObjectUBOs(e){if(!e.selectionParentMesh){const t=this.objectBindingGroupCaches.get(e.id);t&&t.clean(),e._resetCurrentBindingGroups()}this.materialBindingGroupCaches.forEach(((t,i,r)=>{t.cleanObject(e)}))}_cleanRenderableAssets(e){super._cleanRenderableAssets(e),this._cleanObjectUBOs(e)}setRenderTarget(e){this.lastRenderTarget=e,super.setRenderTarget(e)}_testPassInfoLock(e){return!this.currentRenderState.passInfo.locked||(!e&&console.error("trying to update passInfos after the renderPass is created, change won't be applied.\nConsider moving you code before WebRenderer.render\n If you really need to modify this setting after the pass has already been created, then contact xbu1 to plead your case"),!1)}_testPipelineInfoLock(){this.currentRenderState.pipelineInfo.locked&&console.warn("trying to update pipelineInfos after the pipeline is created, change won't be applied")}buildDepthFunctionValues(){this.depthFuncs={NEVER:1,LESS:2,EQUAL:3,LEQUAL:4,GREATER:5,NOTEQUAL:6,GEQUAL:7,ALWAYS:8}}buildStencilOpValues(){this.stencilOps={KEEP:1,ZERO:2,REPLACE:3,INVERT:4,INCR:5,DECR:6,INCR_WRAP:7,DECR_WRAP:8}}buildFaceCullingValues(){this.cullings={NONE:1,BACK:2,FRONT:3}}buildBlendingFunctionValues(){this.blendingFuncs={ADD:1,SUB:2,REVERSE_SUB:3,MIN:4,MAX:5}}buildBlendingFactorValues(){this.blendingFactors={ZERO:1,ONE:2,SRC:3,ONE_MINUS_SRC:4,SRC_ALPHA:5,ONE_MINUS_SRC_ALPHA:6,DST_ALPHA:7,ONE_MINUS_DST_ALPHA:8,DST:9,ONE_MINUS_DST:10,SRC_ALPHA_SATURATED:11}}_getGPUDepthCompareValue(){return this.gpuStates.depthTest?this.gpuStates.depthFunc:this.depthFuncs.ALWAYS}_getGPUStencilCompareValue(){return this.gpuStates.stencilTest?this.gpuStates.stencilFunc:this.depthFuncs.ALWAYS}_getGPUStencilOpValues(){return this.gpuStates.stencilOp?this.gpuStates.stencilOp:[this.stencilOps.KEEP,this.stencilOps.KEEP,this.stencilOps.KEEP]}_setBlending(e,t,i,r,n,s,a){this._testPipelineInfoLock();let o=this.currentRenderState.pipelineInfo.blendingState;o.enable!==e&&o.setEnable(e),o.eq1!==t&&o.setEq1(t),o.src1!==i&&o.setSrc1(i),o.dst1!==r&&o.setDst1(r),o.eq2!==n&&o.setEq2(n),o.src2!==s&&o.setSrc2(s),o.dst2!==a&&o.setDst2(a)}setDepthFunc(e){this._testPipelineInfoLock(),super.setDepthFunc(e);const t=this.currentRenderState.pipelineInfo;t.depthCompare!==this._getGPUDepthCompareValue()&&t.setDepthCompare(this._getGPUDepthCompareValue())}setDepthTest(e){this._testPipelineInfoLock(),super.setDepthTest(e);const t=this.currentRenderState.pipelineInfo;t.depthCompare!==this._getGPUDepthCompareValue()&&t.setDepthCompare(this._getGPUDepthCompareValue())}setStencilTest(e){this._testPipelineInfoLock(),super.setStencilTest(e);const t=this.currentRenderState.pipelineInfo;t.stencilCompare!==this._getGPUStencilCompareValue()&&t.setStencilCompare(this._getGPUStencilCompareValue())}setPolygonOffset(e,t,i){let r=this.gpuStates;const n=this.currentRenderState.pipelineInfo;r.polygonOffset!==e&&(n.setPolygonOffset(e),r.polygonOffset=e),!e||r.polygonOffsetFactor===t&&r.polygonOffsetUnits===i||(r.polygonOffsetFactor=t,r.polygonOffsetUnits=i,n.setPolygonOffsetFactorAndUnits(t,i))}enableScissorTest(e){this._testPassInfoLock(),super.enableScissorTest(e)}setScissor(e,t,i,r){this._testPassInfoLock(),super.setScissor(e,t,i,r)}clear(e,t,i){if(this._testPassInfoLock(!e&&!t&&i)){const r=this.currentRenderState.passInfo;r.colorLoadOp=void 0===e||e?A.CLEAR:A.LOAD,r.depthLoadOp=void 0===t||t?A.CLEAR:A.LOAD,r.stencilLoadOp=void 0===i||i?A.CLEAR:A.LOAD}else{let e=this.currentRenderState.passInfo.renderTarget,t=e.depthStencilFormat;const i={code:"\n                        @vertex\n                        fn vs_main(@builtin(vertex_index) index : u32) -> @builtin(position) vec4f {\n                          var positions = array<vec2f, 4>(\n                            vec2f(-1.0, -1.0),\n                            vec2f( 1.0, -1.0),\n                            vec2f(-1.0,  1.0),\n                            vec2f( 1.0,  1.0)\n                          );\n                          let pos = positions[index];\n                          return vec4f(pos, 0.0, 1.0);\n                        }\n\n                        @fragment\n                        fn fs_main() -> @location(0) vec4f {\n                          return vec4f(0.0, 0.0, 0.0, 0.0);\n                        }\n                      "},r=this.webGPUDevice.createRenderPipeline({layout:"auto",vertex:{module:this.webGPUDevice.createShaderModule(i),entryPoint:"vs_main"},fragment:{module:this.webGPUDevice.createShaderModule(i),entryPoint:"fs_main",targets:[{format:e.format,writeMask:0}]},depthStencil:{format:t,depthWriteEnabled:!1,depthCompare:"always",stencilFront:{compare:"always",passOp:"replace",failOp:"replace",depthFailOp:"replace"},stencilBack:{compare:"always",passOp:"replace",failOp:"replace",depthFailOp:"replace"},stencilWriteMask:255,stencilReadMask:255},primitive:{topology:"triangle-strip"}});this.currentRenderState.currentPassGPU.setPipeline(r),this.currentRenderState.currentPassGPU.draw(4),this.currentPipelineKey=-1}}setClearColor(e,t){super.setClearColor(e,t),this._testPassInfoLock(),this.currentRenderState.passInfo.clearColor={r:e.r,g:e.g,b:e.b,a:t}}setClearDepth(e){super.setClearDepth(e),this._testPassInfoLock(),this.currentRenderState.passInfo.clearDepth=e}setClearStencil(e){super.setClearStencil(e),this._testPassInfoLock(),this.currentRenderState.passInfo.clearStencil=e}setColorWrite(e){if(this.disableSetColorWrite)return;this._testPipelineInfoLock();const t=e?15:0,i=this.currentRenderState.pipelineInfo;i.colorWriteMask!==t&&i.setColorWrite(t)}setStencilWrite(e){this._testPipelineInfoLock();const t=e?255:0,i=this.currentRenderState.pipelineInfo;i.stencilWriteMask!==t&&i.setStencilWrite(t)}setDepthWrite(e){this._testPipelineInfoLock();const t=this.currentRenderState.pipelineInfo;t.depthWriteEnabled!==!!e&&t.setDepthWrite(!!e)}setStencilFunc(e,t,i){this._testPipelineInfoLock();const r=this.currentRenderState.pipelineInfo;r.stencilCompare!==e&&r.setStencilCompare(e),r.stencilRef!==(t||0)&&(this.currentPipelineKey=-1,r.stencilRef=t||0);const n=null==i?255:i;r.stencilReadMask!==n&&r.setStencilRead(n),super.setStencilFunc(e,t,i)}setStencilOp(e,t,i){this._testPipelineInfoLock(),this.setStencilOpFront(e,t,i),this.setStencilOpBack(e,t,i),super.setStencilOp(e,t,i)}setStencilOpFront(e,t,i){this._testPipelineInfoLock();const r=this.currentRenderState.pipelineInfo;r.stencilOpFront[0]===e&&r.stencilOpFront[1]===t&&r.stencilOpFront[2]===i||r.setStencilOpFront(e,t,i),super.setStencilOpFront(e,t,i)}setStencilOpBack(e,t,i){this._testPipelineInfoLock();const r=this.currentRenderState.pipelineInfo;r.stencilOpBack[0]===e&&r.stencilOpBack[1]===t&&r.stencilOpBack[2]===i||r.setStencilOpBack(e,t,i),super.setStencilOpBack(e,t,i)}setFrontFace(e){this._testPipelineInfoLock();const t=this.currentRenderState.pipelineInfo;t.frontFace!==e&&t.setFrontFace(e),super.setFrontFace(e)}setCullMode(e){this._testPipelineInfoLock();const t=this.currentRenderState.pipelineInfo;t.cullMode!==e&&t.setCullMode(e),super.setCullMode(e)}setViewport(t,i,r,n){let s=super.setViewport(t,i,r,n),a=this.currentRenderState.passInfo;if(s&&a.locked){let t=a.renderTarget,i=Math.floor(t.height)-Math.floor(e.glStates.currentHeight)-e.glStates.currentYOffset;this.currentRenderState.currentPassGPU.setViewport(e.glStates.currentXOffset,i,Math.floor(e.glStates.currentWidth),Math.floor(e.glStates.currentHeight),0,1)}}_getTempTexture(){if(this._wgpuBlankTexture)return this._wgpuBlankTexture;const e=new Uint8Array([255,255,255,255,255,0,0,255,0,255,0,255,0,0,255,255]);var t=this.webGPUDevice.createTexture({label:"loading texture",size:{width:2,height:2},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});return this.webGPUDevice.queue.writeTexture({texture:t},e,{bytesPerRow:8},{width:2,height:2}),this._wgpuBlankTexture=t,t.formatClass=_.rgba8unorm,t.textureView=t.createView({label:"temp texture"}),this._wgpuBlankTexture}renderInterval(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m){const v=this._cullDGSSB(e,i,n,s,a,o,g,m,d);if(v){if(0===v.totalCount)return!1;a=v.starts[0],o=v.counts[0],g=v.starts,m=v.counts}const _=this.currentRenderInfo;_.nbDGs++;const y=s.glType;let b=r.program;this._renderInterval_lastMinuteBufferHandling(i,n,s,d,u,r,b);let x=T.vertexBuffer;const w=T.indexBuffer;let P=T.updateBuffers;const C=T.instanceAttribArrays;if(!x||!w)return!1;x!==this.currentVertexBuffer&&(this.currentVertexBuffer=x,P=!0,c=c||n.layout._layoutKey!==this.currentLayoutSignature);var M=r.programManager.getTokenProgramID(d);(c||M!==this.currentProgramID)&&(r.previousOccurrenceRenderingOverride=null,this.setProgram(e,t,r,i,h,n,d,M,u,p,f,s),b=r.program);const E=b.bindingGroups;if(this.prepareObjectBindGroup(i,n,r,u,y),2===b.hasHighFrequencyUniforms&&(this.prepareMaterialBindGroup(r,i,h,u,p,s,d),this.prepareMaterialHighBindGroup(r,h,u,p,i,s,d,!0),!this.bindGroupNeedsUpdate)){const e=this.currentPipeline,t=this.currentFrameIndex;this.setBindGroup(e.layoutOrder.Material,E.Material.bindGroup),E.Material.lastUsedFrameIndex=t}const A=this.currentRenderState;this.currentGLType!==y&&(A.pipelineInfo._updateRTProgramGLTypeKey(y),this.currentGLType=y);var D=A.pipelineInfo.finalKey;if((A.pipelineInfo.needsHardUpdate||this.currentPipelineKey!==D)&&(this.currentPipeline=this.wgpuRenderPipelines.getPipeline(D,this.webGPUDevice,this.gpuStates,r,this.bindGroupOrder,A,y),A.currentPassGPU.setPipeline(this.currentPipeline.getPipeline()),A.currentPassGPU.setStencilReference(A.pipelineInfo.stencilRef),this.currentPipelineKey=D),this.bindGroupNeedsUpdate){const e=this.currentPipeline,t=this.currentFrameIndex;this.bindGroupNeedsUpdate=!1,this.setBindGroup(e.layoutOrder.Global,E.Global.bindGroup),E.Global.lastUsedFrameIndex=t,this.setBindGroup(e.layoutOrder.Material,E.Material.bindGroup),E.Material.lastUsedFrameIndex=t,this.setBindGroup(e.layoutOrder.Object,E.Object.bindGroup),E.Object.lastUsedFrameIndex=t,E.Light&&(this.setBindGroup(e.layoutOrder.Light,E.Light.bindGroup),E.Light.lastUsedFrameIndex=t)}if(r._hasLODTextures&&r._chooseLODTextures(e,i),P){_.swapBuffers++,_.unsharedBuffers+=n.sharedBuffers&&!x.isShared?1:0;let e=0,t=x.numVertices;if(y===S.POINTS){t=6;let e=t*b.bufferLayouts[0].arrayStride;t>x.numVertices&&(null===this._dummyVertexBuffer?this._dummyVertexBuffer=this.webGPUDevice.createBuffer({label:"Dummy WebGPU Points Vertex Buffer",size:e,usage:GPUBufferUsage.VERTEX}):this._dummyVertexBuffer.size<e&&(this._dummyVertexBuffer.destroy(),this._dummyVertexBuffer=this.webGPUDevice.createBuffer({label:"Dummy WebGPU Points Vertex Buffer",size:e,usage:GPUBufferUsage.VERTEX})),x={buffer:this._dummyVertexBuffer})}let i=b.bufferLayouts[0].arrayStride,r=t*i;if(x.buffer.size<r)throw`Vertex range (${t}) requires a larger buffer (${t*i}) than the bound buffer size (${x.buffer.size}) of the vertex buffer at slot 0 with stride ${i}.`;if(this.currentRenderState.currentPassGPU.setVertexBuffer(e++,x.buffer,0),null!==C)for(var I in C){let t=I;if("instanceId"==I?t="aInstanceId":"defaultInstancingMatrix"==I&&(t="aDefaultInstancingMatrix"),!b.shaderIO.attribute[t])continue;const i=C[I];this.currentRenderState.currentPassGPU.setVertexBuffer(e++,i.buffer,0)}}if(w!==this.currentIndexBuffer&&(this.currentIndexBuffer=w,s.indirectBuffer&&s.indirectIndexBuffer?this.currentRenderState.currentPassGPU.setIndexBuffer(s.indirectIndexBuffer,w.format,0):w.buffer&&this.currentRenderState.currentPassGPU.setIndexBuffer(w.buffer,w.format,0)),d){y===S.TRIANGLES||y===S.LINES||y===S.POINTS?d.draw(this.currentRenderState.currentPassGPU,d,o):console.warn(`Unsupported draw with glType ${y}`);let e=o;if(m)for(var R=0;R<m.length;++R)e+=m[R];_.vertices+=e,y===S.TRIANGLES?_.faces+=e/3:y===S.LINES?_.lines+=e/2:y===S.POINTS?_.points+=e:y===S.TRIANGLE_STRIP&&(_.faces+=e+2)}else{const e=y===S.TRIANGLES||y===S.TRIANGLE_STRIP;r.wireframe&&e?console.warn("Unsupported operation: wireframe"):y===S.POINTS&&n.vertexPositionArray&&n.vertexPositionArray.nonindexedPoints?console.warn("Unsupported operation: non indexed points"):s.nonIndexed?this.currentRenderState.currentPassGPU.draw(o,1,a):this.currentRenderState.currentPassGPU.drawIndexed(o,1,a+n.indexOffsetGPU)}return _.calls++,!0}setProgramWithUniforms(e,t,i,r,n,s,a,o,l,h,c,d){const u=this.setProgram(e,t,i,r,n,s,a,o,l,h,c,d),p=d?d.glType:S.TRIANGLES;if(this.prepareObjectBindGroup(r,s,i,l,p),2===u.hasHighFrequencyUniforms&&(this.prepareMaterialBindGroup(i,r,n,l,h,d,a),this.prepareMaterialHighBindGroup(i,n,l,h,r,d,a,!0),!this.bindGroupNeedsUpdate)){const e=this.currentPipeline,t=this.currentFrameIndex;this.setBindGroup(e.layoutOrder.Material,v.Material.bindGroup),v.Material.lastUsedFrameIndex=t}const f=this.currentRenderState;this.currentGLType!==p&&(f.pipelineInfo._updateRTProgramGLTypeKey(p),this.currentGLType=p);var g=f.pipelineInfo.finalKey;(f.pipelineInfo.needsHardUpdate||this.currentPipelineKey!==g)&&(this.currentPipeline=this.wgpuRenderPipelines.getPipeline(g,this.webGPUDevice,this.gpuStates,i,this.bindGroupOrder,f,p),f.currentPassGPU.setPipeline(this.currentPipeline.getPipeline()),f.currentPassGPU.setStencilReference(f.pipelineInfo.stencilRef),this.currentPipelineKey=g);var m=this.currentPipeline;const v=u.bindingGroups;if(this.bindGroupNeedsUpdate){const e=this.currentFrameIndex;this.bindGroupNeedsUpdate=!1,this.setBindGroup(m.layoutOrder.Global,v.Global.bindGroup),v.Global.lastUsedFrameIndex=e,this.setBindGroup(m.layoutOrder.Material,v.Material.bindGroup),v.Material.lastUsedFrameIndex=e,this.setBindGroup(m.layoutOrder.Object,v.Object.bindGroup),v.Object.lastUsedFrameIndex=e,v.Light&&(this.setBindGroup(m.layoutOrder.Light,v.Light.bindGroup),v.Light.lastUsedFrameIndex=e)}return u}setProgram(e,t,i,r,n,s,a,o,l,h,c,d){this.usedTextureUnits=0;let u=this.materialToUseList;const p=this.getContextId(e),f=this.id|this._globalProgramID,g=this.currentRendererMode,m=i.programManager,v=c+s.layout._layoutKey*y;v===m.currentRenderingContext&&g===m.currentRendererMode&&f===m.currentRendererId&&p===m.currentContextId||m.setActivePool(p,f,g,v),i.needsUpdate||(i.program=m.getProgram(o,this.shaderVersions[this.currentRendererMode],this.deallocateMaterial),null===i.program&&(this.initMaterial(e,i,t,r,s,d,a,o,l,c),i._notifyDLtoBeSortedNextFrame(this.currentSSRID))),u.lightedMaterial&&i.program&&(i.program._lightsKey!==this.lightsKey||i.program._ambianceKey!==this.ambianceKey)&&i.program._materialToUse===c&&(m.disposeCurrentProgram(this.deallocateMaterial,o),this.initMaterial(e,i,t,r,s,d,a,o,l,c),i._notifyDLtoBeSortedNextFrame(this.currentSSRID)),i.needsUpdate&&(m.disposeAllPrograms(this.deallocateMaterial),m.setActivePool(p,f,g,v),this.initMaterial(e,i,t,r,s,d,a,o,l,c),i.needsUpdate=!1,i._notifyAllDLtoBeSortedNextFrame());var _=!1,S=!1,b=i.program,x=b.program,w=n?n.id:-1,P=h?h.id:-1,C=l&&l._mappingOperator?l.id:-1;if((i.id!==this.currentMaterialId||w!==this.currentMaterialOverrideId||P!==this.currentGASMatIdrrideId||C!==this.currentMatAppId||i._hasDGUniform)&&(this.currentRenderInfo.swapMaterials++,this.bindGroupNeedsUpdate=!0,this.currentMaterialId=i.id,this.currentMaterialOverrideId=w,this.currentGASMatId=P,this.currentMatAppId=C,_=!0),x!==this.currentProgram.program){this.currentRenderInfo.swapPrograms++,this.bindGroupNeedsUpdate=!0,this.currentProgram.program=x;const e=this.currentRenderState.pipelineInfo;e.rtProgramKey=e.rtKey+BigInt(x)<<G,this.currentGLType=-1,this.currentVertexBuffer=null,this.currentIndexBuffer=null,S=!0,_=!0;let t=b.shaderIO.objectUBOKey;this.materialToUseList.pickingMaterial&&(t+=d.glType+1);const i=b.bindingGroups;i.Object||(i.Object=this.currentObjectBindingGroup);(i.Object&&i.Object.destroyed||t!==this.currentObjectProgramKey||i.Object&&i.Object.matrixRevision!==this.currentModelMatrix)&&(this.currentModelMatrix=null,this.currentObjectBindingGroup=null,i.Object=null),this.currentObjectProgramKey=t,i.Material&&i.Material.destroyed&&(i.Material=null),i.Global&&i.Global.destroyed&&(i.Global=null),i.Light&&i.Light.destroyed&&(i.Light=null)}return this.currentScene!==this.scene||e!==this.currentCamera?(this.currentRenderInfo.swapScenes++,S=!0):b._clipPlanesVersion!==this._clipPlanesState.version&&(S=!0),S&&(this.currentCamera=e,this.currentScene=this.scene,this.prepareGlobalBindGroup(i),_&&(u.lightedMaterial&&this.lightsNeedUpdate&&(this.setupLights(t,e),this.lightsNeedUpdate=!1),r.receiveShadow&&!u.shadowPassMaterial&&this.setupShadows(t,i),this.prepareLightBindGroup(i,r))),_&&(i.refreshUniforms(this,r),this.prepareMaterialBindGroup(i,r,n,l,h,d,a)),b._clipPlanesVersion=this._clipPlanesState.version,this.currentProgramID=o,this.currentLayoutSignature=s.layout._layoutKey,b}_createTextureSampler(t,i,r){let n=t.magFilter,s=t.minFilter;const a=t.wrapS,o=t.wrapT,l=t.anisotropy||1;i.isFilterable(r)||(n=e.NearestFilter,s=e.NearestFilter);let h=`${n}-${s}-${a}-${o}-${l}`;if(this.textureSamplerCache.has(h))return this.textureSamplerCache.get(h);function c(t){switch(t){case e.ClampToEdgeWrapping:case e._ClampToBorderWrapping:return"clamp-to-edge";case e.MirroredRepeatWrapping:return"mirror-repeat";default:return"repeat"}}const d={label:h+"Sampler",addressModeU:c(a),addressModeV:c(o)};let u=!0;switch(n&&n!=e.LinearFilter?(d.magFilter="nearest",u=!1):d.magFilter="linear",s){case e.NearestFilter:d.minFilter="nearest",d.mipmapFilter="nearest",d.lodMaxClamp=0,u=!1;break;case e.LinearFilter:d.minFilter="linear",d.mipmapFilter="linear",d.lodMaxClamp=0;break;case e.LinearMipMapNearestFilter:d.minFilter="linear",d.mipmapFilter="nearest",u=!1;break;case e.NearestMipMapLinearFilter:d.minFilter="nearest",d.mipmapFilter="linear",u=!1;break;case e.LinearMipMapLinearFilter:default:d.minFilter="linear",d.mipmapFilter="linear"}u&&(d.maxAnisotropy=l);const p=this.webGPUDevice.createSampler(d);return this.textureSamplerCache.set(h,p),p}_getTextureFormat(t){let i;switch(t.format){case e.RFormat:i="r";break;case e.AlphaFormat:i="a";break;case e.RGFormat:i="rg";break;case e.RGBFormat:i="rgb";break;case e.RGBAFormat:case e.RGBAIntegerFormat:i="rgba";break;case e.LuminanceFormat:i="l";break;case e.LuminanceAlphaFormat:i="la";break;case e.RGB_S3TC_DXT1_Format:case e.RGBA_S3TC_DXT1_Format:i="bc1-rgba-unorm";break;case e.RGBA_S3TC_DXT3_Format:i="bc2-rgba-unorm";break;case e.RGBA_S3TC_DXT5_Format:i="bc3-rgba-unorm";break;case e.RED_RGTC1_Format:i="bc4-r-unorm";break;case e.RED_RGTC1_S_Format:i="bc4-r-snorm";break;case e.REDGREEN_RGTC2_Format:i="bc5-rg-unorm";break;case e.REDGREEN_RGTC2_S_Format:i="bc4-rg-snorm";break;case e.RGB_BPTC_SIGNED_FLOAT_Format:i="bc6h-rgb-float";break;case e.RGB_BPTC_UNSIGNED_FLOAT_Format:i="bc6h-rgb-ufloat";break;case e.RGBA_BPTC_UNORM_Format:i="bc7-rgba-unorm";break;case e.SRGB_ALPHA_BPTC_UNORM_Format:i="bc7-rgba-unorm-srgb";break;case e.R11_EAC_Format:i="eac-r11unorm";break;case e.SIGNED_R11_EAC_Format:i="eac-r11snorm";break;case e.RG11_ETC2_EAC_Format:i="eac-rg11unorm";break;case e.SIGNED_RG11_ETC2_EAC_Format:i="eac-rg11snorm";break;case e.RGB8_ETC2_Format:i="etc2-rgb8unorm";break;case e.SRGB8_ETC2_Format:i="etc2-rgb8unorm-srgb";break;case e.RGBA8_ETC2_EAC_Format:case e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2_Format:i="etc2-rgba8unorm";break;case e.SRGB8_ALPHA8_ETC2_EAC_Format:case e.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2_Format:i="etc2-rgba8unorm-srgb"}if(t.format<e.CompressedFormats)switch(t.type){case e.UnsignedByteType:i+="8unorm";break;case e.ByteType:i+="8snorm";break;case e.ShortType:i+="16sint";break;case e.UnsignedShortType:i+="16uint";break;case e.IntType:i+="32sint";break;case e.UnsignedIntType:case e.UnsignedIntType:i+="32uint";break;case e.FloatType:i+="32float";break;case e.HalfFloatType:i+="16float";break;case e.UnsignedShort4444Type:i="rgba8unorm"}return i}_adjustTextureFormats(){const e=this.webGPUDevice;for(let t in _){const i=_[t];switch(t){case"rg11b10ufloat":e.features.has("rg11b10ufloat-renderable")&&(i.renderable=!0,i.blendable=!0,i.multisample=!0,i.resolve=!0);break;case"r32float":case"l32float":case"la32float":case"rg32float":case"rgb32float":case"rgba32float":e.features.has("float32-blendable")&&(i.blendable=!0),e.features.has("float32-filterable")&&(i.sampleType="float")}i.storage&&i.storage.feature&&!e.features.has(i.storage.feature)&&(i.storage=null),i.threeD&&!e.features.has(i.threeD)&&(i.threeD=null),i.feature&&!e.features.has(i.feature)&&(_[t]=null)}}async readPixelsPromise(e,t,i,r,n,s,a=0){if(e<0||t<0)return;if(!this.webGPUDevice)return;let o={x:e,y:t,width:i,height:r},[l,h,c,d,u]=s.getBufferSize(o),p=this.webGPUDevice.createBuffer({label:"readpixels buffer",size:l,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),f=await s.fillDataBufferAsync(this.webGPUDevice,o,p,a),g=new n.constructor(f.buffer.getMappedRange());for(let e=0;e<u;e++)for(let t=0;t<d;t++)for(let i=0;i<4;i++)n[i+4*(t+e*d)]=g[i+4*(t+e*f.bufferWidth)];return p.unmap(),n}readPixelsSyncHack(e,t,i,r,n,s,a,o,l=0){this.setupHackReadPixel();if(e<0||t<0)return;if(this.hack.w=i,this.hack.h=r,!this.webGPUDevice)return;let h=null,c=null;if(o){let n={x:e,y:t,width:i,height:r},[s,a,d,u,p]=o.getBufferSize(n);this.pickBufferData&&this.pickBufferData.width===u&&this.pickBufferData.height===p&&this.pickBufferData.dataPerRow===d&&this.pickBufferData.bytesPerRow===a||(this.pickBufferData={buffer:this.webGPUDevice.createBuffer({label:"Pick Buffer Hack",size:s,usage:GPUBufferUsage.MAP_READ_SYNC|GPUBufferUsage.COPY_DST}),width:u,height:p,dataPerRow:d,bytesPerRow:a}),c=o.fillDataBufferSync(this.webGPUDevice,n,this.pickBufferData.buffer,l),h=new Uint8Array(c.buffer.getMappedRange())}else{let n=this.hack;h=new Uint8Array(i*r*4);var d=this.canvas.toDataURL();document.createElement("img").src=d,n.gl.texImage2D(n.gl.TEXTURE_2D,0,n.gl.RGBA,n.gl.RGBA,n.gl.UNSIGNED_BYTE,this.canvas),n.gl.readPixels(e,t,i,r,n.gl.RGBA,n.gl.UNSIGNED_BYTE,h);let s=Math.floor(r/2);for(let e=0;e<s;e++)for(let t=0;t<i;t++)for(let n=0;n<4;n++){let s=4*(e*i+t)+n,a=4*((r-1-e)*i+t)+n,o=h[s],l=h[a];h[s]=l,h[a]=o}}for(let e=0;e<r;e++)for(let t=0;t<i;t++)for(let r=0;r<4;r++)a[4*(e*i+t)+r]=h[4*(e*i+t)+r];c&&c.buffer.unmap()}setupHackReadPixel(){if(p)return void(this.hack=p);let e=[];p=e,this.hack=e,e.gpuCanvas=new OffscreenCanvas(1,1),e.gpuCtx=e.gpuCanvas.getContext("webgpu"),e.gpuUniformArray=new Uint32Array(8),e.glCanvas=new OffscreenCanvas(1,1),e.gl=e.glCanvas.getContext("webgl2",{alpha:!0}),e.texture=e.gl.createTexture(),e.framebuffer=e.gl.createFramebuffer(),e.gl.bindTexture(e.gl.TEXTURE_2D,e.texture),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,e.framebuffer),e.gl.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.TEXTURE_2D,e.texture,0),e.deviceReadbackHelpers=new WeakMap,e.readSyncBufferState=new WeakMap,GPUBufferUsage.MAP_READ_SYNC=4096;const t=GPUDevice.prototype.createBuffer;GPUDevice.prototype.createBuffer=function(i){let r=!1;i.usage!=GPUBufferUsage.MAP_READ_SYNC&&i.usage!=(GPUBufferUsage.MAP_READ_SYNC|GPUBufferUsage.COPY_DST)||(i.usage&=-4097,i.usage|=GPUBufferUsage.STORAGE,r=!0);const n=t.call(this,i);return r&&e.readSyncBufferState.set(n,{size:i.size,device:this,mapped:!1}),n},GPUBuffer.prototype.mapSync=function(t){if(t!=GPUMapMode.READ)throw new Error("mapSync only supports READ mode.");const i=e.readSyncBufferState.get(this);if(void 0===i)throw new Error("Buffer was not created with MAP_READ_SYNC usage.");if(!0===i.mapped)throw new Error("Buffer is already mapped.");i.mapped=!0};const i=GPUBuffer.prototype.getMappedRange;GPUBuffer.prototype.getMappedRange=function(t,r){const n=e.readSyncBufferState.get(this);return void 0!==n&&!0===n.mapped?(t=t||0,r=r||n.size-t,function(t,i,r,n){const s=256*Math.floor(r/256),a=n+(r-s),o=(Math.ceil(4*e.w/256),e.w),l=e.h;e.gpuCanvas.width=o,e.gpuCanvas.height=l,e.gpuCtx.configure({device:t,format:"bgra8unorm",alphaMode:"opaque"});const h=function(t){if(e.deviceReadbackHelpers.has(t))return e.deviceReadbackHelpers.get(t);const i=t.createShaderModule({label:"shader module hack read pixel",code:"\n                var<private> pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(\n                  vec2<f32>(-1.0, -1.0), vec2<f32>(-1.0, 3.0), vec2<f32>(3.0, -1.0));\n          \n                struct VertexOutput {\n                  @builtin(position) position : vec4<f32>,\n                  @location(0) texCoord : vec2<f32>\n                };\n          \n                @vertex\n                fn vertMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                  var output : VertexOutput;\n                  output.texCoord = pos[vertexIndex] * vec2<f32>(0.5, 0.5) + vec2<f32>(0.5);\n                  output.position = vec4<f32>(pos[vertexIndex], 0.0, 1.0);\n                  return output;\n                }\n          \n                struct InputBuffer {\n                  bytes : array<u32>\n                };\n\n                struct uniformStruct {\n                    canvasSize : vec4<u32>,\n                    shiftValues : vec4<u32>\n                };\n\n                @group(0) @binding(0) var<storage> input : InputBuffer;\n                @group(0) @binding(1) var<uniform> ubo : uniformStruct;\n                \n                @fragment\n                fn fragMain(@location(0) texCoord : vec2<f32>) -> @location(0) vec4<f32> { \n                  let index : u32 = u32(texCoord.x * f32(ubo.canvasSize.x)) +\n                                    u32(texCoord.y * f32(ubo.canvasSize.y)) * ubo.canvasSize.z;\n                  let bytes : u32 = input.bytes[index];\n                 \n                  return vec4(\n                    f32((bytes >> ubo.shiftValues.x) & 0xffu) / 255.0,\n                    f32((bytes >> ubo.shiftValues.y) & 0xffu) / 255.0,\n                    f32((bytes >> ubo.shiftValues.z) & 0xffu) / 255.0,\n                    f32((bytes >> ubo.shiftValues.w) & 0xffu) / 255.0 \n                  );\n                }\n              "}),r=t.createRenderPipeline({label:"pipeline map sync hack",vertex:{module:i,entryPoint:"vertMain"},fragment:{module:i,entryPoint:"fragMain",targets:[{format:"bgra8unorm",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"zero"},alpha:{operation:"add",srcFactor:"one",dstFactor:"zero"}}}]},layout:"auto"}),n=t.createBuffer({label:"hack read pixel UBO",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),s={pipeline:r,uniformBuffer:n};return e.deviceReadbackHelpers.set(t,s),s}(t);e.gpuUniformArray[0]=o,e.gpuUniformArray[1]=l,e.gpuUniformArray[2]=256*Math.ceil(4*o/256)/4,e.gpuUniformArray[3]=0;const c=o*l*4;let d=new Uint8Array(c),u=new Uint8Array(c);var p=[[0,8,16],[24,0,0]];for(let r=0;r<p.length;r++){e.gpuUniformArray[4]=p[r][0],e.gpuUniformArray[5]=p[r][1],e.gpuUniformArray[6]=p[r][2],e.gpuUniformArray[7]=0,t.queue.writeBuffer(h.uniformBuffer,0,e.gpuUniformArray),i.pickBindGroup||(i.pickBindGroup=t.createBindGroup({label:"pickBindGroup",layout:h.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:i,offset:s,size:a}},{binding:1,resource:{buffer:h.uniformBuffer}}]}));const n=e.gpuCtx.getCurrentTexture();n.colorAttachmentsView||(n.colorAttachmentsView=n.createView());const f=t.createCommandEncoder();f.label="hackReadPixelCommandEncoder";const g=f.beginRenderPass({label:"hackReadPixelPassEncoder",colorAttachments:[{view:n.colorAttachmentsView,loadOp:A.CLEAR,storeOp:D.STORE,clearValue:{r:0,g:0,b:0,a:0}}]});g.setPipeline(h.pipeline),g.setBindGroup(0,i.pickBindGroup),g.draw(3),g.end(),t.queue.submit([f.finish()]),e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,e.gl.RGBA,e.gl.UNSIGNED_BYTE,e.gpuCanvas),e.gl.readPixels(0,0,o,l,e.gl.RGBA,e.gl.UNSIGNED_BYTE,u);for(let e=0;e<c;e+=4)for(let t=0;t<3;t++)3*r+t<4&&(d[e+3*r+t]=u[e+t])}if(s!=r||c!=n){const e=r-s;return d.slice(e,a).buffer}return d.buffer}(n.device,this,t,r)):i.call(this,t,r)};const r=GPUBuffer.prototype.unmap;GPUBuffer.prototype.unmap=function(t,i){const n=e.readSyncBufferState.get(this);return void 0!==n&&!0===n.mapped&&(n.mapped=!1),r.call(this)}}readPixelCustom(e,t,i,r,n,s,a,o,l=!0,h=!0,c=0){let d=this.lastRenderTarget,u=d?d.height:this._screenRenderTarget.height,p=h?Math.max(0,-t+u-2*r+r):t;1==l?this.readPixelsSyncHack(e,p,i,r,n,s,a,d,c):this.readPixelsPromise(e,p,i,r,a,d,c).then((e=>{console.log("Async Print value (make this part custom)",e)}))}generateMipmap(e,t){this.mipmapSampler||(this.mipmapSampler=this.webGPUDevice.createSampler({label:"mipmapSampler",minFilter:"linear"})),this.mipmapPipelines||(this.mipmapPipelines={});let i=this;const r=function(e){let t=i.mipmapPipelines[e];return t||(i.mipmapShaderModule||(i.mipmapShaderModule=i.webGPUDevice.createShaderModule({label:"generateMipmap shader module",code:"\n                                  var<private> pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(\n                                    vec2<f32>(-1.0, -1.0), vec2<f32>(-1.0, 3.0), vec2<f32>(3.0, -1.0));\n\n                                  struct VertexOutput {\n                                    @builtin(position) position : vec4<f32>,\n                                    @location(0) texCoord : vec2<f32>,\n                                  };\n\n                                  @vertex\n                                  fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                                    var output : VertexOutput;\n                                    output.texCoord = pos[vertexIndex] * vec2<f32>(0.5, -0.5) + vec2<f32>(0.5);\n                                    output.position = vec4<f32>(pos[vertexIndex], 0.0, 1.0);\n                                    return output;\n                                  }\n\n                                  @group(0) @binding(0) var imgSampler : sampler;\n                                  @group(0) @binding(1) var img : texture_2d<f32>;\n\n                                  @fragment\n                                  fn fragmentMain(@location(0) texCoord : vec2<f32>) -> @location(0) vec4<f32> {\n                                    // return textureSample(img, imgSampler, texCoord) * vec4f(1.2, 1.0, 1.2, 1.0);\n                                    return textureSample(img, imgSampler, texCoord);\n                                  }\n                                "}),i.mipmapBindGroupLayout=i.webGPUDevice.createBindGroupLayout({label:"generateMipmap bind group layout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),i.mipmapPipelineLayout=i.webGPUDevice.createPipelineLayout({label:"generateMipmap pipeline layout",bindGroupLayouts:[i.mipmapBindGroupLayout]})),t=i.webGPUDevice.createRenderPipeline({label:"generateMipmap pipeline",layout:i.mipmapPipelineLayout,vertex:{module:i.mipmapShaderModule,entryPoint:"vertexMain"},fragment:{module:i.mipmapShaderModule,entryPoint:"fragmentMain",targets:[{format:e}]}}),i.mipmapPipelines[e]=t),t}(t.format);if("3d"==t.dimension||"1d"==t.dimension)return void console.error("Generating mipmaps for non-2d textures is currently unsupported!");let n=e;const s=t.size.depthOrArrayLayers||1,a=t.usage&GPUTextureUsage.RENDER_ATTACHMENT;if(!a){const e={label:"mipTextureDescriptor",size:{width:Math.max(1,t.size.width>>>1),height:Math.max(1,t.size.height>>>1),depthOrArrayLayers:s},format:t.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT,mipLevelCount:t.mipLevelCount-1};n=this.webGPUDevice.createTexture(e)}const o=this.webGPUDevice.createCommandEncoder({});o.label="mipmapCommandEncoder";for(let i=0;i<s;++i){let l=e.createView({label:"mipTexture src",baseMipLevel:0,mipLevelCount:1,dimension:"2d",baseArrayLayer:i,arrayLayerCount:1});const h={width:Math.max(1,t.size.width>>>1),height:Math.max(1,t.size.height>>>1),depthOrArrayLayers:s};let c=a?1:0;for(let e=1;e<t.mipLevelCount;++e){const e=n.createView({label:`mipTexture dst ${c}`,baseMipLevel:c++,mipLevelCount:1,dimension:"2d",baseArrayLayer:i,arrayLayerCount:1}),t=o.beginRenderPass({label:"mipmap render pass encoder",colorAttachments:[{view:e,loadOp:A.CLEAR,storeOp:D.STORE}]}),s=this.webGPUDevice.createBindGroup({label:"mipmap bindGroup encoder",layout:this.mipmapBindGroupLayout,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:l}]});t.setPipeline(r),t.setBindGroup(0,s),t.draw(3,1,0,0),t.end(),l=e,h.width=Math.max(1,h.width>>>1),h.height=Math.max(1,h.height>>>1)}}if(!a){const i={width:Math.max(1,t.size.width>>>1),height:Math.max(1,t.size.height>>>1),depthOrArrayLayers:s};for(let r=1;r<t.mipLevelCount;++r)o.copyTextureToTexture({texture:n,mipLevel:r-1},{texture:e,mipLevel:r},i),i.width=Math.max(1,i.width>>>1),i.height=Math.max(1,i.height>>>1)}return this.webGPUDevice.queue.submit([o.finish()]),a||n.destroy(),e}fillUBOGeneric(e,t){const i=e.layout;t.forEach((function(t,r,n){var s=t;const a=i[r];if(a){var o=s.type;t=s.value;switch(o){case"b":case"i":e.setI(a,t);break;case"b2":case"i2":e.setI2(a,t);break;case"b3":case"i3":e.setI3(a,t);break;case"b4":case"i4":e.setI4(a,t);break;case"f":e.setF(a,t);break;case"v2":e.setV2(a,t);break;case"v3":e.setV3(a,t);break;case"v4":e.setV4(a,t);break;case"c":e.setColor(a,t,!1,!1);break;case"iv1":case"bv1":e.setIArray(a,t);break;case"iv2":case"bv2":e.setFlatI2Array(a,t);break;case"iv3":case"bv3":e.setFlatI3Array(a,t);break;case"iv4":case"bv4":e.setFlatI4Array(a,t);break;case"fv1":e.setFArray(a,t);break;case"fv2":e.setFlatV2Array(a,t);break;case"fv3":e.setFlatV3Array(a,t);break;case"fv4":e.setFlatV4Array(a,t);break;case"v2v":e.setV2Array(a,t);break;case"v3v":e.setV3Array(a,t);break;case"v4v":e.setV4Array(a,t);break;case"m3":e.setM3(a,t);break;case"m3v":e.setM3Array(a,t);break;case"m4":e.setM4(a,t);break;case"m4v":e.setM4Array(a,t);break;case"t2":e.setTexture(a,t);break;case"t2v":e.setTextureArray(a,t);break;default:console.warn("unsupported generic uniform type "+o)}}}))}fillPostProcessUBO(e){if(this.inlinedPostProcess.activated){const t=e.layout;t.brightness&&e.setF(t.brightness,this.inlinedPostProcess.brightness),t.filmic_1&&e.setF(t.filmic_1,[this.inlinedPostProcess.filmic_A,this.inlinedPostProcess.filmic_B,this.inlinedPostProcess.filmic_C,this.inlinedPostProcess.filmic_D]),t.filmic_2&&e.setF(t.filmic_2,[this.inlinedPostProcess.filmic_E,this.inlinedPostProcess.filmic_F,this.inlinedPostProcess.filmic_W]),t.crushblacks&&e.setF(t.crushblacks,this.inlinedPostProcess.crushblacks),t.burnhighlights&&e.setF(t.burnhighlights,this.inlinedPostProcess.burnhighlights)}}fillOITLinkedListUBO(t){const i=t.layout;if(i.scissorRect){const r=this.gpuStates.scissorRect;t.setV4(i.scissorRect,new e.Vector4(r.x,r.y,r.width,r.height))}i.oitMaxFragments&&t.setI(i.oitMaxFragments,this.oitMaxFragments),i.oitOpaqueDepth&&t.setTexture(i.oitOpaqueDepth,this.oitOpaqueDepth),i.oitLinkedListHeads&&t.setStorageBuffer(i.oitLinkedListHeads,this.oitLinkedListHeads),i.oitLinkedListElements&&t.setStorageBuffer(i.oitLinkedListElements,this.oitLinkedListElements)}fillLightsUBOCommons(e,t){const i=this.lights,r=e.layout;r.ambientLightColor&&e.setFlatV4(r.ambientLightColor,i.ambient[0],i.ambient[1],i.ambient[2],i.ambient[3]),t?r.directionalLightColor&&e.setFlatV4Array(r.directionalLightColor,i.directional.colorsPhong):r.directionalLightColor&&e.setFlatV4Array(r.directionalLightColor,i.directional.colors),r.directionalLightDirection&&e.setFlatV4Array(r.directionalLightDirection,i.directional.positions),t?r.pointLightColor&&e.setFlatV4Array(r.pointLightColor,i.point.colorsPhong):r.pointLightColor&&e.setFlatV4Array(r.pointLightColor,i.point.colors),r.pointLightPosition&&e.setFlatV4Array(r.pointLightPosition,i.point.positions),t?r.spotLightColor&&e.setFlatV4Array(r.spotLightColor,i.spot.colorsPhong):r.spotLightColor&&e.setFlatV4Array(r.spotLightColor,i.spot.colors),r.spotLightPosition&&e.setFlatV4Array(r.spotLightPosition,i.spot.positions),r.spotLightDirection&&e.setFlatV4Array(r.spotLightDirection,i.spot.directions),r.spotLightPhysicalAttenuation&&e.setFlatI4Array(r.spotLightPhysicalAttenuation,i.spot.physicalAttenuations)}fillShadowsUBO(e){const t=this.lights,i=this.shadows,r=e.layout;r.shadowMatrix&&(r.shadowMap&&e.setTextureArray(r.shadowMap,i.shadowMap),r.transparentShadowMap&&e.setTextureArray(r.transparentShadowMap,i.transparentShadowMap),r.directionalLightColorNoIntensity&&e.setFlatV4Array(r.directionalLightColorNoIntensity,t.directional.colorsNoIntensity),r.spotLightColorNoIntensity&&e.setFlatV4Array(r.spotLightColorNoIntensity,t.spot.colorsNoIntensity),r.shadowMapSizeDarknessBias&&e.setV4Array(r.shadowMapSizeDarknessBias,i.shadowMapSizeDarknessBias),r.shadowMapNearFar&&e.setV4Array(r.shadowMapNearFar,i.shadowMapNearFar),r.shadowCameraPosition&&e.setFlatV4Array(r.shadowCameraPosition,i.shadowCameraPosition),r.lowPartShadowCameraPosition&&e.setFlatV4Array(r.lowPartShadowCameraPosition,i.lowPartShadowCameraPosition),e.setM4Array(r.shadowMatrix,i.shadowMatrix)),r.shadowMapCube&&(r.shadowMapCube&&e.setTextureArray(r.shadowMapCube,i.shadowMapCube),r.transparentShadowMapCube&&e.setTextureArray(r.transparentShadowMapCube,i.transparentShadowMapCube),r.pointLightColorNoIntensity&&e.setFlatV4Array(r.pointLightColorNoIntensity,t.point.colorsNoIntensity),r.shadowCubeInfos&&e.setFlatV4Array(r.shadowCubeInfos,i.shadowCubeInfos),r.shadowPointPosition&&e.setFlatV4Array(r.shadowPointPosition,i.shadowPointPosition))}fillClippingUBO(e){var t=this._clipPlanesState.uniforms;const i=e.layout;i.nbClipPlanes&&e.setI(i.nbClipPlanes,t.nbClipPlanes.value);let r=!1;if(0!==t.nbClipPlanes.value&&(r=!0,i.clipPlaneEquations&&e.setFlatV4Array(i.clipPlaneEquations,t.clipPlaneEquations.value),i.clipPlaneEquations&&e.setIArray(i.clipPlaneActive,t.clipPlaneActive.value),i.clipFrontOpacity&&e.setF(i.clipFrontOpacity,t.clipFrontOpacity.value),i.clipBackOpacity&&e.setF(i.clipBackOpacity,t.clipBackOpacity.value)),i.polygonSize&&e.setIArray(i.polygonSize,t.polygonSize.value),t.polygonSize.value&&0!==t.polygonSize.value[0]?(i.polygonPoints&&e.setTexture(i.polygonPoints,t.polygonPoints.value),i.extrusionPlaneU&&e.setFlatV3Array(i.extrusionPlaneU,t.extrusionPlaneU.value),i.extrusionPlaneV&&e.setFlatV3Array(i.extrusionPlaneV,t.extrusionPlaneV.value),i.clipBackOpacity&&e.setF(i.clipBackOpacity,t.clipBackOpacity.value)):i.polygonPoints&&e.setTexture(i.polygonPoints,this._dummyTexture),i.scissorSize){var n=t.scissorSize.value;n&&0===n.length&&(n=[0]),e.setIArray(i.scissorSize,n)}i.scissorPoints&&(t.scissorSize.value&&0!==t.scissorSize.value[0]?e.setTexture(i.scissorPoints,t.scissorPoints.value):e.setTexture(i.scissorPoints,this._dummyTexture)),i.cylinderClipZone&&e.setI(i.cylinderClipZone,t.cylinderClipZone.value),0!==t.cylinderClipZone.value&&(i.cylinderCenter&&e.setV3(i.cylinderCenter,t.cylinderCenter.value),i.cylinderAxisU&&e.setV3(i.cylinderAxisU,t.cylinderAxisU.value),i.cylinderAxisV&&e.setV3(i.cylinderAxisV,t.cylinderAxisV.value))}fillGASUBO(e,t,i,r=null){const n=e.layout;if(n.diffuse){let t=i.color,s=r&&r.getColor();s&&(t=c.set(r.getColor())),e.setColorPlusF(n.diffuse,t,s?1:0,this.gammaInput,this.simpleGamma)}if(n.opacity){let s=i.opacity,a=this.getDisableKeepOcclusionOpacityOverrides(),o=r&&r.getOpacity(t.__dimension,a);(o||0===o)&&(s=o),this.useRenderPriorityOpacity&&(s=this.computeRenderPriorityOpacity(s,r)),e.setF(n.opacity,s)}}fillMaterialHighFrequencyCommonsUBO(e,t,i,r,n=null){this.fillGASUBO(e,t,i||t,n),r&&r._mappingOperator||t._fillMappingUBO(e,t,this)}fillMaterialEnvMapUBO(t,i){const r=t.layout;r.envMapExposureSpecular&&t.setF(r.envMapExposureSpecular,i.envMapExposureSpecular||0==i.envMapExposureSpecular?i.envMapExposureSpecular:1),r.envMapExposureDiffuse&&t.setF(r.envMapExposureDiffuse,i.envMapExposureDiffuse||0==i.envMapExposureDiffuse?i.envMapExposureDiffuse:1),r.ambienceMatrix&&t.setM4(r.ambienceMatrix,i.ambienceMatrix?i.ambienceMatrix:this._dummyMat4),r.flipEnvMap&&t.setF(r.flipEnvMap,i.flipEnvMap||0==i.flipEnvMap?i.flipEnvMap:1),i.map&&i.map.hdr&&i.map.image?r.mapHDRSize&&t.setFlatV2(r.mapHDRSize,parseInt(i.map.image.width),parseInt(i.map.image.height)):r.mapHDRSize&&t.setFlatV2(r.mapHDRSize,2048,1024),i.envMap&&i.envMap.hdr&&i.envMap.image?(r.envMapHDRSize&&t.setFlatV2(r.envMapHDRSize,parseInt(i.envMap.image.width),parseInt(i.envMap.image.height)),r.useRefract&&t.setI(r.useRefract,i.envMap.mapping instanceof e.CubeRefractionMapping?1:0)):(r.envMapHDRSize&&t.setFlatV2(r.envMapHDRSize,2048,1024),r.useRefract&&t.setI(r.useRefract,0))}fillMaterialCommonsUBO(e,t){const i=e.layout;var r;if(i.colorBufferType&&e.setF(i.colorBufferType,t.vertexColors),i.reflectivity&&e.setF(i.reflectivity,t.reflectivity||0==t.reflectivity?t.reflectivity:1),i.refractionRatio&&e.setF(i.refractionRatio,t.refractionRatio||0==t.refractionRatio?t.refractionRatio:.98),i.combine&&e.setI(i.combine,t.combine?t.combine:0),i.renderIteration&&e.setI(i.renderIteration,this.renderIteration?this.renderIteration:0),t.map?r=t.map:t.specularMap?r=t.specularMap:t.normalMap?r=t.normalMap:t.bumpMap&&(r=t.bumpMap),void 0!==r){var n=r.offset||{x:0,y:0},s=r.repeat||{x:1,y:1};i.offsetBumpMap&&(e.setV2(i.offsetBumpMap,n),e.setV2(i.repeatBumpMap,s))}else i.offsetBumpMap&&(e.setFlatV2(i.offsetBumpMap,0,0),e.setFlatV2(i.repeatBumpMap,1,1));i.map&&e.setTexture(i.map,t.map),i.specularMap&&e.setTexture(i.specularMap,t.specularMap),i.reflectivityEnvMap&&e.setTexture(i.reflectivityEnvMap,t.reflectivityEnvMap),i.envMap&&t.envMap&&!t.envMipMap&&e.setTexture(i.envMap,t.envMap),i.refractionRatioMap&&e.setTexture(i.map,t.refractionRatioMap)}fillDepthLayerUBO(e,t){}fillNormalMapUBO(e,t){const i=e.layout;i.normalScale&&(t.normalScale?e.setV2(i.normalScale,t.normalScale):e.setFlatV2(i.normalScale,1,1)),i.normalMap&&e.setTexture(i.normalMap,t.normalMap)}}return e.Logger?e.Logger.log_class(X):X})),define("DS/Visualization/WebGLRenderer",["DS/Visualization/ThreeJS_DS","DS/GPUFormats/GPUFormats","DS/GPUFormats/WebGLUniformUtils","DS/Visualization/BufferGPUManager","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","DS/ShaderBuilders/Commons/DefaultShaders","DS/ShaderBuilders/ShaderUtils/TypeUtils","DS/ShaderBuilders/ShaderUtils/UniformUtils","DS/ShaderBuilders/ShaderUtils/AttributeUtils","DS/Visualization/ShaderChunk","DS/ShaderBuilders/MultiDrawShaderBuilder"],(function(e,t,i,r,n,s,a,o,l,h,c,d){"use strict";const u=e._toFastProperties;e._MultiDrawShaderBuilder=d;const p=new e.Color,f=e.__pickingColor,g=new e.Vector3,m=e.BlockPoints,v=(e.AutomatedTests()||localStorage.getItem("__WEBVISU_DEBUGGER_ON_COMPIL_FAIL__"),e.AutomatedTests()),_=(e.MaterialToUse._materialToUseShift,e.GLTypeEnum),y=e.ObjectUniformEnum,S=e.GlobalUniformEnum;class b extends e.ProgramObject{constructor(){super(),this.uniformLocations=null,this.globalUniformLocations=null,this.pdsfxUniformLocations=null,this.postProUniformLocations=null,this.lightUniformLocations=null,this.shadowUniformLocations=null,this.clippingUniformLocations=null,this.objectUniformLocations=null}delete(e){e.gl&&e.gl.deleteProgram(this.program),this.program=null}}const x=i.__computeGlobalFunc,w=i.__computeObjectFunc,P=e._lastMinuteHandlingResult;class C{constructor(){this.modelMatrix=null,this.modelViewMatrix=null,this.modelViewInvTranspMatrix=null,this.modelInvTranspMatrix=null,this.normalMatrix=null,this.quantizedVector=null,this.offsetVector=null,this.compressionContext=null,this.ccSize=null,this.fixedSizeCenterRatio=null,this.lightMap=null,this.lightMapUvSlot=null,this.lightMapUvTransform=null,this.lightMapMappingType=null,this.billboardType=null,this.billboardRotationEnabled=null,this.billboardAxis=null,this.billboardRotation=null,this.modelInvRotMatrix=null,this.modelViewInvMatrix=null,this.decalStencilValue=null,this.decalExplicitUv=null,this.decalDepthOffset=null,this.displacementRadius=null,this.objectColorBufferType=null,this.skinningMap=null,this.skinningInstancingMaps=null,this.backgroundViewModeControl=null,this.backgroundViewModeNearFar=null,this.belowInstancingModelMatrix=null,this.pickingColor=null,this.loadObjectUniformsFunc=null,this._instancingData=null,this._instancingDataSize=null}computeFuncName(){this.loadObjectUniformsFunc=w(y,this)}}class M extends e.WebRenderer{constructor(t){super(t),this.__glResources__={renderTarget:{},geometry:[],geometryNullCount:0,texture:[],textureLODPool:new e.TextureLODPool,removeGeometryList:function(e){var t=new Set;e.forEach((function(e,i,r){t.add(e.id)}));for(var i=0,r=0;r<this.geometry.length;r++){var n=this.geometry[r];if(n&&t.has(n.id)&&(i++,t.delete(n.id),this.geometry[r]=null,this.geometryNullCount++,i===e.size))break}this.tryClean()},tryClean:function(){this.geometryNullCount>=100&&(this.geometry=this.geometry.filter((function(e){return null!==e})),this.geometryNullCount=0)}},this.gl=null,this.supportedFeatures={textureFloat:!1,colorBufferFloat:!1,textureFloatLinear:!1,floatBlend:!1,renderToFloatTexture:!1,renderToFloatRGBTexture:!1,textureHalfFloat:!1,colorBufferHalfFloat:!1,textureHalfFloatLinear:!1,renderToHalfFloatTexture:!1,renderToHalfFloatRGBTexture:!1,standardDerivatives:!1,fragDepth:!1,float16InShader:!1,textureLODs:!1,KHRParallelShaderCompile:!1,completionStatusValue:!1,compressedTextureS3TC:!1,compressedTextureRGTC:!1,compressedTextureBPTC:!1,compressedTextureBC3D:!1,compressedTextureASTC:!1,compressedTextureASTCHDR:!1,compressedTextureETC1:!1,compressedTextureETC:!1,compressedTexturePVRTC:!1,textureFilterAnisotropic:!1,maxAnisotropy:0,instancedArrays:!1,DSInstancedArrays:null,elementIndexUint:!1,multiDraw:!1,DSMultiDraw:null,maxTextures:0,maxVertexTextures:0,supportsVertexTextures:!1,noRGBTextures:!1,maxTextureSize:0,maxCubemapSize:0,blendMinMax:!1,drawBuffers:!1,highpAvailable:!1,mediumpAvailable:!1,highpIntAvailable:!1,mediumpIntAvailable:!1,depthBits:0},this.initGL(t.context,t.debugContext,t.debugWebgl2);let i=this.gl,a=this.supportedFeatures;a.maxTextures=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),a.maxVertexTextures=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),a.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),a.maxCubemapSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE);const o=i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.HIGH_FLOAT),l=i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.MEDIUM_FLOAT),h=(i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.LOW_FLOAT),i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT)),c=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.MEDIUM_FLOAT),d=(i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.LOW_FLOAT),i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.HIGH_INT)),u=i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.MEDIUM_INT),p=(i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.LOW_INT),i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_INT)),f=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.MEDIUM_INT);i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.LOW_INT);(this.bufferGPUManager._device||this.bufferGPUManager._gl&&this.bufferGPUManager._gl!==i)&&(e.VisualizationTraces.info("WebGLRenderer: creating BufferGPUManager for"+i.contextId),this.bufferGPUManager=new r.__builder__),this.bufferGPUManager.setGLContext(this.id,i,this.info),this._inheritanceSolver.setContext(i,n,s),this.bufferUtils.setContext(i),this.buildDepthFunctionValues(),this.buildStencilOpValues(),this.buildFaceCullingValues(),this.buildBlendingFunctionValues(),this.buildBlendingFactorValues(),this.setDefaultGLState(),this.context=this.gl,a.depthBits=Math.pow(2,-i.getParameter(i.DEPTH_BITS)),a.maxAnisotropy=a.textureFilterAnisotropic?i.getParameter(a.textureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,a.supportsVertexTextures=a.maxVertexTextures>0,a.highpAvailable=o.precision>0&&h.precision>0,a.mediumpAvailable=l.precision>0&&c.precision>0,"highp"!==this.precision||a.highpAvailable||(a.mediumpAvailable?(this.precision="mediump",e.VisualizationTraces.info("WebGLRenderer: highp not supported, using mediump")):(this.precision="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==this.precision||a.mediumpAvailable||(this.precision="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump not supported, using lowp")),a.highpIntAvailable=0===d.precision&&0===p.precision,a.mediumpIntAvailable=0===u.precision&&0===f.precision,"highp"!==this.precisionInt||a.highpIntAvailable||(a.mediumpIntAvailable?(this.precisionInt="mediump",e.VisualizationTraces.info("WebGLRenderer: highp int not supported, using mediump")):(this.precisionInt="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump int not supported, using lowp"))),"mediump"!==this.precisionInt||a.mediumpIntAvailable||(this.precisionInt="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump int not supported, using lowp")),this._buildSupportedExtensionsFromFeatures(),this._initProgramPool()}initGL(i,r,n){try{if(i)this.gl=i;else{if(n&&(this.gl=this.canvas.getContext("webgl2",{alpha:this.alpha,premultipliedAlpha:this.premultipliedAlpha,antialias:this.antialias,stencil:this.stencil,preserveDrawingBuffer:this.preserveDrawingBuffer,powerPreference:e._webglPerformanceProfile()})),!this.gl){var s={alpha:this.alpha,premultipliedAlpha:this.premultipliedAlpha,antialias:this.antialias,stencil:this.stencil,preserveDrawingBuffer:this.preserveDrawingBuffer,powerPreference:e._webglPerformanceProfile()};this.gl=this.canvas.getContext("webgl",s)||this.canvas.getContext("experimental-webgl",s),e.WebGLVersion=1}if(!this.gl)throw"Error creating WebGL context."}}catch(e){console.error(e)}!i&&r&&(this.gl=WebGLDebugUtils.makeDebugContext(this.gl,(function(e,t,i){throw window.WebVisuTestsWebGLError=!0,"##WEBGLERROR## "+WebGLDebugUtils.glEnumToString(e)+" was caused by call to: "+t})));let a=this.gl,o=this.currentProgram,l=this.gpuStates;const h=this.canvas;h.addEventListener("webglcontextlost",(()=>{const e=new Event("WebVisu_contextlost");h.dispatchEvent(e)})),a._enabledAttributes||(a._enabledAttributes={}),a.hasOwnProperty("contextId")||(e.lastContextId++,a.contextId=e.lastContextId),o.program||(o.program=null),l.blending||(l.blending=-1),e.enableWebGLStats&&(e.webGLStats={reset:function(){this.useProgram_nb=0,this.bindBuffer_nb=0,this.drawElements_nb=0},dump:function(){console.log({useProgram_nb:this.useProgram_nb,bindBuffer_nb:this.bindBuffer_nb,drawElements_nb:this.drawElements_nb})},useProgram_nb:0,bindBuffer_nb:0,drawElements_nb:0},a.useProgram_save=a.useProgram,a.useProgram=function(){e.webGLStats.useProgram_nb++,a.useProgram_save.apply(a,arguments)},a.bindBuffer_save=a.bindBuffer,a.bindBuffer=function(){e.webGLStats.bindBuffer_nb++,a.bindBuffer_save.apply(a,arguments)},a.drawElements_save=a.drawElements,a.drawElements=function(){e.webGLStats.drawElements_nb++,a.drawElements_save.apply(a,arguments)}),this.supportedExt=a.getSupportedExtensions(),this.getExtension=function(e){return this.supportedExt.indexOf(e)>=0?a.getExtension(e):null};let c=this.supportedFeatures;c.colorBufferFloat=!e._mobileDevice&&(this.getExtension("WEBGL_color_buffer_float")||this.getExtension("EXT_color_buffer_float")),c.colorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")||this.getExtension("EXT_color_buffer_float"),c.textureHalfFloat=2===e.WebGLVersion||this.getExtension("OES_texture_half_float"),c.textureFloat=2===e.WebGLVersion||this.getExtension("OES_texture_float"),c.textureFloatLinear=this.getExtension("OES_texture_float_linear"),c.floatBlend=this.getExtension("EXT_float_blend"),c.textureHalfFloatLinear=this.getExtension("OES_texture_half_float_linear"),c.standardDerivatives=2===e.WebGLVersion||this.getExtension("OES_standard_derivatives"),c.textureLODs=2===e.WebGLVersion||this.getExtension("EXT_shader_texture_lod"),c.KHRParallelShaderCompile?c.completionStatusValue=c.KHRParallelShaderCompile.COMPLETION_STATUS_KHR:c.completionStatusValue=a.LINK_STATUS;var d=this.getExtension("WEBGL_debug_renderer_info");function u(e,t,i,r){var n=a.createTexture(),s=a.createFramebuffer(),o=a.createRenderbuffer();a.bindTexture(a.TEXTURE_2D,n),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texImage2D(a.TEXTURE_2D,0,t,100,100,0,i,r,null),a.bindFramebuffer(a.FRAMEBUFFER,s),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,n,0),a.bindRenderbuffer(a.RENDERBUFFER,o),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,100,100),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,o);var l=a.checkFramebufferStatus(a.FRAMEBUFFER);c[e]=!0,l!=a.FRAMEBUFFER_COMPLETE&&(c[e]=!1),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.deleteTexture(n),a.deleteFramebuffer(s),a.deleteRenderbuffer(o)}null!==d&&(this.rendererInfo.gpu=a.getParameter(d.UNMASKED_RENDERER_WEBGL),this.rendererInfo.vendor=a.getParameter(d.UNMASKED_VENDOR_WEBGL)),c.textureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic")||this.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),c.compressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc")||this.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),c.compressedTextureRGTC=this.getExtension("EXT_texture_compression_rgtc")||this.getExtension("WEBGL_compressed_texture_rgtc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_rgtc")||this.getExtension("MOZ_WEBGL_compressed_texture_rgtc"),c.compressedTextureBPTC=this.getExtension("EXT_texture_compression_bptc")||this.getExtension("WEBGL_compressed_texture_bptc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_bptc")||this.getExtension("MOZ_WEBGL_compressed_texture_bptc"),c.compressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),c.compressedTextureASTCHDR=c.compressedTextureASTC&&c.compressedTextureASTC.getSupportedProfiles().indexOf("hdr")>-1,c.compressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),c.compressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),c.compressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),c.instancedArrays=this.getExtension("ANGLE_instanced_arrays"),c.elementIndexUint=this.getExtension("OES_element_index_uint")||2===e.WebGLVersion,c.fragDepth=this.getExtension("EXT_frag_depth")||2===e.WebGLVersion,c.blendMinMax=this.getExtension("EXT_blend_minmax"),c.drawBuffers=this.getExtension("WEBGL_draw_buffers"),c.multiDraw=null,e._mobileDevice||(c.renderToFloatTexture=!!c.colorBufferFloat,c.textureFloat&&!c.renderToFloatTexture&&u("renderToFloatTexture",2===e.WebGLVersion?a.RGBA32F:a.RGBA,a.RGBA,a.FLOAT),c.renderToFloatTexture&&!c.renderToFloatRGBTexture&&u("renderToFloatRGBTexture",2===e.WebGLVersion?a.RGB32F:a.RGB,a.RGB,a.FLOAT)),c.renderToHalfFloatTexture=!!c.colorBufferHalfFloat,c.textureHalfFloat&&!c.renderToHalfFloatTexture&&u("renderToHalfFloatTexture",2===e.WebGLVersion?a.RGBA16F:a.RGBA,a.RGBA,2===e.WebGLVersion?this.gl.HALF_FLOAT:c.textureHalfFloat.HALF_FLOAT_OES),c.renderToHalfFloatTexture&&!c.renderToHalfFloatRGBTexture&&u("renderToHalfFloatRGBTexture",2===e.WebGLVersion?a.RGB16F:a.RGB,a.RGB,2===e.WebGLVersion?this.gl.HALF_FLOAT:c.textureHalfFloat.HALF_FLOAT_OES),e._AmbianceGenerators.init(0),e._SSSGenerator.init(),c.textureFloat||e.VisualizationTraces.info("THREE.WebGLRenderer: Float textures not supported."),c.textureHalfFloat||e.VisualizationTraces.info("THREE.WebGLRenderer: Half Float textures not supported."),c.standardDerivatives||e.VisualizationTraces.info("THREE.WebGLRenderer: Standard derivatives not supported."),c.textureFilterAnisotropic||e.VisualizationTraces.info("THREE.WebGLRenderer: Anisotropic texture filtering not supported."),c.compressedTextureS3TC||e.VisualizationTraces.info("THREE.WebGLRenderer: S3TC compressed textures not supported."),c.compressedTextureRGTC||e.VisualizationTraces.info("THREE.WebGLRenderer: RGTC compressed textures not supported."),c.compressedTextureBPTC||e.VisualizationTraces.info("THREE.WebGLRenderer: BPTC compressed textures not supported."),c.compressedTextureETC1||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC1 compressed textures not supported."),c.compressedTextureETC||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC compressed textures not supported."),c.compressedTextureASTC||e.VisualizationTraces.info("THREE.WebGLRenderer: ASTC compressed textures not supported."),c.compressedTexturePVRTC||e.VisualizationTraces.info("THREE.WebGLRenderer: PVRTC compressed textures not supported."),c.instancedArrays?c.DSInstancedArrays={vertexAttribDivisor:function(e,t){c.instancedArrays.vertexAttribDivisorANGLE(e,t)},drawElementsInstanced:function(e,t,i,r,n){c.instancedArrays.drawElementsInstancedANGLE(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)i[r]>=0&&t[r].array&&(t[r].isMat4?(c.instancedArrays.vertexAttribDivisorANGLE(i[r],e),c.instancedArrays.vertexAttribDivisorANGLE(i[r]+1,e),c.instancedArrays.vertexAttribDivisorANGLE(i[r]+2,e),c.instancedArrays.vertexAttribDivisorANGLE(i[r]+3,e)):c.instancedArrays.vertexAttribDivisorANGLE(i[r],e))}}:2===e.WebGLVersion?c.DSInstancedArrays={vertexAttribDivisor:function(e,t){a.vertexAttribDivisor(e,t)},drawElementsInstanced:function(e,t,i,r,n){a.drawElementsInstanced(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)i[r]>=0&&t[r].array&&(t[r].isMat4?(a.vertexAttribDivisor(i[r],e),a.vertexAttribDivisor(i[r]+1,e),a.vertexAttribDivisor(i[r]+2,e),a.vertexAttribDivisor(i[r]+3,e)):a.vertexAttribDivisor(i[r],e))}}:e.VisualizationTraces.info("THREE.WebGLRenderer: angle instanced arrays not supported."),c.multiDraw?c.DSMultiDraw={isEmulated:!1,multiDrawArrays(e,t,i,r,n,s){c.multiDraw.multiDrawArraysWEBGL(e,t,i,r,n,s)},multiDrawElements(e,t,i,r,n,s,a){c.multiDraw.multiDrawElementsWEBGL(e,t,i,r,n,s,a)},multiDrawArraysInstanced(e,t,i,r,n,s,a,o){c.multiDraw.multiDrawArraysInstancedWEBGL(e,t,i,r,n,s,a,o)},multiDrawElementsInstanced(e,t,i,r,n,s,a,o,l){c.multiDraw.multiDrawElementsInstancedWEBGL(e,t,i,r,n,s,a,o,l)}}:(e.VisualizationTraces.info("THREE.WebGLRenderer: multi-draw not supported."),c.DSMultiDraw={isEmulated:!0,uniformLocation:null,setDrawId:function(e){null!==this.uniformLocation&&a.uniform1i(this.uniformLocation,e)},multiDrawArrays(e,t,i,r,n,s){for(let o=0;o<s;o++){const s=i+o<t.length?t[i+o]:-1,l=n+o<r.length?r[n+o]:-1;if(s<0||l<0)throw new Error("gl.multiDrawArrays(): invalid parameter");this.setDrawId(o),a.drawArrays(e,s,l)}this.setDrawId(0)},multiDrawElements(e,t,i,r,n,s,o){for(let l=0;l<o;l++){const o=s+l<n.length?n[s+l]:-1,h=i+l<t.length?t[i+l]:-1;if(o<0||h<0)throw new Error("gl.multiDrawElements(): invalid parameter");this.setDrawId(l),a.drawElements(e,h,r,o)}this.setDrawId(0)},multiDrawArraysInstanced(e,t,i,r,n,s,o,l){for(let h=0;h<l;h++){const l=i+h<t.length?t[i+h]:-1,c=n+h<r.length?r[n+h]:-1,d=o+h<s.length?s[o+h]:-1;if(l<0||c<0||d<0)throw new Error("gl.multiDrawArraysInstanced(): invalid parameter");this.setDrawId(h),a.drawArraysInstanced(e,l,c,d)}this.setDrawId(0)},multiDrawElementsInstanced(e,t,i,r,n,s,o,l,h){for(let c=0;c<h;c++){const h=s+c<n.length?n[s+c]:-1,d=i+c<t.length?t[i+c]:-1,u=l+c<o.length?o[l+c]:-1;if(h<0||d<0||u<0)throw new Error("gl.multiDrawElementsInstanced(): invalid parameter");this.setDrawId(c),a.drawElementsInstanced(e,d,r,h,u)}this.setDrawId(0)}}),c.elementIndexUint||e.VisualizationTraces.info("THREE.WebGLRenderer: UInt Element Index not supported."),c.fragDepth||e.VisualizationTraces.info("THREE.WebGLRenderer: Fragment Depth Writing not supported."),c.blendMinMax||e.VisualizationTraces.info("THREE.WebGLRenderer: min/max blending not supported."),void 0===a.getShaderPrecisionFormat&&(a.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}});const p={float16:2===e.WebGLVersion?a.HALF_FLOAT:void 0,float32:a.FLOAT,sint8:a.BYTE,sint16:a.SHORT,sint32:2===e.WebGLVersion?a.INT:void 0,uint8:a.UNSIGNED_BYTE,uint16:a.UNSIGNED_SHORT,uint32:2===e.WebGLVersion?a.UNSIGNED_INT:void 0};for(let e in t.VertexAttribute)t.VertexAttribute[e].native=p[t.VertexAttribute[e].base]}restoreGLContext(){console.log("restore context"),this.initGL(null,null,2===e.WebGLVersion),_programs=[],_tryCleanPrograms=!1,_programs_counter=0,this.currentProgram.program=null;memoryInfo.programs;memoryInfo.programs=0,memoryInfo.sharedbuffers=0,memoryInfo.geometries=0;var t=this.__glResources__.geometry;console.log("restore "+t.length+" geometries");for(var i=[],r=0;r<t.length;r++)if(t[r]){var n=t[r].geometry;if(n){if(n.length)for(var s=0;s<n.length;s++)n[s].vertexBufferGPU=null;else if(t[r].__webglInit=!1,n.__webglVertexBuffer=null,n.geometryGroups)for(var a in n.geometryGroups){n.geometryGroups[a].__webglVertexBuffer=null}_this.initObject(t[r])&&i.push(t[r])}}this.initSharedBuffersDS(i,!0),memoryInfo.textures=0,memoryInfo.renderTargets=0;var o=this.__glResources__.texture;console.log("restore "+o.length+" textures");for(r=0;r<o.length;r++){var l=o[r];l.needsUpdate=!0,l._initialized=!1,l.__webglTexture&&(l.__webglTexture=null)}var h=this.__glResources__.renderTarget,c=0;for(var r in h){var d=h[r];d&&(d.__webglFramebuffer=null,d.__webglRenderbuffer=null,d.__webglTexture=null,c++)}console.log("restore "+c+" render targets")}buildDepthFunctionValues(){this.depthFuncs={NEVER:this.gl.NEVER,LESS:this.gl.LESS,EQUAL:this.gl.EQUAL,LEQUAL:this.gl.LEQUAL,GREATER:this.gl.GREATER,NOTEQUAL:this.gl.NOTEQUAL,GEQUAL:this.gl.GEQUAL,ALWAYS:this.gl.ALWAYS}}buildStencilOpValues(){this.stencilOps={KEEP:this.gl.KEEP,ZERO:this.gl.ZERO,REPLACE:this.gl.REPLACE,INVERT:this.gl.INVERT,INCR:this.gl.INCR,DECR:this.gl.DECR,INCR_WRAP:this.gl.INCR_WRAP,DECR_WRAP:this.gl.DECR_WRAP}}buildFaceCullingValues(){this.cullings={NONE:0,BACK:this.gl.BACK,FRONT:this.gl.FRONT}}buildBlendingFunctionValues(){this.blendingFuncs={ADD:this.gl.FUNC_ADD,SUB:this.gl.FUNC_SUBTRACT,REVERSE_SUB:this.gl.FUNC_REVERSE_SUBTRACT}}buildBlendingFactorValues(){this.blendingFactors={ZERO:this.gl.ZERO,ONE:this.gl.ONE,SRC:this.gl.SRC_COLOR,ONE_MINUS_SRC:this.gl.ONE_MINUS_SRC_COLOR,SRC_ALPHA:this.gl.SRC_ALPHA,ONE_MINUS_SRC_ALPHA:this.gl.ONE_MINUS_SRC_ALPHA,DST_ALPHA:this.gl.DST_ALPHA,ONE_MINUS_DST_ALPHA:this.gl.ONE_MINUS_DST_ALPHA,DST:this.gl.DST_COLOR,ONE_MINUS_DST:this.gl.ONE_MINUS_DST_COLOR,SRC_ALPHA_SATURATED:this.gl.SRC_ALPHA_SATURATE}}setDefaultGLState(){let t=this.gl,i=this.gpuStates;t.lineWidth(1),t.clearColor(0,0,0,1),t.clearDepth(1),t.clearStencil(0),this.setDepthTest(!0),this.setDepthFunc(this.depthFuncs.LEQUAL),this.setFrontFace(e.FrontFaceDirectionCCW),this.setCullMode(this.cullings.BACK),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),i.blending=e.AlphaBlending,t.clearColor(i.clearColor.r,i.clearColor.g,i.clearColor.b,i.clearAlpha)}paramThreeToGL(t){let i=this.gl,r=this.supportedFeatures;if(t===e.RepeatWrapping)return i.REPEAT;if(t===e.ClampToEdgeWrapping)return i.CLAMP_TO_EDGE;if(t===e._ClampToBorderWrapping)return i.CLAMP_TO_EDGE;if(t===e.MirroredRepeatWrapping)return i.MIRRORED_REPEAT;if(t===e.NearestFilter)return i.NEAREST;if(t===e.NearestMipMapNearestFilter)return i.NEAREST_MIPMAP_NEAREST;if(t===e.NearestMipMapLinearFilter)return i.NEAREST_MIPMAP_LINEAR;if(t===e.LinearFilter)return i.LINEAR;if(t===e.LinearMipMapNearestFilter)return i.LINEAR_MIPMAP_NEAREST;if(t===e.LinearMipMapLinearFilter)return i.LINEAR_MIPMAP_LINEAR;if(t===e.UnsignedByteType)return i.UNSIGNED_BYTE;if(t===e.UnsignedShort4444Type)return i.UNSIGNED_SHORT_4_4_4_4;if(t===e.UnsignedShort5551Type)return i.UNSIGNED_SHORT_5_5_5_1;if(t===e.UnsignedShort565Type)return i.UNSIGNED_SHORT_5_6_5;if(t===e.ByteType)return i.BYTE;if(t===e.ShortType)return i.SHORT;if(t===e.UnsignedShortType)return i.UNSIGNED_SHORT;if(t===e.IntType)return i.INT;if(t===e.UnsignedIntType)return i.UNSIGNED_INT;if(t===e.FloatType)return i.FLOAT;if(t===e.HalfFloatType){if(i.HALF_FLOAT)return i.HALF_FLOAT;if(r.textureHalfFloat)return r.textureHalfFloat.HALF_FLOAT_OES}if(t===e.RFormat)return i.LUMINANCE;if(t===e.AlphaFormat)return i.ALPHA;if(t===e.RGBFormat)return i.RGB;if(t===e.RGBAFormat)return i.RGBA;if(t===e.LuminanceFormat)return 2===e.WebGLVersion?i.RED:i.LUMINANCE;if(t===e.LuminanceAlphaFormat)return i.LUMINANCE_ALPHA;if(t===e.RGFormat)return i.RG;if(t===e.RGBAIntegerFormat)return i.RGBA_INTEGER;if(t===e.AddEquation)return i.FUNC_ADD;if(t===e.SubtractEquation)return i.FUNC_SUBTRACT;if(t===e.ReverseSubtractEquation)return i.FUNC_REVERSE_SUBTRACT;if(t===e.ZeroFactor)return i.ZERO;if(t===e.OneFactor)return i.ONE;if(t===e.SrcColorFactor)return i.SRC_COLOR;if(t===e.OneMinusSrcColorFactor)return i.ONE_MINUS_SRC_COLOR;if(t===e.SrcAlphaFactor)return i.SRC_ALPHA;if(t===e.OneMinusSrcAlphaFactor)return i.ONE_MINUS_SRC_ALPHA;if(t===e.DstAlphaFactor)return i.DST_ALPHA;if(t===e.OneMinusDstAlphaFactor)return i.ONE_MINUS_DST_ALPHA;if(t===e.DstColorFactor)return i.DST_COLOR;if(t===e.OneMinusDstColorFactor)return i.ONE_MINUS_DST_COLOR;if(t===e.SrcAlphaSaturateFactor)return i.SRC_ALPHA_SATURATE;if(r.compressedTextureS3TC){if(t===e.RGB_S3TC_DXT1_Format)return r.compressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT1_Format)return r.compressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT3_Format)return r.compressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===e.RGBA_S3TC_DXT5_Format)return r.compressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(void 0!==r.compressedTextureRGTC){if(t===e.RED_RGTC1_Format)return r.compressedTextureRGTC.COMPRESSED_RED_RGTC1_EXT;if(t===e.RED_RGTC1_S_Format)return r.compressedTextureRGTC.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(t===e.REDGREEN_RGTC2_Format)return r.compressedTextureRGTC.COMPRESSED_RED_GREEN_RGTC2_EXT;if(t===e.REDGREEN_RGTC2_S_Format)return r.compressedTextureRGTC.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}if(void 0!==r.compressedTextureBPTC){if(t===e.RGBA_BPTC_UNORM_Format)return r.compressedTextureBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(t===e.SRGB_ALPHA_BPTC_UNORM_Format)return r.compressedTextureBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;if(t===e.RGB_BPTC_SIGNED_FLOAT_Format)return r.compressedTextureBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(t===e.RGB_BPTC_UNSIGNED_FLOAT_Format)return r.compressedTextureBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(void 0!==r.compressedTextureASTC&&t===e.RGBA_ASTC_4x4_Format)return r.compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;if(void 0!==r.compressedTextureETC1&&t===e.RGB_ETC1_Format)return r.compressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;if(void 0!==r.compressedTextureETC&&t===e.RGBA8_ETC2_EAC_Format)return r.compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;if(void 0!==r.compressedTexturePVRTC){if(t===e.RGB_PVRTC_2BPPV1_Format)return r.compressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===e.RGB_PVRTC_4BPPV1_Format)return r.compressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===e.RGBA_PVRTC_2BPPV1_Format)return r.compressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;if(t===e.RGBA_PVRTC_4BPPV1_Format)return r.compressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG}if(void 0!==r.blendMinMax){if(t===e.MinEquation)return r.blendMinMax.MIN_EXT;if(t===e.MaxEquation)return r.blendMinMax.MAX_EXT}return 0}initFrameUBO(){if(this.frameUBOArray)return;if(2!==e.WebGLVersion)return;let t=this.gl;this.frameUBOArray=new Float32Array(36),this.frameUBOBuffer=t.createBuffer(),t.bindBuffer(t.UNIFORM_BUFFER,this.frameUBOBuffer),t.bufferData(t.UNIFORM_BUFFER,this.frameUBOArray,t.DYNAMIC_DRAW),t.bufferSubData(t.UNIFORM_BUFFER,0,this.frameUBOArray),t.bindBufferBase(t.UNIFORM_BUFFER,m.FRAME,this.frameUBOBuffer),t.bindBuffer(t.UNIFORM_BUFFER,null)}updateFrameUBO(t){if(super.updateFrameUBO(t),2!==e.WebGLVersion)return;for(var i=t.matrixWorldInverse.elements,r=0;r<16;r++)this.frameUBOArray[r]=i[r];var n=t.projectionMatrix.elements;for(r=0;r<16;r++)this.frameUBOArray[r+16]=n[r];g.getPositionFromMatrix(t.matrixWorld),this.frameUBOArray[32]=g.x,this.frameUBOArray[33]=g.y,this.frameUBOArray[34]=g.z,this.frameUBOArray[36]=e.SplitFloat32(g.x).low,this.frameUBOArray[37]=e.SplitFloat32(g.y).low,this.frameUBOArray[38]=e.SplitFloat32(g.z).low;let s=this.gl;s.bindBuffer(s.UNIFORM_BUFFER,this.frameUBOBuffer),s.bufferSubData(s.UNIFORM_BUFFER,0,this.frameUBOArray)}renderInterval(e,i,r,n,s,a,o,l,h,c,d,u,p,g,m,v,y){const S=this._cullDGSSB(e,r,s,a,o,l,v,y,u);if(S){if(0===S.totalCount)return!1;o=S.starts[0],l=S.counts[0],v=S.starts,y=S.counts}const b=this.gl;let x=this.currentProgram;this.gpuStates,this.viewportData;const w=a.glType,C=this.currentRenderInfo;C.nbDGs++;let M=this.materialToUseList;var E=x.program,T=n.programManager.getTokenProgramID(u);(d||T!==this.currentProgramID)&&(n.previousOccurrenceRenderingOverride=null,this.setProgram(e,i,n,r,c,s,u,T,p,g,m,a));var A=n.program.objectUniformLocations;if(A.loadObjectUniformsFunc(this,A,r,s,n,e,p),M.pickingMaterial){this.setupPickingMaterial(n,w,r);var D=n.program.uniformLocations;A.pickingColor?b.uniform3f(A.pickingColor,f.r,f.g,f.b):b.uniform4f(D.diffuse,f.r,f.g,f.b,0)}n._hasLODTextures&&n._chooseLODTextures(e,r);const I=n.program,R=I.attributes,O=I.instanceAttributes;this._renderInterval_lastMinuteBufferHandling(r,s,a,u,p,n,I);const L=P.vertexBuffer,B=P.indexBuffer;let F=P.updateBuffers;const V=P.instanceAttribArrays;if(!L||!B)return!1;if(L!==this.currentVertexBuffer&&(this.currentVertexBuffer=L,F=!0),F&&(C.swapBuffers++,C.unsharedBuffers+=s.sharedBuffers&&!L.isShared?1:0,b.bindBuffer(b.ARRAY_BUFFER,L.buffer),L.layout.forEach((function(e){const i=R[e.name];if(!Number.isInteger(i)||i<0)return;const r=t.VertexAttribute[e.type];b.vertexAttribPointer(i,r.components,r.native,r.normalized,e.stride,e.offset)})),null!==V))for(var G in V)b.bindBuffer(b.ARRAY_BUFFER,V[G].buffer),O[G]>=0&&V[G].array&&(V[G].isMat4?(b.vertexAttribPointer(O[G],V[G].itemSize,b.FLOAT,!1,64,0),b.vertexAttribPointer(O[G]+1,V[G].itemSize,b.FLOAT,!1,64,16),b.vertexAttribPointer(O[G]+2,V[G].itemSize,b.FLOAT,!1,64,32),b.vertexAttribPointer(O[G]+3,V[G].itemSize,b.FLOAT,!1,64,48)):b.vertexAttribPointer(O[G],V[G].itemSize,b.FLOAT,!1,0,0));if(B!==this.currentIndexBuffer&&(this.currentIndexBuffer=B,b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,B.buffer)),E!=x.program){var N={};if(null!==V)for(var G in V)O[G]>=0&&(V[G].isMat4?(N[O[G]]=!0,N[O[G]+1]=!0,N[O[G]+2]=!0,N[O[G]+3]=!0):N[O[G]]=!0);L.layout.forEach((function(e){const t=R[e.name];!Number.isInteger(t)||t<0||(N[t]=!0)})),this.enableAttributes(N)}if(u){u.draw(b,u,l,this.supportedFeatures.DSMultiDraw,this.supportedFeatures.DSInstancedArrays,V,O,y);let e=l;if(y)for(var U=0;U<y.length;++U)e+=y[U];C.vertices+=e,w===_.TRIANGLES?C.faces+=e/3:w===_.LINES?C.lines+=e/2:w===_.POINTS&&(C.points+=e)}else{const e=s.indexBufferGPU,t=w===_.TRIANGLES||w===_.TRIANGLE_STRIP;n.wireframe&&t?b.drawElements(_.LINE_STRIP,l,e.glFormat,o*e.bytesPerIndex):w===_.POINTS&&s.vertexPositionArray&&s.vertexPositionArray.nonindexedPoints?b.drawArrays(w,s.vertexIndexArray[o],l):a.nonIndexed?b.drawArrays(w,o,l):b.drawElements(w,l,e.glFormat,(s.indexOffsetGPU+o)*e.bytesPerIndex)}return C.calls++,!0}setProgramWithUniforms(e,t,i,r,n,s,a,o,l,h,c,d){const u=this.setProgram(e,t,i,r,n,s,a,o,l,h,c,d),p=this.gl,g=d?d.glType:_.TRIANGLES;var m=i.program.objectUniformLocations;return m.loadObjectUniformsFunc(this,m,r,s,i,e,l),this.materialToUseList.pickingMaterial&&(this.setupPickingMaterial(i,g,r),m.pickingColor?p.uniform3f(m.pickingColor,f.r,f.g,f.b):p.uniform4f(uniformLocations.diffuse,f.r,f.g,f.b,0)),u}setProgram(e,t,i,r,n,s,a,o,l,h,c,d){let u=this.gl,p=this.currentProgram;this.usedTextureUnits=0;let f=this.materialToUseList;const g=this.getContextId(e),m=this.id|this._globalProgramID,v=this.currentRendererMode,_=i.programManager,y=c;y===_.currentRenderingContext&&v===_.currentRendererMode&&m===_.currentRendererId&&g===_.currentContextId||_.setActivePool(g,m,v,y),i.needsUpdate||(i.program=_.getProgram(o,this.shaderVersions[this.currentRendererMode],this.deallocateMaterial),null===i.program&&(this.initMaterial(e,i,t,r,s,d,a,o,l,c),i._notifyDLtoBeSortedNextFrame(this.currentSSRID))),f.lightedMaterial&&i.program&&(i.program._lightsKey!==this.lightsKey||i.program._ambianceKey!==this.ambianceKey)&&i.program._materialToUse===c&&(_.disposeCurrentProgram(this.deallocateMaterial,o),this.initMaterial(e,i,t,r,s,d,a,o,l,c),i._notifyDLtoBeSortedNextFrame(this.currentSSRID)),i.needsUpdate&&(_.disposeAllPrograms(this.deallocateMaterial),_.setActivePool(g,m,v,y),this.initMaterial(e,i,t,r,s,d,a,o,l,c),i.needsUpdate=!1,i._notifyAllDLtoBeSortedNextFrame());var S=i.isPDSFX(),b=!1,x=!1,w=i.program,P=w.uniformLocations,C=w.pdsfxUniformLocations,M=w.globalUniformLocations,E=w.program,T=n?n.id:-1,A=h?h.id:-1,D=l&&l._mappingOperator?l.id:-1;(i.id===this.currentMaterialId&&T===this.currentMaterialOverrideId&&A===this.currentGASMatId&&D===this.currentMatAppId||(this.currentRenderInfo.swapMaterials++,this.currentMaterialId=i.id,this.currentMaterialOverrideId=T,this.currentGASMatId=A,this.currentMatAppId=D,b=!0),E!==p.program&&(this.currentRenderInfo.swapPrograms++,u.useProgram(E),p.program=E,this.currentVertexBuffer=null,this.currentIndexBuffer=null,x=!0,b=!0,this.currentModelMatrix=null),this.currentScene===this.scene&&e===this.currentCamera||(this.currentRenderInfo.swapScenes++,x=!0),(x||w._clipPlanesVersion!==this._clipPlanesState.version)&&(i.enableClipPlanes&&this.loadClippingUniforms(u,w.clippingUniformLocations),w._clipPlanesVersion=this._clipPlanesState.version),b)&&(this.currentRenderInfo.materialUniformCalls++,i.refreshUniforms(this,r),null!==i._shaderID?(i.loadUniforms(this,u,P,n,h,l),S&&i._loadPDSFXUniforms(C,this,r)):this.loadUniformsGeneric(P,i.uniformsList),l&&l._mappingOperator&&l._loadMappingOperatorUniforms(i,this,u),r._applyPlaneViewModeColor&&(P=i.program.uniformLocations).diffuse&&u.uniform4f(P.diffuse,.26,.4,.33,0));return x&&(this.currentCamera=e,this.currentScene=this.scene,this.currentRenderInfo.globalUniformCalls++,M.loadGlobalUniformsFunc(this,M,i,e),f.highlightMaterial&&i.deferrable&&this.scene.highlightData._updateMaterialUniforms(M,u,this),i.loadGlobalUniforms(this,u,M),this.supportedFeatures.DSMultiDraw&&this.supportedFeatures.DSMultiDraw.isEmulated&&(this.supportedFeatures.DSMultiDraw.uniformLocation=P.drawId),M.positionComponent&&u.uniform3f(M.positionComponent,this.positionComponent.x,this.positionComponent.y,this.positionComponent.z),b&&(f.lightedMaterial&&(this.lightsNeedUpdate&&(this.setupLights(t,e),this.lightsNeedUpdate=!1),this.currentRenderInfo.lightUniformCalls++,i.loadUniformsLights(this,u,w.lightUniformLocations)),r.receiveShadow&&!f.shadowPassMaterial&&(this.setupShadows(t,i),this.loadUniformsShadow(u,w)),this.loadUniformsPostProcess(u,w.postProUniformLocations))),this.currentProgramID=o,w}readPixelCustom(e,t,i,r,n,s,a,o){this.gl.readPixels(e,t,i,r,this.paramThreeToGL(n),this.paramThreeToGL(s),a)}async readPixelsPromise(e,t,i,r,n,s,a,o){this.setRenderTarget(s),this.gl.readPixels(e,t,i,r,a,o,n)}buildShader(t,i,r,n,s,l,h,p,f,g,m,_,y,b,w){let P=this.gl,M=this.supportedFeatures,E=this.materialToUseList,T=b.__attributes__,A=b.__uniforms__,D=P.createProgram();n.program=D,r.__geomLayout={};for(var I=m?m.getBufferAttributes():[],R=0;R<I.length;R++)if(I[R]){var O=I[R][0];r.__geomLayout[O]=!0}const L=`\n        \n            ${c.Default_uniforms_declaration(r)}\n            ${c.normalMatrix_uniforms_declaration(r)}\n            ${c.double_emulation_utilities(r)}\n            ${c.double_emulation(r)}\n      \n            ${c.math_utils_pars(r)}\n\n            ${c.sRGB_conversion(r)}\n            ${c.gpu_scenegraph_nodes(r)}\n            \n            ${a.model_view_transformation_pars(r)}\n            ${a.model_view_unit_transformation_pars(r)}\n            \n            ${c.rgba_packing_pars(r)}\n            ${c.decompress_vertices_pars(r)}\n            ${c.decompress_normals_pars(r)}\n            ${c.decompress_uvs_pars(r)}\n            ${c.decompress_colors_pars(r)}\n        `;var B=`\n\n            ${r.deferrable||!r._definePickingInstancing&&!r.specialPickingInstancing?"":ShaderInOutUtils.addVarying({varyingName:"vInstancePickingColor",varyingType:"v3",parameters:r})}\n\n            ${c.attribute_pars_vertex(r)}\n            ${c.attribute_uniforms_pars_vertex(r)}\n\n            ${L}\n\n\t\t\t${d.multidraw_pars_vertex(r)}\n            ${r.PDSFX?`\n                ${c.PDSFX_header_vertex(r)}\n                `:""}\n        `,F=`\n\n            ${L}\n\n\t\t\t${d.multidraw_pars_fragment(r)}\n\n\t\t\t${a.planar_normal_pars_fragment(r)}\n            \n            ${r.deferrable||!r._definePickingInstancing&&!r.specialPickingInstancing?"":ShaderInOutUtils.addVarying({varyingName:"vInstancePickingColor",varyingType:"v3",parameters:r})}\n            \n                ${o.vec3({name:"tangent"})} ;\n                ${o.vec3({name:"binormal"})} ;\n\n            ${2===r.WebGLVersion?"layout(location = 0) out vec4 outFragColor;":""}\n        `;"custom"===i?[s,l]=this.setMaterialShaders(t.postProBuilder,E.lightedMaterial,r):null!==i&&([s,l]=this.setMaterialShaders(e.ShaderLib[i],E.lightedMaterial,r));var V=s,G=l;const N=!i||"gaussianSplat"===i;if(N){var U=/(void(\s+)main(\s*)\((\s*)\)(\s*){(\s*))/;V=V.replace(U,`$&\n                ${d.multidraw_vertex(r)}\n                ${c.attribute_vertex(r)+"\n"+c.large_scale_VS(r)}\n            `),G=G.replace(U,`$&\n                ${d.multidraw_fragment(r)}\n                ${c.large_scale_FS(r)}\n            `)}var k=p+"\n"+F+"\n"+g+"\n"+G,z=h+"\n"+B+"\n"+f+"\n"+V;if(2===e.WebGLVersion){if(k=k.replace(/varying /g,"in "),z=z.replace(/varying /g,"out "),N){k=(k=k.replace(/gl_FragColor/g,"outFragColor")).replace(/gl_FragData\[\d+\]/g,"outFragColor");var H=/\s*texture2D\s*\(/g,W=/\s*textureCube\s*\(/g;z=(z=z.replace(/attribute /g,"in ")).replace(H," texture("),k=(k=k.replace(H," texture(")).replace(W," texture("),z=z.replace(W," texture(");k=k.replace(/#extension\s+GL_OES_standard_derivatives\s*:\s*enable/g,"")}}else N&&(k=M.drawBuffers?k.replace(/gl_FragColor/g,"gl_FragData[0]"):k.replace(/gl_FragData\[\d+\]/g,"gl_FragColor"));k=e.SplitTrimStickString(k),z=e.SplitTrimStickString(z);var j=P.createShader(P.FRAGMENT_SHADER);P.shaderSource(j,k),P.compileShader(j);var X=P.createShader(P.VERTEX_SHADER);if(P.shaderSource(X,z),P.compileShader(X),P.attachShader(D,X),P.attachShader(D,j),P.linkProgram(D),!P.getProgramParameter(D,M.completionStatusValue)){var q=P.getProgramInfoLog(D);if(console.error("Could not initialise shader\nVALIDATE_STATUS: "+P.getProgramParameter(D,P.VALIDATE_STATUS)+", gl error: "+q),q.includes("Vertex shader")?(console.error(P.getShaderInfoLog(X)),console.error(this.addLineNumbers(z))):(console.error(P.getShaderInfoLog(j)),console.error(this.addLineNumbers(k))),v)throw"A shader has failed to compile"}P.deleteShader(j),P.deleteShader(X),n.objectUniformLocations=new C,n.uniformLocations={},n.globalUniformLocations={},n.postProUniformLocations={},n.lightUniformLocations={},n.shadowUniformLocations={},n.clippingUniformLocations={},n.pdsfxUniformLocations={},t._setUniformLocations(P,n,D,A),n.objectUniformLocations.computeFuncName(),n.globalUniformLocations.loadGlobalUniformsFunc=x(S,n.globalUniformLocations),u(n.uniformLocations),u(n.globalUniformLocations),u(n.postProUniformLocations),u(n.lightUniformLocations),u(n.shadowUniformLocations),u(n.clippingUniformLocations),u(n.pdsfxUniformLocations);var Z=n.attributes,Y=n.instanceAttributes;for(var K in T){var $=T[K];const e=P.getAttribLocation(D,K);if(e>-1)if($.dynamic){var Q=$.locationName?$.locationName:K;$.coreAttribute?Z[Q]=e:$.instancingAttribute?Y[Q]=e:console.warn("Unknown attribute category "+K+" "+$)}else Y[K]=e}if(y){const e=P.getProgramParameter(D,P.ACTIVE_ATTRIBUTES);for(let t=0;t<e;t++){const e=P.getActiveAttrib(D,t);T[e.name]||(console.warn("Detected custom attribute declaration for "+e.name+" , please use material.setPDSFXAttributes instead"),Z[e.name]=P.getAttribLocation(D,e.name))}}n.uvOrBinOrTan=(Z.uv>=0||Z.binormal>=0||Z.tangent>=0)&&r.mappingType<1}createProgramObject(){return new b}createGSSOCache(e){return{renderer:this}}loadUniformsGeneric(e,t){const i=this;let r=this.gl;t.forEach((function(t,n,s){var a=t,o=e[n];if(o){var l=a.type;t=a.value;switch(l){case"b":case"i":r.uniform1i(o,t);break;case"b2":case"i2":r.uniform2i(o,t.x,t.y);break;case"i3":case"b3":r.uniform3i(o,t.x,t.y,t.z);break;case"b4":case"i4":r.uniform4i(o,t.x,t.y,t.z,t.w);break;case"f":r.uniform1f(o,t);break;case"v2":r.uniform2f(o,t.x,t.y);break;case"v3":r.uniform3f(o,t.x,t.y,t.z);break;case"v4":r.uniform4f(o,t.x,t.y,t.z,t.w);break;case"c":r.uniform3f(o,t.r,t.g,t.b);break;case"iv1":case"bv1":t.length>0&&r.uniform1iv(o,t);break;case"iv2":case"bv2":t.length>0&&r.uniform2iv(o,t);break;case"bv":case"iv":case"iv3":case"bv3":t.length>0&&r.uniform3iv(o,t);case"iv4":case"bv4":t.length>0&&r.uniform4iv(o,t);break;case"fv1":t.length>0&&r.uniform1fv(o,t);break;case"fv2":t.length>0&&r.uniform2fv(o,t);break;case"fv":case"fv3":t.length>0&&r.uniform3fv(o,t);break;case"fv4":t.length>0&&r.uniform4fv(o,t);break;case"v2v":i.loadVector2Array(r,o,t);break;case"v3v":i.loadVector3Array(r,o,t);break;case"v4v":i.loadVector4Array(r,o,t);break;case"m3":t&&i.loadMatrix3(r,o,t);break;case"m3v":i.loadMatrix3Array(r,o,t);break;case"m4":t&&i.loadMatrix4(r,o,t);break;case"m4v":i.loadMatrix4Array(r,o,t);break;case"t":case"t2":case"tc":i.loadTexture(r,o,t);break;case"tv":case"t2v":i.loadTextureArray(r,o,t);break;case"tcv":i.loadTextureCubeArray(r,o,t);break;default:console.warn("unsupported generic uniform type "+l)}}}))}loadClippingUniforms(e,t){var i=this._clipPlanesState.uniforms;t.nbClipPlanes&&e.uniform1i(t.nbClipPlanes,i.nbClipPlanes.value);let r=!1;if(0!==i.nbClipPlanes.value&&(r=!0,t.clipPlaneEquations&&i.clipPlaneEquations.value.length>0&&e.uniform4fv(t.clipPlaneEquations,i.clipPlaneEquations.value),t.clipPlaneActive&&i.clipPlaneActive.value.length>0&&e.uniform4iv(t.clipPlaneActive,i.clipPlaneActive.value),t.clipFrontOpacity&&e.uniform1f(t.clipFrontOpacity,i.clipFrontOpacity.value),t.clipBackOpacity&&e.uniform1f(t.clipBackOpacity,i.clipBackOpacity.value)),t.polygonSize&&e.uniform4iv(t.polygonSize,i.polygonSize.value),i.polygonSize.value&&0!==i.polygonSize.value[0]?(t.polygonPoints&&this.loadTexture(e,t.polygonPoints,i.polygonPoints.value),t.extrusionPlaneU&&e.uniform3fv(t.extrusionPlaneU,i.extrusionPlaneU.value),t.extrusionPlaneV&&e.uniform3fv(t.extrusionPlaneV,i.extrusionPlaneV.value),!r&&t.clipBackOpacity&&e.uniform1f(t.clipBackOpacity,i.clipBackOpacity.value)):t.polygonPoints&&this.loadTexture(e,t.polygonPoints,this._dummyTexture),t.scissorSize){var n=i.scissorSize.value;n&&0===n.length&&(n=[0,0,0,0]),e.uniform4iv(t.scissorSize,n)}t.scissorPoints&&(i.scissorSize.value&&0!==i.scissorSize.value[0]?this.loadTexture(e,t.scissorPoints,i.scissorPoints.value):this.loadTexture(e,t.scissorPoints,this._dummyTexture)),t.cylinderClipZone&&e.uniform1i(t.cylinderClipZone,i.cylinderClipZone.value),0!==i.cylinderClipZone.value&&(t.cylinderCenter&&e.uniform3f(t.cylinderCenter,i.cylinderCenter.value.x,i.cylinderCenter.value.y,i.cylinderCenter.value.z),t.cylinderAxisU&&e.uniform3f(t.cylinderAxisU,i.cylinderAxisU.value.x,i.cylinderAxisU.value.y,i.cylinderAxisU.value.z),t.cylinderAxisV&&e.uniform3f(t.cylinderAxisV,i.cylinderAxisV.value.x,i.cylinderAxisV.value.y,i.cylinderAxisV.value.z))}loadMatrix3(e,t,i){e.uniformMatrix3fv(t,!1,this.float32Matrix3x3Temp.setDoubles(i.elements))}loadMatrix4(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x4Temp.setDoubles(i.elements))}loadMatrix4x3(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x3Temp.setDoubles(i.elements))}loadMatrixFloat4(e,t,i){e.uniformMatrix4fv(t,!1,i.elements)}loadMatrix3Array(e,t,i){if(t){var r=t.flattenedUniformArray;r||(r=new Float32Array(9*i.length),t.flattenedUniformArray=r);for(var n=0,s=i.length;n<s;n++)i[n]&&i[n].flattenToArrayOffset(r,9*n);r.length>0&&e.uniformMatrix3fv(t,!1,r)}}loadMatrix4Array(e,t,i){if(t){var r=t.flattenedUniformArray;r||(r=new Float32Array(16*i.length),t.flattenedUniformArray=r);for(var n=0,s=i.length;n<s;n++)i[n]&&i[n].flattenToArrayOffset(r,16*n);r.length>0&&e.uniformMatrix4fv(t,!1,r)}}loadVector2Array(e,t,i){if(t){var r,n=t.flattenedUniformArray;n||(n=new Float32Array(2*i.length),t.flattenedUniformArray=n);for(var s=0,a=i.length;s<a;s++)n[r=2*s]=i[s].x,n[r+1]=i[s].y;e.uniform2fv(t,n)}}loadVector3Array(e,t,i){if(t){var r,n=t.flattenedUniformArray;n||(n=new Float32Array(3*i.length),t.flattenedUniformArray=n);for(var s=0,a=i.length;s<a;s++)n[r=3*s]=i[s].x,n[r+1]=i[s].y,n[r+2]=i[s].z;e.uniform3fv(t,n)}}loadVector4Array(e,t,i){if(t){var r,n=t.flattenedUniformArray;n||(n=new Float32Array(4*i.length),t.flattenedUniformArray=n);for(var s=0,a=i.length;s<a;s++)n[r=4*s]=i[s].x,n[r+1]=i[s].y,n[r+2]=i[s].z,n[r+3]=i[s].w;e.uniform4fv(t,n)}}loadTexture(t,i,r){if(i){var n=r||this._dummyTexture,s=i.textureUnit;s>=0||(s=this.getTextureUnit(),i.textureUnit=s),t.uniform1i(i,s),n&&(n instanceof e.WebGLRenderTargetCube?this.setCubeTextureDynamic(n,s):this.setTexture(n,s))}}loadTextureArray(e,t,i){if(t){var r=t.flattenedUniformArray;if(!r)for(r=[],t.flattenedUniformArray=r,n=0,s=i.length;n<s;n++)r[n]=this.getTextureUnit();e.uniform1iv(t,r);for(var n=0,s=i.length;n<s;n++){var a=i[n]||this._dummyTexture,o=r[n];a&&this.setTexture(a,o)}}}loadTextureCubeArray(e,t,i){if(t){var r=t.flattenedUniformArray;if(!r)for(r=[],t.flattenedUniformArray=r,n=0,s=i.length;n<s;n++)r[n]=this.getTextureUnit();e.uniform1iv(t,r);for(var n=0,s=i.length;n<s;n++){var a=i[n]||this._dummyTexture,o=r[n];a&&this.setCubeTextureDynamic(a,o)}}}loadGASUniforms(e,t,i,r,n){if(i.diffuse){var s=n.color,a=r&&r.getColor();a&&(s=p.set(r.getColor())),this.gammaInput&&(s=p.copyToLinear(s,this.simpleGamma)),e.uniform4f(i.diffuse,s.r,s.g,s.b,a?1:0)}if(i.opacity){var o=n.opacity,l=r&&r.getOpacity(t.__dimension,this.getDisableKeepOcclusionOpacityOverrides());(l||0===l)&&(o=l),this.useRenderPriorityOpacity&&(o=this.computeRenderPriorityOpacity(o,r)),e.uniform1f(i.opacity,o)}}loadUniformsEnvMap(t,i,r){if(r.envMapExposureSpecular&&t.uniform1f(r.envMapExposureSpecular,i.envMapExposureSpecular||0==i.envMapExposureSpecular?i.envMapExposureSpecular:1),r.envMapExposureDiffuse&&t.uniform1f(r.envMapExposureDiffuse,i.envMapExposureDiffuse||0==i.envMapExposureDiffuse?i.envMapExposureDiffuse:1),r.ambienceMatrix){var n=i.ambienceMatrix?i.ambienceMatrix:this._dummyMat4;this.gl.uniformMatrix4fv(r.ambienceMatrix,!1,this.float32Matrix4x4Temp.setDoubles(n.elements))}r.flipEnvMap&&t.uniform1f(r.flipEnvMap,i.flipEnvMap||0==i.flipEnvMap?i.flipEnvMap:1),i.map&&i.map.hdr&&i.map.image?r.mapHDRSize&&t.uniform2f(r.mapHDRSize,parseInt(i.map.image.width),parseInt(i.map.image.height)):r.mapHDRSize&&t.uniform2f(r.mapHDRSize,2048,1024),i.envMap&&i.envMap.hdr&&i.envMap.image?(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,parseInt(i.envMap.image.width),parseInt(i.envMap.image.height)),r.useRefract&&t.uniform1i(r.useRefract,i.envMap.mapping instanceof e.CubeRefractionMapping)):(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,2048,1024),r.useRefract&&t.uniform1i(r.useRefract,0)),r.envMap&&this.loadTexture(t,r.envMap,i.envMap)}loadUniformsCommon(e,t,i,r,n,s){var a;if(this.loadGASUniforms(e,t,i,r,n||t),i.colorBufferType&&this.gl.uniform1f(i.colorBufferType,t.vertexColors),i.reflectivity&&e.uniform1f(i.reflectivity,t.reflectivity||0==t.reflectivity?t.reflectivity:1),i.refractionRatio&&e.uniform1f(i.refractionRatio,t.refractionRatio||0==t.refractionRatio?t.refractionRatio:.98),i.combine&&e.uniform1i(i.combine,t.combine?t.combine:0),i.renderIteration&&e.uniform1i(i.renderIteration,this.renderIteration?this.renderIteration:0),t.map?a=t.map:t.specularMap?a=t.specularMap:t.normalMap?a=t.normalMap:t.bumpMap&&(a=t.bumpMap),void 0!==a){var o=a.offset||{x:0,y:0},l=a.repeat||{x:1,y:1};i.offsetBumpMap&&(e.uniform2f(i.offsetBumpMap,o.x,o.y),e.uniform2f(i.repeatBumpMap,l.x,l.y))}else i.offsetBumpMap&&(e.uniform2f(i.offsetBumpMap,0,0),e.uniform2f(i.repeatBumpMap,1,1));i.map&&this.loadTexture(e,i.map,t.map),i.specularMap&&this.loadTexture(e,i.specularMap,t.specularMap),i.reflectivityEnvMap&&this.loadTexture(e,i.reflectivityEnvMap,t.reflectivityEnvMap),i.refractionRatioMap&&this.loadTexture(e,i.refractionRatioMap,t.refractionRatioMap),s&&s._mappingOperator||t._loadMappingInfo(t,this,e,i)}loadUniformsDepthLayer(e,t,i){}loadUniformsNormalMap(e,t,i){t.normalMap&&(i.normalScale&&(t.normalScale?e.uniform2f(i.normalScale,t.normalScale.x,t.normalScale.y):e.uniform2f(i.normalScale,1,1)),i.normalMap&&this.loadTexture(e,i.normalMap,t.normalMap))}loadUniformsLightsCommons(e,t,i){const r=this.lights;t.ambientLightColor&&r.ambient.length>0&&e.uniform4fv(t.ambientLightColor,r.ambient),i?t.directionalLightColor&&r.directional.colorsPhong.length>0&&e.uniform4fv(t.directionalLightColor,r.directional.colorsPhong):t.directionalLightColor&&r.directional.colors.length>0&&e.uniform4fv(t.directionalLightColor,r.directional.colors),t.directionalLightDirection&&r.directional.positions.length>0&&e.uniform4fv(t.directionalLightDirection,r.directional.positions),i?t.pointLightColor&&r.point.colorsPhong.length>0&&e.uniform4fv(t.pointLightColor,r.point.colorsPhong):t.pointLightColor&&r.point.colors.length>0&&e.uniform4fv(t.pointLightColor,r.point.colors),t.pointLightPosition&&r.point.positions.length>0&&e.uniform4fv(t.pointLightPosition,r.point.positions),i?t.spotLightColor&&r.spot.colorsPhong.length>0&&e.uniform4fv(t.spotLightColor,r.spot.colorsPhong):t.spotLightColor&&r.spot.colors.length>0&&e.uniform4fv(t.spotLightColor,r.spot.colors),t.spotLightPosition&&r.spot.positions.length>0&&e.uniform4fv(t.spotLightPosition,r.spot.positions),t.spotLightDirection&&r.spot.directions.length>0&&e.uniform4fv(t.spotLightDirection,r.spot.directions),t.spotLightPhysicalAttenuation&&r.spot.physicalAttenuations.length>0&&e.uniform4iv(t.spotLightPhysicalAttenuation,r.spot.physicalAttenuations)}loadUniformsShadow(e,t){const i=this.lights,r=this.shadows;var n=t.shadowUniformLocations;n.shadowMatrix&&(n.shadowMap&&this.loadTextureArray(e,n.shadowMap,r.shadowMap),n.transparentShadowMap&&(this.loadTextureArray(e,n.transparentShadowMap,r.transparentShadowMap),n.directionalLightColorNoIntensity&&i.directional.colorsNoIntensity.length>0&&e.uniform4fv(n.directionalLightColorNoIntensity,i.directional.colorsNoIntensity),n.spotLightColorNoIntensity&&i.spot.colorsNoIntensity.length>0&&e.uniform4fv(n.spotLightColorNoIntensity,i.spot.colorsNoIntensity)),n.shadowMapSizeDarknessBias&&this.loadVector4Array(e,n.shadowMapSizeDarknessBias,r.shadowMapSizeDarknessBias),n.shadowMapNearFar&&this.loadVector4Array(e,n.shadowMapNearFar,r.shadowMapNearFar),n.shadowCameraPosition&&e.uniform4fv(n.shadowCameraPosition,r.shadowCameraPosition),n.lowPartShadowCameraPosition&&e.uniform4fv(n.lowPartShadowCameraPosition,r.lowPartShadowCameraPosition),this.loadMatrix4Array(e,n.shadowMatrix,r.shadowMatrix)),n.shadowMapCube&&(this.loadTextureCubeArray(e,n.shadowMapCube,r.shadowMapCube),n.transparentShadowMapCube&&(this.loadTextureCubeArray(e,n.transparentShadowMapCube,r.transparentShadowMapCube),n.pointLightColorNoIntensity&&i.point.colorsNoIntensity.length>0&&e.uniform4fv(n.pointLightColorNoIntensity,i.point.colorsNoIntensity)),n.shadowCubeInfos&&e.uniform4fv(n.shadowCubeInfos,r.shadowCubeInfos),n.shadowPointPosition&&e.uniform4fv(n.shadowPointPosition,r.shadowPointPosition))}loadUniformsPostProcess(e,t){this.inlinedPostProcess.activated&&(t.brightness&&e.uniform1f(t.brightness,this.inlinedPostProcess.brightness),t.filmic_1&&e.uniform4f(t.filmic_1,this.inlinedPostProcess.filmic_A,this.inlinedPostProcess.filmic_B,this.inlinedPostProcess.filmic_C,this.inlinedPostProcess.filmic_D),t.filmic_2&&e.uniform3f(t.filmic_2,this.inlinedPostProcess.filmic_E,this.inlinedPostProcess.filmic_F,this.inlinedPostProcess.filmic_W),t.crushblacks&&e.uniform1f(t.crushblacks,this.inlinedPostProcess.crushblacks),t.burnhighlights&&e.uniform1f(t.burnhighlights,this.inlinedPostProcess.burnhighlights))}filterFallback(t){return t===e.NearestFilter||t===e.NearestMipMapNearestFilter||t===e.NearestMipMapLinearFilter?this.gl.NEAREST:this.gl.LINEAR}setTextureParameters(t,i,r){let n=this.gl,s=this.supportedFeatures;r?(n.texParameteri(t,n.TEXTURE_WRAP_S,this.paramThreeToGL(i.wrapS)),n.texParameteri(t,n.TEXTURE_WRAP_T,this.paramThreeToGL(i.wrapT)),n.texParameteri(t,n.TEXTURE_MAG_FILTER,this.paramThreeToGL(i.magFilter)),n.texParameteri(t,n.TEXTURE_MIN_FILTER,this.paramThreeToGL(i.minFilter))):(i.wrapS===e.ClampToEdgeWrapping&&i.wrapT===e.ClampToEdgeWrapping||i.wrapS===e._ClampToBorderWrapping&&i.wrapT===e._ClampToBorderWrapping||console.warn("Non power of two textures must be clamp to edge, falling back on it"),n.texParameteri(t,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_MAG_FILTER,this.filterFallback(i.magFilter)),n.texParameteri(t,n.TEXTURE_MIN_FILTER,this.filterFallback(i.minFilter))),s.textureFilterAnisotropic&&i.type!==e.FloatType&&(i.anisotropy>1||i.__oldAnisotropy)&&(n.texParameterf(t,s.textureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,s.maxAnisotropy)),i.__oldAnisotropy=i.anisotropy)}getInternalFormatFromFormatAndType(t,i,r){let n=this.gl;if(2===e.WebGLVersion){switch(t){case n.RGBA:switch(i){case n.UNSIGNED_BYTE:return n.RGBA8;case n.BYTE:return n.RGBA8_SNORM;case n.HALF_FLOAT:return n.RGBA16F;case n.FLOAT:return n.RGBA32F}break;case n.RGB:switch(i){case n.UNSIGNED_BYTE:return n.RGB8;case n.BYTE:return n.RGB8_SNORM;case n.HALF_FLOAT:return n.RGB16F;case n.FLOAT:return r?n.R11F_G11F_B10F:n.RGB32F}break;case n.RED:switch(i){case n.UNSIGNED_BYTE:return n.R8;case n.BYTE:return n.R8_SNORM;case n.HALF_FLOAT:return n.R16F;case n.FLOAT:return n.R32F}break;case n.RG:switch(i){case n.UNSIGNED_BYTE:return n.RG8;case n.BYTE:return n.RG8_SNORM;case n.HALF_FLOAT:return n.RG16F;case n.FLOAT:return n.RG32F}break;case n.RGBA_INTEGER:return n.RGBA32UI}return t}return t}initTexture(e,t){if(t)if(e.onUpdate){var i=e.onUpdate;e.onUpdate=function(){i(),t()}}else e.onUpdate=t;e._setupTextureWebGL(this.gl,this,this.isPowerOfTwo,this.paramThreeToGL,this.getInternalFormatFromFormatAndType,this.setTextureParameters,this.onTextureDispose,null,this.supportedFeatures.maxCubemapSize)}setTexture(t,i){let r=this.gl;t.onRequest&&t.onRequest(),!t._isReady()&&t._substituteTexture&&(t=t._substituteTexture);var n=t.isCubeMap&&t.isCubeMap();if(!n&&t.lods&&t.lods.length){var s=t.usedTexture;if(-1===s)t.lastUsedTexture=-1;else{var a=t.textures[s];a&&a.loadEndStatus===e.AssetLoadingStatus.READY?(a._initialized||this.__glResources__.textureLODPool.add({textureLOD:t,lod:s,size:a.image?4*a.image.width*a.image.height:0}),t.lastUsedTexture=s,t=a):-1!==t.lastUsedTexture&&(t=t.textures[t.lastUsedTexture])}this.__glResources__.textureLODPool.removeUnusedTextures()}if(t._needsUpdate||t.forceUpdate)t._setupTextureWebGL(r,this,this.isPowerOfTwo,this.paramThreeToGL,this.getInternalFormatFromFormatAndType,this.setTextureParameters,this.onTextureDispose,i,this.supportedFeatures.maxCubemapSize);else{if(!t.__webglTexture)return void this.setTexture(this._dummyTexture,i);r.activeTexture(r.TEXTURE0+i),r.bindTexture(n?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D,t.__webglTexture[0])}}setCubeTextureDynamic(e,t){let i=this.gl;e.onRequest&&e.onRequest(),i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_CUBE_MAP,e.__webglTexture[0])}setupFrameBuffer(e,t,i){let r=this.gl;if(r.bindFramebuffer(r.FRAMEBUFFER,e),t)for(let e=0;e<t.__webglTexture.length;e++)r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+e,i,t.__webglTexture[e],0)}setupRenderBuffer(e,t){let i=this.gl;i.bindRenderbuffer(i.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e)):i.renderbufferStorage(i.RENDERBUFFER,i.RGBA4,t.width,t.height)}setRenderTarget(t){super.setRenderTarget(t);let i=!1;!t&&this._xrRenderTarget&&(void 0!==this._xrRenderTarget.__webglFramebuffer||this._xrRenderTarget.__webglTexture.length>0)&&(t=this._xrRenderTarget,i=!0);let r=this.gl,n=this.supportsDrawBuffers();const s=t instanceof e.WebGLRenderTargetCube;let a;if(t&&!t.__webglFramebuffer){if(!i||t.__webglTexture&&0!==t.__webglTexture.length){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.addEventListener("dispose",this.onRenderTargetDispose),i||(t.__webglTexture=[],t.__webglTexture[0]=r.createTexture()),t.colorCount>1&&(t.__webglMRTFramebuffers=[]),this.memoryInfo.renderTargets++,this.__glResources__.renderTarget[t.uniqueID]=t;const e=this.isPowerOfTwo(t.width)&&this.isPowerOfTwo(t.height),n=this.paramThreeToGL(t.format),a=this.paramThreeToGL(t.type),o=this.getInternalFormatFromFormatAndType(n,a,!0);if(s){t.__webglFramebuffer=[],t.__webglRenderbuffer=[];for(let i=0;i<t.__webglTexture.length;i++){r.bindTexture(r.TEXTURE_CUBE_MAP,t.__webglTexture[i]),this.setTextureParameters(r.TEXTURE_CUBE_MAP,t,e);for(let e=0;e<6;e++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,o,t.width,t.height,0,n,a,null)}for(let e=0;e<6;e++)t.__webglFramebuffer[e]=r.createFramebuffer(),t.__webglRenderbuffer[e]=r.createRenderbuffer(),this.setupFrameBuffer(t.__webglFramebuffer[e],t,r.TEXTURE_CUBE_MAP_POSITIVE_X+e),this.setupRenderBuffer(t.__webglRenderbuffer[e],t);e&&r.generateMipmap(r.TEXTURE_CUBE_MAP)}else{t.__webglFramebuffer=r.createFramebuffer(),t.__webglRenderbuffer=r.createRenderbuffer();for(let i=0;i<t.colorCount;i++)if(i>0&&(t.__webglTexture[i]=r.createTexture()),r.bindTexture(r.TEXTURE_2D,t.__webglTexture[i]),this.setTextureParameters(r.TEXTURE_2D,t,e),r.texImage2D(r.TEXTURE_2D,0,o,t.width,t.height,0,n,a,null),i>0){let e=r.createFramebuffer();t.__webglMRTFramebuffers[i-1]=e,r.bindFramebuffer(r.FRAMEBUFFER,e),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t.__webglTexture[i],0)}this.setupFrameBuffer(t.__webglFramebuffer,t,r.TEXTURE_2D),this.setupRenderBuffer(t.__webglRenderbuffer,t),e&&r.generateMipmap(r.TEXTURE_2D)}s?r.bindTexture(r.TEXTURE_CUBE_MAP,null):r.bindTexture(r.TEXTURE_2D,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null)}}else if(!i&&t&&(t.minFilter!==t.originalMinFilter||t.magFilter!==t.originalMagFilter)){const e=this.isPowerOfTwo(t.width)&&this.isPowerOfTwo(t.height);if(s){for(let i=0;i<t.__webglTexture.length;i++)r.bindTexture(r.TEXTURE_CUBE_MAP,t.__webglTexture[i]),this.setTextureParameters(r.TEXTURE_CUBE_MAP,t,e);r.bindTexture(r.TEXTURE_CUBE_MAP,null)}else{for(let i=0;i<t.__webglTexture.length;i++)r.bindTexture(r.TEXTURE_2D,t.__webglTexture[i]),this.setTextureParameters(r.TEXTURE_2D,t,e);r.bindTexture(r.TEXTURE_2D,null)}t.originalMinFilter=t.minFilter,t.originalMagFilter=t.magFilter}if(t){a=s?t.__webglFramebuffer[t.activeCubeFace]:t.__webglFramebuffer;let i=!0,n=t.shareDepthFrom;if(n){let o=!0;if(n.__webglRenderbuffer||(console.warn("sharedDepth from an unused renderTarget"),o=!1),n.width==t.width&&n.height==t.height||(console.warn("sharedDepth from a renderTarget of different size"),o=!1),n instanceof e.WebGLRenderTargetCube!=s&&(console.warn("sharedDepth renderTarget or current renderTarget is cube and not the other"),o=!1),n.depthBuffer==t.depthBuffer&&n.stencilBuffer==t.stencilBuffer||(console.warn("sharedDepth renderTarget has a different format from current renderTarget"),o=!1),o){let e=s?n.__webglRenderbuffer[t.activeCubeFace]:n.__webglRenderbuffer;r.bindFramebuffer(r.FRAMEBUFFER,a),t.depthBuffer&&!t.stencilBuffer?r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,e):t.depthBuffer&&t.stencilBuffer&&r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,e),r.bindFramebuffer(r.FRAMEBUFFER,null),t.__currentFrameBuffer=n.__webglRenderbuffer,i=!1}}if(i&&t.__currentFrameBuffer){let e=s?t.__webglRenderbuffer[t.activeCubeFace]:t.__webglRenderbuffer;r.bindFramebuffer(r.FRAMEBUFFER,a),t.depthBuffer&&!t.stencilBuffer?r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,e):t.depthBuffer&&t.stencilBuffer&&r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,e),r.bindFramebuffer(r.FRAMEBUFFER,null),t.__currentFrameBuffer=null}}else a=this._VRFrameBuffer?this._VRFrameBuffer:null;if(i&&t.__webglTexture&&t.__webglTexture.length>0&&this.setupFrameBuffer(t.__webglFramebuffer,t,r.TEXTURE_2D),r&&r.bindFramebuffer(r.FRAMEBUFFER,a),e.glStates.currentFramebuffer=a,t&&n&&t.__webglTexture&&t.__webglTexture.length>1){let e=[];for(let i=0;i<t.__webglTexture.length;i++)e.push(n.COLOR_ATTACHMENT0_WEBGL+i);n.drawBuffersWEBGL(e)}}_setBlending(e,t,i,r,n,s,a){let o=this.gl;e?t&&(o.enable(o.BLEND),n?(o.blendEquationSeparate(t,n),o.blendFuncSeparate(i,r,s,a)):(o.blendEquation(t),o.blendFunc(i,r))):o.disable(o.BLEND)}setDepthFunc(e){this.gpuStates.depthFunc!==e&&this.gl.depthFunc(e),super.setDepthFunc(e)}setDepthTest(e){this.gpuStates.depthTest!==e&&(e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST)),super.setDepthTest(e)}setStencilTest(e){this.gpuStates.stencilTest!==e&&(e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST)),super.setStencilTest(e)}setPolygonOffset(e,t,i){let r=this.gl,n=this.gpuStates;n.polygonOffset!==e&&(e?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),n.polygonOffset=e),!e||n.polygonOffsetFactor===t&&n.polygonOffsetUnits===i||(r.polygonOffset(t,i),n.polygonOffsetFactor=t,n.polygonOffsetUnits=i)}enableScissorTest(e){super.enableScissorTest(e),this.gl&&(e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST))}setScissor(e,t,i,r){super.setScissor(e,t,i,r),this.gl&&this.gl.scissor(e,t,i,r)}clear(e,t,i){let r=this.gl;var n=0;(void 0===e||e)&&(n|=r.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=r.DEPTH_BUFFER_BIT);var s=!1;(void 0===i||i)&&(s=!0,n|=r.STENCIL_BUFFER_BIT,this.setStencilWrite(!0)),n&&r.clear(n),s&&!this.enableStencilWrite&&this.setStencilWrite(!1)}setClearColor(e,t){super.setClearColor(e,t),this.gl&&this.gl.clearColor(e.r,e.g,e.b,t)}setClearDepth(e){super.setClearDepth(e),this.gl&&this.gl.clearDepth(e)}setClearStencil(e){super.setClearStencil(e),this.gl&&this.gl.clearStencil(e)}setColorWrite(e){if(this.disableSetColorWrite)return;let t=this.gpuStates;t.colorWrite!==e&&(e?this.gl&&this.gl.colorMask(!0,!0,!0,!0):this.gl&&this.gl.colorMask(!1,!1,!1,!1),t.colorWrite=e)}setStencilFunc(e,t,i){this.gl&&this.gl.stencilFunc(e,t,i),super.setStencilFunc(e,t||0,i||1)}setStencilOp(e,t,i){this.gl&&this.gl.stencilOp(e,t,i),super.setStencilOp(e,t,i)}setStencilOpFront(e,t,i){this.gl&&this.gl.stencilOpSeparate(this.gl.FRONT,e,t,i),super.setStencilOpFront(e,t,i)}setStencilOpBack(e,t,i){this.gl&&this.gl.stencilOpSeparate(this.gl.BACK,e,t,i),super.setStencilOpBack(e,t,i)}setStencilWrite(e){let t=this.gpuStates;e!==t.stencilWrite&&(e?this.gl&&this.gl.stencilMask(255):this.gl&&this.gl.stencilMask(0),t.stencilWrite=e)}setDepthWrite(e){let t=this.gpuStates;t.depthWrite!==e&&(this.gl&&this.gl.depthMask(e),t.depthWrite=e)}setFrontFace(t){t===e.FrontFaceDirectionCW?this.gl.frontFace(this.gl.CW):this.gl.frontFace(this.gl.CCW),super.setFrontFace(t)}setCullMode(e){e!=this.cullings.NONE?(this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(e)):this.gl.disable(this.gl.CULL_FACE),super.setCullMode(e)}}return M})),define("DS/Visualization/Filters/FilteredFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this.state=e}}})),define("DS/Visualization/PickingMode",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode","DS/Mesh/Mesh"],(function(e,t,i){"use strict";const r=new t;class n{constructor(){this.pickingModeMSB=e.ShowAllFaces|e.AllPointsButSurfacicPointsRenderPointMask|e.WireEdgeRenderLineModeMask,this.pickingModeLSB=e.BodyLinesMask|e.SurfacicPointRenderPointMask}clone(){var e=new n;return e.pickingModeMSB=this.pickingModeMSB,e.pickingModeLSB=this.pickingModeLSB,e}applyToAll(e){this.setPickingMode("Face",e),this.setPickingMode("InternalSharpEdge",e),this.setPickingMode("Edge",e),this.setPickingMode("InternalSmoothEdge",e),this.setPickingMode("_HighCurvatureEdge",e),this.setPickingMode("BoundaryEdge",e),this.setPickingMode("WireEdge",e),this.setPickingMode("BoundaryPoint",e),this.setPickingMode("SharpPoint",e),this.setPickingMode("SmoothPoint",e),this.setPickingMode("FreePoint",e),this.setPickingMode("AxisSystem",e),this.setPickingMode("InfiniteFace",e)}_fromRenderer(e){this.pickingModeLSB=e.pickingModeLSB,this.pickingModeMSB=e.pickingModeMSB}_getPickingMasks(e){var i=this.pickingModeLSB,r=this.pickingModeMSB,n=~r&i|r&i&~e|e&(r^i),s=n&t.pointsMask;return[n&t.facesMask,n&t.linesPickingMask,s]}getPickingMasks(e){var t=e.getMask();return this._getPickingMasks(t)}_setPickingMode(e,t){var r=this.pickingModeLSB,n=this.pickingModeMSB;switch(t){case i.PICK_NEVER:this.pickingModeMSB=n&~e,this.pickingModeLSB=r&~e;break;case i.PICK_ALWAYS:this.pickingModeMSB=n&~e,this.pickingModeLSB=r|e;break;case i.PICK_VISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r&~e;break;case i.PICK_INVISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r|e}}setPickingMode(e,t){r._mask=0,r.setRenderMode(e,!0),this._setPickingMode(r.getMask(),t)}}return e.PickingMode=n,n})),define("DS/Visualization/Measurable",["UWA/Class","DS/Visualization/ThreeJS_R57"],(function(e,t){"use strict";var i=[0,8,8,2,2],r=new Uint8Array(4),n=new DataView(r.buffer,0,4),s=new Uint8Array(8),a=new DataView(s.buffer,0,8),o=e.extend({init:function(e){this.sgNode=e,this.size=-1;var t,i=e.getDecoration();if(i){if(i instanceof Array)this.string=i,this.size=this.string[0];else if(e&&(t=e.getGroup())&&t.geometry)if(t.geometry.decorations&&t.geometry.decorations.length){var r=t.geometry.decorations,n=i-1;this.size=r[n]+1,this.string=new Array(this.size);for(var s=0;s<this.size;s++)this.string[s]=r[n++]}else this.string=[]}else this.string=[];this.type=null,this.version=0,this.conversion=!0},getType:function(){return 0==this.size?this.type=o.TYPEUNKNOWN:this.size>0?this.readHeader():this.type=null,this.type},readHeader:function(){var e=0;if(this.size>=i[3]){if(0==this.string[1]){if(this.size>=i[1]){var t=this.readInt(1,2);return this.version=t[0],void(this.type=t[1])}}else this.string[1]=="2".charCodeAt(0)?this.version=2:this.string[1]=="3".charCodeAt(0)?this.version=3:this.string[1]=="4".charCodeAt(0)?this.version=4:this.string[1]=="5".charCodeAt(0)&&(this.version=5),e=this.string[2];switch(e){case 49:this.type=o.TYPEUNKNOWN;break;case 50:this.type=o.TYPEPLANE;break;case 51:this.type=o.TYPECYLINDER;break;case 52:this.type=o.TYPECONE;break;case 53:this.type=o.TYPESPHERE;break;case 54:this.type=o.TYPELINE;break;case 55:this.type=o.TYPECIRCLE;break;case 56:this.type=o.TYPETORUS}}},getPlane:function(){return this.type==o.TYPEPLANE?this.readPlane():null},getCone:function(){return this.type==o.TYPECONE?this.readCone():null},getSphere:function(){return this.type==o.TYPESPHERE?this.readSphere():null},getCircle:function(){return this.type==o.TYPECIRCLE?this.readCircle():null},getCylinder:function(){return this.type==o.TYPECYLINDER?this.readCylinder():null},getLine:function(){return this.type==o.TYPELINE?this.readLine():null},getTorus:function(){return this.type==o.TYPETORUS?this.readTorus():null},readTorus:function(){var e=[0,0,0],t=[0,0,1],r=0,n=0,s=[];if(3==this.version){var a=(s=this.readFloat(i[this.version]+1,8))[0],o=s[1],l=s[2],h=s[3],c=s[4],d=s[5],u=s[6],p=1-h*h-c*c,f=p>=0?Math.sqrt(p):0;d<0&&(f=-f,d=-d),e=[a,o,l],t=[h,c,f],r=u,n=d}else 1==this.version||2==this.version||4==this.version?(e=[(s=this.readDouble(i[this.version]+1,8))[0],s[1],s[2]],t=[s[3],s[4],s[5]],r=s[7],n=s[6]):this.version;return{center:e,axis:t,maxRadius:n,minRadius:r}},readCone:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var s=(n=this.readFloat(i[this.version]+1,7))[0],a=n[1],o=n[2],l=n[3],h=n[4],c=n[5],d=1-l*l-h*h,u=d>=0?Math.sqrt(d):0;c<0&&(u=-u,c=-c);e=[s,a,o],t=[l,h,u],r=c}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,semiAngle:r}},readCircle:function(){var e=[0,0,0],r=[0,0,1],n=0,s=[];if(3==this.version){e=[(s=this.readFloat(i[this.version]+1,7))[0],s[1],s[2]],n=s[3];var a=this.sgNode.getStart(),o=this.sgNode.getGroup().geometry,l=o.vertexIndexArray[a],h=[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]],c=(l=o.vertexIndexArray[a+1],[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]]),d=new t.Vector3(h[0],h[1],h[2]),u=new t.Vector3(c[0],c[1],c[2]),p=new t.Vector3(e[0],e[1],e[2]);u.sub(d),p.sub(d),u.cross(p),u.normalize(),r=[u.x,u.y,u.z]}else 1==this.version||2==this.version||4==this.version?(e=[(s=this.readDouble(i[this.version]+1,7))[0],s[1],s[2]],r=[s[3],s[4],s[5]],n=s[6]):this.version;return{center:e,axis:r,radius:n}},readCylinder:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var s=(n=this.readFloat(i[this.version]+1,7))[0],a=n[1],o=n[2],l=n[3],h=n[4];r=n[5];var c=1-l*l-h*h,d=c>=0?Math.sqrt(c):0;r<0&&(d=-d,r=-r),e=[s,a,o],t=[l,h,d]}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,radius:r}},readSphere:function(){var e=[0,0,0],t=0,r=[];if(3==this.version){var n=(r=this.readFloat(i[this.version]+1,4))[0],s=r[1],a=r[2];t=r[3],e=[n,s,a]}else 1==this.version||2==this.version||4==this.version?(e=[(r=this.readDouble(i[this.version]+1,4))[0],r[1],r[2]],t=r[3]):this.version;return{center:e,radius:t}},readLine:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),s=this.sgNode.getGroup().geometry,a=s.vertexIndexArray[n];e=[s.vertexPositionArray[3*a],s.vertexPositionArray[3*a+1],s.vertexPositionArray[3*a+2]];a=s.vertexIndexArray[n+1];t=[s.vertexPositionArray[3*a],s.vertexPositionArray[3*a+1],s.vertexPositionArray[3*a+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{startPosition:e,endPosition:t}},readPlane:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),s=this.sgNode.getGroup().geometry,a=s.vertexIndexArray[n];e=[s.vertexPositionArray[3*a],s.vertexPositionArray[3*a+1],s.vertexPositionArray[3*a+2]],t=[s.vertexNormalArray[3*a],s.vertexNormalArray[3*a+1],s.vertexNormalArray[3*a+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{normal:t,position:e}},readFloat:function(e,t){for(var i=new Array(t),s=0;s<t;s++)r[3]=this.string[e+4*s],r[2]=this.string[e+4*s+1],r[1]=this.string[e+4*s+2],r[0]=this.string[e+4*s+3],i[s]=n.getFloat32(0,this.conversion);return i},readInt:function(e,t){for(var i=new Array(t),s=0;s<t;s++)r[3]=this.string[e+4*s],r[2]=this.string[e+4*s+1],r[1]=this.string[e+4*s+2],r[0]=this.string[e+4*s+3],i[s]=n.getUint32(0,this.conversion);return i},readDouble:function(e,t){for(var i=new Array(t),r=0;r<t;r++)s[7]=this.string[e+8*r],s[6]=this.string[e+8*r+1],s[5]=this.string[e+8*r+2],s[4]=this.string[e+8*r+3],s[3]=this.string[e+8*r+4],s[2]=this.string[e+8*r+5],s[1]=this.string[e+8*r+6],s[0]=this.string[e+8*r+7],i[r]=a.getFloat64(0,this.conversion);return i}});return o.TYPEUNKNOWN=1,o.TYPEPLANE=2,o.TYPECYLINDER=3,o.TYPECONE=4,o.TYPESPHERE=5,o.TYPELINE=7,o.TYPECIRCLE=8,o.TYPETORUS=9,UWA.namespace("THREEDS/Measurable",o)})),define("Visualization/Measurable",["DS/Visualization/Measurable","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/Measurable"),e})),define("DS/Visualization/BudgetedRenderManager",["UWA/Class","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";var i=e.extend({init:function(e){return this.viewer=e,this._frameTime=0,this._isActive=!1,this._isSimpleActive=!0,this._lastRefreshStamp=performance.now(),this._objectivePercentage=-1,this._shiftToObjective=0,this._shiftStart=0,this._renderTimeStart=0,this._lastRenderTime=16.7,this._lastRenderFrameTime=16.7,this._maxTime=0,this._simpleMaxTime=2e3,this._renderCallbackId=-1,this._startStamp=performance.now(),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1,this},_setAsRenderFrame:function(){this._isRenderFrame=!0},_askForRender:function(e){if(this._isActive||this._isSimpleActive)if(this._isSimpleActive){(i=(t=performance.now())-this._lastRefreshStamp)>this._simpleMaxTime&&(e.budgeted=!1,this._lastRefreshStamp=t,this.viewer.render(e))}else{var t,i=(t=performance.now())-this._lastRefreshStamp,r=(this._startStamp,this._objectivePercentage),n=(performance.now()-this._shiftStart)/this._shiftToObjective;r=1-(n=(n=Math.min(Math.max(0,n),1))*n*(3-2*n))+r*n;var s=this._lastRenderTime*(1-r)/r-i;if(s<=0||this._maxTime>0&&i>this._maxTime)e.budgeted=!1,this._lastRefreshStamp=t,this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1),this.viewer.render(e);else if(this._renderCallbackId<0){var a=this;this._renderCallbackId=setTimeout((function(){a.viewer.render(e)}),s)}}else e.budgeted=!1,this.viewer.render(e)},_resetShift:function(){this._shiftStart=performance.now(),this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1)},resetMeasures:function(){this._startStamp=performance.now(),this._lastRefreshStamp=performance.now(),this._lastrenderTime=16.7},setBudget:function(e){this._objectivePercentage=Math.max(0,Math.min(1,e)),this._isActive=!0,this._isSimpleActive=!1;var t=this;if(-1===this._preRenderCallBackId){this._preRenderCallBackId=this.viewer.onPreRender((function(){t._renderTimeStart=performance.now()}));this._postRenderCallBackId=this.viewer.onPostRender((function(){t._lastRenderTime=performance.now()-t._renderTimeStart}))}this.resetMeasures()},setSimpleBudget:function(e){this._isSimpleActive=e,e&&this._isActive&&(this._isActive=!1)},disableBudget:function(){this._isActive=!1,this._objectivePercentage=-1,this._preRenderCallBackId>=0&&(this.viewer.unsubscribe(this._preRenderCallBackId),this.viewer.unsubscribe(this._postRenderCallBackId),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1)},setSimpleMaxTime:function(e){this._simpleMaxTime=e},setMaxTime:function(e){this._maxTime=e},setShiftingObjective:function(e){this._shiftToObjective=e}});return UWA.namespace("THREEDS/BudgetedRenderManager",i)})),define("DS/Visualization/ScissorPolyLineData",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";function t(e){this.type="polyline",this.polyLines=[],this.lastFrameIndex=-1,this.lastCamera=null,this.texture=null,e&&this.polyLines.push(new i(e))}function i(t,i){let r;for(this.nbPolygon=t.nbPolygon,this.nbVertices=t.nbVertices,this.vertices=t.vertices,this.point=t.point,this.dirX=t.dirX,this.dirY=t.dirY,this.matrix=i,this.points3D=[],this.clippedPoints3D=null,r=0;r<this.vertices.length;r+=2){var n=this.vertices[r],s=this.vertices[r+1],a=this.dirX,o=this.dirY,l=this.point,h=new e.Vector3(l.x+n*a.x+s*o.x,l.y+n*a.y+s*o.y,l.z+n*a.z+s*o.z);i&&h.applyMatrix4(i),this.points3D.push(h)}}return t.prototype.getNbVertices=function(){var e,t,i,r=[];for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r.push(i.nbVertices[t]);return r},t.prototype.getVerticesCount=function(){var e,t,i,r=0;for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r+=i.nbVertices[t];return r},t.prototype.getForOccurrenceOverride=function(e){if(e){var i,r,n=new t;for(i=0;i<this.polyLines.length;i++)r=this.polyLines[i].matrix||e,n.polyLines.push(this.polyLines[i].getForOccurrenceOverride(r));return n}return this},t.prototype.updateTexture=function(t,i){if(t===this.lastCamera&&this.lastFrameIndex===i&&this.texture)return;this.lastCamera=t,this.frameIndex=i;var r,n=0;let s=t instanceof e.PerspectiveCamera;for(r=0;r<this.polyLines.length;r++){let e=this.polyLines[r];e.clippedPoints3D=s?this.clipPoints(e.points3D,t):null,n+=e.clippedPoints3D?e.clippedPoints3D.length:e.points3D.length}var a=new Float32Array(4*n),o=new e.Matrix4;new e.Vector3;o.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var l,h=0;for(r=0;r<this.polyLines.length;r++){let e=(l=this.polyLines[r]).clippedPoints3D||l.points3D;l.fillBuffer(o,h,a,e),h+=4*e.length}var c=new e.DataTexture(a,n,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter);c.needsUpdate=!0,this.texture&&this.texture.dispose(),this.texture=c},t.prototype.getNbPolygon=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++)t+=this.polyLines[e].nbPolygon;return t},t.prototype.clipPoints=function(t,i){let r,n=i.near,s=[],a=[],o=new e.Vector3,l=-1,h=i.position,c=i.getLookAt();for(r=0;r<t.length;r++){o.subVectors(t[r],h);let e=o.dot(c);a.push(e),e>=n&&l<0&&(l=r)}if(l<0)s=[t[0],t[0],t[0]];else{s=[t[l]];let i,d,u=!1,p=null,f=null;for(r=1;r<t.length;r++){i=(l+r)%t.length,d=(l+r-1)%t.length;let g=a[i]<n;g!==u&&(null===p&&(p=new e.Plane,o.set(h.x+n*c.x,h.y+n*c.y,h.z+n*c.z),p.setFromNormalAndCoplanarPoint(c,o),f=new e.Line3),f.set(t[i],t[d]),s.push(p.intersectLine(f))),g||s.push(t[i]),u=g}u&&(f.set(t[i],t[l]),s.push(p.intersectLine(f)))}return s},t.merge=function(e,r,n){if(!!(e&&"polyline"!==e.type||r&&"polyline"!==r.type))return e||r;var s=null;let a=r&&r.polyLines;if(r&&n){a=[];let e=0;for(e=0;e<r.polyLines.length;e++)a.push(new i(r.polyLines[e],n))}return e&&r?(s=new t(null)).polyLines=e.polyLines.concat(a):r?(s=new t(null)).polyLines=a:s=e,s},i.prototype.getForOccurrenceOverride=function(e){return e?new i({nbPolygon:this.nbPolygon,nbVertices:this.nbVertices,vertices:this.vertices,point:this.point,dirX:this.dirX,dirY:this.dirY},e):this},i.prototype.fillBuffer=function(t,i,r,n){var s,a,o=new e.Vector4;let l=debugWebGLV6Viewer.currentViewpoint.getEyePosition(),h=debugWebGLV6Viewer.currentViewpoint.getSightDirection(),c=[];for(s=0;s<n.length;s++){a=n[s],o.set(a.x,a.y,a.z,1);let d=new e.Vector3;d.subVectors(o,l),c.push(d.dot(h)),o.applyMatrix4(t),r[i+4*s]=o.x/o.w,r[i+4*s+1]=o.y/o.w,r[i+4*s+2]=0,r[i+4*s+3]=1}},t})),define("DS/Visualization/ClippingContext",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ScissorPolyLineData","DS/Visualization/ClippingPolyLineData"],(function(e,t,i,r,n){"use strict";var s=0,a=e.extend({init:function(e){this.id=s++,this.planes=e||[],this.planesParams=null,this.cylinder=null,this._localCylinder=null,this.excludeFromClippingPlanes=[],this.clippingSettings=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null,this._scissor=null,this._enableClippingProfile=0,this._clipPolyLine=null,this._uncut=!1,this._localCoordinates=!1,this._localPlanes=null,window.sealWebVisuObjects&&Object.seal(this)},setPlanes:function(e,t){var i;if(this.planes=e||[],this._planesParams=null,t)if(1===t.length&&"all"===t[0])this.planes=[];else for(i=this.planes.length-1;i>=0;i--)t.indexOf(this.planes[i])>=0&&this.planes.splice(i,1)},setExcludeFromClippingPlanes:function(e){this.excludeFromClippingPlanes=e||[]},setUncut:function(e){this._uncut=!!e},setFrontAndBackOpacity:function(e,t){this.clippingSettings=null===e||null===t?null:{frontOpacity:e,backOpacity:t}},getFrontOpacity:function(){return this.frontOpacity},getBackOpacity:function(){return this.backOpacity},setSectionCappingMaterial:function(e,t){this.sectionCappingMaterials||(this.sectionCappingMaterials=[],this.sectionCappingMaterials.defaultMaterial=null);var i=t||null;if(i){var r=0,n=-1;for(r=0;-1===n&&r<this.sectionCappingMaterials.length;r++)this.sectionCappingMaterials[r].clippingPlane===i&&(n=r);n>=0?this.sectionCappingMaterials[n].material=e:this.sectionCappingMaterials.push({clippingPlane:i,material:e})}else this.sectionCappingMaterials.defaultMaterial=e},setSectionLinesProperties:function(e){this.sectionLinesProperties=e?{color:void 0===e.color?null:e.color,width:e.width}:null},getSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){if(!e)return this.sectionCappingMaterials.defaultMaterial;var t;for(t=0;t<this.sectionCappingMaterials.length;t++)if(this.sectionCappingMaterials[t].clippingPlane===e)return this.sectionCappingMaterials[t].material}return null},removeSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},clone:function(){var e,t,i=new a(this.planes);if(i._planesParams=this._planesParams,i.cylinder=this.cylinder,i._scissor=this._scissor,i._clipPolyLine=this._clipPolyLine,i._enableClippingProfile=this._enableClippingProfile,i._uncut=this._uncut,i.excludeFromClippingPlanes=[].concat(this.excludeFromClippingPlanes),i._localCoordinates=this._localCoordinates,this._localPlanes){let e;for(i._localPlanes=[],e=0;e<this._localPlanes.length;e++)i._localPlanes.push(this._localPlanes[e].clone())}if(this.clippingSettings&&(i.clippingSettings={frontOpacity:this.clippingSettings.frontOpacity,backOpacity:this.clippingSettings.backOpacity}),this.sectionCappingMaterials)for(i.sectionCappingMaterials=[],i.sectionCappingMaterials.defaultMaterial=this.sectionCappingMaterials.defaultMaterial,e=0;e<this.sectionCappingMaterials.length;e++)t=this.sectionCappingMaterials[e],i.sectionCappingMaterials.push({clippingPlane:t.clippingPlane,material:t.material});return i.sectionLinesProperties=this.sectionLinesProperties,i},addPlane:function(e){return this.planes.indexOf(e)<0&&(this.planes.push(e),!0)},removePlane:function(e){var t=this.planes.indexOf(e);return t>=0&&(this.planes.splice(t,1),this._planesParams&&t<=this._planesParams.length-1&&this._planesParams.splice(t,1),!0)},isPointVisible:function(e){var t,i,r=this.clippingSettings&&this.clippingSettings.frontOpacity<.5;for(t=0;t<this.planes.length;t++)if(i=this.planes[t],this.excludeFromClippingPlanes.indexOf(i)<0&&i.distanceToPoint(e)<0)return!!r;return!r},setClippingProfile:function(e){this._clipPolyLine=e?new n(e):null},setEnableClippingProfile:function(e){this._enableClippingProfile="on"===e?1:"off"===e?-1:0},isClippingProfileEnabled:function(){return this._enableClippingProfile>=0},setScissorPolyLine:function(e,t){this._scissor=e?new r(t):null},_isCappingUsingPlaneMaterial:function(){let e,i=0;for(e=0;e<this.planes.length;e++){let r=this.getSectionCappingMaterial(this.planes[e]);r||(i=i<1?1:i),r instanceof t.HatchingMeshMaterial&&(r.autoSpaceColor||r.autoStripesColor)&&(i=i<2?2:i)}return i},_getScissorPolyLineSize:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getVerticesCount():0},_getScissorNbPolygons:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getNbPolygon():0},setScissorCircle:function(e,t){this._scissor=e?{type:"circle",x:t.x,y:t.y,radius:t.radius}:null},setPlaneParams:function(e,t){var i=this.planes.indexOf(e);i>=0&&(!this._planesParams&&t&&(this._planesParams=[]),this._planesParams&&(this._planesParams[i]=t?new l(t):null))},_setUseLocalCoordinates:function(){this._localCoordinates=!0},_mergeWithParent:function(e,t){if(!e&&this._scissor&&(e=new a),!e)return this;var i=new a;i._enableClippingProfile=0!==this._enableClippingProfile?this._enableClippingProfile:e._enableClippingProfile,this._uncut||(i._clipPolyLine=n.merge(e._clipPolyLine,this._clipPolyLine)),i.cylinder=this._uncut?null:this.cylinder||e.cylinder,this._uncut||(i._scissor=r.merge(e._scissor,this._scissor,t));var s,o,l,h,c=[].concat(this.planes);if(!this._uncut)for(s=0;s<e.planes.length;s++)c.indexOf(e.planes[s])<0&&c.push(e.planes[s]);if(i.setPlanes(c,this.excludeFromClippingPlanes),this._planesParams||e._planesParams)for(s=0;s<c.length;s++)o=null,l=c[s],((h=this.planes.indexOf(l))>=0||(h=e.planes.indexOf(l))>=0)&&(o=this._getPlaneParams(h)),this.setPlaneParams(l,o);i.clippingSettings=this.clippingSettings||e.clippingSettings;var d=null;if(this.sectionCappingMaterials&&e.sectionCappingMaterials){(d=[].concat(this.sectionCappingMaterials||[])).defaultMaterials=this.sectionCappingMaterials.defaultMaterial||e.sectionCappingMaterials.defaultMaterial;var u,p,f=e.sectionCappingMaterials||[];for(s=0;s<f.length;s++){for(p=!1,u=0;u<d.length&&!p;u++)d[u].clippingPlane===f[s].clippingPlane&&(p=!0);p||d.push(f[s])}}else d=this.sectionCappingMaterials||e.sectionCappingMaterials;return i.sectionCappingMaterials=d,i},_getPlaneParams:function(e){return this._planesParams&&this._planesParams[e]||null},_getPlaneParamsFromPlane:function(e){if(this._planesParams){var t=this.planes.indexOf(e);if(t>=0)return this._planesParams[t]||null;console.warn("unknown plane!")}return null},_hasPlaneCapping:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.capping},_hasPlaneSectionLine:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.sectionLines},_getSectionLinesArray:function(){if(this._planesParams){var e,t=[];for(e=0;e<this.planes.length;e++)!this._planesParams[e]||this._planesParams[e].sectionLines?t.push(!0):t.push(!1);return t}return null},_updatePosition:function(e){if(this._localCoordinates){var t;if(!this._localPlanes)for(this._localPlanes=[],t=0;t<this.planes.length;t++)this._localPlanes[t]=this.planes[t].clone();for(t=0;t<this.planes.length;t++)this.planes[t].copy(this._localPlanes[t]),e&&(this.planes[t].applyMatrix4(e),this.planes[t].normalize());if(this.cylinder){this._localCylinder||(this._localCylinder=this.cylinder);let t=this._localCylinder;this.cylinder={center:t.center.clone(),axisU:t.axisU.clone(),axisV:t.axisV.clone(),clipOutside:t.clipOutside},e&&(this.cylinder.center.applyMatrix4(e),this.cylinder.axisU.applyRotation(e),this.cylinder.axisV.applyRotation(e))}}},dbgDumpClippingContext:function(){return{planes:this.planes,excludeFromClippingPlanes:this.excludeFromClippingPlanes,clipPolyLine:this._clipPolyLine?this._clipPolyLine.dbgDump():null,enableClippingProfile:this._enableClippingProfile}},setAntiPlanes:function(){this.setExcludeFromClippingPlanes.apply(this,arguments)},_getInvertStatus:function(){return this.clippingSettings?this.clippingSettings.frontOpacity<.5&&this.clippingSettings.backOpacity>=.5?-1:0:1},_getBoundingSphereClippingStatus:function(e,t){let i,r,n=3,s=!1,a=this._getInvertStatus();if(0===a||0===this.planes.length)return n;let o=-1===a;for(r=!o,i=0;i<this.planes.length;i++){let n=this.planes[i].distanceToPoint(t);Math.abs(n)<e&&(s=!0),o?n<=e&&(r=!0):n<=-e&&(r=!1)}return n=s?r?3:2:r?1:2,n},_internal_hasUncut:function(){return!!(this.excludeFromClippingPlanes&&this.excludeFromClippingPlanes.length>0||this._uncut)}});function o(e){this.box=new t.Box3(new t.Vector3(e.box.min.x,e.box.min.y,0),new t.Vector3(e.box.max.x,e.box.max.y,0)),this.clipX=0,this.clipY=0,this.clipWidth=0,this.clipHeight=0,this.frame=-1}function l(e){this.capping=void 0===e.capping||!!e.capping,this.sectionLines=void 0===e.sectionLines||!!e.sectionLines}return o.prototype.projectPoint=function(e,t,i,r,n){var s=i.clone();return e.projectVector(s,t),s.x=.5*r*(s.x+1),s.y=.5*n*(s.y+1),s},o.prototype.updateClipRect=function(e,i,r,n){if(i!==this.frame){this.frame=i;var s=new t.Projector,a=this.projectPoint(s,e,this.box.min,r,n),o=this.projectPoint(s,e,this.box.max,r,n);this.clipX0=Math.round(a.x),this.clipY0=Math.round(o.y),this.clipX1=Math.round(o.x),this.clipY1=Math.round(a.y)}},a})),define("DS/Visualization/Filters/GeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],(function(e,t){"use strict";return class extends t{constructor(e){super(),this._geomType=e}}})),define("DS/Visualization/Filters/StaticGeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/GeomTypeFilter"],(function(e,t){"use strict";return class extends t{constructor(e){throw super(e),"Unsupported class"}}})),define("DS/Visualization/MaterialConnection",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";var t=-1,i=1,r=2,n=function(e){e=e||{},this.setParams(e)};return n.prototype.setParams=function(e){this.appearanceId=e.appearanceId||null,this.pathElement=e.pathElement||null,this.type=e.type||n._UNKNOWN,this.status=null!==this.pathElement?i:t,this.vLayer=e.vLayer||0},n.prototype.isComplete=function(){return this.status===i},n.prototype.isIncomplete=function(){return this.status===t},n.prototype.isError=function(){return this.status===r},n.prototype.computeLayer=function(t){var i=this.pathElement.externalPath.length,r=this.vLayer;return this.type===n.CORE_MATERIAL?e.MaterialLayerMax:32768n*BigInt(0)+16n*BigInt(i)+BigInt(r)},n._UNKNOWN=0,n.COVERAGE_MATERIAL=1,n.CORE_MATERIAL=2,n})),define("DS/Visualization/OccurrenceInterface",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS"],(function(e,t,i){"use strict";function r(e){if(!e._occurrenceExplorer._occurrenceInterfaceList){var t=new Error("Use of expired OccurrenceInterface (= outside of callback function given to OccurrenceExplorer.explore())");throw t.expiredOccurrenceInterfaceError=!0,t}return e._occurrenceExplorer._occurrenceList[e._node][e._index].occurrence}return e.extend({init:function(e,t,i){this._node=e,this._index=t,this._occurrenceExplorer=i},getNbChildren:function(){return r(this).children.length},getParent:function(){var e=r(this);return this._occurrenceExplorer.getOccurrenceInterface(e.parent)},getChild:function(e){var t=r(this);return this._occurrenceExplorer.getOccurrenceInterface(t.children[e])},getChildren:function(){var e,t=r(this),i=[];for(e=0;e<t.children.length;e++)i.push(this._occurrenceExplorer.getOccurrenceInterface(t.children[e]));return i},traverse:function(e,t){var i=r(this);if(!e(this,t)){var n=0;for(n=0;n<i.children.length;n++)this._occurrenceExplorer.getOccurrenceInterface(i.children[n]).traverse(e,t)}},getNode:function(){return r(this).node},getMesh3D:function(){var e=r(this);return"Mesh3D"===e.node.getNodeType()?e.node:null},getColor:function(e){var t=r(this);if(this._tryOverridesUpdate(t),t.renderable){var n=t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,s=n&&n.getColor()||null,a=n&&n.getFullMaterial(),o=t.renderable.matApp&&t.renderable.matApp._getMaterialFromGLType(4,i.GeomTypeEnum.FACE),l=!1;!o&&t.renderable.material?(l=!0,!(o=t.renderable.material)||!e&&o.force||(o=null)):o&&e&&(o=null);var h=null;null===s&&!a||o&&o.color&&!o.overridable?h=o&&o.color&&(!l||o.force)&&o.color.clone():(h=a&&a.color&&a.color.clone(),null===s||h&&!a.overridable||(h=new i.Color(s)))}return h},getWorldMatrix:function(e){var t=r(this);return this._tryOverridesUpdate(t),e?(e.copy(t.matrix),e):t.matrix.clone()},getMatrix:function(e){var t=r(this);this._tryOverridesUpdate(t);var i=t.getLocalMatrix();return e?(e.copy(i),e):i.clone()},getMatrixInAxisSystem:function(e,t){var r=this.getWorldMatrix();if(!r)return null;var n=t||new i.Matrix4,s=new i.Matrix4;return s.getInverse(e),n.multiplyMatrices(s,r),n},getRenderableDescendants:function(){var e=r(this),t=[],i=this;return e.traverse((function(e){e.renderable&&t.push(i._occurrenceExplorer.getOccurrenceInterface(e))})),t},buildPathElement:function(e){var i=new t,n=r(this);return i.setFromOccurrence(n,null,e)?i:null},getVisibility:function(){var e=r(this);return this._tryOverridesUpdate(e),e._getVisible()},getBoundingSphere:function(e){return r(this).getBoundingSphere(e,!1)},getBoundingBox:function(e){return r(this).getBoundingBox(e)},isAParentOf:function(e){for(var t=e;t&&this!==t;)t=t.getParent();return t===this},findAncestor:function(e){for(var t=this.getParent(),i=null;t&&!i;)e(t)&&(i=t),t=t.getParent();return i},_tryOverridesUpdate:function(e){var t,i=this._occurrenceExplorer.viewer;if(e._getNeedOverridesUpdate()){for(t=e;t.parent;)t=t.parent;i=i||e.scene3js&&e.scene3js.viewer,t.node._tryOverridesUpdate(i)}}})})),define("DS/Visualization/Filters/PlaneViewModeFilter",["DS/Visualization/Filters/VisuFilter","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";return class extends e{constructor(e,i){if(super(),this.planeFilters=[],!(i instanceof t.Plane)||null==e)return;this.localMode=e;let r={mode:e,plane:i};this.planeFilters.push(r)}mergeLocalFilter(e){null!==this.localMode&&void 0!==this.localMode?e.mode===t.PlaneViewMode.NO_PICK&&this.localMode===t.PlaneViewMode.LOWLIGHT||e.mode===t.PlaneViewMode.LOWLIGHT&&this.localMode===t.PlaneViewMode.NO_PICK?this.planeFilters[0].mode=t.PlaneViewMode.LOWLIGHT_NO_PICK:e.mode>this.localMode?this.planeFilters[0].mode=e.mode:this.localMode>=e.mode&&(this.planeFilters[0].mode=this.localMode):this.planeFilters[0].mode=e.mode}solveInherit(e,t,i){let r=this.planeFilters[0];if(!t)return i&&(this.planeFilters=[],r.mode=this.localMode,this.planeFilters.push(r)),this;this.planeFilters=[],this.planeFilters.push(r);let n=!1;for(let e of t.planeFilters)e.plane.equals(r.plane)?(this.mergeLocalFilter(e),n=!0):this.planeFilters.push(e);return n||(this.planeFilters[0].mode=this.localMode),this}}})),define("DS/Visualization/BoundingBoxGPUCompute",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/ShaderBuilders/ShaderUtils/FunctionUtils","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Plugins/ComposerContext","DS/Plugins/EffectComposer"],(function(e,t,i,r,n,s,a){"use strict";var o=e.extend({init:function(e){this.renderer=e,this.minMaxExtension=t.supportedExtensions.blendMinMax,this.useBackUpAlgorithm=!0,//!(this.renderer.renderer.supportsFloatTextures() && this.minMaxExtension);
this._pixels=1,this.material=null;this.composer=new a(this.renderer.renderer,void 0,this.renderer.renderTargetPool,["--\x3e(main)","clearBBPass","drawBBPass"]),this.clearPass=new n("clearBBPass"),this.clearPass.clearColor=new t.Color(0),this.clearPass.clearAlpha=0,this.drawPass=new r(null,null,null,!1,!1,!0,"drawBBPass"),this.drawPass.disableToneMapping=!0,this.width=6,this.height=this._pixels;var i=new t.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");return this.bboxComposerContext=new s(i,this.composer,"bboxComposerContext"),this.scene=null,this.composer.addPass(this.clearPass),this.composer.addPass(this.drawPass),this.clearPass.clearbColor=!0,this.bboxComposerContext.setPassClear(this.clearPass,!1),this.bboxComposerContext.setPassClearDepth(this.clearPass,!0),this},setPixelCount:function(e){this._pixels=e},_initBackUpMaterial:function(){var e=new t.ParticleBasicMaterial;e.sizeAttenuation=!1,e.activatePDSFX("PDSFXBBoxGPUCompute");var r={composante:{type:"v3",value:new t.Vector3},orientationMatrix:{type:"m4",value:new t.Matrix4},zMin:{type:"f",value:0},zMax:{type:"f",value:0}};e.setPDSFXUniforms(r);e.setPDSFXVaryings({vZ:{type:"f"}});var n={ComputeObjectTexCoord0:function(e,t){const i=e.variableHandler;return`\n                            return ${(e=>i.vec4(e))()}(0.0, 0.0, 0.0, 0.0);\n                        `},ProcessClipSpacePosition:function(e,t){const r=e.variableHandler,n=e.functionHandler,s=e.pdsfxDefines,a=t=>e.getUniform(t),o=t=>e.getVarying(t),l=e=>r.float(e),h=e=>r.vec4(e),c=r.dereference(t[0]);return`\n\n                        ${o("vZ")}=dot(${a("composante")},(${a("orientationMatrix")} * ${((e,t,r)=>i.FunctionHandler.callFunction(e,t,r))("getModelTransformation","v4",[n.prmV3("vertexLocalPosition")])}).xyz);\n                        //float yPos = fract(sin(vZ)*1000.0)*2.0-1.0;\n                        //gl_Position=vec4(0.0,yPos,2.0*(vZ-zMin)/(zMax-zMin)-1.0,1.0);\n\t\t\t\t\t\t${l("zDiff")}=${a("zMax")}-${a("zMin")};\n\t\t\t\t\t\t${l("zCoef")}=${s.WebGPU?"1.0":"2.0"};\n\t\t\t\t\t\t${l("zOffset")}=${s.WebGPU?`${a("zMin")};`:`(${a("zMin")}+${a("zMax")});`};\n                        ${c} = ${h()}(0.0,0.0,zCoef*(${o("vZ")})/zDiff-zOffset/zDiff,1.0);\n                        //${c} = ${h()}(0.0,0.0,2.0*(${o("vZ")})/(${a("zMax")}-${a("zMin")})-(${a("zMin")}+${a("zMax")})/(${a("zMax")}-${a("zMin")}),1.0);\n                        `},ComputeObjectNormal:function(e,t){const i=e.variableHandler;return`\n                            return ${(e=>i.vec3(e))()}(0.0, 0.0, 0.0);\n                        `}};return e.setPDSFXGlobalShaderCode(null,(e=>{const t=e.variableHandler,i=e.functionHandler,r=e.bridgeFunctions,n=(e.pdsfxDefines,e.userDefines,e=>t.float(e)),s=e=>t.vec4(e);return`\n                    ${i.dF("shift_right","f",[i.prmF("v"),i.prmF("amt")])} {\n                        return floor((floor(v) + 0.5) / exp2(amt));\n                    }\n\n                    ${i.dF("shift_left","f",[i.prmF("v"),i.prmF("amt")])} {\n                        return floor(v * exp2(amt) + 0.5);\n                    }\n                    ${i.dF("mask_last","f",[i.prmF("v"),i.prmF("bits")])} {\n                        ${n("shifted")} = ${i.cF("shift_left","f",[i.prmF("1.0"),i.prmF("bits")])};\n                        return ${r.modulo("v","shifted")};\n                    }\n                    ${i.dF("extract_bits","f",[i.prmF("num"),i.prmF("ifrom"),i.prmF("to")])} {\n                        ${n("From")} = floor(ifrom + 0.5);\n                        ${n("To")} = floor(to + 0.5);\n                        ${n("shiftR")} = ${i.cF("shift_right","f",[i.prmF("num"),i.prmF("From")])};\n                        return ${i.cF("mask_last","f",[i.prmF("shiftR"),i.prmF("To - From")])};\n                    }\n                    ${i.dF("encode_float","v4",[i.prmF("val")])} {\n                        if (val == 0.0) {\n                            return ${s()}(0.0, 0.0, 0.0, 0.0);\n                        }\n                        ${n("sign")} = 1.0;\n                        if  (val > 0.0) {\n                            sign = 0.0;\n                        }\n                        ${n("Val")} = abs(val);\n                        ${n("exponent")}  = floor(log2(Val));\n                        ${n("biased_exponent")}  = exponent + 127.0;\n                        ${n("fraction")}  = ((Val / exp2(exponent)) - 1.0) * 8388608.0;\n                        ${n("t")} = biased_exponent / 2.0;\n                        ${n("last_bit_of_biased_exponent")}  = fract(t) * 2.0;\n                        ${n("remaining_bits_of_biased_exponent")}  = floor(t);\n                        ${n("byte4")}  =  ${i.cF("extract_bits","f",[i.prmF("fraction"),i.prmF("0.0"),i.prmF("8.0")])} / 255.0;\n                        ${n("byte3")}  =  ${i.cF("extract_bits","f",[i.prmF("fraction"),i.prmF("8.0"),i.prmF("16.0")])} / 255.0;\n                        ${n("byte2")}  = (last_bit_of_biased_exponent * 128.0 +  ${i.cF("extract_bits","f",[i.prmF("fraction"),i.prmF("16.0"),i.prmF("23.0")])}) / 255.0;\n                        ${n("byte1")}  = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;\n                        return ${s()}(byte4, byte3, byte2, byte1);\n                    }\n                    `})),e.setPDSFXOverridableFunctions(n,{ProcessFinalColor:function(e,t){const i=e.variableHandler,r=e.functionHandler,n=i.dereference(t[0]);return`\n                            ${n} = ${r.cF("encode_float","v4",[r.prmF((t=>e.getVarying(t))("vZ"))])};\n                            //${n} = vec4f(0.0,0.0,1.0,1.0);\n                        `}}),e.force=!0,e},_drawDGs:function(e,i,r,n,s){this.material||(this.material=this._initBackUpMaterial()),this.material.updatePDSFXUniform("orientationMatrix",i),this.material.updatePDSFXUniform("composante",s),this.material.updatePDSFXUniform("zMin",r),this.material.updatePDSFXUniform("zMax",n),this.material.id++;var a=!0,o=new t.OrthographicCamera;o.setWebGPU(this.renderer.renderer.use_webgpu),this.renderer.renderer.clearCurrentBuffer();for(var l=0;l<e.length;l++){var h=e[l].dg,c=e[l].obj,d=e[l].geom,u=h.glType;h.glType=0,this.renderer.renderer.renderInterval(o,[],c,this.material,null,d,h,h.start,h.count,null,null,a,null,null,null,0),h.glType=u,a=!1}this.renderer.renderer.clearCurrentBuffer()},_getScene:function(e){this.scene&&this.scene.dispose(),this.scene=new t.Scene;let i=new Map;for(var r=0;r<e.length;r++){let t=e[r],n=i.get(t.geom.id);if(!n){let e=t.geom.clone(!0,!0);e.layout=t.geom.layout,n={geom:e,obj:t.obj},i.set(t.geom.id,n)}n.geom.drawingGroups.push(t.dg)}for(let[e,r]of i){let e=new t.Mesh(r.geom,this.material);e.matrix=r.obj.matrix.clone(),e.matrixRotationWorld=r.obj.matrixRotationWorld.clone(),e.matrixWorld=r.obj.matrixWorld.clone(),e._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(e.matrixWorld),e._frustumCulled=!1,e.matrixAutoUpdate=!1,this.scene.add(e)}},_renderDGs:function(e,i,r,n){this.bboxComposerContext.needsUpdate=!0,this.material.updatePDSFXUniform("orientationMatrix",e),this.material.updatePDSFXUniform("composante",n),this.material.updatePDSFXUniform("zMin",i),this.material.updatePDSFXUniform("zMax",r),this.material.id++;var s={main:new t.OrthographicCamera(-1,1,1,-1,-1,1,this.renderer.renderer.use_webgpu)},a=this.renderer.renderer.newMaterialInheritance;this.composer.updateScene(this.scene),this.renderer.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.composer.setComposerContext(this.bboxComposerContext),this.renderer.renderer.newMaterialInheritance=!1,this.composer.render(void 0,void 0,s,"main"),this.renderer.renderer.newMaterialInheritance=a},_setRendererState:function(){this.material||(this.material=this._initBackUpMaterial());var e=this.renderer.renderer.getViewport(),i=this.renderer.renderer.enablerenderPluginsPre;this.renderer.renderer.enableRenderPluginsPre=!1,this.renderer.renderer.materialToUse=0;var r=this.renderer.renderer.getClearColor(),n=this.renderer.renderer.getClearAlpha();this.renderer.renderer.setBlending(t.NoBlending),this.renderer.renderer.setDepthTest(!0);var s=this.renderer.renderer.getDepthFunc();return this.renderer.renderer.RTTmatchViewport=!0,{viewport:e,enablerenderpluginsPre:i,depthTest:this.renderer.renderer._oldDepthTest,depthFunc:s,clearColor:r,clearAlpha:n}},_resetRendererState:function(e){this.renderer.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height),this.renderer.renderer.setDepthTest(e.depthTest),this.renderer.renderer.setDepthFunc(e.depthFunc),this.renderer.renderer.enableRenderPluginsPre=e.enablerenderpluginsPre,this.renderer.renderer.RTTmatchViewport=!1,this.renderer.renderer.setClearColor(e.clearColor,e.clearAlpha),this.renderer.renderer.setClearDepth(1)},computeZMinGPU:function(e,i){let r=null;var n=this._setRendererState(),s=e.getSceneBoundingSphere();if(s.pixelRadius>0){var a=e.currentViewpoint.camera.getWorldSizeFromPixelSize(1,s.center,e._getDivClientHeight(),2);s.radius+=a*s.pixelRadius}this.renderer.renderer.setDepthFunc(this.renderer.renderer.depthFuncs.LESS);var o=s.center.z;let l=[],h=t.GeomTypeEnum.FREE_POINT;for(var c=0;c<i.length;c++)for(var d=i[c],u=0;u<d.geometry.length;u++){var p=d.geometry[u];let e=p.getVertexCount()||p.vertexCountGPU;this.renderer.renderer.use_webgpu&&(e=p.indexCountGPU);var f={glType:0,start:0,count:e,_geomType:h,nonIndexed:!0};l.push({dg:f,geom:p,obj:d})}this._getScene(l),this.renderer.renderer.setViewport(0,0,1,this._pixels);let g=new t.Vector3(0,0,1);return this._renderDGs(new t.Matrix4,o-s.radius,o+s.radius,g),r=this._readRenderTarget().min.z,this._resetRendererState(n),r},computeBoundingBoxGPU:function(e,i,r){r||(r=new t.Matrix4);var n=(new t.Matrix4).getInverse(r);let s=null;var a=this._setRendererState(),o=e.getSceneBoundingSphere();if(o.center.applyMatrix4(n),o.pixelRadius>0){var l=e.currentViewpoint.camera.getWorldSizeFromPixelSize(1,o.center,e._getDivClientHeight(),2);o.radius+=l*o.pixelRadius}this.renderer.renderer.setDepthFunc(this.renderer.renderer.depthFuncs.LEQUAL);let h=[],c=t.GeomTypeEnum.FREE_POINT;for(var d=0;d<i.length;d++)for(var u=i[d],p=0;p<u.obj.length;p++){var f=u.obj[p],g={glType:0,start:f.start,count:f.count,_geomType:c};h.push({dg:g,geom:f.geometry,obj:u.renderable})}this._getScene(h);let m=this.renderer.renderer;for(d=0;d<6;d++){this.clearPass.clearbColor=!1,this.renderer.renderer.setViewport(d,0,1,this._pixels);var v=new t.Vector3(0,0,1),_=o.center.z;if(1==d)v.set(1,0,0),_=o.center.x;else if(2==d)v.set(0,1,0),_=o.center.y;else if(3==d){(function(){m.setDepthFunc(m.depthFuncs.GEQUAL),m.setClearDepth(m.use_webgpu?0:-1)})()}else 4==d?(m.setClearDepth(m.use_webgpu?0:-1),v.set(1,0,0),_=o.center.x):5==d?(m.setClearDepth(m.use_webgpu?0:-1),v.set(0,1,0),_=o.center.y):this.clearPass.clearbColor=!0;this._renderDGs(n,_-o.radius,_+o.radius,v)}return s=this._readRenderTarget(),this._resetRendererState(a),s},_readRenderTarget:function(){var e=new Uint8Array(24*this._pixels);this.renderer.renderer.readPixelCustom(0,0,6,this._pixels,t.RGBAFormat,t.UnsignedByteType,e);for(var i=new Float32Array(e.buffer),r=i[0],n=i[1],s=i[2],a=i[3],o=i[4],l=i[5],h=1;h<this._pixels;h++)r=Math.min(r,i[6*h]),n=Math.min(n,i[6*h+1]),s=Math.min(s,i[6*h+2]),a=Math.max(a,i[6*h+3]),o=Math.max(o,i[6*h+4]),l=Math.max(l,i[6*h+5]);return new t.Box3(new t.Vector3(n,s,r),new t.Vector3(o,l,a))},_computeRangesBBWebGPU:function(e){}});return UWA.namespace("THREEDS/BoundingBoxGPUCompute",o)})),define("DS/Visualization/WebGLV6Renderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass_New","DS/Plugins/OcclusionPass","DS/ShaderBuilders/PostPro/MirrorShaderBuilders","DS/ShaderBuilders/PostPro/BlurShaderBuilders","DS/Effects/FXAAEffect","DS/Effects/MSAAEffect","DS/Effects/TAAEffect","DS/Effects/SMAAEffect","DS/Effects/HighlightEffect","DS/Effects/HighlightMobileEffect","DS/Effects/SSAOEffect","DS/Effects/SSAOIterativeEffect","DS/Effects/FakeOutlinesEffect","DS/Effects/NoPowerOfTwoEffect","DS/Effects/SSLReflectionEffect","DS/Effects/SSLRefractionEffect","DS/Effects/BokehDOFEffect","DS/Effects/ComputeSkyScattering","DS/Effects/BloomsEffect","DS/Effects/ToneMappingEffect","DS/Effects/FlareEffect","DS/Effects/VolumeRenderingEffect","DS/Effects/PointCloudEffect","DS/Effects/DebugPassEffect","DS/Effects/DebugShadowMapsEffect","DS/Effects/PreHighlightEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Plugins/NothingPass","DS/Visualization/RenderTargetPool","DS/Plugins/PluginPass","DS/CoreEvents/Events","DS/Effects/OITEffect","DS/Effects/OITLinkedListEffect","DS/Plugins/CSSNodesPass","DS/Visualization/BoundingBoxGPUCompute","DS/Visualization/RenderMode","DS/Usage/TrackerAPI","DS/Effects/XRevealStructureEffect","DS/Effects/HighlightMobileNonEffect","DS/Effects/PreHighlightMobileNonEffect","DS/Effects/NativeOnTopEffect","DS/Effects/GaussianSplatEffect","DS/Effects/AutoPerformanceSuiteEffect","DS/Visualization/WebGLRenderer","DS/Visualization/WebGPURenderer","DS/QualityManager/QMScoreHandler","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Materials/Material"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O,L,B,F,V,G,N,U,k,z,H,W,j,X,q,Z,Y,K,$,Q,J){"use strict";var ee=0,te=new Set;te.add("compareModelPass"),te.add("oitPass"),te.add("oitnoZPass"),te.add("remoteImage_0"),te.add("remoteImage_1"),te.add("remoteImage_2"),te.add("TexturePerformance"),te.add("PixelShaderPerformance");var ie=new Set;ie.add("OIT"),ie.add("OITnoZ"),ie.add("xRevealStructure"),ie.add("NativeOnTop"),ie.add("GaussianSplat"),ie.add("SSAO"),te.add("SSAOEffect"),te.add("SSAOEffectBlurH"),te.add("SSAOEffectBlurV"),te.add("GroundShadowEffect"),te.add("GroundShadowEffectBlurH"),te.add("GroundShadowEffectBlurV"),te.add("mirrorBlendPass"),ie.add("TexturePerformance"),ie.add("PixelShaderPerformance");var re=new Set;let ne,se;function ae(e,t){e.zPostPass.addDLsToDisableFunc(t),e.forwardPass.addDLsToDisableFunc(t),e.ZOnlyPass.addDLsToDisableFunc(t),e.backgroundPass.addDLsToDisableFunc(t)}function oe(e,t){e.zPostPass.removeDLsToDisableFunc(t),e.forwardPass.removeDLsToDisableFunc(t),e.ZOnlyPass.removeDLsToDisableFunc(t),e.backgroundPass.removeDLsToDisableFunc(t)}re.add("OIT"),re.add("OITnoZ"),re.add("OITLinkedList"),re.add("OITnoZLinkedList"),re.add("xRevealStructure"),re.add("Highlight"),re.add("Canvas2DHighlight"),re.add("PreHighlight"),re.add("Canvas2DPreHighlight"),re.add("SSAO"),re.add("SSLRDirect"),re.add("SSLReflection"),re.add("SSLRefraction"),re.add("NativeOnTop"),re.add("TexturePerformance"),re.add("PixelShaderPerformance"),re.add("GaussianSplat");var le=e.extend({init:function(e){if(this.ODTMode=e.viewer.ODTMode,this.useCompositing=void 0===e.useCompositing||e.useCompositing,this.NoOperator=0,this.SimpleOperator=1,this.LinearOperator=2,this.ReinhardOperator=3,this.FilmicOperator=4,this.UnchartedOperator=5,this.needClippingUpdate=!1,void 0===e.canvas)return;this.canvas=e.canvas,this.divCSS=e.divCSS,this.useOffscreenCanvas=e.useOffscreenCanvas,this.antiAliasing=void 0!==e.antiAliasing?e.antiAliasing:"NoAA",this.webgpu=!!e.webgpu,this.useOffscreenCanvas?(this.cssWidth=Math.max(2,e.canvas.width),this.cssHeight=Math.max(2,e.canvas.height)):(this.cssWidth=Math.max(2,e.canvas.offsetWidth),this.cssHeight=Math.max(2,e.canvas.offsetHeight)),this.devicePixelRatio=t.getDevicePixelRatio()||1,this.deviceWidth=Math.floor(this.devicePixelRatio*this.cssWidth),this.deviceHeight=Math.floor(this.devicePixelRatio*this.cssHeight),this.viewportWidth=this.deviceWidth,this.viewportHeight=this.deviceHeight,this.brightness=void 0!==e.brightness?e.brightness:0,this.tonemapping=void 0!==e.tonemapping?e.tonemapping:1,this.disableBackFaceCulling=!1,this.visibleSpace=void 0!==e.visibleSpace?e.visibleSpace:1,this.compareSettings=e.compareSettings,this.mobile=t.mobileVersion,this._postProHighlight=!e.viewer._viewerEffectSettings._lqFallback&&(!this.mobile||!!e.forcePostProHighlight),this._postProHighlight?(ie.add("Highlight"),te.add("HighlightEffect"),ie.add("Canvas2DHighlight"),te.add("Canvas2DHighlightEffect"),ie.add("PreHighlight"),te.add("PreHighlightEffect"),ie.add("Canvas2DPreHighlight"),te.add("Canvas2DPreHighlightEffect"),t._mobileHighlight=!1):(re.delete("Highlight"),re.delete("Canvas2DHighlight"),re.delete("PreHighlight"),re.delete("Canvas2DPreHighlight"),re.add("HighlightMobile"),re.add("PreHighlightMobile"),ie.add("HighlightMobile"),ie.add("PreHighlightMobile")),this.useAuxiliaryAsForward=!1,this.multiView=!1,this.multiViewpoint=!1;let r=this.webgpu?Y:Z;if(this.renderer=new r({context:e.context,gpuStates:e.gpuStates,ODTMode:this.ODTMode,debugWebgl2:e.debugWebgl2||!1,alpha:!0,premultipliedAlpha:!1,antialias:this.webgpu?this.antiAliasing:!0===this.antiAliasing,canvas:this.canvas,divCSS:this.divCSS,visibleSpace:this.visibleSpace,preserveDrawingBuffer:e.preserveDrawingBuffer,debugContext:e.debugContext,sortRenderListByBuffer:!0,useCompositing:this.useCompositing,timestampQuery:e.timestampQuery}),this.renderer._v6renderer=this,this._needsPerformanceCheck=!1,!e.viewer.ODTMode){var n=this.renderer.getRendererInfo();t.IsFirefox&&(n.gpu="Unknown Firefox");var s=n.gpu;"true"!==localStorage.getItem("WebVisu_Renderer_Info")&&k&&(k.trackPageEvent({eventCategory:"WebVisualization",eventAction:"WebGL-GPU",eventLabel:s,appID:"WEBVISUALIZATION_FW",persDim:{pd1:e.viewer.getWidgetID()}}),localStorage.setItem("WebVisu_Renderer_Info",!0))}this.bgColor=void 0!==e.bgColor?e.bgColor:0,this.bgAlpha=void 0!==e.bgAlpha?e.bgAlpha:1,this.setBackgroundColor(this.bgColor,this.bgAlpha),this.renderTargetPool=O.get(this.renderer),this.renderer.renderTargetPool=this.renderTargetPool,this.useOffscreenCanvas?this.renderer.setGLSize(Math.max(2,this.canvas.width),Math.max(2,this.canvas.height),this.viewportWidth,this.viewportHeight,Math.max(2,this.canvas.width),Math.max(2,this.canvas.height)):this.renderer.setGLSize(this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight),this.renderer.setClearColor(new t.Color(0),0),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!this.useCompositing,this.renderer.autoClear=!1,this.renderer.shadowMapCascade=!1,this.renderer.packESM=!0,this.renderer._gpuPickingTolerance=2,this.renderer._smallTargetPicking=this.mobile,this.renderer._heuristicNormalRadius=15,this.gl=this.renderer.context,this.compPickingGPU=null,this.compDepth=null,this.compNormal=null,this.compNormalDepth=null,this.compMirror=null,this.compForward=null,this.composers=[],this.passPickingGPU=null,this.passDepth=null,this.passNormal=null,this.passColor=null,this.passNormalDepth=null,this.passMirrorBlur=null,this.passMirrorBlur1=null,this.passMirrorBlur2=null,this.passMirrorBlur3=null,this.clearScreenSpacePass=null,this.infPlanePass=null,this.mirrorBlendPass=null,this.zPostPass=null,this.forwardPass=null,this.occlusionPass=null,this.ZOnlyPass=null,this.backgroundPass=null,this.passLightFullscreen=null,this.passLightProxy=null,this.XRevealStructureEffect=null,this.OITEffect=null,this.OITnoZEffect=null,this.OITLinkedListEffect=null,this.OITnoZLinkedListEffect=null,this.PreHighlightEffect=null,this._PreHighlightMobileNonEffect=null,this.Canvas2DPreHighlightEffect=null,this.BokehDOFEffect=null,this.SkyScatteringEffect=null,this.BloomEffect=null,this.ToneMappingEffect=null,this.FlareEffect=null,this.HighlightEffect=null,this._HighlightMobileNonEffect=null,this.Canvas2DHighlightEffect=null,this.auxiliaryHighlights=[],this.SSAOEffect=null,this.SSAOIterativeEffect=null,this.FakeOutlinesEffect=null,this.SSLReflectionEffect=null,this.SSLRefractionEffect=null,this.FXAAEffect=null,this.TexturePerformanceEffect=null,this.PixelShaderPerformanceEffect=null,this.SMAAEffect=null,this.MSAAEffect=null,this.TAAEffect=null,this.VolumeRenderingEffect=null,this.PointCloudEffect=null,this.NoPowerOfTwoEffect=null,this.NativeOnTopEffect=null,this.GaussianSplatEffect=null,this.DebugPassEffect=null,this.DebugShadowMapsEffect=null,this.customEffects=[],this.allEffects=[],this.effectStatusMap=new Map,this.renderer.sectionCappingEnabled=!1,this.meshesGPU={},this.positionsGPU={},this.normalsGPU={},this.positionsFloatGPU={},this.heuristicNormalsGPU={},this.currentGPUPickPosition={x:-1,y:-1};var a=t.FloatType,o=t.LinearFilter;this.renderer.supportsFloatTextures()||(a=t.UnsignedByteType),this.renderer.supportsFloatLinearTextures()||(o=t.NearestFilter),this.rtParamsFloatLinear={minFilter:o,magFilter:o,stencilBuffer:!0,format:t.RGBAFormat,type:a},this.rtParamsFloatNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},this.rtParamsFloatNearestStencilBuffer={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:a},this.rtParamsUByteNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByteWithStencilBuffer={minFilter:t.NearestFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByte2={minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.boundingBoxGPUCompute=new N(this);this.mainComposer=new i(this.renderer,void 0,this.renderTargetPool,["--\x3e(initClear)","initClearPass","compositePrePass","--\x3einfPlane","infPlanePass","mirrorClearDepth","mirrorBlendPass","afterMirrorClearDepth","--\x3emain","backgroundPassCapping","backgroundPass","remoteImage_0","renderPriorityClear","renderPriorityStencilP4","renderPriorityStencilP3","renderPriorityStencilP2","renderPriorityStencilP1","renderPriorityStencilP0","renderPriorityDrawP3","renderPriorityDrawP2","renderPriorityDrawP1","renderPriorityDrawP0","passSectionCappingFrontFaces","cssPass","forwardPass","occlusionPass","zPostPass","pointCloudPass","fakeOutlinesPass","transparForwardPass","oitPass","postTransparForwardPass","ZOnlyPassCapping","ZOnlyPass","GaussianSplatPass","--\x3edialog","dialogPass","fallBackOnTopPass","--\x3e(postEffects1)","passMirrorBlur","passMirrorBlur1","passMirrorBlur2","passMirrorBlur3","clearScreenSpacePass","compareModelPass","skyScatteringPass","BokehDOFEffect","--\x3enoz","nozClearPass","nozPass","oitnoZPass","--\x3e(postEffects2)","bloomPass","compositePass","compositePostPass","VolumeRenderingEffect","FlareEffect","MSAAEffect","TAAEffect","--\x3enoEffectNoz","noEffectNozClearPass","noEffectNozPass","remoteImage_1","--\x3e(highlight)","HighlightEffect","AuxiliaryHighlightEffect","PreHighlightEffect","AuxiliaryPreHighlightEffect","highlightClearPass","highlightSinglePass","preHighlightSinglePass","DebugPassEffect","DebugShadowMapsEffect","--\x3eafterHighlightNoz","noEffectAfterHighlightNozClearPass","noEffectAfterHighlightNozPass","remoteImage_2","--\x3eonTop","onTopDepthClearPass","onTopDepthSetPass","onTopPass","--\x3efurtive","furtiveClearPass","furtivePass","--\x3erobot","noEffectRobotClearPass","noEffectRobotPass","noEffectRobotOrthoPass","--\x3e(postEffects3)","FXAAEffect","SMAAEffect","--\x3ecanvas2D","noEffectCanvas2DClearPass","noEffectCanvas2DPass","Canvas2DHighlightEffect","AuxiliaryCanvas2DHighlightEffect","Canvas2DPreHighlightEffect","AuxiliaryCanvas2DPreHighlightEffect","Canvas2DhighlightClearPass","Canvas2DhighlightSinglePass","Canvas2DpreHighlightSinglePass","--\x3e(Graphics Optimizer)","TexturePerformance","PixelShaderPerformance"],{initClearPass:!0,compositePrePass:!0,infPlanePass:!0,mirrorClearDepth:!0,mirrorBlendPass:!0,afterMirrorClearDepth:!0,backgroundPassCapping:!0,backgroundPass:!0,remoteImage_0:!0,renderPriorityClear:!0,renderPriorityStencilP4:!0,renderPriorityStencilP3:!0,renderPriorityStencilP2:!0,renderPriorityStencilP1:!0,renderPriorityStencilP0:!0,renderPriorityDrawP3:!0,renderPriorityDrawP2:!0,renderPriorityDrawP1:!0,renderPriorityDrawP0:!0,passSectionCappingFrontFaces:!0,cssPass:!0,forwardPass:!0,occlusionPass:!0,zPostPass:!0,transparForwardPass:!0,postTransparForwardPass:!0,ZOnlyPassCapping:!0,ZOnlyPass:!0,oitPass:!0}),this.initForwardRender(),this.highlightPass=null,this.shadowComposerContext=null,this.pickingGPUComposerContext=null,this.pickingGPUInstancingComposerContext=null,this.normalComposerContext=null,this.depthComposerContext=null,this.normalDepthIoRRoughnessComposerContext=null,this.normalDepthComposerContext=null,this.outlineDepthComposerContext=null,this.mirrorOutlineDepthComposerContext=null,this.highlightDepthComposerContext=null,this.opaqueOnlyComposerContext=null,this.colorComposerContext=null,this.occlusionDepthComposerContext=null,this.clippingScene=null,this.clipPlaneInfos=null,this.superFinalComposer=null,this.customComposerContexts=null,this.resultIdChange=""},_updateEffectScenes:function(e){this.OITEffect&&(this.OITEffect.revealPass.setScene(e),this.OITEffect.accumPass.setScene(e)),this.OITnoZEffect&&(this.OITnoZEffect.revealPass.setScene(e),this.OITnoZEffect.accumPass.setScene(e)),this.GaussianSplatEffect&&this.GaussianSplatEffect.renderPass.setScene(e)},initEffect:function(e){if(this.mobile&&!ie.has(e))return null;if(!this.useCompositing&&!re.has(e))return null;var i=null;switch(e){case"xRevealStructure":this.XRevealStructureEffect=new z(this.renderer,this.renderTargetPool),i=this.XRevealStructureEffect;break;case"noPowerOfTwoEffect":this.NoPowerOfTwoEffect=new v(this.renderer,this.renderTargetPool),i=this.NoPowerOfTwoEffect;break;case"OIT":this.OITEffect=new F(this.renderer,this.renderTargetPool,this.forwardPass,"oitPass"),i=this.OITEffect;break;case"OITnoZ":this.OITnoZEffect=new F(this.renderer,this.renderTargetPool,this.nozPass,"oitnoZPass"),(i=this.OITnoZEffect).idString="noz";break;case"OITLinkedList":this.OITLinkedListEffect=new V(this.renderer,this.renderTargetPool,this.forwardPass,"oitPass"),i=this.OITLinkedListEffect;break;case"OITnoZLinkedList":this.OITnoZLinkedListEffect=new V(this.renderer,this.renderTargetPool,this.nozPass,"oitnoZPass"),i=this.OITnoZLinkedListEffect;break;case"FXAA":this.FXAAEffect=new l(this.renderer,this.renderTargetPool),i=this.FXAAEffect;break;case"TexturePerformance":this.TexturePerformanceEffect=new q(this.renderer,this.renderTargetPool,q.MODE.TEXTURE),i=this.TexturePerformanceEffect;break;case"PixelShaderPerformance":this.PixelShaderPerformanceEffect=new q(this.renderer,this.renderTargetPool,q.MODE.PIXEL),i=this.PixelShaderPerformanceEffect;break;case"MSAA":this.MSAAEffect=new h(this.renderer,this.renderTargetPool),i=this.MSAAEffect;break;case"TAA":this.TAAEffect=new c(this.renderer,this.renderTargetPool),i=this.TAAEffect;break;case"SMAA":case"MLAA":this.SMAAEffect=new d(this.renderer,this.renderTargetPool),i=this.SMAAEffect;break;case"Highlight":this.HighlightEffect=t.__unrolledHighlight()?new p(this.renderer,this.renderTargetPool,null,""):new u(this.renderer,this.renderTargetPool,null,""),i=this.HighlightEffect;break;case"HighlightMobile":this._HighlightMobileNonEffect=new H(this),i=this._HighlightMobileNonEffect;break;case"PreHighlight":this.PreHighlightEffect=new A(this.renderer,this.renderTargetPool,null,""),i=this.PreHighlightEffect;break;case"PreHighlightMobile":this._PreHighlightMobileNonEffect=new W(this),i=this._PreHighlightMobileNonEffect;break;case"Canvas2DHighlight":this.Canvas2DHighlightEffect=t.__unrolledHighlight()?new p(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"):new u(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":this.Canvas2DPreHighlightEffect=new A(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DPreHighlightEffect;break;case"SSAO":this.SSAOEffect=new f(this.renderer,this.renderTargetPool),i=this.SSAOEffect;break;case"SSAOIterative":this.SSAOIterativeEffect=new g(this.renderer,this.renderTargetPool),i=this.SSAOIterativeEffect;break;case"FakeOutlines":this.FakeOutlinesEffect=new m(this.renderer,this.renderTargetPool),i=this.FakeOutlinesEffect;break;case"SSLRDirect":case"SSLReflection":this.SSLReflectionEffect=new _(this.renderer,this.renderTargetPool),i=this.SSLReflectionEffect;break;case"SSLRefraction":this.SSLRefractionEffect=new y(this.renderer,this.renderTargetPool),i=this.SSLRefractionEffect;break;case"VolumeRendering":this.VolumeRenderingEffect=new C(this.renderer,this.renderTargetPool,this.ODTMode),i=this.VolumeRenderingEffect;break;case"PointCloud":this.PointCloudEffect=new M(this.renderer,this.renderTargetPool,this.ODTMode),i=this.PointCloudEffect;break;case"DOF":this.BokehDOFEffect=new S(this.renderer,this.renderTargetPool),i=this.BokehDOFEffect;break;case"Bloom":this.BloomEffect=new x(this.renderer,this.renderTargetPool,!1),i=this.BloomEffect;break;case"SkyScattering":this.SkyScatteringEffect=new b(this.renderer,this.renderTargetPool),i=this.SkyScatteringEffect;break;case"ToneMapping":this.ToneMappingEffect=new w(this.renderer,this.renderTargetPool),i=this.ToneMappingEffect;break;case"Flare":this.FlareEffect=new P(this.renderer,this.renderTargetPool),i=this.FlareEffect;break;case"DebugPass":this.DebugPassEffect=new E(this.renderer,this.renderTargetPool),i=this.DebugPassEffect;break;case"DebugShadowMaps":this.DebugShadowMapsEffect=new T(this.renderer,this.renderTargetPool),i=this.DebugShadowMapsEffect;break;case"NativeOnTop":this.NativeOnTopEffect=new j(this.renderer,this.renderTargetPool),i=this.NativeOnTopEffect;break;case"GaussianSplat":this.GaussianSplatEffect=new X(this.renderer,this.renderTargetPool),i=this.GaussianSplatEffect}return null!==i&&(i.updateComposersName(e),i.setSize(this.viewportWidth,this.viewportHeight),i.initEffect(!this.useCompositing,this),this.allEffects.push(i)),i},setEffect:function(e,i){var r=null,n=!1;if((!this.mobile||ie.has(e))&&(this.useCompositing||re.has(e))){switch(this.effectStatusMap.set(e,i),e){case"xRevealStructure":r=this.XRevealStructureEffect;break;case"OIT":r=this.OITEffect,n=!this.isDeviceCompatibleWithOIT();var s=i&&!n;this.zPostPass.isOITPass=s,this.forwardPass.isOITPass=s,this.forwardPass._onSubPass((e=>{e.isOITPass=s})),this.renderer.oitMode=s?t.OITMode.WeightedAverage:t.OITMode.None;break;case"OITnoZ":r=this.OITnoZEffect,n=!this.isDeviceCompatibleWithOIT();s=i&&!n;this.nozPass.isOITPass=s,this.renderer.oitMode=s?t.OITMode.WeightedAverage:t.OITMode.None;break;case"OITLinkedList":r=this.OITLinkedListEffect,n=!this.isDeviceCompatibleWithOIT();s=i&&!n;this.forwardPass.isOITPass=s,this.forwardPass._onSubPass((e=>{e.isOITPass=s})),this.renderer.oitMode=s?t.OITMode.PerPixelLinkedList:t.OITMode.None;break;case"OITnoZLinkedList":r=this.OITnoZLinkedListEffect,n=!this.isDeviceCompatibleWithOIT();s=i&&!n;this.nozPass.isOITPass=s,this.renderer.oitMode=s?t.OITMode.PerPixelLinkedList:t.OITMode.None;break;case"FXAA":r=this.FXAAEffect,this.antiAliasing=i?e:"NoAA";break;case"TexturePerformance":r=this.TexturePerformanceEffect,i&&r&&r.resetScore();break;case"PixelShaderPerformance":r=this.PixelShaderPerformanceEffect,i&&r&&r.resetScore();break;case"MSAA":r=this.MSAAEffect,this.antiAliasing=i?e:"NoAA";break;case"TAA":r=this.TAAEffect,this.antiAliasing=i?e:"NoAA";break;case"SMAA":case"MLAA":r=this.SMAAEffect,this.antiAliasing=i?e:"NoAA";break;case"FSAA":case"SSAA":this.antiAliasing=i?e:"NoAA";break;case"Vignetting":case"ToneMapping":r=this.ToneMappingEffect;break;case"Highlight":r=this.HighlightEffect;break;case"HighlightMobile":r=this._HighlightMobileNonEffect;break;case"PreHighlight":r=this.PreHighlightEffect;break;case"PreHighlightMobile":r=this._PreHighlightMobileNonEffect;break;case"Canvas2DHighlight":r=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":r=this.Canvas2DPreHighlightEffect;break;case"SSAO":r=this.SSAOEffect,n=!this.isDeviceCompatibleWithSSAO(),this.renderer.useSSAO=i&&!n;break;case"SSAOIterative":r=this.SSAOIterativeEffect,n=!this.isDeviceCompatibleWithSSAO(),this.renderer.useSSAOIterative=i&&!n;break;case"FakeOutlines":r=this.FakeOutlinesEffect;break;case"SSLRDirect":case"SSLReflection":r=this.SSLReflectionEffect,n=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLR=i&&!n;break;case"SSLRefraction":r=this.SSLRefractionEffect,n=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLRefraction=i&&!n;break;case"VolumeRendering":r=this.VolumeRenderingEffect;break;case"PointCloud":r=this.PointCloudEffect;break;case"DOF":r=this.BokehDOFEffect;break;case"Bloom":r=this.BloomEffect;break;case"SkyScattering":r=this.SkyScatteringEffect;break;case"Flare":r=this.FlareEffect;break;case"DebugPass":r=this.DebugPassEffect;break;case"DebugShadowMaps":r=this.DebugShadowMapsEffect;break;case"NativeOnTop":r=this.NativeOnTopEffect;break;case"GaussianSplat":r=this.GaussianSplatEffect}if(i&&!n&&(r||(r=this.initEffect(e))),null!==r){var a=i&&!n;"Vignetting"===e?r.setVignettingPower(a?10:0):r.setEnabled(a),!this.compMirrorComposerContext||"OIT"!==e&&"OITLinkedList"!==e||this.compMirrorComposerContext.enablePass(r.mixPass,a),"GaussianSplat"===e&&this.compForwardComposerContext.enablePass(r.renderPass,!0)}this.setScale(!1),this.updateFinalComposer(!0)}},getCustomEffect:function(e){return this.customEffects[e]},addCustomEffect:function(e){if(!e)return-1;var t=this.customEffects.length;return this.customEffects.push(e),e.updateComposersName("customEffect_"+this.customEffects.length),e.setSize(this.viewportWidth,this.viewportHeight),e.initEffect(!this.useCompositing,this),t},setCustomEffect:function(e,t){var i=this.customEffects[e];null!==i&&(i.setEnabled(t),t&&i.setSize(this.viewportWidth,this.viewportHeight)),this.updateFinalComposer(!0)},updateEffects:function(e,t,i,r){this.XRevealStructureEffect&&this.XRevealStructureEffect.enabled&&this.XRevealStructureEffect.update("deferred",e,t),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.update("deferred",e,t,i),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.update("deferred",e,t,i),this.FakeOutlinesEffect&&this.FakeOutlinesEffect.enabled&&this.FakeOutlinesEffect.update("deferred",e,t,i),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.update("deferred",e,t,i),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.update("deferred",e,t,i),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.update("deferred",e,t,i),this.PointCloudEffect&&this.PointCloudEffect.enabled&&this.PointCloudEffect.update("deferred",e,t,i),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.update("forward",e,t,i,r);for(let n=0;n<this.auxiliaryHighlights.length;n++)this.auxiliaryHighlights[n].enabled&&this.auxiliaryHighlights[n].update("forward",e,t,i,r);this._HighlightMobileNonEffect&&this._HighlightMobileNonEffect.enabled&&this._HighlightMobileNonEffect.update(e),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.update("forward",e,t,i,r),this._PreHighlightMobileNonEffect&&this._PreHighlightMobileNonEffect.enabled&&this._PreHighlightMobileNonEffect.update(e),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.update("forward",e,t,i,r),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.update("forward",e,t,i,r),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.update("deferred",e,t),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.update("forward",e,t),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.update("forward",e,t,i),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.update("forward",e,t,i),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.update("deferred",e,t),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.update("deferred",e,t),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.update("deferred",e,t),this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.update("forward",e,t),this.GaussianSplatEffect&&this.GaussianSplatEffect.enabled&&this.GaussianSplatEffect.update("forward",e,t);for(var n=0;n<this.customEffects.length;n++){var s=this.customEffects[n];s&&s.enabled&&s.update("forward",e,t,i)}},getMaxIterationEffects:function(){var e=0;return this.SSAOEffect&&this.SSAOEffect.enabled&&(e=Math.max(e,this.SSAOEffect.getMaxIteration())),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(e=Math.max(e,this.SSAOIterativeEffect.getMaxIteration())),this.FakeOutlinesEffect&&this.FakeOutlinesEffect.enabled&&(e=Math.max(e,this.FakeOutlinesEffect.getMaxIteration())),this.MSAAEffect&&this.MSAAEffect.enabled&&(e=Math.max(e,this.MSAAEffect.getMaxIteration())),this.TAAEffect&&this.TAAEffect.enabled&&(e=Math.max(e,this.TAAEffect.getMaxIteration())),this.renderer.occlusionCullingEnabled&&(e=Math.max(e,this.renderer.kNumOcclusionContexts)),e},setRendererSize:function(e,t,i,r,n,s,a,o){if(this.cssWidth!==e||this.cssHeight!==t||this.devicePixelRatio!==s||i){this.devicePixelRatio=s,this.cssWidth=Math.max(2,e),this.cssHeight=Math.max(2,t),this.deviceWidth=Math.floor(s*this.cssWidth),this.deviceHeight=Math.floor(s*this.cssHeight),this.viewportWidth=Math.floor(s*Math.max(2,r)),this.viewportHeight=Math.floor(s*Math.max(2,n));var l=this.cssWidth,h=this.cssHeight;void 0!==a&&(l=Math.max(2,a)),void 0!==o&&(h=Math.max(2,o)),this.renderer.setGLSize(this.cssWidth,this.cssHeight,r,n,l,h),this.setScale(!0)}},setBackgroundColor:function(e,i){this.bgColor=e,this.bgAlpha=i;var r=new t.Color(this.bgColor);this.renderer._backgroundColor=r,this.useCompositing&&r.copyToLinear(r,this.renderer.simpleGamma),this.bgColor=r.getHex()},resetGSSOCache:function(){this.renderer.resetGSSOCache()},_createVirtualLight:function(e,i){var r=new t.DirectionalLight;return r.originalLight=e,r.target=e.target,r.isVirtual=!0,r.LiSPSM=e.LiSPSM,r.onlyShadow=!0,r.castShadow=!0,r.shadowCameraNear=e.shadowCameraNear,r.shadowCameraFar=e.shadowCameraFar,r.shadowCameraLeft=e.shadowCameraLeft,r.shadowCameraRight=e.shadowCameraRight,r.shadowCameraBottom=e.shadowCameraBottom,r.shadowCameraTop=e.shadowCameraTop,r.shadowCameraVisible=e.shadowCameraVisible,r.shadowDarkness=e.shadowDarkness,r.shadowBias=e.shadowCascadeBias[i],r.shadowMapWidth=e.shadowCascadeWidth[i],r.shadowMapHeight=e.shadowCascadeHeight[i],r},_updateVirtualLight:function(e,t){var i=e.shadowCascadeArray[t];i.virtualLightIndex=t,i.position.copy(e.position),e.target?(i.target.position=e.target.position,i.lookAt(i.target.position)):i.rotation.setEulerFromRotationMatrix(e.matrixWorld,i.eulerOrder),i.shadowCameraVisible=e.shadowCameraVisible,i.shadowDarkness=e.shadowDarkness,i.shadowBias=e.shadowCascadeBias[t]},_computeNearFarFromConvexHull:function(e,i){for(var r=i.getPoints(),n=(r.length,1/0),s=-1/0,a=new t.Vector4,o=0;o<r.length;o++)a.copy(r[o]),a.applyMatrix4(e.matrixWorldInverse),-a.z<n&&(n=-a.z),-a.z>s&&(s=-a.z);return{near:n=Math.max(e.near,n),far:s}},_clipConvexHullFromNearFar:function(e,i,r,n,s){i.matrixWorld.elements;var a=e.matrixWorld.elements,o=new t.Vector3(a[8],a[9],a[10]),l=new t.Vector3(-a[8],-a[9],-a[10]),h=(new t.Vector3).copy(o).multiplyScalar(n).add(e.position),c=(new t.Vector3).copy(o).multiplyScalar(s).add(e.position),d=new t.Plane(o,-o.dot(h)),u=new t.Plane(l,-l.dot(c));return r.clipByPlanes([d,u])},_extrudeConvexHullAlongLightDir:function(e,i,r,n){var s=r.getPoints(),a=s.length,o=new t.CGPoly;o.setFromBox(i),o.applyMatrix4(n.matrixWorldInverse);for(var l=[],h=0;h<a;h++){var c=s[h].clone();c.applyMatrix4(n.matrixWorldInverse),l.push(c)}var d=(new t.Box3).setFromPoints(l).getPlanes();return o.clipByPlanes([d[0],d[1],d[2],d[3],d[4]])},_updateShadowCamera:function(e,i,r,n,s,a,o){var l=e.matrixWorld.elements,h=new t.Vector3(l[8],l[9],l[10]),c=i._getLightDirection(this.renderer.baseLightDirection);c.negate();var d=r.getPoints(),u=d.length,p=(new t.Box3).setFromPoints(d);if(i.LiSPSM){for(var f=Math.min(.999999,Math.abs(h.dot(c))),g=Math.sqrt(1-f*f),m=(n+Math.sqrt(n*s))/g,v=m+(w=Math.abs(p.max.y-p.min.y)),_=new t.Vector3(0,p.min.y-m,.5*(p.min.z+p.max.z)),y=0;y<u;y++){(M=d[y]).sub(_)}var S,b,x,w,P=0,C=0;for(y=0;y<u;y++){var M=d[y],E=Math.abs(m*M.x/M.y);(!P||E>P)&&(P=E);var T=Math.abs(m*M.z/M.y);(!C||T>C)&&(C=T)}_.applyMatrix4(o.matrixWorld),o.position.copy(_),o.matrix.elements[12]=o.position.x,o.matrix.elements[13]=o.position.y,o.matrix.elements[14]=o.position.z,o.matrixWorld.elements[12]=o.position.x,o.matrixWorld.elements[13]=o.position.y,o.matrixWorld.elements[14]=o.position.z,o.matrixWorldInverse.getInverse(o.matrixWorld),o.webgpu?(S=m/(v-m),b=-v*m/(v-m),x=m/P,w=-m/C):(S=(v+m)/(v-m),b=-2*v*m/(v-m),x=m/P,w=-m/C),o.projectionMatrix.set(x,0,0,0,0,S,0,b,0,0,w,0,0,1,0,0)}else o.left=p.min.x,o.right=p.max.x,o.top=p.max.y,o.bottom=p.min.y,o.near=-p.max.z,o.far=-p.min.z,o.updateProjectionMatrix()},computeShadows:function(e,i,r,n,s,a){var o,l,h,c,d,u,p,f,g=this.renderer,m=[],v=0;for(i.__lights.sort(i._lightSort),w=0,o=i.__lights.length;w<o;w++)if(((f=i.__lights[w]).castShadow||f.castGroundShadow)&&(!f.castShadow||a)&&!f.isVirtual)if(f instanceof t.DirectionalLight&&f.shadowCascade){for(l=f.shadowCascadeCount;l<f.shadowCascadeArray.length;l++){(_=f.shadowCascadeArray[l])&&(_.cameraHelper&&(_.cameraHelper.visible=!1),_.convexHullHelper&&(_.convexHullHelper.visible=!1))}for(l=0;l<f.shadowCascadeCount;l++){var _;f.shadowCascadeArray[l]?_=f.shadowCascadeArray[l]:((_=this._createVirtualLight(f,l)).originalCamera=y,f.shadowCascadeArray[l]=_,i.add(_)),this._updateVirtualLight(f,l),m[v]=_,v++}}else m[v]=f,v++;if(m.length){this.shadowComposerContext||this.initComposer("Shadow");var y=n[e];this.mainComposer.updateScene(i),this._updateEffectScenes(i),this.mainComposer.setComposerContext(this.shadowComposerContext);for(var S=new t.Frustum,b=new t.Vector3,x=[],w=0;w<129;w++){var P=t.RandomLib.LowDiscrepancy2D(w);x.push({x:P.x-.5,y:P.y-.5})}var C=g.materialToUse,M=this.disableBackFaceCulling,E=g.getScissorTest(),T=g.getClearColor(),A=g.getClearAlpha(),D=function(){g.materialToUse=t.MaterialToUse.shadowMapDepthMaterial,g.setDisableBackFaceCulling(!0),g.setDepthTest(!0),g.enableScissorTest(!1)},I=function(e){g.setClearColor(T,A),g.setDisableBackFaceCulling(M),e?(g.enableScissorTest(E),g.materialToUse=C):g.materialToUse=t.MaterialToUse.originalMaterial};D();var R=null,L=null;if(i.boundingBox)R=i.boundingBox;else{for(var B=0;B<i.children.length;B++){var F=i.children[B];if(F.boundingSphere&&(L=F.boundingSphere),F.boundingBox){R=F.boundingBox;break}}!R&&L&&(R=L.getBoundingBox())}if(R){(new t.Matrix4).multiplyMatrices(y.projectionMatrix,y.matrixWorldInverse),S.setFromCameraWithViewMatrix(y);var V=S.getCorners(),G=new t.CGPoly;G.setFromFrustumPoints(V);var N=R.getPlanes(),U=G.clipByPlanes(N),k=this,z=function(e){if(f.LiSPSM){var i=y.matrixWorld.elements,r=new t.Vector3(-i[8],-i[9],-i[10]),n=f._getLightDirection(k.renderer.baseLightDirection);n.negate();var s=new t.Vector3;s.crossVectors(n,r),(c=new t.Vector3).crossVectors(s,n),c.normalize();var a=new t.Vector3,o=new t.Vector3,l=new t.Vector3;l.crossVectors(n,c),l.normalize(),o.crossVectors(l,n),o.normalize(),a.copy(n),a.normalize(),e.position.getPositionFromMatrix(y.matrixWorld),e.up.copy(o),b.copy(e.position),b.add(a),e.lookAt(b)}else if(e.position.copy(f.position),f.target)e.lookAt(f.target.position);else if(f instanceof t.PointLight){var h,c;switch(te){case 0:d=(new t.Vector3).set(1,0,0),h=(new t.Vector3).set(0,0,-1);break;case 1:d=(new t.Vector3).set(-1,0,0),h=(new t.Vector3).set(0,0,1);break;case 2:d=(new t.Vector3).set(0,1,0),h=(new t.Vector3).set(1,0,0);break;case 3:d=(new t.Vector3).set(0,-1,0),h=(new t.Vector3).set(1,0,0);break;case 4:d=(new t.Vector3).set(0,0,1),h=(new t.Vector3).set(1,0,0);break;case 5:d=(new t.Vector3).set(0,0,-1),h=(new t.Vector3).set(-1,0,0)}(c=new t.Vector3).crossVectors(h,d),c.normalize(),e.up.copy(c),e.lookAt((new t.Vector3).copy(f.position).add(d)),e.renderInverted=!0,e.updateProjectionMatrix()}else{var d;(d=(new t.Vector3).copy(k.renderer.baseLightDirection).multiplyScalar(-1)).applyMatrix4((new t.Matrix4).extractRotation(f.matrixWorld)),e.lookAt((new t.Vector3).copy(f.position).add(d))}e.updateMatrix(),e.matrixWorld.copy(e.matrix),e.matrixWorldInverse.getInverse(e.matrixWorld),e.matrixWorldNeedsUpdate=!1,e.matrixAutoUpdate=!1},H=function(e){let t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))},W=function(e,t){let i=t.renderer.use_webgpu?t.renderer.webGPUDevice.limits.maxTextureDimension2D:t.renderer.supportedFeatures.maxTextureSize;t.mobile&&(i=1024);let r=Math.min(e.shadowMapWidth,i),n=Math.min(e.shadowMapHeight,i);if(e._occurrence&&e._occurrence.scene3js&&e._occurrence.scene3js.viewer){let t=e._occurrence.scene3js.viewer,i=e._occurrence._getViewpoint(),s=t._viewpointManager.getViewpointViewport(i);if(s){let e=s.width/(t.SCREEN_WIDTH*t.devicePixelRatio)*(s.height/(t.SCREEN_HEIGHT*t.devicePixelRatio));r=H(r*e),n=H(n*e)}}return[r,n]};for(w=0,o=m.length;w<o;w++){var j=!(f=m[w]).shadowMap,X=g.shadowMapType===t.ESMShadowMap||g.shadowMapType===t.ESMImprovedShadowMap,q=X&&!this.renderer.packESM,[Z,Y]=W(f,this);f.shadowMap&&(j=q&&f.shadowMap.type===t.UnsignedByteType||!q&&f.shadowMap.type===t.FloatType);let e=(this.webgpu,1);if(j){f.shadowMap&&f.shadowMap.dispose();var K=t.LinearFilter;(g.shadowMapType===t.PCFSoftShadowMap||g.shadowMapType===t.ESMShadowMap&&!q)&&(K=t.NearestFilter);var $={minFilter:K,magFilter:K,type:q?t.FloatType:t.UnsignedByteType,format:t.RGBAFormat};this.webgpu&&($.format=q?"rgba32float":"rgba8unorm"),f instanceof t.PointLight?(X&&(f.tempRT=O.createNewRenderTarget(g,Z,Y,$,e)),f.shadowMap=O.createNewRenderTargetCube(g,Z,Y,$,e)):(f.shadowMap=O.createNewRenderTarget(g,Z,Y,$,e),f.shadowMap.generateMipmaps=!1),f.shadowMapSize=new t.Vector2(Z,Y),f.shadowMatrix=new t.Matrix4}if(g.transparentShadowEnabled&&!f.transparentShadowMap){$={minFilter:K=t.LinearFilter,magFilter:K,type:t.UnsignedByteType,format:t.RGBAFormat};this.webgpu&&($.format="rgba8unorm"),f instanceof t.PointLight?f.transparentShadowMap=O.createNewRenderTargetCube(g,Z,Y,$,e):f.transparentShadowMap=O.createNewRenderTarget(g,Z,Y,$,e),f.transparentShadowMap.shareDepthFrom=f.shadowMap}var Q=[],J=[];if(f instanceof t.SpotLight)f.shadowCamera||(f.shadowCamera=new t.PerspectiveCamera(f.shadowCameraFov,Z/Y,f.shadowCameraNear,f.shadowCameraFar,g.use_webgpu),f.transparentShadowCamera=new t.PerspectiveCamera,f.transparentShadowCamera.setWebGPU(g.use_webgpu),g.autoUpdateScene&&i.updateMatrixWorld()),Q=[f.shadowCamera],J=[f.transparentShadowCamera];else if(f instanceof t.DirectionalLight)f.shadowCamera||(f.shadowCamera=new t.OrthographicCamera(f.shadowCameraLeft,f.shadowCameraRight,f.shadowCameraTop,f.shadowCameraBottom,f.shadowCameraNear,f.shadowCameraFar,g.use_webgpu),f.transparentShadowCamera=new t.OrthographicCamera,f.transparentShadowCamera.setWebGPU(g.use_webgpu),g.autoUpdateScene&&i.updateMatrixWorld()),Q=[f.shadowCamera],J=[f.transparentShadowCamera];else{if(!(f instanceof t.PointLight)){console.error("Unsupported light type for shadow");continue}if(!f.shadowCameras){f.shadowCameras=[],f.transparentShadowCameras=[];for(w=0;w<6;w++){f.shadowCameras.push(new t.PerspectiveCamera(f.shadowCameraFov,Z/Y,f.shadowCameraNear,f.shadowCameraFar,g.use_webgpu));let e=new t.PerspectiveCamera;e.setWebGPU(g.use_webgpu),f.transparentShadowCameras.push(e)}g.autoUpdateScene&&i.updateMatrixWorld()}Q=f.shadowCameras,J=f.transparentShadowCameras}for(var ee=f.updateShadowMap,te=0;te<Q.length;te++){if(D(),u=Q[te],p=J[te],f instanceof t.PointLight&&(f.shadowMap.activeCubeFace=te,f.transparentShadowMap&&(f.transparentShadowMap.activeCubeFace=te),f.updateShadowMap=ee),g.renderIteration>2){var ie=f.offsetShadowCamera;ie?u=Q[te].clone(ie):(u=Q[te].clone(),f.offsetShadowCamera=u);var re=Math.abs(Q[te].right-Q[te].left),ne=Math.abs(Q[te].top-Q[te].bottom);u.left=Q[te].left+x[g.renderIteration].x*re/Z,u.right=Q[te].right+x[g.renderIteration].x*re/Z,u.bottom=Q[te].bottom+x[g.renderIteration].y*ne/Y,u.top=Q[te].top+x[g.renderIteration].y*ne/Y,u.updateProjectionMatrix()}if(f.shadowCameraVisible&&!f.cameraHelper&&(f.cameraHelper=new t.CameraHelper(Q[te]),f.cameraHelper.matrixAutoUpdate=!1,i.add(f.cameraHelper)),g.renderIteration<=2)if(f.isVirtual){if(!f.originalLight.updateShadowMap)continue}else if(!f.updateShadowMap)continue;if(!f.castGroundShadow||f.updateShadowMap){f.isVirtual?f.updateMatrix():f.updateShadowMap=!1,h=f.shadowMap,c=f.transparentShadowMap,d=f.shadowMatrix,z(u);var se=U.clone(),le={near:y.near,far:y.far};if(f.isVirtual){le=this._computeNearFarFromConvexHull(y,se);var he=f.originalLight.shadowCascadeCount,ce=f.originalLight.shadowCascadeSubNear&&f.originalLight.shadowCascadeSubNear[w],de=f.originalLight.shadowCascadeSubFar&&f.originalLight.shadowCascadeSubFar[w];void 0===ce&&(ce=-Math.exp((1-f.virtualLightIndex/he)*Math.log(le.near)+f.virtualLightIndex/he*Math.log(le.far))),void 0===de&&(de=-Math.exp((1-(1+f.virtualLightIndex)/he)*Math.log(le.near)+(1+f.virtualLightIndex)/he*Math.log(le.far))),le.near=ce,le.far=de,se=this._clipConvexHullFromNearFar(y,f,se,le.near,le.far),se=this._extrudeConvexHullAlongLightDir(f,R,se,u)}else se=this._extrudeConvexHullAlongLightDir(f,R,se,u);if((f.isVirtual||f.LiSPSM)&&this._updateShadowCamera(y,f,se,le.near,le.far,i,u),f.shadowCameraVisible)if(se.applyMatrix4(u.matrixWorld),f.convexHullHelper){if(f.shadowCameraHelperToUpdate){var ue=new t.Color(255),pe=[new t.Color(16711680),new t.Color(65280),new t.Color(255)];f.isVirtual&&(ue=f.virtualLightIndex<3?pe[f.virtualLightIndex]:(new t.Color).setRGB(0,0,.1*f.virtualLightIndex)),f.convexHullHelper.update(se,ue)}}else f.convexHullHelper=new t.CGPolyHelper(se),i.add(f.convexHullHelper);if(f.convexHullHelper&&(f.convexHullHelper.visible=f.shadowCameraVisible),f.cameraHelper&&(f.cameraHelper.visible=f.shadowCameraVisible),f.shadowCameraVisible&&(f.shadowCameraHelperToUpdate?(f.cameraHelper.update(),f.cameraHelper.matrixWorld=Q[te].matrixWorld,f.cameraHelper.toUpdate=!0):f.cameraHelper.toUpdate&&(f.cameraHelper.matrixWorld=(new t.Matrix4).copy(Q[te].matrixWorld),f.cameraHelper.matrixWorldNeedsUpdate=!1,f.cameraHelper.toUpdate=!1),f.cameraHelper.matrix.copy(f.cameraHelper.matrixWorld)),g.use_webgpu?d.set(.5,0,0,.5,0,-.5,0,.5,0,0,1,0,0,0,0,1):d.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),d.multiply(u.projectionMatrix),f.castGroundShadow)d.multiply(u.matrixWorldInverse),f._matrixWorldReceiver&&d.multiply(f._matrixWorldReceiver);else{var fe=(new t.Matrix4).copy(u.matrixWorldInverse);fe.setPosition(new t.Vector3(0,0,0)),d.multiply(fe)}if(X&&f instanceof t.PointLight?g.setRenderTarget(f.tempRT):g.setRenderTarget(h),X&&f instanceof t.PointLight?this.shadowComposerContext.writeBuffer=f.tempRT:this.shadowComposerContext.writeBuffer=h,X?q?g.setClearColor((new t.Color).setRGB(Math.exp(80),1,1),1):g.setClearColor((new t.Color).setRGB(.1836426750336792,.28627450980392155,.5529411764705882),.13725490196078433):g.setClearColor((new t.Color).setRGB(1,1,1),1),g.clear(),this.mainComposer.render(void 0,void 0,{main:u,mainNoJittering:u},s),g.transparentShadowEnabled){u.clone(p);var ge=function(e){return!e.hasTranspar};ae(this,ge),g.materialToUse=t.MaterialToUse.transparentShadowMaterial,g.setDisableBackFaceCulling(!1),g.setDepthTest(!0),g.setDepthWrite(!1),g.enableScissorTest(!1),g.setRenderTarget(c),this.shadowComposerContext.writeBuffer=c,g.setClearColor((new t.Color).setRGB(1,1,1),1),g.clear(!0,!1,!1),this.mainComposer.render(void 0,void 0,{main:p,mainNoJittering:p},s),oe(this,ge)}(f.castGroundShadow||X)&&(I(),!f.castGroundShadow&&X?(g.esmEffect.setSize(f.shadowMap.width,f.shadowMap.height),f instanceof t.PointLight?g.esmEffect.setInput(f.tempRT):g.esmEffect.setInput(f.shadowMap),g.esmEffect.passBlurV.setForceRenderTarget(f.shadowMap),g.esmEffect.execute()):f.castGroundShadow&&f.blurShadowEffect&&(f.blurShadowEffect.setSize(512,512),f.blurShadowEffect.setInput(f.shadowMap,d),f.blurShadowEffect.execute(),f.groundMaterial&&f.groundMaterial.updatePDSFXUniform("groundShadow",f.blurShadowEffect.getResult())))}}}I(!0)}}},_applyPickingPriorityMappingToAllPasses:function(e,t,i,r,n){if(e)for(var s=0;s<r.length;s++){var a=r[s];if(a&&a.id&&a.id.startsWith("R")){var o=a._getStateSortingResult(n,this.renderer,i);o&&this.renderer.setPickingPriorityMapping(t,o)}}},computeIntersectionGPU_old:function(e,i,r,n,s,a,o,l,h,c,d){this.gl;var u,p=e.scene,f={},g=new Array,m=i.camera,v={main:m,mainNoJittering:m,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION,!1),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION),this.pickingGPUComposerContext||this.initComposer("PickingGPU"),this.renderer.gammaInput=!1;var _=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(p),this._updateEffectScenes(p),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var y=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var S=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(h,h,m,S,this.pickingGPUComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(h,null,m,S,this.pickingGPUComposerContext);var b,x,w=this.computeMeshPick(e,r,s,h,d),P=w.tab;for(u=0;u<P.length;++u){if((M=P[u])&&M._instancingInfos&&M._instancingInfos.isInstanceNode3D&&"instance"===M._instancingInfos.instancingSelectionMode){b=b||new t.Scene;var C=M.clone();M.copyInstancingInfos(C),b.add(C),C._occurrence=M._occurrence,C._ratioData=M._ratioData}}for(n=n||c&&b,b&&(null===this.pickingGPUInstancingComposerContext&&this.initComposer("PickingGPUInstancing"),this.renderer.autoUpdateScene=!0,b.updateMatrixWorld(),this.mainComposer.updateScene(b),this._updateEffectScenes(b),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,x=this.computeInstancePick(e,r,s),this.pickingGPUInstancingComposerContext.needsUpdate=!0,b.dispose(),b=null),u=0;u<P.length;++u){var M;if(M=P[u])if(x&&x.has(M))x.get(M).forEach((function(e){var t={};t.object=M,t.type=w.type,t.instanceId=e,g.push(t)}));else(f={}).object=M,f.type=w.type,g.push(f)}if(g.length||g.push({object:null}),n){var E=p;this.normalComposerContext||this.initComposer("Normal"),this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,E.updateMatrixWorld(),this.mainComposer.updateScene(E),this._updateEffectScenes(E),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.normalComposerContext.needsUpdate=!1,this.computeNormalPick(g,m,w.outMouse),this.renderer.autoUpdateScene=!0,E.updateMatrixWorld(),this.mainComposer.updateScene(E),this._updateEffectScenes(E),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.depthComposerContext.needsUpdate=!1;var T=g[0].object&&g[0].object._occurrence?g[0].object._occurrence.node:null,A="";T&&""!==(A=T._getPickingCameraName())&&(m=i[A]),this.computePositionPick(g,m,w.outMouse,d)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=_,this.renderer.renderHiddenEdges=y,this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION),g},computeIntersectionGPU:function(e,i,r,n,s,a,o,l,h,c,d,u,p){this.gl;var f,g,m=e.scene,v={},_=new Array,y=this.renderer.getViewport(),S=y.width,b=y.height,x=Math.round(r.xPix),w=Math.round(r.yPix),P=i.camera,C={main:P,mainNoJittering:P,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};if(u){var M=null;let e=2*this.gpuPickingTolerance+1;this.renderer.setViewport(0,0,e,e),this.renderer.setScissor(0,0,e,e),P.fullWidth&&(M={fullWidth:P.fullWidth,fullHeight:P.fullHeight,x:P.x,y:P.y,width:P.width,height:P.height}),C.main.useRealSize=!0,C.connectedRobotCamera.useRealSize=!0,C.robotCameraOrtho.useRealSize=!0;var E=this.gpuPickingTolerance,T=this.gpuPickingTolerance,A=0,D=0;s&&r.pt&&(A=Math.round(Math.abs(r.xPix-r.pt.xPix)),D=Math.round(Math.abs(r.yPix-r.pt.yPix)));var I=A,R=D;if(M){var O,L;O=M.width/M.fullWidth,L=M.height/M.fullHeight;var B=M.fullWidth/S,F=M.fullHeight/b;S=M.fullWidth,b=M.fullHeight,w*=F,x=(x*=B)*O+M.x,w=w*L+M.y,E*=O,T*=L,A=A*B*O,D=D*F*L}x-=y.x,w-=this.deviceHeight-(y.height+y.y);var V=s&&0!==A?A:2*E+1,G=s&&0!==D?D:2*T+1,N=s?x:x-E,U=s?w:w-T;i._setPickingViewOffset({cameraSet:C,fullHeight:b,fullWidth:S,x:N,y:U-1,width:V,height:G,pickingRatioW:V/y.width,pickingRatioH:G/y.height})}if(u?(this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION_SMALL,!1),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION_SMALL)):(this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION,!1),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION)),3!==n){this.pickingGPUComposerContext||this.initComposer("PickingGPU",u),s&&u&&this.pickingGPUComposerContext.setSize(I,R);var k=!1;u&&(k=!!s,this.currentGPUPickPosition.x==x&&this.currentGPUPickPosition.y==w||(this.currentGPUPickPosition.x=x,this.currentGPUPickPosition.y=w,k=!0)),this.renderer.gammaInput=!1;var z=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(m),this._updateEffectScenes(m),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var H=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var W=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(h,h,P,W,this.pickingGPUComposerContext),this.pickingGPUComposerContext.needsUpdate=k||this.pickingGPUComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(h,null,P,W,this.pickingGPUComposerContext);var j,X,q=(g=u?this.computeMeshPickSmallTarget(e,r,s,h,d):this.computeMeshPick(e,r,s,h,d)).tab;for(f=0;f<q.length;++f){if((Y=q[f])&&Y._instancingInfos&&Y._instancingInfos.isInstanceNode3D&&"instance"===Y._instancingInfos.instancingSelectionMode){j=j||new t.Scene;var Z=Y.clone();Y.copyInstancingInfos(Z),j.add(Z),Z._occurrence=Y._occurrence,Z._ratioData=Y._ratioData}}for(n=n||c&&j,j&&(this.pickingGPUInstancingComposerContext||this.initComposer("PickingGPUInstancing",u),s&&u&&this.pickingGPUInstancingComposerContext.setSize(A,D),this.renderer.autoUpdateScene=!0,j.updateMatrixWorld(),this.mainComposer.updateScene(j),this._updateEffectScenes(j),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,C,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,X=u?this.computeInstancePickSmallTarget(e,r,s):this.computeInstancePick(e,r,s),this.pickingGPUInstancingComposerContext.needsUpdate=!0,j.dispose(),j=null),f=0;f<q.length;++f){var Y;if(Y=q[f])if(X&&X.has(Y))X.get(Y).forEach((function(e){var t={};t.object=Y,t.type=g.type,t.instanceId=e,_.push(t)}));else(v={}).object=Y,v.type=g.type,_.push(v)}}if(_.length||_.push({object:null}),n&&n<2){this.normalComposerContext||this.initComposer("Normal",u),this.depthComposerContext||this.initComposer("Depth",u),s&&u&&i._setPickingViewOffset({cameraSet:C,fullHeight:y.height,fullWidth:y.width,x:x-E,y:w-T-1,width:2*E+1,height:2*T+1}),this.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),this.mainComposer.updateScene(m),this._updateEffectScenes(m),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.normalComposerContext.needsUpdate=k||this.normalComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.normalComposerContext.needsUpdate=!1,u?this.computeNormalPickSmallTarget(_,P,g.outMouse):this.computeNormalPick(_,P,g.outMouse),this.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),this.mainComposer.updateScene(m),this._updateEffectScenes(m),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.depthComposerContext.needsUpdate=k||this.depthComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.depthComposerContext.needsUpdate=!1;var K="";($=_[0].object&&_[0].object._occurrence?_[0].object._occurrence.node:null)&&""!==(K=$._getPickingCameraName())&&(P=i[K]),u?this.computePositionPickSmallTarget(_,P,g.outMouse,d):this.computePositionPick(_,P,g.outMouse,d)}if(n>=2&&!s){this.gpuPositionComposerContext||this.initComposer("GPUPosition",u),this.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),this.mainComposer.updateScene(m),this._updateEffectScenes(m),this.renderer.materialToUse=t.MaterialToUse.gpuPositionMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,g||(g={outMouse:r});let e=[],n=g.outMouse.xPix,s=g.outMouse.yPix,a=n-this.heuristicNormalRadius,o=s-this.heuristicNormalRadius,l=2*this.heuristicNormalRadius+1,h=2*this.heuristicNormalRadius+1,c=this.viewportHeight;if(this.renderer.supportsDrawBuffers()||this.renderer.use_webgpu){this.mainComposer.setComposerContext(this.gpuPositionComposerContext[0]),this.gpuPositionComposerContext[0].needsUpdate=k||this.gpuPositionComposerContext[0].needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.gpuPositionComposerContext[0].needsUpdate=!1;let i=this.gpuPositionComposerContext[0].getResult("main");for(let r=0;r<3;r++){let n=new Uint8Array(4*l*h);!this.renderer.use_webgpu&&r>0&&this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,i.__webglMRTFramebuffers[r-1]),u?this.renderer.readPixelCustom(0,0,l,h,t.RGBAFormat,t.UnsignedByteType,n,null,!0,!0,r):this.renderer.readPixelCustom(a,c-o-h+1,l,h,t.RGBAFormat,t.UnsignedByteType,n,null,!0,!0,r),e[r]=new Float32Array(n.buffer)}this.renderer.use_webgpu||this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t.glStates.currentFramebuffer)}else for(let i=0;i<3;i++){switch(this.mainComposer.setComposerContext(this.gpuPositionComposerContext[i]),i){case 0:this.renderer.positionComponent=new t.Vector3(1,0,0);break;case 1:this.renderer.positionComponent=new t.Vector3(0,1,0);break;case 2:this.renderer.positionComponent=new t.Vector3(0,0,1)}this.gpuPositionComposerContext[i].needsUpdate=k||this.gpuPositionComposerContext[i].needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.gpuPositionComposerContext[i].needsUpdate=!1;let r=new Uint8Array(4*l*h);u?this.renderer.readPixelCustom(0,0,l,h,t.RGBAFormat,t.UnsignedByteType,r):this.renderer.readPixelCustom(a,c-o-h+1,l,h,t.RGBAFormat,t.UnsignedByteType,r),e[i]=new Float32Array(r.buffer)}var $;K="";($=_[0].object&&_[0].object._occurrence?_[0].object._occurrence.node:null)&&""!==(K=$._getPickingCameraName())&&(P=i[K]),this.computeFloatPositionPick(_,P,g.outMouse,e,p)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=z,this.renderer.renderHiddenEdges=H,u&&(i._setPickingViewOffset({cameraSet:C,reset:!0}),M&&i.setViewOffset(M,!0)),this.renderer.setViewport(y.x,y.y,y.width,y.height),C.main.useRealSize=!1,C.connectedRobotCamera.useRealSize=!1,C.robotCameraOrtho.useRealSize=!1,s&&u&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)),u?this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION_SMALL):this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION),_},renderPickingColors:function(e,i){var r=e.scene;this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION,!1),this.pickingGPUComposerContext||this.initComposer("PickingGPU",!1);var n=this.renderer.gammaInput,s=this.renderer.gammaOutput;this.renderer.gammaInput=!1,this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(r),this._updateEffectScenes(r),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var a=this.renderer.pickingModeMSB,o=this.renderer.pickingModeLSB;this.renderer.pickingModeMSB=t.ShowAllFaces,this.renderer.pickingModeLSB=0;var l=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var h=this.renderer.renderLineMode;this.renderer.renderLineMode=0;var c=this.renderer.renderPointMode;this.renderer.renderPointMode=0;var d=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext),this.pickingGPUComposerContext.needsUpdate=this.pickingGPUComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,i,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this.renderer.lensFlareEnabled=!0,this.renderer.gammaInput=n,this.renderer.gammaOutput=s,this.renderer.renderFaceMode=l,this.renderer.renderLineMode=h,this.renderer.renderPointMode=c,this.renderer.renderHiddenEdges=d,this.renderer.pickingModeMSB=a,this.renderer.pickingModeLSB=o},computeDepthBuffer:function(e,i,r){var n={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho},s=e.scene;this.depthComposerContext||this.initComposer("Depth"),r&&(this.depthComposerContext.needsUpdate=!0),this.renderer.gammaInput=!1;var a=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoUpdateScene=!0,s.updateMatrixWorld(),this.mainComposer.updateScene(s),this._updateEffectScenes(s),this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,n,"main"),this.depthComposerContext.needsUpdate=!1,this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=a},computePositionGPU:function(e,i,r){this.gl;var n=e.scene,s=[],a={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.gammaInput=!1;var o=this.renderer.gammaOutput;return this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,n.updateMatrixWorld(),this.mainComposer.updateScene(n),this._updateEffectScenes(n),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,a,"main"),this.depthComposerContext.needsUpdate=!1,s[0]={point:null},this.computePositionPick(s,camera,r,replayMode),this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=o,s[0].point},overrideUpdate:function(e){var t=e.root._getViewer();if(e.root._getTreeModified()&&t.getCurrentSceneGraphState()&&function(){var t,i=e.root._occurrences;for(t=0;t<i.length;t++)i[t].requestOverridesUpdate()}(),e.root._getTreeModified()&&t._sceneGraphOverrideSetManager&&t._sceneGraphOverrideSetManager._updateOverridesWithMissingTarget(t),e.root._tryOverridesUpdate(t),e.root._getTreeModified()){var i=new Set;e.root.traverseUnique((function(e){if(!e._getTreeModified())return!0;i.add(e)})),i.forEach((function(e){e.__setTreeModified(!1)}))}},renderRealDepth:function(e,t,i,r,n,s,a,o){this.outlineDepthComposerContext||(this.initComposer("OutlineDepth"),this.initComposer("MirrorOutlineDepth")),this.renderer.dBuffer=this.renderRealDepth_internal(e,t,i,r,n,s,a,o?this.mirrorOutlineDepthComposerContext:this.outlineDepthComposerContext,!1)},renderOcclusionRealDepth:function({cameraName:e,scene:t,gl:i,cameraSet:r,resultId:n,doSectionCapping:s,sceneGraph:a,width:o,height:l,viewportScale:h}){return this.occlusionDepthComposerContext||this.initComposer("OcclusionDepth"),this.occlusionDepthComposerContext.setSize(o,l,n,this.renderTargetPool),this.occlusionDepthComposerContext._internalScaleForViewport=h,this.renderRealDepth_internal(e,t,i,r,n,s,a,this.occlusionDepthComposerContext,!0)},renderRealDepth_internal:function(e,i,r,n,s,a,o,l,h){l.setCameraName(e),this.mainComposer.updateScene(i),this._updateEffectScenes(i);var c=this.renderer.supportsFloatTextures();this.renderer.materialToUse=c&&!h?t.MaterialToUse.normalDepthMaterial:t.MaterialToUse.depthRGBAMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.lensFlareEnabled=!1;var d=function(e){return!e.hasOcclusionDepth};return ae(this,d),l.setPassClear(this.initClearPass,!0,new t.Color(0),0),l.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(l),this._disableScissorForPostPro(),this.renderer.initWebGLObjects(i),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),this.renderer.lensFlareEnabled=!0,oe(this,d),this.mainComposer.getRenderResult("main")},renderOpaqueScene:function(e,i,r,n,s,a){this.opaqueOnlyComposerContext||this.initComposer("Opaque");var o=this.renderer;this.opaqueOnlyComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateEffectScenes(i);var l=function(e){return e.sgOrdered};ae(this,l),o.materialToUse=t.MaterialToUse.originalMaterial,o.autoClearDepth=!0,o.autoClearStencil=!0,o.lensFlareEnabled=!1;var h=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var c=this.renderer.renderLineMode;this.renderer.renderLineMode=0;var d=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.opaqueOnlyComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.opaqueOnlyComposerContext.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(this.opaqueOnlyComposerContext),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),o.lensFlareEnabled=!0,oe(this,l),this.renderer.renderFaceMode=h,this.renderer.renderLineMode=c,this.renderer.renderPointMode=d},renderColorScene:function(e,i,r,n,s,a){this.colorComposerContext||this.initComposer("Color");var o=this.renderer;this.colorComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateEffectScenes(i);var l=function(e){return e.sgOrdered};ae(this,l),o.materialToUse=t.MaterialToUse.originalMaterial,o.autoClearDepth=!0,o.autoClearStencil=!0,o.lensFlareEnabled=!1;var h=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var c=this.renderer.renderLineMode;this.renderer.renderLineMode=0;var d=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.colorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.colorComposerContext.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(this.colorComposerContext),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),o.lensFlareEnabled=!0,oe(this,l),this.renderer.renderFaceMode=h,this.renderer.renderLineMode=c,this.renderer.renderPointMode=d},renderPoliteDepth:function(e,i,r,n,s,a,o){this.highlightDepthComposerContext||this.initComposer("HighlightDepth");var l=this.renderer;this.highlightDepthComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateEffectScenes(i),l.materialToUse=t.MaterialToUse.depthRGBAMaterial,l.autoClearDepth=!0,l.autoClearStencil=!0,l.lensFlareEnabled=!1;var h=function(e){return!e.hasPoliteDepth};ae(this,h),this.highlightDepthComposerContext.setPassClear(this.initClearPass,!0,new t.Color(16777215),1),this.highlightDepthComposerContext.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(this.highlightDepthComposerContext),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),l.politeDepthBuffer=this.mainComposer.getRenderResult("main");for(let e=0;e<l._politeBufferRequestsCBs.length;e++)l._politeBufferRequestsCBs[e](l.politeDepthBuffer);l.lensFlareEnabled=!0,oe(this,h)},_disableScissorForPostPro:function(){this.renderer.splitScreenMode&&(ne=this.renderer.getScissorTest(),this.renderer.enableScissorTest(!1),se=this.renderer.getViewport(),this.renderer.setViewport(0,0,se.width,se.height))},_enableScissorPostPostPro:function(){this.renderer.splitScreenMode&&(this.renderer.setViewport(se.x,se.y,se.width,se.height),this.renderer.enableScissorTest(ne))},renderPostEffectNormalDepth:function(e,i,r,n,s,a,o){this.mainComposer.updateScene(r),this._updateEffectScenes(r),this.renderer.materialToUse=i,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.lensFlareEnabled=!1,e.setPassClear(this.initClearPass,!0,new t.Color(0),0),e.enableRenderCuttingElementsPasses(o),this.mainComposer.setComposerContext(e),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,s,a),this._enableScissorPostPostPro(),this.renderer.lensFlareEnabled=!0},render:function(e,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b){if(this.webgpu){if(!this.renderer.webGPUCanvas)return;this.renderer.webGPUCanvas.resize()}this.renderer.renderIteration=m,this.renderer.increaseFrameCount(t._FrameTypes.MAIN,b),this.renderer.info.renderTime.pushRoot(t._FrameTypes.MAIN),s.mainNoJittering=s.main;var x=this.MSAAEffect&&this.MSAAEffect.enabled,w=this.TAAEffect&&this.TAAEffect.enabled,P=x||w,C=P?w?this.TAAEffect:this.MSAAEffect:null;if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.iterative){var M=null;P&&(M=C.computeJitterValues(s.main,m)),s.main=this.BokehDOFEffect.computeJitterCamera(s.main,m,M),s.cameraBackground=this.BokehDOFEffect.computeJitterCamera(s.cameraBackground,m,M)}else P&&(ee++,ee%=128,s.main=C.computeJitterCamera(s.main,m||ee),s.cameraBackground=C.computeJitterCamera(s.cameraBackground,m||ee),s.mirrorCamera&&(s.mirrorCamera=C.computeJitterCamera(s.mirrorCamera,m)));this.overrideUpdate(a,d);var E,T,A,D,I,R=this.gl;this.renderer.gammaInput=!0,this.renderer.materialToUse=t.MaterialToUse.originalMaterial,A=a.scene,this.scene=A;!u&&(h||this.renderer.getViewportSize().width===this.viewportWidth&&(this.renderer.getViewportSize().height,this.viewportHeight));D=(this.HighlightEffect||this.Canvas2DHighlightEffect)&&!y,I=this.PreHighlightEffect||this.Canvas2DPreHighlightEffect,this.HighlightEffect&&this.HighlightEffect.setEnabled(D),D&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.setEnabled(D),D&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),I&&this.PreHighlightEffect.setEnabled(I),I&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),I&&this.Canvas2DPreHighlightEffect.setEnabled(I),I&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),this.updateFinalComposer(h);var O=!1;if(!c||!this.useCompositing||!this.highlightPass||this.renderer._requestPoliteDepthBuffer&&null===this.renderer.politeDepthBuffer){if(this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.needsUpdate=!0,this.meshesGPU={}),this.normalComposerContext&&(this.normalComposerContext.needsUpdate=!0,this.normalsGPU={}),this.depthComposerContext&&(this.depthComposerContext.needsUpdate=!0,this.positionsGPU={}),this.gpuPositionComposerContext){for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].needsUpdate=!0;this.positionsFloatGPU={},this.heuristicNormalsGPU={}}if(this.currentGPUPickPosition={x:-1,y:-1},this.renderer.reflectionColorBuffer=null,this.renderer.refractionColorBuffer=null,this.renderer.aoBuffer=null,this.renderer.autoUpdateScene=!0,A.updateMatrixWorld(),this.renderer.initWebGLObjects(A),this.useAuxiliaryAsForward||(this.updateClippingGlobals(a,A,this,S),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(O=!0),O&&this.updateSectionCappingScene(a,A)),this.afterMirrorClearDepth&&this.afterMirrorClearDepth.setClearStencil(O),!this.useAuxiliaryAsForward){this.renderer.shadowMapEnabled=r,this.renderer.shadowMapSoft=r,this.computeShadows("main",A,R,s,_,r),this.renderer.materialToUse=t.MaterialToUse.originalMaterial;let e=this.multiView||m<3||v;var L=!1,B=!1;e&&(this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled)&&(this.renderer._pbrCheck={has:!1,hasTransparent:!1},this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.renderPostEffectNormalDepth(this.normalDepthIoRRoughnessComposerContext,t.MaterialToUse.normalDepthIoRRoughnessMaterial,A,R,s,_,O),L=this.renderer._pbrCheck.has,B=this.renderer._pbrCheck.hasTransparent,this.renderer._pbrCheck=null);var F=e&&(this.SSAOEffect&&this.SSAOEffect.enabled||this.FakeOutlinesEffect&&this.FakeOutlinesEffect.enabled||this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled||this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&!this.BokehDOFEffect.iterative||A.__webglFlares&&A.__webglFlares.length||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&B);(F=F||this.TAAEffect&&this.TAAEffect.enabled||this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(1===m||m>1&&this.MSAAEffect&&this.MSAAEffect.enabled))&&(this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.renderPostEffectNormalDepth(this.normalDepthComposerContext,t.MaterialToUse.normalDepthMaterial,A,R,s,_,O)),this.FakeOutlinesEffect&&this.FakeOutlinesEffect.enabled&&this.renderPickingColors(a,s),this.renderer.materialToUse=t.MaterialToUse.originalMaterial;let i=null;this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled?i=this.SSAOIterativeEffect:this.SSAOEffect&&this.SSAOEffect.enabled&&(i=this.SSAOEffect),i&&(this._disableScissorForPostPro(),this.renderer.aoBuffer=i.execute(null),this.renderer.resetUpdatedUBOs(),this._enableScissorPostPostPro()),e&&this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&B&&this.renderOpaqueScene("main",A,R,s,_,O),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&B&&(this._disableScissorForPostPro(),this.renderer.refractionColorBuffer=this.SSLRefractionEffect.execute(),this.renderer.resetUpdatedUBOs(),this._enableScissorPostPostPro()),e&&this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&L&&this.renderColorScene("main",A,R,s,_,O),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&L&&(this._disableScissorForPostPro(),this.renderer.reflectionColorBuffer=this.SSLReflectionEffect.execute(),this.renderer.resetUpdatedUBOs(),this._enableScissorPostPostPro())}this.renderer._requestPoliteDepthBuffer&&this.renderPoliteDepth(this.mobile?"main":"mainNoJittering",A,R,s,_,O,a),this.renderer.materialToUse=t.MaterialToUse.originalMaterial;var V=this.renderer.requestDBuffer||this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled||this.renderer.getRenderMode().getMask()&t.OutlineMask;if(i){V&&this.renderRealDepth("mirrorCamera",A,R,s,_,O,a,!0);var G=this.renderer.reflectionColorBuffer,N=this.renderer.refractionColorBuffer,U=this.renderer.aoBuffer;(this.renderer.aoBuffer||this.renderer.reflectionColorBuffer||this.renderer.refractionColorBuffer)&&this.renderer.resetUpdatedUBOs(),this.renderer.reflectionColorBuffer=null,this.renderer.refractionColorBuffer=null,this.renderer.aoBuffer=null,this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.compMirrorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(O),this.mainComposer.updateScene(A),this._updateEffectScenes(A);var k=!1;null!==o&&(k=o.visible,o.visible=!1);var z=!1,H=20*(1-l);this.passMirrorBlur.material.setUniform("radius",this.renderer._renderScale*H),H>0&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur,z),z=!1,H>12&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur1,z),z=!1,H>16&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur2,z),z=!1,H>18&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur3,z),this.compMirrorComposerContext.setRenderPlugins(this.forwardPass,!0);var W=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var j=this.renderer.renderLineMode;this.renderer.renderLineMode=this.renderer.renderLineMode&~t.GeomTypeEnum.WIRE_EDGE;var X=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.mainComposer.setComposerContext(this.compMirrorComposerContext),this.mainComposer.render(.1,void 0,s,_),this.renderer.renderFaceMode=W,this.renderer.renderLineMode=j,this.renderer.renderPointMode=X,null!==o&&(o.visible=k),this.renderer.reflectionColorBuffer=G,this.renderer.refractionColorBuffer=N,this.renderer.aoBuffer=U,(this.renderer.aoBuffer||this.renderer.reflectionColorBuffer||this.renderer.refractionColorBuffer)&&this.renderer.resetUpdatedUBOs()}if(V&&this.renderRealDepth("main",A,R,s,_,O,a,!1),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.renderer.autoClear=!1,this.compForwardComposerContext.enablePass(this.infPlanePass,e),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.infPlanePass.setScene(n),this.compForwardComposerContext.enableRenderCuttingElementsPasses(O),this.compForwardComposerContext.enablePass(this.mirrorBlendPass,e&&i),this.compForwardComposerContext.enablePass(this.mirrorClearDepth,e&&i),this.compForwardComposerContext.enablePass(this.afterMirrorClearDepth,i),this.compForwardComposerContext.setPassClear(this.mirrorClearDepth,!0,new t.Color(0),1),this.compForwardComposerContext.setPassClear(this.afterMirrorClearDepth,!1,new t.Color(0),1),this.compForwardComposerContext.setPassClearDepth(this.afterMirrorClearDepth,!0),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),function(e,t){e.forwardPass.setScene(t),e.zPostPass.setScene(t),e.backgroundPass.setScene(t),e.ZOnlyPass.setScene(t)}(this,A),this.mainComposer.updateScene(A),this._updateEffectScenes(A),this._HighlightMobileNonEffect&&this._HighlightMobileNonEffect.hide(y),this.customComposerContexts){var q=this.mainComposer.getPostEffectPasses();for(T=0;T<q.length;T++)for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(q[T],!1);for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[E].enableRenderCuttingElementsPasses(O),this.mainComposer.setComposerContext(this.customComposerContexts[E]),this.mainComposer.render(void 0,void 0,s,_)}if(p){var Z=new t.WebGLRenderTargetProperties(f,f,"cubelinear"),Y=this.compForwardComposerContext.originalRenderTargetProperties,$=this.compForwardComposerContext.keepResult,Q=this.compForwardComposerContext.renderResults.main,J=Q.useCount;this.compForwardComposerContext.keepResult=!0,Q.useCount=1,this.compForwardComposerContext.releaseRenderTargets(this.mainComposer.renderTargetPool),this.compForwardComposerContext.originalRenderTargetProperties=Z,this.mainComposer.setComposerContext(this.compForwardComposerContext),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!0),this.mainComposer.render(.1,g,s,_),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!1),this.compForwardComposerContext.originalRenderTargetProperties=Y,this.compForwardComposerContext.keepResult=$,Q.useCount=J}else this.useAuxiliaryAsForward?this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext):this.mainComposer.setComposerContext(this.compForwardComposerContext),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.execute(),this.mainComposer.render(.1,void 0,s,_);this.renderer.shadowMapEnabled=!1,this.renderer.shadowMapSoft=!1}else if(this.mainComposer.updateScene(A),this._updateEffectScenes(A),this.useAuxiliaryAsForward)this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext),this.mainComposer.render(.1,void 0,s,_);else{if(this.customComposerContexts){this.renderer.initWebGLObjects(A),this.updateClippingGlobals(a,A,this,S),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(O=!0),O&&this.updateSectionCappingScene(a,A);q=this.mainComposer.getPostEffectPasses();for(T=0;T<q.length;T++)for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(q[T],!1);for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[E].enableRenderCuttingElementsPasses(O),this.mainComposer.setComposerContext(this.customComposerContexts[E]),this.mainComposer.render(void 0,void 0,s,_)}this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.updateLinks(_),this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.render(.1,void 0,s,_,this.highlightPass)}if(this.renderer.renderAssets(),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.setDepthFunc(this.renderer.depthFuncs.LEQUAL),this.renderer.info.renderTime.popRoot(t._FrameTypes.MAIN),K._iteratePerformance(this)){var te=a.root._getViewer();te&&te.render()}},_activatedPixelPerformanceSuite:function(){return this.PixelShaderPerformanceEffect&&this.PixelShaderPerformanceEffect.enabled},_activatedTexturePerformanceSuite:function(){return this.TexturePerformanceEffect&&this.TexturePerformanceEffect.enabled},_needPerformanceSuite:function(){return this._needsPerformanceCheck},combineResults:function(e,r,n){if(!n.isReady())return!1;if(!this.superFinalComposer){var s=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");s.generateMipmaps=!1,this.superFinalComposer=new i(this.renderer,s,this.renderTargetPool),this.superFinalComposer.composerContext.name="superFinalComposer",n.createPasses(this.superFinalComposer)}n.updatePasses(e,r,this.compForwardComposerContext.renderResults);var a=this.renderer.getViewportSize();return this.renderer.setViewport(0,0,this.deviceWidth,this.deviceHeight),this.superFinalComposer.render(.1,void 0,{},"superFinal"),this.renderer.setViewport(0,0,a.width,a.height),!0},computeMeshPick:function(e,i,r,n,s){var a,o;s&&void 0!==i.x&&void 0!==i.y?(a=Math.round(Math.round((i.x+1)*this.deviceWidth/2)),o=Math.round(this.deviceHeight-Math.round((i.y+1)*this.deviceHeight/2))):(a=Math.round(i.xPix),o=Math.round(i.yPix));var l,h,c,d,u=r&&i.pt&&0!==Math.round(i.xPix-i.pt.xPix)?Math.round(Math.abs(i.xPix-i.pt.xPix)):1,p=r&&i.pt&&0!==Math.round(i.yPix-i.pt.yPix)?Math.round(Math.abs(i.yPix-i.pt.yPix)):1,f=this.deviceHeight,g={},m=new Set,v=a,_=o,y=!0;if(0==r){for(y=this.pickingGPUComposerContext.needsUpdate,h=a-this.gpuPickingTolerance;h<=a+this.gpuPickingTolerance;++h)for(c=o-this.gpuPickingTolerance;c<=o+this.gpuPickingTolerance;++c)this.meshesGPU[c*this.deviceWidth+h+this._pickingVPid]||(y=!0);v=a-this.gpuPickingTolerance,_=o-this.gpuPickingTolerance,u=2*this.gpuPickingTolerance+1,p=2*this.gpuPickingTolerance+1}if(y){var S=new Uint8Array(4*u*p);for(this.renderer.readPixelCustom(v,f-_-p+1,u,p,t.RGBAFormat,t.UnsignedByteType,S,this.mainComposer),h=0;h<u;++h)for(c=0;c<p;++c){l=(63&S[d=4*(c*u+h)])<<16|S[d+1]<<8|S[d+2];var b=S[d]>>6&3,x=g[l];void 0===x&&(x=this.getObjectById(e.scene,l),g[l]=x,x&&x.pickable&&m.add(x)),this.meshesGPU[(_+p-c-1)*this.deviceWidth+v+h+this._pickingVPid]={object:x,glType:b}}}return r?{tab:Array.from(m),outMouse:i}:this._computePixelMeshPick(v,a,u,_,o,p,i,n)},computeInstancePick:function(e,i,r){var n,s,a,o,l=Math.round(i.xPix),h=Math.round(i.yPix),c=r&&i.pt&&0!==Math.round(i.xPix-i.pt.xPix)?Math.round(Math.abs(i.xPix-i.pt.xPix)):1,d=r&&i.pt&&0!==Math.round(i.yPix-i.pt.yPix)?Math.round(Math.abs(i.yPix-i.pt.yPix)):1,u=this.deviceHeight,p=l,f=h;r||(p=l-this.gpuPickingTolerance,f=h-this.gpuPickingTolerance,c+=2*this.gpuPickingTolerance,d+=2*this.gpuPickingTolerance);var g=new Uint8Array(4*c*d);this.renderer.readPixelCustom(p,u-f-d+1,c,d,t.RGBAFormat,t.UnsignedByteType,g,this.mainComposer);var m=new Map,v=r?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(s=0;s<c;++s)for(a=0;a<d;++a)if(!(0===(n=g[o=4*(a*c+s)]<<16|g[o+1]<<8|g[o+2])||n>16777215)){var _=n%5;if(0!==_&&(_>3?n=n+5-_:_<3?n-=_:n=void 0),0!==n&&void 0!==n)if(r){if(y=this.meshesGPU[(f+d-a-1)*this.deviceWidth+p+s+this._pickingVPid])if(m.has(y.object))m.get(y.object).add(n);else(S=new Set).add(n),m.set(y.object,S)}else{var y,S,b=s+p-l,x=a+f-h;if(b*b+x*x<v)if(y=this.meshesGPU[(f+d-a-1)*this.deviceWidth+p+s+this._pickingVPid])if(m.has(y.object))m.get(y.object).add(n);else(S=new Set).add(n),m.set(y.object,S)}}return m},computePositionPick:function(e,i,r,n){var s,a,o,l=r.xPix,h=r.yPix,c=this.deviceHeight,d=new Uint8Array(4);if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid])s=this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid];else{if(this.renderer.readPixelCustom(l,c-h,1,1,t.RGBAFormat,t.UnsignedByteType,d,this.mainComposer),o=(a=new Float32Array(d.buffer))[0]?this.webgpu?a[0]:2*a[0]-1:1,i._viewpoint&&!n){let e=new t.Vector2(r.xPix,r.yPix);e.divideScalar(this.devicePixelRatio),e=i._viewpoint._convertViewportToNDC(e),s=new t.Vector4(e.x,e.y,o,1)}else s=new t.Vector4(r.x,r.y,o,1);s.applyMatrix4(i.projectionMatrixInverse),s.multiplyScalar(1/s.w),s.applyMatrix4(i.matrixWorld),this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid]=s.clone()}for(var u=0;u<e.length;++u)e[u].point=new t.Vector3(s.x,s.y,s.z)},computeNormalPick:function(e,i,r){var n,s=r.xPix,a=r.yPix,o=this.deviceHeight,l=new Uint8Array(4);if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid])n=this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid];else{this.renderer.readPixelCustom(s,o-a,1,1,t.RGBAFormat,t.UnsignedByteType,l,this.mainComposer);var h=(n=new t.Vector4(l[0]/255*2-1,l[1]/255*2-1,l[2]/255*2-1,0)).x,c=n.y,d=n.z,u=i.matrixWorld.elements,p=1/(u[3]*h+u[7]*c+u[11]*d+u[15]);n.x=(u[0]*h+u[4]*c+u[8]*d)*p,n.y=(u[1]*h+u[5]*c+u[9]*d)*p,n.z=(u[2]*h+u[6]*c+u[10]*d)*p,this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid]=n.clone()}for(var f=0;f<e.length;++f)e[f].normal=new t.Vector3(n.x,n.y,n.z),e[f].tangent=null},_computePixelMeshPick:function(e,t,i,r,n,s,a,o){for(var l=0,h=0,c=0,d=0,u=null,p=!1,f=2,g=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance,m=null,v=-1/0,_=0,y=["points","edges","faces"],S=[g,g,0],b=[g,g,0],x=function(e){return e.id===this},w=e;w<e+i;++w)for(var P=w-t,C=r;C<r+s;++C){var M=C-n,E=P*P+M*M,T=this.meshesGPU[C*this.deviceWidth+w+this._pickingVPid];if(T){var A=T.object,D=T.glType,I=A&&A.hasPriorityManipulators&&A.hasPriorityManipulators();if(p&&!I)continue;_=0,A&&A.pickable&&(o&&A.pickingPriorityID&&(m=!!A.pickingPriorityID[y[D]]&&o.find(x,A.pickingPriorityID[y[D]]))&&(_=m.priority),(!p&&I||_>v&&E<=b[D]||_===v&&D<=f&&E<=S[D])&&(p=I,S[D]=E,u=A,f=D,v=_,l=w,h=C,c=w-e,d=C-r))}}return u?{tab:[u],outMouse:{xPix:l,yPix:h,xDev:c,yDev:d,x:(l-this.deviceWidth/2)/(this.deviceWidth/2),y:(this.deviceHeight/2-h)/(this.deviceHeight/2)},type:f}:{tab:[],outMouse:a}},computeMeshPickSmallTarget:function(e,i,r,n,s){var a,o;s&&void 0!==i.x&&void 0!==i.y?(a=Math.round(Math.round((i.x+1)*this.deviceWidth/2)),o=Math.round(this.deviceHeight-Math.round((i.y+1)*this.deviceHeight/2))):(a=Math.round(i.xPix),o=Math.round(i.yPix));var l,h,c,d,u=r&&i.pt&&0!==Math.round(i.xPix-i.pt.xPix)?Math.round(Math.abs(i.xPix-i.pt.xPix)):1,p=r&&i.pt&&0!==Math.round(i.yPix-i.pt.yPix)?Math.round(Math.abs(i.yPix-i.pt.yPix)):1,f=(this.deviceHeight,{}),g=new Set,m=a,v=o;0==r&&(m=a-this.gpuPickingTolerance,v=o-this.gpuPickingTolerance,u=2*this.gpuPickingTolerance+1,p=2*this.gpuPickingTolerance+1);var _=new Uint8Array(4*u*p);for(this.renderer.readPixelCustom(0,0,u,p,t.RGBAFormat,t.UnsignedByteType,_,this.mainComposer),h=0;h<u;++h)for(c=0;c<p;++c){l=(63&_[d=4*(c*u+h)])<<16|_[d+1]<<8|_[d+2];var y=_[d]>>6&3,S=f[l];void 0===S&&(S=this.getObjectById(e.scene,l),f[l]=S,S&&S.pickable&&g.add(S)),this.meshesGPU[(v+p-c-1)*this.deviceWidth+m+h+this._pickingVPid]={object:S,glType:y}}return r?{tab:Array.from(g),outMouse:i}:this._computePixelMeshPick(m,a,u,v,o,p,i,n)},computeInstancePickSmallTarget:function(e,i,r){var n,s,a,o,l=Math.round(i.xPix),h=Math.round(i.yPix),c=r&&i.pt&&0!==Math.round(i.xPix-i.pt.xPix)?Math.round(Math.abs(i.xPix-i.pt.xPix)):1,d=r&&i.pt&&0!==Math.round(i.yPix-i.pt.yPix)?Math.round(Math.abs(i.yPix-i.pt.yPix)):1,u=(this.deviceHeight,l),p=h;r||(u=l-this.gpuPickingTolerance,p=h-this.gpuPickingTolerance,c=2*this.gpuPickingTolerance+1,d=2*this.gpuPickingTolerance+1);var f=new Uint8Array(4*c*d);this.renderer.readPixelCustom(0,0,c,d,t.RGBAFormat,t.UnsignedByteType,f,this.mainComposer);var g=new Map,m=r?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(s=0;s<c;++s)for(a=0;a<d;++a)if(!(0===(n=f[o=4*(a*c+s)]<<16|f[o+1]<<8|f[o+2])||n>16777215)){var v=n%5;if(0!==v&&(v>3?n=n+5-v:v<3?n-=v:n=void 0),0!==n&&void 0!==n)if(r){if(_=this.meshesGPU[(p+d-a-1)*this.deviceWidth+u+s+this._pickingVPid])if(g.has(_.object))g.get(_.object).add(n);else(y=new Set).add(n),g.set(_.object,y)}else{var _,y,S=s+u-l,b=a+p-h;if(S*S+b*b<m)if(_=this.meshesGPU[(p+d-a-1)*this.deviceWidth+u+s+this._pickingVPid])if(g.has(_.object))g.get(_.object).add(n);else(y=new Set).add(n),g.set(_.object,y)}}return g},computePositionPickSmallTarget:function(e,i,r,n){var s,a,o,l=r.xPix,h=r.yPix,c=void 0!==r.xDev?r.xDev:0,d=void 0!==r.yDev?r.yDev:0,u=(this.deviceHeight,new Uint8Array(4)),p=2*this.gpuPickingTolerance+1;if(this.renderer.readPixelCustom(c,p-d-1,1,1,t.RGBAFormat,t.UnsignedByteType,u,this.mainComposer),o=(a=new Float32Array(u.buffer))[0]?this.webgpu?a[0]:2*a[0]-1:1,i._viewpoint&&!n){let e=new t.Vector2(r.xPix,r.yPix);e.divideScalar(this.devicePixelRatio),e=i._viewpoint._convertViewportToNDC(e),s=new t.Vector4(e.x,e.y,o,1)}else s=new t.Vector4(r.x,r.y,o,1);s.applyMatrix4(i.realProjectionMatrixInverse),s.multiplyScalar(1/s.w),s.applyMatrix4(i.matrixWorld),this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid]=s.clone();for(var f=0;f<e.length;++f)e[f].point=new t.Vector3(s.x,s.y,s.z)},computeNormalPickSmallTarget:function(e,i,r){var n,s=r.xPix,a=r.yPix,o=r.xDev?r.xDev:0,l=r.yDev?r.yDev:0,h=(this.deviceHeight,new Uint8Array(4)),c=2*this.gpuPickingTolerance+1;this.renderer.readPixelCustom(o,c-l-1,1,1,t.RGBAFormat,t.UnsignedByteType,h,this.mainComposer);var d=(n=new t.Vector4(h[0]/255*2-1,h[1]/255*2-1,h[2]/255*2-1,0)).x,u=n.y,p=n.z,f=i.matrixWorld.elements,g=1/(f[3]*d+f[7]*u+f[11]*p+f[15]);n.x=(f[0]*d+f[4]*u+f[8]*p)*g,n.y=(f[1]*d+f[5]*u+f[9]*p)*g,n.z=(f[2]*d+f[6]*u+f[10]*p)*g,this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid]=n.clone();for(var m=0;m<e.length;++m)e[m].normal=new t.Vector3(n.x,n.y,n.z),e[m].tangent=null},computeFloatPositionPick:function(e,i,r,n,s){r.xPix,r.yPix;let a,o;{let e=[],i=new Map,r=0,l=0;for(let s=0;s<n[0].length;s++){if(!isNaN(n[0][s])){let a=new t.Vector3(n[0][s],n[1][s],n[2][s]),o=a.x+","+a.y+","+a.z;if(!i.has(o)){let t=(r-this.heuristicNormalRadius)*(r-this.heuristicNormalRadius)+(l-this.heuristicNormalRadius)*(l-this.heuristicNormalRadius),n=null;i.set(o,!0),e.push({pos:a,screensqdist:t,vec:n})}}r=(r+1)%(2*this.heuristicNormalRadius+1),0==r&&l++}let h=99999999999,c=null;for(let t=0;t<e.length;t++)e[t].screensqdist<h&&(h=e[t].screensqdist,c=t);if(a=new t.Vector4(0,0,0,1),o=new t.Vector3(0,0,0),null!=c){let i=e[c];if(e.splice(c,1),e.length>4){for(let r=0;r<e.length;r++)e[r].vec=(new t.Vector3).subVectors(i.pos,e[r].pos);let r=4*e[2].vec.lengthSq(),n=[];for(let t=1;t<e.length;t++)e[t].vec.lengthSq()<r&&n.push(e[t]);let a=new t.Vector3,l=new t.Vector3;for(let e=1;e<n.length;e++){let t,i;e==n.length-1?(t=n[e].vec,i=n[0].vec):(t=n[e-1].vec,i=n[e].vec),t.normalize(),i.normalize(),l.subVectors(i,t),l.length()<.1||(a.crossVectors(t,i),a.normalize(),a.dot(s.direction)>0&&a.negate(),o.add(a))}o.normalize()}a=new t.Vector4(i.pos.x,i.pos.y,i.pos.z,1),o=new t.Vector4(o.x,o.y,o.z,1)}this.positionsFloatGPU[l*this.deviceWidth+r+this._pickingVPid]=a.clone(),this.heuristicNormalsGPU[l*this.deviceWidth+r+this._pickingVPid]=o.clone()}for(var l=0;l<e.length;++l)e[l].point=new t.Vector3(a.x,a.y,a.z),e[l].normal=new t.Vector3(o.x,o.y,o.z)},getObjectById:function(e,t){var i,r,n;if(e.pickingID===t)return e;for(i=0,r=e.children.length;i<r;i++)if(null!==(n=this.getObjectById(e.children[i],t)))return n;return null},insertComposer:function(e,t){if(!this.mobile||te.has(t.name)){if(null!==e&&this.composers.push(e),t.disabledByDefault=!0,this.mainComposer.addPass(t),t.name.includes("Auxiliary")?this.auxiliaryViewpointComposerContext.enablePass(t,!0):this.compForwardComposerContext.enablePass(t,!0),"HighlightEffect"===t.name){this.highlightPass=t;let e=new u(this.renderer,this.renderTargetPool,null,"Auxiliary");e.initEffect(!0,this),this.auxiliaryHighlights.push(e)}else if("Canvas2DHighlightEffect"===t.name||"PreHighlightEffect"===t.name||"Canvas2DPreHighlight"===t.name){let e=t.name.includes("Canvas");if(t.name.includes("Pre")){let i=t.name.split("Pre")[0],r=new A(this.renderer,this.renderTargetPool,e?"canvas2D":null,"Auxiliary"+i);r.initEffect(!0,this),this.auxiliaryHighlights.push(r)}else{let i=t.name.split("Highlight")[0],r=new u(this.renderer,this.renderTargetPool,e?"canvas2D":null,"Auxiliary"+i);r.initEffect(!0,this),this.auxiliaryHighlights.push(r)}}this.updateFinalComposer(!0)}},updateFinalComposer:function(e){if(this.mobile)return;var t=this.mainComposer,i=[this.compForwardComposerContext,this.auxiliaryViewpointComposerContext];if(!t)return;let s=e?1:0;this.multiViewpoint&&(s=2);var a,o,l,h=t.getAllPasses(),c=h.length;for(let e=0;e<i.length;e++){let t=i[e];if(t){for(a=0;a<c;a++)t.setPassRenderToCanvas(h[a],0);for(a=c-1;a>=0;a--)if(l=h[a],t.passStates[a].enabled&&l instanceof n){t.setPassRenderToCanvas(l,s);break}for(o=c-1;o>=0&&(l=h[o],!(t.passStates[o].enabled&&l instanceof n));o--)t.passStates[o].enabled&&(l instanceof r||l instanceof I)&&t.setPassRenderToCanvas(l,s)}}},getComposer:function(e){if("normalDepthIoRRoughness"===e)return this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.normalDepthIoRRoughnessComposerContext;if("normalDepth"===e)return this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.normalDepthComposerContext;if("HighlightDepth"===e)return this.highlightDepthComposerContext||this.initComposer("HighlightDepth"),this.highlightDepthComposerContext;if("Depth"===e)return this.depthComposerContext||this.initComposer("Depth"),this.depthComposerContext;if("result"===e)return this.compForwardComposerContext;if("previousColor"===e){if(this.TAAEffect&&this.TAAEffect.enabled)return this.TAAEffect.composers[0].composerContext;if(this.MSAAEffect&&this.MSAAEffect.enabled)return this.MSAAEffect.composers[0].composerContext}else{if("opaque"===e)return this.opaqueOnlyComposerContext||this.initComposer("Opaque"),this.opaqueOnlyComposerContext;if("color"===e)return this.colorComposerContext||this.initComposer("Color"),this.colorComposerContext}return null},getInfos:function(){var e={},i=this.renderer.info.renderMap.get(t._FrameTypes.MAIN);if(i){var r={};Object.assign(r,i.getCulling()),Object.assign(r,i.getRendering()),Object.assign(r,i.getGeometries()),Object.assign(e,{memory:this.renderer.info.memory.getMemory(),render:r})}return e},setScale:function(e,i){let r=this.renderTargetPool;e&&(this.renderTargetPool.resetRenderTargetPool(),r=null);var n="FSAA"===this.antiAliasing||"SSAA"===this.antiAliasing?2:1,s="true"===localStorage.getItem("__HALF_RES_SSAO__")?.707:1,a="true"===localStorage.getItem("__HALF_RES_RAYMARCHING__")?.707:1,o="true"===localStorage.getItem("__HALF_RES_MIRROR__")?.707:1;s="true"===localStorage.getItem("__QUARTER_RES_SSAO__")?.5:s,a="true"===localStorage.getItem("__QUARTER_RES_RAYMARCHING__")?.5:a,o="true"===localStorage.getItem("__QUARTER_RES_MIRROR__")?.5:o;var l=1;if(this.mobile){var h=this.renderer._renderScale*t.getDevicePixelRatio();h>1&&(s/=h,a/=h,o/=h,l/=h)}if(this.compForwardComposerContext&&(this.compForwardComposerContext.setSize(n*this.viewportWidth,n*this.viewportHeight,i,r),this.compForwardComposerContext._internalScaleForViewport=n),this.compMirrorComposerContext&&(this.compMirrorComposerContext.setSize(o*n*this.viewportWidth,o*n*this.viewportHeight,i,r),this.compMirrorComposerContext._internalScaleForViewport=o*n),this.normalDepthIoRRoughnessComposerContext&&(this.normalDepthIoRRoughnessComposerContext.setSize(l*this.viewportWidth,l*this.viewportHeight,i,r),this.normalDepthIoRRoughnessComposerContext._internalScaleForViewport=l),this.normalDepthComposerContext&&(this.normalDepthComposerContext.setSize(l*this.viewportWidth,l*this.viewportHeight,i,r),this.normalDepthComposerContext._internalScaleForViewport=l),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight,i,r),this.mirrorOutlineDepthComposerContext&&(this.mirrorOutlineDepthComposerContext.setSize(o*this.viewportWidth,o*this.viewportHeight,i,r),this.mirrorOutlineDepthComposerContext._internalScaleForViewport=o),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight,i,r),this.opaqueOnlyComposerContext&&(this.opaqueOnlyComposerContext.setSize(l*this.viewportWidth,l*this.viewportHeight,i,r),this.opaqueOnlyComposerContext._internalScaleForViewport=l),this.colorComposerContext&&(this.colorComposerContext.setSize(l*this.viewportWidth,l*this.viewportHeight,i,r),this.colorComposerContext._internalScaleForViewport=l),!this.smallTargetPicking&&e&&(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight,i,r),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(this.viewportWidth,this.viewportHeight,i,r),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight,i,r),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight,i,r),this.gpuPositionComposerContext))for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(this.viewportWidth,this.viewportHeight,i,r);this.auxiliaryViewpointComposerContext&&(this.auxiliaryViewpointComposerContext.setSize(this.viewportWidth*n,this.viewportHeight*n,i,r),this.auxiliaryViewpointComposerContext._internalScaleForViewport=n),this.FXAAEffect&&this.FXAAEffect.enabled&&this.FXAAEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.TexturePerformanceEffect&&this.TexturePerformanceEffect.enabled&&this.TexturePerformanceEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.PixelShaderPerformanceEffect&&this.PixelShaderPerformanceEffect.enabled&&this.PixelShaderPerformanceEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.setSize(this.viewportWidth,this.viewportHeight,r,i),this.SMAAEffect&&this.SMAAEffect.enabled&&this.SMAAEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.setSize(s*this.viewportWidth,s*this.viewportHeight,i,r),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.setSize(s*this.viewportWidth,s*this.viewportHeight,i,r),this.FakeOutlinesEffect&&this.FakeOutlinesEffect.enabled&&this.FakeOutlinesEffect.setSize(this.viewportWidth,this.viewportHeight,i,r),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.setSize(a*this.viewportWidth,a*this.viewportHeight,r),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.setSize(a*this.viewportWidth,a*this.viewportHeight,r),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.PointCloudEffect&&this.PointCloudEffect.enabled&&this.PointCloudEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.FlareEffect&&this.FlareEffect.enabled&&this.FlareEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,r);for(let e=0;e<this.auxiliaryHighlights.length;e++)this.auxiliaryHighlights[e].enabled&&this.auxiliaryHighlights[e].setSize(this.viewportWidth,this.viewportHeight,r);this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.GaussianSplatEffect&&this.GaussianSplatEffect.enabled&&this.GaussianSplatEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.DebugPassEffect&&this.DebugPassEffect.enabled&&this.DebugPassEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.setSize(this.viewportWidth,this.viewportHeight,r),this.OITEffect&&this.OITEffect.enabled&&this.OITEffect.setSize(n*this.viewportWidth,n*this.viewportHeight,r),this.OITnoZEffect&&this.OITnoZEffect.enabled&&this.OITnoZEffect.setSize(n*this.viewportWidth,n*this.viewportHeight,r),this.OITLinkedListEffect&&this.OITLinkedListEffect.enabled&&this.OITLinkedListEffect.setSize(n*this.viewportWidth,n*this.viewportHeight,r),this.OITnoZLinkedListEffect&&this.OITnoZLinkedListEffect.enabled&&this.OITnoZLinkedListEffect.setSize(n*this.viewportWidth,n*this.viewportHeight,r),this.XRevealStructureEffect&&this.XRevealStructureEffect.enabled&&this.XRevealStructureEffect.setSize(this.viewportWidth,this.viewportHeight,r);for(var c=0;c<this.customEffects.length;c++){var d=this.customEffects[c];d&&d.enabled&&d.setSize(this.viewportWidth,this.viewportHeight,r)}if(null!==this.passMirrorBlur){const e=new t.Vector2(1/this.viewportWidth,1/this.viewportHeight);this.passMirrorBlur.material.setUniform("invSize",e),this.passMirrorBlur1.material.setUniform("invSize",e),this.passMirrorBlur2.material.setUniform("invSize",e),this.passMirrorBlur3.material.setUniform("invSize",e)}},initComposer:function(e,i){var r;switch(e){case"Mirror":var n=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear");n.depthSampled=this.webgpu,this.compMirrorComposerContext=new D(n,this.mainComposer,"compMirrorComposerContext"),this.compMirrorComposerContext.linkToShaderPassUniform(this.mirrorBlendPass,this.mirrorBlendPass.getInput(1)),this.compMirrorComposerContext.enablePass(this.mirrorBlendPass,!1),this.compMirrorComposerContext.enablePass(this.mirrorClearDepth,!1),this.compMirrorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(!0),this.compMirrorComposerContext.enablePass(this.infPlanePass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotOrthoPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compMirrorComposerContext.enablePass(this.nozPass,!1),this.compMirrorComposerContext.setPassClear(this.nozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectAfterHighlightNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.dialogPass,!1),this.compMirrorComposerContext.enablePass(this.furtivePass,!1),this.compMirrorComposerContext.setPassClear(this.furtiveClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compMirrorComposerContext.setCameraName("mirrorCamera"),this.compMirrorComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_MIRRORDISABLED,r=this.compMirrorComposerContext;break;case"Shadow":this.shadowComposerContext=new D(null,this.mainComposer,"shadowComposerContext"),this.shadowComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.shadowComposerContext,null,null,!1),this.shadowComposerContext._checkCamera=!0,r=this.shadowComposerContext;break;case"Depth":var s;(s=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest")).generateMipmaps=!1,this.depthComposerContext=new D(s,this.mainComposer,"depthComposerContext"),this.setupOneMaterialComposerContext(this.depthComposerContext,0,0,!0),r=this.depthComposerContext;break;case"Normal":var a;a=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest"),this.normalComposerContext=new D(a,this.mainComposer,"normalComposerContext"),this.setupOneMaterialComposerContext(this.normalComposerContext,0,1,!0),r=this.normalComposerContext;break;case"NormalDepth":(o=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"maxPrecisionNearest")).generateMipmaps=!1,this.normalDepthComposerContext=new D(o,this.mainComposer,"normalDepthComposerContext"),this.normalDepthComposerContext.keepResult=!0,this.normalDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.ONLY_LIGHTED,this.normalDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.normalDepthComposerContext;break;case"NormalDepthIoRRoughness":var o;(o=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest")).generateMipmaps=!1,this.normalDepthIoRRoughnessComposerContext=new D(o,this.mainComposer,"normalDepthIoRRoughnessComposerContext"),this.normalDepthIoRRoughnessComposerContext._forbidRenderableState=t._ForbidRenderableStates.ONLY_LIGHTED,this.normalDepthIoRRoughnessComposerContext.keepResult=!0,this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthIoRRoughnessComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthIoRRoughnessComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.normalDepthIoRRoughnessComposerContext;break;case"OutlineDepth":var l=this.renderer.supportsFloatTextures();(h=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,l?"nearest":"uintNearest")).generateMipmaps=!1,this.outlineDepthComposerContext=new D(h,this.mainComposer,"outlineDepthComposerContext"),this.outlineDepthComposerContext.keepResult=!0,this.outlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.outlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.outlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.outlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.outlineDepthComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.outlineDepthComposerContext;break;case"MirrorOutlineDepth":var h;l=this.renderer.supportsFloatTextures();(h=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,l?"nearest":"uintNearest")).generateMipmaps=!1,this.mirrorOutlineDepthComposerContext=new D(h,this.mainComposer,"mirrorOutlineDepthComposerContext"),this.mirrorOutlineDepthComposerContext.keepResult=!0,this.mirrorOutlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.mirrorOutlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.mirrorOutlineDepthComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.mirrorOutlineDepthComposerContext;break;case"OcclusionDepth":var c=new t.WebGLRenderTargetProperties(this.getQuarterWidth(),this.getQuarterHeight(),"uintNearest");c.generateMipmaps=!1,this.occlusionDepthComposerContext=new D(c,this.mainComposer,"occlusionDepthComposerContext"),this.occlusionDepthComposerContext.keepResult=!0,this.occlusionDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE|t._ForbidRenderableStates.DISABLE_KEEP_OCCLUSION_OPACITY_OVERRIDES,this.occlusionDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.occlusionDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.infPlanePass,!1),this.occlusionDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.occlusionDepthComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.occlusionDepthComposerContext;break;case"HighlightDepth":var d=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest");d.generateMipmaps=!1,this.highlightDepthComposerContext=new D(d,this.mainComposer,"highlightDepthComposerContext"),this.highlightDepthComposerContext.keepResult=!0,this.highlightDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE|t._ForbidRenderableStates.NO_EDGES_IF_HAS_FACES,this.highlightDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.highlightDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.infPlanePass,!1),this.highlightDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.highlightDepthComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.highlightDepthComposerContext;break;case"Opaque":var u=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"halfNearest");u.generateMipmaps=!1,this.opaqueOnlyComposerContext=new D(u,this.mainComposer,"opaqueOnlyComposerContext"),this.opaqueOnlyComposerContext.keepResult=!0,this.opaqueOnlyComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.ONLY_LIGHTED,this.opaqueOnlyComposerContext.enablePass(this.mirrorBlendPass,!1),this.opaqueOnlyComposerContext.enablePass(this.mirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.infPlanePass,!1),this.opaqueOnlyComposerContext.setRenderPlugins(this.forwardPass,!1),this.opaqueOnlyComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.opaqueOnlyComposerContext;break;case"Color":var p=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"halfNearest");p.generateMipmaps=!1,this.colorComposerContext=new D(p,this.mainComposer,"colorComposerContext"),this.colorComposerContext.keepResult=!0,this.colorComposerContext._forbidRenderableState=t._ForbidRenderableStates.ONLY_LIGHTED,this.colorComposerContext.enablePass(this.mirrorBlendPass,!1),this.colorComposerContext.enablePass(this.mirrorClearDepth,!1),this.colorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.colorComposerContext.enablePass(this.infPlanePass,!1),this.colorComposerContext.setRenderPlugins(this.forwardPass,!1),this.colorComposerContext.setOnEffectComposerChangeCallback((function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)})),r=this.colorComposerContext;break;case"PickingGPUInstancing":(f=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUInstancingComposerContext=new D(f,this.mainComposer,"pickingGPUInstancingComposerContext"),this.setupOneMaterialComposerContext(this.pickingGPUInstancingComposerContext,0,1,!0),this.pickingGPUInstancingComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,r=this.pickingGPUInstancingComposerContext;break;case"PickingGPU":var f;(f=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUComposerContext=new D(f,this.mainComposer,"pickingGPUComposerContext"),this.pickingGPUComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.pickingGPUComposerContext,0,1,!0),r=this.pickingGPUComposerContext;break;case"auxiliaryViewpoint":let e=null;this.auxiliaryViewpointComposerContext=new D(e,this.mainComposer,"auxiliaryViewpointComposerContext");for(var g,m=this.mainComposer.getAllPasses(),v=0;v<m.length;v++)g=m[v],this.auxiliaryViewpointComposerContext.enablePass(g,!1);this.auxiliaryViewpointComposerContext.enablePass(this.initClearPass,!0),this.auxiliaryViewpointComposerContext.setPassClear(this.initClearPass,!1),this.auxiliaryViewpointComposerContext.setPassClearDepth(this.initClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.forwardPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.setPassClear(this.nozClearPass,!1),this.auxiliaryViewpointComposerContext.setPassClearDepth(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.noEffectAfterHighlightNozPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.furtivePass,!0);break;case"GPUPosition":var _;let y=1,S=3;(this.renderer.supportsDrawBuffers()||this.renderer.use_webgpu)&&(y=3,S=1),(_=i?new t.WebGLRenderTargetProperties(2*this.heuristicNormalRadius+1,2*this.heuristicNormalRadius+1,"uintNearest",y):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest",y)).generateMipmaps=!1,this.gpuPositionComposerContext=[];for(let e=0;e<S;e++)this.gpuPositionComposerContext[e]=new D(_,this.mainComposer,"GPUPositionComposerContext"),this.gpuPositionComposerContext[e]._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.gpuPositionComposerContext[e],16777215,1,!0);r=this.gpuPositionComposerContext}var y=this.compForwardComposerContext.getPassState(this.zPostPass);if(this.__enablePassOnAllComposerContexts(this.zPostPass,y.enabled),r){if(this._HighlightMobileNonEffect)if(r.length)for(let e=0;e<r.length;e++)this._HighlightMobileNonEffect.disableOnComposer(r[e]);else this._HighlightMobileNonEffect.disableOnComposer(r);if(this._PreHighlightMobileNonEffect)if(r.length)for(let e=0;e<r.length;e++)this._PreHighlightMobileNonEffect.disableOnComposer(r[e]);else this._PreHighlightMobileNonEffect.disableOnComposer(r)}},setupOneMaterialComposerContext:function(e,i,r,n){if(e.keepResult=!0,n){e.setPassClear(this.initClearPass,!0,new t.Color(i),r);for(var s=this.mainComposer.getAllPasses(),a=0;a<s.length;a++)(o=s[a]).renderCuttingElements&&e.enablePass(o,!1)}else{var o;for(s=this.mainComposer.getAllPasses(),a=0;a<s.length;a++)o=s[a],e.enablePass(o,!1);e.enablePass(this.forwardPass,!0)}e.enablePass(this.infPlanePass,!1),e.enablePass(this.mirrorBlendPass,!1),e.enablePass(this.mirrorClearDepth,!1),e.enablePass(this.afterMirrorClearDepth,!1),n&&(e.enablePass(this.noEffectRobotClearPass,!0),e.setPassClear(this.noEffectRobotClearPass,!1),e.setPassClearDepth(this.noEffectRobotClearPass,!0),e.enablePass(this.noEffectRobotPass,!0),e.enablePass(this.noEffectRobotOrthoPass,!0),e.enablePass(this.noEffectCanvas2DPass,!0)),n&&(e.enablePass(this.nozClearPass,!0),e.setPassClear(this.nozClearPass,!1),e.setPassClearDepth(this.nozClearPass,!0)),e.enablePass(this.nozPass,!0),n&&(e.enablePass(this.noEffectNozClearPass,!0),e.setPassClear(this.noEffectNozClearPass,!1),e.setPassClearDepth(this.noEffectNozClearPass,!0)),e.enablePass(this.noEffectNozPass,!0),n&&(e.enablePass(this.noEffectAfterHighlightNozClearPass,!0),e.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),e.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0)),e.enablePass(this.noEffectAfterHighlightNozPass,!0),e.enablePass(this.dialogPass,!0),n&&(e.enablePass(this.furtiveClearPass,!0),e.setPassClear(this.furtiveClearPass,!1),e.setPassClearDepth(this.furtiveClearPass,!0)),e.enablePass(this.furtivePass,!1),this.NativeOnTopEffect.disablePasses(e),n&&(e.enablePass(this.noEffectCanvas2DClearPass,!0),e.setPassClear(this.noEffectCanvas2DClearPass,!1),e.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)),e.setRenderPlugins(this.forwardPass,!1)},initForwardRender:function(){var e=null;this.initClearPass=new I("initClearPass"),this.infPlanePass=new r(null,null,null,U.facesMask,null,null,"infPlanePass"),this.infPlanePass.lockScene=!0,this.infPlanePass.setCameraName("cameraBackground"),this.zPostPass=new r(null,null,null,null,null,null,"zPostPass"),this.zPostPass.setDisableDepthWrite(!0),this.zPostPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DEFAULT,this.zPostPass.disabledByDefault=!0,this.forwardPass=new r(null,null,null,null,null,null,"forwardPass"),this.occlusionPass=new s(null,"occlusionPass"),this.cssPass=new G(null,"cssPass"),this.backgroundPass=new r(null,null,null,U.facesMask,null,null,"backgroundPass"),this.backgroundPass.idString="background",this.ZOnlyPass=new r(null,null,null,null,null,null,"ZOnlyPass"),this.ZOnlyPass.idString="ZOnly",this.forwardPass.addDLsToDisableFunc((e=>h.PointCloudEffect&&h.PointCloudEffect.hasPointCloud()?e.postOIT||e.canOIT:e.postOIT));const i=new r(null,null,null,null,null,null,"transparForwardPass");i.addDLsToDisableFunc((e=>!h.PointCloudEffect||!h.PointCloudEffect.hasPointCloud()||!e.canOIT)),this.forwardPass.addSubPass(i);const l=new r(null,null,null,null,null,null,"postTransparForwardPass");l.addDLsToDisableFunc((e=>!e.postOIT)),this.forwardPass.addSubPass(l),this.zPostPass.addDLsToDisableFunc((e=>h.PointCloudEffect&&h.PointCloudEffect.hasPointCloud()?e.postOIT||e.canOIT:e.postOIT)),this.zPostPass.setStateSortingResultFrom(this.forwardPass,!1),this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.mirrorBlendPass=new n(a.Blend,"mirrorBlendPass"),this.mirrorBlendPass.material.enableMSAA(this.renderer.use_webgpu&&"GPUAA"===this.renderer.antialias),this.useCompositing&&((e=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear")).depthSampled=this.webgpu),this.useCompositing||(this.mirrorBlendPass.disabledByDefault=!0,this.mirrorBlendPass.needsSwap=!1,this.mirrorBlendPass.material.defines.POSTPRO=0,this.mirrorBlendPass.material.transparent=!0,this.mirrorBlendPass.material.needsUpdate=!0),this.compForwardComposerContext=new D(e,this.mainComposer,"compForwardComposerContext"),this.compForwardComposerContext.keepResult=!0,this.mainComposer.addPass(this.initClearPass),this.mainComposer.addPass(this.infPlanePass),null!==this.mirrorBlendPass&&(this.mirrorClearDepth=new I("mirrorClearDepth"),this.mirrorClearDepth.clear=!1,this.mirrorClearDepth.setClearDepth(!1),this.afterMirrorClearDepth=new I("afterMirrorClearDepth"),this.mainComposer.addPass(this.mirrorBlendPass),this.mainComposer.addPass(this.afterMirrorClearDepth)),this.passSectionCappingFrontFaces=new r(null,null,null,void 0,!1,!1,"passSectionCappingFrontFaces"),this.passSectionCappingFrontFaces.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces.setEnableStencilTest(!0),this.passSectionCappingFrontFaces.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces.setDisableColorWrite(!0),this.passSectionCappingFrontFaces.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces.ignoreNoZ=!0,this.mainComposer.addPass(this.cssPass),this.mainComposer.addPass(this.forwardPass),this.mainComposer.addPass(this.occlusionPass),this.mainComposer.addPass(this.zPostPass),this.mainComposer.addPass(this.backgroundPass),this.mainComposer.addPass(this.ZOnlyPass),this.mainComposer.addPass(this.passSectionCappingFrontFaces),this.ZOnlyPassCapping=new r(null,null,null,void 0,!1,!1,"ZOnlyPassCapping"),this.ZOnlyPassCapping.setRenderCuttingElements(!0),this.ZOnlyPassCapping.setEnableStencilTest(!0),this.ZOnlyPassCapping.setEnableStencilWrite(!0),this.ZOnlyPassCapping.setDisableColorWrite(!0),this.ZOnlyPassCapping.setDisableDepthWrite(!0),this.ZOnlyPassCapping.setStencilFunc("ALWAYS"),this.ZOnlyPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.ZOnlyPassCapping.setDisableBackFaceCulling(!0),this.ZOnlyPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.ZOnlyPassCapping.setDisableBackFaceClipPlanes(1),this.ZOnlyPassCapping.setRenderPluginsPre(!1),this.ZOnlyPassCapping.setRenderPluginsPost(!1),this.ZOnlyPassCapping.ignoreNoZ=!0,this.ZOnlyPassCapping.idString="ZOnly",this.mainComposer.addPass(this.ZOnlyPassCapping),this.backgroundPassCapping=new r(null,null,null,void 0,!1,!1,"backgroundPassCapping"),this.backgroundPassCapping.setRenderCuttingElements(!0),this.backgroundPassCapping.setEnableStencilTest(!0),this.backgroundPassCapping.setEnableStencilWrite(!0),this.backgroundPassCapping.setDisableColorWrite(!0),this.backgroundPassCapping.setDisableDepthWrite(!0),this.backgroundPassCapping.setStencilFunc("ALWAYS"),this.backgroundPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.backgroundPassCapping.setDisableBackFaceCulling(!0),this.backgroundPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.backgroundPassCapping.setDisableBackFaceClipPlanes(1),this.backgroundPassCapping.setRenderPluginsPre(!1),this.backgroundPassCapping.setRenderPluginsPost(!1),this.backgroundPassCapping.ignoreNoZ=!0,this.backgroundPassCapping.idString="background",this.mainComposer.addPass(this.backgroundPassCapping),this.clearScreenSpacePass=new r(null,null,null,null,null,null,"clearScreenSpacePass"),this.clearScreenSpacePass.setDisableColorWrite(!0),this.clearScreenSpacePass.setDisableDepthWrite(!0),this.clearScreenSpacePass.idString="__clearScreenSpacePass__",this.clearScreenSpacePass.disabledByDefault=!0;var h=this;this.clearScreenSpacePass._postRenderCB=function(){(h.renderer.aoBuffer||h.renderer.reflectionColorBuffer||h.renderer.refractionColorBuffer)&&h.renderer.resetUpdatedUBOs(),h.renderer.aoBuffer=null,h.renderer.reflectionColorBuffer=null,h.renderer.refractionColorBuffer=null},this.mainComposer.addPass(this.clearScreenSpacePass),this.compForwardComposerContext.enablePass(this.zPostPass,!1),this.compForwardComposerContext.setRenderPlugins(this.forwardPass,!0),this.compForwardComposerContext.enablePass(this.occlusionPass,!!this.webgpu),this.compForwardComposerContext.enablePass(this.clearScreenSpacePass,!0),this.compForwardComposerContext.enablePass(this.backgroundPass,!0),this.compForwardComposerContext.enablePass(this.ZOnlyPass,!0),this.compForwardComposerContext.enablePass(this.cssPass,!0),this.passMirrorBlur=new n(o.BlurPoisson,"passMirrorBlur"),this.passMirrorBlur.disabledByDefault=!0,this.passMirrorBlur1=new n(o.BlurPoisson,"passMirrorBlur1"),this.passMirrorBlur1.disabledByDefault=!0,this.passMirrorBlur2=new n(o.BlurPoisson,"passMirrorBlur2"),this.passMirrorBlur2.disabledByDefault=!0,this.passMirrorBlur3=new n(o.BlurPoisson,"passMirrorBlur3"),this.passMirrorBlur3.disabledByDefault=!0;const c=new t.Vector2(1/this.viewportWidth,1/this.viewportHeight);(this.passMirrorBlur.material.setUniform("invSize",c),this.passMirrorBlur1.material.setUniform("invSize",c),this.passMirrorBlur2.material.setUniform("invSize",c),this.passMirrorBlur3.material.setUniform("invSize",c),this.mainComposer.addPass(this.passMirrorBlur),this.mainComposer.addPass(this.passMirrorBlur1),this.mainComposer.addPass(this.passMirrorBlur2),this.mainComposer.addPass(this.passMirrorBlur3),this.nozClearPass=new I("nozClearPass"),this.nozClearPass.idString="noz",this.nozPass=new r(null,null,null,void 0,void 0,void 0,"nozPass"),this.nozPass.idString="noz",this.mainComposer.addPass(this.nozClearPass),this.mainComposer.addPass(this.nozPass),this.compositePrePass=new R("compositePrePass"),this.compositePrePass.setCallback((function(e){e.enableInlinedPostProcess=!0})),this.compositePostPass=new R("compositePostPass"),this.compositePostPass.setCallback((function(e){e.enableInlinedPostProcess=!1})),this.mainComposer.addPass(this.compositePrePass),this.mainComposer.addPass(this.compositePostPass),this.noEffectNozClearPass=new I("noEffectNozClearPass"),this.noEffectNozClearPass.idString="noEffectNoz",this.noEffectNozPass=new r(null,null,null,void 0,void 0,void 0,"noEffectNozPass"),this.noEffectNozPass.idString="noEffectNoz",this.mainComposer.addPass(this.noEffectNozClearPass),this.mainComposer.addPass(this.noEffectNozPass),this.noEffectAfterHighlightNozClearPass=new I("noEffectAfterHighlightNozClearPass"),this.noEffectAfterHighlightNozClearPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozClearPass.order=60,this.noEffectAfterHighlightNozPass=new r(null,null,null,void 0,void 0,void 0,"noEffectAfterHighlightNozPass"),this.noEffectAfterHighlightNozPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozPass.order=61,this.noEffectAfterHighlightNozPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectAfterHighlightNozClearPass),this.mainComposer.addPass(this.noEffectAfterHighlightNozPass),this.dialogPass=new r(null,null,null,void 0,void 0,void 0,"dialogPass"),this.dialogPass.idString="dialog",this.mainComposer.addPass(this.dialogPass),this.furtiveClearPass=new I("furtiveClearPass"),this.furtiveClearPass.idString="furtive",this.furtivePass=new r(null,null,null,void 0,void 0,void 0,"furtivePass"),this.furtivePass.idString="furtive",this.mainComposer.addPass(this.furtiveClearPass),this.mainComposer.addPass(this.furtivePass),this.noEffectRobotClearPass=new I("noEffectRobotClearPass"),this.noEffectRobotClearPass.order=70,this.noEffectRobotPass=new r(null,null,null,U.facesMask,void 0,void 0,"noEffectRobotPass"),this.noEffectRobotPass.idString="robot",this.noEffectRobotPass.setDisableClippingPlanes(!0),this.noEffectRobotPass.setDisableToneMapping(!0),this.noEffectRobotPass.isRobotPass=!0,this.noEffectRobotPass.setCameraName("connectedRobotCamera"),this.noEffectRobotPass.order=71,this.noEffectRobotPass.setForceMaterialMode(!0),this.noEffectRobotOrthoPass=new r(null,null,null,U.facesMask,void 0,void 0,"noEffectRobotOrthoPass"),this.noEffectRobotOrthoPass.idString="robotOrtho",this.noEffectRobotOrthoPass.setDisableClippingPlanes(!0),this.noEffectRobotOrthoPass.setCameraName("robotCameraOrtho"),this.noEffectRobotOrthoPass.order=72,this.noEffectRobotOrthoPass.isRobotPass=!0,this.noEffectRobotOrthoPass.setDisableToneMapping(!0),this.noEffectRobotOrthoPass.setForceMaterialMode(!0),this.noEffectCanvas2DClearPass=new I("noEffectCanvas2DClearPass"),this.noEffectCanvas2DClearPass.disabledByDefault=!0,this.noEffectCanvas2DClearPass.idString="canvas2D",this.noEffectCanvas2DPass=new r(null,null,null,void 0,void 0,void 0,"noEffectCanvas2DPass"),this.noEffectCanvas2DPass.idString="canvas2D",this.noEffectCanvas2DPass.disabledByDefault=!0,this.noEffectCanvas2DPass.setDisableClippingPlanes(!0),this.noEffectCanvas2DPass.order=1e5,this.noEffectCanvas2DPass.setDisableToneMapping(!0),this.noEffectCanvas2DPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectRobotClearPass),this.mainComposer.addPass(this.noEffectRobotPass),this.mainComposer.addPass(this.noEffectRobotOrthoPass),this.mainComposer.addPass(this.noEffectCanvas2DClearPass),this.mainComposer.addPass(this.noEffectCanvas2DPass),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DPass,!0),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DClearPass,!0),this.initComposer("Mirror"),this.initComposer("auxiliaryViewpoint"),this.useCompositing)&&(new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint").generateMipmaps=!1,this.compositeClearPass=new I("compositeClearPass"),this.compositeClearPass.invertTarget=!0,this.canvas2DPass=new r(null,null,null,void 0,void 0,void 0,"canvas2DPass"),this.canvas2DPass.order=1100,this.canvas2DPass.idString="canvas2D",this.canvas2DPass.setDisableToneMapping(!0),this.canvas2DPass.setDisableClippingPlanes(!0),this.compositeClearPass.order=5,this.setEffect("ToneMapping",!0),this.ToneMappingEffect.setBrightness(this.brightness),this.ToneMappingEffect.setToneMapping(this.tonemapping));this.setEffect("NativeOnTop",!0),this.compForwardComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compForwardComposerContext.setPassClear(this.nozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.furtiveClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectCanvas2DClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)},resetClippingScene:function(){this.clippingScene=null},__enablePassOnAllComposerContexts:function(e,t){this.compForwardComposerContext&&this.compForwardComposerContext.enablePass(e,t),this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(e,t),this.shadowComposerContext&&this.shadowComposerContext.enablePass(e,t),this.depthComposerContext&&this.depthComposerContext.enablePass(e,t),this.normalComposerContext&&this.normalComposerContext.enablePass(e,t),this.normalDepthIoRRoughnessComposerContext&&this.normalDepthIoRRoughnessComposerContext.enablePass(e,t),this.normalDepthComposerContext&&this.normalDepthComposerContext.enablePass(e,t),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.enablePass(e,t),this.mirrorOutlineDepthComposerContext&&this.mirrorOutlineDepthComposerContext.enablePass(e,t),this.occlusionDepthComposerContext&&this.occlusionDepthComposerContext.enablePass(e,t),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.enablePass(e,t),this.opaqueOnlyComposerContext&&this.opaqueOnlyComposerContext.enablePass(e,t),this.colorComposerContext&&this.colorComposerContext.enablePass(e,t),this.pickingGPUComposerContext&&this.pickingGPUComposerContext.enablePass(e,t),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.enablePass(e,t),this.auxiliaryViewpointComposerContext&&this.auxiliaryViewpointComposerContext.enablePass(e,t)},_enableZPrePass:function(e){this.forwardPass&&(this.compForwardComposerContext.getPassState(this.zPostPass).enabled!==e&&(e?(this.forwardPass.setDisableColorWrite(!0),this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.ENABLED,this.__enablePassOnAllComposerContexts(this.zPostPass,!0)):(this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DEFAULT,this.forwardPass.setDisableColorWrite(!1),this.__enablePassOnAllComposerContexts(this.zPostPass,!1))))},dispose:function(){this.compForwardComposerContext&&(this.compForwardComposerContext.dispose(),this.compForwardComposerContext=null),this.compMirrorComposerContext&&(this.compMirrorComposerContext.dispose(),this.compMirrorComposerContext=null),this.shadowComposerContext&&(this.shadowComposerContext.dispose(),this.shadowComposerContext=null),this.depthComposerContext&&(this.depthComposerContext.dispose(),this.depthComposerContext=null),this.normalComposerContext&&(this.normalComposerContext.dispose(),this.normalComposerContext=null),this.normalDepthIoRRoughnessComposerContext&&(this.normalDepthIoRRoughnessComposerContext.dispose(),this.normalDepthIoRRoughnessComposerContext=null),this.normalDepthComposerContext&&(this.normalDepthComposerContext.dispose(),this.normalDepthComposerContext=null),this.outlineDepthComposerContext&&(this.outlineDepthComposerContext.dispose(),this.outlineDepthComposerContext=null),this.mirrorOutlineDepthComposerContext&&(this.mirrorOutlineDepthComposerContext.dispose(),this.mirrorOutlineDepthComposerContext=null),this.occlusionDepthComposerContext&&(this.occlusionDepthComposerContext.dispose(),this.occlusionDepthComposerContext=null),this.highlightDepthComposerContext&&(this.highlightDepthComposerContext.dispose(),this.highlightDepthComposerContext=null),this.opaqueOnlyComposerContext&&(this.opaqueOnlyComposerContext.dispose(),this.opaqueOnlyComposerContext=null),this.colorComposerContext&&(this.colorComposerContext.dispose(),this.colorComposerContext=null),this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.dispose(),this.pickingGPUComposerContext=null),this.pickingGPUInstancingComposerContext&&(this.pickingGPUInstancingComposerContext.dispose(),this.pickingGPUInstancingComposerContext=null),this.auxiliaryViewpointComposerContext&&(this.auxiliaryViewpointComposerContext.dispose(),this.auxiliaryViewpointComposerContext=null),this.lensFlarePass&&(this.lensFlarePass.dispose(),this.lensFlarePass=null);for(var e=0;e<this.allEffects.length;e++)this.allEffects[e]&&this.allEffects[e].dispose&&this.allEffects[e].dispose();for(e=0;e<this.customEffects.length;e++)this.customEffects[e]&&this.customEffects[e].dispose&&this.customEffects[e].dispose();for(var t in this.renderer.fixedSizeArrayPool.dispose(),this.renderTargetPool.resetRenderTargetPool(),this.allEffects=null,this.customEffects=null,this.mainComposer.dispose(),this.renderer.dispose(),this)this.hasOwnProperty(t)&&(this[t]=null)},isDeviceCompatibleWithSSR:function(){return this.renderer.supportsFloatTextures()},isDeviceCompatibleWithSSAO:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},isDeviceCompatibleWithOIT:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},setDisableBackFaceCulling:function(e){this.disableBackFaceCulling=e,this.forwardPass&&(this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling))},clearCameraSystemData:function(){this.superFinalComposer=null},resizeNPOTTexture:function(){this.NoPowerOfTwoEffect||this.initEffect("noPowerOfTwoEffect");for(let i of this.renderer._texturesToResize){var e=new t.NonPowerOfTwoTexture(i,i.mipmaps);this.NoPowerOfTwoEffect.setTextures(e),this.NoPowerOfTwoEffect.copyToDataTexture(this.gl,i),i.format=1021,i.needsUpdate=!0}this.renderer._texturesToResize.clear(),this.NoPowerOfTwoEffect.dispose()},recompileAllShaders:function(e){this.renderer.recompileAllShaders(e)},updateClippingScene:function(e){var i,r=e.getBoundingSphere(),n=new t.Vector3;for(i=0;i<this.clippingScene.children.length;i++){var s=this.clippingScene.children[i],a=s.clippingPlane&&s.clippingPlane.clone();if(a){a.constant+=this.renderer.clipPlanesTolerance,a.projectPoint(r.center,n),s.matrixAutoUpdate=!1,s.matrixWorldNeedsUpdate=!1;var o=a.normal.clone().multiplyScalar(-1),l=(a.constant,new t.Vector3),h=new t.Vector3(1,0,0);Math.abs(o.y)<=.01&&Math.abs(o.z)<=.01&&(h=new t.Vector3(0,1,0)),l.crossVectors(o,h),l.normalize(),h.crossVectors(o,l),s.matrixWorld.set(1*l.x,1*h.x,1*o.x,n.x,1*l.y,1*h.y,1*o.y,n.y,1*l.z,1*h.z,1*o.z,n.z,0,0,0,1)}}},setSectionCappingMaterial:function(e,i){this.resetGSSOCache();var r,n=this.renderer;e.clippingContext||(e.clippingContext={}),e.clippingContext[n.id]||(e.clippingContext[n.id]={useCount:0}),r=e.clippingContext[n.id],i||0===i?i instanceof t.Material?r.sectionCappingMaterial=i.clone():r.sectionCappingMaterial=new t.MeshBasicMaterial({color:new t.Color(i)}):(r.sectionCappingMaterial=t.MaterialUtils.createShinyFaceMaterial({color:new t.Color(0)}),r.sectionCappingMaterial.clipPlaneUseModelMaterial=!0),this.resetClippingScene()},requestClippingUpdate:function(){this.needClippingUpdate=!0},updateClippingGlobals:function(e,i,r,n,s){let a=e.root._getViewer(),o=!1;if(e._needClippingUpdate){var l=r.renderer,h=i.getAllWebGLObjects(l.currentFrameIndex);if(!h)return;e._needClippingUpdate=!1;var c,d,u,p,f,g,m=null,v=0,_=!1,y=0,S=0,b=0;if(n.length>0)for(m=new Set,c=0;c<n.length;c++){let e=n[c];m.add(e)}for(c=0;c<h.length;c++)if(h[c]&&(d=h[c].object._occurrence)){if(u=d.clippingContext){for(p=0;p<u.planes.length;p++){null===m&&(m=new Set);let e=u.planes[p];m.add(e)}u._clipPolyLine&&(u._clipPolyLine.updateBoundingSphere(e.getBoundingSphere()),(g=u._clipPolyLine.getMaxSize())>v&&(v=g),u._clipPolyLine.getCount()>b&&(b=u._clipPolyLine.getCount())),u._getScissorPolyLineSize()>y&&(y=u._getScissorPolyLineSize()),u._getScissorNbPolygons()>S&&(S=u._getScissorNbPolygons()),u.cylinder&&(_=!0)}d.occurrenceRenderingOverride&&((f=d.occurrenceRenderingOverride.clipPolyLine)&&(f.updateBoundingSphere(e.getBoundingSphere()),(g=f.getMaxSize())>v&&(v=g),f.getCount()>b&&(b=f.getCount())),d.occurrenceRenderingOverride.getClipCylinder()&&(_=!0))}var x=!1;l.maxPolyLineSize===v&&l.useClippingCylinder===_&&l.maxScissorSize===y&&l.maxNbScissor===S&&l.maxNbPolyLine===b||(l.maxPolyLineSize=v,l.maxScissorSize=y,l.maxNbScissor=S,l.maxNbPolyLine=b,l.useClippingCylinder=_,x=!0);var w=l.clipPlanes,P=m?m.size:0,C=!1;if(P!==w.length)C=!0;else if(P>0)for(c=0;c<P&&!C;c++)m.has(w[c])||(C=!0);if((_||S>0||b>0||P>0)&&(J.prototype._hasClippingUniform=!0),C){o=!0;var M=l.clipPlanes,E=[];l.clipPlanes=E,m&&m.forEach((function(e){e.upVector||(e.upVector=new t.Vector3(0,0,1)),e.clippingContext||(e.clippingContext={}),e.clippingContext[l.id]||(e.clippingContext[l.id]={}),e.clippingContext[l.id].sectionCappingMaterial||r.setSectionCappingMaterial(e,null),e.clippingContext[l.id].clippingPlaneAdded=!0,E.push(e)})),0!==M.length&&0!==E.length||(x=!0),s&&(s.updateShadowMap=!0),r.resetClippingScene()}m&&(this.clipPlaneInfos&&this.clipPlaneInfos.hasSamePlanesAsPlaneSet(m)||(this.clipPlaneInfos=new he,this.clipPlaneInfos.setFromPlaneSet(m))),x&&(o=!0,l.recompileAllShaders(null))}this.renderer.clippingSphereOptim&&this.clipPlaneInfos&&this.clipPlaneInfos.needGSSOUpdate()&&(o=!0),o&&(this.renderer.resetClippingStatus(),a._oocManager&&!a.isSectionPlaneManipulated()&&a._oocManager._ldhNodeManager.requestUpdate(!0))},updateSectionCappingScene:function(e,i){if(!this.clippingScene){this.clippingScene=new t.Scene,this.clippingScene.autoUpdateScene=!1,this.clippingScene.matrixWorldNeedsUpdate=!1,this.clippingScene.matrixAutoUpdate=!1;var r,n,s=e.getBoundingSphere(),a=this.webgpu?t.createPlaneGeometryDS(50*s.radius,50*s.radius):new t.PlaneGeometry(50*s.radius,50*s.radius);for(n=0;n<this.renderer.clipPlanes.length;n++){var o=(r=this.renderer.clipPlanes[n].clippingContext[this.renderer.id]).sectionCappingMaterial;o&&((o=o.clone()).clipPlaneIndex=n+1);var l=new t.Mesh(a,o||t.MaterialUtils.createShinyFaceMaterial({color:"purple"}));l.clippingPlane=this.renderer.clipPlanes[n],r.clippingMesh=l,this.clippingScene.add(l)}for(n=0;n<i.children.length;n++){var h=i.children[n];h instanceof t.Light&&this.clippingScene.add(h.clone())}}var c,d=this.mainComposer.getAllPasses();for(n=0;n<d.length;n++)(c=d[n]).renderCuttingElements&&c.setCuttingScene(this.clippingScene);this.updateClippingScene(e)},getQuarterWidth:function(){return Math.ceil(.25*this.viewportWidth)},getQuarterHeight:function(){return Math.ceil(.25*this.viewportHeight)}});Object.defineProperty(le.prototype,"gpuPickingTolerance",{get:function(){return this.renderer._gpuPickingTolerance},set:function(e){this.renderer._gpuPickingTolerance=e,this.smallTargetPicking&&(this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUComposerContext.needsUpdate=!0),this.normalComposerContext&&(this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext.needsUpdate=!0),this.depthComposerContext&&(this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext.needsUpdate=!0))}}),Object.defineProperty(le.prototype,"heuristicNormalRadius",{get:function(){return this.renderer._heuristicNormalRadius},set:function(e){if(this.renderer._heuristicNormalRadius=e,this.smallTargetPicking&&this.gpuPositionComposerContext)for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(2*this.heuristicNormalRadius+1,2*this.heuristicNormalRadius+1),this.pickingGPUComposerContext[e].needsUpdate=!0}}),Object.defineProperty(le.prototype,"smallTargetPicking",{get:function(){return this.renderer._smallTargetPicking},set:function(e){if(this.renderer._smallTargetPicking=e,e){if(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext&&this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext&&this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.gpuPositionComposerContext)for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}else if(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.gpuPositionComposerContext)for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(this.viewportWidth,this.viewportHeight)}}),le.testMode=!1;class he{constructor(){this.array=[],this.start=!0}reset(){this.array.length=0}setFromPlaneSet(e){e.forEach((e=>{this.array.push(new ce(e))}))}needGSSOUpdate(){let e,t=!1;for(e=0;e<this.array.length;e++){let i=this.array[e];i.hasMoved()&&(t=!0),i.update()}return this.start&&(t=!1,this.start=!1),t}hasSamePlanesAsPlaneSet(e){let t=!0;return e.forEach((e=>{this.hasPlane(e)||(t=!1)})),this.arePlanesInPlaneSet(e)||(t=!1),t}hasPlane(e){let t;for(t=0;t<this.array.length;t++){if(this.array[t].plane===e)return!0}return!1}arePlanesInPlaneSet(e){let t;for(t=0;t<this.array.length;t++){let i=this.array[t];if(!e.has(i.plane))return!1}return!0}}class ce{constructor(e){this.plane=e,this.previousPlane=new t.Plane}update(){this.previousPlane.copy(this.plane)}hasMoved(){return this.previousPlane.normal.x!==this.plane.normal.x||this.previousPlane.normal.y!==this.plane.normal.y||this.previousPlane.normal.z!==this.plane.normal.z||this.previousPlane.constant!==this.plane.constant}}return le})),define("Visualization/WebGLV6Renderer",["DS/Visualization/WebGLV6Renderer","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/WebGLV6Renderer"),e})),define("DS/Visualization/WebGLViewerEffectSettings",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/QualityManager/QMController","DS/Effects/ESMEffect"],(function(e,t,i,r){"use strict";const n="true"===localStorage.getItem("__WEBVISU_NEW_TRANSPARDL_SORTING__");var s={AntiAliasing:{static:"NoAA",dynamic:"NoAA",override:"NoAA",contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:5,dynamic:6,override:5},LOD:{static:.5,dynamic:3,override:.5},Transparency:{static:"AlphaBlending",dynamic:"AlphaBlending",override:"AlphaBlending"},GroundShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:"PCF",dynamic:"PCF",override:"PCF"},ShadowFilter:{static:"Low",dynamic:"Low",override:"Low"},FlakesQuality:{static:"Low",dynamic:"Low",override:"Low"},DefaultMaterialQuality:{static:"Low",dynamic:"Low",override:"Low"},Downsampling:{static:1,dynamic:1,override:1},GroundReflection:{static:!1,dynamic:!1,override:!1},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},AmbientOcclusion:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowAmbientOcclusion:{static:!0,dynamic:!0,override:!0,contentChecker:!1},AmbientOcclusionNbSamples:{static:8,dynamic:8,override:8},Bloom:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthFlickeringReduction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},InterObjectReflections:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectReflections:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectRefractions:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectRefractions:{static:!0,dynamic:!0,override:!0,contentChecker:!1},AllowPolitenessOnHighlight:{static:t.EffectState.Enabled,dynamic:t.EffectState.Enabled,override:t.EffectState.Enabled,contentChecker:t.EffectState.Enabled},SectionCapping:{static:t.EffectState.Enabled,dynamic:t.EffectState.Auto,override:t.EffectState.Auto,contentChecker:t.EffectState.Enabled}};class a{constructor(e,i){this.viewer=e,this.settings={},this.autoEffectPreviousStates={AllowPolitenessOnHighlight:{static:!0,dynamic:!0,override:!0,contentChecker:!0}},i.useQM?(Object.assign(this.settings,s),Object.assign(this.settings.AllowGroundShadows,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowInterObjectShadows,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowTransparentObjectShadows,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowGroundReflection,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AmbientOcclusionNbSamples,{static:0,dynamic:0,override:0}),Object.assign(this.settings.AllowInterObjectReflections,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowInterObjectRefractions,{static:!1,dynamic:!1,override:!1})):this.settings={AntiAliasing:{static:i.antiAliasing,dynamic:"MSAA"!==i.antiAliasing?i.antiAliasing:"SMAA",override:i.antiAliasing,contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:4.5,dynamic:4.5,override:4.5},LOD:{static:.5,dynamic:3,override:.5},Transparency:{static:i.enableOIT?"WeightedAverage":"AlphaBlending",dynamic:i.enableOIT?"WeightedAverage":"AlphaBlending",override:i.enableOIT?"WeightedAverage":"AlphaBlending"},GroundShadows:{static:i.useGroundShadow,dynamic:i.useGroundShadow,override:i.useGroundShadow,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:i.useShadowMap,dynamic:i.useShadowMap,override:i.useShadowMap,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:i.shadowQuality,dynamic:i.shadowQuality,override:i.shadowQuality},ShadowFilter:{static:i.shadowFilter,dynamic:i.shadowFilter,override:i.shadowFilter},FlakesQuality:i.ODTMode?{static:"Ultra",dynamic:"Ultra",override:"Ultra"}:{static:"High",dynamic:"High",override:"High"},DefaultMaterialQuality:{static:"High",dynamic:"High",override:"High"},Downsampling:{static:1,dynamic:1,override:1},GroundReflection:{static:i.useMirror,dynamic:i.useMirror,override:i.useMirror},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},AmbientOcclusion:{static:i.useSSAO,dynamic:i.useSSAO,override:i.useSSAO,contentChecker:!1},AllowAmbientOcclusion:{static:!0,dynamic:!0,override:!0,contentChecker:!1},AmbientOcclusionNbSamples:{static:16,dynamic:16,override:16},Bloom:{static:i.useBloom,dynamic:i.useBloom,override:i.useBloom,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:i.useDOF,dynamic:i.useDOF,override:i.useDOF,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthFlickeringReduction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},InterObjectReflections:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectReflections:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectRefractions:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectRefractions:{static:!0,dynamic:!0,override:!0,contentChecker:!1},AllowPolitenessOnHighlight:{static:t.EffectState.Enabled,dynamic:t.EffectState.Enabled,override:t.EffectState.Enabled,contentChecker:t.EffectState.Enabled},SectionCapping:{static:t.EffectState.Enabled,dynamic:t.EffectState.Auto,override:t.EffectState.Auto,contentChecker:t.EffectState.Enabled}},t.AutomatedTestsOrWebDriver()&&(this.settings.AllowPolitenessOnHighlight={static:t.EffectState.Enabled,dynamic:t.EffectState.Enabled,override:t.EffectState.Enabled,contentChecker:t.EffectState.Enabled}),this._lqFallback=!1,this._blackListedEffects=new Set,this._lockedSettings=new Map,this._infPlaneVisibilityBackUp=!1}_lockSettings(e){const t=Object.keys(e);for(let i=0;i<t.length;i++){let r=t[i];switch(r){case"DefaultMaterialQuality":const t=e[r];null==t?this._lockedSettings.delete(r):"High"===t||"Low"===t?this._lockedSettings.set(r,{static:t,dynamic:t}):console.warn("Lock Settings: Invalid value "+t+" for DefaultMaterialQuality");break;case"AllowGroundReflection":const i=e[r];null==i?this._lockedSettings.delete(r):!1!==i.static&&!0!==i.static||!1!==i.dynamic&&!0!==i.dynamic?console.warn("Lock Settings: Invalid structure "+i+" for AllowGroundReflection"):this._lockedSettings.set(r,{static:i.static,dynamic:i.dynamic});break;default:console.warn("Lock Settings: Unknown key "+r)}}this.viewer.render()}_checkCompatibility(){this.viewer.renderer.isDeviceCompatibleWithSSR()||(this._blackListedEffects.add("InterObjectRefractions"),this._blackListedEffects.add("InterObjectReflections")),this.viewer.renderer.isDeviceCompatibleWithOIT()||this._blackListedEffects.add("Transparency"),this.viewer.renderer.isDeviceCompatibleWithSSAO()||this._blackListedEffects.add("AmbientOcclusion")}updateViewerSettings(e,r){var n=!1;this.viewer._QMInit&&i.getLinkedPresetStatus()&&("dynamic"===e&&(e="static"),"dynamic"===r&&(r="static",n=!0));var s=this.viewer;this._setAllowPolitenessOnHighlight(e),this._setPixelCulling(e),this._setLOD(e),this._setAntiAliasing(r,n),this._setShadow(e),this._setTransparentShadow(e),this._setShadowFilter(e),this._setShadowQuality(e),this._setGroundShadow(e),this._setOIT(e),this._setFlakesQuality(e),this._setSectionCapping(e),s.renderer.renderer._defaultAppearanceType!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._setDefaultMaterialQuality(e),this._enableZPrePass(e),this._setMirror(e),this._setSSAO(e),this._setBloom(e),this._setDOF(e),this._setSSLR(e),this._setSSLRefraction(e),s.renderer.renderer.currentRendererMode=t.RendererMode[e];var a=s.renderer.SSAOEffect,o=s.renderer.SSAOIterativeEffect,l=this,h=function(t){t.setDynamicRadius(s.ssaoParams.dynamicRadius),t.setAdaptativeRadius(s.ssaoParams.adaptativeRadius),t.setRadius(s.ssaoParams.radius),t.setRadiusRange(s.ssaoParams.radiusMin,s.ssaoParams.radiusMax),t.setMinPixelRadius(s.ssaoParams.minPixelRadius),t.setAttenuation(s.ssaoParams.attenuation),t.setThresholdAngle(s.ssaoParams.thresholdAngle),t.setNbSamples(l.getSSAONbSamples(e))};a&&h(a),o&&h(o),s.infPlaneSmall&&s.infPlaneSmall.visible&&(this._infPlaneVisibilityBackUp=!0,s.infPlaneSmall.visible=this.getShadow(e)&&this.getAllowShadow(e)||this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e)||this.getGroundShadow(e)&&this.getAllowGroundShadow(e)||this.getSSAO(e)&&this.getAllowSSAO(e))}updateViewerSettingsPostRender(e,t){this._infPlaneVisibilityBackUp&&(this._infPlaneVisibilityBackUp=!1,this.viewer.infPlaneSmall&&(this.viewer.infPlaneSmall.visible=!0)),this._setDownsamplingFactor(e)}_isNotAvailableSetting(e){return this._blackListedEffects.has(e)||this._lockedSettings.has(e)}getSetting(e,t){return this._blackListedEffects.has(e)?s[e][t]:this._lockedSettings.has(e)?this._lockedSettings.get(e)[t]:this.settings[e][t]}setSetting(e,t,i){if(void 0===i&&console.error("Undefined value set for "+e),!this._blackListedEffects.has(e)){var r=this.settings[e][t];this.settings[e][t]=i,r!==i&&this.viewer.render(),"static"!==t&&"dynamic"!==t||this._emitEvent(e,t,i)}}setSettingAndRecompile(e,i,r){var n=this.viewer,s=this.getSetting(e,i);this.setSetting(e,i,r),s!==this.getSetting(e,i)&&n.renderer&&n.renderer.recompileAllShaders([t.RendererMode[i]])}_emitEvent(e,t,i){this.viewer._modelEvent.publish({event:"VisualSettingModified",data:{parameter:e,value:i,mode:t,viewer:this.viewer}})}updateAmbienceBackScale(e){var t=this.viewer;"FSAA"===this.getAntiAliasing(e)?t.ambience.getBackground().setBackplateScale(2):t.ambience.getBackground().setBackplateScale(1),t.ambience.update(t)}copySettings(e,t){var i=this;Object.entries(this.settings).forEach((r=>{i.settings[r[0]][e]=r[1][t]}))}_setFromJson(e,t){var i=this;Object.entries(t).forEach((t=>{i.settings[t[0]]&&(i.settings[t[0]][e]=t[1])}))}setAllowPolitenessOnHighlight(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AllowPolitenessOnHighlight",n,e)}}getAllowPolitenessOnHighlight(e){return e=e||"static",this.getSetting("AllowPolitenessOnHighlight",e)}_setAllowPolitenessOnHighlight(e){var r=this.viewer;if(this.getAllowPolitenessOnHighlight(e)===t.EffectState.Auto){const n=this.autoEffectPreviousStates.AllowPolitenessOnHighlight[e];r.renderer.renderer._usePolitenessOnHighlight=!("Low"===i.defaultPreset||i.unknownOrVeryLowGPU),r.renderer.renderer._usePolitenessOnHighlight!==n&&r.renderer&&r.renderer.recompileAllShaders([t.RendererMode[e]]),this.autoEffectPreviousStates.AllowPolitenessOnHighlight[e]=r.renderer.renderer._usePolitenessOnHighlight}else r.renderer.renderer._usePolitenessOnHighlight=this.getAllowPolitenessOnHighlight(e)===t.EffectState.Enabled}setShadow(t,i,r){var n=this.viewer._directionalLight;if(null!==n){n.light3js.LiSPSM=i;for(let e=0;e<n._occurrences.length;e++)n._occurrences[e].renderable.LiSPSM=i}for(var s=this.getShadow("static"),a=r?[r]:["static","dynamic"],o=0;o<a.length;o++){var l=a[o];this.setSettingAndRecompile("InterObjectShadows",l,t)}var h=this.getShadow("static");h!==s&&e.publish({event:"/WUX/AFR/CMD/VisuToggleShadow/"+(h?"BEGIN":"END")})}getShadow(e){return e=e||"static",this.getSetting("InterObjectShadows",e)}setAllowShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AllowInterObjectShadows",n,e)}}getAllowShadow(e){return e=e||"static",this.getSetting("AllowInterObjectShadows",e)}_setShadow(e){this.viewer.useShadowMap=this.getShadow(e)&&this.getAllowShadow(e)}setShadowFilter(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("ShadowFilter",n,e)}}_setShadowFilter(e){var i=this.viewer;if(this.getShadowFilter(e)!==i.shadowFilter){switch(i.shadowFilter=this.getShadowFilter(e),i.shadowFilter){case"PCF":i.renderer.renderer.shadowMapType=t.PCFShadowMap;break;case"PCFInterpol":i.renderer.renderer.shadowMapType=t.PCFInterpolShadowMap;break;case"PCFPoisson":case"poisson":i.renderer.renderer.shadowMapType=t.PCFPoissonShadowMap;break;case"PCFOptimized":i.renderer.renderer.shadowMapType=t.PCFOptimizedShadowMap;break;case"ESM":i.renderer.renderer.shadowMapType=t.ESMShadowMap,i.renderer.renderer.esmEffect||(i.renderer.renderer.esmEffect=new r(i.renderer.renderer,i.renderer.renderTargetPool));break;default:i.renderer.renderer.shadowMapType=t.BasicShadowMap}i._updateShadowMaps()}}getShadowFilter(e){return e=e||"static",this.getSetting("ShadowFilter",e)}setShadowQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("ShadowQuality",n,e)}}_setShadowQuality(e){var i=this.viewer;this.getShadowQuality(e)!==i.shadowQuality&&(i.shadowQuality=this.getShadowQuality(e),"Medium"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.MediumQuality:"High"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.HighQuality:i.renderer.renderer.shadowMapQuality=t.LowQuality,i._updateShadowMaps())}getShadowQuality(e){return e=e||"static",this.getSetting("ShadowQuality",e)}setGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("GroundShadows",n,e)}}getGroundShadow(e){return e=e||"static",this.getSetting("GroundShadows",e)}_setGroundShadow(e){var t=this.getGroundShadow(e)&&this.getAllowGroundShadow(e),i=this.viewer;i.useGroundShadow!==t&&(i.useGroundShadow=t,i._dirLightGroundShadow.light3js.groundMaterial&&(i.useGroundShadow?i._dirLightGroundShadow.light3js.groundMaterial.defines.GROUND_SHADOW=1:i._dirLightGroundShadow.light3js.groundMaterial.defines.GROUND_SHADOW=0,i._dirLightGroundShadow.light3js.groundMaterial.needsUpdate=!0))}setAllowGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AllowGroundShadows",n,e)}}getAllowGroundShadow(e){return e=e||"static",this.getSetting("AllowGroundShadows",e)}setTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("TransparentObjectShadows",n,e)}}getTransparentShadow(e){return e=e||"static",this.getSetting("TransparentObjectShadows",e)}setAllowTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AllowTransparentObjectShadows",n,e)}}getAllowTransparentShadow(e){return e=e||"static",this.getSetting("AllowTransparentObjectShadows",e)}_setTransparentShadow(e){var t=this.viewer,i=this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e);t.renderer.renderer.transparentShadowEnabled!==i&&(t._updateShadowMaps(),t.renderer.renderer.transparentShadowEnabled=i)}setOIT(e,t){!0===e?e="WeightedAverage":!1!==e&&"AlphaBlending"!==e||(e="None");var i=this.viewer;"PerPixelLinkedList"!==e||i.renderer.isDeviceCompatibleWithOIT()||(console.warn("Warning: per-pixel linked list OIT is not compatible with this device"),e="None",t=null),"PerPixelLinkedList"!==e||i._use_webgpu||(console.warn("Warning: per-pixel linked list OIT is only supported by WebGPU, falling back to weighted average OIT"),e="WeightedAverage",t=null),"WeightedAverage"!==e||i.renderer.isDeviceCompatibleWithOIT()||(console.warn("Warning: weighted average OIT is not compatible with this device"),e="None",t=null);for(var r=t?[t]:["static","dynamic"],n="None"!==e?e:"AlphaBlending",s=0;s<r.length;s++){var a=r[s];this.setSettingAndRecompile("Transparency",a,n)}}_setOIT(e){var i,r=this.viewer,s=r.renderer.renderer.oitMode;switch(this.getOITMode(e)){case"WeightedAverage":i=t.OITMode.WeightedAverage;break;case"PerPixelLinkedList":i=t.OITMode.PerPixelLinkedList;break;default:i=t.OITMode.None}if(i===t.OITMode.None&&this.getSSLRefraction(e)&&this.getAllowSSLRefraction(e)&&(i=t.OITMode.WeightedAverage),i!==t.OITMode.None&&r.getRenderPriority())console.warn("Warning: OIT is not compatible with render priority");else if(i!==s){switch(n&&r.renderer.resetGSSOCache(),s){case t.OITMode.WeightedAverage:r.renderer.setEffect("OIT",!1),r.renderer.setEffect("OITnoZ",!1);break;case t.OITMode.PerPixelLinkedList:r.renderer.setEffect("OITLinkedList",!1),r.renderer.setEffect("OITnoZLinkedList",!1)}switch(i){case t.OITMode.WeightedAverage:r.renderer.setEffect("OIT",!0),r.renderer.setEffect("OITnoZ",!0);break;case t.OITMode.PerPixelLinkedList:r.renderer.setEffect("OITLinkedList",!0),r.renderer.setEffect("OITnoZLinkedList",!0)}}}getOIT(e){return e=e||"static","AlphaBlending"!==this.getSetting("Transparency",e)}getOITMode(e){e=e||"static";var t=this.getSetting("Transparency",e);return"AlphaBlending"!==t?t:"None"}setFlakesQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("FlakesQuality",n,e)}}_setFlakesQuality(e){this.viewer.renderer.renderer.flakesMode={Low:3,Medium:2,High:1,Ultra:0}[this.getFlakesQuality(e)]}getFlakesQuality(e){return e=e||"static",this.getSetting("FlakesQuality",e)}setDownsamplingFactor(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this.setSetting("Downsampling",r,e)}}_setDownsamplingFactor(e){this.viewer.renderer.renderer._renderScale=this.getDownsamplingFactor()}getDownsamplingFactor(){return this.getSetting("Downsampling","static")}setSectionCapping(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("SectionCapping",n,e)}}_setSectionCapping(e){let i=!1;if(this.viewer.sectionCappingRequested){let r=this.getSectionCapping(e);i=!0,r===t.EffectState.Disabled?i=!1:r===t.EffectState.Auto&&(i=this.viewer.getSectionCappingAutoMode())}this.viewer.renderer.renderer.sectionCappingEnabled=i}getSectionCapping(e){return e=e||"static",this.getSetting("SectionCapping",e)}setDefaultMaterialQuality(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this.setSettingAndRecompile("DefaultMaterialQuality",r,e)}}_setDefaultMaterialQuality(e){var t=this.viewer,i={Low:!0,Medium:!0,High:!1,Ultra:!1}[this.getDefaultMaterialQuality()];t.renderer.renderer.gasAsPhong!=i&&(t.renderer.renderer.gasAsPhong=i,t.renderer.resetGSSOCache())}getDefaultMaterialQuality(){return this.getSetting("DefaultMaterialQuality","static")}enableZPrePass(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("DepthFlickeringReduction",n,e)}}_enableZPrePass(e){this.viewer.renderer._enableZPrePass(this.zPrePassEnabled(e))}zPrePassEnabled(e){return e=e||"static",this.getSetting("DepthFlickeringReduction",e)}setMirror(t,i,r,n,s){var a=this.viewer;n=void 0!==n?n:.3,s=void 0!==s?s:.85,i=void 0!==i?i:a.blurryMirror,a.renderer&&a.renderer.mirrorBlendPass&&a.renderer.mirrorBlendPass.material.setUniform("reflectivity",n),a.blurryMirror=i,a.blurryMirror&&a.ambience.setGroundGlossiness(s);for(var o=this.getMirror("static"),l=r?[r]:["static","dynamic"],h=0;h<l.length;h++){var c=l[h];this.setSetting("GroundReflection",c,t)}var d=this.getMirror("static");d!==o&&e.publish({event:"/WUX/AFR/CMD/VisuToggleMirror/"+(d?"BEGIN":"END")})}getMirror(e){return e=e||"static",this.getSetting("GroundReflection",e)}setAllowMirror(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("AllowGroundReflection",n,e)}}getAllowMirror(e){return e=e||"static",this.getSetting("AllowGroundReflection",e)}_setMirror(e){var t=this.viewer,i=this.getMirror(e)&&this.getAllowMirror(e)&&!t._2DMode;!t.useHDR&&t.cameraSystem&&(i=!1),t.useMirror!==i&&(t.useMirror=i)}setPixelCulling(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("PixelCulling",n,e)}}getPixelCulling(e){return e=e||"static",this.getSetting("PixelCulling",e)}_setPixelCulling(e){var t=this.viewer;t.currentViewpoint&&t.currentViewpoint._setPixelCulling(this.getPixelCulling(e))}setLOD(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("LOD",n,e)}}getLOD(e){return e=e||"static",this.getSetting("LOD",e)}_setLOD(e){this.viewer._currentLOD=this.getLOD(e)}setBloom(e,t){for(var i=this.viewer,r=t?[t]:["static","dynamic"],n=0;n<r.length;n++){var s=r[n];this.setSetting("Bloom",s,e)}e&&!i.getEffect("Bloom")&&(i.renderer.setEffect("Bloom",!0),i.renderer.setEffect("Bloom",!1))}getBloom(e){return e=e||"static",this.getSetting("Bloom",e)}_setBloom(e){var t=this.viewer,i=this.getBloom(e)&&this.getAllowBloom(e);t.useBloom!==i&&(t.useBloom=i,t.renderer.setEffect("Bloom",t.useBloom))}setAllowBloom(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("AllowBloom",n,e)}}getAllowBloom(e){return e=e||"static",this.getSetting("AllowBloom",e)}setSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("InterObjectRefractions",n,e)}}getSSLRefraction(e){return e=e||"static",this.getSetting("InterObjectRefractions",e)}setAllowSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AllowInterObjectRefractions",n,e)}}getAllowSSLRefraction(e){return e=e||"static",this.getSetting("AllowInterObjectRefractions",e)}_setSSLRefraction(e){var t=this.viewer,i=this.getSSLRefraction(e)&&this.getAllowSSLRefraction(e);t.useSSLRefraction!==i&&(t.useSSLRefraction=i,this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e)&&t._updateShadowMaps(),t.renderer.setEffect("SSLRefraction",t.useSSLRefraction))}setSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("InterObjectReflections",n,e)}}getSSLR(e){return e=e||"static",this.getSetting("InterObjectReflections",e)}setAllowSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AllowInterObjectReflections",n,e)}}getAllowSSLR(e){return e=e||"static",this.getSetting("AllowInterObjectReflections",e)}_setSSLR(e){var t=this.viewer,i=this.getSSLR(e)&&this.getAllowSSLR(e);t.useSSLRDirect!==i&&(t.useSSLRDirect=i,t.renderer.setEffect("SSLRDirect",i),t.renderer.renderer.useSSLR=i)}setDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("DepthOfField",n,e)}var s=this.viewer;e&&!s.getEffect("DOF")&&(s.renderer.setEffect("DOF",!0),s.renderer.setEffect("DOF",!1))}getDOF(e){return e=e||"static",this.getSetting("DepthOfField",e)}setAllowDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("AllowDepthOfField",n,e)}}getAllowDOF(e){return e=e||"static",this.getSetting("AllowDepthOfField",e)}_setDOF(e){var t=this.viewer,i=this.getDOF(e)&&this.getAllowDOF(e);if(t.useDOF!==i&&(t.useDOF=i,t.renderer.setEffect("DOF",t.useDOF)),"static"===e){var r="MSAA"===this.getAntiAliasing(e),n=t.getEffect("DOF");n&&n.setIterative(t.useDOFIterative&&r)}}setSSAONbSamples(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r],s=this.getSSAO(t)&&this.getAllowSSAO(t);this.setSetting("AmbientOcclusionNbSamples",n,e),(this.getSSAO(t)&&this.getAllowSSAO(t))!==s&&this.viewer.renderer.recompileAllShaders()}}getSSAONbSamples(e){return e=e||"static",this.getSetting("AmbientOcclusionNbSamples",e)}setSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AmbientOcclusion",n,e)}}getSSAO(e){return e=e||"static",this.getSetting("AmbientOcclusion",e)}setAllowSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSettingAndRecompile("AllowAmbientOcclusion",n,e)}}getAllowSSAO(e){return e=e||"static",this.getSetting("AllowAmbientOcclusion",e)&&this.getSetting("AmbientOcclusionNbSamples",e)>0}_setSSAO(e){var t=this.viewer,i=this.getSSAO(e)&&this.getAllowSSAO(e),r="MSAA"===this.getAntiAliasing(e);t.useSSAO=i;var n=t.useSSAOIterative&&r&&t.renderIteration>0;t.renderer.setEffect("SSAO",t.useSSAO&&!n),t.renderer.setEffect("SSAOIterative",t.useSSAO&&n)}setAntiAliasing(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r],s=null;"SMAA"===e||"MLAA"===e||"FXAA"===e||"FSAA"===e||"MSAA"===e||"SSAA"===e||"TAA"===e?s="dynamic"===n&&"MSAA"===e?"SMAA":e:"NoAA"===e||!1===e?s="NoAA":!0===e?s="SMAA":"MSMAA"===e&&(console.warn("MSMAA is deprecated"),s="dynamic"===n?"SMAA":"MSAA"),s&&this.setSetting("AntiAliasing",n,s)}}getAntiAliasing(e){return this.getSetting("AntiAliasing",e)}_setAntiAliasing(e,t){var r=this.viewer,n=this.getAntiAliasing(e),s=this.getAntiAliasing("dynamic");t&&"MSAA"===n&&(n="NoAA"===s?i.currentUser.includes("SWYM")?"TAA":"SMAA":s),"TAA"===n&&"static"===e&&"TAA"!==s&&(n="MSAA"),r.antiAliasing!==n&&(r.renderer.setEffect(r.antiAliasing,!1),r.antiAliasing=n,r.renderer.setEffect(r.antiAliasing,!0))}}class o extends a{constructor(e,t){var i={__child:!0};t.__child?Object.assign(i,t):(i.useQM=t.useQM,i.antiAliasing=e.antiAliasing,i.enableOIT=t.enableOIT,i.useGroundShadow=e.useGroundShadow,i.useShadowMap=e.useShadowMap,i.shadowQuality=e.shadowQuality,i.shadowFilter=e.shadowFilter,i.ODTMode=e.ODTMode,i.useMirror=e.useMirror,i.useSSAO=e.useSSAO,i.useBloom=e.useBloom,i.useDOF=e.useDOF),super(e,i)}}class l extends o{constructor(e,t){var i={__child:!0};t.__child?Object.assign(i,t):(i.useQM=t.useQM,i.antiAliasing="NoAA",i.enableOIT=t.enableOIT,i.useGroundShadow=e.useGroundShadow,i.useShadowMap=e.useShadowMap,i.shadowQuality=e.shadowQuality,i.shadowFilter=e.shadowFilter,i.ODTMode=e.ODTMode,i.useMirror=e.useMirror,i.useSSAO=e.useSSAO,i.useBloom=!1,i.useDOF=!1),super(e,i),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing")}}class h extends l{constructor(e,t){var i={__child:!0};t.__child?Object.assign(i,t):(i.useQM=t.useQM,i.antiAliasing="NoAA",i.enableOIT=t.enableOIT,i.useGroundShadow=e.useGroundShadow,i.useShadowMap=e.useShadowMap,i.shadowQuality=e.shadowQuality,i.shadowFilter=e.shadowFilter,i.ODTMode=e.ODTMode,i.useMirror=e.useMirror,i.useSSAO=e.useSSAO,i.useBloom=!1,i.useDOF=!1),super(e,i),this._blackListedEffects.add("InterObjectReflections"),this._blackListedEffects.add("InterObjectRefractions")}}return{Desktop:o,NoHDR:l,Mobile:h,VR:class extends h{constructor(e,t){var i={__child:!0};t.__child?Object.assign(i,t):(i.useQM=t.useQM,i.antiAliasing="NoAA",i.enableOIT=t.enableOIT,i.useGroundShadow=!1,i.useShadowMap=!1,i.shadowQuality=e.shadowQuality,i.shadowFilter=e.shadowFilter,i.ODTMode=e.ODTMode,i.useMirror=!1,i.useSSAO=!1,i.useBloom=!1,i.useDOF=!1),super(e,i),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("AmbientOcclusion")}},None:class extends a{constructor(e,t){var i={__child:!0};t.__child?Object.assign(i,t):(i.useQM=t.useQM,i.antiAliasing="NoAA",i.enableOIT=!1,i.useGroundShadow=!1,i.useShadowMap=!1,i.shadowQuality=e.shadowQuality,i.shadowFilter=e.shadowFilter,i.ODTMode=e.ODTMode,i.useMirror=!1,i.useSSAO=!1,i.useBloom=!1,i.useDOF=!1),super(e,i),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("Transparency"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing"),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("AmbientOcclusion"),this._blackListedEffects.add("InterObjectReflections"),this._blackListedEffects.add("InterObjectRefractions"),this._lqFallback=!0}}}})),define("DS/Visualization/IdPath",["DS/Visualization/PathElement","DS/SceneGraphOverrides/GenericOverride"],(function(e,t){"use strict";class i{constructor(e){this.ids=e,this._key=null}removeLastId(){this.ids.length>0&&this.ids.length--,this._key=null}clone(){var e,t=[];for(e=0;e<this.ids.length;e++)t.push(this.ids[e]);var r=new i(t);return r._key=this._key,r}buildPathElement(t){var i,r,n=[];for(r=0;r<this.ids.length;r++){if(!(i=t.idToNode(this.ids[r])))return null;n.push(i)}return new e(n)}getElement(e){return this.ids[e]}getLength(){return this.ids.length}getFirstElement(){return this.ids[0]}getKey(){return null===this._key&&(this._key=i.buildIdPathKey(this.ids)),this._key}getLastId(){return this.ids[this.ids.length-1]}_getLDHOccurrence_internal(e,t){let i=e.getChild(this.ids[t]);return i?this.ids.length<=t+1?i:i.reference.referenceId===this.ids[t+1]?this.ids.length<=t+2?i:this._getLDHOccurrence_internal(i,t+2):null:null}_getLDHOccurrences(e){let t,i=[],r=e._getLDHReference(this.ids[0],!0);for(t=0;t<r._occurrences.length;t++){let e=this._getLDHOccurrence_internal(r._occurrences[t],1);i.push(e)}return i}_getOverrideDatas_internal(e,t){if(!(t<this.ids.length))return e.getReferenceOverrideData();{let i=e.getChild(this.ids[t]);if(i)return t>=this.ids.length-1?i.getInstanceOverrideData():i.reference.referenceId===this.ids[t+1]?this._getOverrideDatas_internal(i,t+2):null}return null}_getOverrideDatas(e){let t,i=[],r=!1;for(t=0;t<this.ids.length&&e.isExternalNodeId(this.ids[t]);t++);if(t>=this.ids.length)return null;let n=e._getLDHReference(this.ids[t],!0);if(n||(n=e._getInstance(this.ids[t]),n&&(r=!0)),n){let e;for(e=0;e<n._occurrences.length;e++){let s=n._occurrences[e];if(0===t||!s.parent){let s=this._getOverrideDatas_internal(n._occurrences[e],r?t:t+1);s&&i.push(s)}}}return i}}return i.buildIdPathKey=function(e){var t,i="";for(t=e.length-1;t>=0;t--)i+=e[t],0!==t&&(i+="/");return i},i})),define("DS/Visualization/PLMMaterialConnectionFactory",["DS/Visualization/MaterialConnection","DS/Visualization/PathElement","DS/Visualization/IdPathWatcher","DS/Visualization/IdPath","DS/Visualization/ThreeJS_DS"],(function(e,t,i,r,n){"use strict";class s{constructor(){this.loadAppearanceCB=null,this.loadDecalCB=null,this.getNodeFromIdCB=null,this.computePathElementCB=null,this.idPathWatcher=null,this.appearanceIdMap=new Map,this.decalIdMap=new Map,this.internalPathIds=new Map,this.legacyUVIds=new Map,this.oocManager=null}setParams(e){e.loadAppearanceCB&&(this.loadAppearanceCB=e.loadAppearanceCB),e.loadDecalCB&&(this.loadDecalCB=e.loadDecalCB),e.getNodeFromIdCB&&(this.getNodeFromIdCB=e.getNodeFromIdCB),e.useIdPathMatcher&&e.viewer&&(this.idPathWatcher=new i({viewer:e.viewer,onIdPathActiveCB:this._onIdPathActive.bind(this),onIdPathInactiveCB:this._onIdPathInactive.bind(this),listenToSceneGraphOnly:!0})),e.oocManager&&(this.oocManager=e.oocManager)}addMaterialConnection(e,t){if(this.idPathWatcher){if(t.legacyUV){var i=(n=t.idPath)[n.length-1];this._addLegacyUVId(i)}if(t.internalPath){var n,s="##REP##"+(i=(n=t.idPath)[n.length-1]);t.idPath=n.concat([s]),this._addInternalIdPathId(i)}var l=t.appearanceId;let h=this.appearanceIdMap.get(l);h?h.params=t:(h=new a(e,t,o.MaterialConnection),this.appearanceIdMap.set(l,h),this.idPathWatcher.addIdPath(new r(t.idPath),h))}else{let i=new a(e,t,o.MaterialConnection);this._addMaterialConnectionOnMaterializedIdPath(i)}}addDecal(e,t){if(this.idPathWatcher){let i=t.decalId,n=this.decalIdMap.get(i);n?n.params=t:(n=new a(e,t,o.Decal),this.decalIdMap.set(i,n),this.idPathWatcher.addIdPath(new r(t.idPath),n))}else{let i=new a(e,t,o.Decal);this._addDecalOnMaterializedIdPath(i)}}removeMaterialConnection(e){var t=this.appearanceIdMap.get(e);if(t){var i=t.params;if(i&&i.internalPath){var r=i.idPath[i.idPath.length-2];r&&this._removeInternalIdPath(r),r&&this._removeLegacyUVId(r)}this.idPathWatcher.removeIdObject(t),this.appearanceIdMap.delete(e)}}removeDecal(e){let t=this.decalIdMap.get(e);t&&(this.idPathWatcher.removeIdObject(t),t.decal&&t.decal.unapplyAndDetach(),this.decalIdMap.delete(e))}_addMaterialConnectionOnMaterializedIdPath(t){let i=t.nodeId,r=t.params;var n=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher(),s=n?n.idToNode(i):this.getNodeFromIdCB(i);if(s){var a=s.getPLMMaterialData(),o=r.pathElement,l=o?[o]:[];if(!o){var h=r.idPath;if((o=this.getPathElementFromIdPath(h))&&l.push(o),o&&(r.internalUUIDPath||r.internalPath)){var c=o.externalPath.length,d=c>0?o.externalPath[c-1]:o.externalPath[0];if(r.internalUUIDPath)l=d.getPathElementsFromUUIDs(o,r.internalUUIDPath,r.cgmIdRep,r.cgmIdPrimitive?[r.cgmIdPrimitive]:null);else{var u=[];null!==r.internalPath&&void 0!==r.internalPath&&u.push(r.internalPath),null!==r.cgmIdRep&&void 0!==r.cgmIdRep&&u.push(r.cgmIdRep),null!==r.cgmIdPrimitive&&void 0!==r.cgmIdPrimitive&&u.push(r.cgmIdPrimitive);var p=r.cgmIdPrimitives?r.cgmIdPrimitives:r.cgmIdPrimitive?[r.cgmIdPrimitive]:null;l=d.getPathElementsFromDiezeEle(o,r.internalPath?[r.internalPath]:null,r.cgmIdRep,p)}}}if(l)for(var f=0;f<l.length;f++){var g=new e({pathElement:l[f],appearanceId:r.appearanceId,type:r.type,depth:r.depth,vLayer:r.vLayer});a.addMaterialConnection(g)}}}_addDecalOnMaterializedIdPath(e){let t=e.nodeId,i=e.params;var r=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher();if(!(r?r.idToNode(t):this.getNodeFromIdCB(t)))return;var n=i.pathElement||null;n||(n=this.getPathElementFromIdPath(i.idPath));let s=n.getElement(0,!0),a=n.getLastElement(!0);s&&a&&this.loadDecalCB&&this.loadDecalCB(i,this._applyDecal.bind(this,e,s,a),(()=>{}))}getPathElementFromIdPath(e){var i,r,n=[],s=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher();for(i=0;i<e.length;i++){var a=e[i];if(!(r=s?s.idToNode(a):this.getNodeFromIdCB(a)))return null;n.push(r)}return new t(n)}hasInternalPath(e){return(this.internalPathIds.get(e)||0)>0}hasLegacyUV(e){return(this.legacyUVIds.get(e)||0)>0}_onIdPathActive(e){e.type===o.MaterialConnection?this._addMaterialConnectionOnMaterializedIdPath(e):e.type===o.Decal&&this._addDecalOnMaterializedIdPath(e)}_onIdPathInactive(e){}_addInternalIdPathId(e){var t=this.internalPathIds.get(e)||0;t++,this.internalPathIds.set(e,t)}_removeInternalIdPath(e){var t=this.internalPathIds.get(e)||0;t>0&&(0===--t?this.internalPathIds.delete(e):this.internalPathIds.set(e,t))}_addLegacyUVId(e){var t=this.legacyUVIds.get(e)||0;if(t++,this.legacyUVIds.set(e,t),1===t&&this.oocManager){var i=this.oocManager._getLDHReference(e,!0);i&&i.setLegacyUV()}}_removeLegacyUVId(e){var t=this.legacyUVIds.get(e)||0;t>0&&(0===--t?this.legacyUVIds.delete(e):this.legacyUVIds.set(e,t))}_applyDecal(e,t,i,r,s){let a=s.material||null,o=s.mapping||{};var l=new n.Matrix4;s.matrix&&(l=s.matrix.clone());let h=void 0!==s.decalImplicitScaleU?s.decalImplicitScaleU:1,c=void 0!==s.decalImplicitScaleV?s.decalImplicitScaleV:1,d=r.decalMode>0,u=new n.Matrix3(h,0,0,0,c,0,0,0,1),p=null;p=s.decalUVTransform?(new n.Matrix3).multiplyMatrices(u,s.decalUVTransform):u,a.setMappingOperator(s.decalProjector,new n.Matrix4,p,!0,o.transformSemantic);let f=n.DecalManager.createDecal({matrix:l,material:a,explicitUv:d});a.force=!0,f.setLegacyLayer(r.vLayer,!0),f.setLegacyInheritance(r.inheritanceMaterial),f.attachTo(t),f.applyOn(i),e.decal=f}}class a{constructor(e,t,i){this.nodeId=e,this.params=t,this.type=i}}let o={MaterialConnection:0,Decal:1};return s.prototype.COVERAGE_MATERIAL=e.COVERAGE_MATERIAL,s.prototype.CORE_MATERIAL=e.CORE_MATERIAL,new s})),define("DS/Visualization/PLMMaterialLoader",["DS/Visualization/PLMMaterialConnectionFactory"],(function(e){"use strict";var t=function(){this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null,this.materialConnectionToPLMMaterialDataMap=new Map};return t.prototype.loadMaterials=function(e,t){var i,r,n=this.toLoadMaterialConnectionArray;for(i=0;i<e.length;i++)r=e[i],this.materialConnectionToPLMMaterialDataMap.set(r,t),r.isComplete()&&n.push(r);n.length>0&&null===this.token_toLoadMaterialConnectionArray&&(this.token_toLoadMaterialConnectionArray=setTimeout(this.loadMaterials_internal.bind(this),0))},t.prototype.getPathElementFromIdPath=function(t){var i,r,n=[];for(i=0;i<t.length;i++)r=e.loadAppearanceCB(t[i]),n.push(r);return new PathElement(n)},t.prototype.loadMaterials_internal=function(){var t;if(null!==this.token_toLoadMaterialConnectionArray){for(t=0;t<this.toLoadMaterialConnectionArray.length;t++)e.loadAppearanceCB(this.toLoadMaterialConnectionArray[t],this.onMaterialLoadedCB.bind(this),this.onMaterialErrorCB.bind(this));this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null}},t.prototype.onMaterialLoadedCB=function(e,t){this.materialConnectionToPLMMaterialDataMap.get(e)._applyMaterialApplication(e,t)},t.prototype.onMaterialErrorCB=function(e,t){},t})),define("DS/Visualization/PLMMaterialData",["DS/Visualization/StaticOverrideSet","DS/Visualization/PLMMaterialLoader"],(function(e,t){"use strict";var i=new t,r=function(e){this._node=e,this._materialConnections=[],this._staticOverrideSet=null};return r.prototype._getStaticOverrideSet=function(){var t=this._staticOverrideSet;return null===t&&(t=new e(this._node),this._staticOverrideSet=t),t},r.prototype.addMaterialConnection=function(e){this._materialConnections.push(e),i.loadMaterials([e],this)},r.prototype._applyMaterialApplication=function(e,t){t=t.clone();var i=this._getStaticOverrideSet(),r=e.computeLayer(this);t.setParameters({layer:r}),i.addStaticOverride(e.pathElement,t),this._node._requestStaticOverridesUpdate()},r.prototype.getNbConnections=function(){return this._materialConnections.length},r})),define("DS/Visualization/Node3D",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/OccurrencePath","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ClippingContext","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/MaterialApplication","DS/Visualization/PLMMaterialData","DS/Visualization/KDTree","DS/Visualization/ClippingPolyLineData","DS/Visualization/Filters/VisuFilter","DS/Visualization/Filters/FilteredFilter","DS/Visualization/Filters/PlaneViewModeFilter","DS/SceneGraphOverrides/OverrideUtils","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x){"use strict";var w=i.NoOccurrences,P=5,C=0,M=new i.Matrix4,E=i.__visibleInCurrentSpace;const T=i._VisuFilterType;var A=function(e,t){return this.node=void 0!==e?e:null,this.parent=null,this.depth=0,this.children=[],this.occBooleanAttr=0,this.matrix=null,this.material=null,this.matApp=null,this.matAppOverride=null,this.gas=null,this.ldhOccurrence=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setDepthMode(!0),this._setAdvancedPriority(!1),this._setPickable(!0),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this.setNoPickThrough(!0),this.scene3js=void 0!==t?t:null,this.renderable=null,this.renderMode=null,this.layerFilter=null,this.faceMode=null,this._setNeedBEUpdate(!0),this.passes=null,this._isoLayer=null,this.next=null,this.prev=null,this.forcePasses=null,this.forceGAS=null,this.pickingPriorityID=null,this.clippingContext=null,this.__rdo_visited=0,this._filters=null,this.__overrideData=null,this._manipulators={},this._setNeedOverridesUpdate(!1),this._setDescendantNeedsOverridesUpdate(!1),this._substituteMaterials=null,this.__solvedSubstituteMaterials=null,this._instancingInfos=null,this},D=function(){this.renderPriority=null,this.localMatrixOverride=null,this._relativeMatrix=null,this._relativeVisibility=null,this._bsShow=void 0,this._bsNoShow=void 0,this._bbShow=void 0,this._bbNoShow=void 0,this.occurrenceRenderingOverride=null,this.originalOverrideSet=null,this.overrideLink=null};Object.defineProperty(A.prototype,"renderPriority",{get:function(){return this.__overrideData?this.__overrideData.renderPriority:null},set:function(e){null===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData.renderPriority=e)}}),Object.defineProperty(A.prototype,"occurrenceRenderingOverride",{get:function(){return this.__overrideData?this.__overrideData.occurrenceRenderingOverride:null},set:function(e){null===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData.occurrenceRenderingOverride=e)}}),Object.defineProperty(A.prototype,"originalOverrideSet",{get:function(){return this.__overrideData?this.__overrideData.originalOverrideSet:null},set:function(e){null===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData.originalOverrideSet=e)}}),Object.defineProperty(A.prototype,"overrideLink",{get:function(){return this.__overrideData?this.__overrideData.overrideLink:null},set:function(e){null===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData.overrideLink=e)}}),Object.defineProperty(A.prototype,"localMatrixOverride",{get:function(){return this.__overrideData?this.__overrideData.localMatrixOverride:null},set:function(e){null===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData.localMatrixOverride=e)}}),Object.defineProperty(A.prototype,"_relativeMatrix",{get:function(){return this.__overrideData?this.__overrideData._relativeMatrix:null},set:function(e){null===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData._relativeMatrix=e)}}),Object.defineProperty(A.prototype,"_relativeVisibility",{get:function(){return this.__overrideData?this.__overrideData._relativeVisibility:null},set:function(e){null===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData._relativeVisibility=e)}}),Object.defineProperty(A.prototype,"_bsShow",{get:function(){return this.__overrideData?this.__overrideData._bsShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData._bsShow=e)}}),Object.defineProperty(A.prototype,"_bsNoShow",{get:function(){return this.__overrideData?this.__overrideData._bsNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData._bsNoShow=e)}}),Object.defineProperty(A.prototype,"_bbShow",{get:function(){return this.__overrideData?this.__overrideData._bbShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData._bbShow=e)}}),Object.defineProperty(A.prototype,"_bbNoShow",{get:function(){return this.__overrideData?this.__overrideData._bbNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||this._createOverrideData()&&(this.__overrideData._bbNoShow=e)}}),A.prototype._createOverrideData=function(){return!this.node._isDecal&&(this.__overrideData||(this.__overrideData=new D),!0)},A.prototype._getMaterialApplication=function(){return this.matAppOverride?this.matAppOverride:this.node._getMaterialApplication()},A.prototype._getFilter=function(e){return this._filters?this._filters.get(e):null},A.prototype._isFurtiveFiltered=function(){let e=this._getFilter(T.FURTIVE);return!!(e&&e.state&&this.isFurtive())},A.prototype._getShadow=function(){var e=null,t=null;if(this.renderable&&this._filters&&this._filters.has(T.LOOK)){var i=this._filters.get(T.LOOK);1===i.shadowReceive?e=!0:0===i.shadowReceive&&(e=!1),1===i.shadowCast?t=!0:0===i.shadowCast&&(t=!1)}return[t,e]},A.prototype._addSubstituteMaterial=function(e,t,i=!1){this._substituteMaterials||(this._substituteMaterials=new Map),this._substituteMaterials.set(e,{material:t,highPriority:i}),this.parent&&this.parent.node._updateOccurrences(this.parent,this,I.UpdateMatrixMode.Never,!0,I.InvalidateGSSOMode.Always)},A.prototype._removeSubstituteMaterial=function(e){this._substituteMaterials&&(this._substituteMaterials.delete(e),0===this._substituteMaterials.size&&(this._substituteMaterials=null),this.parent&&this.parent.node._updateOccurrences(this.parent,this,I.UpdateMatrixMode.Never,!0,I.InvalidateGSSOMode.Always))},A.prototype._propagateSubstituteMaterials=function(e){if(this.__solvedSubstituteMaterials=null,e||this._substituteMaterials){var t=new Map;this._substituteMaterials&&this._substituteMaterials.forEach(((e,i,r)=>t.set(i,e))),e&&e.forEach(((e,i,r)=>{var n=t.get(i);n&&n.highPriority||t.set(i,e)})),t.size>0&&(this.__solvedSubstituteMaterials=t)}},A.prototype.updateMatrix=function(e,t){t?e?this.localMatrixOverride?this.localMatrixOverride.copy(e):this.localMatrixOverride=e.clone():this.localMatrixOverride.identity():this.localMatrixOverride=null;var r=this.parent;if(this.node._isDecal){const e=this.node._getOccAttachedTo(this);e&&(r=e)}r?e&&!e.isIdentity()?r.matrix?r.matrix.isIdentity()||r.node._instancingInfos?this.matrix=e.clone():(this.matrix=new i.Matrix4,this.matrix.multiplyMatrices(r.matrix,e)):this.matrix=e.clone():!r.matrix||r.matrix.isIdentity()||r.node._instancingInfos?this.matrix=M:this.matrix=r.matrix:e&&!e.isIdentity()?this.matrix=e.clone():this.matrix=M},A.prototype.getViewer=function(){return this.scene3js&&this.scene3js.viewer},A.prototype.getLocalMatrix=function(){return this.localMatrixOverride||this.node._matrix||M},A.prototype.requestOverridesUpdate=function(){let e=!1;this.ldhOccurrence&&(this.ldhOccurrence.requestOverridesUpdate(),e=!0);for(var t=this.parent;t&&!t._getDescendantNeedsOverridesUpdate();)t._setDescendantNeedsOverridesUpdate(!0),t.ldhOccurrence&&!e&&(t.ldhOccurrence.requestOverridesUpdate(),e=!0),t=t.parent;this.traverseWithCondition((function(e){return e._getNeedOverridesUpdate()?null:(e.parent&&e.parent._setDescendantNeedsOverridesUpdate(!0),e._setNeedOverridesUpdate(!0),!0)}))},A.prototype.doesADescendantNeedOverrideUpdate=function(){return this._getDescendantNeedsOverridesUpdate()},A.prototype.isOverridesUpdateRequested=function(){return this._getNeedOverridesUpdate()},A.prototype.clearOverridesUpdateRequest=function(){this.traverseWithCondition((function(e){var t=!!e._getDescendantNeedsOverridesUpdate()||null;return e._setNeedOverridesUpdate(!1),e._setDescendantNeedsOverridesUpdate(!1),t}))},A.prototype.updateOverrideStatus=function(e){if(e?this.traverseWithCondition((function(e){if(e.ldhOccurrence)return e.ldhOccurrence.requestOverridesUpdate(),!1;{let t=e.parent,i=y.fillOverrideLink(e.overrideLink,e.originalOverrideSet,t&&t.overrideLink,t&&t.originalOverrideSet);return e.overrideLink=i,!0}})):this.traverse((function(e){e.overrideLink&&e.overrideLink.reset()})),this.parent)this.parent.node._updateOccurrences(this.parent,this,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Never);else{var t=this.children,i=0;for(i=0;i<t.length;i++)this.node._updateOccurrences(this,t[i],e?I.UpdateMatrixMode.Never:I.UpdateMatrixMode.Always,void 0,I.InvalidateGSSOMode.Always)}},A.prototype._tryOverridesUpdateWithAncestors=function(e){let t=this.ldhOccurrence,i=!!t&&(t._getNeedOverridesUpdate()||t._getDescendantNeedsOverridesUpdate());if(this._needOverridesUpdate||this._descendantNeedsOverridesUpdate||i){for(var r=this;r.parent;)r=r.parent;r.node._tryOverridesUpdate(e||this.scene3js&&this.scene3js.viewer)}},A.prototype._compactChildrenArray=function(e){var t=this.children;this.children=new Array(t.length);for(var i=0;i<t.length;i++)this.children[i]=t[i];this.renderable&&this.renderable._compactArrays&&this.renderable._compactArrays(e)},A.prototype.getOverrideLinkToUse=function(){return this.ldhOccurrence?this.ldhOccurrence.getOverrideLinkFromOccurrenceNode(this):this.__overrideData?this.__overrideData.overrideLink:null},A.prototype.getOriginalOverrideSetToUse=function(){return this.ldhOccurrence?this.ldhOccurrence.getOriginalOverrideSetFromOccurrenceNode(this):this.__overrideData?this.__overrideData.originalOverrideSet:null},A.prototype.lightCopy=function(){var e,t=this.node,i=new A(t,this.scene3js);if(null!==this.renderable&&((e=t.createRenderable()).name=t.name,e._occurrence=i,i.renderable=e,t._occurrences[0]&&t._occurrences[0]._manipulators)){var r,n=t._occurrences[0]._manipulators;for(r in n){var s=n[r];i._manipulators||(i._manipulators={}),i._manipulators[r]=s}}return i},A.prototype.traverse=function(e,t){var i,r,n=this.children.length;for(r=e(this,t),i=0;i<n;i++)this.children[i].traverse(e,r)},A.prototype.traverseWithCondition=function(e,t){var i,r,n=this.children.length;if(r=e(this,t))for(i=0;i<n;i++)this.children[i].traverseWithCondition(e,r)},A.prototype._getRenderableOccurrences=function(e){var t,i,r,n,s,a;for(t=[],i=this.children,null!==this.renderable&&t.push(this.renderable),n=0;n<i.length;n++)if(a=i[n],!e||!a.node.getExcludeFromBounding())for(r=a._getRenderableOccurrences(),s=0;s<r.length;s++)t.push(r[s]);return t},A.prototype.getBoundingSphere=function(e,t){var i=this._getBoundingSphere(e,t);return i?i.clone():null},A.prototype.getBoundingBox=function(e){return this._getBoundingBox(e)},A.prototype._getRenderModes=function(){var e=this.scene3js&&this.scene3js.viewer;return e&&null!==this.renderable?e.renderer.renderer.getRenderMode(this.renderable)._maskWithDefault:0},A.prototype._getAccurateRenderableOccurrences=function(e,t,r,n){var s=n||this.node.getRatio()>0;if(r.fixedSizeNodesStatus===i.FixedSizeFiltering.Exclude&&s)return e;if(!t||!this.node._isDecal&&!this.node.getExcludeFromBounding()){var a=this.children,o=r.mask||0;if(null!==this.renderable&&this.renderable.geometry){var l=this.renderable;if(!l.filtered&&E(l.visible,l.visibilityFree,r.space,l.layer,this)){var h=[],c=this._getRenderModes(),d=this._getFilter(T._STATIC_GEOM_TYPE)||this._getFilter(T.GEOM_TYPE);if(l.layer){var u=l.layer.layers;for(m=0;m<u.length;m++){var p=u[m];p.drawableInterval.skip(l,r.space)||(p.drawableGroup.isFiltered(c&~o,d?d._geomType:0)||h.push(p))}}else for(var f=0;f<l.geometry.length;f++)for(var g=l.geometry[f],m=0;m<g.drawingGroups.length;m++){var v=g.drawingGroups[m];v.isFiltered(c&~o,d?d._geomType:0)||h.push(v)}if(h.length>0){var _=new i.Matrix4;null!==r.handleMatrix?_.multiplyMatrices((new i.Matrix4).getInverse(r.handleMatrix),l._getMMMatrix()):_=l._getMMMatrix();var y=r.fixedSizeNodesStatus===i.FixedSizeFiltering.CenterOnly&&s?new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0)):l.boundingBox.clone(),S=new i.DGBoundingBoxArray({fastBBox:y.applyMatrix4(_),matrix:_,renderable:l});S.setDGs(h),e.push(S)}}}for(f=0;f<a.length;f++)a[f]._getAccurateRenderableOccurrences(e,t,r,s);return e}},A.prototype._isFixedSize=function(){for(var e=!1,t=this;null!=t&&(e=e||t.node.getRatio()>0,t=t.parent,!e););return e},A.prototype.computeAccurateBoundingBox=function(e,t,r,n){var s="visibleSpace"===e,a=[],o=this._isFixedSize();this._getAccurateRenderableOccurrences(a,!0,{space:s,handleMatrix:t,fixedSizeNodesStatus:r||i.FixedSizeFiltering.Include,mask:n||0},o);for(var l=[],h=a.length-1;h>=0;h--)a[h].renderable.geometry[0].vertexPositionArray||(l.push(a[h]),a.splice(h,1));var c=new i.Box3;if(c.fromDGBoundingBoxArray(a),l.length){var d=this.getViewer();c.union(d.renderer.boundingBoxGPUCompute.computeBoundingBoxGPU(d,l,t))}return c},A.prototype.needsBoundingElement=function(){var e,t=this.children.length;for(e=0;e<t;e++){var i=this.children[e];let t=i.getOverrideLinkToUse();if(i.localMatrixOverride||void 0!==i._bsShow||void 0!==i._bsNoShow||void 0!==i._bbShow||void 0!==i._bbNoShow||t&&t.hasVisibilityOverride())return!0}return!1},A.prototype._isFiltered=function(){if(this.layerFilter&&this.node._layer<this.layerFilter.length&&!this.layerFilter[this.node._layer])return!0;let e=this._getFilter(T.FILTERED);return!!e&&e.state},A.prototype._getBoundingSphere=function(e,t){e=e||"visibleSpace",this._updateBoundingElements();var r=null,n=void 0!==this._bsShow?this._bsShow:this.node._bsShow,s=void 0!==this._bsNoShow?this._bsNoShow:this.node._bsNoShow;return(r=this._getVisibilityFree()?this._getVisible()?n:null:this._getVisible()?"visibleSpace"===e?n:s:"visibleSpace"===e?null:i.mergeBoundingSphereInto(n&&n.clone(),s,this.node.getRatio()))||t||(r=new i.Sphere),r},A.prototype._getBoundingBox=function(e){e=e||"visibleSpace",this._updateBoundingElements();var t=null,r=void 0!==this._bbShow?this._bbShow:this.node._bbShow,n=void 0!==this._bbNoShow?this._bbNoShow:this.node._bbNoShow;return(t=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingBoxInto(r&&r.clone(),n))||(t=new i.Box3),t},A.prototype.updateVisibilityFlag=function(){this._invalidateBoundingElements(!1)},A.prototype.updateVisibilityFreeFlag=function(){this._invalidateBoundingElements(!1)},A.prototype._invalidateBoundingElements=function(e){this._getNeedBEUpdate()||(this._setNeedBEUpdate(!0),!this.parent||this.node.getExcludeFromBounding()&&!e||this.parent._invalidateBoundingElements(!1))},A.prototype._updateBoundingElements=function(e,t){if(e||this.node._updateBoundingElements(),this._getNeedBEUpdate()){if(!this.node._getForceBoundingElements()){t=this.node._updateShadowMapsIfNeeded(t);var r=0;for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this._updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"explicitBSphere"),this._updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"explicitBBox")}if(this.node.getExcludeFromBounding()){let e=this._getSceneGraph();e&&e.addBEExcludedNode(this.node)}this._setNeedBEUpdate(!1),this.parent||this.scene3js&&(this.scene3js.boundingSphere=this._getBoundingSphere("visibleSpace").clone(),this.scene3js.boundingSphere.radius=100,this.scene3js.boundingBox=this._getBoundingBox("visibleSpace").clone())}},A.prototype._updateBoundingElements_internal=function(e,t,i,r){if(!this.node._getForceBoundingElements())if(this.needsBoundingElement()){var n=null,s=null;if(this.children.length){var a,o,l,h,c=0;for(c=0;c<this.children.length;c++)(a=this.children[c]).node.getExcludeFromBounding()||(o=void 0!==a[e]?a[e]:a.node[e],l=void 0!==a[t]?a[t]:a.node[t],h=a.localMatrixOverride||a.node._matrix,a._getVisibilityFree()?(a._getVisible()||a.needsBoundingElement()&&!a.isMesh())&&(n=i(n,o,h,a.node.getRatio()),s=i(s,o,h,a.node.getRatio())):a._getVisible()||a.needsBoundingElement()&&!a.isMesh()?(n=i(n,o,h,a.node.getRatio()),s=i(s,l,h,a.node.getRatio())):(s=i(s,o,h,a.node.getRatio()),s=i(s,l,h,a.node.getRatio())))}if(n=this.node._modifyBE(n,i),s=this.node._modifyBE(s,i),this.node.getHasExplicitBE()){var d=void 0!==this[e]?this[e]:this.node[r];n=n&&d?i(n,d,null,0):d}this[e]=n,this[t]=s}else this[e]=void 0,this[t]=void 0},A.prototype._getViewpoint=function(){return this.scene3js&&this.scene3js.viewer?this.scene3js.viewer._viewpointManager.getViewpointFromRoot3js(this.scene3js):null},A.prototype._getSceneGraph=function(){if(this.scene3js&&this.scene3js.viewer){let e=this.scene3js.viewer._viewpointManager.getViewpointFromRoot3js(this.scene3js);return this.scene3js.viewer._viewpointManager.getViewpointScenegraph(e)}return null},A.prototype.isInCanvas2DPass=function(){var e=this.passes;return!!(e&&e.indexOf("canvas2D")>=0)},A.prototype.isInNozPass=function(){var e=this.passes;return!!(e&&e.indexOf("noz")>=0)||(!!(e&&e.indexOf("NoZ")>=0)||(!!(e&&e.indexOf("Noz")>=0)||(!!(e&&e.indexOf("robot")>=0)||(!!(e&&e.indexOf("canvas2D")>=0)||!!(e&&e.indexOf("-noPoliteHL")>=0)))))},A.prototype.isFurtive=function(){var e=this.passes;return!!(e&&e.indexOf("furtive")>=0)},A.prototype.isMesh=function(){return this.node._isMesh3D};var I=e.extend({init:function(e,t){if(this.id=C,C++,this.node3DBooleanAttr=0,this.node3DBooleanAttr2=0,this.modelIdentification=null,this.name=void 0!==e?e:"",this.parents=[],this.children=[],this.setLinkedToSceneGraph(!1),this._bsShow=null,this._bsNoShow=null,this._bbShow=null,this._bbNoShow=null,this._setForceBoundingElements(!1),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this._matrix=null,this.setExcludeFromBounding(!1),this.userData=null,this._setNeedBEUpdate(!0),this._material=null,this._matApp=null,this._gas=window.newMaterialInheritance?i._NREGASOnNodeInit?new i.GraphicAttributeSet({NREInit:!0}):new i.GraphicAttributeSet({NREInit:!0,type:i.GASTypeEnum._SKIN}):null,this._filters=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setPickable(!0),this.setNoPickThrough(!0),this.setPrimitivePicking(!0),this._occurrences=[],!w||t){var r=new A(this,this.scene3js);this._occurrences.push(r)}return this._setPickParent(!1),this.__setPickParentWithPrimitives(!1),this.__setTreeModified(!1),this.passes=null,this.clippingContext=null,this._renderMode=null,this._pickingMode=null,this._layer=0,this._layerFilter=null,this._depthMode=!1,this._isoLayer=null,this._depthPriority=0,this._forceDepthPriorityMode=!1,this._priority=4,this.setNotAllowedInPathElement(!1),this.modelEvents=void 0,this.productType="",this.persistentId=0,this._setVisibilityInTree(!0),this._iconInTree="",this.pickingPriorityID=null,this.clipPolyLine=null,this.setIsManipulator(!1),this._PLMMaterialData=null,this._setExcludeFromCSO(!1),this._setExcludeFromHSO(!1),this._setExcludeFromPSO(!1),this._setExcludeFromHL(!1),this._setExcludeFromPreHL(!1),this._setPropagateXSOExclusion(!1),this._setForbidHierarchyUpdate(!1),this.decalCount=0,this._overrideSetManager=null,this},_linkingClone:function(e){return(e=e||new I(this.name)).node3DBooleanAttr=this.node3DBooleanAttr,e.node3DBooleanAttr2=this.node3DBooleanAttr2,e._matrix=this._matrix,e._setNeedBEUpdate(!0),e._material=this._material,e._matApp=this._matApp,e._gas=this._gas,this._filters&&(e._filters=new Map,this._filters.forEach(((t,i,r)=>e._filters.set(i,t)))),e.passes=this.passes,e.clippingContext=this.clippingContext,e._renderMode=this._renderMode,e._pickingMode=this._pickingMode,e._layer=this._layer,e._layerFilter=this._layerFilter,e._depthPriority=this._depthPriority,e._forceDepthPriorityMode=this._forceDepthPriorityMode,e._priority=this._priority,e.modelEvents=this.modelEvents,e.productType=this.productType,e.persistentId=this.persistentId,e._iconInTree=this._iconInTree,e.pickingPriorityID=this.pickingPriorityID,e.clipPolyLine=this.clipPolyLine,e._PLMMaterialData=this._PLMMaterialData,e._overrideSetManager=this._overrideSetManager,e._isoLayer=this._isoLayer,e},_invalidateGSSOUnder:function(e){if(!e.has(this)){e.add(this);var t=this.getChildren();for(let i=0;i<t.length;i++)t[i]._invalidateGSSOUnder(e)}},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var s=n[r];this._occurrences[r]=s,s._compactChildrenArray(t)}var a=this.children;this.children=new Array(a.length);for(r=0;r<a.length;r++){var o=a[r];this.children[r]=o,o._compactHierarchy(e,t)}}},_getPickingCameraName:function(){var e=this._occurrences[0].passes;if(e&&1===e.length){if("robot"===e[0])return"connectedRobotCamera";if("robotOrtho"===e[0])return"robotCameraOrtho"}return""},_setTreeModified:function(){if(!this._getTreeModified()){this.__setTreeModified(!0);var e=0;for(e=0;e<this.parents.length;e++)this.parents[e]._setTreeModified()}},getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(e){this.modelIdentification=e},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(e){this.modelIdentification=e},setNodeUsage:function(e){this.persistentId=e},getNodeUsage:function(){return this.persistentId},isOOCPLMNode:function(){var e=this.getNodeUsage();return null!==this.modelIdentification&&void 0!==this.modelIdentification&&e!==I.TILESET_NODE},isOOCRepReference:function(){return this.getNodeUsage()===I.REPRESENTATION_NODE},isOOCReference:function(){return this.getNodeUsage()===I.REFERENCE_NODE},isOOCInstance:function(){return this.getNodeUsage()===I.INSTANCE_NODE&&!this.isOOCRepInstance()},isOOCRepInstance:function(){var e;if(this.getNodeUsage()===I.INSTANCE_NODE)for(e=0;e<this.children.length;e++)if(this.children[e].isOOCRepReference())return!0;return!1},isOOCTileSetNode:function(){return this.getNodeUsage()===I.TILESET_NODE},isEditable:function(){return!1},addChild:function(e){try{return this._addChild(e)}catch(e){throw e}},insertChildAtIndex:function(e,t){if(null!=t&&(t<0||t>this.children.length))return console.log("Index isn't in the right range. Node will be inserted at the end"),this._addChild(e);try{return this._addChild(e,t)}catch(e){throw e}},_addChild:function(e,t,r){if(!e)return!1;if(R>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate())return!1;var n,s,a,o,l;if(this._setTreeModified(),e instanceof i.Object3D&&console.warn("THREE.Object3D can not be a child of Node3D. This is probably due to a migration problem."),-1!==(e.parents.length<this.children.length?e.parents.indexOf(this):this.children.indexOf(e)))return!1;e._invalidateBoundingElements(!1,!1),t||0===t?this.children.splice(t,0,e):this.children.push(e),e.parents.push(this),e._isDecal&&this.decalCount++;var h=null,c=this;if(e.traverse((function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(h||(h=c._getAllOwningViewers()),t=0;t<h.length;t++){for(i=0;i<r.length;i++)h[t]._addClippingPlane(r[i]);h[t]._requestClippingUpdate()}})),s=this._occurrences.length,a=e._occurrences.length,!s||!a)return!1;var d=!1;for((e._getOverrideExists()||this._getOverrideExists())&&(this._setOverrideExistsTraverse(),d=!0),e._overrideSetManager&&(d=!0),e._getOverrideSetManagerUnder()&&this._setOverrideSetManagerUnder(),n=0;n<s;n++){if(o=this._occurrences[n],l=e._occurrences[0],o&&o.originalOverrideSet&&o.originalOverrideSet.onAddChild){var u=o.scene3js&&o.scene3js.viewer;o.originalOverrideSet.onAddChild(u)}(a>1||null!==l.parent)&&(l=this._copyTree(l));let i=null,r=o.scene3js;r&&r.isSGOrdered()&&(t||0===t?t>0&&(i=o.children[t-1]._getLastRenderableOcc()):i=o._getLastRenderableOcc(),i||(i=o._getPreviousRenderableOcc()),i||(i={next:o._getNextRenderableOcc()})),t||0===t?o.children.splice(t,0,l):o.children.push(l),l.parent=o,this._updateOccurrences(o,l,I.UpdateMatrixMode.Always,null,I.InvalidateGSSOMode.Always,i),d&&l.requestOverridesUpdate()}return this._getNeedBEUpdate()||e._areBoundingElementsIncludedInParent(this)||this._invalidateBoundingElements(!1,!1),e.traverseUnique((function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()})),r||this._addChild_publishEvent(e,t),!0},_addChild_publishEvent(e,r){this.onLinkToSceneGraph(e);for(var n={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"ADD",fromNode:this,toNode:e},s=this._getAllOwningViewers(),a=0;a<s.length;a++)i.DecalManager.updateDecalsData(s[a],!1);t.publish({event:"/VISU/onSceneGraphUpdate",data:n})},removeChild:function(e){if(!e)return!1;if(R>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate&&e._getForbidHierarchyUpdate())return!1;var r,n,s,a,o,l,h;if(this._setTreeModified(),-1===(r=this.children.indexOf(e)))return!1;if(this.children.splice(r,1),-1===(n=e.parents.indexOf(this)))return!1;e.parents.splice(n,1),e._isDecal&&this.decalCount--,this.onLinkToSceneGraph(e);var c=this._getAllOwningViewers();if(e.traverse((function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(t=0;t<c.length;t++){for(i=0;i<r.length;i++)c[t]._removeClippingPlane(r[i]);c[t]._requestClippingUpdate()}})),s=this._occurrences.length,a=e._occurrences.length,!s||!a)return!1;for(p=0;p<s;p++)if(o=this._occurrences[p],a=e._occurrences.length,l=e._occurrences[0],1===a){-1!==(r=o.children.indexOf(l))&&o.children.splice(r,1),l.parent=null;let t=o.scene3js;t&&t.isSGOrdered()&&l._unlinkRenderableOccs(),l.material=e._material,e._matrix?l.matrix=e._matrix.clone():l.matrix=null,null!==l.renderable&&(l.renderable.setMatrix(l.matrix,!1),"Mesh3D"===l.node.getNodeType()||"ParticlesNode3D"===l.node.getNodeType()?(null!==l.material&&(l.renderable.material=l.material),null!==l.matApp&&(l.renderable.matApp=l.matApp),null!==l.gas&&(l.renderable.gas=l.gas),null!==l.scene3js&&l.scene3js.containsObject(l.renderable)&&(this._removeFromVisuSelection(l.renderable),l.scene3js.remove(l.renderable),"Mesh3D"===l.node.getNodeType()&&l.renderable.releaseVBO(!1))):"LightNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLight(l.renderable)&&l.scene3js.remove(l.renderable):"LensFlareNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLensFlare(l.renderable)&&l.scene3js.remove(l.renderable):"CSS2DNode"===l.node.getNodeType()||"CSS3DNode"===l.node.getNodeType()?(l.renderable.element.parentNode&&l.renderable.element.parentNode.removeChild(l.renderable.element),null!==l.scene3js&&l.scene3js.remove(l.renderable)):"GaussianNode3D"==l.node.getNodeType()&&(null!==l.material&&(l.renderable.material=l.material),null!==l.matApp&&(l.renderable.matApp=l.matApp),null!==l.gas&&(l.renderable.gas=l.gas),null!==l.scene3js&&l.scene3js.containsObject(l.renderable)&&(this._removeFromVisuSelection(l.renderable),l.scene3js.remove(l.renderable),l.renderable.releaseVBO(!1))));var d=l.scene3js&&l.scene3js.viewer;for(d&&2===d._sceneGraphStateVersion&&l.traverse((function(e){e.originalOverrideSet&&(e.originalOverrideSet.onDetach(d,e),e.originalOverrideSet=null),e.overrideLink=null})),l.scene3js=null,h=0;h<l.children.length;h++)this._updateOccurrences(l,l.children[h],I.UpdateMatrixMode.Always,void 0,I.InvalidateGSSOMode.Always)}else{for(h=0;h<o.children.length&&(l=o.children[h]).node!==e;h++);o.children.splice(h,1),l._unlinkRenderableOccs(),this._deleteTree(l)}this._removeInvalidElementsInXSO(e),e.getExcludeFromBounding()||this._invalidateBoundingElements(!1,!1),e.traverseUnique((function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()}));for(var u={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"REMOVE",fromNode:this,toNode:e},p=0;p<c.length;p++)i.DecalManager.updateDecalsData(c[p],!0);return t.publish({event:"/VISU/onSceneGraphUpdate",data:u}),e._cleanTemp(),!0},_cleanTemp:function(){},removeChildren:function(){if(this._getForbidHierarchyUpdate())return!1;for(;this.children.length;)this.removeChild(this.children[0],!1);return this._invalidateBoundingElements(!1,!1),!0},traverse:function(e,t,i){var r,n,s=!1;s=e(this,t);var a=i?this.parents:this.children;if(n=a.length,!s)for(r=0;r<n&&!(s=a[r].traverse(e,t,i));r++);return s},traverseUnique:function(e,t,i,r){if(!w){var n=new Set;this._traverse_internal(e,t,i,r,n);var s=[];return n.forEach((e=>{s.push(e)})),s}},_traverse_internal:function(e,t,i,r,n){if(!w&&!n.has(this)){n.add(this);var s,a,o;o=e(this,t);var l=i?this.parents:this.children;if(a=l.length,!o)for(s=0;s<a;s++)l[s]._traverse_internal(e,t,i,r,n)}},getChildrenByName:function(e,t){var i={root:this,nodes:[]};return this.traverse((function(t,i){return t.name===e&&i.nodes.push(t),!1}),i,t),i.nodes},_forceGeomType:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._forceGeomType(e)},_setRatio:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setRatio(e)},_setFixedSizeCameraName:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){for(var r=0;r<this.children.length;r++)this.children[r]._setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setFixedSizeCenter(e,t)},getChildByName:function(e,t){var i={root:this,node:null};return this.traverse((function(t,i){return t.name===e&&(i.node=t,!0)}),i,t),i.node},getDirectChildByName:function(e){for(let t=0;t<this.children.length;t++){const i=this.children[t];if(i.name===e)return i}return null},getChildById:function(e,t){var i={root:this,node:null};return this.traverse((function(t,i){return t.persistentId===e&&(i.node=t,!0)}),i,t),i.node},_reduceMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].releaseVBO(!0)},_incrementMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].addRefVBO(!0)},oldSetMaterial:function(e){this._material!==e&&(this._reduceMaterial(),this._material&&this._material._usedBy.delete(this),this._material=e,this._updateMaterial(),this._incrementMaterial(),this._material&&this._material._usedBy.add(this))},_updateMaterial:function(e=!0){var t,r,n,s,a,o,l=this._material;if(e||l){for(t=this._occurrences.length,a=0;a<t;a++)(n=this._occurrences[a]).material=l,null!==n.renderable&&(n.renderable._flagAsGSSOInvalidated(),i.disableJHGDev&&null===n.material||(n.renderable.material=n.material));for(a=0;a<t;a++)for(r=(n=this._occurrences[a]).children.length,o=0;o<r;o++)s=n.children[o],this._updateOccurrences(n,s,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always)}},_setMaterialOnGeomTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setMaterialOnGeomTypes(e,t)},_setMaterialOnGLTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setMaterialOnGLTypes(e,t)},_setGASOnGeomTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setGASOnGeomTypes(e,t)},_setGASOnGLTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setGASOnGLTypes(e,t)},setMaterial:function(e){if(window.newMaterialInheritance){var t=this._matApp&&this._matApp._getParametersFromMaterial(e)||new u({})._getParametersFromMaterial(e);if(t){this._reduceMaterial();var i=new u(t);i._checkForceFlag=!0,this.__setMaterialApplication(i),this._incrementMaterial()}}else this.oldSetMaterial(e)},getMaterialApplication:function(){return this._matApp},setMaterialApplication:function(e){this._reduceMaterial(),this.__setMaterialApplication(e),this._incrementMaterial()},removeMaterialApplication:function(){this._reduceMaterial(),this.__removeMaterialApplication(),this._incrementMaterial()},_getMaterialApplication:function(){return this._matApp},_setMaterialApplication:function(e){console.error("Do not use private internal APIs: please use setMaterialApplication(iMatApp) instead"),this.setMaterialApplication(e)},__setMaterialApplication:function(e){var t=this._getMaterialApplication();t!==e&&(t&&t._usedBy.delete(this),t?(e._layer<t._layer||e._layer===t._layer&&e._inheritance>=t._inheritance)&&(this._matApp=e):this._matApp=e,this._updateMaterialApplication(),this._matApp&&this._matApp._usedBy.add(this))},_removeMaterialApplication:function(){console.error("Do not use private internal APIs: please use removeMaterialApplication() instead"),this.removeMaterialApplication()},__removeMaterialApplication:function(){this._matApp&&this._matApp._usedBy.delete(this),this._matApp=null,this._updateMaterialApplication()},_updateMaterialApplication:function(e=!0){var t,i,r,n;t=this._occurrences.length;var s=this._getMaterialApplication();if(e||s)for(n=0;n<t;n++)!(r=(i=this._occurrences[n]).parent)&&s?i.matApp=s:this._updateOccurrences(r,i,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always),null!==i.renderable&&(i.renderable.matApp=i.matApp)},setGAS:function(e){this._reduceMaterial(),this._setGAS(e),this._incrementMaterial()},getGAS:function(){return this._gas},_setGAS:function(e){if(e){var t,i,r,n,s=this._gas;if(this._gas=e.__getGAS(this._gas),!this._gas._isEqual(s))for(t=this._occurrences.length,n=0;n<t;n++)(r=(i=this._occurrences[n]).parent)?this._updateOccurrences(r,i,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always):i.gas=this._gas?this._gas.clone():null,null!==i.renderable&&(i.renderable.gas=i.gas)}},_getGAS:function(){return this._gas},setVisibility:function(e,r){if(this._getVisible()!==e){var n,s,a,o;if(this._setVisible(e),r)(h=this._getViewer())&&(o=h.getRobot()),o&&o.isTargetGone(h.visibleSpace)&&o.setConnectionState(!1);if(0===this.parents.length)for(n=this._occurrences.length,a=0;a<n;a++){if((s=this._occurrences[a]).parent?s._setVisible(s.parent._getVisible()&&this._getVisible()):s._setVisible(this._getVisible()),null!==s.renderable){s.renderable.visible=s._getVisible();var l,h=null;if(void 0!==s.renderable.highlightMeshes&&null!==s.renderable.highlightMeshes)if(!(h=s.scene3js&&s.scene3js.viewer)||!h.picking.forceVisibility)for(l=0;l<s.renderable.highlightMeshes.length;l++)s.renderable.highlightMeshes[l].renderable.visible=s._getVisible();if(void 0!==s.renderable.preHighlight&&null!==s.renderable.preHighlight&&(h||(h=s.scene3js&&s.scene3js.viewer),h&&h.pPicking.forceVisibility||(s.renderable.preHighlight.visible=s._getVisible())),s.renderable instanceof i.CSS2DNode||s.renderable instanceof i.CSS3DNode){var c=!0;this._getViewer()&&(c=this._getViewer().visibleSpace);(s._getVisibilityFree()||c?s._getVisible():!s._getVisible())||(s.renderable.element.style.display="none")}}s.updateVisibilityFlag()}this._updateNodeOccurrences(I.UpdateMatrixMode.Always,void 0,I.InvalidateGSSOMode.Always),this._updateVisibilityFlag();var d={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"SHOWTREE":"HIDETREE",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:d})}},setVisibilityFree:function(e){if(this._getVisibilityFree()!==e){var r,n,s,a;if(this._setVisibilityFree(e),(l=this._getViewer())&&(a=l.getRobot()),a&&a.isTargetGone(l.visibleSpace)&&a.setConnectionState(!1),0===this.parents.length)for(r=this._occurrences.length,s=0;s<r;s++){if((n=this._occurrences[s]).parent?n._setVisibilityFree(n.parent._getVisibilityFree()||this._getVisibilityFree()):n._setVisibilityFree(this._getVisibilityFree()),null!==n.renderable){n.renderable.visibilityFree=n._getVisibilityFree();var o,l=null;if(void 0!==n.renderable.highlightMeshes&&null!==n.renderable.highlightMeshes)if(!(l=n.scene3js&&n.scene3js.viewer)||!l.picking.forceVisibility)for(o=0;o<n.renderable.highlightMeshes.length;o++)n.renderable.highlightMeshes[o].renderable.visibilityFree=n._getVisibilityFree();if(void 0!==n.renderable.preHighlight&&null!==n.renderable.preHighlight&&(l||(l=n.scene3js&&n.scene3js.viewer),l&&l.pPicking.forceVisibility||(n.renderable.preHighlight.visibilityFree=n._getVisibilityFree())),n.renderable instanceof i.CSS2DNode||n.renderable instanceof i.CSS3DNode){var h=!0;this._getViewer()&&(h=this._getViewer().visibleSpace);(n._getVisibilityFree()||h?n._getVisible():!n._getVisible())||(n.renderable.element.style.display="none")}}n.updateVisibilityFreeFlag()}this._updateNodeOccurrences(I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always),this._updateVisibilityFreeFlag();var c={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"VISIBILITYFREE":"VISIBILITYDEPENDENT",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:c})}},setMatrix:function(e,t){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var r=new Error;console.error(r.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}let n=this._matrix;!e&&!n||e&&n&&e.equals(n)||(!e||e.isIdentity()?this._matrix=null:n?n.copy(e):this._matrix=(new i.Matrix4).copy(e),this._updateMatrix(t))},applyMatrix:function(e){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var t=new Error;console.error(t.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}e&&!e.isIdentity()&&(this._matrix?(this._matrix.multiplyMatrices(e,this._matrix),this._matrix.isIdentity()&&(this._matrix=null)):(this._matrix=new i.Matrix4,this._matrix.copy(e))),this._updateMatrix()},setVisibilityInTree:function(e){if(this._getVisibilityInTree()!==e){this._setVisibilityInTree(e);for(var i=0;i<this.parents.length;i++){var r={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"ADDTREE":"REMOVETREE",fromNode:this.parents[i],toNode:this};t.publish({event:"/VISU/onSceneGraphUpdate",data:r})}}},getVisibilityInTree:function(){return void 0===this._getVisibilityInTree()||this._getVisibilityInTree()},setIcon:function(e){this._iconInTree=""===e?"":e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGEICON",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getIcon:function(){return void 0!==this._iconInTree?this._iconInTree:""},setName:function(e){this.name=e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGENAME",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getName:function(){return this.name},getPickable:function(){return this.getNoPickThrough()?this._getPickable()?s.PICKABLE:s.NOPICKABLE:s.PICKTHROUGH},setPickable:function(e){var t,i,r;if("boolean"==typeof e&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),this._setPickable(e===s.PICKABLE),this.setNoPickThrough(e!==s.PICKTHROUGH),0===this.parents.length)for(t=this._occurrences.length,r=0;r<t;r++)(i=this._occurrences[r]).parent?(i._setPickable(i.parent._getPickable()&&this._getPickable()),i.setNoPickThrough(i.parent.getNoPickThrough()&&this.getNoPickThrough())):(i._setPickable(this._getPickable()),i.setNoPickThrough(this.getNoPickThrough())),null!==i.renderable&&(i.renderable.pickable=i._getPickable(),i.renderable.noPickThrough=i.getNoPickThrough(),i.renderable._flagAsGSSOInvalidated());this._updateNodeOccurrences(I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always)},isPickable:function(){return this._getPickable()},getNoZPriority:function(){return this._getNoZPriority()},setNoZPriority:function(e){var t,i,r,n,s,a;for(this._setNoZPriority(e),t=this._occurrences.length,s=0;s<t;s++){var o=(r=this._occurrences[s]).parent;if(o)this._updateOccurrences(o,r,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always);else for(i=r.children.length,a=0;a<i;a++)n=r.children[a],this._updateOccurrences(r,n,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always)}},setPickParent:function(e){this._setPickParent(e)},getPickParent:function(){return!!this._getPickParent()},_setPickParentWithPrimitives:function(e){this.__setPickParentWithPrimitives(e)},_getPickParentWithPrimitives:function(){return!!this.__getPickParentWithPrimitives()},setPickingPriorityId:function(e){var t,i,r,n,s,a;for(this.pickingPriorityID||(this.pickingPriorityID={faces:null,edges:null,points:null}),"string"==typeof e&&(this.pickingPriorityID.faces=e,this.pickingPriorityID.edges=e,this.pickingPriorityID.points=e),(e.faces||null===e.faces)&&(this.pickingPriorityID.faces=e.faces),(e.edges||null===e.edges)&&(this.pickingPriorityID.edges=e.edges),(e.points||null===e.points)&&(this.pickingPriorityID.points=e.points),t=this._occurrences.length,s=0;s<t;s++)(r=this._occurrences[s]).pickingPriorityID=this.pickingPriorityID,null!==r.renderable&&(r.renderable.pickingPriorityID=r.pickingPriorityID);for(s=0;s<t;s++)for(i=(r=this._occurrences[s]).children.length,a=0;a<i;a++)n=r.children[a],this._updateOccurrences(r,n,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always)},getPickingPriorityId:function(){return this.pickingPriorityID},exludeFromBounding:function(e){this.setExcludeFromBounding(e),this._invalidateBoundingElements(!1,!0)},translate:function(e,t){var r=new i.Vector3;this._matrix&&(t.transformDirection(this._matrix),r.getPositionFromMatrix(this._matrix)),r.add(t.multiplyScalar(e)),this._matrix||(this._matrix=new i.Matrix4),this._matrix.setPosition(r),this._updateMatrix()},translateX:function(e){var t=new i.Vector3(1,0,0);this.translate(e,t)},translateY:function(e){var t=new i.Vector3(0,1,0);this.translate(e,t)},translateZ:function(e){var t=new i.Vector3(0,0,1);this.translate(e,t)},getMaterial:function(e){var t=this._filters?this._filters.get(T.LOOK):null,i=this._getMaterialApplication();if(!i||t){var r=t?t.material:this._material;if(r)switch(e){case"Face":case"GeomFace":return r;case"Line":return r.line;case"Point":return r.point}return r}switch(e){case"Face":return i._material;case"GeomFace":return i._materialGeomFace;case"Line":return i._materialLine;case"Point":return i._materialPoint}return i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null},isVisible:function(){return this._getVisible()},getMatrix:function(){return this._matrix?this._matrix.clone():new i.Matrix4},getChildren:function(){return[].concat(this.children)},getParents:function(){return[].concat(this.parents)},getNodeType:function(){return"Node3D"},whiteVectorInBlack:function(){this.modifyColor(new i.Color(0),new i.Color(16777215))},modifyColor:function(e,t,r){if(!w){if("Mesh3D"===this.getNodeType()){var n=this._occurrences[0].renderable.geometry;if(!(n instanceof Array))return;for(var s=0;s<n.length;s++)for(var a=n[s].drawingGroups,o=0;o<a.length;o++){var l=a[o];if(l.gas&&l.gas.color){if(l.gas instanceof i.ParticleBasicMaterial)continue;var h=l.gas.color;if(r&&r!==l.glType)continue;if(h.equals(t)){var c=l.gas.clone();c.color=e,l.gas=c}}if(l.material&&l.material.color){if(l.material instanceof i.ParticleBasicMaterial)continue;h=l.material.color;if(r&&r!==l.glType)continue;if(h.equals(t)){var d=l.material.clone();d.color=e,l.material=d}}}}for(o=0;o<this.children.length;o++)this.children[o].modifyColor(e,t,r)}},getBoundingSphere:function(e,t){"show"===e&&(console.error("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.error("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");var i=this._getBoundingSphere(e,t);return i?i.clone():null},createOverrideSetManager:function(){return!this._overrideSetManager&&I.SceneGraphOverrideSetManager&&this._setOverrideSetManager(new I.SceneGraphOverrideSetManager({node:this})),this._overrideSetManager},getOverrideSetManager:function(){return this._overrideSetManager},removeOverrideSetManager:function(){this._overrideSetManager&&(this._overrideSetManager.clear(),this._overrideSetManager=null)},_setOverrideSetManager:function(e){this._overrideSetManager=e,this._setOverrideSetManagerUnder(!0)},_getViewer:function(){return this._occurrences.length>0&&this._occurrences[0].scene3js?this._occurrences[0].scene3js.viewer:null},_getAllOwningViewers:function(){var e,t,i=[];for(e=0;e<this._occurrences.length;e++)this._occurrences[e].scene3js&&(t=this._occurrences[e].scene3js.viewer)&&i.indexOf(t)<0&&i.push(t);return i},_hasOccurrenceInViewer:function(e){var t;for(t=0;t<this._occurrences.length;t++)if(this._occurrences[t].scene3js&&e===this._occurrences[t].scene3js.viewer)return!0;return!1},_tryOverridesUpdate:function(e){e._idPathOverrideWatcher&&!e.isManipulatedViewpointMoving()&&e._idPathOverrideWatcher.update();var t,i=e?e.hasSceneGraphOverrideSet():null,r=this._occurrences;if(this._getOverrideSetManagerUnder()){let e=new Set;for(t=0;t<r.length;t++){r[t].traverseWithCondition((function(t){let i=t.node;return i._overrideSetManager&&e.add(i._overrideSetManager),!(!i._getOverrideSetManagerUnder()||!t._getDescendantNeedsOverridesUpdate())}))}e.forEach((e=>{e._refresh(!0),i=!0}))}let n=[];for(t=0;t<r.length;t++)r[t].traverseWithCondition((function(e){return e.ldhOccurrence?(n.push(e),null):e.isOverridesUpdateRequested()?(e.updateOverrideStatus(i),null):!!e.doesADescendantNeedOverrideUpdate()||null}));for(t=0;t<n.length;t++)n[t].clearOverridesUpdateRequest();for(t=0;t<r.length;t++)r[t].clearOverridesUpdateRequest();e&&e._oocManager&&!e._oocManager.isSlave()&&e._oocManager._ldhNodeManager.tryCandidateOverridesUpdate()},forceBoundingElements:function(e,t,r){function n(e){var t=null;return void 0===e.sphere&&void 0===e.box||(t={sphere:e.sphere||function(e){if(!e)return null;var t=new i.Vector3(.5*(e.min.x+e.max.x),.5*(e.min.y+e.max.y),.5*(e.min.z+e.max.z)),r=t.distanceTo(e.max),n=new i.Sphere;return n.center=t,n.radius=r,n}(e.box),box:e.box||function(e){if(!e)return null;var t=new i.Vector3(2*e.radius,2*e.radius,2*e.radius),r=new i.Box3;return r.setFromCenterAndSize(e.center,t),r}(e.sphere)}),t}if(e){r=r||{};var s=n(t=t||{}),a=n(r);this.__forceBoundingElements(s,a)}else this._getForceBoundingElements()&&(this._setForceBoundingElements(!1),this._invalidateBoundingElements(!1,!1))},__forceBoundingElements:function(e,t){this._setForceBoundingElements(!0),this._bsShow=e&&e.sphere,this._bsNoShow=t&&t.sphere,this._bbShow=e&&e.box,this._bbNoShow=t&&t.box,this._invalidateBoundingElements(!1,!1)},getBoundingBox:function(e){return"show"===e&&(console.error("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.error("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace"),this._getBoundingBox(e).clone()},_getBoundingSphere:function(e,t){e=e||"visibleSpace";var r,n,s=null;return this.getHasExplicitBE()&&0===this.children.length?(r=this.explicitBSphere,n=null):(this._updateBoundingElements(),r=this._bsShow,n=this._bsNoShow),(s=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingSphereInto(r&&r.clone(),n,this.getRatio()))||t||(s=new i.Sphere),s},_getBoundingBox:function(e){e=e||"visibleSpace";var t,r,n=null;return this.getHasExplicitBE()&&0===this.children.length?(t=this.explicitBBox,r=null):(this._updateBoundingElements(),t=this._bbShow,r=this._bbNoShow),(n=this._getVisibilityFree()?this._getVisible()?t:null:this._getVisible()?"visibleSpace"===e?t:r:"visibleSpace"===e?null:i.mergeBoundingBoxInto(t&&t.clone(),r))||(n=new i.Box3),n},_invalidateBoundingElements:function(e,t){if(!e){var i=0;for(i=0;i<this._occurrences.length;i++)this._occurrences[i]._invalidateBoundingElements(t)}if(!this._getNeedBEUpdate()&&(this._setNeedBEUpdate(!0),!this.getExcludeFromBounding()||t)){var r=0;for(r=0;r<this.parents.length;r++)this.parents[r]._invalidateBoundingElements(!0,!1)}},_updateVisibilityFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateVisibilityFreeFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateShadowMapsIfNeeded:function(e){var t=this._getViewer(),i=e;return t&&t.useShadowMap&&!t._shadowUpdated&&(void 0===i&&(i=!0,this.traverse((function(e){return!!e.getExcludeFromBounding()&&(i=!1,!0)}),void 0,!0)),(i=i&&!this.getExcludeFromBounding())&&t._updateShadowMaps()),i},_updateBoundingElements:function(e,t){var r;if(this._getNeedBEUpdate()){if(t=this._updateShadowMapsIfNeeded(t),!this._getForceBoundingElements()){for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this.updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"explicitBSphere"),this.updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"explicitBBox")}if(!e)for(r=0;r<this._occurrences.length;r++)this._occurrences[r]._updateBoundingElements(!0);this._setNeedBEUpdate(!1)}},_areBoundingElementsIncludedInParent:function(e){var t=new i.Sphere,r=new i.Box3,n=this._matrix;function s(e,i){return!(e&&!i)&&(!e||(t.copy(e),n&&t.applyMatrix4(n),!!i.containsSphere(t)))}function a(e,t){return!(e&&!t)&&(!e||(r.copy(e),n&&r.applyMatrix4(n),!!t.containsBox(r)))}return this._updateBoundingElements(),s(this._bsShow,e._bsShow)&&a(this._bbShow,e._bbShow)&&s(this._bsNoShow,e._bsNoShow)&&a(this._bbNoShow,e._bbNoShow)},updateBoundingElements_internal:function(e,t,i,r){if(!this._getForceBoundingElements()){var n=null,s=null;if(this.children.length){var a,o,l,h=0;for(h=0;h<this.children.length;h++)(a=this.children[h]).getExcludeFromBounding()||(o=a[e],l=a[t],a._getVisibilityFree()?a._getVisible()&&(n=i(n,o,a._matrix,a.getRatio()),s=i(s,o,a._matrix,a.getRatio())):a._getVisible()?(n=i(n,o,a._matrix,a.getRatio()),s=i(s,l,a._matrix,a.getRatio())):(s=i(s,o,a._matrix,a.getRatio()),s=i(s,l,a._matrix,a.getRatio())))}if(n=this._modifyBE(n,i),s=this._modifyBE(s,i),this.getHasExplicitBE()){var c=this[r];n=n&&c?i(n,c,null,0):c}this[e]=n,this[t]=s}},getRatio:function(){return 0},updateBoundingSphere:function(){this._invalidateBoundingElements(!1,!1)},updateBoundingSphereFromParentToChildren:function(){I.DEPRECATED_Method(new Error)},updateBoundingBox:function(){this._invalidateBoundingElements(!1,!1)},isIncludedIn:function(e){if(!this.bSphere.radius)return!0;var t=this.bSphere.clone();return this._matrix&&t.applyMatrix4(this._matrix),t.center.distanceTo(e.bSphere.center)+t.radius<=e.bSphere.radius},getMatrixWorld:function(e){if(w)return null;var t,s;if(1===this._occurrences.length)return this._occurrences[0].matrix?this._occurrences[0].matrix.clone():new i.Matrix4;if(void 0===e)return console.warn("This node is an instance. An occurrence path has to be specified."),null;if(e instanceof r){var a=new n;a.setFromOccurrencePath(e),e=a}if((s=e._getOccurrences()).length>1)return console.warn("More than one occurrence satisfies this occurrence path. Unable to return a unique matrixWorld."),null;if(!s.length)return console.warn("No occurrence satisfies this occurrence path. Unable to return a matrixWorld."),null;for(t=0;t<this._occurrences.length;t++)if(s[0]===this._occurrences[t])return s[0].matrix?s[0].matrix.clone():new i.Matrix4;return console.warn("The occurrence path has to terminate with the current node name. Unable to return a matrixWorld."),null},isInstance:function(){return this._occurrences.length>1},buildAccelerationStructure:function(e){for(var t=this._occurrences.length,i=0;i<t;i++)for(var r=this._occurrences[i]._getRenderableOccurrences(),n=0;n<r.length;n++){r[n].computeKDTree(e)}},setScene:function(e){var t,i,r,n,s,a;for(t=this._occurrences.length,s=0;s<t;s++)(r=this._occurrences[s]).scene3js=e;for(s=0;s<t;s++)for(i=(r=this._occurrences[s]).children.length,a=0;a<i;a++)n=r.children[a],this._updateOccurrences(r,n,I.UpdateMatrixMode.Always,void 0,I.InvalidateGSSOMode.Always)},subscribe:function(e,t){void 0===this.modelEvents&&(this.modelEvents=new a),this.modelEvents.subscribe(e,t)},isReady:function(){return!0},_updateMatrix:function(e){var t,i,r,n;if(0===this.parents.length)for(t=this._occurrences.length,r=0;r<t;r++)if((i=this._occurrences[r]).updateMatrix(this._matrix),null!==i.renderable){var s;if(i.renderable.setMatrix(i.matrix,!1),i.renderable.orientation=!i.matrix||i.matrix.determinant()>0?1:-1,void 0!==i.renderable.highlightMeshes&&null!==i.renderable.highlightMeshes)for(s=0;s<i.renderable.highlightMeshes.length;s++)i.renderable.highlightMeshes[s].renderable.setMatrix(i.matrix,!1);if(void 0!==i.renderable.preHighlight&&null!==i.renderable.preHighlight&&i.renderable.preHighlight.setMatrix(i.matrix,!1),i.scene3js&&i.scene3js.viewer)if(void 0!==i.renderable.updateShadowMap)i.renderable.updateShadowMap=!0;else if(i.renderable.castShadow)for(var a=0;a<i.scene3js.parent.__lights.length;a++){var o=i.scene3js.parent.__lights[a];o.blockUpdate||(o.updateShadowMap=!0)}}if(this._updateNodeOccurrences(I.UpdateMatrixMode.Always,e,I.InvalidateGSSOMode.Never),!e)for(r=0,n=this.parents.length;r<n;r++)this.getExcludeFromBounding()||this.parents[r]._invalidateBoundingElements(!1,!1)},_copyTree:function(e){var t,i,r,n,s;for(t=e.lightCopy(),"InstancingNode3D"==e.node.getNodeType()&&e.node._propagateInstancingParameters(t,e._instancingInfos),e.node._occurrences.push(t),e._invalidateBoundingElements(!1),r=e.children.length,s=0;s<r;s++)n=e.children[s],(i=this._copyTree(n)).parent=t,t.children.push(i),t._invalidateBoundingElements(!1);return t},_deleteTree:function(e){var t,i,r,n,s;-1!==(i=(t=e.node)._occurrences.indexOf(e))&&t._occurrences.splice(i,1),null!==e.renderable&&null!==e.scene3js&&("Mesh3D"===e.node.getNodeType()||"ParticlesNode3D"===e.node.getNodeType()?e.scene3js.containsObject(e.renderable)&&(this._removeFromVisuSelection(e.renderable),e.scene3js.remove(e.renderable),"Mesh3D"===e.node.getNodeType()&&e.renderable.releaseVBO(!1)):"LightNode3D"===e.node.getNodeType()?e.scene3js.containsLight(e.renderable)&&e.scene3js.remove(e.renderable):"LensFlareNode3D"===e.node.getNodeType()?e.scene3js.containsLensFlare(e.renderable)&&e.scene3js.remove(e.renderable):"CSS2DNode"===e.node.getNodeType()||"CSS3DNode"===e.node.getNodeType()?e.scene3js.containsObject(e.renderable)&&(e.scene3js.remove(e.renderable),e.renderable.element.parentNode&&e.renderable.element.parentNode.removeChild(e.renderable.element)):"GaussianNode3D"==e.node.getNodeType()&&e.scene3js.containsObject(e.renderable)&&(this._removeFromVisuSelection(e.renderable),e.scene3js.remove(e.renderable),e.renderable.releaseVBO(!1)));var a=e.scene3js&&e.scene3js.viewer;for(a&&2===a._sceneGraphStateVersion&&(e.originalOverrideSet&&(e.originalOverrideSet.onDetach(a,e),e.originalOverrideSet=null),e.overrideLink=null),e.scene3js=null,n=e.children.length,r=0;r<n;r++)s=e.children[r],this._deleteTree(s)},forceUpdate:function(){this._forceUpdate()},_forceUpdate:function(){var e,t,i=this._getAllOwningViewers();for(e=0;e<i.length;e++)i[e]&&this._tryOverridesUpdate(i[e]);if(this.parents.length>0)for(e=0;e<this._occurrences.length;e++)t=this._occurrences[e],this._updateOccurrences(t.parent,t,I.UpdateMatrixMode.Always,void 0,I.InvalidateGSSOMode.Always);else for(e=0;e<this.children.length;e++)this.children[e]._forceUpdate()},onLinkToSceneGraph:function(e){if(!w){var t,i,r=e.traverseUnique((function(e){})),n=[],s=[];for(t=0;t<r.length;t++)(i=r[t])._occurrences[0].__rdo_visited=0;for(t=0;t<r.length;t++){for(i=r[t],a=0;a<i.children.length;a++)i.children[a]._occurrences[0].__rdo_visited++}for(e._onLinkToSceneGraph_internal(!0,n,s),t=0;t<r.length;t++){var a;(i=r[t])._occurrences[0].__rdo_visited=0}for(t=n.length-1;t>=0;t--)(i=n[t])._onLinkedToSceneGraph(),i._requestClippingUpdate();for(t=s.length-1;t>=0;t--)(i=s[t])._onUnlinkedToSceneGraph(),i._requestClippingUpdate();null!==I._onLinkToSceneGraph_DEBUG&&I._onLinkToSceneGraph_DEBUG(r,n,s)}},_onLinkToSceneGraph_internal:function(e,t,i){var r,n=!1;if(!w){var s,a=e;for(r=0;!a&&r<this.parents.length;r++)(s=this.parents[r])._occurrences.length>0&&-1===s._occurrences[0].__rdo_visited&&(a=!0);if(a){for(r=0;r<this.parents.length;r++)if(this.parents[r].getLinkedToSceneGraph()){n=!0;break}var o;for(this.getLinkedToSceneGraph()!==n&&(this.setLinkedToSceneGraph(n),this._occurrences[0].__rdo_visited=-1,n?t.push(this):i.push(this)),r=0;r<this.children.length;r++)(o=this.children[r])._occurrences[0].__rdo_visited--,0===o._occurrences[0].__rdo_visited&&o._onLinkToSceneGraph_internal(!1,t,i)}}},_propagateGAS:function(e,t){t?e.gas?e.gas.copy(t):e.gas=t.clone():e.gas=null},_propagateMatApp:function(e,t){t?(e.matApp?e.matApp.copy(t):e.matApp=t.clone(),-1===e.matApp._depth&&(e.matApp._depth=e.depth)):e.matApp=null},_propagateInstancingParameters:function(e,t){e._instancingInfos=t?{isInstanceNode3D:t.isInstanceNode3D,nbInstances:t.nbInstances,drawCount:t.drawCount,instancingSelectionMode:t.instancingSelectionMode,instanceAttribArrays:t.instanceAttribArrays,instanceAttribArrays_id:t.instanceAttribArrays_id,pickedInstanceId:[],useDefaultInstancing:t.useDefaultInstancing}:null;const r=e.renderable;if(r&&(!r._instancingInfos||r._instancingInfos.useDefaultInstancing)){var n;if(r._instancingInfos=e._instancingInfos,r._instancingInfos&&r.highlightMeshes)for(n=0;n<r.highlightMeshes.length;n++){let t=r.highlightMeshes[n].renderable._instancingInfos.instanceAttribArrays;for(let i in t)t[i].isDynamic=e._instancingInfos.instanceAttribArrays[i].isDynamic}let t=r._programID;r._instancingInfos?r._programID|=i.ProgramIDs.DEFAULT_INSTANCING:r._programID&=~i.ProgramIDs.DEFAULT_INSTANCING,t!==r._programID&&r._flagAsGSSOInvalidated()}},_updateOccurrences:function(e,t,r,s,a,l){if(w)return;var h,c,u,p;h=e.node,c=t.node,e.parent||(e.depth=0),t.depth=e.depth+1,t._copyForceShowStatusFromOcc(e),u=t.scene3js;var f=null,g=null,m=null,v=null,_=null,y=null,S=null,b=null,x=!1,P=!1,C=!1;let M=t.getOverrideLinkToUse(),E=t.getOriginalOverrideSetToUse();if(E&&E.resetGSSOCache&&(E.unsetResetGSSOCache(),a=I.InvalidateGSSOMode.Always),t._getRequestGSSOUpdate()&&(a=I.InvalidateGSSOMode.Always,t._setRequestGSSOUpdate(!1)),M){if(t.renderable&&(M.internalMaterialOverrideReset&&(M.internalMaterialOverrideReset=!1,t.renderable.layer=null),M.internalMaterialOverride&&E)){var D=M.internalMaterialOverride;D.material&&((p=new n).setFromArray(E.pathElement.externalPath,D.internalPath),I._applyMaterialToPath(p,D.material)),M.internalMaterialOverrideReset=!0}f=M.getSubstituteMatrix(),g=M.getVisibility(),y=M.getVisibilityFree(),m=M.getPickability(),v=M.getPickingPriorityID(),_=M.getClipping(),S=M.getRenderStyle(),P=M.visibilityFix,E&&E.invalidateBE&&(E.unsetInvalidateBE(),x=!0),M.getMatrixUpdate()&&(M.clearMatrixUpdate(),C=!0),g&&M.getForceShowVisibility()&&!g.visibility&&t._setForceShowHide(!0),m&&M.getForceShowPickability()&&("NOT_PICKABLE"===m?t._setForceShowNoPickability(!0):"IGNORED"===m&&(t._setForceShowNoPickability(!0),t._setForceShowNoDrawHL(!0)))}t.setIsInBackground(e.isInBackground()&&c.isInBackground()),t._setIsAlwaysInForeground(e._isAlwaysInForeground()||c._isAlwaysInForeground());var R,O,B,F,V=null;if(t&&E&&(E.hasMaterialOverride()||E.internalMaterialOverride)&&(V=M),2===e._relativeVisibility&&(t._relativeVisibility=e._relativeVisibility),null!==t._relativeVisibility&&(P=2!==t._relativeVisibility,g={visibility:t._relativeVisibility}),null!==t){if(t.scene3js=e.scene3js,r===I.UpdateMatrixMode.Always||c._isDynamic||C)if(f)t.updateMatrix(f,!0);else{if(f=c._matrix,c._isDynamic&&t.scene3js){var G=t._getViewpoint()||t.scene3js.viewer.currentViewpoint;if(G){var N=c._getDynamicMatrix(e.matrix,null,G);N&&(f=N,c._matrix||(c._matrix=new i.Matrix4),c._matrix.copy(f),s||c._invalidateBoundingElements(!1,!1))}}t.localMatrixOverride&&(x=!0);let r=!1;t._relativeMatrix&&(f=t._relativeMatrix,t._getFrom3dxml()&&(r=!0)),t.updateMatrix(f,r)}b=e.getViewer(),t.renderMode=S?S._combineRenderMode(e.renderMode,c._renderMode):c._renderMode||e.renderMode,t.pickingMode=c._pickingMode||e.pickingMode,t.layerFilter=c._layerFilter?c._layerFilter:e.layerFilter,t._setAdvancedPriority(c._getAdvancedPriority()?c._getAdvancedPriority():e._getAdvancedPriority()),t._setDepthMode(c._getDepthMode()?c._getDepthMode():e._getDepthMode()),b&&b.currentViewpoint&&b.currentViewpoint.isNative2D()&&b.currentViewpoint._depthMode&&(c._gas?c._depthPriority=c._gas._priority-4+h._depthPriority:c._depthPriority=h._depthPriority);var U=S;t.faceMode=U&&U._combineFaceMode(e.faceMode)||e.faceMode;var k=c.passes?c.passes:e.passes;t.forcePasses&&(k=t.forcePasses);var z=t.scene3js&&t.scene3js.parent instanceof i.Scene?t.scene3js.parent:null;if(t.renderable&&t.renderable.fromLoadedModel){var H=b&&b._renderStyle,W=t.faceMode&&t.faceMode.face||H&&H._faceMode;W===d.FaceModes.ZONLY?k=["ZOnly"]:W===d.FaceModes.BACKGROUND&&(k=["background"])}var j=k,X=null;(t.renderPriority||e.renderPriority)&&(X=function(e,t){if(!t)return e&&(e.userPriority||e.userOpacity)?{userPriority:!1,priority:e.priority,userOpacity:!1,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority}:{userPriority:e.userPriority,priority:e.priority,userOpacity:e.userOpacity,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority};if(!e)return{userPriority:t.userPriority,priority:t.priority,userOpacity:t.userOpacity,opacity:t.opacity,lastRenderPriority:t.lastRenderPriority};return{userPriority:t.userPriority,priority:t.userPriority?t.priority:e.priority,userOpacity:t.userOpacity,opacity:t.userOpacity?t.opacity:e.opacity,lastRenderPriority:t.lastRenderPriority}}(e.renderPriority,t.renderPriority));var q=b&&b._renderPriorityManager&&b._renderPriorityManager.enabled;t.renderPriority=X;var Z=-1;q&&(X||(X={userPriority:!1,priority:0,userOpacity:!1,opacity:-1,lastRenderPriority:-1},t.renderPriority=X),j=function(e,t){if(!e||1===e.length&&"main"===e[0])return L[t];var i,r,n=[];for(i=0;i<e.length;i++)"main"===(r=e[i])?n=n.concat(L[t]):n.push(r);return n}(k,Z=X&&X.priority||0));var Y=j!==t.passes||t.renderPriority&&Z!==t.renderPriority.lastRenderPriority;t.renderPriority&&(t.renderPriority.lastRenderPriority=Z),t.renderable&&z&&Y&&z.updateObjectPasses(t.renderable,j),t.passes=k;let n=c.getNativeIsoLayer();if(t._isoLayer=null!==n?n:e._isoLayer,c._isDecal){var K=c._getOccAttachDecalNode(t);t.material=c._material,($=t._getMaterialApplication())?!K||$.isPrioritary(K.matApp,t.depth)?this._propagateMatApp(t,$):this._propagateMatApp(t,K.matApp):t.material=c._getPrioritaryNode(K)._material}else{var $;e.material&&"forceGeomTypeFACE"===e.material.force?t.material=c._material||e.material:t.material=null!==e.material?e.material:c._material,t.forceGAS?t.gas=t.forceGAS:(e.gas&&!c._gas?this._propagateGAS(t,e.gas):this._propagateGAS(t,c._gas),e.gas&&c._gas&&t.gas.merge(e.gas,h._filters&&h._filters.get(T.GAS_INHERIT))),($=t._getMaterialApplication())&&e.matApp?$.isPrioritary(e.matApp,t.depth)?this._propagateMatApp(t,$):this._propagateMatApp(t,e.matApp):$?this._propagateMatApp(t,$):this._propagateMatApp(t,e.matApp)}t._setInvertMode(!g&&(e._getInvertMode()||c._getInvertMode())),t._setInvertPickMode(!m&&(e._getInvertPickMode()||c._getInvertPickMode()));var Q=t._getVisible(),J=t._getVisibilityFree();P?(t._setVisible(ze(e._getVisible(),g,g&&g.visibility,c._getVisible(),M&&M.getForceShowVisibility(),t._getForceShowHide())),t._setPickable(ze(e._getPickable(),m,"PICKABLE"===m,c._getPickable(),M&&M.getForceShowPickability(),t._getForceShowNoPickability())),t.setNoPickThrough(ze(e.getNoPickThrough(),m,"IGNORED"!==m,c.getNoPickThrough(),M&&M.getForceShowPickability(),t._getForceShowNoDrawHL())),t._setVisibilityFree((R=e._getVisibilityFree(),O=y,B=y&&y.visibilityFree,F=c._getVisibilityFree(),!(M&&M.getForceShowVisibilityFree()&&O&&!B)&&(R||(O?B:F))))):(t._setVisible(g?g.visibility:e._getVisible()&&c._getVisible()),t._setVisibilityFree(e._getVisibilityFree()||c._getVisibilityFree()),t._setPickable(m?"PICKABLE"===m:e._getPickable()&&c._getPickable()),t.setNoPickThrough(m?"IGNORED"!==m:e.getNoPickThrough()&&c.getNoPickThrough())),t._setNoZPriority(e._getNoZPriority()||c._getNoZPriority());const a=!!t._getFilter(T._LOD_BRANCH);c._propagateVisuFilters(t,e._filters);const o=!!t._getFilter(T._LOD_BRANCH);if(t.renderable&&t.renderable.scene3js&&a!==o&&z.updateObjectPasses(t.renderable,t.passes),t._propagateSubstituteMaterials(e.__solvedSubstituteMaterials),e._filters&&e._filters.has(T.DO_NOT_PICK_UNDER)&&c.setPickParent(e._filters.get(T.DO_NOT_PICK_UNDER)._doNotPickUnder),t._getVisible()!==Q&&t.updateVisibilityFlag(),t._getVisibilityFree()!==J&&t.updateVisibilityFreeFlag(),e.pickingPriorityID&&e.pickingPriorityID._override?t.pickingPriorityID=e.pickingPriorityID:t.pickingPriorityID=v||(c.pickingPriorityID?c.pickingPriorityID:e.pickingPriorityID),h._getPropagateXSOExclusion()&&(c._setPropagateXSOExclusion(!0),c._setExcludeFromCSO(h._getExcludeFromCSO()),c._setExcludeFromHSO(h._getExcludeFromHSO()),c._setExcludeFromPSO(h._getExcludeFromPSO()),c._setExcludeFromHL(h._getExcludeFromHL()),c._setExcludeFromPreHL(h._getExcludeFromPreHL())),t.node._instancingInfos||this._propagateInstancingParameters(t,e._instancingInfos),b){const e=function(e){var t=c.userData||{};t.__WebVisuFilteringHandled||(t.__WebVisuFilteringHandled=!0,c.userData=t,c._getVisible()!==e&&e&&(c.setVisibility(!0),c.setVisibilityFree(!1)))};"AxisSystems"===c.name?e(b.getAxisFilter()):"RefPlanes"===c.name&&e(b.getPlanesFilter())}}if(null!==t.renderable){const e=t.renderable;a===I.InvalidateGSSOMode.Always&&e._flagAsGSSOInvalidated(),b||(b=t.getViewer()),e.filtered=t._isFiltered(),e.setMatrix(t.matrix,!1),e._ratioData=c._ratioData,e._billboardData=c._billboardData;let r=e.orientation;if(e.orientation=!t.matrix||t.matrix.determinant()>0?1:-1,r!==e.orientation&&e._flagAsGSSOInvalidated(),e._noZPriority=t._getNoZPriority(),b&&b.currentViewpoint&&b.currentViewpoint.isNative2D()?b.currentViewpoint._depthMode?(e._priorityMode=i.PriorityMode.DepthPriority,e._depthPriority=c._depthPriority):e._priorityMode=i.PriorityMode.ClassicPriority2D:t._getDepthMode()?t._getAdvancedPriority()?e._priorityMode=i.PriorityMode.Advanced:e._priorityMode=i.PriorityMode.ClassicPriority:e._priorityMode=i.PriorityMode.SceneGraphOrder,c._forceDepthPriorityMode&&(e._priorityMode=i.PriorityMode.DepthPriority),e._advancedPriority=t.advancedPriority,e._noZPriority||t.passes){var ee=!!t._filters&&t._filters.has(T.LOOK)&&!!t._filters.get(T.LOOK).material,te="_refplaneitem_"===c.name;if(ee||te){if(t.passes){var ie=t.passes.indexOf("noz");-1!==ie&&(t.passes=t.passes.slice(),t.passes[ie]="main",z&&z.updateObjectPasses(e,t.passes))}e._noZPriority=!1}}let n=e._programID;c._isDecal?e._programID|=i.ProgramIDs.DECALS:e._programID&=~i.ProgramIDs.DECALS,n!==e._programID&&e._flagAsGSSOInvalidated();var re=e.highlightMeshes;if(null!=re){var ne,se=t._getVisible()&&!t._getInvertMode(),ae=t._getVisibilityFree();for(de=0;de<re.length;de++)(ne=re[de].renderable).setMatrix(t.matrix,!1),b&&b.picking.forceVisibility||(ne.visible=se,ne.visibilityFree=ae),ne._ratioData=c._ratioData,ne._billboardData=c._billboardData}if(void 0!==e.preHighlight&&null!==e.preHighlight&&(e.preHighlight.setMatrix(t.matrix,!1),b&&b.pPicking.forceVisibility||(e.preHighlight.visible=t._getVisible()&&!t._getInvertMode(),e.preHighlight.visibilityFree=t._getVisibilityFree()),e.preHighlight._ratioData=c._ratioData,e.preHighlight._billboardData=c._billboardData),e instanceof i.CSS2DNode||e instanceof i.CSS3DNode){var oe=!0;this._getViewer()&&(oe=this._getViewer().visibleSpace);(t._getVisibilityFree()||oe?t._getVisible()&&!t._getInvertMode():!(t._getVisible()&&!t._getInvertMode()))||(e.element.style.display="none")}if(i.disableJHGDev)null!==t.material&&(e.material=t.material);else{var le=e.material;le&&le.canvasNodeTextureSize||(e.material=t.material)}if(e.matApp=t.matApp,e.gas=t.gas,e.visible=t._getVisible()&&!t._getInvertMode(),e.visibilityFree=t._getVisibilityFree(),e.pickable=t._getPickable()&&!t._getInvertPickMode(),e.noPickThrough=t.getNoPickThrough()&&!t._getInvertPickMode(),e.pickingPriorityID=t.pickingPriorityID,null!==t.scene3js){if("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()||"CSS3DNode"===t.node.getNodeType()||"CSS2DNode"===t.node.getNodeType()?t.scene3js.containsObject(e)||(t.scene3js.add(e,t.passes),"Mesh3D"===t.node.getNodeType()&&e.addRefVBO(!1)):"LightNode3D"===t.node.getNodeType()?t.scene3js.containsLight(e)||t.scene3js.add(e):"LensFlareNode3D"===t.node.getNodeType()?t.scene3js.containsLensFlare(e)||t.scene3js.add(e):"GaussianNode3D"==t.node.getNodeType()&&(this._getViewer().renderer.initEffect("GaussianSplat"),this._getViewer().renderer.setEffect("GaussianSplat",!0),t.scene3js.containsObject(e)||(t.scene3js.add(e,t.passes),e.addRefVBO(!1))),t.scene3js.viewer)if(t.scene3js.viewer._lockRenderIteration||(t.scene3js.viewer.renderIteration=0),void 0!==e.updateShadowMap)e.updateShadowMap=!0;else if(e.castShadow)for(var he=0;he<t.scene3js.parent.__lights.length;he++){var ce=t.scene3js.parent.__lights[he];ce.blockUpdate||(ce.updateShadowMap=!0)}}else null!==u&&("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()?u.containsObject(e)&&(this._removeFromVisuSelection(e),u.remove(e),"Mesh3D"===t.node.getNodeType()&&e.releaseVBO(!1)):"LightNode3D"===t.node.getNodeType()?u.containsLight(e)&&u.remove(e):"LensFlareNode3D"===t.node.getNodeType()?u.containsLensFlare(e)&&u.remove(e):"CSS2DNode"===t.node.getNodeType()||"CSS3DNode"===t.node.getNodeType()?u.containsObject(e)&&(u.remove(e),e.element.parentNode&&e.element.parentNode.removeChild(e.element)):"GaussianNode3D"==t.node.getNodeType()&&u.containsObject(e)&&(this._removeFromVisuSelection(e),u.remove(e),e.releaseVBO(!1)))}var de,ue=!!t.clippingContext,pe=!1,fe=_||c.clippingContext;if(fe&&fe._localCoordinates&&fe._updatePosition(t.matrix),t.clippingContext=fe?fe._mergeWithParent(e.clippingContext,t.matrix):e.clippingContext,t.clippingContext!==e.clippingContext&&(pe=!0),t.renderPriority!==e.renderPriority&&(pe=!0),t.clippingContext&&(t.renderable&&t.renderable._flagAsGSSOInvalidated(),ue=!0),ue&&(b||(b=e.getViewer()),b&&b._requestClippingUpdate()),V&&(e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride&&e.occurrenceRenderingOverride.materialOverride===V||(pe=!0)),pe){t.occurrenceRenderingOverride=new o,t.occurrenceRenderingOverride.clipPlanes=t.clippingContext&&t.clippingContext.planes,t.occurrenceRenderingOverride.sectionLinesProperties=t.clippingContext&&t.clippingContext.sectionLinesProperties,t.occurrenceRenderingOverride.sectionCappingMaterials=t.clippingContext&&t.clippingContext.sectionCappingMaterials,t.occurrenceRenderingOverride.clippingContext=t.clippingContext;var ge=t.clippingContext&&t.clippingContext._scissor;t.occurrenceRenderingOverride.scissor=ge,t.occurrenceRenderingOverride.materialOverride=V||e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride,t.occurrenceRenderingOverride.setRenderPriority(t.renderPriority),t.clippingContext&&t.clippingContext._clipPolyLine&&t.clippingContext.isClippingProfileEnabled()&&(t.occurrenceRenderingOverride.clipPolyLine=t.clippingContext._clipPolyLine.getForOccurrenceOverride(t.matrix))}else t.occurrenceRenderingOverride=e.occurrenceRenderingOverride;if(t.renderable&&(t.renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride,re=t.renderable.highlightMeshes))for(de=0;de<re.length;de++)re[de].renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride;for(t.renderable&&l&&(t.next=l.next,l instanceof A&&(l.next=t),t.next&&(t.next.prev=t),l instanceof A&&(t.prev=l),l=t),de=0;de<t.children.length;de++){let e=c._isDynamic||C?I.UpdateMatrixMode.Always:r;l=this._updateOccurrences(t,t.children[de],e,s,a,l)}return x&&e._invalidateBoundingElements(!1),l},_updateNodeOccurrences:function(e,t,i){let r,n;if(this.parents.length>0)for(n=0;n<this._occurrences.length;n++)r=this._occurrences[n],this._updateOccurrences(r.parent,r,e,t,i);else for(n=0;n<this.children.length;n++)this.children[n]._updateNodeOccurrences(e,t,i)},_getOccurrencesFromOccurrencePath:function(e){var t,i,r,n,s,a,o,l,h;if(!e.path.length)return[];if(null===(t=this.getChildByName(e.path[0]))&&(t=this.getChildByName(e.path[0],1)),null===t)return[];for(s=t._occurrences,a=[],h=1;h<e.path.length;h++){for(i=e.path[h],o=0;o<s.length;o++)for(r=s[o].children,l=0;l<r.length;l++)(n=r[l]).node.name===i&&a.push(n);s=a,a=[]}return s},_getRenderableOccurrencesFromOccurrencePath:function(e){var t,i,r,n,s,a;for(t=this._getOccurrencesFromOccurrencePath(e),i=[],s=0;s<t.length;s++)for(n=t[s],r=this._getRenderableOccurrencesFromOccurrence(n),a=0;a<r.length;a++)i.push(r[a]);return i},_getRenderableOccurrencesFromOccurrence:function(e){var t,i,r,n,s;for(t=[],i=e.children,null!==e.renderable&&t.push(e.renderable),n=0;n<i.length;n++)for(r=this._getRenderableOccurrencesFromOccurrence(i[n]),s=0;s<r.length;s++)t.push(r[s]);return t},_removeFromVisuSelection:function(e){t.publish({event:"/VISU/SELECTION/REMOVE",data:e})},_removeInvalidElementsInXSO:function(e){var t,i,r=[S,b,x];for(t=0;t<r.length;t++){var n=r[t],s=[],a=n.get();for(i=0;i<a.length;i++){var o=a[i],l=o.pathElement;if(!l&&o.options&&(l=o.options.pathElement),l){var h=l._getIndexFromNode(this);if(-1===h)l.getElement(0,!0);else l.getElement(h+1,!0)===e&&s.push(o)}}for(i=0;i<s.length;i++)n.remove(s[i])}},addAsyncDependancies:function(e){console.warn("The addAsyncDependancies function doesn't do anything anymore: it shouldn't be called anymore.")},onAsyncDependancyCompleted:function(){this._onAllAsyncDependanciesCompleted()},_onAllAsyncDependanciesCompleted:function(){void 0!==this.modelEvents&&this.modelEvents.publish("onReady")},_onLinkedToSceneGraph:function(){},_onUnlinkedToSceneGraph:function(){},setNoZ:function(e){this.setRenderPasses(e?["noz"]:["main"])},setNoEffectNoZ:function(e){this.setRenderPasses(e?["noEffectNoz"]:["main"])},setNoHighlightNoZ:function(e){this.setRenderPasses(e?["afterHighlightNoZ"]:["main"])},setAsNativeIsoBag:function(e){e>3&&console.warn("iso layer support up to 3 but layer provided is "+e),this._isoLayer=Math.min(e,3),this._forceUpdate()},getNativeIsoLayer:function(){return this._isoLayer},setAsNativeDialog:function(e){if(this.setRenderPasses(e?["dialog"]:["main"]),e){this.propagateXSOExclusion(!0),this.exludeFromBounding(!0),this.excludeFromHSO(!0),this.excludeFromHighlight(!0),this.excludeFromPSO(!0);var t=this.createOverrideSetManager(),i=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(i);var r=i.createOverride(new n([this])),s=new h([]);s.setUncut(!0),r.setClippingContext(s);var a=new d;a.setRenderMode("Face",!0),a.setRenderMode("@Edge",!1),a.setRenderMode("@Point",!1),a.setRenderMode("Outline",!1),a.setFaceMode("MATERIAL"),r.setRenderStyle(a)}else this.exludeFromBounding(!1),this.excludeFromHSO(!1),this.excludeFromHighlight(!1),this.excludeFromPSO(!1),this.enableLocalRenderEdgeMode(!1),this.removeOverrideSetManager();this._forceUpdate()},setAsNativeOnTop:function(e){this.setRenderPasses(e?["onTop"]:["main"]);let t=this._getViewer();t&&t.renderer.renderer.requestPoliteDepthBuffer()},setAsNativeFurtive:function(e){if(this.setRenderPasses(e?["furtive"]:["main"]),e){var t=this.createOverrideSetManager(),r=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(r);var s=r.createOverride(new n([this])),a=new u({lineMaterial:new i.LineBasicMaterial({color:16760604,lineWidth:1}),faceMaterial:new i.MeshBasicMaterial({color:16760604}),pointMaterial:new i.ParticleBasicMaterial({color:16760604,size:1,opacity:1})});s.setMaterial(a,!0)}else this.removeOverrideSetManager()},setRenderPasses:function(e){var t,i=e.concat([]);for(t=0;t<e.length;t++)e[t]&&e[t]._getIdString&&(i[t]=e[t]._getIdString());var r=e=i;4===e.length&&e.indexOf("colorOld")>=0&&e.indexOf("depthOld")>=0&&e.indexOf("colorOldCapping")>=0&&e.indexOf("depthOldCapping")>=0&&(r=["compareOld"]),2===e.length&&e.indexOf("depthNew")>=0&&e.indexOf("depthNewCapping")>=0&&(r=["compareNew"]),this.passes=r,this._forceUpdate()},setRenderLineMode:function(e){var t=this._renderMode;t||((t=new c)._useRenderPointMask=!1,t._useRenderFaceMask=!1,this._renderMode=t),t._setRenderLineMode(e),this._requestOverridesUpdate()},enableLocalRenderEdgeMode:function(e){var t=null;e&&((t=new c({renderLineMode:i.HideAllRenderLineMode}))._useRenderFaceMask=!1,t._useRenderPointMask=!1),this._renderMode=t,this._requestOverridesUpdate()},setRenderMode:function(e,t){!e||e.indexOf("Edge")<0||this._renderMode&&(this._renderMode.setRenderMode(e,t),this._requestOverridesUpdate())},setAdvancedPriority:function(e){this._setAdvancedPriority(e)},setZDepthMode:function(e){this._setDepthMode(e)},setLayerFilter:function(e,t){if(this._layerFilter){switch(t){case i.FilterMode.Cumulative:for(r=0;r<e.length;r++)this._layerFilter[r]=this._layerFilter[r]&&(e[r]?1:0);break;case i.FilterMode.None:case i.FilterMode.Replace:case i.FilterMode.V4Master:default:if(1024!==e.length){this._layerFilter=new Array(1024);for(r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e}this._forceUpdate()}else{if(1024!==e.length){this._layerFilter=new Array(1024);for(var r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e;this._forceUpdate()}},setFiltered:function(e){e?this.setVisuFilters({filtered:new v(!0)}):this.setVisuFilters({filtered:null})},setPvmFilter:function(e){let t,i;if(e&&(t=e.mode,i=e.plane),null!=t&&null!=i){let e=new _(t,i);this.setVisuFilters({planeViewModeFilter:e})}else this.setVisuFilters({planeViewModeFilter:null})},setLayerNumber:function(e){this._layer=e,this._forceUpdate()},_propagateVisuFilters:function(e,t){if(t?(e._filters=new Map,t.forEach((function(t,i,r){var n=t&&t.solveInherit(e,null);n&&e._filters.set(i,n)}))):e._filters=null,this._filters&&(e._filters=e._filters||new Map,this._filters.forEach((function(t,i,r){var n=t&&t.solveInherit(e,e._filters.get(i),!0);n&&e._filters.set(i,n)}))),t&&t.has(T.LOD)){let i=t.get(T.LOD);e._filters=e._filters||new Map,e._filters.set(T._LOD_BRANCH,i._getContainer(e,e._filters.get(T._LOD_BRANCH)))}},setVisuFilters:function(e){this._filters||(this._filters=new Map);var t=!1;if(void 0!==e.gasInheritFilter&&(this._filters.set(T.GAS_INHERIT,e.gasInheritFilter),e.gasInheritFilter||this._filters.delete(T.GAS_INHERIT),t=!0),void 0!==e.polygonOffsetFilter&&(this._filters.set(T.POLYGON_OFFSET,e.polygonOffsetFilter),e.polygonOffsetFilter||this._filters.delete(T.POLYGON_OFFSET),t=!0),void 0!==e.zModeFilter&&(this._filters.set(T.ZMODE,e.zModeFilter),e.zModeFilter||this._filters.delete(T.ZMODE),t=!0),void 0!==e.noHighlightFilter&&(this._filters.set(T.NO_HIGHLIGHT,e.noHighlightFilter),e.noHighlightFilter||this._filters.delete(T.NO_HIGHLIGHT),t=!0),void 0!==e.lookFilter&&(this._filters.set(T.LOOK,e.lookFilter),e.lookFilter||this._filters.delete(T.LOOK),t=!0),void 0!==e.geomTypeFilter&&(this._filters.set(T.GEOM_TYPE,e.geomTypeFilter),(!e.geomTypeFilter||e.geomTypeFilter._geomType<0)&&this._filters.delete(T.GEOM_TYPE),t=!0),void 0!==e._staticGeomTypeFilter&&(this._filters.set(T._STATIC_GEOM_TYPE,e._staticGeomTypeFilter),(!e._staticGeomTypeFilter||e._staticGeomTypeFilter._geomType<0)&&this._filters.delete(T._STATIC_GEOM_TYPE),t=!0),void 0!==e._sideFilter&&(this._filters.set(T._SIDE,e._sideFilter),e._sideFilter||this._filters.delete(T._SIDE),t=!0),void 0!==e.dynamicModeFilter&&(this._filters.set(T.DYNAMIC_MODE,e.dynamicModeFilter),e.dynamicModeFilter||this._filters.delete(T.DYNAMIC_MODE),t=!0),void 0!==e.furtiveFilter&&(this._filters.set(T.FURTIVE,e.furtiveFilter),e.furtiveFilter||this._filters.delete(T.FURTIVE),t=!0),void 0!==e._materialToUseFilter&&(this._filters.set(T._MATERIAL_TO_USE,e._materialToUseFilter),(!e._materialToUseFilter||e._materialToUseFilter.materialToUse<0)&&this._filters.delete(T._MATERIAL_TO_USE),t=!0),void 0!==e.LOD&&(this._filters.set(T.LOD,e.LOD),e.LOD&&0!==e.LOD.lods.length||this._filters.delete(T.LOD),t=!0),void 0!==e.planeViewModeFilter&&(this._filters.set(T.PLANE_VIEW_MODE,e.planeViewModeFilter),e.planeViewModeFilter||this._filters.delete(T.PLANE_VIEW_MODE),t=!0),e.doNotPickUnderFilter&&(this._filters.set(T.DO_NOT_PICK_UNDER,e.doNotPickUnderFilter),t=!0),void 0!==e.filtered&&(this._filters.set(T.FILTERED,e.filtered),e.filtered||this._filters.delete(T.FILTERED),t=!0),t){var i=this._filters.has(T.DO_NOT_PICK_UNDER)&&!this._filters.get(T.DO_NOT_PICK_UNDER)._doNotPickUnder;i&&this._forceUpdate(),i&&this._filters.delete(T.DO_NOT_PICK_UNDER),this._filters.forEach(((e,t)=>{if(e&&!(e instanceof m))throw"Invalid Data operation, filters must inherit from VisuFilter"})),0===this._filters.size&&(this._filters=null),this._forceUpdate()}},setPickingMode:function(e){this._pickingMode=e,this._requestOverridesUpdate()},getLocalBoundingBox:function(){if(w)return new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0));var e=new i.Matrix4,t=new i.Matrix4,r=new i.Vector3,n=null,s=null,a=this._occurrences[0],o=a.matrix;e.getInverse(o);for(var l=a._getRenderableOccurrences(),h=0;h<l.length;h++){var c=l[h];t.multiplyMatrices(e,c.matrix);for(var d=0;d<c.geometry.length;d++){var u=c.geometry[d].vertexPositionArray;if(u){var p=u.length;if(p>=3){n||(r.set(u[0],u[1],u[2]),r.applyMatrix4(t),n=(new i.Vector3).copy(r),s=(new i.Vector3).copy(r));for(var f=0;f<p;f+=3)r.set(u[f],u[f+1],u[f+2]),r.applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>s.x&&(s.x=r.x),r.y>s.y&&(s.y=r.y),r.z>s.z&&(s.z=r.z)}}}}return new i.Box3(n,s)},enableClippingPlane:function(e,t){var i,r;if(t){if(this.clippingContext||(this.clippingContext=new h),this.clippingContext.addPlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._addClippingPlane(e)}else if(this.clippingContext&&this.clippingContext.removePlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._removeClippingPlane(e)},disableClipping:function(e){this.clippingContext||(this.clippingContext=new h),this.clippingContext.setExcludeFromClippingPlanes(e?["all"]:[]),this._forceUpdate()},setSectionCappingMaterial:function(e,t){this.clippingContext||(this.clippingContext=new h),this.clippingContext.setSectionCappingMaterial(e,t),this.requestOverridesUpdate()},deleteSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},getSectionCappingMaterial:function(e){return this.clippingContext&&this.clippingContext.getSectionCappingMaterial(e)},removeSectionCappingMaterial:function(e){this.clippingContext&&this.clippingContext.removeSectionCappingMaterial(e)},requestOverridesUpdate:function(){var e=0;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate()},excludeFromCSO:function(e){this._setExcludeFromCSO(e)},excludeFromHSO:function(e){this._setExcludeFromHSO(e)},excludeFromPSO:function(e){this._setExcludeFromPSO(e)},excludeFromHighlight:function(e,t){this._setExcludeFromHL(e),this._setExcludeFromPreHL(t)},propagateXSOExclusion:function(e){this._setPropagateXSOExclusion(e)},createRenderable:function(){return null},add:function(){this.addChild.apply(this,arguments)},remove:function(){this.removeChild.apply(this,arguments)},_requestOverridesUpdate:function(){var e;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate(),this._occurrences[e]._setRequestGSSOUpdate(!0)},_requestClippingUpdate:function(){var e,t=this._getAllOwningViewers();for(e=0;e<t.length;e++)t[e]._requestClippingUpdate()},setClippingCylinder:function(e,t){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}t&&(this.clippingContext._localCoordinates=!0),this.clippingContext.cylinder=e?{center:e.center,axisU:e.axisU.clone(),axisV:e.axisV.clone(),clipOutside:null===e.clipOutside||void 0===e.clipOutside||e.clipOutside}:null,this._requestClippingUpdate(),this._requestOverridesUpdate()},setScissoringPolyLine:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}e?this.clippingContext.setScissorPolyLine(!0,e):this.clippingContext.setScissorPolyLine(!1),this._requestClippingUpdate(),this._requestOverridesUpdate()},__applyOnOccurrences:function(e){for(var t=0;t<this._occurrences.length;t++)e(this._occurrences[t])},setClippingProfile:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}e?this.clippingContext.setClippingProfile(e):this.clippingContext.setClippingProfile(null),this._requestClippingUpdate(),this._requestOverridesUpdate()},isPointOfViewDependant:function(){return!1},_setOverrideExistsTraverse:function(){!function e(t){var i;if(!t._getOverrideExists())for(t._setOverrideExists(!0),i=0;i<t.parents.length;i++)e(t.parents[i])}(this)},getPLMMaterialData:function(e){var t=this._PLMMaterialData;return e||null!==t||(this._PLMMaterialData=new p(this),t=this._PLMMaterialData),t},_getStaticOverrideSet:function(e){var t=this.getPLMMaterialData(!e);return t&&t._getStaticOverrideSet(e)},addStaticMaterialApplicationOverride:function(e,t){this._getStaticOverrideSet(!0).addStaticOverride(e,t),this._requestStaticOverridesUpdate()},clearStaticMaterialApplicationOverrides:function(){var e=this._getStaticOverrideSet();e&&(e.clear(),this._requestStaticOverridesUpdate())},_requestStaticOverridesUpdate:function(){var e,t;for(e=0;e<this._occurrences.length;e++)(t=this._occurrences[e].getViewer())&&(t._updateStaticOverrides=!0)},setLocalRenderEdgeMode:function(){this.setRenderMode.apply(this,arguments)},setUserData:function(e){this.userData=e},getUserData:function(e){return this.userData},_getTrianglesCount:function(e){let t=0;for(let i=0;i<this._occurrences.length;++i)t+=this._occurrences[i]._getTrianglesCount(e);return t},_modifyBE:function(e,t){return e}});I.prototype._isMesh3D=!1,I.prototype._isDecal=!1,I.prototype.__isProxy__=!1;var R=0;I._LockNodeHierarchy=function(){R++},I._UnlockNodeHierarchy=function(){R--},I._applyMaterialToPath=function(e,t){if(null===e)return!1;var i=e._getRenderableOccurrences(),r=i.length;for(s=0;s<r;s++)(a=i[s])&&a._flagAsGSSOInvalidated();var n=e.getLastElement();if(null===n)return!1;if(n instanceof I)for(var s=0;s<r;s++){var a=i[s];null!==t?(a.userData.oldMaterial||(a.userData.oldMaterial=a.material),a.material=t):a.userData.oldMaterial&&(a.material=a.userData.oldMaterial)}else{if(1!==r)return!1;var o=[];if("rep"===n.getType()){var l=n.getChildren();for(s=0;s<l.length;s++)o.push(l[s].sgNode)}else"primitive"===n.getType()&&o.push(n.sgNode);null===i[0].layer&&i[0].initLayers(1),i[0].layer.addPrimitivesToLayers(o,1,t)}return!0},I.DEPRECATED_SceneGraph=function(e,t){if(0!==P&&(console.log("[SceneGraph] DEPRECATED API USE\n"+e.stack),P--),!window.I_solemnly_swear_I_am_up_to_no_good&&!t)throw e},I.DEPRECATED_Method=function(e,t){0!==P&&(console.log("[Node3D] DEPRECATED API USE\n"+e.stack),P--)},I.DEPRECATED_matrix=function(e){0!==P&&(console.warn("Node3D API : use getMatrix() accessor instead of .matrix  "+e.stack),--P||console.warn("Node3D API : too many errors, no more errors will be reported."))},Object.defineProperty(I.prototype,"root",{get:function(){return I.DEPRECATED_SceneGraph(new Error),this}}),Object.defineProperty(I.prototype,"bSphere",{get:function(){return this.getHasExplicitBE()&&0===this.children.length?this.explicitBSphere:this.getBoundingSphere()},set:function(e){if(!this.getHasExplicitBE())throw new Error("bSphere is read-only");this.explicitBSphere=e}}),Object.defineProperty(I.prototype,"bBox",{get:function(){return(this.getHasExplicitBE()||this.hasExplicitBE)&&0===this.children.length?this.explicitBBox:this.getBoundingBox()},set:function(e){if(!this.getHasExplicitBE()&&!this.hasExplicitBE)throw new Error("bBox is read-only");this.explicitBBox=e}}),Object.defineProperty(I.prototype,"matrix",{get:function(){return I.DEPRECATED_matrix(new Error),this._matrix},set:function(e){I.DEPRECATED_matrix(new Error),this._matrix=e}});var O=30;I.FORBIDDEN_ACCESS_occurrences=function(e){0!==O&&(console.log("[Node3D] INTERNAL PROPERTY ACCESS\nAccess to 'occurrences' member is strictly forbidden.\nYou must use authorized APIs.\nIf you are trying to create a pathElement using setFromOccurrence, please consider using ?new PathElement([node3d])? instead.\n"+e.stack),O--)},Object.defineProperty(I.prototype,"occurrences",{get:function(){return I.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences},set:function(e){I.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences=e}}),Object.defineProperty(I.prototype,"clippingPlanes",{get:function(){return this.clippingContext&&this.clippingContext.planes},set:function(){}});var L=[["renderPriority","p0"],["renderPriority","p1"],["renderPriority","p2"],["renderPriority","p3"],["renderPriority","p4"]];I.REFERENCE_NODE=-1,I.INSTANCE_NODE=-2,I.REPRESENTATION_NODE=-3,I.TILESET_NODE=-4,I._onLinkToSceneGraph_DEBUG=null;var B=1,F=2,V=4,G=8,N=16,U=32,k=64,z=128,H=256,W=512,j=1024,X=2048,q=4096,Z=8192,Y=16384,K=32768,$=65536,Q=1<<17,J=1<<18;function ee(e){return function(){return(this.occBooleanAttr&e)>0}}function te(e){return function(t){this.occBooleanAttr=t?this.occBooleanAttr|e:this.occBooleanAttr&~e}}A.prototype._getVisible=ee(B),A.prototype._setVisible=te(B),A.prototype._getVisibilityFree=ee(F),A.prototype._setVisibilityFree=te(F),A.prototype._getPickable=ee(V),A.prototype._setPickable=te(V),A.prototype._getNoZPriority=ee(z),A.prototype._setNoZPriority=te(z),A.prototype.getNoPickThrough=ee(G),A.prototype.setNoPickThrough=te(G),A.prototype._getNeedBEUpdate=ee(N),A.prototype._setNeedBEUpdate=te(N),A.prototype._getNeedOverridesUpdate=ee(U),A.prototype._setNeedOverridesUpdate=te(U),A.prototype._getDescendantNeedsOverridesUpdate=ee(k),A.prototype._setDescendantNeedsOverridesUpdate=te(k),A.prototype._getForceShowHide=ee(H),A.prototype._setForceShowHide=te(H),A.prototype._getForceShowNoPickability=ee(W),A.prototype._setForceShowNoPickability=te(W),A.prototype._getForceShowNoDrawHL=ee(j),A.prototype._setForceShowNoDrawHL=te(j),A.prototype.isInBackground=ee(X),A.prototype.setIsInBackground=te(X),A.prototype._isAlwaysInForeground=ee(q),A.prototype._setIsAlwaysInForeground=te(q),A.prototype._getAdvancedPriority=ee(Y),A.prototype._setAdvancedPriority=te(Y),A.prototype._getDepthMode=ee(Z),A.prototype._setDepthMode=te(Z),A.prototype._getInvertMode=ee(K),A.prototype._setInvertMode=te(K),A.prototype._getInvertPickMode=ee($),A.prototype._setInvertPickMode=te($),A.prototype._getFrom3dxml=ee(Q),A.prototype._setFrom3dxml=te(Q),A.prototype._getRequestGSSOUpdate=ee(J),A.prototype._setRequestGSSOUpdate=te(J),A.prototype._copyForceShowStatusFromOcc=function(e){var t=H|W|j;this.occBooleanAttr=this.occBooleanAttr&~t|e.occBooleanAttr&t},A.prototype._getTrianglesCount=function(e){let t=0;if(this._getVisible()===e||!e){if(this.renderable)if(this.renderable.layer){var i=this.renderable.layer.layers;if(i)for(var r=0;r<i.length;r++){var n=i[r].drawableGroup;n&&4===n.glType&&(t+=n.count/3)}}else if(this.renderable.geometry)for(let e=0;e<this.renderable.geometry.length;++e)for(var s=this.renderable.geometry[e],a=0;a<s.drawingGroups.length;++a){let e=s.drawingGroups[a];e&&4===e.glType&&(t+=e.count/3)}for(let i=0;i<this.children.length;++i)t+=this.children[i]._getTrianglesCount(e)}return t},A.prototype._getPreviousRenderableOcc=function(e){let t=null,i=this;for(;!t;){let r=i.parent;if(!r||i===e)return null;let n=r.children.length,s=null;for(let e=0;e<n-1;++e)if(r.children[e+1]===i){s=r.children[e];break}if(s)t=s._getLastRenderableOcc(),i=s;else{if(r.renderable)return r;i=r}}return t},A.prototype._getNextRenderableOcc=function(e){let t=this,i=null;for(;!i;){let r=t.parent;if(!r||t===e)return null;let n=r.children.length,s=null;for(let e=0;e<n-1;++e)if(r.children[e]===t){s=r.children[e+1];break}s?(i=s._getFirstRenderableOcc(),i||(t=s)):t=r}return i},A.prototype._getFirstRenderableOcc=function(){let e=this;for(;!e.renderable;){if(0===e.children.length)return e._getNextRenderableOcc(this);e=e.children[0]}return e},A.prototype._getLastRenderableOcc=function(){let e=this,t=e.children.length;for(;t>0;)e=e.children[t-1],t=e.children.length;return e.renderable?e:e._getPreviousRenderableOcc(this)},A.prototype._unlinkRenderableOccs=function(){let e=this._getFirstRenderableOcc();if(!e)return;let t=this._getLastRenderableOcc(),i=null;e.prev&&(e.prev.next=t.next,i=e.prev,e.prev=null),t.next&&(t.next.prev=i,t.next=null)},Object.defineProperty(A.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(A.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(A.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(A.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(A.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(A.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(A.prototype,"_needOverridesUpdate",{get:function(){return this._getNeedOverridesUpdate()},set:function(e){this._setNeedOverridesUpdate(e)}}),Object.defineProperty(A.prototype,"_descendantNeedsOverridesUpdate",{get:function(){return this._getDescendantNeedsOverridesUpdate()},set:function(e){this._setDescendantNeedsOverridesUpdate(e)}}),I.SceneGraphOverrideSetManager=null,I.UpdateMatrixMode={Always:new String("UpdateMatrixMode_Always"),Never:new String("UpdateMatrixMode_Never")},I.InvalidateGSSOMode={Always:new String("InvalidateGSSOMode_Always"),Never:new String("InvalidateGSSOMode_Never")};var ie=1,re=2,ne=4,se=8,ae=16,oe=32,le=64,he=128,ce=256,de=512,ue=1024,pe=2048,fe=4096,ge=8192,me=16384,ve=32768,_e=65536,ye=1<<17,Se=1<<18,be=1<<19,xe=1<<20,we=1<<21,Pe=1<<22,Ce=1<<23,Me=1<<24,Ee=1<<25,Te=1<<26,Ae=1<<27,De=1<<28,Ie=1<<29,Re=1<<30,Oe=1,Le=2,Be=4,Fe=8,Ve=16;function Ge(e){return function(){return(this.node3DBooleanAttr&e)>0}}function Ne(e){return function(t){this.node3DBooleanAttr=t?this.node3DBooleanAttr|e:this.node3DBooleanAttr&~e}}function Ue(e){return function(){return(this.node3DBooleanAttr2&e)>0}}function ke(e){return function(t){this.node3DBooleanAttr2=t?this.node3DBooleanAttr2|e:this.node3DBooleanAttr2&~e}}function ze(e,t,i,r,n,s,a){return!s&&!a&&(!(!n||!t)||e&&(t?i:r))}return I.prototype.getLinkedToSceneGraph=Ge(ie),I.prototype.setLinkedToSceneGraph=Ne(ie),I.prototype._getForceBoundingElements=Ge(re),I.prototype._setForceBoundingElements=Ne(re),I.prototype.getExcludeFromBounding=Ge(ne),I.prototype.setExcludeFromBounding=Ne(ne),I.prototype._getNeedBEUpdate=Ge(se),I.prototype._setNeedBEUpdate=Ne(se),I.prototype._getVisible=Ge(ae),I.prototype._setVisible=Ne(ae),I.prototype._getVisibilityFree=Ge(oe),I.prototype._setVisibilityFree=Ne(oe),I.prototype._getPickable=Ge(le),I.prototype._setPickable=Ne(le),I.prototype._getNoZPriority=Ge(Se),I.prototype._setNoZPriority=Ne(Se),I.prototype.getNoPickThrough=Ge(he),I.prototype.setNoPickThrough=Ne(he),I.prototype._getPickParent=Ge(ce),I.prototype._setPickParent=Ne(ce),I.prototype._getTreeModified=Ge(de),I.prototype.__setTreeModified=Ne(de),I.prototype.getNotAllowedInPathElement=Ge(ue),I.prototype.setNotAllowedInPathElement=Ne(ue),I.prototype._getVisibilityInTree=Ge(pe),I.prototype._setVisibilityInTree=Ne(pe),I.prototype.getIsManipulator=Ge(fe),I.prototype.setIsManipulator=Ne(fe),I.prototype._getExcludeFromCSO=Ge(ye),I.prototype._setExcludeFromCSO=Ne(ye),I.prototype._getExcludeFromHSO=Ge(ge),I.prototype._setExcludeFromHSO=Ne(ge),I.prototype._getExcludeFromPSO=Ge(me),I.prototype._setExcludeFromPSO=Ne(me),I.prototype._getExcludeFromHL=Ge(_e),I.prototype._setExcludeFromHL=Ne(_e),I.prototype._getExcludeFromPreHL=Ge(ve),I.prototype._setExcludeFromPreHL=Ne(ve),I.prototype._getPropagateXSOExclusion=Ge(Ce),I.prototype._setPropagateXSOExclusion=Ne(Ce),I.prototype._getOverrideExists=Ge(xe),I.prototype._setOverrideExists=Ne(xe),I.prototype._getDisablePrimPicking=Ge(be),I.prototype._setDisablePrimPicking=Ne(be),I.prototype._getDepthMode=Ge(Te),I.prototype._setDepthMode=Ne(Te),I.prototype._getAdvancedPriority=Ge(Ae),I.prototype._setAdvancedPriority=Ne(Ae),I.prototype._getInvertMode=Ge(De),I.prototype._setInvertMode=Ne(De),I.prototype._getInvertPickMode=Ge(Ie),I.prototype._setInvertPickMode=Ne(Ie),I.prototype._getForbidHierarchyUpdate=Ge(Re),I.prototype._setForbidHierarchyUpdate=Ne(Re),I.prototype.isInBackground=Ge(Me),I.prototype.setIsInBackground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|Me:this.node3DBooleanAttr&~Me,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];if(i.parent)this._updateOccurrences(i.parent,i,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always);else{i.setIsInBackground(e);for(let e=0;e<i.children.length;e++)this._updateOccurrences(i,i.children[e],I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always)}}},I.prototype._isAlwaysInForeground=Ge(Ee),I.prototype._setIsAlwaysInForeground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|Ee:this.node3DBooleanAttr&~Ee,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];i.parent?this._updateOccurrences(i.parent,i,I.UpdateMatrixMode.Never,void 0,I.InvalidateGSSOMode.Always):i._setIsAlwaysInForeground(e)}},I.prototype._getOverrideSetManagerUnder=function(){return(this.node3DBooleanAttr&we)>0},I.prototype._setOverrideSetManagerUnder=function(){var e;for(this.node3DBooleanAttr=this.node3DBooleanAttr|we,e=0;e<this.parents.length;e++)this.parents[e]._setOverrideSetManagerUnder()},I.prototype.getHasExplicitBE=function(){return!1},I.prototype._getForceShowMode=function(){return(this.node3DBooleanAttr&Pe)>0},I.prototype._setForceShowMode=function(e){var t=e;e?t||this.traverse((e=>{e.node3DBooleanAttr=e.node3DBooleanAttr|Pe})):t&&this.traverse((e=>{e.node3DBooleanAttr=e.node3DBooleanAttr&~Pe}))},I.prototype._getNoGASOnPrimitives=Ue(Oe),I.prototype._setNoGASOnPrimitives=ke(Oe),I.prototype._getPixelCullingFromParent=Ue(Le),I.prototype._setPixelCullingFromParent=function(e){this.node3DBooleanAttr2=e?this.node3DBooleanAttr2|Le:this.node3DBooleanAttr2&~Le;for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable._updateWorldCenterAndRadius()}},I.prototype._getNoCullingBE=Ue(Be),I.prototype._setNoCullingBE=ke(Be),I.prototype.getPrimitivePicking=Ue(Fe),I.prototype.setPrimitivePicking=ke(Fe),Object.defineProperty(I.prototype,"material",{get:function(){return this.getMaterial()},set:function(e){console.warn("do not use node.material=myMaterial but node.setMaterial(myMaterial)"),this.setMaterial(e)}}),I.prototype.__getPickParentWithPrimitives=Ue(Ve),I.prototype.__setPickParentWithPrimitives=ke(Ve),Object.defineProperty(I.prototype,"linkedToSceneGraph",{get:function(){return this.getLinkedToSceneGraph()},set:function(e){this.setLinkedToSceneGraph(e)}}),Object.defineProperty(I.prototype,"_forceBoundingElements",{get:function(){return this._getForceBoundingElements()},set:function(e){this._setForceBoundingElements(e)}}),Object.defineProperty(I.prototype,"excludeFromBounding",{get:function(){return this.getExcludeFromBounding()},set:function(e){this.setExcludeFromBounding(e)}}),Object.defineProperty(I.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(I.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(I.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(I.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(I.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(I.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(I.prototype,"pickParent",{get:function(){return this._getPickParent()},set:function(e){this._setPickParent(e)}}),Object.defineProperty(I.prototype,"_treeModified",{get:function(){return this._getTreeModified()},set:function(e){this.__setTreeModified(e)}}),Object.defineProperty(I.prototype,"notAllowedInPathElement",{get:function(){return this.getNotAllowedInPathElement()},set:function(e){this.setNotAllowedInPathElement(e)}}),Object.defineProperty(I.prototype,"_visibilityInTree",{get:function(){return this._getVisibilityInTree()},set:function(e){this._setVisibilityInTree(e)}}),Object.defineProperty(I.prototype,"isManipulator",{get:function(){return this.getIsManipulator()},set:function(e){this.setIsManipulator(e)}}),Object.defineProperty(I.prototype,"_excludeFromCSO",{get:function(){return this._getExcludeFromCSO()},set:function(e){this._setExcludeFromCSO(e)}}),Object.defineProperty(I.prototype,"_excludeFromHSO",{get:function(){return this._getExcludeFromHSO()},set:function(e){this._setExcludeFromHSO(e)}}),Object.defineProperty(I.prototype,"_excludeFromPSO",{get:function(){return this._getExcludeFromPSO()},set:function(e){this._setExcludeFromPSO(e)}}),Object.defineProperty(I.prototype,"_excludeFromHL",{get:function(){return this._getExcludeFromHL()},set:function(e){this._setExcludeFromHL(e)}}),Object.defineProperty(I.prototype,"_excludeFromPreHL",{get:function(){return this._getExcludeFromPreHL()},set:function(e){this._setExcludeFromPreHL(e)}}),UWA.namespace("THREEDS/Nodes/Node3D",I)})),define("Visualization/Node3D",["DS/Visualization/Node3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/Node3D"),e})),define("DS/Visualization/OccurrenceExplorer",["UWA/Class","DS/Visualization/OccurrenceInterface","DS/Visualization/Node3D","DS/Visualization/OccurrenceInterfaceFactory"],(function(e,t,i,r){"use strict";var n=e.extend({init:function(e){this.viewer=e},explore:function(e){e&&this._exploreInternal(null,e)},exploreQuick:function(e,t){e&&t&&this._exploreInternal(e,t)},_exploreInternal:function(e,t){var n=new s,a=new r(n,this.viewer);i._LockNodeHierarchy();try{if(e)t(a.getOccurrenceItf(e),a);else t(a);i._UnlockNodeHierarchy(),n.cleanUp()}catch(e){throw i._UnlockNodeHierarchy(),n.cleanUp(),e}}}),s=function(){this._occurrenceList=[],this._occurrenceInterfaceList=[]};return s.prototype.cleanUp=function(){this._occurrenceList=null,this._occurrenceInterfaceList=null},s.prototype.getOccurrenceInterface=function(e){if(!e||!this._occurrenceList)return null;this._occurrenceList[e.node.id]||(this._occurrenceList[e.node.id]=[]);var i,r,n=this._occurrenceList[e.node.id],s=-1;for(r=0;s<0&&r<n.length;r++)n[r].occurrence===e&&(s=n[r].index);return s<0?(i=new t(e.node.id,n.length,this),n.push({occurrence:e,index:this._occurrenceInterfaceList.length}),this._occurrenceInterfaceList.push(i)):i=this._occurrenceInterfaceList[s],i},n})),define("DS/Visualization/ViewManager",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/CSICommandBinder/CSICommandBinder","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/Filters/MaterialToUseFilter"],(function(e,t,i,r,n,s,a,o){"use strict";var l={},h={},c={},d={},u=new Map,p={},f=null;function g(e,t){e.viewer=t.viewer,e.views=t.views,e._updatePlane=t._updatePlane,e._sceneEnvRootForLights=t._sceneEnvRootForLights,e._sceneEnvRootForAmbiance=t._sceneEnvRootForAmbiance,e._sceneEnvRootForTransientHighlight=t._sceneEnvRootForTransientHighlight,e._viewpointMap=t._viewpointMap}i.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},(function(e){var t=e.parameters.viewer;u.delete(t),f&&f.viewer===t&&(u.delete(p),f=null,u.forEach((function(e,t,i){null===f&&(f=e)})),f&&u.set(p,f))}));var m=e.extend({init:function(e){if(e=e||p,f||(f=this),f.viewer!==p&&e===p)u.set(e,this),g(this,f);else if(f.viewer===p&&e!==p)f.viewer=e,u.set(e,this),g(this,f);else if(u.has(e)){g(this,u.get(e))}else u.set(e,this),this.viewer=e,this.views={},this._updatePlane=!0,this._sceneEnvRootForLights=new s("3DSyncSceneEnvRootForLights"),this._sceneEnvRootForAmbiance=new s("3DSyncSceneEnvRootForAmbiance"),this._sceneEnvRootForAmbiance._setIsAlwaysInForeground(!0),this._sceneEnvRootForTransientHighlight=new s("3DSyncSceneEnvRootForTransientHighlight"),this._sceneEnvRootForTransientHighlight.setPickable(a.PICKTHROUGH),this._sceneEnvRootForTransientHighlight.exludeFromBounding(!0),this._sceneEnvRootForTransientHighlight.setVisuFilters({_materialToUseFilter:new o(n.MaterialToUse.highlightMaterial)}),this._viewpointMap=new Map;return this},_executeParameter:function(e){e.setStaticMaterials(l),e.setDefaultMaterials(c),e.setTemporaryBodies(d),e.execute(this),this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane})},clear:function(){for(var e in this.views)delete this.views[e]},addView:function(e,t){var i=this.views[e];return i||(i=t,this.views[e]=i),i},removeView:function(e){var t=this.views[e];return t&&(t=null,this.views[e]=t),t},getView:function(e){var t=this.views[e];return t||(t=new s,this.viewer.addNode(t),this.views[e]=t),t},getKey:function(e){for(var t in this.views)if(e===this.views[t])return t;return null},onVisuAnswer:function(e){return this.viewer._modelEvent.subscribe({event:"VisuAnswer"},e)},unsubscribe:function(e){this.viewer._modelEvent.unsubscribe(e)},_publishVisuAnswer:function(e){e&&this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane,ekTrace:!0})},setStaticMaterial:function(e,t){return!(""===e||!t)&&(l[e]=t,!0)},getStaticMaterial:function(e){return l[e]},setStaticLook:function(e,t){return!(""===e||!t)&&(h[e]=t,!0)},getStaticLook:function(e){return!h[e]&&this.viewer._onMissingStaticLookCB&&this.setStaticLook(e,this.viewer._onMissingStaticLookCB(e)),h[e]},setDefaultMaterials:function(e){c=e},getDefaultMaterials:function(){return c},setTemporaryBodies:function(e){d=e||{}},updatePlaneOnViewMessage:function(e){this._updatePlane=e,u.get(this.viewer).updatePlaneOnViewMessage(e)},dispose:function(){const e=Object.keys(h);for(let t=0;t<e.length;t++){let i=e[t];h[i]&&h[i].material&&h[i].material.dispose()}const t=Object.keys(l);for(let e=0;e<t.length;e++){let i=t[e];l[i]&&l[i].dispose()}}});return UWA.namespace("THREEDS/ViewManager",m)})),define("DS/Visualization/VolumeRenderingManagerSimple",["UWA/Class","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D"],(function(e,t,i,r){"use strict";for(var n=function(e,t){for(var i=t||1;i<e;)i*=2;return i},s=[],a={},o={},l=0;l<7;l++){var h=Math.pow(2,l+2);s[l]=h*n(Math.ceil(Math.sqrt(h))),a[s[l]]=l,o[h]=l}var c=[16384,4096,1024,512,512,128,128],d=[0,0,0,0,0,0,0];window.nbTextures=[0,0,0,0,0,0,0];var u=[];window.nbCallsToFreeTexture=0;var p=function(e){nbCallsToFreeTexture++;var t=o[e];return u[t].length?u[t].pop():nbTextures[t]<c[t]?g(!0,s[t],s[t]):null},f=function(e,t){var i=Math.log2(t)-2;u[i].push(e)},g=function(e,i,r,n){var s,o=!n;if(o){s=new Uint8Array(i*r*(e?1:4));for(var l=0;l<i*r;l++)e?s[l]=0:(s[4*l]=0,s[4*l+1]=0,s[4*l+2]=0,s[4*l+3]=255)}else{s=new Float32Array(i*r);for(l=0;l<i*r;l++)s[l]=0}var h=new t.DataTexture(s,i,r,o?e?t.RFormat:t.RGBAFormat:t.RFormat,o?t.UnsignedByteType:t.FloatType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter);return h.generateMipmaps=!1,h.needsUpdate=!0,e&&void 0!==a[i]&&nbTextures[a[i]]++,h},m=e.extend({init:function(e){e.renderer.renderer,this.viewer=e,this.camera=null,function(){for(var e=0;e<7;e++){u[e]=[];for(var t=Math.pow(2,e+2),i=t*n(Math.ceil(Math.sqrt(t))),r=0;r<d[e];r++){var s=g(!0,i,i);u[e].push(s)}}}(),this.maxAllowedSize=4294967296,this.loadedSize=0,this.debugMemoryMap=null,this.pathToModel="",this.modelLoader=null,this.rootNode=new r,this.volumeChunks=[],this.overrideRange=!1,this.minValue=0,this.maxValue=1,this.tileSetRange=[0,1],this.invisibleRanges=[],this.clipPlane=null,this.colorMap=g(!1,2,1),this.colorData=null,this.transferFunctionMap=g(!1,1024,1,!0);for(var t=0;t<1024;t++)this.transferFunctionMap.image.data[t]=.5;return this.transferFunctionMap.needsUpdate=!0,this.binnedMap=g(!1,1024,512,!1),this.binnedValues=new Uint32Array(256),this.binnedMaxValue=0,this.needsRender=!0,this},sortChunks:function(e){var i=new t.Vector3,r=e.position;this.volumeChunks.sort((function(e,t){return i.subVectors(e.data.position,r).length()-i.subVectors(t.data.position,r).length()}))},update:function(e){var t=e._renderedCamera;t&&(this.camera=t,t.matrixWorldInverse.getInverse(t.matrixWorld),this.sortChunks(t))},updateTransferFunction:function(e){for(var t=this.transferFunctionMap.image.data,i=1;i<e.length;i++)for(var r=e[i-1],n=Math.floor(1024*r.position),s=r.value,a=e[i],o=1024*a.position,l=a.value,h=(l-s)/(o-n),c=l-h*o,d=n;d<o;d++)t[d]=h*d+c;this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateTransferFunctionRaw:function(e){var t=this.transferFunctionMap.image.data,i=1023/(e.length-1);if(i>=1)for(var r=1;r<e.length;r++)for(var n=e[r],s=e[r-1],a=Math.floor(i*r),o=Math.floor(i*(r-1)),l=(n-s)/(a-o),h=n-l*a,c=o;c<=a;c++)t[c]=l*c+h;else for(r=0;r<1024;r++)t[r]=e[Math.floor(r/i)];this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateInvisibleRanges:function(){this.invisibleRanges=[];for(var e=this.transferFunctionMap.image.data,t=null,i=0;i<e.length;i++)0===e[i]?t||(t=[i,i],this.invisibleRanges.push(t)):t&&(t[1]=i,t=null);t&&(t[1]=1023);for(i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];r[0]=this.minValue+r[0]/1023*(this.maxValue-this.minValue),r[1]=this.minValue+r[1]/1023*(this.maxValue-this.minValue)}},updateBinnedValues:function(e){if(e&&e.data){var t=e.data.voxelRepartition;if(t)for(var i=255*this.minValue/(this.tileSetRange[1]-this.tileSetRange[0]),r=255*this.maxValue/(this.tileSetRange[1]-this.tileSetRange[0]),n=0;n<256;n++)this.binnedValues[n]+=t[Math.floor(i+(r-i)*n/255)],this.binnedValues[n]>this.binnedMaxValue&&(this.binnedMaxValue=this.binnedValues[n])}},updateBinnedMap:function(){for(var e,t,i,r=1024,n=512,s=this.binnedMap.image.data,a=this.colorMap.image.width,o=0;o<r;o++){var l=Math.round((a-1)*o/1023);this.colorData?(e=this.colorData[4*l],t=this.colorData[4*l+1],i=this.colorData[4*l+2]):(e=255,t=255,i=255);for(var h=this.transferFunctionMap.image.data[o],c=this.binnedValues[Math.round(.25*o)]/this.binnedMaxValue,d=0;d<n;d++){var u=d*r+o,p=h*n>n-d,f=c*n>n-d,g=f?e:255;g*=p?.8:1;var m=f?t:255;m*=p?.8:1;var v=f?i:255;v*=p?.8:1,s[4*u]=g,s[4*u+1]=m,s[4*u+2]=v,s[4*u+3]=255}}this.binnedMap.needsUpdate=!0},setTileSetRange:function(e){this.tileSetRange=[e[0],e[1]]},setMinValue:function(e){this.overrideRange=!0,this.minValue=e},setMaxValue:function(e){this.overrideRange=!0,this.maxValue=e},setColorMap:function(e){var i=this;this.colorMap=t.ImageUtils.loadTexture(e,new t.UVMapping),this.colorMap.onLoadCallbacks.push((function(e){var t=e.image,r=document.createElement("canvas");r.width=t.width,r.height=t.height;var n=r.getContext("2d");n.drawImage(t,0,0),i.colorData=n.getImageData(0,0,t.width,1).data}))},setColorMapRaw:function(e){for(var i=new Uint8Array(4*e.length),r=new t.Color,n=0;n<e.length;n++)r.set(e[n]),i[4*n]=255*r.r,i[4*n+1]=255*r.g,i[4*n+2]=255*r.b,i[4*n+3]=255;this.colorMap=new t.DataTexture(i,e.length,1,t.RGBAFormat,t.UnsignedByteType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter),this.colorMap.generateMipmaps=!1,this.colorMap.needsUpdate=!0,this.colorData=this.colorMap.image.data},computeChunkVoxelDensity:function(e,t){var i=t.data.position,r=e.pixelCullingCst/e.pixelCulling;if(!e.isOrtho){var n=e.matrixWorldInverse.elements;r*=Math.abs(n[2]*i.x+n[6]*i.y+n[10]*i.z+n[14])}var s=t.data.radius/r,a=t.data.mapDim,o=Math.pow(a.x*a.y*a.z,1/3);return t.data._voxelDensity=s/o,s},freeChunk:function(e){var t=e.data;if(null!==t&&0!==e.lastTimeLoaded){var i=t.mapData.data?t.mapData.data.byteLength:t.buffer.byteLength;this.loadedSize-=i,t.map&&f(t.map,t.chunkSize),e.data=null,e.isLoaded=!1,e.isLoading=!1,e.lastTimeLoaded=0}},getTexturePool:function(){return u},getFreeTexture:function(e){var t=p(e.data.chunkSize);if(t)return t;for(var i=0;i<this.volumeChunks.length;i++){var r=this.volumeChunks[i];if(r!==e&&(r.data&&r.data.map&&r.data.chunkSize===e.data.chunkSize)){var n=r.data.map;return r.data.map=null,n}}return null},isRangeVisible:function(e){var t=this.maxValue-this.minValue;if((e.max-e.min)/t<.005)return!1;if(e.min>this.maxValue||e.max<this.minValue)return!1;for(var i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];if(e.min>r[0]&&e.max<r[1])return!1}return!0},getVolumeData:function(e,i){var r=e.targetSGNode;if(i){for(var n=0;n<r.children.length;n++)if("VoxelVolumeNode"===r.children[n].getNodeType()){r=r.children[n];break}}else for(;r.children[0];)r=r.children[0];var s=r.volumeData;if(s){var a=s.mapData.data?s.mapData.data.byteLength:s.buffer.byteLength;this.loadedSize+=a;var o=e.node._boundingBox,l=new t.Vector3(o.max.x-o.min.x,o.max.y-o.min.y,o.max.z-o.min.z),h=new t.Vector3(.5*(o.max.x+o.min.x),.5*(o.max.y+o.min.y),.5*(o.max.z+o.min.z));s.position=h;var c=new t.Vector3;s.radius=.5*o.size(c).length(),s.gridSize=new t.Vector3(l.x,l.y,l.z),s.modelMatrix=(new t.Matrix4).makeTranslation(h.x,h.y,h.z),s.tileSetRange.min=this.tileSetRange[0],s.tileSetRange.max=this.tileSetRange[1];var d=this.tileSetRange[1]-this.tileSetRange[0];s.valueRange.min=this.tileSetRange[0]+d*s.valueRange.min,s.valueRange.max=this.tileSetRange[0]+d*s.valueRange.max,e.data=s,r.volumeData=null}},addChunk:function(e){return!(!e||!e.data)&&(this.volumeChunks.push(e),!0)},removeChunk:function(e){if(!e||!e.data)return!1;var t=this.volumeChunks.indexOf(e);return-1!==t&&(this.volumeChunks.splice(t,1),e.data.map&&f(e.data.map,e.data.chunkSize),e.data.map=null,!0)},loadChunk:function(e,i,n){if(this.modelLoader&&!i.isLoaded){i.isLoading=!0;var s=this,a=new r(e);this.rootNode.addChild(a),this.modelLoader.setOnErrorCallback((function(){i.isLoading=!1,i.isLoaded=!0,s.needsRender=!0})),this.modelLoader.setOnLoadedCallback((function(e){i.isLoading=!1,i.isLoaded=!0,s.needsRender=!0;for(var r=a;r.children[0];)r=r.children[0];var o=r.volumeData;if(o){var l=o.mapData.data?o.mapData.data.byteLength:o.buffer.byteLength;s.loadedSize+=l;var h=i.extent,c=new t.Vector3(h[1][0]-h[0][0],h[1][1]-h[0][1],h[1][2]-h[0][2]),d=new t.Vector3(h[1][0]+h[0][0],h[1][1]+h[0][1],h[1][2]+h[0][2]);o.gridSize=new t.Vector3(c.x,c.y,c.z),o.modelMatrix=(new t.Matrix4).makeTranslation(.5*d.x,.5*d.y,.5*d.z),i.data=o,i.data.map=p(o.chunkSize),i.data.map&&(i.data.map.image=i.data.mapData,i.data.map.needsUpdate=!0),r.volumeData=null,n&&n(i)}})),this.modelLoader.loadModel({provider:"FILE",serverurl:"",filename:this.pathToModel+e,requiredAuth:null,proxyurl:"none",loaderSettings:{volumeChunkType:"uint8"}},a)}}});return m})),define("DS/Visualization/Mesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],(function(e,t,i,r,n){"use strict";var s=0,a=e.NoOccurrences;const o=new e.Vector3(0,0,0);var l=t.extend({init:function(t,i){this._parent(i),this.mesh3DBooleanAttr=0,this.setHasExplicitBE(!0),this.explicitBSphere=new e.Sphere,this.explicitBBox=new e.Box3,this.mesh3js=void 0!==t?t:new e.Mesh,this.setIsInstanceNode3D(!1),this.nbInstances=0,this.drawCount=this.nbInstances,this._bodyDim=0,this._ratioData={ratio:0,center:o,cameraName:null},this._billboardData={type:0,axis:null,rotation:null},this.mesh3js.matrixAutoUpdate=!1,this.mesh3js.matrixWorldNeedsUpdate=!1;var r=this._occurrences[0];if(a||(r.renderable=this.mesh3js,r.renderable.name=this.name,r.renderable._occurrence=r),this.mesh3js.geometry.boundingSphere&&this.explicitBSphere.copy(this.mesh3js.geometry.boundingSphere),this.mesh3js.geometry.boundingBox)this.explicitBBox.copy(this.mesh3js.geometry.boundingBox);else{var n=new e.Vector3(2*this.explicitBSphere.radius,2*this.explicitBSphere.radius,2*this.explicitBSphere.radius);this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,n)}if(!e.disableJHGDev){var s=t.geometry;(1===s._type||s.length>0&&1===s[0]._type)&&t.material&&this.setMaterial(t.material)}return this._updateBEInternal(),this.warnCount=0,this},_linkingClone:function(i,r){return i=i||new l(e.Mesh.DuplicateMesh(this.mesh3js,{ignoreVisibility:!!r}),this.name),t.prototype._linkingClone.call(this,i),i.mesh3DBooleanAttr=this.mesh3DBooleanAttr,i._bodyDim=this._bodyDim,i._ratioData=this._ratioData,i._billboardData=this._billboardData,i.nbInstances=this.nbInstances,i.drawCount=this.drawCount,i._updateBEInternal(),i},getRatio:function(){return this._ratioData.ratio},getFixedSizeCenter:function(){return this._ratioData.center.clone()},setRatio:function(e){if(e!==this._ratioData.ratio&&(r=this._occurrences[0])){var t=r.renderable;if(t){this._ratioData.ratio=e,this.explicitBBox.copy(t.geometry.boundingBox),this.explicitBSphere.copy(t.geometry.boundingSphere),this._updateBEInternal();for(var i=0;i<this._occurrences.length;i++){var r;null!==(r=this._occurrences[i]).renderable&&r.renderable._updateWorldCenterAndRadius()}this._flagAsGSSOInvalidated()}}},_invalidateGSSOUnder:function(e){if(!e.has(this)){e.add(this),this._flagAsGSSOInvalidated();var t=this.getChildren();for(let i=0;i<t.length;i++)t[i]._invalidateGSSOUnder(e)}},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var s=n[r];this._occurrences[r]=s,s._compactChildrenArray(t)}this.mesh3js&&this.mesh3js._compactArrays(t)}},setBillboardData:function(e,t,i){if(s=this._occurrences[0]){var r=s.renderable;if(r){this._billboardData.type=e,this._billboardData.axis=t,this._billboardData.rotation=i,this.explicitBBox.copy(r.geometry.boundingBox),this.explicitBSphere.copy(r.geometry.boundingSphere),this._updateBEInternal();for(var n=0;n<this._occurrences.length;n++){var s;null!==(s=this._occurrences[n]).renderable&&s.renderable._updateWorldCenterAndRadius()}this._flagAsGSSOInvalidated()}}},setFixedSizeCenter:function(e,t){if(n=this._occurrences[0]){var i=n.renderable;if(i){this._ratioData.center=e?e.clone():o,e&&t&&this._ratioData.center.multiplyScalar(t),this.explicitBBox.copy(i.geometry.boundingBox),this.explicitBSphere.copy(i.geometry.boundingSphere),this._updateBEInternal();for(var r=0;r<this._occurrences.length;r++){var n;null!==(n=this._occurrences[r]).renderable&&n.renderable._updateWorldCenterAndRadius()}this._flagAsGSSOInvalidated()}}},setFixedSizeCameraName:function(e){this._ratioData.cameraName=e||"camera",this._flagAsGSSOInvalidated()},_setRatio:function(e){this.setRatio(e)},_setFixedSizeCameraName:function(e){this.setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){this.setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){this.setFixedSizeCenter(e,t)},_updateBEInternal:function(){if(0!==this._billboardData.type&&(this.explicitBSphere&&(this.explicitBSphere.radius+=this.explicitBSphere.center.length(),this.explicitBSphere.center.set(0,0,0),this.explicitBBox&&this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,this.explicitBSphere.radius)),!this.explicitBSphere&&this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0))),this._ratioData.ratio>0&&(this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0)),this.explicitBSphere)){var t=this._ratioData.center.clone();t.multiplyScalar(1/this._ratioData.ratio),this.explicitBSphere.center.add(t),this.explicitBSphere._updateRatio(this._ratioData.ratio)}for(var i=0;i<this._occurrences.length;i++){var r=this._occurrences[i];null!==r.renderable&&r.renderable._updateWorldCenterAndRadius()}this._invalidateBoundingElements(!1,!1)},computeBoundingElements:function(){var t=this._occurrences[0];if(t&&(s=t.renderable)){for(var i=s.geometry.boundingBox,r=s.geometry.boundingSphere,n=0;n<s.geometry.length;n++){(a=s.geometry[n]).computeBoundingBox(),a.computeBoundingSphere(),n?(i.expandByPoint(a.boundingBox.min),i.expandByPoint(a.boundingBox.max),r.clone().mergeWithSphere(a.boundingSphere,r)):(i.copy(a.boundingBox),r.copy(a.boundingSphere))}for(n=0;n<this._occurrences.length;n++){var s,a;(a=(s=this._occurrences[n].renderable).geometry).boundingBox.copy(i),a.boundingSphere.copy(r),s.boundingBox||(s.boundingBox=new e.Box3),s.boundingSphere||(s.boundingSphere=new e.Sphere),s.boundingBox.copy(i),s.boundingSphere.copy(r),s._updateWorldCenterAndRadius()}this.explicitBBox.copy(i),this.explicitBSphere.copy(r),this._updateBEInternal()}},forceBoundingSphere:function(e){this.forceBoundingElements(!0,{sphere:e}),this._updateBEInternal()},_forceBoundingSphere:function(t){this.mesh3js&&this.mesh3js.geometry?(this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingSphere||(this.mesh3js.geometry.boundingSphere=new e.Sphere),this.mesh3js.geometry.boundingSphere.copy(t),this.explicitBSphere.copy(t)):console.log("Couldn't force bounding sphere.")},forceBoundingBox:function(e){this.forceBoundingElements(!0,{box:e}),this._updateBEInternal()},_forceBoundingBox:function(t){this.mesh3js&&this.mesh3js.geometry?(this.mesh3js.geometry.boundingBox||(this.mesh3js.geometry.boundingBox=new e.Box3),this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingBox.copy(t),this.explicitBBox.copy(t)):console.log("Couldn't force bounding box.")},__forceBoundingElements:function(e,t){if(e){var i;e.sphere&&this._forceBoundingSphere(e.sphere),e.box&&this._forceBoundingBox(e.box);for(var r=0;r<this._occurrences.length;r++)null!==(i=this._occurrences[r]).renderable&&i.renderable._updateWorldCenterAndRadius()}},_forceGeomType:function(e){this.mesh3js&&this.mesh3js._forceGeomType(e)},createRenderable:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.visible=this.mesh3js.visible,t.pickable=this.mesh3js.pickable,t.noPickThrough=this.mesh3js.noPickThrough,t.renderDepth=this.mesh3js.renderDepth,t.frustumCulled=this.mesh3js.frustumCulled,t.enableNormalDepth=this.mesh3js.enableNormalDepth,t.castShadow=this.mesh3js.castShadow,t.receiveShadow=this.mesh3js.receiveShadow,t.beforeRenderCB=this.mesh3js.beforeRenderCB,t.fromLoadedModel=this.mesh3js.fromLoadedModel,t.lightMapData=this.mesh3js.lightMapData,t._ratioData=this.mesh3js._ratioData,t._programID=this.mesh3js._programID?this.mesh3js._programID:t._programID,t._vertexColors=this.mesh3js._vertexColors,this.mesh3js._skinningData&&(t._skinningData={},Object.assign(t._skinningData,this.mesh3js._skinningData)),t._billboardData=this.mesh3js._billboardData,t.materialMode=this.mesh3js.materialMode,t._bodyDim=this._bodyDim,t.kdTree=this.mesh3js.kdTree,t.hasPoint=this.mesh3js.hasPoint,this.mesh3js.disableMirror&&(t.disableMirror=this.mesh3js.disableMirror);var i=a?null:this._occurrences[0].renderable;if(i){i.layer&&(t.layer=i.layer.clone());var r=i.selectionGroups;if(r)for(var n=0;n<r.length;n++)t.addSelectionGroup(r[n].clone())}return this.mesh3js.copyInstancingInfos(t),t},add:function(){return!1},setRenderDepth:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.renderDepth=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.renderDepth=e,i.renderable._flagAsGSSOInvalidated())},setFrustumCulled:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.frustumCulled=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.frustumCulled=e)},_setNoCullingBE:function(e){this.setFrustumCulled(!e)},_getNoCullingBE:function(){return null!==this.mesh3js&&!this.mesh3js.frustumCulled},setVertexColors:function(e){null!==this.mesh3js&&this.mesh3js.setVertexColors(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setVertexColors(e)}},setSkinningTransformations:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformations(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformations(e)}},setSkinningTransformationsInstancing:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformationsInstancing(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformationsInstancing(e)}},setSSAO:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.enableNormalDepth=e,this.mesh3js._flagAsGSSOInvalidated()),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.enableNormalDepth=e,i.renderable._flagAsGSSOInvalidated())},setShadow:function(e,t){var i,r;for(null!==this.mesh3js&&(this.mesh3js.castShadow=e,this.mesh3js.receiveShadow=t),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.castShadow=e,r.renderable.receiveShadow=t)},setMirror:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.disableMirror=!e,this.mesh3js._flagAsGSSOInvalidated()),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.disableMirror=!e,i.renderable._flagAsGSSOInvalidated())},clone:function(t){var i=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);!!t&&(this.mesh3js.geometry.boundingSphere&&(i.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()),this.mesh3js.geometry.boundingBox&&(i.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone())),this.mesh3js.copyInstancingInfos(i),i.castShadow=this.mesh3js.castShadow,i.receiveShadow=this.mesh3js.receiveShadow;var r=new THREEDS.Nodes.Mesh(i,this.name);return this.getIsInstanceNode3D()&&r.setIsInstanceNode3D(!0),r},getPrimitive:function(e,t){var i=this._getPrimitives(e,t);return i.length?i[0]:null},getPrimitives:function(e,t){return this._getPrimitives(void 0,e,t)},show:function(e){e?this._setLayer(e,1):this._initLayer(1)},hide:function(e){e?this._setLayer(e,0):this._initLayer(0)},setMaterial:function(t,i){!t||t instanceof e.Material?this._parent(t):t&&(this._initLayer(1),this._setLayer(t,1,i))},setNoZPriority:function(e,t){e&&e instanceof Object?e&&(this._initLayer(1),this._setLayer(e,1,void 0,void 0,t?4:-1)):this._parent(e)},_setGAS:function(e,t){e instanceof Array?e&&(this._initLayer(1),this._setLayer(e,1,void 0,t)):this._parent(e)},setVisuFilters:function(e){e&&(e.LOD=null),this._parent(e)},_setNoZOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,void 0,t?4:-1)},_setNoZOnGLTypes:function(e,t){this._initLayer(1),this._setLayerOnGLTypes(e,void 0,void 0,void 0,t?4:-1)},_setMaterialOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,t)},_setMaterialOnGLTypes:function(e,t){this._initLayer(1),this._setLayerOnGLTypes(e,void 0,t)},_setGASOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,t)},_setGASOnGLTypes:function(e,t){this._initLayer(1),this._setLayerOnGLTypes(e,void 0,void 0,t)},_getGas:function(e){return this._getMaterials(e,!0)},_getMaterials:function(e,t){var r=this._getPrimitivesFromElts(e);if(!r.length)return!1;var n=r[0].container instanceof i.DrawingGroup,s=[],a=this._occurrences[0].renderable;if(!a)return!1;var o=new i.SGPrimitiveHelper;if(a.layer)for(var l=0;l<r.length;l++)for(var h=r[l],c=0;c<a.layer.layers.length;c++){var d=a.layer.layers[c].drawableGroup,u=a.layer.layers[c].drawableInterval;if(-1!==u.layerNum&&((t||u.material)&&(!t||u.gas))){if(n){if(h.container!==d)continue;if(h.index<u.primitiveStart||h.index>=u.primitiveStart+u.primitiveCount)continue;return t?s.push(u.gas):s.push(u.material),s}for(var p=u.primitiveStart;p<u.primitiveStart+u.primitiveCount;p++)if(o.set(d,p),o.isEqual(h))return t?s.push(u.gas):s.push(u.material),s}}return s},setMaterialMode:function(e){var t=e?1:null===e?2:0;null!==this.mesh3js&&(this.mesh3js.materialMode=t);for(var i=0;i<this._occurrences.length;i++){var r=this._occurrences[i];null!==r.renderable&&(r.renderable.materialMode=t)}},getNodeType:function(){return"Mesh3D"},getBodyDimension:function(){return this._bodyDim?this._bodyDim:-1},isEditable:function(){return!1},setInstancingParameters:function(t,i,r){var n,a;if(void 0!==this.mesh3js)if(n=this.mesh3js,this._matApp&&((a=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(a=this._matApp._getMaterialFromGLType(1)),a||(a=this._matApp._getMaterialFromGLType(0))),a||(a=this.material),a){this.setIsInstanceNode3D(!0),this.nbInstances=t,this.drawCount=t,n._instancingInfos={isInstanceNode3D:!0,nbInstances:t,drawCount:t,instancingSelectionMode:r||"instance",instanceAttribArrays:null,instanceAttribArrays_id:s++,pickedInstanceId:-1,useDefaulInstancing:!1};for(var o=new Float32Array(t),l=0;l<t;l++)o[l]=5+5*l;var h={instanceId:{}};h.instanceId.array=o,h.instanceId.buffer=null,h.instanceId.itemSize=1,h.instanceId.type="f";for(var c=0;c<i.length;c++){switch(h[i[c].attribName]={},i[c].type){case"f":h[i[c].attribName].array=new Float32Array(i[c].data),h[i[c].attribName].type="f",h[i[c].attribName].itemSize=1;break;case"v2":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(2*t);for(var d=0;d<t;d++)h[i[c].attribName].array[2*d]=i[c].data[d].x,h[i[c].attribName].array[2*d+1]=i[c].data[d].y}h[i[c].attribName].type="v2",h[i[c].attribName].itemSize=2;break;case"v3":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(3*t);for(d=0;d<t;d++)h[i[c].attribName].array[3*d]=i[c].data[d].x,h[i[c].attribName].array[3*d+1]=i[c].data[d].y,h[i[c].attribName].array[3*d+2]=i[c].data[d].z}h[i[c].attribName].type="v3",h[i[c].attribName].itemSize=3;break;case"v4":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(4*t);for(d=0;d<t;d++)h[i[c].attribName].array[4*d]=i[c].data[d].x,h[i[c].attribName].array[4*d+1]=i[c].data[d].y,h[i[c].attribName].array[4*d+2]=i[c].data[d].z,h[i[c].attribName].array[4*d+3]=i[c].data[d].w}h[i[c].attribName].type="v4",h[i[c].attribName].itemSize=4;break;case"m4":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(16*i[c].data.length);for(var u=0;u<i[c].data.length;u++){var p=new Float32Array(16);p=i[c].data[u].elements;for(l=0;l<16;l++)h[i[c].attribName].array[16*u+l]=p[l]}}h[i[c].attribName].type="m4",h[i[c].attribName].itemSize=4,h[i[c].attribName].isMat4=!0}h[i[c].attribName].buffer=null}if(n._instancingInfos.instanceAttribArrays=h,a._PDSFXData&&a._PDSFXData.PDSFX){a._PDSFXData.pdsfxAttributesInternal={};for(let e=0;e<i.length;e++)a._PDSFXData.pdsfxAttributesInternal[i[e].attribName]={type:i[e].type,instancing:!0}}for(var f=0;f<this._occurrences.length;f++)n.copyInstancingInfos(this._occurrences[f].renderable)}else console.error("Error: An instancing material wasn't set to the Mesh3D.")},setDrawCount:function(e){if(!this.mesh3js._instancingInfos)return void console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).");e<0&&(this.warnCount<10&&(console.warn(`Error: drawCount ${e} is negative.`),this.warnCount+=1),e=0),e>this.nbInstances&&(this.warnCount<10&&(console.warn(`drawCount ${e} is greater than max number of instances ${this.nbInstances} .`),this.warnCount+=1),e=this.nbInstances);const t=this.drawCount;this.drawCount=e,this.mesh3js._instancingInfos.drawCount=e;for(var i=0;i<this._occurrences.length;i++)this._occurrences[i].renderable._instancingInfos.drawCount=e;if(this.drawCount<t)for(let e=0;e<this._occurrences.length;e++){let t=this._occurrences[e]._getRenderableOccurrences();for(let e=0;e<t.length;e++)this._removeFromVisuSelection(t[e])}},updateInstanceAttribValue:function(t){if(t.instanceId&&t.attribName&&void 0!==t.value){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(t.instanceId%5!=0||t.instanceId<5||t.instanceId>5*r._instancingInfos.nbInstances)console.error("Error: the instance id is incorrect or out of range.");else if(r._instancingInfos.instanceAttribArrays[t.attribName]){var n=r._instancingInfos.instanceAttribArrays,s=t.instanceId/5-1,a=!0;switch(n[t.attribName].type){case"f":"number"!=typeof t.value||isNaN(t.value)?a=!1:n[t.attribName].array[s]=t.value;break;case"v2":t.value instanceof e.Vector2?(n[t.attribName].array[2*s]=t.value.x,n[t.attribName].array[2*s+1]=t.value.y):a=!1;break;case"v3":t.value instanceof e.Vector3?(n[t.attribName].array[3*s]=t.value.x,n[t.attribName].array[3*s+1]=t.value.y,n[t.attribName].array[3*s+2]=t.value.z):a=!1;break;case"v4":t.value instanceof e.Vector4?(n[t.attribName].array[4*s]=t.value.x,n[t.attribName].array[4*s+1]=t.value.y,n[t.attribName].array[4*s+2]=t.value.z,n[t.attribName].array[4*s+3]=t.value.w):a=!1;break;case"m4":if(t.value instanceof e.Matrix4){var o=new Float32Array(16);o=t.value.elements;for(var l=0;l<16;l++)n[t.attribName].array[16*s+l]=o[l]}else a=!1;break;default:a=!0}if(a){var h;n[t.attribName].isDynamic=!0;for(var c=0;c<this._occurrences.length;c++){var d;if((h=this._occurrences[c].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,h.highlightMeshes)for(d=0;d<h.highlightMeshes.length;d++)h.highlightMeshes[d].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new value doesn't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}else console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.")},updateInstanceAttribArray:function(t){if(t.attribName&&t.array){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(r._instancingInfos.instanceAttribArrays[t.attribName]){var n=!0,s=r._instancingInfos.instanceAttribArrays;if(t.isFlattened)t.array instanceof Array&&(t.array=new Float32Array(t.array)),s[t.attribName].array=t.array;else{var a=s[t.attribName].type,o=t.array[0];switch(a){case"f":"number"!=typeof o||isNaN(o)?n=!1:s[t.attribName].array.set(new Float32Array(t.array));break;case"v2":if(o instanceof e.Vector2)for(var l=0;l<r._instancingInfos.nbInstances;l++)s[t.attribName].array[2*l]=t.array[l].x,s[t.attribName].array[2*l+1]=t.array[l].y;else n=!1;break;case"v3":if(o instanceof e.Vector3)for(l=0;l<r._instancingInfos.nbInstances;l++)s[t.attribName].array[3*l]=t.array[l].x,s[t.attribName].array[3*l+1]=t.array[l].y,s[t.attribName].array[3*l+2]=t.array[l].z;else n=!1;break;case"v4":if(o instanceof e.Vector4)for(l=0;l<r._instancingInfos.nbInstances;l++)s[t.attribName].array[4*l]=t.array[l].x,s[t.attribName].array[4*l+1]=t.array[l].y,s[t.attribName].array[4*l+2]=t.array[l].z,s[t.attribName].array[4*l+3]=t.array[l].w;else n=!1;break;case"m4":if(o instanceof e.Matrix4){var h;for(l=0;l<r._instancingInfos.nbInstances;l++){h=t.array[l].elements;for(var c=0;c<16;c++)s[t.attribName].array[16*l+c]=h[c]}}else n=!1;break;default:n=!0}}if(n){var d;s[t.attribName].isDynamic=!0;for(var u=0;u<this._occurrences.length;u++){var p;if((d=this._occurrences[u].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,d.highlightMeshes)for(p=0;p<d.highlightMeshes.length;p++)d.highlightMeshes[p].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new values don't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}},setInstancingSelectionMode:function(e){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=e;for(var t=this._occurrences,i=t.length,r=0;r<i;r++)t[r].renderable._instancingInfos.instancingSelectionMode=e}},_getPrimitivesFromElts:function(e){var t=[];if(e.length)if(e[0]instanceof r)for(var n=0;n<e.length;n++)if("rep"===e[n].getType())for(var s=0;s<e[n].sgNode.getPrimitivesCount();s++){var a=new i.SGPrimitiveHelper;a.set(e[n].sgNode,s),t.push(a)}else t.push(e[n].sgNode);else t=e.slice();return t},_setLayer:function(e,t,i,r,n){var s,a,o=[];if(a=this._getPrimitivesFromElts(e),-1===t){var l;if(!(l=this._occurrences[0].renderable))return;o=l.getRenderablesFromGeometries()}else for(s=0;s<this._occurrences.length;s++)o.push(this._occurrences[s].renderable);for(s=0;s<o.length;s++)if(l=o[s]){var h;if(l._flagAsGSSOInvalidated(),null===l.layer)if(l.initLayers(1),l.highlightMeshes)for(h=0;h<l.highlightMeshes.length;h++)l.highlightMeshes[h].renderable.layer=l.layer.clone();l.layer.addPrimitivesToLayers(a,t,i,r,null,n)}},_setLayerByFilteredDG:function(e,t,i,r,n){var s=[];if(-1===t){if(!(o=this._occurrences[0].renderable))return;s=o.getRenderablesFromGeometries()}else for(a=0;a<this._occurrences.length;a++)s.push(this._occurrences[a].renderable);for(var a=0;a<s.length;a++){var o;if(o=s[a]){var l;if(o._flagAsGSSOInvalidated(),null===o.layer)if(o.initLayers(1),o.highlightMeshes)for(l=0;l<o.highlightMeshes.length;l++)o.highlightMeshes[l].renderable.layer=o.layer.clone();for(var h=0;h<o.geometry.length;h++)for(var c=o.geometry[h],d=0;d<c.drawingGroups.length;d++){var u=c.drawingGroups[d];e(u)&&o.layer.setDGToLayer(c,u,t,i,r,void 0,n)}}}},_setLayerOnGeomTypes:function(e,t,i,r,n){this._setLayerByFilteredDG((function(t){var i=void 0!==t._initialGeomType?t._initialGeomType:t._geomType;return-1!==e.indexOf(i)}),t,i,r,n)},_setLayerOnGLTypes:function(e,t,i,r,n){this._setLayerByFilteredDG((function(t){return-1!==e.indexOf(t.glType)}),t,i,r,n)},_flagAsGSSOInvalidated:function(){for(var e=0;e<this._occurrences.length;e++){var t=this._occurrences[e];null!==t.renderable&&t.renderable._flagAsGSSOInvalidated()}},_initLayer:function(e){var t,i;for(t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable._flagAsGSSOInvalidated(),null===i.renderable.layer&&i.renderable.initLayers(e))},_resetLayers:function(){var e,t;for(e=0;e<this._occurrences.length;e++)null!==(t=this._occurrences[e]).renderable&&(t.renderable._flagAsGSSOInvalidated(),t.renderable.layer=null)},_removePrimitives:function(e){e&&this._setLayer(e,-1)},_addDynamicGeometry:function(e,t,i){var r=null,n=this._occurrences[0].renderable;if(!n)return!1;for(var s=0;s<n.geometry.length;s++)if(n.geometry[s].dynamic){r=n.geometry[s];break}if(r)r.merge(e,t,i);else{e.dynamic=!0;for(s=0;s<this._occurrences.length;s++)(n=this._occurrences[s].renderable)&&n.addGeometry(e)}},_optimizeBuffers:function(e){var t={invalidRatio:e&&void 0!==e.invalidRatio?e.invalidRatio:.5};if(l=this._occurrences[0].renderable){var r=l.geometry;if(r instanceof Array){var n=l.layer?l.layer.layers:null;if(n){var s=new Map,a=i.mergeGeometries({geometries:r,layers:n,invalidRatio:t.invalidRatio,force:!1},s);if(a)for(var o=0;o<this._occurrences.length;o++){var l;if(l=this._occurrences[o].renderable){l.releaseVBO(!1),l.geometry.length=0;for(var h=0;h<a.length;h++)l.geometry.push(a[h]);for(h=0;h<a.length;h++)a[h].addRefVBO(l,!1);a.boundingBox&&(l.geometry.boundingBox=a.boundingBox.clone()),a.boundingSphere&&(l.geometry.boundingSphere=a.boundingSphere.clone());var c=l.layer.layers,d=!1,u=[];for(h=0;h<c.length;h++){var p=[],f=c[h].drawableGroup,g=c[h].drawableInterval;if(g.layerNum>0&&g.material){d=!0;for(var m=g.primitiveStart;m<g.primitiveStart+g.primitiveCount;m++)if(s.has(f)){var v=s.get(f);v.has(m)&&p.push(v.get(m))}u.push({layerInterval:g,primitives:p})}}if(l.layer=null,d){l.initLayers(1);for(h=0;h<u.length;h++)l.layer.addPrimitivesToLayers(u[h].primitives,u[h].layerInterval.layerNum,u[h].layerInterval.material)}}}}}}},_getPrimitives:function(e,t,n){""===e&&(e=null);var s=[],a=this._occurrences[0].renderable;if(!a)return!1;var o=new i.SGPrimitiveHelper;if(a.layer)for(var l=0;l<a.layer.layers.length;l++){var h=a.layer.layers[l].drawableGroup,c=a.layer.layers[l].drawableInterval;if(void 0!==n)if((void 0!==h._initialGeomType?h._initialGeomType:h._geomType)!==n)continue;if(-1!==c.layerNum&&(!t||c.layerNum))for(var d=c.primitiveStart;d<c.primitiveStart+c.primitiveCount;d++)if(o.set(h,d),void 0!==e){if(o.getCgmId()===e)return s.push(r.getFromSGNode(o.clone())),s}else s.push(r.getFromSGNode(o.clone()))}else{var u=a.geometry;if(!(u instanceof Array))return s;for(d=0;d<u.length;d++){var p=u[d].drawingGroups;for(l=0;l<p.length;l++){h=p[l];if(void 0!==n)if((void 0!==h._initialGeomType?h._initialGeomType:h._geomType)!==n)continue;for(var f=0;f<h.getPrimitivesCount();f++)if(o.set(h,f),void 0!==e){if(o.getCgmId()===e)return s.push(r.getFromSGNode(o.clone())),s}else s.push(r.getFromSGNode(o.clone()))}}}return s},_setBeforeRenderCB:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.beforeRenderCB=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.beforeRenderCB=e)}});l.prototype._isMesh3D=!0;var h=1,c=2;return l.prototype.getHasExplicitBE=function(){return(this.mesh3DBooleanAttr&h)>0},l.prototype.setHasExplicitBE=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|h:this.mesh3DBooleanAttr&~h},l.prototype.getIsInstanceNode3D=function(){return(this.mesh3DBooleanAttr&c)>0},l.prototype.setIsInstanceNode3D=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|c:this.mesh3DBooleanAttr&~c},l.prototype.forceNoMeshInRAM=function(){var e,t,i=this.mesh3js.geometry;for(e=0;e<i.length;e++){if((t=i[e]).sharedBuffers)throw new Error("Cannot force no mesh in RAM on geometry with sharedBuffers");t.noMeshInRAM||(t.noMeshInRAM=!0,t.vertexBufferGPU&&t.clearMeshInRAM(!1))}},Object.defineProperty(l.prototype,"hasExplicitBE",{get:function(){return this.getHasExplicitBE()},set:function(e){this.setHasExplicitBE(e)}}),Object.defineProperty(l.prototype,"isInstanceNode3D",{get:function(){return this.getIsInstanceNode3D()},set:function(e){this.setIsInstanceNode3D(e)}}),UWA.namespace("THREEDS/Nodes/Mesh",l)})),define("Visualization/Mesh3D",["DS/Visualization/Mesh3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/Mesh3D"),e})),define("DS/Visualization/CompareModelsServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Effects/CompareModelsEffect","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet"],(function(e,t,i,r,n,s,a){"use strict";var o=e.extend({init:function(e){return this.viewer=e,this._oldMatInherit=!1,this.compareEffect=null,this.effectID=-1,this._tmpNodes=[],this._occurrences=[],this},startCompare:function(e){this._oldMatInherit=this.viewer.renderer.renderer.newMaterialInheritance,this.viewer.renderer.renderer.newMaterialInheritance=!0,this.viewer.materialManager.setBlankingPolygonVisibility(!1);for(var r=new t.Color(e.first.color),n=new t.Color(e.second.color),s=new t.Color(e.common.color),o=new a({colorRGB:r,colorA:e.first.opacity,inheritanceCustom:t.GASEnumCustom._FORCE_EDGE_OPACITY}),l=new a({colorRGB:n,colorA:e.second.opacity,inheritanceCustom:t.GASEnumCustom._FORCE_EDGE_OPACITY}),h=new a({colorRGB:s,colorA:e.common.opacity,inheritanceCustom:t.GASEnumCustom._FORCE_EDGE_OPACITY}),c=e.first.pathElements,d=e.second.pathElements,u=[],p=[],f=0;f<c.length;f++){var g=this._createTemporaryNode(c[f]);u.push(g)}for(f=0;f<d.length;f++){g=this._createTemporaryNode(d[f]);p.push(g)}for(f=0;f<u.length;f++)u[f].setVisibility(!1);for(f=0;f<p.length;f++)p[f].setVisibility(!1);for(f=0;f<c.length;f++)this._applyColorsAndPasses(0,c[f],u[f],o,h);for(f=0;f<d.length;f++)this._applyColorsAndPasses(1,d[f],p[f],l);if(!this.compareEffect){var m=new i(this.viewer.renderer.renderer,this.viewer.renderer.renderTargetPool);this.effectID=this.viewer.renderer.addCustomEffect(m),this.compareEffect=this.viewer.renderer.getCustomEffect(this.effectID)}this.compareEffect.set2DMode(e.compareMode&&"2D"===e.compareMode),this.viewer.renderer.setCustomEffect(this.effectID,!0)},stopCompare:function(){this.viewer.renderer.setCustomEffect(this.effectID,!1),this._cleanTemporaryNodes(),this.viewer.renderer.renderer.newMaterialInheritance=this._oldMatInherit,this.viewer.materialManager.setBlankingPolygonVisibility(!0)},_createTemporaryNode:function(e){var t=e.externalPath[e.externalPath.length-2],i=new r;return this._tmpNodes.push(i),t.addChild(i),i.addChild(e.getLastElement()),i},_hideOccurrences:function(e){for(var t=0;t<e._occurrences.length;t++){e._occurrences[t].setVisibility(!1)}},_applyColorsAndPasses:function(e,t,i,r,n){var a=t.externalPath.slice();a.splice(t.externalPath.length-1,0,i);for(var o=new s(a),l=t._getOccurrences(this.viewer),h=o._getOccurrences(this.viewer),c=0;c<l.length;c++){var d=l[c];this._updateGASOccurrence(d,r)}for(c=0;c<h.length;c++){(d=h[c])._relativeVisibility=2,1===e?this._updateRenderPassesOccurrence(d,["compareNew"]):(this._updateRenderPassesOccurrence(d,["compareOld"]),this._updateGASOccurrence(d,n))}},_cleanTemporaryNodes:function(){for(var e=0;e<this._occurrences.length;e++){var t=this._occurrences[e];this._resetOccurrence(t)}this._occurrences=[];for(e=0;e<this._tmpNodes.length;e++){var i=this._tmpNodes[e];i.removeChildren();for(var r=0;r<i.parents.length;r++)i.parents[r].removeChild(i)}this._tmpNodes=[]},_updateGASOccurrence:function(e,t){this._occurrences.push(e),e.forceGAS=t,e.gas=t,e.node._updateOccurrences(e.parent,e,r.UpdateMatrixMode.Never,void 0,r.InvalidateGSSOMode.Always)},_updateRenderPassesOccurrence:function(e,t){this._occurrences.push(e),e.forcePasses=t,e.node._updateOccurrences(e.parent,e,r.UpdateMatrixMode.Never,void 0,r.InvalidateGSSOMode.Always)},_resetOccurrence:function(e){e.forceGAS=null,e.gas=null,e.forcePasses=null,e._relativeVisibility=null,e.traverse((function(e){e._relativeVisibility=null}));for(var t=0;t<e.children.length;t++){var i=e.children[t];i.node._updateOccurrences(e,i,r.UpdateMatrixMode.Never,void 0,r.InvalidateGSSOMode.Always)}}});return UWA.namespace("THREEDS/CompareModelsServices",o)})),define("DS/Visualization/PrimitiveIterator",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/PathElement"],(function(e,t,i,r){"use strict";var n={},s=e.extend({init:function(e,t){if(t===n){var s=e;if(this._primitives=null,this._sgRep=null,this._sgPrimitive=null,e instanceof r&&(s=e.getLastElement()),s instanceof i)this._primitives=s.getPrimitives();else if(s.sgNode)switch(s.sgNode.getType?s.sgNode.getType():s.sgNode.type){case 2:this._sgRep=s.sgNode;break;case 3:this._sgPrimitive=s.sgNode;break;default:console.log("PrimitiveIterator: unsupported SubElement type")}}},getNbPrimitives:function(){if(this._primitives)return this._primitives.length;if(this._sgPrimitive)return 1;if(this._sgRep)return this._sgRep.getPrimitivesCount();throw new Error("Internal error")},getConnectivityType:function(e){return this._getSGNode(e).getGroup().glType},getLength:function(e){return this._getSGNode(e).getCount()},getOffset:function(e){return this._getSGNode(e).getStart()},getIndexArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexIndexArray},getPositionArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexPositionArray},getNormalArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexNormalArray},getMaterial:function(e){return this._getSGNode(e).getGroup().material},getGas:function(e){return this._getSGNode(e).getGroup().gas},getGeomType:function(e){var i=this._getSGNode(e);return t.GeomTypeString[i.getGroup()._geomType]},_getSGNode:function(e){if(this._primitives)return this._primitives[e].sgNode;if(this._sgPrimitive&&0===e)return this._sgPrimitive;if(this._sgRep){var i=new t.SGPrimitiveHelper;return i.set(this._sgRep,e),i}}});return s.POINTS=0,s.LINES=1,s.LINE_LOOP=2,s.LINE_STRIP=3,s.TRIANGLES=4,s.TRIANGLE_STRIP=5,s.TRIANGLE_FAN=6,s._authorizedTeamsOnly_getKey=function(){return n},s})),define("DS/Visualization/EditableMesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Intersection/IntersectionUtils"],(function(e,t,i,r){"use strict";var n=t.extend({init:function(e,t){return this._parent(e,t),this},clone:function(){let t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return this.mesh3js.copyInstancingInfos(t),new THREEDS.Nodes.EditableMesh(t,this.name)},getNodeType:function(){return"Mesh3D"},isEditable:function(){return!0},getBuffer:function(e,t){let i=t||this.mesh3js.geometry[0],r=this._getDataArray(e);return r?i[r]:null},getIndexBuffer:function(e){let t=e||this.mesh3js.geometry[0];return this._getIndexArray(t)},updateIndexBuffer:function(e,t,i,r){let n=void 0===r||r;n=(i||this.mesh3js.geometry[0]).markIndexStale(e,e+t)||n,n&&this._clearGSSOCache()},updateBuffer:function(e,t,i,n,s){let a=void 0===s||s,o=n||this.mesh3js.geometry[0];const l=this._getDataArray(e);a=o.markAttributeStale({vertexPositionArray:"position",vertexNormalArray:"normal",vertexUvArray:"uv",vertexUv2Array:"uv2",vertexTangentArray:"tangent",vertexBinormalArray:"binormal",vertexColorArray:"color"}[l],t,t+i)||a,o.vertexBufferGPU&&(o.vertexBufferGPU.needsUpdate=!0),o.wideLinesLinker&&o.wideLinesLinker.linkedGeometry.vertexBufferGPU&&(o.wideLinesLinker.linkedGeometry.vertexBufferGPU.needsUpdate=!0),a&&this._clearGSSOCache(),r.clearDGBSCache()},addBuffer:function(e,t,r){this._clearGSSOCache();let n=r||this.mesh3js.geometry[0];const s=this._getDataArray(e);if(!(s?n[s]:null))switch(n.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:n.vertexPositionArray=t;break;case i.VertexComponentEnum.NORMAL:n.vertexNormalArray=t;break;case i.VertexComponentEnum.DIFFUSE_COLOR:n.vertexColorArray=t;break;case i.VertexComponentEnum.TEX_COORD_0:n.vertexUvArray=t;break;case i.VertexComponentEnum.TEX_COORD_1:n.vertexUv2Array=t;break;case i.VertexComponentEnum.TEX_COORD_2:n.vertexTangentArray=t;break;case i.VertexComponentEnum.TEX_COORD_3:n.vertexBinormalArray=t}},removeBuffer:function(e,t){this._clearGSSOCache();let r=t||this.mesh3js.geometry[0];const n=this._getDataArray(e);if(n?r[n]:null)switch(r.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:r.vertexPositionArray=null;break;case i.VertexComponentEnum.NORMAL:r.vertexNormalArray=null;break;case i.VertexComponentEnum.DIFFUSE_COLOR:r.vertexColorArray=null;break;case i.VertexComponentEnum.TEX_COORD_0:r.vertexUvArray=null;break;case i.VertexComponentEnum.TEX_COORD_1:r.vertexUv2Array=null;break;case i.VertexComponentEnum.TEX_COORD_2:r.vertexTangentArray=null;break;case i.VertexComponentEnum.TEX_COORD_3:r.vertexBinormalArray=null}},_getIndexArray:function(e){return e.vertexIndexArray},_getDataArray:function(e){switch(e){case i.VertexComponentEnum.POSITION:return"vertexPositionArray";case i.VertexComponentEnum.NORMAL:return"vertexNormalArray";case i.VertexComponentEnum.DIFFUSE_COLOR:return"vertexColorArray";case i.VertexComponentEnum.TEX_COORD_0:return"vertexUvArray";case i.VertexComponentEnum.TEX_COORD_1:return"vertexUv2Array";case i.VertexComponentEnum.TEX_COORD_2:return"vertexTangentArray";case i.VertexComponentEnum.TEX_COORD_3:return"vertexBinormalArray"}return null},_clearGSSOCache:function(){let e,t=null,i=null;for(e=0;e<this._occurrences.length;e++)i=this._occurrences[e],t=i.renderable,t&&(t._flagAsGSSOInvalidated(),t.outlinesGeometry&&(t.outlinesGeometry.upToDate=!1))}});return UWA.namespace("THREEDS/Nodes/EditableMesh",n)})),define("Visualization/EditableMesh3D",["DS/Visualization/EditableMesh3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/EditableMesh3D"),e})),define("DS/Visualization/DecalNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Visualization/MaterialApplication"],(function(e,t,i){"use strict";var r=t.extend({init:function(t,i){if(!e.DecalManager._creatingDecal)throw"Use Decal Manager to create decals";return this._parent(t,i),this.decalNode3DBooleanAttr=0,this._setHasExplicitUv(!1),this._decalAttachedTo=new Map,this.setVisibilityFree(!0),this.setMaterialMode(1),this._enableDepth=!1,this._matAppLayer=-1n,this._matAppInheritance=-1,e.DecalManager.activated=!0,this},setExplicitUv:function(t){this._setHasExplicitUv(t);for(var i=this._getAllOwningViewers(),r=0;r<i.length;r++)e.DecalManager.updateDecalsData(i[r],!0)},isExplicitUv:function(){return this._getHasExplicitUv()},setLegacyLayer:function(t,i){if(!window.newMaterialInheritance){this._matAppLayer=BigInt(t),this._enableDepth=!!i;for(var r=this._getAllOwningViewers(),n=0;n<r.length;n++)e.DecalManager.updateDecalsData(r[n],!0)}},setLegacyInheritance:function(t){if(!window.newMaterialInheritance){this._matAppInheritance=t;for(var i=this._getAllOwningViewers(),r=0;r<i.length;r++)e.DecalManager.updateDecalsData(i[r],!0)}},getLegacyLayer:function(e){if(this._enableDepth){let t=this._getOccAttachedTo(e),i=0;if(e&&t){let r=t.depth,n=e.depth-1-r;i=330000n*BigInt(r)+100000n*BigInt(n)+1n+this._matAppLayer}return i}return this._matAppLayer},__shareAttachementFrom:function(e){this._decalAttachedTo=e},attachTo:function(e){return!e._isDecal&&(this._decalAttachedTo.set(e,this),this._updateMatrix(),!0)},getAttachedTo:function(){return Array.from(decalNode._decalAttachedTo.keys())},_getOccAttachedTo:function(e){let t=e.parent;const i=e.node;if(i._decalAttachedTo.size>0)for(;t&&!i._decalAttachedTo.has(t.node);)t=t.parent;return t},_getOccAttachDecalNode:function(e){var t=this._getOccAttachedTo(e),i=this;const r=e.node;return t&&(i=r._decalAttachedTo.get(t.node)),i!==this&&i?i:null},_getPrioritaryNode:function(e){if(!this._enableDepth&&this._matAppInheritance>=0&&e){var t=this._matAppLayer,r=e._matAppLayer,n=this._matAppInheritance,s=e._matAppInheritance;if(!i._isPrioritary(n,s,t,r))return e}return this},applyOn:function(e){return e.addChild(this)},getAppliedOn:function(){return this.parents.slice()},applyAndAttach:function(e){return this.attachTo(e)&&this.applyOn(e)},unapply:function(e){if(!this.parents.length)return!1;if(e)return e.removeChild(this);for(var t=0;t<this.parents.length;t++)this.parents[t].removeChild(this);return!0},detach:function(e){return e?this._decalAttachedTo.delete(e):this._decalAttachedTo.clear(),this._updateMatrix(),!0},unapplyAndDetach:function(){return this.unapply(null)&&this.detach(null)},addChild:function(e){return!1},removeChild:function(e){return!1},setMaterialMode:function(i){e.DecalManager._creatingDecal&&t.prototype.setMaterialMode.call(this,i)},_propagateVisuFilters:function(e,t){},setVisuFilters:function(e){}});r.prototype._isDecal=!0;var n=1;return r.prototype._getHasExplicitUv=function(){return(this.decalNode3DBooleanAttr&n)>0},r.prototype._setHasExplicitUv=function(e){this.decalNode3DBooleanAttr=e?this.decalNode3DBooleanAttr|n:this.decalNode3DBooleanAttr&~n},UWA.namespace("THREEDS/Nodes/DecalNode3D",r)})),define("Visualization/DecalNode3D",["DS/Visualization/DecalNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/DecalNode3D"),e})),define("DS/Visualization/SceneGraphFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/DecalNode3D","DS/Visualization/EditableMesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/Canvas2DNode","DS/SceneGraphNodes/Canvas2DInstancingNode","DS/Effects/ComputeSDFFontIterative","DS/Effects/DownSamplingEffect","DS/Effects/ComputeSDFFontMergeTiles","DS/Visualization/MaterialApplication","DS/Visualization/ImageUtils"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y){"use strict";var S=new h,b={textCanvas:null,iterativeCompute:null,downSampling:null,mergeTiles:null},x=["left","center","right"],w=[0,.5,1],P=["top","bottom","middle","alphabetic","hanging"],C=[0,1,.5,1,0];const M={left:0,center:.5,right:1},E={top:0,bottom:1,middle:.5,alphabetic:1,hanging:0};var T,A,D,I,R,O,L,B,F,V,G,N,U,k={createMeshNode:function(t,s,o,l,h,c){var d,u,p,f,g,m,v,_,y=void 0!==o?o:0,S=void 0!==s?s:t.material;e.disableJHGDev&&null==S&&(d=new e.Color,u=new e.Color(6710886),p=new e.Color,(S=e.MaterialUtils.createShinyFaceMaterial({color:d.getHex(),opacity:1})).line=new e.LineBasicMaterial({color:u.getHex(),lineWidth:1,opacity:1}),S.point=new e.ParticleBasicMaterial({color:p.getHex(),size:1,opacity:1})),f=new a.SGBag,g=new a.SGRep({cgmId:y,parent:f}),a.validatePrimitiveGroup(t);var b,x=a.checkMeshOptimizable(t),w=x&&t.editable,P=x&&(t.editable||t.optimized),C=!w&&t.sharing;if(P)v=[a.createGeometryOptimized(t,g)],w&&(v[0].editable=!0);else{t.editable?console.warn("Could not make the mesh editable since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer."):t.optimized&&console.warn("Could not optimize the mesh build since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.");for(var M=0;M<t.buffers.length;M++){var E=t.buffers[M];if(E&&E.component===a.VertexComponentEnum.DIFFUSE_COLOR){if(3===E.dimension){E.dimension=4,E.size*=4/3;for(var T=E.data,A=T.length/3,D=new Float32Array(4*A),I=0,R=0;R<A;R++)D[I]=T[3*R],D[I+1]=T[3*R+1],D[I+2]=T[3*R+2],D[I+3]=1,I+=4;E.data=D}else 4!==E.dimension&&console.error("ERROR : Your Color Buffer should have 4 values per vertex (RGBA)");break}}(m=a.convertToGeometry3js(t,void 0,void 0,void 0,l,!1,h)).rep=g,(v=a.divideRep(m)).sceneGraph=f,t.patternOffsets&&(v.patternOffsets=t.patternOffsets)}return _=a.convertTo3jsMesh(v,S,!0,C),b=c?new r(_):w?new n(_):new i(_),!e.disableJHGDev&&S&&b.setMaterial(S),t.noz&&b.setRenderPasses(["noz"]),b},isReady:function(){return this.root.isReady()},applyMaterialOpacityOverrideToPath:function(){return!1},applyMaterialOverrideToPath:function(){return!1},removeAnyMaterialOverride:function(){return!1},createCuboidNode:function(e){var t=S.CreateVis3DCuboid(e);return this.createMeshNode(t,e.material,void 0,void 0,void 0,!!e._decal)},createCuboidNodeFromBox3:function(e,t){var i=S.CreateVis3DCuboidFromBox3(e,{});return this.createMeshNode(i,t,void 0,"mono")},createSphereNode:function(e){var t=S.CreateVis3DSphere(e);return this.createMeshNode(t,e.material,void 0,"mono")},createTubeNode:function(e){var t=S.CreateVis3DTube(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderNode:function(e){var t=S.CreateVis3DCylinder(e);return this.createMeshNode(t,e.material,void 0,"mono")},createConeNode:function(e){var t=S.CreateVis3DCone(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderCustomNode:function(e){var t=S.CreateVis3DCylinderCustom(e);return this.createMeshNode(t,e.material,void 0,"mono")},createLineNode:function(e){var t=S.createLine(e);return this.createMeshNode(t,e.material)},createRectangleNode:function(e){var t=S.createRectangle(e);return this.createMeshNode(t,e.material)},createCircleNode:function(e){var t=S.createCircle(e);return this.createMeshNode(t,e.material)},createTorusNode:function(e){var t=S.createTorus(e);return this.createMeshNode(t,e.material)},createPointsNode:function(e){var t=S.createPoints(e.positions,e.color,e.size,e.layerNb);return this.createMeshNode(t,e.material)},createSimpleMeshNode:function(e){var t=S.createMesh(e.bufferPosition,e.bufferNormal,e.bufferUV,e.bufferIndex,e.glType,e.color,void 0,e.axis,e.layerNb);return this.createMeshNode(t,e.material)},createTessellatedCurvedPipe:(T=new e.Vector3,A=new e.Vector3,D=new e.Vector3,I=new e.Vector3,R=new e.Vector3,O=new e.Vector3,L=new e.Vector3,B=new e.Vector3,F=new e.Vector3,V=new e.Vector3,G=new e.Vector3,N=new e.Vector3,U=new e.Vector3,function(t,r,n,s,o,l,h,c,d){var u=new e.BufferGeometryDS;u.sharedBuffers=!0;var p=n.length/3;T.set(n[0]+s.x,n[1]+s.y,n[2]+s.z),A.set(n[3*(p-1)]+o.x,n[3*(p-1)+1]+o.y,n[3*(p-1)+2]+o.z),u.drawingGroups=[];var f=6*t*(p-1)+6*(t-2),g=new a.DrawingGroup(c,d,4,0,f);g.geometry=u,u.drawingGroups.push(g);for(var m=(p+2)*t,v=new Float32Array(3*m),_=new Float32Array(3*m),y=0,S=new Array(t),b=new Array(t),x=0;x<t;x++){var w=2*Math.PI*(x/t);S[x]=Math.cos(w),b[x]=Math.sin(w)}B.copy(l);for(var P=[],C=[],M=0;M<p;M++){I.set(n[3*M],n[3*M+1],n[3*M+2]),0===M?D.copy(T):D.set(n[3*(M-1)],n[3*(M-1)+1],n[3*(M-1)+2]),M===p-1?R.copy(A):R.set(n[3*(M+1)],n[3*(M+1)+1],n[3*(M+1)+2]),O.subVectors(I,D).normalize(),L.subVectors(R,I).normalize(),G.addVectors(O,L).normalize();var E=B.dot(G);for(N.copy(G).multiplyScalar(E),U.subVectors(B,N),F.crossVectors(G,U),x=0;x<t;x++){V.set(S[x]*U.x+b[x]*F.x,S[x]*U.y+b[x]*F.y,S[x]*U.z+b[x]*F.z).normalize();var k=r*V.x,z=r*V.y,H=r*V.z;0===M&&(P.push(-G.x),P.push(I.x+k),P.push(-G.y),P.push(I.y+z),P.push(-G.z),P.push(I.z+H)),M===p-1&&(C.push(G.x),C.push(I.x+k),C.push(G.y),C.push(I.y+z),C.push(G.z),C.push(I.z+H)),_[y]=k,v[y++]=I.x+k,_[y]=z,v[y++]=I.y+z,_[y]=H,v[y++]=I.z+H}B=U}for(x=0;x<P.length/2;x++)_[y]=P[2*x],v[y++]=P[2*x+1];for(x=0;x<C.length/2;x++)_[y]=C[2*x],v[y++]=C[2*x+1];u.vertexPositionArray=v,u.vertexNormalArray=_;var W=new Uint16Array(f),j=0,X=0,q=0,Z=0,Y=0,K=0;for(M=0;M<p-1;M++)for(x=0;x<t;x++)X=(K=M*t)+x,q=K+(x+1)%t,Z=K+x+t,Y=x===t-1?K+t:(K+x+t+1)%m,W[j++]=X,W[j++]=q,W[j++]=Z,W[j++]=q,W[j++]=Y,W[j++]=Z;for(K=p*t,x=0;x<t-2;x++)W[j++]=K,W[j++]=K+x+2,W[j++]=K+x+1,W[j++]=K+t,W[j++]=K+t+x+1,W[j++]=K+t+x+2;u.vertexIndexArray=W;var $=[];$.push(u);var Q=new e.Mesh($,d);Q.matrixAutoUpdate=!1;var J=function(t,i){for(var r=new e.Vector3(1/0,1/0,1/0),n=new e.Vector3(-1/0,-1/0,-1/0),s=new e.Vector3,a=new e.Vector3,o=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new e.Vector3,u=new e.Vector3,p=null,f=i.length/3-1,g=0;g<f;g++){a.set(i[3*g],i[3*g+1],i[3*g+2]),o.set(i[3*g+3],i[3*g+4],i[3*g+5]),s.subVectors(o,a);var m=s.dot(s);l.set(t*Math.sqrt(1-s.x*s.x/m),t*Math.sqrt(1-s.y*s.y/m),t*Math.sqrt(1-s.z*s.z/m)),h.subVectors(a,l),d.subVectors(o,l),h.min(d),c.addVectors(a,l),u.addVectors(o,l),c.max(u),p=new e.Box3(h,c),r.min(p.min),n.max(p.max)}var v=(new e.Vector3).addVectors(r,n).multiplyScalar(.5),_=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(r,v).multiplyScalar(1.05)),y=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(n,v).multiplyScalar(1.05));return new e.Box3(_,y)}(r,n),ee=new i(Q,"");return ee.forceBoundingBox(J),ee}),createTextNode:function(e){return e.sdf?this.createSDFTextNode.apply(this,arguments):this.createTextNodeZoomable.apply(this,arguments)},createSDFTextNode:function(t){var i,r,n,s,a,o,l,h,c;t.resolutionCoef=256,t.color||(t.color=new e.Color("white")),i="font-family: "+t.font+"; font-size: "+t.resolutionCoef+"px;",a=(n=(r=t.precomputedTextSize||S._determineTextSize(t.text,i,"pre")).width)/(s=r.height),b.textCanvas||(b.textCanvas=document.createElement("canvas")),(o=b.textCanvas).width=n,o.height=s,(l=o.getContext("2d")).fillStyle="#ffffff",l.fillRect(0,0,n,s),l.fillStyle="#000000",l.lineWidth=0,l.strokeStyle="#000000",l.font=t.resolutionCoef+"px "+t.font,l.textAlign="left",l.textBaseline="top",l.fillText(t.text,0,0),l.restore(),h=n/t.resolutionCoef,(c=S.createRectangle(t.fontSize*h,t.fontSize*h/a,!0,void 0,void 0,t.layerNb)).noz=t.layerNb>0;let d=debugWebGLV6Viewer.renderer;var u=null;if(0!==o.width||0!==o.height){b.iterativeCompute||(b.iterativeCompute=new g(d.renderer,d.renderTargetPool)),b.downSampling||(b.downSampling=new m(d.renderer,d.renderTargetPool)),b.mergeTiles||(b.mergeTiles=new v(d.renderer,d.renderTargetPool));b.iterativeCompute.gl,performance.now();for(var p=l.getImageData(0,0,o.width,o.height),f=(new ArrayBuffer(p.data.length),512),_=512,y=Math.floor(o.width/8),x=Math.floor(o.height/8),w=1+Math.ceil((o.width-f)/448),P=1+Math.ceil((o.height-_)/448),C=new Uint8Array(1048576),M=(new Uint8Array(16384),new Uint8Array(4*y*x)),E=null,T=(performance.now(),0);T<P;T++)for(var A=448*T,D=A/8,I=0;I<w;I++){var R=448*I,O=R/8,L=I===w-1?o.width-448*I:f,B=T===P-1?o.height-448*T:_,F=Math.floor(L/8),V=Math.floor(B/8),G=A*o.width+R,N=0;performance.now();for(var U=0;U<_;U++)for(var k=0;k<f;k++)if(k<L&&U<B){var z=G+U*o.width+k;C[N++]=p.data[4*z],C[N++]=p.data[4*z+1],C[N++]=p.data[4*z+2],C[N++]=p.data[4*z+3]}else C[N++]=255,C[N++]=255,C[N++]=255,C[N++]=255;E||(E=new e.DataTexture(C,f,_,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),b.iterativeCompute.setMap(E,50),b.downSampling.setSize(f,_),b.downSampling.setInput(b.iterativeCompute.composers[1]),b.mergeTiles.setSize(y,x),b.mergeTiles.setInput(b.downSampling.composers[2])),E.needsUpdate=!0,performance.now();for(var H=0;H<50;H++)b.iterativeCompute.executeStep(H,49===H);b.downSampling.execute(),b.mergeTiles.setTileInfos(O,D,64,64,F,V),b.mergeTiles.execute()}performance.now(),d.renderer.readPixelCustom(0,0,y,x,e.RGBAFormat,e.UnsignedByteType,M,b.mergeTiles.composers[0],!0,!1),(u=new e.DataTexture(M,y,x,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter)).needsUpdate=!0,u.flipY=!0}c.material=new e.MeshBasicMaterial({force:!0,side:t.side?t.side:e.FrontSide,transparent:!0}),c.material.activatePDSFX("PDSFXSDFTextNode");var W={fontMap:{type:"t2",value:u},_color:{type:"v3",value:new e.Vector3(t.color.r,t.color.g,t.color.b)},ratio:{type:"f",value:x/y}};c.material.setPDSFXUniforms(W);c.material.setPDSFXVaryings({_uv:{type:"v2"}}),c.material.setPDSFXGlobalShaderCode(null,(e=>`\n                    ${e.variableHandler.float("alpha",0,"private")};\n                `));return c.material.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                        ${(t=>e.getVarying(t))("_uv")} = ${e.vGetAttribTexCoord0()}.xy;\n                    `}},{ComputeCommonValues:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions,n=e.pdsfxDefines,s=e=>i.float(e),a=(t=>e.getTextureUniform(t))("fontMap");return`\n                    \n                        ${s("epsilon")}  = 0.003;\n                        ${(e=>i.vec2(e))("uv")} = ${(t=>e.getVarying(t))("_uv")};\n                        ${r.uvConvention("uv")};\n                        ${s("texel")}  = ${r.sample2DTexture(a,"uv")}.r;\n                        ${n.extDerivatives?`\n                            ${s("w")} = clamp(200.0 * epsilon * (abs(${r.dpdx("texel")}) + abs(${r.dpdy("texel")})), 0.0, 0.5);\n                            `:`\n                            ${s("w")} = epsilon;\n                            `}\n\n                        alpha = smoothstep(0.5 - w, 0.5 + w, 1.0 - texel);\n                        alpha = pow(alpha, 1.0/2.2);\n                    `},ComputeDiscard:function(e,t){const i=e.variableHandler;return`\n                        ${(e=>i.float(e))("alphaTest")} = 0.01;\n                        // IR 797819\n                        return (alpha < alphaTest);\n                    `},ComputeAlbedo:function(e,t){e.variableHandler;return`\n                        return ${(t=>e.getUniform(t))("_color")};\n                    `},ComputeOpacity:function(e,t){return"\n                        return alpha;\n                    "}}),this.createMeshNode(c)},createTextNodeZoomable:function(t){var i=t.resolutionCoef||32,r="";t.bold&&(r+="font-weight : bold; "),t.italic&&(r+="font-style: italic;");var n=r+"font-family: '"+t.font+"'; font-size: "+i+"px;",s=t.precomputedTextSize||S._determineTextSize(t.text,n),a=s.width,o=s.height,l=a/o,h=t.side?t.side:e.FrontSide,u=t.textAlign?x[t.textAlign]:"left",p=t.textBaseline?P[t.textBaseline]:"top",f=t.textAlign?w[t.textAlign]:0,g=t.textBaseline?C[t.textBaseline]:0,m=t.zoom||1,v=a/i,_=t.fontSize*v*m,y=t.fontSize*v/l*m,b=!!t.stroke&&t.stroke,M=a,E=o;if(t._fix&&(!M||!E||!isFinite(E)||!isFinite(M)))return null;var T=new c({width:M,height:E,drawCB:function(e,r,n){var s=f*M,a=g*E;try{r.globalAlpha=void 0!==t.opacity?t.opacity:1,r.fillStyle="#"+t.color.getHexString(),r.lineWidth=0,r.strokeStyle="#"+t.color.getHexString();var o=(t.bold?"bold ":"")+(t.italic?"italic ":"");if(r.font=o+i+"px '"+t.font+"',Arra",r.textAlign=u,r.textBaseline=p,b?r.strokeText(t.text,s,a):r.fillText(t.text,s,a),t._debug&&(r.strokeStyle="red",r.moveTo(0,a),r.lineTo(M,a),r.stroke(),r.moveTo(0,0),r.moveTo(s,0),r.lineTo(s,E),r.stroke(),r.moveTo(0,0)),window.WUXDisableTextNodes)return void r.clearRect(0,0,M,E)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,depthWrite:t.depthWrite}),A=t.hotspot||{x:0,y:0};return t.bbox?new d({name:t.name,bottomLeftcorner:new e.Vector3(t.bbox[0],t.bbox[2],0),widthVector:new e.Vector3(t.bbox[1]-t.bbox[0],0,0),heightVector:new e.Vector3(0,t.bbox[3]-t.bbox[2],0),canvasNodeTexture:T,side:h},k):new d({name:t.name,bottomLeftcorner:new e.Vector3(-A.x*_,-A.y*y,0),widthVector:new e.Vector3(_,0,0),heightVector:new e.Vector3(0,y,0),canvasNodeTexture:T,side:h},k)},_createTextTexture:function({text:e,fontFamily:t,fill:i=!0,bold:r=!1,italic:n=!1,textAlign:s="left",textBaseline:a="top",color:o,opacity:l=1,resolutionCoef:h=32,precomputedTextSize:c}){const d=`${r?"font-weight : bold;":""} ${n?"font-style: italic;":""} font-family: '${t}'; font-size: ${h}px;`,u=c||S._determineTextSize(e,d),p=u.width,f=u.height;if(!(p&&f&&isFinite(f)&&isFinite(p)))return null;const g="#"+o.getHexString(),m=M[s],v=E[a];if(void 0===m)throw new Error(`Unknown text alignment: ${s}`);if(void 0===v)throw new Error(`Unknown text baseline: ${a}`);const _=m*p,b=v*f;return y.Utils.loadFromCanvas({width:p,height:f,draw:function(o){o.globalAlpha=l,o.lineWidth=0,o.fillStyle=g,o.strokeStyle=g,o.font=`${r?"bold":""} ${n?"italic":""} ${h}px '${t}',Arra`,o.textAlign=s,o.textBaseline=a,i?o.fillText(e,_,b):o.strokeText(e,_,b),window.WUXDisableTextNodes&&o.clearRect(0,0,p,f)}})},createCanvasNode:function(e){return new d(e,k)},createCanvas2DNode:function(e){return new p(e,k)},createCanvas2DInstancingNode:function(e){return new f(e,k)},createNodeFromTHREEMesh:function(e){var t=S.convertFromTHREEMesh(e);return this.createMeshNode(t)},createFixedSizeNode:function(e){return new u({name:(e=e||{}).name,ratio:e.ratio||1})}};return k})),define("Visualization/SceneGraphFactory",["DS/Visualization/SceneGraphFactory","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/SceneGraphFactory"),e})),define("DS/Visualization/PolygonTessellator",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","libtess/libtess.min"],(function(e,t,i,r,n){"use strict";var s=0,a=e.extend({init:function(){this.polygons=[],this.polygonGroupEnd=[],this.currentPolygon=this._createEmptyPolygon()},addPointToCurrentPolygonLoop:function(e,t,i){var r;0===this.currentPolygon.points.length&&(this.currentPolygon.userData=i),this.currentPolygon.points.length>0&&(r=this.currentPolygon.points.length-2,this.currentPolygon.points[r]===e&&this.currentPolygon.points[r+1]===t)||(this.currentPolygon.points.push(e),this.currentPolygon.points.push(t))},closeCurrentPolygonLoop:function(){this.currentPolygon.points.length>2&&(this.currentPolygon.closed=!0,this.polygons.push(this.currentPolygon)),this.currentPolygon=this._createEmptyPolygon()},endCurrentPolygon:function(){this._startNewPolygon(),this.polygonGroupEnd.push(this.polygons.length)},createNode3D:function(e,n){var s,a,o,h,c,d,u,p,f=new i,g=[],m=this.polygonGroupEnd.length;for(u=0;u<m;u++){for(p=!0,h=[],s=0===u?0:this.polygonGroupEnd[u-1];s<this.polygonGroupEnd[u]&&p;s++)if(this.polygons[s].closed){for(c=[],a=this.polygons[s].points,o=0;o<a.length;o+=2)c.push(a[o],-a[o+1]);c.push(a[0],-a[1]),h.push(c)}else p=!1;if(h.length&&p)d=l(h,n),g=g.concat(d);else if(h.length)throw new Error("fill open polygon")}if(0===g.length)return null;for(var v=new Uint32Array(g.length/3),_=0;_<v.length;++_)v[_]=_;var y=[];for(_=0;_<g.length;_+=3)y.push(0,0,1);var S=t.createSimpleMeshNode({bufferPosition:g,bufferIndex:v,glType:r.ConnectivityTypeEnum.TRIANGLES,material:e,bufferNormal:y});return f.addChild(S),f},_startNewPolygon:function(){this.currentPolygon.points.length>2&&this.polygons.push(this.currentPolygon),this.currentPolygon=this._createEmptyPolygon()},_createEmptyPolygon:function(){return{points:[],closed:!1,userData:null,id:s++}}}),o=function(){var e=new n.GluTesselator;return e.gluTessCallback(n.gluEnum.GLU_TESS_VERTEX_DATA,(function(e,t){t[t.length]=e[0],t[t.length]=e[1],t[t.length]=e[2]})),e.gluTessCallback(n.gluEnum.GLU_TESS_BEGIN,(function(e){e!==n.primitiveType.GL_TRIANGLES&&console.log("expected TRIANGLES but got type: "+e)})),e.gluTessCallback(n.gluEnum.GLU_TESS_ERROR,(function(e){console.log("error callback"),console.log("error number: "+e)})),e.gluTessCallback(n.gluEnum.GLU_TESS_COMBINE,(function(e,t,i){return[e[0],e[1],e[2]]})),e.gluTessCallback(n.gluEnum.GLU_TESS_EDGE_FLAG,(function(e){})),e}();function l(e,t){o.gluTessNormal(0,0,1);var i=[];o.gluTessBeginPolygon(i);for(var r=0;r<e.length;r++){o.gluTessBeginContour();for(var n=e[r],s=0;s<n.length;s+=2){var a=[n[s],n[s+1],t];o.gluTessVertex(a,a)}o.gluTessEndContour()}return o.gluTessEndPolygon(),i}return a})),define("DS/Visualization/Selection",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Visualization/PathElement","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/BufferGPUManager"],(function(e,t,i,r,n,s,a,o,l,h,c){"use strict";const d=i._VisuFilterType;function u(e,t,i){if(t(e,i),"bag"===e.getType())for(var r=e.getChildren(),n=0;n<r.length;n++)u(r[n],t,i)}function p(e){for(var t=0;t<e.externalPath.length;t++){var i=e.externalPath[t];if(i instanceof THREEDS.Nodes.CGRNode&&"3DSyncBatch"===i.productType)return i}return null}function f(e,t,i){var a=[],l=[];if(e.sgNode instanceof r.SGPrimitiveHelper){(p=i.children[1]instanceof s?i.children[1]:i.children[0]).mesh3js&&l.push({mesh:p.mesh3js,element:e})}else{var h=function(e){var t=new Map;return u(e,(function(e,t){if("rep"===e.getType()){var i=e.getIdentificationObject?e.getIdentificationObject():null,r=i?i.getLocalId():0;r&&t.set(r,e)}}),t),t}(e),c=t.getLastElement(!0),d=i.children[1]instanceof n?i.children[1]:i.children[0],p=i.children[1]instanceof s?i.children[1]:i.children[0],f=d.children,g=function(e,t){return e.traverse((function(e,t){return e===t.parent}),{parent:t},!0)}(c,d);g&&(f=[c]);for(var m=0;m<f.length;m++){var v=f[m],_=v.persistentId;if(_)if(h.get(_)){var y=new o;y.externalPath=t.externalPath.slice(),g||(y.addElement(d),y.addElement(v));for(var S=y._getRenderableOccurrences(),b=0;b<S.length;b++){var x=S[b];a.push(x)}h.delete(_)}}if(h.size>0){var w=new o;w.externalPath=t.externalPath.slice(),w.addElement(p);var P=w._getRenderableOccurrences();if(1===P.length){var C=h[Symbol.iterator]();for(var M of C)l.push({mesh:P[0],element:M[1]})}}}return{meshes:a,sgNodes:l}}const g={_findHLIndexOrAdd:function(e,t){var i,r=-1,n=e.highLight;n.map.has(t.container)?(i=n.map.get(t.container)).has(t.index)?r=i.get(t.index):i.set(t.index,n.primitives.length):((i=new Map).set(t.index,n.primitives.length),n.map.set(t.container,i));return r},_removeHLIndex:function(e,t){var i=e.highLight;if(i.map.has(t.container)){var r=i.map.get(t.container);r.has(t.index)&&(r.delete(t.index),0===r.size&&i.map.delete(t.container))}},_findHLIndex:function(e,t){var i=-1,r=e.highLight;if(r.map.has(t.container)){var n=r.map.get(t.container);n.has(t.index)&&(i=n.get(t.index))}return i},addHighLightPrimitive:function(e,t){if(e.highLight){var i=e.highLight,r=this._findHLIndexOrAdd(e,t);if(-1===r){var n=t.clone();i.primitives.push(n),i.nbSelected.push(1),null===e.layer&&e.initLayers(),e.layer.addPrimitivesToLayers([n],1)}else i.nbSelected[r]++}},addHighLightRep:function(e,t){if(e.highLight){for(var i=e.highLight,n=[],s=new r.SGPrimitiveHelper,a=0;a<t.getPrimitivesCount();a++){s.set(t,a);var o=this._findHLIndexOrAdd(e,s);if(-1===o){var l=s.clone();i.primitives.push(l),i.nbSelected.push(1),n.push(l)}else i.nbSelected[o]++}null===e.layer&&e.initLayers(),e.layer.addPrimitivesToLayers(n,1)}},removeHighLightPrimitive:function(e,t){if(e.highLight){var i=this._findHLIndex(e,t);if(-1!==i&&null!==e.layer){var r=e.highLight;r.nbSelected[i]--,r.nbSelected[i]||(this._removeHLIndex(e,t),r.primitives.splice(i,1),r.nbSelected.splice(i,1),e.layer.addPrimitivesToLayers([t.clone()],0))}}},removeHighLightRep:function(e,t){if(e.highLight){for(var n=[],s=e.highLight,a=new r.SGPrimitiveHelper,o=new Set,l=0;l<t.getPrimitivesCount();l++){a.set(t,l);var h=this._findHLIndex(e,a);-1!==h&&(s.nbSelected[h]--,s.nbSelected[h]||(this._removeHLIndex(e,a),o.add(h),n.push(a.clone())))}if(o.size>0){var c=new Array(s.primitives.length-o.size),d=new Array(s.nbSelected.length-o.size),u=0;for(l=0;l<s.primitives.length;l++)o.has(l)||(c[u]=s.primitives[l],d[u++]=s.nbSelected[l]);s.primitives=c,s.nbSelected=d}null===e.layer&&(e.layer=new i.BufferLayer(e)),e.layer.addPrimitivesToLayers(n,0)}},removeHighLight:function(e){e.highLight&&(e.layer=null,e.highLight.map.clear(),e.highLight.primitives=[],e.highLight.nbSelected=[])}};var m=0;return e.extend({init:function(e,t){this.id=m++,this.viewer=e,this.eventType=t,this.scene=e.internalSceneGraph.scene,this._defaultScene=this.scene,this._sceneHLMap=new Map,this.sceneHL=new i.Scene,this._sceneHLMap.set(this.scene,this.sceneHL),this.selectedMeshes=new Map,this.selectedMeshesFromPrim=new Map,this.selectedMeshesFromAdjacence=new Map,this.doubleSideHighlight=!0,this.matHL=null,this.node3DMap=new Map;var r={HSO:l,PSO:h};return this._xsoManager=r[this.eventType],this.toUnsubscribe=[],this._attachEvents(),this},_attachEvents:function(){this._detachEvents(!1,!1);var e=this,i=this._xsoManager;this.onSceneGraphUpdate=t.subscribe({event:"/VISU/onSceneGraphUpdate"},(function(t){if(e.node3DMap.has(t.fromNode)){if("ADD"==t.eventType){var i=e.node3DMap.get(t.fromNode);e.addNodeToMap(t.toNode,e.node3DMap,i);for(var r=0;r<i.length;r++){var n=i[r].getLastElement(),s=t.toNode,a=[];e._getPaths(n,s,[],a);for(var l=0;l<a.length;l++){var h=new o(i[r].externalPath.slice());h.externalPath=h.externalPath.concat(a[l]),e._add(t.toNode,h)}}}"REMOVE"==t.eventType&&e.removeNodeToMap(t.toNode,e.node3DMap)}})),this.toUnsubscribe.push(i.onPostAdd((function(t){if(!("PSO"==e.eventType&&e.viewer&&e.viewer.pPicking&&e.viewer.pPicking.preferenceHideHL)&&null!==t){var i=t.pathElement,r=!!t.forceVisibility;!i&&t.options&&(i=t.options.pathElement,r=!!t.options.forceVisibility),i&&(e.add(i,t.parameters,r),e.viewer&&e.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach((function(t){e.add(t.pathElement,t.parameters,!!t.forceVisibility)})),e.viewer&&e.viewer.render({onlyPostProcess:!0}))}}))),this.toUnsubscribe.push(i.onPostRemove((function(t){if(null!==t){var i=t.pathElement;!i&&t.options&&(i=t.options.pathElement),i&&(e.remove(i,t.parameters),e.viewer&&e.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach((function(t){e.remove(t.pathElement,t.parameters)})),e.viewer&&e.viewer.render({onlyPostProcess:!0}))}}))),this.toUnsubscribe.push(i.onEmpty((function(){e.viewer&&e.viewer.render({onlyPostProcess:!0})})))},_detachEvents:function(e,i){var r;for(r=0;r<this.toUnsubscribe.length;r++)this._xsoManager.unsubscribe(this.toUnsubscribe[r]);this.toUnsubscribe=[],e||(t.unsubscribe(this.onSceneGraphUpdate),this.onSceneGraphUpdate=null)},_updateScene:function(e){(e=e||this._defaultScene)!==this.scene&&(this.scene=e,this._sceneHLMap.has(e)||this._sceneHLMap.set(e,new i.Scene),this.sceneHL=this._sceneHLMap.get(e))},setDoubleSideHighlight:function(e){this.doubleSideHighlight=e},_getPaths:function(e,t,i,r){var n,s;if(t!=e){i.unshift(t);var a=t.parents;for(s=a.length,n=0;n<s;n++)this._getPaths(e,a[n],i,r);i.shift(t)}else r.push(i.slice(0))},addNodeToMap:function(e,t,i){e.traverse((function(e){var r;if(e instanceof n)if((r=t.get(e))&&r.length){var s,a,o,l,h=r.concat([]);for(s=0;s<i.length;s++){for(o=i[s],l=!0,h.indexOf(o)>=0&&(l=!1),a=0;a<h.length&&l;a++)h[a].hash()===o.hash()&&(l=!1);l&&h.push(o)}t.set(e,h)}else t.set(e,i)}))},removeNodeToMap:function(e,t){e.traverse((function(e){e instanceof n&&t.delete(e)}))},__useParentPath:(e,t,i)=>i.getPickParent()||e&&i._getPickParentWithPrimitives()&&0===t.internalPath.length,add:function(e,t,r){var s;if(null!=e){const t=i._AllowPickParentWithPrimitives;for(var a=null,o=e&&e.getLastElement(!0),l=e&&e._getUniqueOccurrence&&e._getUniqueOccurrence(this.viewer),h=l&&l._getFilter(d._LOD_BRANCH)&&!l._getFilter(d.LOD);o&&o instanceof n&&(this.__useParentPath(t,e,o)||h);)a=e,o=(e=e.getParentPath())&&e.getLastElement(!0),h=(l=e&&e._getUniqueOccurrence&&e._getUniqueOccurrence(this.viewer))&&l._getFilter(d._LOD_BRANCH)&&!l._getFilter(d.LOD);if(e||(e=a),null===(s=e.getLastElement()))return!1;s instanceof n&&this.addNodeToMap(s,this.node3DMap,[e]),this._add(s,e,r)}return!0},_add:function(e,t,i){var s=null;if(THREEDS.Nodes.CGRNode&&(s=p(t))&&e instanceof THREEDS.Nodes.CGRNode){var o=a.getFromSGNode(e.internalSceneGraph);t.internalPath.push(o),e=o}var l=t._getRenderableOccurrences(this.viewer),h=l.length;if(e instanceof n){if(h)for(var c=0;c<h;c++){var d=l[c];void 0!==t.instanceId&&d._instancingInfos?d._instancingInfos.pickedInstanceId=[t.instanceId]:void 0===t.instanceId&&d._instancingInfos&&(d._instancingInfos.pickedInstanceId=[]),this.addMesh(d,i)}}else if(s&&(e.sgNode instanceof r.SGRep||e.sgNode instanceof r.SGBag||h>1&&e.sgNode instanceof r.SGPrimitiveHelper)){var u=f(e,t,s);for(c=0;c<u.meshes.length;c++)this.addMesh(u.meshes[c],i);for(c=0;c<u.sgNodes.length;c++)this.addPrimitive(u.sgNodes[c].mesh,u.sgNodes[c].element,i,!1)}else{if(1!==h)return!1;this.addPrimitive(l[0],e,i,!1)}},remove:function(e){var t;if(e){const S=i._AllowPickParentWithPrimitives;for(var s=null,o=e&&e.getLastElement(!0),l=e&&e._getUniqueOccurrence&&e._getUniqueOccurrence(this.viewer),h=l&&l._getFilter(d._LOD_BRANCH)&&!l._getFilter(d.LOD);o&&o instanceof n&&(this.__useParentPath(S,e,o)||h);)s=e,o=(e=e.getParentPath())&&e.getLastElement(!0),h=(l=e&&e._getUniqueOccurrence&&e._getUniqueOccurrence(this.viewer))&&l._getFilter(d._LOD_BRANCH)&&!l._getFilter(d.LOD);if(e||(e=s),null===(t=e.getLastElement()))return;var c=null;if(THREEDS.Nodes.CGRNode&&(c=p(e))&&t instanceof THREEDS.Nodes.CGRNode){var u=a.getFromSGNode(t.internalSceneGraph);e.internalPath.push(u),t=u}var g=e._getRenderableOccurrences(this.viewer),m=g.length;if(t instanceof n){if(this.node3DMap.has(t)&&this.removeNodeToMap(t,this.node3DMap),m)for(var v=0;v<m;v++){var _=g[v];void 0!==e.instanceId&&_._instancingInfos&&(_._instancingInfos.pickedInstanceId=[e.instanceId]),this.removeMesh(_)}}else if(c&&(t.sgNode instanceof r.SGRep||t.sgNode instanceof r.SGBag||m>1&&t.sgNode instanceof r.SGPrimitiveHelper)){var y=f(t,e,c);for(v=0;v<y.meshes.length;v++)this.removeMesh(y.meshes[v]);for(v=0;v<y.sgNodes.length;v++)this.removePrimitive(y.sgNodes[v].mesh,y.sgNodes[v].element,!1)}else{if(1!==m)return!1;this.removePrimitive(g[0],t,!1)}}},addPrimitive:function(e,t,i,r){var n=null,s=r?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(this._updateScene(e&&e.getScene()),!this.scene.containsMesh(e))return null;if(s.has(e)){var a=s.get(e);a.nbSelections++,a.hlMeshPrimScene||(a.hlMeshPrimScene=this.duplicateMeshForHighlight(e,!0,i,s===this.selectedMeshesFromPrim,s===this.selectedMeshesFromAdjacence),this.sceneHL.add(a.hlMeshPrimScene)),n=a.hlMeshPrimScene}else n=this.duplicateMeshForHighlight(e,!0,i,s===this.selectedMeshesFromPrim,s===this.selectedMeshesFromAdjacence),s.set(e,{hlMeshScene:null,hlMeshPrimScene:n,nbSelections:1}),this.sceneHL.add(n),e.addRefVBO(!1);if("rep"===t.getType()||"selectionGroup"===t.getType()){for(var o=!1,l=[],h=t.getChildren(),c=0;c<h.length;c++){var d=h[c];-1===g._findHLIndex(n,d.sgNode)?l.push(d):o=!0}if(o||"selectionGroup"===t.getType())for(c=0;c<l.length;c++)g.addHighLightPrimitive(n,l[c].sgNode);else g.addHighLightRep(n,t.sgNode)}else if("bag"===t.getType()){u(t,(function(e,t){if("rep"===e.getType())for(var i=e.getChildren(),r=0;r<i.length;r++){var s=i[r];-1===g._findHLIndex(n,s.sgNode)&&t.push(s)}}),h=[]);for(c=0;c<h.length;c++)g.addHighLightPrimitive(n,h[c].sgNode)}else if("primitive"===t.getType()){-1===g._findHLIndex(n,t.sgNode)&&g.addHighLightPrimitive(n,t.sgNode)}return n},addMesh:function(e,t){var i=null,r=e._occurrence,n=r&&r.isInCanvas2DPass()?["canvas2D"]:null;if(this._updateScene(e&&e.getScene()),!this.scene.containsMesh(e))return null;if(this.selectedMeshes.has(e)){var s=this.selectedMeshes.get(e);s.nbSelections++,s.hlMeshScene||(s.hlMeshScene=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.sceneHL.add(s.hlMeshScene,n)),i=s.hlMeshScene}else i=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.selectedMeshes.set(e,{hlMeshScene:i,hlMeshPrimScene:null,nbSelections:1}),this.sceneHL.add(i,n),e.addRefVBO(!1);if(i._instancingInfos&&"instance"===i._instancingInfos.instancingSelectionMode&&e._instancingInfos.pickedInstanceId.length){for(var a=!1,o=e._instancingInfos.pickedInstanceId[0],l=i._instancingInfos.pickedInstanceId,h=0;h<l.length;h++)if(l[h]==o){a=!0;break}a||(i._instancingInfos.pickedInstanceId.push(o),i._instancingInfos.nbInstances++,i._instancingInfos.drawCount++,this.updateInstancedHighLightMesh(i,e))}return i},removeMesh:function(e){var t=null;if(e&&this.selectedMeshes.has(e)){var i=this.selectedMeshes.get(e);if(!(t=i.hlMeshScene))return null;if(i.nbSelections--,i.nbSelections){if(t._instancingInfos&&e._instancingInfos.pickedInstanceId.length){for(var r=-1,n=e._instancingInfos.pickedInstanceId[0],s=t._instancingInfos.pickedInstanceId,a=0;a<s.length;a++)if(s[a]==n){r=a;break}-1!=r&&(t._instancingInfos.pickedInstanceId.splice(r,1),t._instancingInfos.nbInstances--,t._instancingInfos.drawCount--,this.updateInstancedHighLightMesh(t,e))}}else{i.hlMeshScene=null;var o=t.getScene();o&&o.remove(t),this.cleanHLMesh(t),i.hlMeshPrimScene||(this.selectedMeshes.delete(e),e.releaseVBO(!1),t=null)}}return t},getHighlightMeshIndex:function(e){var t;if(e.highlightMeshes)for(t=0;t<e.highlightMeshes.length;t++)if(e.highlightMeshes[t].selectionId===this.id)return t;return-1},setHighlightMesh:function(e,t){if("highlight"===this.attr){!e.highlightMeshes&&t&&(e.highlightMeshes=[]);var i=this.getHighlightMeshIndex(e),r=i>=0?e.highlightMeshes[i]:null;r?t?r.renderable=t:e.highlightMeshes.length>1?e.highlightMeshes.splice(i,1):e.highlightMeshes=null:t&&e.highlightMeshes.push(new HighlightMeshData(this.id,t))}else e[this.attr]=t},removeMeshAndPrimitives:function(e){if(e){var t=this,i=function(i){if(i.has(e)){var r,n=i.get(e),s=n.hlMeshScene,a=n.hlMeshPrimScene;if(s)(r=s.getScene())&&r.remove(s),t.cleanHLMesh(s);if(a)(r=a.getScene())&&r.remove(a),t.cleanHLMesh(a);i.delete(e),e.releaseVBO(!1)}};i(this.selectedMeshesFromPrim),i(this.selectedMeshesFromAdjacence),i(this.selectedMeshes)}},removePrimitive:function(e,t,i){var r=null;if(e){var n=i?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(n.has(e)){var s=n.get(e);if(!(r=s.hlMeshPrimScene))return null;if(s.nbSelections--,"rep"===t.getType())g.removeHighLightRep(r,t.sgNode);else if("selectionGroup"===t.getType())for(var a=t.getChildren(),o=0;o<a.length;o++)g.removeHighLightPrimitive(r,a[o].sgNode);else"primitive"===t.getType()&&g.removeHighLightPrimitive(r,t.sgNode);if(r.isMeshHiddenByLayer()){s.hlMeshPrimScene=null;var l=r.getScene();l&&l.remove(r),this.cleanHLMesh(r)}s.nbSelections||s.hlMeshPrimScene||(n.delete(e),e.releaseVBO(!1),r=null)}}return r},updateHighlight:function(e){},_needsDepth:function(){return!1},duplicateMeshForHighlight:function(e,t,r,n,s){var a=i.Mesh.DuplicateMesh(e,{ignoreVisibility:t});return a.highLight={map:new Map,primitives:[],nbSelected:[]},a.occurrenceRenderingOverride=e.occurrenceRenderingOverride,a._occurrence=e._occurrence,a.matrixAutoUpdate=!1,a.visible=r||e.visible,a.visibilityFree=r||e.visibilityFree,a.castShadow=!1,a.receiveShadow=!1,a._bindingGroups=e._bindingGroups,a.selectionParentMesh=e,n&&(a._programID|=i.ProgramIDs.PRIMITIVE_HIGHLIGHT),a},cleanHLMesh:function(e){if(e._instancingInfos){let i=[];var t=e._instancingInfos.instanceAttribArrays;for(let r in t)e._instancingInfos.instanceAttribArrays[r].buffer&&(i.push(e._instancingInfos.instanceAttribArrays[r].buffer),e._instancingInfos.instanceAttribArrays[r].buffer=null);c.deallocate(i)}},updateInstancedHighLightMesh:function(e,t){var i,r,n=t._instancingInfos.instanceAttribArrays;for(var s in this.cleanHLMesh(e),e._instancingInfos.instanceAttribArrays={},e._instancingInfos.instanceAttribArrays_id=t._instancingInfos.instanceAttribArrays_id,n){let l=n[s].itemSize;e._instancingInfos.instanceAttribArrays[s]={itemSize:l,type:n[s].type};let h=n[s].isMat4?16:l;16===h&&(e._instancingInfos.instanceAttribArrays[s].isMat4=!0);let c=new Float32Array(e._instancingInfos.nbInstances*h),d=0;for(var a=0;a<e._instancingInfos.nbInstances;a++){const l=e._instancingInfos.pickedInstanceId[a]/5-1;if(!(l>=t._instancingInfos.drawCount)){r=(i=l*h)+h;for(var o=i;o<r;o++)c[d++]=n[s].array[o]}}e._instancingInfos.instanceAttribArrays[s].array=c,e._instancingInfos.instanceAttribArrays[s].buffer=null}},clearAll:function(e){var t,i=this;e?(t=function(t){var r=[];t.forEach((function(t,n,s){var a=t.hlMeshScene,o=t.hlMeshPrimScene;if(n.getScene()===e){var l;if(a)(l=a.getScene())&&l.remove(a),i.cleanHLMesh(a);if(o)(l=o.getScene())&&l.remove(o),i.cleanHLMesh(o);n.releaseVBO(!1),r.push(n)}}));for(var n=0;n<r.length;n++)t.delete(r),r._occurrence&&r._occurrence.node&&i.removeNodeToMap(r._occurrence.node)},this._sceneHLMap.delete(e)):(t=function(e){e.forEach((function(e,t,r){var n,s=e.hlMeshScene,a=e.hlMeshPrimScene;s&&((n=s.getScene())&&n.remove(s),i.cleanHLMesh(s));a&&((n=a.getScene())&&n.remove(a),i.cleanHLMesh(a));t.releaseVBO(!1)})),e.clear()},this.node3DMap.clear(),this._sceneHLMap.clear()),t(this.selectedMeshes),t(this.selectedMeshesFromPrim),t(this.selectedMeshesFromAdjacence)}})})),define("Visualization/Selection",["DS/Visualization/Selection","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/Selection"),e})),define("DS/Visualization/AbstractHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection"],(function(e,t,i,r){"use strict";return r.extend({init:function(e,i){return this._parent(e,i),this.attr="",this.nodeMethod="",this.defaultSetting=null,this.highlightData=new t.HaloHighlightData,this.advanced=this.highlightData instanceof t.AdvancedPoliteHighlightData,this.sceneHL.highlightData=this.highlightData,this.onSelectionRemove=null,this.enabled=!0,this},getHighlightData:function(){this.advanced;var e=null;Object.assign(e,this.highlightData)},_updateScene:function(e){this._parent(e),this.sceneHL.highlightData!==this.highlightData&&(this.sceneHL.highlightData=this.highlightData)},_detachEvents:function(t,i){i||(e.unsubscribe(this.onSelectionRemove),this.onSelectionRemove=null),this._parent(t,i)},enable:function(e){this.enabled=e},addMesh:function(e,i){if(e instanceof t.CSS2DNode)return e.element.classList.add("wux-css2dnode-highlighted"),null;if(!e||!e._occurrence)return null;var r=e._occurrence.node;if(r&&r[this.nodeMethod]())return null;var n=this._parent(e,i);return n&&this.setHighlightMesh(e,n),n},removeMesh:function(e){if(e instanceof t.CSS2DNode)return e.element.classList.remove("wux-css2dnode-highlighted"),null;var i=this._parent(e);this.setHighlightMesh(e,i)},addPrimitive:function(e,t,i){if(!e||!e._occurrence)return null;var r=e._occurrence.node;if(r&&r[this.nodeMethod]())return null;var n=this._parent(e,t,i);return n&&this.setHighlightMesh(e,n),n},removePrimitive:function(e,t){var i=this._parent(e,t);this.setHighlightMesh(e,i)},getColorHighlight:function(){return console.warn("Warning: deprecated, use getHighlightData instead"),this.highlightData},getHighlightData:function(){return this.highlightData},isEqualColor:function(e){return!!e&&this.highlightData.isEqual(e)},setColorHighlight:function(e){console.warn("Warning: deprecated, use setHighlightData instead"),this.setHighlightData(this.advanced,e)},setHighlightData:function(e,i){var r=0===this.highlightData.priority;e!==this.advanced&&(this.advanced=e,this.highlightData=e?new t.AdvancedPoliteHighlightData(this.defaultSetting.advancedpolite):new t.HaloHighlightData(this.defaultSetting.halo),this._updateScene(this.scene)),i?this.highlightData._setData(i):this.highlightData._setData(this.advanced?this.defaultSetting.advancedpolite:this.defaultSetting.halo),r&&(this.highlightData.priority=0)},_needsDepth:function(){return this.advanced}})})),define("Visualization/AbstractHighlightSelection",["DS/Visualization/AbstractHighlightSelection","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/AbstractHighlightSelection"),e})),define("DS/Visualization/HighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],(function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"HSO"),this.attr="highlight",this.nodeMethod="_getExcludeFromHL",this.defaultSetting=t.DefaultHighlightData,this.isMultiColorSet=!1,this.linkToHSO=!0,this.passes=[],this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},(function(e){t.removeMeshAndPrimitives(e),t.setHighlightMesh(e,null)})),this.onCSIAddHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_ADD"},(function(e){t.add(e.path,e.parameters)})),this.onCSIRemoveHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_REMOVE"},(function(e){t.remove(e.path,e.parameters)})),this.onCSIHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE"},(function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)}))},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddHighlight),this.onCSIAddHighlight=null,e.unsubscribe(this.onCSIRemoveHighlight),this.onCSIRemoveHighlight=null,e.unsubscribe(this.onCSIHighlightUpdate),this.onCSIHighlightUpdate=null),this._parent(t,i)},__matches:function(e){var t=this.viewer;if(this.isMultiColorSet){if(e&&e.highlightColor&&this.highlightData.isEqual(e.highlightColor))return!e.viewer||e.viewer===t}else if(e&&!e.highlightColor||!e)return!e||!e.viewer||e.viewer===t;return!1},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},detachToHSO:function(){this.linkToHSO&&(this.linkToHSO=!1,this._detachEvents(!0,!0))},attachToHSO:function(){this.linkToHSO||(this.linkToHSO=!0,this._attachEvents())},setMultiColorMode:function(e){this.isMultiColorSet=e}})})),define("Visualization/HighlightSelection",["DS/Visualization/HighlightSelection","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/HighlightSelection"),e})),define("DS/Visualization/PreHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],(function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"PSO"),this.attr="preHighlight",this.linkToPSO=!0,this.nodeMethod="_getExcludeFromPreHL",this.defaultSetting=t.DefaultPreHighlightData,this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},(function(e){t.removeMeshAndPrimitives(e),e.preHighlight=null})),this.onCSIAddPreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_ADD"},(function(e){t.add(e.path,e.parameters)})),this.onCSIRemovePreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_REMOVE"},(function(e){t.remove(e.path,e.parameters)})),this.onCSIPreHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE"},(function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)}))},__matches:function(e){var t=this.viewer;return!e||!e.viewer||e.viewer===t},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddPreHighlight),this.onCSIAddPreHighlight=null,e.unsubscribe(this.onCSIRemovePreHighlight),this.onCSIRemovePreHighlight=null,e.unsubscribe(this.onCSIPreHighlightUpdate),this.onCSIPreHighlightUpdate=null),this._parent(t,i)},detachToPSO:function(){this.linkToPSO&&(this.linkToPSO=!1,this._detachEvents(!0,!0))},attachToPSO:function(){this.linkToPSO||(this.linkToPSO=!0,this._attachEvents())}})})),define("Visualization/PreHighlightSelection",["DS/Visualization/PreHighlightSelection","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/PreHighlightSelection"),e})),define("DS/Visualization/InternalSceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Object3D/Root3D","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents"],(function(e,t,r,n,s,a,o,l,h,c,d,u){"use strict";var p,f,g,m=t.__visibleInCurrentSpace,v=e.extend({init:function(e,t,i,r){return this.parentSceneGraph=null,this.bShowReferenceAxisSystem=!0,this.lockShowReferenceAxisSystem=i,this.viewer=e,this.drivesTheRobot=!1,this.viewpointAdded=!1,this.userRoot=new n,this.userRoot.setLinkedToSceneGraph(!0),(t||window.userRootOutOfPathElements)&&this.userRoot.setNotAllowedInPathElement(!0),this.viewer._svgMode&&(this.svgRoot=new n,this.svgRoot._isSVGRoot=!0,this.svgRoot._setIsAlwaysInForeground(!0)),this.robotRoot=new n,this.robotRoot.exludeFromBounding(!0),this.robotRoot._setVisibilityFree(!0),this.robotRoot._setIsAlwaysInForeground(!0),r&&e._safeInternalSceneGraph?this.lightRoot=e._safeInternalSceneGraph.lightRoot:(this.lightRoot=new n,this.lightRoot.exludeFromBounding(!0),this.lightRoot._setVisibilityFree(!0)),this._robot=null,this._customReferenceAxisSystem=null,this._sceneInstances=[],this.addSceneInstance(!0),this.modelEvents=new u,this._needClippingUpdate=!1,this.selectionHL=e.__selectionHL,this.selectionPreHL=e.__selectionPreHL,this._subscribedEvents=[],this._onViewpointChangedEvent=null,this.excludedFromBoundingNodes=new Map,this._savedSceneMin=null,this},addSceneInstance:function(e){let s=null;for(let e=0;e<this._sceneInstances.length;e++)if(null==this._sceneInstances[e])s=e;else if(!this._sceneInstances[e].used)return this._sceneInstances[e].used=!0,e;let a=new n("",!0);a.setLinkedToSceneGraph(!0),a.setNotAllowedInPathElement(!0);var o=this;a.subscribe("onready",(function(){o.modelEvents.publish("onready")})),a.addChild(this.userRoot),a.addChild(this.lightRoot),e&&a.addChild(this.robotRoot),this.svgRoot&&a.addChild(this.svgRoot);let l=new t.Scene;this._sceneInstances.length&&(l.__lights=this._sceneInstances[0].scene.__lights),l.matrixWorldNeedsUpdate=!1;let h=new r;return h.setViewer(this.viewer),h.setInternalSceneGraph(this),l.add(h),a.setScene(h),h.setNode(this.root),null!=s?this._sceneInstances[i]={used:!0,root:a,scene:l,root3js:h}:(this._sceneInstances.push({used:!0,root:a,scene:l,root3js:h}),s=this._sceneInstances.length-1),1==this._sceneInstances.length&&(this._sceneInstances[0].used=!1,this.selectSceneInstance(0)),s},freeSceneInstance:function(e){if(0==e)this._sceneInstances[e].used=!1;else if(null!=this._sceneInstances[e])for(this._sceneInstances[e].root.removeChild(this.userRoot),this._sceneInstances[e].root.removeChild(this.robotRoot),this.svgRoot&&this._sceneInstances[e].root.removeChild(this.svgRoot),this._sceneInstances[e].scene.dispose(!0),this._sceneInstances[e]=null;null==this._sceneInstances[this._sceneInstances.length-1];)this._sceneInstances.splice(e,1)},selectSceneInstance:function(e){this.scene=this._sceneInstances[e].scene,this.root3js=this._sceneInstances[e].root3js,this.root=this._sceneInstances[e].root},onSelectViewpoint:function(){this.subscribeToOnViewpointChanged()},subscribeToOnViewpointChanged:function(){var e=this.viewer.currentViewpoint,t=this._onViewpointChangedEvent,i=!1;if(t){if(e===t.object)return;t.object.unsubscribe(t.token),this._onViewpointChangedEvent=null,i=!0}var r=this.viewer.currentViewpoint.onMove(this.onViewpointChange.bind(this));this._onViewpointChangedEvent={object:this.viewer.currentViewpoint,token:r},i&&this.onViewpointChange()},onAddViewpoint:function(){if(this.subscribeToOnViewpointChanged(),!this.viewpointAdded){var e=this.viewer.onViewerResize(this.onViewpointChange.bind(this));this._subscribedEvents.push({object:this.viewer,token:e})}this.viewpointAdded=!0,this.lockShowReferenceAxisSystem||this.showReferenceAxisSystem(this.bShowReferenceAxisSystem,!0)},onViewpointChange:function(){var e=this.viewer.currentViewpoint;e&&(e._updateRobotCamera(this),this._robot&&this._robot.onViewpointChange(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode.onViewpointChange())},_detachEvents:function(){var e,t;for(e=0;e<this._subscribedEvents.length;e++)(t=this._subscribedEvents[e]).object.unsubscribe(t.token);this._subscribedEvents=[]},getChildByName:function(e){return this.root.getChildByName(e)},getMeshMin:function(e,i){var r,n,s,a,o,l=void 0!==i?i:"z",h=null,c=new t.Vector3;for(n=null,s=0,e.geometry.length>=0?(n=e.geometry[0],s=e.geometry.length):2===e.geometry._type&&(n=e.geometry,s=1),a=0;a<s;a++){if(null===n.vertexPositionArray){n=e.geometry[a+1];continue}r=e._getMMMatrix();const t=n.getVertexCount();for(o=0;o<t;o++)n.getVertexPosition(o,c),c.applyMatrix4(r),(c[l]<h||null===h)&&(h=c[l]);n=e.geometry[a+1]}return h},getSceneMin:function(e,i){if(this._savedSceneMin=0,!this.root3js)return 0;var r="z";if(i&&i.upVector.y>0&&(r="y"),e){if(this.root){var n=this.root.getBoundingBox("show");if(n)return this._savedSceneMin=n.min[r],n.min[r]}return 0}var s,a,o,l,h,c=this.root3js.children,d=null,u=null,p=new t.Vector3;for(s=0,a=c.length;s<a;s++)if(!(o=c[s])._isDecal()&&m(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&o.geometry.length&&o.geometry[0].drawingGroups.length){if(o._instancingInfos&&o._instancingInfos.useDefaultInstancing){let e=o._occurrence;for(;e&&!e.node._instancingInfos;)e=e.parent;h=e?e.node.getTopZ(o,e,r):d}else{var f=o._getMMMatrix();p.copy(o.geometry.boundingSphere.center),p.applyMatrix4(f);let e=p[r];l=f?f.getMaxScaleOnAxis():1,h=e+o.geometry.boundingSphere.radius*l,o._BEbottomZ=e-o.geometry.boundingSphere.radius*l}(null===d||h<d)&&(d=h)}var g=[];for(s=0,a=c.length;s<a;s++){if(!(o=c[s])._isDecal())if(m(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&o.geometry.length&&o.geometry[0].drawingGroups.length)if(l=(f=o._getMMMatrix())?f.getMaxScaleOnAxis():1,o._BEbottomZ<d)if(o.geometry[0].vertexPositionArray){var v=o.getMin(r,d);(null===u||v<u)&&(u=v)}else g.push(o)}if(g.length){var _=this.viewer.renderer.boundingBoxGPUCompute.computeZMinGPU(this.viewer,g);u=null===u?_:Math.min(_,u)}return this._savedSceneMin=u,u},getSavedSceneMin:function(){return this._savedSceneMin},updateShaders:function(){this.viewer.renderer.recompileAllShaders(null)},getBoundingSphere:function(e,i,r){var n=this.root._occurrences[0]?this.root._occurrences[0].getBoundingSphere(e,!0):null;return i||n&&!(n.radius<=0&&n.pixelRadius<=0)||(n=new t.Sphere(new t.Vector3,100)),n},clearSelection:function(){this.selectionHL.clearAll(this.scene),this.selectionPreHL.clearAll(this.scene)},addLightNode:function(e){this.lightRoot.addChild(e)},removeLightNode:function(e){this.lightRoot.removeChild(e,!0)},addRobotNode:function(e){this.robotRoot.addChild(e)},addUserNode:function(e,t){t?this.userRoot.children[0].addChild(e):this.userRoot.addChild(e)},removeUserNode:function(e,t){t?this.userRoot.children[0].removeChild(e,!0):e instanceof n||!e?this.userRoot.removeChild(e,!0):this.userRoot.removeChild(e._private_root,!0)},setRobot:function(e,t,i,r){return e&&!r&&(this.lockShowReferenceAxisSystem=!1),t=t||{},this.drivesTheRobot=!0,this.createAxisSystem(),this._robot&&e&&(this.robotRoot.remove(this._robot,!0),this._robot._dispose(),this._robot=null,this.robot=null),this._robot||this.createRobot(i,t,p),e?this._robot.setHiddenMode(!1):this._robot.setHiddenMode(!0),r||(this.robot=e?this._robot:void 0),!0},getRobot:function(){return this.drivesTheRobot?this.robot:this.getChildByName("robot")},setCustomReferenceAxisSystem:function(e){this._customReferenceAxisSystem&&(this.robotRoot.removeChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem._dispose(),this._customReferenceAxisSystem=null),e&&(this._customReferenceAxisSystem=new g(this.viewer,e),this._customReferenceAxisSystem.setRenderPasses(["robotOrtho"]),this.robotRoot.addChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem.onViewpointChange())},clearScene:function(e,t,i){this.clearSelection();var r,n=this.userRoot.children.length;if("deprecated"===i)for(var s=this.userRoot.children[0];s.children.length;)s.remove(s.children[0]);else for(r=0;r<n;r++)this.userRoot.remove(this.userRoot.children[0])},getUserNodes:function(e){var t,i=[],r=this.getUserRoot(e);for(t=0;t<r.children.length;t++)i.push(r.children[t]);return i},getUserRoot:function(e){return e?this.userRoot.children[0]:this.userRoot},addDebugNode:function(e){this.debugRoot||(this.debugRoot=new n,this.debugRoot.excludeFromBounding=!0,this.root.addChild(this.debugRoot)),this.debugRoot.addChild(e)},removeDebugNode:function(e){this.debugRoot.removeChild(e)},showReferenceAxisSystem:function(e,t){t||(this.lockShowReferenceAxisSystem=!1),this.bShowReferenceAxisSystem=e,this.viewpointAdded&&(this.createAxisSystem(),this.updateReferenceAxisSystemVisibility())},createAxisSystem:function(){this.referenceAxisSystemNode||(this.referenceAxisSystemNode=new f("referenceAxisSystem",this.viewer),this.robotRoot.addChild(this.referenceAxisSystemNode),this.referenceAxisSystemNode.setCameraName("robotCameraOrtho"),this.referenceAxisSystemNode.setRenderPasses(["robotOrtho"]))},createRobot:function(e,t,i){this._robot=new i(this,"robot",e,t.snapOnFace,t.showOnlyManipulated,"I solemnly swear that I am up to no good.",t.touchMode);var r=e.getWorldOrientation();"zup"!==r._woName&&this._robot._setWorldOrientation(r),this.onViewpointChange(),this.updateReferenceAxisSystemVisibility()},updateReferenceAxisSystemVisibility:function(){this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(this.bShowReferenceAxisSystem)},setRobotAndRefAxisSystemEnabled:function(e){this._robot&&this._robot._setEnabled(e),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(e)},dispose:function(e){this._robot&&this._robot._dispose(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._dispose(),this._customReferenceAxisSystem&&this._customReferenceAxisSystem._dispose();for(let e=this._sceneInstances.length-1;e>=0;e--)this.freeSceneInstance(e);for(this._robot=null,this.robot=null,this.referenceAxisSystemNode=null,this._detachEvents(),this.clearScene();this.root.children.length;)this.root.removeChild(this.root.children[0]);var t;for(t in this.scene.dispose(e),this.selectionHL=null,this.selectionPreHL=null,this)this[t]=null},setWorldOrientation:function(e){this._robot&&this._robot._setWorldOrientation(e)},forceHighlightVisibility:function(e){if(this.selectionHL&&(this.selectionHL._updateScene(this.scene),this.selectionHL.sceneHL)){var t=this.selectionHL.sceneHL.children;this.forceHLVisibility(t,e)}},forcePreHighlightVisibility:function(e){if(this.selectionPreHL&&(this.selectionPreHL._updateScene(this.scene),this.selectionPreHL.sceneHL)){var t=this.selectionPreHL.sceneHL.children;this.forceHLVisibility(t,e)}},forceHLVisibility:function(e,t){if(t)for(var i=0;i<e.length;i++){(r=e[i]).visible=!0,r.visibilityFree=!0}else for(i=0;i<e.length;i++){var r,n=(r=e[i])._occurrence;n&&n.renderable&&(r.visible=n.renderable.visible,r.visibilityFree=n.renderable.visibilityFree)}},updateStaticOverrides:function(){v._enableStaticOverrides&&(this.root.traverseUnique((function(e){var t=e._getStaticOverrideSet();null!==t&&t._deactivateStaticOverrides()})),this.root.traverseUnique((function(e){var t=e._getStaticOverrideSet();null!==t&&t.applyStaticOverrides()})),this.root.forceUpdate())},addBEExcludedNode:function(e){e.id!=this.robotRoot.id&&this.excludedFromBoundingNodes.set(e.id,e)},removeBEExcludedNode:function(e){this.excludedFromBoundingNodes.delete(e.id)},getBEExcluded:function(e){let t=null,i=this._getBEExcludedNodeOccurences();for(let r=0;r<i.length;r++){let n=i[r].getBoundingSphere(e,!0);n&&(n.applyMatrix4(i[r].matrix),t?t.mergeWithSphere(n,t):t=n)}return t},_getBEExcludedNodeOccurences:function(){let e=[];for(let[t,i]of this.excludedFromBoundingNodes)if(i.getExcludeFromBounding())for(let t=0;t<i._occurrences.length;t++){let r=i._occurrences[t];r.scene3js==this.root3js&&e.push(r)}else this.removeBEExcludedNode(i);return e}});return v.setRobotClasses=function(e,t,i){p=e,f=t,g=i},v._enableStaticOverrides=!0,UWA.namespace("THREEDS/InternalSceneGraph",v)})),define("Visualization/InternalSceneGraph",["DS/Visualization/InternalSceneGraph","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/InternalSceneGraph"),e})),define("DS/Visualization/SceneGraphUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/SceneGraphNodes/AxisSystemNode"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p){"use strict";var f={_getUniqueOccurrence(e){if(!e)return null;var t=e._getOccurrences();return 1!==t.length?null:t[0]},getSagFromPathElement:function(e){if(!e)return 0;for(var t=0;t<e.externalPath.length;t++){if(e.externalPath[t].sag)return sag}return 0},getCurrentVisibility:function(e){if(!e)return!1;for(var t=0;t<e.externalPath.length;t++){if(!e.externalPath[t].isVisible())return!1}return!0},_getDGorLayers:function(e,t){var i=[],r=e.layer;if(r)for(var n=r.layers.length,s=0;s<n;s++){var a=r.layers[s];a.drawableInterval.layerNum<=0||(t&&4!==a.drawableGroup.glType||i.push(a))}else{var o=e.geometry.length;for(s=0;s<o;s++)for(var l=e.geometry[s].drawingGroups,h=l.length,c=0;c<h;c++)t&&4!==l[c].glType||i.push(l[c])}return i},_getCurrentGraphicProperties:function(t,i,r,n,s){for(var a=[],o=t.getLastElement(!0),l=t._getRenderableOccurrences(i),h=0;h<l.length;h++){var c=l[h],d=c.visible,p=c.layer,f=c.matApp,g=c.meshMaterial,m=c.gas,v=new u(t.externalPath),_={path:v,materials:[],gas:[],visible:d};a.push(_);for(var y=[],S=c._occurrence;S.node!==o;)y.unshift(S.node),S=S.parent;for(var b=0;b<y.length;b++)v.addElement(y[b]);var x=this._getDGorLayers(c,!0);for(b=0;b<x.length;b++){var w=x[b],P=null;p&&(P=w.drawableInterval,w=w.drawableGroup);var C=w.glType,M=null,E=null,T=f&&f._getMaterialFromGLType(C,w._geomType),A=P&&P.material?P.material:w.material,D=P&&P.gas?P.gas:w.gas;A&&(A.isMatApp&&(M=A.solveInheritance(f,c._occurrence.depth)===f?T:A._getMaterialFromGLType(C,w._geomType)),M||A.isMatApp||(T?f:null,(M=T)||(M=A instanceof e.Material?A:null))),M||(f,M=T),!M&&g&&g.force&&(M=g),E=m?m.getMaterial(D,C,null,null):D.isGAS?D.getMaterial(null,C,null,null):D,r||(M=null),n||(E=null);for(var I=!1,R=0;R<_.materials.length;R++){var O=_.materials[R],L=_.gas[R];if(O===M&&L===E){I=!0;break}}I||(_.materials.push(M),_.gas.push(E))}}return a},getCurrentGraphicProperties:function(e){for(var t=[],i=this._getCurrentGraphicProperties(e.pathElement,e.viewer,e.getMaterial,e.getColor||e.getOpacity,e.getVisibility),r=0;r<i.length;r++)for(var n=i[r],s=0;s<n.materials.length;s++){var a={pathElement:n.path};e.getMaterial&&(a.material=n.materials[s]);var o=n.gas[s];e.getOpacity&&(a.opacity=o?o.isGAS?o._alpha:o.opacity:1),e.getColor&&(a.color=o?o.isGAS?o._color:o.color:null),e.getVisibility&&(a.visibility=n.visible),t.push(a)}return t},getTrianglesCount:function(e,t){return e._getTrianglesCount(t)},_getCurrentMaterialOrGAS:function(e,t){var i="matApp"===t?"material":t,r=f._getUniqueOccurrence(e);if(!r)return null;for(var n=null;!n&&r;){if(r[t])return r[t];if(n=r.renderable){if(n[t])return n[t];var s=null;if(n.layer)for(var a=0;a<n.layer.layers.length;a++){var o=n.layer.layers[a];if(!(o.drawableInterval.layerNum<=0)&&(s=o.drawableInterval[i],4===o.drawableGroup.glType&&o.drawableInterval[i]))return s}else for(a=0;a<n.geometry.length;a++)for(var l=n.geometry[a],h=0;h<l.drawingGroups.length;h++){var c=l.drawingGroups[h];if(s=c[i],4===c.glType&&c[i])return s}return s}if(1!==r.children.length)break;r=r.children[0]}return null},getCurrentOpacity:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._alpha:t.opacity:1},getCurrentColor:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._color:t.color:null},getCurrentMaterial:function(e,t){var i=this._getCurrentMaterialOrGAS(e,"matApp");return i?"Face"===t?i._material:"GeomFace"===t?i._materialGeomFace:"Line"===t?i._materialLine:"Point"===t?i._materialPoint:i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null:null},applyMaterialToOccurrencePath:function(e,t,i){var r,n=e._getRenderableOccurrencesFromOccurrencePath(t);for(r=0;r<n.length;r++)n[r].material=i},applyMaterialToPath:function(e,t){return i._applyMaterialToPath(e,t)},applyVisibilityToPaths:function(t,r){for(var n=new Map,s=new e.Box3,a=0;a<t.length;a++){for(var o=t[a],l=o._getRenderableOccurrences(),h=l.length,c=0;c<h;c++)(g=l[c])&&g._flagAsGSSOInvalidated();var d=o.getLastElement();if(null===d)return!1;if(d instanceof i)2===r?d.setVisibility(!d.visible,!0):d.setVisibility(r,!0);else if(1===h)if((m=n.get(l[0]))||(m=[],n.set(l[0],m)),"rep"===d.getType()){var u=d.getChildren();for(c=0;c<u.length;c++)m.push(u[c].sgNode)}else"primitive"===d.getType()&&m.push(d.sgNode)}const p=n[Symbol.iterator]();var f=new e.Matrix4;for(const e of p){var g=e[0],m=e[1];null===g.layer&&g.initLayers(1),g.layer.addPrimitivesToLayers(m,r);for(c=0;c<g.geometry.length;c++){var v=g.geometry[c]._computeOrientedBoundingBox(f,g.layer.getIntervals(g.geometry[c]));s.union(v)}g._occurrence.node.forceBoundingBox(s)}},applyVisibilityToPath:function(e,t,r){if(null===e)return!1;var n=e._getRenderableOccurrences(),s=n.length;for(h=0;h<s;h++)(o=n[h])&&o._flagAsGSSOInvalidated();var a=e.getLastElement();if(null===a)return!1;if(r){if(1!==s)return!1;var o;null===(o=n[0]).layer&&o.initLayers(1),o.layer.addPrimitivesToLayers(r,t)}else if(a instanceof i)2===t?a.setVisibility(!a.visible,!0):a.setVisibility(t,!0);else{if(1!==s)return!1;r=[];if("rep"===a.getType())for(var l=a.getChildren(),h=0;h<l.length;h++)r.push(l[h].sgNode);else"primitive"===a.getType()&&r.push(a.sgNode);null===n[0].layer&&n[0].initLayers(1),n[0].layer.addPrimitivesToLayers(r,t)}return!0},getVisibilityFromPath:function(e,t){if(!e)return!1;var r=e._getRenderableOccurrences(t),n=r.length,s=e.getLastElement();if(!s)return!1;if(s instanceof i)return s.isVisible();if(1!==n)return!1;var a,o=r[0];if(null===o.layer)return!0;if("rep"===s.getType()){var l=s.getChildren();l[0]&&(a=l[0].sgNode)}else"primitive"===s.getType()&&(a=s.sgNode);for(var h=a.getGroup(),c=a.getStart(),d=o.layer.layers,u=0;u<d.length;u++){var p=d[u];if(h===p.drawableGroup){var f=p.drawableInterval;if(!(c<f.start||c>=f.start+f.count))return 1===f.layerNum}}return!1},getOrientedBoundingBoxFromPathElements:function(t,i,r,n){for(var s=new e.Box3,a=(new e.Matrix4).extractRotation(i),o=0;o<t.length;++o){var l=t[o].getOrientedBoundingBox(i,r,null,null,null,!!n);l&&(s=s.union(l))}return{cornerPoint:(new e.Vector3).copy(s.min).applyMatrix4(i),firstAxis:new e.Vector3(s.max.x-s.min.x,0,0).applyMatrix4(a),secondAxis:new e.Vector3(0,s.max.y-s.min.y,0).applyMatrix4(a),thirdAxis:new e.Vector3(0,0,s.max.z-s.min.z).applyMatrix4(a),localBBox:s}},getMaterialsFromPath:function(e,t,i){e.getRootNode()._tryOverridesUpdate(e);var r=t._getUniqueOccurrence(),n=null,s=null,a=null;if(r&&r.renderable){s=[],this._traversePathMaterials(r,(function(e){s.indexOf(e)<0&&s.push(e)}),(function(){}),null,!1);let e=r.getOverrideLinkToUse();e&&(a={color:e.getColor(),opacity:e.getOpacity(3),material:e.getFullMaterial()}),n={materials:s,overrides:a}}return n},buildModelIdPath:function(e){var t,i,r,n={elements:[],subElements:[]},s=e.getLastElement();if(s instanceof p&&s._sgRep)t={id:s._sgRep.cgmId,namingContext:s._sgRep.namingContext},n.elements.push(t);else for(i=0;i<e.internalPath.length;i++)(r=e.internalPath[i].sgNode).getType&&3===r.getType()?n.subElements.push(r.getCgmId()):1!==r.type&&2!==r.type||(t={id:r.cgmId,namingContext:r.namingContext},n.elements.push(t));return n},buildPathElementFromModelIdPath:function(e,t){var i=e.getLastElement(!0);if(!(i instanceof r))return null;var a,o,l,h,c,d,p,f,g=null,m=t.elements,v=null,_=new s.SGPrimitiveHelper,y=!1;if(t.subElements.length>0&&(g=t.subElements[0])>0)for(a=0;a<i.mesh3js.geometry.length&&!y;a++)for(d=i.mesh3js.geometry[a],o=0;o<d.drawingGroups.length&&!y;o++)for(p=d.drawingGroups[o],l=0;l<p.getPrimitivesCount()&&!y;l++)if(_.set(p,l),_.getCgmId()===g){for(h=m.length-1,c=_.getRep();c&&h>=0&&c.cgmId===m[h].id;)c=c.parents[0],h--;!c&&h<0&&(y=!0)}if(y)(f=e._getUniqueOccurrence())&&(v=new u).setFromOccurrence(f,n.getFromSGNode(_));else if(1===m.length){var S=i.parents[0],b=S&&S.getChildByName("AxisSystems");if(b){for(a=0;a<b.children.length&&!y;a++){var x=b.children[a]._sgRep;x&&x.cgmId===m[0].id&&(y=b.children[a])}if(y){for(v=new u,a=0;a<e.externalPath.length&&e.externalPath[a]!==i;a++)v.addElement(e.externalPath[a]);v.addElement(b),v.addElement(y)}}}return v},buildPathesLeadingToNode:function(e,t){var i,r,n,s=[];for(i=0;i<e._occurrences.length;i++)r=e._occurrences[i],(n=new u).setFromOccurrence(r,null,t)&&s.push(n);return s},setRenderPriority:function(e,t,i){if(g.indexOf(t)<0)return console.warn("SceneGraphUtils.setRenderPriority invalid input priority value"),!1;var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,s={userPriority:null!==t,priority:t,userOpacity:!(!n||!n.userOpacity),opacity:n?n.opacity:null,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=s,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},setRenderPriorityOpacity:function(e,t,i){t||0===t||(t=null);var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,s={userPriority:!(!n||!n.userPriority),priority:n?n.priority:null,userOpacity:null!==t,opacity:t,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=s,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},_traversePathMaterials:function(t,i,r,n,s,a){if(null===t)return null;var o={};function l(e){var t=[],i=0;for(i=0;i<e.geometry.length;i++){var r=0,n=e.geometry[i];for(r=0;r<n.drawingGroups.length;r++){var s=n.drawingGroups[r];if(t[o[s.glType]]){if(t[o[s.glType]]!==s.gas)return null}else t[o[s.glType]]=s.gas}}return t}o[0]=0,o[3]=1,o[2]=1,o[1]=1,o[5]=2,o[6]=2,o[4]=2;var h=[];t.renderable&&h.push(t.renderable);for(var c=h.length,d=0;d<c;d++){var u=h[d],p=!a&&l(u);if(u.material&&u.material.force){var f=u.userData&&u.userData.oldMaterial?u.userData.oldMaterial:u.material;i(f,f,(function(e){u.material=e}),u)}else if(p){var g=p[2];g||(g=new e.MeshBasicMaterial),p[0]&&(g.point=p[0]),p[1]&&(g.line=p[1]),i(p[2],g,(function(e){e.force=!0,u.material=e}),u)}else if(s||u.layer){var m=0;for(m=0;m<u.layer.layers.length;m++){var v=u.layer.layers[m];a&&v.drawableGroup._geomType!==a||(v.drawableInterval.material?i(v.drawableInterval.material,v.drawableInterval.material,(function(e){v.drawableInterval.material=e})):i(v.drawableGroup.gas,v.drawableGroup.gas,(function(e){v.drawableInterval.material=e})))}}else{n&&n(u);var _=0;for(_=0;_<u.geometry.length;_++){var y=0,S=u.geometry[_];for(y=0;y<S.drawingGroups.length;y++){var b=S.drawingGroups[y];!b||a&&b._geomType!==a||i(b.gas,b.gas,(function(e){u.layer.addPrimitivesToLayers(b.primitives,1,e)}))}}}r()}},streamVisu:function(i){var r=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexTangentArray","vertexBinormalArray","vertexColorArray"],n=i.layers||!1,a=i.node?i.node:i,o=(i.nodejsContext,i.nodeCallback),l=i.imageCallback,h=i.loadedTexturesCallback,c=null,d=i.embeddedTextures||!1,u=0,p={textures:{},materials:{},geometries:{},nodes:{}},f=0,g=[{size:0,buffers:[],data:null}],m={json:p,chunks:g};function v(e){g[f].size+e.byteLength>1e8&&(f++,g[f]={size:0,buffers:[],data:null});var t=g[f],i=t.size;return t.buffers.push({buffer:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),offset:i}),t.size+=e.byteLength,t.size%4&&(t.buffers.push({buffer:new Uint8Array(4-t.size%4),offset:t.size}),t.size+=4-t.size%4),i}function _(){u--,console.log("nb textures loading: "+u),c&&!u&&c(m)}function y(t,i){if(t.image)if(t.image.getContext||t.image.tagName&&"img"===t.image.tagName.toLowerCase()){if(t.sourceFile&&"blob:"===t.sourceFile.substring(0,5)){var r=new XMLHttpRequest;r.open("GET",t.sourceFile,!0),r.responseType="blob",r.onload=function(e){if(200===this.status){var t=this.response.type;i.format="image/jpeg"===t?"jpeg":"png",i.data=this.response,i.path="texture_"+i.id+"."+i.format,console.log("canvas blob"),_()}},r.send()}else if(t.image.getContext){var n=(l=t.image.getContext("2d")).getImageData(0,0,t.image.width,t.image.height);i.format="png",i.data=n,i.path="texture_"+i.id+"."+i.format,console.log("png"),_()}}else if(t.mipmaps&&t.mipmaps.length){var s=t.image.width,a=t.image.height;i.format="dds",i.data=new Blob([e.ImageUtils.streamDDS(t)],{type:"arraybuffer"}),i.path="texture_"+i.id+"."+i.format,console.log("dds"),_()}else{s=t.image.width,a=t.image.height;var o=document.createElement("canvas");o.width=s,o.height=a;for(var l,h=(n=(l=o.getContext("2d")).getImageData(0,0,s,a)).data,c=0;c<a;c++)for(var d=0;d<4*s;d++)h[4*(a-c-1)*s+d]=t.image.data[4*c*s+d];l.putImageData(n,0,0,0,0,s,a);var u=atob(o.toDataURL("image/png").split(",")[1]),p=new Array(u.length);for(c=0;c<u.length;c++)p[c]=u.charCodeAt(c);var f=new Uint8Array(p);i.format="png",i.data=new Blob([f],{type:"image/png"}),i.path="texture_"+i.id+"."+i.format,console.log("uncompressed"),_()}}function S(i,r){if(!r.textures[i.id]){var n={id:i.id,anisotropy:i.anisotropy,magFilter:i.magFilter,minFilter:i.minFilter,wrapS:i.wrapS,wrapT:i.wrapT,repeat:i.repeat};if(l)l(i,n);else if(d)if(i.loadEndStatus&&i.loadEndStatus!==e.AssetLoadingStatus.READY){if(i.loadEndStatus===e.AssetLoadingStatus.ERROR)return void console.log("texture was not loaded: impossible to embed it in streamvisu.");u++,console.log("nb textures loading: "+u),i.onLoadCallbacks.push((function(e){y(e,n)}))}else u++,console.log("nb textures loading: "+u),y(i,n);else if(i.sourceFile){n.format=t.getExtension(i.sourceFile);var s=function(e){var t="";if("blob:"===e.substring(0,5))return null;if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else{if("file://"===e.substring(0,7))return null;var i=location.href,r=i.indexOf("?");-1!==r&&(i=i.substring(0,r));var n=i.lastIndexOf("/");-1!==n&&(i=i.substring(0,n+1)),t=i+e}return t}(i.sourceFile);s&&(n.path=s)}r.textures[i.id]=n}return i.id}function b(t,i){var r="MeshPhong";t instanceof e.LineBasicMaterial?r="LineBasic":t instanceof e.PhysicalMaterial?r="Physical":t instanceof e.MeshLambertMaterial&&(r="MeshLambert");var n={id:t.id,type:r,visible:t.visible,force:t.force,side:t.side,enableClipPlanes:t.enableClipPlanes,transparent:t.transparent,opacity:t.opacity,alphaTest:t.alphaTest,depthTest:t.depthTest,depthWrite:t.depthWrite};return t.color&&(n.color=t.color),(t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)&&(n.ambient=t.ambient,n.emissive=t.emissive,n.specular=t.specular,n.shininess=t.shininess,n.vertexColors=t.vertexColors,void 0!==t.glossiness&&(n.glossiness=t.glossiness),void 0!==t.metalness&&(n.metalness=t.metalness),t.map&&(n.diffuseMap=S(t.map,i)),t.bumpMap&&(n.bumpMap=S(t.bumpMap,i)),t.normalMap&&(n.normalMap=S(t.normalMap,i)),t.specularMap&&(n.specularMap=S(t.specularMap,i)),t.emissiveMap&&(n.emissiveMap=S(t.emissiveMap,i)),t.metalnessMap&&(n.metalnessMap=S(t.metalnessMap,i)),t.glossinessMap&&(n.glossinessMap=S(t.glossinessMap,i)),t.bumpMap&&void 0!==t.bumpScale&&(n.bumpScale=t.bumpScale),t.coating&&(n.coating=t.coating),t.coating&&void 0!==t.coatingGlossiness&&(n.coatingGlossiness=t.coatingGlossiness)),n}return a.traverse((function(t,i){var a=i.nodes[t.id];if(!a){var l=t.getNodeType();if(a={id:t.id,type:l},t._matrix&&!t._matrix.isIdentity()){var h=[];t._matrix.flattenToArray(h),a.matrix=h}if(t.material)(j=i.materials[t.material.id])||(j=t.material,i.materials[t.material.id]=b(j,i)),a.material=t.material.id;if(i.nodes[t.id]=a,"Node3D"===l){for(var c=[],d=0;d<t.children.length;d++)c.push(t.children[d].id);a.children=c}else{var u=t._occurrences[0].renderable,p=u.boundingSphere,g=u.boundingBox;g||(g=p.getBoundingBox());var m=!1;if(n)for(d=0;d<t._occurrences.length;d++)if(t._occurrences[d].renderable.layer){m=!0;break}var _=[];for(d=0;d<u.geometry.length;d++){var y=u.geometry[d].id;_.push(y);var S=i.geometries[y];if(!S){S=u.geometry[d];var x={};x.id=S.id;for(var w=0;w<r.length;w++){var P=S[r[w]];if(P){var C=v(P),M={chunk:f,offset:C,byteLength:P.byteLength,bpe:P.BYTES_PER_ELEMENT,itemSize:P.itemSize};x[r[w]]=M}}x.dgs=[];for(w=0;w<S.drawingGroups.length;w++){var E=S.drawingGroups[w];n&&m&&(E.__id__=w);for(var T=E.getPrimitivesCount(),A=0,D=0;D<T;D++){(L=E.getPrimitiveDecoration(D))&&L.length&&(A+=L.length)}var I=new Uint32Array(4*T),R=new Uint8Array(A),O=0;for(D=0;D<T;D++){var L,B=E.getPrimitiveCgmId(D),F=E.getPrimitiveRep(D),V=E.getPrimitiveStart(D),G=E.getPrimitiveCount(D);if(I[4*D]=B,I[4*D+1]=F?F.cgmId:0,I[4*D+2]=V,I[4*D+3]=G,(L=E.getPrimitiveDecoration(D))&&L.length){console.log(L.length),L.length>255&&console.log("panic"),R[O++]=L.length;for(var N=0;N<L.length;++N)R[O++]=L[N]}else R[O++]=0}C=v(I);var U={chunk:f,offset:C,byteLength:I.byteLength,bpe:I.BYTES_PER_ELEMENT,itemSize:I.itemSize},k=void 0;if(A){var z=v(R);k={chunk:f,offset:z,byteLength:R.byteLength,bpe:R.BYTES_PER_ELEMENT,itemSize:R.itemSize}}if(x.dgs[w]={start:E.start,count:E.count,geomType:s.GeomTypeString[E._geomType],glType:E.glType,primitives:U,canonicals:k},E.material instanceof e.Material)i.materials[E.material.id]||(i.materials[E.material.id]=b(E.material,i)),x.dgs[w].material=E.material.id;else if(E.gas){i.materials[E.gas.id]||(i.materials[E.gas.id]=b(E.gas,i)),x.dgs[w].gas=E.gas.id}}i.geometries[y]=x}}if(a.mesh3js={bs:{c:[p.center.x,p.center.y,p.center.z],r:p.radius},bbox:{min:[g.min.x,g.min.y,g.min.z],max:[g.max.x,g.max.y,g.max.z]},geometries:_},n&&m){a.occurrences={};for(d=0;d<t._occurrences.length;d++){var H=t._occurrences[d].renderable;if(H.layer){var W=[];a.occurrences[d]={index:d,layers:W};for(w=0;w<H.layer.layers.length;w++){var j,X=H.layer.layers[w],q={start:X.drawableInterval.start,count:X.drawableInterval.count,primitiveStart:X.drawableInterval.primitiveStart,primitiveCount:X.drawableInterval.primitiveCount,layerNum:X.drawableInterval.layerNum};if(X.drawableInterval.material)q.material=X.drawableInterval.material.id,(j=i.materials[q.material])||(j=X.drawableInterval.material,i.materials[q.material]=b(j,i));W.push({geometry:X.geometry.id,drawableGroup:X.drawableGroup.__id__,drawableInterval:q})}}}}if(u.material)(j=i.materials[u.material.id])||(j=u.material,i.materials[u.material.id]=b(j,i)),a.mesh3js.material=u.material.id}o&&o(t,a)}}),p),p.nbChunks=g.length,h&&(c=h),m.chunks=function(){for(var e=0;e<g.length;e++){var t=g[e];t.data=new Uint8Array(t.size);for(var i=0;i<t.buffers.length;i++)for(var r=t.buffers[i],n=r.buffer,s=r.offset,a=0;a<n.byteLength;a++)t.data[s+a]=n[a]}return g}(),!u&&c&&c(m),m}},g=[0,1,2,3,4];return f})),define("DS/Visualization/SceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/SceneGraphUtils"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u){"use strict";if(!window.undoSceneGraphMigrationStep2)return function(){}})),define("Visualization/SceneGraph",["DS/Visualization/SceneGraph","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/SceneGraph"),e})),define("DS/Visualization/Viewpoint",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/Visualization/TrackballControls","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/VisuMePreferences/MePreferences","DS/WAFData/WAFData"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u){"use strict";var p=new i.Projector,f=0,g=e.extend({init:function(e,t,r,n,s){var a,o,l;e.hasOwnProperty("viewer")?(this.viewer=e.viewer,this.projectionType=void 0!==e.projectionType?e.projectionType:g.PERSPECTIVE,a=void 0!==e.angle?e.angle:void 0!==e.fov?e.fov:45,e.fov&&console.warn("Deprecated. Use options.angle instead."),o=void 0!==e.near?e.near:10,l=void 0!==e.far?e.far:2500,h=void 0===e.defaultController||e.defaultController):(console.warn("Deprecated. You must use a litteral object to define your viewpoint."),this.viewer=e,a=void 0!==t?t:45,o=void 0!==r?r:10,l=void 0!==n?n:2500,this.projectionType=g.PERSPECTIVE,h=void 0===s||s),this.id=f++,this._isMain=!1,this.viewer._viewpointManager&&this.viewer._viewpointManager.registerViewpoint(this),this.useWebGPU=!!this.viewer.renderer&&this.viewer.renderer.renderer.use_webgpu,this._worldOrientation=c.ZUpYRight,e.inactive||this.createDivCSS();var h,d=(this.viewer.canvas.offsetWidth?this.viewer._getCanvasOffsetWidth():1)/(this.viewer.canvas.offsetHeight?this.viewer._getCanvasOffsetHeight():1);return this.projectionType===g.PERSPECTIVE?this.camera=new i.PerspectiveCamera(a,d,o,l,this.useWebGPU):(this.camera=new i.OrthographicCamera(0,0,0,0,o,l,this.useWebGPU),this.camera.setVisualizedHeight(null,d,a)),this.camera._renderingRole=i._CameraRoles.PRINCIPAL+(e._roleShift?e._roleShift:0),this._renderedCamera=this.camera,this.camera._viewpoint=this,this.robotCameraOrtho=new i.OrthographicCamera(0,0,0,0,o,l,this.useWebGPU),this.camera.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(400,d,a),this.robotCameraOrtho._viewpoint=this,this.robotCameraOrtho._setRobotRenderingRoleFromPrincipal(this.camera),this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._viewpoint=this,this.connectedRobotCamera._setRobotConnectedRenderingRoleFromPrincipal(this.camera),this.target=new i.Vector3,this.position=new i.Vector3,this.defaultReframeTime=this.viewer&&this.viewer.ODTMode?1:400,this.sceneGraphRoot=null,this._internalSceneGraph=null,this.control=null,this._mePreferenceSetting=null,this._forcedController=null,this._2DModePreviousController=null,this._currentDefaultController="COMBINED",this._isMoving=!1,this.updateAnimation=function(e){},this._viewpointAnimation=null,this._frustum=new i.Frustum,this.setDefaultController(h),h||this.resetCameraOrientation(),this.viewer.internalSceneGraph&&this._updateRobotCamera(this.viewer.internalSceneGraph),this._customReframeCB=null,this._customCenterCameraCB=null,this._2DMode=!1,this._nativeTranslationOffset=null,this._nativeZoomType=null,this._nativeZoomRatio=null,this._nativeZoom=1,this._clip=0,this._bottomleftClip=null,this._toprightClip=null,this._anchor=0,this._XMaxTranslationBound=1e10,this._XMinTranslationBound=-1e10,this._YMaxTranslationBound=1e10,this._YMinTranslationBound=-1e10,this._depthMode=0,this._unlockMoveIn360Mode=!1,this._focusMode=g._FOCUS_MODE.TRANSLATION,this._SWXCoreViewManipulation=null,this._csiUID=null,this},createDivCSS:function(){this.divCameraCSSElement=UWA.createElement("div"),this.divCameraCSSElement.style.WebkitTransformStyle="preserve-3d",this.divCameraCSSElement.style.MozTransformStyle="preserve-3d",this.divCameraCSSElement.style.oTransformStyle="preserve-3d",this.divCameraCSSElement.style.transformStyle="preserve-3d",this.divCameraCSSElement.id="camera",this.viewer.divCss3DElement.appendChild(this.divCameraCSSElement),this.viewer.divCss3DElement.style.overflow="hidden",this.divCameraCSSElement.style.width=this.viewer.divCss3DElement.style.width,this.divCameraCSSElement.style.height=this.viewer.divCss3DElement.style.height},isMain:function(){return this._isMain},setCsiUID:function(e){this._csiUID=e},getCsiUID:function(){return this._csiUID},getWorldOrientation:function(){return this._worldOrientation},getCamera:function(){return this.camera},setUnlockMoveIn360Mode:function(e){this._unlockMoveIn360Mode=e},getUnlockMoveIn360Mode:function(){return this._unlockMoveIn360Mode},getCameraTarget:function(){return console.warn("DEPRECATED"),this.target},getCameraPosition:function(){return console.warn("DEPRECATED"),this.position},getControl:function(){return this.control},setEyePosition:function(e){var t=e.clone().add(this.getSightDirection().multiplyScalar(this.getTargetDistance()));this.control.setTarget(t),this.control.update()},getEyePosition:function(){return this.camera.position.clone()},setSightDirection:function(e){e.normalize();var t=this.camera.getLookAt();t.normalize();var r=Math.acos(e.clone().dot(t));if(r){var n=e.clone().cross(t);n.normalize();var s=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(s,this.control.orientation.clone());var a=this.getEyePosition().add(e.clone().multiplyScalar(this.getTargetDistance()));this.control.setTarget(a)}this.control.update()},getSightDirection:function(){return this.camera.getLookAt()},setUpDirection:function(e){e.normalize();var t=this.camera.up.clone(),r=Math.acos(e.dot(t));if(r){var n=e.clone().cross(t);n.normalize();var s=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(s,this.control.orientation.clone())}this.control.update()},getUpDirection:function(){return this.camera.up.clone()},setAngle:function(e){this.camera.fov=(360+e)%360,this.camera._hasChanged=!0,this.control.update()},getAngle:function(){return this.camera.fov},setTarget:function(e){var t=this.getEyePosition(),r=e.clone().sub(t).normalize(),n=Math.acos(r.dot(this.getSightDirection()));if(n){var s=r.clone().cross(this.getSightDirection()).normalize(),a=(new i.Quaternion).setFromAxisAngle(s,-n);this.getControl().orientation.multiplyQuaternions(a,this.control.orientation.clone())}this.getControl().setTarget(e),this.getControl().distanceToTarget=e.distanceTo(t),this.control.update()},getTarget:function(){return this.target.clone()},setTargetDistance:function(e){var t=this.getEyePosition().add(this.getSightDirection().multiplyScalar(e));this.control.setTarget(t),this.control.distanceToTarget=e,this.projectionType===g.ORTHOGRAPHIC&&this.camera.setVisualizedHeight(e),this.control.update()},getTargetDistance:function(){return this.getControl().distanceToTarget},setProjectionType:function(e){if((!this._2DMode||1===e)&&e!==this.projectionType){if(this.projectionType=e,!this.cameraOther){var t=this.camera.near,r=this.camera.far;e===g.PERSPECTIVE?this.cameraOther=new i.PerspectiveCamera(this.camera.fov,this.camera.aspect,t,r,this.useWebGPU):this.cameraOther=new i.OrthographicCamera(0,0,0,0,t,r,this.useWebGPU),this.cameraOther._renderingRole=this.camera._renderingRole,this.cameraOther._viewpoint=this}this.cameraOther.position=this.camera.position,this.cameraOther.fov=this.camera.fov,this.cameraOther.aspect=this.camera.aspect,this.cameraOther.pixelCulling=this.camera.pixelCulling,this.camera.fullWidth&&this.cameraOther.setViewOffsetInternal(this.camera.fullWidth,this.camera.fullHeight,this.camera.x,this.camera.y,this.camera.width,this.camera.height);var n=this.camera;this.camera=this.cameraOther,this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._setRobotConnectedRenderingRoleFromPrincipal(this.camera),this.connectedRobotCamera._viewpoint=this,this.cameraOther=n,this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera._hasChanged=!0,this.control.camera=this.camera,this.control.update(),this.viewer.render()}},getProjectionType:function(){return this.projectionType},_setIntraOccularDistance:function(e){},setPixelCulling:function(e,t){this.viewer&&this.viewer.setPixelCulling(e,t)},_setPixelCulling:function(e){this.camera.pixelCulling=e},_setApplicationDefaultController:function(){if(null===this.control)return;let e="3dexperience",t="catia",i="solidworks",r="COMBINED",n="CATIA",s="SWX";this._mePreferenceSetting=null;let a=this;this._mePreferenceToken&&d.unsubscribe(this._mePreferenceToken),this._mePreferenceToken=d.subscribe(d.PREFERENCES.NAVIGATIONMODE,(function(o){o&&o.toLowerCase&&((o=o.toLowerCase())==e?(a._mePreferenceSetting=r,a._2DMode||a.setDefaultController(!0,r)):o==t?(a._mePreferenceSetting=n,a._2DMode||a.setDefaultController(!0,n)):o==i&&(a._mePreferenceSetting=s,a._2DMode||a.setDefaultController(!0,s)))}))},_setApplicationDefaultController_old:function(e){if(null===this.control)return;var t=this,i=function(){};let r="3dexperience",n="catia",s="solidworks",a="COMBINED",o="CATIA",l="SWX";if(this._mePreferenceSetting=null,window.widget&&window.widget.getValue("x3dPlatformId")){var h=function(e){e&&e.toLowerCase&&((e=e.toLowerCase())==r?(t._mePreferenceSetting=a,t._2DMode||t.setDefaultController(!0,a)):e==n?(t._mePreferenceSetting=o,t._2DMode||t.setDefaultController(!0,o)):e==s&&(t._mePreferenceSetting=l,t._2DMode||t.setDefaultController(!0,l)))};if(require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(e){var t=window.widget,r=function(e){if(e&&e.repositories){var t=e.repositories[0].preferences[0].value;h(t)}};e.getServiceUrl({serviceName:"mepreferences",platformId:t.getValue("x3dPlatformId"),onComplete:function(e){if(void 0!==e){e[0].url&&(e=e[0].url);var t=e+"/api/v1/preferences";u.authenticatedRequest(t,{method:"POST",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferenceNames:["SWNavigationMode"]}]}),headers:{"Content-Type":"application/json"},onComplete:r,onFailure:i})}},onFailure:i})})),!e){require(["DS/PlatformAPI/PlatformAPI"],(function(e){e.subscribe("com.ds.mep:onPrefUpdate",(function(e,t){if(e){let t=e[2].tenantId,i=JSON.parse(e[1].preferences).repositories;if(t&&t!=window.widget.getValue("x3dPlatformId"))return;let r=null,n=null;if(i){for(let e=0;e<i.length;e++)if("VisualizationRepository"==i[e].name){i[e].preferences.length&&(r=i[e].preferences);break}if(r)for(let e=0;e<r.length;e++)if("SWNavigationMode"==r[e].name){n=r[e].value;break}h(n)}}}))}))}}},getDefaultController:function(){return this.control?this._currentDefaultController:null},setDefaultController:function(e,t,i){if(!this._forcedController||t==this._forcedController){var r={SIMPLE:a.Mode.SIMPLE,CATIA:a.Mode.CATIA,COMBINED:a.Mode.COMBINED,LOOKAROUND:a.Mode.LOOKAROUND};if(e||null!==this.control)if("FLY_WALK"===t&&this.control)this.control.setForceFlyWalkState(!e);else{if(e){let e=null;var n=!1;if(null==this.control&&(this.control=new a(this,this.viewer.canvas),e="COMBINED",n=!0),"SWX"==t||localStorage.getItem("forceSWXControls")&&"true"===localStorage.getItem("forceSWXControls")){if(null==this._SWXCoreViewManipulation){var s=this;require(["DS/SWXCoreManipulation/SWXCoreViewManipulation"],(function(e){if(null==s._SWXCoreViewManipulation){let t={viewer:s.viewer};s._SWXCoreViewManipulation=new e,s._SWXCoreViewManipulation.setup(t),s._SWXCoreViewManipulation.enable(),s._SWXCoreViewManipulation.enableViewerCallbacks=!0}else s._SWXCoreViewManipulation.enable();i&&i()}))}else this._SWXCoreViewManipulation.enable(),i&&i();e="SWX"}else void 0!==t&&(null!=r[t]&&(e=t),this._SWXCoreViewManipulation&&this._SWXCoreViewManipulation.disable(),this.control.setMode(r[t]));if(null!=e&&(this._currentDefaultController=e),!n)return;this.control.rotateSpeed=1,this.control.lockZRotationSpeed=.002,this.control.zoomSpeed=5,this.control.panSpeed=1.1}else null!==this.control&&this.control.detachEvents(),this.control=null;this.resetCameraOrientation()}}},setControlActive:function(e){null!==this.control&&this.control.setActive(e)},addDivToManipulation:function(e){return!!this.control&&this.control.addViewToManipulation(e)},removeDivToManipulation:function(e){return!!this.control&&this.control.removeViewFromManipulation(e)},onReframe:function(e){this._customReframeCB=e},onCenterCamera:function(e){this._customCenterCameraCB=e},_setFocusMode:function(e){this._focusMode=e},__rotatedFocusMoveTo:function(e){e.sight=e.sightDirection,e.position=e.eyePosition;var a,o,l,h;if(l=e.distanceToTarget,e.orientation)h=e.orientation,(m=new i.Vector3(0,0,-1)).applyQuaternion(h),m.normalize(),a=m;else if(e.sight){a=e.sight.clone().normalize();var c=this.camera.getLookAt().clone().normalize(),d=Math.acos(a.dot(c));if(d){var u=a.clone().cross(c).normalize(),p=(new i.Quaternion).setFromAxisAngle(u,-d);h=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else h=this.control.orientation.clone(),a=c}var f={position:o=e.position,target:v=(new i.Vector3).addVectors(o,a.clone().multiplyScalar(l)),distanceToTarget:l,orientation:h,duration:e.duration||0};this._viewpointAnimation&&this._viewpointAnimation.stop();var g={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===f.duration){var m;t.publish({event:"/VISU/",data:g}),(m=new i.Vector3(0,0,-1)).applyQuaternion(f.orientation),m.normalize();var v=(new i.Vector3).addVectors(this.control.position,m.multiplyScalar(f.distanceToTarget));this.control.setTarget(v),this.control.orientation=f.orientation.clone(),this.control.distanceToTarget=f.distanceToTarget,this.control.update();var _={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:_})}else{var y=new s({orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{orientation:f.orientation,distanceToTarget:f.distanceToTarget},f.duration);y.setInterpolator((function(e,t,r){var n={},s=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,s,e),n.orientation=s,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n})),this.updateAnimation=function(e){if(this.control){var t=new i.Vector3(0,0,-1);t.applyQuaternion(e.orientation),t.normalize();var r=(new i.Vector3).addVectors(this.control.position,t.multiplyScalar(e.distanceToTarget));this.control.setTarget(r),this.control.orientation=e.orientation.clone(),this.control.distanceToTarget=e.distanceToTarget,this.control.update()}};var S=this;this._viewpointAnimation=new n(this,"updateAnimation",y,(function(e){if(e===r.State.STOPPED){var i={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:S,cameraEye:S.camera.position,cameraUp:S.camera.up};t.publish({event:"/VISU/",data:i})}})),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:g})}},NativeZoomTypes:{MillimeterScreenBased:"MillimeterScreenBased",HalfWindowHeightBased:"HalfWindowHeightBased",HalfWindowWidthAndHeightBased:"HalfWindowWidthAndHeightBased"},setNative2DZoomType:function(e,t){this._nativeZoomType=e,this._nativeZoomRatio=t},setNative2DClip:function(e,t,r){this._clip=e,this._bottomleftClip=new i.Vector2(t[0],t[1]),this._toprightClip=new i.Vector2(r[0],r[1])},setNative2DTranslationBounds:function(e,t){this._XMaxTranslationBound=e[1],this._XMinTranslationBound=e[0],this._YMaxTranslationBound=t[1],this._YMinTranslationBound=t[0]},setNative2DAnchor:function(e){this._anchor=e},setNative2DDepthMode:function(e){let t=this._depthMode!==e;return this._depthMode=e,t},setNative2DZoomLimits:function(e,t){this._nativeMinZoom=e,this._nativeMaxZoom=t},isNative2D:function(){return null!=this._nativeZoomType},getScaleFactor:function(){if(this.isNative2D()){let e=1/this.getMMInSupportUnit(),t=1;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:t=e/this._nativeZoom;break;case this.NativeZoomTypes.HalfWindowHeightBased:case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:t=2/(this._nativeZoom*this.viewer.SCREEN_HEIGHT)}return t}return Math.tan(this.camera.fov/2*(Math.PI/180))/(this.viewer.SCREEN_HEIGHT/2)/this._nativeZoom},getPixelFromModelRatio:function(){return this.isNative2D()?this.getScaleFactor():1},_native2DModelFromPixel:function(e,t,i,r,n,s){let a,o,l=1*s,h=1/n,c=this._nativeZoom*this._nativeZoomRatio/l,d=this._nativeZoom;if(this._clip<=1){switch(3&this._anchor){case 0:a=i/2;break;case 1:a=0;break;case 2:a=i}switch(12&this._anchor){case 0:o=r/2;break;case 4:o=0;break;case 8:o=r}}else{switch(3&this._anchor){case 0:a=.5*(this._bottomleftClip.x+this._toprightClip.x);break;case 1:a=this._bottomleftClip.x;break;case 2:a=this._toprightClip.x}switch(12&this._anchor){case 0:o=.5*(this._bottomleftClip.y+this._toprightClip.y);break;case 4:o=this._toprightClip.y;break;case 8:o=this._bottomleftClip.y}}let u=0,p=0;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:u=this.camera.position.x+h/c*(e-a),p=this.camera.position.y+h/d*(o-t);break;case this.NativeZoomTypes.HalfWindowHeightBased:u=this.camera.position.x+1/c*(e-a)/(r/2),p=this.camera.position.y+1/d*(o-t)/(r/2);break;case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:u=this.camera.position.x+1/c*(e-a)/(i/2),p=this.camera.position.y+1/d*(o-t)/(r/2)}return[u,p]},_native2DViewportBounds:function(e,t,i,r){let[n,s]=this._native2DModelFromPixel(0,0,e,t,i,r),[a,o]=this._native2DModelFromPixel(e,t,e,t,i,r),l=this.getEyePosition();if(a-n>this._XMaxTranslationBound-this._XMinTranslationBound){let e=l.x;switch(3&this._anchor){case 0:l.x=(this._XMinTranslationBound+this._XMaxTranslationBound)/2;break;case 1:l.x=this._XMinTranslationBound;break;case 2:l.x=this._XMaxTranslationBound}n+=l.x-e,a+=l.x-e}else this._XMinTranslationBound>n?(l.x+=this._XMinTranslationBound-n,a+=this._XMinTranslationBound-n,n+=this._XMinTranslationBound-n):this._XMaxTranslationBound<a&&(l.x+=this._XMaxTranslationBound-a,n+=this._XMaxTranslationBound-a,a+=this._XMaxTranslationBound-a);if(s-o>this._YMaxTranslationBound-this._YMinTranslationBound){let e=l.y;switch(12&this._anchor){case 0:l.y=(this._YMinTranslationBound+this._YMaxTranslationBound)/2;break;case 4:l.y=this._YMaxTranslationBound;break;case 8:l.y=this._YMinTranslationBound}o+=l.y-e,s+=l.y-e}else this._YMinTranslationBound>o?(l.y+=this._YMinTranslationBound-o,s+=this._YMinTranslationBound-o,o+=this._YMinTranslationBound-o):this._YMaxTranslationBound<s&&(l.y+=this._YMaxTranslationBound-s,o+=this._YMaxTranslationBound-s,s+=this._YMaxTranslationBound-s);return n-=l.x,a-=l.x,o-=l.y,s-=l.y,[n,a,s,o,l]},getMMInSupportUnit:function(){return i.getPixelsPerMM()},updateNative2D(){let e=this.getMMInSupportUnit(),[t,i,r,n,s]=this._native2DViewportBounds(this.viewer.SCREEN_WIDTH,this.viewer.SCREEN_HEIGHT,e,1);return this.camera.setViewportInfos(r,n,t,i),s},moveTo:function(e){var a,o,l,h,c,d;if(e.up||e.sight||e.position?console.log("DEPRECATED Naming: options.up => options.upDirection, options.sight => options.sightDirection, options.position => options.eyePosition."):(e.up=e.upDirection,e.sight=e.sightDirection,e.position=e.eyePosition),h=e.distanceToTarget||this.control.distanceToTarget,e.orientation)d=e.orientation,(v=new i.Vector3(0,1,0)).applyQuaternion(d),v.normalize(),a=v,(_=new i.Vector3(0,0,-1)).applyQuaternion(d),_.normalize(),o=_;else if(e.up&&e.sight)a=e.up.clone().normalize(),o=e.sight.clone().normalize();else if(e.up){a=e.up.clone().normalize();var u=this.camera.up.clone().normalize();if(g=Math.acos(a.dot(u))){var p=a.clone().cross(u).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-g);o=this.camera.getLookAt().clone().applyQuaternion(f).normalize(),d=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else d=this.control.orientation.clone(),a=u,o=this.camera.getLookAt().clone().normalize()}else if(e.sight){o=e.sight.clone().normalize();var g,m=this.camera.getLookAt().clone().normalize();if(g=Math.acos(o.dot(m))){p=o.clone().cross(m).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-g);a=this.camera.up.clone().applyQuaternion(f).normalize(),d=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else d=this.control.orientation.clone(),o=m,a=this.camera.up.clone().normalize()}else{var v,_;d=this.control.orientation.clone(),(v=new i.Vector3(0,1,0)).applyQuaternion(this.control.orientation),v.normalize(),a=v,(_=new i.Vector3(0,0,-1)).applyQuaternion(this.control.orientation),_.normalize(),o=_}if(e.position?(l=e.position,c=(new i.Vector3).addVectors(l,o.clone().multiplyScalar(h))):(l=(new i.Vector3).subVectors(this.control.target,o.clone().multiplyScalar(h)),c=this.control.target.clone()),!(Math.abs(l.x-this.camera.position.x)>1e-4||Math.abs(l.y-this.camera.position.y)>1e-4||Math.abs(l.z-this.camera.position.z)>1e-4)||!this.viewer.get360Mode()||this.getUnlockMoveIn360Mode()){if(!d){d=new i.Quaternion;var y=new i.Matrix4;y.lookAt(l,c,a),d.setFromRotationMatrix(y)}if(e.ratioOffset||e.ratioSize){h/=Math.max(.01,Math.min(e.ratioSize.x,e.ratioSize.y));var S=Math.tan(i.Math.degToRad(.5*this.camera.fov))*h,b=S*this.camera.aspect,x=new i.Vector2(b,S);x.x*=-(1-Math.max(.01,e.ratioSize.x)),x.y*=-(1-Math.max(.01,e.ratioSize.y));var w=new i.Vector2(2*b,2*S);w.x*=e.ratioOffset.x,w.y*=e.ratioOffset.y,w.add(x);var P=(new i.Vector3).crossVectors(a,o);c.add(a.multiplyScalar(w.y)),c.add(P.multiplyScalar(w.x)),e.interpolationType&&(l=(new i.Vector3).subVectors(c,o.clone().multiplyScalar(h)))}var C=e.fov||null,M={position:l,target:c,distanceToTarget:h,orientation:d,duration:e.duration||0,fov:C};this._viewpointAnimation&&this._viewpointAnimation.stop();var E={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===M.duration){t.publish({event:"/VISU/",data:E}),M.fov&&this.setAngle(M.fov),this.control.setTarget(M.target),this.control.orientation=M.orientation,this.control.distanceToTarget=M.distanceToTarget,this.control.update();var T={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:T}),e.onEndCB&&e.onEndCB(this)}else{var A=new s({position:this.control.position.clone(),target:this.control.target.clone(),orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget,fov:M.fov?this.getAngle():M.fov},{position:M.position,target:M.target,orientation:M.orientation,distanceToTarget:M.distanceToTarget,fov:M.fov},M.duration);A.setInterpolator((function(e,t,r){var n={},s=t.position.clone();s.lerp(r.position,e),n.position=s;var a=t.target.clone();a.lerp(r.target,e),n.target=a;var o=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,o,e),n.orientation=o,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n.fov=t.fov!=r.fov?t.fov+(r.fov-t.fov)*e:t.fov,n})),e.interpolationType?this.updateAnimation=function(t){if(this.control){t.fov&&this.setAngle(t.fov),this.control.position=t.position.clone();var r=new i.Vector3(0,0,-1);r.applyQuaternion(t.orientation),r.normalize();var n=(new i.Vector3).addVectors(t.position,r.multiplyScalar(t.distanceToTarget));this.control.setTarget(n),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(D)}}:this.updateAnimation=function(t){this.control&&(t.fov&&this.setAngle(t.fov),this.control.setTarget(t.target),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(D))};var D=this;this._viewpointAnimation=new n(this,"updateAnimation",A,(function(i){if(i===r.State.STOPPED){var n={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:D,cameraEye:D.camera.position,cameraUp:D.camera.up};t.publish({event:"/VISU/",data:n}),e.onEndCB&&e.onEndCB(D)}})),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:E})}}},contextAwareMoveTo:function(e,t){t&&t.allow360&&this.viewer.get360Mode()&&this.viewer._viewer360Manager?this.viewer._viewer360Manager.moveTo(e,t):this.moveTo(e)},onMove:function(e){if(this.control)return this.control.onMove(e)},unsubscribe:function(e){this.control&&this.control.unsubscribe(e)},isMoving:function(){return this._isMoving},_isAnimated:function(){var e=!!this._viewpointAnimation&&this._viewpointAnimation.state()===r.State.RUNNING;return e=e||this.control&&this.control._wheelMoving},resize:function(e,t){this.robotCameraOrtho&&this.camera&&this.robotCameraOrtho.setVisualizedHeight(400,void 0,this.camera.fov),null!==this.control&&this.control._resize(e,t)},setSceneGraph:function(e){h.DEPRECATED_SceneGraph(new Error),e instanceof o&&(this.sceneGraph=e)},_setInternalSceneGraph(e){e?(this._setNode(e.root),this._internalSceneGraph=e):(this._internalSceneGraph=null,this._setNode(null))},_setNode:function(e){this.sceneGraphRoot=e},_lockController:function(e){this._forcedController=e?this._currentDefaultController:null},_set2DMode:function(e,t){var r=this._2DMode!=e;if(this._2DMode=e,e){if(this.setSightDirection(new i.Vector3(0,0,-1)),this.setUpDirection(new i.Vector3(0,1,0)),this.setProjectionType(1),this.control){var n=null,s=!1;"CATIA"!=t&&"COMBINED"!=t&&"SWX"!=t||(n=t,this._forcedController?this._lockController(!1):this._2DModePreviousController=this._currentDefaultController,s=!0),"SWX"!=this._currentDefaultController||n||(n="COMBINED"),n&&this.setDefaultController(!0,n),this._lockController(s),this.control._2DMode=!0,this.control.setMouseRotationActive(!1),this.control.setTouchRotationActive(!1)}}else this._lockController(!1),r&&(this._mePreferenceSetting||this._2DModePreviousController)&&this.setDefaultController(!0,this._mePreferenceSetting||this._2DModePreviousController),this._2DModePreviousController=null,this.control._2DMode=!1,this.control.setMouseRotationActive(!0),this.control.setTouchRotationActive(!0)},resetCameraOrientation:function(){var e,t,r,n;if(!this._2DMode)if(t=new i.Quaternion,(n=this._worldOrientation.getMatrixForSideRotation("iso"))?t.setFromRotationMatrix(n):this._worldOrientation===c.ZUpYRight?(e=new i.Vector3(.35*Math.PI,0,.75*Math.PI),t.setFromEuler(e,this._worldOrientation._eulerOrderForReframe)):t.set(-.21567539362612123,.37210985866635193,.08933567311009524,.8983526674850427),r=1.1*100/Math.tan(22.5*Math.PI/180),null!==this.sceneGraphRoot&&(r=1.1*this.getBoundingSphere().radius/Math.tan(22.5*Math.PI/180)),this.camera.position=new i.Vector3(r,r,r).multiplyScalar(1/Math.sqrt(3)),null===this.control)this.camera.quaternion=t,this.camera.useQuaternion=!0,this.camera.updateMatrix();else{this.control.orientation=t;var s=new i.Vector3(0,0,-1);s.applyQuaternion(t),s.normalize(),this.moveTo({orientation:t,eyePosition:s.clone().multiplyScalar(-r),distanceToTarget:r,duration:0})}},_complyWithZoom:function(e){if(e.distanceToTarget&&e.target&&e.orientation){if(this.projectionType==g.PERSPECTIVE&&this.control._zoomType==a.ZoomType.ZOOM_FOV_CHANGE){var t=this.getBoundingSphere(),r=new i.Vector3(0,0,-1);r.applyQuaternion(e.orientation),r.normalize();let a=(new i.Vector3).addVectors(e.target,r.clone().multiplyScalar(-e.distanceToTarget));var n=r.dot(t.center.clone().sub(a)),s=2*t.radius;if(n<s){var o=s-n,l=Math.tan(i.Math.degToRad(.5*this.getAngle())),h=i.Math.radToDeg(Math.atan(l*Math.abs(n)/s));h<=22.5&&h>0&&(e.fov=h),e.distanceToTarget+=o}}}else console.warn("_complyWith zoom not implemented for exotic cases")},reframe:function(e,t,r,n,s){if(this.sceneGraphRoot&&null!==this.control)if(this.viewer._viewpointManager&&this.viewer._viewpointManager.isA2X()&&null===e)this.viewer._viewpointManager.onA2XViewSectionCommand("VisuReframeViewAction");else{var a=null,o=null,l=null,h=null;if(n&&("string"==typeof n?o=n:(o=n.reframeSpace,s=n.radiusIfEmpty,l=n.targetBoundingBox,a=n.use360Reframe,h=n.useZoomLimitations)),!o&&this.viewer&&(o=this.viewer.visibleSpace?"visibleSpace":"invisibleSpace"),this.viewer.get360Mode())this.viewer._viewer360Manager&&this.viewer._viewer360Manager.reframeIn360(e,t,r,o,a);else if(this._customReframeCB)this._customReframeCB(e,t,r,o);else{var c,d,u;if(d=void 0!==t?t:this.defaultReframeTime,l)if(this._2DMode){var p=new i.Box2(new i.Vector2(l.min.x,l.min.y),new i.Vector2(l.max.x,l.max.y));u=this._buildReframeTarget2DFromBBox(p)}else u=this._buildReframeTargetFromBBox(l);else r||!this._2DMode?(void 0!==r&&r instanceof i.Mesh?(c=r.boundingSphere.clone()).applyMatrix4(r.matrixWorld):c=void 0!==r&&r instanceof i.Sphere&&!r.isNaN()?r.clone():this.getBoundingSphere(o,s),u=this._buildReframeTarget(c,e)):u=this._buildReframeTarget2D(o);if(u){var f=new i.Vector3(0,0,-1);f.applyQuaternion(u.orientation),f.normalize(),h&&this._complyWithZoom(u);let e=(new i.Vector3).addVectors(u.target,f.clone().multiplyScalar(-u.distanceToTarget));this.moveTo({orientation:u.orientation,eyePosition:e,distanceToTarget:u.distanceToTarget,fov:u.fov,duration:d}),this.control&&this.control.updateCameraToTargetDist(u.target,u.distanceToTarget)}}}},reframeOn:function(e,t,r){r=r||{};var n=new i.Matrix4,s=l.getOrientedBoundingBoxFromPathElements(t,n,this.viewer,!!r.withInternalSceneGraph),a=s.localBBox,o=Math.sqrt(Math.pow(a.min.x-a.max.x,2)+Math.pow(a.min.z-a.max.z,2)+Math.pow(a.min.y-a.max.y,2))/2,h=s.cornerPoint,c=(new i.Vector3).add(h).add(s.firstAxis).add(s.secondAxis).add(s.thirdAxis),d=(new i.Vector3).add(h).add(c);d.divideScalar(2),isNaN(o)||isNaN(d.x)||isNaN(d.y)||isNaN(d.z)?this._reframeOnWarningCount<10&&(console.warn("reframeOn: no usable path for reframe"),this._reframeOnWarningCount++):this.reframe(void 0,e,new i.Sphere(d,o),r)},_reframeOnWarningCount:0,_buildReframeTargetFromBBox:function(e){e.empty()&&e.set(new i.Vector2(-100,-100,-100),new i.Vector2(100,100,100));var t=new i.Vector3((e.min.x+e.max.x)/2,(e.min.y+e.max.y)/2,(e.min.z+e.max.z)/2);let r=0;this.projectionType===g.PERSPECTIVE&&(r=(e.max.z-e.min.z)/2),t.applyMatrix4(this.camera.matrixWorld);var n=this.camera.aspect,s=.5/Math.tan(this.camera.fov*Math.PI/360),a=s*(e.max.x-e.min.x)/n,o=s*(e.max.y-e.min.y),l=Math.max(a,o)+r;return{target:t,orientation:this.control.orientation.clone(),distanceToTarget:l}},_buildReframeTarget2DFromBBox:function(e){var t,r,n,s;e.empty()&&e.set(new i.Vector2(-100,-100),new i.Vector2(100,100)),t=new i.Vector3((e.min.x+e.max.x)/2,(e.min.y+e.max.y)/2,0);var a=this.camera.aspect,o=.5/Math.tan(this.camera.fov*Math.PI/360);return n=o*(e.max.x-e.min.x)/a,s=o*(e.max.y-e.min.y),r=Math.max(n,s),{target:t,orientation:new i.Quaternion,distanceToTarget:r}},_buildReframeTarget2D:function(e){var t=this.getBoundingBox2D(e);return this._buildReframeTarget2DFromBBox(t)},_buildReframeTarget:function(e,t){var r,n,s,a,o=null,l=null;if(e||boundingBox2D){if(n=this.target.clone(),r=this.control.orientation.clone(),s=this.control.distanceToTarget,null==t||this._2DMode){var h=Math.max(this.viewer._getDivClientHeight()/this.viewer._getDivClientWidth(),1);s=1.1*e.radius*h/Math.tan(this.camera.fov*Math.PI/360),n=e.center.clone()}else a=this._worldOrientation.getAxisForSideRotation(t),l=this._worldOrientation.getMatrixForSideRotation(t);if(l)(r=new i.Quaternion).setFromRotationMatrix(l);else if(a){var c=this._worldOrientation._eulerOrderForReframe;(r=new i.Quaternion).setFromEuler(a,c)}o={target:n,orientation:r,distanceToTarget:s}}return o},centerCamera:function(e){if(null!==this.control)if(this._customCenterCameraCB)this._customCenterCameraCB(e);else if(null!==e){var t=e.clone(),r=this.control.orientation.clone(),n=this.control.distanceToTarget;if(this.viewer.__useNewCenterCameraBehaviour&&this.projectionType!==g.PERSPECTIVE||(n=t.distanceTo(this.camera.position)),this._focusMode===g._FOCUS_MODE.TRANSLATION){var s=new i.Vector3(0,0,-1);s.applyQuaternion(r),s.normalize();var a=this.viewer.ODTMode,o=(new i.Vector3).addVectors(t.clone(),s.clone().multiplyScalar(-n));this.moveTo({eyePosition:o,distanceToTarget:n,duration:a?0:200}),this.control&&this.control.updateCameraToTargetDist(o,n)}else if(this._focusMode===g._FOCUS_MODE.ROTATION){var l=(new i.Vector3).subVectors(t,this.control.position).normalize();a=this.viewer.ODTMode;if(this.control.lockZ||i.mobileVersion){var h=this.camera.getLookAt().clone().normalize(),c=null,d=Math.acos(l.dot(h));if(d){var u=l.clone().cross(h).normalize(),p=(new i.Quaternion).setFromAxisAngle(u,-d);c=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else c=this.control.orientation.clone(),l=h;var f=c.toEuler();f.y=0,c=(new i.Quaternion).setFromEuler(f,"ZYX"),this.__rotatedFocusMoveTo({eyePosition:this.control.position,orientation:c,distanceToTarget:n,duration:a?0:200})}else this.__rotatedFocusMoveTo({eyePosition:this.control.position,sightDirection:l,distanceToTarget:n,duration:a?0:200})}}},centerCameraSVG:function(e,t){this.control.update();var r,n,s,a=e.x-t.x,o=e.y-t.y;if(0!==a||0!==o){r=(new i.Vector3).copy(this.camera.position).sub(this.target),n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight(),(s=new i.Vector3).add(r.clone().cross(this.camera.up).setLength(n*a)),s.add(this.camera.up.clone().setLength(n*o));var l=this.viewer.ODTMode,h=this.camera.position.clone().add(s);this.moveTo({eyePosition:h,duration:l?0:200})}},pan:function(e){if(null!==this.control){var t,r,n=new i.Vector3;switch(e){case"left":n.x=-1;break;case"right":default:n.x=1;break;case"top":n.y=1;break;case"bottom":n.y=-1}n.applyQuaternion(this.control.orientation),n.setLength(.05*this.control.distanceToTarget),t=this.target.clone().add(n),this.control.orientation.clone(),r=this.control.distanceToTarget;var s=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),duration:s?0:100})}},zoom:function(e){if(null!==this.control){var t,r,n=.9;"out"===e&&(n=1.1),t=this.target.clone(),this.control.orientation.clone(),r=this.control.distanceToTarget*n;var s=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),distanceToTarget:r,duration:s?0:100})}},rotateCameraForPerfos:function(e,t,r){if(null!==this.control){var s=new function(){var r=new i.Vector3(.35*Math.PI,0,.75*Math.PI);this._orientation=(new i.Quaternion).setFromEuler(r,"ZXY"),this._key1=new i.Quaternion,this._key2=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI/2),this._key3=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI),this._key4=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),3*Math.PI/2),this._nbLoops=void 0!==e?e:5,this._duration=void 0!==t?t:1e4,this.duration=function(){return this._duration},this.valueAt=function(e){var t,r,n,s,a=this._duration/this._nbLoops,o=e%a/a;return o>=0&&o<.25?(t=this._key1,r=this._key2,s=o/.25):o>=.25&&o<.5?(t=this._key2,r=this._key3,s=(o-.25)/.25):o>=.5&&o<.75?(t=this._key3,r=this._key4,s=(o-.5)/.25):(t=this._key4,r=this._key1,s=(o-.75)/.25),n=new i.Quaternion,i.Quaternion.slerp(t,r,n,s),n.multiply(this._orientation)}},a=new n(this.control,"orientation",s);r&&a.setLoop(1),a.start()}},zoomCameraInAndOutForPerfos:function(e,t){if(null!==this.control){this.resetCameraOrientation(),this.reframe(void 0,0);var i=1.2*this.getTargetDistance(),r=new function(){this._duration=void 0!==e?e:3e3,this.duration=function(){return this._duration},this.valueAt=function(t){var r=t%e/e;return(r>=0&&r<.5?r/.5:1-(r-.5)/.5)*i}},s=new n(this.control,"distanceToTarget",r);t&&s.setLoop(1),s.start()}},getBoundingBox2D:function(e){if(!this._2DMode)return null;var t,r=this.viewer||this.sceneGraphRoot._getViewer();if(r.svgRoot){var n=this.viewer.svgRoot.getBBox();t=new i.Box2(new i.Vector2(n.x,-n.y-n.height),new i.Vector2(n.x+n.width,-n.y))}let s=this._internalSceneGraph?this._internalSceneGraph:r?r._safeInternalSceneGraph:null;var a=r?r.getSceneBoundingBox(e,s):this.sceneGraphRoot.getBoundingBox(e),o=new i.Box2(new i.Vector2(a.min.x,a.min.y),new i.Vector2(a.max.x,a.max.y));return t&&o.union(t),o},getBoundingSphere:function(e,t){var r=this.viewer||this.sceneGraphRoot._getViewer();let n=this._internalSceneGraph?this._internalSceneGraph:r?r._safeInternalSceneGraph:null;var s=r?r.getSceneBoundingSphere(e,!0,n):this.sceneGraphRoot.getBoundingSphere(e,!0);return s?0===s.radius&&s.pixelRadius>0?s.radius=void 0!==t?t:s.pixelRadius:0===s.radius&&(s.radius=void 0!==t?t:100):s=new i.Sphere(new i.Vector3,100),s},setViewOffset:function(e,t){var i=this.camera;!function(i,r){if(e){e.camera&&(i=e.camera);var n=e.fullWidth?e.fullWidth:r.SCREEN_WIDTH,s=e.fullHeight?e.fullHeight:r.SCREEN_HEIGHT,a=e.x?e.x:0,o=e.y?e.y:0,l=e.width?e.width:r.SCREEN_WIDTH,h=e.height?e.height:r.SCREEN_HEIGHT;i.setViewOffsetInternal(n,s,a,o,l,h,null,t)}else i.setViewOffsetInternal(0,0,0,0,r.SCREEN_WIDTH,r.SCREEN_HEIGHT,null,t)}(i,this.viewer),i.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(400,void 0,i.fov),this.robotCameraOrtho._setRobotRenderingRoleFromPrincipal(i)},project:function(e,t){var i=t||this.camera,r=e.clone();return p.projectVector(r,i),r.x=.5*this.viewer._getCanvasOffsetWidth()*(r.x+1),r.y=.5*this.viewer._getCanvasOffsetHeight()*(1-r.y),r},unProject:function(e,t){var r=t||this.camera,n=e.x/this.viewer._getCanvasOffsetWidth()*2-1,s=-e.y/this.viewer._getCanvasOffsetHeight()*2+1,a=new i.Vector3(n,s,e.z);return p.unprojectVector(a,r),a},_convertViewportToNDC:function(e){let t=e.x,r=e.y,n=this.viewer.canvas.offsetWidth,s=this.viewer.canvas.offsetHeight;if(this.viewer._viewpointManager){let e=this.viewer._viewpointManager.getViewpointViewport(this);if(e){t-=e.x,r-=this.viewer.canvas.offsetHeight-(e.height+e.y),n=e.width,s=e.height}}return t=t/n*2-1,r=-r/s*2+1,new i.Vector2(t,r)},create3DRayFrom2DPoint:function(e,t){let r=this._convertViewportToNDC(e),n=(t=t||this.camera).getProjectedDepthNear();var s=new i.Vector3(r.x,r.y,n);p.unprojectVector(s,t);var a=new i.Vector3(r.x,r.y,1);p.unprojectVector(a,t);var o=(new i.Vector3).copy(a).sub(s);return o.normalize(),new i.Ray(s,o)},dump:function(){var e="viewpoint.control.target = new THREE.Vector3("+this.control.target.x+", "+this.control.target.y+", "+this.control.target.z+");\nviewpoint.control.orientation = new THREE.Quaternion("+this.control.orientation.x+", "+this.control.orientation.y+", "+this.control.orientation.z+", "+this.control.orientation.w+");\nviewpoint.control.distanceToTarget = "+this.control.distanceToTarget+";";console.log(e)},setFromJSON:function(e){},_setPickingViewOffset:function(e){function t(t,i){if(e.reset)t.setViewOffsetInternal(0,0,0,0,i.SCREEN_WIDTH,i.SCREEN_HEIGHT,{},!0);else{var r=e.fullWidth?e.fullWidth:i.SCREEN_WIDTH,n=e.fullHeight?e.fullHeight:i.SCREEN_HEIGHT,s=e.x?e.x:0,a=e.y?e.y:0,o=e.width?e.width:i.SCREEN_WIDTH,l=e.height?e.height:i.SCREEN_HEIGHT;t.setViewOffsetInternal(r,n,s,a,o,l,{ratioW:e.pickingRatioW,ratioH:e.pickingRatioH},!0)}}e&&e.cameraSet&&(t(e.cameraSet.main,this.viewer),t(e.cameraSet.robotCameraOrtho,this.viewer),t(e.cameraSet.connectedRobotCamera,this.viewer))},_updateRobotCamera:function(e){function t(e,t){var r=(new i.Vector3).subVectors(e.center,t.position),n=t.getLookAt(),s=r.dot(n),a=s+e.radius,o=s-e.radius;return t.isOrtho||(o=Math.max(o,.001*a)),{near:o,far:a}}var r=this.camera;r.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(400,void 0,this.camera.fov),this.robotCameraOrtho.position.set(0,0,0),this.robotCameraOrtho.updateMatrix(),this.robotCameraOrtho.updateMatrixWorld(),this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix),this.robotCameraOrtho._setRobotRenderingRoleFromPrincipal(r),r.clone(this.connectedRobotCamera),this.connectedRobotCamera._setRobotConnectedRenderingRoleFromPrincipal(r);var n,s,a,o,l,h=e.robotRoot;if(h.getMatrixWorld(),(s=h.getBoundingSphere()).pixelRadius>0){var c=this.robotCameraOrtho.getWorldSizeFromPixelSize(1,s.center,this.viewer._getDivClientHeight(),2);s.radius+=c*s.pixelRadius}if(0===s.radius&&(s.radius=10),s){o=t(s,this.robotCameraOrtho),this.robotCameraOrtho.near=o.near,this.robotCameraOrtho.far=o.far,this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);var d=e._robot;if(d)if(!(!d.isConnected||d.isManipulatedInPlane)){if(n=d.getMatrixWorld(),(a=d.getBoundingSphere()).applyMatrix4(n),a.pixelRadius>0){c=this.connectedRobotCamera.getWorldSizeFromPixelSize(1,a.center,this.viewer._getDivClientHeight(),2);a.radius+=c*a.pixelRadius}l=t(a,this.camera),this.connectedRobotCamera.near=Math.min(l.near,r.near),this.connectedRobotCamera.far=Math.max(l.far,r.far),this.connectedRobotCamera.updateProjectionMatrix(),this.connectedRobotCamera.projectionMatrixInverse.getInverse(this.connectedRobotCamera.projectionMatrix)}}},_updateFrustum:function(){var e=this.camera;this._frustum.setFromCameraWithViewMatrix(e)},_setWorldOrientation:function(e){if(e!==this._worldOrientation){var t=this._worldOrientation.upAttribute,r=this._worldOrientation.rightAttribute,n=this._worldOrientation.frontAttribute;this._worldOrientation=e;var s=this._worldOrientation.upAttribute,a=this._worldOrientation.rightAttribute,o=this._worldOrientation.frontAttribute,l=new i.Vector3,h=this.getEyePosition();l[s]=h[t],l[a]=h[r],l[o]=h[n];var c=new i.Vector3,d=this.getUpDirection();c[s]=d[t],c[a]=d[r],c[o]=d[n];var u=new i.Vector3,p=this.getSightDirection();u[s]=p[t],u[a]=p[r],u[o]=p[n],this.moveTo({eyePosition:l,upDirection:c,sightDirection:u})}},getFrustum:function(){return(new i.Frustum).copy(this._frustum)},dispose:function(){this.viewer._viewpointManager&&this.viewer._viewpointManager.unregisterViewpoint(this),this.viewer=null,this._lockController(!1),this._mePreferenceToken&&d.unsubscribe(this._mePreferenceToken),this._SWXCoreViewManipulation&&(this._SWXCoreViewManipulation.disable(),this._SWXCoreViewManipulation=null),this.control&&(this.control.detachEvents(),this.control=null),this._setNode(null)}});return g._FOCUS_MODE={TRANSLATION:0,ROTATION:1},g.PERSPECTIVE=0,g.ORTHOGRAPHIC=1,UWA.namespace("THREEDS/Viewpoint",g)})),define("Visualization/Viewpoint",["DS/Visualization/Viewpoint","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/Viewpoint"),e})),define("DS/Visualization/CollisionServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/ComposerContext","DS/Visualization/Viewpoint","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet","DS/Visualization/InternalSceneGraph"],(function(e,t,i,r,n,s,a,o){"use strict";var l=e.singleton({init:function(){return this.collisionDepthComposers=new Map,this.collisionNormalComposers=new Map,this._clearCurrentData(),this.useDebug=!1,this.renderNormals=!1,this.disableBackFaceCulling=!0,this.skipTransparentItems=!1,this.readPixelPerfs=0,this.readPixelCount=0,this.currentCollision=null,window.__collisionService=this,this._bufferPool=new Map,this},_getBuffer(e,t){let i=e;"float32"==t&&(i*=4),this._bufferPool.has(i)||this._bufferPool.set(i,[]);let r,n=this._bufferPool.get(i);return r=n.length?n.splice(0,1)[0]:new Uint8Array(i),"float32"==t?r=new Float32Array(r.buffer):"uint8"==t&&(r=new Uint8Array(r.buffer)),r},_releaseBuffer(e){let t=e.BYTES_PER_ELEMENT*e.length;this._bufferPool.get(t).push(e)},setViewer:function(e){this.viewer=e,this.gl=this.viewer.getWebGLContext();let t={viewer:this.viewer,defaultController:!1};return this.vp=new r(t),this.vp.camera.pixelCulling=0,t.projectionType=r.ORTHOGRAPHIC,this.vpOrtho=new r(t),this.vpOrtho.camera.pixelCulling=0,this},_clearCurrentData:function(e){if(e){let t=this.data.get(e);t?(t.camera=null,t.frustumInfos=null,t.width=null,t.height=null,t.normalData&&this._releaseBuffer(t.normalData),t.normalData=null,t.depthData&&this._releaseBuffer(t.depthData),t.depthData=null,t.positionData&&this._releaseBuffer(t.positionData),t.positionData=null,t.cameraPositionData=null,t.farthest=null,t.nearest=null,t.depthComposer=null,t.normalComposer=null,t.colliderInfos=null):(t={camera:null,frustumInfos:null,width:null,height:null,normalData:null,depthData:null,positionData:null,farthest:null,nearest:null,depthComposer:null,normalComposer:null,colliderInfos:null},this.data.set(e,t))}else this.data=new Map},setCurrentData:function(e){this.currentData=this.data.get(e)},_setDebugInfos:function(e){this.debugInfos=e},_debug:function(){let e=this.currentData.width,t=this.currentData.height,i=this,r=document.getElementById("normal"),n=null,s=null;if(r){r.width=e,r.height=t,n=r.getContext("2d"),s=n.createImageData(e,t);let a=i.getNormalData();for(let r=0;r<e*t;r++){let n=a[3*r],o=a[3*r+1],l=a[3*r+2],h=i.convertIndexToXY(r),c=h[0]+(t-1-h[1])*e;s.data[4*c+0]=255*n,s.data[4*c+1]=255*o,s.data[4*c+2]=255*l,s.data[4*c+3]=255}n.putImageData(s,0,0)}if(r=document.getElementById("depth"),r){r.width=e,r.height=t,n=r.getContext("2d"),s=n.createImageData(e,t);let a=i.getDepthData();for(let r=0;r<e*t;r++){let n=255*(a[r]+1)/2,o=n,l=n,h=n;if(r==Math.floor(e/2)*t+Math.floor(e/2)&&(l=0,h=0),this.debugInfos)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right,t.near,t.far)){o*=t.color[0],l*=t.color[1],h*=t.color[2];break}if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right)){o*=.5*t.color[0],l*=.5*t.color[1],h*=.5*t.color[2];break}}let c=i.convertIndexToXY(r),d=c[0]+(t-1-c[1])*e;s.data[4*d+0]=o,s.data[4*d+1]=l,s.data[4*d+2]=h,s.data[4*d+3]=255}n.putImageData(s,0,0)}if(r=document.getElementById("position"),r){r.width=e,r.height=t,n=r.getContext("2d"),s=n.createImageData(e,t);let a=i.getPositionData();for(let r=0;r<e*t;r++){let n=a[3*r],o=a[3*r+1],l=a[3*r+2],h=i.convertIndexToXY(r),c=h[0]+(t-1-h[1])*e;s.data[4*c+0]=255*n,s.data[4*c+1]=255*o,s.data[4*c+2]=255*l,s.data[4*c+3]=255}n.putImageData(s,0,0)}},_dlDepthTexture:function(e){let t=this.currentData.width,i=this.currentData.height,r=this;var n=document.createElement("canvas");n.width=t,n.height=i;let s=n.getContext("2d"),a=s.createImageData(t,i),o=r.getDepthData();for(let n=0;n<t*i;n++){let s=255*o[n],l=s,h=s,c=s;if(this.debugInfos&&e)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(n,t.up,t.down,t.left,t.right)){l*=t.color[0],h*=t.color[1],c*=t.color[2];break}}let d=r.convertIndexToXY(n),u=d[0]+(i-1-d[1])*t;a.data[4*u+0]=l,a.data[4*u+1]=h,a.data[4*u+2]=c,a.data[4*u+3]=255}s.putImageData(a,0,0);var l=document.createElement("a");l.download="depth.png",s.canvas.toBlob((function(e){l.href=URL.createObjectURL(e),l.click()}))},_dlPositionTexture:function(e){let t=this.currentData.width,i=this.currentData.height,r=this;var n=document.createElement("canvas");n.width=t,n.height=i;let s=n.getContext("2d"),a=s.createImageData(t,i),o=r.getPositionData();for(let n=0;n<t*i;n++){let s=o[3*n],l=o[3*n+1],h=o[3*n+2];if(this.debugInfos&&e)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(n,t.up,t.down,t.left,t.right)){s*=t.color[0],l*=t.color[1],h*=t.color[2];break}}let c=r.convertIndexToXY(n),d=c[0]+(i-1-c[1])*t;a.data[4*d+0]=s,a.data[4*d+1]=l,a.data[4*d+2]=h,a.data[4*d+3]=255}s.putImageData(a,0,0);var l=document.createElement("a");l.download="depth.png",s.canvas.toBlob((function(e){l.href=URL.createObjectURL(e),l.click()}))},_dlNormalTexture:function(e){let t=this.currentData.width,i=this.currentData.height,r=this;var n=document.createElement("canvas");n.width=t,n.height=i;let s=n.getContext("2d"),a=s.createImageData(t,i),o=r.getNormalData();for(let n=0;n<t*i;n++){let s=255*o[3*n],l=255*o[3*n+1],h=255*o[3*n+2];if(this.debugInfos&&e)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(n,t.up,t.down,t.left,t.right)){s*=t.color[0],l*=t.color[1],h*=t.color[2];break}}let c=r.convertIndexToXY(n),d=c[0]+(i-1-c[1])*t;a.data[4*d+0]=s,a.data[4*d+1]=l,a.data[4*d+2]=h,a.data[4*d+3]=255}s.putImageData(a,0,0);var l=document.createElement("a");l.download="depth.png",s.canvas.toBlob((function(e){l.href=URL.createObjectURL(e),l.click()}))},_getViewpointFromCameraInfos:function(e){if(!e)return this.viewer.currentViewpoint;let i,r=e.near?e.near:this.viewer.currentViewpoint.camera.near,n=e.far?e.far:this.viewer.currentViewpoint.camera.far;if(e.camera)i=this.vp,i.camera=e.camera,this.currentData.frustumInfos={near:r,far:n};else{let s,a,o,l,h,c;if(e.useOrtho){i=this.vpOrtho,c=e.top?e.top:1,h=e.bottom?e.bottom:1,l=e.right?e.right:1,o=e.left?e.left:1,i.camera.makeProjectionMatrix(o,l,c,h,r,n),s=l-o,a=c-h}else{i=this.vp;let d=e.hfov?e.hfov:this.viewer.currentViewpoint.camera.fov,u=e.vfov?e.vfov:this.viewer.currentViewpoint.camera.fov;c=Math.tan(t.Math.degToRad(.5*u))*r,h=-c,l=Math.tan(t.Math.degToRad(.5*d))*r,o=-l,this.viewer.renderer.renderer.use_webgpu?i.camera.projectionMatrix.makeFrustumWebGPU(o,l,h,c,r,n):i.camera.projectionMatrix.makeFrustum(o,l,h,c,r,n),s=(l-o)*n/r,a=(c-h)*n/r}this.currentData.frustumInfos={left:o,right:l,bottom:h,top:c,near:r,far:n},this.currentData.colliderInfos={farH:s,farV:a},i.camera._renderingRole=t._CameraRoles.NONE;let d=e.position?e.position:this.viewer.currentViewpoint.getEyePosition(),u=e.sight?e.sight:this.viewer.currentViewpoint.getSightDirection(),p=e.up?e.up:this.viewer.currentViewpoint.getUpDirection(),f=i.camera.quaternion,g=i.camera.position,m=new t.Vector3;i.camera.matrix.lookAt(d,(new t.Vector3).addVectors(d,u),p),i.camera.matrix.setPosition(d),i.camera.matrix.decompose(g,f,m)}return i.camera.matrixWorld.copy(i.camera.matrix),i.camera.matrixWorldInverse.getInverse(i.camera.matrixWorld),i.camera.projectionMatrixInverse.getInverse(i.camera.projectionMatrix),i},_buildNormalArray:function(){let e=this.currentData.normalComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let i=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8");this.currentData.normalData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let r=this.currentData.normalData;this.viewer.renderer.renderer.readPixelCustom(0,0,this.currentData.width,this.currentData.height,t.RGBAFormat,t.UnsignedByteType,i);for(let e=0;e<this.currentData.width*this.currentData.height;e++){var n=i[4*e+0]/255*2-1,s=i[4*e+1]/255*2-1,a=i[4*e+2]/255*2-1,o=this.currentData.camera.matrixWorld.elements,l=1/(o[3]*n+o[7]*s+o[11]*a+o[15]);r[3*e]=(o[0]*n+o[4]*s+o[8]*a)*l,r[3*e+1]=(o[1]*n+o[5]*s+o[9]*a)*l,r[3*e+2]=(o[2]*n+o[6]*s+o[10]*a)*l}this._releaseBuffer(i)},_buildDepthArray:function(){let e=this.currentData.depthComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let i=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8"),r=performance.now();this.viewer.renderer.renderer.readPixelCustom(0,0,this.currentData.width,this.currentData.height,t.RGBAFormat,t.UnsignedByteType,i);let n=performance.now()-r;this.readPixelPerfs+=n,this.readPixelCount++,this.currentData.depthData=new Float32Array(i.buffer);let s=this.currentData.depthData,a=1,o=null,l=0,h=null;for(let e=0;e<this.currentData.width*this.currentData.height;e++)s[e]||(s[e]=1),s[e]<a&&(a=s[e],o=e),s[e]>l&&(l=s[e],h=e);this.currentData.farthest={index:h,depth:l},this.currentData.nearest={index:o,depth:a}},_buildPositionArray:function(){let e=this.getDepthData();this.currentData.positionData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let i=this.currentData.positionData;for(let r=0;r<this.currentData.width*this.currentData.height;r++){let n=this.convertIndexToXY(r);n[0]=n[0]/this.currentData.width*2-1,n[1]=n[1]/this.currentData.height*2-1;let s=e[r];this.viewer.renderer.renderer.use_webgpu||(s=2*s-1);let a=new t.Vector4(n[0],n[1],s,1);a.applyMatrix4(this.currentData.camera.projectionMatrixInverse),a.multiplyScalar(1/a.w),a.applyMatrix4(this.currentData.camera.matrixWorld),i[3*r]=a.x,i[3*r+1]=a.y,i[3*r+2]=a.z}},convertIndexToXY:function(e){let t=Math.floor(e/this.currentData.width);return[e-t*this.currentData.width,t]},convertXYToIndex:function(e,t){return t*this.currentData.width+e},computeCollision:function(e){let r=e||{};if(null!=e.near&&null!=e.far&&e.near>=e.far)return void console.warn("CollisionService: incoherent input infos, collision not computed");r.name||(r.name="default"),this._clearCurrentData(r.name),this.setCurrentData(r.name),this.currentData.name=r.name;let n=r.width?r.width:100,s=r.height?r.height:100;this.currentData.cameraPositionData=[];for(let e=0;e<n*s;e++)this.currentData.cameraPositionData[e]=null;let a=this.viewer.renderer;a.renderer.increaseFrameCount(t._FrameTypes.COLLISION);let l=this.collisionDepthComposers.get(r.name);if(!l){var h=new t.WebGLRenderTargetProperties(n,s,"uintNearest");h.generateMipmaps=!1,l=new i(h,a.mainComposer,"depthCollisionComposerContext"),l.setPassClear(a.initClearPass,!0,new t.Color(0),0),a.setupOneMaterialComposerContext(l,0,0,!1),l.enablePass(a.initClearPass,!0),this.collisionDepthComposers.set(r.name,l)}this.currentData.depthComposer=l;let c=this.collisionNormalComposers.get(r.name);if(!c){var d=new t.WebGLRenderTargetProperties(n,s,"uintNearest");d.generateMipmaps=!1,c=new i(d,a.mainComposer,"normalCollisionComposerContext"),c.setPassClear(a.initClearPass,!0,new t.Color(0),1),a.setupOneMaterialComposerContext(c,0,1,!1),c.enablePass(a.initClearPass,!0),this.collisionNormalComposers.set(r.name,c)}this.currentData.normalComposer=c;var u=!!a.compForwardComposerContext.getPassState(a.zPostPass).enabled;l.enablePass(a.zPostPass,u),c.enablePass(a.zPostPass,u),l.setSize(n,s,r.name),c.setSize(n,s,r.name),l.writeBuffer=null,c.writeBuffer=null,l.readBuffer=null,c.readBuffer=null,l.needsUpdate=!0,c.needsUpdate=!0,this.currentData.width=n,this.currentData.height=s;var p=this._getViewpointFromCameraInfos(e);this.currentData.camera=p.camera;let f=this.viewer.internalSceneGraph,g=!1;if(r.renderedNodes){g=!0,f=new o(this.viewer);let e=f.getUserRoot();for(let t=0;t<r.renderedNodes.length;t++)e.addChild(r.renderedNodes[t])}var m=f.scene,v=p.camera,_={main:v,mainNoJittering:v,connectedRobotCamera:p.connectedRobotCamera,robotCameraOrtho:p.robotCameraOrtho};if(this.disableBackFaceCulling){var y=this.viewer.renderer.renderer.disableBackFaceCulling;this.viewer.renderer.renderer.setDisableBackFaceCulling(!0)}this.skipTransparentItems?(l._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,c._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE):(l._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,c._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE),a.renderer._fixedPointSize=1,this.renderNormals&&(a.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),a.mainComposer.updateScene(m),a._updateEffectScenes(m),a.renderer.materialToUse=t.MaterialToUse.normalMaterial,a.renderer.autoClearDepth=!0,a.renderer.autoClearStencil=!0,a.mainComposer.setComposerContext(c),a.mainComposer.render(void 0,void 0,_,r.name),c.needsUpdate=!1),a.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),a.mainComposer.updateScene(m),a._updateEffectScenes(m),a.renderer.materialToUse=t.MaterialToUse.depthMaterial,a.renderer.autoClearDepth=!0,a.renderer.autoClearStencil=!0,a.mainComposer.setComposerContext(l),a.mainComposer.render(void 0,void 0,_,r.name),l.needsUpdate=!1,this.disableBackFaceCulling&&this.viewer.renderer.renderer.setDisableBackFaceCulling(y),a.renderer._fixedPointSize=null,g&&(f.dispose(),f=null),this.useDebug&&this._debug()},getDepthData:function(){return this.currentData.depthData||this._buildDepthArray(),this.currentData.depthData},getNormalData:function(){return this.currentData.normalData||this._buildNormalArray(),this.currentData.normalData},getPositionData:function(){return this.currentData.positionData||this._buildPositionArray(),this.currentData.positionData},get3DpositionAtIndex:function(e){let i=this.getDepthData()[e];this.viewer.renderer.renderer.use_webgpu||(i=2*i-1);let r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(this.currentData.camera.matrixWorld),new t.Vector3(n.x,n.y,n.z)},get3DCameraPositionAtIndex:function(e){let i=this.getDepthData()[e];this.viewer.renderer.renderer.use_webgpu||(i=2*i-1);let r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),new t.Vector3(n.x,n.y,n.z)},getOptimized3DCameraPositionAtIndex:function(e){if(null==this.currentData.cameraPositionData[e]){let i=this.getDepthData()[e],r=this.convertIndexToXY(e),n=this.currentData.colliderInfos.farH,s=this.currentData.colliderInfos.farV,a=r[0]/this.currentData.width-.5;a*=n;let o=r[1]/this.currentData.height-.5;o*=s;let l=Math.min(this.getCameraDepth(i),this.currentData.frustumInfos.far),h=l/this.currentData.frustumInfos.far,c=a*h,d=o*h;this.currentData.cameraPositionData[e]=new t.Vector3(c,d,l)}return this.currentData.cameraPositionData[e]},getFarthest:function(){return this.currentData.farthest||this._buildDepthArray(),this.currentData.farthest},getNearest:function(){return this.currentData.nearest||this._buildDepthArray(),this.currentData.nearest},getCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return t*i/(e*(t-i)+i)},getNoLinearCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return(t*i/e-i)/(t-i)},isDirectCollider:function(e,t,i,r,n){let s=void 0!==r?r:this.currentData.frustumInfos.near,a=void 0!==n?n:this.currentData.frustumInfos.far;return this.isDirectAsymetricCollider(e,t,-t,-i,i,s,a)},isDirectAsymetricCollider:function(e,t,i,r,n,s,a){let o=void 0!==s?s:this.currentData.frustumInfos.near,l=void 0!==a?a:this.currentData.frustumInfos.far;return this.isGenericCollider(e,(function(e){let s=e.x,a=e.y,h=e.z;return s<=n&&s>=r&&a<=t&&a>=i&&h>=o&&h<=l}))},isEdgingCollider:function(e,t,i,r,n,s,a,o){let l=void 0!==s?s:this.currentData.frustumInfos.near;return this.isGenericCollider(e,(function(e){let s=e.x,h=e.y,c=e.z,d=(s-r)/(n-r);return s<=n&&s>=r&&h<=t&&h>=i&&c>=l&&c<=a*(1-d)+o*d}))},isArcingDepthFromTopCollider:function(e,t,i,r,n,s,a){let o=void 0!==s?s:this.currentData.frustumInfos.near,l=void 0!==a?a:this.currentData.frustumInfos.far;return this.isGenericCollider(e,(function(e){let s=e.x,a=e.y,h=e.z;if(s<=n&&s>=r&&a<=t&&a>=i){let e=1-a/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return h>=o&&h<=r}return!1}))},isArcingDepthFromBottomCollider:function(e,t,i,r,n,s,a){let o=void 0!==s?s:this.currentData.frustumInfos.near,l=void 0!==a?a:this.currentData.frustumInfos.far;return this.isGenericCollider(e,(function(e){let s=e.x,a=e.y,h=e.z;if(s<=n&&s>=r&&a<=t&&a>=i){let e=a/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return h>=o&&h<=r}return!1}))},isInsideCylinder:function(e,t){let i=this.currentData.frustumInfos.near;return this.isGenericCollider(e,(function(e){let r=e.x,n=(e.y,e.z);return(n-t-i)*(n-t-i)+r*r<t*t}))},isGenericCollider:function(e,t){return t(this.getOptimized3DCameraPositionAtIndex(e))},getPrecisePositionAtPick_firstImpl(e){var t=this.viewer.currentViewpoint.camera.clone(this.vp.camera),i=null;t.fullWidth&&(i={fullWidth:t.fullWidth,fullHeight:t.fullHeight,x:t.x,y:t.y,width:t.width,height:t.height}),t.useRealSize=!0;var r=Math.round(e.xPix),n=Math.round(e.yPix),s=this.viewer.renderer.renderer.getViewportSize(),a=s.width,o=s.height;if(i){var l,h;l=i.width/i.fullWidth,h=i.height/i.fullHeight;var c=i.fullWidth/a,d=i.fullHeight/o;a=i.fullWidth,o=i.fullHeight,n*=d,r=(r*=c)*l+i.x,n=n*h+i.y,currentPickingToleranceX*=l,currentPickingToleranceY*=h,trapXdist*=l,trapYdist*=h}t.setViewOffsetInternal(a,o,r,n,1,1,{ratioW:1/s.width,ratioH:1/s.height},!0);let u=this.currentData?this.currentData.name:null,p=t.far,f=t.near,g={name:"PreciseDepth",camera:t,near:f,far:p,width:1,height:1};this._setDebugInfos([]),this.computeCollision(g);let m=this.getDepthData()[0],v=this.getCameraDepth(m),_=(this.get3DpositionAtIndex(0),v-f);if(f=v-.001*_,_=p-v,p=v+.001*_,t.near=f,t.far=p,t.updateProjectionMatrix(),g.near=f,g.far=p,this.computeCollision(g),this.getDepthData()[0]==m){this.computeCollision(g);this.getDepthData()[0]}let y=this.get3DpositionAtIndex(0);return u&&this.setCurrentData(u),y},getPrecisePositionAtPick(e,i){var r=Math.round(e.xPix),n=Math.round(e.yPix);let s=this.viewer.renderer.renderer.getViewportSize();var a=this.viewer.currentViewpoint,o=a.camera,l=a.getEyePosition(),h=a.getSightDirection().normalize(),c=a.getUpDirection().normalize(),d=(new t.Vector3).crossVectors(h,c).normalize(),u=a.getAngle()/2;h.multiplyScalar(1/Math.tan(u*Math.PI/180));let p=2*(r/s.width-.5),f=2*(n/s.height-.5);c.multiplyScalar(-f),d.multiplyScalar(p*s.width/s.height),h.addVectors(h,c),h.addVectors(h,d),h.normalize(),c.set(-h.z,h.x,-h.y),d.crossVectors(h,c),c.crossVectors(d,h);let g,m=o.far,v=o.near,_={name:"PreciseDepth2",near:v,far:m,useOrtho:!0,top:.5,bottom:-.5,left:-.5,right:.5,position:l,sight:h,up:c,width:1,height:1},y=this.currentData?this.currentData.name:null;this._setDebugInfos([]),i&&(g=this.renderNormals,this.renderNormals=!0),this.computeCollision(_),i&&(this.renderNormals=g);let S=1*Math.floor(.5)+Math.floor(.5),b=this.getDepthData()[S],x=null;if(1!=b){i&&(i.x=this.getNormalData()[3*S],i.y=this.getNormalData()[3*S+1],i.z=this.getNormalData()[3*S+2]);x=this.get3DpositionAtIndex(S)}return y&&this.setCurrentData(y),x}});return UWA.namespace("THREEDS/Collision",l)})),define("DS/Visualization/CGRNode",["UWA/Class","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/PathElement","DS/Selection/HSOManager"],(function(e,t,i,r,n,s,a,o){"use strict";var l=function(e,t,i){var r,s=e.children?e.children.length:0,a=e._primitives?e.getPrimitivesCount():0;for(t(e,i),r=0;r<s;r++)l(e.children[r],t,i);if(a)for(r=0;r<a;r++){var o=new n.SGPrimitiveHelper;o.set(e,r),t(o,i)}},h=function(e,t,i){var r,s,a=e.children?e.children.length:0,o=e._primitives?e.getPrimitivesCount():0;if((s=t(e,i)).stop)s.stop=!1;else{for(r=0;r<a;r++)h(e.children[r],t,s);if(o){for(r=0;r<o;r++){var l=new n.SGPrimitiveHelper;l.set(e,r),s=t(l,s),i.index&&i.index--}return}}i.index&&i.index--},c=function(e,t,i){var r=t(e,i);if(!r&&e.type<=i.nodeType)for(var n=e.children,s=n?n.length:0,a=0;a<s;a++)r=c(n[a],t,i);return r},d=function(e,t){(e.getCgmId?e.getCgmId():e.cgmId)==t.cgmId&&t.results.nodes.push(e)},u=function(e,t){var i=!1,r=!0,s=e.getCgmId?e.getCgmId():e.cgmId;if(s==t.path[t.index]?(t.index==t.path.length-1&&t.results.nodes.push(e),r=!1):0==s&&(i=!0,r=!1),!r){var a=e.children;e._primitives&&(a=function(e){for(var t=[],i=0;i<e.getPrimitivesCount();i++){var r=new n.SGPrimitiveHelper;r.set(e,i),t.push(r)}return t}(e)),i||t.index++;for(var o=a?a.length:0,l=0;l<o;l++)u(a[l],t);i||t.index--}},p=r.extend({init:function(e,t,i){return this._parent(t),this.internalSceneGraph=e,this.sag=i,this},setInternalSceneGraph:function(e){this.internalSceneGraph=e},getSag:function(){return this.sag},setHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var s=o,l=n[t].mesh._occurrence,h=new a,c=n[t].primitives;for(i=0;i<c.length;i++){(h=new a).setFromOccurrence(l,c[i]);var d={pathElement:h};d.pathElement.getLastElement(!0)._getExcludeFromHL()||s.add(d)}}return r},removeHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var s=o,l=n[t].mesh._occurrence,h=n[t].primitives;for(i=0;i<h.length;i++){(u=new a).setFromOccurrence(l,h[i]);var c={pathElement:u},d=s.get();for(t=0;t<d.length;t++){var u,p=d[t];if(!(u=p.pathElement)&&p.options&&(u=p.options.pathElement),u&&u.isEqual(c.pathElement)){s.remove(p),!0;break}}}}return r},show:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,s=r[t].primitives;n.show(s)}return i},hide:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,s=r[t].primitives;n.hide(s)}return i},getHideShowPathElement:function(e,t,i){var r=this._getPathElements(e,t,i);return{visiblePath:r.pathElementsToShow,hiddenPath:r.pathElementsToHide}},getPathElement:function(e,t){var i=this._getPrimitivesNew4(e);return this.buildPathElementsFromNodes(i,t)},getPathElementsFromIDs:function(e,t,i,r,s){for(var a=new n.UUID,o=function(e,t){return a.setFromUint32(e.uuid_1,e.uuid_2,e.uuid_3,e.uuid_4),!!t.id.isEqual(a)&&(t.res.nodes.push(e),!0)},l=function(e,t){return t.id===e.cgmId&&(t.res.nodes.push(e),!0)},h=function(e,t){t.id===e.cgmId&&t.res.nodes.push(e)},d=function(e,t){for(var i=[],r=e.getPrimitivesCount(),s=0;s<r;s++)for(var a=0;a<t.length;a++)if(e.getPrimitiveCgmId(s)===t[a]){var o=new n.SGPrimitiveHelper;o.set(e,s),i.push(o);break}return i},u=[this.internalSceneGraph],p=[],f=0;f<t.length;f++){for(var g=[],m=0;m<u.length;m++){var v={nodes:[]};c(u[m],0===s?o:l,{id:t[f],nodeType:1,res:v}),v.nodes.length&&(g=g.concat(v.nodes))}if(!g.length)return null;u=g}if(0!==i&&null!=i){for(g=[],m=0;m<u.length;m++){v={nodes:[]};c(u[m],h,{id:i,nodeType:2,res:v}),v.nodes.length&&(g=g.concat(v.nodes))}if(!g.length)return null;if(u=g,null!=r)for(m=0;m<u.length;m++){v={nodes:[]};for(var _=d(u[m],r),y=0;y<_.length;y++)p.push(_[y])}}return this.buildPathElementsFromNodes(p.length>0?p:u,e)},getPathElementsFromUUIDs:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,0)},getPathElementsFromDiezeEle:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,1)},_getPrimitives:function(e){var t={};if(!(e instanceof Array))return t;var i=function(e,t){if(e.getType&&3===e.getType()){var i=new s(e),r=e.getGroup();if(r&&r.geometry){var n=r.geometry.meshList[0],a=n.id;t.res[a]?function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1}(t.res[a].primitives,i.id)||t.res[a].primitives.push(i):t.res[a]={mesh:n,primitives:[i]}}}return t},r=function(e,t){h(e,(function(e,t){return e.cgmId==t.path[t.index]?(t.index++,t.path.length==t.index?(t.res.push(e),t.stop=!0,t):t):(t.stop=!0,t)}),t)};return h(this.internalSceneGraph,(function(e,t){e.children&&e.children.length;var n,s=t.idArray.length;for(n=0;n<s;n++)if(e.getCgmId&&e.getCgmId()==t.idArray[n][0]||!e.getCgmId&&e.cgmId==t.idArray[n][0]){var a=[];r(e,{path:t.idArray[n],index:0,res:a,stop:!1}),a.length&&h(a[0],i,t)}return t}),{idArray:e,res:t,stop:!1}),t},_getPrimitiveWithMesh:function(e,t){var i=function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1};if(e)if(e.getType){var r=s.getFromSGNode(e),n=e.getGroup();if(n&&n.geometry&&n.geometry.meshList.length>0){var a=n.geometry.meshList[0],o=a.id;t.res[o]?i(t.res[o].reps,r.id)||t.res[o].reps.push(r):t.res[o]={mesh:a,reps:[r]}}}else h(e,(function(e,t){if(2==e.type&&(t.stop=!0,e.getPrimitivesCount())){var r=e.getPrimitiveGroup(0),n=s.getFromSGNode(e);if(r&&r.geometry){var a=r.geometry.meshList[0],o=a.id;t.res[o]?i(t.res[o].reps,n.id)||t.res[o].reps.push(n):t.res[o]={mesh:a,reps:[n]}}}return t}),t);return t.res},_buildPaths:function(e,t){var i=e,r=[];for(var n in i){for(var o=i[n].mesh._occurrence.node,l=[];o.id!==this.id&&o.parents&&o.parents[0];)l.unshift(o),o=o.parents[0];t&&t.externalPath&&(l=t.externalPath.concat(l));for(var h=i[n].reps,c=0;c<h.length;c++){var d=[h[c]];o=h[c];for("primitive"==h[c].getType()&&(o=s.getFromSGNode(h[c].sgNode.getRep()),d.unshift(o));o&&o.sgNode&&o.sgNode.parents[0];){var u=s.getFromSGNode(o.sgNode.parents[0]);d.unshift(u),o=u}var p=new a;p.setFromArray(l,d),r.push(p)}}return r},buildPathElementsFromNodes:function(e,t){for(var i=[],r=0;r<e.length;r++)this._getPrimitiveWithMesh(e[r],{stop:!1,res:i});return this._buildPaths(i,t)},_getPathElements:function(e,t,i){var r={pathElementsToHide:[],pathElementsToShow:[]};if(!(e instanceof Array))return r;if(!(t instanceof Array))return r;for(var n=[],a=[],o=this._getPrimitivesNew4(e),l=0;l<o.length;l++){(c=o[l]).getCgmId||1!=c.type||c.noShow||(c.noShow=!0,n.push(c))}r.pathElementsToHide=this.buildPathElementsFromNodes(o,i);var h=this._getPrimitivesNew4(t);for(l=0;l<h.length;l++){var c;(c=h[l]).getCgmId||1!=c.type||c.noShow&&(c.noShow=!1,a.push(c))}var d,u=[],p=[];for(l=0;l<h.length;l++)this._getPrimitiveWithMesh(h[l],{stop:!1,res:u});for(d in u)for(var f=u[d].reps,g=0;g<f.length;g++){var m=!0,v=f[g];for("primitive"==v.getType()&&(v=s.getFromSGNode(v.sgNode.getRep()));v&&v.sgNode&&v.sgNode.parents[0];){if("rep"!=v.getType()&&v.sgNode.noShow){m=!1;break}v=s.getFromSGNode(v.sgNode.parents[0])}m&&(p[d]?p[d].reps.push(f[g]):p[d]={mesh:u[d].mesh,reps:[f[g]]})}r.pathElementsToShow=this._buildPaths(p,i);for(l=0;l<n.length;l++)n[l].noShow=!1;for(l=0;l<a.length;l++)a[l].noShow=!0;return r},_getPrimitivesNew2:function(e){for(var t={nodes:[]},i=0;i<e.length;i++)l(this.internalSceneGraph,u,{index:0,results:t,path:e[i]});return t.nodes},getNodeFromIdPath:function(e,t,i,r){var s=i._primitives?i.getPrimitivesCount():0,a=i.getCgmId?i.getCgmId():i.cgmId;if(a>0){if(a!=e[t])return!1;if(++t===e.length)return r.push(i),!0}else if(0==a&&0==e[t]&&++t===e.length)return r.push(i),!0;var o=i.children;if(o)for(var l=0;l<o.length;++l)this.getNodeFromIdPath(e,t,o[l],r);else if(s)for(l=0;l<s;l++){var h=new n.SGPrimitiveHelper;if(h.set(i,l),h.getCgmId()===e[t])return r.push(h),!0}},_getPrimitivesNew4:function(e){for(var t=[],i=0;i<e.length;++i)this.getNodeFromIdPath(e[i],0,this.internalSceneGraph,t);return t},_getPrimitivesNew3:function(e){for(var t=[],i={nodes:[]},r=0;r<e.length;r++){var n=e[r],s=n.length;l(this.internalSceneGraph,d,{results:i,cgmId:n[s-1]});for(var a=0;a<i.nodes.length;a++)for(var o=i.nodes[a],h=0,c=o.getCgmId?o.getCgmId():o.cgmId;c==n[s-1-h]||0==c;){if(c==n[s-1-h]&&h++,h==s){t.push(i.nodes[a]);break}if(o.getType&&3==o.getType())o=o.getRep();else{if(!o.parents||!o.parents[0])break;o=o.parents[0]}c=o.getCgmId?o.getCgmId():o.cgmId}}return t},_buildSGBagNodes:function(){var e=this.internalSceneGraph;e&&1===e.type&&(this.internalSceneGraph=this._buildSGBag(e))},_buildSGBag:function(e){var t,i,r,s=new n.SGBag;for(s.copyNoChildren(e),t=0;t<e.children.length;t++)(r=1===(i=e.children[t]).type?this._buildSGBag(i):i).parents[0]=s,s.children.push(r);return s}});return UWA.namespace("THREEDS/Nodes/CGRNode",p)})),define("Visualization/CGRNode",["DS/Visualization/CGRNode","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/CGRNode"),e})),define("DS/Visualization/FontUtils",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ProxyAbstraction","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/ModelLoader"],(function(e,t,i,r,n,s,a,o,l){"use strict";var h=null,c=null,d=null,u=new Set,p=new Set,f=[],g=!1,m=function(e,t){var i=function(e,t){return e.font="64px "+t,e.measureText("cwmli64dr").width},r=function(e,t,i){return e.font="64px '"+t+"','"+i,e.measureText("cwmli64dr").width};return i(t,"monospace")!=r(t,e,"monospace")||(i(t,"serif")!=r(t,e,"serif")||i(t,"sans-serif")!=r(t,e,"sans-serif"))},v=function(e){d=c.getContext("2d"),u.has(e.fn)||(m(e.fn,d)?u.add(e.fn):p.add(e.fn))},_=function(e,t){c||((c=document.createElement("canvas")).height=128),d||(d=c.getContext("2d")),d.font=e;var i=d.measureText(t);c.height=128,c.width=i.width,d.font=e,d.textAlign="left",d.textBaseline="middle",d.clearRect(0,0,c.width,c.height),d.fillStyle="#FFFFFF",d.fillText(t,0,63);for(var r=d.getImageData(0,0,c.width,c.height).data,n=0,s=c.height-1,a=0;a<c.height-1;a++)for(var o=0;o<c.width-1;o++)if(r[a*c.width*4+4*o]){n=a,a=c.height;break}for(a=c.height-1;a>=0;a--)for(o=0;o<c.width-1;o++)if(r[a*c.width*4+4*o]){s=a,a=-1;break}return{width:c.width,height:s-n,topLine:n}},y=function(t){var s,a,o,l,h,c,d,u=new i({width:t.width,height:t.height,drawCB:function(i,r,n,s,a){var o=t.topOffset;try{var l=t.color;if(a&&t.colorIndex&&(l=e._getColorMap(a)[t.colorIndex]),r.fillStyle="#"+l.getHexString(),r.font=t.fontOption,r.textAlign="left",r.textBaseline="middle",r.fillText(t.text,0,o),window.WUXDisableTextNodes)return void r.clearRect(0,0,t.width,t.height)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,alphaTest:.01,webGLV6Viewer:t.viewer}),p=(t.hotspot,t.bbox[0]),f=t.bbox[1],g=t.bbox[2],m=t.bbox[3],v=t.orientationAngle,_=f-p,y=m-g,S=v%90;switch(d=v/90,isNaN(d)?NaN:d>0?Math.floor(d):Math.ceil(d)){case 1:s=new e.Vector3(f,g,0),a=new e.Vector3(f,m,0),h=new e.Vector3(0,1,0),c=new e.Vector3(-1,0,0),o=y,l=_;break;case 2:s=new e.Vector3(f,m,0),a=new e.Vector3(p,m,0),h=new e.Vector3(-1,0,0),c=new e.Vector3(0,-1,0),o=_,l=y;break;case 3:s=new e.Vector3(p,m,0),a=new e.Vector3(p,g,0),h=new e.Vector3(0,-1,0),c=new e.Vector3(1,0,0),o=y,l=_;break;default:s=new e.Vector3(p,g,0),a=new e.Vector3(f,g,0),h=new e.Vector3(1,0,0),c=new e.Vector3(0,1,0),o=_,l=y}var b=l,x=0;(S=S*(Math.PI/180))>0&&(x=o-Math.cos(S)*t.widthRigth,b=Math.tan(Math.PI/2-S)*x);var w=l-b;h.multiplyScalar(x);var P=(new e.Vector3).copy(c).multiplyScalar(w);c.multiplyScalar(b);var C=(new e.Vector3).addVectors(s,h),M=(new e.Vector3).addVectors(s,c).sub(C),E=P.add(a).sub(C);return new r({name:"test",bottomLeftcorner:C,widthVector:E,heightVector:M,canvasNodeTexture:u,side:e.DoubleSide,_noZPriority:t._noZPriority},n)},S=function(i,r,n){var s=[];c||((c=document.createElement("canvas")).height=128);for(var a=i.length,o=0;o<a;o++){(l=h[i[o].fontName])&&v(l)}p.forEach((function(e,t,i){!function(e){d=c.getContext("2d"),u.has(e)||m(e,d)&&u.add(e)}(e)})),p.clear();for(o=0;o<a;o++){var l;(l=h[i[o].fontName])||(l={fn:"nofont"});var f=(l.B?"bold ":"")+(l.I?"italic ":"")+"64px '"+l.fn,g=_(f,i[o].text),S=63-g.topLine,b=(i[o].colorIndex&&i[o].colorIndex,i[o].viewer&&i[o].viewer,new e.Color({r:i[o].color.r,g:i[o].color.g,b:i[o].color.b}));r.textureInBlack&&1==i[o].color.r&&1==i[o].color.g&&1==i[o].color.b&&(b.r=b.g=b.b=0);var x=y({text:i[o].text,width:g.width,height:g.height+1,color:b,fontOption:f,topOffset:S,bbox:i[o].bbox,widthRigth:i[o].width,orientationAngle:i[o].orientationAngle,_noZPriority:i[o]._noZPriority});if(i[o].matrix&&x.setMatrix((new e.Matrix4).setFromArray(i[o].matrix.elements)),i[o].attachedPoint){var w=new t({type:"Spherical"});w.setMatrix((new e.Matrix4).setFromArray(i[o].attachedPoint.elements)),w.addChild(x),s.push(w)}else s.push(x)}n(s)},b={table:h,createTexts:function(e,t,i){h?S(e,t,i):(f.push({cgrTexts:e,options:t,doneCallback:i}),g||(g=!0,require(["text!Visualization/assets/fonts/fontTable.json"],(function(e){h=JSON.parse(e),function(){for(var e=0;e<f.length;e++)S(f[e].cgrTexts,f[e].options,f[e].doneCallback);f=[]}()}))))},measureText:_};return UWA.namespace("THREEDS/FontUtils",b)})),define("DS/Visualization/GaussianSplattingUtils",["DS/Mesh/GaussianSplattingParsing","DS/Materials/GaussianSplatMaterial","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/RenderEngineUtils/WebGPUComputeInterface"],(function(e,t,i,r,n,s,a,o){"use strict";class l{constructor(e={}){this.logging=!1,this.workerInfos=null,this.sortSplatIndexKernel=null,this.viewer=e.viewer||null;const t=e.useMillimeters||!1;this.splatContainer=new h(t),this.firstRenderCB=e.firstRenderCB||null}_createTileContentFromData(t){const i=e.PlainDataParser.parseToSplatBuffer(t,1);return this.logging&&console.log("Plain data buffer built"),i}_createTileContentFromSTPM(t){const i=e.StpmDataParser.parseToSplatBuffer(t,1);return this.logging&&console.log("STPM data buffer built"),i}_createTileContentFromResponse(t){const i=e.ResponseDataParser.parseToSplatBuffer(t,1);return this.logging&&console.log("Response data buffer built"),i}_createNode3D(e){const t=this.splatContainer.splatBuffers;t.push(e),this.splatContainer.build(t,[{position:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1]}]);const r=this.splatContainer.geometry;return i.WebGPU||this.setupSortWorker(this.splatContainer),i.WebGPU?r.mesh3js.beforeRenderCB=this.updateSplatSortWebGPU():r.mesh3js.beforeRenderCB=this.updateSplatSortWebGL(),r}setupSortWorker(e){const t=s.matchUrl(n.getWebappsBaseUrl(),window.location)?null:"Passport",i={provider:"FILE",filename:"AmdLoader.js",serverurl:n.getWebappsBaseUrl()+"AmdLoader/",module:"AmdLoader",requiredAuth:t},r={provider:"FILE",filename:"GaussianSplatSortWorker.js",serverurl:n.getWebappsBaseUrl()+"Workers/",module:"Workers",requiredAuth:t},o=this;a.getWorkerBlobFromSpecs([i,r],(function(t){o.workerInfos&&(o.workerInfos.worker.terminate(),delete o.workerInfos.worker,o.workerInfos=null),o.workerInfos={worker:new Worker(t),ready:!1,isSorting:!1,indicesToSort:null};var i=!0;o.workerInfos.worker.onmessage=function(t){var r=t.data;if(r.loaded){o.workerInfos.ready=!0,o.logging&&console.log("sortWorker Ready");let e=o.splatContainer.splatBuffers[0].centerArray;o.workerInfos.worker.postMessage({init:!0,data:{centers:e}});const t=e.length/3;o.workerInfos.indicesToSort=new Float32Array(t);for(let e=0;e<t;e++)o.workerInfos.indicesToSort[e]=e;o.viewer&&o.viewer.render()}else if(r.sortComplete){const t=r.data.indicesOut;o.logging&&console.log(`Update instancing params ! ${r.data.nbRendered} / ${r.data.indicesOut.length}`),e.updateRenderIndexes(t,r.data.nbRendered),o.workerInfos.isSorting=!1,o.viewer&&i&&(o.viewer.render(),i=!1,o.firstRenderCB&&o.firstRenderCB())}}}))}updateSplatSortWebGL(){const e=new i.Matrix4,t=new i.Vector3(0,0,-1),r=new i.Vector3(0,0,-1),n=new i.Vector3,s=new i.Vector3,a=[],o=[{angleThreshold:.55,sortFractions:[.125,.33333,.75]},{angleThreshold:.65,sortFractions:[.33333,.66667]},{angleThreshold:.8,sortFractions:[.5]}];let l=this;return function(i,h){const c=l.workerInfos;if(!c)return void(l.logging&&console.warn("Waiting for gaussian web worker initialization"));if(!c.ready||c.isSorting)return;let d=h.camera,u=0,p=0;if(r.set(0,0,-1).applyQuaternion(d.quaternion),u=r.dot(t),p=s.copy(d.position).sub(n).length(),!l.splatContainer.dynamicMode&&0===a.length&&.95<u&&p<1)return;c.isSorting=!0,e.copy(d.matrixWorldInverse),e.multiplyMatrices(d.projectionMatrix,e),e.multiplyMatrices(e,i.matrixWorld);const f=l._gatherSceneNodesForSort(d,l.splatContainer.splatTree,c.indicesToSort,!1,i.matrixWorld);if(l.splatContainer.dynamicMode)a.push(f);else if(0===a.length){for(let e of o)if(u<e.angleThreshold){for(let t of e.sortFractions)a.push(Math.floor(f*t));break}a.push(f)}const g=Math.min(a.shift(),f);c.worker.postMessage({sort:!0,data:{splatIndices:c.indicesToSort,mvpMatrix:e,nbRendered:f,sortCount:g}}),0===a.length&&(t.copy(r),n.copy(d.position))}}updateSplatSortWebGPU(){let e=this,t=!0;return function(r,n){if(null===n.viewpoint)return;const s=i.WebGPU?n.viewpoint.viewer.renderer.renderer.webGPUDevice:null;if(null===s)throw new Error("Cannot use updateSplatSortWebGPU on WebGL !");null===e.splatContainer.material.splatIndexGPUBuffer&&(e.splatContainer.material.splatIndexGPUBuffer=s.createBuffer({label:"splatIndexGPUBuffer",size:e.splatContainer.splatBuffers[0].splatCount*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC})),null===e.sortSplatIndexKernel&&(e.sortSplatIndexKernel=new o.sortSplatIndexKernel({device:s,positionsTextureSize:e.splatContainer.material.centersTextureSize,positionsDataTexture:e.splatContainer.material.centersRGTexture,indices:e.splatContainer.material.splatIndexGPUBuffer,count:e.splatContainer.splatBuffers[0].splatCount}));const a=s.createCommandEncoder(),l=a.beginComputePass();e.sortSplatIndexKernel.updateUniformBuffer(r.matrixWorld,n.camera.matrixWorldInverse,n.camera.projectionMatrix),e.sortSplatIndexKernel.dispatch(l),l.end(),s.queue.submit([a.finish()]),e.viewer&&t&&(e.viewer.render(),t=!1,e.firstRenderCB&&e.firstRenderCB())}}static setupSplatBufferMethods(t){let r=t;t.getSplatCenter=function(t,i,n){const s=t*e.SplatBuffer.CenterComponentCount;i.x=r.centerArray[s],i.y=r.centerArray[s+1],i.z=r.centerArray[s+2],n&&i.applyMatrix4(n)},t.getSplatScaleAndRotation=function(t,n,s,a){const o=new i.Matrix4,l=new i.Matrix4,h=new i.Matrix4,c=new i.Vector3,d=t*e.SplatBuffer.ScaleComponentCount;n.set([r.scaleArray[d],r.scaleArray[d+1],r.scaleArray[d+2]]);const u=t*e.SplatBuffer.RotationComponentCount;s.set([r.rotationArray[u+1],r.rotationArray[u+2],r.rotationArray[u+3],r.rotationArray[u]]),a&&(o.makeScale(n.x,n.y,n.z),l.makeRotationFromQuaternion(s),h.copy(o).multiply(l).multiply(a),h.decompose(c,s,n))},t.getSplatColor=function(t,i){const n=t*e.SplatBuffer.ColorComponentCount;i.set([r.colorArray[n],r.colorArray[n+1],r.colorArray[n+2],r.colorArray[n+3]])},t.fillSplatCenterArray=function(t,n,s){const a=r.splatCount,o=new i.Vector3;for(let i=0;i<a;i++){const a=i*e.SplatBuffer.CenterComponentCount,l=(i+n)*e.SplatBuffer.CenterComponentCount;o.x=r.centerArray[a],o.y=r.centerArray[a+1],o.z=r.centerArray[a+2],s&&o.applyMatrix4(s),t[l]=o.x,t[l+1]=o.y,t[l+2]=o.z}},t.fillSplatCovarianceArray=function(t,n,s){const a=r.splatCount,o=new i.Vector3,l=new i.Quaternion,h=new i.Matrix3,c=new i.Matrix3,d=new i.Matrix3,u=new i.Matrix3,p=new i.Matrix3,f=new i.Matrix3,g=new i.Matrix4;for(let i=0;i<a;i++){const a=i*e.SplatBuffer.ScaleComponentCount;o.set(r.scaleArray[a],r.scaleArray[a+1],r.scaleArray[a+2]),g.makeScale(o.x,o.y,o.z),c.set(g.elements[0],g.elements[4],g.elements[8],g.elements[1],g.elements[5],g.elements[9],g.elements[2],g.elements[6],g.elements[10]);const m=i*e.SplatBuffer.RotationComponentCount;l.set(r.rotationArray[m+1],r.rotationArray[m+2],r.rotationArray[m+3],r.rotationArray[m]),g.makeRotationFromQuaternion(l),h.set(g.elements[0],g.elements[4],g.elements[8],g.elements[1],g.elements[5],g.elements[9],g.elements[2],g.elements[6],g.elements[10]),f.copy(h),f.multiplyMatrices(f,c),d.copy(f).transpose(),d.multiplyMatrices(f,d);const v=e.SplatBuffer.CovarianceSizeFloats*(i+n);s&&(u.set(s.elements[0],s.elements[4],s.elements[8],s.elements[1],s.elements[5],s.elements[9],s.elements[2],s.elements[6],s.elements[10]),p.copy(u).transpose(),d.multiplyMatrices(d,p),d.multiplyMatrices(u,d)),t[v]=d.elements[0],t[v+1]=d.elements[3],t[v+2]=d.elements[6],t[v+3]=d.elements[4],t[v+4]=d.elements[7],t[v+5]=d.elements[8]}},t.fillSplatColorArray=function(t,i){const n=r.splatCount;for(let s=0;s<n;s++){const n=s*e.SplatBuffer.ColorComponentCount,a=(s+i)*e.SplatBuffer.ColorComponentCount;t[a]=r.colorArray[n],t[a+1]=r.colorArray[n+1],t[a+2]=r.colorArray[n+2],t[a+3]=r.colorArray[n+3]}}}createNode3DFromPlainData(e){console.log("Reading plain data...");const t=this._createTileContentFromData(e);if(null===t)return null;l.setupSplatBufferMethods(t);return this._createNode3D(t)}createNode3DFromPLYFileData(t){if(console.log("Reading ply file data..."),!(t instanceof ArrayBuffer))return console.error("plyFileData for createNode3DFromPLYFileData is not an ArrayBuffer"),null;const i=e.PlyParser.parseToSplatBuffer(t,1);if(null===i)return null;l.setupSplatBufferMethods(i);return this._createNode3D(i)}createNode3DFromSPZFileData(t){if(console.log("Reading spz file data..."),!(t instanceof ArrayBuffer))return console.error("spzFileData for createNode3DFromSPZFileData is not an ArrayBuffer"),null;const i=e.SPZParser.parseToSplatBuffer(t,1);if(null===i)return null;l.setupSplatBufferMethods(i);return this._createNode3D(i)}createNode3DFromCGR(t){if(console.log("Reading CGR file..."),t.version>=1){if(t.type==l.CGR_TYPE_PLY){const i=e.PlyParser.parseToSplatBuffer(t.bufferData.buffer,1);l.setupSplatBufferMethods(i);return this._createNode3D(i)}}else console.warn("Invalid gaussian splat CGR.");return null}createNode3DFromSplatBuffer(e){if(null===e)return null;l.setupSplatBufferMethods(e);return this._createNode3D(e)}ConvertPLYToSTPM(t){if(!(t instanceof ArrayBuffer))return console.error("fileData for createNode3DFromPLYFileData is not an ArrayBuffer"),null;return e.PlyParser.convertToSTPM(t)}_gatherSceneNodesForSort(e,t,r,n,s){const a=[],o=new i.Vector3,l=new i.Vector3,h=new i.Vector3,c=new i.Matrix4,d=new i.Matrix4,u=new i.Vector3,p=new i.Vector3(0,0,-1),f=new i.Vector3,g=e=>f.copy(e.max).sub(e.min).length(),m=e.far;let v={width:512,height:512};this.viewer&&(v=this.viewer.renderer.renderer.getViewportSize()),u.x=v.width,u.y=v.height;const _=u.y/2/Math.tan(e.fov/2*(Math.PI/180)),y=Math.atan(u.x/2/_),S=Math.atan(u.y/2/_),b=Math.cos(y),x=Math.cos(S);d.copy(e.matrixWorldInverse),d.multiplyMatrices(d,s);let w=0,P=0;for(let e=0;e<t.subTrees.length;e++){const i=t.subTrees[e];c.copy(d);const r=i.nodesWithIndexes.length;for(let e=0;e<r;e++){const t=i.nodesWithIndexes[e];h.copy(t.center).applyMatrix4(c);const r=h.length();0,o.copy(h).setX(0).normalize(),l.copy(h).setY(0).normalize();const s=p.dot(l),d=p.dot(o),u=g(t);!n&&(s<b-.6||d<x-.6||r>m)&&r>u||(P+=t.data.indexes.length,a[w]=t,t.data.distanceToNode=r,w++)}}a.length=w,a.sort(((e,t)=>e.data.distanceToNode<t.data.distanceToNode?-1:1));let C=4*P;for(let e=0;e<w;e++){const t=a[e],i=t.data.indexes.length,n=4*i;new Float32Array(r.buffer,C-n,i).set(t.data.indexes),C-=n}return this.logging&&console.log(`Nodes not culled: ${w}, renderCount: ${P}`),P}}l.CGR_TYPE_UNKNOWN=e.CGR_TYPE_UNKNOWN,l.CGR_TYPE_PLY=e.CGR_TYPE_PLY;class h{constructor(e=!1){this.dynamicMode=!0,this.useMillimeters=e,this.splatBuffers=[],this.scenes=[],this.splatTree=null,this.globalSplatIndexToLocalSplatIndexMap=[],this.globalSplatIndexToSceneIndexMap=[],this.material=null,this.geometry=null}buildGeometry(e){const t=e[0],n=t.splatCount;var s=r.createRectangleNode({cornerPoint:new i.Vector2(-1,-1),width:2,height:2,fill:!0});s.name="Gaussian Splat Cloud",s.mesh3js.name="Gaussian Splat Cloud mesh",s.getNodeType=function(){return"GaussianNode3D"},s.setMaterial(this.material),this.useMillimeters||console.log("Scaling the gaussian splat by 1000.0 since we are using meters instead of millimeters");const a=this.useMillimeters?1:1e3,o=new i.Matrix4(a,0,0,0,0,-a,0,0,0,0,a,0,0,0,0,1);s.setMatrix(o);{var l=new i.Sphere,h=1;const e=new i.Vector3;for(var c=0;c<n;c++){t.getSplatCenter(c,e,null);var d=e.x*e.x+e.y*e.y+e.z*e.z;h<d&&(h=d)}l.radius=Math.sqrt(h),s.forceBoundingSphere(l)}if(s.setFrustumCulled(!1),i.WebGPU)s.setInstancingParameters(n,[],"mesh");else{var u=new Float32Array(n);for(c=0;c<n;c++)u[c]=c;var p={data:u,type:"f",attribName:"aSplatIndex"};s.setInstancingParameters(n,[p],"mesh")}return s.setRenderPasses(["GaussianSplat"]),s}static createScene(e,t,i,r){return new c(e,t,i,r)}static buildScenes(e,t){const r=[];r.length=e.length;for(let n=0;n<e.length;n++){const s=e[n],a=t[n]||{};let o=a.position||[0,0,0],l=a.rotation||[0,0,0,1],c=a.scale||[1,1,1];const d=new i.Vector3(o[0],o[1],o[2]),u=new i.Quaternion(l[0],l[1],l[2],l[3]),p=new i.Vector3(c[0],c[1],c[2]);r[n]=h.createScene(s,d,u,p)}return r}static buildSplatTree(e,t=[]){e.splatTree=new p(8,1e3);const i=new Uint8Array([0,0,0,0]);e.splatTree.processSplatContainer(e,(r=>{e.getSplatColor(r,i);const n=e.getSceneIndexForSplat(r),s=t[n]||1;return i[3]>=s}))}static buildSplatIndexMaps(e){const t=[],i=[];let r=0;for(let n=0;n<e.length;n++){const s=e[n].splatCount;for(let e=0;e<s;e++)t[r]=e,i[r]=n,r++}return{localSplatIndexMap:t,sceneIndexMap:i}}disposeMeshData(){this.geometry&&(this.geometry=null),this.material&&(this.material.centersRGTexture&&this.material.centersRGTexture.dispose(),this.material.covariancesBATexture&&this.material.covariancesBATexture.dispose(),this.material.dispose(),this.material=null),this.splatTree=null}build(e,i,r=!0){this.disposeMeshData(),this.material=new t,this.splatBuffers=e;const n=h.buildScenes(e,i);if(r)for(let e=0;e<this.scenes.length&&e<n.length;e++){const t=n[e],i=this.getScene(e);t.copyTransformData(i)}this.scenes=n;const s=h.buildSplatIndexMaps(e);this.globalSplatIndexToLocalSplatIndexMap=s.localSplatIndexMap,this.globalSplatIndexToSceneIndexMap=s.sceneIndexMap,h.buildSplatTree(this),this.uploadSplatDataToTextures(),this.geometry=this.buildGeometry(this.splatBuffers)}updateRenderIndexes(e,t){this.geometry.updateInstanceAttribArray({isFlattened:!0,attribName:"aSplatIndex",array:e}),this.geometry.setDrawCount(t)}getSplatCount(){return h.getTotalSplatCountForScenes(this.scenes)}uploadSplatDataToTextures(){const e=this.getSplatCount(),t=new Float32Array(6*e),i=new Float32Array(3*e),r=new Uint8Array(4*e);this.fillSplatDataArrays(t,i,r),this.material.updateDataToTextures(t,i,r)}fillSplatDataArrays(e,t,i,r){let n=0;for(let s=0;s<this.scenes.length;s++){null==r&&(r=!this.dynamicMode);const a=this.getScene(s),o=a.splatBuffer,l=r?a.transform:null;e&&o.fillSplatCovarianceArray(e,n,l),t&&o.fillSplatCenterArray(t,n,l),i&&o.fillSplatColorArray(i,n),n+=o.splatCount}}static getTotalSplatCountForScenes(e){let t=0;for(let i of e)i&&i.splatBuffer&&(t+=i.splatBuffer.splatCount);return t}static getTotalSplatCountForSplatBuffers(e){let t=0;for(let i of e)t+=i.splatCount;return t}getLocalSplatParameters(e,t,i){null==i&&(i=!this.dynamicMode),t.splatBuffer=this.getSplatBufferForSplat(e),t.localIndex=this.getSplatLocalIndex(e),t.sceneTransform=i?this.getSceneTransformForSplat(e):null}getSplatCenter(e,t,i){const r={};this.getLocalSplatParameters(e,r,i),r.splatBuffer.getSplatCenter(r.localIndex,t,r.sceneTransform)}getSplatScaleAndRotation(e,t,i,r){const n={};this.getLocalSplatParameters(e,n,r),n.splatBuffer.getSplatScaleAndRotation(n.localIndex,t,i,n.sceneTransform)}getSplatColor(e,t){const i={};this.getLocalSplatParameters(e,i),i.splatBuffer.getSplatColor(i.localIndex,t)}getSceneTransform(e,t){const i=this.getScene(e);i.updateTransform(),t.copy(i.transform)}getScene(e){if(e<0||e>=this.scenes.length)throw new Error("SplatContainer::getScene() -> Invalid scene index.");return this.scenes[e]}getSplatBufferForSplat(e){return this.getScene(this.globalSplatIndexToSceneIndexMap[e]).splatBuffer}getSceneIndexForSplat(e){return this.globalSplatIndexToSceneIndexMap[e]}getSceneTransformForSplat(e){return this.getScene(this.globalSplatIndexToSceneIndexMap[e]).transform}getSplatLocalIndex(e){return this.globalSplatIndexToLocalSplatIndexMap[e]}}class c{constructor(e,t=new i.Vector3,r=new i.Quaternion,n=new i.Vector3(1,1,1)){this.splatBuffer=e,this.position=t.clone(),this.quaternion=r.clone(),this.scale=n.clone(),this.transform=new i.Matrix4,this.updateTransform()}copyTransformData(e){this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.transform.copy(e.transform)}updateTransform(){this.transform.compose(this.position,this.quaternion,this.scale)}}class d{constructor(e,t,r,n){this.min=(new i.Vector3).copy(e),this.max=(new i.Vector3).copy(t),this.boundingBox=new i.Box3(this.min,this.max),this.center=(new i.Vector3).copy(this.max).sub(this.min).multiplyScalar(.5).add(this.min),this.depth=r,this.children=[],this.data=null,this.id=n||d.idGen++}}d.idGen=0;class u{constructor(e,t){this.maxDepth=e,this.maxCentersPerNode=t,this.sceneDimensions=new i.Vector3,this.sceneMin=new i.Vector3,this.sceneMax=new i.Vector3,this.rootNode=null,this.addedIndexes={},this.nodesWithIndexes=[]}}class p{constructor(e,t){this.maxDepth=e,this.maxCentersPerNode=t,this.splatCenters=null,this.splatContainer=null,this.subTrees=[]}processSplatContainer(e,t=(e=>!0)){this.splatContainer=e,this.subTrees=[];const r=new i.Vector3,n=function(i,n,s,a){const o=new u(s,a);let l=0;const h=[];for(let s=0;s<n;s++){const n=s+i;t(n)&&(e.getSplatCenter(n,r),(0===l||r.x<o.sceneMin.x)&&(o.sceneMin.x=r.x),(0===l||r.x>o.sceneMax.x)&&(o.sceneMax.x=r.x),(0===l||r.y<o.sceneMin.y)&&(o.sceneMin.y=r.y),(0===l||r.y>o.sceneMax.y)&&(o.sceneMax.y=r.y),(0===l||r.z<o.sceneMin.z)&&(o.sceneMin.z=r.z),(0===l||r.z>o.sceneMax.z)&&(o.sceneMax.z=r.z),l++,h.push(n))}return o.sceneDimensions.copy(o.sceneMax).sub(o.sceneMin),o.rootNode=new d(o.sceneMin,o.sceneMax,0),o.rootNode.data={indexes:h},o};if(e.dynamicMode){let t=0;for(let i=0;i<e.scenes.length;i++){const r=e.getScene(i).splatBuffer.splatCount,s=n(t,r,this.maxDepth,this.maxCentersPerNode);this.subTrees[i]=s,p.processNode2(s,s.rootNode,e),t+=r}}else{const t=n(0,e.getSplatCount(),this.maxDepth,this.maxCentersPerNode);this.subTrees[0]=t,p.processNode2(t,t.rootNode,e)}}static processNode2(e,t,r){const n=t.data.indexes.length;if(n<e.maxCentersPerNode||t.depth>e.maxDepth){const i=[];for(let r=0;r<t.data.indexes.length;r++)e.addedIndexes[t.data.indexes[r]]||(i.push(t.data.indexes[r]),e.addedIndexes[t.data.indexes[r]]=!0);return t.data.indexes=i,void e.nodesWithIndexes.push(t)}const s=(new i.Vector3).copy(t.max).sub(t.min),a=(new i.Vector3).copy(s).multiplyScalar(.5),o=(new i.Vector3).copy(t.min).add(a),l=[new i.Box3(new i.Vector3(o.x-a.x,o.y,o.z-a.z),new i.Vector3(o.x,o.y+a.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y,o.z-a.z),new i.Vector3(o.x+a.x,o.y+a.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y,o.z),new i.Vector3(o.x+a.x,o.y+a.y,o.z+a.z)),new i.Box3(new i.Vector3(o.x-a.x,o.y,o.z),new i.Vector3(o.x,o.y+a.y,o.z+a.z)),new i.Box3(new i.Vector3(o.x-a.x,o.y-a.y,o.z-a.z),new i.Vector3(o.x,o.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y-a.y,o.z-a.z),new i.Vector3(o.x+a.x,o.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y-a.y,o.z),new i.Vector3(o.x+a.x,o.y,o.z+a.z)),new i.Box3(new i.Vector3(o.x-a.x,o.y-a.y,o.z),new i.Vector3(o.x,o.y,o.z+a.z))],h=[],c=[];for(let e=0;e<l.length;e++)h[e]=0,c[e]=[];const u=new i.Vector3;for(let e=0;e<n;e++){const i=t.data.indexes[e];r.getSplatCenter(i,u);for(let e=0;e<l.length;e++)l[e].containsPoint(u)&&(h[e]++,c[e].push(i))}for(let e=0;e<l.length;e++){const i=new d(l[e].min,l[e].max,t.depth+1);i.data={indexes:c[e]},t.children.push(i)}t.data={};for(let i of t.children)p.processNode2(e,i,r)}processSplatCenters(e,t=(e=>!0)){this.splatCenters=e,this.subTrees=[];const r=new i.Vector3,n=function(i,n,s){const a=new u(n,s);let o=0;const l=[];for(let n=0;n<i;n++){const i=n;t(i)&&(r.x=e[3*i],r.y=e[3*i+1],r.z=e[3*i+2],(0===o||r.x<a.sceneMin.x)&&(a.sceneMin.x=r.x),(0===o||r.x>a.sceneMax.x)&&(a.sceneMax.x=r.x),(0===o||r.y<a.sceneMin.y)&&(a.sceneMin.y=r.y),(0===o||r.y>a.sceneMax.y)&&(a.sceneMax.y=r.y),(0===o||r.z<a.sceneMin.z)&&(a.sceneMin.z=r.z),(0===o||r.z>a.sceneMax.z)&&(a.sceneMax.z=r.z),o++,l.push(i))}return a.sceneDimensions.copy(a.sceneMax).sub(a.sceneMin),a.rootNode=new d(a.sceneMin,a.sceneMax,0),a.rootNode.data={indexes:l},a}(e.length/3,this.maxDepth,this.maxCentersPerNode);this.subTrees[0]=n,p.processNode(n,n.rootNode,e)}static processNode(e,t,r){const n=t.data.indexes.length;if(n<e.maxCentersPerNode||t.depth>e.maxDepth){const i=[];for(let r=0;r<t.data.indexes.length;r++)e.addedIndexes[t.data.indexes[r]]||(i.push(t.data.indexes[r]),e.addedIndexes[t.data.indexes[r]]=!0);return t.data.indexes=i,void e.nodesWithIndexes.push(t)}const s=(new i.Vector3).copy(t.max).sub(t.min),a=(new i.Vector3).copy(s).multiplyScalar(.5),o=(new i.Vector3).copy(t.min).add(a),l=[new i.Box3(new i.Vector3(o.x-a.x,o.y,o.z-a.z),new i.Vector3(o.x,o.y+a.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y,o.z-a.z),new i.Vector3(o.x+a.x,o.y+a.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y,o.z),new i.Vector3(o.x+a.x,o.y+a.y,o.z+a.z)),new i.Box3(new i.Vector3(o.x-a.x,o.y,o.z),new i.Vector3(o.x,o.y+a.y,o.z+a.z)),new i.Box3(new i.Vector3(o.x-a.x,o.y-a.y,o.z-a.z),new i.Vector3(o.x,o.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y-a.y,o.z-a.z),new i.Vector3(o.x+a.x,o.y,o.z)),new i.Box3(new i.Vector3(o.x,o.y-a.y,o.z),new i.Vector3(o.x+a.x,o.y,o.z+a.z)),new i.Box3(new i.Vector3(o.x-a.x,o.y-a.y,o.z),new i.Vector3(o.x,o.y,o.z+a.z))],h=[],c=[];for(let e=0;e<l.length;e++)h[e]=0,c[e]=[];const u=new i.Vector3;for(let e=0;e<n;e++){const i=t.data.indexes[e];u.x=r[3*i],u.y=r[3*i+1],u.z=r[3*i+2];for(let e=0;e<l.length;e++)l[e].containsPoint(u)&&(h[e]++,c[e].push(i))}for(let e=0;e<l.length;e++){const i=new d(l[e].min,l[e].max,t.depth+1);i.data={indexes:c[e]},t.children.push(i)}t.data={};for(let i of t.children)p.processNode(e,i,r)}countLeaves(){let e=0;return this.visitLeaves((()=>{e++})),e}visitLeaves(e){const t=(e,i)=>{0===e.children.length&&i(e);for(let r of e.children)t(r,i)};for(let i of this.subTrees)t(i.rootNode,e)}}return l})),define("DS/Visualization/DecalManager",["DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS"],(function(e,t,i){"use strict";var r=1,n=1,s=0,a=new Map,o=!1,l=function(e){e.setPickable(o?t.PICKABLE:t.PICKTHROUGH),o?e.excludeFromHighlight(!1,!1):e.excludeFromHighlight(!0,!0)},h=function(){this.activated=!1,this._creatingDecal=!1};h.prototype={_attachViewer:function(e){a.has(e)||a.set(e,new Set)},detachViewer:function(e){a.delete(e)},createDecal:function(t){if(!(!!i.supportedExtensions.textureHalfFloat&&!!i.supportedExtensions.renderToHalfFloatTexture&&!!i.supportedExtensions.textureHalfFloatLinear||!!i.supportedExtensions.textureFloat&&!!i.supportedExtensions.renderToFloatTexture&&!!i.supportedExtensions.textureFloatLinear))return console.error("Error: float/half float textures not supported, decals disabled"),null;if(!i.supportedExtensions.fragDepth)return console.error("Error: frag depth not supported, decals disabled"),null;if(!t.material&&!t.materialApplication)return console.error("Error: you need to give a material to a decal node"),null;if(t.material&&!t.material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;if(t.materialApplication&&!t.materialApplication._material&&!t.materialApplication._material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;this._creatingDecal=!0;var r=new i.Matrix4,n=t.material,s=t.materialApplication;t.matrix&&(r=t.matrix);var a=e.createCuboidNode({cornerPoint:new i.Vector3(-.5,-.5,-.5),firstAxis:new i.Vector3(1,0,0),secondAxis:new i.Vector3(0,1,0),thirdAxis:new i.Vector3(0,0,1),_decal:!0});return a._setHasExplicitUv(!!t.explicitUv),s?a.setMaterialApplication(s):a.setMaterial(n),a.setMatrix(r),l(a),a.setVisibilityInTree(!1),this._creatingDecal=!1,a},updateDecalsPickable:function(e){o=e,a.forEach((function(e,t,i){e.forEach((function(e,t,i){l(e)}))}))},updateDecalsData:function(e,t){this._attachViewer(e),r=1,n=0,s=0;var i=this.activated;i&&t&&(i=a.get(e).size>0);if(i){var o=new Set;a.set(e,o),this._updateDecalsData(e.getRootNode()._occurrences[0],o,!1,0)}},_updateDecalsData:function(e,t,i,a){if(!e.node._isDecal){var o=e.node.decalCount>0,l=a;if(o){s++,n++;for(var h=0;h<e.children.length;h++){const r=(c=e.children[h]).node;if(r._isDecal){const e={key:0,internalSortKey:h,depth:l,depthOffset:0,layer:r.getLegacyLayer(c),stencilID:n,explicitUv:r._getHasExplicitUv(),needDrawUvs:!1};c.renderable._decalData=e,i=i||e.explicitUv,t.add(r),c.renderable._flagAsGSSOInvalidated()}}l++}for(h=0;h<e.children.length;h++)this._updateDecalsData(e.children[h],t,i,l);if(e.renderable){if(s>0){const t={key:4*r,stencilID:n,depth:0,depthOffset:0,internalSortKey:0,layer:0,explicitUv:!1,needDrawUvs:i};e.renderable._decalData=t}else e.renderable._decalData=null;e.renderable._flagAsGSSOInvalidated()}if(o){s--;for(h=0;h<e.children.length;h++){var c;(c=e.children[h]).node._isDecal&&(c.renderable._decalData.key=4*r+1,c.renderable._flagAsGSSOInvalidated())}r++}}},displayDecalInfo:function(e){console.clear(),this._displayInfo(e.getRootNode()._occurrences[0],0)},_displayInfo:function(e,t){for(var i="",r=0;r<t;r++)i+=" ";if(e.renderable){var n=e.renderable;console.log(""),console.log(i+(e.node._isDecal?"decal:":"geometry:")),n._decalData&&(console.log(i+" key: "+n._decalData.key),console.log(i+" stencil: "+n._decalData.stencilID))}var s=2*t+2;for(r=0;r<e.children.length;r++)this._displayInfo(e.children[r],s)}};var c=new h;return i.DecalManager=c,c})),define("DS/Visualization/InstancingNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],(function(e,t,i,r,n,s){"use strict";var a=0,o=(e.NoOccurrences,t.extend({init:function(e){return this._parent(e),this.instance3DBooleanAttr=0,this.setIsInstanceNode3D(!1),this.nbInstances=0,this.drawCount=this.nbInstances,this._instancingInfos=null,this._instancingMatrices=null,this._pixelCullingMatrix=null,this},_propagateInstancingInfos:function(){for(let e=0;e<this._occurrences.length;e++){let i=this._occurrences[e];this._propagateInstancingParameters(i,this._instancingInfos);let r=i.children.length;for(let e=0;e<r;e++){let r=i.children[e];this._updateOccurrences(i,r,t.UpdateMatrixMode.Never,void 0,t.InvalidateGSSOMode.Always)}}},_updateMatrixInfos:function(){if(this._instancingMatrices){let e=null;for(let t=0;t<this._instancingMatrices.length;t++){let i=this._instancingMatrices[t].getMaxScaleOnAxis();(!e||i>e)&&(this._pixelCullingMatrix=this._instancingMatrices[t],e=i)}}else this._pixelCullingMatrix=null},removeInstancingParameters:function(){if(this._instancingInfos){let t=this._instancingInfos.instanceAttribArrays,i=this._getViewer(),r=i&&i.getWebGLContext();if(r)for(var e in t)t[e].buffer&&r.deleteBuffer(t[e].buffer)}for(let e=0;e<this._occurrences.length;e++){let t=this._occurrences[e]._getRenderableOccurrences();for(let e=0;e<t.length;e++)this._removeFromVisuSelection(t[e])}this._instancingInfos=null,this._instancingMatrices=null,this._invalidateBoundingElements(),this._propagateInstancingInfos()},setInstancingParameters:function(e,t,i){if(this.removeInstancingParameters(),!e)return;for(let e=0;e<this.parents.length;e++){let t=this.parents[e];for(let e=0;e<t._occurrences.length;e++){if(t._occurrences[e]._instancingInfos)return void console.error("there is already an instancingNode3D with instancing active higher in this node hierarchy")}}let r=!1;if(this.traverse((function(e){return e instanceof o&&e._instancingInfos&&(r=!0),r})),r)return void console.error("there is already an instancingNode3D with instancing active lower in this node hierarchy");this._instancingMatrices=[];for(let t=0;t<e.length;t++)this._instancingMatrices[t]=e[t].clone();this._updateMatrixInfos(),t||(t=[]),t.push({isFlattened:!1,type:"m4",data:e,attribName:"defaultInstancingMatrix"});let n=e.length;this.setIsInstanceNode3D(!0),this.nbInstances=n,this.drawCount=n,this._instancingInfos={isInstanceNode3D:!0,nbInstances:n,drawCount:n,instancingSelectionMode:i||"instance",instanceAttribArrays:null,instanceAttribArrays_id:a++,pickedInstanceId:-1,useDefaultInstancing:!0};for(var s=new Float32Array(n),l=0;l<n;l++)s[l]=5+5*l;var h={instanceId:{}};h.instanceId.array=s,h.instanceId.buffer=null,h.instanceId.itemSize=1,h.instanceId.type="f";for(var c=0;c<t.length;c++){switch(h[t[c].attribName]={},t[c].type){case"f":h[t[c].attribName].array=new Float32Array(t[c].data),h[t[c].attribName].type="f",h[t[c].attribName].itemSize=1;break;case"v2":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(2*n);for(var d=0;d<n;d++)h[t[c].attribName].array[2*d]=t[c].data[d].x,h[t[c].attribName].array[2*d+1]=t[c].data[d].y}h[t[c].attribName].type="v2",h[t[c].attribName].itemSize=2;break;case"v3":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(3*n);for(d=0;d<n;d++)h[t[c].attribName].array[3*d]=t[c].data[d].x,h[t[c].attribName].array[3*d+1]=t[c].data[d].y,h[t[c].attribName].array[3*d+2]=t[c].data[d].z}h[t[c].attribName].type="v3",h[t[c].attribName].itemSize=3;break;case"v4":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(4*n);for(d=0;d<n;d++)h[t[c].attribName].array[4*d]=t[c].data[d].x,h[t[c].attribName].array[4*d+1]=t[c].data[d].y,h[t[c].attribName].array[4*d+2]=t[c].data[d].z,h[t[c].attribName].array[4*d+3]=t[c].data[d].w}h[t[c].attribName].type="v4",h[t[c].attribName].itemSize=4;break;case"m4":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(16*t[c].data.length);for(var u=0;u<t[c].data.length;u++){var p=new Float32Array(16);p=t[c].data[u].elements;for(l=0;l<16;l++)h[t[c].attribName].array[16*u+l]=p[l]}}h[t[c].attribName].type="m4",h[t[c].attribName].itemSize=4,h[t[c].attribName].isMat4=!0}h[t[c].attribName].buffer=null}this._instancingInfos.instanceAttribArrays=h,t.splice(t.length-1,1);let f={};for(c=0;c<t.length;c++)f[t[c].attribName]={type:t[c].type,instancing:!0};return this._invalidateBoundingElements(),this._propagateInstancingInfos(),f},setDrawCount:function(e){if(e<0||this.nbInstances<e)return void console.error("Error: drawCount is out of bounds of the instance buffer.");if(!this._instancingInfos)return void console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).");const t=this.drawCount;this.drawCount=e,this._instancingInfos.drawCount=e;for(var i=0;i<this._occurrences.length;i++)this._occurrences[i].renderable._instancingInfos.drawCount=e;if(this.drawCount<t)for(let e=0;e<this._occurrences.length;e++){let t=this._occurrences[e]._getRenderableOccurrences();for(let e=0;e<t.length;e++)this._removeFromVisuSelection(t[e])}},getInstanceMatrixValue:function(e){return this._instancingMatrices[e].clone()},updateInstanceMatrixValue:function(e,t){this._instancingMatrices[e]=t.clone(),this.updateInstanceAttribValue({instanceId:5*(e+1),attribName:"defaultInstancingMatrix",value:this._instancingMatrices[e]}),this._updateMatrixInfos(),this._invalidateBoundingElements()},updateInstanceMatrixArray:function(e,t){t=t||0;for(let i=0;i<e.length;i++)this._instancingMatrices[i+t]=e[i].clone();this.updateInstanceAttribArray({attribName:"defaultInstancingMatrix",array:this._instancingMatrices,isFlattened:!1}),this._updateMatrixInfos(),this._invalidateBoundingElements()},updateInstanceAttribValue:function(t){if(t.instanceId&&t.attribName&&void 0!==t.value)if(this._instancingInfos)if(t.instanceId%5!=0||t.instanceId<5||t.instanceId>5*this._instancingInfos.nbInstances)console.error("Error: the instance id is incorrect or out of range.");else if(this._instancingInfos.instanceAttribArrays[t.attribName]){var i=this._instancingInfos.instanceAttribArrays,r=t.instanceId/5-1,n=!0;switch(i[t.attribName].type){case"f":"number"!=typeof t.value||isNaN(t.value)?n=!1:i[t.attribName].array[r]=t.value;break;case"v2":t.value instanceof e.Vector2?(i[t.attribName].array[2*r]=t.value.x,i[t.attribName].array[2*r+1]=t.value.y):n=!1;break;case"v3":t.value instanceof e.Vector3?(i[t.attribName].array[3*r]=t.value.x,i[t.attribName].array[3*r+1]=t.value.y,i[t.attribName].array[3*r+2]=t.value.z):n=!1;break;case"v4":t.value instanceof e.Vector4?(i[t.attribName].array[4*r]=t.value.x,i[t.attribName].array[4*r+1]=t.value.y,i[t.attribName].array[4*r+2]=t.value.z,i[t.attribName].array[4*r+3]=t.value.w):n=!1;break;case"m4":if(t.value instanceof e.Matrix4){var s=new Float32Array(16);s=t.value.elements;for(var a=0;a<16;a++)i[t.attribName].array[16*r+a]=s[a]}else n=!1;break;default:n=!0}n?(i[t.attribName].isDynamic=!0,this._propagateInstancingInfos()):console.error("Error: the type of the new value doesn't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this node is not multi-instanced (call setIntancingParameters first).");else console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.")},updateInstanceAttribArray:function(t){if(t.attribName&&t.array)if(this._instancingInfos)if(this._instancingInfos.instanceAttribArrays[t.attribName]){var i=!0,r=this._instancingInfos.instanceAttribArrays;if(t.isFlattened)t.array instanceof Array&&(t.array=new Float32Array(t.array)),r[t.attribName].array=t.array;else{var n=r[t.attribName].type,s=t.array[0];switch(n){case"f":"number"!=typeof s||isNaN(s)?i=!1:r[t.attribName].array.set(new Float32Array(t.array));break;case"v2":if(s instanceof e.Vector2)for(var a=0;a<this._instancingInfos.nbInstances;a++)r[t.attribName].array[2*a]=t.array[a].x,r[t.attribName].array[2*a+1]=t.array[a].y;else i=!1;break;case"v3":if(s instanceof e.Vector3)for(a=0;a<this._instancingInfos.nbInstances;a++)r[t.attribName].array[3*a]=t.array[a].x,r[t.attribName].array[3*a+1]=t.array[a].y,r[t.attribName].array[3*a+2]=t.array[a].z;else i=!1;break;case"v4":if(s instanceof e.Vector4)for(a=0;a<this._instancingInfos.nbInstances;a++)r[t.attribName].array[4*a]=t.array[a].x,r[t.attribName].array[4*a+1]=t.array[a].y,r[t.attribName].array[4*a+2]=t.array[a].z,r[t.attribName].array[4*a+3]=t.array[a].w;else i=!1;break;case"m4":if(s instanceof e.Matrix4){var o;for(a=0;a<this._instancingInfos.nbInstances;a++){o=t.array[a].elements;for(var l=0;l<16;l++)r[t.attribName].array[16*a+l]=o[l]}}else i=!1;break;default:i=!0}}i?(r[t.attribName].isDynamic=!0,this._propagateInstancingInfos()):console.error("Error: the type of the new values don't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")},setInstancingSelectionMode:function(e){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=e;for(var t=this._occurrences,i=t.length,r=0;r<i;r++)t[r].renderable._instancingInfos.instancingSelectionMode=e}},_invalidateBoundingElements:function(e,t){this._parent(e,t)},_getInstanceWorldMatrixFromInstanceId(e,t,i){return this._getInstanceWorldMatrixFromIndex((e-5)/5,t,i)},_getInstanceWorldMatrixFromIndex(t,i,r){let n=i.matrix,s=r.matrix;if(t<this._instancingMatrices.length){let i=new e.Matrix4;return i.multiplyMatrices(this._instancingMatrices[t],s),i.multiplyMatrices(n,i),i}return console.error("incoherent index used for matrice instance"),s},_modifyBE:function(e,t){if(this._instancingMatrices){let i=null;for(let r=0;r<this._instancingMatrices.length;r++)i=t(i,e,this._instancingMatrices[r]);return i}return e},getTopZ(t,i,r){let n=t._getMMMatrix(),s=i.matrix,a=new e.Vector3,o=new e.Matrix4,l=null,h=null,c=null;for(let e=0;e<this._instancingMatrices.length;e++){let i=this._instancingMatrices[e].getMaxScaleOnAxis();o.multiplyMatrices(this._instancingMatrices[e],n),o.multiplyMatrices(s,o),a.copy(t.geometry.boundingSphere.center),a.applyMatrix4(o);let d=a[r],u=d+t.geometry.boundingSphere.radius*i;(!l||u<l)&&(l=u,c=d,h=c-t.geometry.boundingSphere.radius*i)}return t._BEbottomZ=h,l},getMin(t,i,r,n,s){let a=t._getMMMatrix(),o=i.matrix,l=new e.Matrix4,h=null,c=new e.Vector3;const d=n.getVertexCount();for(let e=0;e<this._instancingMatrices.length;e++){l.multiplyMatrices(this._instancingMatrices[e],a),l.multiplyMatrices(o,l);let i=t.geometry.boundingSphere.clone();if(i.applyMatrix4(l),i.center[r]-i.radius<s)for(let e=0;e<d;e++)n.getVertexPosition(e,c),c.applyMatrix4(l),(c[r]<h||null===h)&&(h=c[r])}return h},getMaxScaleOnAxis(t,i){let r=t.matrix?t.matrix.clone():new e.Matrix4;return this._pixelCullingMatrix&&r.multiplyMatrices(this._pixelCullingMatrix,r),i.matrix&&r.multiplyMatrices(i.matrix,r),r.getMaxScaleOnAxis()},getPixelCullingRadius(e,t){if(this._pixelCullingMatrix){let i=e.boundingSphere.clone();return i.applyMatrix4(e._occurrence.matrix),i.applyMatrix4(this._pixelCullingMatrix),i.applyMatrix4(t.matrix),i.radius}return e.worldCenterAndRadius.worldRadius},getMesh3DChildren(){let e=[];return this.traverseUnique((function(t){t instanceof i&&e.push(t)})),e},_linkingClone:function(e,i){return t.prototype._linkingClone.call(this,e),e.instance3DBooleanAttr=this.instance3DBooleanAttr,e.nbInstances=this.nbInstances,e.drawCount=this.drawCount,e._instancingInfos=this._instancingInfos,e._instancingMatrices=this._instancingMatrices,e},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var s=n[r];this._occurrences[r]=s,s._compactChildrenArray(t)}this.mesh3js&&this.mesh3js._compactArrays(t)}},setFrustumCulled:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.frustumCulled=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.frustumCulled=e)},_setNoCullingBE:function(e){this.setFrustumCulled(!e)},_getNoCullingBE:function(){return null!==this.mesh3js&&!this.mesh3js.frustumCulled},clone:function(t){var i=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);!!t&&(this.mesh3js.geometry.boundingSphere&&(i.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()),this.mesh3js.geometry.boundingBox&&(i.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone())),this.mesh3js.copyInstancingInfos(i),i.castShadow=this.mesh3js.castShadow,i.receiveShadow=this.mesh3js.receiveShadow;var r=new THREEDS.Nodes.Mesh(i,this.name);return this.getIsInstanceNode3D()&&r.setIsInstanceNode3D(!0),r},getNodeType:function(){return"InstancingNode3D"}})),l=1,h=2;return o.prototype.getHasExplicitBE=function(){return(this.instance3DBooleanAttr&l)>0},o.prototype.setHasExplicitBE=function(e){this.instance3DBooleanAttr=e?this.instance3DBooleanAttr|l:this.instance3DBooleanAttr&~l},o.prototype.getIsInstanceNode3D=function(){return(this.instance3DBooleanAttr&h)>0},o.prototype.setIsInstanceNode3D=function(e){this.instance3DBooleanAttr=e?this.instance3DBooleanAttr|h:this.instance3DBooleanAttr&~h},o.prototype.forceNoMeshInRAM=function(){var e,t,i=this.mesh3js.geometry;for(e=0;e<i.length;e++){if((t=i[e]).sharedBuffers)throw new Error("Cannot force no mesh in RAM on geometry with sharedBuffers");t.noMeshInRAM||(t.noMeshInRAM=!0,t.vertexBufferGPU&&t.clearMeshInRAM(!1))}},Object.defineProperty(o.prototype,"hasExplicitBE",{get:function(){return this.getHasExplicitBE()},set:function(e){this.setHasExplicitBE(e)}}),Object.defineProperty(o.prototype,"isInstanceNode3D",{get:function(){return this.getIsInstanceNode3D()},set:function(e){this.setIsInstanceNode3D(e)}}),UWA.namespace("THREEDS/Nodes/InstancingNode",o)})),define("Visualization/InstancingNode3D",["DS/Visualization/InstancingNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/InstancingNode3D"),e})),define("DS/Visualization/LoaderInfiniteUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/KDTree","DS/Visualization/FontUtils","DS/SceneGraphNodes/RefPlaneNode","DS/SceneGraphNodes/VoxelVolumeNode","DS/SceneGraphNodes/FixedSizeArrowNode","DS/Visualization/GaussianSplattingUtils"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m){"use strict";return{createInfiniteGeometry:function(t,r,n){var o=null;switch(t){case e._InfiniteGeomertryType.VOXEL_REP:o=new f(r),n.flexibleBatching||(n.voxelNode||(n.voxelNode=[]),n.voxelNode.push(o));break;case e._InfiniteGeomertryType.GAUSSIAN_SPLAT_REP:if(o=new m({}).createNode3DFromSplatBuffer(r.splatBuffer),r.splatMatrix){let t=o.getMatrix(),i=(new e.Matrix4).multiplyMatrices(r.splatMatrix,t);o.setMatrix(i)}n.flexibleBatching||(n.gaussianSplatNode||(n.gaussianSplatNode=[]),n.gaussianSplatNode.push(o));break;case e._InfiniteGeomertryType.REF_PLANE:var l=function(t,i){for(var r=[],n=1/e.getPixelsPerMM(),a=e.getDevicePixelRatio()/n,o=0;o<t.length;o++){var l=t[o],d=null,u=l.lengthX*a,f=l.lengthY*a,g=new e.Vector3(l.xAxis[0],l.xAxis[1],l.xAxis[2]),m=new e.Vector3(l.yAxis[0],l.yAxis[1],l.yAxis[2]),v=((new e.Vector3).crossVectors(g,m),new e.Vector3(l.origin[0],l.origin[1],l.origin[2])),_=new s.Color(l.color[0]/255,l.color[1]/255,l.color[2]/255,l.color[3]/255);if(new e.Color(_),"CAT3DReferencePlaneRep"===l.type){var y=l.mode;y?(l.lengthX*=1/n,l.lengthY*=1/n):l.autoSize&&(l.lengthX*=1.05,l.lengthY*=1.05);var S=l.refPlaneData,b=!S||!S._wireframeMode,x=(!!S&&S._orientationVisibility,!S||S._labelVisibility),w=S?S._opacity/255:.075,P=S?new e.Color(S._frontColor):new e.Color("#005686"),C=S?new e.Color(S._backColor):new e.Color("#a3c8dc"),M={name:"ref Plane "+o,fill:!0,newLook:b,fixedSize:y,size:new e.Vector2(l.lengthX,l.lengthY),planeAttributes:{front:{color:P,opacity:w},back:{color:C,opacity:w}},borderAttributes:{front:{color:P,opacity:.8,width:1},back:{color:C,opacity:.8,width:1}}};x&&(M.textAttributes={fixedSize:!0,front:{data:l.label,color:P,opacity:1,size:30},back:{data:l.label,color:C,opacity:1,size:30}}),d=new p(M)}else if(l.zoomable){(d=c.createRectangleNode({color:_,width:u,height:f,fill:!1})).setShadow(!1),d.setFrustumCulled(!1);var E=new e.Vector3(.7071068*-u/2,.7071068*-f/2,0),T=(new e.Matrix4).setPosition(E);d.setMatrix(T)}else{var A=null;i.sgRep&&(A=i.sgRep[l.rep]),M={sgRep:A,origin:v,direction2:new e.Vector3(l.xAxis[0]+l.yAxis[0],l.xAxis[1]+l.yAxis[1],l.xAxis[2]+l.yAxis[2]),direction1:new e.Vector3(l.xAxis[0]-l.yAxis[0],l.xAxis[1]-l.yAxis[1],l.xAxis[2]-l.yAxis[2]),color:_,length1:.7071068*u,length2:.7071068*f,name:"ref Plane "+o},d=new h(M)}r.push(d)}return r}(r,n);if(n.flexibleBatching){if(l.length){(o=new i)._setPickParentWithPrimitives(!0),o._forceGeomType("INFINITE_FACE");for(d=0;d<l.length;d++)e.__NoShowForAxisAndPlanesBags()&&(l[d].setVisibility(!1),l[d].setVisibilityInTree(!1)),l[d].setNoZ(!0),o.addChild(l[d])}}else if(n.refPlanesNode||(n.refPlanesNode=new i("RefPlanes"),n.refPlanesNode._setPickParentWithPrimitives(!0),n.refPlanesNode.setNoZ(!0),e.__NoShowForAxisAndPlanesBags()&&(n.refPlanesNode.setVisibility(!1),n.refPlanesNode.setVisibilityInTree(!1))),l.length)for(var d=0;d<l.length;d++)n.refPlanesNode.addChild(l[d]);break;case e._InfiniteGeomertryType.AXIS_SYSTEM:o=function(t,r){var n=t,o=new i;o._setPickParentWithPrimitives(!0);var l=null,h=n.zoomable||!1;t={sgRep:r.sgRep&&r.sgRep[n.rep],headLength:10,arrowLength:h?n.length:50,arrowWidth:2,sceneGraph:o,colors:{colorX:new s.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255),colorY:new s.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255),colorZ:new s.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255)},name:"axis System 1",head:a.types.ARROW,zoomable:h},l=new a(t);var d=new e.Matrix4,u=[];if(u[0]=n.xAxis[0],u[1]=n.xAxis[1],u[2]=n.xAxis[2],u[3]=0,u[4]=n.yAxis[0],u[5]=n.yAxis[1],u[6]=n.yAxis[2],u[7]=0,u[8]=n.zAxis[0],u[9]=n.zAxis[1],u[10]=n.zAxis[2],u[11]=0,u[12]=n.origin[0],u[13]=n.origin[1],u[14]=n.origin[2],u[15]=1,d.setFromArray(u),l.setMatrix(d),void 0!==n.refPlanes){var p=null;if(h){(p=new i)._setPickParentWithPrimitives(!0);for(var f=null,g=0;g<n.refPlanes.length;g++){var m=new s.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255);f=n.refPlanes[g];var v=[new e.Vector3(f[0],f[1],f[2]),w=new e.Vector3(f[3],f[4],f[5]),new e.Vector3(f[6],f[7],f[8])];(y=c.createLineNode({points:v,color:m})).setShadow(!1),y.setFrustumCulled(!1),p.addChild(y)}}else{(p=new i("fixedSizeHalfPlanes"))._setPickParentWithPrimitives(!0);var _=(new e.Matrix4).getInverse(d);for(n.xAxis,n.yAxis,n.zAxis,g=0;g<n.refPlanes.length&&1===n.refPlanes[g].mode;g++){var y,S=n.refPlanes[g].length*e.getDevicePixelRatio()/.264583333,b=(m=new s.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255),n.refPlanes[g].direction1),x=n.refPlanes[g].direction2,w=new e.Vector3(.5*S*b[0],.5*S*b[1],.5*S*b[2]);v=[new e.Vector3(w.x+.25*S*(b[0]+x[0]),w.y+.25*S*(b[1]+x[1]),w.z+.25*S*(b[2]+x[2])),w,new e.Vector3(w.x+.25*S*(b[0]-x[0]),w.y+.25*S*(b[1]-x[1]),w.z+.25*S*(b[2]-x[2]))],(y=c.createLineNode({points:v,color:m})).setShadow(!1),y.setFrustumCulled(!1),p.addChild(y)}var P=(new e.Matrix4).multiplyMatrices(_,(new e.Matrix4).setPosition(new e.Vector3(n.origin[0],n.origin[1],n.origin[2])));p.setMatrix(P),p._setRatio(1)}p.setNoZ(!0),l.addChild(p)}return l}(r,n),n.flexibleBatching?o&&o._forceGeomType&&o._forceGeomType("AXIS_SYSTEM"):(n.axisSystemsNode||(n.axisSystemsNode=new i("AxisSystems"),n.axisSystemsNode._setPickParentWithPrimitives(!0),e.__NoShowForAxisAndPlanesBags()&&(n.axisSystemsNode.setVisibility(!1),n.axisSystemsNode.setVisibilityFree(!0),n.axisSystemsNode.setVisibilityInTree(!1))),o&&n.axisSystemsNode.addChild(o));break;case e._InfiniteGeomertryType.CANONICAL:o=function(e){var t=0,i=1,r=2,n=3,s=4,a=5,o=6,l=7;switch(e.canonicalType){case t:console.log("Cone");break;case i:console.log("Cylinder");break;case r:console.log("Pipe");break;case n:console.log("Cuboid");break;case a:console.log("PartialSphere");break;case s:console.log("Sphere");break;case l:console.log("PartialTore");break;case o:console.log("Tore")}return null}(r);break;case e._InfiniteGeomertryType.ARROWS:l=function(t){for(var i=[],r=e.getDevicePixelRatio()/.264583333,n=0;n<t.length;n++){var a=t[n],o=null,l=a.length*r,h=new e.Vector3(a.direction[0],a.direction[1],a.direction[2]);h.normalize();var c=new e.Vector3(0,1,0),d=new e.Vector3(1,0,0),u=new e.Vector3(a.origin[0],a.origin[1],a.origin[2]);1!==h.z&&((c=(new e.Vector3).crossVectors(new e.Vector3(0,0,1),h)).normalize(),(d=(new e.Vector3).crossVectors(c,h)).normalize());var p=(new e.Matrix4).makeBasis(d,c,h);p.setPosition(u);var f={name:"arrow"+n,pickable:!0,color:new s.Color(a.color[0]/255,a.color[1]/255,a.color[2]/255,a.color[3]/255),head:g.types.ARROW,arrowLength:l,arrowWidth:1};o=new g(f),a.noShow&&o.setVisibility(!1),o.setMatrix(p),a.infiniteFace&&o._forceGeomType("AXIS_SYSTEM"),i.push(o)}return i}(r);if(n.flexibleBatching){if(l.length){(o=new i)._setPickParentWithPrimitives(!0);for(d=0;d<l.length;d++)o.addChild(l[d])}}else if(n.refArrowsNode||(n.refArrowsNode=new i("Arrows"),n.refArrowsNode._setPickParentWithPrimitives(!0)),l.length)for(var d=0;d<l.length;d++)n.refArrowsNode.addChild(l[d])}return o}}})),define("DS/Visualization/LoaderUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/KDTree","DS/Visualization/FontUtils","DS/SceneGraphNodes/RefPlaneNode","DS/SceneGraphNodes/VoxelVolumeNode","DS/SceneGraphNodes/FixedSizeArrowNode","DS/Visualization/LoaderInfiniteUtils","DS/Visualization/PathElement","DS/Visualization/RenderStyle"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_){"use strict";var y=null;class S{constructor({xmlMaterial:e,materialFiles:t,resources:i,options:r}){this.xmlMaterial=e,this.materialCache=[],this.materialFiles=t,this.resourcesImage=i,this.decalCache=new Map,this.materialManager=new n,this.materialManager.cleanResources(),this._sceneGraphOrderMode=0,r.textureInBlack&&this.processTextureInBlack(),r.sceneGraphOrderMode&&(this._sceneGraphOrderMode=r.sceneGraphOrderMode),Object.seal(this)}getMaterial(e,t){var i=null,r=!1;return null==e?null:e.file?{mat:this.getMaterialXML(e.id)}:(-1===e.id||4!==t.glType&&!t.forceMaterial||(this.materialCache[e.id]?i=this.materialCache[e.id]:(e.shading&&(this.materialFiles[e.id].shading=e.shading),(i=this.materialManager.getMaterialCgr(this.materialFiles[e.id],void 0,"CGR",this.resourcesImage,t.dg))&&(i._sceneGraphOrderMode=this._sceneGraphOrderMode,this.materialCache[e.id]=i,this.materialFiles[e.id]&&this.materialFiles[e.id].useAsGas&&(null,t.dg.gas=i),void 0!==i.needTangentBinormal&&(i.needTangentBinormal&&t.needTangentBinormal||(i.needTangentBinormal=!1)))),this.materialFiles[e.id]&&this.materialFiles[e.id].useAsGas&&(r=!0)),{mat:i,useAsGas:r})}processTextureInBlack(){this.resourcesImage.length;for(var e=0;e<this.resourcesImage.length;e++){var t=this.resourcesImage[e].img,i=this.resourcesImage[e].format;if(2==i)for(var r=0;r<t.length;r+=3)255==t[r]&&255==t[r+1]&&255==t[r+2]&&(t[r]=0,t[r+1]=0,t[r+2]=0);if(3==i)for(r=0;r<t.length;r+=4)255==t[r]&&255==t[r+1]&&255==t[r+2]&&(t[r]=0,t[r+1]=0,t[r+2]=0)}}getMaterialXML(t){var i=this.xmlMaterial.materialLibrary,r=this.xmlMaterial.baseUrl,n=i[t];if(void 0===n)return null;var s=i[n.instance];if(void 0===s)return null;var a=i[s.instance];return void 0===a?null:(void 0===a.material&&void 0!==a.params?(a.material=this.materialManager.getMaterial3DXML(a.params,r,"XMLV43"),a.material.force=!0):void 0===a.params&&(a.material=e.MaterialUtils.createMatteFaceMaterial(),a.material.force=!0),a.material)}}var b=function(e,t,i,r,n){for(var a=e.buffer?e:e.prims,o=e.buffer?null:e.bs,l=a.length/5,h=new s.BinarySGPrimitiveArray(a,i,t,o,5),c=[],d=null,u=null,p=new Set,f=0;f<l;f++){(d=t[a[5*f+1]])._binary=!0,p.has(d)&&d!==u&&console.error("Non contiguious primitive reps"),p.add(d);var g=d._primitives[d._primitives.length-1];g&&d===u?g.count++:d._primitives.push({binary:h,start:f,count:1}),u=d}if(r&&r.noShowPrim&&r.noShowPrim.length){var m=new s.SGPrimitiveHelper;for(f=0;f<r.noShowPrim.length;f++)m.set(i,r.noShowPrim[f]),c.push(m.clone())}return{primitives:h,noShowPrim:c}},x=function(e,t,i,r,n){for(var a=e.buffer?e:e.prims,o=(e.buffer||e.bs,a.length/5),l=new Array(o),h=[],c=-1,d=null,u=0,p=0,f=0,g=null,m=0,v=0;v<o;v++)c=a[m++]-1,d=t[a[m++]],u=a[m++],p=a[m++],f=a[m++],g=new s.SGPrimitive({cgmId:c,rep:d,start:u,count:p,decoration:f,group:i}),l[v]=g,d._primitives.push(g);if(r&&r.noShowPrim&&r.noShowPrim.length){var _=new s.SGPrimitiveHelper;for(v=0;v<r.noShowPrim.length;v++)_.set(i,r.noShowPrim[v]),h.push(_.clone())}return{primitives:l,noShowPrim:h}},w=function(t,i,a,o){for(var l,h=null,c=!1,d=null,u=[],p=null,f=null,g=new e.Sphere,m=new e.Box3,v=[],_=o.sgRep,y=o.decorations,S=new n,w=0;w<t.length;w++){var P=t[w],C=o.noMeshInRAM,M=new e.BufferGeometryDS,E=new e.Vector3(P.AABB.min[0],P.AABB.min[1],P.AABB.min[2]),T=new e.Vector3(P.AABB.max[0],P.AABB.max[1],P.AABB.max[2]);M.boundingBox=new e.Box3(E,T),M.boundingSphere=M.boundingBox.getBoundingSphere(),null===p&&(p=E),null===f&&(f=T),E.x<p.x&&(p.x=E.x),E.y<p.y&&(p.y=E.y),E.z<p.z&&(p.z=E.z),T.x>f.x&&(f.x=T.x),T.y>f.y&&(f.y=T.y),T.z>f.z&&(f.z=T.z),m.set(p,f),g.radius=f.clone().sub(p).multiplyScalar(.5).length(),g.center=f.clone().add(p).multiplyScalar(.5);for(var A=0;A<P.drawingGroups.length;A++){if(h=P.drawingGroups[A],P.drawingGroups[A]=new s.DrawingGroup(h.gas,h.material,h.glType,h.start,h.count,h._primitives,null,h._geomType,h.gasIndex,-1,h._advancedInheritance),P.drawingGroups[A].numPlanarIndices=h.numPlanarIndices,h.cullingData){let e=4===h.glType?h.count/3:h.count/2,t=0;for(let e=0;e<h.cullingData.repArraysToCull.length;e++)t+=h.cullingData.repArraysToCull[e].length;e/=t,P.drawingGroups[A].cullingData=e>100?new s.DGCullingData(h.cullingData):null}if(o.fromCGR){var D;e._BinaryPrimitives?(D=b(h._primitives,_,P.drawingGroups[A],h),P.drawingGroups[A]._nonBinary=!1):D=x(h._primitives,_,P.drawingGroups[A],h),P.drawingGroups[A]._primitives=D.primitives,v=v.concat(D.noShowPrim)}else{l=(h=P.drawingGroups[A])._primitives;for(var I=0;I<l.length;I++)l[I]=new s.SGPrimitive(l[I]),l[I].group=h}(h=P.drawingGroups[A]).geometry=M;var R=h.gas,O=!1;R.set&&((R=new s.GraphicAttributeSet(R.set,R.rgba,R.webOverride)).getDepthMode()&&(R=new s.GraphicAttributeSetForDepth(R.set,R.rgba,R.webOverride,R.depthPriority)),O=R.getType()>1);c=P.vertexTangentArray&&P.vertexBinormalArray;var L={dg:h,glType:h.glType,forceMaterial:O,needTangentBinormal:c},B=a.getMaterial(h.material,L);if(B&&(B.useAsGas?(R=null,h.gas=B.mat,h.material=B.mat):h.material=B.mat),null!==R)if(R.set){o&&!o.edgeTransparency&&S._getLineWidth(R)>1&&(R.opacity=1),S._gasAllowNMIR(R)||(C=!1);var F=-1;0==R.getType()&&((F=R.getPriority())||(F=4),(h._geomType&e.BodyLinesMask)>0&&(F=-1),R.getAdvancedPriority()&&(F+=16));var V={sceneGraphOrderMode:o.sceneGraphOrderMode};R.isNopick()&&(h._noPick=!0),h._advancedInheritance&&S.hasLineTypes()&&(V.lineType=h._advancedInheritance),h.gas=S._getMaterialFromGAS(R,V),h._noZPriority=F}else{var G=new e.Color;G.setRGB(R.color.r,R.color.g,R.color.b),R.lineWidth&&o&&!o.edgeTransparency&&(R.opacity=1),(R.pattern>1||R.lineWidth>1)&&(C=!1),h.gas=S.getMaterialFromGAS({color:G,opacity:R.opacity,pattern:R.pattern,lineWidth:R.lineWidth,forceLineWidth:R.forceLineWidth,solid:R.solid,symbol:R.symbol,basic:R.basic,resource:a.resourcesImage})}}for(A=0;A<P.drawingGroups.length;A++)(h=P.drawingGroups[A]).computeCompleteSolidStatus();M.drawingGroups=P.drawingGroups,M.decorations=y,M.vertexPositionArray=P.vertexPositionArray,P.positionCompression&&(M.compressionContext=o.compressedTexture,M.useCompressionContext=!0,M.compressedVertices=!0),null!==P.vertexNormalArray&&(M.vertexNormalArray=P.vertexNormalArray),P.normalCompression&&(M.compressedNormals=!0,P.normalCompression==s.CATSGPlayRepDataOptions.NormalOct16Compression&&(M.oct16Normals=!0)),null!==P.vertexUvArray&&(M.vertexUvArray=P.vertexUvArray),null!==P.vertexTangentArray&&(M.vertexTangentArray=P.vertexTangentArray),null!==P.vertexBinormalArray&&(M.vertexBinormalArray=P.vertexBinormalArray),null!==P.vertexColorArray&&(M.vertexColorArray=P.vertexColorArray),M.vertexIndexArray=P.vertexIndexArray,o&&o.sharedBuffers&&(M.sharedBuffers=!0),M.noMeshInRAM=C,u.push(M)}var N=S._getMaterialFromGAS(new s.GraphicAttributeSet(4278190112,-1,2));N.line=S._getMaterialFromGAS(new s.GraphicAttributeSet(4278456337,-1,1)),u.boundingSphere=g,u.boundingBox=m,(d=new e.Mesh(u,N)).fromLoadedModel=!0;for(w=0;w<u.length;w++){s.unindexPoints(u[w])&&(u[w].sharedBuffers=!1)}d.matrixAutoUpdate=!1,d.castShadow=!0,d.receiveShadow=!0;var U=new r(d);(U._setPickParentWithPrimitives(!0),v.length&&U.hide(v),o.accelStruct)&&U._occurrences[0].renderable.computeKDTree(!1);return U},P={__storeCGRNames:1,getEmptyMesh:function(){return y||(y=this.createEmptyMesh()),y},createEmptyMesh:function(){var t=new e.BufferGeometryDS;t.boundingSphere=new e.Sphere(new e.Vector3,0),t.boundingBox=new e.Box3;var i=e.MaterialUtils.createShinyFaceMaterial(),n=new e.Mesh(t,i);return n.matrixAutoUpdate=!1,n.castShadow=!0,n.receiveShadow=!0,new r(n)},createMeshes:function(t,r,n,s,a){for(var l=null,h=!0,c=0;c<t.length;c++)if(t[c].length){if(1&c||8&c){if((l=new i)._setPickParentWithPrimitives(!0),l.name=r.node+"_parallelToScreen",!(1&c)){for(d=0;d<t[c].length;++d){(p=w(t[c][d].tab,0,s,a)).setRatio(1);f=t[c][d].globalMatrix;if((u=new o({type:"Spherical"}))._setPickParentWithPrimitives(!0),u.addChild(p),f){g=(new e.Matrix4).setFromArray(f.elements),m=(new e.Vector3).getScaleFromMatrix(g),v=(new e.Matrix4).scale(m);u.setMatrix(g),p.setMatrix(v)}l.addChild(u)}0==l.children.length&&(l=null),l&&(n.push(l),h=!1);continue}for(var d=0;d<t[c].length;++d){var u,p=w(t[c][d].tab,0,s,a),f=t[c][d].globalMatrix;if((u=new o({type:"Spherical"}))._setPickParentWithPrimitives(!0),u.addChild(p),f){var g=(new e.Matrix4).setFromArray(f.elements),m=(new e.Vector3).getScaleFromMatrix(g),v=(new e.Matrix4).scale(m);u.setMatrix(g),p.setMatrix(v)}l.addChild(u)}0==l.children.length&&(l=null)}else l=w(t[c],0,s,a),1===this.__storeCGRNames&&(l.name=r.node);2&c&&l.setExcludeFromBounding(!0),4&c&&l.setNoZ(!0),l&&(n.push(l),a.depthMode2D&&(l._forceDepthPriorityMode=!0),h=!1)}return h},processData:function(r,a,o,l,h,c){h||(h={});var d=new S({xmlMaterial:o,materialFiles:a.material,resources:a.resource,options:h});a.compound&&(h.udlMode=!0);var p=h.udlMode,f=function(t,i){var r=1,n=2,s=3,a=4,o=5,l=6,h=7,c=9;if(i===0);else{var d=!1,u=e.GeomTypeEnum.EDGE|e.GeomTypeEnum.SHARP_EDGE|e.GeomTypeEnum.SMOOTH_EDGE|e.GeomTypeEnum._HIGH_CURVATURE_EDGE|e.GeomTypeEnum.BOUNDARY_EDGE|e.GeomTypeEnum.FACE|e.GeomTypeEnum.INFINITE_FACE|e.GeomTypeEnum._OUTLINE,p=new _({faceMode:null});switch(p._displayNothingRenderMode(),p.setReplaceMask(u),i){case r:p.setRenderMode("Face",!0),p.setRenderMode("InfiniteFace",!0);break;case n:p.setRenderMode("@Edge",!0);break;case s:p.setRenderMode("Face",!0),p.setRenderMode("InfiniteFace",!0),p.setRenderMode("@Edge",!0);break;case a:p.setRenderMode("Face",!0),p.setRenderMode("InfiniteFace",!0);break;case c:p.setRepViewNothing(!0);break;case o:p.setRenderMode("Face",!0),p.setRenderMode("@Edge",!0),p.setRenderMode("Outline",!0),p.setFaceMode("BACKGROUND");break;case l:p.setRenderMode("@Edge",!0),p.setRenderMode("Outline",!0);break;case h:p.setRenderMode("Face",!0),p.setRenderMode("@Edge",!0),p.setRenderMode("Outline",!0);break;default:d=!0}if(!d){let e=t.createOverrideSetManager(),i=e.createSceneGraphOverrideSet();e.pushSceneGraphOverrideSet(i),i.createOverride(new v([t])).setRenderStyle(p,!0)}}},g=function(t,r,n,s,a,o,l,h){if(t&&r){if(t.externalPath&&(t.alreadyCreated||(t.attributes&&t.attributes.length?t.nodeRef=function(t,r){var n=new i;n._setPickParentWithPrimitives(!0);for(var s=0;s<t.length;s++){var a=t[s].typeAttribute,o=t[s].attribute;if(a==e._FilterType.SCISSORFILTER){var l=o[1],h=[];for(s=0;s<l;s++)h.push(o[2+2*s]),h.push(o[2+2*s+1]);n.setScissoringPolyLine({nbPolygon:1,nbVertices:[l],vertices:h,point:new e.Vector3(0,0,0),dirX:new e.Vector3(1,0,0),dirY:new e.Vector3(0,1,0)})}else if(a==e._FilterType.VIEWMODE){var c=o.viewMode;o.viewModeSensitivity,f(n,c)}else if(a==e._FilterType.DECALS){var d=null;if(o&&o.decal){let t=o.decal.decal,i=o.decal.decalApplied>0,s=o.decal.decalAttached>0,a=r.decalCache.get(t.decalIndex);if(a||(a=new Map,r.decalCache.set(t.decalIndex,a)),o.material){let t=r.getMaterial(o.material,{forceMaterial:!0});d=t&&t.mat?t.mat.clone():new e.PhysicalMaterial}else d=new e.PhysicalMaterial;let l=o.mapping||{};var u=new e.Matrix4;t.decalMatrix&&(u=new e.Matrix4(t.decalMatrix[0],t.decalMatrix[4],t.decalMatrix[8],t.decalMatrix[12],t.decalMatrix[1],t.decalMatrix[5],t.decalMatrix[9],t.decalMatrix[13],t.decalMatrix[2],t.decalMatrix[6],t.decalMatrix[10],t.decalMatrix[14],t.decalMatrix[3],t.decalMatrix[7],t.decalMatrix[11],t.decalMatrix[15]));let h=void 0!==t.decalImplicitScaleU?t.decalImplicitScaleU:1,c=void 0!==t.decalImplicitScaleV?t.decalImplicitScaleV:1,p=t.decalMode>0,f=new e.Matrix3(h,0,0,0,c,0,0,0,1);d.mappingUVTransformation&&(f=(new e.Matrix3).multiplyMatrices(f,d.mappingUVTransformation)),d.setMappingOperator(t.decalProjector,new e.Matrix4,f,!0,l.transformSemantic);let g=e.DecalManager.createDecal({matrix:u,material:d,explicitUv:p});d.force=!0,g.setLegacyLayer(o.layer,!1),g.setLegacyInheritance(o.inheritanceMaterial),g.__shareAttachementFrom(a),i&&g.applyOn(n),s&&g.attachTo(n)}}}return n}(t.attributes,h):(t.nodeRef=new i,t.nodeRef._setPickParentWithPrimitives(!0)),t.externalMatrix&&t.nodeRef.setMatrix((new e.Matrix4).setFromArray(t.externalMatrix.elements)),t.alreadyCreated=!0),s&&s.addChild(t.nodeRef),s=t.nodeRef),t.textIndice)for(var c=l[t.textIndice-1],d=0;d<c.length;d++)s.addChild(c[d]);if(t.batchInfo&&t.batchInfo.length)for(var u=0;u<t.batchInfo.length;u++){var p=t.batchInfo[u].typeGeom,m=t.batchInfo[u].batchIndex,v=[];switch(p){case e._InfiniteGeomertryType.REF_PLANE:case e._InfiniteGeomertryType.AXIS_SYSTEM:case e._InfiniteGeomertryType.ARROWS:case e._InfiniteGeomertryType.CANONICAL:case e._InfiniteGeomertryType.VOXEL_REP:case e._InfiniteGeomertryType.GAUSSIAN_SPLAT_REP:v=a[m];break;case e._InfiniteGeomertryType.TESSELATION:v=n[m];break;case e._InfiniteGeomertryType.CURVED_PIPE:v=o[m]}if(v)if(Array.isArray(v))for(var _=0;_<v.length;_++)s.addChild(v[_]);else s.addChild(v)}if(t.children){var y=t.children,S=null,b=y.length;for(d=0;d<b;d++)if(y[d].children)g(y[d],r,n,s,a,o,l,h);else{if(y[d].batchInfo&&y[d].batchInfo.length)for(u=0;u<y[d].batchInfo.length;u++){p=y[d].batchInfo[u].typeGeom,m=y[d].batchInfo[u].batchIndex,v=[];switch(p){case e._InfiniteGeomertryType.REF_PLANE:case e._InfiniteGeomertryType.AXIS_SYSTEM:case e._InfiniteGeomertryType.ARROWS:case e._InfiniteGeomertryType.CANONICAL:case e._InfiniteGeomertryType.VOXEL_REP:case e._InfiniteGeomertryType.GAUSSIAN_SPLAT_REP:v=a[m];break;case e._InfiniteGeomertryType.TESSELATION:v=n[m];break;case e._InfiniteGeomertryType.CURVED_PIPE:v=o[m]}if(v)if(Array.isArray(v))for(_=0;_<v.length;_++)s.addChild(v[_]);else s.addChild(v)}if(y[d].textIndice){var x=l[y[d].textIndice-1];s.addChild(x)}y[d].parents&&y[d].parents[0]||(y[d].added?(r[y[d].ind].parents[0]=t,S=r[y[d].ind],y[d]=S):(r[y[d]].parents[0]=t,S=r[y[d]],y[d]=S))}}}},y=function(){this.children=[]};y.prototype.addChild=function(e){this.children.push(e)};var b,x=null,w=[],C=[],M=[],E=[],T=[],A=!1,D=!1,I=!1,R=null,O=function(e){if(!A&&D){if(r&&!h.unlinkToSG){if(a.sceneGraph){if(p&&R&&R.length)for(var t=0;t<R.length;t++)b.addChild(R[t]);g(a.sceneGraph,F,C,b,T,M,E,d),b._buildSGBagNodes(),e||(w=[b])}if(l){for(var i=0;i<r.length;i++)r[i]&&(e?((x=P.createEmptyMesh()).name=a.node,r[i].addChild(x)):(r[i].addChild(b),w=[b]));a.sceneGraph&&a.sceneGraph.noShow&&!h.forceNoShowCGR&&b.setVisibility(!1)}else for(i=0;i<r.length;i++)if(r[i])if(r[0].length&&(r=r[0]),e)(x=P.createEmptyMesh()).name=a.node,r[i].addChild(x);else if(p)r[i].addChild(b);else for(t=0;t<b.children.length;t++)r[i].addChild(b.children[t])}c&&c(w,{textHasBeenProcessed:I,cullingData:h.cullingData})}};l||h.udlMode?(b=new t(a.sceneGraph,a.node,a.sag),h.fromOOC&&b._setPickParentWithPrimitives(!0)):b=new y;new n;var L=!0;h.fromCGR=!0,h.flexibleBatching=p;var B=[];if(a.rep&&(B[0]=[a.rep],h.fromCGR=!1),a.reps&&(B=a.reps),h.fromCGR){var F=function(e,t){if(!e)return[];var i=3;t.withSAG&&(i+=1),t.repWithBS&&(i+=4),t.udlMode&&(i+=2);var r=e.length/i,n=new Array(r),a=0;if(t.withSAG)if(t.repWithBS)for(var o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++],sag:e[a++],boundingSphere:{radius:e[a++],center:[e[a++],e[a++],e[a++]]}});else for(o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++],sag:e[a++]});else if(t.repWithBS)for(o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++],boundingSphere:{radius:e[a++],center:[e[a++],e[a++],e[a++]]}});else for(o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++]});return n}(a.sgRep,h);h.sgRep=F,h.decorations=a.decorations,h.keepCompression&&(h.compressedTexture=function(t){const i=t.length/3,r=Math.ceil(Math.sqrt(i)),n=e.ImageUtils.nearest_greater_pow2(r);let s=new Float32Array(3*n*n);for(let e=0;e<t.length;e++)s[e]=t[e];let a=new e.DataTexture(s,n,n,e.RGBFormat,e.FloatType);return a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.generateMipmaps=!1,a.flipY=!1,a.needsUpdate=!0,a}(a.compressedArray))}if(B.length){C=new Array(B.length);for(var V=0;V<B.length;V++){C[V]=[],this.createMeshes(B[V],a,C[V],d,h)||(L=!1)}if(p){if(-1!==a.rootBatch){var G=C[a.rootBatch.indice];R=G}}else for(V=0;V<C[0].length;V++)b.addChild(C[0][V]),w.push(C[0][V])}var N={refPlanesNode:null,refArrowsNode:null,axisSystemsNode:null,voxelNode:null,gaussianSplatNode:null,sgRep:F,flexibleBatching:p};if(a.infiniteGeometries){for(V=0;V<a.infiniteGeometries.length;++V){L=!1;var U=a.infiniteGeometries[V],k=m.createInfiniteGeometry(U.type,U.params,N);p&&T.push(k)}if(!p){if(N.refPlanesNode&&(N.refPlanesNode._forceGeomType("INFINITE_FACE"),w.push(N.refPlanesNode),b.addChild(N.refPlanesNode)),N.refArrowsNode&&(w.push(N.refArrowsNode),b.addChild(N.refArrowsNode)),N.axisSystemsNode&&(N.axisSystemsNode._forceGeomType("AXIS_SYSTEM"),w.push(N.axisSystemsNode),b.addChild(N.axisSystemsNode)),N.voxelNode)for(V=0;V<N.voxelNode.length;++V)w.push(N.voxelNode[V]),b.addChild(N.voxelNode[V]);if(N.gaussianSplatNode)for(V=0;V<N.gaussianSplatNode.length;++V)w.push(N.gaussianSplatNode[V]),b.addChild(N.gaussianSplatNode[V])}}if(h.processText&&a.texts&&a.texts.length>0){A=a.texts.length,L=!1,I=!0;for(var z=function(e){for(var t=0;t<e.length;++t)p?E.push(e[t]):(w.push(e[t]),b.addChild(e[t]));A--,O(L)},H=0;H<a.texts.length;++H)u.createTexts(a.texts[H],h,z)}D=!0,O(L)},isProcessDataAsynchronous:!0};return P})),define("DS/Visualization/SpriteNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],(function(e,t,i){"use strict";var r=t.extend({init:function(t,i){this._parent(i),this.anchor=t;var r=this;return this.cbInit=function(t){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)},this.cbChange=function(t){if("@onViewpointChange"===t.eventType){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)}},this},_onLinkedToSceneGraph:function(){this.tokenInit=i.subscribe({event:"/VISU/SpriteNodeInit"},this.cbInit),this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange)},getNodeType:function(){return"SpriteNode3D"}});return UWA.namespace("THREEDS/Nodes/Sprite",r)})),define("Visualization/SpriteNode3D",["DS/Visualization/SpriteNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/SpriteNode3D"),e})),define("DS/Visualization/LightNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i,r){this._parent(i),this.light3js=void 0!==t?t:new e.AmbientLight,t=this.createRenderable(),this._matrix=(new e.Matrix4).setPosition(new e.Vector3(0,0,1)),this._intensity=t.intensity,this._color=t.color,this._attachedToVpt=!!r;var n=this._occurrences[0];return n.renderable=t,n.renderable.name=this.name,n.renderable._occurrence=n,this},createRenderable:function(){var e=this.light3js.clone();return e.matrixAutoUpdate=!1,e.visible=this.light3js.visible,e.matrixWorldNeedsUpdate=!1,e.castShadow=this.light3js.castShadow,e.shadowCameraLeft=this.light3js.shadowCameraLeft,e.shadowCameraRight=this.light3js.shadowCameraRight,e.shadowCameraTop=this.light3js.shadowCameraTop,e.shadowCameraBottom=this.light3js.shadowCameraBottom,e.shadowCameraNear=this.light3js.shadowCameraNear,e.shadowCameraFar=this.light3js.shadowCameraFar,e.shadowBias=this.light3js.shadowBias,e.shadowDarkness=this.light3js.shadowDarkness,e.shadowMapWidth=this.light3js.shadowMapWidth,e.shadowMapHeight=this.light3js.shadowMapHeight,e.shadowCameraVisible=this.light3js.shadowCameraVisible,e},add:function(){return!1},updateShadowMap:function(){var e,t;for(null!==this.light3js&&(this.light3js.updateShadowMap=!0),e=0;e<this._occurrences.length;e++)null!==(t=this._occurrences[e]).renderable&&(t.renderable.updateShadowMap=!0)},blockShadowUpdates:function(e){var t,i;for(null!==this.light3js&&(this.light3js.blockUpdate=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.blockUpdate=e)},attachToViewpoint:function(e){this._attachedToVpt=e},setIntensity:function(e){this._intensity=void 0===e?1:e,this._updateIntensity()},_updateIntensity:function(){var e,t;for(this.light3js.intensity=this._intensity,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.intensity=this._intensity},setColor:function(t){t instanceof e.Color?this._color=t:this._color=new e.Color(t),this._updateColor()},setPhysical:function(e){let t,i=this._occurrences.length;for(this.light3js._phongReduction=!!e,t=0;t<i;t++){this._occurrences[t].renderable._phongReduction=!!e}},_updateColor:function(){var e,t;for(this.light3js.color=this._color,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.color=this._color},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"LightNode3D"},_setShadowCameraVisible:function(e){this.light3js.shadowCameraVisible=e;let t=this._occurrences.length;for(let i=0;i<t;i++){this._occurrences[i].renderable.shadowCameraVisible=e}},dispose:function(){let e;for(e=0;e<this._occurrences.length;e++){this._occurrences[e].renderable.dispose()}}});return UWA.namespace("THREEDS/Nodes/Light",i)})),define("Visualization/LightNode3D",["DS/Visualization/LightNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/LightNode3D"),e})),define("DS/Visualization/ParticlesNode3D",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],(function(e,t,i){"use strict";var r=i.extend({init:function(e,i){this._parent(i);var r=e.material?e.material:null;t.disableJHGDev||(this.material=r),this.particles3js=void 0!==e?e:new t.ParticleSystem;var n=t.convertParticleSystemToBufferGeometryDS(this.particles3js.geometry);this.particles3js=new t.Mesh(n,r),this.particles3js.frustumCulled=!1,e=this.createRenderable();var s=this._occurrences[0];return s.renderable=e,s.renderable.name=this.name,s.renderable._occurrence=s,this.hasExplicitBE=!0,this.explicitBSphere=null,this.explicitBBox=null,void 0!==this.particles3js.geometry.boundingSphere&&(this.explicitBSphere=this.particles3js.geometry.boundingSphere.clone()),this},createRenderable:function(){var e=this.particles3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.particles3js.visible,e.pickable=this.particles3js.pickable,e.noPickThrough=this.particles3js.noPickThrough,e.renderDepth=this.particles3js.renderDepth,e.frustumCulled=this.particles3js.frustumCulled,e.enableNormalDepth=!1,e},add:function(){return!1},setPickable:function(t){var i,r;for("boolean"==typeof t&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),null!==this.particles3js&&(this.particles3js.pickable=t===e.PICKABLE,this.particles3js.noPickThrough=t!==e.PICKTHROUGH),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.pickable=this.particles3js.pickable,r.renderable.noPickThrough=this.particles3js.noPickThrough,r.renderable._flagAsGSSOInvalidated())},getNodeType:function(){return"ParticlesNode3D"}});return UWA.namespace("THREEDS/Nodes/Particles",r)})),define("Visualization/ParticlesNode3D",["DS/Visualization/ParticlesNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/ParticlesNode3D"),e})),define("DS/Visualization/ViewpointManager",["DS/Mesh/ThreeJS_Base","DS/Visualization/InternalSceneGraph","DS/VisuEvents/EventsManager","DS/Visualization/TrackballControls","DS/CoreEvents/Events"],(function(e,t,i,r,n){"use strict";var s=function(e){this.viewer=e,this.currentDocument=this.viewer.contextDocument,this.vpList=[],this.viewpointInfos=new Map,this._registeredViewpoints=new Map,this.defaultSceneGraph=null,this.manipulated=null,this.warnCount=0,this._viewerWatcher=void 0,this._multiViewCount=0;this._addMultiViewEvents()};return s.prototype.addViewpoint=function(e,i,r,n){e.control&&(e.isMain()&&null==this.manipulated?this.setManipulatedViewpoint(e):e.control.setActive&&e.control.setActive(!1)),null!=this.manipulated&&this.manipulated.control&&this.manipulated.control.updateEditGesture&&this.manipulated.control.updateEditGesture();let s=r?250:50;void 0!==n&&(s+=n),this.vpList.push(e);let a={viewport:null,scenegraph:null,sceneInstance:0,vpEditor:!0,locks:0,isMultiView:!1,order:s,activated:!0};if(i)a.sceneInstance=this.defaultSceneGraph.addSceneInstance(),a.scenegraph=this.defaultSceneGraph,e._setInternalSceneGraph(this.defaultSceneGraph);else{let i=new t(this.viewer,!0,!1,e._isMain);var o=this.defaultSceneGraph.selectionHL,l=this.defaultSceneGraph.selectionPreHL,h=i.selectionHL,c=i.selectionPreHL;h&&h.setHighlightData(o.advanced,o.highlightData),c&&c.setHighlightData(l.advanced,l.highlightData),e._setInternalSceneGraph(i),a.scenegraph=i,e._isMain&&i.scene.add(this.viewer.ambientLight)}this.viewpointInfos.set(e,a),this.orderViewpoints()},s.prototype.getViewpointInfos=function(e){return this.viewpointInfos.get(e)},s.prototype.setOrderCSIViewpoints=function(e){let t=100,i=this.getVpList(!1);for(let r=0;r<e.length;r++){let n=e[r].getUID();for(let e=0;e<i.length;e++){let r=i[e];if(n==r.getCsiUID()){this.viewpointInfos.get(r).order=t++;break}}}this.orderViewpoints()},s.prototype.orderViewpoints=function(){let e=this;this.vpList.sort((function(t,i){let r=e.viewpointInfos.get(t),n=e.viewpointInfos.get(i);return r.order-n.order}))},s.prototype.clearNonCSIViewpoints=function(){let e=this.getVpList(!1);for(let t=e.length-1;t>=0;t--){let i=e[t];null===i.getCsiUID()&&this.removeViewpoint(i)}},s.prototype.removeViewpoint=function(e){this.manipulated&&this.manipulated.id==e.id&&this.setManipulatedViewpoint(null),this.viewer.currentViewpoint&&this.viewer.currentViewpoint.id==e.id&&(this.viewer.currentViewpoint=null);let t=this.vpList.indexOf(e);if(t>=0){this.vpList.splice(t,1),e._setInternalSceneGraph(null);let i=this.viewpointInfos.get(e);i&&(i.isMultiView&&this._multiViewCount--,i.scenegraph.freeSceneInstance(i.sceneInstance),i.scenegraph!=this.defaultSceneGraph&&i.scenegraph.dispose(!0)),this.viewpointInfos.delete(e)}},s.prototype.addMainViewpoint=function(e,t,i,r){e._isMain=!0,this.addViewpoint(e,t,i,r)},s.prototype.setManipulatedViewpoint=function(t){if(t&&!t.control)return;null===this.viewer.currentViewpoint&&(this.viewer.currentViewpoint=t);let i=t&&(!this.getViewpointInfos(t)||this.getViewpointInfos(t).vpEditor);this.manipulated==t&&i||(this.manipulated&&this.manipulated.control.setActive&&this.manipulated.control.setActive(!1),t&&i?(t.control.setActive&&t.control.setActive({viewpoint:!0}),this.manipulated=t,this._multiViewPreviousMatrix=(new e.Matrix4).getInverse(this.manipulated.camera.matrix),this._multiViewPreviousDistanceToTarget=this.manipulated.control&&this.manipulated.control.distanceToTarget):(this.manipulated=null,this._multiViewPreviousMatrix=null,this._multiViewPreviousDistanceToTarget=null))},s.prototype.getManipulatedViewpoint=function(){return this.manipulated},s.prototype.hasMovingViewpoint=function(){let e=this.getManipulatedViewpoint();return!(!e||!e.isMoving())},s.prototype.setViewpointActivation=function(e,t){let i=this.viewpointInfos.get(e);i&&(i.activated=t)},s.prototype.setViewpointViewport=function(e,t,i,r,n,s){let a=this.viewpointInfos.get(e);a&&(a.viewport={fixed:t,x:i,y:r,width:n,height:s},this.resizeViewpoint(e))},s.prototype.getViewpointViewport=function(e){let t=this.viewpointInfos.get(e);if(!t)return null;let i=t.viewport;if(i){if(i.fixed)return{x:i.x*this.viewer.devicePixelRatio,y:i.y*this.viewer.devicePixelRatio,width:i.width*this.viewer.devicePixelRatio,height:i.height*this.viewer.devicePixelRatio};{let e=Math.round(i.x*this.viewer.SCREEN_WIDTH*this.viewer.devicePixelRatio),t=Math.round(i.width*this.viewer.SCREEN_WIDTH*this.viewer.devicePixelRatio);return{x:e,y:Math.round(i.y*this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio),width:t,height:Math.round(i.height*this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio)}}}return null},s.prototype.resizeViewpoint=function(e,t,i){let r=this.getViewpointViewport(e),n=t||this.viewer.SCREEN_WIDTH,s=i||this.viewer.SCREEN_HEIGHT;r&&(n=r.width,s=r.height),e.camera.aspect=n/s,e.camera.updateProjectionMatrix(),e.connectedRobotCamera.aspect=n/s,e.connectedRobotCamera.updateProjectionMatrix(),e.robotCameraOrtho.aspect=n/s,e.robotCameraOrtho.setVisualizedHeight(400,e.robotCameraOrtho.aspect),e.robotCameraOrtho.updateProjectionMatrix(),e.control&&e.control.update(),e.resize(n,s)},s.prototype.resize=function(e,t){if(this.isViewpointManagerOverridenBadly())this.resizeViewpoint(this.viewer.currentViewpoint,e,t);else{let i=this.getVpList(!1);for(let r=0;r<i.length;r++){let n=i[r];this.resizeViewpoint(n,e,t)}}},s.prototype.setDefaultSceneGraph=function(e){this.defaultSceneGraph=e},s.prototype.getViewpointScenegraph=function(e){let t=this.viewpointInfos.get(e);return t?t.scenegraph:null},s.prototype.getViewpointRepresentation=function(e){let t=this.viewpointInfos.get(e);return t?t.sceneInstance:0},s.prototype.getViewpointFromRoot3js=function(e){let t=this.getVpList(!1);for(let i=0;i<t.length;i++){let r=this.getViewpointScenegraph(t[i]),n=this.getViewpointRepresentation(t[i]);if(r&&r._sceneInstances[n]&&r._sceneInstances[n].root3js==e)return t[i]}},s.prototype.isViewpointManagerOverridenBadly=function(){let e=this.viewer.currentViewpoint;if(e){for(let t=0;t<this.vpList.length;t++)if(this.vpList[t]==e)return!1;return this.warnCount<10&&(console.warn("viewer.currentViewpoint wasn't properly processed, you have to go through AddViewpoint/SelectViewpoint api to replace currentViewpoint"),this.warnCount++),!0}return!1},s.prototype.getVpList=function(e){if(this.isViewpointManagerOverridenBadly())return[this.viewer.currentViewpoint];if(e){let e=[];for(let t=0;t<this.vpList.length;t++){this.getViewpointInfos(this.vpList[t]).activated&&e.push(this.vpList[t])}return e}return this.vpList},s.prototype.addNodeToViewpoint=function(e,t){e.sceneGraphRoot?e.sceneGraphRoot.addChild(t):this.warnCount<10&&console.warn("addNodeToViewpoint : this viewpoint don't have an associated scenegraph")},s.prototype.getAuxiliaryScenegraphs=function(){let e=[],t=this.getVpList(!1);for(let i=0;i<t.length;i++){let r=t[i],n=this.viewpointInfos.get(r);n&&n.scenegraph!=this.defaultSceneGraph&&e.push(n.scenegraph)}return e},s.prototype.setCSIInfos=function(e,t){let i=this.getViewpointInfos(e);if(i.vpEditor=void 0!==t.hasEditor?t.hasEditor:i.vpEditor,void 0!==t.locks&&i.locks!=t.locks){if(e.control){let i=e.control;0==t.locks?(i.setMouseRotationActive(!0),i.setTouchRotationActive(!0),i.setZoomActive(!0),i.setPanActive(!0),i.setReframeActive(!0),i.setReframeOnDoubleTap(!0)):(i.setMouseRotationActive(!(4&t.locks)),i.setTouchRotationActive(!(2048&t.locks)),i.setZoomActive(!(1&t.locks||256&t.locks)),i.setPanActive(!(16&t.locks||4096&t.locks)),i.setReframeActive(!(64&t.locks)),i.setReframeOnDoubleTap(!(16384&t.locks)))}i.locks=t.locks}void 0!==t.isMultiView&&i.isMultiView!=t.isMultiView&&(t.isMultiView?this._multiViewCount++:(this._multiViewCount--,this.setManipulatedViewpoint(e)),i.isMultiView=t.isMultiView),e.control&&this._viewerWatcher&&this._viewerWatcher.updateVPCSIInfos(e,t)},s.prototype.setViewerWatcher=function(e){e&&(this._viewerWatcher=e)},s.prototype.onA2XViewSectionCommand=function(e){this._viewerWatcher&&this._viewerWatcher.onA2XViewSectionCommand(e)},s.prototype.isA2X=function(){return!!this._viewerWatcher},s.prototype._set2DMode=function(e,t){let i=this.getVpList(!1);for(let r=0;r<i.length;r++){let n=i[r];n._isMain&&n._set2DMode(e,t)}},s.prototype._needClear=function(e){let t=this.getVpList(!0),i=!1;for(let e=0;e<t.length;e++)if(t[e]._isMain){i=!0;break}return!i&&t[0].id===e.id},s.prototype.updateApplicationController=function(){let e=this.getVpList(!1);for(let t=0;t<e.length;t++)e[t]._setApplicationDefaultController()},s.prototype.hasMain=function(){let e=this.getVpList(!0);for(let t=0;t<e.length;t++)if(e[t]._isMain)return!0;return!1},s.prototype.setMultiViewSyncMode=function(t){this._multiViewSyncMode=t;let i=this.getManipulatedViewpoint();this._multiViewPreviousMatrix=i&&(new e.Matrix4).getInverse(i.camera.matrix),this._multiViewPreviousDistanceToTarget=i&&i.control&&i.control.distanceToTarget},s.prototype.checkMultiViewSync=function(t){if(!this._multiViewSyncMode)return;let i=this.getManipulatedViewpoint();if(i&&this.getViewpointInfos(i)&&this.getViewpointInfos(i).isMultiView&&t&&t.viewpoint&&t.viewpoint==i){if(this._multiViewPreviousMatrix){let t=this.getVpList(!0),r=(new e.Matrix4).multiplyMatrices(this._multiViewPreviousMatrix,i.camera.matrix),n=i.control.distanceToTarget/this._multiViewPreviousDistanceToTarget,s=1e-6,a=(1!=n&&Math.abs(r.elements[0]-1)<=s&&Math.abs(r.elements[5]-1)<=s&&Math.abs(r.elements[10]-1)<=s&&Math.abs(r.elements[1])<=s&&Math.abs(r.elements[2])<=s&&Math.abs(r.elements[4])<=s&&Math.abs(r.elements[6])<=s&&Math.abs(r.elements[8])<=s&&Math.abs(r.elements[9]),i.getProjectionType());for(let s=0;s<t.length;s++){let o=t[s];if(!this.getViewpointInfos(o).isMultiView||o==i||!o.control)continue;let l=o.control.distanceToTarget*n,h=(new e.Matrix4).multiplyMatrices(o.camera.matrix,r),c=new e.Vector3,d=new e.Quaternion,u=new e.Vector3;h.decompose(c,d,u),o.moveTo({eyePosition:c,orientation:d,distanceToTarget:l}),o.setProjectionType(a),1==a&&o.camera.fov!=i.fov&&(o.camera.fov=i.fov,o.camera.updateProjectionMatrix())}}this._multiViewPreviousMatrix=(new e.Matrix4).getInverse(i.camera.matrix),this._multiViewPreviousDistanceToTarget=i.control&&i.control.distanceToTarget}},s.prototype._addMultiViewEvents=function(){void 0===i._isInit?i.init():i.addDocument(this.currentDocument),this._onPointerDown=this._onPointerDownCB.bind(this),i.addEvent(this.currentDocument,"onLeftMouseDown",this._onPointerDown),i.addEvent(this.currentDocument,"onRightMouseDown",this._onPointerDown),i.addEvent(this.currentDocument,"onMiddleMouseDown",this._onPointerDown),i.addEvent(this.currentDocument,"onTouch",this._onPointerDown),this._multiViewSyncMode=!1,this._multiViewPreviousMatrix=null,this._multiViewPreviousDistanceToTarget=null,this.tokenChange=n.subscribe({event:"/VISU/"},this.checkMultiViewSync.bind(this))},s.prototype._removeMultiViewEvents=function(){i.removeEvent(this.currentDocument,"onLeftMouseDown",this._onPointerDown),i.removeEvent(this.currentDocument,"onRightMouseDown",this._onPointerDown),i.removeEvent(this.currentDocument,"onMiddleMouseDown",this._onPointerDown),i.removeEvent(this.currentDocument,"onTouch",this._onPointerDown),n.unsubscribe(this.tokenChange)},s.prototype._onPointerDownCB=function(e){if(0==this._multiViewCount)return;if(this.manipulated&&this.manipulated.control){if(!this.manipulated.control.getManipulationState)return;let e=this.manipulated.control.getManipulationState();if(e!==r.State.NONE&&e!==r.State.STOP)return}var t=e.from&&e.from.length?e.from[0]:null;if(!t)return;let i=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas));if(i.x<-1||i.x>1||i.y<-1||i.y>1)return;i.yPix=this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio-i.yPix;let n=this.getVpList(!0);for(let e=0;e<n.length;e++){let t=n[e];if(t.isMain()&&this.getViewpointInfos(t).isMultiView){let e=this.getViewpointViewport(t);if(!e||i.xPix>=e.x&&i.xPix<=e.x+e.width&&i.yPix>=e.y&&i.yPix<=e.y+e.height){this.setManipulatedViewpoint(t);break}}}},s.prototype.getViewpointsUnder=function(e){let t=this.getVpList(!0),i=[],r=this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio-e.yPix;for(let n=0;n<t.length;n++){let s=t[n],a=this.getViewpointViewport(s);(!a||e.xPix>=a.x&&e.xPix<=a.x+a.width&&r>=a.y&&r<=a.y+a.height)&&i.push(s)}return i},s.prototype.hasMultiView=function(){return this._multiViewCount>0},s.prototype.registerViewpoint=function(e){this._registeredViewpoints.set(e.id,e)},s.prototype.unregisterViewpoint=function(e){this._registeredViewpoints.delete(e.id)},s.prototype.dispose=function(){this._removeMultiViewEvents();for(let e=0;e<this.vpList.length;e++){let t=this.vpList[e];t.dispose();let i=this.viewpointInfos.get(t);i.scenegraph!=this.defaultSceneGraph&&i.scenegraph.dispose()}this.viewpointInfos=null,this.vpList=null,this.viewer=null;for(let[e,t]of this._registeredViewpoints)t.dispose()},UWA.namespace("THREEDS/ViewpointManager",s)})),define("DS/Visualization/Ambience",["DS/Visualization/ThreeJS_DS","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/SceneGraphFactory","DS/Visualization/Utils","DS/Visualization/WorldOrientation","DS/CoreEvents/Events","DS/Effects/ExtractLightFromIBL","DS/Effects/MergeMainMipsEffect","WebappsUtils/WebappsUtils","DS/SceneGraphNodes/DirectionalLightNode"],(function(e,t,i,r,n,s,a,o,l,h){"use strict";var c=e._AmbianceGenerators;const d=c._dummyRoughnessTextureRGBE,u=c._dummyRoughnessTextureLogLUV,p=c._dummyRoughnessTextureRGBM,f=new Set;f.add(d),f.add(u),f.add(p),f.add(null);const g="true"===localStorage.getItem("__WebVisu_LinearFilter_IBL__")?e.LinearFilter:e.NearestFilter;var m=function(t,i){var r=void 0!==(t=t||{}).image?t.image:null,n=void 0!==t.format?t.format:null,s=void 0!==t.sRGB?t.sRGB:"hdr"!=n,a=void 0!==t.type?t.type:"url",o=void 0!==t.texture?t.texture:null,l=void 0!==i?i:null,h=function(){console.log("loading image error")};this.stream=function(){return o?{texture:o,format:n}:null},this.getTexture=function(){return o},this.getImage=function(){return r},this.getFormat=function(){return n},this.isSRGB=function(){return s},this.isTextureHDRFloat=function(){return!(!o||o.type!=e.FloatType||o.format!=e.RGBFormat)},this.getType=function(){return a},this.setTexture=function(e){s=(o=e).sRGB},this.setFormat=function(e){n=e,"hdr"==e&&(s=!1)},this.setSRGB=function(e){s=e},this.setType=function(e){a=e},this.loadImage=function(t){var i=this.getImage(),r=this;if("url"==this.getType())if("hdr"==this.getFormat())(o=e.ImageUtils.loadHDRTexture(i,t,l,h,!1,!1)).minFilter=o.encoding!==e.RGBE_Encoding?e.LinearFilter:g,o.magFilter=o.minFilter;else if("dds"==this.getFormat()){o=e.ImageUtils.loadCompressedTexture(i,t,(function(t){r.isTextureHDRFloat()&&(r.setFormat("hdr"),t.hdr=!0,t.encoding=e.RGBA_Encoding),r.setSRGB(t.sRGB),l(t)}))}else o=new e.ImageUtils.loadTexture(i,t,l,null,e.ImageUtils.crossOriginPolicy);"urlCube"==this.getType()?o=e.ImageUtils.loadTextureCube(i,t,l):i&&i instanceof e.Texture&&((o=i).loadEndStatus===e.AssetLoadingStatus.READY?l():o.onLoadCallbacks.push(l))}},v=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var i="latlong",r=[],n=0,s=new m,a="bestFit",o=1,l=1,h=null,c=1,d={transition:0,image:new m,ambienceMatrix:new e.Matrix4,inverseMatrix:new e.Matrix4,radius:0},u=this,p=function(e){u.needUpdate=!0};this.setFromJson=function(h){if(t=!0,this.needUpdate=!0,h.type&&(i=h.type),h.sizeScaling&&(a=h.sizeScaling),h.intensity&&(o=h.intensity),h.ratio&&(l=h.ratio),h.horizonHeight&&(n=h.horizonHeight),h.image&&h.image.texture&&(s.setTexture(h.image.texture),s.setFormat(h.image.format)),h.colors)for(var c=0;c<h.colors.length;c++)r.push((new e.Color).setRGB(h.colors[c][0],h.colors[c][1],h.colors[c][2]))},this.stream=function(){if(t){var e={};if(e.type=i,r.length){for(var h=[],c=0;c<r.length;c++)h.push([r[c].r,r[c].g,r[c].b]);e.colors=h}return e.horizonHeight=n,e.sizeScaling=a,e.intensity=o,e.ratio=l,e.image=s.stream(),e}return null},this.isActivated=function(){return t},this.getType=function(){return i},this.initDefaultColors=function(t){r=[];for(var i=0;i<t;i++)r.push(new e.Color)},this.getColors=function(){switch(this.getType()){case"gradient":2!=r.length&&this.initDefaultColors(2);break;case"gradient3":3!=r.length&&this.initDefaultColors(3);break;case"gradientWithHorizon":4!=r.length&&this.initDefaultColors(4)}return r},this.getHorizonHeight=function(){return n},this.getBackplateScale=function(){return c},this.setBackplateScale=function(e){e!==c&&(c=e,"backplate"==i&&(this.needUpdateParameters=!0))},this.getImage=function(){return s},this.getSizeScaling=function(){return a},this.getIntensity=function(){return o},this.getBlur=function(){return 0},this.getRatio=function(){return l},this.getBackplateCB=function(){return h},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){i!=e&&(i=e,this.needUpdate=!0),t||this.setActivated(!0)},this.setColors=function(e){var t;switch((r=e).length){case 2:t="gradient";break;case 3:t="gradient3";break;case 4:t="gradientWithHorizon";break;default:return!1}this.setType(t),this.needUpdateParameters=!0},this.setHorizonHeight=function(e){n=e,this.needUpdateParameters=!0},this.setSizeScaling=function(e){a=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setBlur=function(e){},this.setRatio=function(e){l=e,this.needUpdateParameters=!0},this.setBackplateCB=function(e){h=e,this.needUpdateParameters=!0},this.hasGradient=function(){return t&&("gradient"==i||"gradientWithHorizon"==i)},this.loadImage=function(t){t.doneCallback&&(p=function(){t.doneCallback(),u.needUpdate=!0}),t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),(s=new m(t,p)).loadImage(function(t,i){switch(t){case"cubemap":return new e.CubeEnvMapping;case"environment":return new e.LatLongReflectionMapping;case"latlong":return new e.LatLongEnvMapping;case"backplate":return new e.SimpleEnvMapping}}(this.getType(),this.getSizeScaling()))},this.withImage=function(){if(!s.getTexture())return!1;var e=this.getType();return"cubemap"==e||"latlong"==e||"backplate"==e||"transition"==e||"transitionCube"==e},this.getTransitionInfos=function(){return d},this.setTransitionInfos=function(e){d=e}},_=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1,this.needUpdateSize=!1;var i=!1,r="sphere",n=5e3,s=new e.Vector3(0,0,.5),a=!1;this.setFromJson=function(e,i){t=!0,this.needUpdate=!0,e.type&&(r=e.type),e.size&&(n=e.size),e.shootPosition&&(i?s.set(e.shootPosition[0]/n,e.shootPosition[1]/n,e.shootPosition[2]/n):s.set(e.shootPosition[0],e.shootPosition[1],e.shootPosition[2]))},this.setYUp=function(e){i=e},this.stream=function(){if(t){var e={};return e.type=r,e.size=n,e.shootPosition=s.toArray(),e}return null},this.isActivated=function(){return t},this.getType=function(){return r},this.getSize=function(){return n},this.isAutoUpdateSize=function(){return a},this.getShootPosition=function(){return i?new e.Vector3(s.x,s.z,s.y):s},this.getWorldShootPosition=function(t){var i=(new e.Matrix4).extractRotation(t);return this.getShootPosition().clone().applyMatrix4(i)},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){r=e,this.needUpdate=!0},this.setSize=function(e){n>0&&(n=e),this.needUpdateSize=!0,this.needUpdateParameters=!0},this.setAutoUpdateSize=function(e){a=e},this.setShootPosition=function(e){s=e,this.needUpdateParameters=!0}},y=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1,this.needsUpdateShadowIntensity=!1,this.needsUpdateInfinitePlane=!1;var i="transparent",r=0,n=0,s=1,a=0,o=new e.Color;this.needsUpdateGroundReflectivity=!1,this.disableDefaultGroundShadow=!1;var h=null,c=!0;this.setFromJson=function(e){t=!0,this.needUpdate=!0,e.type&&(i=e.type),e.planeColor&&this.setPlaneColor(e.planeColor),void 0!==e.height&&(r=e.height),void 0!==e.reflectivity&&(n=e.reflectivity,this.needsUpdateGroundReflectivity=!1),void 0!==e.glossiness&&(s=e.glossiness),void 0!==e.shadowIntensity&&(a=e.shadowIntensity),e.material},this.stream=function(){if(t){var e={};return e.type=i,e.height=r,e.autoHeight=c,e.reflectivity=n,e.glossiness=s,e.shadowIntensity=a,e.material=h,e}return null},this.isActivated=function(){return t},this.getPlaneColor=function(){return o},this.isPhysical=function(){return!!h&&"physical"==this.getType()},this.getType=function(){return i},this.getHeight=function(){return r},this.getAutoHeight=function(){return c},this.getReflectivity=function(){return n},this.getGlossiness=function(){return s},this.getShadowIntensity=function(){return a},this.getMaterial=function(){return h},this.setActivated=function(e){e!=t&&(this.needUpdate=!0,this.needUpdateParameters=!0),t=e},this.setGroundOutDoor=function(){this.needUpdate=!0,i="physical",function(){h=new e.DSPBR19xMaterial({side:0,opacity:.99,roughness:.9});var t=l.getWebappsAssetUrl("Visualization","")+"OCA/",i=e.ImageUtils.loadTexture(t+"Outdoor_Ground_Diffuse.jpg");i.generateMipmap=!0,i.minFilter=e.LinearMipMapLinearFilter,i.magFilter=e.LinearFilter,i.repeat=new e.Vector2(10,10),i.wrapS=1e3,i.wrapT=1e3;var r=e.ImageUtils.loadTexture(t+"Outdoor_Ground_MainMap.jpg");r.generateMipmap=!0,r.minFilter=e.LinearMipMapLinearFilter,r.magFilter=e.LinearFilter,r.repeat=new e.Vector2(1,1),r.wrapS=1e3,r.wrapT=1e3,h.side=0,h.forceSide=!0,h.force=!0,h.needsUpdate=!0,h.depthWrite=!1,h.activatePDSFX("PDSFXAmbience");var n={fadingStrenght:{type:"f",value:5},fadingRatio:{type:"f",value:1},s_MaterialMap:{type:"t2",value:r},s_BaseColorMap:{type:"t2",value:i}};h.setPDSFXUniforms(n),h.setPDSFXVaryings({_vUv:{type:"v2"}}),h.setPDSFXGlobalShaderCode(null,(function(e){const t=e.variableHandler,i=e.functionHandler,r=e=>t.vec3(e),n=e=>t.mat3(e),s=e=>t.float(e,0,"private"),a=e=>t.vec2(e,0,"private"),o=e=>t.mat3(e,0,"private");return`\n                    //global variables\n                    ${s("ratio")}  = 1.0;\n                    ${a("myUV1")};\n                    ${a("myUV2")};\n                    ${s("dUV")} = 1.0;\n                    \n                    ${(e=>t.vec4(e,0,"private"))("groundColor")}  = ${(e=>t.vec4(e))()}(290.0/255.0, 214.0/255.0, 164.0/255.0, 1.0) ;\n                    ${o("MainMatrix_UVTransfo")}  = ${n()}(10, 0.0, 0.0,\n                                                     0.0, 10, 0.0,\n                                                     0.0, 0.0, 1.0);\n\n\n                    ${o("Matrix1_UVTransfo")}  = ${n()}(1.0024, 0.9758, 0.0,\n                                                  -0.9758, 1.0024, 0.0,\n                                                  0.0, 0.0, 1.0);\n\n\n                    ${o("Matrix2_UVTransfo")}  = ${n()}(1.7, 0.0, 0.0,\n                                                  0.0, 1.6, 0.0,\n                                                  0.01, 0.78, 1.0);\n                    \n                    ${i.dF("TransformUV","v2",[i.prmV2("iUV"),i.prmM3("iMatrix")])}{\n                        ${r("uv")}  = iMatrix*${r()}(iUV, 1.0);\n                        return uv.xy;\n                    }\n                    `})),h.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                            ${(t=>e.getVarying(t))("_vUv")} = ${e.vGetAttribTexCoord0()}.xy;\n                        `}},{ComputeAlbedo:function(e,t){const i=e.bridgeFunctions,r=t=>e.getTextureUniform(t);return`\n                            return mix(${i.sample2DTexture(r("s_BaseColorMap"),"myUV1")}.xyz, ${i.sample2DTexture(r("s_BaseColorMap"),"myUV2")}.xyz, ratio);\n                        `},ComputeCommonValues:function(e,t){const i=e.variableHandler,r=e.functionHandler,n=e.bridgeFunctions,s=(t=>e.getVarying(t))("_vUv");return`                   \n                            dUV = smoothstep(0.0,0.8,(length(2.0 * ${s} - 1.0)));\n                            ${(e=>i.vec2(e))("p_vUv")}   = ${r.cF("TransformUV","v2",[r.prmV2(s),r.prmM3("MainMatrix_UVTransfo")])};\n                            myUV1 =  ${r.cF("TransformUV","v2",[r.prmV2("p_vUv"),r.prmM3("Matrix1_UVTransfo")])};\n                            myUV2=  ${r.cF("TransformUV","v2",[r.prmV2("p_vUv"),r.prmM3("Matrix2_UVTransfo")])};\n                            p_vUv = ${r.cF("TransformUV","v2",[r.prmV2("p_vUv"),r.prmM3("MainMatrix_UVTransfo")])};\n                            ${(e=>i.float(e))("ratio")} = ${n.sample2DTexture((t=>e.getTextureUniform(t))("s_MaterialMap"),"p_vUv")}.r;\n                        `},ProcessFinalColor:function(e,t){return`\n                            ${e.variableHandler.dereference(t[0])}.a = 1.0 - dUV;\n                        `}})}()},this.setPlaneColor=function(e){o=e,this.needUpdateParameters=!0},this.setType=function(e){t&&i!=e&&(this.needUpdate=!0),i=e},this.setHeight=function(e){r=e,this.needUpdateParameters=!0},this.setAutoHeight=function(e){c=e,this.needUpdateParameters=!0},this.setReflectivity=function(e){0!==n&&0!==e||!(n>0||e>0)||(this.needUpdate=!0),n=e,this.needUpdateParameters=!0,this.needsUpdateGroundReflectivity=!0},this.setGlossiness=function(e){s=e,this.needUpdateParameters=!0},this.setShadowIntensity=function(e){a!==e&&(this.needsUpdateShadowIntensity=!0),0!==a&&0!==e||!(a>0||e>0)||(this.needUpdate=!0,this.needUpdateParameters=!0),a=e},this.setMaterial=function(e){h=e,this.needUpdateParameters=!0}},S=function(t){var i=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var r=t,n=new m,s="latlong",a=new e.Color(16777215),o=1,l=1,h=new e.Matrix4,c=new e.Matrix4,d=!1,u=this,p=function(){u.needUpdate=!0};this.setFromJson=function(t,c,d){if(c&&(r=!0,d&&h.multiplyMatrices(h,(new e.Matrix4).extractRotation(d))),i=!0,t.projection&&(s=t.projection),t.emissionColor&&(a=a.setRGB(t.emissionColor[0],t.emissionColor[1],t.emissionColor[2])),t.emissionValue&&(o=t.emissionValue,l=t.emissionValue),r){if(t.matrix){var u=(new e.Matrix4).setFromArray(t.matrix);h.multiplyMatrices(h,u)}this.updateMatrix()}else if(h.rotateZ(-Math.PI/2),t.matrix){u=(new e.Matrix4).setFromArray(t.matrix);var p=(new e.Matrix4).getInverse(u);h.multiplyMatrices(h,p)}t.image&&t.image.texture&&(n.setTexture(t.image.texture),n.setFormat(t.image.format),this.needUpdate=!0)},this.updateMatrix=function(){c.identity(),c.rotateZ(-Math.PI/2),d&&c.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(h);c.multiplyMatrices(c,t)},this.stream=function(){if(i){var e={};return e.projection=s,e.emissionColor=[a.r,a.g,a.b],e.emissionValue=o,e.matrix=h.elements.slice(0),e.image=n.stream(),e}return null},this.isActivated=function(){return i},this.setYUp=function(e){d=e,this.updateMatrix()},this.getImage=function(){return n},this.getProjection=function(){return scale},this.getValue=function(){return value},this.getMatrix=function(){return h},this.getInverseMatrix=function(){return c},this.getIntensity=function(){return o},this.getDiffuseIntensity=function(){return l},this.setActivated=function(e){e!=i&&(this.needUpdate=!0,i=e)},this.setValue=function(e){value=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,l=e,this.needUpdateParameters=!0},this.setSpecularIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setDiffuseIntensity=function(e){l=e,this.needUpdateParameters=!0},this.setMatrix=function(e){h=e,r&&this.updateMatrix(),this.needUpdateParameters=!0},this.loadImage=function(t){var i;t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),i=t.cb?function(e){t.cb(e),p()}:p,(n=new m(t,i)).loadImage(new e.LatLongReflectionMapping)},this.updateMatrix()},b=function(){var t=new e.Vector3(0,0,0),i=new e.Vector3(0,0,1),r=(new e.Vector3(0,0,1),new e.Vector3(0,0,0)),n=1,s=!0,a=!1;this.needUpdateParameters=!1,this.setFromJson=function(e){e.groundPosition&&(t=e.groundPosition),e.groundNormal&&(i=e.groundNormal),e.sceneHeight&&(r=e.sceneHeight),e.groundScale&&(n=e.groundScale),e.withGround&&(s=e.withGround)},this.updateMatrix=function(){i.set(0,0,1),a&&i.set(0,1,0)},this.updateFromMatrix=function(i){t.getPositionFromMatrix(i),i=(new e.Matrix4).extractRotation(i),this.updateMatrix()},this.setYUp=function(e){a=e,this.setSceneHeight(r),this.updateMatrix()},this.stream=function(){var e={};return e.groundPosition=t,e.groundNormal=i,e.sceneHeight=r,e.groundScale=n,e.withGround=s,e},this.isWithGround=function(){return s},this.getGroundPosition=function(){return t},this.getGroundNormal=function(){return i},this.getSceneHeight=function(){return r},this.getGroundScale=function(){return n},this.setGroundPosition=function(e){e.x==t.x&&e.y==t.x&&e.z==t.z||(t.copy(e),this.needUpdateParameters=!0)},this.setWithGround=function(e){s=e},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal")},this.setSceneHeight=function(t){r=a?new e.Vector3(0,t.z,0):t.clone(),this.needUpdateParameters=!0},this.setGroundScale=function(e){n=e,this.needUpdateParameters=!0}},x=function(l){var m=this;l||(l={}),this.requestIBLLightExtraction=s.subscribe({event:"/VISU/requestIBLLightExtraction"},(function(e){m._extractIBLLight(e.extraData.rendererID)}));var w=void 0!==l.viewer?l.viewer:null,P=void 0!==l.roughnessMap?l.roughnessMap:d,C="",M=!0,E=new v,T=new _,A=new y,D=new S(M),I=new b,R=new e.Matrix4,O=new e.Matrix4,L=null,B=!1,F=!1,V=[],G=[],N=!1,U=null,k=[],z=[],H=null,W=0,j=!1,X=null,q=0,Z=0,Y=0,K=0,$=0,Q=0,J=0,ee=0,te=0,ie=!1,re=!1,ne=new e.Vector2(1,1),se=new e.Vector2(0,0);l.finiteEnv&&T.setActivated(!0),this.usePlaneV2=!1,l.usePlaneV2&&(this.usePlaneV2=!0);var ae=null,oe=!1;!1===l.autoGroundOffset&&A.setAutoHeight(!1);var le=new e.Color(0),he=1,ce=!1;w&&w.currentViewpoint&&w.currentViewpoint.camera&&w.currentViewpoint.camera.isOrtho&&(ce=!0);var de=!1,ue=null,pe=1920,fe=1080,ge=1,me=!1;this.needUpdateIBL=new Set;this.isOCA=!1,this.skyLightingInfo=null,this.keepIBLTexture=!0,this.keepBackgroundTexture=!0,this.setCameraOrtho=function(e){ce!=e&&(ce=e,me=!0,this.update())},this.useRenderToTarget=function(e){e},this.setWorldOrientation=function(e,t){var i=e==n.YUpXRight;D.setYUp(i),I.setYUp(i),T.setYUp(i),j=i,this.updateMatrix(),this.update(t)},this.updateAmbience=function(e){if(e&&this.skyLightingInfo){var t=null==this.skyLightingInfo.height?e.currentViewpoint.camera.position.z-this.skyLightingInfo.groundHeight:this.skyLightingInfo.height;t*=this.skyLightingInfo.unitScale/1e6,this.setSkyLighting(this.skyLightingInfo.sunDirection,Math.max(t,.001),this.skyLightingInfo.intensity,this.skyLightingInfo.withBackGround,e),this.skyLightingInfo.needsUpdate=!1}De(e,!0),e&&ie&&(e._setBackgroundColor(),ie=!1),e&&e&&e.planeV2&&e.planeGrid&&(e.planeGrid.size=2*T.getSize(),T.needUpdateSize=!1),e&&this.setWorldOrientation(e._worldOrientation,e),_e(e,!0),this.needUpdateIBL=new Set},this.setGroundOptions=function(e){re=!0,L=e},this.setOnComputeRoughnessMapCb=function(e){U=e};this.isComputingRoughnessMap=function(){return N};var ve=function(){c.setCallBack((function(){!function(e){N=e}(!1),c.setCallBack(null),U&&U()}))};this.isTextureLoading=function(){return B||F},this.updateMatrix=function(){O.identity(),O.rotateZ(-Math.PI/2),j&&O.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(R);t.elements[12]=R.elements[12],t.elements[13]=R.elements[13],t.elements[14]=R.elements[14],O.multiplyMatrices(O,t);var i=E.getTransitionInfos();i.inverseMatrix.identity(),i.inverseMatrix.rotateZ(-Math.PI/2),j&&i.inverseMatrix.rotateX(Math.PI/2),(t=(new e.Matrix4).getInverse(i.ambienceMatrix)).elements[12]=i.ambienceMatrix.elements[12],t.elements[13]=i.ambienceMatrix.elements[13],t.elements[14]=i.ambienceMatrix.elements[14],i.inverseMatrix.multiplyMatrices(i.inverseMatrix,t)},this.loadFrom3dx=function(t,i,r,n,s){var a=t;r&&(M=!0);var o=null;if(a.name&&(C=a.name),M)a.transform&&(o=(new e.Matrix4).setFromArray(a.transform),R.multiplyMatrices(R,o),I.updateFromMatrix(R)),this.updateMatrix();else if(R.rotateZ(-Math.PI/2),a.transform){o=(new e.Matrix4).setFromArray(a.transform);var l=(new e.Matrix4).getInverse(o);l.elements[12]=o.elements[12],l.elements[13]=o.elements[13],l.elements[14]=o.elements[14],R.multiplyMatrices(R,l)}a.backgroundGeometry&&T.setFromJson(a.backgroundGeometry,r),a.ground?A.setFromJson(a.ground):r&&this.setGroundGeometry(!1);var h={needsUpdate:!1,useSky:!1,background:!0,dir:null,intensity:1,height:null,groundHeight:A.getHeight()};if(a.environmentLight)if(a.environmentLight.sun_direction&&!1!==a.environmentLight.enabled){h.useSky=!0;var c=a.environmentLight.sun_direction;if(h.dir=new e.Vector3(-c[0],-c[1],-c[2]),o){var u=(new e.Matrix4).extractRotation(o);h.dir.applyMatrix4(u)}null!=a.environmentLight.altitude&&(h.height=a.environmentLight.altitude),null!=a.environmentLight.intensity&&(h.intensity=a.environmentLight.intensity)}else r?D.setFromJson(a.environmentLight,r,o):D.setFromJson(a.environmentLight,r);if(A.setAutoHeight(!1),a.background)if("color"==a.background.type&&"color"==a.background.type){var p=a.background.colors[0];le.setRGB(p[0],p[1],p[2]),he=p[3],ie=!0}else E.setFromJson(a.background);i?this.loadImageFrom3dx(i,n,s):P||(P=!r&&D.getImage().getTexture()?null:d,this.needUpdateIBL=new Set),h.useSky&&this.setSkyLightingInfo(h.dir,h.height,h.intensity,h.background,h.groundHeight,a.unitScale)},this._extractIBLLight=function(e){if(!H){var t=this.getIblMap();if(w&&w.renderer&&w.renderer.renderer&&w.renderer.renderer.id===e){var i=new a(w.renderer.renderer,w.renderer.renderTargetPool);t&&i.setEnvMap(t),H={},i.execute(!t||k.filter((function(e){return e.light3js.castShadow&&e.light3js.intensity>0})).length>0,(e=>{i.dispose(),s.publish({event:"/VISU/IBLLightExtracted",data:{eventChannel:"/VISU/IBLLightExtracted",eventType:"@IBLLightExtracted"}}),e&&(H=e,W++)}))}}},this._solveSceneRoughnessMap=function(e,t,i){if(t){var r=this.getIblMap();if(r){var n=new o(t.renderer.renderer,t.renderer.renderTargetPool);n.setTextures(e.textures,r,e.ggx0,e.ggxMapping),this.setRoughnessMap({texture:n.execute()}),n.dispose(),s.publish({event:"/VISU/3DXMipsMerged",data:{eventChannel:"/VISU/3DXMipsMerged",eventType:"@3DXMipsMerged"}}),i&&i({ambiance:this})}}},this.addLightNode=function(e){W++,this.removeIBLLight(),k.push(e)},this.removeIBLLight=function(){if(H&&H.light){H.light.dispose();for(let e=0;e<z.length;e++)z[e].scene.remove(H.light);H=null}},this.updateLights=function(t,i,r,n,s){if(i){if(W!=i.scene.ambienceLightState){for(var a=0;a<k.length;a++)i.addLightNode(k[a]);H&&H.light&&i.scene.add(H.light),i.scene.ambienceLightState=W}-1==z.indexOf(i)&&z.push(i)}var o,l,h,c,d=t.getUpDirection(),u=t.getSightDirection();(new e.Vector3).crossVectors(u,d);H&&H.light&&(o=H,l=this.getEnvironmentLightMatrix(!0),h=o.light,c=o.dirLight,h.target.position.copy(r.center),h.target.updateMatrixWorld(),h.position=(new e.Vector3).copy(c).multiplyScalar(2*r.radius).add(r.center),null!==l&&h.position.applyMatrix4(l),h.updateMatrix(),h.updateMatrixWorld())},this.removeLights=function(){for(var e=0;e<k.length;e++){for(let t=0;t<z.length;t++)z[t].removeLightNode(k[e]);k[e].dispose()}this.removeIBLLight();for(let e=0;e<z.length;e++)z[e].scene&&(z[e].scene.ambienceLightState=-1);z=[],W=0},this.loadImageFrom3dx=function(i,r,n){if(this.removeIBLLight(),l.images){var s=0,a=0;l.images.background&&s++,l.images.environmentLight&&s++;var o=this,h=function(){++a==s&&(B=!1,F=!1,me=!0,r&&r({ambiance:o}))};if(l.images.background&&(B=!0,E.loadImage({image:l.images.background.data,format:l.images.background.format,doneCallback:h})),l.images.environmentLight){if("hdr"==l.images.environmentLight.format)c=n?function(){o.needUpdateIBL=new Set,h()}:function(){o.needUpdateIBL=new Set;var t=o.getEnvironmentLight().getImage().getTexture();if(t&&t.image){var i=t.image,r=parseInt(i.width,10),n=parseInt(i.height,10);if(isNaN(r)||isNaN(n)||2*n!=r&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),r<8||n<4){for(var s=new Uint8Array(128),a=0;a<32;a++)s[4*a]=i.data[0],s[4*a+1]=i.data[1],s[4*a+2]=i.data[2],s[4*a+3]=i.data[3];i.height="4",i.width="8",i.data=s;var l=new Uint8Array(256);for(a=0;a<64;a++)l[4*a]=i.data[0],l[4*a+1]=i.data[1],l[4*a+2]=i.data[2],l[4*a+3]=i.data[3];return(P=new e.DataTexture(l,8,8,e.RGBAFormat,void 0,void 0)).hdr=t.hdr,P.sRGB=t.sRGB,P.minFilter=P.encoding!==e.RGBE_Encoding?e.LinearFilter:g,P.magFilter=P.minFilter,P.wrapS=e.RepeatWrapping,P.wrapT=e.RepeatWrapping,P.mapping=t.mapping,void h()}}N=!0,ve(),o.needUpdateIBL=new Set,P=null,h()},F=!0,D.loadImage({cb:c,image:l.images.environmentLight.data,format:l.images.environmentLight.format});else if("dds"==l.images.environmentLight.format){c=n?function(e){var i=null;if(e.isCubeMap&&e.isCubeMap()){if(w){ue||(ue=new t(w.renderer.renderer,w.renderer.renderTargetPool));var r=D.getImage().getTexture();ue.setEnvMap(r,2),ue.execute(),i=ue.getResultRGBE(!0)}}else i=e;D.getImage().setTexture(i),o.needUpdateIBL=new Set,h()}:function(i){var r=null;if(i.isCubeMap&&i.isCubeMap()){if(w){ue||(ue=new t(w.renderer.renderer,w.renderer.renderTargetPool));var n=D.getImage().getTexture();ue.setEnvMap(n,2),ue.execute(),r=ue.getResultRGBE(!0)}}else if((r=i)&&r.mipmaps){var s=r.mipmaps[0],a=parseInt(s.width,10),l=parseInt(s.height,10);if(isNaN(a)||isNaN(l)||2*l!=a&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),a<8||l<4){var c,d;i.type==e.FloatType?(r.hdr=!0,i.encoding=e.RGBA_Encoding,r.sRGB=!1,c=new Float32Array(128)):c=new Uint8Array(128);for(var u=0;u<32;u++)c[4*u]=s.data[0],c[4*u+1]=s.data[1],c[4*u+2]=s.data[2],c[4*u+3]=s.data[3];s.height="4",s.width="8",s.data=c,d=i.type==e.FloatType?new Float32Array(256):new Uint8Array(256);for(u=0;u<64;u++)d[4*u]=s.data[0],d[4*u+1]=s.data[1],d[4*u+2]=s.data[2],d[4*u+3]=s.data[3];return(P=new e.DataTexture(d,8,8,e.RGBAFormat,void 0,void 0)).hdr=r.hdr,P.sRGB=r.sRGB,P.minFilter=P.encoding!==e.RGBE_Encoding?e.LinearFilter:g,P.magFilter=P.minFilter,P.wrapS=e.RepeatWrapping,P.wrapT=e.RepeatWrapping,P.mapping=r.mapping,D.getImage().setTexture(r),o.needUpdateIBL=new Set,void h()}}D.getImage().setTexture(r),N=!0,ve(),o.needUpdateIBL=new Set,P=null,h()},F=!0,D.loadImage({cb:c,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}else if("png"==l.images.environmentLight.format||"jpg"==l.images.environmentLight.format){var c=function(){P=D.getImage().getTexture(),o.needUpdateIBL=new Set};h();c=function(){var t=D.getImage().getTexture();t.encoding=e.RGBA_Encoding,t.hdr=!0,t.sRGB=!0,N=!0,h(),ve(),o.needUpdateIBL=new Set,P=null};F=!0,D.loadImage({cb:c,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}}else this.needUpdateIBL=new Set,P=d}},this.setRenderTargetSize=function(e,t,i,r){q=0,Z=0,Y=i,K=r,e&&(q=e),t&&(Z=t)},this.isFiniteMode=function(){return T.isActivated()},this.getTransform=function(){return R},this.setTransform=function(e){R=e,M&&(this.updateMatrix(),I.updateFromMatrix(R)),me=!0},this.getEnvironmentLightMatrix=function(e){return e&&M?D.getInverseMatrix():D.getMatrix()},this._getEnvironmentLightMatrix=function(){var t=new e.Matrix4;return t.getInverse(D.getInverseMatrix()),t},this.getGroundOptions=function(){return L},this.setEnvironmentLightMatrix=function(e){D.setMatrix(e),me=!0},this.getBackgroundGeometryEditor=function(){return I},this.getBackgroundGeometry=function(){return T},this.getBackground=function(){return E},this.getGround=function(){return A},this.getEnvironmentLight=function(){return D},this.getBackgroundColor=function(){return le},this.getBackgroundAlpha=function(){return he},this.setBackgroundAlpha=function(e){he=e,me=!0},this.setBackgroundColor=function(t){le=new e.Color(t),me=!0,ie=!0},this.updateParameters=function(e){me=!0,this.update(e)},this.update=function(e){E.needUpdate&&(_e(e),E.needUpdate=!1,E.needUpdateParameters=!1,D.needUpdateParameters=!1),T.needUpdate&&(_e(e),T.needUpdate=!1,E.needUpdateParameters=!1,D.needUpdateParameters=!1,T.needUpdateParameters=!1),D.needUpdate&&(D.needUpdate=!1),A.needUpdate&&(De(e),A.needUpdate=!1),(me||A.needUpdateParameters||E.needUpdateParameters||D.needUpdateParameters||T.needUpdateParameters||I.needUpdateParameters)&&(ye(e),E.needUpdateParameters=!1,D.needUpdateParameters=!1,A.needUpdateParameters=!1,T.needUpdateParameters=!1,I.needUpdateParameters=!1,me=!1)};var _e=function(t,i){if(E.isActivated())switch(E.getType()){case"gradient":case"gradient3":case"gradientWithHorizon":Ee();break;case"cubemap":T.isActivated()?"sphere"==T.getType()&&Te():Re();break;case"latlong":T.isActivated()?"sphere"==T.getType()&&Te():Ie();break;case"transition":case"transitionCube":Ae();break;case"backplate":Oe(t);break;default:return!1}ae&&(ae.side=e.DoubleSide,ae.depthTest=!1,ae.depthWrite=!1,ae.force=!0,ae.forceSide=!0,oe=!0),ye(t,i)},ye=function(e,t){if(ae&&E.isActivated()){if(E.withImage()){var i=E.getImage();i.getTexture()&&(ae.tEnvMap=i.getTexture(),ae.tEnvMap.envMapExposure&&(ae.tEnvMap.envMapExposure=E.getIntensity()),ae.envMapExposure=E.getIntensity(),ae.setUseHDR("hdr"==i.getFormat()),ae.setUseSRGB(i.isSRGB()),ae.setUseHDRFloat(i.isTextureHDRFloat()))}T.isActivated()?"gradient"==E.getType()||"gradientWithHorizon"==E.getType()||"gradient3"==E.getType()?be("gradientWithHorizon"==E.getType()):"backplate"==E.getType()?xe(e):"transition"==E.getType()||"transitionCube"==E.getType()?Me():Ce():("latlong"==E.getType()&&Pe(),"cubemap"==E.getType()&&we(),"backplate"==E.getType()&&xe(e),"gradient"!=E.getType()&&"gradientWithHorizon"!=E.getType()&&"gradient3"!=E.getType()||be("gradientWithHorizon"==E.getType()))}if(D.isActivated()){var r=D.getImage().getTexture();r&&(r.envMapExposureSpecular=D.getIntensity(),r.envMapExposureDiffuse=D.getDiffuseIntensity())}A.isActivated()&&(t||A.needsUpdateGroundReflectivity)&&(Se(e),A.needsUpdateGroundReflectivity=!1),e&&ie&&(e._setBackgroundColor(),ie=!1)},Se=function(e){if(e&&A.getReflectivity()>0){var t=function(e){if(e&&e.renderer&&e.renderer.mirrorBlendPass)return e.renderer.mirrorBlendPass}(e);t&&t.material.setUniform("reflectivity",A.getReflectivity())}},be=function(e){ae.colors=[];var t=ae.colors,i=E.getColors();ae.YUp=j?1:0,ae.ratio=E.getRatio();for(var r=0;r<i.length;r++){var n=i[r];t.push(n.r),t.push(n.g),t.push(n.b)}e&&(ae.horizonHeight=E.getHorizonHeight())},xe=function(e){E.getImage().getTexture();ae.backgroundColor.set(le),ae.backgroundAlpha=he,Fe(void 0,e)},we=function(){E.getImage().getTexture()&&(ae.ambienceMatrix=M?O:R)},Pe=function(){var t=E.getImage().getTexture();t&&(t.encoding!==e.RGBE_Encoding&&(t.minFilter=e.LinearFilter),ae.ambienceMatrix=M?O:R,A.isPhysical()?(ae.planeColor=A.getPlaneColor(),ae.withPlane=1):ae.withPlane=0)},Ce=function(){var t=E.getImage().getTexture();if(ae.side=ce?e.BackSide:e.DoubleSide,t){t.encoding!==e.RGBE_Encoding&&(t.minFilter=e.LinearFilter),ae.tEnvMap=t,M?(ae.ambienceMatrix=O,ae.groundHeight=T.getWorldShootPosition(R)):(ae.ambienceMatrix=R,ae.groundHeight=T.getShootPosition()),ae.groundPosition=I.getGroundPosition(),ae.groundNormal=I.getGroundNormal(),ae.groundOffset=A.getHeight(),ae.sceneHeight=I.getSceneHeight(),ae.groundRadius=T.getSize(),ae.groundScale=I.getGroundScale(),ae.withGround=I.isWithGround(),ae.projectionConic=!ce;var i="cubemap"==E.getType()||"transitionCube"==E.getType();ae.setUseLatLongMap(!i)}},Me=function(){var t=E.getImage().getTexture();if(ae.side=e.DoubleSide,t){t.encoding!==e.RGBE_Encoding&&(t.minFilter=e.LinearFilter),ae.tEnvMap=t,ae.ambienceMatrix=O,ae.groundPosition=I.getGroundPosition(),ae.groundPositionLowPart=new e.Vector3(e.SplitFloat32(ae.groundPosition.x).low,e.SplitFloat32(ae.groundPosition.y).low,e.SplitFloat32(ae.groundPosition.z).low),ae.groundRadius=T.getSize(),ae.groundScale=I.getGroundScale();var i="cubemap"==E.getType()||"transitionCube"==E.getType();ae.setUseLatLongMap(!i)}var r=E.getTransitionInfos();ae.transitionCoef=r.transition;var n=r.image.getTexture();n&&(n.encoding!==e.RGBE_Encoding&&(n.minFilter=e.LinearFilter),ae.tEnvMap2=n,ae.groundPosition2.set(r.ambienceMatrix.elements[12],r.ambienceMatrix.elements[13],r.ambienceMatrix.elements[14]),ae.groundPosition2LowPart=r.ambienceMatrix.getLowPartTranslation(),ae.ambienceMatrix2=r.inverseMatrix,ae.groundRadius2=r.radius,ae.groundScale2=I.getGroundScale())},Ee=function(){var t;switch(E.getType()){case"gradient":t=e.GradientBackgroundMaterial2;break;case"gradient3":t=e.GradientBackgroundMaterial3;break;case"gradientWithHorizon":t=e.GradientBackgroundMaterial4;break;default:return!1}ae=new t(null)},Te=function(){var t=E.getImage(),i={useLatLongMap:"latlong"==E.getType()||"transition"==E.getType(),useAmbianceV2:!!M,useHDR:"hdr"==t.getFormat(),useSRGB:t.isSRGB()};ae=new e.FiniteEnvMapMaterial(i)},Ae=function(){ae=new e.FiniteTransitionEnvMapMaterial(null)},De=function(e,t){e&&((t||re)&&L&&(e.setGroundOptions(L),re=!1),A.isActivated()&&A.getReflectivity()>0?e.setMirror(!0,void 0,null,A.getReflectivity(),A.getGlossiness()):e.setMirror(!1),A.isActivated()&&A.getShadowIntensity()>0?(e.setShadowPlane(!0),A.disableDefaultGroundShadow?e.setGroundShadow(!1):e.setGroundShadow(!0)):e.setGroundShadow(!1),A.needsUpdateInfinitePlane&&e.displayInfinitePlane(A.isActivated()))},Ie=function(){var t=E.getImage(),i={useHDR:"hdr"==t.getFormat(),useHDRFloat:t.isTextureHDRFloat(),useSRGB:t.isSRGB()};ae=new e.LatLongMapMaterial(i)},Re=function(){ae=new e.CubeMapMaterial},Oe=function(t){var i=E.getImage(),r={useHDR:"hdr"==i.getFormat(),useHDRFloat:i.isTextureHDRFloat(),useSRGB:i.isSRGB()};ae=new e.SimpleMapMaterial(r),Fe(void 0,t)},Le=function(i){var r;if(i.url){var n=i.onMapsLoaded,s=null;if(i.onlyOnRequest&&i.fallbackColor&&(n=null,s=function(t){r=function(t){var i=4;t[0]&&(i=8);for(var r=new Uint8Array(8*i*4),n=0;n<8*i;n++)r[4*n]=t[1],r[4*n+1]=t[2],r[4*n+2]=t[3],r[4*n+3]=t[4];var s=new e.DataTexture(r,8,i,e.RGBAFormat);return s.needsUpdate=!0,s.hdr=!0,s.sRGB=!1,s.minFilter=s.encoding!==e.RGBE_Encoding?e.LinearFilter:g,s.magFilter=s.minFilter,s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping,s.loadEndStatus=e.AssetLoadingStatus.READY,s}(i.fallbackColor),i.fallbackColor[0]?m.setIblMap({texture:r}):m.setRoughnessMap({texture:r})}),i.url instanceof Array)r=e.ImageUtils.loadTextureCube(i.url,i.mapping,i.onMapsLoaded);else if(i.hdr)r=e.ImageUtils.loadHDRTexture(i.url,i.mapping,n,null,null,!1,!1,e.ImageUtils.crossOriginPolicy,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r);else{var a=i.url.split("."),o=(a[a.length-2],a[a.length-1]);"hdr"==(o=o.toLowerCase())||i.hdr?(r=e.ImageUtils.loadHDRTexture(i.url,i.mapping),i.hdr=!0,r.onLoadCallbacks.push(i.onMapsLoaded)):"dds"==o||i.dds?r=e.ImageUtils.loadCompressedTexture(i.url,new e.LatLongReflectionMapping,(function(){w&&(ue||(ue=new t(w.renderer.renderer,w.renderer.renderTargetPool)),ue.setEnvMap(r,2),ue.execute(),r=ue.getResultRGBE(!0),i.onMapsLoaded(r))})):(r=new e.ImageUtils.loadTexture(i.url,i.mapping,n,s,e.ImageUtils.crossOriginPolicy,!1,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r))}}return r},Be=function(t,i,r){var n=E.getImage();n.setTexture(t);var s=r?"hdr":"png";n.setFormat(s);var a,o,l=t,h=!!r;i instanceof e.SimpleEnvMapping?(a="backplate",o="simple"):i instanceof e.SimpleEnvMappingCustom?(a="backplate",o="custom"):i instanceof e.SimpleEnvMappingFit?(a="backplate",o="fit"):i instanceof e.SimpleEnvMappingPreserveRatio?(a="backplate",o="bestFit"):i instanceof e.SimpleEnvMappingFitWidth?(a="backplate",o="fitWidth"):i instanceof e.SimpleEnvMappingFitHeight?(a="backplate",o="fitHeight"):i instanceof e.LatLongEnvMapping?a="latlong":i instanceof e.CubeEnvMapping&&(a="cubemap"),h&&(l.minFilter=l.encoding!==e.RGBE_Encoding?e.LinearFilter:g,l.magFilter=l.minFilter,l.wrapS=e.RepeatWrapping,l.wrapT=e.RepeatWrapping),a!=E.getType()||!ae||"backplate"==E.getType()&&E.getSizeScaling()!=o?(E.setType(a),o&&E.setSizeScaling(o),E.needUpdate=!0):me=!0},Fe=function(t,i){var r=E.getImage().getTexture();if("backplate"==E.getType()&&r){var n=2048,s=1024;r.image?(n=r.image.width,s=r.image.height):r.width&&r.height&&(n=r.width,s=r.height);var a=n/s,o=pe,l=fe;q&&Z&&(o=q,l=Z),t&&(n*=2,s*=2,o*=2,l*=2);var h,c=(o*=E.getBackplateScale())/(l*=E.getBackplateScale()),d=Y,u=K;if(te)if(o=te,l=ee,d=-$,u=-(ee-J-Q),q&&Z&&(o=q,l=Z,d=Y,u=K),c=o/l,"custom"==E.getSizeScaling())(h=E.getBackplateCB())&&h({textureWidth:n,textureHeight:s,viewportWidth:o,viewportHeight:l,devicePixelRatio:ge});else if("simple"==E.getSizeScaling())n=o,s=l,ae.offset.set(ge*(d+se.x*n),ge*(u-se.y*s-(ne.y-1)*s)),ae.invSize.set(1/(ge*n*ne.x),1/(ge*s*ne.y));else if("fitHeight"==E.getSizeScaling()){{let e=fe/s;ae.offset.set((pe/2-n*e/2)*ge,0),ae.invSize.set(1/(ge*n*e),1/(ge*s*e))}}else if("fitWidth"==E.getSizeScaling()){{let t=pe/n,i=e.WebGPU?-1:1;ae.offset.set(0,i*(fe/2-s*t/2)*ge),ae.invSize.set(1/(ge*n*t),1/(ge*s*t))}}else if("bestFit"==E.getSizeScaling()){if(i){let t=i.currentViewpoint,r=t.camera.fullWidth,n=t.camera.fullHeight,s=n,o=n*a;o<r&&(o=r,s=r/a),e.WebGPU?ae.offset.set(((r-o)/2-t.camera.x)*ge,((n-s)/-2+i.SCREEN_HEIGHT+t.camera.y-n)*ge):ae.offset.set(((r-o)/2-t.camera.x)*ge,((n-s)/2+i.SCREEN_HEIGHT+t.camera.y-n)*ge),ae.invSize.set(1/(o*ge),1/(s*ge))}}else"fit"==E.getSizeScaling()&&(a>c?(n=o,u+=.5*(l-(s=o/a))):(s=l,d+=.5*(o-(n=l*a))),ae.offset.set(ge*(d+se.x*n),ge*(u-se.y*s-(ne.y-1)*s)),ae.invSize.set(1/(ge*n*ne.x),1/(ge*s*ne.y)));else if("custom"==E.getSizeScaling())(h=E.getBackplateCB())&&h({textureWidth:n,textureHeight:s,viewportWidth:o,viewportHeight:l,devicePixelRatio:ge});else if("simple"==E.getSizeScaling())n=o,s=l,ae.offset.set(ge*d,ge*u),ae.invSize.set(1/(ge*n),1/(ge*s));else if("fitHeight"==E.getSizeScaling())n=l*a,s=l,d=.5*(pe*E.getBackplateScale()-n),ae.offset.set(ge*d,ge*u),ae.invSize.set(1/(ge*n),1/(ge*s));else if("fitWidth"==E.getSizeScaling()){n=o,s=o/a,u=.5*(fe*E.getBackplateScale()-s);let t=e.WebGPU?-1:1;ae.offset.set(ge*d,t*(ge*u)),ae.invSize.set(1/(ge*n),1/(ge*s))}else if("bestFit"==E.getSizeScaling()){if(i){a>c?n=(s=l)*a:s=(n=o)/a;let t=i.currentViewpoint;e.WebGPU?ae.offset.set(0,(i.SCREEN_HEIGHT+t.camera.y-s)/-2*ge):ae.offset.set(0,(i.SCREEN_HEIGHT+t.camera.y-s)/2*ge),ae.invSize.set(1/(n*ge),1/(s*ge))}}else"fit"==E.getSizeScaling()&&(a>c?(n=o,u+=.5*(l-(s=o/a))):(s=l,d+=.5*(o-(n=l*a))),ae.offset.set(ge*d,ge*u),ae.invSize.set(1/(ge*n),1/(ge*s)))}};this.getIblMap=function(){if(D.isActivated()){var t=D.getImage().getTexture();if(t&&(t.loadEndStatus==e.AssetLoadingStatus.READY||t.loadEndStatus==e.AssetLoadingStatus.PAUSED||null==t.loadEndStatus))return t}return null},this.getRoughnessMap=function(){return D.isActivated()?P:null},this.getRadiusEnvMap=function(){return T.getSize()*I.getGroundScale()*2},this.getCenter=function(){var e,t;return M?((e=I.getSceneHeight().clone()).multiplyScalar(T.getSize()),e.add(I.getGroundPosition())):((e=I.getGroundNormal().clone().multiply(I.getSceneHeight())).multiplyScalar(T.getSize()),t=I.getGroundPosition().clone().applyMatrix4(R),e.add(t)),e},this.getRadius=function(){return T.getSize()*I.getGroundScale()},this.getProjectionCenter=function(){var e,t;return M?((e=T.getShootPosition().clone()).multiplyScalar(T.getSize()),e.add(I.getGroundPosition())):((e=I.getGroundNormal().clone().multiply(T.getShootPosition())).multiplyScalar(T.getSize()),t=I.getGroundPosition().clone().applyMatrix4(R),e.add(t),e.z+=A.getHeight()),e},this.updateCamera=function(t,i,r,n,s){if(t.camera&&this.setCameraOrtho(t.camera.isOrtho),ae&&"latlong"==E.getType()){if(r.fullWidth&&!n)ae.invScreenSize.x=1/r.width,ae.invScreenSize.y=1/r.height,ae.startOffset.x=r.x/r.fullWidth,ae.endOffset.y=1-r.y/r.fullHeight,ae.endOffset.x=(r.x+r.width)/r.fullWidth,ae.startOffset.y=1-(r.y+r.height)/r.fullHeight;else{var a=i.renderer.getViewportSize();ae.invScreenSize.x=1/a.width,ae.invScreenSize.y=1/a.height,ae.startOffset.x=0,ae.startOffset.y=0,ae.endOffset.x=1,ae.endOffset.y=1}if(t.camera.isOrtho&&this.isFiniteMode()){var o=Math.tan(.5*e.Math.degToRad(t.camera.fov)),l=t.getSightDirection().normalize(),h=t.camera.up.normalize();ae.cameraRight.crossVectors(t.getSightDirection(),t.camera.up).normalize(),ae.cameraSight.copy(l),ae.cameraUp.copy(h),ae.invScreenSize.x=1/i.deviceWidth,ae.invScreenSize.y=1/i.deviceHeight,ae.near=t.camera.near,ae.right=t.camera.right,ae.up=t.camera.top}else{o=Math.tan(.5*e.Math.degToRad(t.camera.fov));ae.cameraSight.copy(t.getSightDirection()),ae.cameraUp.copy(t.camera.up).multiplyScalar(o),ae.cameraRight.crossVectors(t.getSightDirection(),t.camera.up),ae.cameraRight.multiplyScalar(t.camera.aspect*o),ae.invScreenSize.x=1/i.deviceWidth,ae.invScreenSize.y=1/i.deviceHeight}}if(ae&&"backplate"==E.getType()){var c="SSAA"==i.antiAliasing;r.fullWidth?($=r.x,Q=r.y,r.width,J=r.height,ee=r.fullHeight,te=r.fullWidth,Fe(c,s)):($=0,Q=0,0,J=0,ee=0,te=0,Fe(c,s))}},this.resize=function(e,t,i,r,n){if(pe=e,fe=t,ge=i,"backplate"==E.getType()){var s="SSAA"==r.antiAliasing;Fe(s,n)}},this.getSphere=function(){return(e=i.createSphereNode({radius:1,sag:64,material:ae})._occurrences[0].renderable).frustumCulled=!1,e.renderDepth=2,e.visible=!0,e.visibilityFree=!0,e;var e};this.getGroundGeometry=function(){return(t=i.createRectangleNode({width:1,noEdge:!0,height:1,cornerPoint:new e.Vector2(-.5,-.5),fill:!0,material:A.getMaterial()?A.getMaterial():new e.PhysicalMaterial})._occurrences[0].renderable).frustumCulled=!1,t.renderDepth=2,t.visible=!0,t.visibilityFree=!0,t;var t},this.updateSphere=function(e,t,i){var r,n;de||(r=t,n=e,i.position.set(r.x,r.y,r.z),i.scale.set(n,n,n),i.updateMatrix(),ae&&(i.material=ae),i.visible=!0,oe&&(i._flagAsGSSOInvalidated(),oe=!1))},this.setNearValue=function(e){ae&&(ae.near=e)},this.updateGround=function(e){if(!de){var t=5*this.getBackgroundGeometry().getSize(),i=this.getCenter();e.position.set(i.x,i.y,i.z),e.scale.set(t,t,t),e.rotation.x=j?-Math.PI/2:0,e.updateMatrix(),A.getMaterial()&&(e.material=A.getMaterial()),e.visible=!0}},this._removePhysicalGround=function(){A.setMaterial(null),A.setType("transparent")},this.setIblMap=function(t){!0===t.pngHdr&&(t.pngHdr=e.RGBE_Encoding);var i=this,r=null;if(this.removeIBLLight(),t.mapping||(t.mapping=new e.LatLongReflectionMapping),t.onMapsLoaded=function(r){t.pngHdr&&(r.sRGB=!1,r.hdr=!0,r.encoding=t.pngHdr);var n=r;if(D.getImage().setTexture(n),D.setActivated(!0),n.minFilter=n.encoding!==e.RGBE_Encoding?e.LinearFilter:g,n.magFilter=n.minFilter,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),t.generateRougnessMap||t.generateRoughnessMap){F=!1;for(var s=0;s<G.length;s++)G[s].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});G=[],N=!0,t.doneCallback&&t.doneCallback(),ve(),i.needUpdateIBL=new Set,P=null}if(t.doneCallback&&(!t.generateRougnessMap||!t.generateRoughnessMap)){F=!1;for(s=0;s<G.length;s++)G[s].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});G=[],t.doneCallback()}me=!0,i.needUpdateIBL=new Set},t.url)F=!0,r=Le(t);else if(t.texture&&t.texture instanceof e.Texture)F=!0,(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded);else if(t.texture&&t.texture instanceof e._AbstractRenderTarget){var n=t.texture;D.getImage().setTexture(n),D.setActivated(!0),n.minFilter=n.encoding!==e.RGBE_Encoding?e.LinearFilter:g,n.magFilter=n.minFilter,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),t.generateRougnessMap&&(N=!0,t.doneCallback&&t.doneCallback(n),i.needUpdateIBL=new Set,P=null,ve())}},this.setReflectionMap=function(i){var n=this,s=null,a=i.url,o=d;if(i.onMapsLoaded=function(){var t=s;D.getImage().setTexture(t),D.setActivated(!0),P=o;const r=t.encoding!==e.RGBE_Encoding?e.LinearFilter:g;t.minFilter=P.minFilter=r,t.magFilter=P.magFilter=r,t.wrapS=P.wrapS=e.RepeatWrapping,t.wrapT=P.wrapT=e.RepeatWrapping,i.doneCallback&&i.doneCallback(),n.needUpdateIBL=new Set},"dds"===r.getExtension(a))var l=e.ImageUtils.loadCompressedTexture(a,new e.LatLongReflectionMapping,(function(){w&&(ue||(ue=new t(w.renderer.renderer,w.renderer.renderTargetPool)),ue.setEnvMap(l,2),ue.execute(),o=null,s=ue.getResultRGBE(!0),i.onMapsLoaded())}))},this.setRoughnessMap=function(t){!0===t.pngHdr&&(t.pngHdr=e.RGBE_Encoding);var i=this,r=d;switch(t.pngHdr){case e.LogLUV_Encoding:r=u;break;case e.RGBM_Encoding:r=p}t.onMapsLoaded=function(n){P=n||r,t.pngHdr&&(P.sRGB=!1,P.hdr=!0,P.encoding=t.pngHdr),t.hasDiffuse&&(P.hasDiffuse=!0),P.minFilter=P.encoding!==e.RGBE_Encoding?e.LinearFilter:g,P.magFilter=P.minFilter,P.wrapS=e.RepeatWrapping,P.wrapT=e.RepeatWrapping,t.mapping&&(P.mapping=t.mapping),t.hdr&&(P.hdr=t.hdr),t.doneCallback&&t.doneCallback(),i.needUpdateIBL=new Set},t.url?r=Le(t):t.texture&&t.texture instanceof e.Texture?(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded):t.texture&&t.texture instanceof e._AbstractRenderTarget&&(r=t.texture,t.onMapsLoaded(r))},this.setBackplateMap=function(t){var i=null,r=this;t.onMapsLoaded=function(){r.setFiniteMode(!1),Be(i,t.mapping,t.hdr),t.doneCallback&&t.doneCallback()},t.url?i=Le(t):t.texture&&t.texture instanceof e.Texture&&(i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded))},this.generateIBLFromColor=function(t,i=e.RGBE_Encoding){for(var r=new Uint8Array(128),n=0;n<32;n++)r[4*n]=t[0],r[4*n+1]=t[1],r[4*n+2]=t[2],r[4*n+3]=t[3];var s=new e.DataTexture(r,8,4,e.RGBAFormat,void 0,void 0);s.hdr=!0,s.sRGB=!1,s.mapping=new e.LatLongReflectionMapping,s.encoding=i,s.minFilter=i!==e.RGBE_Encoding?e.LinearFilter:g,s.magFilter=s.minFilter,s.needsUpdate=!0;var a=new Uint8Array(256);for(n=0;n<64;n++)a[4*n]=t[0],a[4*n+1]=t[1],a[4*n+2]=t[2],a[4*n+3]=t[3];(P=new e.DataTexture(a,8,8,e.RGBAFormat,void 0,void 0)).hdr=!0,P.sRGB=!1,P.encoding=i,P.needsUpdate=!0,P.minFilter=s.magFilter,P.magFilter=s.magFilter,P.wrapS=e.RepeatWrapping,P.wrapT=e.RepeatWrapping,P.mapping=new e.LatLongReflectionMapping,D.getImage().setTexture(s),D.setActivated(!0),this.needUpdateIBL=new Set},this.setBackGroundMap=function(t){!0===t.pngHdr&&(t.pngHdr=e.RGBE_Encoding);var i=null;t.onMapsLoaded=function(){t.pngHdr&&(i.sRGB=!1,i.hdr=!0,i.encoding=t.pngHdr,t.hdr=!0),Be(i,t.mapping,t.hdr),B=!1;for(var e=0;e<V.length;e++)V[e].setBackGroundMap({texture:i,mapping:t.mapping,hdr:t.hdr});V=[],t.doneCallback&&t.doneCallback()},t.url?(B=!0,i=Le(t)):t.texture&&t.texture instanceof e.Texture?(B=!0,i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded)):t.texture&&t.texture instanceof e._AbstractRenderTarget&&Be(t.texture,t.mapping,t.hdr)},this.setExposure=function(e){E.setIntensity(e),D.setIntensity(e)},this.getEnvMapExposure=function(){return E.getIntensity()},this.lockAmbiance=function(e){de=e},this.setFiniteMode=function(e){T.isActivated()!=e&&T.setActivated(e)},this.setGroundGeometry=function(e){I.setWithGround(e)},this.getGroundPosition=function(){return I.getGroundPosition()},this.setGroundPosition=function(e){I.setGroundPosition(e)},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal"),I.setGroundNormal(e)},this.setSceneHeight=function(e){I.setSceneHeight(e)},this.setGroundHeight=function(e){T.setShootPosition(e)},this.setGroundRadius=function(e){T.setSize(e)},this.displayGround=function(e){A.setActivated(e),this.needsUpdateInfinitePlane=!0},this.setGroundScale=function(e){I.setGroundScale(e)},this.updateScene=function(e){I.setGroundPosition(e)},this.isAutoGroundOffset=function(){return A.getAutoHeight()},this.setAutoGroundOffset=function(e){A.setAutoHeight(e)},this.setGroundOffset=function(e){A.setHeight(e)},this.setEnvMapBlur=function(e){},this.getOffset=function(){return A.getHeight()},this.setEnvMapOffset=function(e){R.makeRotationZ(e),D.getMatrix().makeRotationZ(e),M&&(D.updateMatrix(),this.updateMatrix()),me=!0},this.setGroundReflectivitiy=function(e){A.setReflectivity(e),A.setActivated(!0)},this.setGroundReflectivity=function(e){A.setReflectivity(e),A.setActivated(!0)},this.setGroundShadowIntensity=function(e){A.setShadowIntensity(e),A.setActivated(!0)},this.isUsedMirror=function(){return A.isActivated()&&"transparent"==A.getType()&&A.getReflectivity()>0},this._setMirror=function(e){(e||"transparent"==A.getType())&&(A.setActivated(e),A.setType("transparent"),A.setReflectivity(.3))},this.getGroundGlossiness=function(){return A.getGlossiness()},this.setCustomBackplateCallback=function(e){E.setType("backplate"),E.setSizeScaling("custom"),E.setBackplateCB(e)},this.setBackplateOffset=function(e,t){ae&&ae.offset.set(e,t)},this.setBackplateSize=function(e,t){ae&&ae.invSize.set(e,t)},this.setGroundGlossiness=function(e){A.setGlossiness(e)},this.setTranslation=function(e){R.translate(e),M&&this.updateMatrix()},this.setSkyLightingInfo=function(e,t,i,r,n,s){this.skyLightingInfo={needsUpdate:!0,sunDirection:e,height:t,groundHeight:n,unitScale:s,intensity:i,withBackGround:r}},this.setSkyLighting=function(t,i,r,n,s){if(s){s.renderer.SkyScatteringEffect?s.renderer.SkyScatteringEffect.setEnabled(!0):s.renderer.initEffect("SkyScattering");var a=this;s.setShadow(!0),this.getGround().disableDefaultGroundShadow=!0,this.setExposure(r),X||((X=new h({color:16777215,intensity:5.5*Math.PI*r})).castShadows(!0,{mapWidth:s.shadowMapWidth,mapHeight:s.shadowMapHeight,bias:-.005}),this.addLightNode(X)),X.setDirection(t),s.renderer.SkyScatteringEffect.setGenerationInput({sunDirection:t,viewAltitude:i}),s.renderer.SkyScatteringEffect.execute(!0,(function(t){a.setIblMap({texture:t,hdr:!0,mapping:new e.LatLongReflectionMapping,generateRougnessMap:!0}),a.keepIBLTexture=!0,n&&(a.setBackGroundMap({texture:t,hdr:!0,mapping:new e.LatLongEnvMapping}),a.keepBackgroundTexture=!0)}))}},this.setTransitionBackground=function(t,i,r){this.setFiniteMode(!0),this.setAutoGroundOffset(!1),t.radius&&T.setSize(t.radius),this.setTransform(t.matrix),(h=E.getImage()).setTexture(t.map);var n=t.hdr?"hdr":"png";h.setFormat(n);var s=t.map,a=!!t.hdr,o=s.isCubeMap()?"transitionCube":"transition";a&&(s.minFilter=s.encoding!==e.RGBE_Encoding?e.LinearFilter:g,s.magFilter=s.minFilter,s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping);var l=E.getTransitionInfos();if(i&&i.map&&i.map.loadEndStatus===e.AssetLoadingStatus.READY){var h;(h=l.image).setTexture(i.map);n=i.hdr?"hdr":"png";h.setFormat(n);s=i.map;(a=!!i.hdr)&&(s.minFilter=s.encoding!==e.RGBE_Encoding?e.LinearFilter:g,s.magFilter=s.minFilter,s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping),l.ambienceMatrix=i.matrix,l.radius=i.radius,l.transition=r}else l.transition=0;E.setTransitionInfos(l),o==E.getType()&&ae?me=!0:(E.setType(o),E.needUpdate=!0)},this.dispose=function(e){f.has(P)||P.dispose(),!this.getIblMap()||this.keepIBLTexture&&!e||this.getIblMap().dispose();var t=E.getImage().getTexture();!t||this.keepBackgroundTexture&&!e||t.dispose(),E.setActivated(!1),D.setActivated(!1),T.setActivated(!1),ae&&ae.dispose(),this.needUpdateIBL=new Set,this.removeLights(),s.unsubscribe(this.requestIBLLightExtraction)},this.clone=function(e){e||(e={});var t={viewer:void 0!==e.viewer?e.viewer:null},i={};i.name=C,i.usePlaneV2=this.usePlaneV2,i.backgroundGeometryEditor=I.stream(),i.transform=R.elements.slice(0),i.background=E.stream(),i.backgroundGeometry=T.stream(),i.environmentLight=D.stream(),i.ground=A.stream(),t.v2=M,t.ambiance=i;var r=new x(t);return r.getGround().setAutoHeight(!0),r.setBackgroundColor(le.getHex()),r.setBackgroundAlpha(he),ie=!0,B&&V.push(r),F&&G.push(r),P&&r.setRoughnessMap({texture:P}),r},this.updateMatrix(),l.ambiance&&this.loadFrom3dx(l.ambiance,l.images,l.from3DX,l.doneCallback,!!l.roughnessMap),_e()};return x})),define("DS/Visualization/TextNode",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/EditableMesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet","DS/Visualization/MaterialApplication","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,i,r,n,s,a,o){"use strict";var l={};var h={count:97,width:256,height:256,chars:{0:{yoffset:1.5,width:4,xadvance:0,y:238,x:223,height:4,xoffset:-1.5},13:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:250,height:4,xoffset:-1.5},32:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:246,height:4,xoffset:-1.5},33:{yoffset:27.063,width:12,xadvance:9.5,y:0,x:186,height:30,xoffset:-.688},34:{yoffset:27.063,width:15,xadvance:18,y:15,x:210,height:14,xoffset:3},35:{yoffset:26.438,width:24,xadvance:19.5,y:125,x:48,height:28,xoffset:-1.875},36:{yoffset:32.125,width:24,xadvance:19.938,y:65,x:24,height:40,xoffset:-1.625},37:{yoffset:27.938,width:30,xadvance:31.813,y:94,x:48,height:31,xoffset:1.5},38:{yoffset:24.75,width:36,xadvance:33.25,y:38,x:0,height:27,xoffset:-.25},39:{yoffset:27.063,width:8,xadvance:10.875,y:238,x:246,height:14,xoffset:3},40:{yoffset:33,width:16,xadvance:12,y:105,x:24,height:41,xoffset:-.5},41:{yoffset:33,width:16,xadvance:12,y:211,x:48,height:41,xoffset:-2.188},42:{yoffset:28.938,width:19,xadvance:16.375,y:238,x:227,height:18,xoffset:.438},43:{yoffset:20.688,width:19,xadvance:18.875,y:237,x:135,height:19,xoffset:.25},44:{yoffset:6.938,width:11,xadvance:9.5,y:15,x:225,height:15,xoffset:-2.25},45:{yoffset:14.938,width:15,xadvance:15.063,y:247,x:181,height:7,xoffset:.25},46:{yoffset:6.938,width:10,xadvance:9.5,y:243,x:92,height:10,xoffset:-.875},47:{yoffset:31.875,width:22,xadvance:19.25,y:94,x:135,height:38,xoffset:-1},48:{yoffset:26.875,width:22,xadvance:21.25,y:65,x:81,height:29,xoffset:.188},49:{yoffset:26.375,width:16,xadvance:15.75,y:0,x:74,height:28,xoffset:0},50:{yoffset:26.875,width:21,xadvance:19,y:65,x:190,height:29,xoffset:-1.438},51:{yoffset:26.813,width:22,xadvance:18.938,y:65,x:147,height:29,xoffset:-2.188},52:{yoffset:27.063,width:22,xadvance:20.188,y:65,x:125,height:29,xoffset:-.938},53:{yoffset:26.375,width:23,xadvance:19.688,y:182,x:48,height:29,xoffset:-1.688},54:{yoffset:26.813,width:21,xadvance:20.375,y:65,x:211,height:29,xoffset:.125},55:{yoffset:26.438,width:20,xadvance:16.875,y:65,x:232,height:29,xoffset:.188},56:{yoffset:26.813,width:22,xadvance:21.125,y:65,x:103,height:29,xoffset:-.688},57:{yoffset:26.813,width:21,xadvance:20.375,y:222,x:24,height:30,xoffset:.438},58:{yoffset:20.188,width:11,xadvance:9.5,y:185,x:243,height:23,xoffset:-.875},59:{yoffset:20.25,width:13,xadvance:9.5,y:0,x:173,height:29,xoffset:-2.25},60:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:121,height:21,xoffset:.25},61:{yoffset:18.75,width:20,xadvance:18.875,y:0,x:210,height:15,xoffset:.688},62:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:141,height:21,xoffset:-.563},63:{yoffset:27.625,width:19,xadvance:18.625,y:185,x:0,height:30,xoffset:.938},64:{yoffset:27.625,width:38,xadvance:37.75,y:0,x:0,height:38,xoffset:.188},65:{yoffset:27.125,width:26,xadvance:21.563,y:209,x:201,height:29,xoffset:-3.125},66:{yoffset:27.063,width:23,xadvance:22.875,y:123,x:233,height:29,xoffset:.188},67:{yoffset:27.625,width:24,xadvance:21.063,y:187,x:109,height:30,xoffset:.25},68:{yoffset:27.063,width:25,xadvance:24.188,y:123,x:183,height:29,xoffset:.188},69:{yoffset:27.063,width:22,xadvance:19.5,y:94,x:234,height:29,xoffset:.188},70:{yoffset:27.063,width:21,xadvance:18.188,y:65,x:169,height:29,xoffset:.188},71:{yoffset:27.625,width:25,xadvance:23.625,y:153,x:230,height:30,xoffset:.25},72:{yoffset:27.063,width:25,xadvance:24.625,y:94,x:184,height:29,xoffset:.188},73:{yoffset:27.063,width:12,xadvance:10.813,y:0,x:198,height:29,xoffset:.188},74:{yoffset:27.063,width:16,xadvance:11,y:215,x:0,height:35,xoffset:-3.75},75:{yoffset:27.063,width:26,xadvance:22.438,y:209,x:227,height:29,xoffset:.188},76:{yoffset:27.063,width:19,xadvance:18.563,y:0,x:38,height:29,xoffset:.188},77:{yoffset:27.063,width:31,xadvance:29.188,y:94,x:78,height:29,xoffset:-1.25},78:{yoffset:27.063,width:25,xadvance:24.75,y:123,x:208,height:29,xoffset:.188},79:{yoffset:27.625,width:26,xadvance:25.5,y:123,x:157,height:30,xoffset:.25},80:{yoffset:27.125,width:24,xadvance:21.875,y:123,x:78,height:29,xoffset:.188},81:{yoffset:27.625,width:26,xadvance:25.5,y:94,x:109,height:34,xoffset:.25},82:{yoffset:27.125,width:24,xadvance:22.375,y:217,x:109,height:29,xoffset:.188},83:{yoffset:27.625,width:24,xadvance:20.313,y:157,x:109,height:30,xoffset:-1.75},84:{yoffset:27.063,width:23,xadvance:19.375,y:153,x:48,height:29,xoffset:.125},85:{yoffset:27.063,width:25,xadvance:24.25,y:153,x:205,height:30,xoffset:.75},86:{yoffset:27.063,width:25,xadvance:21.625,y:94,x:209,height:29,xoffset:.438},87:{yoffset:27.125,width:33,xadvance:30.875,y:65,x:48,height:29,xoffset:.813},88:{yoffset:27.063,width:27,xadvance:21.063,y:94,x:157,height:29,xoffset:-3},89:{yoffset:27.063,width:25,xadvance:21,y:128,x:109,height:29,xoffset:.125},90:{yoffset:27.063,width:24,xadvance:19.438,y:152,x:78,height:29,xoffset:-2.125},91:{yoffset:31.813,width:17,xadvance:12,y:146,x:24,height:38,xoffset:-1.625},92:{yoffset:31.875,width:20,xadvance:19.375,y:209,x:181,height:38,xoffset:-.438},93:{yoffset:31.875,width:17,xadvance:12,y:184,x:24,height:38,xoffset:-1.938},94:{yoffset:32.688,width:22,xadvance:19.875,y:238,x:201,height:15,xoffset:.5},95:{yoffset:-.563,width:22,xadvance:19.25,y:248,x:157,height:7,xoffset:-3.313},96:{yoffset:31.875,width:14,xadvance:12.125,y:243,x:78,height:11,xoffset:-.438},97:{yoffset:21.625,width:22,xadvance:21.375,y:38,x:60,height:24,xoffset:-.375},98:{yoffset:29.438,width:22,xadvance:21.75,y:132,x:135,height:32,xoffset:-.125},99:{yoffset:21.625,width:20,xadvance:17.25,y:38,x:211,height:24,xoffset:-.375},100:{yoffset:29.438,width:24,xadvance:21.688,y:153,x:181,height:32,xoffset:-.375},101:{yoffset:21.625,width:21,xadvance:19.25,y:38,x:169,height:24,xoffset:-.375},102:{yoffset:29.5,width:24,xadvance:12.375,y:65,x:0,height:40,xoffset:-4.188},103:{yoffset:21.688,width:23,xadvance:21.625,y:216,x:157,height:32,xoffset:-1.125},104:{yoffset:29.438,width:22,xadvance:21.25,y:212,x:78,height:31,xoffset:-.25},105:{yoffset:30.938,width:13,xadvance:10,y:0,x:108,height:33,xoffset:-.375},106:{yoffset:30.938,width:17,xadvance:10,y:196,x:135,height:41,xoffset:-4.938},107:{yoffset:29.438,width:22,xadvance:20.813,y:181,x:78,height:31,xoffset:-.25},108:{yoffset:29.438,width:12,xadvance:10.438,y:0,x:161,height:32,xoffset:0},109:{yoffset:21.625,width:32,xadvance:31.375,y:185,x:181,height:24,xoffset:-.25},110:{yoffset:21.625,width:22,xadvance:21.25,y:38,x:104,height:24,xoffset:-.25},111:{yoffset:21.625,width:22,xadvance:21.313,y:38,x:82,height:24,xoffset:-.375},112:{yoffset:21.625,width:24,xadvance:21.75,y:153,x:157,height:32,xoffset:-1.375},113:{yoffset:21.625,width:22,xadvance:21.563,y:164,x:135,height:32,xoffset:-.375},114:{yoffset:21.625,width:18,xadvance:14.313,y:0,x:90,height:24,xoffset:-.25},115:{yoffset:21.563,width:20,xadvance:17.563,y:38,x:231,height:24,xoffset:-1.938},116:{yoffset:26,width:17,xadvance:13.75,y:0,x:57,height:29,xoffset:-.563},117:{yoffset:21.063,width:21,xadvance:21.063,y:38,x:148,height:24,xoffset:.313},118:{yoffset:21.125,width:22,xadvance:18.375,y:38,x:126,height:23,xoffset:-.375},119:{yoffset:21.125,width:30,xadvance:27.125,y:185,x:213,height:23,xoffset:0},120:{yoffset:21.063,width:24,xadvance:18,y:38,x:36,height:23,xoffset:-3.438},121:{yoffset:21.125,width:24,xadvance:18.313,y:185,x:157,height:31,xoffset:-2.25},122:{yoffset:21.063,width:21,xadvance:16.375,y:38,x:190,height:23,xoffset:-2.5},123:{yoffset:32.438,width:16,xadvance:12,y:145,x:0,height:40,xoffset:-.813},124:{yoffset:31.375,width:12,xadvance:14.375,y:211,x:64,height:37,xoffset:1.688},125:{yoffset:32.438,width:16,xadvance:12,y:105,x:0,height:40,xoffset:-2.313},126:{yoffset:16.125,width:21,xadvance:18.875,y:246,x:109,height:9,xoffset:-.438}},base:41},c=t.getWebappsAssetUrl("Visualization",""),d=new e.ImageUtils.loadTexture(c+"fonts/default.png",void 0,null,null,!0);d.flipY=!0,d.anisotropy=16;const u=(e,t,i)=>o.FunctionHandler.callFunction(e,t,i);var p=new e.Vector3,f=i.extend({init:function(t,i,r){this.lineHeight=1,this.nbChars=0,this.textArray={},this._paramsLocked=!!r,this.billboard=!(!r||void 0===r.billboard)&&!!r.billboard,this.billboardAxis=!(!r||void 0===r.billboardAxis)&&!!r.billboardAxis,this.fixedSize=!(!r||void 0===r.fixedSize)&&!!r.fixedSize,this.viewSpace=!(!r||void 0===r.viewSpace)&&!!r.viewSpace,this.projectionSpace=!(!r||void 0===r.projectionSpace)&&!!r.projectionSpace,this.textMaterial=null,this.textGas=new s({colorRGB:new e.Color(0),side:e.FrontSide}),this._initMaterialPDSFX(this._paramsLocked),this._setFont();var n=new e.Mesh(void 0,null);return this._token=0,this.mesh3js=null,this._parent(n,t),this.mesh3js=this._occurrences[0].renderable,this._reallocate(r&&r.allocSize?r.allocSize:512),this.setFrustumCulled(!0),this.matInherit=window.newMaterialInheritance,this.matInherit?(this.matApp=new a({faceMaterial:this.textMaterial,layer:0}),this.textMaterial.useGASColor=!0,this.setMaterialApplication(this.matApp)):this.setMaterial(this.textMaterial),this.setMaterialMode(!0),this},clone:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return new f(t,this.name)},getNodeType:function(){return"Mesh3D"},setBillboard:function(e,t){this._paramsLocked||this.billboard===e&&this.billboardAxis===t||(this.billboard=e,this.billboardAxis=t,this._updateDefines())},setFixedSize:function(e){this._paramsLocked||this.fixedSize!==e&&(this.fixedSize=e,e&&(this.billboard=!0),this._updateDefines())},_setViewSpace:function(e){this._paramsLocked||this.viewSpace!==e&&(this.viewSpace=e,this.projectionSpace=!e,this._updateDefines())},_setProjectionSpace:function(e){this._paramsLocked||this.projectionSpace!==e&&(this.projectionSpace=e,this.viewSpace=!e,this._updateDefines())},_updateDefines:function(){var e={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=e,this.textMaterial.updateDeferredMaterials(),this.textMaterial.needsUpdate=!0},getBillboard:function(){return this.billboard},addText:function(e){var t=e.string.length;if(0==t)return-1;var i=this._addText(e);if(i){e.primitive=i;var r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}var n=this._reallocate(t),s=this._occurrences[0].renderable;if(i=this._addText(e,null!==n?s.layer.layers[n]:null,n)){e.primitive=i;r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}return-1},removeText:function(e){var t=this.textArray[e];t&&(this.hide([n.getFromSGNode(t.primitive)]),this.nbChars-=t.string.length,delete this.textArray[e])},_setFont:function(){this.textMaterial&&this.textMaterial.updatePDSFXUniform("fontMap",d)},_reallocate:function(t){var i=this._occurrences[0].renderable,n=4*t,s=i.geometry.length,a=s?i.geometry[s-1]:null,o=a?a.vertexPositionArray.length/3:0,l=!s||65536===o,h=l?e.ImageUtils.nearest_greater_pow2(n):e.ImageUtils.nearest_greater_pow2(o+n),c=new e.BufferGeometryDS;c.editable=!0,c.vertexIndexArray=new Uint16Array(6*h/4),c.vertexPositionArray=new Float32Array(3*h),c.vertexColorArray=new Float32Array(4*h),c.vertexNormalArray=new Float32Array(3*h),c.vertexUvArray=new Float32Array(3*h),c.vertexUv2Array=new Float32Array(3*h),c.vertexTangentArray=new Float32Array(3*h),c.vertexBinormalArray=new Float32Array(3*h);for(var d=0;d<3*h;d+=3)c.vertexPositionArray[d]=NaN;var u=null;if(l){var p=new r.SGPrimitive({cgmId:this._token,rep:null,start:0,count:6*h/4});this._token++,(g=new r.DrawingGroup(this.textGas,null,4,0,6*h/4,[p])).geometry=c,c.drawingGroups.push(g),p.group=g;for(var f=0;f<this._occurrences.length;f++){(b=this._occurrences[f].renderable).geometry.push(c),c.addRefVBO(b,!1),b._initLayersForGeometry(0,c),u=(x=b.layer.getIntervals(c,null,!0)).length?b.layer.layers.indexOf(x[0]):-1}}else{for(d=0;d<4*o;d++)c.vertexColorArray[d]=a.vertexColorArray[d],d<3*o&&(c.vertexPositionArray[d]=a.vertexPositionArray[d],c.vertexNormalArray[d]=a.vertexNormalArray[d],c.vertexUvArray[d]=a.vertexUvArray[d],c.vertexUv2Array[d]=a.vertexUv2Array[d],c.vertexTangentArray[d]=a.vertexTangentArray[d],c.vertexBinormalArray[d]=a.vertexBinormalArray[d]);for(d=0;d<6*o/4;d++)c.vertexIndexArray[d]=a.vertexIndexArray[d];var g,m=a.drawingGroups[0]._primitives.slice(),v=m[m.length-1],_=v.start+v.count,y=6*h/4-_,S=new r.SGPrimitive({cgmId:this._token,rep:null,start:_,count:y});m.push(S),this._token++,(g=new r.DrawingGroup(this.textGas,null,4,0,6*h/4,m)).geometry=c,c.drawingGroups.push(g);for(f=0;f<m.length;f++)m[f].group=g;for(f=0;f<this._occurrences.length;f++){for(var b,x=(b=this._occurrences[f].renderable).layer.getIntervals(b.geometry[s-1],null,!0),w=0;w<x.length;w++)x[w].geometry=c,x[w].drawableGroup=c.drawingGroups[0];var P=x[x.length-1],C=b.layer.layers.indexOf(P);if(P.drawableInterval.layerNum){var M=new e.DrawableInterval(0,_,y);M.primitiveStart=m.length-1,M.primitiveCount=1;var E=new e.LayerInterval(c,c.drawingGroups[0],M);b.layer.layers.splice(C+1,0,E),u=C+1}else P.drawableInterval.count+=y,P.drawableInterval.primitiveCount++,u=C;c.addRefVBO(b,!1),b.geometry[s-1].releaseVBO(b,!1),b.geometry.splice(s-1,1),b.geometry.push(c)}}return u},_initMaterialPDSFX:function(t){var i="_";if(t&&(this.billboard&&(i+="bi_"),this.billboardAxis&&(i+="ax_"),this.fixedSize&&(i+="fi_"),this.viewSpace&&(i+="vi_"),this.projectionSpace&&(i+="pr_"),l[i]))this.textMaterial=l[i];else{if(this.textMaterial=new e.MeshBasicMaterial({force:!this.matInherit,side:e.FrontSide,needTangentBinormal:!0,transparent:!0}),t){var r={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=r}this.textMaterial.activatePDSFX("PDSFXTextNode");var n={fontMap:{type:"t2",value:null},quad:{type:"fv4",value:[-.5,0,0,0,-.5,0,0,0,.5,0,0,0,-.5,0,0,0,.5,0,0,0,.5,0,0,0,-.5,0,0,0,.5,0,0,0],length:8},invSize:{type:"v2",value:new e.Vector2(512,512)}};this.textMaterial.setPDSFXUniforms(n);this.textMaterial.setPDSFXVaryings({_color:{type:"v4"},_uv:{type:"v2"}}),this.textMaterial.setPDSFXGlobalShaderCode(null,(e=>`\n                    ${e.variableHandler.floatG("alpha")};\n                `));var s={ComputeVaryingValues:function(e,t){const i=e.variableHandler,r=(e.functionHandler,e.pdsfxDefines,e.userDefines,t=>e.getVarying(t));return`\n                        ${r("_color")} = ${(e=>i.vec4(e))()}(${e.vGetAttribColor()}.rgb, 1.0);\n                        ${r("_uv")} = ${e.vGetAttribTexCoord0()}.xy;\n                    `},ProcessClipSpacePosition:function(t,i){const r=t.variableHandler,n=t.functionHandler,s=(t.pdsfxDefines,t.userDefines),a=e=>t.getUniform(e),o=e=>r.int(e),l=e=>r.vec2(e),h=e=>r.vec3(e),c=e=>r.vec4(e),d=r.dereference(i[0]),p=((e=>{t.getTextureUniform(e)})("fontMap"),a("quad")),f=a("invSize"),g=!!s.USE_BILLBOARD,m=!!s.USE_FIXEDSIZE,v=!!s.USE_VIEWSPACE,_=!!s.USE_PROJSPACE,y=!!s.USE_AXIS;return`\n                        ${h("mPos")}  = ${t.vGetAttribPosition()};\n                        ${h("mNormal")}  = ${t.vGetAttribNormal()};\n                        ${c("mUV2")}  = ${t.vGetAttribTexCoord1()};\n                        ${h("mTangent")}  = ${t.vGetAttribTangent()};\n                        ${h("mBinormal")}  = ${t.vGetAttribBinormal()};\n\n                        ${h("uncompressedUp")}  = mTangent;\n\n                        ${h("uncompressedRight")}  = mBinormal;\n\n                        ${h("corner")}  = ${h()}\n                            (\n                                ${p}[2*${o()}(${t.vGetAttribColorAlpha()})].x, \n                                ${p}[2*${o()}(${t.vGetAttribColorAlpha()}) + 1].x, \n                                0.0\n                            );\n\n                        ${g?m?`\n                                ${v?`\n                                    ${c("mvPosition")}  = ${u("getModelTransformation","v4",[n.prmV3("mPos")])};\n                                    `:_?`\n                                        ${c("projPosition")}  = ${c()}(mPos.xy, 0.0, 1.0);\n                                        `:`                        \n                                        ${c("mPosV4")} = ${c()}(mPos, 1.0);\n                                        ${e._DefaultShaderChunk.getModelViewTransformationChunk(c("mvPosition"),"mPosV4",t.__internalOptions__)}\n                                        `}\n                                ${y?v?`                                      \n                                            ${c("mvPosition2")}  = ${u("getModelTransformation","v4",[n.prmV3("mPos + uncompressedRight")])};\n                                            `:_?`\n                                                ${c("projPosition2")}  = ${c()}(uncompressedRight.xy, 0.0, 1.0);\n                                                `:`                                      \n                                                ${c("mPos2V4")} = ${c()}(mPos + uncompressedRight, 1.0);\n                                                ${e._DefaultShaderChunk.getModelViewTransformationChunk(c("mvPosition2"),"mPos2V4",t.__internalOptions__)}\n                                                `:""}\n                                `:`\n                                ${c("mPosV4")} = ${c()}(mPos, 1.0);\n                                ${e._DefaultShaderChunk.getModelViewTransformationChunk(c("_mvPos"),"mPosV4",t.__internalOptions__)}\n                                ${c("mvPosition")} = _mvPos + ${c()}(mNormal, 0.0) + ${c()}(corner * ${h()}(mUV2.xy, 1.0), 0.0);\n                                `:`\n                            ${c("newPosition")}  = ${c()}(mPos + ${(e=>r.mat3(e))()}(uncompressedRight, uncompressedUp, ${h()}(0.0, 0.0, 1.0)) * (mNormal + corner * ${h()}(mUV2.xy, 1.0)), 1.0);\n                            ${e._DefaultShaderChunk.getModelViewTransformationChunk(`${c("mvPosition")}`,"newPosition",t.__internalOptions__)}\n                            `}\n                        ${h("mvNormal")};\n\n                        ${_?`\n                            ${d} = projPosition;\n                            `:`\n                            ${d}  = ${t.vGetProjectionMatrix()} * mvPosition;\n                            `}\n                        ${m?y?`\n                                ${_?`                                      \n                                        ${l("toPixels")}  = 0.5 / ${f};\n                                        ${l("projPt1")}  = toPixels * projPosition.xy;\n                                        ${l("projPt2")}  = toPixels * projPosition2.xy;\n                                        `:`\n                                        ${c("glPosition2")}  = ${t.vGetProjectionMatrix()} * mvPosition2;\n                                        ${l("toPixels1")}  = 0.5 / (${f} * ${d} .w);\n                                        ${l("toPixels2")}  = 0.5 / (${f} * glPosition2.w);\n                                        ${l("projPt1")}  = toPixels1 * ${d} .xy;\n                                        ${l("projPt2")}  = toPixels2 * glPosition2.xy;\n                                        `}\n                                \n                                ${l("rightVecPx")}  = normalize(projPt2.xy - projPt1.xy);\n                                ${l("upVecPx")}  = ${l()}(-rightVecPx.y, rightVecPx.x);\n                                ${l("offsetVec")}  = (mNormal.xy + corner.xy * mUV2.xy);\n                                offsetVec = offsetVec.x * rightVecPx + offsetVec.y * upVecPx;\n                                ${_?`\n                                        ${d}.x += 2.0 * ${f}.x * offsetVec.x;\n                                        ${d}.y += 2.0 * ${f}.y * offsetVec.y;\n                                        `:`\n                                        ${d}.x += 2.0 * ${f}.x * offsetVec.x * ${d} .w;\n                                        ${d}.y += 2.0 * ${f}.y * offsetVec.y * ${d} .w;\n                                        `}\n                                `:`\n                                ${d}.x += 2.0 * ${f}.x * (mNormal.x + corner.x * mUV2.x) * ${d}.w;\n                                ${d}.y += 2.0 * ${f}.y * (mNormal.y + corner.y * mUV2.y) * ${d}.w;\n                                `:""}\n                    `}};this.textMaterial.setPDSFXOverridableFunctions(s,{ComputeCommonValues:function(e,t){const i=e.variableHandler,r=e.bridgeFunctions,n=e.pdsfxDefines,s=(e.userDefines,e=>i.float(e)),a=(t=>e.getTextureUniform(t))("fontMap");return`\n                        ${s("epsilon")}  = 0.1;\n                        ${(e=>i.vec4(e))("texture")}  = ${r.sample2DTexture(a,(t=>e.getVarying(t))("_uv"))};\n\n                        ${n.extDerivatives?`\n                            ${s("w")} = clamp(200.0 * epsilon * (abs(${r.dpdx("_uv.x")}) + abs(${r.dpdy("_uv.y")})), 0.0, 0.5);\n                            `:`\n                            ${s("w")} = epsilon;\n                            `}\n\n                        alpha = smoothstep(0.5 - w, 0.5 + w, texture.r);\n                        alpha = pow(alpha, 1.0/2.2);\n                    `},ComputeDiscard:function(e,t){const i=e.variableHandler;return`\n                        ${(e=>i.float(e))("alphaTest")} = 0.01;\n                        // IR 797819\n                        return (alpha < alphaTest);\n                    `},ProcessFinalColor:function(e,t){const i=e.variableHandler;return`\n                        ${i.dereference(t[0])} = ${(e=>i.vec4(e))()}(${e.vGetAlbedo()} * ${(t=>e.getVarying(t))("_color")}.xyz, alpha * ${e.vGetOpacity()});\n                    `}}),this.textMaterial.enableClipPlanes=!0,t&&(l[i]=this.textMaterial)}},_addText:function(e,t,i){var r=e.string.length,n=this._occurrences[0].renderable;if(!t)for(var s=0;s<n.layer.layers.length;s++){var a=n.layer.layers[s],o=a.drawableInterval;if(!o.layerNum&&o.count>=6*r){t=a,i=s;break}}if(t){var l=this._updatePrimitives(t,i,r);return this._updateBuffers(l,e),l}return null},_encodeUnitVector:function(e){var t=Math.abs(e.x)+Math.abs(e.y)+Math.abs(e.z),i=e.x/t,r=e.y/t;if(e.z<0){var n=(1-Math.abs(r))*(i>=0?1:-1),s=(1-Math.abs(i))*(r>=0?1:-1);i=n,r=s}return 4096*(i=Math.round(4095*(.5*i+.5)))+(r=Math.round(4095*(.5*r+.5)))},_updateBuffers:function(t,i){for(var n=new e.Box2,s=t.getGroup().geometry,a=t.getStart(),o=4*(a/6),l=i,c=l.string.length,d=l.offset?l.offset:p,u=this.getBuffer(r.VertexComponentEnum.POSITION,s),f=this.getBuffer(r.VertexComponentEnum.NORMAL,s),g=this.getBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,s),m=this.getBuffer(r.VertexComponentEnum.TEX_COORD_0,s),v=this.getBuffer(r.VertexComponentEnum.TEX_COORD_1,s),_=this.getBuffer(r.VertexComponentEnum.TEX_COORD_2,s),y=this.getBuffer(r.VertexComponentEnum.TEX_COORD_3,s),S=this.getIndexBuffer(s),b=l.size/h.base,x=l.lineLength?l.lineLength:0,w=0,P=new e.Vector3,C=a,M=o,E=3*o,T=4*o,A=3*o,D=3*o,I=3*o,R=3*o,O=3*o,L=0,B=0;B<c;B++){var F=l.string[B];if("\n"===F)P.x=0,P.y-=b*this.lineHeight*h.base,w=0;else{if(x&&" "===F&&w>x){P.x=0,P.y-=b*this.lineHeight*h.base,w=0;continue}if(!(F=h.chars[F.charCodeAt(0)]))continue;L++,S[C++]=M,S[C++]=M+1,S[C++]=M+2,S[C++]=M,S[C++]=M+2,S[C++]=M+3,M+=4,m[I++]=F.x/h.width,m[I++]=(h.height-(F.y+F.height))/h.height,m[I++]=0,m[I++]=(F.x+F.width)/h.width,m[I++]=(h.height-(F.y+F.height))/h.height,m[I++]=0,m[I++]=(F.x+F.width)/h.width,m[I++]=(h.height-F.y)/h.height,m[I++]=0,m[I++]=F.x/h.width,m[I++]=(h.height-F.y)/h.height,m[I++]=0;var V=P.x+b*(.5*F.width+F.xoffset),G=P.y+b*(F.yoffset-.5*F.height);P.z;P.x+=b*F.xadvance,w+=b*F.xadvance,n&&(V-.5*b*F.width<n.min.x&&(n.min.x=V-.5*b*F.width),V+.5*b*F.width>n.max.x&&(n.max.x=V+.5*b*F.width),G-.5*b*F.height<n.min.y&&(n.min.y=G-.5*b*F.height),G+.5*b*F.height>n.max.y&&(n.max.y=G+.5*b*F.height));for(var N=0;N<4;N++)f[E++]=d.x+V,f[E++]=d.y+G,f[E++]=d.z,u[A++]=l.anchor.x,u[A++]=l.anchor.y,u[A++]=l.anchor.z,v[D++]=b*F.width,v[D++]=b*F.height,v[D++]=0,g[T++]=l.color.r,g[T++]=l.color.g,g[T++]=l.color.b,g[T++]=N,_[R++]=l.up.x,_[R++]=l.up.y,_[R++]=l.up.z,y[O++]=l.right.x,y[O++]=l.right.y,y[O++]=l.right.z}}for(B=0;B<6*(c-L);B++)S[C++]=0;this.updateBuffer(r.VertexComponentEnum.POSITION,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.NORMAL,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_0,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_1,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_2,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_3,o,4*c,s),this.updateIndexBuffer(a,6*c,s);var U=new e.Vector3(n.min.x,n.min.y,-.5),k=new e.Vector3(n.max.x,n.max.y,.5),z=this.getBoundingBox(),H=new e.Box3(U,k);this.forceBoundingBox(z.union(H)),i.labelExtent||(i.labelExtent=n)},getTextExtent:function(t){var i=new e.Box2;t.labelExtent=i;for(var r=t,n=r.string.length,s=r.size/h.base,a=r.lineLength?r.lineLength:0,o=0,l=new e.Vector2,c=0;c<n;c++){var d=r.string[c];if("\n"===d)l.x=0,l.y-=s*this.lineHeight*h.base,o=0;else{if(a&&" "===d&&o>a){l.x=0,l.y-=s*this.lineHeight*h.base,o=0;continue}if(!(d=h.chars[d.charCodeAt(0)]))continue;var u=l.x+s*(.5*d.width+d.xoffset),p=l.y+s*(d.yoffset-.5*d.height);l.x+=s*d.xadvance,o+=s*d.xadvance,u-.5*s*d.width<i.min.x&&(i.min.x=u-.5*s*d.width),u+.5*s*d.width>i.max.x&&(i.max.x=u+.5*s*d.width),p-.5*s*d.height<i.min.y&&(i.min.y=p-.5*s*d.height),p+.5*s*d.height>i.max.y&&(i.max.y=p+.5*s*d.height)}}return i},_updatePrimitives:function(e,t,i){this._mergePrimitives(e,t);var n=e.geometry,s=n.drawingGroups[0],a=e.drawableInterval,o=s.getPrimitiveCount(a.primitiveStart);s._setPrimitiveCount(6*i,a.primitiveStart);var l=new r.SGPrimitiveHelper;l.set(s,a.primitiveStart);var h=o-l.getCount();if(h>0){var c=new r.SGPrimitive({cgmId:this._token,rep:null,group:l.getGroup(),start:l.getStart()+l.getCount(),count:h});this._token++,s._primitives.splice(a.primitiveStart+1,0,c)}for(var d=0;d<this._occurrences.length;d++){var u=this._occurrences[d].renderable,p=u.layer.layers[t],f=t?u.layer.layers[t-1]:null,g=f&&f.geometry===p.geometry;if(f&&g&&1===f.drawableInterval.layerNum)f.drawableInterval.count+=l.getCount(),f.drawableInterval.primitiveCount++,h>0?(p.drawableInterval.start=l.getStart()+l.getCount(),p.drawableInterval.count=h,p.drawableInterval.primitiveStart++):u.layer.layers.splice(t,1);else if(p.drawableInterval.count=6*i,p.drawableInterval.layerNum=1,h>0){var m=p.clone();m.drawableInterval.layerNum=0,m.drawableInterval.start=l.getStart()+l.getCount(),m.drawableInterval.count=h,u.layer.layers.splice(t+1,0,m)}if(h>0)for(var v=t+1;v<u.layer.layers.length&&u.layer.layers[v].geometry===n;v++)u.layer.layers[v].drawableInterval.primitiveStart++}return l},_mergePrimitives:function(e,t){var i=e.geometry,r=i.drawingGroups[0]._primitives,n=e.drawableInterval;if(!(n.primitiveCount<=1)){var s=r[n.primitiveStart],a=r[n.primitiveStart+n.primitiveCount-1];s.count=a.start+a.count-s.start,r.splice(n.primitiveStart+1,n.primitiveCount-1);for(var o=0;o<this._occurrences.length;o++)for(var l=this._occurrences[o].renderable,h=t+1;h<l.layer.layers.length&&l.layer.layers[h].geometry===i;h++)l.layer.layers[h].drawableInterval.primitiveStart-=n.primitiveCount-1;n.primitiveCount=1}}});return UWA.namespace("THREEDS/Nodes/TextNode",f)})),define("DS/Visualization/LensFlareNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],(function(e,t){"use strict";var i=t.extend({init:function(t,i){this._parent(i),this.lensflare3js=void 0!==t?t:new e.ParticleSystem,t=this.createRenderable();var r=this._occurrences[0];return r.renderable=t,r.renderable.name=this.name,r.renderable._occurrence=r,this},createRenderable:function(){var e=this.lensflare3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.lensflare3js.visible,e.pickable=!1,e.noPickThrough=!1,e.enableNormalDepth=!1,e},add:function(){return!1},getNodeType:function(){return"LensFlareNode3D"}});return UWA.namespace("THREEDS/Nodes/LensFlare",i)})),define("Visualization/LensFlareNode3D",["DS/Visualization/LensFlareNode3D","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/LensFlareNode3D"),e})),define("DS/Visualization/PlaneGrid",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Visualization/TextNode"],(function(e,t,r,n,s,a){"use strict";var o=(new r.Color).setRGB(1,1,1),l=(new r.Vector3(0,0,1),new r.Vector3(0,0,-1),new r.Vector3(1,0,0)),h=new r.Vector3(0,1,0),c=new r.Vector3(0,0,1),d=new r.Vector3(-1,0,0),u=new r.Vector3(0,-1,0),p=new r.Vector3(0,0,-1),f=new r.Vector3,g=new r.Vector2,m=new r.Vector2;return Math.round10||(Math.round10=function(e,t){return function(e,t,i){return void 0===i||0==+i?Math[e](t):(t=+t,i=+i,isNaN(t)||"number"!=typeof i||i%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math[e](+(t[0]+"e"+(t[1]?+t[1]-i:-i)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+i:i))))}("round",e,t)}),e.extend({init:function(e){this.viewer=e,this.worldOrientation=null,this.position=new r.Vector3,this.size=100,this.displayLabels=!1,this.gridLabels=null,this.labelColor=o,this.labelCB=null,this.displayLabelCB=null,this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]},this.displayGrid=e.displayGrid,this.displayGridFromBelow=e.displayGridFromBelow,this.gridScreenSize=50,this.gridNbSteps=e.gridNbSteps,this.gridUnit=1,this.gridOffset=new r.Vector2,this.gridCoeff=0,this.gridFalloff=0,this.gridColor=e.gridColor,this.displayPlane=1,this.planeFalloff=0,this.planeColor=e.planeColor,this.planeOpacity=1,this.planeTexture=null,this.planeTextureScale=1,this._onlyDiffuse=!1,this.planeBorder=!1,this.edgeColor=new r.Color,this.mesh=null,this.matrix=new r.Matrix4,this.material=null,this.gridTextures={},this.viewProjMatrix=new r.Matrix4,this.tmpFrustum=new r.Frustum,this.tmpPoly1=new r.CGPolygon,this.tmpPoly2=new r.CGPolygon,this.tmpLine=new r.Line3(new r.Vector3,new r.Vector3)},setGridNbSteps:function(e){this.gridNbSteps=e,this.setGridTextures()},setLabels:function(e){if(e!==this.displayLabels){if(this.displayLabels=e,e&&!this.gridLabels){this.gridLabels=new a("gridLabels"),this.gridLabels.setBillboard(!0,!0),this.gridLabels.setFixedSize(!0),this.gridLabels._setProjectionSpace(!0);var t=this.gridLabels._occurrences[0].renderable;t.renderDepth=0,t.receiveShadow=!1,this.viewer.sceneBackground.add(t)}this.gridLabels&&(this.gridLabels.setVisibility(e),this.gridLabels.setVisibilityFree(e))}},setLabelColor:function(e){this.labelColor=new r.Color,this.labelColor.set(e)},setLabelCallback:function(e){this.labelCB=e},setDisplayLabelCallback:function(e){this.displayLabelCB=e},getUnitGridTexture:function(e){if(this.gridTextures[e])return this.gridTextures[e];for(var t=new Uint8Array(e*e),i=0;i<e;++i)t[i]=255,t[e*(e-1)+i]=255,t[e*i]=255,t[e*i+e-1]=255;var n=new r.DataTexture(t,e,e,r.RFormat,r.UnsignedByteType,new r.UVMapping,r.RepeatWrapping,r.RepeatWrapping,r.LinearFilter,r.LinearMipMapLinearFilter,16);return n.needsUpdate=!0,this.gridTextures[e]=n,n},setGridTextures:function(){if(this.material){var e=this.gridNbSteps/2,t=r.ImageUtils.nearest_pow2(64*e),i=r.ImageUtils.nearest_pow2(64*e*e),n=Math.min(r.ImageUtils.nearest_pow2(64*e*e*e),4096);this.material.updatePDSFXUniform("gridTexture",this.getUnitGridTexture(64)),this.material.updatePDSFXUniform("gridTexture2",this.getUnitGridTexture(t)),this.material.updatePDSFXUniform("gridTexture3",this.getUnitGridTexture(i)),this.material.updatePDSFXUniform("gridTexture4",this.getUnitGridTexture(n))}},createGridGeometry:function(e,t,r){var a=e+1,o=t>0?a-(Math.floor(a/t)+1):a,l=1/e,h=new s.PrimitiveGroup,c=6*o,d=8*o,u=new s.Buffer({component:s.VertexComponentEnum.POSITION,data:new Float32Array(3*c)}),p=new Uint16Array(d),f=new s.Buffer({indexBuffer:!0,data:p});h.addBuffer(0,u),h.addBuffer(1,f);var g=0,m=0,v=u.data,_=f.data;for(i=0;i<a;i++)t>0&&!(i%t)||(v[g++]=1-2*i*l,v[g++]=-1,v[g++]=0,v[g++]=1-2*i*l,v[g++]=0,v[g++]=0,v[g++]=1-2*i*l,v[g++]=1,v[g++]=0,v[g++]=-1,v[g++]=1-2*i*l,v[g++]=0,v[g++]=0,v[g++]=1-2*i*l,v[g++]=0,v[g++]=1,v[g++]=1-2*i*l,v[g++]=0);for(i=0;i<4*o;i++)_[m++]=3*i,_[m++]=3*i+1,_[m++]=3*i+1,_[m++]=3*i+2;var y=new s.Primitive({nbIndices:d,connectivity:s.ConnectivityTypeEnum.LINES,fillGAS:new s.FillAttributes(new s.Color(.2,.2,.2,1))}),S=new s.VertexComponent({nbVertices:c,bufferId:0,indices:new s.IndexArray({bufferId:1,offset:0})});y.addVertexComponent(S),h.addPrimitive(y);var b=n.createMeshNode(h,r);return b._setIsAlwaysInForeground(!0),b.setVisibilityFree(!0),(h=b._occurrences[0].renderable).frustumCulled=!1,h.receiveShadow=!1,h.renderDepth=1,h.pickable=!1,h},createPlaneGrid:function(e,t,i,s,a,o){this.size=e,this.position=t,this.worldOrientation=i.getWorldOrientation();var l=this.worldOrientation.upVector,h="zup"===this.worldOrientation._woName;this.computeGridUnit(i.camera,Math.abs(i.camera.position.dot(l)-this.position.dot(l)));var c=this.gridNbSteps*this.gridUnit;if(this.gridOffset.x=s?t.x-c*Math.floor(t.x/c):0,h?this.gridOffset.y=s?t.y-c*Math.floor(t.y/c):0:this.gridOffset.z=s?t.z-c*Math.floor(t.z/c):0,!this.mesh){this.material=new r.PlaneMaterial,this.material.setPlaneV2(!0),this.material.ambient.copy(new r.Color(328965)),this.setGridTextures();var d=n.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:this.material});d.setVisibilityFree(!0),this.mesh=d._occurrences[0].renderable,this.mesh.frustumCulled=!1,this.mesh.receiveShadow=!1,this.mesh.renderDepth=1,this.viewer.sceneBackground.add(this.mesh),this.mesh.pickable=!1}this.mesh.visible=!0;var u=new r.Vector3,p=new r.Vector3,f=(new r.Matrix4).copy(a);u.copy(this.worldOrientation.frontVector),u.multiplyScalar(t.x-.5*e),p.copy(this.worldOrientation.rightVector),p.multiplyScalar(t.y-.5*e),u.add(p),p.copy(this.worldOrientation.upVector),p.multiplyScalar(t.z),u.add(p),f.setPosition(u),f.scale(new r.Vector3(e,e,e)),this.mesh.setMatrix(f),this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow),this.material.color.copy(this.planeColor),this.material.updatePDSFXUniform("planeOpacity",this.planeOpacity),this.material.setPlaneTexture(this.planeTexture),this.material.updatePDSFXUniform("uvScale",this.planeTextureScale);var g=new r.Color;g.copyToLinear(this.edgeColor,o),this.material.updatePDSFXUniform("border",g),this.material.updatePDSFXUniform("attenuation",this.viewer.planeAttenuation?1:0),this.material.updatePDSFXUniform("planeBorder",this.planeBorder?1:0),this.material.updatePDSFXUniform("planeFalloff",this.planeFalloff),this.material.updatePDSFXUniform("gridFalloff",this.gridFalloff),this.material.updatePDSFXUniform("gridUnit",this.gridUnit),this.material.updatePDSFXUniform("gridOffset",this.gridOffset),this.material.updatePDSFXUniform("gridCoeff",this.gridCoeff);var m=new r.Color;m.copyToLinear(this.gridColor,o),this.material.updatePDSFXUniform("gridColor",m),this.material.updatePDSFXUniform("planeSize",e),this.material.updatePDSFXUniform("nbSteps",this.gridNbSteps),this.material.updatePDSFXUniform("onlyDiffuse",this._onlyDiffuse)},computeGridUnit:function(e,t){var i=1;e instanceof r.PerspectiveCamera?i=2*this.gridScreenSize*Math.tan(Math.PI*e.fov/360)*t/this.viewer._getDivClientHeight():e instanceof r.OrthographicCamera&&(i=this.gridScreenSize*(e.top-e.bottom)/this.viewer._getDivClientHeight());for(var n=1/(this.gridNbSteps*this.gridNbSteps);n<i;)1===this.gridNbSteps?n++:n*=this.gridNbSteps;this.gridUnit=n,1===this.gridNbSteps?this.gridCoeff=i-n-1:this.gridCoeff=(i-n/this.gridNbSteps)/(n-n/this.gridNbSteps)},updateLabels:function(e){if(this.displayLabels&&(this.cleanLabels(),this.computeLabelPositions(e.camera),this.displayLabelsFunc(),this.gridLabels)){var t=this.gridLabels.textMaterial;t.updatePDSFXUniform("invSize",new r.Vector2(1/this.viewer.renderer.deviceWidth,1/this.viewer.renderer.deviceHeight)),t.updatePDSFXUniform("screenRatio",this.viewer.renderer.deviceWidth/this.viewer.renderer.deviceHeight)}},addLabel:function(e,t,i,n,s,a,o){var m="x"===a?l:"y"===a?h:c,v={string:e,anchor:t,color:this.labelColor,size:20*r.getDevicePixelRatio(),lineLength:500,up:this.worldOrientation.upVector,right:m,isRight:!1},_=this.gridLabels.getTextExtent(v),y=Math.abs(_.max.x-_.min.x),S=Math.abs(_.max.y-_.min.y);_.min.x=-S,_.min.y=-S,_.max.x=S,_.max.y=S,_.translate(i),f.addVectors(t,m);var b=this.viewer.currentViewpoint.project(f,o);g.set(b.x-i.x,b.y-i.y),g.normalize(),g.x<0&&(v.right="x"===a?d:"y"===a?u:p);var x=!1;if(s?(x=!0,g.x>0&&g.negate()):((g.x<0&&g.y<0||g.x>0&&g.y>0)&&(x=!0),g.x>0&&g.y>0&&g.negate()),x&&(g.multiplyScalar(y),i.x+=g.x,i.y+=g.y),v.anchor=this.viewer.currentViewpoint.unProject(i,o),v.right=(new r.Vector3).addVectors(v.anchor,v.right),v.anchor.applyProjection(this.viewProjMatrix),v.right.applyProjection(this.viewProjMatrix),g.set(v.right.x-v.anchor.x,v.right.y-v.anchor.y),g.normalize(),v.right.copy(v.anchor),v.right.x+=g.x,v.right.y+=g.y,!this.displayLabelCB)for(var w=0;w<n.length;w++)if(_.isIntersectionBox(n[w]._text.labelExtent))return;var P={token:null,_text:v,isRight:s,display:!0};n.push(P),this.labels.all.push(P)},isBottomRightEdge:function(e){return!(e.x<2)&&!(e.y<2)},isRightEdgeFunc:function(e){return e.x>this.viewer.SCREEN_WIDTH-2},isInsideFrustum:function(e){return!(e.x<-1||e.x>this.viewer.SCREEN_WIDTH+1)&&(!(e.y<-1||e.y>this.viewer.SCREEN_HEIGHT+1)&&!(e.z<-1.001||e.z>1.001))},cleanLabels:function(){for(var e=0;e<this.labels.all.length;e++)null!==this.labels.all[e].token&&this.gridLabels.removeText(this.labels.all[e].token);this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]}},displayLabelsFunc:function(){this.displayLabelCB&&this.displayLabelCB(this.labels.all);for(var e=0;e<this.labels.all.length;e++){var t=this.labels.all[e];if(t.display){if(t.offset||t.offsetFromScreenEdge||t.offsetFromAxis){var i=t.offset?t.offset.x:0,n=t.offset?t.offset.y:0;g.set(.5*this.viewer.SCREEN_WIDTH*(t._text.right.x-t._text.anchor.x),.5*this.viewer.SCREEN_HEIGHT*(t._text.right.y-t._text.anchor.y)),g.normalize(),m.set(-g.y,g.x),(t.isRight||g.y<0)&&g.negate(),!t.isRight&&g.y<0&&m.negate(),m.multiplyScalar(t.offsetFromAxis||0),g.multiplyScalar(t.offsetFromScreenEdge||0),t._text.anchor.x+=2*(i+m.x+g.x)/this.viewer.SCREEN_WIDTH,t._text.anchor.y+=2*(n+m.y+g.y)/this.viewer.SCREEN_HEIGHT,t._text.right.x+=2*(i+m.x+g.x)/this.viewer.SCREEN_WIDTH,t._text.right.y+=2*(n+m.y+g.y)/this.viewer.SCREEN_HEIGHT}t.size&&(t._text.size=t.size*r.getDevicePixelRatio()),t.color&&(t._text.color=t.color);var s=this.gridLabels.addText(t._text);t.token=s}}},computeIntersectionsForLabels:function(e,t,i,r,n,s,a){var o="zup"===this.worldOrientation._woName,l=o?"y":"x",h=o?"z":"y",c=this.labels.rightWE,d=this.labels.bottomWE,u="E",p="W";o?"y"===e&&(l="x",u="N",p="S"):"x"===e&&(l="z",u="N",p="S");var f=Math.round((t.min[e]-this.position[e])/this.gridUnit),g=Math.round((t.max[e]-this.position[e])/this.gridUnit);i<0?g=Math.min(f+1e3,g):f=Math.max(g-1e3,f);for(var m=this.tmpLine,v=f;v<=g;v++){m.start[e]=v*this.gridUnit+this.position[e],m.start[l]=-.5*this.size+this.position[l],m.start[h]=this.position[h],m.end[e]=m.start[e],m.end[l]=.5*this.size+this.position[l],m.end[h]=this.position[h];var _=r.planes[n].intersectLine(m),y=_&&s.project(_,a),S=!!_&&this.isInsideFrustum(y)&&this.isBottomRightEdge(y),b=S&&this.isRightEdgeFunc(y);if(S){var x,w=v*this.gridUnit+this.position[e],P=Math.round10(w,-2),C=P>=0;x=this.labelCB?this.labelCB(w,C?u:p):Math.abs(P)+" "+(C?u:p),this.addLabel(x,_,y,b?c:d,b,l,a)}}},removeMesh:function(){this.mesh&&this.viewer.sceneBackground.remove(this.mesh)},updateVisibility:function(){this.material&&(this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow))},computeLabelPositions:function(){var e=this.viewer.currentViewpoint,t="zup"===this.worldOrientation._woName,i=this.viewer.cameraBackground;this.viewProjMatrix.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);var n=this.tmpFrustum;n.setFromCameraWithViewMatrix(i);var s=n.getCorners(),a=this.tmpPoly1;a.addPoints([(new r.Vector3).copy(s[0]),(new r.Vector3).copy(s[1]),(new r.Vector3).copy(s[5]),(new r.Vector3).copy(s[4])]);var o=this.tmpPoly2;o.addPoints([(new r.Vector3).copy(s[1]),(new r.Vector3).copy(s[2]),(new r.Vector3).copy(s[6]),(new r.Vector3).copy(s[5])]);var l=new r.Plane,h=(new r.Vector3).copy(this.worldOrientation.upVector);h.multiplyScalar(-1),l.setFromNormalAndCoplanarPoint(h,this.position);var c,d,u,p,f=a.clipByPlane(l,new r.CGPolygon),g=o.clipByPlane(l,new r.CGPolygon),m=new r.Vector3,v=new r.Vector3,_=null,y=null;2===f.corner.length&&(m.subVectors(f.corner[1],f.corner[0]),m.normalize(),c=m.dot(this.worldOrientation.frontVector),d=m.dot(this.worldOrientation.rightVector),_=(new r.Box3).setFromPoints([f.corner[0],f.corner[1]])),2===g.corner.length&&(v.subVectors(g.corner[1],g.corner[0]),v.normalize(),u=v.dot(this.worldOrientation.frontVector),p=v.dot(this.worldOrientation.rightVector),y=(new r.Box3).setFromPoints([g.corner[0],g.corner[1]])),Math.abs(c)>.707?(_&&this.computeIntersectionsForLabels(t?"x":"z",_,c,n,2,e,i),y&&this.computeIntersectionsForLabels(t?"y":"x",y,p,n,0,e,i)):(_&&this.computeIntersectionsForLabels(t?"y":"x",_,d,n,2,e,i),y&&this.computeIntersectionsForLabels(t?"x":"z",y,u,n,0,e,i)),this.gridLabels.setFrustumCulled(!1)}})})),window.disposedViewers=[],define("DS/Visualization/WebGLViewer",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/Viewpoint","DS/Visualization/InternalSceneGraph","DS/Mesh/MeshUtils","DS/Animation/AnimationEngine","DS/Visualization/WebGLV6Renderer","DS/Visualization/OccurrencePath","UWA/Controls/Abstract","DS/Magnifier/Magnifier","DS/Magnifier/FrustumClipper","DS/Visualization/MaterialManager","DS/Selection/HSOManager","DS/VisuEvents/EventsManager","DS/Manipulators/ManipulatorManager","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/ModelEvents","DS/Plugins/UserPassManager","DS/Visualization/PlaneGrid","DS/Visualization/ClippingContext","DS/Visualization/GetSVGMode","DS/Visualization/RenderPriorityManager","DS/WebRecordEnabler/Adapter","DS/Visualization/Ambience","DS/Visualization/RenderStyle","DS/Visualization/BudgetedRenderManager","DS/Visualization/WorldOrientation","DS/EKEventsWeb/EKEvents","DS/VisuEvents/MouseEvent","DS/Visualization/DecalManager","DS/Visualization/WebGLViewerEffectSettings","DS/Visualization/ViewpointManager","DS/Visualization/PickingMode","DS/SceneGraphNodes/DirectionalLightNode","DS/VisuMePreferences/MePreferences","DS/QualityManager/QMScoreHandler","DS/Visualization/Mixins/ViewerEffectMixins","DS/Visualization/Mixins/ViewerRenderModeMixins","DS/Visualization/Mixins/ViewerSelectionAndPickingMixins","DS/Visualization/Mixins/ViewerLightsAndAmbiancesMixins","DS/Visualization/JSONSettings","DS/Visualization/TaskManager"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,b,x,w,P,C,M,E,T,A,D,I,R,O,L,B,F,V,G,N,U,k,z,H,W,j,X,q,Z,Y){"use strict";var K=t.NoOccurrences;const $="true"===localStorage.getItem("WebVisuForceHaloHL");var Q=0,J=!1,ee=1e-4;const te=j.NoShowData.noShowColor,ie=(j.NoShowData.noShowAlpha,j.NoShowData.noShowSaturationRatio),re=j.NoShowData.noShowBlendingRatio,ne=t._AmbianceGenerators,se=t._SSSGenerator;var ae=!1;try{OffscreenCanvas&&(ae=!0)}catch(e){ae=!1}var oe=u.extend({init:function(i){this.id=void 0!==i.id?"A2X_"+i.id:Q,Q++,window.debugWebGLV6Viewer||(window.debugWebGLV6Viewer=this),this.contextDocument=document;var r,n=this;i.uniqueName&&(this.uniqueName=i.uniqueName),i.pageObjectName&&(this.pageObjectName=i.pageObjectName),this._executionContext=i.executionContext?i.executionContext:null,this.clearThis=function(){n=null},this.version="9.0",this._familyName=i.familyName?i.familyName:"",this.debugWebgl2=!!i.debugWebgl2,this.debugWebgl2&&!i.multiViewer&&(t.WebGLVersion=2),this._parent(),this._worldOrientation=L.ZUpYRight,this.idPathMatcher=null,this._refPlaneCounter=0,this._refPlaneMap=new Map,this._manipulators={},this.trapSelectionManipulator=null,this.disposed=!1,this._fillXSOMode=!0,this.lastViewerWidth=0,this.lastViewerHeight=0,i=i||{},this._svgMode=!!i.svgMode,this._2DMode=!1,this.div=null,this.divCssElement=null,this.materialManager=null,this.context2D=null,this._nearFarBigScale=!!window.nearFarBigScale,this._sceneGraph=null,this._sceneGraphOverrideSetManager=null,this._sceneGraphStateVersion=null,this._oocManager=null,this._userPassManager=new C(this),this._renderPriorityManager=null,this._modelEvent=new P,this.trapSelection=null,this._renderStyle=null,this._pickingMode=new U,this._forceSceneMinValue=null,this._backgroundViewMode=t.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._sgOrder=i.sgOrder||!1,this._planeViewMode={mode:t.PlaneViewMode.NORMAL,plane:new t.Plane},i.capturer&&(this.capturer=i.capturer,this.capturer.setViewer(this),i.preserveDrawingBuffer=!0),void 0!==i.div&&(this.div=i.div),void 0!==i.divCssElement&&(this.divCssElement=i.divCssElement),this._useDefaultAmbiancesIBL=void 0===i.useDefaultAmbiancesIBL||i.useDefaultAmbiancesIBL,this.buildSkeleton(),this.buildSkeletonCss(),window.DSWebRecord&&(console.log("registering viewer#"+this.id),v._record_registerObject(this,"WebGLV6Viewer",[this.canvas,this.divTrap])),this.previousMaxSectionPolyLineSize=0,this.ODTMode=i.ODTMode||!1,this.disableAutoSMAA=i.disableAutoSMAA||!1,this.ODTMode&&(t._BinaryPrimitives=!t.IsIE11),this.fetchMePreferenceControls=void 0===i.fetchMePreferenceControls||i.fetchMePreferenceControls,this.fetchMePreferenceSettings=void 0!==i.fetchMePreferenceSettings&&i.fetchMePreferenceSettings,this._configAmbiences=Z.configAmbiences,this._compareSettings=Z.compareSettings,this.ODTMode&&i.ODTAmbiences&&(this._configAmbiences=JSON.parse(i.ODTAmbiences));navigator.userAgent.indexOf("Chrome");!1===i._useMaterialManager?this._use_webgpu=!!i.webgpu:(J=J||!!i.webgpu,this._use_webgpu=J),this._use_webgpu&&(t.WebGPU=!0),this._use_forwardpass_only=!!i.forwardPassOnly,this._enableTimestampQuery=i._enableTimestampQuery;var d=!1;this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.FallbackForApple&&(d=!!this._configAmbiences.effects.FallbackForApple);var u=t.isMobile();this.mobile=u||!!i.shouldBeMobile||!!i._isVR,void 0===i.mobile||d||(this.mobile=i.mobile,console.warn("Warning: Detected mobile mode override. DO NOT USE IN PRODUCTION.")),t.mobileVersion=this.mobile,t._mobileDevice=this.mobile||u,t._vrDevice=!!i._isVR,t._appleDevice=t.isAppleDevice(),t._isLinux=t.isLinuxOS(),t._visuFaceMaterialsAsPBR||(t._visuFaceMaterialsAsPBR=void 0!==i.visuFaceMaterialsAsPBR&&i.visuFaceMaterialsAsPBR,t._GASFaceMaterialsAsPBR=void 0!==i.GASFaceMaterialsAsPBR&&i.GASFaceMaterialsAsPBR),t._visuFaceMaterialsAsPBR&&(t._GASFaceMaterialsAsPBR=!0),t._GASFaceMaterialsAsPBR&&(t._visuFaceMaterialsAsPBR=!0),this.useHDR=!d&&(void 0===i.hdr||i.hdr),this.multiViewer=void 0!==i.multiViewer&&i.multiViewer,this.multiViewerFix=!0,this.offscreenAPI=void 0!==i.offscreenAPI&&(i.offscreenAPI&&ae),this.multiViewerAuto=!!i.multiViewerAuto||this.multiViewer&&localStorage.getItem("multiViewerAuto"),this.multiViewerAuto&&this.offscreenAPI&&(this.multiViewerAuto=!1,this.multiViewer=!0),this.defaultAnimationLoop=void 0===i.defaultAnimationLoop||i.defaultAnimationLoop,D.isReplaying()&&(this.defaultAnimationLoop=!1),this.autoUpdateFrustum=void 0===i.autoUpdateFrustum||i.autoUpdateFrustum,this.autoUpdateLights=!0,this.triLights=void 0!==i.triLights&&i.triLights,this.ambience=new I({viewer:this,v2:!0}),this.ambience.setBackgroundColor(void 0!==i.backgroundColor?i.backgroundColor:0),this.ambience.setBackgroundAlpha(void 0!==i.backgroundAlpha?i.backgroundAlpha:1),this.__tempBackgroundColorODT=void 0!==i.backgroundColor?i.backgroundColor:0,this.planeColor=new t.Color(15658734),this.gridColor=new t.Color(15658734),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.showBgColor=this.ambience.getBackgroundColor().getHex(),this.showPlaneColor=new t.Color(this.planeColor.getHex()),this.showGridColor=new t.Color(this.gridColor.getHex()),this.showGradientBackground=[],this.visibleSpace=void 0!==i.visibleSpace?i.visibleSpace:1,this._updateStaticOverrides=!1,this.visuShadingMode={preset:null,face:null,edge:null,point:null,before2DModeLinesFilter:null,before2DModePointsFilter:null,before2DModeVerticesFilter:null,outline:!1},this.axisFilterStatus=null,this.planesFilterStatus=null,this.pointsFilterStatus=null,this.linesFilterStatus=null,this.verticesFilterStatus=null,this.smallCurvatureEdgesFilterStatus=null,this.lockedRenderMode=new Map,this.sceneGraphState=null,this.cameraSystem=null,this.cameraSystemUpdated=!1,this.lastNbTexturesBeingLoaded=0,this._pageObjectData=null,this._immFrame=null,this.highlightColor=null,this.highlightSets=[],this.picking={activated:!0,trapSelection:!1,showDivTrap:!0,displayHL:!0,forceVisibility:!1,gpu:!0,trapGPU:!1,_trapPrimitiveUsed:!1,trapPrimitive:!1,computeNormalDepth:!0,primitive:!1,tolerance:2},Object.defineProperty(this.picking,"trapSelectionMesh",{set:function(e){console.warn("Invalid useage, please use setPicking API")},get:function(){return console.warn("DEPRECATED: please use .trapSelection and .trapPrimitive instead"),this.trapSelection&&!this.trapPrimitive}}),void 0!==i.highlight&&this.setPicking(i.highlight),this.pPicking={activated:!1,trapSelection:!1,displayHL:!0,forceVisibility:!1,gpu:!0,computeNormalDepth:!1,primitive:!1,disableWhileMoving:!0,preferenceHideHL:!1,tolerance:2},this._showHighlight=!0,void 0!==i.pHighlight&&this.setPrePicking(i.pHighlight),this.lastAddedToPSO=null,void 0===i.usePicking&&void 0===i.usePickingGPU||console.log("usePicking and usePickingGPU parameters are deprecated.\n Use highlight and pHighlight objects instead."),void 0!==i.usePicking&&(this.picking.activated=i.usePicking),void 0!==i.usePickingGPU&&(this.picking.gpu=i.usePickingGPU),void 0!==i.useTrapGPU&&(this.picking.trapGPU=i.useTrapGPU),this.infinitePlane=void 0===i.infinitePlane||i.infinitePlane,this._infinitePlane=this.infinitePlane,this.displayGrid=void 0!==i.displayGrid&&i.displayGrid,this._displayGrid=this.displayGrid,this.displayGridFromBelow=!1,this.autoUpdatePlane=void 0===i.autoUpdatePlane||i.autoUpdatePlane,this.useMirror=void 0!==i.mirror&&i.mirror,this.blurryMirror=!1,this.planeAttenuation=!1,this.useShadowPlane=this._infinitePlane,this.useDefaultLights=void 0===i.defaultLights||i.defaultLights,this.useGroundShadow=void 0!==i.useGroundShadow&&i.useGroundShadow,this.useShadowMap=void 0===i.useShadowMap||i.useShadowMap,this.shadowFilter="PCF",this.shadowQuality="Low",this.shadowMapWidth=void 0!==i.shadowMapWidth?i.shadowMapWidth:4096,this.shadowMapHeight=void 0!==i.shadowMapHeight?i.shadowMapHeight:4096,this.deferred=void 0!==i.deferred&&i.deferred,this.antiAliasing=void 0!==i.antiAliasing?i.antiAliasing:"NoAA",this._use_webgpu||(!0===this.antiAliasing?this.antiAliasing="SMAA":!1===this.antiAliasing&&(this.antiAliasing="NoAA"));var p=void 0!==i.useOIT&&i.useOIT;i.svgMode&&(p=!1),this.forceRender=!1,this._renderingToTarget=!1,this.visuEnv="None",void 0!==i.displayHighlight&&(this.displayHighlight=i.displayHighlight,this.setPicking({activated:this.displayHighlight,displayHL:this.displayHighlight})),this.useVignetting=void 0!==i.useVignetting&&i.useVignetting,this.useSSAO=void 0!==i.ssao&&i.ssao,this.useSSAOIterative=void 0!==i.ssaoIterative?i.ssaoIterative:!!i.useQualityManager,this.useSSLRDirect=!1,this.useSSLRefraction=!1,this.useBloom=void 0!==i.bloom&&i.bloom,this.useFlare=void 0!==i.flare&&i.flare,this.useDOF=void 0!==i.dof&&i.dof,this.pointCloudHQ=!1,this.useFakeOutlines=!1,d?this._viewerEffectSettings=new G.None(this,{enableOIT:p,useQM:!!i.useQualityManager}):t._vrDevice?this._viewerEffectSettings=new G.VR(this,{enableOIT:p,useQM:!!i.useQualityManager}):this.mobile?this._viewerEffectSettings=new G.Mobile(this,{enableOIT:p,useQM:!!i.useQualityManager}):this.useHDR?this._viewerEffectSettings=new G.Desktop(this,{enableOIT:p,useQM:!!i.useQualityManager}):this._viewerEffectSettings=new G.NoHDR(this,{enableOIT:p,useQM:!!i.useQualityManager}),this.ssaoParams={dynamicRadius:!0,adaptativeRadius:!0,radius:.04,radiusMin:.01,radiusMax:.12,minPixelRadius:14,attenuation:1,contrast:2,power:1,thresholdAngle:1.35},this.magnifier=null,this.frustumClipper=null,this.debugShadowLight=void 0!==i.debugShadowLight&&i.debugShadowLight,this.debugBSphere=void 0!==i.debugBSphere&&i.debugBSphere,this.debugPrimitiveBSphere=void 0!==i.debugPrimitiveBSphere&&i.debugPrimitiveBSphere,this.debugRepBBox=void 0!==i.debugRepBBox&&i.debugRepBBox,this.debugPicking=void 0!==i.debugPicking&&i.debugPicking,this.debugNormals=void 0!==i.debugNormals&&i.debugNormals,this.debugBackfaceCulling=void 0!==i.debugBackfaceCulling&&i.debugBackfaceCulling,this.debugPickHybrid=!1;if(this.debugPostProcessing=!1,this.debugShadowMaps=!1,this.debugEvents=0,this.debugFPS=!1,this.debugFPSInfos={fpsCounter:null,fpsArray:[],fpsIndex:0,fpsValue:30,fpsCumul:1200,fpsWindow:40,fpsLastTime:0},this._viewpointManager=new N(this),this.viewpoints=[],this.currentViewpoint=null,this._currentLOD=.5,this.trackingViewpoint=null,this.internalSceneGraph=null,this._safeInternalSceneGraph=null,this.manipulatorManager=null,this.temporaryEmptyScene=new t.Scene,this.centerMouseDownCB=null,this.mouseMoveCB=null,this.centerMouseUpCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=null,this.rightMouseUpCB=null,this._defaultPicking=null,this.setDefaultPicking(!0),this.pickingPriorityMapping=null,this.forceMultiSel=!1,this.sceneBackground=new t.Scene,this.sceneBackground.isBackground=!0,this.cameraBackgroundNear=1e-4,this.cameraBackgroundFar=1,this.cameraBackground=new t.PerspectiveCamera,this.cameraBackground.setWebGPU(this._use_webgpu),this.sceneBackground.add(this.cameraBackground),this.cameraReflected=new t.PerspectiveCamera,this.cameraReflected.setWebGPU(this._use_webgpu),this.planeGridOrientation=new t.Matrix4,this.infPlane=null,this.infPlaneSmall=null,this.planeSize=200,this.grid=null,this.bigGrid=null,this.gridSize=200,this.gridUnit=1,this.gridStep=.005,this.gridNbSteps=5,this.offsetPlaneSmall=new t.Vector3,this.offsetPlaneBackground=new t.Vector3,this.planeV2=void 0!==i.planeV2&&i.planeV2,this._planeV2Appli=this.planeV2,this._requestedPlaneV2=this.planeV2,this.planeGrid=this.planeV2?new M(this):null,this.ground=null,this.envMap=null,this.envMap2=null,this.envMapExposure=1,this.envMapOffset=0,this.envMapBlur=0,this.sphereEnv=null,this.isRenderIteration=!0,this._lockRenderIteration=!1,this.renderIteration=0,this.timeIter0=0,this.delayBeforeIteration=500,this.devicePixelRatio=t.getDevicePixelRatio()||1,this.SCREEN_WIDTH=800,this.SCREEN_HEIGHT=600,this.lazyResize=void 0!==i.lazyResize&&i.lazyResize,this.lazyResizeTime=300,this.oldCanvasSize={width:this.SCREEN_WIDTH,height:this.SCREEN_HEIGHT,dpr:this.devicePixelRatio,time:(new Date).getTime()},this.initMousePos=null,this.currMousePos=null,this.bSphere=null,this.bBox=null,this.primitiveBSphere=null,this.debugPickingNode=null,this.debugNormalNode=new t.Object3D,this.renderer=null,this._requestRender=!1,this._onlyPostProcess=!0,this._renderParams=[],this.renderFrameCB=null,this.beginRenderFrameCB=null,this.ambientLight=new t.AmbientLight(new t.Color(0)),this._directionalLight=null,this._directionalLight2=null,this._directionalLight3=null,this._dirLightGroundShadow=null,this.groundShadowLatitude=0,this.groundShadowLongitude=0,this.dirLightLatitude=.25,this.dirLightLongitude=0,this.dirLightVector=new t.Vector3(2,1.5,2.5),this.dirLight2Vector=new t.Vector3(0,0,1),this.dirLight3Vector=new t.Vector3(0,0,1),this.lights=[],this.clipPlanes=[],this.sectionCappingRequested=!1,this.sectionPlaneManipulated=!1,t.intensityCorrection=!0,this._preferenceBackgroundColor=null,this.fetchMePreferenceSettings){this._mePreferencesTokens=[];let e=this;if(!0===this.fetchMePreferenceSettings||!0===this.fetchMePreferenceSettings.PreSelection){let t=function(t){e.pPicking.preferenceHideHL=!t};this._mePreferencesTokens.push(z.subscribe(z.PREFERENCES.PRESELECTION,t))}if(!0===this.fetchMePreferenceSettings||!0===this.fetchMePreferenceSettings.Background){let i=function(i){e._preferenceBackgroundColor=new t.Color(i),"BasicOCA"===e.visuEnv&&e.setVisuEnvOCA("Basic")};this._mePreferencesTokens.push(z.subscribe(z.PREFERENCES.BACKGROUNDCOLOR,i))}}this.budgetedRenderManager=new O(this),this._budgetedRenderRequested=!1,r=new Date,this._oldTime=r.getTime(),this.overrideCursors=!0,this._changeCursorDelay=null,this._temporaryCursorData=null,this._forcePRZ=!1,this._viewer360Manager=null,this._360ModeRequest=null,this._navigationParams={clickToNavigateIn360:!0,reframe360CB:null},this.startPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startPan(e),this._forcePRZ=!0},this.startRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startRotate(e),this._forcePRZ=!0},this.startZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startZoom(e),this._forcePRZ=!0},this.endPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endPan(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endRotate(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endZoom(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this._getPaths=function(e,t,i,r){var n,s;if(t.count!=t.stop){t.count++,i.push(e);var a=e.children;for(s=a.length,n=0;n<s;n++)this._getPaths(a[n],t,i,r);i.pop(),t.count--}else r.push(i.slice(0))},this.addPathToHso=function(e){var t=[],i=m;this._getPaths(this.getRootNode().children[0],{count:0,stop:e},[],t);for(var r=0;r<t.length;r++)i.add({pathElement:new s(t[r])});return t},this.render=function(e){if(null!=n){if(void 0===e&&(e={}),e.budgeted)return n._budgetedRenderRequested=!0,void n.budgetedRenderManager._askForRender(e);void 0===e.budgeted&&n.budgetedRenderManager._resetShift(),n._budgetedRenderRequested=!1,n._renderParams.push(e),n._requestRender=!0,e&&e.onlyPostProcess||(n._onlyPostProcess=!1)}},this._QMTimer=null,this._dynamicMode=!1,this._forcedDynamicModeFromServer=!1,this._isDynamicMode=function(e,t,i){if(this._dynamicMode=!!this._QMTimer&&!i||this._forcedDynamicModeFromServer||e.isMoving()||e._isAnimated()||!!t,this._QMTimer&&!i&&clearTimeout(this._QMTimer),this._dynamicMode&&!this.sectionPlaneManipulated){var r=this;this._QMTimer=setTimeout((function(){clearTimeout(r._QMTimer),r._QMTimer=null,r.render()}),r.delayBeforeIteration||500)}return this._dynamicMode},this._viewpointState={set:!1,viewport:null,rendererViewportWidth:null,rendererViewportHeight:null,gammaOutput:null},this._setupViewpoint=function(e,t){if(e){this._viewpointState.set||(this._viewpointState.set=!0,this._viewpointState.viewport=this.renderer.renderer.getViewport(),this._viewpointState.rendererViewportWidth=this.renderer.viewportWidth,this._viewpointState.rendererViewportHeight=this.renderer.viewportHeight,this._viewpointState.gammaOutput=this.renderer.renderer.gammaOutput);let i=this._viewpointManager.getViewpointScenegraph(e)||this._safeInternalSceneGraph,r=this._viewpointManager.getViewpointRepresentation(e);i.selectSceneInstance(r),this.internalSceneGraph=i,t||(this.autoUpdateFrustum&&this._updateNearFar(e),e.camera.updateProjectionMatrix(),e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix)),e._isMain||(this.renderer.auxiliaryViewpointComposerContext||this.renderer.initComposer("auxiliaryViewpoint"),this.renderer.useAuxiliaryAsForward=!0,this.renderer.renderer.gammaOutput=!0,this.renderer.renderer._doBlendingOnCanvas=!0);let n=this._viewpointManager.getViewpointViewport(e);n&&(this.renderer.renderer.setViewport(n.x,n.y,n.width,n.height),this.renderer.renderer.setScissor(n.x,n.y,n.width,n.height),this.renderer.renderer.enableScissorTest(!0),this.renderer.renderer._enableClearScissor=!0,this.renderer.viewportWidth==n.width&&this.renderer.viewportHeight==n.height||(this.renderer.viewportWidth=n.width,this.renderer.viewportHeight=n.height,this.renderer.setScale(!1,"main"+this.renderer.resultIdChange)))}else this._viewpointState.set&&(this._viewpointState.set=!1,this.internalSceneGraph=this._safeInternalSceneGraph,this.internalSceneGraph.selectSceneInstance(0),this.renderer.renderer.gammaOutput=this._viewpointState.gammaOutput,this.renderer.useAuxiliaryAsForward=!1,this.renderer.renderer._doBlendingOnCanvas=!1,this.renderer.renderer.setViewport(this._viewpointState.viewport.x,this._viewpointState.viewport.y,this._viewpointState.viewport.width,this._viewpointState.viewport.height),this.renderer.renderer.enableScissorTest(!1),this.renderer.renderer._enableClearScissor=!1,this.renderer.viewportWidth==this._viewpointState.rendererViewportWidth&&this.renderer.viewportHeight==this._viewpointState.rendererViewportHeight||(this.renderer.viewportWidth=this._viewpointState.rendererViewportWidth,this.renderer.viewportHeight=this._viewpointState.rendererViewportHeight,this.renderer.setScale(!1,"main"+this.renderer.resultIdChange)))},this.glRenderMultiVP=function(e){this._shadowUpdated=!1,this.budgetedRenderManager._isActive&&this.budgetedRenderManager._setAsRenderFrame(),this.beginRenderFrameCB&&this.beginRenderFrameCB(),this.renderer.renderer._dBufferNextFrame&&(this.renderer.renderer.requestDBuffer=!0,this.renderer.renderer._dBufferNextFrame=!1),this.renderer.renderer._politeDBufferNextFrame&&(this.renderer.renderer._requestPoliteDepthBuffer=!0,this.renderer.renderer._politeDBufferNextFrame=!1);let i=!1;if(void 0!==e.viewpoint)i=this.glRender(e);else{let r=this._viewpointManager.getVpList(!0);this._viewpointManager.hasMultiView()&&(this.renderer.multiView=!0),r.length>1&&(this.renderer.multiViewpoint=!0);for(let n=0;n<r.length;n++){let s=this.renderer;0!=n||this._viewpointManager.hasMain()?s.auxiliaryViewpointComposerContext.setPassClear(s.initClearPass,!1):s.auxiliaryViewpointComposerContext.setPassClear(s.initClearPass,!0,new t.Color(s.bgColor).multiplyScalar(s.bgAlpha),s.bgAlpha),this.renderer.resultIdChange=0!==n&&r[n]._isMain?n:"",this._setupViewpoint(r[n]);let a=[...e,{addedParamsOnly:!0,viewpoint:r[n],skipRenderInfoReset:0!=n}];i=this.glRender(a)||i,this._setupViewpoint(null),this.renderer.resultIdChange=""}this.renderer.multiView=!1}return this.renderer.renderer.requestDBuffer=!1,this.renderer.renderer._requestPoliteDepthBuffer||(this.renderer.renderer.politeDepthBuffer=null),this.renderer.renderer._requestPoliteDepthBuffer=!1,this.renderer.renderer._politeBufferRequestsCBs=[],this.ODTMode&&t.ImageUtils.nbTexturesBeingLoaded>0?this.render():this.renderFrameCB&&this.renderFrameCB(),i},this.glRender=function(e){if(!this._initialized)return;var i,r,s,a,o,h,c,d,u,p,f,g,v;this.renderer.renderer.maxPolyLineSize!==this.previousMaxSectionPolyLineSize&&(this.previousMaxSectionPolyLineSize=this.renderer.renderer.maxPolyLineSize,this.renderer&&this.renderer.recompileAllShaders(null)),t.webGLStats&&t.webGLStats.reset();var _=!1,y=null,x=!1,w=!1,P=n.currentViewpoint,C=!0,M=!!e.length,E=!!e.length,T=!1,A=512,D=0,I=0,R=!1,O=!1,L=!1,F=!1,V=!1,G=!1;for(ie=0;ie<e.length;ie++)void 0!==e[ie].needReframe&&(_=e[ie].needReframe),void 0!==e[ie].reframeSpace&&(y=e[ie].reframeSpace),void 0!==e[ie].updateInfinitePlane&&(x=x||e[ie].updateInfinitePlane),void 0!==e[ie].updateInfinitePlaneFast&&(w=w||e[ie].updateInfinitePlaneFast),void 0!==e[ie].renderIteration&&(I=e[ie].renderIteration),void 0!==e[ie].isStillFrame&&(R=e[ie].isStillFrame),void 0!==e[ie].forceRender&&(O=e[ie].forceRender),void 0!==e[ie].viewpoint&&(P=e[ie].viewpoint),void 0!==e[ie].toScreen&&(C=e[ie].toScreen),void 0!==e[ie].cubemap&&(T=e[ie].cubemap),void 0!==e[ie].cubemapResolution&&(A=e[ie].cubemapResolution),void 0!==e[ie].cubeFace&&(D=e[ie].cubeFace),L||!0!==e[ie].ekTrace||(L=!0),!0===e[ie].forceStaticMode&&(forceStaticMode=!0),!0===e[ie].forceDynamicMode&&(V=!0),!0===e[ie].overrideEffects&&(F=!0),!0===e[ie].skipRenderInfoReset&&(G=!0),e[ie].addedParamsOnly||(e[ie].onlyPostProcess||(M=!1),e[ie].onlyForward||(E=!1));L&&(L=B.Trace.traceStart("techno_webvisu","webgl_frame_display"));let N=null!==P&&P.isMain();var U=F?"override":this._isDynamicMode(P,V,O)?"dynamic":"static",k=F?"override":0===I?"dynamic":"static";if(this._viewerEffectSettings.updateViewerSettings(U,k),n._modelEvent.publish({event:"PreRender",data:{viewer:n,viewpoint:P,trackingViewpoint:n.trackingViewpoint,onlyPostProcess:M,frameType:U}}),N&&this._updateStaticOverrides&&(this._updateStaticOverrides=!1,this.internalSceneGraph.updateStaticOverrides()),f=P.camera,u=null===n.internalSceneGraph?n.temporaryEmptyScene:n.internalSceneGraph.scene,(p=null===n.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):n.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace")).pixelRadius>0){var z=f.getWorldSizeFromPixelSize(1,p.center,this._getDivClientHeight(),2);p.radius+=z*p.pixelRadius}if(null!==P&&(f.updateMatrix(),f.matrixWorld.copy(f.matrix),f.matrixWorldInverse.getInverse(f.matrixWorld),this._viewerEffectSettings.updateAmbienceBackScale(U),this.blurShadowEffect&&this._dirLightGroundShadow&&this.ambience.getGround().needsUpdateShadowIntensity&&(this.ambience.getGround().needsUpdateShadowIntensity=!1,this.blurShadowEffect.setIntensity(this.ambience.getGround().getShadowIntensity()),this._dirLightGroundShadow.updateShadowMap()),this.sphereEnv&&this.ambience.updateCamera(P,this.renderer,f,C,this)),n._directionalLight&&n._directionalLight._setShadowCameraVisible(n.debugShadowLight),N){if(n.debugBSphere){if(n.bSphere)n.bSphere.visibilityFree=!0,n.bSphere.visible=!0,n.bSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(p.radius,p.radius,p.radius),i.setPosition(p.center),n.bSphere.setMatrix(i);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.2,transparent:!0,force:!0,forceSide:!0}),(q=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.bSphere=q._occurrences[0].renderable,n.bSphere.frustumCulled=!1,n.bSphere.noPickThrough=!1,u.add(n.bSphere)}}else n.bSphere&&(n.bSphere.visibilityFree=!0,n.bSphere.visible=!1);if(n.debugNodeBSphere){var H=null,W=null;if((J=m.get())[0])H=(Y=(Z=J[0].pathElement).getLastElement(!0)).getBoundingSphere(),W=Z.getWorldMatrix(this);if(H){if(n.nodeBSphere)n.nodeBSphere.visible=!0,n.nodeBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(H.radius,H.radius,H.radius),i.setPosition(H.center),W.multiplyMatrices(W,i),n.nodeBSphere.setMatrix(W);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(q=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.nodeBSphere=q._occurrences[0].renderable,n.nodeBSphere.frustumCulled=!1,u.add(n.nodeBSphere)}}else n.nodeBSphere&&(n.nodeBSphere.visible=!1)}if(n.debugPrimitiveBSphere){var j=null;W=null;if((J=m.get())[0])(Y=(Z=J[0].pathElement).getLastElement()).sgNode&&Y.sgNode.boundingSphere&&(j=Y.sgNode.boundingSphere,W=Z.getWorldMatrix(this));if(j){if(n.primitiveBSphere)n.primitiveBSphere.visible=!0,n.primitiveBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(j.radius,j.radius,j.radius),i.setPosition({x:j.center[0],y:j.center[1],z:j.center[2]}),W.multiplyMatrices(W,i),n.primitiveBSphere.setMatrix(W);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(q=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.primitiveBSphere=q._occurrences[0].renderable,n.primitiveBSphere.frustumCulled=!1,u.add(n.primitiveBSphere)}}else n.primitiveBSphere&&(n.primitiveBSphere.visible=!1)}if(n.debugRepBSphere){var X=null;W=null;if((J=m.get())[0])(Y=(Z=J[0].pathElement).getLastElement()).sgNode&&Y.sgNode.rep&&Y.sgNode.rep.boundingSphere&&(X=Y.sgNode.rep.boundingSphere,W=Z.getWorldMatrix(this));if(X){if(n.repBSphere)n.repBSphere.visible=!0,n.repBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(X.radius,X.radius,X.radius),i.setPosition({x:X.center[0],y:X.center[1],z:X.center[2]}),W.multiplyMatrices(W,i),n.repBSphere.setMatrix(W);else if(null!==u){var q;r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(q=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.repBSphere=q._occurrences[0].renderable,n.repBSphere.frustumCulled=!1,u.add(n.repBSphere)}}else n.repBSphere&&(n.repBSphere.visible=!1)}if(n.debugRepBBox){var Z,Y,K=null;W=null;if((J=m.get())[0])(Y=(Z=J[0].pathElement).getLastElement()).getBoundingBox()&&(K=Y.getBoundingBox(),W=Z.getWorldMatrix(this));else K=this.getSceneBoundingBox(),W=this.internalSceneGraph.root.getMatrix();if(K)if(n.bBox)n.bBox.visible=!0,n.bBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(K.max.x-K.min.x,K.max.y-K.min.y,K.max.z-K.min.z),i.setPosition({x:K.min.x+(K.max.x-K.min.x)/2,y:K.min.y+(K.max.y-K.min.y)/2,z:K.min.z+(K.max.z-K.min.z)/2}),W.multiplyMatrices(W,i),n.bBox.setMatrix(W);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0});var $=b.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r});n.bBox=$._occurrences[0].renderable,n.bBox.frustumCulled=!1,n.bBox.pickable=!1,u.add(n.bBox)}}else n.bBox&&(n.bBox.visible=!1);if(n.debugLocalBBox){var Q=(new t.Matrix4).identity();n.debugHandleMatrix&&Q.copy(P.camera.matrix);for(var J=m.get(),te=[],ie=0;ie<J.length;ie++)te.push(J[ie].pathElement);var re=S.getOrientedBoundingBoxFromPathElements(te,Q,n).localBBox;if(re){if(n.localBBox)n.localBBox.visible=!0,n.localBBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(re.max.x-re.min.x,re.max.y-re.min.y,re.max.z-re.min.z),i.setPosition({x:re.min.x+.5*(re.max.x-re.min.x),y:re.min.y+.5*(re.max.y-re.min.y),z:re.min.z+.5*(re.max.z-re.min.z)}),Q.multiplyMatrices(Q,i),n.localBBox.setMatrix(Q);else if(u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),($=b.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.localBBox=$._occurrences[0].renderable,n.localBBox.frustumCulled=!1,u.add(n.localBBox)}}else n.localBBox&&(n.localBBox.visible=!1)}if(n.debugBBox){Q=(new t.Matrix4).identity();n.debugHandleMatrix&&Q.copy(P.camera.matrix);var ne=this.computeSceneAccurateBoundingBox(n.visibleSpace?"visibleSpace":"invisibleSpace",n.debugHandleMatrix?Q:null);if(ne){if(n.BBox)n.BBox.visible=!0,n.BBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(ne.max.x-ne.min.x,ne.max.y-ne.min.y,ne.max.z-ne.min.z),i.setPosition({x:ne.min.x+.5*(ne.max.x-ne.min.x),y:ne.min.y+.5*(ne.max.y-ne.min.y),z:ne.min.z+.5*(ne.max.z-ne.min.z)}),Q.multiplyMatrices(Q,i),n.BBox.setMatrix(Q);else if(u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),($=b.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.BBox=$._occurrences[0].renderable,n.BBox.frustumCulled=!1,u.add(n.BBox)}}else n.BBox&&(n.BBox.visible=!1)}else n.BBox&&(n.BBox.visible=!1);var se=this.getRootNode();se&&!n.debugPicking&&null!==n.debugPickingNode&&(n.debugPickingNode.removeChildren(),se.removeChild(n.debugPickingNode),n.debugPickingNode=null),n.debugNormals?(n.debugNormalNode.children.length||function(){if(null===n.internalSceneGraph)return;var e,i,r,s,a,o,h,c,d,u,p,f,g,m,v,_,y,S,x=n.internalSceneGraph.scene,w=x.getMeshInstances();for(_=0;_<w.length;_++){for(i=.05*(e=w[_]).boundingSphere.radius,r=null,s=0,e.geometry.length>=0?(r=e.geometry[0],s=e.geometry.length):2===e.geometry._type&&(r=e.geometry,s=1),a=[],S=0;S<s;S++){if(o=r.vertexPositionArray,null!==(h=r.vertexNormalArray))for(y=0;y<o.length;y+=3)a.push({x:o[y],y:o[y+1],z:o[y+2]}),a.push({x:o[y]+i*h[y],y:o[y+1]+i*h[y+1],z:o[y+2]+i*h[y+2]});r=e.geometry[S+1]}if(a.length){for((c=new l.PrimitiveGroup).fillAttr=new l.FillAttributes,c.lineAttr=new l.LineAttributes,c.pointAttr=new l.PointAttributes,(d=new l.Buffer).size=3*a.length,d.component=l.VertexComponentEnum.POSITION,d.format=l.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),c.addBuffer(0,d),v=d.data,S=0,y=0;y<a.length;y++)v[S++]=a[y].x,v[S++]=a[y].y,v[S++]=a[y].z;for(u=Math.ceil(a.length/65534),p=0,y=0;y<u;y++)(f=new l.Primitive).nbIndices=Math.min(a.length-p,65534),f.connectivity=l.ConnectivityTypeEnum.LINES,f.attr={fill:new l.FillAttributes,line:new l.LineAttributes(new l.Color(0,0,1,1)),point:new l.PointAttributes},(g=new l.VertexComponent).component=l.VertexComponentEnum.POSITION,g.nbVertices=3*Math.min(a.length-p,65534),g.nbValuesPerVertex=3,g.format=l.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=0,g.offset=p,g.indices=null,f.addVertexComponent(g),c.addPrimitive(f),p+=65534;(m=b.createMeshNode(c)).mesh3js.setMatrix((new t.Matrix4).copy(e.matrixWorld)),m.setPickable(!1),m.mesh3js.castShadow=!1,m.mesh3js.receiveShadow=!1,n.debugNormalNode.add(m.mesh3js)}}}(),u.add(n.debugNormalNode)):(u.remove(n.debugNormalNode),n.debugNormalNode.children=[])}if(N&&this.ambience&&this.ambience.updateLights(P,this.internalSceneGraph,p,n.useShadowMap),N&&n.useDefaultLights){if(ye=n._directionalLight,s=n._directionalLight2,a=n._directionalLight3,null!==p)if(n.triLights){var ae=P.getUpDirection(),oe=P.getSightDirection(),le=(new t.Vector3).crossVectors(oe,ae);n.autoUpdateLights&&(o=new t.Vector3(1,1,1).normalize(),ye.setDirection(o,n.renderer.renderer.baseLightDirection),h=(new t.Vector3).copy(ae).sub(oe).sub(le).normalize(),s.setDirection(h,n.renderer.renderer.baseLightDirection),c=(new t.Vector3).copy(le).sub(oe).normalize(),a.setDirection(c,n.renderer.renderer.baseLightDirection))}else if(n.autoUpdateLights){var he=2;le=1.5,ae=2.5;let e=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(he).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(le)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(ae));e.normalize(),ye.setDirection(e,n.renderer.renderer.baseLightDirection);he=-2,le=1.5,ae=2.5;(h=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(he).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(le)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(ae))).normalize(),s.setDirection(h,n.renderer.renderer.baseLightDirection)}n._directionalLight.castShadows(n.useShadowMap&&ye._intensity)}if(this._2DMode?(this.ground&&(this.ground.visible=!1),this.sphereEnv&&(this.sphereEnv.visible=!1)):this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()?(this.ground||this._setPhysicalGround(this.ambience.getGroundGeometry()),this.ambience.updateGround(this.ground)):this.ground&&(this.ground.visible=!1),!N||this.ambience.needUpdateIBL.has(this)||this.internalSceneGraph.scene.reflectionProbes)N&&this.renderer.multiView&&this.internalSceneGraph!=this._safeInternalSceneGraph&&(this.internalSceneGraph.scene.ambienceMatrix=this._safeInternalSceneGraph.scene.ambienceMatrix,this.internalSceneGraph.scene.envMipMap=this._safeInternalSceneGraph.scene.envMipMap);else{var ce=this.ambience.getIblMap(),de=this.ambience.getRoughnessMap();ce?(this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),n.internalSceneGraph.scene.envMipMap[0]=ce,n.internalSceneGraph.scene.envMipMap[1]=de,this.sceneBackground.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),this.sceneBackground.envMipMap[0]=ce,this.sceneBackground.envMipMap[1]=de):(n.internalSceneGraph.scene.envMipMap=[],this.sceneBackground.envMipMap=[]),n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),n.renderer&&n.renderer.recompileAllShaders(null),this.ambience.needUpdateIBL.add(this)}if(!n._displayGrid&&(null!==n.grid&&n.grid.visible||null!==n.bigGrid&&n.bigGrid.visible)&&n._removeGrid(),!n._displayGrid&&n.planeGrid&&n.planeGrid.updateVisibility(),g=100,N&&null!==p&&(n._displayGrid||n._infinitePlane||n.useShadowPlane||n.ambience.getGround().isActivated()||n.ambience.isFiniteMode())){"yup"===this._worldOrientation._woName?(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.z=p.center.z):(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.y=p.center.y);var ue=2*p.radius;n._updateOffsetPlane(p,f,x,w);var pe=n._getPlaneSize(p,f,n.gridUnit,n.gridStep);pe!==n.planeSize&&(n.planeSize=pe,n.autoUpdateFrustum&&n._updateNearFar(P)),d=-f.getLookAt().dot(this._worldOrientation.upVector);var fe=f.position.dot(this._worldOrientation.upVector)-n.offsetPlaneBackground.dot(this._worldOrientation.upVector);if((g=f.isOrtho?d:fe)>0&&n.useShadowPlane&&!n._2DMode){var ge=(new t.Vector3).copy(n.offsetPlaneSmall);ge.x-=.001*g*this._worldOrientation.upVector.x,ge.y-=.001*g*this._worldOrientation.upVector.y,ge.z-=.001*g*this._worldOrientation.upVector.z;var me=Math.PI*Math.max(.1,.5-n.dirLightLatitude);ue*=Math.sin(me)+(Math.cos(me)+1)/Math.tan(me),n.createInfinitePlane(n.infPlaneSmall,0,ue,ge)}else n._removeInfinitePlane(n.infPlaneSmall,!0);if(n.planeV2&&n.planeGrid||n.ambience.usePlaneV2?(n._removeGrid(),n.planeGrid.createPlaneGrid(n.planeSize,n.offsetPlaneBackground,P,n.ambience.isAutoGroundOffset(),n.planeGridOrientation,n.renderer.renderer.simpleGamma)):(n._infinitePlane&&n.createInfinitePlane(n.infPlane,1,n.planeSize,n.offsetPlaneBackground),n._displayGrid&&(g>0||this.displayGridFromBelow?n.createGrid(n.planeSize,n.offsetPlaneBackground,Math.abs(fe),Math.abs(d),x):n._removeGrid()),(v=(new t.Vector3).copy(n.offsetPlaneBackground)).applyMatrix4(f.matrixWorldInverse),null!==this.grid&&(this.grid.material.updatePDSFXUniform("gridCenter",v.clone()),null!==this.bigGrid&&this.bigGrid.material.updatePDSFXUniform("gridCenter",v.clone()))),n.useGroundShadow){var ve=n._dirLightGroundShadow,_e=(he=Math.sin(Math.PI*this.groundShadowLatitude)*Math.cos(2*Math.PI*this.groundShadowLongitude),le=Math.sin(Math.PI*this.groundShadowLatitude)*Math.sin(2*Math.PI*this.groundShadowLongitude),ae=Math.cos(Math.PI*this.groundShadowLatitude),(new t.Vector3).copy(this._worldOrientation.frontVector).multiplyScalar(he).add((new t.Vector3).copy(this._worldOrientation.rightVector).multiplyScalar(le)).add((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(ae)));ve.setDirection(_e,this.renderer.renderer.baseLightDirection),ve._castGroundShadows(!0);let e=new t.Matrix4;n.infPlaneSmall&&e.copy(n.infPlaneSmall.matrix),ve.light3js._matrixWorldReceiver=e;for(let t=0;t<ve._occurrences.length;t++)ve._occurrences[t].renderable._matrixWorldReceiver=e}else n._dirLightGroundShadow._castGroundShadows(!1)}for(ie=0;ie<u.__lights.length;ie++){var ye=u.__lights[ie];u.children.includes(ye)&&ye.updateMatrix();var Se=!1;ye._occurrence&&(Se=ye._occurrence.node._attachedToVpt),Se&&(ye._vptUp=P.getUpDirection(),ye._vptSight=P.getSightDirection(),ye._vptPosition=P.getEyePosition()),ye._sceneShadow&&ye.updateShadowParameters(p,n.renderer.renderer.baseLightDirection)}if(N&&n.updateBackgroundLights(),!this._2DMode)if(this.ambience.getBackground().isActivated()){var be=this.trackingViewpoint?this.trackingViewpoint:P,xe=(new t.Vector3).copy(be.camera.position);this.sphereEnv&&(this.sphereEnv.visible=!0),this.sphereEnv||this._setSphereEnv(this.ambience.getSphere()),this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0);var we=.1*this.cameraBackgroundFar;if(f.isOrtho){var Pe=1;if(f.fullWidth){var Ce=f.height/f.fullHeight;Ce>1&&(Pe*=Ce),(Ce=f.width/f.fullWidth)>1&&(Pe*=Ce)}var Me=Math.sqrt(Math.pow(f.right,2)+Math.pow(f.top,2));Me*=Pe,this.ambience.getBackground().setRatio(Pe),(we=Math.max(we,Me))+this.cameraBackgroundNear>this.cameraBackgroundFar&&(this.cameraBackgroundFar=we+this.cameraBackgroundNear);var Ee=P.getSightDirection().normalize();xe.addVectors(xe,Ee.multiplyScalar(this.cameraBackgroundNear))}this.ambience.updateSphere(we,xe,this.sphereEnv)}else this.removeEnvMap();if(n.useGroundShadow&&n.useShadowPlane&&!n._2DMode&&n._setGroundShadow(),this.cameraSystem){this.renderer.renderer._VRFrameBuffer=this.cameraSystem._extFrameBuffer;var Te,Ae,De=this.trackingViewpoint||P;if(2===(Te=this.cameraSystem.computeCameraArray(P,De.camera.near,De.camera.far)).length&&(Te[0]._setStereoLeftRenderingRoleFromPrincipal(f),Te[1]._setStereoRightRenderingRoleFromPrincipal(f)),this.cameraSystem.useExternalProjectionMatrix){var Ie=ee*this.cameraBackgroundFar;this._nearFarBigScale&&(Ie=Math.min(.001,Ie)),Ae=this.cameraSystem.computeCameraArray(P,Ie,this.cameraBackgroundFar)}var Re=[],Oe=this.renderer.renderer.getViewportSize();for(ie=0;ie<Te.length;ie++){if(this.renderer.renderer.cameraSystem_cameraIndex=ie,Re.push("cameraSystem"+ie),this.mobile||!this.useHDR?this.renderer.renderer.setSplitScreenMode(ie*Oe.width,0):this.renderer.renderer.removeSplitScreenMode(),this.sphereEnv&&this.sphereEnv.material){var Le=Te[ie],Be=this.sphereEnv.material;Le.fullWidth?(Be.invScreenSize&&(Be.invScreenSize.x=1/Le.width,Be.invScreenSize.y=1/Le.height),Be.startOffset&&(Be.startOffset.x=Le.x/Le.fullWidth,Be.startOffset.y=1-(Le.y+Le.height)/Le.fullHeight),Be.endOffset&&(Be.endOffset.y=1-Le.y/Le.fullHeight,Be.endOffset.x=(Le.x+Le.width)/Le.fullWidth)):(Be.invScreenSize&&(Be.invScreenSize.x=1/Oe.width,Be.invScreenSize.y=1/Oe.height),Be.startOffset&&(Be.startOffset.x=0,Be.startOffset.y=0),Be.endOffset&&(Be.endOffset.x=1,Be.endOffset.y=1))}this.renderCamera(Te[ie],Ae&&Ae[ie],!1,M,E,T,A,D,I,R,Re[ie],g,G)}!this.mobile&&this.useHDR?this.renderer.combineResults(Re,C,this.cameraSystem)||this.render():this.renderer.renderer.enableScissorTest(!1)}else this.renderer.renderer._VRFrameBuffer=null,this.renderCamera(f,null,C,M,E,T,A,D,I,R,"main"+this.renderer.resultIdChange,g,G);return null!==P&&_&&null!==p&&(P.resetCameraOrientation(),P.reframe(void 0,void 0,void 0,y)),t.webGLStats&&t.webGLStats.dump(),L&&L.End(),n._viewerEffectSettings.updateViewerSettingsPostRender(U,k),!M},this._requestShadowMapUpdate=e.subscribe({event:"/VISU/requestShadowMapUpdate"},(function(e){n._updateShadowMaps()})),this._requestVisuUpdate=e.subscribe({event:"/VISU/requestVisuUpdate"},(function(e){n.render()})),this._updateBackgroundColor=this.onColorMapUpdated((function(){const e=n;if(e&&e.renderer&&e.renderer.renderer&&e.renderer.renderer.__A2XMode){const i=e.getColorFromColorMap(t.COLORMAP_INDEX.BACKGROUND);"BasicOCA"===e.visuEnv&&e.setBackgroundColor(i.getHex(),e.ambience.getBackgroundAlpha())}})),this.renderCamera=function(e,i,r,n,s,a,o,l,h,c,d,u,p){var f=this.cameraSystem?this.currentViewpoint:e._viewpoint||this.currentViewpoint;if(f._renderedCamera=e,this.internalSceneGraph&&f&&(this.internalSceneGraph.selectionHL.updateHighlight(f),this.internalSceneGraph.selectionPreHL.updateHighlight(f),this.renderer.updateEffects(this.internalSceneGraph,f,h,n)),i)this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=i,this.sceneBackground.add(this.cameraBackground);else{!this.cameraBackground.isOrtho&&!e.isOrtho||this.cameraBackground.isOrtho&&e.isOrtho?e.clone(this.cameraBackground):(this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=e.clone(),this.sceneBackground.add(this.cameraBackground));var g=ee*this.cameraBackgroundFar;this._nearFarBigScale&&(g=Math.min(.001,g)),this.cameraBackground.near=g,this.cameraBackground.far=this.cameraBackgroundFar,this.cameraBackground.isOrtho&&(this.cameraBackground.near=this.cameraBackgroundNear),this.cameraBackground.updateProjectionMatrix(),this.cameraBackground.projectionMatrixInverse.getInverse(this.cameraBackground.projectionMatrix)}this.cameraBackground._setBackgroundRenderingRoleFromPrincipal(e),!this.cameraReflected.isOrtho&&!e.isOrtho||this.cameraReflected.isOrtho&&e.isOrtho?e.clone(this.cameraReflected):this.cameraReflected=e.clone(),this.cameraReflected.matrixAutoUpdate=!1;var m="zup"===this._worldOrientation._woName,v=new t.Matrix4(1,0,0,0,0,m?1:-1,0,0,0,0,m?-1:1,0,0,0,0,1),_=2*this._worldOrientation.upVector.dot(this.offsetPlaneBackground);v.setPosition((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(_));var y=(new t.Matrix4).copy(e.matrixWorld);if(v.multiply(y),this.cameraReflected.setMatrix(v),this.cameraReflected._setReflectedRenderingRoleFromPrincipal(e),this.infPlaneSmall&&this.infPlaneSmall.visible){var S=!this.planeV2&&this.infPlane&&this.infPlane.visible||this.planeV2&&!this._requestedPlaneV2&&this.planeGrid&&this.planeGrid.displayPlane?0:1;this.infPlaneSmall.material.updatePDSFXUniform("smallPlaneSSAO",S)}if(this.SCREEN_WIDTH&&this.SCREEN_HEIGHT){var b=u>0&&this.useMirror,x=this._infinitePlane||this._displayGrid||this.ambience.getBackground().isActivated()||b,w=this.useShadowMap&&(this.useDefaultLights||this.isShadowMap());f._updateRobotCamera(this.internalSceneGraph),this.planeV2&&this.planeGrid&&this.planeGrid.updateLabels(f);var P={main:e,cameraBackground:this.cameraBackground,connectedRobotCamera:f.connectedRobotCamera,robotCameraOrtho:f.robotCameraOrtho,mirrorCamera:this.cameraReflected};if(this.renderer.render(x,b,w,this.sceneBackground,P,this.internalSceneGraph,this.infPlaneSmall,this.ambience.getGroundGlossiness(),r,n,this.hasSceneGraphOverrideSet(),s,a,o,l,h,c,d,!this._showHighlight,this.clipPlanes,p),window.__debugLoop__)for(var C=performance.now(),M=0;M<600;)M=performance.now()-C}},this.renderToTarget=function(e,i,r,s,a,o){if(i||r){this._viewerEffectSettings.copySettings("override","static"),this.renderer.recompileAllShaders([t.RendererMode.override]);var l=n.useSSAOIterative;s?(this._viewerEffectSettings._setFromJson("override",s),void 0!==s.IterativeSSAO&&n.setIterativeSSAO(!!s.IterativeSSAO)):(n.setIterativeSSAO(!1),"MSAA"===n._viewerEffectSettings.getSetting("AntiAliasing","override")&&n._viewerEffectSettings.setSetting("AntiAliasing","override","SMAA"));var h=n._viewerEffectSettings.getSSAO("override"),c="MSAA"===n._viewerEffectSettings.getAntiAliasing("override"),d="FSAA"===n._viewerEffectSettings.getAntiAliasing("override"),u=h&&n.useSSAOIterative||c,p=s&&s.NbIterations?Math.min(s.NbIterations,128):32,f=!1;if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){n._renderingToTarget=!0;var g=this.devicePixelRatio||1;d&&(g*=2);var m=Math.floor(g*n.SCREEN_WIDTH),v=Math.floor(g*n.SCREEN_HEIGHT);if(e||(e={data:null,width:m,height:v,bufferWidth:0,bufferHeight:0,x:0,y:0}),(e.width>m||e.height>v)&&(f=!0),null===e.data||e.bufferWidth<e.width||e.bufferHeight<e.height?d?(e.data=new Uint8Array(4*e.width*e.height*4),e.bufferWidth=2*e.width,e.bufferHeight=2*e.height):(e.data=new Uint8Array(4*e.width*e.height),e.bufferWidth=e.width,e.bufferHeight=e.height):(e.bufferWidth=e.width,e.bufferHeight=e.height),e.x||(e.x=0),e.y||(e.y=0),n.autoUpdateFrustum&&n._updateNearFar(),i){var _=i.camera;_.updateProjectionMatrix(),_.projectionMatrixInverse.getInverse(_.projectionMatrix)}n.getWebGLContext();var y=n.getRenderer();if(y.removeSplitScreenMode(),f){var S=0,b=-1;h&&(S=32,s&&s.MaxOverlap&&(S=s.MaxOverlap),n.renderer.SSAOEffect&&(b=n.renderer.SSAOEffect.maxPixelRadius,n.renderer.SSAOEffect.maxPixelRadius=S));var x=m-2*S,w=v-2*S,P=Math.ceil(e.width/x),C=Math.ceil(e.height/w),M=e.width,E=e.height,T=E-C*w,A=0,D=0,I=M,R=E,O=x,L=w,B=1,F=1;if(i.camera.fullWidth){var V={fullWidth:i.camera.fullWidth,fullHeight:i.camera.fullHeight,x:i.camera.x,y:i.camera.y,width:i.camera.width,height:i.camera.height};I=V.fullWidth,R=V.fullHeight,A=V.x,D=V.y,O*=B=V.width/M,L*=F=V.height/E}for(var G=i.camera,N=new Uint8Array(4*x*w),U=0;U<C;U++)for(var k=0;k<P;k++){var z=Math.min(x,e.width-k*x),H=Math.min(w,e.height-U*w),W=G.clone();if(W._renderingRole=G._renderingRole,W.setViewOffsetInternal(I,R,k*O+A-S*B,U*L+D-S*F,O+2*S*B,L+2*S*F),i.camera=W,u)for(var j=0;j<p;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);y.readPixelCustom(S,S,x,w,t.RGBAFormat,t.UnsignedByteType,N,this.renderer.mainComposer);var X=C-U-1,q=0;X>0&&(q=X*w+T);for(var Z=0;Z<H;Z++)for(var Y=0;Y<z;Y++){var K=M*(q+Z)+k*x+Y,$=(w-H+Z)*x+Y;e.data[4*K]=N[4*$],e.data[4*K+1]=N[4*$+1],e.data[4*K+2]=N[4*$+2],e.data[4*K+3]=N[4*$+3]}}i.camera=G,b>0&&(n.renderer.SSAOEffect.maxPixelRadius=b)}else if(r){var Q={xMin:Math.max(0,-e.x),xMax:Math.max(0,e.x+e.width-m),yMin:Math.max(0,-e.y),yMax:Math.max(0,e.y+e.height-v)},J=Q.xMin>0||Q.xMax>0||Q.yMin>0||Q.yMax>0,ee=e.x,te=e.y;if(J)(ie=(G=i.camera).clone())._renderingRole=G._renderingRole,ie.setViewOffsetInternal(m,v,Q.xMin>0?-Q.xMin:Q.xMax>0?Q.xMax:0,Q.yMin>0?Q.yMin:Q.yMax>0?-Q.yMax:0,m,v),i.camera=ie,ee=Q.xMin>0?0:Q.xMax>0?m-e.width:e.x,te=Q.yMin>0?0:Q.yMax>0?v-e.height:e.y;if(y.setScissor(ee,te,e.width,e.height),y.enableScissorTest(!0),u)for(j=0;j<p;j++)i?n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]):n.glRenderMultiVP([{toScreen:!1,overrideEffects:!0,renderIteration:j}]);else i?n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]):n.glRenderMultiVP([{toScreen:!1,overrideEffects:!0}]);y.enableScissorTest(!1),J&&(i.camera=G),y.readPixelCustom(ee,te,e.width,e.height,t.RGBAFormat,t.UnsignedByteType,e.data,this.renderer.mainComposer)}else{var ie;(ie=(G=i.camera).clone())._renderingRole=G._renderingRole;ee=.5*(m-e.bufferWidth),te=.5*(v-e.bufferHeight);if(G.fullWidth){ee=0,te=v-e.bufferHeight;var re=e.width/e.bufferHeight*G.height;ie.x-=.5*(re-ie.width),ie.width=re;var ne=m/e.bufferWidth,se=v/e.bufferHeight;ie.width*=ne,ie.height*=se,this.ambience.setRenderTargetSize(e.width,e.bufferHeight,ee,te)}else this.ambience.setRenderTargetSize(e.width,e.bufferHeight,ee,te),ie.setViewOffsetInternal(e.bufferWidth,e.bufferHeight,-.5*(m-e.bufferWidth),-.5*(v-e.bufferHeight),m,v);if(ie.updateProjectionMatrix(),ie.projectionMatrixInverse.getInverse(ie.projectionMatrix),i.camera=ie,y.setScissor(Math.max(0,ee-8),Math.max(0,te-8),Math.min(m,e.bufferWidth+16),Math.min(v,e.bufferHeight+16)),y.enableScissorTest(!0),this.ambience.updateParameters(this),u)for(j=0;j<p;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);this.ambience.setRenderTargetSize(0,0,0,0),this.ambience.updateParameters(this),this.ambience.setRenderTargetSize(0,0,0,0),y.enableScissorTest(!1),i.camera=G,y.readPixelCustom(ee,te,e.bufferWidth,e.bufferHeight,t.RGBAFormat,t.UnsignedByteType,e.data,this.renderer.mainComposer)}this.ambience.updateParameters(this),n.setIterativeSSAO(l),o&&o(),n.mobile?i?n.glRender([{viewpoint:i,onlyPostProcess:!1}]):n.glRenderMultiVP([{onlyPostProcess:!1}]):n.render({onlyPostProcess:!1}),n._renderingToTarget=!1}}else console.error("renderToTarget without specific viewpoint is only supported in subScreen mode")},this._renderToCanvas=function(e,t){var i,r;if(this.svgRootNode){var n;(n=this.svgRootNode.cloneNode(!0)).setAttributeNS(null,"width",this.canvas.width),n.setAttributeNS(null,"height",this.canvas.height),n.style.left=0,n.style.top=0,n.style.width=this.canvas.width+"px",n.style.height=this.canvas.height+"px";var s=n.outerHTML?n.outerHTML:(new XMLSerializer).serializeToString(n),a=new Blob([s],{type:"image/svg+xml;charset=utf-8"}),o=window.URL.createObjectURL(a),l=new Image,h=this;l.onload=function(){i=h.canvas.width,r=h.canvas.height,l.width=i,l.height=r;var t={width:i,height:r,data:null};h.renderToTarget(t,h.currentViewpoint);var n=document.createElement("canvas");n.width=i,n.height=r;for(var s=n.getContext("2d"),a=s.createImageData(i,r),c=a.data,d=0;d<a.height;d++)for(var u=0;u<a.width;u++){var p=u+d*i,f=u+(r-d-1)*i;c[4*p]=t.data[4*f],c[4*p+1]=t.data[4*f+1],c[4*p+2]=t.data[4*f+2],c[4*p+3]=t.data[4*f+3]}s.putImageData(a,0,0),setTimeout((function(){var t=document.createElement("canvas");t.width=i,t.height=r;var s=t.getContext("2d");s.drawImage(l,0,0),s.drawImage(n,0,0),window.URL.revokeObjectURL(o),e(t)}),100)},l.onerror=function(){window.URL.revokeObjectURL(o),t()},l.src=o}else{i=this.canvas.width,r=this.canvas.height;var c={width:i,height:r,data:null};this.renderToTarget(c,this.currentViewpoint);var d=document.createElement("canvas");d.width=i,d.height=r;for(var u=d.getContext("2d"),p=u.createImageData(i,r),f=p.data,g=0;g<p.height;g++)for(var m=0;m<p.width;m++){var v=m+g*i,_=m+(r-g-1)*i;f[4*v]=c.data[4*_],f[4*v+1]=c.data[4*_+1],f[4*v+2]=c.data[4*_+2],f[4*v+3]=c.data[4*_+3]}u.putImageData(p,0,0),e(d)}},this.renderCubemap=function(e,i,r,s,o){if(e){if(!s)s={radius:1e6*this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace").radius};if(s.radius){var l=s.radius;s={minAABB:(new t.Vector3).subVectors(e,new t.Vector3(1,1,1).multiplyScalar(l)),maxAABB:(new t.Vector3).addVectors(e,new t.Vector3(1,1,1).multiplyScalar(l))}}var h=new a(this,90,void 0,void 0,!1),c=h.camera;c.aspect=1,c.position=e,c.useQuaternion=!0;for(var d=new t.Vector3,u=0;u<6;u++){switch(u){case 0:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(1,0,0)));break;case 1:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(-1,0,0)));break;case 2:c.up.set(0,0,1),c.lookAt(d.addVectors(e,new t.Vector3(0,1,0)));break;case 3:c.up.set(0,0,-1),c.lookAt(d.addVectors(e,new t.Vector3(0,-1,0)));break;case 4:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(0,0,1)));break;case 5:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(0,0,-1)))}c.updateMatrix(),n.autoUpdateFrustum&&n._updateNearFar(),c.updateProjectionMatrix(),c.projectionMatrixInverse.getInverse(c.projectionMatrix),n.glRender([{viewpoint:h,toScreen:!1,onlyForward:!0,cubemap:!0,cubemapResolution:i,cubeFace:u}])}var p=this.renderer.compForwardComposerContext.renderResults.main;require(["DS/Effects/InvertCubeMapFaces","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/AmbianceGenerator"],(function(i,a,l){n._use_webgpu&&(n.renderer.compInvertCubeMapFaces||(n.renderer.compInvertCubeMapFaces=new i(n.renderer.renderer,n.renderer.renderTargetPool)),n.renderer.compInvertCubeMapFaces.execute(p)),n.renderer.compConvertCubeMapToLatLong||(n.renderer.compConvertCubeMapToLatLong=new a(n.renderer.renderer,n.renderer.renderTargetPool)),n.renderer.compConvertCubeMapToLatLong.setEnvMap(p),ne.manager||(ne.manager=new l(ne.cb));n.renderer.compConvertCubeMapToLatLong.composers[1];var h,c="shoot360",d=ne.manager._getGenerator(c,!1);d.setCallBack((function(){var i=d._getResult(),a={position:e,box:new t.Box3(s.minAABB,s.maxAABB)},l={hdr:h,mips:i};Object.assign(l,a),r&&(n.removeReflectionProbes(),n.internalSceneGraph.scene.reflectionProbes=a,n.internalSceneGraph.scene.envMipMap[0]=h,n.internalSceneGraph.scene.envMipMap[1]=i,ne._decreaseSceneUseCount(n.internalSceneGraph.scene)),o&&o(l)})),n.renderer.compConvertCubeMapToLatLong.execute(),h=n.renderer.compConvertCubeMapToLatLong.getResultRGBE(!0),d.setValues(h),d.execute(),ne.manager._disposeGenerator(c,!1)}))}else console.error("Missing mandatory paramenters")},this.grabDepthBuffer=function(e){if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){var i=this.devicePixelRatio||1,r=Math.floor(i*n.SCREEN_WIDTH),s=Math.floor(i*n.SCREEN_HEIGHT);e||(e={data:null,_dataUint8:null,width:r,height:s,bufferWidth:0,bufferHeight:0}),(e.width>r||e.height>s)&&(e.width=r,e.height=s),(!e._dataUint8||e.bufferWidth<e.width||e.bufferHeight<e.height)&&(e._dataUint8=new Uint8Array(4*e.width*e.height),e.data=null,e.bufferWidth=e.width,e.bufferHeight=e.height);n.getWebGLContext();return this.renderer.computeDepthBuffer(this.internalSceneGraph,this.currentViewpoint,!0),this.renderer.renderer.readPixelCustom(0,0,e.width,e.height,t.RGBAFormat,t.UnsignedByteType,e._dataUint8,this.renderer.mainComposer),e.data=new Float32Array(e._dataUint8.buffer),e}};var f=this._getForceRenderTargetSize();f?(this.SCREEN_WIDTH=f.width/this.devicePixelRatio,this.SCREEN_HEIGHT=f.height/this.devicePixelRatio):this.useOffscreenCanvas?(this.SCREEN_WIDTH=this.canvas.width,this.SCREEN_HEIGHT=this.canvas.height):(this.SCREEN_WIDTH=this.canvas.offsetWidth,this.SCREEN_HEIGHT=this.canvas.offsetHeight),this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer),this.initResources(!1===i._useMaterialManager),this._onWebVisuContextLost=function(e){console.log("GPU context Lost !"),e.preventDefault(),n.setQMGlobalProfile&&n.setQMGlobalProfile("Low"),H._contextLost(),n._modelEvent.publish({event:"WebVisuContextLost",data:{viewer:n}})},this._contextMenu=function(e){e.preventDefault()},this.canvas.addEventListener("WebVisu_contextlost",this._onWebVisuContextLost,!1),this.onWebGLContextRestore=function(){window.__debugLoop__=!1,n.setQMGlobalProfile&&n.setQMGlobalProfile("Low"),n.renderer.renderer.restoreGLContext(),n.render()},this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestore,!1);let g=!1;switch(g=this._use_webgpu?this.antiAliasing&&"NoAA"!==this.antiAliasing?this.antiAliasing:"NoAA":!(this.useHDR&&!this.mobile||!this.antiAliasing||"NoAA"===this.antiAliasing)||"NoAA",this.renderer=new c({canvas:this.canvas,context:this.materialManager?this.materialManager.getContext():null,gpuStates:this.materialManager?this.materialManager.getGPUStates():null,debugWebgl2:this.debugWebgl2,webgpu:this._use_webgpu,divCSS:this.divCss3DElement,useOffscreenCanvas:this.useOffscreenCanvas,deferred:this.deferred,useCompositing:!this.mobile&&this.useHDR,tonemapping:1,bgColor:this.ambience.getBackgroundColor().getHex(),bgAlpha:this.ambience.getBackgroundAlpha(),viewer:this,visibleSpace:this.visibleSpace,compareSettings:this._compareSettings,antiAliasing:g,forcePostProHighlight:!!i.forcePostProHighlight,preserveDrawingBuffer:i.preserveDrawingBuffer,debugContext:i.debugContext,timestampQuery:this._enableTimestampQuery}),this.renderer.renderer._viewer=this,this._initialized=!0,this.renderer.renderer.bufferGPUManager.__fake=!!i.noMeshInVRAM,this.renderer.renderer.__A2XMode=!!i.isA2X,this.renderer.renderer.forceCPUTBCompute=!!i.forceCPUTBCompute,this._viewerEffectSettings._checkCompatibility(),this.renderer.renderer.ssaoParams=this.ssaoParams,this.renderer.renderer.precomputedTexture=this.materialManager?this.materialManager.precomputedTexture:null,this.renderer.renderer.noiseTexture3D=this.materialManager?this.materialManager.noiseTexture3D:null,this.renderer.renderer.precomputedAreaTexture=this.materialManager?this.materialManager.precomputedAreaTexture:null,this.renderer.renderer.ambianceGenerators=ne,ne.addViewer(this),this.renderer.renderer.sssGenerator=se,se.addViewer(this),this.renderer.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.newMaterialInheritance=window.newMaterialInheritance,this.antiAliasing){case"NoAA":default:break;case"FXAA":this.renderer.setEffect("FXAA",!0);break;case"MLAA":this.renderer.setEffect("MLAA",!0);break;case"SMAA":this.renderer.setEffect("SMAA",!0);break;case"MSAA":this.renderer.setEffect("MSAA",!0);break;case"TAA":this.renderer.setEffect("TAA",!0);break;case"FSAA":case"SSAA":this.renderer.setEffect("FSAA",!0)}this.renderer.setEffect("Vignetting",this.useVignetting),this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative),this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative),this.renderer.setEffect("DOF",this.useDOF),this.renderer.setEffect("Bloom",this.useBloom),this.renderer.setEffect("Flare",this.useFlare),this.renderer.setEffect("OIT",p),this.renderer.setEffect("OITnoZ",p),this.setPicking({}),this.setPrePicking({}),this.useDefaultLights&&function(){n.setAmbientLight(2236962),n._directionalLight=new k({color:16777215,intensity:.81*Math.PI,sceneShadow:!0},"defaultLight1");let e=n.triLights?.3:.65;n._directionalLight.setShadowOptions({bias:-.001,darkness:e,mapWidth:n.shadowMapWidth,mapHeight:n.shadowMapHeight}),n._directionalLight.castShadows(n.useShadowMap),n._directionalLight.translate(40,new t.Vector3(1,1,1)),n._directionalLight.setDirection(new t.Vector3(2,1.5,2.5).normalize(),n.renderer.renderer.baseLightDirection),n.renderer.renderer.shadowMapAutoUpdate=!0,n.triLights?(n._directionalLight.setIntensity(.49*Math.PI),n._directionalLight2=new k({color:16777215,intensity:.49*Math.PI},"defaultLight2"),n._directionalLight3=new k({color:16777215,intensity:.49*Math.PI},"defaultLight3"),n._directionalLight3.translate(40,new t.Vector3(0,0,1)),n._directionalLight3.setDirection(new t.Vector3(0,0,1).normalize(),n.renderer.renderer.baseLightDirection),n._directionalLight2.setDirection(new t.Vector3(0,0,1).normalize(),n.renderer.renderer.baseLightDirection)):(n._directionalLight2=new k({color:3827071,intensity:1*Math.PI},"defaultLight2"),n._directionalLight2.setDirection(new t.Vector3(-2,1.5,2.5).normalize(),n.renderer.renderer.baseLightDirection));n._directionalLight2.translate(40,new t.Vector3(-1,1,1))}(),n._dirLightGroundShadow=new k({color:16777215,intensity:0,sceneShadow:!0},"groundShadow"),n._dirLightGroundShadow.setShadowOptions({bias:-.001,darkness:.65,mapWidth:n.shadowMapWidth,mapHeight:n.shadowMapHeight}),n._dirLightGroundShadow.translate(40,new t.Vector3(0,0,1)),n._dirLightGroundShadow.setDirection(new t.Vector3(0,0,1).normalize(),n.renderer.renderer.baseLightDirection),n._dirLightGroundShadow._castGroundShadows(n.useGroundShadow),function(e){this.div.appendChild(this.renderer.renderer.domElement),e||document.addEventListener("contextmenu",this._contextMenu,!0);void 0===v._isInit?v.init():v.addDocument(document);this.manipulatorManager=new _(this)}.apply(this,[i.enableDocumentContextMenu]),this.defaultAnimationLoop&&T(0,!1);let y=-1,E=0;function T(i,r){if(n){n.fpsCounter&&n.fpsCounter.onAnimate(),v.RecordEventsManager&&v.RecordEventsManager.pushRecordAnimateEvent(n),!r&&n.defaultAnimationLoop&&requestAnimationFrame(T),n.isRenderIteration||(n.renderIteration=0),n.capturer&&n.capturer.capture(n.canvas,n.renderIteration);var s,a,o,l,c,d,u,p,f=new h,g=new Date,m=g.getTime()-n._oldTime;n._oldTime=g.getTime(),f.step(m),l=!1,p=n.renderer.renderer._renderScale*(t.getDevicePixelRatio()||1);var _=n._getForceRenderTargetSize();_?(d=_.width,u=_.height,n.div.offsetWidth===n.lastViewerWidth&&n.div.offsetHeight===n.lastViewerHeight||(n.currentViewpoint.camera.aspect=n.SCREEN_WIDTH/n.SCREEN_HEIGHT,n.lastViewerWidth=n.div.offsetWidth,n.lastViewerHeight=n.div.offsetHeight,n.canvas.style.width=n.lastViewerWidth+"px",n.canvas.style.height=n.lastViewerHeight+"px")):n.useOffscreenCanvas?(d=n.canvas.width||1,u=n.canvas.height||1):(d=n.div.offsetWidth||1,u=n.div.offsetHeight||1);var S=!1;if(n.lazyResize?n.oldCanvasSize.width!==d||n.oldCanvasSize.height!==u||n.oldCanvasSize.dpr!==p?(n.oldCanvasSize.width=d,n.oldCanvasSize.height=u,n.oldCanvasSize.dpr=p,n.oldCanvasSize.time=(new Date).getTime(),l=!0):n.oldCanvasSize.time>=0&&(new Date).getTime()-n.oldCanvasSize.time>300&&(n.oldCanvasSize.time=-1,S=!0):n.SCREEN_WIDTH===d&&n.SCREEN_HEIGHT===u&&n.devicePixelRatio===p||(S=!0,l=!0),n.devicePixelRatio=p,l&&n.currentViewpoint&&(n.currentViewpoint.camera._hasChanged=!0),n.cameraSystemUpdated&&(n.cameraSystemUpdated=!1,S=2),S&&n.onResize(void 0,2===S),null===n.currentViewpoint){if(0==n._viewpointManager.getVpList(!0).length)return}else if(null!==(a=n.currentViewpoint.getControl())&&a.update(),s=n.currentViewpoint.camera){if(s.updateMatrix(),s.matrixWorld.copy(s.matrix),s.matrixWorldInverse.getInverse(s.matrixWorld),n.autoUpdateFrustum&&!n._budgetedRenderRequested)n._updateNearFar()&&(n.renderIteration=0);s.updateProjectionMatrix(),s.projectionMatrixInverse.getInverse(s.projectionMatrix),(o=s.getLookAt()).add(s.position),l&&e.publish({event:"/VISU/onWindowResized",data:{eventChannel:"/VISU/onWindowResized",eventType:"@onWindowResized",viewpoint:n.currentViewpoint,cameraEye:s.position,cameraTarget:o,cameraUp:s.up}})}l&&n._modelEvent.publish({event:"Resize",data:{width:d,height:u}});var b=!1;if(!n._initialized&&(b=!0,n.renderer._needPerformanceSuite()))if(H._locked()){var x=H._getGOFrame();x===y&&(E++,E>3&&(H._unlock(),y=-1,E=0)),y=x}else H._unlock();n._remoteRenderInfos.videoRender&&n.render(),t.ImageUtils.nbTexturesBeingLoaded<n.lastNbTexturesBeingLoaded&&n.render(),n.lastNbTexturesBeingLoaded=t.ImageUtils.nbTexturesBeingLoaded;var w=n._requestRender;w&&!n._onlyPostProcess&&(n.renderIteration=0),n._onlyPostProcess=!0;var P=!1;n._viewerEffectSettings._setAntiAliasing(n.renderIteration>0?"static":"dynamic"),n.renderIteration<n.renderer.getMaxIterationEffects()&&(P=!0),P=P&&!n.forceRender;var C=!n._dynamicMode,M=C&&1===n.renderIteration,A=C&&n.renderIteration>0;if(!b&&(w||A&&P||n.forceRender||M)){if(n._requestRender=!1,c=n._renderParams,n._renderParams=[],c.length?(c[0].renderIteration=n.renderIteration,c[0].isStillFrame=A,c[0].forceRender=n.forceRender,c[0].onlyPostProcess=c[0].onlyPostProcess&&!P):c.push({renderIteration:n.renderIteration,isStillFrame:A,forceRender:n.forceRender}),n.forceRender=!1,n.debugFPS){var D=performance.now()-n.debugFPSInfos.fpsLastTime;n.debugFPSInfos.fpsLastTime=performance.now();var I=1e3/Math.max(D,.1);n.debugFPSInfos.fpsCumul+=I,n.debugFPSInfos.fpsCumul-=n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex],n.debugFPSInfos.fpsValue=n.debugFPSInfos.fpsCumul/n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex]=I,n.debugFPSInfos.fpsIndex=(n.debugFPSInfos.fpsIndex+1)%n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsCounter.setHTML(Math.ceil(n.debugFPSInfos.fpsValue).toString())}n._modelEvent.publish({event:"PreRenderFrame",data:{viewer:n,viewpoint:n.currentViewpoint}});var R=n.glRenderMultiVP(c);if(!n)return;if(0===n.renderIteration&&(n.timeIter0=g.getTime()),R&&(P||n.renderIteration<2)&&n.renderIteration++,n.renderer.renderer._texturesToResize.size&&n.renderer.resizeNPOTTexture(),n.context2D&&n.materialManager){var O=n.materialManager.getCanvas();n.context2D.globalCompositeOperation="copy",n.context2D.drawImage(O,0,O.height-n.canvas.height,n.canvas.width,n.canvas.height,0,0,n.canvas.width,n.canvas.height)}H.useNonBlockingGO&&(n.renderer._activatedTexturePerformanceSuite()?n.renderer.TexturePerformanceEffect.addFrame(i):n.renderer._activatedPixelPerformanceSuite()&&n.renderer.PixelShaderPerformanceEffect.addFrame(i)),n._modelEvent.publish({event:"PostRender",data:{viewer:n,viewpoint:n.currentViewpoint}})}}}return this.animate=T,this.addEvent("onPostInject",(function(){T(0,!0)})),this.internalSceneGraph=new o(this,this.multiViewerFix,!i.showReferenceAxisSystem),this._safeInternalSceneGraph=this.internalSceneGraph,this.__selectionHL=new x(this),this.__selectionHL.highlightData.priority=0,this.__selectionPreHL=new w(this),this.__selectionPreHL.highlightData.priority=0,this.internalSceneGraph.selectionHL=this.__selectionHL,this.internalSceneGraph.selectionPreHL=this.__selectionPreHL,this._viewpointManager.setDefaultSceneGraph(this.internalSceneGraph),this.internalSceneGraph.scene.add(this.ambientLight),this.enableDefaultLights(!0),this.internalSceneGraph.addLightNode(this._dirLightGroundShadow),this._glCounters=null,this.fpsCounter=null,this.blurShadowEffect=null,this.displayHighlight=!1,this.name="",this.debugLocalBBox=!1,this.debugBBox=!1,this.debugHandleMatrix=!1,this.localBBox=null,this.BBox=null,$||this.ODTMode||this.setAdvancedPoliteHighlight(null,null),this._remoteRenderInfos={eventToken:null,div:null,cvs:null,img:null,tex:null,useDiv:!1,videoRender:!1,videoElements:null},this.renderer.scene=this.internalSceneGraph.scene,this},setExecutionContext(e){this._executionContext=e||null},setWorldOrientation:function(e){var t;for(this._worldOrientation=e,t=0;t<this.viewpoints.length;t++)this.viewpoints[t]._setWorldOrientation(e);this._setPlaneGridOrientation(),this.internalSceneGraph.setWorldOrientation(e),this.renderer.renderer._setWorldOrientation(e),this._updateDirectionalLightWorldOrientation(e),this.ambience.setWorldOrientation(e,this),this.render({updateInfinitePlane:!0})},getWorldOrientation:function(){return this._worldOrientation},createCanvas:function(){var e=UWA.createElement("canvas"),t={width:"100%",height:"100%"};return this._svgMode&&!T.getWebGLMode()&&(t.zIndex=10,t.position="absolute",t.left="0px"),e.setStyles(t),this.useOffscreenCanvas&&(e.width=this.div.width,e.height=this.div.height),e},attachCanvas:function(e){e.webGLViewer=this,D.isActive()&&(e.setAttribute("data-rec-id","FakeRecManager"),D.registerElement(e,"DS/WebVisuRecord/FakeRec",!0),e.isWebGLCanvas=function(){return!0}),this.canvas&&this.div.removeChild(this.canvas);var t=this.canvas;if(this.canvas=e,this.div.appendChild(e),this.renderer){this.renderer.canvas=e,this.renderer.renderer.canvas=e,this.renderer.renderer.domElement=e;let i=this._viewpointManager.getVpList(!0);for(let t=0;t<i.length;t++){let r=i[t].control;r&&r._switchCanvas&&r._switchCanvas(e)}v._switchViewAll(t,e),this.onResize(void 0,!0)}},buildSkeleton:function(){null===this.div?(this.elements.container=UWA.createElement("div"),this.div=this.elements.container,this.div.setStyles({width:"100%",height:"100%"})):this.elements.container=UWA.extendElement(this.div),this.div.style["-ms-touch-action"]="none";var e=this.createCanvas();if(this.attachCanvas(e),this._svgMode&&!T.getWebGLMode()){var t=document.createElementNS(this.getSvgNS(),"svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0px",t.style.left="0px",t.style.backgroundColor="white",t.style.zIndex=0,this.svgRootNode=t,this.svgRoot=document.createElementNS(this.getSvgNS(),"g"),this.svgRootNode.appendChild(this.svgRoot),this.div.appendChild(this.svgRootNode)}},getSvgNS:function(){return"http://www.w3.org/2000/svg"},addBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.addChild(e),this._updateSVGVisu())},removeBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.removeChild(e),this._updateSVGVisu())},getAllBackgroundSVGNodes:function(){return this.internalSceneGraph.svgRoot.children.concat([])},clearBackgroundSVGNodes:function(){this.renderer.resetGSSOCache();var e,t=this.getAllBackgroundSVGNodes();for(e=0;e<t.length;e++)this.removeBackgroundSVGNode(t[e])},buildSkeletonCss:function(){null===this.divCssElement?(this.divCssElement=UWA.createElement("div"),this.divCssElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.div.appendChild(this.divCssElement)):this.divCssElement=UWA.extendElement(this.divCssElement),this.divCssElement.style.WebkitTransformStyle="preserve-3d",this.divCssElement.style.MozTransformStyle="preserve-3d",this.divCssElement.style.oTransformStyle="preserve-3d",this.divCssElement.style.transformStyle="preserve-3d",this.divCssElement.id="divCssElement",this.divCss3DElement=UWA.createElement("div"),this.divCss3DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss3DElement.style.WebkitTransformStyle="preserve-3d",this.divCss3DElement.style.MozTransformStyle="preserve-3d",this.divCss3DElement.style.oTransformStyle="preserve-3d",this.divCss3DElement.style.transformStyle="preserve-3d",this.divCss3DElement.id="divCss3DElement",this.divCssElement.appendChild(this.divCss3DElement),this.divCss2DElement=UWA.createElement("div"),this.divCss2DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss2DElement.id="divCss2DElement",this.divCssElement.appendChild(this.divCss2DElement),this.divTrap=UWA.createElement("div",{id:"trapSelection"}),this.div.appendChild(this.divTrap)},create2DContext:function(){var e=Math.max(1,Math.floor(this.devicePixelRatio*this.SCREEN_WIDTH)),t=Math.max(1,Math.floor(this.devicePixelRatio*this.SCREEN_HEIGHT));this.materialManager&&this.materialManager.setCanvasSize(this,e,t),this.context2D=this.canvas.getContext("2d")},initResources:function(e){if(!e){var t=(!this.useHDR||this.mobile)&&this.antiAliasing&&"NoAA"!==this.antiAliasing;this.materialManager=new g(c.testMode.testMode,this.multiViewer,t,this,this.multiViewerAuto),this.multiViewer=this.materialManager.multiViewer,(this.multiViewer||this.multiViewerAuto&&this.materialManager.hasMultipleViewers())&&!this._use_webgpu&&this.create2DContext()}},onResize:function(e,t){var i,r;if((o=this._getForceRenderTargetSize())?(this.SCREEN_WIDTH=o.width/this.devicePixelRatio,this.SCREEN_HEIGHT=o.height/this.devicePixelRatio):this.useOffscreenCanvas?(this.SCREEN_WIDTH=this.canvas.width||1,this.SCREEN_HEIGHT=this.canvas.height||1):(this.SCREEN_WIDTH=this.div.offsetWidth||1,this.SCREEN_HEIGHT=this.div.offsetHeight||1),this.svgRoot&&this._updateSVGVisu(),this.context2D){var n=Math.max(1,Math.floor(this.devicePixelRatio*this.SCREEN_WIDTH)),s=Math.max(1,Math.floor(this.devicePixelRatio*this.SCREEN_HEIGHT));this.materialManager&&this.materialManager.setCanvasSize(this,n,s)}if(this.cameraSystem){var a=this.cameraSystem.getViewportSize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT);i=a.width,r=a.height}else i=this.SCREEN_WIDTH,r=this.SCREEN_HEIGHT;var o,l=void 0,h=void 0;(o=this._getForceRenderTargetSize())&&(l=this.div.offsetWidth,h=this.div.offsetHeight),this.renderer.setRendererSize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.useOffscreenCanvas||t,i,r,this.devicePixelRatio,l,h),this._viewpointManager.resize(i,r),this.ambience.resize(i,r,this.devicePixelRatio,this.renderer,this),this.renderIteration=0,this.render()},getCanvasSize:function(){return{width:Math.floor(this.devicePixelRatio*this.SCREEN_WIDTH),height:Math.floor(this.devicePixelRatio*this.SCREEN_HEIGHT)}},onContextLost:function(e){return this._modelEvent.subscribe({event:"WebVisuContextLost"},e)},onBackgroundModify:function(e){return this._modelEvent.subscribe({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()},e)},onViewerResize:function(e){return this._modelEvent.subscribe({event:"Resize"},e)},onPreRenderFrame:function(e){return this._modelEvent.subscribe({event:"PreRenderFrame"},e)},onPreRender:function(e){return this._modelEvent.subscribe({event:"PreRender"},e)},onPostRender:function(e){return this._modelEvent.subscribe({event:"PostRender"},e)},onPreAddRemoveXSO:function(e){return this._modelEvent.subscribe({event:"PreAddRemoveXSO"},e)},onActivate:function(e){return this._modelEvent.subscribe({event:"Activate"},e)},onPreactivate:function(e){return this._modelEvent.subscribe({event:"Preactivate"},e)},onContext:function(e){return this._modelEvent.subscribe({event:"Context"},e)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},unsubscribeFromArray:function(e){if(e&&e.length)for(var t=0;t<e.length;t++)this.unsubscribe(e[t])},forceCPUTBCompute:function(e){this.renderer.renderer.forceCPUTBCompute=e},getVersion:function(){return this.version},getWebGLContext:function(){return this.renderer.renderer.getContext()},getRenderer:function(){return this.renderer.renderer},getInfos:function(){return this.renderer.getInfos()},isManipulatedViewpointMoving:function(){return this._viewpointManager.hasMovingViewpoint()},addViewpoint:function(e,t){null!==e&&(e._setWorldOrientation(this._worldOrientation),e._setNode(this.internalSceneGraph.root),this._2DMode&&e._set2DMode(!0,t),this.viewpoints.push(e)),1===this.viewpoints.length&&this.selectViewpoint(0),this.internalSceneGraph.onAddViewpoint(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},addMultiViewpoint:function(e,t,i,r,n){e._setWorldOrientation(this._worldOrientation),this.fetchMePreferenceControls&&e._setApplicationDefaultController(),i&&e._setNode(this.internalSceneGraph.root),t?this._viewpointManager.addMainViewpoint(e,!!i,r,n):this._viewpointManager.addViewpoint(e,!!i,r,n)},removeMultiViewpoint:function(e){e!==this.currentViewpoint&&this._viewpointManager.removeViewpoint(e)},addNodeToViewpoint:function(e,t){this._viewpointManager.addNodeToViewpoint(e,t)},setViewpointOptions:function(e,t){if(void 0!==(t=t||{}).activated&&this._viewpointManager.setViewpointActivation(e,t.activated),t.viewport){let i=t.viewport;this._viewpointManager.setViewpointViewport(e,i.fixed,i.x,i.y,i.width,i.height)}void 0!==t.isMain&&this._viewpointManager.setMainStatus(e,isMain),this._viewpointManager.setCSIInfos(e,t)},setManipulatedViewpoint:function(e){this._viewpointManager.setManipulatedViewpoint(e)},removeViewpoint:function(e){e<0||e>=this.viewpoints.length||(this.viewpoints[e]==this.currentViewpoint&&(null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint=null),this.viewpoints.splice(e,1),this.viewpoints.length>0&&this.selectViewpoint(0))},selectViewpoint:function(e,t){!t&&(e<0||e>=this.viewpoints.length)||(null!==this.currentViewpoint&&null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint&&this._viewpointManager.removeViewpoint(this.currentViewpoint),this.currentViewpoint=t||this.viewpoints[e],this._viewpointManager.addMainViewpoint(this.currentViewpoint,!0),this.fetchMePreferenceControls&&this.currentViewpoint._setApplicationDefaultController(),this.internalSceneGraph.onSelectViewpoint(),this.render({updateInfinitePlane:!0}))},getViewpoints:function(){return this.viewpoints},setTrackingViewpoint:function(e){this.trackingViewpoint=e},getTrackingViewpoint:function(){return this.trackingViewpoint},updatePlatformPreferences:function(){this.fetchMePreferenceControls&&this._viewpointManager.updateApplicationController()},attachScene:function(e){if(null!==e){"I solemnly swear that I am up to no good."!==e.passcode&&r.DEPRECATED_SceneGraph(new Error),e.parentSceneGraph=this.internalSceneGraph;var t=this._sceneGraph;this._sceneGraph=null,t&&this.removeNode(t),this.addNode(e._private_root),this._sceneGraph=e}},addNode:function(e,t){if(e instanceof y)throw new Error("addNode with SceneGraph");this.internalSceneGraph&&this.internalSceneGraph.addUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t})},removeNode:function(e,t){this.internalSceneGraph&&(this.internalSceneGraph.removeUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t}))},getNodes:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserNodes(null!==this._sceneGraph):null},getRootNode:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserRoot(null!==this._sceneGraph):null},setClippingPlanes:function(e){this.renderer.resetGSSOCache();var t=this.getRenderer();if(null===t)return!1;if(e&&!this.clipPlanes.length)return!1;var i=t.clipPlanesEnabled;return t.clipPlanesEnabled=e,i!==e&&null!==this.internalSceneGraph&&this.render(),!0},getClippingPlanes:function(){var e=this.getRenderer();return null===e?null:e.clipPlanes},addClippingPlane:function(e,t){return this.renderer.resetGSSOCache(),this._requestClippingUpdate(),this.clipPlanes.indexOf(e)<0&&this.clipPlanes.push(e),this._addClippingPlane(e),this.setSectionCappingMaterial(e,t),!0},setSectionCappingMaterial:function(e,t){this._requestClippingUpdate(),this.renderer.setSectionCappingMaterial(e,t)},removeClippingPlane:function(e){this._requestClippingUpdate(),this.renderer.resetGSSOCache();var t=this.clipPlanes.indexOf(e);t>=0&&this.clipPlanes.splice(t,1),this._removeClippingPlane(e)},setClippingPlaneUpVector:function(e,t){this._requestClippingUpdate(),e.upVector=t.clone(),e.upVector.normalize()},setSectionCapping:function(e){return this._sectionCappingLock>=0?(this._sectionCappingLock=e?1:0,!1):"true"!==localStorage.getItem("OOCDisableCapping")&&(this._requestClippingUpdate(),this.renderer.resetGSSOCache(),e&&this.getRenderPriority()?(console.warn("Section capping is not compatible with render priority mode"),!1):(this.sectionCappingRequested=!!e,this.render(),!0))},getSectionCapping:function(){return this.sectionCappingRequested},getSectionCappingAutoMode:function(){let e=this._oocManager;return!e||!e.hasLargeAssemblyRoot()},getMousePosition:function(e){if(!(e instanceof t.Vector2)&&(console.error("DEPRECATED: WebGLViewer.getMousePosition() now only accepts THREEDS.Core.Vector2 2D position on the screen as argument."),e.changedTouches)){var i=e.changedTouches.length?e.changedTouches[0]:e,r=this.canvas.getBoundingClientRect(),n=i.pageX-r.left,s=i.pageY-r.top;e=new t.Vector2(n,s)}var a=this.devicePixelRatio;return{x:e.x/this.canvas.offsetWidth*2-1,y:-e.y/this.canvas.offsetHeight*2+1,xPix:e.x*a,yPix:e.y*a}},computeDistanceFromCamera:function(e){return this.renderer.computePositionGPU(this.internalSceneGraph,this.currentViewpoint,e).distanceTo(this.currentViewpoint.camera.position)},_updateSVGVisu:function(){if(this._svgMode&&this.svgRoot&&this._2DMode){var e=this.currentViewpoint.camera,t=this.SCREEN_HEIGHT/e.visualizedHeight,i="matrix("+t+" 0 0 "+t+" "+0*(1-t)+" "+0*(1-t)+") ",r="translate ("+(.5*this.SCREEN_WIDTH-e.position.x*t+0*t-0)+" "+(.5*this.SCREEN_HEIGHT+e.position.y*t-0*t-0)+") ";this.svgRoot.setAttribute("transform",r+i)}},_updateOffsetPlane:function(e,i,r,n){var s,a="zup"===this._worldOrientation._woName;if((this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()||this.ambience.isFiniteMode())&&this.ambience.getBackgroundGeometry().isAutoUpdateSize()&&this.ambience.getBackgroundGeometry().setSize(4*e.radius),this.ambience.isAutoGroundOffset()&&null!==(s=null!==this._forceSceneMinValue?this._forceSceneMinValue:r?null===this.internalSceneGraph?0:this.internalSceneGraph.getSceneMin(n,this._worldOrientation):null===this.internalSceneGraph?0:this.internalSceneGraph.getSavedSceneMin())&&this.ambience.updateScene(new t.Vector3(e.center.x,a?e.center.y:s,a?s:e.center.z)),this.offsetPlaneBackground.copy(this.ambience.getGroundPosition()),this.ambience.isAutoGroundOffset()&&!this.ambience.isFiniteMode()&&"physical"!=this.ambience.getGround().getType()){var o=i.getLookAt();if(this.planeV2)this.offsetPlaneBackground.x=e.center.x,a?this.offsetPlaneBackground.y=e.center.y:this.offsetPlaneBackground.z=e.center.z;else if(a){var l=Math.abs(o.z)>1e-4?1/o.z:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.z-this.offsetPlaneBackground.z)*o.x*l),this.offsetPlaneBackground.y=.5*(e.center.y+i.position.y-(i.position.z-this.offsetPlaneBackground.z)*o.y*l)}else{l=Math.abs(o.y)>1e-4?1/o.y:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.y-this.offsetPlaneBackground.y)*o.x*l),this.offsetPlaneBackground.z=.5*(e.center.z+i.position.z-(i.position.y-this.offsetPlaneBackground.y)*o.z*l)}}a?(this.offsetPlaneBackground.z+=this.ambience.getOffset(),this.offsetPlaneSmall.z=this.offsetPlaneBackground.z):(this.offsetPlaneBackground.y+=this.ambience.getOffset(),this.offsetPlaneSmall.y=this.offsetPlaneBackground.y)},_getPlaneSize:function(e,t,i,r){return this.ambience.isAutoGroundOffset()?this.planeV2?20*e.radius:Math.max(20*(this.offsetPlaneBackground.distanceTo(e.center)+e.radius),5*this.offsetPlaneBackground.distanceTo(t.position)):this.planeV2&&this.planeGrid?this.planeGrid.size:this.gridUnit/this.gridStep},displayBlankingPolygon:function(e){this.renderer.resetGSSOCache(),this.materialManager&&this.materialManager.displayBlankingPolygon(e,this)},requestViewPanelClose:function(){this._modelEvent.publish({event:"RequestViewPanelClose",data:{viewer:this}})},onRequestViewPanelClose:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelClose"},e)},_setGradientBackgroundShader:function(){var e;if(null!==this.sphereEnv){var i=this.ambience.getBackground().getColors();switch(i){case 2:e=t.GradientBackgroundMaterial2;break;case 3:e=t.GradientBackgroundMaterial3;break;case 4:e=t.GradientBackgroundMaterial4;break;default:return void this.removeEnvMap()}var r=new e({force:!0,side:t.DoubleSide,forceSide:!0,depthTest:!1});r.colors=[];for(var n=r.colors,s=0;s<i.length;s++){var a=i[s];n.push(a.r),n.push(a.g),n.push(a.b)}this.sphereEnv.material=r}},setGradientBackground:function(e){if(this.showGradientBackground=[],!e||e.length<2||e.length>4)this.removeEnvMap();else{for(var i=[],r=0;r<e.length;r++){var n=new t.Color(e[r]);this.visibleSpace||n.desaturate(ie).alphaBlend(te,re),this.showGradientBackground.push(new t.Color(e[r])),i.push(n)}this.ambience.getBackground().setColors(i)}},_setBackgroundColor:function(){this._svgMode&&this._2DMode&&!T.getWebGLMode()?this.renderer.setBackgroundColor(0,0):this.renderer.setBackgroundColor(this.ambience.getBackgroundColor().getHex(),this.ambience.getBackgroundAlpha()),this._modelEvent.publish({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()})},setBackgroundColor:function(e,i){if(this.__tempBackgroundColorODT=e,this.ambience.setBackgroundAlpha(void 0!==i?i:1),this.showBgColor=new t.Color(e).getHex(),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.visibleSpace)this.ambience.setBackgroundColor(e);else{var r=new t.Color(e);r.desaturate(ie).alphaBlend(te,re),this.ambience.setBackgroundColor(r.getHex())}this._setBackgroundColor(),this.render()},setPlaneColor:function(e){this.planeColor.set(e),this.showPlaneColor.set(e),this.visibleSpace||this.planeColor.desaturate(ie).alphaBlend(te,re),this.render()},setGridColor:function(e){this.gridColor.set(e),this.showGridColor.set(e),this.visibleSpace||this.gridColor.desaturate(ie).alphaBlend(te,re),this.render()},removePlaneV2:function(){this.ambience.usePlaneV2&&!this._planeV2Appli&&(this.setGroundOptions({displayPlane:!1,displayGrid:!1,planeFalloff:0}),this.planeGrid&&this.planeGrid.mesh&&(this.planeGrid.mesh.visible=!1),this.planeV2=!1),this._requestedPlaneV2=!1},setGrid:function(e,t){this.displayGrid!==e&&(this.displayGrid=e,this._modelEvent.publish({event:"DisplayGrid",data:{viewer:this,value:e}})),this._updateGridDisplay(),void 0!==t&&(this.displayGridFromBelow=t,this.planeV2&&(this.planeGrid.displayGridFromBelow=t?1:0)),this.render()},getGrid:function(){return this.displayGrid},onGridChange:function(e){return this._modelEvent.subscribe({event:"DisplayGrid"},e)},_updateGridDisplay:function(){var t=!this._2DMode&&this.displayGrid;this._displayGrid!==t&&(this._displayGrid=t,this.planeV2&&(this.planeGrid.displayGrid=t?1:0),e.publish({event:"/WUX/AFR/CMD/VisuGrid/"+(t?"BEGIN":"END")}))},getGridUnit:function(){return this.planeV2&&this.planeGrid?this.planeGrid.gridUnit:this.gridUnit},onProjectionTypeChange:function(e){var t=0,i=this;return this.onPreRender((function(){i.currentViewpoint&&i.currentViewpoint.getProjectionType()!==t&&(t=i.currentViewpoint.getProjectionType(),e({viewer:i,state:t}))}))},displayInfinitePlane:function(e,t){this.infinitePlane=e,this.planeAttenuation=void 0!==t&&t,this._updateInfinitePlaneDisplay()},_updateInfinitePlaneDisplay:function(){this._infinitePlane=!this._2DMode&&this.infinitePlane,this.planeV2&&(this.planeGrid.displayPlane=this._infinitePlane?1:0),this._infinitePlane?(this.render({updateInfinitePlane:!0}),this.useShadowPlane=!0):!this.planeV2&&this._removeInfinitePlane(this.infPlane)},setShadowPlane:function(e){this.useShadowPlane=e,this._updateShadowPlaneDisplay()},_updateShadowPlaneDisplay:function(e){!this._2DMode&&this.useShadowPlane?this.render({updateInfinitePlane:!0}):!this._infinitePlane&&this._removeInfinitePlane(this.infPlaneSmall)},setAutomaticPlaneUpdate:function(e){this.ambience.setAutoGroundOffset(e)},setPlanePositionAndScale:function(e,t){this.offsetPlaneBackground.copy(e),this.offsetPlaneSmall.z=e.z,this.ambience.updateScene(e),this.gridUnit=t},setGridNbSteps:function(e){if(this.gridNbSteps=Math.min(Math.max(e,1),10),this.planeV2)this.planeGrid.setGridNbSteps(this.gridNbSteps);else{if(!this.bigGrid)return;this._createBigGridGeometry()}},setGroundOptions:function(e){e&&(void 0!==e.groundCenter&&(this.offsetPlaneBackground.copy(e.groundCenter),this.offsetPlaneSmall.z=e.groundCenter.z,this.ambience.updateScene(e.groundCenter)),void 0!==e.groundSize&&this.planeV2&&(this.planeGrid.size=e.groundSize),void 0!==e.groundShadow&&this.setGroundShadow(!!e.groundShadow),void 0!==e.displayPlane&&this.displayInfinitePlane(!!e.displayPlane,e.planeAttenuation),void 0!==e.displayGrid?this.setGrid(!!e.displayGrid,e.displayGridFromBelow):void 0!==e.displayGridFromBelow&&this.setGrid(this.displayGrid,e.displayGridFromBelow),void 0!==e.gridNbSteps&&this.setGridNbSteps(e.gridNbSteps),void 0!==e.gridLabels&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabels(e.gridLabels),void 0!==e.gridLabelColor&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelColor(e.gridLabelColor),void 0!==e.gridLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelCallback(e.gridLabelCallback),void 0!==e.gridDisplayLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setDisplayLabelCallback(e.gridDisplayLabelCallback),void 0!==e._onlyDiffuse&&this.planeV2&&this.planeGrid&&(this.planeGrid._onlyDiffuse=e._onlyDiffuse),void 0!==e.planeMirror&&this.setMirror(!!e.planeMirror,e.blurryMirror),void 0!==e.planeColor&&this.setPlaneColor(e.planeColor),this.planeV2&&this.planeGrid&&(void 0!==e.planeOpacity&&(this.planeGrid.planeOpacity=e.planeOpacity),void 0!==e.planeTexture&&(this.planeGrid.planeTexture=e.planeTexture),void 0!==e.planeTextureScale&&(this.planeGrid.planeTextureScale=e.planeTextureScale),void 0!==e.planeFalloff&&(this.planeGrid.planeFalloff=e.planeFalloff),void 0!==e.gridFalloff&&(this.planeGrid.gridFalloff=e.gridFalloff),void 0!==e.planeBorder&&(this.planeGrid.planeBorder=e.planeBorder),void 0!==e.planeBorderColor&&this.planeGrid.edgeColor.set(e.planeBorderColor)),void 0!==e.gridColor&&this.setGridColor(e.gridColor))},getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:!!this.planeGrid&&this.planeGrid.displayLabels,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:this.planeColor.getHexString(),gridColor:this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?this.planeGrid.edgeColor.getHexString():void 0}},_getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,onlyDiffuse:this.planeGrid?this.planeGrid._onlyDiffuse:0,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:null,gridLabelCallback:this.planeGrid?this.planeGrid.labelCB:null,gridDisplayLabelCallback:this.planeGrid?this.planeGrid.displayLabelCB:null,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:"#"+this.planeColor.getHexString(),planeOpacity:this.planeGrid?this.planeGrid.planeOpacity:1,planeTexture:this.planeGrid?this.planeGrid.planeTexture:null,planeTextureScale:this.planeGrid?this.planeGrid.planeTextureScale:1,gridColor:"#"+this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?"#"+this.planeGrid.edgeColor.getHexString():void 0}},setRenderIteration:function(e){this.isRenderIteration=e},lockRenderIteration:function(){this._lockRenderIteration=!0},unlockRenderIteration:function(){this._lockRenderIteration=!1},setMagnifier:function(e){e.viewer||(e.viewer=this),null===this.magnifier?this.magnifier=new p(e):this.magnifier.setOption(e),this.pPicking.activated||this.setPrePicking({activated:!0,displayHL:!1,gpu:!1,computeNormalDepth:!0})},getMagnifier:function(){return this.magnifier},setDepthEffect:function(e){e&&void 0!==e.activated&&(!0===e.activated?null==this.frustumClipper?this.frustumClipper=new f(Object.assign(e,{viewpoint:this.currentViewpoint})):this.frustumClipper.setOptions(e):(this.frustumClipper&&this.frustumClipper.dispose(),this.frustumClipper=null))},getDepthEffect:function(){return this.frustumClipper},showTargetNode:function(e,i){let n=new r;if(e){if(this.currentViewpoint.getControl().getTarget3DNode())return;this.addNode(n);let e=b.createSphereNode({radius:i&&i.radius?i.radius:this.getSceneBoundingSphere().radius/100,material:t.MaterialUtils.createShinyFaceMaterial({color:"red",force:!0})}),s=new r;s.addChild(e),s.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,0,0))),n.addChild(s),n.setMatrix((new t.Matrix4).setPosition(this.currentViewpoint.getControl().target)),n.setPickable(2),this.currentViewpoint.getControl().setTarget3DNode(n),this.currentViewpoint.getControl().setDebugTarget(!0)}else this.currentViewpoint.getControl().getTarget3DNode()&&this.removeNode(this.currentViewpoint.getControl().getTarget3DNode()),this.currentViewpoint.getControl().setTarget3DNode(void 0),this.currentViewpoint.getControl().setDebugTarget(!1)},setIntensityCorrection:function(e){},activateNoMeshInRAM:function(e){console.warn("DEPRECATED: noMeshInRAM should be activated on the modelLoader")},setManipulators:function(e){if(!this.manipulatorManager)return!1;void 0!==e.activated&&this.manipulatorManager.setActivate(e.activated),void 0!==e.preActivate&&this.manipulatorManager.setPreActivate(e.preActivate)},getManipulators:function(){return!!this.manipulatorManager&&this.manipulatorManager.getActivate()},setOverrideCursors:function(e){this.overrideCursors=e},getCursor:function(){return this.canvas.style.cursor},setCursor:function(e,t,r){if(this.overrideCursors){var n=this,s="auto";if(-1!==["auto","-webkit-grabbing","pointer"].indexOf(e))s=e;else if("Auto"!==e)if(r)s=e;else{var a=i.getWebappsAssetUrl("Visualization","")+"icons/";s="url('"+a+"WebViewer"+e+".png'), url('"+a+"WebViewer"+e+".cur'), auto"}this._changeCursorDelay&&(clearTimeout(this._changeCursorDelay),this._changeCursorDelay=null);var o=function(e){n.canvas.style.cursor=e};t>0?this._changeCursorDelay=setTimeout((function(){o(s)}),t):o(s)}},setTemporaryCursor:function(e){var t=this._temporaryCursorData;t||(t={oldCursor:this.getCursor()||null},this._temporaryCursorData=t,this.setCursor(e))},unsetTemporaryCursor:function(){var e=this._temporaryCursorData;if(e){var t=e.oldCursor||"auto";this.setCursor(t,0,!0),this._temporaryCursorData=null}},setDebugPostProcessing:function(e){this.debugPostProcessing!==e&&(this.renderer.setEffect("DebugPass",e),this.debugPostProcessing=e,this.render())},_initGLCounters:function(){this._glCounters||(this._glCounters={_glFPSCounter:null,_glInfoCounter:null,_glNodeCounter:null,_glCustomCounter:null})},showPerfo:function(e,t,i,r,n,s,a){this._initGLCounters(),require(["DS/VisuTools/FPSCounter"],(o=>{void 0!==n&&o.setAutoRefresh(!n),void 0!==s&&o.setHideOOC(s),void 0!==a&&o.setSimpleOOC(a),e&&!this._glCounters._glFPSCounter?(this._glCounters._glFPSCounter=o,this._glCounters._glFPSCounter.setActivated(this,!0,i),window.webVisuPerfo.setEnabled(!!t),r&&r()):this._glCounters._glFPSCounter&&(this._glCounters._glFPSCounter.setActivated(this,e,i),window.webVisuPerfo.setEnabled(!!t)),this.render()}))},_enableInfos:function(e){this.renderer.renderer.generateInfos=e},showInfos:function(e,t){if(this._enableInfos(e),this._initGLCounters(),e&&!this._glCounters._glInfoCounter){var i=this;require(["DS/VisuTools/InfoCounter"],(function(e){i._glCounters._glInfoCounter=new e(i,t),i.render()}))}else this._glCounters._glInfoCounter&&(this._glCounters._glInfoCounter.activate(e),this.render())},showNodeCounter:function(e,t){if(this._initGLCounters(),e&&!this._glCounters._glNodeCounter){var i=this;require(["DS/VisuTools/NodeCounter"],(function(e){i._glCounters._glNodeCounter=new e(i,t),i.render()}))}else this._glCounters._glNodeCounter&&(this._glCounters._glNodeCounter.activate(e),this.render())},showCustomCounter:function(e,t){if(this._initGLCounters(),e&&!this._glCounters._glCustomCounter){var i=this;require(["DS/VisuTools/CustomCounter"],(function(e){i._glCounters._glCustomCounter=new e(i,t.color),i._glCounters._glCustomCounter.setParams(t),i.render()}))}else this._glCounters._glCustomCounter&&(this._glCounters._glCustomCounter.setParams(t),this._glCounters._glCustomCounter.activate(e),this.render())},setHUD:function({fps:e,ooc:t,nodeCounter:i,infos:r,color:n}){this.showPerfo(e||t,"full"===e&&!t,n,void 0,!e,!t,"simple"===t),this.showNodeCounter(i,n),this.showInfos(r,n)},setDebugFPS:function(e,t){this.debugFPS=e,this.debugFPSInfos.fpsLastTime=performance.now(),this.debugFPSInfos.fpsWindow=t||40,this.debugFPSInfos.fpsIndex=0,this.debugFPSInfos.fpsCumul=30*this.debugFPSInfos.fpsWindow,this.debugFPSInfos.fpsValue=30,this.debugFPSInfos.fpsArray=[];for(var i=0;i<this.debugFPSInfos.fpsWindow;i++)this.debugFPSInfos.fpsArray[i]=30;e?this.debugFPSInfos.fpsCounter?this.debugFPSInfos.fpsCounter.show():(this.debugFPSInfos.fpsCounter=new UWA.Element("div",{html:"FPS",styles:{fontFamily:"arial, sans-serif",fontSize:"20px",position:"absolute",top:"20px",right:"10px",textAlign:"left",verticalAlign:"middle",backgroundColor:"#333",color:"white"}}),this.div.appendChild(this.debugFPSInfos.fpsCounter)):this.debugFPSInfos.fpsCounter&&this.debugFPSInfos.fpsCounter.hide()},setDebugShadowMaps:function(e){this.debugShadowMaps!==e&&(this.renderer.setEffect("DebugShadowMaps",e),this.debugShadowMaps=e,this.render())},setDebugEvents:function(e){this.debugEvents=e,v.setDebugEvents(e)},setOcclusionCulling:function(e){return e&&!this._use_webgpu?(console.warn("Warning: occlusion culling is only supported by WebGPU"),!1):(this.renderer.renderer.occlusionCullingEnabled=e,!0)},setOcclusionDebug:function(e){return this._use_webgpu?(this.renderer.renderer.occlusionDebugEnabled=e,!0):(console.warn("Warning: occlusion culling is only supported by WebGPU"),!1)},getInfinitePlane:function(){return this.infinitePlane},getMirror:function(){return this.useMirror},_setPlaneGridOrientation:function(e){e?this.planeGridOrientation.copy(e):this.planeGridOrientation.makeBasis(this._worldOrientation.frontVector,this._worldOrientation.rightVector,this._worldOrientation.upVector)},createInfinitePlane:function(e,i,r,n){if(!K){var s,a=null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene,o=new t.Vector3,l=new t.Vector3,h=(new t.Matrix4).copy(this.planeGridOrientation);if(o.copy(this._worldOrientation.frontVector),o.multiplyScalar(n.dot(this._worldOrientation.frontVector)-.5*r),l.copy(this._worldOrientation.rightVector),l.multiplyScalar(n.dot(this._worldOrientation.rightVector)-.5*r),o.add(l),l.copy(this._worldOrientation.upVector),l.multiplyScalar(n.dot(this._worldOrientation.upVector)),o.add(l),h.setPosition(o),h.scale(new t.Vector3(r,r,r)),null===e){if(1===i)(s=new t.PlaneMaterial)._firstDirOnly=this.triLights,s.ambient.copy(new t.Color(328965)),s.color.copy(this.planeColor),(u=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),s.updatePDSFXUniform("border",u),s.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),s.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0),(d=b.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:s}))._setIsAlwaysInForeground(!0),this.infPlane=d._occurrences[0].renderable,(e=this.infPlane).receiveShadow=!1,e.renderDepth=1,this.sceneBackground.add(e);else if(0===i){s=new t.SmallPlaneMaterial(undefined),this._dirLightGroundShadow.light3js.groundMaterial=s;for(var c=0;c<this._dirLightGroundShadow._occurrences.length;c++)this._dirLightGroundShadow._occurrences[c].renderable.groundMaterial=s;var d;(d=b.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:s}))._setIsAlwaysInForeground(!0),this.infPlaneSmall=d._occurrences[0].renderable,(e=this.infPlaneSmall).receiveShadow=!0,e.castShadow=!1,e.renderDepth=-Number.MAX_VALUE,a.add(e)}e.pickable=!1,e.frustumCulled=!1,e.visibilityFree=!0,e.setMatrix(h)}else{var u;if(e.visible=!0,e.visibilityFree=!0,1===i&&e.material&&(e.material.color.copy(this.planeColor),(u=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),e.material.updatePDSFXUniform("border",u),e.material.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),e.material.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0)),e.setMatrix(h),0===i){-1==a.children.indexOf(e)&&a.add(e)}}}},_removeInfinitePlane:function(e,t){null!==e&&e.visible&&(e.visible=!1,!t&&this.render())},createGrid:function(e,r,n,s,a){if(!K){s=Math.pow(Math.max(0,s),.4);var o,h,c,d,u=this.mobile;o=function(t){var i=Math.tan(.125*Math.PI);return i*=t/e,Math.ceil(100*i)}(n),h=this.ambience.isAutoGroundOffset()?function(e){for(var t=.25*e,i=2e-4,r=0;i<t;){switch(r%3){case 0:case 2:i*=2;break;case 1:i*=2.5}r++}return i}(e*o):e,null!==this.grid&&(this.grid.visibilityFree=!0,this.grid.material.color=this.gridColor),null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.material.color=this.gridColor);var p=new t.Vector3,f=new t.Vector3,g=(new t.Matrix4).copy(this.planeGridOrientation);g.scale(new t.Vector3(h,h,h)),this.gridSize=h,this.gridUnit=h*this.gridStep;var m,v=new t.Vector3(0,0,r.dot(this._worldOrientation.upVector));if(v.x=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.frontVector)/(this.gridNbSteps*this.gridUnit)),v.y=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.rightVector)/(this.gridNbSteps*this.gridUnit)),u?(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x-.5*h),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y-.5*h),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)):(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)),g.setPosition(p),null!==this.grid)return this.grid.visibilityFree=!0,this.grid.setMatrix(g),this.grid.material.updatePDSFXUniform("gridSize",e),this.grid.material.updatePDSFXUniform("attenuation",this.grid.map?.9*s:.6*s),this.grid.visible=!0,null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.setMatrix(g),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",s),this.bigGrid.visible=!0),!0;if(c=new t.GridMaterial,u&&((m=new t.ImageUtils.loadTexture(i.getWebappsAssetUrl("Visualization","grid512.png"),void 0,null,null,t.ImageUtils.crossOriginPolicy)).wrapS=t.RepeatWrapping,m.wrapT=t.RepeatWrapping,m.anisotropy=8,m.repeat=new t.Vector2(.2/this.gridStep,.2/this.gridStep),c.setGridTexture(m)),c.updatePDSFXUniform("gridSize",e),c.updatePDSFXUniform("attenuation",u?.9*s:.6*s),u){var _=b.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:c});this.grid=_._occurrences[0].renderable,this.grid.frustumCulled=!1}else{var y=new l.PrimitiveGroup,S=2/this.gridStep,x=6*S,w=8*S,P=new l.Buffer({component:l.VertexComponentEnum.POSITION,data:new Float32Array(3*x)}),C=new Uint16Array(w),M=new l.Buffer({indexBuffer:!0,data:C});y.addBuffer(0,P),y.addBuffer(1,M);var E=0,T=0,A=P.data,D=M.data;for(d=0;d<S;d++)A[E++]=d*this.gridStep-1,A[E++]=-1,A[E++]=0,A[E++]=d*this.gridStep-1,A[E++]=0,A[E++]=0,A[E++]=d*this.gridStep-1,A[E++]=1,A[E++]=0,A[E++]=-1,A[E++]=d*this.gridStep-1,A[E++]=0,A[E++]=0,A[E++]=d*this.gridStep-1,A[E++]=0,A[E++]=1,A[E++]=d*this.gridStep-1,A[E++]=0;for(d=0;d<4*S;d++)D[T++]=3*d,D[T++]=3*d+1,D[T++]=3*d+1,D[T++]=3*d+2;var I=new l.Primitive({nbIndices:w,connectivity:l.ConnectivityTypeEnum.LINES,fillGAS:new l.FillAttributes(new l.Color(.2,.2,.2,1))}),R=new l.VertexComponent({nbVertices:x,bufferId:0,indices:new l.IndexArray({bufferId:1,offset:0})});I.addVertexComponent(R),y.addPrimitive(I);var O=b.createMeshNode(y,c);O._setIsAlwaysInForeground(!0),this.grid=O._occurrences[0].renderable,this.grid.frustumCulled=!1}return this.grid.pickable=!1,this.grid.receiveShadow=!0,this.grid.renderDepth=0,this.grid.visibilityFree=!0,this.sceneBackground.add(this.grid),u||(this._createBigGridGeometry(),this.bigGrid.setMatrix(g),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",s),this.bigGrid.material.color=this.gridColor),this.grid.setMatrix(g),this.grid.material.color=this.gridColor,!0}},_createBigGridGeometry:function(){this.bigGrid&&this.sceneBackground.remove(this.bigGrid);var e=new t.GridMaterial,i=this.gridNbSteps*this.gridStep,r=.02*this.gridStep,n=new l.PrimitiveGroup,s=2/this.gridStep,a=12*s,o=24*s,h=new l.Buffer({component:l.VertexComponentEnum.POSITION,data:new Float32Array(3*a)}),c=new l.Buffer({component:l.VertexComponentEnum.NORMAL,data:new Float32Array(3)}),d=new l.Buffer({indexBuffer:!0,data:new Uint16Array(o)}),u=new l.Buffer({indexBuffer:!0,data:new Uint16Array(o)});n.addBuffer(0,h),n.addBuffer(1,c),n.addBuffer(2,d),n.addBuffer(3,u);var p=0,f=0,g=0,m=h.data,v=d.data,_=c.data,y=u.data;_[0]=0,_[1]=0,_[2]=1;for(var S=0;S<s;S++)m[p++]=S*i-1-r,m[p++]=-1,m[p++]=0,m[p++]=S*i-1-r,m[p++]=0,m[p++]=0,m[p++]=S*i-1-r,m[p++]=1,m[p++]=0,m[p++]=S*i-1+r,m[p++]=1,m[p++]=0,m[p++]=S*i-1+r,m[p++]=0,m[p++]=0,m[p++]=S*i-1+r,m[p++]=-1,m[p++]=0,m[p++]=-1,m[p++]=S*i-1-r,m[p++]=0,m[p++]=0,m[p++]=S*i-1-r,m[p++]=0,m[p++]=1,m[p++]=S*i-1-r,m[p++]=0,m[p++]=1,m[p++]=S*i-1+r,m[p++]=0,m[p++]=0,m[p++]=S*i-1+r,m[p++]=0,m[p++]=-1,m[p++]=S*i-1+r,m[p++]=0;for(S=0;S<24*s;S++)y[g++]=0;var x=0;for(S=0;S<s;S++)v[f++]=x,v[f++]=x+4,v[f++]=x+1,v[f++]=x,v[f++]=x+5,v[f++]=x+4,v[f++]=x+1,v[f++]=x+3,v[f++]=x+2,v[f++]=x+1,v[f++]=x+4,v[f++]=x+3,x+=6,v[f++]=x,v[f++]=x+1,v[f++]=x+4,v[f++]=x,v[f++]=x+4,v[f++]=x+5,v[f++]=x+1,v[f++]=x+2,v[f++]=x+3,v[f++]=x+1,v[f++]=x+3,v[f++]=x+4,x+=6;var w=new l.Primitive({nbIndices:o,connectivity:l.ConnectivityTypeEnum.TRIANGLES,fillGAS:new l.FillAttributes(new l.Color(.2,.2,.2,1))}),P=new l.VertexComponent({nbVertices:a,bufferId:0,indices:new l.IndexArray({bufferId:2,offset:0})}),C=new l.VertexComponent({nbVertices:1,bufferId:1,indices:new l.IndexArray({bufferId:3,offset:0})});w.addVertexComponent(P),w.addVertexComponent(C),n.addPrimitive(w);var M=b.createMeshNode(n,e);M._setIsAlwaysInForeground(!0),this.bigGrid=M._occurrences[0].renderable,this.bigGrid.frustumCulled=!1,this.bigGrid.visibilityFree=!0,this.bigGrid.pickable=!1,this.bigGrid.receiveShadow=!0,this.bigGrid.renderDepth=0,this.sceneBackground.add(this.bigGrid)},_removeGrid:function(){var e=!1;return null!==this.grid&&(this.grid.visible=!1,e=!0),null!==this.bigGrid&&(this.bigGrid.visible=!1,e=!0),e},_updateDirectionalLightWorldOrientation:function(e){var i=this._directionalLight,r=(null===this.internalSceneGraph||this.internalSceneGraph.getBoundingSphere().radius,null===this.internalSceneGraph?new t.Vector3(0,0,0):this.internalSceneGraph.getBoundingSphere().center,Math.sin(Math.PI*this.dirLightLatitude)*Math.cos(2*Math.PI*this.dirLightLongitude)),n=Math.sin(Math.PI*this.dirLightLatitude)*Math.sin(2*Math.PI*this.dirLightLongitude),s=Math.cos(Math.PI*this.dirLightLatitude);if(this.useDefaultLights){let a=(new t.Vector3).copy(e.frontVector).multiplyScalar(r).add((new t.Vector3).copy(e.rightVector).multiplyScalar(n)).add((new t.Vector3).copy(e.upVector).multiplyScalar(s));a.normalize(),i.setDirection(a,this.renderer.renderer.baseLightDirection)}},setLightProbe:function(e){console.warn("Light probes are deprecated and won't work on PBR materials, please use an ambiance instead, phongs are deprecated"),console.warn("setLightProbe API disabled")},_setPhysicalGround:function(e){e&&(this.ground=e,this.sceneBackground.add(e))},getSceneBoundingSphere:function(e,i,r,n){"show"===e&&(console.error("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.error("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let s=r||this.internalSceneGraph;return s?(s.root._tryOverridesUpdate(this),s.getBoundingSphere(e,i,n)):i?null:new t.Sphere},getSceneBoundingBox:function(e,i){"show"===e&&(console.error("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.error("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let r=i||this.internalSceneGraph;if(!r)return new t.Box3;var n=r.root;return n._tryOverridesUpdate(this),n._occurrences[0].getBoundingBox(e)},computeSceneAccurateBoundingBox:function(e,i,r,n,s){let a=s||this.internalSceneGraph;if(!a)return new t.Box3;var o=a.root;o._tryOverridesUpdate(this),r=r||t.FixedSizeFiltering.Include,n=n||[];for(var l=0,h=0;h<n.length;h++){l|=n[h]}return o._occurrences[0].computeAccurateBoundingBox(e,i,r,l)},_updateNearFar:function(e){var i=this.trackingViewpoint?this.trackingViewpoint:e||this.currentViewpoint,r=i.camera;if(!r)return!1;var n=r.near,s=r.far;if(this.frustumClipper){let e=this.frustumClipper.getClippingFrustum(),t=n!==e.near||s!==e.far;return t&&(r.near=e.near,r.far=e.far,this.render()),t}var a=null===this.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace",null,null,!0);if(!a)return!1;var o=0;a.pixelRadius>0&&(o=r.getWorldSizeFromPixelSize(1,a.center,this._getDivClientHeight(),2)*a.pixelRadius);this._updateOffsetPlane(a,r,!1);var l=this._getPlaneSize(a,r,this.gridUnit,this.gridStep);l!==this.planeSize&&(this.planeSize=l);var h,c=(new t.Vector3).subVectors(a.center,r.position),d=(new t.Vector3).subVectors(this.offsetPlaneBackground,r.position),u=r.getLookAt(),p=c.dot(u),f=d.dot(u),g=p,m=Math.PI*Math.max(.1,.5-this.dirLightLatitude),v=Math.sin(m)+(Math.cos(m)+1)/Math.tan(m),_=this._infinitePlane||this._displayGrid;if(_)if(this.cameraBackgroundFar=Math.max(f+this.planeSize,p+a.radius),this._nearFarBigScale){var y=(new t.Sphere).copy(a);y.center.z-=a.radius;var S=new t.Sphere;a.mergeWithSphere(y,S),c.subVectors(S.center,r.position),g=c.dot(u)}else c.z-=a.radius,g=c.dot(u);if(this.cameraBackgroundNear=f-this.planeSize,this._nearFarBigScale&&(this.cameraBackgroundNear=Math.max(this.cameraBackgroundNear,.001)),this.ambience.getBackground().isActivated()&&!this._2DMode)if(this.ambience.isFiniteMode()){if(!r.isOrtho){var b=v*this.ambience.getRadiusEnvMap();this.cameraBackgroundFar=f+b;var x=Math.max(f-b,.001*this.cameraBackgroundFar);x>this.cameraBackgroundNear&&(this.cameraBackgroundNear=x)}0==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!0,this.renderer&&this.renderer.recompileAllShaders(null)),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereCenter=this.ambience.getCenter(),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereRadius=this.ambience.getRadius(),this.internalSceneGraph.scene.parallaxCorrectionParameters.projectionCenter=this.ambience.getProjectionCenter()}else 1==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!1,this.renderer&&this.renderer.recompileAllShaders(null)),this.cameraBackgroundFar=Math.max(f+this.planeSize,p+a.radius);if(h=this._nearFarBigScale?v*(_?S.radius+o:a.radius+o):v*(a.radius+o),r.far=g+h,r.near=Math.max(g-h,.001*r.far),this._nearFarBigScale){var w=i.control.distanceToTarget,P=Math.max(0,g-h);r.near=w>50?Math.min(Math.max(w/50,P),r.near):Math.min(Math.max(.1,P),r.near)}return r.isOrtho?r.near=g-h:r.far<0&&(r.near=5,r.far=50),n!==r.near||s!==r.far},dispose:function(){e.publish({event:"/VISU/VIEWER/VIEWER_DISPOSED",data:{eventChannel:"/VISU/VIEWER/VIEWER_DISPOSED",eventType:"@VIEWER_DISPOSED",parameters:{viewer:this}}}),disposedViewers.push(this.id),this.canvas.removeEventListener("WebVisu_contextlost",this._onWebVisuContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestore),this.canvas.webGLViewer=null;for(var i=0;i<this.highlightSets.length;i++)this.highlightSets[i]&&this.highlightSets[i]._detachEvents(!1,!1);this.highlightSets=[],this._oocManager&&this._oocManager._dispose(),this._oocManager=null,this._sceneGraphOverrideSetManager&&(this._sceneGraphOverrideSetManager.dispose(),this._sceneGraphOverrideSetManager=null),this.disposed=!0,this.setDefaultPicking(!1),this.leftMouseUpCB=null,this.infPlane&&this.infPlane.dispose(),this.infPlaneSmall&&this.infPlaneSmall.dispose(),this.grid&&this.grid.dispose(),this.ambience&&this.ambience.needUpdateIBL.delete(this),ne._decreaseSceneUseCount(this.internalSceneGraph.scene),this.bigGrid&&this.bigGrid.dispose(),this.internalSceneGraph&&(this.internalSceneGraph.dispose(),this.internalSceneGraph=null,this._safeInternalSceneGraph=null),this.__selectionHL._detachEvents(!1,!1),this.__selectionHL.clearAll(),this.__selectionPreHL._detachEvents(!1,!1),this.__selectionPreHL.clearAll(),e.unsubscribe(this._requestShadowMapUpdate),e.unsubscribe(this._requestVisuUpdate),e.unsubscribe(this._updateBackgroundColor),this.requestViewPanelClose(),t.cleanPredefinedMaterialCache(),t.cleanPredefinedMaterialTextureCache(),this.sceneBackground.dispose(),this.sceneBackground=null,this.manipulatorManager&&(this.manipulatorManager._detachEvents(),this.manipulatorManager=null),ne.dispose(this),se.dispose(this),this._viewpointManager.dispose(),this._viewpointManager=null;for(i=0;i<this.viewpoints.length;i++)this.viewpoints[i].setDefaultController(!1),this.viewpoints[i]._setNode(null);if(this._mePreferencesTokens)for(let e=0;e<this._mePreferencesTokens.length;e++)z.unsubscribe(this._mePreferencesTokens[e]);this.materialManager&&(this.materialManager.removeViewer(this),this.materialManager=null),this._userPassManager._dispose(),this.renderer&&this.renderer.dispose(),this.renderer=null,v.disconnectFrom(this.canvas),v._dispose(this.canvas),document.removeEventListener("contextmenu",this._contextMenu,!0),window.debugWebGLV6Viewer===this&&(window.debugWebGLV6Viewer=null),this.div&&(this.canvas&&this.div===this.canvas.parentNode&&this.div.removeChild(this.canvas),this.divCssElement&&this.div===this.divCssElement.parentNode&&this.div.removeChild(this.divCssElement),this.divTrap&&this.div===this.divTrap.parentNode&&this.div.removeChild(this.divTrap),this.svgRootNode&&this.div===this.svgRootNode.parentNode&&this.div.removeChild(this.svgRootNode)),this.canvas.webGLV6Viewer&&delete this.canvas.webGLV6Viewer,this.canvas=null,this.infPlane=null,this.infPlaneSmall=null,this.grid=null,this.bigGrid=null,this.sceneBackground=null,this.cameraBackground=null,this.ambientLight=null,this._directionalLight=null,this._directionalLight2=null,this._directionalLight3=null,this._dirLightGroundShadow=null,this.lights=[],this.currentViewpoint=null,this.viewpoints=[],this.trackingViewpoint=null,this.materialManager=null,this.cameraReflected=null,this.renderer=null,this.debugPickingNode=null,this.debugNormalNode=null,this.temporaryEmptyScene=null,this._modelEvent.destroy(),this.trapSelectionManipulator=null,V.detachViewer(this),this.clearThis(),this._refPlaneMap.clear(),this._refPlaneCounter=0},setRenderFrameCB:function(e,t){this.renderFrameCB=e,this.beginRenderFrameCB=t},getCurrentSceneGraphState:function(){return this.sceneGraphState},getSceneGraphOverrideSetManager:function(){return this._sceneGraphOverrideSetManager},hasSceneGraphOverrideSet:function(){return!!(this.sceneGraphState||this._sceneGraphOverrideSetManager&&this._sceneGraphOverrideSetManager.hasSceneGraphOverrideSet())},getUserPassManager:function(){return this._getUserPassManager()},clearScene:function(e,t){this.empty(e,t)},empty:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.clearScene(e,t,this._sceneGraph?"deprecated":void 0),e&&this.render({updateInfinitePlane:t,needReframe:t}),this.divCss2DElement.empty()},isEmpty:function(){return this._sceneGraph?0===this._sceneGraph._private_root.children.length:this.internalSceneGraph?0===this.internalSceneGraph.userRoot.children.length:void 0},setDisableBackFaceCulling:function(e){this.renderer.setDisableBackFaceCulling(e)},setCameraSystem:function(e){e!==this.cameraSystem&&(this.cameraSystem=e,this.renderer.clearCameraSystemData(),this.cameraSystemUpdated=!0,this.renderer.resetGSSOCache()),e||this.renderer.renderer.removeSplitScreenMode()},setXRRenderTarget:function(e){this.renderer.renderer._xrRenderTarget=e},set2DMode:function(e,t,i){this._2DMode=e,this._setBackgroundColor(),this._updateGridDisplay(),this._updateInfinitePlaneDisplay(),this._updateShadowPlaneDisplay(),this._viewpointManager._set2DMode(e,t),this._updateSVGVisu(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},get2DMode:function(){return this._2DMode},getCameraSystem:function(){return this.cameraSystem},request360Mode:function(e,t){this._init360ModeRequest(),this._360ModeRequest.enabled=e,this._360ModeRequest.params=t,this._viewer360Manager?(this._360ModeRequest.needInit=!1,this._viewer360Manager.request360Mode(e,t,this._360ModeRequest.tileSetAdded),this._360ModeRequest.tileSetAdded=!1,this._360ModeRequest.params=null):this._360ModeRequest.needInit&&(this._360ModeRequest.needInit=!1,require(["DS/WebVisu360/Viewer360Manager"],(e=>{this._viewer360Manager=new e(this),this._viewer360Manager.request360Mode(this._360ModeRequest.enabled,this._360ModeRequest.params,this._360ModeRequest.tileSetAdded),this._360ModeRequest.tileSetAdded=!1,this._360ModeRequest.params=null})))},_init360ModeRequest:function(){null===this._360ModeRequest&&(this._360ModeRequest={needInit:!0,enabled:!1,params:null,tileSetAdded:!1})},_on360TileSetAddedBefore:function(){this._init360ModeRequest(),this._360ModeRequest.tileSetAdded=!0},_on360TileSetAddedAfter:function(){this.request360Mode(this.is360ModeRequested(),this._360ModeRequest&&this._360ModeRequest.params||null)},is360ModeRequested:function(){return this._360ModeRequest&&this._360ModeRequest.enabled||!1},get360Mode:function(){return!!this._viewer360Manager&&this._viewer360Manager.get360Mode()},onStart360Mode:function(e){return this._modelEvent.subscribe({event:"Start360Mode"},e)},onEnd360Mode:function(e){return this._modelEvent.subscribe({event:"End360Mode"},e)},setNavigationParams:function(e){void 0!==this._navigationParams&&(void 0!==e.clickToNavigateIn360&&(this._navigationParams.clickToNavigateIn360=e.clickToNavigateIn360),void 0!==e.reframe360CB&&(this._navigationParams.reframe360CB=e.reframe360CB))},getNavigationParams:function(){return this._navigationParams},hasVirtualProduct:function(){return!!this._oocManager&&this._oocManager.hasVirtualProduct()},onVirtualProductAdded:function(e){return this._modelEvent.subscribe({event:"VirtualProductAdded"},e)},onVirtualProductRemoved:function(e){return this._modelEvent.subscribe({event:"VirtualProductRemoved"},e)},_publish360ModeEvent:function(e){if(this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}}),this._executionContext){let t=this._executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent);t&&(e?t.disableCheck("VisFlyWalkActions"):t.enableCheck("VisFlyWalkActions"))}this._modelEvent.publish({event:e?"Start360Mode":"End360Mode",data:{viewer:this}})},_updateShaders:function(){this.internalSceneGraph&&this.internalSceneGraph.updateShaders()},_addRobot:function(e,t){t.addRobotNode(e)},addDebugPoint:function(e,i,r){var n=b.createSphereNode({radius:r||3,material:new t.MeshBasicMaterial({color:i,force:!0,enableClipPlanes:!1,forceSide:!0})});n.setNoHighlightNoZ(!0);var s=b.createFixedSizeNode();s.addChild(n),this.internalSceneGraph.addDebugNode(s),s.setPickable(l.PICKTHROUGH);var a=this;function o(e){var i=new t.Matrix4;e instanceof Array&&(e={x:e[0],y:e[1],z:e[2]}),i.setPosition(e),s.setMatrix(i)}return o(e),{setPosition:function(e){o(e)},remove:function(){a.internalSceneGraph.removeDebugNode(s)},add:function(){a.internalSceneGraph.addDebugNode(s)}}},restoreVisualizationMode:function(e){var i=[],r=0,n=t.ShowAllFaces,s=t.ShowAllRenderLineMode,a=0;e&&(void 0!==e.materialMode&&null!==e.materialMode&&(r=e.materialMode),void 0!==e.renderFaceMode&&null!==e.renderFaceMode&&(n=e.renderFaceMode),void 0!==e.renderLineMode&&null!==e.renderLineMode&&(s=e.renderLineMode),void 0!==e.displayHiddenEdges&&null!==e.displayHiddenEdges&&(a=e.displayHiddenEdges));var o=localStorage.getItem("visuShadingMode");if(o)localStorage.removeItem("renderFaceMode"),localStorage.removeItem("renderLineMode"),localStorage.removeItem("displayHiddenEdges"),localStorage.removeItem("materialMode"),this.setVisuShadingMode(o),i.push("Visu"+o+"Cmd"),i.push("Visu"+o);else{if(!localStorage.getItem("materialMode")||"BACKGROUND"!==localStorage.getItem("materialMode")&&"ZONLY"!==localStorage.getItem("materialMode")){var l=localStorage.getItem("materialMode")?parseInt(localStorage.getItem("materialMode"),10):r;this.setMaterialMode(l)}else{var h=new R;h.setFaceMode(localStorage.getItem("materialMode")),this.setRenderStyle(h)}var c=localStorage.getItem("renderFaceMode")?parseInt(localStorage.getItem("renderFaceMode"),10):n,d=localStorage.getItem("renderLineMode")?parseInt(localStorage.getItem("renderLineMode"),10):s;this._setInternalRenderFaceMode(c),this._setInternalRenderLineMode(d);var u=localStorage.getItem("displayHiddenEdges")?parseInt(localStorage.getItem("displayHiddenEdges"),10):a;this.displayHiddenEdges(u)}var p=localStorage.getItem("axisState");p&&(this.setAxisFilter("true"===p),this.getAxisFilter()&&(i.push("VisuFilterAxis"),i.push("VisuFilterAxisEnableCmd")));var f=localStorage.getItem("linesState");f&&(this.setLinesFilter("true"===f),this.getLinesFilter()&&(i.push("VisuFilterLines"),i.push("VisuFilterLinesEnableCmd")));var g=localStorage.getItem("pointsState");return g&&(this.setPointsFilter("true"===g),this.getPointsFilter()&&(i.push("VisuFilterPoints"),i.push("VisuFilterPointsEnableCmd"))),this.applyRenderModeLock(),i},restoreProjectionMode:function(){var e=[];return this.currentViewpoint&&localStorage.getItem("projectionMode")&&!this._2DMode&&(this.currentViewpoint.setProjectionType(parseInt(localStorage.getItem("projectionMode"),10)),1===this.currentViewpoint.getProjectionType()?(e.push("VisuOrthographicViewCmd"),e.push("VisuOrthographicView")):(e.push("VisuPerspectiveViewCmd"),e.push("VisuPerspectiveView"))),e},restoreAmbiance:function(){var e=[],t=localStorage.getItem("visuEnv");return t?t.includes("OCA")?(e.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t)):(e.push("Visu"+t+"Env"),e.push("Visu"+t+"EnvCmd"),this.setVisuEnv(t)):this.setV6Ambience(),e},getWidgetID:function(){var e=window.widget;return void 0!==e?e.getValue("x3DAppId"):"no-app"},setRobotAndRefAxisSystemEnabled:function(e){this.internalSceneGraph.setRobotAndRefAxisSystemEnabled(e)},getRobotAndRefAxisSystemEnabled:function(){var e=this.getRobot();return e&&e._isEnabled()},setRenderPriority:function(e){return this.renderer.resetGSSOCache(),e&&this.getSectionCapping()?(console.warn("Render priority mode is not compatible with section capping"),!1):(e&&this.setOIT(!1),this._renderPriorityManager||(this._renderPriorityManager=new A(this)),this._renderPriorityManager.setEnabled(e),!0)},getRenderPriority:function(){return!(!this._renderPriorityManager||!this._renderPriorityManager.enabled)},setRenderPriorityDefaultOpacity:function(e){this.getRenderer().renderPriorityDefaultOpacity=e},forceSceneMin:function(e){this._forceSceneMin(e),this.render({updateInfinitePlane:!0})},_getDivClientWidth:function(){return(this._pageObjectData?this._pageObjectData.version<2?this.canvas.width:this.canvas.width/this.devicePixelRatio:this.div.clientWidth)||1},_getDivClientHeight:function(){return(this._pageObjectData?this._pageObjectData.version<2?this.canvas.height:this.canvas.height/this.devicePixelRatio:this.div.clientHeight)||1},_getCanvasOffsetWidth:function(){return this._pageObjectData?this.canvas.width:this.canvas.offsetWidth},_getCanvasOffsetHeight:function(){return this._pageObjectData?this.canvas.height:this.canvas.offsetHeight},_getForceRenderTargetSize:function(){return this._pageObjectData&&this._pageObjectData.forceRenderTargetSize},_forceSceneMin:function(e){this._forceSceneMinValue=e},_addClippingPlane:function(e){},_removeClippingPlane:function(e){},_addManipulator:function(e,t){this._manipulators[t]=e},_removeManipulator:function(e){delete this._manipulators[e]},_filterClippedIntersections:function(e){var t,i,r=[],n=this.getRenderer();n.clipPlanesEnabled&&(t=new E(n.clipPlanes));var s,a=0;for(a=0;a<e.length;a++)(i=(s=e[a]).object&&(t||s.object._occurrence.clippingContext))&&s.point&&!i.isPointVisible(s.point)||r.push(s);return r},setIdPathMatcher:function(e){this.idPathMatcher=e},setImmersiveFrame:function(e){this._immFrame=e},getFreeZone:function(){var e=this._pageObjectData?this._pageObjectData.getFreeZone():null;return e||this._immFrame&&this._immFrame.getFreeZone()},getIdPathMatcher:function(){return this.idPathMatcher},_deprecated_useBackfaceCullingWithNoCapping:function(e){this.renderer.renderer.useBackfaceCullingWithNoCapping=e},useCustomCappingForClipPolyline:function(e){this.renderer.renderer.useCustomCappingForClipPolyline=!!e},_setPageObjectData:function(e){this._pageObjectData=e},_getScenegraphs:function(){let e=this._viewpointManager.getAuxiliaryScenegraphs();return this._safeInternalSceneGraph&&e.push(this._safeInternalSceneGraph),e},_requestClippingUpdate:function(){let e=this._getScenegraphs();for(let t=0;t<e.length;t++)e[t]._needClippingUpdate=!0;this._updateShadowMaps()},_getUserPassManager:function(){return this._userPassManager},_setOOCManager:function(e){this._oocManager=e,this._sceneGraphOverrideSetManager&&this._sceneGraphOverrideSetManager._setPGManager(e._getPGManager())},_getOOCManager:function(){return this._oocManager},_setInternalRenderFaceMode:function(e){this.renderer.renderer.renderFaceMode=e},_getInternalRenderFaceMode:function(){return this.renderer.renderer.renderFaceMode},_setInternalRenderLineMode:function(e){this.renderer.renderer.renderLineMode=e},_getInternalRenderLineMode:function(){return this.renderer.renderer.renderLineMode},_DEPRECATED_setRenderFooMode:function(e){console.warn("[WebGLViewer] Deprecated setRenderLineMode/setRenderFaceMode method.\nUse setRenderMode() instead\n"+e.stack)},enableRemoteRender:function(e){this.renderer.setEffect("xRevealStructure",e)},setupRemoteRender:function(e){var t=this;if(this._remoteRenderInfos.eventToken&&(t.unsubscribe(t._remoteRenderInfos.eventToken),!e&&t._remoteRenderInfos.div&&t._remoteRenderInfos.div.destroy()),t._remoteRenderInfos.videoRender=!1,!e){let e=this.getEffect("xRevealStructure");if(e&&e.clearTextures(),t.renderer.setEffect("xRevealStructure",!1),this._remoteRenderInfos.videoElements){for(let[e,t]of this._remoteRenderInfos.videoElements)t&&(t.image.close&&t.image.close(),t.dispose());this._remoteRenderInfos.videoElements=null}return}let i="function"!=typeof e;if(t._remoteRenderInfos.useDiv&&!t._remoteRenderInfos.div){t._remoteRenderInfos.div=UWA.createElement("div"),t._remoteRenderInfos.div.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});let e=UWA.createElement("img"),i=UWA.createElement("canvas");i.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),t.div.insertBefore(t._remoteRenderInfos.div,t.div.firstChild),t._remoteRenderInfos.div.append(e),t._remoteRenderInfos.div.append(i),t._remoteRenderInfos.img=e,t._remoteRenderInfos.cvs=i}if(t._remoteRenderInfos.useDiv||this.getEffect("xRevealStructure")||this.renderer.initEffect("xRevealStructure"),t.renderer.setEffect("xRevealStructure",!0),this.getEffect("xRevealStructure").setPosition(i?1:2),!i){t._remoteRenderInfos.eventToken=t.onPreRender((function(){var i=e(t.currentViewpoint,[t.SCREEN_WIDTH,t.SCREEN_HEIGHT]);i&&i.then(t._onRemoteImageReceived).catch((()=>{}))}))}},setRemoteVideo:function(e,i,r){let n=this.getEffect("xRevealStructure").getTexture(i);if(n&&n.image==e)return;let s=null;e&&(s=new t.ImageUtils.loadVideoTexture(e,null,r));if(this._remoteRenderInfos.videoRender=!0,this._remoteRenderInfos.videoElements||(this._remoteRenderInfos.videoElements=new Map),this._remoteRenderInfos.videoElements.has(i)){let e=this._remoteRenderInfos.videoElements.get(i);e&&e.dispose()}this._remoteRenderInfos.videoElements.set(i,s),this.getEffect("xRevealStructure").updateTexture(s,i)},setRemoteVideoDecoderTexture:function(e,i,r){let n=this.getEffect("xRevealStructure").getTexture(i);if(n){if(n.image==e)return;n.image.close()}let s=null;e&&(s=new t.ImageUtils.loadVideoTextureFrame(e,null,r,n));this.render(),this._remoteRenderInfos.videoElements||(this._remoteRenderInfos.videoElements=new Map),this._remoteRenderInfos.videoElements.set(i,s),this.getEffect("xRevealStructure").updateTexture(s,i)},_onRemoteImageReceived:function(e,i){let r=this;if(e.data)if(r._remoteRenderInfos.useDiv){if("blob"==e.format||"arrayBuffer"==e.format||"url"==e.format)URL.revokeObjectURL(r._remoteRenderInfos.img.src),"blob"==e.format?r._remoteRenderInfos.img.src=URL.createObjectURL(e.data):"arrayBuffer"==e.format?r._remoteRenderInfos.img.src=URL.createObjectURL(new Blob([e.data])):"url"==e.format&&(r._remoteRenderInfos.img.src=e.data),r._remoteRenderInfos.img.width=r.SCREEN_WIDTH,r._remoteRenderInfos.img.height=r.SCREEN_HEIGHT,r._remoteRenderInfos.cvs.width=0,r._remoteRenderInfos.cvs.height=0;else if("uint8Array"==e.format){r._remoteRenderInfos.img.width=0,r._remoteRenderInfos.img.height=0,r._remoteRenderInfos.cvs.width=e.width,r._remoteRenderInfos.cvs.height=e.height;var n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height);r._remoteRenderInfos.cvs.getContext("2d").putImageData(n,0,0)}}else{var s=null,a=!0;"uint8Array"==e.format?((s=new t.DataTexture(e.data,e.width,e.height,t.RGBAFormat,t.UnsignedByteType)).flipY=!1,s.needsUpdate=!0,a=!1):"blob"==e.format?s=new t.ImageUtils.loadTexture(URL.createObjectURL(e.data)):"arrayBuffer"==e.format?s=new t.ImageUtils.loadTexture(URL.createObjectURL(new Blob([e.data]))):"url"==e.format&&(s=new t.ImageUtils.loadTexture(e.data)),a?s.onLoadCallbacks.push((function(e){r._remoteRenderInfos.tex&&r._remoteRenderInfos.tex.dispose(),r._remoteRenderInfos.tex=e,r.getEffect("xRevealStructure").updateTexture(e,i)})):(r._remoteRenderInfos.tex&&r._remoteRenderInfos.tex.dispose(),r._remoteRenderInfos.tex=s,r.getEffect("xRevealStructure").updateTexture(s,i)),r.render()}else r.getEffect("xRevealStructure").updateTexture(null,i)},onSectionPlaneMoveStart:function(){Y.startManipulation("sectionPlaneMove"),this.sectionPlaneManipulated=!0,!1!==window.OOCLDHTest_pause&&this._oocManager&&this._oocManager.setPauseLoading(!0,"sectionPlaneManipulation")},onSectionPlaneMoveEnd:function(){!1!==window.OOCLDHTest_pause&&this._oocManager&&this._oocManager.setPauseLoading(!1,"sectionPlaneManipulation"),this.sectionPlaneManipulated=!1,Y.endManipulation("sectionPlaneMove"),this.render()},isSectionPlaneManipulated:function(){return this.sectionPlaneManipulated}});return Object.defineProperty(oe.prototype,"backgroundColor",{get:function(){return this.__tempBackgroundColorODT}}),Object.defineProperty(oe.prototype,"sceneGraph",{get:function(){return r.DEPRECATED_SceneGraph(new Error,!0),this.getRootNode()}}),Object.defineProperty(oe.prototype,"directionalLight",{get:function(){return console.warn("deprecated property : directionalLight"),this._directionalLight&&this._directionalLight._occurrences[0].renderable},set:function(e){console.warn("deprecated property"),this._directionalLight=e}}),Object.defineProperty(oe.prototype,"directionalLight2",{get:function(){return console.warn("deprecated property : directionalLight2"),this._directionalLight2&&this._directionalLight2._occurrences[0].renderable},set:function(e){console.warn("deprecated property"),this._directionalLight2=e}}),Object.defineProperty(oe.prototype,"directionalLight3",{get:function(){return console.warn("deprecated property : directionalLight3"),this._directionalLight3&&this._directionalLight3._occurrences[0].renderable},set:function(e){console.warn("deprecated property"),this._directionalLight3=e}}),Object.assign(oe.prototype,W),Object.assign(oe.prototype,j.Mixins),Object.assign(oe.prototype,X),Object.assign(oe.prototype,q),UWA.namespace("THREEDS/WebGLViewer",oe)})),define("DS/Visualization/WebGLV6Viewer",["DS/Visualization/WebGLViewer","DS/Robot/Robot","DS/Robot/ReferenceAxisSystemNode","DS/Robot/CustomReferenceAxisSystem","DS/Visualization/InternalSceneGraph","DS/SceneGraphOverrides/SceneGraphState","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/Visualization/OccurrenceRenderingOverride","DS/SceneGraphOverrides/OverrideLink2","DS/QualityManager/QMController","DS/QualityManager/QMScoreHandler","DS/QualityManager/QMViewerMixins","DS/Visualization/ThreeJS_DS","DS/ViewPanel/ViewPanelController","DS/WAFData/WAFData","DS/Visualization/Node3D","DS/SceneGraphOverrides/IdPathOverrideWatcherTree","DS/Visualization/Filters/MaterialToUseFilter","DS/Visualization/Viewpoint","DS/VisuMePreferences/MePreferences"],(function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y){g.SceneGraphOverrideSetManager=a;var S=e.extend({init:function(e){if(this._useQM=!1,this._QMInit=!1,this._useViewPanel=!1,this._viewPanelInit=!1,this._QMRefreshToken=null,!h.isInitialized){var t=e.qualityManagerProfile?e.qualityManagerProfile:"true"===localStorage.getItem("__WEBVISU_SWYM_PROFILES__")?"SWYM":"Default";"SWYM"!==t&&"Default"!==t&&(console.error("Unknown QM profile "+t+". Switching back to Default."),t="true"===localStorage.getItem("__WEBVISU_SWYM_PROFILES__")?"SWYM":"Default"),h.init("QualityPresets",t),h.initPresetDB()}void 0!==e.useQualityManager&&e.useQualityManager&&(h.linkToViewer(this),this._useQM=!0),void 0!==e.useViewPanel&&e.useViewPanel&&(this._useViewPanel=!0),this._parent(e),this._initialized=!1,this._sceneGraphOverrideSetManager=new a({viewer:this}),this._idPathOverrideWatcher=null,this._viewPanelController=null;const i=this;c.handleViewer(i,e,(()=>!h.computeDefaultPreset(i)))},_initVisualization:function(e){this._initialized||(this._initialized=!0,e.lockQMSettings&&this.lockQMSettings(e.lockQMSettings),this._useQM&&this._initQMSettings(),this._useViewPanel&&(this._viewPanelController=new p(this,e.viewPanelConfig),this._initViewPanelSettings(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})),this.renderer._needPerformanceSuite()&&(this.renderer._needsPerformanceCheck=!1,this.render()),this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.OIT&&this.setOIT(this._configAmbiences.effects.OIT),this._modelEvent.publish({event:"VisualizationInitialized",data:{viewer:this}}),e.useQualityManager&&(this._QMRefreshToken=this.onPreRenderFrame((()=>{h._refreshViewers()}))))},_initViewPanelSettings:function(){if(this._viewPanelInit||!this._useViewPanel)return;const e=this;this._viewPanelController.init((()=>{e._viewPanelInit=!0,e._modelEvent.publish({event:"ViewPanelSettingsInitialized",data:{viewer:e}})}))},restoreViewPanelSettings:function(){if(this._useViewPanel)if(this._viewPanelInit)this._viewPanelController.restore();else{var e=this;let t;t=this._modelEvent.subscribe({event:"ViewPanelSettingsInitialized"},(function(){e.unsubscribe(t),e.restoreViewPanelSettings()}))}},dumpViewPanelSettings:function(){return this._useViewPanel?p.dumpSettings(this):null},applyViewPanelSettings:function(e){if(this._useViewPanel)if(this._viewPanelInit)this._viewPanelController.apply(e);else{var t=this;let i;i=this._modelEvent.subscribe({event:"ViewPanelSettingsInitialized"},(function(){t.unsubscribe(i),t.applyViewPanelSettings(e)}))}},restoreVisualizationMode:function(t){return this._useViewPanel?[]:e.prototype.restoreVisualizationMode.call(this,t)},restoreProjectionMode:function(){return this._useViewPanel?[]:e.prototype.restoreProjectionMode.call(this)},restoreAmbiance:function(){if(this._useViewPanel)return[];var t=localStorage.getItem("visuEnv");if(!t&&this._useQM&&!u.AutomatedTests()){var i=[];return t="WhiteExperienceOCA",i.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t),i}return e.prototype.restoreAmbiance.call(this)},setV6Ambience:function(){if(!this._useViewPanel)return e.prototype.setV6Ambience.call(this)},updateViewPanelUIConfiguration:function(e){if(this._useViewPanel)if(this._viewPanelInit)this._viewPanelController._updateViewPanelUIConfiguration(e),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}});else{var t=this;let i;i=this._modelEvent.subscribe({event:"ViewPanelSettingsInitialized"},(function(){t.unsubscribe(i),t.updateViewPanelUIConfiguration(e)}))}},_onRequestViewPanelReconstruction:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelReconstruction"},e)},setPlanesFilter:function(e){var t=this.planesFilterStatus!==e;if(u.__NoShowForAxisAndPlanesBags()){var i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("RefPlanes");r&&r.length>0&&r.forEach((function(t){t.setVisibility(e),t.setVisibilityFree(!e)}))}}t&&(this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},setAxisOnlyFilter:function(e){var t=this.axisFilterStatus!==e;if(u.__NoShowForAxisAndPlanesBags()){var i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("AxisSystems");r&&r.length>0&&r.forEach((function(t){t.setVisibility(e),t.setVisibilityFree(!e)}))}}t&&(this.axisFilterStatus=e,this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}})),this.render()},setAxisAndPlanesFilter:function(e){this.setPlanesFilter(e),this.setAxisOnlyFilter(e)},setRobot:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.setRobot(e,t,this)&&this.render()},getRobot:function(){return this.internalSceneGraph?this.internalSceneGraph.getRobot():null},setCustomReferenceAxisSystem:function(e){this.internalSceneGraph&&(this.internalSceneGraph.setCustomReferenceAxisSystem(e),this.render())},getCustomReferenceAxisSystem:function(){return this.internalSceneGraph&&this.internalSceneGraph._customReferenceAxisSystem},setReferenceAxisSystem:function(e){this.internalSceneGraph.showReferenceAxisSystem(e,void 0)},getReferenceAxisSystemNode:function(){return this.internalSceneGraph&&this.internalSceneGraph.referenceAxisSystemNode},createSceneGraphState:function(){if(this._sceneGraphStateVersion&&1!==this._sceneGraphStateVersion)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),this.getRootNode())return new s(this,this.getRootNode())},setCurrentSceneGraphState:function(e){if(this._sceneGraphStateMode&&1!==this._sceneGraphStateVersio)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),e instanceof s||this.sceneGraphState instanceof s&&!e){var t=this.getRootNode();(!e||e.viewer===this&&e.sceneGraph===t)&&e!==this.sceneGraphState&&(this.sceneGraphState&&this.sceneGraphState.onDeactivation(t),e&&e.onActivation(t),this.sceneGraphState=e,this.internalSceneGraph.root._occurrences[0].requestOverridesUpdate())}},setVisuEnv:function(e){if(this._useViewPanel)return"None"!==e&&"No"!==e?void console.error("Error: deprecated API usage, please use setVisuEnvOCA instead. Requested environment will not be applied."):(console.warn("Error: deprecated API usage, please use setVisuEnvOCA instead. Using Basic from setVisuEnvOCA"),void this.setVisuEnvOCA("Basic"));this._parent(e)},setVisuEnvOCA:function(e,t){return this._parent(e,t)},_isControlPanelActivated:!0,displayIntroductoryControlPreferencePanel:function(){if(this._isControlPanelActivated&&window.widget&&window.widget.getValue("x3dPlatformId")){let e=this,t=function(t,i,r){if(!i&&!r){let e=t&&t.toLowerCase&&t.toLowerCase();n=e,require(["DS/SWXCoreManipulation/xAppControlPreferencesPanel"],(function(e){var t=new e,i="solidworks"==n?2:"catia"==n?1:0;t.show(i).then((function(e){if(-1!=e){var t=0==e?"3DEXPERIENCE":1==e?"CATIA":"SOLIDWORKS";y.setPreference(y.PREFERENCES.NAVIGATIONMODE,t)}}))}))}var n;y.unsubscribe(e._mePreferenceToken),e._mePreferenceToken=null};this._mePreferenceToken=y.subscribe(y.PREFERENCES.NAVIGATIONMODE,t)}},_getIdPathOverrideWatcher:function(){return!this._idPathOverrideWatcher&&this.idPathMatcher&&(this._idPathOverrideWatcher=new m({viewer:this})),this._idPathOverrideWatcher},dispose:function(){this._viewPanelInit&&this._viewPanelController.dispose(),h.dispose(this),this.unsubscribe(this._QMRefreshToken),this._QMRefreshToken=null,this._parent()},_runPerformanceCheck:function(e){if(e._performanceViewer)return;this.renderer._needsPerformanceCheck=!0;const t=this;if(!c._locked()){c._lock();const e=document.createElement("div");e.style.width="2px",e.style.height="2px",e.style.position="absolute",document.body.appendChild(e);var i=new S({useQualityManager:!1,div:e,hdr:!1,antiAliasing:!1,_performanceViewer:!0,_useMaterialManager:!1});i.getRootNode()&&i.getRootNode().setVisuFilters({_materialToUseFilter:new v(u.MaterialToUse.totalMaterial)});var r=new _(i);i.addViewpoint(r),c._doPerformanceCheck(i,(()=>{var t;c._unlock(),t=i.onPostRender((()=>{i.unsubscribe(t),i.dispose(),document.body.removeChild(e)}))}))}let n;n=c.onUnlock((function(){c.unsubscribe(n),h.computeDefaultPreset(t)?(t._initVisualization(e),t.render()):t._runPerformanceCheck(e)})),t.render()}});return Object.assign(S.prototype,d),n.setRobotClasses(t,i,r),o.setOverrideLink2Class(l),UWA.namespace("THREEDS/WebGLV6Viewer",S)})),define("Visualization/WebGLV6Viewer",["DS/Visualization/WebGLV6Viewer","DS/DSMigration/DSMigration"],(function(e,t){return t.deprecateModule("Visualization/WebGLV6Viewer"),e}));