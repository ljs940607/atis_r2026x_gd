define("DS/VCXWebVisualization/VCXInteractor",["require","exports","DS/VCXWebExperienceBase/VCXPathElementTools","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools"],(function(e,t,i,a,n,r){"use strict";class s{constructor(e){this._pathElement=void 0,this._handle=void 0,this._type=s.EType.Pick,this._constraint=s.EConstraint.None,this._constraintReferential=s.EConstraintReferential.World,this._application=s.EApplication.None,this._active=!0,this._enable=!1,this._snappingBehavior=0,this._disabledByManipulable=!1,this._enableMultiSelect=!1,this._visibility=s.EVisibility.NoChange,this._manipulatorType=s.EManipulatorType.Handle,this._handleInfos=null,this._canonicsDetection=null,this._canonicsDefaultDetection=null,this._visibilityLockedByNode=0,this._matrix=new n.Matrix4,this._inManipulation=!1,this._shouldReverseNormal=!1,this._handleLocation=s.EConstraintReferential.World,this._constraintInfos={},this._arcBar=null,this._component=e}isHandleNeeded(){return this.manipulatorType!==s.EManipulatorType.None}updateAxis(){var e;switch(this.constraint){case s.EConstraint.XAxis:e=r.getVxFromMatrix(this.matrixToUse);break;case s.EConstraint.YAxis:e=r.getVyFromMatrix(this.matrixToUse);break;case s.EConstraint.ZAxis:e=r.getVzFromMatrix(this.matrixToUse);break;case s.EConstraint.CustomAxis:e=this.constraintInfos.axis}return this.manipulator&&e&&(this.manipulator.axis=e),this.manipulator&&this.type===s.EType.Rotation&&(this.manipulator.centerPosition=r.getOFromMatrix(this.matrixToUse)),e}enable(){this._enable||(this.manipulator&&this.manipulator.enable(),a.publish({event:"VCX_INTERACTOR_ENABLE_CHANGED",data:{interactor:this,enable:!0}}),this._enable=!0)}disable(){this._enable&&(this.manipulator&&this.manipulator.disable(),a.publish({event:"VCX_INTERACTOR_ENABLE_CHANGED",data:{interactor:this,enable:!1}}),this._enable=!1)}isManipulated(){return this._inManipulation}setManipulated(e){this._inManipulation=e}get VisibilityLockedByNode(){return this._visibilityLockedByNode}set VisibilityLockedByNode(e){this._visibilityLockedByNode=e}get constraintInfos(){return this._constraintInfos}set constraintInfos(e){this._constraintInfos=e}get matrixToUse(){var e;if(this.constraintReferential===s.EConstraintReferential.Geometry&&this.geometry&&this.component){var t=this.component.QueryInterface("W3AISGNodeHolder")?.getPathElement(),a=t&&i.buildPathElement(t,this.geometry);e=a&&a.getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer())}else e=this.constraintReferential===s.EConstraintReferential.Object&&this.component?this.component.QueryInterface("W3AISGNodeHolder")?.getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer()):this.matrix?this.matrix:new n.Matrix4;return e}get handleMatrix(){if(!this.handleLocation)return this.matrixToUse;var e;if(this.handleLocation===s.EConstraintReferential.Geometry&&this.geometry&&this.component){var t=this.component.QueryInterface("W3AISGNodeHolder")?.getPathElement(),a=i.buildPathElement(t,this.geometry);e=a&&a.getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer())}else e=this.handleLocation===s.EConstraintReferential.Object&&this.component?this.component.QueryInterface("W3AISGNodeHolder")?.getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer()):this.matrix?this.matrix:new n.Matrix4;return e}get pathElement(){return this._pathElement}set pathElement(e){this._pathElement=e,this.manipulatorToken&&(this.manipulator&&this.manipulator.unlink(this.manipulatorToken),this.manipulatorToken=null)}get handle(){return this._handle}set handle(e){this._handle=e,this.manipulatorToken&&(this.manipulator&&this.manipulator.unlink(this.manipulatorToken),this.manipulatorToken=null)}get node(){return this.isHandleNeeded()?this._handle&&this._handle?.getHandleGeom():this._pathElement&&this._pathElement?.getLastElement(!0)}set node(e){if(e){if(this._component){var t=this._component.QueryInterface("W3AISGNodeHolder"),i=t&&t.giveSGNode();if(e===i)this.pathElement=t?.getPathElement()?.clone();else{var a=[],n=e,r=this._component._experienceBase.getManager("VCXContextManager");if(!r)return;var s=r.getRootNode();if(!s)return;for(;n.parents&&n.parents[0]&&n!==i&&n!==s;)a.push(n),n=n.parents[0];if(n===i){this.pathElement=t?.getPathElement()?.clone();for(var o=a.length-1;o>=0;o--)this._pathElement?.addElement(a[o])}else if(n===s){var l=r.getRootComponent();const e=l?.QueryInterface("W3AISGNodeHolder")?.getPathElement();this.pathElement=e?.clone(),this.pathElement?.setFromArray(a,[])}}}}else this.pathElement=void 0}get type(){return this._type}set type(e){this._type=e}get constraint(){return this._constraint}set constraint(e){this._constraint=e}get constraintReferential(){return this._constraintReferential}set constraintReferential(e){this._constraintReferential=e}get application(){return this._application}set application(e){"number"==typeof e&&(this._application=e)}get active(){return!!s.enableInteractors&&(!(!this.handleInfos||!this.handleInfos.stayVisible)||!this.disabledByManipulable&&this._active)}set active(e){this._active!==e&&(this._active=e,this.active?this.enable():this.disable())}get enableMultiSelect(){return this._enableMultiSelect}set enableMultiSelect(e){"boolean"==typeof e&&(this._enableMultiSelect=e)}get snappingBehavior(){return this._snappingBehavior}set snappingBehavior(e){this._snappingBehavior=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e}get manipulatorType(){return this._manipulatorType}set manipulatorType(e){this._manipulatorType=e}get handleInfos(){return this._handleInfos}set handleInfos(e){e?(e.color||e.opacity||e.size)&&(this._handleInfos||(this._handleInfos={}),e.color&&(this._handleInfos.color=e.color),e.opacity&&(this._handleInfos.opacity=e.opacity),e.size&&(this._handleInfos.size=e.size),e.stayVisible&&(this._handleInfos.stayVisible=e.stayVisible)):this._handleInfos=null}get matrix(){return this._matrix}set matrix(e){e instanceof n.Matrix4&&(this._matrix=e)}get component(){return this._component}set component(e){this._component=e}get canonicsDetection(){return this._canonicsDetection}set canonicsDetection(e){this._canonicsDetection=e}get canonicsDefaultDetection(){return this._canonicsDefaultDetection}set canonicsDefaultDetection(e){this._canonicsDefaultDetection=e}get manipulator(){return this._manipulator}set manipulator(e){this._manipulator=e}get customIcon(){return this._customIcon}set customIcon(e){this._customIcon=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e}get manipulatorToken(){return this._manipulatorToken}set manipulatorToken(e){this._manipulatorToken=e}get handleLocation(){return this._handleLocation}set handleLocation(e){this._handleLocation=e}get disabledByManipulable(){return this._disabledByManipulable}set disabledByManipulable(e){this._disabledByManipulable=e}get arcBar(){return this._arcBar}set arcBar(e){this._arcBar=e}get contextualMenuOptions(){return this._contextualMenuOptions}set contextualMenuOptions(e){this._contextualMenuOptions=e}get shouldReverseNormal(){return this._shouldReverseNormal}set shouldReverseNormal(e){this._shouldReverseNormal=e}}return s.enableInteractors=!0,function(e){let t,i,a,n,r,s,o;!function(e){e[e.Pick=0]="Pick",e[e.PlaneTranslation=1]="PlaneTranslation",e[e.LineTranslation=2]="LineTranslation",e[e.Scaling=3]="Scaling",e[e.Rotation=4]="Rotation",e[e.Screen=5]="Screen"}(t=e.EType||(e.EType={})),function(e){e[e.None=0]="None",e[e.XAxis=1]="XAxis",e[e.YAxis=2]="YAxis",e[e.ZAxis=3]="ZAxis",e[e.CustomAxis=4]="CustomAxis",e[e.Screen=5]="Screen"}(i=e.EConstraint||(e.EConstraint={})),function(e){e[e.World=0]="World",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry"}(a=e.EConstraintReferential||(e.EConstraintReferential={})),function(e){e[e.None=0]="None",e[e["3DIllustration"]=2]="3DIllustration",e[e["3DPlayCATIAComposer"]=4]="3DPlayCATIAComposer"}(n=e.EApplication||(e.EApplication={})),function(e){e[e.NoChange=0]="NoChange",e[e.OnObjectOver=2]="OnObjectOver",e[e.OnObjectSelected=4]="OnObjectSelected",e[e.OnInteractorOver=8]="OnInteractorOver",e[e.Always=16]="Always",e[e.OnNodeVisibility=32]="OnNodeVisibility"}(r=e.EVisibility||(e.EVisibility={})),function(e){e[e.None=0]="None",e[e.Axis=1]="Axis",e[e.Handle=2]="Handle",e[e.BarHandle=3]="BarHandle",e[e.Custom=4]="Custom",e[e.ArrowHandle=5]="ArrowHandle",e[e.PinHandle=6]="PinHandle"}(s=e.EManipulatorType||(e.EManipulatorType={})),function(e){e.TopLeft="nwse-resize",e.BottomRight="nwse-resize",e.TopRight="nesw-resize",e.BottomLeft="nesw-resize",e.Top="ns-resize",e.Bottom="ns-resize",e.Left="ew-resize",e.Right="ew-resize"}(o=e.ECursorDisplay||(e.ECursorDisplay={}))}(s||(s={})),s})),define("DS/VCXWebVisualization/VCXIViewpointController",["require","exports"],(function(e,t){"use strict";var i;return function(e){let t;!function(e){e[e.Auto=10]="Auto",e[e.DOI=20]="DOI",e[e.Follow=30]="Follow"}(t=e.EDOFType||(e.EDOFType={}))}(i||(i={})),i})),define("DS/VCXWebVisualization/VCXBillBoardArrowNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/VCXWebSystem/VCXMathTools","DS/Visualization/ThreeJS_DS"],(function(e,t,i){"use strict";var a=new i.Vector3,n=new i.Matrix4,r=new i.Matrix4,s=new i.Matrix4;return e.extend({_computeAxisProjectionSight(e,t){let i=e.dot(t),a=e.clone().sub(t.clone().multiplyScalar(i));return a.normalize(),a},_getDynamicMatrix:function(e,o,l){e||(n.identity(),e=n);var h=l||o.viewpoint;s.identity(),s.extractRotation(e);var u=t.getOFromMatrix(e).sub(h.getEyePosition()).normalize();let c=t.getVxFromMatrix(e).clone().normalize(),p=t.getVzFromMatrix(e).clone().normalize(),d=t.getVyFromMatrix(e).clone().normalize();var _=u.clone();let g;switch(("PRESERVE_Z_AXIS"===this.BillBoardType?t.getVyFromMatrix(e).dot(u):t.getVzFromMatrix(e).dot(u))<0&&_.negate(),this.BillBoardType){case"PRESERVE_X_AXIS":g=this._computeAxisProjectionSight(_,c),r=t.getMatrixFromOVzVx(new i.Vector3,g,c);break;case"PRESERVE_Y_AXIS":g=this._computeAxisProjectionSight(_,d),r=t.getMatrixFromOVzVy(new i.Vector3,g,d);break;case"PRESERVE_Z_AXIS":g=this._computeAxisProjectionSight(_,p),r=t.getMatrixFromOVyVz(new i.Vector3,g,p)}return n.getInverse(s),s.multiplyMatrices(n,r),this._matrix&&s.setPosition(a.getPositionFromMatrix(this._matrix)),s}})}));var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebVisualization/VCXAPrepareRenderToTexture",["require","exports","DS/VCXWebComponents/WebExtensionBaseExperience"],(function(e,t,i){"use strict";i=__importDefault(i);class a extends i.default{GetType(){return"VCXAPrepareRenderToTexture"}async prepareRender(e,t){}async postRender(e,t){}}return a}));var __decorate=this&&this.__decorate||function(e,t,i,a){var n,r=arguments.length,s=r<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,a);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s};__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebVisualization/VCXImageManager",["require","exports","DS/VCXWebProperties/VCXColor","DS/VCXWebComponents/VCXWebComponentBaseExperience","DS/VCXWebIO/VCXPixelImage","DS/VCXWebSystem/VCXEvent"],(function(e,t,i,a,n,r){"use strict";a=__importDefault(a),n=__importDefault(n);class s extends a.default{constructor(){super(...arguments),this._imagesCacheSize=10,this._imagesCache=[]}postInitialize(){}onTest(e){e&&e.docID&&this.clearCache(e.docID)}unInitialize(){this.clearCache()}_findInCache(e,t,i,a){for(var n=0;n<this._imagesCache.length;++n){let r=this._imagesCache[n];if(r.iDocID===e&&r.iEffect===t&&r.expectedWidth===i&&r.expectedHeight===a)return r}return null}_addToCache(e,t,i,a,n){let r={iDocID:e,iEffect:t,expectedWidth:i,expectedHeight:a,effectImage:n};this._imagesCache.length<this._imagesCacheSize?this._imagesCache[this._imagesCache.length]=r:(this._imagesCache=this._imagesCache.slice(1,this._imagesCacheSize),this._imagesCache[this._imagesCacheSize-1]=r)}clearCache(e){this._imagesCache=e?this._imagesCache.filter((e=>{e.iDocID})):[]}GetImageFromDocID(e,t,a,r){t||(t=0);var o=this._experienceBase.getManager("VCXDocManager").GetPropPath(e);if(!o)return Promise.reject(new Error("No property path"));var l=o.GetValueURL().Value,h=this._findInCache(e,t,a,r);if(h&&h.effectImage)return h.effectImage.deferred.promise;var u=document.createElement("canvas");u.deferred=UWA.Promise.deferred(),this._addToCache(e,t,a,r,u);var c=t&s.Effect.RemoveBorder,p=t&s.Effect.BlankRest,d=t&s.Effect.RedimensionPower2,_=new n.default;return void 0!==a&&void 0!==r&&_.setPreferredSize(a,r),_.loadFrom(l,(()=>{var e=_.getPixelWidth(),t=_.getPixelHeight();if(c){var a={};if(_.buildBorderHist(a)){o=(new i).FromRGBA(0,0,0,0),g=(new i).FromRGBA(0,0,0,0);p&&(h=(new i).FromRGBA(0,0,0,1/255))}else{var n,r;for(var s in a)(void 0===n||a[s]>r)&&(n=s,r=a[s]);var o=(new i).FromHex(n),l=!1;if(r>t+e&&(l=!0),l){var h,g=(new i).FromRGBA(0,0,0,0);p&&(h=(new i).FromRGBA(0,0,0,1/255)),_.replaceKeyColorByOther(o,g,h)}}}if(_.fillCanvas(u),d&&(!_.isPowerOf2(_.getPixelWidth())||!_.isPowerOf2(_.getPixelHeight()))){var m=_.getNearestPow2(_.getPixelWidth()),M=_.getNearestPow2(_.getPixelHeight()),f=document.createElement("canvas");f.width=m,f.height=M;let e=f.getContext("2d");e?.drawImage(u,0,0,m,M);var C=u.deferred;(u=f).deferred=C}u._IsReadyToUse=!0,u.deferred.resolve(u)})),u.deferred.promise}get componentType(){return"VCXImageManager"}}return __decorate([r.subscribeAll],s.prototype,"postInitialize",null),__decorate([r.Handler("VCX_DOC_ADDED")],s.prototype,"onTest",null),__decorate([r.unsubscribeAll],s.prototype,"unInitialize",null),function(e){let t;!function(e){e[e.None=0]="None",e[e.RedimensionPower2=1]="RedimensionPower2",e[e.RemoveBorder=2]="RemoveBorder",e[e.BlankRest=4]="BlankRest"}(t=e.Effect||(e.Effect={}))}(s||(s={})),s})),define("DS/VCXWebVisualization/VCXBillBoardNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/VCXWebSystem/VCXMathTools","DS/Visualization/ThreeJS_DS"],(function(e,t,i){"use strict";new i.Projector;var a=new i.Vector3,n=new i.Matrix4,r=new i.Matrix4,s=new i.Matrix4;return e.extend({_getDynamicMatrix:function(e,o,l){if("PRESERVE_X_AXIS_Y_IN_CAM_PLANE"!==this.BillBoardType&&"PRESERVE_X_AXIS_Z_IN_CAM_PLANE"!==this.BillBoardType)return this._parent(e,o,l);e||(n.identity(),e=n);var h=l||o.viewpoint;s.identity(),s.extractRotation(e);var u,c=t.getOFromMatrix(e).sub(h.getEyePosition()).normalize();u="PRESERVE_X_AXIS_Y_IN_CAM_PLANE"===this.BillBoardType?t.getVzFromMatrix(e).dot(c):t.getVyFromMatrix(e).dot(c);var p=c.clone();return u<0&&p.negate(),r=t.getMatrixFromOVzVx(new i.Vector3,p,t.getVxFromMatrix(e)),n.getInverse(s),s.multiplyMatrices(n,r),this._matrix&&s.setPosition(a.getPositionFromMatrix(this._matrix)),s}})})),define("DS/VCXWebVisualization/VCXBillBoardPinNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/VCXWebSystem/VCXMathTools","DS/Visualization/ThreeJS_DS"],(function(e,t,i){"use strict";new i.Projector;var a=new i.Vector3,n=new i.Matrix4,r=new i.Matrix4,s=new i.Matrix4;return e.extend({_computeAxisProjectionSight(e,t){let i=e.dot(t),a=e.clone().sub(t.clone().multiplyScalar(i));return a.normalize(),a},_getDynamicMatrix:function(e,o,l){e||(n.identity(),e=n);const h=l||o.viewpoint;s.identity(),s.extractRotation(e);var u=t.getOFromMatrix(e).sub(h.getEyePosition()).normalize();t.getVxFromMatrix(e).clone().normalize(),t.getVzFromMatrix(e).clone().normalize();let c=t.getVyFromMatrix(e).clone().normalize();var p=u.clone();t.getVzFromMatrix(e).dot(u)<0&&p.negate();let d=this._computeAxisProjectionSight(p,c);return r=t.getMatrixFromOVzVy(new i.Vector3,d,c),n.getInverse(s),s.multiplyMatrices(n,r),this._matrix&&s.setPosition(a.getPositionFromMatrix(this._matrix)),s}})})),define("DS/VCXWebVisualization/VCXPickInfo",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools","DS/VCXWebVisu/VCXModifiablesAccess"],(function(e,t,i,a){"use strict";var n=e.extend({init:function(e,i){if(this._experienceBase=i,this._viewer=e,!this._viewer&&this._experienceBase&&(this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer()),this._experienceBase){var a=this._experienceBase.getManager("VCXDressupManager").QueryInterface("VCXIModelNavigable");this._currentWorkingRoot=a.getWorkingRoot().GetObject()}this._pathElement=null,this._modifiableIsDirty=!0,this._modifiable=null,this._position=new t.Vector3,this._normal=new t.Vector3(0,1,0),this._xAxis=null,this._matrixIsDirty=!0,this._matrix=null,this._smartMouse=new t.Vector2},reset:function(){this._viewer=null,this._experienceBase=null,this._pathElement=null,this._modifiableIsDirty=!0,this._modifiable=null,this._position=null,this._normal=null,this._matrixIsDirty=!0,this._matrix=null,this._smartMouse=null,this._canonic=null},clone:function(){var e=new n(this._viewer,this._experienceBase);return e._pathElement=this._pathElement&&this._pathElement.clone(),e._modifiableIsDirty=this._modifiableIsDirty,e._modifiable=this._modifiable,e._position=this._position&&this._position.clone(),e._normal=this._normal&&this._normal.clone(),e._xAxis=this._xAxis&&this._xAxis.clone(),e._matrixIsDirty=this._matrixIsDirty,e._matrix=this._matrix&&this._matrix.clone(),e._smartMouse=this._smartMouse&&this._smartMouse.clone(),e._canonic=this._canonic,e.magnet=this.magnet,e}});return Object.defineProperty(n.prototype,"pathElement",{enumerable:!0,get:function(){return this._pathElement},set:function(e){this._pathElement=e,this._modifiableIsDirty=!0}}),Object.defineProperty(n.prototype,"modifiable",{enumerable:!0,get:function(){return this._modifiableIsDirty&&this._experienceBase&&(this._pathElement?(this._modifiable=a.GetModifiableFromPathElement(this._pathElement,this._experienceBase),this._modifiable):this._modifiable=null,this._modifiableIsDirty=!1),this._modifiable}}),Object.defineProperty(n.prototype,"canonic",{enumerable:!0,get:function(){return this._canonic},set:function(e){this._canonic=e}}),Object.defineProperty(n.prototype,"globalPosition",{enumerable:!0,get:function(){return this.zShiftRatio&&this.pathElement&&this.size?this._position.clone().add(this._normal.clone().normalize().multiplyScalar(this.size*this.zShiftRatio||0)):this._position},set:function(e){this._position=e,this._matrixIsDirty=!0}}),Object.defineProperty(n.prototype,"localPosition",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");return t?t.getPositionInLCS(this._viewer,this.globalPosition):this.globalPosition.clone()}}),Object.defineProperty(n.prototype,"globalNormal",{enumerable:!0,get:function(){return this._normal},set:function(e){this._normal=e,this._matrixIsDirty=!0}}),Object.defineProperty(n.prototype,"localNormal",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");if(t)return t.getDirectionInLCS(this._viewer,this.globalNormal)}}),Object.defineProperty(n.prototype,"globalXAxis",{enumerable:!0,get:function(){return this._xAxis},set:function(e){this._xAxis=e,this._matrixIsDirty=!0}}),Object.defineProperty(n.prototype,"localXAxis",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");if(t)return t.getDirectionInLCS(this._viewer,this.globalXAxis)}}),Object.defineProperty(n.prototype,"globalMatrix",{enumerable:!0,get:function(){return this._matrixIsDirty&&(this._xAxis?this._matrix=i.getMatrixFromOVzVx(this._position,this._normal,this._xAxis):this._matrix=i.getMatrixFromOVz(this._position,this._normal),this.zShiftRatio&&this.pathElement&&this.size&&this._matrix.setPosition(this._position.clone().add(this._normal.clone().normalize().multiplyScalar(this.size*this.zShiftRatio||0))),this._matrixIsDirty=!1),this._matrix}}),Object.defineProperty(n.prototype,"localMatrix",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");if(t)return t.getMatrixInLCS(this._viewer,this.globalMatrix)}}),Object.defineProperty(n.prototype,"workingRootMatrix",{enumerable:!0,get:function(){var e=this._currentWorkingRoot.QueryInterface("W3AISGNodeHolder");if(e)return e.getMatrixInLCS(this._viewer,this.globalMatrix)}}),Object.defineProperty(n.prototype,"viewer",{enumerable:!0,get:function(){return this._viewer}}),Object.defineProperty(n.prototype,"smartMouse",{enumerable:!0,get:function(){return this._smartMouse},set:function(e){this._smartMouse=e}}),Object.defineProperty(n.prototype,"linkPathElement",{enumerable:!0,get:function(){return this.modifiable?this.modifiable.GetObject().QueryInterface("W3AISGNodeHolder").getPathElement():this._experienceBase.getManager("VCXContextManager").getRootPathElement()}}),Object.defineProperty(n.prototype,"size",{enumerable:!0,get:function(){var e=this.magnet&&this.magnet.radius;if(e>0)return 2*e;var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();return this.linkPathElement&&this.linkPathElement.getBoundingSphere(t).radius||1}}),n})),define("DS/VCXWebVisualization/VCXPublishRasterImage",["UWA/Class","DS/VCXWebIO/VCXPixelImage","DS/VCXWebKernelCommands/VCXCmdGoToScenario","i18n!DS/VCXWebVisualization/assets/nls/VCXWebVisualization"],(function(e,t,i,a){"use strict";var n=e.extend({init:function(){},getUsePaperRatio:function(){return void 0===this._usePaperRatio||this._usePaperRatio},captureViewport:function(e,i){var a=e.getManager("VCXVisuManager");a.setTileOutput(!0);var n=this._viewer?this._viewer:e.getManager("VCXContextManager").getMainViewer(),r=i||1,s={data:null,width:r*n.SCREEN_WIDTH,height:r*n.SCREEN_HEIGHT};n.renderToTarget(s,n.currentViewpoint);var o=null;return null!==s.data&&(o=new t(s.data,s.width,s.height)).flipVertical(),a.setTileOutput(!1),UWA.Promise.resolve(o)},_doHiResImage:async function(e,i,n,r){var s=e.getManager("VCXExperience");await s.getAllActorsReadiness();var o=this._viewer||e.getManager("VCXContextManager").getMainViewer(),l=e.getManager("VCXVisuManager");l.hideDecorations("RasterImage",o),l.setTileOutput(!0);var h=e.getManager("VCXPaperManager"),u=h.AutoFit,c=h.Zoom,p=h.Pan.clone(),d=Math.floor(i),_=Math.floor(n);if(this.getUsePaperRatio()){var g=Math.floor(i*h.Ratio);Math.abs(_-g)>1&&(_=g)}var m=!0,M=null;this._image&&this._image.getPixelWidth()===d&&this._image.getPixelHeight()===_&&(M=this._image._bufferRGBA,m=!1);var f={data:M,width:d,height:_};let C={x:Math.floor(d/window.devicePixelRatio),y:Math.floor(_/window.devicePixelRatio)};var b;this.getUsePaperRatio()&&(h.AutoFit=!0,h.updatePaper({viewportSize:C}));var x=e.getManager("VCXContextManager").getActiveViewport().QueryInterface("VCXIModifiable").GetPropertyValue("Environment.SSAO")>1;let V={viewer:o,viewpoint:o.currentViewpoint,mainOverrideSet:void 0,buffer:void 0,viewportSize:C},v=e.ComponentsMap.GetComponentFromType("VCXDressup_Spec").concat(e.ComponentsMap.GetComponentFromType("VCXComponentOccurrenceComposer"));if(r)for(const e of v){let t=e.QueryInterface("VCXIPrepareRenderToTexture");t&&await t.prepareRender(V,"normal")}try{o.renderToTarget(f,o.currentViewpoint,_>o.SCREEN_HEIGHT,{SSAO:x,IterativeSSAO:!1,AntiAliasing:"SMAA",nbIterations:1})}catch(t){if(b=t,t instanceof RangeError&&e){var y=a["RasterImage.SizeTooBig"],S=e.getManager("VCXNotificationManager");if(S){var P={level:"error",title:"error",message:y};S.addNotification(P)}}throw t}if(!b&&null!==f.data&&(m&&(this._image=new t(f.data,f.width,f.height)),this._image.flipVertical(),r)){try{V.canvas=this._image.toCanvas();for(const e of v){let t=e.QueryInterface("VCXIPrepareRenderToTexture");t&&await t.postRender(V,"normal")}}catch(e){console.warn(e)}var w=V.canvas.getContext("2d",{willReadFrequently:!0}).getImageData(0,0,V.canvas.width,V.canvas.height);this._image._bufferRGBA=new Uint8ClampedArray(w.data)}return this.getUsePaperRatio()&&(h.AutoFit=u,h.Zoom=c,h.Pan=p,h.updatePaper()),l.setTileOutput(!1),l.showDecorations("RasterImage",o),this._image},doHiRes:function(e,t,a,r,s){if(!e)return console.log("Experience is null !"),UWA.Promise.reject(new Error("Experience is null !"));var o=e.getManager("VCXScenarioManager");if(!o)return UWA.Promise.reject(new Error("VCXScenarioManager is null !"));if(!(r&&(r.mode===n.Mode.Selected||r.mode===n.Mode.All)))return this._doHiResImage(e,t,a,!0).then((e=>(e&&r.quality&&r.quality>=0&&r.quality<=1&&e.setQuality(r.quality),s&&s({image:e,scenario:o._Scenarios[o.GetCurrentScenario()]}),{image:e,scenario:o._Scenarios[o.GetCurrentScenario()]})));var l=e.getManager("VCXSelectionManager"),h=e.getManager("VCXSequenceManager");if(!h)return UWA.Promise.reject(new Error("VCXScenarioManager is null !"));for(var u=h?h.GetListSequencesFromType(0):[],c=[],p=0;p<u.length;p++){var d=u[p];if(d)for(var _=d.GetListScenariosId(),g=0;g<_.length;g++){var m=_[g],M=o.GetScenarios()[m];M&&M._ID&&(r.mode!==n.Mode.Selected||l.isIn(M))&&c.push(M._ID)}}var f=o?o.GetCurrentScenario():null,C=!1,b=e.getManager("VCXVisuManager");b&&(C=b.CameraControlsViewpoint,b.CameraControlsViewpoint=!0,b.CameraEasingTime=0);var x=this._viewer?this._viewer:e.getManager("VCXContextManager").getMainViewer();if(!x)return UWA.Promise.reject(new Error("viewer is null !"));if(!c.length)return UWA.Promise.reject(new Error("No scenario"));for(var V=e.getManager("VCXCommandManager"),v=null,y=[],S=0;S<c.length;++S)y.push(c[S]);return y.reduce(((n,l)=>n.then((()=>((v=new i(e)).GoToScenario(l),V.Do(v),e._ManagerSet.update({viewer:x,viewpoint:x.currentViewpoint}),this._doHiResImage(e,t,a,!0).then((e=>{r&&r.quality&&r.quality>=0&&r.quality<=1&&e.setQuality(r.quality),s({image:e,scenario:o._Scenarios[l]})})))))),UWA.Promise.resolve()).then((()=>{(v=new i(e)).GoToScenario(f),V.Do(v),b&&(b.CameraControlsViewpoint=C,b.CameraEasingTime=null)}))},doThumbnailToDataUrl:async function(e,t,i,a){if(this._processing)return console.warn("Wait for previous processing"),await this._processing.promise,this.doThumbnailToDataUrl(e,t,i,a);this._processing=UWA.Promise.deferred();var r,s=e.getManager("VCXPaperManager"),o=Math.floor(t);r=this.getUsePaperRatio()?t*(s._ViewBoxPxSize.y/s._ViewBoxPxSize.x):Math.floor(i);const l=await this.doHiRes(e,o,r,{mode:n.Mode.Current,quality:.8,usePaper:!0});var h=l&&l.image;if(!h)return null;var u=document.createElement("canvas");u.width=h._width,u.height=h._height;var c=u.getContext("2d");let p,d;h._height<h._width?(p=a?h._height/a:h._width,d=h._height):(d=a?h._width*a:h._height,p=h._width);const _=document.createElement("canvas");_.width=p,_.height=d;const g=_.getContext("2d");let m=(u.width-_.width)/2,M=(u.height-_.height)/2;var f=c.getImageData(0,0,h._width,h._height);return f.data.set(h._bufferRGBA),g.putImageData(f,-m,-M),this._processing.resolve(),this._processing=null,_.toDataURL("image/jpeg",.8)}});return n.Mode={Current:1,Selected:2,All:3},n})),define("DS/VCXWebVisualization/VCXIManipulable",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("DS/VCXWebVisualization/VCXIPrepareRenderToTexture",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("DS/VCXWebVisualization/VCXBillBoardPinSphereNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/VCXWebSystem/VCXMathTools","DS/Visualization/ThreeJS_DS"],(function(e,t,i){"use strict";new i.Projector;var a=new i.Vector3,n=new i.Matrix4,r=new i.Matrix4,s=new i.Matrix4;return e.extend({_computeAxisProjectionSight(e,t){let i=e.dot(t),a=e.clone().sub(t.clone().multiplyScalar(i));return a.normalize(),a},_getDynamicMatrix:function(e,o,l){e||(n.identity(),e=n);const h=l||o.viewpoint;s.identity(),s.extractRotation(e);var u=t.getOFromMatrix(e).sub(h.getEyePosition()).normalize();t.getVxFromMatrix(e).clone().normalize(),t.getVzFromMatrix(e).clone().normalize();let c=t.getVyFromMatrix(e).clone().normalize();var p=u.clone();return t.getVzFromMatrix(e).dot(u)<0&&p.negate(),r=t.getMatrixFromOVzVy(new i.Vector3,u,c),n.getInverse(s),s.multiplyMatrices(n,r),this._matrix&&s.setPosition(a.getPositionFromMatrix(this._matrix)),s}})})),define("DS/VCXWebVisualization/VCXPaperManager",["DS/CoreEvents/Events","UWA/Class","DS/Visualization/ThreeJS_DS","css!DS/VCXWebVisualization/VCXWebVisualization.css"],(function(e,t,i){"use strict";var a=t.extend({init:function(){},initialize:function(){this._PaperSize=new i.Vector2(297,210),this._zoom=1,this._lock=!1,this._fullFrame=!1,this.noShowState=!1,this._pan=new i.Vector2(0,0),this._panToCenter=new i.Vector2(0,0),this._viewer=null,this._ViewBox=new i.Vector2(0,0),this._ViewBoxSize=new i.Vector2(1,1),this._ViewBoxPx=new i.Vector2(0,0),this._ViewBoxPxSize=new i.Vector2(1,1),this._zPaper=null,this._paperDiv=null,this._paperDivContent=new UWA.Element("div",{id:"divPaperSpace"}),this._paperReferential=new i.Matrix4,this._usePaperReferential=!1},unInitialize:function(){if(this._paperDiv&&this._paperDiv.parentNode&&this._paperDiv.parentNode.removeChild(this._paperDiv),this._usableAreaUpdateEvent&&(e.unsubscribe(this._usableAreaUpdateEvent),delete this._usableAreaUpdateEvent),this._viewer){var t=this._viewer.currentViewpoint&&this._viewer.currentViewpoint.control;t&&t.onZoom&&t.onZoom(null),t&&t.onPan&&t.onPan(null);let e=this._viewer.div;e&&e.removeEvent&&this._onResizeDocking&&e.removeEvent("resize",this._onResizeDocking,!0)}this._viewer=null,this._paperDivContent=null},postInitialize:function(){if(this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer(),this._viewer){var t=this;this._usableAreaUpdateEvent=e.subscribe({event:"VCX_GUI_USABLEAREA_UPDATE"},(function(e){(t._shouldConsiderUsableArea()&&JSON.stringify(e.area)!=JSON.stringify(t.area)||JSON.stringify(e.areaWithoutPanels)!=JSON.stringify(t._usableAreaRect))&&(t._usableAreaRect=e.area,t._usableAreaWithoutPanelsRect=e.areaWithoutPanels,t.updatePaper({propagateEvent:!0}))}));var i=this._viewer.currentViewpoint;if(i&&i.control&&this._experienceBase.getManager("VCXContextManager").isSupported("Paper")&&this._experienceBase.getManager("VCXContextManager").isSupported("DisplayPaperCtrlBtns")){var a=i.control;a&&a.setPreventDefaultForCtrlKeyWheelActive&&a.setPreventDefaultForCtrlKeyWheelActive(!0);a&&a.onPan&&a.onPan((e=>{if(("COMBINED"===i.getDefaultController()||this._touchControl)&&(e&&e.gesture&&e.gesture.currentEvent&&e.gesture.currentEvent[0]&&e.gesture.currentEvent[0].event&&e.gesture.currentEvent[0].event.ctrlKey||this._touchControl)){var t=this._pan.clone();t.add(e.gesture.currentEvent[0].deltaPosition),this.Pan=t,e.defaultBehavior=!1}}));a&&a.onZoom&&a.onZoom((e=>{if("COMBINED"===i.getDefaultController()&&e&&e.factor&&e.evt&&e.evt.event&&e.evt.event.ctrlKey){var t=e.factor,a={x:e.evt.event.clientX,y:e.evt.event.clientY};this.zoomPaper(t,a),e.defaultBehavior=!1}}))}if(!this._paperDiv){this._paperDiv=new UWA.Element("div",{id:"divPaperSpaceContainer"});var n=new UWA.Element("div",{id:"divPaperSpaceTop"}),r=new UWA.Element("div",{id:"divPaperSpaceLeft"}),s=new UWA.Element("div",{id:"divPaperSpaceBottom"}),o=new UWA.Element("div",{id:"divPaperSpaceRight"});this._paperDivContent.inject(this._paperDiv),this.paperCornersTop=new UWA.Element("div",{class:"paperCorners paperTop"}).inject(this._paperDivContent),this.paperCornersBottom=new UWA.Element("div",{class:"paperCorners paperBottom"}).inject(this._paperDivContent),n.inject(this._paperDiv),r.inject(this._paperDiv),s.inject(this._paperDiv),o.inject(this._paperDiv),this._paperDiv.inject(this._viewer.div)}}this._autoFitDirty=!this._autoFit,this._autoFit=!0,this.updatePaper({propagateEvent:!0}),this._touchControl=!1;t=this;this._onResizeDocking=function(e){t.updatePaper({propagateEvent:!0})},this._onResizeWidget=function(e){e.target===window&&t.updatePaper({propagateEvent:!0})};let l=this._viewer.div;l&&l.addEvent&&this._onResizeDocking&&l.addEvent("resize",this._onResizeDocking,!1,0,!0)},update:function(e){this._frameToRender&&(this._frameToRender--,this._viewer.render());const t=this._experienceBase.getManager("VCXVisuManager");t&&(t.getNonVisibleSpaceState()&&this.paperCornersTop&&this.paperCornersBottom?(this.paperCornersTop.hasClassName("noShowState")||this.paperCornersTop.addClassName("noShowState"),this.paperCornersBottom.hasClassName("noShowState")||this.paperCornersBottom.addClassName("noShowState")):(this.paperCornersTop.hasClassName("noShowState")&&this.paperCornersTop.removeClassName("noShowState"),this.paperCornersBottom.hasClassName("noShowState")&&this.paperCornersBottom.removeClassName("noShowState")))},setPreviewModeStyle(e){var t=document.getElementById("divPaperSpaceContainer");e?t.addClassName("vcxPreviewModeActive"):t.removeClassName("vcxPreviewModeActive")},postRender:function(e){this._zPaper=null},GetZPaper:function(e){if(null===this._zPaper){new i.Vector3;var t=this.ModelToMM2(e,e.viewer.getSceneBoundingSphere().center.clone());this._zPaper=t.z,this._zPaper>=1&&(this._zPaper=.8),this._zPaper<=0&&(this._zPaper=.2)}return this._zPaper},ToggleAutoFit:function(){return this._experienceBase.getManager("VCXAnalyticsTrackerAppManager")&&this._experienceBase.getManager("VCXAnalyticsTrackerAppManager").trackReframeCanvas(),this.AutoFit=!this.AutoFit,this.AutoFit},ActivatePaperPan:function(e){this._touchControl=e},SetWidth:function(t){this._PaperSize.x=t,e.publish({event:"VCX_PAPER_RATIO_CHANGED"})},GetWidth:function(){return this._PaperSize.x},SetHeight:function(t){this._PaperSize.y=t,e.publish({event:"VCX_PAPER_RATIO_CHANGED"})},GetHeight:function(){return this._PaperSize.y},getDefaultOptions:function(){return{viewer:this._viewer,viewpoint:this._viewer.currentViewpoint}},getPaperReferential:function(){return this._paperReferential},shouldUsePaperReferential:function(){return this._usePaperReferential},setPaperReferential:function(e){this._paperReferential.copy(e)},setUsePaperReferential:function(e){this._usePaperReferential=e},_keepPaperCurrentPosition:function(e){var t=this._panToCenter.clone();this._panToCenter=e?new i.Vector2(this._usableAreaRect.left+.5*(this._usableAreaRect.width-this._viewportSize.x),this._usableAreaRect.top+.5*(this._usableAreaRect.height-this._viewportSize.y)):new i.Vector2(this._usableAreaWithoutPanelsRect.left+.5*(this._usableAreaWithoutPanelsRect.width-this._viewportSize.x),this._usableAreaWithoutPanelsRect.top+.5*(this._usableAreaWithoutPanelsRect.height-this._viewportSize.y)),this._pan=t.sub(this._panToCenter)},_shouldConsiderUsableArea:function(){if(!this._autoFit)return!1;var e=this._viewer.div.clientWidth;if(this.lastUsableAreaWidth&&this.lastUsableAreaWidth.width===e)return this.lastUsableAreaWidth.useUsableArea;var t=this._experienceBase.getManager("VCXGUIManager").getUIResponsivenessParameters(e);return t&&"boolean"==typeof t.fitBetweenPanels?(this.lastUsableAreaWidth||(this.lastUsableAreaWidth={}),this.lastUsableAreaWidth.width=e,this.lastUsableAreaWidth.useUsableArea=t.fitBetweenPanels,t&&t.fitBetweenPanels):null},updatePaper:function(t){var a={};if(t&&(t.viewportSize||t.fullFrame))this._fullFrame=!0,this._specificViewer=!0,t.viewportSize?this._viewportSize=new i.Vector2(t.viewportSize.x,t.viewportSize.y):this._viewportSize=new i.Vector2(this._viewer.div.clientWidth,this._viewer.div.clientHeight),a.top=0,a.left=0,a.width=this._viewportSize.x,a.height=this._viewportSize.y;else{this._fullFrame=!1,this._specificViewer=!1,this._viewportSize=new i.Vector2(this._viewer.div.clientWidth,this._viewer.div.clientHeight),this._usableAreaRect||(this._usableAreaRect={top:0,left:0,width:this._viewportSize.x,height:this._viewportSize.y},this._usableAreaWithoutPanelsRect={top:0,left:0,width:this._viewportSize.x,height:this._viewportSize.y});var n=this._shouldConsiderUsableArea();if(n?(a.top=this._usableAreaRect.top,a.left=this._usableAreaRect.left,a.width=this._usableAreaRect.width,a.height=this._usableAreaRect.height):(a.top=this._usableAreaWithoutPanelsRect.top,a.left=this._usableAreaWithoutPanelsRect.left+20,a.width=this._usableAreaWithoutPanelsRect.width-40,a.height=this._usableAreaWithoutPanelsRect.height),this._autoFit){var r=this.Ratio,s=a.height/a.width;this._viewportSize.y>0&&(this._zoom=r>s?a.height/this._viewportSize.y:a.width/this._viewportSize.x),this._pan=new i.Vector2}}this._autoFit?this._panToCenter=new i.Vector2(a.left+.5*(a.width-this._viewportSize.x),a.top+.5*(a.height-this._viewportSize.y)):this._autoFitDirty&&!1===this._autoFit&&this._keepPaperCurrentPosition(n),this._autoFitDirty=!1,this._updateCameraOffset(t),t&&t.propagateEvent&&(e.publish({event:"/VCX/Paper/PanChanged",data:{value:this.Pan,updatePaper:!1,autoFit:this._autoFit}}),e.publish({event:"/VCX/Paper/ZoomChanged",data:{value:this.Zoom,updatePaper:!1,autoFit:this._autoFit}}),this.updatePaperViz(),this._frameToRender=2)},_updateViewBox:function(){var e=this.Size,t=this._viewportSize.y/this._viewportSize.x,i=e.y/e.x;let a=t;this._usableAreaRect&&this._usableAreaWithoutPanelsRect&&(a=this._shouldConsiderUsableArea()?this._usableAreaRect.height/this._usableAreaRect.width:this._usableAreaWithoutPanelsRect.height/this._usableAreaWithoutPanelsRect.width),i>a?(this._ViewBoxSize.y=e.y,this._ViewBoxSize.x=this._ViewBoxSize.y/t,this._ViewBoxPxSize.y=this._viewportSize.y,this._ViewBoxPxSize.x=this._ViewBoxPxSize.y/i):(this._ViewBoxSize.x=e.x,this._ViewBoxSize.y=this._ViewBoxSize.x*t,this._ViewBoxPxSize.x=this._viewportSize.x,this._ViewBoxPxSize.y=this._ViewBoxPxSize.x*i),this._ViewBoxSize.multiplyScalar(1/this.Zoom),this._ViewBox.subVectors(e,this._ViewBoxSize).multiplyScalar(.5),this._ViewBoxPxSize.multiplyScalar(this.Zoom),this._ViewBoxPx.subVectors(this._viewportSize,this._ViewBoxPxSize).multiplyScalar(.5),this._ViewBoxPx.add(this.Pan),this._ViewBoxPx.add(this._panToCenter)},updatePaperViz:function(){var e=document.getElementById("divPaperSpace"),t=document.getElementById("divPaperSpaceTop"),i=document.getElementById("divPaperSpaceLeft"),a=document.getElementById("divPaperSpaceRight"),n=document.getElementById("divPaperSpaceBottom");if(null!==e){var r=this._ViewBoxPx.x,s=this._ViewBoxPx.y,o=this._ViewBoxPxSize.x,l=this._ViewBoxPxSize.y;e.style.left=r+"px",e.style.top=s+"px",e.style.width=(o>0?o:0)+"px",e.style.height=(l>0?l:0)+"px",t.style.left="0px",t.style.top="0px",t.style.width=(this._viewportSize.x>0?this._viewportSize.x:0)+"px",t.style.height=(s>0?s:0)+"px",i.style.left="0px",i.style.top=s+"px",i.style.width=(r>0?r:0)+"px",i.style.height=(l>0?l:0)+"px",n.style.left="0px",n.style.top=s+l+"px",n.style.width=this._viewportSize.x+"px",n.style.height=this._viewportSize.y-(s+l)+"px",a.style.left=r+o+"px",a.style.top=s+"px",a.style.width=this._viewportSize.x-(r+o)+"px",a.style.height=l+"px"}},_updateCameraOffset:function(e){this._updateViewBox();let t=this._viewer;if(e&&e.viewer&&(t=e.viewer),t){var i=t.currentViewpoint;if(i){let e={fullWidth:this._ViewBoxPxSize.x,fullHeight:this._ViewBoxPxSize.y,x:-this._ViewBoxPx.x,y:-this._ViewBoxPx.y,width:this._viewportSize.x,height:this._viewportSize.y};i.setViewOffset(e)}}},MMToPixelRatio:function(e){e||(e=this.getDefaultOptions());var t=this._viewportSize.y;return e&&e.viewer&&e.viewer._zoomFactor&&(t*=e.viewer._zoomFactor),t/this._ViewBoxSize.y},_GetPan:function(e){if(this._specificViewer||e&&e.viewer&&e.viewer._isDigger){e||(e=this.getDefaultOptions());var t=new i.Vector2;return this._specificViewer&&t.add(this._ViewBoxPx),t.sub(e.viewpoint.camera),t.sub(new i.Vector2(this._viewportSize.x,this._viewportSize.y).multiplyScalar(.5)),t.add(this._ViewBoxPxSize.clone().multiplyScalar(.5)),e.viewer._zoomFactor&&t.multiplyScalar(e.viewer._zoomFactor),t}return(new i.Vector2).addVectors(this.Pan,this._panToCenter)},UnitValueToPixel:function(e){return e*this.MMToPixelRatio()*.352778*window.devicePixelRatio},MMToPixel:function(e){return e*this.MMToPixelRatio()},MMToPixelX:function(e){var t=0;return t=(e-this._ViewBox.x)*this.MMToPixelRatio(),t+=this.Pan.x,t+=this._panToCenter.x},MMToPixelY:function(e){var t=0;return t=(e-this._ViewBox.y)*this.MMToPixelRatio(),t+=this.Pan.y,t+=this._panToCenter.y},MMToPixel2:function(e,t){e||(e=this.getDefaultOptions());var a=new i.Vector2(0,0);return a.subVectors(t,this._ViewBox).multiplyScalar(this.MMToPixelRatio(e)).add(this._GetPan(e)),a},PixelToMM:function(e){return e/this.MMToPixelRatio()},PixelToMMX:function(e){return(e-(this.Pan.x+this._panToCenter.x))/this.MMToPixelRatio()+this._ViewBox.x},PixelToMMY:function(e){return(e-(this.Pan.y+this._panToCenter.y))/this.MMToPixelRatio()+this._ViewBox.y},PixelToMM2:function(e,t){e||(e=this.getDefaultOptions());var a=new i.Vector2(0,0);return a.subVectors(t,this._GetPan(e)).multiplyScalar(1/this.MMToPixelRatio(e)).add(this._ViewBox),a},ModelToMM2:function(e,t){var a=e.viewpoint.project(t),n=new i.Vector2(0,0);n=this.PixelToMM2(e,a);var r=new i.Vector3(0,0,0);return r.x=n.x,r.y=n.y,r.z=a.z,r},MMToModel2:function(e,t){var a=new i.Vector2(0,0);a.x=t.x,a.y=t.y;var n=new i.Vector2(0,0);n=this.MMToPixel2(e,a);var r=new i.Vector3(0,0,0);return r.x=n.x,r.y=n.y,r.z=t.z,e.viewpoint.unProject(r)},GetMmToPxRatio:function(e){var t=new i.Vector2(0,0),a=new i.Vector2(1,0),n=this.MMToPixel2(e,t),r=this.MMToPixel2(e,a);return n.distanceTo(r)},GetModelToPixelRatio:function(e,t){let i=t.clone().add(e.viewpoint.getUpDirection()),a=t.clone().sub(e.viewpoint.getUpDirection());var n=e.viewpoint.project(i),r=e.viewpoint.project(a);return.5*n.distanceTo(r)},GetPaperRatio:function(e,t){e||(e=this.getDefaultOptions());var a=1;if(!t||null===t)return a;var n=(new i.Vector3).addVectors(t,e.viewpoint.getUpDirection()),r=this.ModelToMM2(e,t),s=this.ModelToMM2(e,n),o=t.distanceTo(n),l=r.distanceTo(s);return 0!==l&&(a=o/l),a},GetModelPointFromModelPointAndPaperPosition:function(e,t,a,n){var r,s=e.viewpoint.getSightDirection(),o=e.viewpoint.getUpDirection(),l=(new i.Vector3).crossVectors(s,o).normalize(),h=(new i.Vector3).crossVectors(s,l).normalize(),u=l.multiplyScalar(a.x),c=h.multiplyScalar(a.y),p=u.clone().add(c).normalize();if(n>0){var d=Math.min(this.Size.x,this.Size.y);(_=n/(g=this.GetPaperRatio(e,t)))<.04*d?_=.04*d:_>.7*d&&(_=.7*d),r=_*g}else{var _,g;r=(_=Math.sqrt(a.x*a.x+a.y*a.y))*(g=this.GetPaperRatio(e,t))}var m=p.multiplyScalar(r);return(new i.Vector3).addVectors(t,m)},setPaperVisibility:function(e){if(this._paperDiv){!0===e?this._paperDiv.style.display="":!1===e?this._paperDiv.style.display="none":console.log("[VCXPaperManager::setPaperVisibility] Parameter is not a boolean. Aborting.");var t=this._experienceBase.getManager("VCXContextManager").getActiveViewport();if(t){var i=t.QueryInterface("VCXIModifiable");if(i){i.OnChangePropertiesEnd();var a=i.QueryInterface("W3AISGNodeHolder");a&&a.setSGNodeDirty(!0)}}}},getPaperVisibility:function(){return!!this._paperDiv&&""===this._paperDiv.style.display},zoomPaper:function(e,t){var a=1+.05*e,n=.5*this._viewer.SCREEN_WIDTH,r=.5*this._viewer.SCREEN_HEIGHT;t.x>0&&t.x<this._viewer.SCREEN_WIDTH&&t.y>0&&t.y<this._viewer.SCREEN_HEIGHT&&(n=t.x,r=t.y);var s=.5*(this._ViewBoxPxSize.x>0?this._ViewBoxPxSize.x:0)+this._ViewBoxPx.x,o=.5*(this._ViewBoxPxSize.y>0?this._ViewBoxPxSize.y:0)+this._ViewBoxPx.y,l=a*(s-n)+n,h=a*(o-r)+r,u=this._pan.clone();u.add(new i.Vector2(l-s,h-o));var c=this.Zoom;this.Zoom*=a,c!==this.Zoom&&(this.Pan=u)}});return Object.defineProperty(a.prototype,"Pan",{enumerable:!0,get:function(){return this._fullFrame?new i.Vector2:this._pan},set:function(e){this._lock||this._pan.equals(e)||(this._pan=e,this._autoFitDirty=this._autoFit,this._autoFit=!1,this.updatePaper({propagateEvent:!0}))}}),Object.defineProperty(a.prototype,"Zoom",{enumerable:!0,get:function(){return this._fullFrame?1:this._zoom},set:function(e){this._lock||this._zoom!==e&&(this._zoom=e,this._zoom<=0&&(this._zoom=.01),this._autoFitDirty=this._autoFit,this._autoFit=!1,this.updatePaper({propagateEvent:!0}))}}),Object.defineProperty(a.prototype,"AutoFit",{enumerable:!0,get:function(){return this._autoFit},set:function(e){this._lock||(this._autoFitDirty=this._autoFit!==e,this._autoFit=e,this.updatePaper({propagateEvent:!0}))}}),Object.defineProperty(a.prototype,"Size",{enumerable:!0,get:function(){return new i.Vector2(this._PaperSize.x,this._PaperSize.y)}}),Object.defineProperty(a.prototype,"Ratio",{enumerable:!0,get:function(){var e=1;return this._PaperSize.x&&(e=this._PaperSize.y/this._PaperSize.x),e>1&&this._PaperSize.x>this._PaperSize.y?this._PaperSize.x/this._PaperSize.y:this._PaperSize.y/this._PaperSize.x}}),Object.defineProperty(a.prototype,"Lock",{enumerable:!0,get:function(){return this._lock},set:function(e){this._lock=e}}),Object.defineProperty(a.prototype,"componentType",{enumerable:!0,get:function(){return"VCXPaperManager"}}),a})),define("DS/VCXWebVisualization/VCXRulersUnitEnum",["require","exports","DS/Ruler/Ruler","DS/Ruler/AngularRuler"],(function(e,t,i,a){"use strict";var n;return function(e){let t,n;!function(e){e[e.Micrometers=i.MICRON_UNIT]="Micrometers",e[e.Millimeters=i.MM_UNIT]="Millimeters",e[e.Centimeters=i.CM_UNIT]="Centimeters",e[e.Meters=i.M_UNIT]="Meters",e[e.Kilometers=i.KM_UNIT]="Kilometers",e[e.Inches=i.INCH_UNIT]="Inches",e[e.Feet=i.FOOT_UNIT]="Feet",e[e.Yards=i.YARD_UNIT]="Yards"}(t=e.VCXLinearRulerUnitEnum||(e.VCXLinearRulerUnitEnum={})),function(e){e[e.Radians=a.RAD_UNIT]="Radians",e[e.Degrees=a.DEG_UNIT]="Degrees",e[e.Grades=a.GRAD_UNIT]="Grades",e[e.Turns=a.PERCENT_UNIT]="Turns"}(n=e.VCXAngularRulerUnitEnum||(e.VCXAngularRulerUnitEnum={}))}(n||(n={})),n})),define("DS/VCXWebVisualization/VCXVisuManager",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Plugins/UserRenderList","DS/Effects/SpatialOccupationEffect","DS/VCXWebVisibility/VCXIVisibility","DS/Visualization/SceneGraphUtils","DS/Visualization/Ambience","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/ApplicationFrame/CommandsManager","DS/VCXWebIO/VCXPixelImage","DS/Mesh/Mesh","DS/VCXWebSystem/VCXTextTools","DS/VCXWebVisu/VCXVisuTools","DS/VCXWebSystem/VCXHardwareServices","DS/VCXWebSystem/VCXCommandHelperEnum","DS/Visualization/ModelLoader","DS/Visualization/Node3D","i18n!DS/VCXWebVisualization/assets/nls/VCXWebVisualization","text!DS/VCXWebVisualization/assets/json/viewer_options.json","text!DS/VCXWebVisualization/assets/json/viewer_options_mobile.json","DS/VCXWebVisualization/VCXInteractor","DS/VCXWebKernel/VCXNotificationManager","DS/VCXWebSystem/VCXLockTable"],(function(e,t,i,a,n,r,s,o,l,h,u,c,p,d,_,g,m,M,f,C,b,x,V,v,y){"use strict";var S=e.extend({init:function(){this._onIdleSSAOCB=null,this._isInTransition=!1,this._CameraControlsViewpoint=!1,this._CameraEasingTime=5,this._modelLoaded=[],this._isNoShowSpaceRunning=!1,this._isNoShowSpaceRunningDirty=!1},getNonVisibleSpaceState:function(){return this._isNoShowSpaceRunning},setNonVisibleSpaceState:function(e){if(this._isNoShowSpaceRunning!==e){this._isNoShowSpaceRunning=e,this._isNoShowSpaceRunningDirty=!0;const t=this._experienceBase.getManager("VCXContextManager");if(t){const e=t.getMainViewer();e&&e.swapVisibleSpace()}}},postInitialize:function(){this._timerWithNoRefresh=0,this._idle=!1,this._idleCBs=[],this._idleIndex=1,this._helperNonVisibleSpaceName="VisibleSpace",this._activeViewport=null,this._bUpdateViewport=!0,this.CameraControlsViewpoint=!1,this._verticalFrame=new a.Matrix4,this._inverseVerticalFrame=new a.Matrix4,this._hideDecorationLock=new y;const e=this._experienceBase.getManager("VCXGUIManager").GetGUIComponentFromName("VCXGUICommandHelperManagerCtrl");e&&e.addCommandHelper(m.Type.DEFAULT,this._helperNonVisibleSpaceName),"1"==this._experienceBase.getManager("VCXContextManager").getUrlVars().fps&&this._experienceBase.getManager("VCXContextManager").getMainViewer().setDebugFPS(!0),this._experienceBase.getManager("VCXContextManager").getMainViewer().setOIT(!0),this._experienceBase.getManager("VCXContextManager").getMainViewer().setAllowMirror(!0),this._experienceBase.getManager("VCXContextManager").getMainViewer().setAllowDOF(!g.isLowEndGraphicDevice());var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();this._onViewpointToken=i.subscribe({event:"/VISU/"},(e=>{e&&e.viewpoint&&"@onViewpointChange"===e.eventType&&t===e.viewpoint.viewer&&(this.viewpointHasMovedRequested=!0)})),this._onSwapVisibleSpaceToken=t.onSwapVisibleSpace((async()=>{var e=this._experienceBase.getManager("VCXContextManager").getContext(),a=u.getCommand("VCXSwapVisibleSpace",e);a&&(a.getCheckState()&&!this.getNonVisibleSpaceState()?await a.disactivateCheck():!a.getCheckState()&&this.getNonVisibleSpaceState()&&await a.activateCheck());var n=u.getCommand("VCXDisplayLivePreviewRenderingCmd",e);n&&n.getCheckState()&&this.getNonVisibleSpaceState()&&await n.disactivateCheck();let r={};this.getNonVisibleSpaceState()?(r.requestedStep=m.Step.START,r.name=this._helperNonVisibleSpaceName,r.options={numberSteps:1,message:C["NonVisibleSpace.Message.Title"],noLabel:!0,infoMessage:C["NonVisibleSpace.Message.Information"]}):(r.requestedStep=m.Step.END,r.name=this._helperNonVisibleSpaceName),i.publish({event:"VCX/Cmd/Step",data:r}),this._isNoShowSpaceRunning?t.setVisuEnvOCA(localStorage.getItem("AmbienceNonVisibleSpace")||"BlueDesign"):this._experienceBase.ComponentsMap.GetComponentFromType("AmbienceModel_Spec").forEach((e=>{e.setDirty()}))})),this._onVisuAmbianceStateChangeToken=t.onVisuAmbianceStateChange&&t.onVisuAmbianceStateChange((()=>{this._ambienceProcessings&&(this._ambienceProcessings.resolve(),this._ambienceProcessings=null,this.showDecorations("AmbienceLoading",t))}),(()=>{if(!this._ambienceProcessings){this.hideDecorations("AmbienceLoading",t),this._ambienceProcessings=UWA.Promise.deferred();var e=this.QueryInterface("VCXIReadiness");e&&e.registerPromise(this._ambienceProcessings.promise)}}),(()=>{this._ambienceProcessings&&(this._ambienceProcessings.resolve(),this._ambienceProcessings=null,this.showDecorations("AmbienceLoading",t))})),this._experienceBase.getManager("VCXContextManager").isSupported("DefaultViewpointControler")&&window.widget&&(this._addNavigationPreferences(),this.SetController(window.widget.getValue("Mouse_Controls_Profile"),window.widget.getValue("Rotation_Rolling")),this._widgetEvents=window.widget.addEvents&&window.widget.addEvents({endEdit:e=>{e.submitted&&this._updateFromWidget()}})),this._previousAmbience=t.ambience,this._previousAmbience.isOCA&&(this._previousAmbienceOCA=t.getVisuEnv())},SetController:function(e,t){this._experienceBase.getManager("VCXContextManager").getMainViewer().currentViewpoint.getControl().setRotationRolling(t)},_updateFromWidget:function(){localStorage.setItem("DS_VCX_ROTATION_ROLLING",window.widget.getValue("Rotation_Rolling")),this.SetController(window.widget.getValue("Mouse_Controls_Profile"),window.widget.getValue("Rotation_Rolling"))},_addNavigationPreferences:function(){var e=localStorage.getItem("DS_VCX_ROTATION_ROLLING");e||(e=!1)},unInitialize:function(){this._activeViewport=null,this._defaultAmbiencePromise&&delete this._defaultAmbiencePromise,this._widgetEvents&&window.widget&&window.widget.removeEvents(this._widgetEvents),this._idleCBs=[],delete this._spatialOccupationEffect,this._onViewpointToken&&(i.unsubscribe(this._onViewpointToken),this._onViewpointToken=null);var e=this._experienceBase.getManager("VCXContextManager").getMainViewer();this._onVisuAmbianceStateChangeToken&&(e&&e.unsubscribeFromArray(this._onVisuAmbianceStateChangeToken),this._onVisuAmbianceStateChangeToken=null),this._previousAmbienceOCA?e&&e.setVisuEnvOCA(this._previousAmbienceOCA.replaceAll("OCA","")):this._previousAmbience&&e&&e.setAmbience(this._previousAmbience),this._previousAmbience=null,this._previousAmbienceOCA=null,e&&e.unsubscribe(this._onSwapVisibleSpaceToken),this.defaultAmbience&&(this.defaultAmbience.dispose(),this.defaultAmbience=null),this._defaultAmbiencePromise=null,this._modelLoaded=[]},getUpdatePriority:function(){return-7},addOnIdleCB:function(e,t){var i={};return t||(t=.5),i.time=t,i.idle=!1,i.cbFunction=e,i.id=this._idleIndex,this._idleIndex++,this._idleCBs.push(i),i.id},removeOnIdleCB:function(e){for(var t=0;t<this._idleCBs.length;t++)if(this._idleCBs[t].id===e)return this._idleCBs.splice(t,1),!0;return!1},setUpdateViewport:function(e){this._bUpdateViewport=e},setUsableInteractors:function(e){V.enableInteractors=e},getUpdateViewport:function(){return this._bUpdateViewport},setTransitionMode:function(e){this._isInTransition=e},isInTransitionMode:function(){return this._isInTransition},setTileOutput:function(e){this._isInTileMode=e},setVertical:function(e){var t=new a.Vector3(1,0,0),i=new a.Vector3(0,1,0),n=new a.Vector3(0,0,1);switch(e){case 0:t.set(0,1,0),i.set(0,0,1),n.set(1,0,0);break;case 1:t.set(0,0,1),i.set(1,0,0),n.set(0,1,0);break;case 2:break;case 3:t.set(0,0,1),i.set(0,1,0),n.set(-1,0,0);break;case 4:t.set(1,0,0),i.set(0,0,1),n.set(0,-1,0);break;case 5:t.set(0,1,0),i.set(1,0,0),n.set(0,0,-1)}return this._verticalFrame.makeBasis(t,i,n),this._inverseVerticalFrame.getInverse(this._verticalFrame),this._verticalFrame},getMatrixToAdjustVertical:function(e){return this._verticalFrame},getInverseMatrixToAdjustVertical:function(e){return this._inverseVerticalFrame},getOccupationGrid:function(e,t,i){var a=this._experienceBase.getManager("VCXContextManager").getRootNode();if(a&&(a._PassToCheckAvailableSpaceAdded||(a._PassToCheckAvailableSpaceAdded=!0,a.setRenderPasses(["main","PassToCheckAvailableSpace"]))),this._previousSizeX===e&&this._previousSizeY===t||(this._previousSizeX=e,this._previousSizeY=t,this._spatialOccupationEffect=new r(i,{targetWidth:e,targetHeight:t,name:"PassToCheckAvailableSpace"})),this._spatialOccupationEffect){i.renderer.renderer.materialToUse=0;var n=this._experienceBase.getManager("VCXPaperManager");n.updatePaper({viewportSize:{x:this._previousSizeX,y:this._previousSizeY}});var s=this._spatialOccupationEffect.renderResult({flipImage:!1});return n.updatePaper(),i.currentViewpoint.camera._hasChanged=!1,s}},isInFrustum:function(e,t){if(this._isInTileMode)return!0;var i=!0;if(t.GetPropertyValue("Collab.HideIfOutsideAnchorFrustrum")){i=!1;var n=new a.Frustum;return n.setFromMatrix((new a.Matrix4).multiplyMatrices(e.viewpoint.camera.projectionMatrix,e.viewpoint.camera.matrixWorldInverse)),t.processAnchorsIDs(((r,o)=>{if(o){var l=!0,h=o.GetValueLink().Value;if(h){var u=this._experienceBase.ComponentsMap.GetComponentFromID(h);if(u){var c=u.QueryInterface("VCXIVisibility");c&&c.GetVisibility()===s.EVisState.Hidden&&(l=!1)}}if(l){var p=t.GetAnchorWorldMatrix(r,e);if(p&&n.containsPoint((new a.Vector3).getPositionFromMatrix(p)))return i=!0,!1}}})),i}return i},areAllAnchorsReadyAndVisible:function(e,t){let i=!0;return t.processAnchorsIDs(((a,n)=>{if(n){var r=n.GetValueLink().Value;if(r&&r!==t.GetObject().GetID()){var o=this._experienceBase.ComponentsMap.GetComponentFromID(r);if(o){const t=o.QueryInterface("W3AISGNodeHolder");if(t&&t.getPathElement()){var l=o.QueryInterface("VCXIVisibility");l&&(i=l.GetVisibility()!==s.EVisState.Hidden&&_.buildGraphicPropertiesStructure(o,null,e&&e.viewer,{getVisibility:!0})[0].visible.Visibility)}else i=!1}}}return i})),i},getRenderList:function(e){var t=this._experienceBase.getManager("VCXContextManager").getFrameWindow();return t?(t._renderList||(t._renderList={}),t._renderList[e]||(t._renderList[e]=new n(e)),t._renderList[e]):null},createViewerLayers:function(e){e.setPickingMode("@Edge",p.PICK_VISIBLE);var t=e.getUserPassManager();if(t){var i,a,n,r={};i="VCXBackground",(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setEnableStencilTest(!1),n.setEnableStencilWrite(!1),n.setDisableColorWrite(!1),n.setDisableBackFaceCulling(!1),n.setDisableDepthWrite(!0),n.setDepthFunc("ALWAYS"),r[i]=n),i="VCXBackground2DDressups",(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setEnableStencilTest(!1),n.setEnableStencilWrite(!1),n.setDisableColorWrite(!1),n.setDisableBackFaceCulling(!1),n.setDisableDepthWrite(!0),n.setDepthFunc("ALWAYS"),r[i]=n),i="VCXGround",(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setEnableStencilTest(!1),n.setEnableStencilWrite(!1),n.setDisableColorWrite(!1),n.setDisableBackFaceCulling(!1),n.setDisableDepthWrite(!0),n.setDepthFunc("ALWAYS"),r[i]=n),i="VCXBackground3DDressups",(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setEnableStencilTest(!1),n.setEnableStencilWrite(!1),n.setDisableColorWrite(!1),n.setDisableBackFaceCulling(!1),n.setDisableDepthWrite(!0),n.setDepthFunc("ALWAYS"),r[i]=n),i="VCXOc3DDressups",(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n),a="VCXPreNOc3DDressups",i="VCXNOc3DDressups",(n=t.createUserClearPass(a,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setClearStencil(!0),n.setClearDepth(!0),r[a]=n),(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n),a="VCXPreRaytracing",i="VCXRaytracing",(n=t.createUserClearPass(a,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setClearStencil(!1),n.setClearDepth(!0),r[a]=n),(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n),a="VCXPre2DDressups",i="VCX2DDressups";var s="VCX2DDressups2";(n=t.createUserClearPass(a,this.getRenderList(a)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setClearStencil(!0),n.setClearDepth(!0),r[a]=n),(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n),(n=t.createUserRenderPass(s,this.getRenderList(s)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[s]=n),a="VCXPre3DManipulators",i="VCX3DManipulators",(n=t.createUserClearPass(a,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setClearStencil(!1),n.setClearDepth(!0),r[a]=n),(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n),a="VCXPreManipulators",i="VCXManipulators",(n=t.createUserClearPass(a,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setClearStencil(!1),n.setClearDepth(!0),r[a]=n),(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n),a="VCXPreForeground",i="VCXForeground",(n=t.createUserClearPass(a,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),n.setClearStencil(!1),n.setClearDepth(!0),r[a]=n),(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n),i="VCXNoAADressups",(n=t.createUserRenderPass(i,this.getRenderList(i)))&&(n._passes[0].setScene(e.internalSceneGraph.scene),r[i]=n);var o=t.getSystemPass("main"),l=t.getSystemPass("infinitePlane"),h=t.getSystemPass("noEffectNoz"),u=t.getSystemPass("canvas2D");u._list="canvas2D",t.insertUserPassBeforePass(r.VCXGround,l),t.insertUserPassBeforePass(r.VCXBackground,r.VCXGround),t.insertUserPassAfterPass(r.VCXBackground2DDressups,l),t.insertUserPassAfterPass(r.VCXBackground3DDressups,r.VCXBackground2DDressups),t.insertUserPassAfterPass(r.VCXOc3DDressups,o),t.insertUserPassAfterPass(r.VCXPreRaytracing,r.VCXOc3DDressups),t.insertUserPassAfterPass(r.VCXRaytracing,r.VCXPreRaytracing),t.insertUserPassAfterPass(r.VCXPreNOc3DDressups,r.VCXRaytracing),t.insertUserPassAfterPass(r.VCXNOc3DDressups,r.VCXPreNOc3DDressups),t.insertUserPassAfterPass(r.VCXPre2DDressups,h),t.insertUserPassAfterPass(r.VCX2DDressups,r.VCXPre2DDressups),t.insertUserPassAfterPass(r.VCX2DDressups2,r.VCX2DDressups),t.insertUserPassAfterPass(r.VCXPre3DManipulators,r.VCX2DDressups2),t.insertUserPassAfterPass(r.VCX3DManipulators,r.VCXPre3DManipulators),t.insertUserPassAfterPass(r.VCXNoAADressups,u),t.insertUserPassAfterPass(r.VCXPreManipulators,r.VCXNoAADressups),t.insertUserPassAfterPass(r.VCXManipulators,r.VCXPreManipulators),t.insertUserPassAfterPass(r.VCXPreForeground,r.VCXManipulators),t.insertUserPassAfterPass(r.VCXForeground,r.VCXPreForeground),e.setPickingPriority([{id:"VCXMagnetCenterActive",priority:90},{id:"VCXMagnetPointActive",priority:80},{id:"VCXMagnetAxisActive",priority:70},{id:"VCXMagnetLineActive",priority:60},{id:"VCXMagnetCircleActive",priority:55},{id:"VCXMagnetPlaneActive",priority:10},{id:"VCXMagnetCenter",priority:50},{id:"VCXMagnetPoint",priority:40},{id:"VCXMagnetAxis",priority:30},{id:"VCXMagnetLine",priority:20},{id:"VCXMagnetCircle",priority:15},{id:"VCXMagnetPlane",priority:10},{id:"VCXDressup",priority:7},{id:"VCXSection",priority:-10},{id:"VCXMagnetGrid",priority:5}]),e._VCXLayersCreated=!0}},update:function(e){this._parent(e),this._isNoShowSpaceRunningDirty&&(this._isNoShowSpaceRunningDirty=!1);var t=this._experienceBase.getManager("VCXContextManager");t.applyToViewers((e=>{e._VCXLayersCreated||this.createViewerLayers(e)})),this.viewpointHasMoved=this.viewpointHasMovedRequested;var i=e.viewpoint.control.update();if(this.viewpointHasMoved|=i,this.viewpointHasMovedRequested=!1,this.viewpointHasMoved&&t.getActiveViewport()){var a=t.getActiveViewport().QueryInterface("VCXIViewpointController");a&&a.fromViewpoint()}this._renderPriorityDirty&&this.activateRenderPriorityIfNeeded()},dirtifyRenderPriority:function(){this._renderPriorityDirty=!0},setTransparentBackground:function(e){var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();e?(t.ambience.getBackground().setActivated(!1),t.setGrid(!1),t.setBackgroundColor("rgb(0,0,0)","0"),this._transparentBackground=!0):(t.removeAmbience(),t.restoreAmbiance(),this._transparentBackground=!1)},showDecorations:function(e,t,a){this._hideDecorationLock.unlock(e),this._hideDecorationLock.isLock()||i.publish({event:"VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION",data:{Source:e,viewer:t}}),a&&t.render()},hideDecorations:function(e,t,a){let n=this._hideDecorationLock.isLock();this._hideDecorationLock.lock(e),n||i.publish({event:"VCX_TEMPORARILY_HIDE_DECORATION",data:{Source:e,viewer:t}}),a&&t.render()},updateGroundPosition:function(e){var t=this._experienceBase.getManager("VCXContextManager");if(t&&t.getMainViewer()){var n={},r=!1;if(e&&e.radius>0?(n.groundSize=2*e.radius,n.ambienceGroundSize=e.radius):r=!0,e&&e.position?n.groundCenter=e.position:r=!0,r){var s=t.getRootPathElement();if(s){var l=o.getOrientedBoundingBoxFromPathElements([s],new a.Matrix4,t.getMainViewer());l&&!isNaN(l.cornerPoint.x)&&(e&&e.radius>0||(n.groundSize=3*Math.max(l.firstAxis.x,l.secondAxis.y),n.ambienceGroundSize=20*n.groundSize),e&&e.position||(n.groundCenter=new a.Vector3(l.cornerPoint.x+.5*l.firstAxis.x,l.cornerPoint.y+.5*l.secondAxis.y,l.cornerPoint.z)))}}e&&e.ambience&&(n.groundCenter&&e.ambience.setGroundPosition(n.groundCenter),n.ambienceGroundSize&&e.ambience.setGroundRadius(n.ambienceGroundSize)),t.applyToViewers((function(e){e.setAutomaticPlaneUpdate(!1),e.setGroundOptions(n)})),i.publish({event:"VCX_GROUND_UPDATE_AUTO"})}},setDefaultAmbienceOptions:function(e){this.defaultAmbienceOptions=e},activateDefaultAmbience:function(e){var n=this._experienceBase.getManager("VCXContextManager");if(n&&"0"==n.getUrlVars().ambience)return UWA.Promise.resolve();var r="3DEXCITE";for(var s in S.EDefaultAmbience)if(S.EDefaultAmbience[s]===e){r=s;break}if("3DEXCITE"===r){if(!this._defaultAmbiencePromise){var o=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.requestedMap,h=t.getWebappsAssetUrl(this.defaultAmbienceOptions&&this.defaultAmbienceOptions.baseModule,this.defaultAmbienceOptions&&this.defaultAmbienceOptions.baseFolder),u=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasIBL,c=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasRoughness,p=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasBackGround,d=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasGround,_=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.is3dxc;let e=null;if(e=new Promise(_?(e,t)=>{var i=new M;i.setFileType("3dxc"),i.setOnLoadedCallback((function(t){e(t.ambiance)})),i.loadModel(h+o+".3dxc",new f)}:e=>{var t=UWA.Promise.deferred(),i=UWA.Promise.deferred(),r=UWA.Promise.deferred(),s=new l({viewer:n.getMainViewer()});if(s.keepIBLTexture=!1,s.keepBackgroundTexture=!1,u){var d=h+o+"/"+o+".hdr",_=d?a.ImageUtils.loadHDRTexture(d,new a.LatLongReflectionMapping,void 0,void 0,void 0,void 0,void 0,!1):null;s.setIblMap({texture:_,generateRoughnessMap:!c,doneCallback:()=>{t&&t.resolve()}})}else t.resolve();if(c){var g=h+o+"/"+o+"_rmips.hdr",m=g?a.ImageUtils.loadHDRTexture(g,new a.LatLongReflectionMapping,void 0,void 0,void 0,void 0,void 0,!1):null;s.setRoughnessMap({texture:m,hasDiffuse:!0,doneCallback:()=>{i&&i.resolve()}})}else i.resolve();if(p){var M=h+o+"/"+o+"_BG.hdr",f=M?a.ImageUtils.loadHDRTexture(M,new a.LatLongEnvMapping,void 0,void 0,void 0,void 0,void 0,!1):null;s.setBackGroundMap({texture:f,mapping:new a.LatLongEnvMapping,hdr:!0,doneCallback:()=>{r.resolve()}})}else r.resolve();UWA.Promise.all([t.promise,i.promise,r.promise]).then((()=>e(s)))}),!e)throw new Error("Error with ambience settings");this._defaultAmbiencePromise=e.then((e=>{if(e.setFiniteMode(!1),!n.getActiveGround()&&d){var t={planeMirror:!0,blurryMirror:!0};e.setGroundOptions(t),e.setGroundReflectivitiy(.35),e.setGroundGlossiness(.25)}return e}));var g=this.QueryInterface("VCXIReadiness");g&&g.registerPromise(this._defaultAmbiencePromise),this._experienceBase.getManager("VCXNotificationManager").addProgressNotification({strObjectName:C["ProgressNotification.DefaultAmbience"],strAction:C["ProgressNotification.Loading"],maskDisplayAdd:v.FDisplayMode.CONSOLE,iPromise:this._defaultAmbiencePromise})}return this._defaultAmbiencePromise.then((e=>{let t=this._experienceBase.getManager("VCXContextManager").getActiveViewport();if(!t||!t.QueryInterface("VCXIModifiable").GetPropertyValue("Viewport.ActiveAmbience")){if(!n._experienceBase.isValid)return console.error(new Error("Experience not valid anymore")),void e.dispose();this.requestSetAmbience(e,!1),this._transparentBackground&&this.setTransparentBackground(!0),i.publish({event:"VCX_ENVIRONNEMENT_PROPERTY_CHANGED"}),this.defaultAmbience=e;var a=this.QueryInterface("VCXIReadiness");return a?a.isReady():UWA.Promise.resolve()}})),this._defaultAmbiencePromise}n.applyToViewers((e=>{e.setVisuEnvOCA(r)}))},requestSetAmbience(e,t){var i=this._experienceBase.getManager("VCXContextManager");i.getMainViewer().removePlaneV2(),i.applyToViewers((a=>{a.setAmbience(e,t),this.updateGroundPosition({ambience:e}),i.getActiveGround()&&i.getActiveGround().update(),i.getActiveViewport()&&i.getActiveViewport().update({force:!0}),a.render()}))},activateRenderPriorityIfNeeded:function(){this._renderPriorityDirty=!1;var e=this._experienceBase.getManager("VCXContextManager"),t=e.getMainViewer(),i=!1;e.getActiveViewport().renderMode===h.ERenderingMode.Custom&&this.hasOnePartRenderPriorityDifferentFromCentral()&&(i=!0),t.setRenderPriority&&(i?(t.setSectionCapping(!1),t.setRenderPriority(!0)):(t.setSectionCapping(!0),t.setRenderPriority(!1)),t.setRenderPriorityDefaultOpacity(.5),o.setRenderPriority(e.getRootPathElement(),2,t))},hasOnePartRenderPriorityDifferentFromCentral:function(){var e=this._experienceBase.getManager("VCXContextManager").getRootComponent();if(e){var t=e.QueryInterface("VCXIModelNavigable"),i=!1;t.traverse(((e,t,a)=>{Number.isInteger(e.GetObject().priority)&&2!==e.GetObject().priority&&(i=!0,a.stop=!0)}),void 0,{}),this._priorityDifferentFromCentral=i}return this._priorityDifferentFromCentral},postUpdate:function(e){this._parent(e),this.viewpointHasMoved=!1},load3DXMLModel:function(e,i){if(this._modelLoaded[e])return this._modelLoaded[e];if(!i)return null;let a=new f,n=t.getWebappsAssetUrl(i.module,i.path);i.callBackCreation&&i.callBackCreation(a);var r=new M;return r.setFileType("3dxml"),r.loadModel(n,a),this._modelLoaded[e]=a,a}});return S.getViewerOptions=function(){return g.isLowEndGraphicDevice()?(console.log("getViewerOptions :  MODE MOBILE"),JSON.parse(x)):(console.log("getViewerOptions :  MODE DESKTOP"),JSON.parse(b))},Object.defineProperty(S.prototype,"CameraControlsViewpoint",{enumerable:!0,get:function(){return this._CameraControlsViewpoint},set:function(e){this._CameraControlsViewpoint=e}}),Object.defineProperty(S.prototype,"CameraEasingTime",{enumerable:!0,get:function(){return this._CameraEasingTime},set:function(e){this._CameraEasingTime=null===e?5:e}}),Object.defineProperty(S.prototype,"componentType",{enumerable:!0,get:function(){return"VCXVisuManager"}}),Object.defineProperty(S.prototype,"HasViewpointMoved",{enumerable:!0,get:function(){return this.viewpointHasMoved}}),S.EDefaultAmbience={Basic:10,WhiteDesign:20,BlueDesign:30,DarkDesign:40,Studio:50,PureWhite:60,WhiteExperience:70,WhiteMirror:80,WhiteReview:90,DarkMirror:100,DarkReview:110,Outdoor:120,Indoor:130,City:140,Road:150,"3DEXCITE":1e4},S})),define("DS/VCXWebVisualization/VCXMaterialManager",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderStyle","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/Visualization/PathElement","UWA/Class","DS/CoreEvents/Events","DS/WebappsUtils/WebappsUtils","DS/VCXWebSystem/VCXEnums","DS/VCXWebVisualization/VCXImageManager","DS/Visualization/MaterialManager","DS/VCXWebSystem/VCXMutex"],(function(e,t,i,a,n,r,s,o,l,h,u){"use strict";var c=n.extend({initialize:function(){this._renderStyles=new Map,this._materialsPhong=new Map,this._materialsBasic=new Map,this._materialsLineBasic=new Map,this._materialsPoint=new Map,this._materialsCustom=new Map,this._materialsDetails={},this._materialsActors=[],this._materialFlat=null,this._imagesCacheSize=10,this._imagesCache=[],this._nTexturesLoading=0,this._cbTextureLoaded=null,this._isDirty=!1,this._materialInfoMap={},this._materialInternalMutex=new u},_releaseTexture:function(e){e&&e.dispose&&(e.dispose(),e=null)},_releaseMaterials:function(e){e&&e.size&&(e.forEach((function(e,t){e&&e.dispose&&e.dispose()})),e.clear(),e=null)},unInitialize:function(){this._releaseMaterials(this._renderStyles),this._releaseMaterials(this._materialsPhong),this._releaseMaterials(this._materialsBasic),this._releaseMaterials(this._materialsLineBasic),this._releaseMaterials(this._materialsPoint),this._releaseMaterials(this._materialsCustom),this._releaseTexture(this._materialFlat),this._imagesCacheSize=0,this._imagesCache=null,this.materialManager=null,this._nTexturesLoading=0,this._cbTextureLoaded=null,this._materialsActors=null,this._materialInfoMap={}},loadMaterialFromPath:function(t,i){return e.ImageUtils.loadTexture(s.getWebappsAssetUrl(t,i),void 0,void 0,void 0,!1)},postInitialize:function(){this.materialManager=new h},_findTextureInCache:function(e,t){if(this._imagesCache)for(var i=0;i<this._imagesCache.length;++i){var a=this._imagesCache[i];if(a.iDocID===e&&a.iEffect===t)return a.texture}return null},_addTextureToCache:function(e,t,i){if(this._imagesCache){var a={iDocID:e,iEffect:t,texture:i};this._imagesCache.length<this._imagesCacheSize?this._imagesCache[this._imagesCache.length]=a:(this._imagesCache=this._imagesCache.slice(1,this._imagesCacheSize),this._imagesCache[this._imagesCacheSize-1]=a)}},getRenderStyle:function(e,a,n){var r=e+"_"+a+"_"+(n?1:0),s=this._renderStyles.get(r);if(!s){let o=!0,l=!0,h="MATERIAL";switch((s=new t).setRenderMode("Face",!0),e){case i.ERenderingMode.Custom:case i.ERenderingMode.Smooth:o=!1,l=!1;break;case i.ERenderingMode.SmoothOutline:l=!1;break;case i.ERenderingMode.Silhouette:h="ZONLY"}s.setFaceMode(h),s.setRenderMode("Outline",l),o?(s.setRenderMode("InternalSharpEdge",!0),s.setRenderMode("InternalSmoothEdge",a===i.EOutlineType.Construction),s.setRenderMode("BoundaryEdge",a===i.EOutlineType.Smart),s.setOutlineWidth(2)):(s.setRenderMode("InternalSharpEdge",!1),s.setRenderMode("InternalSmoothEdge",!1),s.setRenderMode("BoundaryEdge",!1)),s.setRenderMode("WireEdge",n),s.setRenderMode("InfiniteFace",n),s.setRenderMode("AxisSystem",n),this._renderStyles.set(r,s)}return s},getMaterialPoint:function(t,i,a){var n=t.getHex()+"|"+i+"|"+a,r=this._materialsPoint.get(n);return void 0===r&&((r=new e.ParticleBasicMaterial({color:t,opacity:i,size:a,sizeAttenuation:!1})).force=!0,this._materialsPoint.set(n,r)),r},getMaterialLine:function(t,i,a){var n=t.getHex()+"|"+i+"|"+a,r=this._materialsLineBasic.get(n);return void 0===r&&((r=new e.LineBasicMaterial({color:t,opacity:i,dashSize:0,gapSize:0,side:e.DoubleSide,polygonBorderMode:!0})).setLineWidth(a),r.force=!0,this._materialsLineBasic.set(n,r)),r},getMaterialBasic:function(t,i){var a=t.getHex()+"|"+i,n=this._materialsBasic.get(a);return void 0===n&&((n=new e.MeshBasicMaterial({color:t,opacity:i})).force=!0,this._materialsBasic.set(a,n)),n},getMaterialPhong:function(t,i,a){var n="";a&&(n=a);var r=t.getHex()+"|"+i+"|"+n,s=this._materialsPhong.get(r);if(void 0===s&&((s=new e.PhysicalMaterial({color:new e.Color(t.getHex()),opacity:i,side:e.DoubleSide,specular:new e.Color(16777215),roughness:1,metalness:0,force:!0})).line=new e.LineBasicMaterial({color:new e.Color(65280),lineWidth:1,opacity:1}),s.point=new e.ParticleBasicMaterial({color:new e.Color(16711680),size:1,opacity:1}),this._materialsPhong.set(r,s),a)){var o=e.ImageUtils.loadTexture(a,e.UVMapping);o.wrapS=e.RepeatWrapping,o.wrapT=e.RepeatWrapping,o.repeat.set(1,1),o.needsUpdate=!0,s.map=o,s.force=!0,s.update=!0,s.needsUpdate=!0}return s},getMaterialFlat:function(){return this._materialFlat||(this._materialFlat=new e.MeshBasicMaterial({NRECompatibility:!0,side:e.DoubleSide}),this._materialFlat.name="Flat"),this._materialFlat},createMaterial:function(t){return t._envID,new e.PhysicalMaterial({NRECompatibility:!0,side:e.DoubleSide,force:!0})},getSharedMaterial:function(e){var t=e._envID+"|"+e._textureDocID,i=this._materialsCustom.get(t);if(!i){switch(i=this.createMaterial(e),e._envID){case o.EnvironmentalId.None:case o.EnvironmentalId.PLM:i.color=o.Color.Black,i.specular=o.Color.White,i.roughness=1,i.metalness=0,i.name="None"}this._materialsCustom.set(t,i)}return i},isTextureVisible:function(e){switch(e){case o.EnvironmentalId.None:case o.EnvironmentalId.PLM:return!0}return!1},getBboxInNewBasis:function(t,i){var a=(new e.Matrix4).getInverse(t),n=new e.Vector3(i.min.x,i.min.y,i.min.z);n.applyMatrix4(a);var r=n.x,s=n.x,o=n.y,l=n.y,h=n.z,u=n.z;r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z),n.x=i.min.x,n.y=i.min.y,n.z=i.max.z,n.applyMatrix4(a),r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z),n.x=i.min.x,n.y=i.max.y,n.z=i.min.z,n.applyMatrix4(a),r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z),n.x=i.min.x,n.y=i.max.y,n.z=i.max.z,n.applyMatrix4(a),r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z),n.x=i.max.x,n.y=i.min.y,n.z=i.min.z,n.applyMatrix4(a),r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z),n.x=i.max.x,n.y=i.min.y,n.z=i.max.z,n.applyMatrix4(a),r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z),n.x=i.max.x,n.y=i.max.y,n.z=i.min.z,n.applyMatrix4(a),r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z),n.x=i.max.x,n.y=i.max.y,n.z=i.max.z,n.applyMatrix4(a),r>n.x?r=n.x:s<n.x&&(s=n.x),o>n.y?o=n.y:l<n.y&&(l=n.y),h>n.z?h=n.z:u<n.z&&(u=n.z);var c=new e.Box3;return c.min.x=r,c.min.y=o,c.min.z=h,c.max.x=s,c.max.y=l,c.max.z=u,c},getBbox:function(e){if(!e)return null;var t=e.QueryInterface("W3AISGNodeHolder").getPathElement();if(!t||void 0===t||!t.externalPath.length)return null;for(var i=new a,n=0;n<t.externalPath.length;++n)i.addElement(t.externalPath[n]);for(var r=i.getLastElement();r&&(!(r=r.children.length?r.children[0]:null)||(i.addElement(r),"InstanceRep"!==r.getNodeType())););var s=this._experienceBase.getManager("VCXContextManager").getMainViewer();return i.getBoundingBox(null,s)},doTextureUV:function(t,i){var a=t._textureProjectionMatrix||new e.Matrix4,n=new e.Matrix3,r=t._textureUVMatrix||new e.Matrix4;n.set(r.elements[0],r.elements[1],0,r.elements[4],r.elements[5],0,0,0,1),i.setMappingOperator(t._textureProjectionType,a,n,!0)},doTextureMappingPlanar:function(t,i){if(t){t.QueryInterface("W3AISGNodeHolder").getPathElement(),this._experienceBase.getManager("VCXContextManager").getMainViewer();var a=this.getBbox(t),n=1,r=1,s=1;r=n=t._textureUVscale<50?1+(50-t._textureUVscale)/2:1-(t._textureUVscale-50)/50,s=n;r*=t._textureUVratio<=50?t._textureUVratio/50:1+(t._textureUVratio-50)/5;var o=t._textureProjectionMatrix||new e.Matrix4,l=this.getBboxInNewBasis(o,a),h=l.max.x-l.min.x;h>0&&(n/=h);h=l.max.y-l.min.y;h>0&&(r/=h);h=l.max.z-l.min.z;h>0&&(s/=h);var u=(new e.Matrix4).copy(o);u.elements[12]=.5*(a.max.x+a.min.x),u.elements[13]=.5*(a.max.y+a.min.y),u.elements[14]=.5*(a.max.z+a.min.z),u=(new e.Matrix4).getInverse(u);var c=new e.Matrix4;c.scale(new e.Vector3(n,r,s)),u=(new e.Matrix4).multiplyMatrices(c,u);var p=new e.Matrix3,d=t._textureUVMatrix||new e.Matrix4;p.set(d.elements[0],d.elements[1],0,d.elements[4],d.elements[5],0,0,0,1);var _=new e.Matrix3;_.set(1,0,.5-d.elements[12],0,1,.5-d.elements[13],0,0,1);var g=(new e.Matrix3).multiplyMatrices(p,_);i.setMappingOperator(t._textureProjectionType,u,g,!0)}},doTextureMappingSpherical:function(t,i){if(t){var a=t.QueryInterface("W3AISGNodeHolder").getPathElement().getLastElement().getBoundingBox(),n=1,r=1,s=1;r=n=t._textureUVscale<50?1+(50-t._textureUVscale)/2:1-(t._textureUVscale-50)/50,s=n;r*=t._textureUVratio<=50?t._textureUVratio/50:1+(t._textureUVratio-50)/5;var o=(new e.Matrix4).makeRotationZ(Math.PI/2),l=t._textureProjectionMatrix||new e.Matrix4,h=(new e.Matrix4).multiplyMatrices(l,o),u=this.getBboxInNewBasis(h,a),c=Math.max(Math.max(u.max.x-u.min.x,u.max.y-u.min.y),u.max.z-u.min.z),p=c*Math.sqrt(2);p>0&&(n/=p);p=c*Math.sqrt(2);p>0&&(r/=p);p=c*Math.sqrt(2);p>0&&(s/=p),h.elements[12]=.5*(a.max.x+a.min.x),h.elements[13]=.5*(a.max.y+a.min.y),h.elements[14]=.5*(a.max.z+a.min.z),h=(new e.Matrix4).getInverse(h);var d=new e.Matrix4;d.scale(new e.Vector3(n,r,s)),h=(new e.Matrix4).multiplyMatrices(d,h);var _=new e.Matrix3,g=t._textureUVMatrix||new e.Matrix4;_.set(g.elements[0],g.elements[1],0,g.elements[4],g.elements[5],0,0,0,1);var m=new e.Matrix3;m.set(1,0,.5-g.elements[12],0,1,.5-g.elements[13],0,0,1);var M=(new e.Matrix3).multiplyMatrices(_,m);i.setMappingOperator(t._textureProjectionType,h,M,!0)}},applyTexture:function(t,i,a){i._textureBorderMode?(a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping):(a.wrapS=e.ClampToEdgeWrapping,a.wrapT=e.ClampToEdgeWrapping),a.repeat.set(1,1),a.needsUpdate=!0,t.map=a,t.needsUpdate=!0,t.updateDeferredMaterials()},loadTexture:function(t,i,a,n){var r=this._findTextureInCache(t._textureDocID,n);if(r)return this.applyTexture(i,t,r),UWA.Promise.resolve(r);var s=this._experienceBase.getManager("VCXImageManager");if(!s)return UWA.Promise.reject(new Error("No VCXImageManager"));this._nTexturesLoading++;var o=this;return s.GetImageFromDocID(t._textureDocID,n).then((function(a){o._nTexturesLoading--;var r=o._findTextureInCache(t._textureDocID,n);if(r)return o.applyTexture(i,t,r),r;var s=a.toDataURL("image/png"),l=UWA.Promise.deferred(),h=e.ImageUtils.loadTexture(s,{},(function(e){o.applyTexture(i,t,e),o._cbTextureLoaded&&o._cbTextureLoaded(e,o._nTexturesLoading),l.resolve(e)}));return o._addTextureToCache(t._textureDocID,n,h),l.promise}))},hasTexturesLoading:function(){return this._nTexturesLoading>0},setMaterialAttributesFromOccurrence:function(t,a){if(a){var n=this.getSharedMaterial(t);if(n&&(a.color=n.color.clone(),a.specular=n.specular.clone(),a.normalMap=n.normalMap,a.metalnessMap=n.metalnessMap,a.roughnessMap=n.roughnessMap,a.glossinessMap=n.glossinessMap,a.specularMap=n.specularMap,a.transparent=n.transparent,a.metalness=n.metalness,a.shininess=n.shininess,a.glossiness=n.glossiness,a.roughness=n.roughness,a.specularContrib=n.specularContrib,a.transparent=n.transparent,a.NRECompatibility=n.NRECompatibility,a.side=n.side),this.isTextureVisible(t._envID)){var r=this._experienceBase.getManager("VCXDocManager"),s=null;r&&(s=r.GetPropPath(t._textureDocID));var h=null;s&&(h=s.GetValueURL());var u=null;if(h&&(u=h.Value),u){var c=l.Effect.RedimensionPower2;t.localColor&&(a.diffuseMulCoef=new e.Vector3(t.localColor.r,t.localColor.g,t.localColor.b)),a.diffuseAddCoef=new e.Vector3(0,0,0),t._textureTransparency?(a.transparent=!0,t._textureBlending&&(c|=l.Effect.RemoveBorder)):(a.transparent=!1,t._textureBlending||(a.color=o.Color.White,a.diffuseMulCoef=new e.Vector3(1,1,1))),t.getDirtyFlag(i.FDirty.EnvID|i.FDirty.TextureDocID|i.FDirty.TextureTransparency|i.FDirty.TextureBlending)&&this.loadTexture(t,a,u,c).then((function(e){}))}if(t.getDirtyFlag(i.FDirty.TextureBorderMode)){var p=a.map;p&&(t._textureBorderMode?(p.wrapS=e.RepeatWrapping,p.wrapT=e.RepeatWrapping):(p.wrapS=e.ClampToEdgeWrapping,p.wrapT=e.ClampToEdgeWrapping),p.repeat.set(1,1),p.needsUpdate=!0)}t._textureProjectionType===o.TextureMapping.Planar?this.doTextureMappingPlanar(t,a):t._textureProjectionType===o.TextureMapping.Spherical?this.doTextureMappingSpherical(t,a):this.doTextureUV(t,a)}else a.map=null}},getLineMaterialFromParams:function(t,a){var n=null,r=null,s=null;if("number"==typeof t.type)if(t.type===i.ELineType.None)n="None";else if(t.type===i.ELineType.Solid)n="Solid";else{var o=this.getCustomLineDashPatternFromType(t.type);o?o[0]>0&&(r=o,s=!0):n="Solid"}else Array.isArray(t.dashPattern)&&(r=t.dashPattern,s=!0);if(a)return"string"==typeof n&&a.dashType!==n?a.setDashPatternType(n):r&&a.dashPattern!==r&&a.setDashPatternArray(r),"boolean"==typeof s&&a.isCPUPattern!==s&&a.setCPUPattern(s),a.handleByPrerender||("number"==typeof t.lineWidth&&a.lineWidth!==t.lineWidth||1===a.lineWidth&&!a.visible)&&(a.setLineWidth(t.lineWidth),a.visible=t.lineWidth>0),t.color&&!a.color.equals(t.color)&&(a.color=t.color),"number"==typeof t.opacity&&a.opacity!==t.opacity&&(a.opacity=t.opacity),t.vertexColors&&a.vertexColors!==t.vertexColors&&(a.vertexColors=t.vertexColors),!t.backMaterial||a.backMaterial&&a.backMaterial.id===t.backMaterial.id||t.backMaterial&&a.setBackMaterial(t.backMaterial),this._experienceBase.getManager("VCXContextManager").renderAll(),a;var l={force:!0,polygonBorderMode:t.polygonBorderMode,alphaTest:.005,scale:"number"==typeof t.scale?t.scale:5,lineWidth:"number"==typeof t.lineWidth?t.lineWidth:2,opacity:"number"==typeof t.opacity?t.opacity:1};return"number"==typeof n?l.dashType=n:r&&(l.dashPattern=new Float32Array(r)),t.backMaterial&&t.backMaterial.isCPUPattern?l.isCPUPattern=!0:"boolean"==typeof s&&(l.isCPUPattern=s),t.vertexColors&&(l.vertexColors=t.vertexColors),t.color&&(l.color=t.color),t.backMaterial&&(l.backMaterial=t.backMaterial),t.polygonOffset&&(l.polygonOffset=t.polygonOffset,l.polygonOffsetFactor=t.polygonOffsetFactor,l.polygonOffsetUnits=t.polygonOffsetUnits),new e.LineBasicMaterial(l)},getCustomLineDashPatternFromType:function(e){switch(e){case i.ELineType.SmallDash:return[2,2];case i.ELineType.MediumDash:return[6,2];case i.ELineType.DotDash:return[3,1,1,1];case i.ELineType.LongDash:return[10,2];case i.ELineType.Dot:return[1,1];case i.ELineType.VeryLongDash:return[14,2];default:return null}},update:function(e){let t=this._experienceBase.ComponentsMap.GetComponentFromType("CXPCoveringMaterial_Spec");t=t.concat(this._experienceBase.ComponentsMap.GetComponentFromType("VCXVolatileCXPCoveringMaterial_Spec")),t.forEach((e=>{e.QueryInterface("VCXIMaterialCache").updateMaterial()})),this._isDirty&&this._experienceBase.getManager("VCXGUIManager")&&this._experienceBase.getManager("VCXGUIManager")._vcxMaterialCtrl&&(r.publish({event:"VCX_MATERIALS_PANEL_UPDATE_V2",data:null}),this._isDirty=!1)},getImportedMaterials:function(e=!0){let t=this._experienceBase.getManager("VCXContextManager").getRootComponent();if(!t)return[];let i=t.QueryInterface("CATI3DExperienceObject");if(!i)return[];try{if(!i.HasVariable("materials"))return[]}catch(e){return[]}return this._experienceBase.getManager("VCXContextManager").isSupported("VCXMaterialPanel_Splitted")&&(e=!1),i.GetValueByName("materials").filter((t=>!!t.QueryInterface("VCXIMaterialCache").hasDetails()&&(!e||!t.QueryInterface("VCXIMaterialCache").GetInternalMaterial())))},getMaterialsPLM:function(){return this._experienceBase.ComponentsMap.GetComponentFromType("VCXInternalMaterial_Spec")},getMaterials:function(){return this.getImportedMaterials().concat(this.getMaterialsPLM())}});return Object.defineProperty(c.prototype,"componentType",{enumerable:!0,get:function(){return"VCXMaterialManager"}}),c})),define("DS/VCXWebVisualization/VCXAManipulable",["UWA/Class","DS/CoreEvents/Events","DS/VCXWebVisibility/VCXIVisibility","DS/VCXWebVisualization/VCXInteractor","DS/Mesh/MeshUtils"],(function(e,t,i,a,n){"use strict";return e.extend({init:function(){this._interactors={},this._inManipulation=!1,this._isSnappable=!0},isManipulated:function(){return this._inManipulation},setManipulated:function(e){this._inManipulation=e},changePickability(e){var t=this.QueryInterface("W3AISGNodeHolder");t&&t.giveSGNode()&&t.giveSGNode().setPickable(e?n.PICKABLE:n.PICKTHROUGH)},isTextEditable:function(){return!1},startEditInPlace:function(){},getInteractor:function(e){return this._interactors[e]},getAllInteractors:function(){return this._interactors},getActiveInteractors:function(){var e={};for(var t in this._interactors)this._interactors.hasOwnProperty(t)&&!0===this._interactors[t].active&&(e[t]=this._interactors[t]);return e},updateInteractors:function(e){},isActive:function(){var e=this.GetObject(),t=(e.GetID(),this.QueryInterface("VCXIVisibility"));if(t&&t.GetVisibility()===i.EVisState.Hidden)return!1;var n=this.getActiveInteractors(),r=Object.keys(n);if(0===r.length)return!1;for(var s={selection:!1,hoveringObject:!1,hoveringHandle:!1},o=this.GetObject()._experienceBase.getManager("VCXSelectionManager"),l=0;l<r.length;++l){var h=n[r[l]];if(h.handleInfos&&h.handleInfos.stayVisible)return!0;if(!s.selection&&(!h.visibility||h.visibility&&h.visibility&a.EVisibility.OnObjectSelected)){if(o.isIn(e))return!0;s.selection=!0}if(!s.hoveringObject&&(!h.visibility||h.visibility&&h.visibility&a.EVisibility.OnObjectOver)){if(o.GetComponentsFromSelection("PSO").includes(e))return!0;s.hoveringObject=!0}s.hoveringHandle||h.visibility&&!(h.visibility&&h.visibility&a.EVisibility.OnInteractorOver)||(s.hoveringHandle=!0)}return!1},addInteractor:function(e,i){return!(!i||this._interactors[e])&&(this._interactors[e]=i,i.id||(i.id=e),i.enable(),t.publish({event:"VCX_INTERACTOR_ADDED",data:{interactor:i,manipulable:this}}),!0)},removeInteractor:function(e){return!!this._interactors[e]&&(t.publish({event:"VCX_INTERACTOR_REMOVED",data:{interactor:this._interactors[e],manipulable:this}}),delete this._interactors[e],!0)},enableInteractors:function(e){this._switchInteractors(e,!0)},disableInteractors:function(e){this._switchInteractors(e,!1)},_switchInteractors:function(e,t){if(Array.isArray(e))for(var i=0;i<e.length;++i){var a=e[i],n=this._interactors[a];if(n){n.disabledByManipulable=!t;var r=n.handle;r&&r.isDisplayed()&&!n.active&&r.Hide(!0)}}else console.log("Methods of VCXAManipulable enableInteractors & disableInteractors require an array as input !")},interact:function(){}})})),define("DS/VCXWebVisualization/VCXOccurrenceComposerPrepareRenderToTexture",["require","exports","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/Visualization/ThreeJS_DS","DS/VCXWebVisualization/VCXAPrepareRenderToTexture","DS/VCXWebVisu/VCXVisuTools"],(function(e,t,i,a,n,r){"use strict";return class extends n{GetType(){return"VCXOccurrenceComposerPrepareRenderToTexture"}async prepareRender(e,t){if("normal"!==t&&r.buildGraphicPropertiesStructure(this,null,this.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer(),{getVisibility:!0})[0]?.visible?.Visibility){const r=this.GetObject();if(r?._highlightSet&&r.HighlightData){var i=r.QueryInterface("W3AISGNodeHolder")?.getPathElement();let s={...r?.HighlightData};"white"===t?(s.color=new a.Color(16777215),s.outlineColor=new a.Color(16777215),s.haloColor=new a.Color(16777215),s.lineicHaloColor=new a.Color(16777215),s.lineicOutlineColor=new a.Color(16777215),s.outlineColor=new a.Color(16777215)):("visibletop"===t||"normalLPR"===t)&&(s.occludedAlpha=1,s.outlineAlpha=1,s.visibleAlpha=1,s.lineicOutlineAlpha=1);var n=s.polite?new a.AdvancedPoliteHighlightData(s):new a.HaloHighlightData(s);this._highlightSetTmp=e.viewer.createHighlightSet(n,!1,s.polite,!0),this._highlightSetTmp.add(i,{highlightColor:n},!0),this._highlightSetTmp.setHighlightData(r.HighlightData.polite,n)}}}async postRender(e,t){"normal"!==t&&r.buildGraphicPropertiesStructure(this,null,this.GetObject()?._experienceBase.getManager("VCXContextManager").getMainViewer(),{getVisibility:!0})[0]?.visible?.Visibility&&this._highlightSetTmp&&(e.viewer.removeHighlightSet(this._highlightSetTmp),delete this._highlightSetTmp)}}})),define("DS/VCXWebVisualization/VCXHandle",["UWA/Class","DS/CoreEvents/ModelEvents","DS/VCXWebVisualization/VCXBillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/VCXWebVisibility/VCXIVisibility","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/VCXWebVisualization/VCXInteractor","DS/SceneGraphNodes/AxisSystemNode","DS/VCXWebSystem/VCXHardwareServices","DS/Mesh/MeshUtils"],(function(e,t,i,a,n,r,s,o,l,h,u,c,p){"use strict";return e.extend({init:function(e){if(e.interactor){this._parentOwnerComponent=e.parentOwner,this._id=e.id,this.interactor=e.interactor,this._modelEvents=new t,this.manipulator=null,this.manipulatorTokens={};var i=this.interactor.data&&this.interactor.data.handleVisual;this.setColor(i&&i.color?i.color:this.getDefaultColor()),this.setOpacity(i&&i.opacity?i.opacity:this.getDefaultOpacity()),this.setSize(i&&i.size?i.size:this.getDefaultSize()),this._experienceBase=this._parentOwnerComponent._experienceBase,this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer(),this.sceneGraph=this._viewer.getRootNode(),this._anchor=this._generateHandleGeom(e),this._anchor.setVisibilityInTree(!1),this._anchor.exludeFromBounding(!0),this._anchor.handle=this,this._stayVisible=!(!i||"boolean"!=typeof i.stayVisible)&&i.stayVisible,this.hiddingTime=1e3,this.showingTime=300,this.updateVisibility()}else console.log("Needs interactor in parameters to pursue creation of handle")},getSize:function(){return"number"!=typeof this._displaySize&&(this._displaySize=this.getDefaultSize()),this._displaySize},setSize:function(e){return"number"==typeof e&&(this._displaySize=e,this.fixedSizeNode&&this.fixedSizeNode.setRatio(this._displaySize),!0)},getDefaultSize:function(){return 16},getDefaultColor:function(){return new o.Color("#FFFFFF")},setColor:function(e){return e instanceof o.Color&&(this._color=e,this.pointMat&&(this.pointMat.color=this._color),!0)},getColor:function(){return this._color instanceof o.Color||(this._color=this.getDefaultColor()),this._color},getDefaultOpacity:function(){return 1},setOpacity:function(e){if("number"==typeof e)return this.opacity=e,this.pointMat&&(this.pointMat.opacity=this.opacity),!0;console.log("Issue with assignment of handle opacity")},getOpacity:function(){return"number"!=typeof this.opacity&&(this.opacity=this.getDefaultOpacity()),this.opacity},setPosition:function(e,t,i){this._anchor.setMatrix((new o.Matrix4).setPosition(new o.Vector3(e,t,i)))},setMatrix:function(e){this._anchor.setMatrix(e)},getMatrix:function(){return this._anchor.getMatrix()},StayVisible:function(e){"boolean"==typeof e&&(this._stayVisible=e)},remove:function(){this.sceneGraph.remove(this._anchor),this._anchor.handle=null,this._anchor=null,this._experienceBase=null,this._viewer=null,this._parentOwnerComponent=null,this._id=null,this.interactor=null,this._modelEvents=null,this.manipulator=null,this.manipulatorTokens=null,this.sceneGraph=null},_getPointMaterial:function(){var e=l.getWebappsAssetUrl("VCXWebVisualization","texture");this.pointHandleTexture=new o.ImageUtils.loadTexture(e+"/VCX_Point.png"),this.pointHandleTexture.flipY=!1,this.pointHandleTexture.minFilter=o.LinearMipMapLinearFilter,this.pointDotHandleTexture=new o.ImageUtils.loadTexture(e+"/VCX_Point_Blue.png"),this.pointDotHandleTexture.flipY=!1,this.pointDotHandleTexture.minFilter=o.LinearMipMapLinearFilter;var t=new o.MeshBasicMaterial({map:this.pointHandleTexture,side:o.DoubleSide,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity});return t.force=!0,t},_getRectangleMaterial:function(){var e=l.getWebappsAssetUrl("VCXWebVisualization","texture"),t=new o.ImageUtils.loadTexture(e+"/VCX_Bar.png");t.flipY=!1,t.minFilter=o.LinearMipMapLinearFilter,t.magFilter=o.NearestFilter;var i=new o.MeshBasicMaterial({map:t,side:o.DoubleSide,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity});return i.force=!0,i},_getCustomIconMaterial:function(){var e=new o.MeshBasicMaterial({map:this.interactor.customIcon&&this.interactor.customIcon[0],side:o.DoubleSide,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity});return e.force=!0,e},_getMaterial2:function(){switch(this.interactor.manipulatorType){case h.EManipulatorType.Custom:return this._getCustomIconMaterial();case h.EManipulatorType.BarHandle:return this._getRectangleMaterial();default:return this._getPointMaterial()}},_getMaterial:function(e){var t;switch(this.interactor.manipulatorType){case h.EManipulatorType.Custom:case h.EManipulatorType.BarHandle:break;default:this.pointDotHandleTexture=e.pointDotHandleTexture,this.pointHandleTexture=e.pointHandleTexture}return(t=void 0!==e.objId?0===e.objId?e.material:e.material1:e.material).opacity=this.opacity,t},_generateHandleGeom:function(e){var t=new r(e.name);this.isPreactivated=!1,this.isManipulated=!1;var n=void 0===e.noz||e.noz,l={position:this.position,name:"billBoard1"};this.billBoardNode=new i(l),this._setBillboardType();var u=[{id:0}],c=this._experienceBase.getManager("VCXVisuManager"),p=this._experienceBase.getManager("VCXGUIManager").isTouchActivated();u.push({id:1}),u.forEach((t=>{e.objId=t.id,u[t.id].material=this._getMaterial2(e);var i=s.createRectangleNode({width:1,height:1,cornerPoint:new o.Vector2(-.5,-.5),fill:!0,fillColor:null,noEdge:!0,layerNb:n?1:0,material:u[t.id].material});i.name="diskNode",i.setShadow(!1),i.setFrustumCulled(!1),i.excludeFromCSO(!0),i.excludeFromHighlight(!0,!0),i.setNoHighlightNoZ(!0),i.setMirror(!1),i.exludeFromBounding(!0),i.setRenderPasses([c.getRenderList("VCXPreManipulators"),c.getRenderList("VCXManipulators")]),u[t.id].node=i,this.billBoardNode.add(i)}));var d=1,_=1;if(this.interactor.manipulatorType===h.EManipulatorType.BarHandle)d=2,_=2;else if(this.interactor.manipulatorType===h.EManipulatorType.Custom)d=this.interactor.scaleX||2,_=this.interactor.scaleY||2;u[0].node.setMatrix((new o.Matrix4).makeScale(d,_,1)),this.pointMat=u[0].material;var g=1;return p&&(g=4),u[1].node.setMatrix((new o.Matrix4).makeScale(d*g,_*g,1)),u[1].material.alphaTest=.005,u[1].material.opacity=0,u[1].material.depthTest=!1,u[1].material.depthWrite=!1,this.fixedSizeNode=new a({name:"fixedSizeNode3D",ratio:this._displaySize}),this.fixedSizeNode.add(this.billBoardNode),t.add(this.fixedSizeNode),this.sceneGraph.add(t),t},getHandleGeom:function(){return this._anchor},updateManipulatorCallbacks:function(e){if(e!==this.manipulator){if(this.manipulator&&this.manipulatorTokens){for(var t=Object.keys(this.manipulatorTokens),i=0;i<t.length;++i){var a=t[i],n=this.manipulatorTokens[a];this.manipulator.unsubscribe(n)}this.manipulatorTokens={},this.manipulator=null}this.manipulator=e}},_createManipulatorCallbacks:function(e){if(this._anchor){var t=this;this.manipulatorTokens.tokenBeginManipulate=e.subscribe("BeginManipulate",(function(e){t.pointMat.color=new o.Color("#1B6E9C"),e.viewer.setCursor("-webkit-grabbing"),t.isManipulated=!0,t.fixedSizeNode.setRatio(1.2*t._displaySize),t._loadingOption&&t._loadingOption.isShowPickerDebug()&&t._debugHTMLAcquired(),t._handleInitPosition=e.intersection.position,e.handleID=t._id,t._modelEvents.publish({event:"BeginManipulate",data:e,context:this})})),this.manipulatorTokens.tokenManipulate=e.subscribe("Manipulate",(function(e){t._loadingOption&&t._loadingOption.isShowPickerDebug()&&t._debugHTMLAcquired(),e.handleID=t._id,t._modelEvents.publish({event:"Manipulate",data:e,context:this})})),this.manipulatorTokens.tokenEndManipulate=e.subscribe("EndManipulate",(function(e){e.handleID=t._id,t._modelEvents.publish({event:"EndManipulate",data:e,context:this}),t.isPreactivated?(e.viewer.setCursor("pointer"),t.pointMat.color=new o.Color("#A1D9ED")):(e.viewer.setCursor("auto"),t.pointMat.color=t.color,t.fixedSizeNode.setRatio(t._displaySize)),t.isManipulated=!1})),this.manipulatorTokens.tokenBeginPreactivate=e.subscribe("BeginPreactivate",(function(e){t._modelEvents.publish({event:"BeginPreactivate",data:e,context:this}),t.isPreactivated=!0,t.isManipulated||(t.pointMat.color=new o.Color("#A1D9ED")),t.fixedSizeNode.setRatio(1.2*t._displaySize)})),this.manipulatorTokens.tokenPreactivate=e.subscribe("Preactivate",(function(e){t._modelEvents.publish({event:"Preactivate",data:e,context:this})})),this.manipulatorTokens.tokenEndPreactivate=e.subscribe("EndPreactivate",(function(e){t._modelEvents.publish({event:"EndPreactivate",data:e,context:this}),t.isPreactivated=!1,t.isManipulated||(t.pointMat.color=t.color,t.fixedSizeNode.setRatio(t._displaySize))}))}else console.log("Manipulable node not found, abort.")},Show:function(){this.showingRequest=this.showingTime,this.hiddingRequest=-1,this.fixedSizeNode&&this.fixedSizeNode.setRatio(this._displaySize),this._anchor.setVisibility(!0),this._viewer.invalidatePickingBuffer()},Hide:function(e){this.hiddingRequest=this.hiddingTime,this.showingRequest=-1,(e||!1===this._stayVisible)&&(this.fixedSizeNode&&this.fixedSizeNode.setRatio(1),this._anchor.setVisibility(!1),this._viewer.invalidatePickingBuffer())},IsVisible:function(){return this._anchor.visible},isDisplayed:function(){return this.IsVisible()&&this.getOpacity()>0},updateVisibility:function(){var e=this._experienceBase.getManager("VCXSelectionManager"),t=!1,i=this._parentOwnerComponent,a=i.GetID(),r=i.QueryInterface("VCXIVisibility");if(r&&r.GetVisibility()===n.EVisState.Hidden)this.isDisplayed()&&this.Hide(!0);else{if(e.GetComponentsFromSelection("HSO").map((function(e){return e.GetID()})).includes(a))t=!0;else e.GetComponentsFromSelection("PSO").map((function(e){return e.GetID()})).includes(a)&&(t=!0);t||this._stayVisible?this.Show():this.Hide()}},getMatrixInWCS:function(){this._anchor.getMatrix(),this._anchor.getMatrixInWCS&&this._anchor.getMatrixInWCS();return this._anchor.getMatrix()},update:function(e){this.showingRequest>0?(this.fixedSizeNode&&this.fixedSizeNode.setRatio(this._displaySize),this._anchor.setVisibility(!0),this.pointMat.setOpacity(1-this.showingRequest/this.showingTime),this.showingRequest-=e.deltaTime,this.showingRequest<=0&&this.pointMat.setOpacity(1)):this.hiddingRequest>0&&(this.hiddingRequest-=e.deltaTime,this.pointMat.setOpacity(this.hiddingRequest/this.hiddingTime),this.hiddingRequest<=0&&(this.fixedSizeNode&&this.fixedSizeNode.setRatio(1),this._anchor.setVisibility(!1)))},_setBillboardType:function(){var e="Spherical";this.interactor.manipulatorType!==h.EManipulatorType.Handle&&(e=this.interactor.constraint===h.EConstraint.ZAxis?"PRESERVE_X_AXIS_Y_IN_CAM_PLANE":"PRESERVE_X_AXIS_Z_IN_CAM_PLANE"),this.billBoardNode.BillBoardType=e},updateTexture:function(e){if(this._setBillboardType(),this.interactor&&this.interactor.data&&"number"==typeof this.interactor.data.anchorID){var t=this.interactor._component.QueryInterface("VCXIModifiable").GetProperty("Actor.Anchor."+this.interactor.data.anchorID).GetPropertyValue().GetValueLink();this.pointMat.map=t&&t.Value?this.pointDotHandleTexture:this.pointHandleTexture}if(this.interactor.customIcon&&this.interactor.customIcon.length>1){this.currentTime|=0,this.currentSlot|=0,this.currentTime+=e.deltaTime;var i=this.preactivated?Math.floor(this.currentTime/300)%this.interactor.customIcon.length:0;this.currentSlot!==i&&(this.currentSlot=i,this.pointMat.map=this.interactor.customIcon[i],this._experienceBase.getManager("VCXContextManager").renderAll())}},_debugHTMLAcquired:function(){var e=this._experienceBase.getManager("VCXExperience");if(e.debugTools){var t='<div style="width:220px;padding:5px;"><div style="margin:5px;width:210px" align="center"><b>Anchor moving</b></div>';c.isTouchCompliantDevice()&&(t+='<div style="margin:5px;" align="left">Touch compliante: size increase</div>'),t+='<div style="width:200px;border:1px solid black; margin:5px;padding:5px;">';var i=e.debugTools.getImgCoord();t+="<div>";var a=(new o.Vector3).getPositionFromMatrix(this._initialMatrixInWCS),n=(new o.Vector3).getPositionFromMatrix(this._anchor.getMatrix());t+="Initial Position<br>",t+=i+a.x.toFixed(2)+"/"+a.y.toFixed(2)+"/"+a.z.toFixed(2)+"<br>",t+="Current Position<br>",t+=i+n.x.toFixed(2)+"/"+n.y.toFixed(2)+"/"+n.z.toFixed(2)+"<br>",t+="</div>",t+="</div>",t+="</div>",this._experienceBase.getManager("VCXExperience").debugTools.updateImmersiveConsole(t)}}})})),define("DS/VCXWebVisualization/VCXRulers",["require","exports","DS/Ruler/Ruler","DS/Ruler/AngularRuler","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools","DS/VCXWebVisualization/VCXRulersUnitEnum"],(function(e,t,i,a,n,r,s){"use strict";return class{constructor(e,t,n){if(this._linearManipulated="",this._angularManipulated="",n)this._options=n;else{const e={lightDisplay:!0,displayOrigin:!0,mainGrad:100,nbDecimals:1,nbSecondaryGrads:1,offset:150,unit:i.MM_UNIT,displayUnit:!0,displayRulerDuringLocalTransfo:!0},t={worldRadius:20,mainGrad:10,displayOrigin:!0,displayUnit:!0,lightDisplay:!0,graduationsDisplay:a.FULLSYMETRIC_GRADUATIONS,nbDecimals:1,nbSecondaryGrads:1,displayRulerDuringLocalTransfo:!0};this._options={LINEAR:e,ANGULAR:t}}this._experienceBase=t,this._frameWindow=e,this._linearRulers={X:null,Y:null,Z:null},this._angularRulers={X:null,Y:null,Z:null}}getLinearRulerByName(e){return this._linearRulers?.hasOwnProperty(e)?this._linearRulers[e]:(console.warn("No linear ruler found with the following name",e),null)}getAngularRulerByName(e){return this._angularRulers?.hasOwnProperty(e)?this._angularRulers[e]:(console.warn("No angular ruler found with the following name",e),null)}showLinearRuler(e,t){const i=this.getLinearRulerByName(e);i&&this._showRuler(i,t)}showAngularRuler(e,t){const i=this.getAngularRulerByName(e);i&&this._showRuler(i,t)}_showRuler(e,t){!e.ruler||e.getVisibleFlag()&&!t||(e.display(),e.setVisibleFlag(!0),e.setVisibilityFree(!0),e.hasBeenDisplayed=!0)}hideAllRulers(){[this._linearRulers,this._angularRulers].forEach((e=>{for(let t in e)e.hasOwnProperty(t)&&e[t]&&e[t].clear()}))}destroy(){[this._linearRulers,this._angularRulers].forEach((e=>{for(let t in e)e.hasOwnProperty(t)&&e[t]&&(e[t].clear(),e[t].hasBeenDisplayed=!1,delete e[t])}))}setCallbacksOnManipulateRulers(e,t){this._callbackOnManipulateLinear=e,this._callbackOnManipulateAngular=t}_createLinearRuler(){const e=new i(this._frameWindow,this._options.LINEAR);return this.setRulerUnit(e,"Length"),e.subscribe("RulerManipulateBegin",(()=>{this.onTranslationRulerBeginManipulation()})),e.subscribe("RulerManipulate",(()=>{this.onTranslationRulerManipulation()})),e.subscribe("RulerManipulateEnd",(()=>{this.onTranslationRulerEndManipulation()})),e}_createAngularRuler(){const e=new a(this._frameWindow,this._options.ANGULAR);return this.setRulerUnit(e,"Angle"),e.subscribe("AngularRulerManipulateBegin",(()=>{this.onAngularRulerBeginManipulation()})),e.subscribe("AngularRulerManipulate",(()=>{this.onAngularRulerManipulation()})),e.subscribe("AngularRulerManipulateEnd",(()=>{this.onAngularRulerEndManipulation()})),e}onAngularRulerBeginManipulation(){}onAngularRulerManipulation(){}onAngularRulerEndManipulation(){}onTranslationRulerBeginManipulation(){}onTranslationRulerManipulation(){}onTranslationRulerEndManipulation(){}set linearManipulated(e){this._linearManipulated=e}set angularManipulated(e){this._angularManipulated=e}get linearManipulated(){return this._linearManipulated}get angularManipulated(){return this._angularManipulated}setRulerUnit(e,t){if("Length"===t||"Angle"===t){if(e){const n=this._experienceBase.getManager("VCXUnitManager");let r="Length"===t?i.MM_UNIT:a.DEG_UNIT;if(n){let e=n.getUnitType(t).getDisplayUnit().Name;if(e){let i="Length"===t?s.VCXLinearRulerUnitEnum[e]:s.VCXAngularRulerUnitEnum[e];i&&(r=i)}}e.unit=r}}else console.warn(t,"is not corresponding to the type of ruler")}updateLinearValue(e){const t=this.getLinearRulerByName(this.linearManipulated);if(t){let i=e.length();e.dot(t.direction)<=0&&(i=-i),t.setValue(i)}}updateAngularValue(e){const t=this.getAngularRulerByName(this.angularManipulated);if(t){var i=new n.Quaternion;let a;i.setFromRotationMatrix(e.rotationMatrix),a=r.getEulerFromQuaternion(i).dot(t.direction)>=0?180*e.angle/Math.PI:360-180*e.angle/Math.PI,t.setValue(a)}}}}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebVisualization/VCXPlaneRulers",["require","exports","DS/VCXWebVisualization/VCXRulers","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools"],(function(e,t,i,a,n){"use strict";n=__importDefault(n);return class extends i{constructor(e,t){super(e,t,null),this._axisXRotation=new a.Vector3(1,0,0),this._axisYRotation=new a.Vector3(0,1,0),this._axisZTranslation=new a.Vector3(0,0,1),this._node=null,this._initialAngularValue={X:0,Y:0},this._initialLinearValue={Z:0}}set node(e){this._node=e}setAxisForTransformationRulers(e,t,i){this._axisXRotation.x=e,this._axisYRotation.y=t,this._axisZTranslation.z=i}createRulers(){this._linearRulers.Z=this._createLinearRuler(),this._angularRulers.X=this._createAngularRuler(),this._angularRulers.Y=this._createAngularRuler(),this.linearManipulated="Z"}_computeTranslationDirection(e){if(this._node&&this._node.getChildByName("LeftMiddle")&&this._node.getChildByName("RightMiddle")&&this._node.getChildByName("TopMiddle")&&this._node.getChildByName("BottomMiddle")){const t=this._node.GetWorldMatrix(e.viewer,"LeftMiddle"),i=this._node.GetWorldMatrix(e.viewer,"RightMiddle"),r=this._node.GetWorldMatrix(e.viewer,"TopMiddle"),s=this._node.GetWorldMatrix(e.viewer,"BottomMiddle");if(t&&i&&r&&s){let e=n.default.getOFromMatrix(i.clone()),o=n.default.getOFromMatrix(t.clone()),l=n.default.getOFromMatrix(r.clone()),h=n.default.getOFromMatrix(s.clone()),u=(new a.Vector3).subVectors(e,o),c=(new a.Vector3).subVectors(l,h),p=(new a.Vector3).crossVectors(u,c);return p.normalize(),p}}return null}_computeDirectionRotation(e){if(this._node&&this._node.getChildByName("LeftMiddle")&&this._node.getChildByName("RightMiddle")&&this._node.getChildByName("TopMiddle")&&this._node.getChildByName("BottomMiddle")){const t=this._node.GetWorldMatrix(e.viewer,"LeftMiddle"),i=this._node.GetWorldMatrix(e.viewer,"RightMiddle"),r=this._node.GetWorldMatrix(e.viewer,"TopMiddle"),s=this._node.GetWorldMatrix(e.viewer,"BottomMiddle");if(t&&i&&r&&s&&this.angularManipulated){let e=null,o=null;if("Y"===this.angularManipulated&&(e=n.default.getOFromMatrix(i.clone()),o=n.default.getOFromMatrix(t.clone())),"X"===this.angularManipulated&&(e=n.default.getOFromMatrix(r.clone()),o=n.default.getOFromMatrix(s.clone())),e&&o){let t=(new a.Vector3).subVectors(e,o);return t.normalize(),t}}}return null}_computeAxisRotation(e){if(this._node&&this._node.getChildByName("LeftMiddle")&&this._node.getChildByName("RightMiddle")&&this._node.getChildByName("TopMiddle")&&this._node.getChildByName("BottomMiddle")){const t=this._node.GetWorldMatrix(e.viewer,"LeftMiddle"),i=this._node.GetWorldMatrix(e.viewer,"RightMiddle"),r=this._node.GetWorldMatrix(e.viewer,"TopMiddle"),s=this._node.GetWorldMatrix(e.viewer,"BottomMiddle");if(t&&i&&r&&s&&this.angularManipulated){let e=null,o=null;if("X"===this.angularManipulated&&(e=n.default.getOFromMatrix(i.clone()),o=n.default.getOFromMatrix(t.clone())),"Y"===this.angularManipulated&&(e=n.default.getOFromMatrix(r.clone()),o=n.default.getOFromMatrix(s.clone())),e&&o){let t=(new a.Vector3).subVectors(e,o);return t.normalize(),t}}}return null}updateTranslationRulers(e){this.hideAllRulers();const t=this._linearRulers[this.linearManipulated];if(t&&this._node.getChildByName("CenterNode")){const i=this._node.GetWorldMatrix(e.viewer,"CenterNode");console.log(i),console.log("============================="),i&&(t.origin=n.default.getOFromMatrix(i)),t.direction=this._computeTranslationDirection(e),this.setRulerUnit(t,"Length"),t.display(),t.setValue(0)}}updateRotationRulers(e){this.hideAllRulers();const t=this._angularRulers[this.angularManipulated];if(t&&this._node.getChildByName("CenterNode")){const i=this._node.GetWorldMatrix(e.viewer,"CenterNode");console.log(i),console.log("============================="),i&&(t.origin=n.default.getOFromMatrix(i));let a=this._computeAxisRotation(e);a&&(t.direction=a);let r=this._computeDirectionRotation(e);r&&(t.originVector=r),this.setRulerUnit(t,"Angle"),t.display(),t.setValue(0)}}onAngularRulerBeginManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180;this._initialAngularValue[this.angularManipulated]=e,this._callbackOnManipulateAngular.BeginManipulate()}onAngularRulerManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180-this._initialAngularValue[this.angularManipulated],t="X"===this.angularManipulated?this._axisXRotation:this._axisYRotation;const i=(new a.Matrix4).makeRotationAxis(t,e);this._callbackOnManipulateAngular.Manipulate(i)}onAngularRulerEndManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180-this._initialAngularValue[this.angularManipulated],t="X"===this.angularManipulated?this._axisXRotation:this._axisYRotation;const i=(new a.Matrix4).makeRotationAxis(t,e);this._callbackOnManipulateAngular.EndManipulate(i)}onTranslationRulerBeginManipulation(){this._callbackOnManipulateLinear.BeginManipulate(),this._initialLinearValue[this.linearManipulated]=this._linearRulers[this.linearManipulated].value}onTranslationRulerManipulation(){let e=this._linearRulers[this.linearManipulated].value-this._initialLinearValue[this.linearManipulated],t=new a.Vector3(0,0,this._axisZTranslation.z*e);this._callbackOnManipulateLinear.Manipulate(t)}onTranslationRulerEndManipulation(){let e=this._linearRulers[this.linearManipulated].value-this._initialLinearValue[this.linearManipulated],t=new a.Vector3(0,0,this._axisZTranslation.z*e);this._callbackOnManipulateLinear.EndManipulate(t)}}})),define("DS/VCXWebVisualization/VCXArrowHandle",["DS/VCXWebVisualization/VCXHandle","DS/VCXWebVisualization/VCXBillBoardArrowNode3D","DS/VCXWebVisualization/VCXInteractor","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/AxisSystemNode","DS/WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils"],(function(e,t,i,a,n,r,s,o,l,h){"use strict";return e.extend({init:function(e){this._parent(e)},_generateHandleGeom:function(e){var l=new n(e.name);this.isPreactivated=!1,this.isManipulated=!1;var u=this._experienceBase.getManager("VCXVisuManager");void 0===e.noz||e.noz;new a.Vector2(0,0);this.arrowNode=r.createRectangleNode({width:1,height:4,cornerPoint:new a.Vector2(0,0),fill:!0,fillColor:null,noEdge:!0,material:this._getMaterial(e)}),this.arrowNode.name="arrowNode",this.arrowNode.setShadow(!1),this.arrowNode.setFrustumCulled(!1),this.arrowNode.excludeFromCSO(!0),this.arrowNode.excludeFromHighlight(!0,!0),this.arrowNode.setMirror(!1),this.arrowNode.exludeFromBounding(!0),this.arrowNode.setRenderPasses([u.getRenderList("VCXPreManipulators"),u.getRenderList("VCXManipulators")]);let c=new a.Matrix4;c.identity();const p=new a.Vector3(1,0,0).applyMatrix4(c).normalize(),d=(new a.Vector3(0,1,0).applyMatrix4(c).normalize(),new a.Vector3(0,0,1).applyMatrix4(c).normalize());let _=new a.Matrix4;switch(e.interactor.constraint){case i.EConstraint.XAxis:_=(new a.Matrix4).makeRotationAxis(d,-.5*Math.PI);break;case i.EConstraint.YAxis:break;case i.EConstraint.ZAxis:_=(new a.Matrix4).makeRotationAxis(p,-.5*Math.PI);break;case i.EConstraint.CustomAxis:_=(new a.Matrix4).makeRotationAxis(p,.5*Math.PI)}this.arrowNode.setMatrix(_.translate(new a.Vector3(-.5,0,0))),this.arrowNode.setMatrix(this.arrowNode.getMatrix());var g={position:this.position,name:"billBoardNode"};this.billBoardNode=new t(g),this.billBoardNode.addChild(this.arrowNode);new o({name:"AxisSystem",headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new h.Color(255,0,0,0),colorY:new h.Color(0,255,0,0),colorZ:new h.Color(0,0,255,0)},head:o.types.ARROW});return this.fixedSizeNode=new s({name:"fixedSizeNode3D",ratio:this._displaySize}),this.fixedSizeNode.addChild(this.billBoardNode),l.add(this.fixedSizeNode),this.sceneGraph.add(l),l},_getMaterial:function(e){return e.material},_setBillboardType:function(){var e="Spherical";this.interactor.manipulatorType===i.EManipulatorType.ArrowHandle&&(e=this.interactor.constraint===i.EConstraint.XAxis?"PRESERVE_X_AXIS":this.interactor.constraint===i.EConstraint.YAxis?"PRESERVE_Y_AXIS":"PRESERVE_Z_AXIS"),this.billBoardNode&&(this.billBoardNode.BillBoardType=e)}})})),define("DS/VCXWebVisualization/VCXRobotRulers",["require","exports","DS/VCXWebVisualization/VCXRulers","DS/Visualization/ThreeJS_DS"],(function(e,t,i,a){"use strict";const n=.001;return class extends i{constructor(e,t,i){super(e,i,null),this._robot=t,this._initialAngularValue={X:0,Y:0,Z:0},this._initialLinearValue={X:0,Y:0,Z:0}}createRulers(){this._linearRulers.X=this._createLinearRuler(),this._linearRulers.Y=this._createLinearRuler(),this._linearRulers.Z=this._createLinearRuler(),this._angularRulers.X=this._createAngularRuler(),this._angularRulers.Y=this._createAngularRuler(),this._angularRulers.Z=this._createAngularRuler()}updateRotationRulers(){this.hideAllRulers();let e="",t=null;if(this._robot.rotationArcYZ&&(this._robot.rotationArcYZ.isManipulated||this._robot.rotationArcYZ.isPreactivated)&&(e="X",t=this._robot.rotationArcYZ),this._robot.rotationArcXZ&&(this._robot.rotationArcXZ.isManipulated||this._robot.rotationArcXZ.isPreactivated)&&(e="Y",t=this._robot.rotationArcXZ),this._robot.rotationArcXY&&(this._robot.rotationArcXY.isManipulated||this._robot.rotationArcXY.isPreactivated)&&(e="Z",t=this._robot.rotationArcXY),t&&e&&this._angularRulers[e]){let i=new a.Vector3,n=new a.Vector3,r=new a.Vector3;this._robot.getMatrixWorld().extractBasis(i,n,r);let s=null;"Z"===e?s=i.clone():"Y"===e?s=r.clone():"X"===e&&(s=n.clone()),this._angularRulers[e].origin=(new a.Vector3).getPositionFromMatrix(this._robot.getMatrixWorld()),this._angularRulers[e].direction=t.axis,s&&(this._angularRulers[e].originVector=s.normalize()),this.setRulerUnit(this._angularRulers[e],"Angle"),this._angularRulers[e].display(),this._angularRulers[e].setValue(0),this.angularManipulated=e}}onTranslationRulerBeginManipulation(){this._callbackOnManipulateLinear.BeginManipulate(),this._initialLinearValue[this.linearManipulated]=this._linearRulers[this.linearManipulated].value}onTranslationRulerManipulation(){let e=this._linearRulers[this.linearManipulated].value,t=e-this._initialLinearValue[this.linearManipulated],i=this._linearRulers[this.linearManipulated].direction,a=i.clone(),n=i.clone();a.multiplyScalar(t),n.multiplyScalar(e),this._updateRobotTranslationMatrix(n),this._callbackOnManipulateLinear.Manipulate({translationVector:a})}onTranslationRulerEndManipulation(){this._callbackOnManipulateLinear.EndManipulate()}onAngularRulerBeginManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180;this._initialAngularValue[this.angularManipulated]=e,this._callbackOnManipulateAngular.BeginManipulate()}onAngularRulerManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180,t=e-this._initialAngularValue[this.angularManipulated],i=(new a.Matrix4).makeRotationAxis(this._angularRulers[this.angularManipulated].direction.clone(),t),n=(new a.Matrix4).makeRotationAxis(this._angularRulers[this.angularManipulated].direction.clone(),e);this._updateRobotRotationMatrix(n),this._callbackOnManipulateAngular.Manipulate({rotationMatrix:i})}onAngularRulerEndManipulation(){this._callbackOnManipulateAngular.EndManipulate()}_updateRobotRotationMatrix(e){let t=(new a.Matrix4).copy(e);t.multiply((new a.Matrix4).extractRotation(this._robot.initialMatrix));let i=t.setPosition((new a.Vector3).getPositionFromMatrix(this._robot.initialMatrix));this._robot.setMatrix(i)}_updateRobotTranslationMatrix(e){let t=new a.Vector3;t.getPositionFromMatrix(this._robot.initialMatrix),t.add(e);let i=(new a.Matrix4).copy(this._robot.getMatrix());this._robot.setMatrix(i.setPosition(t)),this._robot.updateCenterPosition(t)}updateTranslationRulers(){this.hideAllRulers();let e="",t=null;this._robot.arrowX&&(this._robot.arrowX.isManipulated||this._robot.arrowX.isPreactivated)&&(e="X",t=this._robot.arrowX),this._robot.arrowY&&(this._robot.arrowY.isManipulated||this._robot.arrowY.isPreactivated)&&(e="Y",t=this._robot.arrowY),this._robot.arrowZ&&(this._robot.arrowZ.isManipulated||this._robot.arrowZ.isPreactivated)&&(e="Z",t=this._robot.arrowZ),t&&e&&this._linearRulers[e]&&(this._linearRulers[e].origin=(new a.Vector3).getPositionFromMatrix(this._robot.getMatrixWorld()),this._linearRulers[e].direction=this._getTranslationAxis(e),this.setRulerUnit(this._linearRulers[e],"Length"),this._linearRulers[e].display(),this._linearRulers[e].setValue(0),this.linearManipulated=e)}_verifyCoordinatesToTolerance(e){e&&(Math.abs(e.x)<n&&(e.x=0),Math.abs(e.y)<n&&(e.y=0),Math.abs(e.z)<n&&(e.z=0))}_getTranslationAxis(e){let t=null,i=new a.Vector3,n=new a.Vector3,r=new a.Vector3;switch(this._robot.getMatrixWorld().extractBasis(i,n,r),e){case"X":t=i.clone();break;case"Y":t=n.clone();break;case"Z":t=r.clone()}return t&&(this._verifyCoordinatesToTolerance(t),t.normalize()),t}}})),define("DS/VCXWebVisualization/VCXRobotAdapter",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebModifiablesServices/VCXModifiablesServices","DS/CoreEvents/Events","DS/VCXWebSystem/VCXMathTools","DS/Mesh/MeshUtils","DS/VCXWebVisualization/VCXRobotRulers"],(function(e,t,i,a,n,r,s,o,l){"use strict";var h=e.extend({initialize:function(){},postInitialize:function(){this._requestedReferenceAxisSystemValue=!0,this._WUXEventTokens={};var e=this,i=this._experienceBase.getManager("VCXContextManager");this._WUXEventTokens.VCX_TEMPORARILY_HIDE_DECORATION=r.subscribe({event:"VCX_TEMPORARILY_HIDE_DECORATION"},(function(t){var a=i.getMainViewer().getRobot();a&&(e._robotConnectedBeforeSave=a.isConnected,e._robotPositionMatrix=a.getMatrix(),i.getMainViewer().setReferenceAxisSystem(!1))})),this._WUXEventTokens.VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION=r.subscribe({event:"VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION"},(function(t){var a=i.getMainViewer().getRobot();e._robotConnectedBeforeSave&&(a.setConnectionState(!0),a.fixedSizeNode3D.setRatio(7),a.setRobotMatrix(e._robotPositionMatrix),e._robotConnectedBeforeSave=null,e._robotPositionMatrix=null),i.getMainViewer().setReferenceAxisSystem(e._requestedReferenceAxisSystemValue)}));var a=this._experienceBase.getManager("VCXGUIManager");i.getMainViewer().setRobot(!0,{snapOnFace:!0,showOnlyManipulated:!0,touchMode:a.isTouchActivated()}),this._robot=this._experienceBase.getManager("VCXContextManager").getMainViewer().getRobot(),"replay"!==this._experienceBase.odt&&(this._rulers=new l(this._experienceBase.getManager("VCXContextManager").getFrameWindow(),this._robot,this._experienceBase),this._rulers.createRulers(),this._rulers.setCallbacksOnManipulateRulers({BeginManipulate:()=>this._allManipulationBeginCB({eventChannel:"TranslationBegin"}),Manipulate:e=>this._lineTranslationManipulationCB(e),EndManipulate:()=>this._allManipulationEndCB({eventChannel:"TranslationEnd"},"translation")},{BeginManipulate:()=>this._allManipulationBeginCB({eventChannel:"RotationBegin"}),Manipulate:e=>this._rotationManipulationCB(e),EndManipulate:()=>this._allManipulationEndCB({eventChannel:"RotationEnd"},"translation")}));var n=new t.Vector3(1,0,0),s=new t.Vector3(0,1,0),h=new t.Vector3(0,0,1);this._robot.updateAxis(n,s,h);var u=this._robot.ratio.docked;this._robot.setRatio({docked:a.isTouchActivated()?u+2:u,moving:u,connected:a.isTouchActivated()?u+2:u}),this._robot.setDisplayScalingNodes(!1);if(this._robot.setGetPositionCB(((e,t,i)=>{var n=this._robot&&this._robot.fixedSizeNode3D.ratio/7,r=a&&a.getUsableArea(),s=r&&r.getBoundingClientRect();return s&&"number"==typeof n?{x:2*i*(s.right-100*n)/e-1,y:2*(1-i*((s.bottom-100*n)/t))-1}:{x:.85,y:-.8}})),this._experienceBase.getManager("VCXContextManager").getMainViewer().getReferenceAxisSystemNode&&this._experienceBase.getManager("VCXContextManager").getMainViewer().getReferenceAxisSystemNode().setGetPositionCB(((e,t,i)=>{var n={x:null,y:null},r=a&&a.getUsableArea(),s=r&&r.getBoundingClientRect();return s?(n.x=Math.min(2*i*(s.right-20)/e-1,.85),n.y=Math.max(2*(1-i*((s.bottom-20)/t))-1,-.8)):(n.x=.85,n.y=-.8),n})),this._experienceBase.getManager("VCXContextManager").getContextFromName("PlayerMode"))this._robot.robotHandle.setPickable(o.NOPICKABLE);else{e=this;this._robot.setMoveMode("CALLBACK_ONLY"),this._robot.setAddToHSO(!1),this._robot.setAddToCSO(!1),this.tokens={},this.tokens.lineTranslationBegin=this._robot.subscribe("ScalingBegin",(function(t){t.target&&e._allManipulationBeginCB(t)})),this.tokens.lineTranslationManipulation=this._robot.subscribe("ScalingManipulation",(function(t){t.target&&e._lineTranslationManipulationCB(t)})),this.tokens.lineTranslationEnd=this._robot.subscribe("ScalingEnd",(function(t){t.target&&e._allManipulationEndCB(t,"scaling")})),this.tokens.lineTranslationBegin=this._robot.subscribe("LineTranslationBegin",(function(t){t.target&&e._allManipulationBeginCB(t),e._rulers&&e._rulers.updateTranslationRulers(t)})),this.tokens.lineTranslationManipulation=this._robot.subscribe("LineTranslationManipulation",(function(t){t.target&&e._lineTranslationManipulationCB(t),e._rulers&&e._rulers.updateLinearValue(t.translationVector)})),this.tokens.lineTranslationEnd=this._robot.subscribe("LineTranslationEnd",(function(t){t.target&&e._allManipulationEndCB(t,"translation")})),this.tokens.planeTranslationBegin=this._robot.subscribe("PlaneTranslationBegin",(function(t){t.target&&e._allManipulationBeginCB(t)})),this.tokens.planeTranslationManipulation=this._robot.subscribe("PlaneTranslationManipulation",(function(t){t.target&&e._planeTranslationManipulationCB(t)})),this.tokens.planeTranslationEnd=this._robot.subscribe("PlaneTranslationEnd",(function(t){t.target&&e._allManipulationEndCB(t,"translation")})),this.tokens.rotationBegin=this._robot.subscribe("RotationBegin",(function(t){t.target&&e._allManipulationBeginCB(t),e._rulers&&e._rulers.updateRotationRulers()})),this.tokens.rotationManipulation=this._robot.subscribe("RotationManipulation",(function(t){if(t.target&&e._rotationManipulationCB(t),t.angle&&t.rotationMatrix){let i={};i.angle=t.angle,i.rotationMatrix=t.rotationMatrix,e._rulers&&e._rulers.updateAngularValue(i)}})),this.tokens.rotationEnd=this._robot.subscribe("RotationEnd",(function(t){t.target&&e._allManipulationEndCB(t,"translation")})),this.tokens.screenPlaneTranslationBegin=this._robot.subscribe("ScreenPlaneTranslationBegin",(function(t){e._screenPlaneTranslationBeginCB(t)})),this.tokens.screenPlaneTranslationEnd=this._robot.subscribe("ScreenPlaneTranslationEnd",(function(t){e._screenPlaneTranslationEndCB(t)})),this._arrayModifiables=null,this._initialFramesInParents=null,this._initialPivotsInParents=null,this._lastData=null}},unInitialize:function(){for(var e in this._WUXEventTokens)this._WUXEventTokens.hasOwnProperty(e)&&this._WUXEventTokens[e]&&(r.unsubscribe(this._WUXEventTokens[e]),this._WUXEventTokens[e]=null);if(this._rulers&&(this._rulers.destroy(),this._rulers=null),this._robot){if(!this._experienceBase.getManager("VCXContextManager").getContextFromName("PlayerMode"))for(var t in this.tokens)if(this.tokens.hasOwnProperty(t)){var i=this.tokens[t];this._robot.unsubscribe(i),this.tokens[t]=null}this._robot.setGetPositionCB(null),this._robot=null,this.tokens=null}},_allManipulationBeginCB:function(e){this._saveInitialPositions(),this._togglePrePicking(!1),this._experienceBase.getManager("VCXCommandManager").StartTransaction("Robot "+e.eventChannel.substring(0,e.eventChannel.indexOf("Begin")))},_allManipulationEndCB:function(e,t){if(this._experienceBase.getManager("VCXCommandManager").EndTransaction("Robot "+e.eventChannel.substring(0,e.eventChannel.indexOf("Begin"))),this._togglePrePicking(!0),"record"===this._experienceBase.odt){var i=this._arrayModifiables.map((function(e){return e.GetObject().GetID()}));if(this._lastData.translationVector){var a={commandName:"VCXTransformCmd",transformType:t,inputStr:this._lastData.translationVector.createJSON(),componentsIDs:i};this._experienceBase.getManager("VCXODTManager").LogAPI("VCXExecuteTransform",a)}}this._applyFinalPositions(),this._arrayModifiables=null,this._initialFramesInParents=null,this._initialPivotsInParents=null,this._lastData=null},showReferenceAxisSystem:function(e){this._requestedReferenceAxisSystemValue=e,this._experienceBase.getManager("VCXContextManager").getMainViewer().setReferenceAxisSystem(this._requestedReferenceAxisSystemValue)},_lineTranslationManipulationCB:function(e){this._arrayModifiables&&0!==this._arrayModifiables.length&&(this._updateWithManipulation("translation",e.translationVector,this._robot.initialMatrix),this._lastData=e)},_planeTranslationManipulationCB:function(e){this._lineTranslationManipulationCB(e)},_rotationManipulationCB:function(e){this._arrayModifiables&&0!==this._arrayModifiables.length&&(this._updateWithManipulation("rotation",e.rotationMatrix,this._robot.initialMatrix),this._lastData=e)},_screenPlaneTranslationBeginCB:function(e){var t=this._experienceBase.getManager("VCXContextManager").getContext(),a=i.getCommand("VCXTransformCmd",t);a&&!a.isRunning()&&a.end(),0===this._experienceBase.getManager("VCXSelectionManager").GetComponentsFromCurrentSelection("VCXWebComponentOccurrence").length?(this._robot.setAddToHSO(!0),this._robot.setAddToCSO(!0)):(this._robot.setAddToHSO(!1),this._robot.setAddToCSO(!1)),this._togglePrePicking(!1)},_screenPlaneTranslationEndCB:function(e){if(e.target){r.publish({event:"VCX_DONT_CHNG_ROBOT_POS_AT_TRANSFORM_BEGIN"});var t=this._experienceBase.getManager("VCXContextManager").getContext(),a=i.getCommand("VCXTransformCmd",t);a&&!a.isRunning()&&a.begin()}this._togglePrePicking(!0)},_updateWithManipulation:function(e,i,r){var s=null;switch(e.toLowerCase()){case"rotation":if(!(i instanceof t.Matrix4))return void console.error("A THREE.Matrix4 object is needed as input !");s=e=>n.buildPropertyLocationWithRotationInWCS(e,i,r);break;case"translation":if(!(i instanceof t.Vector3))return void console.error("A THREE.Vector3 object is needed as input !");s=e=>n.buildPropertyLocationWithTranslationInWCS(e,i,r);break;default:return void console.error("A compatible manipulation type ('translation' or 'rotation') must be specified as argument !")}this._restoreLastInitPositions();for(var o=new a(this._experienceBase),l=0;l<this._arrayModifiables.length;l++){var h=s(this._arrayModifiables[l]);o.ChangeProperty(this._arrayModifiables[l],h)}this._experienceBase.getManager("VCXCommandManager").Push(o)},_saveInitialPositions:function(){this._arrayModifiables=[];var e=this._experienceBase.getManager("VCXSelectionManager").GetComponentsFromSelection("CSO");e=n.filterChildrenOfCompsFromArray(e);for(var t=0;t<e.length;++t)if(e[t].IsKindOf("VCXWebComponentOccurrence")&&!e[t].IsDressup){var i=e[t].QueryInterface("VCXIModifiable");i&&this._arrayModifiables.push(i)}if(0!==this._arrayModifiables.length){this._initialFramesInParents={},this._initialPivotsInParents={};for(t=0;t<this._arrayModifiables.length;t++){var a=this._arrayModifiables[t].GetProperty("Actor.Position").GetPropertyValue();this._initialFramesInParents[t]=a.GetFrame().GetValue(),this._initialPivotsInParents[t]=a.GetPivot().GetValue()}}},_restoreLastInitPositions:function(){for(var e=0;e<this._arrayModifiables.length;e++){var i=(new t.Matrix4).copy(this._initialFramesInParents[e]),a=(new t.Matrix4).copy(this._initialPivotsInParents[e]),r=n.buildPropertyLocationWithFramePivot(i,a);this._arrayModifiables[e].OnChangeProperty("Actor.Position",r.GetPropertyValue()),this._arrayModifiables[e].OnChangePropertiesEnd()}},_applyFinalPositions:function(){for(let e=0;e<this._arrayModifiables.length;e++){let i=(new t.Matrix4).copy(this._initialFramesInParents[e]);const a=this._arrayModifiables[e].GetProperty("Actor.Position").GetPropertyValue(),r=(new t.Matrix4).copy(a.GetFrame().GetValue()),s=(new t.Matrix4).getInverse(i),o=(new t.Matrix4).multiplyMatrices(r,s),l=(new t.Matrix4).copy(this._initialPivotsInParents[e]),h=(new t.Matrix4).copy(o).multiply(l);let u=n.buildPropertyLocationWithFramePivot(r,h);this._arrayModifiables[e].OnChangeProperty("Actor.Position",u.GetPropertyValue()),this._arrayModifiables[e].OnChangePropertiesEnd()}},_togglePrePicking:function(e){var t=this._experienceBase.getManager("VCXContextManager"),i=t&&t.getMainViewer();i&&i.setPrePicking({activated:e})},executeTransformODT:function(e){var i=null,a=new t.Matrix4;"rotation"===e.transformType?(i=new t.Matrix4,a.setFromJSON(e.initialMatrixStr)):"translation"===e.transformType&&(i=new t.Vector3),i.setFromJSON(e.inputStr);this._experienceBase.ComponentsMap.GetComponentsFromIDs(e.componentsIDs);this._saveInitialPositions(),this._updateWithManipulation(e.transformType,i,a),this._arrayModifiables=null},displayRobot:function(e,t){var i=this._experienceBase.getManager("VCXContextManager").getMainViewer();i&&i.getRobot()&&(i.getRobot().setVisibility(e),e||(this._rulers&&this._rulers.hideAllRulers(),i.setReferenceAxisSystem(t),this._requestedReferenceAxisSystemValue=t))}});return Object.defineProperty(h.prototype,"componentType",{enumerable:!0,get:function(){return"VCXRobotAdapter"}}),h})),define("DS/VCXWebVisualization/VCXPinHandle",["DS/VCXWebVisualization/VCXHandle","DS/VCXWebVisualization/VCXBillBoardPinSphereNode3D","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/AxisSystemNode","DS/WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils"],(function(e,t,i,a,n,r,s,o,l){"use strict";return e.extend({init:function(e){this.width=1,this.height=1,this.widthBase=3.5,this.heightBase=1,this.widthSphere=1,this.heightSphere=1,this._materialBase=e.materialBase,this._materialHead=e.materialHead,this._parent(e)},_generateHandleGeom:function(e){var o=new a(e.name);this.isPreactivated=!1,this.isManipulated=!1;var h=this._experienceBase.getManager("VCXVisuManager");void 0===e.noz||e.noz;const u={width:this.widthBase,height:this.heightBase,cornerPoint:new i.Vector2(0,0),fill:!0,fillColor:null,noEdge:!0,material:this._materialBase};this._pinNodeBase=n.createRectangleNode(u),this._pinNodeBase.name="pinNodeBase",this._pinNodeBase.setShadow(!1),this._pinNodeBase.setFrustumCulled(!1),this._pinNodeBase.excludeFromCSO(!0),this._pinNodeBase.excludeFromHighlight(!0,!0),this._pinNodeBase.setMirror(!1),this._pinNodeBase.exludeFromBounding(!0),this._pinNodeBase.setRenderPasses([h.getRenderList("VCXPreManipulators"),h.getRenderList("VCXManipulators")]),this._pinNodeBase.setMatrix((new i.Matrix4).makeTranslation(-this.widthBase/2,-this.heightBase,0)),this._pinNodeBase.setPickParent(!0);var c={position:this.position,name:"billBoardNode"};this.billBoardNodeBase=new t(c),this.billBoardNodeBase.addChild(this._pinNodeBase),this.billBoardNodeBase.setPickParent(!0);const p={width:this.widthSphere,height:this.heightSphere,cornerPoint:new i.Vector2(0,0),fill:!0,fillColor:null,noEdge:!0,material:this._materialHead};this._pinNodeSphere=n.createRectangleNode(p),this._pinNodeSphere.name="pinNodeSphere",this._pinNodeSphere.setShadow(!1),this._pinNodeSphere.setFrustumCulled(!1),this._pinNodeSphere.excludeFromCSO(!0),this._pinNodeSphere.excludeFromHighlight(!0,!0),this._pinNodeSphere.setMirror(!1),this._pinNodeSphere.exludeFromBounding(!0),this._pinNodeSphere.setRenderPasses([h.getRenderList("VCXPreManipulators"),h.getRenderList("VCXManipulators")]),this._pinNodeSphere.setMatrix((new i.Matrix4).makeTranslation(-this.widthSphere/2,-this.heightBase-3*this.heightSphere/4,0)),this._pinNodeSphere.setPickParent(!0);var d={position:this.position,name:"billBoardNodeSphere"};this.billBoardNodeSphere=new t(d),this.billBoardNodeSphere.addChild(this._pinNodeSphere),this.billBoardNodeSphere.setPickParent(!0);new s({name:"AxisSystem",headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new l.Color(255,0,0,0),colorY:new l.Color(0,255,0,0),colorZ:new l.Color(0,0,255,0)},head:s.types.ARROW});this.billBoardNode=new a("Billboard");new s({name:"AxisSystem",headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new l.Color(255,0,0,0),colorY:new l.Color(0,255,0,0),colorZ:new l.Color(0,0,255,0)},head:s.types.ARROW}),new s({name:"AxisSystem",headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new l.Color(255,0,0,0),colorY:new l.Color(0,255,0,0),colorZ:new l.Color(0,0,255,0)},head:s.types.ARROW});return this.billBoardNode.addChild(this.billBoardNodeBase),this.billBoardNode.addChild(this.billBoardNodeSphere),this.billBoardNode.setPickParent(!0),this.fixedSizeNode=new r({name:"fixedSizeNode3D",ratio:this._displaySize}),this.fixedSizeNode.addChild(this.billBoardNode),this.fixedSizeNode.setPickParent(!0),o.add(this.fixedSizeNode),o.setPickParent(!0),this.sceneGraph.add(o),o}})})),define("DS/VCXWebVisualization/VCXAnchorHandle",["DS/VCXWebVisualization/VCXHandle","DS/Visualization/ThreeJS_DS"],(function(e,t){"use strict";return e.extend({init:function(e){this._parent(e)},getAnchorMatrixInWCS:function(){return this._parentOwnerComponent.QueryInterface("VCXIModifiable").GetAnchorWorldMatrix(this._id,null)},getMatrixInWCS:function(){return this.getAnchorMatrixInWCS()}})})),define("DS/VCXWebVisualization/VCXPickerTools",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebVisualization/VCXPickInfo","DS/VCXWebVisualization/VCXInteractor","DS/VCXWebSystem/VCXMathTools","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphUtils"],(function(e,t,i,a,n,r,s,o){"use strict";return e.extend({init:function(e){this._experienceBase=e||null,this._verticalDecay=0,this._useNormalConstraintToCamera=!1,this._useNormalConstraint=!1,this._usePointConstraint=!1,this._currentComponent=null},clear:function(){this._experienceBase=null},setVerticalDecay:function(e){this._verticalDecay=e},setCurrentComponent:function(e){this._currentComponent=e},useNormalConstraintToCamera:function(e){this._useNormalConstraintToCamera=e},useNormalConstraint:function(e,i){this._useNormalConstraint=!!e,e&&(this._normalConstraint=(new t.Vector3).copy(i)),this.useNormalConstraintToCamera(!1)},usePointConstraint:function(e,i){this._usePointConstraint=!!e,e&&(this._pointConstraint=(new t.Vector3).copy(i))},pick2DonGround:function(e,t,i){return this.pick(e,{pageX:t,pageY:i}).pickInfo.globalPosition},setCanonicMode:function(e,t){this._experienceBase.getManager("VCXCanonicsManager")},pickObject:function(e,t,i){const a=t.QueryInterface("W3AISGNodeHolder").getPathElement(),r=n.getMatrixFromOVzVy(e.currentViewpoint.getEyePosition(),e.currentViewpoint.getSightDirection(),e.currentViewpoint.getUpDirection()),s=(e.currentViewpoint.camera.matrix,o.getOrientedBoundingBoxFromPathElements([a],r,e)),l=e.currentViewpoint.project(s.cornerPoint),h=s.cornerPoint.clone().add(s.firstAxis).add(s.secondAxis).add(s.thirdAxis),u=e.currentViewpoint.project(h);let c=e.canvas.getBoundingClientRect();const p=Math.min(l.y,c.height),d=Math.min(l.x,c.width),_=Math.max(u.y,0),g=Math.max(u.x,0),m=.5*(d+g),M=.5*(p+_),f=d-g,C=p-_;let b;if(f>0&&C>0){const a=10,r=n.getSnailArray({radius:a});for(let n=0;n<r.length&&!b;n++){const s=r[n],o={pageX:m+s.x/a*f*.5+c.left,pageY:M+s.y/a*C*.5+c.top},l=this.pick(e,o,i);let h=!1;const u=l.pickInfo.modifiable&&l.pickInfo.modifiable.GetObject();(u&&u.GetID())===t.GetObject().GetID()&&(b||(b=l),h=!0)}}if(!b){const t={pageX:m+c.left,pageY:M+c.top};b=this.pick(e,t,i),b.pickInfo.pathElement=a,b.pickInfo.globalPosition=s.cornerPoint.clone().add(h).multiplyScalar(.5),b.pickInfo.globalNormal=e.currentViewpoint.getSightDirection().negate()}return b},pick:function(e,n,r,s){var o={mouse:{},viewer:e};let l;r&&this._currentComponent&&(l=this._currentComponent.QueryInterface("VCXIManipulable").getInteractor(r));if(s&&s.event)o.mouse=e.getMousePosition(s.event.from[0].getCurrentPosition(e.div));else{let i=e.canvas.getBoundingClientRect(),a=n.pageX-i.left,r=n.pageY-i.top-this._verticalDecay;o.mouse=e.getMousePosition(new t.Vector2(a,r))}o.pickInfo?o.pickInfo.reset():(o.pickInfo=new i(e,this._experienceBase),o.pickInfo.zShiftRatio=0);var h=o.pickInfo,u=null;if((!l||l&&0===l.type)&&!this._usePointConstraint){if(s&&s.eventChannel&&"BeginManipulate"!==s.eventChannel&&"EndManipulate"!==s.eventChannel)u=s.intersection;else{let t=this._experienceBase.odt?"repHybrid":"mesh";n&&"DSpointermove"===n.type&&(t="mesh"),u=e.pick(o.mouse,t,!0,null,!1)}if(h.ray=u.ray,u&&u.path&&u.path.length>0&&u.path[0]){h.pathElement=u.path[0].clone(),!1===e.multiViewerFix&&h.pathElement.externalPath.splice(0,1);var c=h.modifiable;let t=!0;c&&c.GetObject().IsDressup&&!c.GetObject().IsPickerSensitive&&(t=!1),t?(u.position&&(h.globalPosition=u.position.clone(),this._lastValidPosition=h.globalPosition),u.normal&&(l&&l.shouldReverseNormal?h.globalNormal=u.normal.clone().negate():h.globalNormal=u.normal.clone())):(u=null,h.pathElement=null)}}o.mouse.xPix/=window.devicePixelRatio,o.mouse.yPix/=window.devicePixelRatio;let p=this._experienceBase.getManager("VCXPaperManager").PixelToMM2(null,{x:o.mouse.xPix,y:o.mouse.yPix}),d=this._experienceBase.getManager("VCXPaperManager").Size;if(o.mouse.xPaper=p.x/d.x,o.mouse.yPaper=p.y/d.y,!u||0===u.path.length)if(l&&l.tag&&l.tag.Snap2D&&(l.constraint===a.EConstraint.Screen||l.type===a.EType.Screen))this._experienceBase.getManager("VCXCanonicsManager").snap2D(this._currentComponent,l,o,s);else{var _=this._lastValidPosition?this._lastValidPosition:new t.Vector3;this._usePointConstraint&&(_=this._pointConstraint);var g=e.currentViewpoint.getSightDirection().clone().negate().normalize();this._useNormalConstraint&&(g=this._normalConstraint),this._useNormalConstraintToCamera&&(g=e.currentViewpoint.getSightDirection().clone().negate().normalize());var m=new t.Plane(g,0).setFromNormalAndCoplanarPoint(g,_),M=e.currentViewpoint.create3DRayFrom2DPoint(new t.Vector2(o.mouse.xPix,o.mouse.yPix)).intersectPlane(m);M&&(h.globalPosition=M),h.globalNormal=e.currentViewpoint.getSightDirection().clone().negate().normalize()}if(h.smartMouse.x=o.mouse.xPix,h.smartMouse.y=o.mouse.yPix,!l||l&&0===l.type){var f=this._experienceBase.getManager("VCXCanonicsManager");const t=this._experienceBase.getManager("VCX3DGridManager");let i=!1;t&&h.modifiable&&(i=t.checkSnappingGrid(h.modifiable.GetObject()));let a=null;i?(h.considerSnapFilter=!1,a=t.detectGrid(e,h.modifiable?h.modifiable.GetObject():null,h.ray,l,h)):(t&&t.manageAllGuidingLines(null,null),h.considerSnapFilter=!0),f&&f.pickCanonics(h,l,s)}return this._useNormalConstraint&&(h.globalNormal=this._normalConstraint),this._useNormalConstraintToCamera&&(h.globalNormal=e.currentViewpoint.getSightDirection().clone().negate().normalize()),o}})})),define("DS/VCXWebVisualization/VCXHandleFactory",["UWA/Class","DS/VCXWebVisualization/VCXAnchorHandle","DS/VCXWebVisualization/VCXHandle","DS/VCXWebVisualization/VCXArrowHandle","DS/VCXWebVisualization/VCXPinHandle","DS/VCXWebVisualization/VCXInteractor","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils"],(function(e,t,i,a,n,r,s,o){"use strict";return e.extend({init:function(){this._materials={},this._textures={}},_getMaterialFromTexture:async function(e,t,i){return s.ImageUtils.loadTexture(t,{},(t=>{this._textures[e]=t,this._textures[e].flipY=!1,this._textures[e].minFilter=s.LinearMipMapLinearFilter;var a=this._getBasicMaterial(i);a.map=this._textures[e],this._materials[e]=a}))},_getBasicMaterial:function(e){var t=new s.MeshBasicMaterial({side:s.DoubleSide,enableClipPlanes:!1,opacity:1});return e?t.transparent=!0:t.alphaTest=.05,t.force=!0,t},createAllMaterialsForHandle:async function(){const e={BarHandle:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/VCX_Bar.png",transparent:!1},BarHandle1:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/VCX_Bar.png",transparent:!1},AnchorHandle1:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/VCX_Point.png",transparent:!1},AnchorHandle:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/VCX_Point.png",transparent:!1},AnchorDotHandle:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/VCX_Point_Blue.png",transparent:!1},PinBaseHandle:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/VCX_PinBaseV2.png",transparent:!0},PinHeadHandle:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/VCX_Point.png",transparent:!0},ArrowHandle:{path:o.getWebappsAssetUrl("VCXWebVisualization","texture")+"/AS_Arrow.png",transparent:!0}};for(let t in e)await this._getMaterialFromTexture(t,e[t].path,e[t].transparent)},createHandle:function(e,s){var o,l={parentOwner:e,id:s.id,manipulator:s.manipulator,interactor:s};s.data&&"number"==typeof s.data.anchorID?e.QueryInterface("VCXIModifiable").GetAnchorValue(s.data.anchorID)&&(l.material=this._materials.AnchorHandle,l.material1=this._materials.AnchorHandle1,l.pointHandleTexture=this._textures.AnchorHandle,l.pointDotHandleTexture=this._textures.AnchorDotHandle,o=new t(l)):s.manipulatorType&&s.manipulatorType===r.EManipulatorType.ArrowHandle?(l.material=this._materials.ArrowHandle,o=new a(l)):s.manipulatorType&&s.manipulatorType===r.EManipulatorType.PinHandle?(l.materialBase=this._materials.PinBaseHandle,l.materialHead=this._materials.PinHeadHandle,o=new n(l)):s.manipulatorType&&s.manipulatorType===r.EManipulatorType.BarHandle?(l.material=this._materials.BarHandle,l.material1=this._materials.BarHandle1,o=new i(l)):s.manipulatorType&&s.manipulatorType===r.EManipulatorType.Custom?(l.material=this._getBasicMaterial(!1),l.material.map=s.customIcon&&s.customIcon[0],l.material1=this._getBasicMaterial(!1),l.material1.map=s.customIcon&&s.customIcon[0],o=new i(l)):(l.material=this._materials.AnchorHandle,l.material1=this._materials.AnchorHandle1,l.pointHandleTexture=this._textures.AnchorHandle,l.pointDotHandleTexture=this._textures.AnchorDotHandle,o=new i(l));return o}})}));__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebVisualization/VCXManipulatorManager",["require","exports","DS/VCXWebVisualization/VCXHandleFactory","DS/Manipulators/ScreenPlaneManipulator","DS/Manipulators/LineTranslationManipulator","DS/Manipulators/HandlePointManipulator","DS/Manipulators/PlaneTranslationManipulator","DS/Manipulators/ScalingManipulator","DS/Manipulators/RotationManipulator","DS/VCXWebGUIInfra/VCXArcBar","DS/VCXWebComponents/VCXWebComponentBaseExperience","DS/CoreEvents/Events","DS/VCXWebVisibility/VCXIVisibility","DS/VCXWebVisualization/VCXInteractor","DS/VCXWebSystem/VCXMathTools","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/Visualization/ThreeJS_DS","DS/VCXWebVisualization/VCXPickerTools"],(function(e,t,i,a,n,r,s,o,l,h,u,c,p,d,_,g,m,M,f){"use strict";u=__importDefault(u),c=__importDefault(c),p=__importDefault(p),d=__importDefault(d),m=__importDefault(m);class C extends u.default{constructor(){super(...arguments),this._manipulatorsActive=!0,this._manipulatorsPreactive=!0,this._manipulationInProgress=!1,this._allInteractorShouldBeHidden=!1,this._isCatchByMagnetLine=!1,this.manipulatorPreActivated=!1,this.robotChangePositionAtCmdBeginning=!1,this._arcBarDirty=!0,this._arcBarVisibility=!1}initialize(){this._handleFactory=new i}getInitPhase(){return 8}unInitialize(){for(var e in this.removeManipulators(),this.refreshHandlesFromComponentList(null),this.hideArcBar(),this._WUXEventTokens)this._WUXEventTokens.hasOwnProperty(e)&&this._WUXEventTokens[e]&&(c.default.unsubscribe(this._WUXEventTokens[e]),this._WUXEventTokens[e]=null);for(;this._iManipulables&&this._iManipulables.length;){var t=this._iManipulables[0];this.unregisterManipulable(t)}this._iManipulables=null,this.unsubscribeAllInteractors(!0),this._manipulationTokens=null,this._manipulatorsActive=!1,this._manipulatorsPreactive=!1,this._lastValidPosition=null,this._lastManipulablesSelected=null,this._lastReturnedList=null,delete this._activeManipulables}async postInitialize(){this._iManipulables=[],this._manipulationTokens={},this._WUXEventTokens={};var e=this._experienceBase.getManager("VCXContextManager").getMainViewer();this.robotChangePositionAtCmdBeginning=!0,this._WUXEventTokens.VCX_DONT_CHNG_ROBOT_POS_AT_TRANSFORM_BEGIN=c.default.subscribe({event:"VCX_DONT_CHNG_ROBOT_POS_AT_TRANSFORM_BEGIN"},(e=>{this.robotChangePositionAtCmdBeginning=!1,this.robotTargetsAtBeginning=e&&e.targets,this.robotMatrixAtBeginning=e&&e.matrix})),await this._handleFactory.createAllMaterialsForHandle(),"boolean"!=typeof this._manipulatorsActive&&e.getManipulators&&(this._manipulatorsActive=!!e.getManipulators()),"boolean"!=typeof this._manipulatorsPreactive&&(this._manipulatorsPreactive=e.pPicking&&e.manipulatorManager&&e.manipulatorManager.preActivation),e.setManipulators({activated:this._manipulatorsActive,preActivate:this._manipulatorsPreactive}),this._WUXEventTokens.VCX_INTERACTOR_CREATED=c.default.subscribe({event:"VCX_INTERACTOR_ADDED"},(e=>{this.removeManipulators();var t=e.manipulable;this._iManipulables.includes(t)||this.registerManipulable(t)})),this._WUXEventTokens.VCX_INTERACTOR_REMOVED=c.default.subscribe({event:"VCX_INTERACTOR_REMOVED"},(e=>{this.removeManipulators();var t=e.manipulable;this._iManipulables.includes(t)||this.registerManipulable(t)})),this._WUXEventTokens.VCX_PREHIGHLIGHT_EMPTY=c.default.subscribe({event:"VCX_PREHIGHLIGHT_EMPTY"},(e=>{this._manipulationInProgress||this.removeManipulators()})),this._WUXEventTokens.VCX_HIGHLIGHT_EMPTY=c.default.subscribe({event:"VCX_HIGHLIGHT_EMPTY"},(e=>{this._manipulationInProgress||this.removeManipulators()})),this._WUXEventTokens.VCX_PREHIGHLIGHT_REMOVE=c.default.subscribe({event:"VCX_PREHIGHLIGHT_REMOVE"},(e=>{if(!this._manipulationInProgress){var t=e.map((function(e){return e.pathElement})),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.removeManipulators(),this.refreshHandlesFromComponentList(i)}})),this._WUXEventTokens.VCX_HIGHLIGHT_REMOVE=c.default.subscribe({event:"VCX_HIGHLIGHT_REMOVE"},(e=>{if(!this._manipulationInProgress){var t=e.map((function(e){return e.pathElement})),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.removeManipulators(),this.refreshHandlesFromComponentList(i)}})),this._WUXEventTokens.VCX_SELECTION_REMOVE=c.default.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},(e=>{this._manipulationInProgress||(this.removeManipulators(),this.refreshHandlesFromComponentList(e))})),this._WUXEventTokens.VCX_SELECTED_ACTORS_EMPTY=c.default.subscribe({event:"VCX_SELECTED_ACTORS_EMPTY"},(e=>{this._manipulationInProgress||(this.removeManipulators(),this.refreshHandlesFromComponentList(e))})),this._WUXEventTokens.VCX_PREHIGHLIGHT_ADD=c.default.subscribe({event:"VCX_PREHIGHLIGHT_ADD"},(e=>{if(!this._manipulationInProgress){var t=e.map((function(e){return e.pathElement})),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.addManipulators(i),this.refreshHandlesFromComponentList(i)}})),this._WUXEventTokens.VCX_HIGHLIGHT_ADD=c.default.subscribe({event:"VCX_HIGHLIGHT_ADD"},(e=>{if(!this._manipulationInProgress){var t=e.map((function(e){return e.pathElement})),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.addManipulators(i),this.refreshHandlesFromComponentList(i)}})),this._WUXEventTokens.VCX_SELECTION_ADD=c.default.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},(e=>{this._manipulationInProgress||(this.addManipulators(e),this.refreshHandlesFromComponentList(e))})),this._WUXEventTokens.VCX_VISIBILITY_CHANGED=c.default.subscribe({event:"VCX_VISIBILITY_CHANGED"},(e=>{if(e.visibility===p.default.EVisState.Hidden){this.refreshHandlesFromComponentList(e.components);for(let t of e.components){let e=t&&t.QueryInterface("VCXIManipulable");e&&e._rulers&&e._rulers.hideAllRulers()}}})),this._WUXEventTokens.VCX_DRESSUPS_REMOVE=c.default.subscribe({event:"VCX_DRESSUPS_REMOVED"},(e=>{for(var t=0;t<e.length;++t){var i=e[t],a=i&&i.QueryInterface("VCXIManipulable");a&&this.unregisterManipulable(a),a&&a._rulers&&a._rulers.hideAllRulers()}})),this._WUXEventTokens.VCX_DRESSUPS_ADDED=c.default.subscribe({event:"VCX_DRESSUPS_ADDED"},(e=>{this.removeManipulators();for(var t=0;t<e.length;++t){var i=e[t],a=i&&i.QueryInterface("VCXIManipulable");this._iManipulables.includes(a)||a&&this.registerManipulable(a)}})),this._WUXEventTokens.VCX_TEMPORARILY_HIDE_DECORATION=c.default.subscribe({event:"VCX_TEMPORARILY_HIDE_DECORATION"},(e=>{if(!this._manipulationInProgress){var t=this.getActiveManipulables();this.refreshHandlesFromComponentList(t),this._allInteractorShouldBeHidden=!0}})),this._WUXEventTokens.VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION=c.default.subscribe({event:"VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION"},(e=>{if(!this._manipulationInProgress){this._allInteractorShouldBeHidden=!1;var t=this.getActiveManipulables();this.refreshHandlesFromComponentList(t)}}))}registerManipulable(e){this._iManipulables.push(e),this.hideArcBar()}unregisterManipulable(e){for(var t=e.GetObject(),i=t.GetID(),a=0;a<this._iManipulables.length;++a){var n=this._iManipulables[a].GetObject().GetID();if(n===i)break}if(n===i){var r=this._iManipulables[a];if(r){var s=r.getAllInteractors();for(var o in s)if(s.hasOwnProperty(o)){let e=s[o];this.unsubscribeInteractor(t,e,!0)}this._iManipulables.splice(a,1)}}}unsubscribeAllInteractors(e){let t=[];for(let e in this._manipulationTokens)t.push(e);t.forEach((t=>{this.unsubscribeAllComponentInteractors(t,e)}))}unsubscribeAllComponentInteractors(e,t){let i=[],a=this._manipulationTokens&&this._manipulationTokens[e];if(a)for(let e in a)i.push(e);i.forEach((i=>{this.unsubscribeInteractor(e,i,t)}))}unsubscribeInteractor(e,t,i){var a=t.manipulator;if(a){var n=e.GetID();if(this._manipulationTokens&&this._manipulationTokens[n]&&this._manipulationTokens[n][t.id]){for(var r=Object.keys(this._manipulationTokens[n][t.id]),s=0;s<r.length;++s){var o=r[s];if("interactor"!==o){var l=this._manipulationTokens[n][t.id][o];l&&a.unsubscribe(l)}}delete this._manipulationTokens[n][t.id],a.interactor=null,t.manipulator.unlink(t.manipulatorToken),t.manipulator=null,t.manipulatorToken=null,i&&t.handle&&(t.handle.remove(),t.handle=null),t===this._currentArcBarInteractor&&this.hideArcBar()}}}addManipulators(e){if(delete this._activeManipulables,Array.isArray(e))for(var t=0;t<e.length;++t){var i=e[t],a=i&&i.QueryInterface("VCXIManipulable");if(a)-1===this._iManipulables.indexOf(a)&&this.registerManipulable(a)}else console.warn("Data given by SelectionManager for adds have changed..")}removeManipulators(){delete this._activeManipulables,this._manipulationInProgress=!1}updateAllInteractors(e){var t=e;if(!t){var i=this._experienceBase.getManager("VCXContextManager").getMainViewer();t={viewer:i,viewpoint:i.currentViewpoint}}if(Array.isArray(this._iManipulables)&&this._iManipulables.length>0)for(var a=0;a<this._iManipulables.length;a++)this._iManipulables[a].updateInteractors(t)}updateManipulatorOfInteractor(e,t,i){var a=e.GetObject(),n=e.QueryInterface("VCXIModifiable");let r=e.getInteractor(t);if(!r)return!1;if(r.data&&"number"==typeof r.data.anchorID&&!n.GetAnchorValue(r.data.anchorID))return r.manipulator&&this.unsubscribeInteractor(a,r,!0),delete e._interactors[t],!1;if(!r.active)return r.disable(),!1;var s=this.updateInteractorManipulator(e,r);if(r.manipulatorType!==d.default.EManipulatorType.None){if(!r.matrix)return console.error("Every interactor should have a set matrix"),!1;if(r.handle||(r.handle=this.createHandle(a,r)),!r.handle)return console.error("Handle not specified for this interactor"),!1;var o=r.handle;r.manipulatorToken||(r.manipulatorToken=s.linkToNode(r.node),o.updateManipulatorCallbacks(s)),o.setMatrix(r.handleMatrix),o.updateTexture(i);var l=r.handleInfos;r.handleInfos&&("boolean"==typeof l.stayVisible&&o.StayVisible(l.stayVisible),o.getOpacity()!==l.opacity&&o.setOpacity(l.opacity),o.getColor()!==l.color&&o.setColor(l.color),o.getSize()!==l.size&&o.setSize(l.size)),r.visibility===d.default.EVisibility.OnNodeVisibility?r.geometry&&(r.geometry.isVisible()?(r.VisibilityLockedByNode=1,o.Show()):(r.VisibilityLockedByNode=2,o.Hide())):!o.isDisplayed()&&(r.visibility===d.default.EVisibility.Always||o.getOpacity()>0)?(r.VisibilityLockedByNode=0,o.Show()):!o.isDisplayed()||r.visibility!==d.default.EVisibility.NoChange&&0!==o.getOpacity()?r.VisibilityLockedByNode=0:(r.VisibilityLockedByNode=0,o.Hide())}else!r.manipulatorToken&&r.pathElement&&(r.manipulatorToken=s.linkToNode(r.pathElement.getLastElement(!0))),s.setSelectionAllowed(!0);return r.active?r.enable():r.disable(),!0}updateManipulatorsOfManipulable(e,t){var i=!1,a=e.getAllInteractors();for(var n in a)this.updateManipulatorOfInteractor(e,n,t)&&(i=!0);i&&(e._active=!0)}removeManipulatorsFromIManipulable(e){var t=e.getAllInteractors(),i=e.GetObject();for(var a in t)if(t.hasOwnProperty(a)){let e=t[a];var n=e&&e.manipulator;n&&this.unsubscribeInteractor(i,n.interactor,!0)}}disableManipulable(e){var t=e.getAllInteractors();for(var i in t)if(t.hasOwnProperty(i)){let e=t[i];e&&e.disable()}e._active=!1}updateInteractorManipulator(e,t){return this._checkManipulatorMatchesInteractor(t)?t.updateAxis():(this.unsubscribeInteractor(e.GetObject(),t,!1),this.generateInteractorManipulator(e,t)),t.manipulator}_checkManipulatorMatchesInteractor(e){if(!e||!e.manipulator)return!1;var t=e.manipulator,i=!1;switch(e.type){case d.default.EType.Pick:i=t instanceof r;break;case d.default.EType.PlaneTranslation:i=t instanceof s;break;case d.default.EType.LineTranslation:i=t instanceof n;break;case d.default.EType.Scaling:i=t instanceof o;break;case d.default.EType.Rotation:i=t instanceof l;break;case d.default.EType.Screen:i=t instanceof a;break;default:i=!1}return i}generateInteractorManipulator(e,t){var i=null;switch(t.type){case d.default.EType.Pick:i=new r;break;case d.default.EType.PlaneTranslation:i=new s({axis:t.updateAxis()});break;case d.default.EType.LineTranslation:i=new n({axis:t.updateAxis()});break;case d.default.EType.Scaling:i=new o({axis:t.updateAxis()});break;case d.default.EType.Rotation:i=new l({axis:t.updateAxis()});break;case d.default.EType.Screen:i=new a}if(i){i.checkManipulatorsOnCreation(!0),i.setExclusive(!0),i.setDynamic(!0),t.manipulator=i,i.interactor=t;var h=i.subscribe("BeginPreactivate",(t=>this._beginPreactivateCB(e,t))),u=i.subscribe("Preactivate",(t=>this._preactivateCB(e,t))),c=i.subscribe("EndPreactivate",(t=>this._endPreactivateCB(e,t))),p=i.subscribe("BeginManipulate",(t=>this._beginManipulateCB(e,t))),_=i.subscribe("Manipulate",(t=>this._manipulateCB(e,t))),g=i.subscribe("EndManipulate",(t=>this._endManipulateCB(e,t))),m=i.subscribe("PrimaryPointerClick",(t=>this._primPointerClickCB(e,t))),M=i.subscribe("PrimaryPointerDoubleClick",(t=>this._primPointerDblClickCB(e,t))),f=e.GetObject().GetID();this._manipulationTokens[f]||(this._manipulationTokens[f]={}),this._manipulationTokens[f][t.id]={interactor:t,tokenBeginPreactivate:h,tokenPreactivate:u,tokenEndPreactivate:c,tokenBeginManipulate:p,tokenManipulate:_,tokenEndManipulate:g,tokenPrimPointerClick:m,tokenPrimPointerDblClick:M}}}checkManipulationInProgress(){for(var e=!1,t=0;t<this._iManipulables.length;++t){if(this._iManipulables[t].isManipulated()){e=!0;break}}return e}createHandle(e,t){return this._handleFactory.createHandle(e,t)}_computeRequestedMatrix(e){var t=e.manipulator;let i=e.manipulator.interactor;var a=new M.Matrix4;function n(e){if(e.intersection.ray&&e.viewer&&e.viewpoint){t._lastValidPosition||(t._lastValidPosition=(new M.Vector3).getPositionFromMatrix(i.matrixToUse));var n=(new M.Plane).setFromNormalAndCoplanarPoint(e.viewpoint.getSightDirection(),t._lastValidPosition),r=e.intersection.ray.intersectPlane(n);let s=new M.Vector3(0,0,1);s=e.manipulator._initNormal?e.manipulator._initNormal:e.viewpoint.getSightDirection().normalize().negate(),a=_.getMatrixFromOVz(r,s)}}switch(i.type){case d.default.EType.Screen:n(e);break;case d.default.EType.Pick:if(e.intersection.position&&e.intersection.path.length){t._lastValidPosition=e.intersection.position;var r=e.intersection.normal.clone().normalize();a=_.getMatrixFromOVzVx(e.intersection.position,r,_.getVxFromMatrix(i.initialMatrix))}else n(e);break;case d.default.EType.LineTranslation:case d.default.EType.PlaneTranslation:if(e.translationVector){a=i.initialMatrix.clone();var s=_.getOFromMatrix(i.initialMatrix);s.add(e.translationVector),a.setPosition(s)}break;case d.default.EType.Rotation:e.rotationMatrix&&((a=i.initialMatrix.clone()).setPosition((new M.Vector3).subVectors(_.getOFromMatrix(a),e.center)),(a=(new M.Matrix4).multiplyMatrices(e.rotationMatrix,a)).setPosition((new M.Vector3).addVectors(_.getOFromMatrix(a),e.center)));break;default:r=e.intersection.normal.clone().normalize();a=_.getMatrixFromOVzVx(e.intersection.position,r,_.getVxFromMatrix(i.initialMatrix))}return a}_changePropertiesFromPropSet(e,t){var i=e.GetHashing(),a=new g;a.AddOrModifyPropertySet(i,t);var n=new m.default(this._experienceBase);n.ChangePropertiesFromMap(a),this._experienceBase.getManager("VCXCommandManager").Push(n)}setArcBarInteractor(e){if(this._currentArcBarInteractor!==e){if(!e)return void this.hideArcBar();if(e.contextualMenuOptions){if(this._currentArcBarInteractor&&this._currentArcBarInteractor.arcBar&&this.hideArcBar(),!e.arcBar){const t=this._experienceBase.getManager("VCXGUIManager").isTouchActivated(),i=this._experienceBase,a=i.getManager("VCXContextManager");e.arcBar=new h({experienceBase:i,body:a.getUIFrame(),frmWindow:a.getFrameWindow(),actionBar:a.getActionBar(),heightElem:t?38:22,widthElem:t?38:22,padding:2,updateOpacity:!1,startAngle:0,clockwise:!1,center:new M.Vector2,radius:200,...e.contextualMenuOptions})}this._currentArcBarInteractor=e}this._arcBarDirty=!0}return this._currentArcBarInteractor}changeArcBarVisibility(e){this._arcBarVisibility!==e&&(this._arcBarVisibility=e,this._arcBarDirty=!0)}hideArcBar(){this._currentArcBarInteractor&&this._currentArcBarInteractor.arcBar&&(this._currentArcBarInteractor.arcBar.clear(),this._currentArcBarInteractor.arcBar=null,this._currentArcBarInteractor=null)}updateArcBar(e){const t=this._currentArcBarInteractor;if(t&&t.arcBar){const a=this._experienceBase.getManager("VCXGUIManager").isTouchActivated(),n=this._experienceBase,r=n.getManager("VCXPaperManager");let s=a?50:25,o=-45;const l=t.node&&t.node.getMatrixWorld()||t.matrix;let h=r.MMToPixel2(e,r.ModelToMM2(e,_.getOFromMatrix(l)));if(t.contextualMenuOptions&&t.contextualMenuOptions.useShapeInfo){const i=t.component.QueryInterface("W3AISGNodeHolder").getSGNode().GetShapeInfo();if(i.centerInPaper&&i.shape&&i.size){o=180*Math.atan2(i.size.x,i.size.y)/Math.PI-90;let t=1;[4,3,5].indexOf(i.shape)>-1&&(t/=Math.SQRT2),s=r.MMToPixel(.5*i.size.length())*t+(a?40:20),h=r.MMToPixel2(e,i.centerInPaper)}}t.arcBar.isVisible()!==this._arcBarVisibility&&t.arcBar.setVisible(this._arcBarVisibility);var i=n.getManager("VCXGUIManager");let u=i&&i.ComputePositionInUI(h,{isInsideCanvas:!0});t.arcBar.updateLayout(u,s,o),t.arcBar.updateCommandState(),t.arcBar.updateVisibilityStyle(),this._arcBarDirty=!1}}refreshHandlesVisAndPositions(e){var t=e.GetObject(),i=e.getAllInteractors();for(var a in i)if(i.hasOwnProperty(a)){let n=i[a],r=!1,s=!0;if(this._manipulationInProgress)r=!1,s=!1;else if(this.bManipulationsAllowed&&n.active&&!this._allInteractorShouldBeHidden){s=!0;let t=!0;const i=e.QueryInterface("VCXIVisibility");i&&(t=i.GetVisibility());this.getActiveManipulables().includes(e)&&t?0===n.VisibilityLockedByNode||1===n.VisibilityLockedByNode?r=!0:2===n.VisibilityLockedByNode&&(r=!1):r=!1}this.changeArcBarVisibility(s);const o=n.handle;o&&(r?o.isDisplayed()||o.Show():o.isDisplayed()&&o.Hide(!0),o.isDisplayed()&&o.setMatrix(n.handleMatrix)),this.bManipulationsAllowed||this.unsubscribeInteractor(t,n,!0)}}refreshHandlesFromComponentList(e){if(Array.isArray(e))for(var t=0;t<e.length;++t){const i=e[t],a=i&&i.QueryInterface("VCXIManipulable");a&&this.refreshHandlesVisAndPositions(a)}else{if(!this._iManipulables)return;for(t=0;t<this._iManipulables.length;t++){const e=this._iManipulables[t],i=e&&e.QueryInterface("VCXIManipulable");i&&this.refreshHandlesVisAndPositions(i)}}}getActiveManipulables(){if(this._activeManipulables)return this._activeManipulables;let e=[],t=[];for(var i=this._experienceBase.getManager("VCXSelectionManager"),a=i.GetComponentsFromSelection("CSO"),n=[],r=0;r<a.length;++r){var s=a[r].QueryInterface("VCXIManipulable");if(s){var o=this._experienceBase.getManager("VCXContextManager").getMainViewer();s.updateInteractors({viewer:o,viewpoint:o.currentViewpoint});var l=s.getAllInteractors();for(var h in l)if(l.hasOwnProperty(h)){let t=l[h];if(t.handleInfos&&t.handleInfos.stayVisible){e.push(s);break}}n.push(s)}}if(n.length>1){var u=!0;if(this._lastManipulablesSelected&&this._lastManipulablesSelected.length>1&&n.length===this._lastManipulablesSelected.length)for(var c=0;c<n.length;++c){var p=n[c];if(!this._lastManipulablesSelected.indexOf(p)){u=!1;break}}else u=!1;if(u)t=this._lastReturnedList.slice();else{if(this._disabledInteractors){for(var d=Object.keys(this._disabledInteractors),_=0;_<d.length;++_){var g=d[_];const e=this._experienceBase.ComponentsMap.GetComponentFromID(g),t=e&&e.QueryInterface("VCXIManipulable");t&&t.enableInteractors(this._disabledInteractors[g])}this._disabledInteractors={}}for(var m=[],M=!0,f=0;f<n.length;++f){const e=n[f].getActiveInteractors();if(M){for(var h in e)if(e.hasOwnProperty(h)){e[h].enableMultiSelect&&m.push(h)}M=!1}else for(var C=0;C<m.length;++C){var b=m[C];if(!b)continue;let t=e[b];t&&t.enableMultiSelect||delete m[C]}}if(0!==(m=m.filter((e=>Boolean(e)))).length)for(f=0;f<n.length;++f){var x=(p=n[f]).getActiveInteractors(),V=Object.keys(x),v=V.slice();for(C=0;C<m.length;++C){var y=m[C],S=V.indexOf(y);S>=0&&delete v[S]}g=p.GetObject().GetID();this._disabledInteractors||(this._disabledInteractors={}),this._disabledInteractors[g]||(this._disabledInteractors[g]=[]),this._disabledInteractors[g]=v.filter((e=>Boolean(e))),p.disableInteractors(this._disabledInteractors[g]),V.length!==this._disabledInteractors[g].length&&t.push(p)}}}else{if(this._disabledInteractors)for(d=Object.keys(this._disabledInteractors),_=0;_<d.length;++_){g=d[_];const e=this._experienceBase.ComponentsMap.GetComponentFromID(g),t=e&&e.QueryInterface("VCXIManipulable");t&&t.enableInteractors(this._disabledInteractors[g])}if(this._disabledInteractors={},0===n.length){var P=i.GetComponentsFromSelection("PSO"),w=[];for(r=0;r<P.length;++r){const e=P[r].QueryInterface("VCXIManipulable");e&&w.push(e)}t=1===w.length&&w[0]&&w[0].isActive()?[w[0]]:[]}else 1===n.length&&n[0]&&n[0].isActive()&&(t=[n[0]])}this._lastManipulablesSelected=n.slice(),this._lastReturnedList=t.slice();for(var A=0;A<e.length;++A){var D=e[A];t.indexOf(D)>=0&&delete e[A]}return e=e.filter((e=>Boolean(e))),this._activeManipulables=e.concat(t),this._activeManipulables}updateActiveInteractorsAndHandles(e){var t=this.getActiveManipulables();if(t)for(var i=0;i<t.length;i++)t[i].updateInteractors(e),this.refreshHandlesVisAndPositions(t[i])}preRender(e){e&&e.viewer&&e.viewer._isDigger||this.updateActiveInteractorsAndHandles(e)}getUpdatePriority(){return-6}update(e){if(this.bManipulationsAllowed&&Array.isArray(this._iManipulables)&&this._iManipulables.length>0){(this._experienceBase.getManager("VCXVisuManager").HasViewpointMoved||this._arcBarDirty)&&this.updateArcBar(e);for(var t=0;t<this._iManipulables.length;t++){var i=this._iManipulables[t];i.isManipulated()||(this.getActiveManipulables().includes(i)?this.updateManipulatorsOfManipulable(i,e):i._active&&this.disableManipulable(i))}}}setManipulatorsRequirements(e){e&&("boolean"==typeof e.active&&(this._manipulatorsActive=e.active),"boolean"==typeof e.preActive&&(this._manipulatorsPreactive=e.preActive))}getManipulatorsRequirements(){return{activated:this._manipulatorsActive,preActivate:this._manipulatorsPreactive}}_manageCursorPreactivate(e,t){var i=e&&e.cursorPreactivate;return"function"==typeof i?i(e,t):"string"==typeof e.cursorPreactivate?e.cursorPreactivate:"grab"}_beginPreactivateCB(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint;var i=this._experienceBase.getManager("VCXGUIManager");let a=t.manipulator.interactor;a&&a.handle&&(a.handle.preactivated=!0),this.setArcBarInteractor(a);var n=this._manageCursorPreactivate(a,t);this._manipulationInProgress||i.SetCursor(n),e.interact(t)}_preactivateCB(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint;var i=this._experienceBase.getManager("VCXGUIManager");this.manipulatorPreActivated=!0;let a=t.manipulator.interactor;var n=this._manageCursorPreactivate(a,t);this._manipulationInProgress||i.SetCursor(n),e.interact(t)}_endPreactivateCB(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint;var i=this._experienceBase.getManager("VCXGUIManager");let a=t.manipulator.interactor;a&&a.handle&&(a.handle.preactivated=!1),this.setArcBarInteractor(a),this._manipulationInProgress||i.SetCursor("default"),e.interact(t),this.manipulatorPreActivated=!1}_onManipulate(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint;let i=t.manipulator.interactor;i&&"EndManipulate"===t.eventChannel&&this.setArcBarInteractor(i),this._picker||(this._picker=new f(this._experienceBase)),this._picker.setCurrentComponent(e.GetObject());var a=t&&t.event&&t.event.from&&t.event.from.length?t.event.from[0].event:{},n=this._picker.pick(t.viewer,a,i.id,t);(n.pickInfo.magnet||i.handle)&&(n.pickInfo.magnet&&(t.magnet=n.pickInfo.magnet),t.intersection.position=n.pickInfo.globalPosition.clone(),t.intersection.normal=n.pickInfo.globalNormal.clone(),t.intersection.path=[],n.pickInfo.pathElement&&(t.intersection.path[0]=n.pickInfo.pathElement.clone())),n.mouse&&(n.mouse.snapX||n.mouse.snapY)&&(t.intersection.ray=t.viewpoint.create3DRayFrom2DPoint(new M.Vector2(n.mouse.xPix,n.mouse.yPix))),i.requestedMatrix=this._computeRequestedMatrix(t),t.requestedMatrix=i.requestedMatrix;var r=this.getActiveManipulables();(r.includes(e)||r.push(e),r.length>0)&&((o=r[0])._DisplayMagnetPointIsNeeded&&o._DisplayMagnetPointIsNeeded(!1));for(var s=0;s<r.length;s++){var o;if(o=r[s]){if(this._shouldManipulate(o,t)&&o.interact(t),o._isCatchByMagnetLine){o._isAlreadyAttachOnMagnetLine=!0;for(var l=0;l<r.length;l++){if((_=r[l])._isAlreadyAttachOnMagnetLine)continue;let e=_._attach2MagnetLine(o._attachedMagnetLine);e.IsEmpty()||(_._isAlreadyAttachOnMagnetLine=!0,i.requestedPropertyMap.Merge(e))}}if(i.requestedMatrix&&(i.requestedMatrix=null),i.requestedPropertyMap){var h=this._experienceBase.getManager("VCXScenarioManager");for(var u in i.requestedPropertyMap._map)if(i.requestedPropertyMap._map.hasOwnProperty(u)){var c=h.ModifiableServer.GetModifiableFromHashing(u),p=i.requestedPropertyMap.GetPropertySet(u);this._changePropertiesFromPropSet(c,p)}i.requestedPropertyMap=null}else if(i.requestedPropertySet){var d=o.QueryInterface("VCXIModifiable");this._changePropertiesFromPropSet(d,i.requestedPropertySet),i.requestedPropertySet=null}for(l=0;l<r.length;l++){var _;(_=r[l])._isAlreadyAttachOnMagnetLine=!1,_._isCatchByMagnetLine=!1}}}}_shouldManipulate(e,t){return!this._isCatchByMagnetLine}_beginManipulateCB(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint,this._experienceBase.getManager("VCXContextualContentManager")&&this._experienceBase.getManager("VCXContextualContentManager").contextualShortcutToolbarCtrl&&this._experienceBase.getManager("VCXContextualContentManager").contextualShortcutToolbarCtrl.hideContextualBar();var i=this._experienceBase.getManager("VCXDressupManager");i&&i.changeDressupsPickability(!1);var a=e.getActiveInteractors();for(var n in a)if(a.hasOwnProperty(n)){let e=a[n];e.initialMatrix=e.matrixToUse}e.setManipulated(!0),e.changePickability(!1),this._manipulationInProgress=!0,this._experienceBase.getManager("VCXContextManager").getMainViewer().setPrePicking({activated:!1}),this.refreshHandlesVisAndPositions(e);let r=t.manipulator.interactor;var s=r&&r.cursorManipulate||"grabbing";r&&r.setManipulated(!0);var o=this._experienceBase.getManager("VCXGUIManager");o&&o.SetCursor(s);var l=0,h=r&&r.id.split("Anchor.")[1];h&&(l=parseInt(h));var u=e.QueryInterface("VCXIModifiable"),p=u&&u.GetAnchorWorldMatrix(l,t);p&&(t.manipulator._initNormal=_.getVzFromMatrix(p),t.manipulator._initPosition=_.getOFromMatrix(p));for(var d=this.getActiveManipulables(),g=0;g<d.length;g++){var m=d[g];m&&(m._isCatchByMagnetLine=!1,m._attachedMagnetLine=null)}c.default.publish({event:"VCX_INTERACTOR_BEGIN_MANIPULATE",data:{interactor:r,attachedOccurrences:u.GetAttachedOccurences&&u.GetAttachedOccurences(),attachedOccurrence:u.GetAttachedOccurence&&u.GetAttachedOccurence(l)}}),this._onManipulate(e,t),t.ignoreTransaction||this._experienceBase.getManager("VCXCommandManager").StartTransaction()}_manipulateCB(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint;let i=t.manipulator.interactor;var a=i&&i.cursorManipulate||"grabbing",n=this._experienceBase.getManager("VCXGUIManager");n&&n.SetCursor(a),this._onManipulate(e,t)}_endManipulateCB(e,t){if(t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint,e.setManipulated(!1),e.changePickability(!0),this._manipulationInProgress=this.checkManipulationInProgress(),this._onManipulate(e,t),t.ignoreTransaction||this._experienceBase.getManager("VCXCommandManager").EndTransaction(),!this._manipulationInProgress){var i=this._experienceBase.getManager("VCXContextManager").getMainViewer();i&&i.setPrePicking({activated:!0}),this.refreshHandlesVisAndPositions(e)}this._experienceBase.getManager("VCXGUIManager").SetCursor("default");var a=this._experienceBase.getManager("VCXCanonicsManager");a&&(a.clear(),this._picker=null),t.manipulator._initNormal&&(delete t.manipulator._initNormal,delete t.manipulator._initPosition);var n=e.getActiveInteractors();for(var r in n)if(n.hasOwnProperty(r)){let e=n[r];delete e.initialMatrix,e&&e.setManipulated(!1)}var s=this._experienceBase.getManager("VCXDressupManager");s&&s.changeDressupsPickability(!0),c.default.publish({event:"VCX_INTERACTOR_END_MANIPULATE",data:t})}_primPointerClickCB(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint;let i=t.manipulator.interactor;if(this.setArcBarInteractor(i),e.interact(t),i.requestedMatrix&&(i.requestedMatrix=null),i.requestedPropertySet){var a=e.QueryInterface("VCXIModifiable");this._changePropertiesFromPropSet(a,i.requestedPropertySet),i.requestedPropertySet=null}c.default.publish({event:"VCX_INTERACTOR_END_MANIPULATE",data:t})}_primPointerDblClickCB(e,t){t.viewpoint=t&&t.viewer&&t.viewer.currentViewpoint,e.interact(t)}_testMagnetLine(e,t){e.viewpoint=e&&e.viewer&&e.viewer.currentViewpoint;var i=t.QueryInterface("VCXIModifiable"),a=i.QueryInterface("VCXIMagnetLine");if(null===a)return;if(!a.isMagnetizable())return;for(var n=this._experienceBase.ComponentsMap.GetComponentFromType("VCXMagnetLine_Spec"),r=[],s=0;s<n.length;s++){const e=n[s];if(e){const t=e.QueryInterface("VCXIVisibility");if(t&&t.GetVisibility()){const t=e.QueryInterface("VCXIModifiable");t&&r.push(t)}}}if(0===r.length)return;const o=this._experienceBase.getManager("VCXPaperManager");var l=o.ModelToMM2(e,_.getOFromMatrix(e.manipulator.interactor.requestedMatrix)),h=new M.Vector2(l.x,l.y);for(s=0;s<r.length;s++){const t=r[s];if(t.GetObject().isOnMagnetLine(h)){var u=t.GetObject().getNewProposalMagnetPositionIn2D(i,h),c=o.MMToModel2(e,u);if(e.translationVector){var p=e.manipulator.initial3dIntersectionPoint.clone();e.translationVector.subVectors(c,p)}t.GetObject().addModifiableAttached(i);break}t.GetObject().removeModifiableAttached(i)}}getVersion(){return"3.1.3"}get componentType(){return"VCXManipulatorManager"}get bManipulationsAllowed(){return!this._allInteractorShouldBeHidden&&this._manipulatorsActive}}return C}));