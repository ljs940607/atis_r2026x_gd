define("DS/DELWebViewerWorkInstructionCommon/View/DELSubViewCell",[],(function(){"use strict";return function(e,t){var i=UWA.is(e)&&UWA.is(t)?[e,t]:[0,0],a={x:0,y:0},o=0,n=0,r=null,s=null;return{getCellText:function(){return null},getCellImage:function(){return r},setCellImage:function(e){(!r||e&&e.src!==r.src)&&(r=e,s=null)},getCellImageToDisplay:function(){return s},setCellImageToDisplay:function(e){s&&(!e||e.width===s.width&&e.height===s.height&&e.src===s.src)||(s=e)},removeCellImageToDisplay:function(){s=null},getCellIndex:function(){var e={};return e.row=i[0],e.col=i[1],e},getCellPos:function(){return a},setCellPos:function(e){a=e},getCellWd:function(){return o},setCellWd:function(e){o=e},getCellHt:function(){return n},setCellHt:function(e){n=e}}}})),define("DS/DELWebViewerWorkInstructionCommon/View/DELViewMathsVector3D",[],(function(){"use strict";var e;return e||(e=new function(){var e=1e-6;return{clone:function(e){var t=[];return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},squaredLength:function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},normalize:function(t,i){var a,o=[0,0,0],n=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];return Math.abs(n-1)<e?((o=i||[0,0,0])[0]=t[0],o[1]=t[1],o[2]=t[2]):n>e&&(a=Math.sqrt(n),(o=i||[0,0,0])[0]=t[0]/a,o[1]=t[1]/a,o[2]=t[2]/a),o},sub:function(e,t,i){var a=i||[0,0,0];return a[0]=t[0]-e[0],a[1]=t[1]-e[1],a[2]=t[2]-e[2],a},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},subAndLength:function(e,t,i){var a=i||[0,0,0];return a[0]=t[0]-e[0],a[1]=t[1]-e[1],a[2]=t[2]-e[2],Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},multiplyAndAdd:function(e,t,i,a){var o=a||[0,0,0];return o[0]=e[0]*t+i[0],o[1]=e[1]*t+i[1],o[2]=e[2]*t+i[2],o}}}),e})),define("DS/DELWebViewerWorkInstructionCommon/Utils/WKINodeUtils",["UWA/Core"],(function(e){"use strict";let t={isADMUPath:function(t){var i=!1,a=["DMUReviewBag","WKINodeBag","DECReview"];if(t&&e.is(t.externalPath,"array"))for(let e=0;e<t.externalPath.length;e++){let o=t.externalPath[e].name;if(a.indexOf(o)>-1){i=!0;break}}return i},isPictogram:function(e){let t=!1,i=e&&e.getLastElement?e.getLastElement():null;if(i){let e=i.getUserData();t=!(!e||"Pictogram"!==e.type)}return t},getWKIContentNodeId:function(e){let t,i=e&&e.getLastElement?e.getLastElement():null;if(i){let e=i.getUserData();t=e&&e.uuid?e.uuid:null}return t}};return t})),define("DS/DELWebViewerWorkInstructionCommon/DELWKIContent/DELWkiContentDataParser",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS"],(function(e,t,i){"use strict";const a={AssociativeViewPicture:!1,Pictogram:!0};var o=[{name:"isVisible",type:"bool",JSONname:"DELAVPProperties.GraphicProperties.visible",defaultValue:!0},{name:"hasALeader",type:"bool",JSONname:"DELAVPProperties.HasALeader",defaultValue:!1},{name:"leaderEndType",type:"string",JSONname:"DELAVPProperties.LeaderEndType"},{name:"position",type:"Vector3",JSONname:"DELAVPProperties.LeaderBreakPoint3D",defaultValue:new i.Vector3},{name:"isFilled",type:"bool",JSONname:"DELAVPProperties.filled",defaultValue:!0},{name:"hasBorder",type:"bool",JSONname:"DELAVPProperties.border",defaultValue:!1},{name:"subViewImage",type:"ImageURL",JSONname:"DELAVPProperties.imgData.imgSrc"},{name:"imageHeight",type:"float",JSONname:"DELAVPProperties.imgData.imageBoxHeight"},{name:"imageWidth",type:"float",JSONname:"DELAVPProperties.imgData.imageBoxWidth"},{name:"fImageHeight",type:"float",JSONname:"DELAVPProperties.imgData.imageBoxHeight"},{name:"fImageWidth",type:"float",JSONname:"DELAVPProperties.imgData.imageBoxWidth"},{name:"anchorMode",type:"string",JSONname:"DELAVPProperties.AnchorMode"},{name:"zoomMode",type:"bool",JSONname:"DELAVPProperties.ZoomMode",defaultValue:!1},{name:"leaderAttachHeightRatio",type:"float",JSONname:"DELAVPProperties.LeaderAttachHeightRatio"},{name:"leaderAttachLengthRatio",type:"float",JSONname:"DELAVPProperties.LeaderAttachHeightRatio"},{name:"leaderAttachWidthRatio",type:"float",JSONname:"DELAVPProperties.LeaderAttachWidthRatio"},{name:"boxRotationAngle",type:"float",JSONname:"DELAVPProperties.BoxRotationAngle"},{name:"graphicProperties.borderRadius",type:"float",JSONname:"DELAVPProperties.BorderRadius"},{name:"graphicProperties.fillStyle.color",type:"Color",JSONname:"DELAVPProperties.GraphicProperties.FillStyle.color",defaultValue:new i.Color("#ffffff")},{name:"graphicProperties.fillStyle.opacity",type:"float",JSONname:"DELAVPProperties.GraphicProperties.FillStyle.opacity",defaultValue:1},{name:"graphicProperties.lineStyle.thickness",type:"float",JSONname:"DELAVPProperties.GraphicProperties.LineStyle.thickness",defaultValue:1},{name:"graphicProperties.lineStyle.pattern",type:"string",JSONname:"DELAVPProperties.GraphicProperties.LineStyle.pattern",defaultValue:"1"},{name:"graphicProperties.lineStyle.color",type:"Color",JSONname:"DELAVPProperties.GraphicProperties.LineStyle.color",defaultValue:new i.Color("#000000")},{name:"graphicProperties.leaderStyle.thickness",type:"float",JSONname:"DELAVPProperties.GraphicProperties.LeaderStyle.thickness",defaultValue:1},{name:"graphicProperties.leaderStyle.pattern",type:"string",JSONname:"DELAVPProperties.GraphicProperties.LeaderStyle.pattern",defaultValue:"1"},{name:"graphicProperties.leaderStyle.color",type:"Color",JSONname:"DELAVPProperties.GraphicProperties.LeaderStyle.color",defaultValue:new i.Color("#000000")},{name:"leaderPointingPoints",type:"array",JSONname:"DELAVPProperties.Leaders",defaultValue:[]},{name:"lLeaderPointingPoints",type:"ListVector3",JSONname:"DELAVPProperties.Leaders.0.AbsPointPoint3D",defaultValue:[]},{name:"vLeaderAbsPointPoint3D",type:"Vector3",JSONname:"DELAVPProperties.Leaders.0.AbsPointPoint3D",defaultValue:new i.Vector3},{name:"pointedReferences",type:"array",JSONname:"DELAVPProperties.Leaders",defaultValue:[]},{name:"isVisible",type:"bool",JSONname:"DELPictogramProperties.GraphicProperties.visible",defaultValue:!0},{name:"hasALeader",type:"bool",JSONname:"DELPictogramProperties.HasALeader",defaultValue:!1},{name:"leaderEndType",type:"string",JSONname:"DELPictogramProperties.LeaderEndType"},{name:"position",type:"Vector3",JSONname:"DELPictogramProperties.LeaderBreakPoint3D",defaultValue:new i.Vector3},{name:"isFilled",type:"bool",JSONname:"DELPictogramProperties.filled",defaultValue:!0},{name:"hasBorder",type:"bool",JSONname:"DELPictogramProperties.border",defaultValue:!1},{name:"subViewImage",type:"ImageURL",JSONname:"DELPictogramProperties.imgData.imgSrc"},{name:"imageHeight",type:"float",JSONname:"DELPictogramProperties.imgData.imageBoxHeight"},{name:"imageWidth",type:"float",JSONname:"DELPictogramProperties.imgData.imageBoxWidth"},{name:"fImageHeight",type:"float",JSONname:"DELPictogramProperties.imgData.imageBoxHeight"},{name:"fImageWidth",type:"float",JSONname:"DELPictogramProperties.imgData.imageBoxWidth"},{name:"anchorMode",type:"string",JSONname:"DELPictogramProperties.AnchorMode"},{name:"zoomMode",type:"bool",JSONname:"DELPictogramProperties.ZoomMode",defaultValue:!1},{name:"leaderAttachHeightRatio",type:"float",JSONname:"DELPictogramProperties.LeaderAttachHeightRatio"},{name:"leaderAttachLengthRatio",type:"float",JSONname:"DELPictogramProperties.LeaderAttachHeightRatio"},{name:"leaderAttachWidthRatio",type:"float",JSONname:"DELPictogramProperties.LeaderAttachWidthRatio"},{name:"boxRotationAngle",type:"float",JSONname:"DELPictogramProperties.BoxRotationAngle"},{name:"graphicProperties.borderRadius",type:"float",JSONname:"DELPictogramProperties.BorderRadius"},{name:"graphicProperties.fillStyle.color",type:"Color",JSONname:"DELPictogramProperties.GraphicProperties.FillStyle.color",defaultValue:new i.Color("#ffffff")},{name:"graphicProperties.fillStyle.opacity",type:"float",JSONname:"DELPictogramProperties.GraphicProperties.FillStyle.opacity",defaultValue:1},{name:"graphicProperties.lineStyle.thickness",type:"float",JSONname:"DELPictogramProperties.GraphicProperties.LineStyle.thickness",defaultValue:1},{name:"graphicProperties.lineStyle.pattern",type:"string",JSONname:"DELPictogramProperties.GraphicProperties.LineStyle.pattern",defaultValue:"1"},{name:"graphicProperties.lineStyle.color",type:"Color",JSONname:"DELPictogramProperties.GraphicProperties.LineStyle.color",defaultValue:new i.Color("#000000")},{name:"graphicProperties.leaderStyle.thickness",type:"float",JSONname:"DELPictogramProperties.GraphicProperties.LeaderStyle.thickness",defaultValue:1},{name:"graphicProperties.leaderStyle.pattern",type:"string",JSONname:"DELPictogramProperties.GraphicProperties.LeaderStyle.pattern",defaultValue:"1"},{name:"graphicProperties.leaderStyle.color",type:"Color",JSONname:"DELPictogramProperties.GraphicProperties.LeaderStyle.color",defaultValue:new i.Color("#000000")},{name:"leaderPointingPoints",type:"array",JSONname:"DELPictogramProperties.Leaders",defaultValue:[]},{name:"lLeaderPointingPoints",type:"ListVector3",JSONname:"DELPictogramProperties.Leaders.0.AbsPointPoint3D",defaultValue:[]},{name:"vLeaderAbsPointPoint3D",type:"Vector3",JSONname:"DELPictogramProperties.Leaders.0.AbsPointPoint3D",defaultValue:new i.Vector3},{name:"pointedReferences",type:"array",JSONname:"DELPictogramProperties.Leaders",defaultValue:[]}],n=function(){var t,n,r,s,h,l,c,d,p;r=function(e){return"string"==typeof e?"true"===e||"false"!==e&&null:e},s=function(e){return parseFloat(e)},h=function(e){var t=e.replace(/[RGB( )]/gi,"").split(",");return(new i.Color).setRGB(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))},l=function(e){var t=e.split?e.split(" "):null;return t?new i.Vector3(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])):3===e.length?new i.Vector3(e[0],e[1],e[2]):void 0},c=function(e){var t,i=[];for(t=0;t<e.length;t++)i.push(l(e[t]));return i},d=function(e){var t,i=new Image;return(t=e&&0===e.indexOf('"')?JSON.parse(e):e)&&""!==t&&(i.src=t),i},p=function(e,t){if(null!=e&&""!==e&&null!=t&&""!==t)switch(t){case"bool":return r(e);case"float":return s(e);case"Color":return h(e);case"Vector3":return l(e);case"ListVector3":return c(e);case"ImageURL":return d(e);default:return e}},t=function(t){var i=[];return e.is(t)&&t.forEach((function(e){i.push(p(e.AbsPointPoint3D,"Vector3"))})),i};let u=function(t){var i=[];return e.is(t,"array")&&t.forEach((function(e){i.push(p(e.PointedReference,"string"))})),i};return n=function(t,i){var a,o=t.occurrences||{},n=[];return e.is(i)&&e.Array.detect(o,(function(e){e.id!==i||(a=e.path)})),a instanceof Array&&t.entities instanceof Array&&a.forEach((function(e){t.entities.forEach((function(t){e===t.id&&n.push(t.identifier)}))})),n},{getParseWKIData:function(i){let r=[],s=[],h=function(i){var r,h,l,c={},d=function(e,t){var i=c;e.forEach((function(a,o){i.hasOwnProperty(a)||(o===e.length-1?i[a]=t:i[a]={}),i=i[a]}))};c.id=i.id,c.uuid=i.UUID,c.name=i.Name,c.type=i.type,c.isPickable=!e.is(a[i.type])||a[i.type],o.forEach((function(a){if(e.is(a.JSONname))for(r=i,h=a.JSONname.split(".");0===h.length&&("leaderPointingPoints"===a.name?c[a.name]=t(p(r,a.type)):"pointedReferences"===a.name?c[a.name]=u(p(r,a.type)):(l=a.name.split(".")).length>1?d(l,p(r,a.type)):c[a.name]=p(r,a.type)),r=r[h.shift()],e.is(r););}));let g=s.find((function(t){if(e.is(t.entities))return t.entities}));return c.pointedReferenceOccurencesIdToPathMap={},e.is(c.pointedReferences,"array")&&c.pointedReferences.forEach((e=>{c.pointedReferenceOccurencesIdToPathMap[e]=n(g,e)})),c};return i&&i.data&&i.uuid&&(s=i&&i.data&&i.data.Model[0]&&i.data.Model[0].WKIObjects?i.data.Model[0].WKIObjects:[],s.forEach((function(t){var a,o,n,l,c;"View"===t.type&&e.is(t.proxiedSlideUuid)&&t.proxiedSlideUuid===i.uuid&&(a=t,i.uuid,n=[],l=[],c=[],e.is(a)&&(e.is(a.subObjects)||e.is(a.ObjectOverloads))&&(l=a.subObjects||[],c=a.ObjectOverloads||[],l.forEach((e=>{s.forEach((t=>{"AssociativeViewPicture"===t.type&&e===t.id&&n.push(h(t))}))})),c.forEach((t=>{s.forEach((i=>{if("Pictogram"===i.type&&t.targetId===i.id){o=h(i);let a=t.state;a&&(o.isVisible=!e.is(a.visible,"boolean")||a.visible,e.is(a.LeaderBreakPoint3D,"array")&&(o.position.x=a.LeaderBreakPoint3D[0],o.position.y=a.LeaderBreakPoint3D[1],o.position.z=a.LeaderBreakPoint3D[2])),n.push(o)}}))}))),r=n)}))),r}}};let r;return e.is(r)||(r=new n),r})),define("DS/DELWebViewerWorkInstructionCommon/View/DELSubViewTools",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Mesh/Mesh","DS/SceneGraphNodes/ArrowNode","DS/Visualization/MaterialManager","DS/DELWebViewerWorkInstructionCommon/View/DELViewMathsVector3D"],(function(e,t,i,a,o,n){"use strict";var r,s=function i(){var r,s,h,l,c;return r=function(t){var i=(new e.Matrix4).setRotationFromQuaternion(t.clone()).elements;return{X:new e.Vector3(i[0],i[1],i[2]),Y:new e.Vector3(i[4],i[5],i[6]),Z:new e.Vector3(i[8],i[9],i[10]),Origin:new e.Vector3(i[12],i[13],i[14])}},s=function(t,i,a){var o=(new e.Projector).projectVector(i.clone(),t.viewpoints[0].getCamera()),n=Math.round((0-o.y)*(a.getContent().offsetHeight/2))+a.getContent().offsetHeight/2,r=Math.round(o.x*(a.getContent().offsetWidth/2))+a.getContent().offsetWidth/2,s=n>0&&n<a.getContent().offsetWidth&&r>0&&r<a.getContent().offsetWidth;return{top:n,left:r,bottom:a.getContent().offsetHeight-n,right:a.getContent().offsetWidth-r,inWindow:s}},h=function(t,i){var a,o,n,r,s,h=t.currentViewpoint;return 1===h.getProjectionType()?a=h.camera.top-h.camera.bottom:(o=h.getAngle()*Math.PI/180,n=h.getEyePosition(),r=(new e.Vector3).copy(i),s=(new e.Vector3).subVectors(r,n),a=2*Math.tan(.5*o)*s.length()),a/t.SCREEN_HEIGHT},l=function(e,t,i){var a,o,r={};return UWA.is(e)&&UWA.is(t)&&UWA.is(i)&&(a=n.squaredLength(i))>1e-6&&(o=n.dot(n.sub(e,t),i)/a,r.aPosition=n.multiplyAndAdd(i,o,e),r.distance=n.subAndLength(e,r.aPosition)),r},c=function(e,t,i,a){var o,n=void 0!==a?a:.001,r=!0;switch(void 0!==i?i:"float"){case"float":r=Math.abs(e-t)<n;break;case"Vector3":r=Math.abs(e.x-t.x)<n&&Math.abs(e.y-t.y)<n&&Math.abs(e.z-t.z)<n;break;case"Matrix4":for(o=0;o<16&&r;o++)r=Math.abs(e.elements[o]-t.elements[o])<n}return r},{colorToHex:function(e){var t,i,a,o,n,r,s;if(UWA.is(e)){if(e.substr&&"#"===e.substr(0,1))return e;if(void 0!==e.r&&void 0!==e.g&&void 0!==e.b)return e.r<0||e.g<0||e.b<0?null:"#"+(t=(t=Math.round(255*e.r).toString(16)).length<2?"0"+t:t)+(i=(i=Math.round(255*e.g).toString(16)).length<2?"0"+i:i)+(a=(a=Math.round(255*e.b).toString(16)).length<2?"0"+a:a);if(o=/(.*?)rgb\((\d+), *(\d+), *(\d+)\)/.exec(e),UWA.is(o))return 0===parseInt(o[2],10)&&0===parseInt(o[3],10)&&0===parseInt(o[4],10)?"#000000":(n=parseInt(o[2],10),r=parseInt(o[3],10),s=parseInt(o[4],10)|r<<8|n<<16,"#"+(0===n?"00"+s.toString(16):s.toString(16)))}return e},getViewpointInfo:function(t){var i,a,o;if(UWA.is(t))return i=(new e.Matrix4).lookAt(new e.Vector3,t.getSightDirection(),t.getUpDirection()),a=(new e.Quaternion).setFromRotationMatrix(i),o=r(a),{position:t.getEyePosition(),sight:t.getSightDirection(),right:o.X,up:t.getUpDirection(),distance:t.getTargetDistance()}},getLineFromWindowPosition:function(t,i,a){var o=new e.Vector3((i-window.pageXOffset)/t.canvas.offsetWidth*2-1,-(a-window.pageYOffset)/t.canvas.offsetHeight*2+1,.5),n=(new e.Projector).pickingRay(o.clone(),t.currentViewpoint.camera);return{position:n.ray.origin.clone(),direction:n.ray.direction.clone()}},getViewerPositionFromPoint:function(t,i){var a=(new e.Projector).projectVector(i.clone(),t.viewpoints[0].getCamera()),o=Math.round((0-a.y)*(t.canvas.offsetHeight/2))+t.canvas.offsetHeight/2,n=Math.round(a.x*(t.canvas.offsetWidth/2))+t.canvas.offsetWidth/2,r=o>0&&o<t.canvas.offsetHeight&&n>0&&n<t.canvas.offsetWidth;return{top:o,left:n,bottom:t.canvas.offsetHeight-o,right:t.canvas.offsetWidth-n,inWindow:r}},convertPixelToModel:function(e){return UWA.is(e.coords)?e.sizeInPixels*h(e.viewer,e.coords):e.sizeInPixels/(96/25.4)},convertModelToPixels:function(e){return UWA.is(e.coords)?e.sizeInMM/h(e.viewer,e.coords):e.sizeInMM*(96/25.4)},getDashPattern:function(e,t,i){var a,n,r=e;return r=parseFloat(r),i?r:(n=(a=new o).getDashPattern?a.getDashPattern(r):a._getDashPattern(r),isNaN(t)||n.forEach((function(e){t})),n)},computeLinePlaneDistance:function(e,t,i,a){var o,r,s,h,c,d={};return d.returnCode=1,UWA.is(e)&&UWA.is(t)&&UWA.is(i)&&UWA.is(a)&&(d.returnCode=0,o=n.normalize(t),r=n.normalize(a),s=n.dot(o,r),Math.abs(s)<.001?(d.angle=0,0===(h=l(e,i,r)).returnCode&&h.distance<.001?d.aPosition=n.clone(e):d.aPosition=h.aPosition):(d.angle=Math.asin(s),c=n.dot(n.sub(e,i),r)/s,d.aPosition=n.multiplyAndAdd(o,c,e))),d},modifyLeaderNode:function(e,i,o,n,r,s,h,l,d,p,u,g){var f,m,P,D,w,y,_,S={};return S.vBreak=n.clone(),S.vAttach=n.clone(),UWA.is(o)&&(S=this.computeNewPoints(e,n,r,s,u,g)),null===S.vBreak&&null===S.vAttach||(m=this.getDashPattern(d,null,!0),P={arrowWidth:h,headLength:Math.max(2*h+4,10),viewpoint:e.currentViewpoint,arrowDashType:m,arrowScale:2,color:l},D=!c(S.vBreak,r,"Vector3"),w=i.getChildByName("attach"),UWA.is(w)?UWA.is(D)?(w.updateInitialPosition(S.vBreak),w.updateFinalPosition(r),w.updateColor(l),w.setArrowWidth(h),w.setHeadSize(Math.max(2*h+4,10)),w.setHeadType(p),w.setArrowPattern(m),w.setArrowPatternScale(2),f+="(modify attach)"):(i.remove(w),f+="(delete attach)"):UWA.is(D)&&(P.initialPoint=S.vBreak.clone(),P.finalPoint=r.clone(),P.head=p,(w=new a(P)).name="attach",w.setPickable(t.PICKABLE),w.setPickParent(!0),i.add(w),f+="(redraw attach)"),y=D&&!c(S.vBreak,S.vAttach,"Vector3"),_=i.getChildByName("step"),UWA.is(_)?UWA.is(y)?(_.updateInitialPosition(S.vBreak),_.updateFinalPosition(S.vAttach),_.updateColor(l),_.setArrowWidth(h),_.setHeadSize(Math.max(2*h+4,10)),_.setHeadType(0),w.setArrowPattern(m),w.setArrowPatternScale(2),f+="(modify step)"):(i.remove(_),f+="(delete step)"):UWA.is(y)&&(P.initialPoint=S.vBreak.clone(),P.finalPoint=S.vAttach.clone(),P.head=0,(_=new a(P)).name="step",_.setPickable(t.PICKABLE),w.setPickParent(!0),i.add(_),f+="(redraw step)")),f},computeNewPoints:function(t,a,o,n,r,h){var l,c,d,p,u,g,f,m,P,D,w,y,_={},S=Math.PI/180*105,b=15;return _.vBreak=a.clone(),_.vAttach=a.clone(),UWA.is(r.offsetHeight)?c=r.offsetHeight/2:UWA.is(r.style.pixelHeight)&&(c=r.style.pixelHeight/2),UWA.is(r.offsetWidth)?l=r.offsetWidth/2:UWA.is(r.style.pixelWidth)&&(l=r.style.pixelWidth/2),d=s(t,a,h),u=(p=s(t,o,h)).left-d.left,f=l+b,m=(g=p.top-d.top)>0?i.AttachmentSide.BOTTOM:i.AttachmentSide.TOP,u>0?(UWA.is(n)&&void 0!==n.width&&(f=l+(b=r.offsetWidth*n.width)),u>f&&(P=new e.Vector3(-f,0,0),D=new e.Vector3(u-f,g,0),P.angleTo(D)>S&&(m=i.AttachmentSide.RIGHT))):-u>f&&(n&&void 0!==n.width&&(f=l+(b=r.offsetWidth*n.width)),P=new e.Vector3(f,0,0),D=new e.Vector3(u+f,g,0),P.angleTo(D)>S&&(m=i.AttachmentSide.LEFT)),u<0&&(u=-u),(g=p.top-d.top)<0&&(g=-g),g<c&&u<l?(_.vBreak=null,_.vAttach=null,_):(m===i.AttachmentSide.RIGHT||m===i.AttachmentSide.LEFT?(w=l,m===i.AttachmentSide.LEFT&&(w=-w),_.vAttach=this.computeProjection(t,a,d.left+w,d.top),w=l+b,m===i.AttachmentSide.LEFT&&(w=-w),_.vBreak=this.computeProjection(t,a,d.left+w,d.top)):m!==i.AttachmentSide.TOP&&m!==i.AttachmentSide.BOTTOM||(y=c,m===i.AttachmentSide.TOP&&(y=-y),_.vAttach=this.computeProjection(t,a,d.left,d.top+y),UWA.is(n)&&void 0!==n.height?(y=c+(b=r.offsetHeight*n.height),m===i.AttachmentSide.TOP&&(y=-y),_.vBreak=this.computeProjection(t,a,d.left,d.top+y)):_.vBreak=_.vAttach.clone()),_)},computeProjection:function(t,i,a,o){var n=this.getViewpointInfo(t.currentViewpoint).sight.negate(),r=this.getLineFromWindowPosition(t,a,o),s=this.computeLinePlaneDistance(r.position.toArray(),r.direction.toArray(),i.toArray(),n.toArray());return new e.Vector3(s.aPosition[0],s.aPosition[1],s.aPosition[2])}}};return s.AttachmentSide={CENTER:0,LEFT:1,RIGHT:2,TOP:3,BOTTOM:4},UWA.is(r)||(r=new s),r})),define("DS/DELWebViewerWorkInstructionCommon/View/DELSubViewShapeGrid",["UWA/Core","UWA/Class","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewCell"],(function(e,t,i){"use strict";return function(){var t,a,o,n,r,s,h=1,l=1,c=[],d=[0],p=[0];return(t=e.createElement("canvas")).width=1e3,t.height=300,a=new i,c.push(a),o=function(e,t){d[e]=t},n=function(e,t){p[e]=t},r=function(e){return{width:e.getCellWd(),height:e.getCellHt(),fontHeight:0}},s=function(){var e;c=[],d=[0],p=[0],h=1,l=1,e=new i,c.push(e)},{updateGrid:function(){var t,i,a,s,c,u,g,f=0,m=0;for(t=0;t<l;t++){for(a=0,i=0;i<h;i++)s=this.getMarkUpCell(i,t),e.is(s)&&a<(c=r(s)).width&&(a=c.width);n(t,a)}for(i=0;i<h;i++){for(u=0,t=0;t<l;t++)s=this.getMarkUpCell(i,t),e.is(s)&&(c=r(s),u=Math.max(c.height,u));o(i,u)}for(t=0;t<h;t++){for(u=d[t],f=0,i=0;i<l;i++)a=p[i],s=this.getMarkUpCell(t,i),e.is(s)&&((g={}).x=f,g.y=m,s.setCellPos(g)),f+=a;m+=u}},getMarkUpCell:function(e,t){var i,a,o;if(c.length>0)for(a=0;a<c.length;a++)if((o=c[a].getCellIndex()).row===e&&o.col===t){i=c[a];break}return i},getNbofRows:function(){return h},setNbofRows:function(e){var t,a,o,n;if(e!==h&&s(),e>h)for(t=h,a=0;a<l;a++)for(o=t;o<e;o++)n=new i(o,a),c.push(n),d[o]=0;h=e},getNbofColumns:function(){return l},setNbofColumns:function(e){var t,a,o;if(e!==l&&s(),e>l)for(t=l;t<e;t++){for(a=0;a<h;a++)o=new i(a,t),c.push(o);p[t]=0}l=e},getRowHt:function(e){return d[e]},getColWd:function(e){return p[e]}}}})),define("DS/DELWebViewerWorkInstructionCommon/View/DELSubViewShape",["UWA/Core","UWA/Class","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewShapeGrid","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewTools"],(function(e,t,i,a){"use strict";return function(t,o){var n;return{getMarkUpGrid:function(){return n||(n=new i),n},buildGrid:function(){var i,n,r,s,h,l,c=0;r=(i=this.getMarkUpGrid()).getMarkUpCell(0,0),n=t.subViewImage,e.is(i)&&e.is(t)&&e.is(r)&&e.is(n)&&(i.setNbofRows(1),i.setNbofColumns(1),r.setCellImage(n),c=t.imageWidth,s=t.imageHeight,e.is(c)&&e.is(s)?(h=t.position,e.is(h)?(c=a.convertModelToPixels({sizeInMM:c,viewer:o})*window.devicePixelRatio,s=a.convertModelToPixels({sizeInMM:s,viewer:o})*window.devicePixelRatio):(c*=l=o.SCREEN_HEIGHT/2,s*=l)):(c=n.naturalWidth,s=n.naturalHeight),r.setCellWd(c),r.setCellHt(s),i.updateGrid())}}}})),define("DS/DELWebViewerWorkInstructionCommon/View/DELSubViewShapeNode",["UWA/Core","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewTools","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewShape"],(function(e,t,i,a,o,n,r,s,h,l){"use strict";var c,d;return(c=t.extend({init:function(t){this._parent(),this._canvas=e.createElement("canvas"),this._canvas.width=1e3,this._canvas.height=300,this._canvasCopy=e.createElement("canvas"),this._canvasPictureToDisplay=e.createElement("canvas"),this._canvasNode=null,this._containerNode=null,this._sizeData={},this._additionalSpace=null,this._zoomMode=null,this._rotationAngle=0,this._imgToDisplay=new Image,this.wkiData=t.wkiData,this.delShape=new l(this.wkiData,d),this._appData={anchorMode:"center",isFilled:!0,hasBorder:!1,graphicProperties:{padding:0,borderRadius:8,horizontalAlignement:"center",fontStyle:{height:12,familyName:"sans-serif",familyStyle:"normal",color:new i.Color(0)},fillStyle:{color:new i.Color(16777215),opacity:1},lineStyle:{thickness:1,pattern:"1",color:new i.Color(4013373)}},isHighlighted:!1},this.canvasNodeTexture=null},modify:function(){var e,a,r,s,h,l;if(this.wkiData.position&&(this._appData.position=this.wkiData.position.clone(),this.setMatrix((new i.Matrix4).setPosition(this._appData.position))),!this._compareOpts(this.wkiData)||!this._canvasNode){if(e=!1,(this._appData.subViewImage&&!this.wkiData.subViewImage||!this._appData.subViewImage&&this.wkiData.subViewImage||this._appData.subViewImage&&this.wkiData.subViewImage&&(this._appData.subViewImage.src!==this.wkiData.subViewImage.src||this._appData.subViewImage.width!==this.wkiData.subViewImage.width||this._appData.subViewImage.height!==this.wkiData.subViewImage.height))&&(e=!0),("number"==typeof this.wkiData.imageWidth&&"number"==typeof this._appData.imageWidth&&this.wkiData.imageWidth!==this._appData.imageWidth||"number"==typeof this.wkiData.imageHeight&&"number"==typeof this._appData.imageHeight&&this.wkiData.imageHeight!==this._appData.imageHeight||e||this.wkiData.imageInvertH!==this._appData.imageInvertH||this.wkiData.imageInvertV!==this._appData.imageInvertV||this._rotationAngle!==this._appData.boxRotationAngle)&&(a=this.delShape?this.delShape.getMarkUpGrid():null))for(r=0;r<a.getNbofRows();r++)for(s=0;s<a.getNbofColumns();s++)a.getMarkUpCell(r,s)&&(a.getMarkUpCell(r,s).removeCellImageToDisplay(),this._imgToDisplay.src="",this._imgToDisplay.width=1,this._imgToDisplay.height=1,this._imgToDisplay.hasBeenLoaded=!1);this._mergeOpts(this.wkiData),this.delShape&&this.delShape.buildGrid(),this._computeBoxSize(),this._zoomMode===this._appData.zoomMode&&this._rotationAngle===this._appData.boxRotationAngle||!this._containerNode||(this.removeChildren(),this._containerNode=null),this._containerNode?this._containerNode.removeChildren():(this._zoomMode=this._appData.zoomMode,this._rotationAngle=this._appData.boxRotationAngle?this._appData.boxRotationAngle:0,this._zoomMode?(this._containerNode=new o({type:"Spherical"}),this.addChild(this._containerNode),this._containerNode.setPickParent(!0)):this._rotationAngle?(h=new o({type:"Spherical"}),this.addChild(h),l=new n({ratio:1}),h.addChild(l),this._containerNode=new t,l.addChild(this._containerNode),this._containerNode.setPickParent(!0),l.setPickParent(!0),h.setPickParent(!0)):this._containerNode=this),this._additionalSpace=this._zoomMode?3:8,this._canvasNode=this._buildCanvasNode((this._zoomMode?this._sizeData.widthInMM:this._sizeData.width)+this._additionalSpace,(this._zoomMode?this._sizeData.heightInMM:this._sizeData.height)+this._additionalSpace,this._drawCallback.bind(this),this._additionalSpace),this._containerNode.addChild(this._canvasNode),this._rotationAngle&&this._containerNode.setMatrix((new i.Matrix4).makeRotationAxis(new i.Vector3(0,0,1),this._rotationAngle))}},getDimensions:function(){return{offsetWidth:this._sizeData.widthInMM>0?this._sizeData.widthInMM:1,offsetHeight:this._sizeData.heightInMM>0?this._sizeData.heightInMM:1}}})).prototype._buildCanvasNode=function(e,t,o,n){var h,l;if(this.canvasNodeTexture=new r({width:e,height:t,webGLV6Viewer:d,drawCB:o,rectangleTexture:!0,materialParams:{depthTest:!1}}),this.canvasNodeTexture.setPickParent(!0),this._zoomMode||this._rotationAngle){switch(this._appData.anchorMode){case"topleft":l=new i.Vector3(-n/2,n/2-t,0);break;case"center":l=new i.Vector3(-e/2,-t/2,0)}(h=new s({bottomLeftcorner:l,widthVector:new i.Vector3(e,0,0),heightVector:new i.Vector3(0,t,0),canvasNodeTexture:this.canvasNodeTexture},a)).setPickParent(!0)}else{switch(this._appData.anchorMode){case"topleft":l=new i.Vector2(n/2,t-n/2);break;case"center":l=new i.Vector2(e/2,t/2)}(h=a.createCanvas2DNode({hotspot:l,canvasNodeTexture:this.canvasNodeTexture})).setPickParent(!0)}return h.getChildren&&h.getChildren().length>0&&h.getChildren().forEach((e=>e.setPickParent(!0))),h.rectangle.setRenderDepth(10),h},c.prototype._computeBoxSize=function(){var t,i,a=null;if(this._sizeData={},e.is(this.delShape)&&(a=this.delShape.getMarkUpGrid()),e.is(a)){for(this._sizeData.height=0,this._sizeData.width=0,t=0;t<a.getNbofRows();t++)this._sizeData.height+=a.getRowHt(t);for(isNaN(this._sizeData.height)&&(this._sizeData.height=1),i=0;i<a.getNbofColumns();i++)this._sizeData.width+=a.getColWd(i);isNaN(this._sizeData.width)&&(this._sizeData.width=1)}this._sizeData.width+=2*this._appData.graphicProperties.padding,this._sizeData.height+=2*this._appData.graphicProperties.padding,this._sizeData.widthInMM=h.convertPixelToModel({sizeInPixels:this._sizeData.width,viewer:d}),this._sizeData.heightInMM=h.convertPixelToModel({sizeInPixels:this._sizeData.height,viewer:d}),this._sizeData.width=Math.round(this._sizeData.width),this._sizeData.height=Math.round(this._sizeData.height),this._sizeData.widthInMM=Math.round(this._sizeData.widthInMM),this._sizeData.heightInMM=Math.round(this._sizeData.heightInMM)},c.prototype._createRoundedRectangle=function(e,t,i,a,o){var n=this._appData.graphicProperties.borderRadius;e.beginPath(),e.moveTo(t+n,i),e.lineTo(t+a-n,i),e.arc(t+a-n,i+n,n,1.5*Math.PI,2*Math.PI),e.lineTo(t+a,i+o-n),e.arc(t+a-n,i+o-n,n,0,.5*Math.PI),e.lineTo(t+n,i+o),e.arc(t+n,i+o-n,n,.5*Math.PI,Math.PI),e.lineTo(t,i+n),e.arc(t+n,i+n,n,Math.PI,1.5*Math.PI),e.closePath()},c.prototype._drawImage=function(e,t,i,a,o,n,r,s){e.save(),e.translate(i+o/2,a+n/2),e.scale(r?-1:1,s?-1:1),e.drawImage(t,-o/2,-n/2,o,n),e.restore()},c.prototype._drawCallback=function(t,a,o,n){var r,s,l,c,p,u,g,f,m,P,D,w,y,_,S,b,v,V,L,E,k,C,N,M,A,I;if(a.scale(1/n,1/n),g=(u=a.canvas.width/(this._zoomMode?h.convertModelToPixels({sizeInMM:this._sizeData.widthInMM+this._additionalSpace,viewer:d}):this._sizeData.width+this._additionalSpace))*this._sizeData.width,D=u*this._sizeData.height,f=(a.canvas.width-g)/2,P=(a.canvas.height-D)/2,this._appData.isFilled)if(this._appData.graphicProperties.fillStyle.gradient){for("leftToRight"===this._appData.graphicProperties.fillStyle.gradient.type?m=a.createLinearGradient(f,P,a.canvas.width-f,P):"topToBottom"===this._appData.graphicProperties.fillStyle.gradient.type?m=a.createLinearGradient(f,P,f,a.canvas.height):"topLeftToBottomRight"===this._appData.graphicProperties.fillStyle.gradient.type?m=a.createLinearGradient(f,P,a.canvas.width-f,a.canvas.height):"bottomLeftToTopRight"===this._appData.graphicProperties.fillStyle.gradient.type&&(m=a.createLinearGradient(f,a.canvas.height,a.canvas.width-f,P)),w=Object.keys(this._appData.graphicProperties.fillStyle.gradient.specs),y=0;y<w.length;y++)m.addColorStop(parseFloat(w[y]),this._appData.graphicProperties.fillStyle.gradient.specs[w[y]]);a.fillStyle=m}else a.fillStyle=h.colorToHex(this._appData.graphicProperties.fillStyle.color),a.globalAlpha=this._appData.graphicProperties.fillStyle.opacity;else a.globalAlpha=0;if(this._createRoundedRectangle(a,(a.canvas.width-g)/2,(a.canvas.height-D)/2,g,D),a.fill(),a.globalAlpha=1,a.fillStyle=h.colorToHex(this._appData.graphicProperties.fontStyle.color),_=this.delShape?this.delShape.getMarkUpGrid():null,S=function(e){e.target.hasBeenLoaded=!0,e.target.removeEventListener("load",S),e.target.listenToLoadEvt=!1,this._appData&&this.canvasNodeTexture&&(this.canvasNodeTexture.requestRedraw(),d.render())},e.is(_))for(r=0;r<_.getNbofRows();r++)for(s=0;s<_.getNbofColumns();s++)if(p=_.getMarkUpCell(r,s),e.is(p))if(b=p.getCellPos(),(v=p.getCellImageToDisplay())||(v=p.getCellImage()),v)V=u*p.getCellWd(),L=u*p.getCellHt(),u*_.getRowHt(r)<L&&(L=u*_.getRowHt(r)),u*_.getColWd(s)<V&&(V=u*_.getColWd(s)),!this._zoomMode&&v.width&&v.height&&(v.width!==V||v.height!==L)&&(v.width>300||v.height>300)&&(k=!1,V===v.width&&L===v.height||(this._canvasCopy.width=v.width,this._canvasCopy.height=v.height,this._canvasCopy.getContext("2d").drawImage(v,0,0),k=!0),C=v,v=this._imgToDisplay,this._canvasPictureToDisplay.width=V,this._canvasPictureToDisplay.height=L,this._canvasPictureToDisplay.getContext("2d").drawImage(k?this._canvasCopy:C,0,0,this._canvasPictureToDisplay.width,this._canvasPictureToDisplay.height),E=this._canvasPictureToDisplay.toDataURL("image/png"),v.width=this._canvasPictureToDisplay.width,v.height=this._canvasPictureToDisplay.height,p.setCellImageToDisplay(v)),v.hasBeenLoaded||(v.listenToLoadEvt&&(v.removeEventListener("load",S.bind(this)),v.listenToLoadEvt=!1),v.addEventListener("load",S.bind(this)),v.listenToLoadEvt=!0,E&&(v.src=E)),this._drawImage(a,v,f+u*b.x+("center"===this._appData.graphicProperties.horizontalAlignement?(a.canvas.width-2*f-V)/2:0),P+u*b.y,V,L,this._appData.imageInvertH,this._appData.imageInvertV);else if((N=(c=p.getCellText())?c.getTextToDisplay():null)&&N.length)for(M=c.getFontStyle()?c.getFontStyle()+" ":"",A=c.getFontName()?c.getFontName():"sans-serif",a.font=M+u*c.getFontSize()*window.devicePixelRatio+"px "+A,I=u*this._appData.graphicProperties.padding,l=0;l<N.length;++l)a.fillText(N[l],f+u*(this._appData.graphicProperties.padding+p.size.paddingX+b.x),P+I+u*(p.size.paddingY+p.size.fontHeight+b.y)),I+=u*(2*p.size.paddingY+p.size.fontHeight);!this._appData.hasBorder&&this._appData.inEdition?(a.strokeStyle="#00C8FF",a.lineWidth=Math.max(this._appData.graphicProperties.lineStyle.thickness,4),a.stroke()):this._appData.hasBorder&&(this._appData.inEdition?(a.strokeStyle="#00C8FF",a.lineWidth=Math.max(this._appData.graphicProperties.lineStyle.thickness,4)):(a.strokeStyle=h.colorToHex(this._appData.graphicProperties.lineStyle.color?this._appData.graphicProperties.lineStyle.color:h.colorToHex(new i.Color(12775156))),a.lineWidth=this._appData.graphicProperties.lineStyle.thickness),this._appData.graphicProperties.lineStyle.pattern&&a.setLineDash(h.getDashPattern(this._appData.graphicProperties.lineStyle.pattern,2)),a.stroke()),d.render()},c.prototype._compareOpts=function(e){var t,i,a,o,n,r=function(e,t){return void 0===t||void 0===e||JSON.stringify(t)===JSON.stringify(e)},s=Object.keys(e);for(t=0;t<s.length;t++)if("graphicProperties"!==s[t]&&"breakPoint2D"!==s[t]&&"position"!==s[t]&&"pointingPoints"!==s[t]){if("subViewImage"===s[t]){if(this._appData[s[t]]&&!e[s[t]]||!this._appData[s[t]]&&e[s[t]])return!1;if(this._appData[s[t]].src!==e[s[t]].src||this._appData[s[t]].width!==e[s[t]].width||this._appData[s[t]].height!==e[s[t]].height)return!1}else if(!r(this._appData[s[t]],e[s[t]]))return!1}else if("graphicProperties"===s[t])for(i=Object.keys(e[s[t]]),a=0;a<i.length;a++)if("fontStyle"===i[a]||"fillStyle"===i[a]||"lineStyle"===i[a]){for(o=Object.keys(e[s[t]][i[a]]),n=0;n<o.length;n++)if(!r(this._appData[s[t]][i[a]][o[n]],e[s[t]][i[a]][o[n]]))return!1}else if(!r(this._appData[s[t]][i[a]],e[s[t]][i[a]]))return!1;return!0},c.prototype._mergeOpts=function(e){var t,i,a,o,n,r=function(e){return null!=e&&e.clone?e.clone():e},s=Object.keys(e);for(t=0;t<s.length;t++)if("graphicProperties"!==s[t])this._appData[s[t]]=r(e[s[t]]);else for(i=Object.keys(e[s[t]]),o=0;o<i.length;o++)if("fontStyle"===i[o]||"fillStyle"===i[o]||"lineStyle"===i[o])for(a=Object.keys(e[s[t]][i[o]]),n=0;n<a.length;n++)this._appData[s[t]][i[o]][a[n]]=r(e[s[t]][i[o]][a[n]]);else this._appData[s[t]][i[o]]=r(e[s[t]][i[o]])},function(e){return d=e.viewer,new c(e)}})),define("DS/DELWebViewerWorkInstructionCommon/View/DELSubViewNode3D",["UWA/Core","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewShapeNode","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewTools","DS/Mesh/MeshUtils"],(function(e,t,i,a,o,n,r){"use strict";var s,h,l,c=i.extend({init:function(a){var n;this._wkiData=a||{},this._parent(),this._nPictureBoxNode=new o({viewer:s,wkiData:a}),this.addChild(this._nPictureBoxNode),this._nPictureBoxNode.setPickParent(!0),this.setName(this._wkiData.name),this.setUserData({type:this._wkiData.type,uuid:this._wkiData.uuid}),e.is(this._wkiData.isPickable,"boolean")&&(this._wkiData.isPickable?this.setPickable(r.PICKABLE):this.setPickable(r.PICKTHROUGH)),this.setNoZ(!0),this._nLeaderNode=new i,this.addChild(this._nLeaderNode),this._nLeaderNode.setPickParent(!0),this._hideShowTokens=[],this._wuxTokens=[];let h=this;n=l.getHideShowController(),this._hideShowTokens.push(n.getModelEvents().subscribe({event:"onHide"},(function(){h._updateLeaderAndPictureBoxVisibility.bind(h)}))),this._hideShowTokens.push(n.getModelEvents().subscribe({event:"onShow"},(function(){h._updateLeaderAndPictureBoxVisibility.bind(h)}))),this._wuxTokens.push(t.subscribe({event:"/VISU/"},this.onViewerEventCB.bind(this))),this._wuxTokens.push(t.subscribe({event:"/VISU/onSceneGraphUpdate"},(function(e){"REMOVE"===e.eventType&&(h._hideShowTokens.forEach((e=>{n.getModelEvents().unsubscribe(e)})),h._hideShowTokens=[])})))},onViewerEventCB:function(e){"@onWindowResized"!==e.eventType&&"@onViewpointChange"!==e.eventType&&"onSwapVisibleSpace"!==e.eventType||(this._updateLeaderPosition(),this._updateLeaderAndPictureBoxVisibility(),s.render())},update:function(){this._nPictureBoxNode.modify(),this._updateLeaderPosition(),this._updateLeaderAndPictureBoxVisibility(),this.setVisibility(this._wkiData.isVisible),s.render()},destroy:function(){this._wuxTokens.forEach((e=>{t.unsubscribe(e)})),this._wuxTokens=[],this._hideShowTokens.forEach((e=>{l.getHideShowController().getModelEvents().unsubscribe(e)})),this._hideShowTokens=[]}});return c.prototype._updateLeaderPosition=function(){var t,o,r,l,c,d,p,u,g,f,m,P,D,w,y;if(!this._wkiData.hasALeader)return this._nLeaderNode.setVisibility(!1),void this._nLeaderNode.setVisibilityFree(!0);if(this._nLeaderNode.setVisibility(!0),this._nLeaderNode.setVisibilityFree(!1),0===s.getVisibleSpace()&&!1===this._wkiData.isVisible||1===s.getVisibleSpace()&&!0===this._wkiData.isVisible){switch(t=0,this._wkiData.leaderEndType){case"Arrow":t=1;break;case"Bubble":t=2}if((o=this._nPictureBoxNode.getDimensions()).offsetWidth>0&&o.offsetHeight>0&&(r=this._wkiData.position.clone(),(l={offsetWidth:n.convertModelToPixels({sizeInMM:o.offsetWidth,viewer:s,coords:this._wkiData.zoomMode?r:null}),offsetHeight:n.convertModelToPixels({sizeInMM:o.offsetHeight,viewer:s,coords:this._wkiData.zoomMode?r:null})}).offsetWidth/=window.devicePixelRatio,l.offsetHeight/=window.devicePixelRatio,"topleft"===this._wkiData.anchorMode&&(this._wkiData.zoomMode?(c=s.currentViewpoint.getUpDirection().clone(),d=(new a.Vector3).crossVectors(s.currentViewpoint.getSightDirection(),c).setLength(o.offsetWidth/2),c.setLength(-o.offsetHeight/2),r.add(c),r.add(d)):(p=n.getViewerPositionFromPoint(s,r),isNaN(p.left)||isNaN(p.top)||(u=new a.Vector2(p.left+l.offsetWidth/2,p.top+l.offsetHeight/2),g=n.getLineFromWindowPosition(s,u.x,u.y),f=n.getViewpointInfo(s.currentViewpoint),m=n.computeLinePlaneDistance(g.position.toArray(),g.direction.toArray(),this._wkiData.position.toArray(),f.sight.toArray()),r=new a.Vector3(m.aPosition[0],m.aPosition[1],m.aPosition[2])))),P=this._wkiData.leaderPointingPoints,e.is(P)&&P.length&&(D=this._nLeaderNode.getChildren(),P.forEach(function(a,o){e.is(D[o])||(D[o]=new i("DELSubViewLeaderNode"),D[o].setPickParent(!0),e.is(this._wkiData.pointedReferences,"array")&&this._wkiData.pointedReferences[o]&&D[o].setUserData({pointedReference:this._wkiData.pointedReferences[o]}),this._nLeaderNode.addChild(D[o])),y={width:this._wkiData.leaderAttachWidthRatio,height:this._wkiData.leaderAttachLengthRatio},n.modifyLeaderNode(s,D[o],!0,r,a,y,this._wkiData.graphicProperties.leaderStyle.thickness*window.devicePixelRatio,this._wkiData.graphicProperties.leaderStyle.color,this._wkiData.graphicProperties.leaderStyle.pattern,t,l,h)}.bind(this)),D=this._nLeaderNode.getChildren(),P.length<D.length)))for(w=D.length-1;w>=P.length;w--)this._nLeaderNode.removeChild(D[w])}},c.prototype._getNodeId=function(e){if(!e)return null;let t;return t=e.getModelIdentification?e.getModelIdentification():null,t||(t=e.getId?e.getId():t),t||(t=e.persistentId),t},c.prototype._getPathFromId=function(e){var t=this,i=null,a=[...e],o=function(e,a){var n;if(e.length>0)for(n=0;n<e.length;n++){var r=e[n].getLastElement();if(t._getNodeId(r)===a[0]&&(a.splice(0,1),0===a.length)){i=e[n];break}var s=e[n].getChildrenOccurrencePathes();null!=s&&o(s,a)}},n=[l.getRootBagPath()];return o(n,a),i},c.prototype._checkSubViewPointedElmtsVisibility=function(t){var i,a=!1;if(this._wkiData.pointedReferenceOccurencesIdToPathMap&&e.is(this._wkiData.pointedReferenceOccurencesIdToPathMap[t],"array")){let o=this._wkiData.pointedReferenceOccurencesIdToPathMap[t];if(i=l.unstreamPath(o),e.is(i)||(i=this._getPathFromId(o)),!e.is(i))return!1;a=s.getSceneGraphOverrideSetManager().getCurrentVisibility(i)}return a},c.prototype._updateLeaderAndPictureBoxVisibility=function(){var e=this;let t=e._nLeaderNode.getChildren();if(t.forEach((t=>{let i=t.getUserData();if(i&&i.pointedReference){let a=e._checkSubViewPointedElmtsVisibility(i.pointedReference);t.setVisibility(a),t.setVisibilityFree(!a)}})),this.getUserData()&&"Pictogram"===this.getUserData().type){t.every((e=>!1===e.isVisible()))&&t.length>0?(this._nPictureBoxNode.setVisibility(!1),this._nPictureBoxNode.setVisibilityFree(!0)):(this._nPictureBoxNode.setVisibility(!0),this._nPictureBoxNode.setVisibilityFree(!1))}},c.prototype.getPointedParts=function(){let t=[];return this._wkiData&&this._wkiData.pointedReferenceOccurencesIdToPathMap&&Object.values(this._wkiData.pointedReferenceOccurencesIdToPathMap).forEach((i=>{let a=l.unstreamPath(i);e.is(a)||(a=this._getPathFromId(i)),t.push({pathElement:a})})),t},c.prototype.getDMUType=function(){return this._wkiData.type},function(e,t){return l=t,s=t.getViewer(),h=t.getFrameWindow(),new c(e)}})),define("DS/DELWebViewerWorkInstructionCommon/DELWKIContent/DELWKIContentController",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/Visualization/Node3D","DS/DELWebViewerWorkInstructionCommon/View/DELSubViewNode3D","DS/DELWebViewerWorkInstructionCommon/DELWKIContent/DELWkiContentDataParser","DS/DELWebViewerCommon/DELCommonMarkerServices","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/PathElement","DS/DELWebViewerWorkInstructionCommon/Utils/WKINodeUtils"],(function(e,t,i,a,o,n,r,s,h,l,c,d){"use strict";const p="WKINodeBag",u="Dressup",g="onDressupSelected",f="onDressupUnSelected",m="onDressupHighlighted",P="onDressupUnHighlighted";return t.extend({logger:i.getLogger("DS/DELWebViewerWorkInstructionCommon/DELWKIContent/DELWKIContentController"),init:function(e){if(!e||!e.context)throw new Error("Invalid Input, context is mandatory");this.context=e.context,this._parent(e),this._modelEvents=new l,this._hsoTokens=[],this._csoTokens=[]},_subscribeToSelections:function(){let t=this,i=function(t,i){e.is(t,"array")&&t.length>0&&t.forEach((e=>{if(e&&e.pathElement&&d.isPictogram(e.pathElement)){let t=e.pathElement.getLastElement(),a=t&&t.getPointedParts?t.getPointedParts():[];a.length>0&&(i?h.add(a):h.remove(a))}}))},a=function(i,a){if(e.is(i,"array")&&i.length>0){let e=[];i.forEach((i=>{if(i&&i.pathElement){let a=t.getID(i.pathElement);a&&e.push(a)}})),e&&e.length>0&&t._modelEvents.publish({event:a,data:e.map((e=>({id:e,type:u})))})}};t._hsoTokens.push(h.onPostAdd((e=>{i(e,!0),a(e,m)}))),t._hsoTokens.push(h.onPostRemove((e=>{i(e,!1),a(e,P)}))),t._csoTokens.push(s.onPostAdd((e=>a(e,g)))),t._csoTokens.push(s.onPostRemove((e=>a(e,f))))},_unsubscribeToSelections:function(){this._hsoTokens.forEach((e=>{h.unsubscribe(e)})),this._csoTokens.forEach((e=>{s.unsubscribe(e)})),this._hsoTokens=[],this._csoTokens=[]},_getRootNode:function(){return this.context.getViewer().getRootNode()},_getWKINodeBag:function(){return this._getRootNode().getChildByName(p)},_clearWKINodeBag:function(){let t=this._getWKINodeBag();e.is(t)&&t.getChildren().length>0&&(t.getChildren().forEach((e=>{e.destroy&&e.destroy()})),t.removeChildren())},getWebUUIDs:function(t){var i=[];if(!e.is(this._uuidMappingTable))return i;if(!e.is(t,"array")||0===t.length)return i;for(let e of t)this._uuidMappingTable[e]&&this._uuidMappingTable[e].length&&(i=i.concat(this._uuidMappingTable[e]));return i},getNativeUUIDs:function(t){var i=[];if(!e.is(this._uuidMappingTable))return i;if(!e.is(t,"array")||0===t.length)return i;let a=Object.keys(this._uuidMappingTable);for(let e of t)for(let t of a)this._uuidMappingTable[t].includes(e)&&i.push(t);return i},getID:function(t){let i;if(e.is(t)&&d.isADMUPath(t)){let e=r.getDMUObjectIDsFromPathElements({context:this.context,pathElements:[t]});if(e.length>0){let t=this.getNativeUUIDs(e);i=t.length>0?t[0]:null}else d.isPictogram(t)&&(i=d.getWKIContentNodeId(t))}return i},importModel:function(e){this._wkiContent=e&&e.wkiContent?e.wkiContent:null,this._uuidMappingTable=e&&e.uuidMappingTable?e.uuidMappingTable:null,this._subscribeToSelections()},applySlide:function(t){var i=this;if(i._clearWKINodeBag(),this._wkiContent){let r=n.getParseWKIData({uuid:t.uuid,data:this._wkiContent});if(e.is(r,"array")&&r.length>0){let t,n=0,s=null;t=this._getWKINodeBag(),e.is(t)||(t=new a(p),this._getRootNode().addChild(t)),setTimeout((function(){if(e.is(r)&&r.length>0)for(n=0;n<r.length;n+=1)s=new o(r[n],i.context),t.addChild(s),s.update()}),10)}}else this.logger.error("Model not available , set the model using importModel api")},_toggleHighlight:function(t){if(t.id&&t.type===u&&this.context){!(!t||!e.is(t.clear,"boolean"))&&t.clear&&h.empty();let i=this.getWebUUIDs([t.id]);if(i.length>0)!0===t.highlight&&r.highlightDMUObjects({context:this.context,uuids:i});else{let i=this._getWKINodeBag();e.is(i)&&i.getChildren().length>0&&i.getChildren().forEach((e=>{if(e.getUserData().uuid===t.id&&!0===e.visible){let a=new c;a.addElement(i),a.addElement(e),!0===t.highlight?h.add({pathElement:a}):h.remove({pathElement:a})}}))}}},highlightNode:function(e){this._toggleHighlight({...e,highlight:!0})},unHighlightNode:function(e){this._toggleHighlight({...e,highlight:!1})},subscribe:function(e,t){return this._modelEvents.subscribe(e,t)},unsubscribe:function(e){this._modelEvents.unsubscribe(e)},removeModel:function(){this._clearWKINodeBag(),this._unsubscribeToSelections(),this._wkiContent=null,this._uuidMappingTable=null},destroy:function(){this.removeModel(),this.context=null,this._modelEvents=null}})}));