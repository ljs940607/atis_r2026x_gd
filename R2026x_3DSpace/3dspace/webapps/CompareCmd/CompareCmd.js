define("DS/CompareCmd/CompareCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleServices/Utils","DS/WAFData/WAFData","i18n!DS/CompareCmd/assets/nls/CompareCmd"],(function(e,t,o,n,i,r,a){"use strict";var s=e.extend({name:"compare_command",context:null,defaultOptions:{disregardSelectedNodes:!1},init:function(e){if(this.context=e.context,this.runOptions=e.runOptions,void 0!==e.expectedContent&&null!==e.expectedContent&&(this.expectedContentObj=e.expectedContent),this._parent(e,{mode:"exclusive",isAsynchronous:!1}),null==this.context){var t=this;require(["DS/PADUtils/PADContext"],(function(e){var o=e.get();if(null!=o&&(t.context=o,null!=t.context.getPADTreeDocument)){var n=t.context.getPADTreeDocument().getXSO();t._boundCheck=t.checkSelect.bind(t),n.onPostAdd(t._boundCheck),n.onPostRemove(t._boundCheck),t._isEnabled=t.getEnableCmd()}}))}this.setCommandAvailability(this.getEnableCmd())},setCommandAvailability:function(e){var o=t.getCommand(this._id,this);o&&(!0===e?o.enable():o.disable())},getEnableCmd:function(){var e=this,t=!1;return n.hasRole((function(o){if(!0===o&&null!=e.context&&(e.context.getPADTreeDocument||"LifecycleWidget"===e.context.widgetType)){let o=0;o=e.context.getPADTreeDocument?e.context.getPADTreeDocument().getXSO().get():e.context.getSelectedNodes(),t=!0,o.length>0&&(o=o.filter((function(e){return!("function"==typeof e.getNodeSource&&1===e.getNodeSource()||e.hasOwnProperty("isRelationsObjectGroupNode")&&!0===e.isRelationsObjectGroupNode||e.hasOwnProperty("isGroupingNode")&&!0===e.isGroupingNode)}))),0==o.length&&(t=!1)}}),["InternalDS","PAR","PAU","CSV"]),t},checkSelect:function(){var e=this.getEnableCmd();this.setCommandAvailability(e)},beginExecute:function(){},execute:function(){var e=this.runOptions||{};switch(this._id){case"CompareHdr":break;case"CompareV2Hdr":e.app="COMPARE",e.version="2";break;case"CompareNewRevFromHdr":e.app="NRF",e.version="2",e.cmdOptions={ImmediateCompare:!0,AllowCompareOfIdentical:!1,ImmediateRevisionOf:!0,AllowDuplicatesInRevisionsDialog:!1,DisableRootInRevisionsDialog:!0,ControlOKButtonInRevisionsDialog:!0,SupportsCompareCustomization:!1,input:[{NoDropZones:!0,NoFilterOf:!0,NoOpenContent:!0,NoRemove:!0},{NoDropZones:!0,NoFilterOf:!0,NoOpenContent:!0}]};break;case"CompareMergeHdr":e.app="MERGE",e.version="2";var t=!i.urlHasParam("mergeSettingsEX");e.cmdOptions={ImmediateCompare:!1,AllowCompareOfIdentical:!1,ImmediateRevisionOf:!0,AllowDuplicatesInRevisionsDialog:!1,DisableRootInRevisionsDialog:!0,ControlOKButtonInRevisionsDialog:!0,RevisionsDialogOKButtonLabel:a.revisionsDialogOKButtonLabelMerge,SupportsCompareCustomization:!1,settings:[{Label:a.createARevisionNRF,Value:"viewSettings.MERGE_STRUCT_VIEW.createARevision"}],input:[{Label:a.leftDropLabelNRF,NoDropZones:!0,NoFilterOf:t,NoOpenContent:!0,NoRemove:!0,RevisionsDialogTitle:a.leftRevisionsDialogTitleMerge},{Label:a.rightDropLabelNRF,NoDropZones:!0,NoFilterOf:!1,NoOpenContent:!0,RevisionsDialogTitle:a.rightRevisionsDialogTitleMerge}]};break;default:return this.NLS_showMessage("cmdNotImplented","compare-alert-error"),!1}return this.execute_CompareHdr(this.context,e)},endExecute:function(){},getTenant:function(){var e="undefined"!=typeof widget&&widget?widget.getValue("x3dPlatformId"):null;return null!=e&&""!=e||(e="OnPremise"),e},execute_CompareHdr:function(e,t){t=t||{};var o=this,n=o.getTenant(),i=o.getObjSpecArray(e),r=o.getFilterProxy(e),a=!1;return 1==t.skipValidate?o.launchCompare(n,i,r,t):a=this.validateInput(n,i,(function(){o.launchCompare(n,i,r,t)})),a},getFilterProxy:function(e){var t=null;null!=e&&void 0!==e._biFilter&&null!==e._biFilter&&void 0!==e._biFilter._biFilter&&null!==e._biFilter._biFilter&&(t={appId:e._biFilter._biFilter._appId,widgetId:e._biFilter._biFilter._widgetId});return t},getObjSpecArray:function(e){var t=[];if(null!=e&&0==this.options.disregardSelectedNodes&&null!=e.getSelectedNodes&&"function"==typeof e.getSelectedNodes){var o=e.getSelectedNodes(),n=e.getSecurityContext().SecurityContext,i=this.getTenant();o.forEach((function(e){var o=e.getID(),r=(e.options||e.object).type;r||"function"!=typeof e.getType||(r=e.getType()),t.push({id:o,objIDType:"modelID",objType:r,contextId:n,objTenant:i})}))}else t=this.options.CompareIds;return t},checkFormat_PhysID:function(e){if(null==e||e.constructor!=String||32!=e.length)return!1;for(var t=0;t<32;t++){var o=e.charAt(t);if(0==(o>="a"&&o<="f"||o>="A"&&o<="F"||o>="0"&&o<="9"))return!1}return!0},checkFormat_editCommands:function(e){if(null==e||e.constructor!=Array||0==e.length)return"Empty or missing edit commands";for(var t=0;t<e.length;t++){var o=e[t];if(null==o.op)return"Command is missing operator";switch(o.op){case"INSERT":if(0==this.checkFormat_PhysID(o.inNode))return"Bad or missing inNode in INSERT operation";break;case"REMOVE":if(0==this.checkFormat_PhysID(o.rmNode))return"Bad or missing rmnode in REMOVE operation";break;case"REPLACE":if(0==this.checkFormat_PhysID(o.inNode))return"Bad or missing inNode in REPLACE operation";if(0==this.checkFormat_PhysID(o.rmNode))return"Bad or missing rmnode in REPLACE operation";break;default:return"Unknown op: '"+o.op+"'"}if(0==this.checkFormat_PhysID(o.parent))return"Bad or missing parent"}return 0},validateInput:function(e,t,o){var i=this;if(null==t||t.constructor!=Array||0==t.length)return this.NLS_showMessage("objectNotSelected","compare-alert-error"),!1;if(t.length>5)return this.NLS_showMessage("selectFiveOrFewer","compare-alert-error"),!1;for(var a=this,s=[],c=[],l=0;l<t.length;l++){var d=t[l];if(null==d||""==d)return this.NLS_showMessage("objSpec is NULL","compare-alert-error"),!1;var p=null,u=null;if(p=d.constructor==String?d:d.id,null!=d.commands&&(u=d.commands),0==a.checkFormat_PhysID(p)){var m="Invalid root ID: "+p;return null!=d.commands&&(m+=" in objSpec: "+JSON.stringify(d)),a.NLS_showMessage(m,"compare-alert-error"),!1}if(null!=u){var g=a.checkFormat_editCommands(u);if(0!=g)return a.NLS_showMessage(g+" in objSpec: '"+JSON.stringify(d)+"'.","compare-alert-error"),!1}-1==s.indexOf(p)&&s.push(p),d.contextId&&c.push(d.contextId)}var h=s.join(),f=null;f=1==i.options.isODT?"/resources/compare/getObjState?objectIds="+h:n.get3DSpaceWSUrl(e,"/resources/compare/getObjState","objectIds="+h);var C={Accept:"application/json"};c.length&&(C.securityContext=c[0]);try{r.authenticatedRequest(f,{proxy:"passport",timeout:12e4,method:"GET",headers:C,onComplete:function(e){i.checkValidateResults(e,o)}})}catch(e){i.NLS_showMessage("requestError","compare-alert-error")}return!0},checkValidateResults:function(e,t){JSON.parse(e).results.forEach((function(e){if(0==e.exists)return this.NLS_showMessage("OBJ_NOT_FOUND","compare-alert-error"),!1})),t()},launchCompare:function(e,t,n,i){let r=this;console.log("===== CompareCmd.launchCompare");var a=!0,s=null;void 0!==this.context&&null!==this.context&&(s=o._getSecurityContextFromContext(this.context));var c=null;i=i||{};let l=!1;if(null!=t){var d=[];console.log("===== CompareCmd.launchCompare: "+t.length+" objects"),t.forEach((function(t){var n={idType:"unknown",objectId:null,commands:null,objectType:null,contextId:null},i=null;t.constructor==String?(n.idType="modelID",n.objectId=t):(null!=t.commands?n.idType="IDPlusCommands":null!=t.TYPE?n.idType=t.TYPE:n.idType=t.objIDType,n.objectId=t.id,n.commands=t.commands,n.objectType=t.objType,n.contextId=t.contextId,i=t.objTenant),n.envId=null!=i?i:e,n.serviceId="3DSpace",n.displayName="",n.path="",!0===o.hasFilter(r.context,n.objectId).hasFilter&&"function"==typeof r.context.getNGFUXID&&(console.log("===== CompareCmd.launchCompare: "+n.objectId+" has filter info according to LifecycleServices"),n.filterSpec="#_need_public_filter_spec_#",l=!0),d.push(n)})),c={items:d,immediateCompare:m}}var p=widget.getPreference("useIndex"),u=null==p||p.value,m=!0===r.ImmediateCompare,g=o.getCurrentAppName(this.context),h={envId:e,protocol:"3DXContent",version:"1.0",source:g=g||"ENOSTDE_AP",widgetId:widget.id,useIndex:u,biProxyCtx:n,data:c,runOptions:i,appContextId:s};if(l){for(var f=[],C=0;C<h.data.items.length;C++){"#_need_public_filter_spec_#"===h.data.items[C].filterSpec&&f.push(C)}if(f.length>0){var b=0,v=h.data.items[f[b]],S={rootId:v.objectId,NGFUXId:r.context.getNGFUXID(!0)||widget.id,widgetId:widget.id,eventName:"getPublicFilterSpec_"+v.objectId};console.log("===== CompareCmd.launchCompare: "+v.objectId+" retrieving public filter spec"),console.log("   "+S.rootId+" "+S.NGFUXId+" "+S.widgetId+" "+S.eventName),o.getPublicFilterSpecificationPromise(r.context,S).then((function(e){console.log("===== CompareCmd.launchCompare: "+v.objectId+" public filter spec received"),v.filterSpec=e.publicSpec,f.length>1?(b=1,v=h.data.items[f[b]],S.rootId=v.objectId,console.log("===== CompareCmd.launchCompare: "+v.objectId+" retrieving public filter spec"),console.log("   "+S.rootId+" "+S.NGFUXId+" "+S.widgetId+" "+S.eventName),o.getPublicFilterSpecificationPromise(r.context,S).then((function(e){for(console.log("===== CompareCmd.launchCompare: "+v.objectId+" public filter spec received"),v.filterSpec=e.publicSpec,b=2;b<f.length;b++)h.data.items[f[b]].filterSpec="";r.launchCompare_finish(a,h,r.expectedContentObj)}))):r.launchCompare_finish(a,h,r.expectedContentObj)}))}}this.launchCompare_finish(a,h,this.expectedContentObj)},launchCompare_finish:function(e,t,o){console.log("===== CompareCmd.launchCompare_finish: seeing if launching is ready");null!=t.data&&t.data.items.some((e=>"#_need_public_filter_spec_#"===e.filterSpec))||(e?(console.log("===== CompareCmd.launchCompare_finish: launching transient widget"),require(["DS/TransientWidget/TransientWidget"],(function(e){e.showWidget("ENOCOMP_AP","",{X3DContentId:JSON.stringify(t)},{mode:"transient"})}))):(console.log("===== CompareCmd.launchCompare_finish: launching app"),require(["UWA/Utils/InterCom"],(function(e){var o=new e.Socket("compassPageSocket");o.subscribeServer("com.ds.compass",window.parent),o.dispatchEvent("onSetX3DContent",t,"compassPageSocket"),o.dispatchEvent("onLaunchApp",{appId:"ENOCOMP_AP"},"compassPageSocket")}))))},NLS_showMessage:function(e,t){"compare-alert-console"==t?console.error(e):require(["DS/CompareCommon/CompareAlert","i18n!DS/CompareCmd/assets/nls/CompareCmd"],(function(o,n){var i=null!=n[e]?n[e]:e;o.doAlert({msg:i,alertStyle:t})}),(function(o){console.log("%%%% CompareWidget:: Failed to show "+t+": '"+e+"', error:"+o)}))}});return s}));