define("DS/DMUComment/DMUCommentExport",["require","exports","DS/DMUPlayMarker/DMUCommentPositioned","DS/DMUPlayMarker/DMUCommentHighlight","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseUIServices/DMUObjectsServices"],(function(e,t,n,i,r,o){"use strict";class a{static getCommentExportDefinition(e,t){return new Promise((n=>{(async()=>{const i=e.getParent(),o=i&&i.getMarkupOwner();let a,s=o&&o.getCommentStatus(e.getAttribute("sUuid"));e.getAssociatedHighlightData().forEach((e=>{"5"===e.rating.toString()&&(a="processed")}));const m=e.getAttribute("sOwner")||"";let l=t?await r.getUserName(m):m,g={id:e.getAttribute("sUuid")||"",content:(e.getAttribute("sTextContents")||[""]).join("\n"),owner:l,creationDate:new Date(e.getAttribute("fCreationDate")||Date.now()),lastModificationDate:new Date(e.getAttribute("fLastModificationDate")||Date.now()),parentCommentId:e.getAttribute("sParentCommentId"),status:s||a};n(g)})()}))}static getExportDefinition(e,t,s){return new Promise(((m,l)=>{(async()=>{let g,u=e.getPointedPosition(),c=e.getPointedReference(0);c&&(u=o.getAbsolutePosition(e,u,u,c));let d=e.getAttribute("sUuid")||"";const p=e.getParent(),D=p&&p.getMarkupOwner();let h=D&&D.getCommentStatus(e.getAttribute("sUuid"));if(e instanceof n)g={id:d,visible:!0,type:e.getType(),position:{x:u.x,y:u.y,z:u.z},width:32,height:32,radius:1,status:h};else if(e instanceof i){let t=e.getSelection();g={id:d,visible:!0,type:e.getType(),position:{x:u.x,y:u.y},selection:t.map((t=>{let n=o.getRelativePosition(e,t.position);return{position:{x:n.x,y:n.y},width:t.width,height:t.height,rotationAngle:t.rotationAngle}})),status:h}}if(g){let o,l=r.getUserColor(e.getOwner()||"");if(l&&e instanceof n){let e=l.getHSL();e.s=1,e.l*=.5,o=l.clone().setHSL(e.h,e.s,e.l)}let u={definition:g,pageNumber:e.getAttribute("fPointedPageNumber")||s||1,material:{fill:l&&{color:l,opacity:e instanceof i?.3:1},border:o&&{color:o,thickness:.34,opacity:1}}},c=e.getDMUComments();if(c.length){u.comments=[];for(let e=0;e<c.length;e++){let n=await a.getCommentExportDefinition(c[e],t);u.comments.push(n)}}return m(u)}l(new Error("This type cannot be exported"))})()}))}}return a})),define("DS/DMUComment/DMUCommentCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUCommentHighlight","DS/DMUPlayMarker/DMUCommentPositioned","DS/DMUPlayMarker/DMUCommentOnTable","DS/DMUBaseExperience/EXPToolsVisualization","DS/VisuEvents/EventsManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseUIServices/DMUObjectsServices","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUComment/assets/nls/DMUComment"],(function(e,t,n,i,r,o,a,s,m,l,g,u,c,d,p,D,h){"use strict";return t.extend({init:function(t){this._parent(t,"exclusive",!0);var M,U,f,C,S,w=this.getFrameWindow().getViewer(),v=this;let y=t.executionContext;function b(e){if(e.pointedElementId){var t=M.getElementMatrix(e.pointedElementId);if(t){let n=new d.Vector3(e.absRect.position.x,e.absRect.position.y,0);n.applyMatrix4((new d.Matrix4).getInverse(t));let i=new d.Vector3(e.absRect.width,e.absRect.height,0);return i.applyMatrix4((new d.Matrix4).extractRotation(t)),{position:new d.Vector2(n.x,n.y),width:i.x,height:i.y}}}return e.absRect}function P(t){var i=n.getReviewContext({viewer:v.getFrameWindow().getViewer()});let m=i.getValidation(),l=m?m.getCurrentMarkup():null;l&&l.getRepRef&&(l=l.getRepRef());let g=l?l.getMarkupContent():i.getCurrentSessionMarkup(),d=g;"marker"===t.type&&t.marker&&(d=t.marker.getParent());var p,U=new r(w,d);if(U.setAttributes([{name:"sID",value:g.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:g.computeNewName({object:U,prefix:h.commentPrefix})},{name:"sOwner",value:u.getUserLogin()},{name:"sTextContents",value:[""]},{name:"fCreationDate",value:Date.now()},{name:"fLastModificationDate",value:Date.now()}]),"highlight"===t.type||"positioned"===t.type||"onTable"===t.type){let r;"highlight"===t.type?p=new o(w,g):"positioned"===t.type?p=new a(w,g):"onTable"===t.type&&(p=new s(w,g)),t.position&&M&&("Requirement"===M.getDocumentType()?r=M.getPointedElemIDAtPosition(t.position):"Document"===M.getDocumentType()&&(r=null));const m="Requirement"!==M.getDocumentType()&&function(e,{path:t}){if(t){const n=e.getOccurence({pathElement:t},!0);return n&&n.id}}(d,{path:t.path});if(p.setAttributes([{name:"sID",value:g.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:g.computeNewName({object:p,prefix:h[t.type+"CommentPrefix"]})},{name:"fPointedPageNumber",value:t.pageNumber},{name:"sPointedElementID",value:r},{name:"oSelection",value:t.selectionRects},{name:"lPointedReferences",value:m?[m]:null}]),t.position){(t.pageNumber||r)&&t.position.setZ(0);var f=c.getRelativePosition(p,t.position);p.setAttribute("vPosition",f)}if(t.tableObject){let e=t.tableObject.idPath[t.tableObject.idPath.length-1],n=t.tableObject.attrName;p.setAttributes([{name:"sPointedElementID",value:e},{name:"sAttrName",value:n}])}if(m&&t.path){const e=D.getLastReference(t.path).getLastElement(!0);if(e){const t=n.getContextViewer({reviewContext:i});D.getName([e],(function(e){e&&e.length&&e[0]&&(U.setAttribute("sTextContents",e),U.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:U}),U.fireEvent("onDMUCommentEditionRequired",{dmuObject:U,selectText:!0}))}),t)}}g.getCurrentSlide().addDMUObject(p),p.addDMUComment(U),p.fireEvent("onDMUObjectInitialized",{dmuObject:p}),p.fireEvent("onDMUObjectCreation",{dmuObject:p})}else"marker"===t.type&&t.marker&&(p=t.marker).addDMUComment(U);p&&U&&(v.addInCSO(U),U.fireEvent("onDMUObjectInitialized",{dmuObject:U}),U.fireEvent("onDMUCommentEditionRequired",{dmuObject:U}),i.getUIManager().isAPreviewRegistered()||i.getUIManager().registerElementIdAsPreview(U.getAttribute("sUuid"),g),require(["DS/DMUBaseExperience/EXPUtils"],(function(e){e._sendUsageProbe("command","CreateComment"+g.getCurrentSlide().getType())})),U.fireEvent("onDMUObjectCreation",{dmuObject:U}),v.publish({event:"EndCommand"}))}function x(){var e=window.getSelection();if(e&&""!==e.toString())for(var t=e.getRangeAt(0),n=0,i=t.commonAncestorContainer;i&&n<15;){if(i===w.currentViewpoint.divCameraCSSElement)return t;i=i.parentNode,n++}return null}function E(){var e=p.get(),t=n.getReviewContext({viewer:v.getFrameWindow().getViewer()});if(t)for(var i=0;i<e.length;i++){var r=t.getDMUObjectFromPathElement(e[i].pathElement);if(r&&r.addDMUComment)return r}return null}function O(){if(!M||"Requirement"!==M.getDocumentType()&&"Document"!==M.getDocumentType()){for(var e=p.get(),t=0;t<e.length;t++){const n=e[t];if(n&&(D.isAModelPath(n.pathElement)||D.isAPOIPath(n.pathElement)))return n.pathElement}return null}}function k(e,t){for(let n=0;n<t.length;n++){const i=t[n];if(i!==e&&e.top<i.y&&e.bottom>i.y+i.height&&e.left<i.x&&e.right>i.x+i.width)return!1}return!0}function A(e){var t=[],n=m.getMMPerPixelRatio(w),i=Array.from(e.getClientRects()).filter((e=>e.height&&e.width)),r=w.canvas.getOffsets(),o=m.getPickingInfo(w,new d.Vector2(i[0].x-r.x,i[0].y-r.y)).point;o=new d.Vector3(o.x,o.y,0);for(var a="Document"===M.getDocumentType()&&i.length>2,s=0;s<i.length;s++)if((!a||(s+1)%2!=0||s+1===i.length)&&k(i[s],i)){for(var l=m.getPickingInfo(w,new d.Vector2(i[s].x-r.x,i[s].y-r.y)).point,g=M.getPointedElemIDAtPosition(l),u="number"==typeof g?g:null,c="string"==typeof g?g:null,p=b({absRect:{position:l,width:i[s].width*n,height:i[s].height*n},pointedElementId:g}),D=!1,h=0;h<t.length;h++)(u&&t[h].page===u||c&&t[h].element===c)&&(t[h].rects.push(p),D=!0);D||t.push({page:u,element:c,rects:[p]})}P({type:"highlight",pageNumber:t[0].page,pointedElement:t[0].element,position:o,selectionRects:t})}function R(e){var t=M.getElementToDraw(e.from[0].getView());if(t){var i=x();if(i)A(i);else{var r=E();let i=n.getReviewContext({viewer:v.getFrameWindow().getViewer()});const s=r&&i&&i.getRestrictions(r.getParent());if(s&&(s.markup.canEdit||s.reply.canEdit))P({type:"marker",marker:r});else{var o=e.from[0].getCurrentPosition(w.canvas),a=M.getPageNumber(t);const n=m.getPickingInfo(w,o);P({type:"positioned",pageNumber:a,position:n.point,path:n.paths&&n.paths[0]})}}}}function I(){let e;M||(M=g.getManager({name:"DMU2DSheetManager",context:v.getFrameWindow()})),y&&(e=y.getComponent("DMUApplicativeManagerComponent")),M.setLinkActivationFlag(!1);var t=x();if(t)v.emptyHSO(),v.emptyCSO(),A(t);else if(e){let t=e.getCurrentSelection();v.emptyHSO(),v.emptyCSO(),t.length&&t[0].idPath?P({type:"onTable",tableObject:t[0]}):(C||(C=n.getEventsController({viewer:v.getFrameWindow().getViewer()})),S=C.addEvent("onApplicativeSelectionChanged",(function(e){if(!e||!e.listOfSelectedObjects||!e.listOfSelectedObjects.length)return;const t=e.listOfSelectedObjects[0];t&&(v.emptyHSO(),v.emptyCSO(),P({type:"onTable",tableObject:t}),C&&S&&C.removeEvent(S))})),v.sendNotify("info",h.commentCreationLabel))}else{var r=E();let e=n.getReviewContext({viewer:v.getFrameWindow().getViewer()});const t=r&&e&&e.getRestrictions(r.getParent());if(t&&(t.markup.canEdit||t.reply.canEdit))v.emptyHSO(),v.emptyCSO(),P({type:"marker",marker:r});else{const e=O();!e||M&&"Requirement"===M.getDocumentType()?(v.emptyHSO(),v.emptyCSO(),function(){U=M.getPointedElem();var e=i.giveDMUCursorsController({context:v.getFrameWindow()});e&&e.setCursors({pages:"crosshair",preHLMarkers:"pointer"}),l.addEvent(U,"onPrimaryPointerUpUnique",R),f=p.onPostAdd((e=>{if(!e||e.some((e=>e.event)))return;const t=O();!t||M&&"Requirement"===M.getDocumentType()||(v.emptyHSO(),v.emptyCSO(),P({type:"positioned",position:t.getBoundingSphere(w).center,path:t}))})),v.sendNotify("info",h.commentCreationLabel)}()):(v.emptyHSO(),v.emptyCSO(),P({type:"positioned",position:e.getBoundingSphere(w).center,path:e}))}}}function T(){v.cleanNotify(),M&&(M.setLinkActivationFlag(!0),M=null);var e=i.giveDMUCursorsController({context:v.getFrameWindow()});e&&e.restoreCursors(),l.removeEvent(U,"onPrimaryPointerUpUnique",R),f&&p.unsubscribe(f),f=null,S&&C&&C.removeEvent(S),S=C=null,v.restoreDefaultController(),v.end?v.end():v.done()}this.cancelExecute=function(){T()},this.buildGraph=function(){v.changeDefaultController(),setTimeout(I);var e=v.createInitialState("initialState"),t=v.getFinalState(),n={iSender:v,iEvent:"EndCommand",iInitialState:e,iFinalState:t,iCondition:null,iAction:function(e){T(),e()}};v.addTransition(n)}}})})),define("DS/DMUComment/DMUCommentContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/DMUBaseUI/DMUToolsContextualBar","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseUIServices/DMUSlidePreferences"],(function(e,t,n,i,r){"use strict";let o,a;const s=function(e,t,n=1){Boolean("wafr"===require("DS/PADUtils/PADSettingsMgt").getSetting("eno3dviewer_infrastructure_version"))?o.push({type:"WAfrDefaultHandlerItem",handlerId:e,hdr_list:[e]}):o.push({line:n,name:t,hdr_list:[e]})};return e.extend({getSharedContextualMenuCommandList:function(e){return e.every((e=>!e.isReadOnly()&&"DMUComment"===e.getType()))?this.getContextualMenuCommandList(e):[]},getContextualMenuCommandList:function(e){const m=n.getReviewContext({viewer:this.getFrameWindow().getViewer()}),l=m&&m.getValidation(),g=l&&"Activated"===l.getRestrictedEditionFlag(),u=this.getParent(),c=u&&u.getMarkupOwner(),d=c&&c.getCommentStatus(this.getAttribute("sUuid")),p=this.getAssociatedHighlightData(),D=p&&p.length>0,h=g&&Boolean(d||D);if(o=[],!this.isReadOnly()){if(l){if(e&&e.length>1)return function(e,t){let r=!1,a=!1;const m=n.getReviewContext({viewer:t.getFrameWindow().getViewer()}),l=(m&&m.getValidation()).getMembers(),g=l&&Object.keys(l.getAttribute("sJsonMembers")).length,u=!!g&&l.getCoordinators().some((e=>e.user===i.getUserLogin())),c=m.getRestrictions().markup.canCreate,d=g?u:c;return e.forEach((e=>{const t=e.getParent(),n=t&&t.getMarkupOwner(),i=e.getAssociatedHighlightData();n&&n.getCommentStatus(e.getAttribute("sUuid"))?d&&(a=!0):!d||i&&i.length||(r=!0)})),r&&(s("DMUMarkCommentProcessedHdr"),s("DMUMarkCommentWithdrawnHdr")),a&&s("DMUUnMarkCommentHdr"),o}(e,this);if(h||s("DMUReplyCmdHdr","DMUReplyCmdStr"),!this.isReply()&&window.widget&&"ENOR3V_AP"===window.widget.getValue("appId")){const e=l.getMembers(),t=e&&Object.keys(e.getAttribute("sJsonMembers")).length,n=!!t&&e.getCoordinators().some((e=>e.user===i.getUserLogin())),o=m.getRestrictions(),g=o.highlight.canCreate,u=o.markup.canCreate,c=t?n:u;d?c&&s("DMUUnMarkCommentHdr","DMUUnMarkCommentStr"):(c&&!D&&(s("DMUMarkCommentProcessedHdr","DMUMarkCommentProcessedStr"),s("DMUMarkCommentWithdrawnHdr","DMUMarkCommentWithdrawnStr")),g&&(D||s("DMUAddHighlightHdr","DMUAddHighlightStr"),function(e){let t=e.getAssociatedHighlightData(),n=r.getSlidePreferences({context:e.getFrameWindow()});return a=n&&n.highlightPreference,!((t&&!(t.length<2)||"highlightTypeIssue"!==a||t[0]&&t[0].hasIssue)&&("highlightTypeTask"!==a||t[0]&&t[0].hasTask))}(this)&&("highlightTypeIssue"===a?s("issueTemplate"===localStorage.getItem("issueCreationType")?"DMUGenerateIssueFromTemplateFromSelectionHdr":"DMUGenerateIssueFromSelectionHdr","DMUGenerateIssueFromSelectionStr"):s("DMUGenerateTaskFromSelectionHdr","DMUGenerateTaskFromSelectionStr"))))}}h||s("DMUDeleteHdr","DMUDeleteStr"),!t.isCloud()||this.isPreview()||this.isReply()||s("DMUSetAsPreviewHdr","DMUSetAsPreviewStr")}return o},getContextualCommandList:function(){return o=[],!this.isReadOnly()&&this.isInEdition()&&s("DMUCommentCmdHdr"),o},register:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:"markup"===e.experience?{type:"DMUComment",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}:{type:"DMUComment",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:"markup"===e.experience?{type:"DMUComment",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}:{type:"DMUComment",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})}})}));