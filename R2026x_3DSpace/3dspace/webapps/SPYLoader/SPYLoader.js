/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/SPYLoader/SPYStreamLoader",["UWA/Core","UWA/Class","DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI"],(function(e,t,i,n,s,r,o){"use strict";var a=null,d=null,l=function(e,t,i,n){var s={name:"",store:""};return s.name=e+"_'"+t+"'."+i,s.name+="="+n,s.format=i,s.persistencyName=n,s};return t.singleton({load:function(e){var t,u,c,h;null!==a&&null!==d&&d.url===e.serverUrl&&d.contextid===e.contextid||(function(e){var t=e.url;e.xmqlServiceUri=function(){return t+"/i3dx/services/xmql"},e.threedexpServiceUri=function(){return t};var i=o.getUser().login;s.useUWAProxy({proxymode:"passport",login:i,contextid:e.contextid}),e.login=i}(d={rawmode:!1,url:e.serverUrl,contextid:encodeURIComponent(e.contextid)}),a=new i(d)),e.sd?(u=e.repId,c=e.sd,h=function(e){var t=/SDv2\((.*),'(.*)',(.*),.*,.*,'(.*)','(.*)'\)/.exec(e);return{format:t[1],role:t[2],lateType:t[3],persistencyType:t[4],persistencyName:t[5]}}(c),t=l(u,h.role,h.format,h.persistencyName)):t=l(e.repId,e.role,e.format,e.persistencyName),function(e,t,i,r){var o=a.transformSelectedFileIntoTicketRequest(e,t.format,t.store,t.name),l=new n(o,d);(new s).asyncTransformFCSUrlIntoRealUrl(l.generateRequest(),!1,(function(e,t){i(t)}))}(e.repId,t,(function(i){!function(e,t,i,n,s,o,a){if("posthttp"==e.slice(0,8)){var d=e.indexOf(":postparams:"),l=e.slice(9,d),u=e.slice(d+12,e.length),c={cors:!0,timeout:isNaN(a)?0:a,method:"POST",data:u,responseType:i,async:!0,headers:{Accept:"text/plain",SecurityContext:encodeURIComponent(t)},onComplete:n,onFailure:s,onTimeout:o};r.authenticatedRequest(l,c)}}(i,e.contextid,e.streamType,(function(i){e.onStreamLoaded(t.persistencyName,i)}),e.onError,e.onTimeOut,e.timeout)}),e.onError)}})})),define("DS/SPYLoader/SPYWSProxy",["UWA/Class","DS/WAFData/WAFData"],(function(e,t){"use strict";const i="physicalid",n="bo.streamdescriptors",s="label",r="bo.designsight.simulationorigin",o="revision",a="current",d="lightweightViz";let l,u=function(e){let t=12e4;return e>150&&(t*=e/150,t=Math.min(Math.round(t),24e4)),t},c=function(e,d,u,c){!function(e,d,l,u){let c=e.serverurl+"/cvservlet/progressiveexpand/v2";c+="?tenant="+e.tenant,c+="&SecurityContext="+encodeURIComponent(e.contextid),c+="&output_format=cvjson";let h={timeout:2e4,onComplete:d,onCancel:l,onFailure:l,onTimeout:u,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en"}},m={batch:{expands:[{label:"SimulationExperienceContent_ExpV2",root:{physical_id:e.physicalid},filter:{all:1},graph:{descending_condition:{uql:"availability:1"},descending_condition_object:{uql:'(flattenedtaxonomies:"types/dsc_Result_Category_Ref") OR (flattenedtaxonomies:"types/dsc_Result_rep")'}}}]},outputs:{select_object:[i,n,r,"type",s,o,"islastrevision",a]}};h.data=JSON.stringify(m),t.authenticatedRequest(c,h)}(e,(function(e){let t=h.errorCodes.ERR_EXPANDCV_FAILED;if("string"==typeof e&&e.length>0){let t=JSON.parse(e).results;if(Array.isArray(t)&&t.length>=3){let e=t[0],i=t[2];if(i&&e){let t=e[r];return l=t||void 0,void d(i,e)}}}u(t)}),u,c)},h=e.singleton({errorCodes:{ERR_NOEXTDATA:"SPYWS_NOEXTDATA",ERR_UNEXPECTED:"SPYWS_UNEXPECTED",ERR_EXTDATA_PARSE:"SPYWS_EXTDATA_PARSE_FAILED",ERR_EXTDATA_NORUNS:"SPYWS_EXTDATA_NORUNS",ERR_EXTDATA_NOLW:"SPYWS_EXTDATA_NOLW",ERR_GETLWSTREAMS_NOLW:"SPYWS_GETLWSTREAMS_NOLW",ERR_EXPANDCV_FAILED:"SPYWS_EXPANDCV_FAILED"},getLatestSimulationOrigin:function(){return l},getThumbnails:(e,i,n,s)=>function(e,i,n,s){let r=[];if(null!=e[0]){let o=e[0].serverurl+"/cvservlet/fetch/v2";o+="?tenant="+e[0].tenant,o+="&SecurityContext="+encodeURIComponent(e[0].contextid),e.forEach((function(e){r.push(e.physicalid)}));let a={timeout:6e4,onComplete:i,onCancel:n,onFailure:n,onTimeout:s,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en"}},d={physicalid:r,label:"PhysicsSimulationResults_"+Date.now(),select_file:["icon","thumbnail_2d"],tenant:e[0].tenant};a.data=JSON.stringify(d),t.authenticatedRequest(o,a)}}(e,i,n,s),getResultExtendedData:function(e,t,i,n){Date.now();c(e,((e,n)=>{let s=e["bo.simobjsimulationv5repreferencegeneric.v_extendeddata"],r=this.errorCodes.ERR_UNEXPECTED;if(void 0===s||"string"!=typeof s||s.length<=0)r=this.errorCodes.ERR_NOEXTDATA,i(r);else try{let e=JSON.parse(s);t(e,simulationAttributes)}catch(e){r=this.errorCodes.ERR_EXTDATA_PARSE,i(r)}}),i,n)},_postRequestToSMAServices:function(e,i,n,s,r){let o={timeout:6e4,onComplete:e=>{let t=this.errorCodes.ERR_UNEXPECTED;if(void 0===e||"string"!=typeof e||e.length<=0)t=this.errorCodes.ERR_NOEXTDATA,s(t);else try{let t=JSON.parse(e);n(t)}catch(e){t=this.errorCodes.ERR_EXTDATA_PARSE,s(t)}},onCancel:s,onFailure:s,onTimeout:r,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en",SecurityContext:e.contextid}},a={itemId:e.physicalid,clientContext:{}};a.clientContext[["e","k","a","r","i","p","m","u","i","l"].reverse().reduce((function(e,t){return e+t}),"")]="7948163181467835",o.data=JSON.stringify(a),t.authenticatedRequest(i,o)},getAnalysisCases:function(e,t,i,n){let s=e.serverurl+"/resources/SMAPowerByServices/getAnalysisCases";this._postRequestToSMAServices(e,s,t,i,n)},getRuns:function(e,t,i,n){let s=e.serverurl+"/resources/SMAPowerByServices/getRuns";this._postRequestToSMAServices(e,s,t,i,n)},getLWDictionary:function(e,t,i,n,s){let r=s&&s.compareCVExpand;r&&this.getResultExtendedData(e,((e,t)=>{console.log(" ** sma getResultExtendedData onComplete => : ",e,t)}),i,n);
//!!
//!!
let o=Date.now();this.getRuns(e,(n=>{r&&console.log(" ** SPYLW - getRuns call took in ms: ",Date.now()-o);let s=this.errorCodes.ERR_UNEXPECTED,a=new Map,l={};if(n){l.boId=n.contentId,l.boCEstamp=n.cestamp,l.definitionProvider=e.serverurl,s=this.errorCodes.ERR_EXTDATA_NORUNS;let t=n.runs;if(t){this.errorCodes.ERR_EXTDATA_NOLW,Object.keys(t).forEach((function(e){let i=t[e];if(i&&i[d]){let t={name:i.name,lastRunID:e,lastUpdate:i.updateStamp,lw:i[d]};a.set(i.analysisCaseId,t)}}))}}a.size>0?t(a,l):i(s)}),i,n)},loadContentStream:function(e,t,i,n){},getLWstreamUrl:function(e,n,s,r){c(e,(function(o){!function(e,n,s,r,o){let a=e.serverurl+"/cvservlet/fetch/v2";a+="?tenant="+e.tenant,a+="&SecurityContext="+encodeURIComponent(e.contextid);let d={timeout:6e4,onComplete:s,onCancel:r,onFailure:r,onTimeout:o,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en"}},l={physicalid:[n],fcs_url_mode:"REDIRECT",select_file:["xml"],select_predicate:[i],label:"SimulationExperienceContent_Fetch",tenant:e.tenant,locale:"en"};d.data=JSON.stringify(l),t.authenticatedRequest(a,d)}(e,o.id,n,s,r)}),s,r)},getLWstreamsIds:function(e,t,i,s){l=void 0;let r=Date.now();c(e,((e,s)=>{let o=e[n];if(o){let n=o.split(":").filter((e=>e.contains("SimNavData_")));if(n.length>0){let i=Date.now()-r,s=u(i);t(e.resourceid,n,s)}else i(this.errorCodes.ERR_GETLWSTREAMS_NOLW)}else i()}),(n=>{let o=e.serverurl+"/resources/SMAPowerByServices/getAttachedStreams";this._postRequestToSMAServices(e,o,(e=>{if(e&&Array.isArray(e.streams)){let n=e.streams.filter((function(e){return"xml"===e.filetype&&e.name.contains("SimNavData_")}));if(n.length>0){n.forEach((function(e,t,i){let n=e.locator.split(":");i[t]="SDv2(2,'EXTENDED',CATNonCATIADocument,'-1181347442','-1181347444','xml','"+n[4]+"')"}));let i=Date.now()-r,s=2*u(i);t(e.contentId,n,s)}else i(this.errorCodes.ERR_GETLWSTREAMS_NOLW)}}),i,s)}),s)}});return h})),define("DS/SPYLoader/MSRFileTreeProxy",["UWA/Core","UWA/Class","DS/WebServicesUtils/WebServicesUtils"],(function(e,t,i){"use strict";const n="/resources/v1/modeler/dsmsrprotected";return t.singleton({getSimulation:async function(e,t){const s=e+n+"/dsmsr:Simulation/"+t+"/dsmsr:Result?allReps=true";return(await i.request(s,{method:"GET",type:"json"})).body},getFileTree:async function(e,t,s){const r=e+n+"/dsmsr:Simulation/"+t+"/dsmsr:Result/"+s;return(await i.request(r,{method:"GET",type:"json"})).body},getFileTreeCheckoutTicket:async function(e,t,s,r){const o=e+n+"/dsmsr:Simulation/"+t+"/dsmsr:Result/"+s+"/files/"+r+"/DownloadTicket";return(await i.request(o,{method:"GET",type:"json"})).body},downloadFile:async function(e,t,n,s,r,o,a){var d={method:"POST",proxy:"passport",responseType:n,onTimeout:r,data:{__fcs__jobTicket:t}};o&&(d.onProgress=o),void 0!==a&&(d.timeout=a);return(await i.request(e+"/"+s,d)).body}})})),define("DS/SPYLoader/AbstractLoader",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/WebUtils/ProbesManager","DS/SPYUtils/TrackingManager"],(function(e,t,i,n,s){"use strict";return t.extend({_cleanCompleteCb:function(){this._sequenceCreatedCB&&(i.unsubscribe(this._sequenceCreatedCB),delete this._sequenceCreatedCB)},_cleanErrorCb:function(){this._sequenceErrorCB&&(i.unsubscribe(this._sequenceErrorCB),delete this._sequenceErrorCB)},_loadSequence:function(e,t){if(e&&this._listObjToLoad.push(e),!this._loading&&0!==this._listObjToLoad.length){var i=this._listObjToLoad.shift(),s=n.createProbe("MsrEcLoadSequence"+this._probesLoadSequence.length);this._probesLoadSequence.push(s),s.begin(),this._loading=!0,this._dmFactory.createSequence({src:i,spm:this._spm},t)}},_loadModel:function(){},init:function(){this._parent(),this._loading=!1,this._listObjToLoad=[],this._defaultAssetType=void 0,this._streamsInfo=[],this._typingInfo={},this._report={streamsInfo:[]},this._probesLoadSequence=[]},clean:function(){this._cleanCompleteCb(),this._cleanErrorCb(),this._spm=null,this._listObjToLoad=[],this._streamsInfo=[],delete this._dmFactory,this._report={streamsInfo:[]},this._probesLoadSequence.forEach((function(e){e&&e.end()}))},onUnstreamComplete:function(e,t){this._cleanCompleteCb(),this._sequenceCreatedCB=i.subscribe({event:e+"/SPY/SEQUENCE/CREATED"},function(e){var i=this._probesLoadSequence[e.seqIdx];i&&i.end(),this._report&&e&&(this._report.filteredDDNb=e.filteredDDNb),t(e)}.bind(this))},onUnstreamError:function(e,t){this._cleanErrorCb(),this._sequenceErrorCB=i.subscribe({event:e+"/SPY/SEQUENCE/ERROR"},function(e){var i;(i=isNaN(e.seqIdx)?this._probesLoadSequence.pop():this._probesLoadSequence[e.seqIdx])&&i.end(),e&&"FILTEREDCONTENT"===e.errorCode?(this._report&&(this._report.filteredContent=!0),s.trackAllContentsFiltered(void 0,this._typingInfo)):(this._report&&(isNaN(this._report.invalidStreamNb)&&(this._report.invalidStreamNb=0),this._report.invalidStreamNb++),s.trackInvalidStreamContent(void 0,this._typingInfo)),this._loading=!1,t()}.bind(this))},onQueryStart:function(e,t){this._onQueryStart=t},onQueryProgress:function(e,t){this._onQueryProgress=t},onUnstreamStart:function(e,t){this._onUnstreamStart=t},onDicoThumbnailsReady:function(e,t){},onFileTreeRegenerationSuggested:function(e,t){},onFileNotSupported:function(e,t){this._onFileNotSupported=t},onQueryError:function(e,t){this._onQueryError=t},onTimeOut:function(e,t){this._onTimeOut=t},load:function(e,t,i){this._spm=i,s.setTenant(e.tenant),this._spm.addAnalytics({providerType:e.provider,assetType:e.dtype||this._defaultAssetType,tenant:e.tenant,loadStart:Date.now()}),require([t],function(t){var i,r,o=function(){},a=this._onFileNotSupported?this._onFileNotSupported:o,d=this._onUnstreamStart?this._onUnstreamStart:o,l=this._onTimeOut?this._onTimeOut:o;this._dmFactory=new t;var u=this.getReport();if(u.streamNb=0,"FILE"===e.provider){var c="3dsim"===e.format||"simxml"===e.format,h=e.format===e.mimetype&&e.format===e.type;if(0===(r=e.filename&&e.filename.length>0?e.filename:e.serverurl).indexOf("https",0)&&r.indexOf(e.format,0)<0&&h){c?(u.streamNb=1,i={persistentId:r,index:0,provider:"FILE",filename:r,filesize:e.filesizes?Number(e.filesizes):void 0,proxyurl:"none",withCredentials:!0},d(),this._loadSequence(i)):a()}else{let t=e.filename,n=e.filesizes,s=new RegExp("[;]+","g"),r=t.split(s),o=n?Array.isArray(n)?n:n.split(s):[],l=0;r.forEach(((e,t)=>{0!==e.indexOf("blob",0)&&e.indexOf("3dsim",0)<0&&e.indexOf("simxml",0)<0&&e.indexOf("zip",0)<0&&e.indexOf("nas",0)<0&&e.indexOf("inp",0)<0&&e.indexOf("json",0)<0&&a(),e.indexOf("json",0)<0&&(i={persistentId:e,index:l,provider:"FILE",filename:e,filesize:Number(o[t]),serverurl:"",proxyurl:"none",requiredAuth:null,withCredentials:!0},d(),this._loadSequence(i),l++)})),u.streamNb=l}}else if("BLOB"===e.provider)e.blob instanceof Blob&&(u.streamNb=1,i={provider:"BLOB",blob:e.blob,index:0,analytics:{dataSize:e.blob.size,streamingTime:0}},d(),this._loadSequence(i));else if("EV6"===e.provider||"3DSPACE"===e.provider){this._onQueryStart&&this._onQueryStart();var m=this._onQueryProgress?this._onQueryProgress:o,p=this._onQueryError?this._onQueryError:o,f=n.createProbe("MsrEcLoadModel");f.begin(),this._loadModel(e,m,function(e,t){f.end(),u&&(isNaN(u.streamTimeOut)||l()),t&&this._spm.setTypingInfo(t);var n=this;if(Array.isArray(e))e&&e.length>0&&(d(),e.forEach((function(e){i={persistentId:e.persistentId,index:e.index,provider:"BUFFER",buffer:e.data?e.data:e,analytics:{dataSize:e.dataSize,streamingTime:e.streamingTime}},n._loadSequence(i)})));else{var s=e;if(s.length>0){d();for(var r=new RegExp("[;]+","g"),o=s.split(r),c=0;c<o.length;c++){if(0!==(s=o[c]).indexOf("blob",0)&&s.indexOf("simxml",0)<0)return void a();i={provider:"FILE",filename:s,serverurl:"",proxyurl:"none",requiredAuth:null},this._loadSequence(i)}}}}.bind(this),function(e){switch(f.end(),e){case"NOACCESS":s.trackNoAccess(void 0,this._typingInfo);break;case"NOSTREAM":s.trackNoSimulationEC(void 0,this._typingInfo)}p(e)}.bind(this),function(e){s.trackECLoadingTimeOut(void 0,this._typingInfo,e)}.bind(this))}}.bind(this))},isLoadingComplete:function(){return 0===this._listObjToLoad.length&&!this._loading&&!this._spm.loading},getLoading:function(){return this._loading},setLoading:function(e){this._loading=e},continueLoading:function(){this._loading=!1,this._loadSequence()},getReport:function(){return this._report},resetReport:function(){this._report={streamsInfo:[]}},getDMFactory:function(){return this._dmFactory},extensionLoad:function(e,t,i,n){let s=function(){i&&i()},r=function(){n&&n()},o=this.getDMFactory();if(o&&o.setExtendedMode&&this._spm&&this._streamsInfo){o.setExtendedMode(!0);let i=-1;e&&(i=this._spm.findSequenceByPersistentId(e)),i<0&&(i=this._spm.findSequenceByName(t));let n=this._streamsInfo[i];n?this._loadSequence({provider:"BUFFER",buffer:n.data,analytics:{dataSize:n.dataSize,streamingTime:n.streamingTime}},{onComplete:s,onError:r}):r()}else r()},extensionLoadAll:function(){let e=this.getDMFactory();if(e&&e.setExtendedMode&&this._spm&&this._streamsInfo){this.resetReport&&this.resetReport(),e.setExtendedMode(!0);for(const e in this._streamsInfo){let t=this._streamsInfo[e];t&&this._loadSequence({provider:"BUFFER",buffer:t.data,analytics:{dataSize:t.dataSize,streamingTime:t.streamingTime}})}}}})})),define("DS/SPYLoader/MSRFileTreeLoader",["UWA/Core","UWA/Class","DS/SPYLoader/MSRFileTreeProxy","DS/i3DxMdSimulationWeb/i3DxMSRFileTree"],(function(e,t,i,n){"use strict";return t.singleton({_mergeDictionaries:function(e){if(0===e.length)return null;return{version:e[0].version,analysisCases:e.flatMap((e=>(e.analysisCases??[]).filter((e=>Array.isArray(e.contents)&&e.contents.length>0))))}},loadPrimaryDico:async function(e){try{const{fcsurl:t,ticket:n}=await i.getFileTreeCheckoutTicket(e.url,e.simId,e.resultRepId,e.key);return await i.downloadFile(t,n,e.streamType,e.key,e.onTimeOut)}catch(t){return e.onError(t),null}},loadPrimaryDictionaries:async function(e){try{const t=e.keys.map((async t=>{const i={url:e.url,simId:e.simId,resultRepId:e.resultRepId,key:t,onError:e.onError,streamType:"json",onTimeOut:e.onTimeOut};return this.loadPrimaryDico(i)})),i=(await Promise.allSettled(t)).filter((e=>"fulfilled"===e.status&&e.value)).map((e=>e.value)),n=this._mergeDictionaries(i);e.onPrimaryDicoLoaded(n)}catch(t){e.onError(t)}},loadThumbnails:async function(e){const t=e.thumbnails,n=e.keys,s=Object.entries(t).flatMap((([t,s])=>s.map((async s=>{try{const r=n.get(s),{fcsurl:o,ticket:a}=await i.getFileTreeCheckoutTicket(e.url,e.simId,e.resultRepId,r),d=await i.downloadFile(o,a,e.streamType,r,e.onTimeOut),l=new Blob([d],{type:"image/PNG"});return e.onThumbnailLoaded(t,s,l),l}catch(t){throw e.onError(t),t}}))));await Promise.allSettled(s)},loadStream:function(e){(async()=>{try{const{fcsurl:t,ticket:n}=await i.getFileTreeCheckoutTicket(e.url,e.simId,e.resultRepId,e.streamKey),s=await i.downloadFile(t,n,e.streamType,e.streamKey,e.onTimeOut,e.onProgress,e.timeout);e.onStreamLoaded(s)}catch(t){e.onError(t)}})()},loadDataModel:function(e){(async()=>{try{const t=["SimNavData.xml"];let i=await n.getFileTreeDownloadURL(e.url,e.contextid,e.simId,e.resultRepId,e.streamKey,t);e.onStreamLoaded(i[0].buffer)}catch(t){e.onError(t)}})()}})})),define("DS/SPYLoader/SPYLoader",["UWA/Core","UWA/Class","DS/SPYLoader/AbstractLoader","DS/SPYLoader/SPYWSProxy","DS/SPYLoader/SPYStreamLoader"],(function(e,t,i,n,s){"use strict";var r="DesignSight";return i.singleton({_defaultAssetType:r,_loadModel:function(e,t,i,r,o){e.contextid=e.contextid||e.contextId,this._typingInfo={assetType:e.dType||e.type,providerType:e.provider},this._streamsInfo=[],n.getAnalysisCases(e,(e=>{if(e)for(var t in e.analysisCases){var i=e.analysisCases[t];this._typingInfo[t]={name:i.name,origin:i.origin,sequenceType:i.type,sequenceSubTypes:i.subType,featureId:i.featureId};var n=i.appData_NativeApp||i.appData_SimMgr;n&&(this._typingInfo[t].internalId=n.internalId,this._typingInfo[t].internalName=n.internalName)}}),(e=>{this._typingInfo.error=e}),(()=>{this._typingInfo.timeout=!0})),n.getRuns(e,(e=>{if(e)for(var t in e.runs){var i=e.runs[t];if(i.analysisCaseId){var n=this._typingInfo[i.analysisCaseId];n&&(n.resultSequenceId=t)}}}),(()=>{}),(()=>{})),this._onFinish=i,n.getLWstreamsIds(e,((i,a,d)=>{if(this._typingInfo.simulationOrigin=n.getLatestSimulationOrigin(),s&&Array.isArray(a)){var l=0,u=a.length;this._report.streamNb=u,this._report.suggestedTimeout=d,t(0,{streamsLoaded:0,streamsTotal:u});for(let e=0;e<a.length;e++)a[e]={id:a[e],order:e};if(this._spm){let e=this._spm.getPreferredStreamId();if(e){let t=a.findIndex((t=>t.id.contains(e)));t>0&&a.splice(0,0,a.splice(t,1)[0])}}a.forEach((n=>{var c=Date.now(),h={repId:i,serverUrl:e.serverurl,contextid:e.contextid,sd:n.id,streamType:"arraybuffer",onStreamLoaded:function(e,i){u--;var s=a.length-u;t(100*s/a.length,{streamsLoaded:s,streamsTotal:a.length}),this._streamsInfo.push({persistentId:e,index:n.order,data:i,dataSize:i.byteLength,streamingTime:Date.now()-c}),0===u&&this._onFinish(this._streamsInfo,this._typingInfo)}.bind(this),timeout:d,onTimeOut:()=>{l++,u--,this._report.streamTimeOut=l;var e=a.length-u;t(100*e/a.length),o&&o(Date.now()-c),0===u&&this._onFinish(this._streamsInfo,this._typingInfo)},onError:e=>{u--,r("NOACCESS")}};s.load(h)}))}}),(e=>{this._typingInfo.simulationOrigin=n.getLatestSimulationOrigin(),e===n.errorCodes.ERR_GETLWSTREAMS_NOLW?r("NOSTREAM"):r("NOACCESS")}),(()=>{this._typingInfo.simulationOrigin=n.getLatestSimulationOrigin(),r("NOACCESS")}))},declareToPAD:function(e,t,i){if(e&&e.loadJSON){var n=[{rootID:t,validForServerCall:!0,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":r,"ds6w:globaltype":"ds6w:Document","ds6w:label":i,boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":r,"ds6w:globaltype":"ds6w:Document",boundingbox:{max:[-1,-1,-1],min:[1,1,1]}}]},refreshDelegationCB:()=>new Promise((e=>{e()}))}];e.loadJSON({data:n})}},removeFromPAD:function(e,t){e&&t&&e.removeRoots({pids:[t]})}})})),define("DS/SPYLoader/MSRLoader",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/WebUtils/ProbesManager","DS/SPYUtils/TrackingManager","DS/SPYLoader/SPYLoader","DS/SPYLoader/SPYWSProxy","DS/SPYLoader/SPYStreamLoader","DS/SPYLoader/MSRFileTreeProxy","DS/SPYLoader/MSRFileTreeLoader","DS/i3DxMdSimulationWeb/i3DxMSRFileTree"],(function(e,t,i,n,s,r,o,a,d,l,u){"use strict";var c="DesignSight";return t.singleton({_defaultAssetType:c,_cleanCompleteCb:function(){this._sequenceCreatedCB&&(i.unsubscribe(this._sequenceCreatedCB),delete this._sequenceCreatedCB)},_cleanErrorCb:function(){this._sequenceErrorCB&&(i.unsubscribe(this._sequenceErrorCB),delete this._sequenceErrorCB)},_loadSequence:function(e,t){if(e&&this._listObjToLoad.push(e),!(this.oldLoader?this.oldLoader.getLoading():this._loading)&&0!==this._listObjToLoad.length){var i=this._listObjToLoad.shift(),s=n.createProbe("SPY.MSRLoader.LOADSEQUENCE."+this._probesLoadSequence.length);this._probesLoadSequence.push(s),s.begin(),this.oldLoader?this.oldLoader.setLoading(!0):this._loading=!0,this._dmFactory.createSequence({src:i,spm:this._spm},t)}},init:function(){this._parent(),this._listObjToLoad=[],this._defaultAssetType=void 0,this._streamsInfo=[],this._typingInfo={},this._report={streamsInfo:[]},this._probesLoadSequence=[]},clean:function(){this._cleanCompleteCb(),this._cleanErrorCb(),this._spm=null,this._listObjToLoad=[],this._streamsInfo=[],delete this._dmFactory,this._report={streamsInfo:[]},this._probesLoadSequence.forEach((function(e){e&&e.end()}))},onUnstreamComplete:function(e,t){this._cleanCompleteCb(),this._sequenceCreatedCB=i.subscribe({event:e+"/SPY/SEQUENCE/CREATED"},function(e){var i=this._probesLoadSequence[e.seqIdx];i&&i.end(),this._report&&e&&(this._report.filteredDDNb=e.filteredDDNb),t(e)}.bind(this))},onUnstreamError:function(e,t){this._cleanErrorCb(),this._sequenceErrorCB=i.subscribe({event:e+"/SPY/SEQUENCE/ERROR"},function(e){var i;(i=isNaN(e.seqIdx)?this._probesLoadSequence.pop():this._probesLoadSequence[e.seqIdx])&&i.end(),e&&"FILTEREDCONTENT"===e.errorCode?(this._report&&(this._report.filteredContent=!0),s.trackAllContentsFiltered(void 0,this._typingInfo)):(this._report&&(isNaN(this._report.invalidStreamNb)&&(this._report.invalidStreamNb=0),this._report.invalidStreamNb++),s.trackInvalidStreamContent(void 0,this._typingInfo)),this.oldLoader&&this.oldLoader.setLoading(!1),t()}.bind(this))},onQueryStart:function(e,t){this._onQueryStart=t},onQueryProgress:function(e,t){this._onQueryProgress=t},onUnstreamStart:function(e,t){this._onUnstreamStart=t},onDicoThumbnailsReady:function(e,t){this._onDicoThumbnailsReady=t},onFileNotSupported:function(e,t){this._onFileNotSupported=t},onQueryError:function(e,t){this._onQueryError=t},onTimeOut:function(e,t){this._onTimeOut=t},onFileTreeRegenerationSuggested:function(e,t){this._onFileTreeRegenerationSuggested=t},load:function(e,t,i){this._spm=i,s.setTenant(e.tenant),this._spm.addAnalytics({providerType:e.provider,assetType:e.dtype||this._defaultAssetType,tenant:e.tenant,loadStart:Date.now()}),require([t],function(i){var o,a,d=function(){},l=this._onFileNotSupported?this._onFileNotSupported:d,u=this._onUnstreamStart?this._onUnstreamStart:d,c=this._onDicoThumbnailsReady?this._onDicoThumbnailsReady:d,h=this._onTimeOut?this._onTimeOut:d;this._dmFactory=new i;var m=this.getReport();if(m.streamNb=0,"FILE"===e.provider){var p=["3dsim","simxml","zip"].includes(e.format),f=e.format===e.mimetype&&e.format===e.type;if(0===(a=e.filename&&e.filename.length>0?e.filename:e.serverurl).indexOf("https",0)&&a.indexOf(e.format,0)<0&&f){p?(m.streamNb=1,o={persistentId:a,index:0,provider:"FILE",filename:a,filesize:e.filesizes?Number(e.filesizes):void 0,proxyurl:"none",withCredentials:!0},u(),this._loadSequence(o)):l()}else(async()=>{let i;this.oldLoader=r;let n=e.filename,s=new RegExp("[;]+","g");n.split(s).forEach((e=>{0===e.indexOf("blob",0)||e.indexOf("json",0)<0&&e.indexOf("zip",0)<0&&e.indexOf("simxml",0)<0&&e.indexOf("PNG",0)<0?l():e.indexOf("json",0)>0&&(i=e)})),i?await this._getThumbnailsForFile(i).then((()=>{c(),this.oldLoader.load(e,t,this._spm)})):this.oldLoader.load(e,t,this._spm),this._report=this.oldLoader.getReport()})()}else if("BLOB"===e.provider)e.blob instanceof Blob&&(m.streamNb=1,o={provider:"BLOB",blob:e.blob,index:0,analytics:{dataSize:e.blob.size,streamingTime:0}},u(),this._loadSequence(o));else if("EV6"===e.provider||"3DSPACE"===e.provider){this._onQueryStart&&this._onQueryStart();var _=this._onQueryProgress?this._onQueryProgress:d,S=this._onQueryError?this._onQueryError:d,y=n.createProbe("SPY.MSRLoader.LOADMODEL");y.begin(),this._loadModel(e,u,y,c,_,function(e,t){y.end(),m&&(isNaN(m.streamTimeOut)||h()),t&&this._spm.setTypingInfo(t);var i=this;if(Array.isArray(e))e&&e.length>0&&(u(),e.forEach((function(e){o={persistentId:e.persistentId,index:e.index,provider:"BUFFER",buffer:e.data?e.data:e,analytics:{dataSize:e.dataSize,streamingTime:e.streamingTime}},i._loadSequence(o)})));else{var n=e;if(this.oldLoader=r,n.length>0){u();for(var s=new RegExp("[;]+","g"),a=n.split(s),d=0;d<a.length;d++){if(0!==(n=a[d]).indexOf("blob",0)&&n.indexOf("simxml",0)<0)return void l();o={provider:"FILE",filename:n,serverurl:"",proxyurl:"none",requiredAuth:null},this._loadSequence(o)}}}}.bind(this),function(e){switch(y.end(),e){case"NOACCESS":s.trackNoAccess(void 0,this._typingInfo);break;case"NOSTREAM":s.trackNoSimulationEC(void 0,this._typingInfo)}S(e)}.bind(this),function(e){s.trackECLoadingTimeOut(void 0,this._typingInfo,e)}.bind(this))}}.bind(this))},isLoadingComplete:function(){return this.oldLoader?0===this._listObjToLoad.length&&!this.oldLoader.getLoading()&&!this._spm.loading:0===this._listObjToLoad.length&&!this._loading&&!this._spm.loading},continueLoading:function(){this.oldLoader?this.oldLoader.continueLoading():(this._loading=!1,this._loadSequence())},getReport:function(){return this._report},resetReport:function(){this._report={streamsInfo:[]}},getDMFactory:function(){return this._dmFactory},extensionLoad:function(e,t,i,n){let s=function(){i&&i()},r=function(){n&&n()},o=this.getDMFactory();if(o&&o.setExtendedMode&&this._spm&&this._streamsInfo){o.setExtendedMode(!0);let i=-1;e&&(i=this._spm.findSequenceByPersistentId(e)),i<0&&(i=this._spm.findSequenceByName(t));let n=this._streamsInfo[i];n?this._loadSequence({provider:"BUFFER",buffer:n.data,analytics:{dataSize:n.dataSize,streamingTime:n.streamingTime}},{onComplete:s,onError:r}):r()}else r()},extensionLoadAll:function(){let e=this.getDMFactory();if(e&&e.setExtendedMode&&this._spm&&this._streamsInfo){this.resetReport&&this.resetReport(),e.setExtendedMode(!0);for(const e in this._streamsInfo){let t=this._streamsInfo[e];t&&this._loadSequence({provider:"BUFFER",buffer:t.data,analytics:{dataSize:t.dataSize,streamingTime:t.streamingTime}})}}},_loadModel:function(e,t,i,n,s,r,o,l){e.contextid=e.contextid||e.contextId,this._typingInfo={assetType:e.dType||e.type,providerType:e.provider},this._streamsInfo=[];let u=Date.now();(async()=>{try{const a=await d.getSimulation(e.serverurl,e.physicalid),p=a.content.find((e=>"dsc_Result_Rep"===e.type))?.contentId,f=await d.getFileTree(e.serverurl,e.physicalid,p);var c=[];this.items=[];var h=new Map;let _=!0;var m=null;if(f.manifest&&Array.isArray(f.manifest)&&f.manifest.length>0){const e=f.manifest.filter((e=>e.isMetaData)),t=f.manifest.filter((e=>!e.isMetaData));c=e.filter((e=>e.path.startsWith("PrimaryDico"))).map((e=>e.key)).reverse();const i=t.filter((e=>e.path.includes("SimNavData.xml")));if(i.length>0){_=i.some((e=>Array.isArray(e.appData.zipDetails)&&e.appData.zipDetails.length>0)),this._spm.setIsProgressiveLoading(_);const e=i[0].path.match(/^(.*?)([\\/]+)(.*?)$/);m=e?e[2]:null,this.items=i.map((e=>{let t="";const i=e.path.indexOf("SimNavFile");i>0&&(t=e.path.substring(0,i));let n=e.path.replace("SimNavFile","").replace(`${m}SimNavData.xml`,"");return t&&(n=n.replace(t,""),this._spm.setPhysicalId(t)),{id:n,streamKey:e.key,size:e.appData.zipSize}})).reverse()}f.manifest.filter((e=>e.path.contains("Thumbnail"))).forEach((e=>h.set(e.path,e.key)))}if(!(this.items.length>0&&c.length>0&&h))throw new Error("No streams found in the file tree");{const a=this.items.map((e=>e.id));this._spm.setStreamIds(a);const d=this.items.filter((e=>void 0!==e.size)).map((e=>e.size));this._spm.setStreamSizes(d),this._spm.setSeparator(m);let f=function(e,t){var i=12e4;return e>75&&t>150&&(i*=(e/75+t/150)/2,i=Math.min(Math.round(i),24e4)),i}(Date.now()-u);this._retrieveAnalysisCases(e),this._retrieveRuns(e),this._onFinish=r,await this._loadPrimaryDicoAndThumbnails(e.serverurl,e.physicalid,p,c,h,o,l),n(),_?this._loadDataModel(e,t,i,p,this.items,f,s,o):this._loadStreamsWithFileTree(e,t,i,p,this.items,f,s,o,l)}}catch(t){this._retrieveAnalysisCases(e),this._retrieveRuns(e),this._onFinish=r,this._loadStreams(e,a.load,s,o,l)}})()},_loadDataModel:async function(e,t,i,n,s,r,o,a){var d=s.length;this._report.streamNb=d,this._report.suggestedTimeout=r,o(0,{streamsLoaded:0,streamsTotal:d});var u=s.map((e=>e.id));this._spm.initStreamLoadingProgress(u);var c=s.map(((e,t)=>({id:e.id,key:e.streamKey,order:t})));let h=-1;if(this._spm){let e=this._spm.getPreferredStreamId();h=e?c.findIndex((t=>t.id.contains(e))):this._spm.getPrimaryDico().getDefaultSequence()}h>0&&c.splice(0,0,c.splice(h,1)[0]),c.forEach(((s,r)=>{var h=Date.now(),m={url:e.serverurl,streamKey:s.key,simId:e.physicalid,resultRepId:n,contextid:e.contextid,onStreamLoaded:function(a){d--;var l=c.length-d;o(100*l/c.length,{streamsLoaded:l,streamsTotal:c.length});r>=0&&r<u.length&&this._spm.updateStreamProgess(u[r],66);var m={url:e.serverurl,persistentId:s.id,index:s.order,buffer:a,uncompressed:!0,simId:e.physicalid,resultRepId:n,contextid:e.contextid,key:s.key,analytics:{dataSize:a.byteLength,streamingTime:Date.now()-h}};this._streamsInfo.push(m),0===d&&(i.end(),this._reportreport&&(isNaN(this._reportreport.streamTimeOut)||timeOut()),this._typingInfo&&this._spm.setTypingInfo(this._typingInfo),Array.isArray(this._streamsInfo)&&this._streamsInfo.length>0&&(t(),this._streamsInfo.forEach((e=>{this._loadSequence(e)}))))}.bind(this),onError:e=>{d--,a("NOACCESS")}};l.loadDataModel(m)}))},_loadPrimaryDicoAndThumbnails:async function(e,t,i,n,s,r,o){try{const a={url:e,simId:t,resultRepId:i,keys:n,onError:r,streamType:"json",onTimeOut:o},d=new Promise((async(n,d)=>{a.onPrimaryDicoLoaded=async a=>{try{let d=this._spm.setPrimaryDicoAndGetThumabnails(a,this._dmFactory.filteringOptions);const u={url:e,simId:t,resultRepId:i,keys:s,thumbnails:d,onThumbnailLoaded:(e,t,i)=>{this._spm.addThumbnailBlob(e,t,i)},streamType:"arraybuffer",onError:r,onTimeOut:o};await l.loadThumbnails(u),n()}catch(e){d(e)}},await l.loadPrimaryDictionaries(a)}));await d}catch(e){r(e)}},_retrieveAnalysisCases:function(e){o.getAnalysisCases(e,(e=>{if(e)for(var t in e.analysisCases){var i=e.analysisCases[t];this._typingInfo[t]={name:i.name,origin:i.origin,sequenceType:i.type,sequenceSubTypes:i.subType,featureId:i.featureId};var n=i.appData_NativeApp||i.appData_SimMgr;n&&(this._typingInfo[t].internalId=n.internalId,this._typingInfo[t].internalName=n.internalName)}}),(e=>{this._typingInfo.error=e}),(()=>{this._typingInfo.timeout=!0}))},_retrieveRuns:function(e){o.getRuns(e,(e=>{if(e)for(var t in e.runs){var i=e.runs[t];if(i.analysisCaseId){var n=this._typingInfo[i.analysisCaseId];n&&(n.resultSequenceId=t)}}}),(()=>{}),(()=>{}))},_loadStreams:function(e,t,i,n,s){o.getLWstreamsIds(e,((r,a,d)=>{if(this._typingInfo.simulationOrigin=o.getLatestSimulationOrigin(),t&&Array.isArray(a)){var l=0,u=a.length;this._report.streamNb=u,this._report.suggestedTimeout=d,i(0,{streamsLoaded:0,streamsTotal:u});for(let e=0;e<a.length;e++)a[e]={id:a[e],order:e};if(this._spm){let e=this._spm.getPreferredStreamId();if(e){let t=a.findIndex((t=>t.id.contains(e)));t>0&&a.splice(0,0,a.splice(t,1)[0])}}a.forEach((o=>{var c=Date.now(),h={repId:r,sd:o.id,items:this.items,contentId:"226DB056BBEF18006710438B00000B85",serverUrl:e.serverurl,contextid:e.contextid,streamType:"arraybuffer",onStreamLoaded:function(e,t){u--;var n=a.length-u;i(100*n/a.length,{streamsLoaded:n,streamsTotal:a.length}),this._streamsInfo.push({persistentId:e,index:o.order,data:t,dataSize:t.byteLength,streamingTime:Date.now()-c}),0===u&&this._onFinish(this._streamsInfo,this._typingInfo)}.bind(this),timeout:d,onTimeOut:()=>{l++,u--,this._report.streamTimeOut=l;var e=a.length-u;i(100*e/a.length),s&&s(Date.now()-c),0===u&&this._onFinish(this._streamsInfo,this._typingInfo)},onError:e=>{u--,n("NOACCESS")}};t(h)}))}}),(e=>{this._typingInfo.simulationOrigin=o.getLatestSimulationOrigin(),e===o.errorCodes.ERR_GETLWSTREAMS_NOLW?n("NOSTREAM"):n("NOACCESS")}),(()=>{this._typingInfo.simulationOrigin=o.getLatestSimulationOrigin(),n("NOACCESS")}))},_loadStreamsWithFileTree:function(e,t,i,n,s,r,a,d,u){if(this._typingInfo.simulationOrigin=o.getLatestSimulationOrigin(),l&&Array.isArray(s)){var c=0,h=s.length;this._report.streamNb=h,this._report.suggestedTimeout=r;var m=this._onFileTreeRegenerationSuggested?this._onFileTreeRegenerationSuggested:doNothing;a(0,{streamsLoaded:0,streamsTotal:h});var p=s.map((e=>e.id));this._spm.initStreamLoadingProgress(p);var f=s.map(((e,t)=>({id:e.id,key:e.streamKey,order:t})));let o=-1;if(this._spm){let e=this._spm.getPreferredStreamId();o=e?f.findIndex((t=>t.id.contains(e))):this._spm.getPrimaryDico().getDefaultSequence()}o>0&&f.splice(0,0,f.splice(o,1)[0]),f.forEach(((o,_)=>{var S=Date.now(),y={url:e.serverurl,streamKey:o.key,simId:e.physicalid,resultRepId:n,streamType:"arraybuffer",onProgress:function(e){let t=e.lengthComputable?e.loaded/e.total*100:e.loaded/(s[_].size||1)*100;t=t<100?t:100,_>=0&&_<p.length&&this._spm.updateStreamProgess(p[_],66*t/100)}.bind(this),onStreamLoaded:function(e){h--;var n=f.length-h;a(100*n/f.length,{streamsLoaded:n,streamsTotal:f.length}),t();var s={persistentId:o.id,index:o.order,data:e,dataSize:e.byteLength,streamingTime:Date.now()-S},r={persistentId:s.persistentId,index:s.index,provider:"BUFFER",buffer:s.data?s.data:s,analytics:{dataSize:s.dataSize,streamingTime:s.streamingTime}};this._loadSequence(r),0===h&&(i.end(),this._typingInfo&&this._spm.setTypingInfo(this._typingInfo),m())}.bind(this),timeout:r,onTimeOut:()=>{c++,h--,this._report.streamTimeOut=c;var e=f.length-h;a(100*e/f.length),u&&u(Date.now()-S),0===h&&this._onFinish(this._streamsInfo,this._typingInfo)},onError:e=>{h--,d("NOACCESS")}};l.loadStream(y)}))}},loadOneStreamWithFileTree:function(e,t,i,n,s,r,o,a){if(Array.isArray(n)){let d=n.find((e=>e.id===i));const u=Date.now();let c={url:e.serverurl,streamKey:d.streamKey,simId:e.physicalid,resultRepId:t,streamType:"arraybuffer",onProgress:e=>{},onStreamLoaded:e=>{var t={persistentId:d.id,src:{provider:"BUFFER",buffer:e,index:0|d.order,uncompressed:!1}};r(t)},timeout:s,onTimeOut:()=>{a&&a(Date.now()-u)},onError:e=>{o("NOACCESS")}};l.loadStream(c)}},_getThumbnailsForFile:async function(e){var t,i=e.split("PrimaryDico.json");await fetch(e).then((e=>e.json())).then((e=>{let n=[];return t=this._spm.setPrimaryDicoAndGetThumabnails(e),Object.entries(t).forEach((([e,t])=>{t.forEach((t=>{n.push(new Promise(((n,s)=>{let r=i[0]+t;fetch(r).then((e=>e.blob())).then((i=>{this._spm.addThumbnailBlob(e,t,i),n()}))})))}))})),Promise.all(n)}))},declareToPAD:function(e,t,i){if(e&&e.loadJSON){var n=[{rootID:t,validForServerCall:!0,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":c,"ds6w:globaltype":"ds6w:Document","ds6w:label":i,boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":c,"ds6w:globaltype":"ds6w:Document",boundingbox:{max:[-1,-1,-1],min:[1,1,1]}}]},refreshDelegationCB:()=>new Promise((e=>{e()}))}];e.loadJSON({data:n})}},removeFromPAD:function(e,t){e&&t&&e.removeRoots({pids:[t]})}})}));