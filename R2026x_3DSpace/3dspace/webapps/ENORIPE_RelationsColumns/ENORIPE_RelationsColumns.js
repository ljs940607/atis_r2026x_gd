/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_RelationsColumns/utils/NavWSProxy",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/PADServices/utils/GlobalUtils","UWA/Promise","DS/ENOXWidgetPreferences/js/ENOXWidgetPreferences","DS/SNNavigationMap/utils/MapSecurityCtxConverter","DS/ENORIPE_Relations/RelationsTabSettings"],(function(e,t,n,i,o,s,r,a){var l=function(e,n,i){return new o((function(o,s){n.onComplete=function(e){var t=function(e){return"string"==typeof e?JSON.parse(e):e}(e),n=t;i&&(n=i(t)),o(n)},n.onFailure=function(e){s(e)},n.data&&(n.data=JSON.stringify(n.data)),function(e,n,i){t.authenticatedRequest(e,n)}(e,n)}))};return{getrelationprofiles:function(e,t){var i=n.get3DSpaceUrl(),o={};return i=i+"/resources/enorelnav/v2/navigate/getProfiles?tenant="+n.getPlatformId(),o.method="POST",o.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:this.getXPrefCredential()},o.data={widgetId:n.getWidgetId(),label:"DGV-RelationColumns-"+Date.now(),roles:e,lang:widget&&widget.lang?widget.lang:"en"},l(i,o,!1)},getRelationSettings:function(e,t){var i=n.get3DSpaceUrl(),o={label:"DGV-RelationColumns-"+Date.now()};return i=i+"/resources/enorelcc/cc_services/getrelsettings?tenant="+n.getPlatformId(),o.method="GET",o.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:this.getXPrefCredential()},l(i,o,!1)},getMergedProfiles:function(e,t,n){var i=this,s=!1;return new o((function(o,r){t.relation_sets&&t.relation_sets.length||o(e);e.profiles.map((function(e){return e.name}));for(var a=0;a<t.relation_sets.length;a++){for(var l=t.relation_sets[a].roles,d=t.relation_sets[a].userGroups,u=!1,c=0;c<l.length;c++)if(n.indexOf(l[c])>-1){u=!0;break}if(d.length>0&&!u){s=!0;break}}s?i._getGrantedUsrGrp().then((function(s){s=i._parseUserGroups(s),e=i._filterRelSets(e,t,s,n),o(e)})):(e=i._filterRelSets(e,t,[],n),o(e))}))},getAllProfilesAndSettings:function(e){var t=this,n=this.getrelationprofiles(e),i=this.getRelationSettings();return new o((function(s,r){o.all([n,i]).then((function(n){var i=n[0],o=n[1];t._parseSettings(o).then((function(n){t.getMergedProfiles(i,n,e).then((function(e){s([e,n])}))})).catch((()=>{s()}))})).catch((()=>{s()}))}))},getAppId:function(){return n.getAppId()},getUserID:function(){return n.getUserLogin()},addCredentialPreferenceToWidget:function(){var e=this,t="";return new o((function(n,i){e.isWebInWin()?e._getListOfSecurityContext().then((function(t){e.setXPrefCredential(t[0].value),n()})):(t=widget.getValue("xPref_CREDENTIAL"))&&""!==t?(e.setXPrefCredential(t),n()):s.addCredentialPreferenceToWidget({usePreferredCredentials:!0}).then((function(){(t=widget.getValue("xPref_CREDENTIAL"))||(t=widget.getPreference("xPref_CREDENTIAL").options[0].value,widget.setValue("xPref_CREDENTIAL",t)),e.setXPrefCredential(t),n()}))}))},_getListOfSecurityContext:function(){var e=this;return new o((function(t,n){e.getAllSecurityContexts().then((function(e){var i=[];if(e&&e.cspaces){var o=e.cspaces;if(Array.isArray(o))for(var s=0;s<o.length;s++)i[s]={label:o[s].label,value:o[s].value};JSON.stringify(i),t(i)}else n("collabspaces not found")}))}))},getAllSecurityContextsUrl:function(){return n.get3DSpaceUrl()+"/resources/modeler/pno/person?current=true&select=preferredcredentials&select=collabspaces&tenant="+n.getPlatformId()},getAllSecurityContexts:function(){var e=this;return new o((function(n,i){e.map_AllSecurityContexts&&""!=e.map_AllSecurityContexts?n(e.map_AllSecurityContexts):t.authenticatedRequest(e.getAllSecurityContextsUrl(),{headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",type:"json",proxy:"passport",onComplete:function(t){if(null!==t){var i=r.getSecurityContext(t);e.map_AllSecurityContexts=i,n(i)}},onFailure:function(e){i(e)}})}))},getXPrefCredential:function(){return this._xPrefCredential&&0!==this._xPrefCredential.indexOf("ctx::")&&(this._xPrefCredential="ctx::"+this._xPrefCredential),this._xPrefCredential},setXPrefCredential:function(e){this._xPrefCredential=e},isWebInWin:function(){return"undefined"!=typeof dscef||"undefined"!=typeof CATCefSendString},_parseSettings:function(e){var t=this;return new o((function(n,i){e.notexist||void 0===e.relation_apps?t._getResetRelApps().then((function(t){n(e=t)})):n(e)}))},_getResetRelApps:function(){var e=n.get3DSpaceUrl(),t={};return e=e+"/resources/enorelcc/cc_services/getrelappsinit?tenant="+n.getPlatformId(),t.method="GET",t.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:this.getXPrefCredential()},l(e,t,!1)},_getGrantedUsrGrp:function(){var e=n.get3DSearchUrl()+"/search",t={},i=n.getUserLogin()||"";return t.method="POST",t.headers={Accept:"application/json","Content-Type":"application/json"},t.data={label:"ENORIPE_"+i+"_"+Date.now(),select_predicate:["ds6w:label"],query:"[ds6w:type]:GROUP AND "+i,tenant:n.getPlatformId(),nresults:100,with_synthesis_attribute:!1,with_synthesis:!1},l(e,t,!1)},_parseUserGroups:function(e){var t=[];if(e&&e.results)for(var n=0;n<e.results.length;n++){var i=e.results[n];if(i.attributes){for(var o={},s=0;s<i.attributes.length;s++)"resourceid"===i.attributes[s].name&&(o.resourceid=i.attributes[s].value),"ds6w:label"===i.attributes[s].name&&(o.label=i.attributes[s].value);void 0!==o.resourceid&&t.push(o)}}return t},_filterRelSets:function(e,t,n,i){var o=e.profiles.map((function(e){return e.name})),s=(n=n.map((function(e){return e.resourceid})),this.getAppId()),r="In_App_Product_Relations";t&&t.relation_apps&&t.relation_apps[s]&&(r=t.relation_apps[s]);for(var a=0;a<t.relation_sets.length;a++){var l=t.relation_sets[a].roles,d=t.relation_sets[a].userGroups,u=t.relation_sets[a].name,c=!1;l&&l.length>0&&(l=l.map((function(e){return e.name}))),d&&d.length>0&&(d=d.map((function(e){return e.name})));for(var p=0;p<l.length;p++)if(i.indexOf(l[p])>-1){c=!0;break}if(!c)for(u===r&&console.debug(`"${u}" profile not authorized (roles check)`,{profileRoles:l,userRoles:i}),p=0;p<d.length;p++)if(n.indexOf(d[p])>-1){c=!0;break}var f=o.indexOf(u);c?-1===f?e.profiles.push(t.relation_sets[a]):e.profiles.splice(f,1,t.relation_sets[a]):(u===r&&console.debug(`"${u}" profile not authorized (userGroups check)`,{profileUsrGrps:d,userUsrGrps:n}),-1!==f&&e.profiles.splice(f,1))}return e}}})),define("DS/ENORIPE_RelationsColumns/WSRelations",["DS/WAFData/WAFData","DS/PADServices/utils/GlobalUtils","DS/PADServices/utils/PlatformURL","DS/PADServices/utils/PCSTracker","DS/ENORIPE_RelationsColumns/utils/NavWSProxy"],(function(e,t,n,i,o){"use strict";function s(){return"object"==typeof s.instance?s.instance:(s.instance=this,this)}return s.prototype.executeRequest=function(t,n,o,s){var r=i.networkprobe({url:t,request_options:n});return e.authenticatedRequest(t,r)},s.prototype.getCount=function(e){return n.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}),new Promise(function(i,s){var r=n.get3DSpaceURL(),a={onComplete:i,onFailure:s};r=r+"/resources/enorelnav/v2/navigate/getRelationCount?tenant="+n.getPlatformId(),a.method="POST",a.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:o.getXPrefCredential()},a.data=JSON.stringify({widgetId:"DGV-RelationColumns-"+t.getWidgetId()+"-"+Date.now(),label:"DGV-RelationColumns-"+Date.now(),ids:e.ids,relations:e.relations,computeWithInstances:!1}),this.executeRequest(r,a)}.bind(this))},s.prototype.getDetail=function(e){return new Promise(function(i,s){var r=n.get3DSpaceURL(),a={onComplete:i,onFailure:s};r=r+"/resources/enorelnav/v2/navigate/getEcosystem?tenant="+n.getPlatformId(),a.method="POST",a.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:o.getXPrefCredential()},a.data={widgetId:"DGV-RelationColumns-"+t.getWidgetId()+"-"+Date.now(),label:"DGV-RelationColumns-"+Date.now(),responseMode:"objectsByPatterns",computeWithInstances:!1},a.data=Object.assign(a.data,e),a.data=JSON.stringify(a.data),this.executeRequest(r,a)}.bind(this))},new s})),define("DS/ENORIPE_RelationsColumns/utils/RelationProfiles",["DS/ENORIPE_RelationsColumns/utils/NavWSProxy","DS/CoreEvents/ModelEvents","DS/PlatformAPI/PlatformAPI","i18n!DS/ENORIPE_Relations/assets/nls/Relations"],(function(e,t,n,o){return{fetchandStoreProfiles:function(t,n){var i=this;e.addCredentialPreferenceToWidget().then((function(){e.getAllProfilesAndSettings(t).then((function(e){if(Array.isArray(e)&&2===e.length){var o=e[0];i._settings=e[1];var s=i._getRelationsSet();if(s)for(var r=0;r<s.length;r++)o.profiles.splice(r+1,0,s[r]);o=i._filterRelSets(o,t),i.storeProfiles(o.profiles)}"function"==typeof n&&n()}))}))},_filterRelSets:function(t,n){for(var i=t.profiles.map((function(e){return e.name})),o=e.getAppId(),s=0;s<this._settings.relation_sets.length;s++){var r=this._settings.relation_sets[s].roles,a=this._settings.relation_sets[s].userGroups,l=this._settings.relation_sets[s].applications||[],d=!1;r&&r.length>0&&(r=r.map((function(e){return e.name}))),a&&a.length>0&&(a=a.map((function(e){return e.name})));for(var u=0;u<r.length;u++)if(n.indexOf(r[u])>-1){d=!0;break}var c=i.indexOf(this._settings.relation_sets[s].name);if(d){if(-1===c?t.profiles.push(this._settings.relation_sets[s]):t.profiles.splice(c,1,this._settings.relation_sets[s]),l.length>0&&(l=l.map((function(e){return e.name}))).indexOf(o)<0){c=i.indexOf(this._settings.relation_sets[s].name);t.profiles.splice(c,1),i.splice(c,1)}}else-1!==c&&(t.profiles.splice(c,1),i.splice(c,1))}return t},storeProfiles:function(t){var n="In_App_Product_Relations",o={name:"AutoModeProfile"},s=e.getAppId();if(o.relations=[],t.unshift(o),this._settings&&this._settings.relation_apps&&this._settings.relation_apps[s]&&(n=this._settings.relation_apps[s]),this._profiles=t,this._profileNames=this._profiles.map((function(e){return e.name})),this._profileNames.length>0){var r=!1;for(i=0;i<this._profileNames.length;i++)if(this._profileNames[i]===n){this.setCurrentProfile(this._profileNames[i]),r=!0;break}!1===r&&this.setCurrentProfile(this._profileNames[0])}},getProfileNames:function(){return this._profileNames},getNlsForProfileNames:function(e){for(var t=[],n=0;this._profileNames&&n<this._profileNames.length;n++){var i=this._profileNames[n],s=o[i]||i;t.push({name:i,nls:s})}return t},getNlsForMenu:function(){return o["Manage-Relations"]},setCurrentProfile:function(e){this._currentProfile===e&&void 0!==this._currentProfile||(this._currentProfile=e,this.publish("CurrentProfileChanged"))},getCurrentProfile:function(){return this._currentProfile},getCurrentProfileNls:function(){return o[this._currentProfile]||this._currentProfile},getCurrentProfileRelations:function(){relations=[];for(var e=this._getCurrentProfileData(),t=0;e&&t<e.relations.length;t++){var n=e.relations[t];relations.push(n.name)}return relations},getRelationsInSettings:function(e){var t=[];if(this._settings&&this._settings.relation_apps[e])for(var n=0;this._profiles&&n<this._profiles.length;n++){let s=this._profiles[n];if(s.name===this._settings.relation_apps[e])for(var i=0;s&&i<s.relations.length;i++){var o=s.relations[i];t.push(o.name)}}return t},publish:function(e){this._ensureModelEvents(),this._modelEvents.publish({event:e})},subscribe:function(e,t){return this._ensureModelEvents(),this._modelEvents.subscribe({event:e},t)},_getCurrentProfileData:function(){for(var e=0;this._profiles&&e<this._profiles.length;e++){var t=this._profiles[e];if(t.name===this._currentProfile)return t}return null},_ensureModelEvents:function(){this._modelEvents||(this._modelEvents=new t)},_getRelationsSet:function(){var e=localStorage.getItem(this.getUserID()+"_ENORIPE_CustomRelationsSet");if(e)return JSON.parse(e)},getUserID:function(){return e.getUserID()||""},_fetchLastStoredProfile:function(){var t,n="LastUsedProfile-"+e.getAppId();return"undefined"!=typeof widget&&null!==widget&&(t=widget.getValue(n)),t||(t=localStorage.getItem(n)),t}}})),define("DS/ENORIPE_RelationsColumns/RelationsColumns",["UWA/Core","text!DS/ENORIPE_RelationsColumns/assets/ColumnsDefinition.json","i18n!DS/ENORIPE_RelationsColumns/assets/nls/ENORIPE_Columns","DS/SNNavigationMap/utils/NlsManager","DS/SNNavigationMap/utils/ProbesUtils","DS/ENORIPE_RelationsColumns/WSRelations","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices","DS/ENORIPE_RelationsColumns/utils/RelationProfiles","DS/ENORIPE_Relations/RelationsTabSettings","DS/PADServices/utils/AttributesMgtV2","DS/PADServices/utils/DictionaryAccess","DS/CoreEvents/ModelEvents","DS/PADServices/utils/GlobalUtils"],(function(e,t,n,i,o,s,r,a,l,d,u,c,p,f){"use strict";var g=new p;function h(){if("object"==typeof h.instance)return h.instance;h.instance=this,this.relationColumnsDef=JSON.parse(t),this.alwaysUpdate=!1,this.dataIndexes=[],this._afterRefresh=!1,e.merge(n,i.getNls()),g.subscribe({event:"ENXRelationsCol/AddGroupingNodes"},this._addGroupingNodes.bind(this)),g.subscribe({event:"ENXRelationsCol/ShowGroupingNodes"},this._showGroupingNodes.bind(this)),g.subscribe({event:"ENXRelationsCol/HideGroupingNodes"},this._hideGroupingNodes.bind(this)),l.subscribe("CurrentProfileChanged",(function(e){}))}function m(e,t,n,i,o){var s=new e.options.nodeModelClass(n);s.isRelationsObjectNode=!0;var r=t.getRoot().getID(),a=t.getState(),l=t.getChildren(),d=void 0;return l&&l.length?(d=function(e,t){let n;for(let t=0;t<e.length;t++)if(!0===e[t].isRelationsObjectGroupingNode){n=e[t];break}return n}(l),void 0!==d?function(e,t){let n=!1;for(let i=0;i<e.length;i++){let o=e[i].getChildren();if(null!=o)for(let e=0;e<o.length;e++)if(o[e]._options.resourceid===t._options.resourceid){n=!0;break}}return n}(l,s)||d.addChild(s):((d=v({treeDoc:e,parentId:t.getID()})).addChild(s),t.insertBefore(d,l[0]))):((d=v({treeDoc:e,parentId:t.getID()})).addChild(s),t.addChild(d)),!0===h.groupingNodeHidden&&d.hide(),g.publish({event:"ENXRelationsCol/AddGroupingNodes",data:{groupingNode:d,rootId:r}}),!0===i&&d.setState({state:"expanded"}),"noChildren"===a&&void 0!==o&&!1===o?t.setState({state:"collapsed"}):"noChildren"===a&&void 0===o||"collapsed"===a&&t.childComputed&&t.getReferenceValue("ds6w:kind")&&-1!==t.getReferenceValue("ds6w:kind").indexOf("3DPart")||"collapsed"===a&&!1===t.childComputed?t.setState({state:"expanded"}):t.setState({state:a}),s}function v(e){var t={resourceid:"fakeNode-"+e.parentId,label:n.fakeGroupingNode.label,childComputed:!0,icons:[{iconName:"object-related",fontIconFamily:1}],thumbnail:{iconName:"object-related",fontIconFamily:1},grid:{},children:[]},i=new e.treeDoc.options.nodeModelClass(t);return i.isRelationsObjectNode=!0,i.isRelationsObjectGroupingNode=!0,i.childComputed=!0,i}return h.prototype.setupCallback=function(e){e.treeDocModelEvents&&e.treeDocModelEvents.subscribe({event:"preRemoveChild"},this._cleanupGroupingNodes.bind(this)),e.globalModelEvents&&e.globalModelEvents.subscribe({event:"ENXModel/UpdateAdditionalColumns"},this._forceUpdateAttributes.bind(this))},h.prototype.isAdditionalColumnsAvailable=function(e){if("function"!=typeof e)throw new Error("A callback function should be defined");var t={getPlatformID:function(){return a.getPlatformId()},getServiceID:function(){return"3DSpace"}};d.isAvailable(t,{isDraggable:!0}).then((function(t){"object"==typeof t?a.app_initialization((function(){l.fetchandStoreProfiles(t.roles,(function(){e(!0)}))})):e(!1)}),(function(){e(!1)}))},h.prototype.getName=function(){return"RelationsColumns"},h.prototype.getManagedColumnNames=function(){return this.dataIndexes=this.columnsPreference.availableDataIndexes,this.dataIndexes},h.prototype.setPreferenceProxy=function(){e.merge(n,i.getNls());var t=l.getRelationsInSettings(f.getAppId());t&&t.length>this.relationColumnsDef.patternsLimit&&(t=t.slice(0,this.relationColumnsDef.patternsLimit)),this.alwaysUpdate=!h.groupingNodeHidden,h.prototype.relationsColumnsList=t,this._buildDefaultConfiguration(this.relationsColumnsList)},h.prototype.relationNodesExpanded=function(e){this.__nodeExpandedByDefault=e},h.prototype.getNbPatternsSelected=async function(){return l.getRelationsInSettings(f.getAppId()).length},h.prototype.getRelationNodeAvailability=function(){return h.groupingNodeHidden},h.prototype.setupDGVManipulation=function(e){h.prototype.addColumns=e.onAddColumn,h.prototype.removeColumns=e.onRemoveColumn},h.prototype.toBeUpdated=function(e,t){if("SyncModelRefresh"===t&&(this._afterRefresh=!0),"SyncModelRefresh"===t||"SyncModelNodes"===t||"OnSyncModel"===t||"OnScrollEnd"===t)return!0;for(var n=!1,i=Object.keys(e),o=0;o<i.length&&!1===n;o++)""!==e[i[o]]&&void 0!==e[i[o]]||(n=!0);return n},h.prototype.getNodesByIds=function(e,t){let n=t.getAllDescendants(),i={};for(var o=0;o<e.length;o++)i[e[o]]=[];for(o=0;o<n.length;o++)if("function"==typeof n[o].getID){let t=n[o].getID();-1!==e.indexOf(t)&&i[t].push(n[o])}return i},h.prototype.updateAttributes=function(e,t,n){var i={pids:{},relids:{}},o=this,r=[];let a=this.getNodesByIds(e.pids,n);e.pids.forEach((function(e){a[e].forEach((function(t){if(o._afterRefresh&&(t.alreadyGetCount=!1,t.alreadyGetFakeNode=!1),!t.alreadyGetCount&&(t.alreadyGetCount=!0,r.indexOf(e)<0)){r.push(e),i.pids[e]||(i.pids[e]={});for(var n=0;n<o.dataIndexes.length;n++)i.pids[e][o.dataIndexes[n]]=void 0}}))})),o._afterRefresh=!1;var l=[];if(r.length>0){var d=new Promise((function(e){s.getCount({ids:r,relations:o.dataIndexes}).then((function(e){r.forEach((function(e){for(var t=0;t<o.dataIndexes.length;t++)i.pids[e][o.dataIndexes[t]]=0}));for(var t=(e="string"==typeof e?JSON.parse(e):e).counts,n=0;n<t.length;n++)i.pids[t[n].source][t[n].name]=parseInt(t[n].count)})).finally(e)}));l.push(d)}let u=null!==e.noIconUpdate&&void 0!==e.noIconUpdate&&!0===e.noIconUpdate;l.push(new Promise((function(t){d?d.then((function(){o._autoAddInView({expandRelNodes:e.expandRelNodes,noIconUpdate:u,pids:e.pids,updatedAttributes:i,treedocument:n}).then(t)})):o._autoAddInView({expandRelNodes:e.expandRelNodes,noIconUpdate:u,pids:e.pids,updatedAttributes:i,treedocument:n}).then(t)}))),Promise.all(l).then((function(){"function"==typeof t&&t(i)}))},h.prototype.getAdditionalColumnsUXDGV=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].dataIndex);0===this.dataIndexes.length&&this.getManagedColumnNames();for(var s=0;s<this.dataIndexes.length;s++){var r=this.dataIndexes[s],a=this._buildDGVColumn(this.dataIndexes[s]),l=t.indexOf(r);-1===l?(a.text=n.get(this.dataIndexes[s]),e.push(a),l=e.length-1):(e[l]=UWA.extend(e[l],a,!0),e[l].text=n.get(this.dataIndexes[s])),e[l].visibleFlag&&o.trackMultiUsage("RColumns","initColumns",[e[l].dataIndex,f.getAppId()])}},h.prototype.provideDisplayTooltip=function(e){var t=null;return e.nodeModel&&-1!==this.dataIndexes.indexOf(e.dataIndex)&&(t=e.nodeModel.options.grid[e.dataIndex]),t},h.prototype.getTypeRepresentations=function(){return{relColNone:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"",fontIconFamily:WUXManagedFontIcons.Font3DS}}},relColLoading:{stdTemplate:"functionIcon",semantics:{className:"relationRefresh",icon:{iconName:"reload wux-ui-3ds-spin",fontIconFamily:WUXManagedFontIcons.Font3DS}}},relCheck:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"check",fontIconFamily:WUXManagedFontIcons.Font3DS}}}}},h.prototype.getOnCellClickCB=function(e){if(-1!==this.dataIndexes.indexOf(e))return function(t){t.nodeModel&&(t.nodeModel.options.grid[e]>0&&require(["DS/ApplicationFrame/CommandsManager"],(function(t){var i=t.getCommandCheckHeader("RightSidePanel");i&&(!1===i.getState()&&i.setState(!0,!1),i._propertiesWdg.selectFacet("relations"),d.expandRelations([n.get(e)]))})))}},h.prototype.getAdditionalCtxMenu=function(e){var t,i=!1;"datagridview"===e.view&&(i=-1===e.ctxParams.cellInfos.rowID,t=e.ctxParams.collectionView.getColumnOrGroup(e.ctxParams.cellInfos.columnID).dataIndex);var s=[];"tree"===t&&!0===i?(h.groupingNodeHidden?s.push({type:"PushItem",fonticon:{family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-eye"},title:n.ctxCommands.showRelated,action:{callback:function(){g.publish({event:"ENXRelationsCol/ShowGroupingNodes",data:{treeDoc:e.treeDocument}}),o.trackMultiUsage("RColumns","showRelations",[f.getAppId()]),h.groupingNodeHidden=!1,e.ctxParams.collectionView.requestDelayedModelData("OnSyncModel"),localStorage.setItem("enx-relation-groupingNode-hide_"+f.getAppId(),"false")}}}):s.push({type:"PushItem",fonticon:{family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-eye-off"},title:n.ctxCommands.hideRelated,action:{callback:function(t){g.publish({event:"ENXRelationsCol/HideGroupingNodes",data:{treeDoc:e.treeDocument}}),h.groupingNodeHidden=!0,localStorage.setItem("enx-relation-groupingNode-hide_"+f.getAppId(),"true")}}}),e.callback(this.getName(),s)):e.callback(null)},h.prototype._forceUpdateAttributes=function(e){this.updateAttributes(e.nodesToUpdate,e.callback,e.treedocument)},h.prototype._buildDGVColumn=function(e){var t={dataIndex:e,alignment:"center",editableFlag:!1,sortableFlag:!1,width:50,minWidth:50,visibleFlag:!1,isAdditionalColumn:!0,getCellTypeRepresentation:function(t){if(t.nodeModel){var n=t.nodeModel.options.grid[e];return!0===t.nodeModel.isRelationsObjectNode?"relColNone":void 0!==n&&""!==n?n>0?"relCheck":"relColNone":"relColLoading"}},getCellSemantics:function(t){if(t.nodeModel){var n=t.nodeModel.options.grid[e];if(void 0===n||""===n||0===n)return{disabled:!0}}},customisation:{dataIndex:e,exportable:{lock:!1,value:!1},layout:{removable:!1}}};return t=UWA.extend(t,{}),UWA.clone(t)},h.prototype._autoAddInView=function(e){var t=this;return new Promise((function(n){if(h.groupingNodeHidden)n();else{var i,o=[],r=[],a=t.columnsPreference.availableDataIndexes,l=e.treedocument,d=u.createOutputsRequest("fetch"),p=t.getNodesByIds(e.pids,l);for(i=0;i<e.pids.length;i++){p[e.pids[i]].forEach((function(t){if(!0!==t.isRelationsObjectNode&&!t.alreadyGetFakeNode){if(!0!==e.noIconUpdate){var n=t.options.icons;n[0].badges||(n[0].badges={}),n[0].badges.topRight={iconName:"reload wux-ui-3ds-spin",fontIconSize:"1x",className:"dgv-badge-top"},t.updateOptions({icons:n})}t.alreadyGetFakeNode=!0,o.push(e.pids[i])}}))}o.length>0?s.getDetail({ids:o,relations:a,attributesForView:d.select_predicate?d.select_predicate:d.select_object}).then((function(s){s="string"==typeof s?JSON.parse(s):s,l.withTransactionUpdate((function(){for(i=0;i<a.length;i++){var d=a[i],u=s.objectsByPatterns[d];if(u)for(var f=0;f<u.length;f++)for(var g=u[f],h=0;h<g.relations.length;h++){var v=g.relations[h].source;if(-1===r.indexOf(v)&&r.push(v),P=p[v])for(var _=0;_<P.length;_++){var C=P[_];if(!0!==C.isRelationsObjectNode){var N=t._buildNode(g),b=m(l,C,N,t.__nodeExpandedByDefault||e.expandRelNodes,t.__nodeExpandedByDefault);if(c.updateNLS(b),!0!==e.noIconUpdate){var I=UWA.clone(C.options.icons);I[0].badges&&(I[0].badges.topRight=null),C.updateOptions({icons:I})}}}}}if(!0!==e.noIconUpdate)for(i=0;i<o.length;i++){var P;if(-1===r.indexOf(o[i]))(P=p[o[i]]).forEach((function(e){var t=UWA.clone(e.options.icons);t[0].badges&&(t[0].badges.topRight=null),e.updateOptions({icons:t})}))}n()}))})).catch((function(e){console.warn("Retrieve the pattern fails:"+JSON.stringify(e)),n()})):n()}}))},h.prototype._buildDefaultConfiguration=function(e){this.columnsPreference={},this.columnsPreference.availableDataIndexes=e,this.dataIndexes=[]},h.prototype._buildNode=function(e){for(var t=u.createOutputsRequest("fetch"),n={resourceid:e.id,relationid:e.relation,label:e["ds6w:label"],icons:[{iconPath:"url("+e.type_icon_url+")",className:"dgv-icons"}],type:e["ds6w:type"],thumbnail:e.thumbnail,relationOrder:-2,grid:{thumbnail:e.thumbnail},children:null},i=t.select_predicate?t.select_predicate:t.select_object,o=0;o<i.length;o++)"ds6w:label"!==i[o]&&(n.grid[i[o]]=e[i[o]]);return n},h.prototype.hasHiddenGroupingNodes=function(){return this._hiddenGroupingNodes&&this._hiddenGroupingNodes.length},h.groupingNodeHidden=!localStorage.getItem("enx-relation-groupingNode-hide_"+f.getAppId())||"true"===localStorage.getItem("enx-relation-groupingNode-hide_"+f.getAppId()),h.prototype._addGroupingNodes=function(e){var t=e.groupingNode,n=e.rootId;t&&n&&(this._groupingNodes||(this._groupingNodes={}),this._groupingNodes[n]||(this._groupingNodes[n]=[]),this._groupingNodes[n].push(t))},h.prototype._showGroupingNodes=function(e){if(this._groupingNodes){var t=this;e.treeDoc.withTransactionUpdate((function(){for(var e=Object.keys(t._groupingNodes),n=0;n<e.length;n++)for(var i=t._groupingNodes[e[n]],o=0;o<i.length;o++){i[o].show();i[o]._parentNode}}))}h.groupingNodeHidden=!1,this.alwaysUpdate=!0},h.prototype._hideGroupingNodes=function(e){if(this._groupingNodes){var t=this;e.treeDoc.withTransactionUpdate((function(){for(var e=Object.keys(t._groupingNodes),n=0;n<e.length;n++)for(var i=t._groupingNodes[e[n]],o=0;o<i.length;o++){i[o].hide();var s=i[o]._parentNode;s&&s.getChildren()&&1===s.getChildren().length&&s.setState({state:"collapsed"})}}))}h.groupingNodeHidden=!0,this.alwaysUpdate=!1},h.prototype._cleanupGroupingNodes=function(e){if(this._groupingNodes){var t=null,n=e.data.nodeModel;n&&n.isRoot()?(t=n,this._groupingNodes[n.getID()]&&delete this._groupingNodes[n.getID()]):(t=n.getRoot())&&this._groupingNodes[t.getID()]&&(this._groupingNodes[t.getID()]=this._groupingNodes[t.getID()].filter((function(e){return-1!==e.getOccurencePath().indexOf(t.getID())}))),this._afterRefresh=!0}},new h})),define("DS/ENORIPE_RelationsColumns/RelationsColumnsCmd",["DS/ENORIPE_RelationsColumns/RelationsColumns","DS/ApplicationFrame/Command","css!DS/ENORIPE_RelationsColumns/ENORIPE_Columns","i18n!DS/ENORIPE_RelationsColumns/assets/nls/ENORIPE_Columns","DS/Controls/Button","DS/Controls/Accordeon","DS/Controls/Toggle","DS/PADUtils/PADContext"],(function(e,t,n,i,o,s,r,a){"use strict";return t.extend({init:function(e){this._parent(e)},execute:function(){},_buildContent:function(){return new Promise(function(t){this.elements.container=document.createElement("div"),this.elements.container.classList.add("enx-relmgt-container");var n=e.relationColumnsDef;this.columnsPreference.addAutoPatterns||(this.columnsPreference.addAutoPatterns=[]);var o=e.relationsColumnsList,a=this,l=function(t){var n=document.createElement("div");n.classList.add("enx-relmgt-expander"),n.classList.add(t);var o=-1!==e.dataIndexes.indexOf(t),s=new r({type:"switch",label:i.relationsColumnsMgt.columnAvailable,value:t,checkFlag:o,touchMode:!0});n.appendChild(s.getContent()),s.addEventListener("change",a._colAvailablityMgt.bind(a));var l=-1!==a.columnsPreference.addAutoPatterns.indexOf(t),d=new r({type:"switch",label:i.relationsColumnsMgt.autoAdd,value:t,checkFlag:l,touchMode:!0});n.appendChild(d.getContent());var u=document.createElement("div");return u.classList.add("enx-relmgt-autoAddInfo"),u.classList.add(t),u.innerText=i.relationsColumnsMgt.autoAddInfo,!0===l?u.removeAttribute("hidden"):u.setAttribute("hidden",""),n.appendChild(u),d.addEventListener("change",a._autoAddMgt.bind(a)),n};if(1===o.length){this.elements.container.classList.add("enx-relmgt-single-pattern");var d=n.patterns[o[0]],u=require(d.nlsPatternAMD),c=document.createElement("div");c.classList.add("enx-relmgt-title-pattern"),c.innerText=u[o[0]],this.elements.container.appendChild(c);var p=l(o[0]);this.elements.container.appendChild(p)}else if(o.length>1){var f=this.elements.accordion=new s({style:"filled-separate",exclusive:!1});this.elements.container.appendChild(f.getContent());for(var g=0;g<o.length;g++){p=l(o[g]),d=n.patterns[o[g]],u=require(d.nlsPatternAMD);f.addItem({header:u[o[g]],body:p,expandedFlag:!0})}}t()}.bind(this))},_buildFooter:function(){var t=this,n=UWA.createElement("div",{class:"footerModal"}),s=new o({label:i.relationsColumnsMgt.save,emphasize:"primary",touchMode:!0});s.addEventListener("click",(function(){e.updateConfiguration(t.changes),t.elements.floatingpanel.destroy()})),s.inject(n);var r=new o({label:i.relationsColumnsMgt.reset,emphasize:"secondary",touchMode:!0});r.addEventListener("click",(function(){e.resetConfiguration(),t.elements.floatingpanel.destroy()})),r.inject(n);var a=new o({label:i.relationsColumnsMgt.cancel,emphasize:"secondary",touchMode:!0});return a.addEventListener("click",(function(){t.elements.floatingpanel.destroy()})),a.inject(n),n},_colAvailablityMgt:function(e){this.changes[e.dsModel.value]||(this.changes[e.dsModel.value]={}),this.changes[e.dsModel.value].dgvColumnAvailable=e.dsModel.checkFlag},_autoAddMgt:function(e){this.changes[e.dsModel.value]||(this.changes[e.dsModel.value]={}),this.changes[e.dsModel.value].autoAdd=e.dsModel.checkFlag;var t=this.elements.container.getElementsByClassName("enx-relmgt-autoAddInfo "+e.dsModel.value);1===t.length&&(!0===e.dsModel.checkFlag?(this.elements.container.classList.add("withAutoAddInfo"),t[0].removeAttribute("hidden")):(this.elements.container.classList.remove("withAutoAddInfo"),t[0].setAttribute("hidden","")),this.elements.floatingpanel.onResize())},_checkIfTreeview:function(){if("datagridview"===a.get().getCurrentView())this.enable();else this.disable()}})}));