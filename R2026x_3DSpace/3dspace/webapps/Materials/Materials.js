define("DS/Materials/ShaderDynamicPrefixBuilder",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";var t=function(t){const s=e.MaterialToUse;switch(t){case s.originalMaterial:case s._fakeOriginalMaterial:return"ORIGINAL_MATERIAL";case s.normalMaterial:return"NORMAL_MATERIAL";case s.depthMaterial:return"DEPTH_MATERIAL";case s.normalDepthIoRRoughnessMaterial:return"NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL";case s.shadowMapDepthMaterial:return"SHADOWMAP_MATERIAL";case s.highlightMaterial:return"HIGHLIGHT_MATERIAL";case s.pickingMaterial:return"PICKING_MATERIAL";case s.pickingMaterialInstancing:return"PICKING_INSTANCING_MATERIAL";case s.oitAccumMaterial:return"OIT_ACCUM_MATERIAL";case s.oitRevealMaterial:return"OIT_REVEAL_MATERIAL";case s.oitLinkedListMaterial:return"OIT_LINKED_LIST_MATERIAL";case s.depthRGBAMaterial:return"DEPTH_RGBA_MATERIAL";case s.decalNormalStencilDepthMaterial:return"DECAL_NORMAL_STENCIL_DEPTH_MATERIAL";case s.normalDepthMaterial:return"NORMAL_DEPTH_MATERIAL";case s.transparentShadowMaterial:return"TRANSPARENT_SHADOWMAP_MATERIAL";case s.texCoordMaterial:return"TEXTURE_COORDINATES_MATERIAL";case s.gpuPositionMaterial:return"GPU_POSITION_MATERIAL";default:throw"Invalid Material to use "+t}};function s(e){return["#define "+t(e.materialToUse),e.antialias?"#define GPU_AA":"",e.selectionMaterial?"#define SELECTION_MATERIAL":"",e.mobile?"#define MOBILE_MODE":"",e.mobileDevice?"#define MOBILE_DEVICE_MODE":"",e.vrDevice?"#define VR_DEVICE_MODE":"",e.appleDevice?"#define APPLE_DEVICE_MODE":"",e.noCompositing?"#define NO_COMPOSITING":"",e.mobileHL?"#define MOBILE_HIGHLIGHT_MODE":"",e.primitiveHighlight?"#define PRIMITIVE_HIGHLIGHT":"",e.deferrable?"#define DEFERRABLE_MATERIAL":"",e.politeHighlight?"#define HIGHLIGHT_POLITE 1":"#define HIGHLIGHT_POLITE 0",e.useDepthForPoliteHighlight?"#define HIGHLIGHT_WITH_DEPTH":"",e.noZObject?"#define NOZ_OBJECT":"",e.largeScale?"#define MODELVIEW_GPU":"#define MODELVIEW_CPU",e.planeViewModeColor?"#define PLANE_VIEW_MODE_COLOR":"",e.useNormalMatrix?"#define USE_NORMAL_MATRIX":"",e.depthDebugMaterial?"#define DEBUG_DEPTH":"",e.normalDebugMaterial?"#define DEBUG_NORMAL":"",e.shadowMapDebugMaterial?"#define DEBUG_SHADOW":"",e.geomUVDebug?"#define DEBUG_GEOM_UVS":"",e.mappingUVDebug?"#define DEBUG_MAPPING_UVS":"",e.geomUV2Debug?"#define DEBUG_GEOM_UV2S":"",e.mappingUV2Debug?"#define DEBUG_MAPPING_UV2S":"",e.geomUV3Debug?"#define DEBUG_GEOM_UV3S":"",e.mappingUV3Debug?"#define DEBUG_MAPPING_UV3S":"",e.colorDebugMaterial?"#define DEBUG_COLOR":"",e.aoDebugMaterial?"#define DEBUG_AO":"",e.float16DepthDebugMaterial?"#define DEBUG_FLOAT16_DEPTH":"",e.oct22NormalDebugMaterial?"#define DEBUG_OCT22_NORMAL":"",e.useLighting?"#define USE_LIGHTING":"",e.skipTranspar?"#define SKIP_TRANSPARENT":"",e.highFrequencyColors?"#define HIGH_FREQUENCY_COLORS":"",e.mappingFromMatApp?"#define MAPPING_FROM_MATAPP":"",e.extFragDepth?"#define FRAG_DEPTH_EXT":"",e.gammaInput?"#define GAMMA_INPUT":"",e.gammaOutput?"#define GAMMA_OUTPUT":"",e.simpleGamma?"#define SIMPLE_GAMMA":"",e.usePhongInfos?"#define PHONG_LIGHTING_INFOS":"","#define MAX_DIR_LIGHTS "+e.maxDirLights,"#define MAX_DIR_IBL_LIGHTS "+e.maxDirIBLLights,"#define MAX_DIR_PHONG_LIGHTS "+e.maxDirPhongLights,"#define MAX_POINT_LIGHTS "+e.maxPointLights,"#define MAX_SPOT_LIGHTS "+e.maxSpotLights,"#define MAX_SPHERE_LIGHTS "+e.maxSphereLights,"#define MAX_TUBE_LIGHTS "+e.maxTubeLights,"#define MAX_DISK_LIGHTS "+e.maxDiskLights,"#define MAX_RECTANGLE_LIGHTS "+e.maxRectangleLights,"#define MAX_IES_LIGHTS "+e.maxIESLights,e.lightMap?"#define USE_LIGHTMAP":"","#define MAX_SHADOWS "+e.maxShadows,"#define MAX_SHADOWS_DIR "+e.maxDirShadows,"#define MAX_SHADOWS_DIR_IBL "+e.maxDirIBLShadows,"#define MAX_SHADOWS_SPOT "+e.maxSpotShadows,"#define MAX_SHADOWS_CUBE "+e.maxShadowsCube,e.shadowMapEnabled?"#define USE_SHADOWMAP":"","#define "+e.shadowMapTypeDefine,e.shadowMapType>-1?"#define SHADOW_MAP_TYPE "+e.shadowMapType:"","#define "+e.shadowMapQualityDefine,e.shadowMapQuality>-1?"#define SHADOW_MAP_QUALITY"+e.shadowMapQuality:"",e.shadowMapCubeEnabled?"#define USE_SHADOWMAP_CUBE":"",e.transparentShadowEnabled?"#define USE_TRANSPARENTSHADOWMAP":"",e.transparentShadowDeclarationEnabled?"#define DECLARE_TRANSPARENTSHADOWMAP":"",e.uintESM?"#define USE_UINT_ESM":"",e.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",e.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",e.useUV?"#define NEEDS_UVTOUSE":"",0==e.mappingUseFragment?"#define USE_MAPPING_OPERATOR_VERTEX":"",1==e.mappingUseFragment?"#define USE_MAPPING_OPERATOR_FRAGMENT":"",e.mappingType>-1?"#define MAPPING_OPERATOR":"",e.needTangentBinormal?"#define USE_TANGENT_BINORMAL":"",e.clipPlanesEnabled?"#define USE_CLIPPINGPLANES":"",e.useClippingCylinder?"#define USE_CLIPPINGCYLINDER":"","#define MAX_POLYGON_SIZE "+e.maxPolygonSize,e.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",e.maxPolyLineSize>0?"#define NB_CLIPPINGPOLYGON "+e.maxNbPolyLine:"",e.maxScissorSize>0?"#define USE_SCISSORPOLYGON":"",e.maxScissorSize>0?"#define NB_SCISSOR "+e.maxNbScissor:"",e.fogViewMode?"#define USE_BACKGROUNDVIEWMODE_FOG":"",e.lowlightViewMode?"#define USE_BACKGROUNDVIEWMODE_LOWLIGHT":"",e.wrapAround?"#define WRAP_AROUND":"",(e.doubleSided,"#define DOUBLE_SIDED"),e.flipSided?"#define FLIP_SIDED":"",e.vertexColors||e.objectVertexColors?"#define USE_COLOR":"",e.objectVertexColors?"#define USE_OBJECT_COLOR":"",e.gpuTangentBinormal?"#define GPU_TANGENT_BINORMAL":"",e.specgloss?"#define SPECGLOSS":"",e.specglossNRE?"#define SPECGLOSS_NRE":"",e.dspbr?"#define DSPBR":"",e.dspbr19x?"#define DSPBR19x":"",e.dspbr21x?"#define DSPBR21x":"",e.dspbr22x?"#define DSPBR22x":"",e.dspbr25x?"#define DSPBR25x":"",e.fromGLTF?"#define PBR_FROM_GLTF "+e.fromGLTF:"",e.isDecal?"#define DECAL":"",e.useOIT?"#define USE_OIT":"",e.PDSFX?"#define PDSFX":"",e.pdsfxUseMap?"#define PDSFX_USE_MAP":"",e.refractionRatioMap?"#define USE_REFRACTIONRATIOMAP":"",e.sslrefractionEnabled?"#define SSLREFRACTION_ENABLED":"",e.sslreflectionEnabled?"#define SSLREFLECTION_ENABLED":"",e.useSSAO?"#define USE_SSAO":"",e.isMultiInstanced?"#define IS_MULTI_INSTANCED":"",e._definePickingInstancing?"#define PICKING_INSTANCING":"",e.specialPickingInstancing?"#define SPECIAL_PICKING_INSTANCING":"",e.envMap?"#define USE_ENVMAP":"",e.envMap2?"#define USE_ENVMAP_2":"",e.useHDR?"#define HDR":"",e.useLatLongMap?"#define LATLONG_MAP":"",e.useAmbianceV2?"#define AMBIANCE_V2":"",e.useHDRFloat?"#define HDR_FLOAT":"",e.useSRGB?"#define sRGB":"",1===e.envMapping?"#define USE_LIGHTPROBEMAP":"",2===e.envMapping?"#define USE_LATLONGMAP":"",e.useFiniteEnvMap?"#define USE_FINITE_ENVMAP":"",e.useIBLColor?"#define USE_IBL_LIGHT_COLOR":"",e.useLinearSampling?"#define USE_IBL_LINEAR":"",e.envMapEncoding?"#define USE_IBL_"+e.envMapEncoding:"",e.reflectionProbes?"#define USE_REFLECTION_PROBE":"",e.dashedLine?"#define USE_DASHEDLINE":"",e.cpuPattern?"#define CPU_PATTERN":"",e.worldSizePattern?"#define WORLD_SIZE_PATTERN":"",e.invertedPattern?"#define DASHEDLINE_INVERTED":"",e._originalPatternSize?"#define PATTERN_LENGTH "+e._originalPatternSize:"",e.wideLine?"#define USE_WIDELINE":"",e.useLineGap?"#define USE_LINE_GAP":"",e.useLineGap&&e.useLineGapColor?"#define USE_LINE_GAP_COLOR":"",e.wideLine&&e.projectLineZToPolygon?"#define PROJECT_LINE_Z_TO_POLYGON":"",e.wideLine&&e.linejoin?"#define USE_"+e.linejoin.toUpperCase()+"JOIN":"",e.wideLine&&e.linecap?"#define USE_"+e.linecap.toUpperCase()+"CAP":"",e.doPlanarFace?"#define DO_PLANAR_FACE":""].join("\n")}return{_FragmentPrefixBuilder:function(t){return e.SplitTrimStickString([s(t),t.alphaTest?"#define ALPHATEST "+t.alphaTest.toFixed(5):"",t.discardOrOpaque?"#define DISCARD_OR_OPAQUE":"",t.inlinedPostProActivated?"#define INLINED_POSTPROCESS":"",6==t.inlinedPostProTonemapping?"#define TONEMAP_PHOTOGRAPHIC":"",t.useSpecularAA?"#define USE_SPECULAR_AA":"",t.reflectivityEnvMap?"#define REFLECTIVITY_ENVMAP":"",1===t.lightMapMode?"#define LIGHTMAP_IRRADIANCE_MODE":"",t.lightMapMappingType>-1?"#define LIGHTMAP_MAPPING_OPERATOR":"",t.lightMapLinear?"#define USE_LIGHTMAP_LINEAR":"",t.phongFirstDir?"#define PHONG_FIRST_DIR_ONLY":"",void 0!==t.textureBlending?"#define TEXTURE_BLENDING "+t.textureBlending:"","#define TEXTURE_FORMAT "+t.textureFormat,t.bumpMap?"#define USE_BUMPMAP":"",t.bumpMap&&t.bumpScaleMap?"#define USE_BUMPSCALEMAP":"",t.bumpMap&&t.bumpScaleMulCoef&&t.bumpScaleAddCoef?"#define USE_BUMPSCALE_COEFFICIENTS":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMap&&t.normalMulCoef&&t.normalAddCoef?"#define USE_NORMAL_COEFFICIENTS":"",t.normalMapFlipY?"#define NORMALFLIPY":"",t.normalMap&&t.normalScaleMap?"#define USE_NORMALSCALEMAP":"",t.normalMap&&t.normalScaleMulCoef&&t.normalScaleAddCoef?"#define USE_NORMALSCALE_COEFFICIENTS":"",t.map?"#define USE_MAP":"",t.mapHDR?"#define USE_MAP_HDR":"",t.diffuseMulCoef&&t.diffuseAddCoef?"#define USE_DIFFUSE_COEFFICIENTS":"",t.diffuseBorderColorU?"#define USE_DIFFUSEMAP_BORDER_COLOR_U":"",t.diffuseBorderColorV?"#define USE_DIFFUSEMAP_BORDER_COLOR_V":"",t.map&&t.useAlphaFromDiffuseMap?"#define USE_ALPHA_FROM_MAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularMulCoef&&t.specularAddCoef?"#define USE_SPECULAR_COEFFICIENTS":"",t.specularMapLinear?"#define SPECULAR_LINEAR":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.metalnessMulCoef&&t.metalnessAddCoef?"#define USE_METALNESS_COEFFICIENTS":"",t.specularContribMap?"#define USE_SPECULARCONTRIBMAP":"",t.specularContribMulCoef&&t.specularContribAddCoef?"#define USE_SPECULARCONTRIB_COEFFICIENTS":"",t.useEmission?"#define USE_EMISSION":"",t.emissionColorMap?"#define USE_EMISSIONCOLORMAP":"",t.emissionColorMulCoef&&t.emissionColorAddCoef?"#define USE_EMISSIONCOLOR_COEFFICIENTS":"",t.emissionNormalized?"#define USE_NORMALIZED_EMISSION":"",t.emissionColorMapLinear?"#define EMISSION_LINEAR":"",t.useTransparency?"#define USE_TRANSPARENCY":"",t.transparencyMap?"#define USE_TRANSPARENCYMAP":"",t.transparencyMulCoef&&t.transparencyAddCoef?"#define USE_TRANSPARENCY_COEFFICIENTS":"",t.opacityMap?"#define USE_OPACITYMAP":"",t.opacityBorderColorU?"#define USE_OPACITYMAP_BORDER_COLOR_U":"",t.opacityBorderColorV?"#define USE_OPACITYMAP_BORDER_COLOR_V":"",t.opacityMulCoef&&t.opacityAddCoef?"#define USE_OPACITY_COEFFICIENTS":"",t.dspbrWithTranslucency?"#define USE_TRANSLUCENCY":"",t.translucencyMap?"#define USE_TRANSLUCENCYMAP":"",t.translucencyMulCoef&&t.translucencyAddCoef?"#define USE_TRANSLUCENCY_COEFFICIENTS":"",t.translucencyColorMap?"#define USE_TRANSLUCENCY_COLOR_MAP":"",t.translucencyColorMapLinear?"#define TRANSLUCENCY_COLOR_LINEAR":"",t.translucencyColorMulCoef&&t.translucencyColorAddCoef?"#define USE_TRANSLUCENCY_COLOR_COEFFICIENTS":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.glossinessMap?"#define USE_GLOSSINESSMAP":"",t.roughnessMulCoef&&t.roughnessAddCoef?"#define USE_ROUGHNESS_COEFFICIENTS":"",t.glossinessMulCoef&&t.glossinessAddCoef?"#define USE_GLOSSINESS_COEFFICIENTS":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.anisotropyMulCoef&&t.anisotropyAddCoef?"#define USE_ANISOTROPY_COEFFICIENTS":"",t.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",t.anisotropyAngleMulCoef&&t.anisotropyAngleAddCoef?"#define USE_ANISOTROPYANGLE_COEFFICIENTS":"",t.sheen?"#define USE_SHEEN":"",t.sheenMap?"#define USE_SHEEN_MAP":"",t.sheenMulCoef&&t.sheenAddCoef?"#define USE_SHEEN_COEFFICIENTS":"",t.sheenColorMap?"#define USE_SHEEN_COLOR_MAP":"",t.sheenColorMulCoef&&t.sheenColorAddCoef?"#define USE_SHEEN_COLOR_COEFFICIENTS":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESS_MAP":"",t.sheenRoughnessMulCoef&&t.sheenRoughnessAddCoef?"#define USE_SHEEN_ROUGHNESS_COEFFICIENTS":"",t.sheenMode?"#define "+t.sheenMode:"",t.sheenColorMapLinear?"#define SHEEN_COLOR_LINEAR":"",t.specGlossFlakes?"#define USE_SPECGLOSS_FLAKES":"",t.dspbrFlakes?"#define USE_DSPBR_FLAKES":"",t.specGlossFlakes&&t.flakesMode<2?"#define ADVANCED_FLAKES_BLENDING":"",t.specGlossFlakes&&t.flakesMode<2?"#define ADVANCED_PRESENCE_NOISE":"",t.specGlossFlakes&&t.flakesMode<1?"#define FLAKES_NORMAL_PERTURBATION":"",t.specGlossFlakes&&t.flakesMode<1?"#define PEARL_FLAKES_ACTIVATED":"",t.dspbrFlakes&&0===t.flakesMode?"#define DSPBR_FLAKES_FULL_GRID":"",t.dspbrFlakes&&t.flakesMode<=1?"#define DSPBR_FLAKES_THREE_LAYERS":"",t.dspbrFlakes&&2===t.flakesMode?"#define DSPBR_FLAKES_TWO_LAYERS":"",t.dspbrFlakes&&3===t.flakesMode?"#define DSPBR_FLAKES_ONE_LAYER":"",t.flakesCoverageMap?"#define USE_FLAKESCOVERAGE_MAP":"",t.flakesCoverageMulCoef&&t.flakesCoverageAddCoef?"#define USE_FLAKESCOVERAGE_COEFFICIENTS":"",t.flakesRoughnessMap?"#define USE_FLAKESROUGHNESS_MAP":"",t.flakesRoughnessMulCoef&&t.flakesRoughnessAddCoef?"#define USE_FLAKESROUGHNESS_COEFFICIENTS":"",t.flakesColorMap?"#define USE_FLAKESCOLOR_MAP":"",t.flakesColorMulCoef&&t.flakesColorAddCoef?"#define USE_FLAKESCOLOR_COEFFICIENTS":"",t.flakesSizeMap?"#define USE_FLAKESSIZE_MAP":"",t.flakesSizeMulCoef&&t.flakesSizeAddCoef?"#define USE_FLAKESSIZE_COEFFICIENTS":"",t.flakesColorMapLinear?"#define FLAKES_LINEAR":"",t.flipFlop?"#define USE_FLIPFLOP":"",t.flipFlopColorMap?"#define USE_FLIPFLOP_COLOR_MAP":"",t.flipFlopColorMulCoef&&t.flipFlopColorAddCoef?"#define USE_FLIPFLOP_COLOR_COEFFICIENTS":"",t.flipFlopColorMapLinear?"#define FLIPFLOP_COLOR_LINEAR":"",t.flipFlopMap?"#define USE_FLIPFLOP_MAP":"",t.flipFlopMulCoef&&t.flipFlopAddCoef?"#define USE_FLIPFLOP_COEFFICIENTS":"",t.clearCoat?"#define CLEAR_COAT":"",t.clearCoatMap?"#define CLEAR_COAT_MAP":"",t.clearCoatMulCoef&&t.clearCoatAddCoef?"#define USE_CC_COEFFICIENTS":"",t.clearCoatColorMap?"#define CLEAR_COAT_COLORMAP":"",t.clearCoatColorMulCoef&&t.clearCoatColorAddCoef?"#define USE_CC_COLOR_COEFFICIENTS":"",t.clearCoatNormalMap?"#define CLEAR_COAT_NORMALMAP":"",(t.clearCoatNormalMap||t.orangePeel)&&t.clearCoatNormalMulCoef&&t.clearCoatNormalAddCoef?"#define USE_CC_NORMAL_COEFFICIENTS":"",t.clearCoatNormalMapFlipY?"#define CLEAR_COAT_NORMALMAPFLIPY":"",t.clearCoatRoughnessMap?"#define USE_CC_ROUGHNESSMAP":"",t.coatingGlossinessMap?"#define USE_CC_GLOSSINESSMAP":"",t.coatingGlossinessMulCoef&&t.coatingGlossinessAddCoef?"#define USE_CC_GLOSSINESS_COEFFICIENTS":"",t.clearCoatRoughnessMulCoef&&t.clearCoatRoughnessAddCoef?"#define USE_CC_ROUGHNESS_COEFFICIENTS":"",t.orangePeel?"#define USE_ORANGE_PEEL":"",t.clearCoatColorMapLinear?"#define CLEARCOAT_LINEAR":"",t.subsurface?"#define USE_SUBSURFACE":"",t.sssLUT?"#define USE_SSSLUT":"",t.thickness?"#define USE_THICKNESS":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.thicknessAddCoef&&t.thicknessMulCoef?"#define USE_THICKNESS_COEFFICIENTS":"",t.envMapSheen?"#define USE_ENVMAP_SHEEN":"",t.envMapDiffuse?"#define USE_ENVMAP_DIFFUSE":"",t.envMapHDR?"#define USE_ENVMAP_HDR":"",t.envMapsRGB?"#define USE_ENVMAP_SRGB":"",t.thinWalled?"#define THIN_WALLED":"",t.iridescence?"#define USE_IRIDESCENCE":"",t.iridescenceMap?"#define USE_IRIDESCENCE_MAP":"",t.iridescenceAddCoef&&t.iridescenceMulCoef?"#define USE_IRIDESCENCE_COEFFICIENTS":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESS_MAP":"",t.iridescenceThicknessAddCoef&&t.iridescenceThicknessMulCoef?"#define USE_IRIDESCENCE_THICKNESS_COEFFICIENTS":"",t.instancingMeshSelectionMode?"#define INSTANCING_MESH_SELECTION":"",t.isFromGAS?"#define PBR_FROM_GAS":"",t.metal?"#define METAL":""].join("\n"))},_VertexPrefixBuilder:function(t){return e.SplitTrimStickString([s(t),t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals?"#define USE_MORPHNORMALS":"",t.fixedSize?"#define FIXED_SIZE":"",t.billboard?"#define BILLBOARD":"",t.skinning?"#define USE_SKINNING":"",t.useEulerAngles?"#define USE_SKINNING_ANGLES":"",t.skinningMapWidth&&!t.isMultiInstanced?"#define N_BONE_PIXEL_X "+t.skinningMapWidth.toFixed(1):"",t.skinningMapHeight&&!t.isMultiInstanced?"#define N_BONE_PIXEL_Y "+t.skinningMapHeight.toFixed(1):"",t.skinningInstancingMapsInfo&&t.isMultiInstanced?"#define NB_INSTANCING_SKIN_MAPS "+t.skinningInstancingMapsInfo.nbTextures+"\n#define NB_BONES "+t.skinningInstancingMapsInfo.nbBones.toFixed(1)+"\n#define MAX_MAP_SIZE "+t.skinningInstancingMapsInfo.maxTextureSize.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_X "+t.skinningInstancingMapsInfo.lastTextureSizeX.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_Y "+t.skinningInstancingMapsInfo.lastTextureSizeY.toFixed(1)+"\n":"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.map?"#define USE_MAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.glossinessMap?"#define USE_GLOSSINESSMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",t.displacementMap?"#define USE_DISPLACEMENTMAP":"",t.displacementMap&&t.displacementAddCoef&&t.displacementMulCoef?"#define USE_DISPLACEMENT_COEFFICIENTS":"",t.dspbrFlakes?"#define USE_DSPBR_FLAKES":"",t.specGlossFlakes?"#define USE_SPECGLOSS_FLAKES":"",t.orangePeel?"#define USE_ORANGE_PEEL":"",t.subsurface?"#define USE_SUBSURFACE":"",t.compressedVertices?"#define COMPRESSED_VERTICES":"",t.compressedNormals?"#define COMPRESSED_NORMALS":"",t.oct16Normals?"#define OCT16_NORMALS":"",t.useCompressionContext?"#define COMPRESSION_CONTEXT":"",t.compressedUVs?"#define COMPRESSED_UVS":"",t.compressedColors?"#define COMPRESSED_COLORS":""].join("\n"))}}})),define("DS/Materials/DeferredCaches",["DS/Mesh/ThreeJS_Base","WebappsUtils/WebappsUtils"],(function(e,t){"use strict";var s=new Map,i=new Map,a=new Map,r=new Map,n=new Map,o=new Map,l=new Map,h=t.getWebappsAssetUrl("Visualization","")+"textures/predefinedMaterials/",p=[],u=function(e){this.material=e,this.usedBy=new Set};u.prototype.get=function(e){return this.usedBy.add(e.id),this.material};return{_loadPredefinedMaterialTextures:function(t,s,i){if(p.length>0||i)return p;p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Brass_Albedo.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(220,213,156)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Brass_roughness.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.4)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_BrushedSteel_Albedo.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(170,170,170)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_BrushedSteel_Anisotropy.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.5)),p.push(e.ImageUtils.loadTexture(h+"Appearance_BrushedSteel_Normal.png",void 0,s,null,!0,!1,t).withSubstituteTexture(.5,.5,1)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_BrushedSteel_Roughness.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.15)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastAluminum_Albedo.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(170,170,170)),p.push(e.ImageUtils.loadTexture(h+"Appearance_CastAluminum_Normal.png",void 0,s,null,!0,!1,t).withSubstituteTexture(.5,.5,1)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastAluminum_Roughness.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.6)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastSteel_Albedo.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(136,136,136)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastSteel_Roughness.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.4)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Copper_Albedo.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(210,184,177)),p.push(e.ImageUtils.loadTexture(h+"Appearance_Copper_Normal.png",void 0,s,null,!0,!1,t).withSubstituteTexture(.5,.5,1)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Copper_Roughness.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.4)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedAluminum_Albedo.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(170,170,170)),p.push(e.ImageUtils.loadTexture(h+"Appearance_MachinedAluminum_Normal.png",void 0,s,null,!0,!1,t).withSubstituteTexture(.5,.5,1)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedAluminum_Roughness.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.6)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedStainlessSteel_Albedo.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(170,170,170)),p.push(e.ImageUtils.loadTexture(h+"Appearance_MachinedStainlessSteel_Normal.png",void 0,s,null,!0,!1,t).withSubstituteTexture(.5,.5,1)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedStainlessSteel_Roughness.basis",void 0,s,null,!0,e.BasisUsage.RGB,t).withSubstituteTexture(.15));for(var a=0;a<p.length;a++)p[a].wrapS=e.RepeatWrapping,p[a].wrapT=e.RepeatWrapping,p[a].flipY=!1;return p},DeferredMaterial:u,DefaultNormalDepthMaterials:s,DefaultShadowDepthMaterials:i,DefaultPickingMaterials:a,DefaultHighlightMaterials:r,DefaultMaterials:n,PredefinedMaterials:o,GeomTypeMaterials:l}})),define("DS/Materials/PDSFXData",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";var t=[/(\W+)modelViewMatrix(\W+)/,/(\W+)viewMatrix(\W+)/,/(\W+)projectionMatrix(\W+)/],s=["modelViewMatrix","viewMatrix","projectionMatrix"],i=["vGetWorldViewMatrix()","vGetViewMatrix()","vGetProjectionMatrix()"],a=function(e){for(var a=s.length,r="",n=0;n<a;n++){e.search(t[n])>=0&&(r||(r=['BAD PDSFX USAGE!!!: DO NOT USE THE "'+s[n]+'" token in your overridden function!',"This is henceforth an internal PRIVATE variable. Use the following appropriate PDSFX getter function: "+i[n],"Please take time to correct your PDSFX materials by using the getters/setters provided by the API."].join("\n")),console.warn(r))}};var r=function(){this.PDSFX=!1,this.PDSFX_OverridableFunctions_VS={},this.PDSFX_OverridableFunctions_FS={},this.pdsfxUniforms=null,this.pdsfxTextures=null,this._pdsfxUniformsList=null,this.pdsfxVaryings=null,this.pdsfxGlobalVariablesCode_VS=null,this.pdsfxGlobalVariablesCode_FS=null,this.pdsfxAttributes=null,this.pdsfxAttributesInternal=null,this._extraDefines=null,this._uniqueID=null};return r.prototype.clone=function(){var t=new r;return t.PDSFX=this.PDSFX,Object.assign(t.PDSFX_OverridableFunctions_VS,this.PDSFX_OverridableFunctions_VS),Object.assign(t.PDSFX_OverridableFunctions_FS,this.PDSFX_OverridableFunctions_FS),this.pdsfxUniforms&&(t.pdsfxUniforms=e.CloneStructure(this.pdsfxUniforms)),this.pdsfxTextures&&(t.pdsfxTextures=this.pdsfxTextures.slice()),this.pdsfxVaryings&&(t.pdsfxVaryings=e.CloneStructure(this.pdsfxVaryings)),this.pdsfxGlobalVariablesCode_VS&&(t.pdsfxGlobalVariablesCode_VS=this.pdsfxGlobalVariablesCode_VS),this.pdsfxGlobalVariablesCode_FS&&(t.pdsfxGlobalVariablesCode_FS=this.pdsfxGlobalVariablesCode_FS),this.pdsfxAttributes&&(t.pdsfxAttributes=e.CloneStructure(this.pdsfxAttributes)),this.pdsfxAttributesInternal&&(t.pdsfxAttributesInternal=e.CloneStructure(this.pdsfxAttributesInternal)),t._uniqueID=this._uniqueID,t._setUniformsList(),this._extraDefines&&(t._extraDefines={},Object.assign(t._extraDefines,this._extraDefines)),t},r.prototype._setUniformsList=function(){if(this.pdsfxUniforms)for(var e in this._pdsfxUniformsList=new Map,this.pdsfxUniforms)this._pdsfxUniformsList.set(e,this.pdsfxUniforms[e])},r.prototype._getGlobalVertexCode=function(e){return this.pdsfxGlobalVariablesCode_VS?"function"!=typeof this.pdsfxGlobalVariablesCode_VS?this.pdsfxGlobalVariablesCode_VS:this.pdsfxGlobalVariablesCode_VS(e):""},r.prototype._getGlobalFragmentCode=function(e){return this.pdsfxGlobalVariablesCode_FS?"function"!=typeof this.pdsfxGlobalVariablesCode_FS?this.pdsfxGlobalVariablesCode_FS:this.pdsfxGlobalVariablesCode_FS(e):""},r.prototype._getPDSFXOverridableFunctions_VS=function(t){for(var s="",i=Object.keys(this.PDSFX_OverridableFunctions_VS),r=0;r<i.length;r++){var n=i[r],o=this.PDSFX_OverridableFunctions_VS[n];if("string"==typeof o)a(o),s=`\n                    ${s}\n                    ${o}\n                `;else{var l=e._ShaderChunk["__PDSFX"+n+"_VS"](t,o);a(l),s=`\n                    ${s}\n                    ${l}\n                `}}return s},r.prototype._getPDSFXOverridableFunctions_FS=function(t){for(var s="",i=Object.keys(this.PDSFX_OverridableFunctions_FS),r=0;r<i.length;r++){var n=i[r],o=this.PDSFX_OverridableFunctions_FS[n];if("string"==typeof o)a(o),s=`\n                    ${s}\n                    ${o}\n                `;else{var l=e._ShaderChunk["__PDSFX"+n+"_FS"](t,o);a(l),s=`\n                    ${s}\n                    ${l}\n                `}}return s},r.prototype._setPDSFXOverridableFunctions=function(e,t){var s;for(s in e)this.PDSFX_OverridableFunctions_VS[s]&&e[s]&&(this.PDSFX_OverridableFunctions_VS[s]=e[s]);for(s in t)this.PDSFX_OverridableFunctions_FS[s]&&t[s]&&(this.PDSFX_OverridableFunctions_FS[s]=t[s])},r})),define("DS/Materials/ProgramManager",["DS/Mesh/ThreeJS_Base"],(function(e){"use strict";var t=function(e,t){this.program=e,this.shaderVersion=t};t.prototype.disposeProgram=function(e,t){e(t,this.program.program,!1)};var s=function(){this.programs=new Map};s.prototype.disposeAllPrograms=function(e,t){this.programs.forEach((function(s,i,a){s.disposeProgram(e,t)})),this.programs.clear()};var i,a=function(){this.renderingContexts=new Map};a.prototype.disposeAllPrograms=function(e,t){this.renderingContexts.forEach((function(s,i,a){s.disposeAllPrograms(e,t)})),this.renderingContexts.clear()},a.prototype._getActive=function(e){if(!this.renderingContexts.has(e)){var t=new s;return this.renderingContexts.set(e,t),t}return this.renderingContexts.get(e)};var r=function(){this.renderers=new Array(i);for(var e=0;e<i;e++)this.renderers[e]=new Map};r.prototype._getActive=function(e,t){var s=this.renderers[t];return s.has(e)||s.set(e,new a),s.get(e)},r.prototype.disposeAllPrograms=function(e,t){for(var s=0;s<this.renderers.length;s++){var i=this.renderers[s];i.forEach((function(s,i,a){s.disposeAllPrograms(e,t)})),i.clear()}},r.prototype.disposeAllRendererPrograms=function(e,t,s){for(var i=0;i<this.renderers.length;i++){var a=this.renderers[i];a.has(s)&&(a.get(s).disposeAllPrograms(e,t),a.delete(s))}};var n=function(t){i=e.RendererMode._count,this.material=t,this.programPools=new Map,this.activeProgramPool=null,this.currentContextId=-1,this.currentRendererId=-1,this.currentRendererMode=-1,this.currentRenderingContext=-1};n.prototype.setActivePool=function(e,t,s,i){this.programPools.has(e)||this.programPools.set(e,new r),this.activeProgramPool=this.programPools.get(e)._getActive(t,s)._getActive(i).programs,this.currentContextId=e,this.currentRendererId=t,this.currentRendererMode=s,this.currentRenderingContext=i},n.prototype.getProgram=function(e,t,s){var i=this.activeProgramPool.get(e);return i&&null!==i.program.program?i.shaderVersion!==t?(this.disposeCurrentProgram(s,e),null):i.program:null},n.prototype.addProgram=function(e,s,i){this.activeProgramPool.set(e,new t(s,i))},n.prototype.disposeAllPrograms=function(e){var t=this;this.programPools.forEach((function(s,i,a){s.disposeAllPrograms(e,t.material)})),this.programPools.clear(),this.activeProgramPool=null,this.currentContextId=-1,this.currentRendererId=-1,this.currentRendererMode=-1,this.currentRenderingContext=-1},n.prototype.disposeAllRendererPrograms=function(e,t,s){this.programPools.has(t)&&this.programPools.get(t).disposeAllRendererPrograms(e,this.material,s)},n.prototype.disposeCurrentProgram=function(e,t){if(this.activeProgramPool.has(t)){var s=this.activeProgramPool.get(t);this.activeProgramPool.delete(t),e(this.material,s.program.program,!1)}};Math.pow(2,31);return n.prototype.getProgramID=function(e,t){return(e?e._programID:0)|(t?t._programID:0)},n.prototype.getTokenProgramID=function(e){return e?e._programID:0},n})),define("DS/Materials/PhysicalMaterialKeyUtils",[],(function(){"use strict";const e=new Set(["flakesCoverage","flakesCoverageMap","flakesCoverageAddCoef","flakesCoverageMulCoef","flakesCoverageUvTransform","flakesCoverageUvSlot","flakesSize","flakesSizeMap","flakesSizeAddCoef","flakesSizeMulCoef","flakesSizeUvTransform","flakesSizeUvSlot","flakesRoughness","flakesRoughnessMap","flakesRoughnessAddCoef","flakesRoughnessMulCoef","flakesRoughnessUvTransform","flakesRoughnessUvSlot","flakesColor","flakesColorMap","flakesColorAddCoef","flakesColorMulCoef","flakesColorUvTransform","flakesColorUvSlot","flipFlopColor","flipFlopColorMap","flipFlopColorAddCoef","flipFlopColorMulCoef","flipFlopColorUvTransform","flipFlopColorUvSlot","flipFlop","flipFlopMap","flipFlopAddCoef","flipFlopMulCoef","flipFlopUvTransform","flipFlopUvSlot"]),t=new Set(["flakes","flakesColor","flakesColorMulCoef","flakesColorAddCoef","flakesBump","flakesDensity","flakesScale","flakesRoughness","pearlFlakesColor","pearlFlakesColorMulCoef","pearlFlakesColorAddCoef","pearlFlakesBump","pearlFlakesDensity"]),s=new Set(["clearCoat","clearCoatMap","clearCoatAddCoef","clearCoatMulCoef","clearCoatUvTransform","clearCoatUvSlot","clearCoatRoughness","clearCoatRoughnessMap","clearCoatRoughnessAddCoef","clearCoatRoughnessMulCoef","clearCoatRoughnessUvTransform","clearCoatRoughnessUvSlot","coatingGlossinessMap","coatingGlossinessMulCoef","coatingGlossinessAddCoef","clearCoatColor","clearCoatColorMap","clearCoatColorAddCoef","clearCoatColorMulCoef","clearCoatColorUvTransform","clearCoatColorUvSlot","clearCoatNormalMap","clearCoatNormalAddCoef","clearCoatNormalMulCoef","clearCoatNormalUvTransform","clearCoatNormalUvSlot","clearCoatNormalMapFlipY","clearCoatNormalScaleMulCoef","clearCoatNormalScaleAddCoef","clearCoatNormalScale","orangePeel","orangePeelScale"]),i=new Set(["thinWalled","ior","attenuationColor","attenuationDistance","subsurfaceColor","subsurfaceAnisotropy","subsurfacePreset"]),a=new Set(["thickness","thicknessMap","thicknessAddCoef","thicknessMulCoef","thicknessUvTransform","thicknessUvSlot"]),r=new Set(["anisotropy","anisotropyMap","anisotropyAddCoef","anisotropyMulCoef","anisotropyUvSlot","anisotropyUvTransform","anisotropyAngle","anisotropyAngleMap","anisotropyAngleAddCoef","anisotropyAngleMulCoef","anisotropyAngleUvSlot","anisotropyAngleUvTransform"]),n=new Set(["displacementMap","displacementAddCoef","displacementMulCoef","displacementUvTransform","displacementUvSlot","displacementScale","displacementBias"]),o=new Set(["iridescence","iridescenceMap","iridescenceAddCoef","iridescenceMulCoef","iridescenceUvTransform","iridescenceUvSlot","iridescenceIoR","iridescenceThickness","iridescenceThicknessMap","iridescenceThicknessAddCoef","iridescenceThicknessMulCoef","iridescenceThicknessUvTransform","iridescenceThicknessUvSlot"]),l=new Set(["sheen","sheenMap","sheenAddCoef","sheenMulCoef","sheenUvTransform","sheenUvSlot","sheenRoughness","sheenRoughnessMap","sheenRoughnessAddCoef","sheenRoughnessMulCoef","sheenRoughnessUvTransform","sheenRoughnessUvSlot","sheenColor","sheenColorMap","sheenColorAddCoef","sheenColorMulCoef","sheenColorUvTransform","sheenColorUvSlot","sheenMode"]),h=new Set(["uvSlot","diffuse","diffuseMap","diffuseMulCoef","diffuseAddCoef","diffuseUvTransform","diffuseUvSlot","specular","specularMap","specularMulCoef","specularAddCoef","specularUvTransform","specularUvSlot","specularContribution","specularContributionMap","specularContributionMulCoef","specularContributionAddCoef","specularContributionUvTransform","specularContributionUvSlot","metalness","metalnessMap","metalnessMulCoef","metalnessAddCoef","metalnessUvTransform","metalnessUvSlot","emissionColor","emissionColorMap","emissionColorMulCoef","emissionColorAddCoef","emissionColorUvTransform","emissionColorUvSlot","emissionValue","emissionNormalized","transparency","transparencyMap","transparencyMulCoef","transparencyAddCoef","transparencyUvTransform","transparencyUvSlot","opacity","opacityMap","opacityMulCoef","opacityAddCoef","opacityUvTransform","opacityUvSlot","useAlphaFromDiffuseMap","roughness","roughnessMap","roughnessMulCoef","roughnessAddCoef","roughnessUvTransform","roughnessUvSlot","glossinessMap","glossinessMapMulCoef","glossinessMapAddCoef","translucency","translucencyMap","translucencyMulCoef","translucencyAddCoef","translucencyUvTransform","translucencyUvSlot","translucencyColor","translucencyColorMap","translucencyColorMulCoef","translucencyColorAddCoef","translucencyColorUvTransform","translucencyColorUvSlot","useTranslucencyColorFromAlbedo","bumpMap","bumpUvSlot","bumpUvTransform","bumpScale","bumpScaleMap","bumpScaleMulCoef","bumpScaleAddCoef","bumpScaleUvTransform","bumpScaleUvSlot","normalMap","normalMulCoef","normalAddCoef","normalUvTransform","normalUvSlot","normalMapFlipY","normalScale","normalScaleMap","normalScaleMulCoef","normalScaleAddCoef","normalScaleUvTransform","normalScaleUvSlot"]),p={diffuseUvSlot:"uvSlot",specularUvSlot:"uvSlot",metalnessUvSlot:"uvSlot",specularContributionUvSlot:"uvSlot",specularContribUvSlot:"uvSlot",emissionColorUvSlot:"uvSlot",transparencyUvSlot:"uvSlot",opacityUvSlot:"uvSlot",roughnessUvSlot:"uvSlot",translucencyUvSlot:"uvSlot",translucencyColorUvSlot:"uvSlot",bumpUvSlot:"uvSlot",bumpScaleUvSlot:"uvSlot",normalUvSlot:"uvSlot",normalScaleUvSlot:"uvSlot",sheenColorUvSlot:"uvSlot",sheenRoughnessUvSlot:"uvSlot",sheenUvSlot:"uvSlot",iridescenceThicknessUvSlot:"uvSlot",iridescenceUvSlot:"uvSlot",displacementUvSlot:"uvSlot",anisotropyAngleUvSlot:"uvSlot",anisotropyUvSlot:"uvSlot",thicknessUvSlot:"uvSlot",clearCoatNormalUvSlot:"uvSlot",clearCoatColorUvSlot:"uvSlot",clearCoatRoughnessUvSlot:"uvSlot",clearCoatUvSlot:"uvSlot",flipFlopUvSlot:"uvSlot",flipFlopColorUvSlot:"uvSlot",flakesColorUvSlot:"uvSlot",flakesRoughnessUvSlot:"uvSlot",flakesSizeUvSlot:"uvSlot",flakesCoverageUvSlot:"uvSlot"};return{AllowedDSPBRFlakesKeys:e,AllowedSpecGlossFlakesKeys:t,AllowedClearCoatKeys:s,AllowedVolumeKeys:i,AllowedThicknessKeys:a,AllowedAnisotropyKeys:r,AllowedDisplacementKeys:n,AllowedIridescenceKeys:o,AllowedSheenKeys:l,AllowedCoreKeys:h,UVKeysToInternalKeys:p,sanitizeForUVKeys:function(e,t,s){var i=void 0!==t.uvSlot?t.uvSlot:-1;return e.forEach((e=>{void 0!==t[e]&&(p[e]&&void 0===t[p[e]]?i=t[e]:p[e]||(s[e]=t[e]))})),i},KeysToInternalKeys:{diffuse:"color",diffuseMap:"map",specularContribution:"specularContrib",specularContributionMap:"specularContribMap",specularContributionMulCoef:"specularContribMulCoef",specularContributionAddCoef:"specularContribAddCoef",specularContributionUvTransform:"specularContribUvTransform"}}})),define("DS/Materials/Material",["DS/Mesh/ThreeJS_Base","DS/Materials/ProgramManager","DS/Materials/DeferredCaches","DS/CoreEvents/Events"],(function(e,t,s,i){"use strict";let a=null;var r=0,n=new e.Matrix3,o=new e.Matrix4;const l=new e.Matrix3(.01,0,0,0,-.01,0,0,.01,1),h=new Set;h.add("programManager"),h.add("program"),h.add("_displayRangeLists"),h.add("_PDSFXData"),h.add("_deferredMaterials"),h.add("_deferredMaterialsInit"),h.add("_dspbrFlakes"),h.add("_specGlossFlakes"),h.add("_clearCoat"),h.add("_volume"),h.add("_sheenData"),h.add("_sheen"),h.add("_anisotropy"),h.add("_displacement"),h.add("_iridescence"),h.add("_thickness"),h.add("_fromGLTF"),h.add("__physicalMode");class p{constructor(){a=e.BlockPoints,e.EventDispatcher.call(this),this._isAlteringGeometryOnGPU=!1,this.id=r++,this._sceneGraphOrderMode=0,this.name="",this._useCount=0,this._usedBy=new Set,this._resetFrameIndex=0,this._source=e.AssetSource.MANUAL,this._side=e.Constants.FrontSide,this.forceSide=!1,this._opacity=1,this._transparent=!1,this.blending=e.NormalBlending,this.blendSrc=null,this.blendDst=null,this.blendEquation=null,this.depthTest=!0,this.depthFunc=null,this.depthWrite=!0,this.colorWrite=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.vertexColors=e.VertexColorType.NoColors,this.polite=!1,this.politeMaterial=null,this.useGASColor=!1,this._isFromGAS=!1,this._alphaTest=0,this.alphaTestMode=e.AlphaTestMode.DISCARD,this._disableForcedAlphaTest=!1,this._visible=!0,this.enableClipPlanes=!0,this.clipPlaneIndex=0,this.clipPlaneUseModelMaterial=null,this.mappingType=-1,this.mappingTransformSemantic=1,this.mappingObjTransformation=o,this.mappingNormTransformation=n,this.mappingUVTransformation=n,this.mappingUseFragment=!1,this.needsUpdate=!0,this.overridable=!0,this._allowFullMaterialOverride=0,this._force=!1,this.context=null,this.backMaterial=null,this.isBackMaterial=!1,this.useBlending=!1,this.previousOccurrenceRenderingOverride=null,this.vertexShader=null,this.fragmentShader=null,this.program=null,this.programManager=new t(this),this.shaderID=0,this._definePickingInstancing=!1,this.enableReceiveShadowOnCapping=!1,this._renderedClipPlane=null,this.line=null,this.point=null,this.defines=null,this._PDSFXData=null,this.isWideLine=!1,this.isDashedLine=!1,this.is2DLine=!1,this.isCPUPattern=!1,this.refreshUniforms=function(e,t){},this._refreshPDSFXUniforms_private=function(e,t){this.refreshPDSFXUniforms&&this.refreshPDSFXUniforms()},this.refreshPDSFXUniforms=function(){},this._displayRangeLists=new Set,this._displayLists=new Map,this._hasLODTextures=!1,this._deferredMaterialsInit=!1,this._deferredMaterials=[];for(var s=0;s<e.MaterialToUse.totalMaterial;s++)this._deferredMaterials[s]=null;this._deferredMaterials[e.MaterialToUse.originalMaterial]=this,this._loadingTextures=null,this._cloneOrigin=null,this._revision=0}isPDSFX(){return!!this._PDSFXData&&this._PDSFXData.PDSFX}_needsUpdateIfTexturesAreReady(){var t=this;if(this.needsUpdate)for(var s=this._getTextures(!1),i=0;i<s.length;i++){var a=s[i];if(a){if(!a.onLoadCallbacks)continue;a._isReady||(a._isReady=function(){return this.loadEndStatus===e.AssetLoadingStatus.READY||this.loadEndStatus===e.AssetLoadingStatus.INIT},a._canBeUsed=function(){return null!==this._substituteTexture||this._isReady()}),a._isReady()||(a.onLoadCallbacks.push((function(){t._sendEvent("requestShadowMapUpdate"),t._sendEvent("requestVisuUpdate")})),a.onRequest&&a.onRequest(),null===a._substituteTexture&&(this._loadingTextures||(this._loadingTextures=new Set),this._loadingTextures.has(a)||this._loadingTextures.add(a)))}}if(this._loadingTextures){var r=!0;this._loadingTextures.forEach((function(t){r=r&&(t._isReady()||t.loadEndStatus===e.AssetLoadingStatus.ERROR),t.onRequest&&t.onRequest()})),r&&(this._loadingTextures=null,this.needsUpdate=!0)}}static __isTextureAvailable(t,s){var i=t[s];return!!i&&(i._canBeUsed||(console.error("Expected THREE.Texture or THREE.WebGLRenderTarget but got object"),i._canBeUsed=function(){return this.loadEndStatus===e.AssetLoadingStatus.READY||this.loadEndStatus===e.AssetLoadingStatus.INIT}),i._canBeUsed())}_isTextureAvailable(e){return p.__isTextureAvailable(this,e)}requireTangentBinormal(){return!1}requireVertexTangentBinormal(){return!1}_setMaterialShaderOptions(e,t,s,i,a,r){var n=this,o={};(t||s||i)&&Object.assign(o,{normalMap:n._isTextureAvailable("normalMap"),normalMapFlipY:!!n.normalMapFlipY,bumpMap:n._isTextureAvailable("bumpMap")}),Object.assign(e,o)}_dump(){return{type:this.getType(),pdsfx:this.isPDSFX(),opacity:this.opacityMap?"texture":this._opacity,useGASColor:this.useGASColor}}_getTextures(e){let t=[];if(!e&&this.isPDSFX()&&this._PDSFXData.pdsfxTextures)for(let e=0;e<this._PDSFXData.pdsfxTextures.length;e++)this._PDSFXData.pdsfxTextures[e].value&&t.push(this._PDSFXData.pdsfxTextures[e].value);return t}isPropertyTextured(e){switch(e){case"color":return!!this.map;case"specular":return!!this.specularMap;case"opacity":return!!this.opacityMap;case"normal":return!!this.normalMap;case"bump":return!!this.bumpMap}return!1}_transparencyOnGPU(t){if(this.isPDSFX()&&this._PDSFXData._extraDefines.opacity||this.alphaTest>0&&this.alphaTestMode===e.AlphaTestMode.DISCARD)return!0;var s=!1;return t&&t._vertexColors>0?s=(this.useGASColor||this._isFromGAS)&&((t._vertexColors&e.VertexColorType.A)>0||t._vertexColors<=e.VertexColorType.RGBA):this.vertexColors>0&&(s=(this.vertexColors&e.VertexColorType.A)>0||this.vertexColors<=e.VertexColorType.RGBA),s}_isTransparent(e){return this._transparent||this.getOpacity()<1||this._transparencyOnGPU(e)}_loadMappingInfo(e,t,s,i){if(i.mappingType){var a=e.mappingNormTransformation;s.uniformMatrix3fv(i.mappingNormTransformation,!1,t.float32Matrix3x3Temp.setDoubles(a.elements)),a=e.mappingUVTransformation,s.uniformMatrix3fv(i.mappingUVTransformation,!1,t.float32Matrix3x3Temp.setDoubles(a.elements)),a=e.mappingObjTransformation,s.uniformMatrix4fv(i.mappingObjTransformation,!1,t.float32Matrix4x4Temp.setDoubles(a.elements)),s.uniform1i(i.mappingType,e.mappingType),s.uniform1i(i.mappingTransformSemantic,e.mappingTransformSemantic)}}_fillMappingUBO(e,t,s){const i=e.layout;i.mappingType&&(e.setM3(i.mappingNormTransformation,t.mappingNormTransformation),e.setM3(i.mappingUVTransformation,t.mappingUVTransformation),e.setM4(i.mappingObjTransformation,t.mappingObjTransformation),e.setI(i.mappingType,t.mappingType),e.setI(i.mappingTransformSemantic,t.mappingTransformSemantic))}_chooseLODTextures(e,t){let s=0;const i=this._getTextures(!1);for(let a=0;a<i.length;a++){let r=i[a];r&&r.lods&&(s|=r.chooseTexture(e,t))}s>0&&this._revision++}_computeAmbianceKeyAndProcessMaterial(e,t,s,i,a){if(this._needsUpdateIfTexturesAreReady(),!i.materialToUseList.shadowPassMaterial&&this.needsUpdate){this._hasLODTextures=!1;const e=this._getTextures(!1);for(let t=0;t<e.length;t++){let s=e[t];if(s&&s.lods){this._hasLODTextures=!0;break}}}return 0}get opacity(){return this._opacity}set opacity(e){this.setOpacity(e)}get force(){return this._force}set force(e){e!==this._force&&(this._force=e,this._usedBy.forEach((e=>{e._updateMaterial(!1)})),this._invalidateDisplayRangeLists())}get wireframe(){return!1}set wireframe(e){}get alphaTest(){return this._alphaTest}set alphaTest(e){this.setAlphaTest(e)}get transparent(){return this._transparent}set transparent(e){e!==this._transparent&&this._invalidateDisplayRangeLists(),this._transparent=e}get side(){return this._side}set side(e){this._side!==e&&this._invalidateDisplayRangeLists(),this._side=e}get visible(){return this._visible}set visible(e){this._visible!==e&&this._invalidateDisplayRangeLists(),this._visible=e}_invalidateDisplayRangeLists(){this._displayRangeLists.forEach((function(e,t){e.flagObjectsAsGSSOInvalidated()})),this._revision++,this._resetFrameIndex++}_removeDisplayRangeList(e){const t=e.dl;this._displayRangeLists.delete(e),this._displayLists.has(t)&&(this._displayLists.set(t,this._displayLists.get(t)-1),this._displayLists.get(t)<=0&&this._displayLists.delete(t))}_addDisplayRangeList(e){const t=e.dl;this._displayRangeLists.add(e),this._displayLists.has(t)?this._displayLists.set(t,this._displayLists.get(t)+1):this._displayLists.set(t,1)}_notifyAllDLtoBeSortedNextFrame(){this._displayLists.forEach((function(e,t){t._sortByProgram=!0}))}_notifyDLtoBeSortedNextFrame(e){this._displayLists.forEach((function(t,s){s.ssrId===e&&(s._sortByProgram=!0)}))}get PDSFX_OverridableFunctions_FS(){return this.isPDSFX()?this._PDSFXData.PDSFX_OverridableFunctions_FS:null}get pdsfxUniforms(){return console.warn("Do not access the 'pdsfxUniforms' property! Use one of these API functions instead: Material.getPDSFXUniform, Material.setPDSFXUniforms, or Material.updatePDSFXUniform."),this.isPDSFX()?this._PDSFXData.pdsfxUniforms:null}get PDSFX(){return console.warn("Please call the Material.isPDSFX function instead."),this.isPDSFX()}setPDSFXUniforms(t){if(this.isPDSFX()){let a=[];for(var s in t){var i=e.ToGLSLTypes[t[s].type];i&&(i.isTexture&&a.push(t[s]))}this._PDSFXData.pdsfxTextures=a.length?a:null,this._PDSFXData.pdsfxUniforms=t,this._PDSFXData._setUniformsList(),this.needsUpdate=!0}}updatePDSFXUniform(e,t,s=-1){if(this.isPDSFX()){if(void 0!==this._PDSFXData.pdsfxUniforms[e]&&(this._PDSFXData.pdsfxUniforms[e].value=t,s>=0)){const t=this._PDSFXData.pdsfxUniforms[e].length;this._PDSFXData.pdsfxUniforms[e].length=s,this.needsUpdate=this.needsUpdate||t!==s}this._revision++}}getPDSFXUniform(e){if(this.isPDSFX())return this._PDSFXData.pdsfxUniforms&&void 0!==this._PDSFXData.pdsfxUniforms[e]?{name:e,value:this._PDSFXData.pdsfxUniforms[e].value}:null}setPDSFXVaryings(e){this.isPDSFX()&&(this._PDSFXData.pdsfxVaryings=e,this.needsUpdate=!0)}setPDSFXAttributes(e){this.isPDSFX()&&(this._PDSFXData.pdsfxAttributes=e,this.needsUpdate=!0)}setPDSFXGlobalShaderCode(e,t){this.isPDSFX()&&(this._PDSFXData.pdsfxGlobalVariablesCode_VS=e,this._PDSFXData.pdsfxGlobalVariablesCode_FS=t,this.needsUpdate=!0)}setPDSFXPolygonOffset(t){if(this.isPDSFX()){this.polygonOffset=!0;var s=e.PDSFXPolygonOffsetParams[t];s&&(this.polygonOffsetFactor=s[0],this.polygonOffsetUnits=s[1])}}_defaultPDSFXOverridableFunctions(){return{vertex:{ComputeCommonValues:e._ShaderChunk.PDSFXComputeCommonValues_VS,ComputeObjectPosition:e._ShaderChunk.PDSFXComputeObjectPosition_VS,ComputeObjectFollowingPosition:e._ShaderChunk.PDSFXComputeObjectFollowingPosition_VS,ComputeObjectPreviousPosition:e._ShaderChunk.PDSFXComputeObjectPreviousPosition_VS,ComputeObjectNormal:e._ShaderChunk.PDSFXComputeObjectNormal_VS,ComputeObjectTexCoord0:e._ShaderChunk.PDSFXComputeObjectTexCoord0_VS,ComputeObjectTexCoord1:e._ShaderChunk.PDSFXComputeObjectTexCoord1_VS,ComputeObjectTexCoord2:e._ShaderChunk.PDSFXComputeObjectTexCoord2_VS,ComputeObjectTangent:e._ShaderChunk.PDSFXComputeObjectTangent_VS,ComputeObjectBinormal:e._ShaderChunk.PDSFXComputeObjectBinormal_VS,ProcessViewTangentSpace:e._ShaderChunk.PDSFXProcessViewTangentSpace_VS,ProcessClipSpacePosition:e._ShaderChunk.PDSFXProcessClipSpacePosition_VS,ComputeVaryingValues:e._ShaderChunk.PDSFXComputeVaryingValues_VS},fragment:{ComputeCommonValues:e._ShaderChunk.PDSFXComputeCommonValues_FS,ComputeDiscard:e._ShaderChunk.PDSFXComputeDiscard_FS,ComputeAlbedo:e._ShaderChunk.PDSFXComputeAlbedo_FS,_ComputeDiffuseTexel:e._ShaderChunk.PDSFX_ComputeDiffuseTexel_FS,ComputeViewPosition:e._ShaderChunk.PDSFXComputeViewPosition_FS,ComputeViewNormal:e._ShaderChunk.PDSFXComputeViewNormal_FS,ComputeOpacity:e._ShaderChunk.PDSFXComputeOpacity_FS,ProcessFinalColor:e._ShaderChunk.PDSFXProcessFinalColor_FS}}}_setDefaultPDSFXOverridableFunctions(){var e=this._defaultPDSFXOverridableFunctions();Object.assign(this._PDSFXData.PDSFX_OverridableFunctions_VS,e.vertex),Object.assign(this._PDSFXData.PDSFX_OverridableFunctions_FS,e.fragment),this.needsUpdate=!0}activatePDSFX(e=null){throw"Called abstract activatePDSFX"}_loadPDSFXUniforms(e,t,s){this._PDSFXData._pdsfxUniformsList&&(this._refreshPDSFXUniforms_private(t,s),t.loadUniformsGeneric(e,this._PDSFXData._pdsfxUniformsList))}_fillPDSFXUBO(e,t,s){this._PDSFXData._pdsfxUniformsList&&(this._refreshPDSFXUniforms_private(t,s),t.fillUBOGeneric(e,this._PDSFXData._pdsfxUniformsList))}setPDSFXOverridableFunctions(t,s){if(this.isPDSFX()){this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData._setPDSFXOverridableFunctions(t,s);var i=this._PDSFXData._extraDefines;i.opacity=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeOpacity!==e._ShaderChunk.PDSFXComputeOpacity_FS,i.opacity=i.opacity||this._PDSFXData.PDSFX_OverridableFunctions_FS.ProcessFinalColor!==e._ShaderChunk.PDSFXProcessFinalColor_FS,this.needsUpdate=!0}else console.warn("Not a PDSFX material: please call activatePDSFX() first.")}setBackMaterial(e){this.isBackMaterial?console.warn("You can't set a back material on a back material"):(this.backMaterial=e,null!==this.backMaterial&&(this.backMaterial.polygonOffset=!0,this.backMaterial.polygonOffsetFactor=-10,this.backMaterial.polygonOffsetUnits=-10,this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isBackMaterial=!0,this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||this.is2DLine&&!this.backMaterial.is2DLine?(console.warn("The back material you are using is not compatible with the main material: primitive types don't match"),this.backMaterial=null):this.needsUpdate=!0),this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())}setMappingOperator(t,s,i,a,r){if(t.length)switch(t){case"NONE":t=0;break;case"PLANAR":t=1;break;case"SPHERICAL":t=2;break;case"CUBIC":t=3;break;case"CYLINDRICAL":t=4;break;case"INFINITE_CYLINDRICAL":t=5;break;case"SPHERICAL_NORMALIZED":t=6;break;case"INFINITE_CYLINDRICAL_NORMALIZED":t=7;break;case"INFINITE_CYLINDRICAL_NORM_ANGLE_PRES":t=8;break;default:return void console.error("Unknown mapping operator "+t)}this.mappingType=t,void 0!==a&&(this.mappingUseFragment=a),s instanceof e.Matrix4&&(this.mappingObjTransformation=s,this.mappingObjTransformation.isIdentity()?(this.mappingObjTransformation=o,this.mappingNormTransformation=n):this.mappingNormTransformation=(new e.Matrix3).getInverse(s).transpose()),i instanceof e.Matrix3&&(this.mappingUVTransformation=i,this.mappingUVTransformation.isIdentity()&&(this.mappingUVTransformation=n)),void 0!==r&&(this.mappingTransformSemantic=r),this.needsUpdate=!0}getType(){return"Unknown"}areTexturesLoaded(){return!(this.map&&this._alphaTest&&!this.map._canBeUsed())}_sendEvent(e,t){t=t||{},i.publish({event:"/VISU/"+e,data:{eventChannel:"/VISU/"+e,eventType:"@"+e,extraData:t}})}setOpacity(e){(1===this._opacity&&e<1||this._opacity<1&&1===e||this._opacity>0&&0===e||0===this._opacity&&e>0)&&this._invalidateDisplayRangeLists(),this._opacity=e,this._revision++}setColor(e){void 0!==this.color&&void 0!==e&&(this.color=e,this._revision++)}getOpacity(){return this._opacity}setAlphaTest(e){this._alphaTest!==e&&(this.needsUpdate=!0,this._deferredMaterialsInit&&this.updateDeferredMaterials()),(0===this._alphaTest&&e>0||this._alphaTest>0&&0===e)&&this._invalidateDisplayRangeLists(),this._alphaTest=e}_inTransparentPass(e){return this.getOpacity()<1||this.transparent&&this._transparencyOnGPU(e)}setValues(t){void 0!==t&&(e.setValuesToObject(this,t,h),null!==this.backMaterial&&(this.backMaterial.polygonOffset=!0,this.backMaterial.polygonOffsetFactor=-10,this.backMaterial.polygonOffsetUnits=-10,this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isBackMaterial=!0,(this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||this.is2DLine&&!this.backMaterial.is2DLine)&&(console.warn("The back material you are using is not compatible with the main material: primitive types don't match"),this.backMaterial=null)),this.alphaTest&&this.alphaTestMode===e.AlphaTestMode.DISCARD&&(this.transparent=!0),null===this.mappingObjTransformation||this.mappingObjTransformation.isIdentity()?(this.mappingObjTransformation=o,this.mappingNormTransformation=n):this.mappingNormTransformation=(new e.Matrix3).getInverse(this.mappingObjTransformation).transpose(),(null===this.mappingUVTransformation||this.mappingUVTransformation.isIdentity())&&(this.mappingUVTransformation=n))}_canUseLights(){return!0}clone(e){return void 0===e&&(e=new p),e.name=this.name,e.side=this.side,e.forceSide=this.forceSide,e._opacity=this._opacity,e.transparent=this.transparent,e.blending=this.blending,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.useGASColor=this.useGASColor,e._isFromGAS=this._isFromGAS,e.depthTest=this.depthTest,e.depthFunc=this.depthFunc,e.depthWrite=this.depthWrite,e.colorWrite=this.colorWrite,e.defines=this.defines?Object.assign({},this.defines):null,e.polygonOffset=this.polygonOffset,e.polygonOffsetFactor=this.polygonOffsetFactor,e.polygonOffsetUnits=this.polygonOffsetUnits,e.polite=this.polite,e.politeMaterial=this.politeMaterial,e.alphaTest=this.alphaTest,e.alphaTestMode=this.alphaTestMode,e._disableForcedAlphaTest=this._disableForcedAlphaTest,e.visible=this.visible,e.force=this.force,e.vertexColors=this.vertexColors,e.enableClipPlanes=this.enableClipPlanes,e.clipPlaneIndex=this.clipPlaneIndex,e.clipPlaneUseModelMaterial=this.clipPlaneUseModelMaterial,e.overridable=this.overridable,e.mappingType=this.mappingType,e.mappingUseFragment=this.mappingUseFragment,e.mappingNormTransformation=this.mappingNormTransformation,e.mappingObjTransformation=this.mappingObjTransformation,e.mappingUVTransformation=this.mappingUVTransformation,this._definePickingInstancing&&(e._definePickingInstancing=this._definePickingInstancing),this._PDSFXData&&(e._PDSFXData=this._PDSFXData.clone(),this.refreshPDSFXUniforms&&(e.refreshPDSFXUniforms=this.refreshPDSFXUniforms),this._refreshPDSFXUniforms_private&&(e._refreshPDSFXUniforms_private=this._refreshPDSFXUniforms_private)),e.backMaterial=this.backMaterial,e.isBackMaterial=this.isBackMaterial,e.previousOccurrenceRenderingOverride=this.previousOccurrenceRenderingOverride,e.useBlending=this.useBlending,e.program=this.program,e.enableReceiveShadowOnCapping=this.enableReceiveShadowOnCapping,e._renderedClipPlane=this._renderedClipPlane,e.line=this.line,e.point=this.point,e.isWideLine=this.isWideLine,e.isDashedLine=this.isDashedLine,e.is2DLine=this.is2DLine,e.isCPUPattern=this.isCPUPattern,e.refreshUniforms=this.refreshUniforms,e._isAlteringGeometryOnGPU=this._isAlteringGeometryOnGPU,e._cloneOrigin=this._cloneOrigin||this,e}updateDeferredMaterials(e){this._deferredMaterialsInit=!0}getGeomTypeDeferredMaterial(e,t){return this}dispose(){this.dispatchEvent({type:"dispose"})}_needsIBLLightExtraction(){return!1}_forceOpaqueShadowMapPass(){return!1}recompileShaders(e,t){if(t&&t.onlyDeferred||(t&&t.callback&&t.callback(this),this.needsUpdate=!0),this._deferredMaterialsInit){var s=this._deferredMaterials,i=t?t.deferredChannels:null;if(i&&i.length>0)for(var a=0;a<i.length;a++){(r=s[i[a]])&&(t&&t.callback&&t.callback(r),r.needsUpdate=!0)}else for(a=0;a<s.length;a++){var r;(r=s[a])&&(t&&t.callback&&t.callback(r),r.needsUpdate=!0)}}e&&(this.line&&this.line.recompileShaders(!1,t),this.point&&this.point.recompileShaders(!1,t))}getBaseId(){var e="id";return this.isPDSFX()&&(e+="PDSFX"),e}getPredefinedMaterial(t,i,a){if(i===e.DefaultAppearanceMode.BASIC)return this;var r=this,n=s._loadPredefinedMaterialTextures(!0,(function(){r._sendEvent("requestVisuUpdate")}),!1),o=this.getBaseId();switch(o+="Lighted",o+="S"+this.side,o+="CP"+this.enableClipPlanes,o+="Type"+i,i){case e.DefaultAppearanceMode._GASLOOK_OLD:if(o+="Col"+this.color.getHex(),o="id"+(o+="O"+this._opacity).hashCode(),!s.PredefinedMaterials.has(o)){(c=new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.576,roughness:.3,color:this.color,opacity:this._opacity})).activatePDSFX("PDSFXGASLook");var h={noiseVolume:{type:"t2",value:t}};c.setPDSFXUniforms(h);c.setPDSFXVaryings({noiseCoords:{type:"v3"}});c.setPDSFXGlobalShaderCode(null,(function(e){const t=e.variableHandler,s=e.functionHandler,i=e.bridgeFunctions,a=t=>e.getTextureUniform(t),r=e=>t.float(e),n=e=>t.floatC(e),o=e=>t.vec2(e),l=e=>t.vec4(e);return`\n                                ${n("SLICE_SIDE")} = 64.0;\n                                ${n("SLICES_PER_ROW")} = 8.0;\n                                ${n("INV_SLICES_PER_ROW")} = 1.0 / SLICES_PER_ROW;\n                                // 1 / 512\n                                ${n("MAP_INVSIZE")} = 0.001953125;\n\n                                ${s.dF("sample3DTexture","v4",[s.prmV3("iPos")])} {\n                                    ${h="pos",t.vec3(h)} = iPos * (SLICE_SIDE - 1.0);\n    \n                                    ${r("rowID")}  = floor(pos.z * INV_SLICES_PER_ROW);\n                                    ${r("rowID2")}  = rowID;\n                                    ${r("colID")}  = ${i.modulo("floor(pos.z)","SLICES_PER_ROW")};\n                                    ${r("colID2")}  = ${i.modulo("ceil(pos.z)","SLICES_PER_ROW")};\n                                    if (colID2 == 0.0) { \n                                        rowID2 = rowID2 + 1.0; \n                                    }\n            \n                                    ${r("x1")}  = colID  * SLICE_SIDE + pos.x + 0.5;\n                                    ${r("x2")}  = colID2 * SLICE_SIDE + pos.x + 0.5;\n                                    ${r("y1")}  = rowID  * SLICE_SIDE + pos.y + 0.5;\n                                    ${r("y2")}  = rowID2 * SLICE_SIDE + pos.y + 0.5;\n                                    ${o("mapUV")}   = ${o()}(x1 * MAP_INVSIZE, 1.0 - y1 * MAP_INVSIZE);\n                                    ${o("mapUV2")}  = ${o()}(x2 * MAP_INVSIZE, 1.0 - y2 * MAP_INVSIZE);\n                                    ${l("alpha1")}  = ${i.sample2DTexture(a("noiseVolume"),"mapUV")};\n                                    ${l("alpha2")}  = ${i.sample2DTexture(a("noiseVolume"),"mapUV2")};\n            \n                                    return mix(alpha1, alpha2, fract(pos.z));\n                                }\n                            `;var h}));var p={ComputeViewNormal:function(e,t){const s=e.variableHandler,i=e.functionHandler,a=e=>s.vec3(e);return`\n                                    ${a("vNormal")} = ${e.vGetViewNormal()};\n\n                                    ${a("bumpNorm")}  = ${i.cF("sample3DTexture","v4",[i.prmV3("fract(noiseCoords * 0.5)")])}.xxx * 0.04;\n                                    bumpNorm = (${e.vGetViewMatrix()} * ${s.vec4(r)}(bumpNorm, 0.0)).xyz;\n        \n                                    vNormal += bumpNorm;\n                                    vNormal = normalize(vNormal);\n    \n                                    return vNormal;\n                                `;var r}};c.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                                    ${e.getVarying("noiseCoords")} = ${e.vGetAttribPosition()};\n                                `}},p);var u=new s.DeferredMaterial(c);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.GASLOOK:if(o+="Col"+this.color.getHex(),o="id"+(o+="O"+this._opacity).hashCode(),!s.PredefinedMaterials.has(o)){var c=new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.5,roughness:.3,color:(new e.Color).set(this.color).multiplyScalar(.85),opacity:this._opacity,clearCoat:.918,clearCoatRoughness:.1,_isFromGAS:!0});u=new s.DeferredMaterial(c);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode._TRANSPARENT:if(o="id"+(o+="Col"+this.color.getHex()).hashCode(),!s.PredefinedMaterials.has(o)){u=new s.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:this.color,opacity:.25,transparent:!0,roughness:.34,ior:1.5,_isFromGAS:!0}));s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.CLAY:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){u=new s.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.64,.34,.26),specular:(new e.Color).setRGB(.996,.851,.694),roughness:.41,ior:1.5,overridable:!1,_allowFullMaterialOverride:1}));s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.WHITE_MAT_PLASTER:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){u=new s.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.922,.922,.922),roughness:1,ior:1.5,overridable:!1,_allowFullMaterialOverride:1}));s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.GREY_SHINY_PLASTIC:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){u=new s.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.584,.584,.584),roughness:.045,ior:1.5,overridable:!1}));s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.CAST_ALUMINUM:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){(d=new e.DSPBR19xMaterial({color:11184810,map:n[6],side:this.side,normalMap:n[7],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.6,roughnessMap:n[8],ior:1.5,overridable:!1,_allowFullMaterialOverride:1})).setMappingOperator(e.MappingType.CUBIC,null,l,!0);u=new s.DeferredMaterial(d);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.MACHINED_ALUMINUM:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){(d=new e.DSPBR19xMaterial({color:11184810,map:n[14],side:this.side,normalMap:n[15],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.6,roughnessMap:n[16],ior:1.5,overridable:!1,_allowFullMaterialOverride:1})).setMappingOperator(e.MappingType.CUBIC,null,l,!0);u=new s.DeferredMaterial(d);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.CAST_STEEL:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){(d=new e.DSPBR19xMaterial({color:8947848,map:n[9],side:this.side,enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:n[10],ior:1.5,overridable:!1,_allowFullMaterialOverride:1})).setMappingOperator(e.MappingType.CUBIC,null,l,!0);u=new s.DeferredMaterial(d);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.BRUSHED_STEEL:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){(d=new e.DSPBR19xMaterial({color:11184810,map:n[2],side:this.side,normalMap:n[4],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.15,roughnessMap:n[5],anisotropyMap:n[3],anisotropyAngle:.14,ior:1.5,overridable:!1,_allowFullMaterialOverride:1})).setMappingOperator(e.MappingType.CUBIC,null,l,!0);u=new s.DeferredMaterial(d);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){(d=new e.DSPBR19xMaterial({color:11184810,map:n[17],side:this.side,normalMap:n[18],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.15,roughnessMap:n[19],anisotropy:.17,anisotropyAngle:.09,ior:1.5,overridable:!1,_allowFullMaterialOverride:1})).setMappingOperator(e.MappingType.CUBIC,null,l,!0);u=new s.DeferredMaterial(d);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.COPPER:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){(d=new e.DSPBR19xMaterial({color:13809841,map:n[11],side:this.side,normalMap:n[12],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:n[13],ior:1.5,overridable:!1,_allowFullMaterialOverride:1})).setMappingOperator(e.MappingType.CUBIC,null,l,!0);u=new s.DeferredMaterial(d);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.BRASS:if(o="id"+o.hashCode(),!s.PredefinedMaterials.has(o)){var d;(d=new e.DSPBR19xMaterial({color:14472604,map:n[0],side:this.side,enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:n[1],ior:1.5,overridable:!1,_allowFullMaterialOverride:1})).setMappingOperator(e.MappingType.CUBIC,null,l,!0);u=new s.DeferredMaterial(d);s.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.GENERIC_PLASTIC:case e.DefaultAppearanceMode.GENERIC_METAL:var f=a.colorFromGAS;if(f){if(o+="Col"+this.color.getHex(),o="id"+(o+="O"+this._opacity).hashCode(),!s.PredefinedMaterials.has(o)){u=new s.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.5,color:this.color,opacity:this._opacity,opacityAddCoef:0,opacityMulCoef:1,_allowFullMaterialOverride:1,overridable:!0,_isFromGAS:!0}));s.PredefinedMaterials.set(o,u)}}else if(o+="ColCustom",o="id"+(o+="OCustom").hashCode(),!s.PredefinedMaterials.has(o)){u=new s.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.5,opacityAddCoef:0,opacityMulCoef:1,_allowFullMaterialOverride:1}));s.PredefinedMaterials.set(o,u)}(c=s.PredefinedMaterials.get(o).get(this)).metalness=i===e.DefaultAppearanceMode.GENERIC_PLASTIC?0:1,c.roughness=1-a.shininess,c.opacityMulCoef=a.opacity,c._transparent=c._opacity<1||a.opacity<1,f||c.color.copy(a.color);break;case e.DefaultAppearanceMode.__QA_AUTOMATION__:var m=this.map||0===this.color.getHex()?new e.Color(11184810):this.color,C=this.opacityMap?1:this._opacity;if(o+="Col"+m.getHex(),o="id"+(o+="Op"+C).hashCode(),!s.PredefinedMaterials.has(o)){(c=new e.MeshBasicMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:m,opacity:C})).activatePDSFX("PDSFXLightedQAAutomation");p={ProcessFinalColor:function(e,t){const s=e.variableHandler,i=e.pdsfxDefines,a=e=>s.vec3(e),r=e=>s.vec4(e),n=s.dereference(t[0]);return`\n                                    ${a("color")} = ${e.vGetAlbedo()};\n                                    ${o="viewMat",s.mat4(o)}  = ${e.vGetViewMatrix()};\n                                    ${a("light1")}  = normalize((viewMat*${r()}(0.0,0.0,1.0,0.0)).xyz);\n                                    ${a("light2")}  = normalize((viewMat*${r()}(0.0,-1.0,-1.0,0.0)).xyz);\n                                    ${a("light3")}  = normalize((viewMat*${r()}(0.0,1.0,-1.0,0.0)).xyz);\n                                    ${a("viewNorm")}  = ${e.vGetViewNormal()};\n                                    ${(e=>s.float(e))("ambientCoef")}  = 0.11;\n                                    color = 2.0 * color * (ambientCoef + 0.44*clamp(dot(viewNorm, light1), 0.0, 1.0) + 0.22*clamp(dot(viewNorm, light2), 0.0, 1.0) + 0.22*clamp(dot(viewNorm, light3), 0.0, 1.0));\n                                    ${n} = ${r()}(color, ${e.vGetOpacity()});\n                                    ${i.gammaOutput?`\n                                        ${n}.r = sqrt(${n}.r);\n                                        ${n}.g = sqrt(${n}.g);\n                                        ${n}.b = sqrt(${n}.b);\n                                        `:""}\n                                `;var o}};c.setPDSFXOverridableFunctions({},p);u=new s.DeferredMaterial(c);s.PredefinedMaterials.set(o,u)}}return s.PredefinedMaterials.get(o).get(this)}loadGlobalUniforms(e,t,s){}loadUniformsLights(e,t,s,i){}loadUniforms(e,t,s,i,a,r){}fillGlobalUBO(e,t){}fillLightsUBO(e,t){}fillUBO(e,t){}fillUBOHigh(e,t,s,i,a){}buildUniformsList(){}__getGAS(e){return this}_setUniformLocations(t,s,i,r){var n=s.objectUniformLocations,o=s.globalUniformLocations,l=s.postProUniformLocations,h=s.lightUniformLocations,p=s.shadowUniformLocations,u=s.clippingUniformLocations,c=s.pdsfxUniformLocations,d=s.uniformLocations;if(2===e.WebGLVersion){var f=t.getUniformBlockIndex(i,"FrameUBO");t.uniformBlockBinding(i,f,a.FRAME)}for(var m in r){var C=r[m],S=t.getUniformLocation(i,m),M=C.locationName?C.locationName:m;S&&(C.dynamic?C.globalUniform?o[M]=S:C.objectUniform?n[M]=S:C.lightUniform?h[M]=S:C.shadowUniform?p[M]=S:C.postProUniform?l[M]=S:C.clippingUniform?u[M]=S:C.pdsfxUniform?c[M]=S:C.materialUniform?d[M]=S:console.warn("Unknown uniform category "+m+" "+C):d[M]=S)}}_deallocate(t){if(this._deferredMaterialsInit){var s=e.MaterialToUse;e.cleanDeferredCache(this.id),this._deferredMaterialsInit=!1,this._deferredMaterials=[];for(var i=0;i<s.totalMaterial;i++)this._deferredMaterials[i]=null;this._deferredMaterials[s.originalMaterial]=this,this.backMaterial&&this._deferredMaterials[s.pickingMaterial]&&this._deferredMaterials[s.pickingMaterial].dispose()}this.needsUpdate=!0}getZOnlyMaterial(t){var i=this.transparent||this._opacity<1,a="ZOnly-Tr"+i;if(a="id"+a.hashCode(),s.DefaultMaterials.has(a))return s.DefaultMaterials.get(a).get(this);var r=new e.MeshBasicMaterial({force:!0});r.blending=e.CustomBlending,r.useBlending=!0,r.blendDst=t.blendingFactors.ONE,r.blendSrc=t.blendingFactors.ZERO,r.transparent=i,r._opacity=i?.5:1,r.overridable=!1;var n=new s.DeferredMaterial(r);return s.DefaultMaterials.set(a,n),n.get(this)}_getLightsKey(e){return 0}_getLightsUBOCache(e){return e.lightBindingGroupCache}}return p.prototype.__dimension=2,p.prototype.targetPrimitiveType="FACES",p.prototype._shaderID=null,p.prototype.deferrable=!1,p.prototype.isPhysicalMaterial=!1,p.prototype._autoForceSide=!1,p.prototype.__dontUseUVAttributes=!1,p.prototype._usePhongLighting=!1,p.prototype._hasDGUniform=!1,p.prototype._hasClippingUniform=!1,p.prototype._sideMatters=!0,p})),define("DS/Materials/PostProMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material","DS/Materials/PDSFXData"],(function(e,t,s){"use strict";class i extends t{constructor(e){if(!e||!e.postProContext)throw"Invalid Operation: PostProMaterial requires as PostProContext";super(),this.postProContext=null,this.setValues(e),this.useMSAA=!1;var t=this.postProContext;if(this.postProBuilder=t.getShaderBuilder(),this.uniformHandler=t.getUniformHandler(),this.defines=t.getDefines(),this.force=!0,this.polygonOffset=!0,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,e&&!this.postProBuilder)throw"Invalid Operation Exception: ProProMaterial needs a postProBuilder";this.enableClipPlanes=!1}getType(){return"Custom"}enableMSAA(e){this.useMSAA!==e&&(this.useMSAA=e,this.needsUpdate=!0)}getPredefinedMaterial(e,t,s){return this}_inTransparentPass(e){return this.transparent}setUniform(e,t){e&&void 0!==t&&void 0!==this.uniformHandler[e]&&(this.uniformHandler[e]=t)}getUniform(e){return e&&void 0!==this.uniformHandler[e]?this.uniformHandler[e]:null}getInput(e=0){return this.uniformHandler.getInput(e)}setInput(e,t=0){this.uniformHandler.setInput(e,t)}setLinkedInput(e,t=0){this.uniformHandler.setLinkedInput(e,t)}clone(e){var t=void 0!==e?e:new i({postProContext:this.postProContext});super.clone(t);var s=this.postProContext;return t.postProBuilder=s.getShaderBuilder(),t.uniformHandler=s.getUniformHandler(),t.defines=s.getDefines(),t.useMSAA=this.useMSAA,t}_computeAmbianceKeyAndProcessMaterial(e,t,s,i,a){return this._revision++,super._computeAmbianceKeyAndProcessMaterial(e,t,s,i,a)}loadUniforms(e,t,s,i,a,r){this.uniformHandler.loadUniforms(this,e,t,s,i,a,r)}fillUBO(e,t){this.uniformHandler.fillUBO(e,this,t)}activatePDSFX(e=null){throw"Unsupported operation: PostProMaterial can't be PDSFXed, please use a standard material."}_canUseLights(){return!1}_dump(){throw"Unsupported operation"}}return i.prototype._shaderID="custom",i})),define("DS/Materials/GradientBackgroundMaterials",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],(function(e,t){"use strict";class s extends t{constructor(e){super(),this.colors=null,this.YUp=0,this.setValues(e)}clone(){throw"Unsupported operation"}getPredefinedMaterial(e,t,s){return this}loadUniforms(e,t,s,i,a,r){t.uniform1i(s.YUp,this.YUp),t.uniform3fv(s.colors,this.colors)}fillUBO(e,t){const s=e.layout;e.setI(s.YUp,this.YUp),e.setFlatV3Array(s.colors,this.colors)}getType(){throw"Abstract Gradient material"}}class i extends s{constructor(e){super(e)}getType(){return"GradientBackground2"}}i.prototype._shaderID="gradient2";class a extends s{constructor(e){super(e)}getType(){return"GradientBackground3"}}a.prototype._shaderID="gradient3";class r extends s{constructor(e){super(e),this.skylineFading=0,this.horizonHeight=0,this.setValues(e)}getType(){return"GradientBackground4"}loadUniforms(e,t,s,i,a,r){return super.loadUniforms(e,t,s,i,a,r),t.uniform1f(s.skylineFading,this.skylineFading),t.uniform1f(s.horizonHeight,this.horizonHeight),!0}fillUBO(e,t){super.fillUBO(e,t);const s=e.layout;e.setF(s.skylineFading,this.skylineFading),e.setF(s.horizonHeight,this.horizonHeight)}}return r.prototype._shaderID="gradient4",{GradientBackgroundMaterial2:i,GradientBackgroundMaterial3:a,GradientBackgroundMaterial4:r}})),define("DS/Materials/ShaderMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],(function(e,t){"use strict";class s extends t{constructor(e){super(),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms={},this.varyings={},this.defines={},this.attributes={},this.shaderID=-1,this.uniformsList=null,this.map=null,this.setValues(e),this.enableClipPlanes=!1}_getTextures(e){var t=super._getTextures(e);return t=t.concat([this.map])}getType(){return"Custom"}getPredefinedMaterial(e,t,s){return this}_inTransparentPass(e){return this.getOpacity()<1||this.transparent}clone(t){var i=void 0!==t?t:new s;return super.clone(i),i.fragmentShader=this.fragmentShader,i.vertexShader=this.vertexShader,i.uniforms=e.CloneStructure(this.uniforms),i.varyings=e.CloneStructure(this.varyings),i.attributes=e.CloneStructure(this.attributes),i.shading=this.shading,i.uniformsList=this.uniformsList,i.map=this.map,i}buildUniformsList(){for(var e in null===this.uniformsList&&(this.uniformsList=new Map),this.uniforms){if(this.program.uniformLocations[e]){var t=this.uniforms[e];t.dynamic||this.uniformsList.set(e,t)}}}activatePDSFX(e=null){throw"Unsupported operation: ShaderMaterial can't be PDSFXed, please use a standard material."}_dump(){throw"Unsupported operation"}}return s.prototype._isDeprecatedMaterial=!0,s})),define("DS/Materials/DeferrableMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material","DS/Materials/PDSFXData"],(function(e,t,s){"use strict";class i extends t{constructor(){super()}updateDeferredMaterials(t){e.cleanDeferredCache(this.id);for(var s=0;s<this._deferredMaterials.length;s++)this._deferredMaterials[s]=this;this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterialsInit=!0}activatePDSFX(e=null){this._PDSFXData=new s,this._PDSFXData._uniqueID=e,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData._extraDefines={}}_setMaterialShaderOptions(e,t,s,i,a,r){super._setMaterialShaderOptions(e,t,s,i,a,r)}clone(e){return void 0===e&&(e=new i),super.clone(e),e}}return i.prototype.deferrable=!0,i})),define("DS/Materials/ParticleBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],(function(e,t,s,i){"use strict";class a extends t{constructor(t){super(),this.color=new e.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.hasSymbol=t&&t.hasSymbol,this.setValues(t)}_getTextures(e){var t=super._getTextures(e);return t=t.concat([this.map])}_dump(){var e=super._dump(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e.size=this.size,e}clone(){var e=new a;return super.clone(e),e.color.copy(this.color),e.map=this.map,e.size=this.size,e.sizeAttenuation=this.sizeAttenuation,e}setPointTexture(e){this.map=e,this._revision++}setPointSize(e){this.size=e,this._revision++}setPointSizeAttenuation(e){this.sizeAttenuation!==e&&(this.needsUpdate=!0,this.sizeAttenuation=e)}getType(){return this._isFromGAS?"GASPoint":"Point"}_canUseLights(){return!1}loadGlobalUniforms(e,t,s){}_setMaterialShaderOptions(e,t,s,i,a,r){super._setMaterialShaderOptions(e,t,s,i,a,r),e.WebGPU&&(e.usePointUV=!0)}loadUniforms(e,t,s,i,a,r){e.loadGASUniforms(t,this,s,i,a||this),s.colorBufferType&&t.uniform1f(s.colorBufferType,this.vertexColors),s.scale&&t.uniform1f(s.scale,e.domElement.height/2),s.size&&t.uniform1f(s.size,this.size?this.size:1),s.map&&e.loadTexture(t,s.map,this.map)}fillGlobalUBO(e,t){const s=e.layout;s.pixelSize&&e.setV2(s.pixelSize,t._pixelSize)}fillUBO(e,t){const s=e.layout;if(s.colorBufferType&&e.setF(s.colorBufferType,this.vertexColors),s.scale&&e.setF(s.scale,t.domElement.height/2),s.size&&e.setF(s.size,this.size?this.size:1),s.myViewportSize){let i=t.viewportData;e.setFlatV2(s.myViewportSize,i.viewportWidth,i.viewportHeight)}s.map&&e.setTexture(s.map,this.map),s.hasSymbol&&e.setF(s.hasSymbol,1)}fillUBOHigh(e,t,s,i,a){const r=e.layout,n=e.object.geometry.length?e.object.geometry[0]:e.object.geometry;if(t.fillGASUBO(e,this,s||this,a),r.startIndex){let t=n.indexOffsetGPU;e.setI(r.startIndex,e.token.start+t)}}getPredefinedMaterial(t,s,r){var n=this.getBaseId();if(n+="Point",n+="S"+this.side,n+="CP"+this.enableClipPlanes,n+="Type"+s,s!==e.DefaultAppearanceMode.__QA_AUTOMATION__)return this;if(n+="Col"+this.color.getHex(),n+="Op"+this._opacity,n="id"+(n+="SA"+this.sizeAttenuation).hashCode(),!i.PredefinedMaterials.has(n)){var o=new a({size:5,side:this.side,enableClipPlanes:this.enableClipPlanes,color:this.color,sizeAttenuation:this.sizeAttenuation,opacity:this._opacity});o.activatePDSFX("PDSFXParticleQAAutomation");o.setPDSFXOverridableFunctions({},{ProcessFinalColor:function(e,t){const s=e.variableHandler,i=e.pdsfxDefines,a=s.dereference(t[0]);return`\n                                    ${a} = ${s.vec4(r)}(${e.vGetAlbedo()}, ${e.vGetOpacity()});\n                                    ${i.gammaInput?`\n                                        ${a}.r = sqrt(${a}.r);\n                                        ${a}.g = sqrt(${a}.g);\n                                        ${a}.b = sqrt(${a}.b);\n                                        `:""}\n                                    ${i.gammaOutput?`\n                                        ${a}.r = sqrt(${a}.r);\n                                        ${a}.g = sqrt(${a}.g);\n                                        ${a}.b = sqrt(${a}.b);\n                                        `:""}\n                                `;var r}});var l=new i.DeferredMaterial(o);i.PredefinedMaterials.set(n,l)}return i.PredefinedMaterials.get(n).get(this)}getZOnlyMaterial(){return this}_defaultPDSFXOverridableFunctions(){var t=super._defaultPDSFXOverridableFunctions();return Object.assign(t.vertex,{ComputePointSize:e._ShaderChunk.PDSFXComputePointSize_VS}),t}updateDeferredMaterials(t){super.updateDeferredMaterials(t),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null,this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=null}}return a.prototype._shaderID="particle_basic",a.prototype.__dimension=0,a.prototype.targetPrimitiveType="POINTS",a.prototype.__dontUseUVAttributes=!0,a.prototype._hasDGUniform=!0,a.prototype._sideMatters=!1,a})),define("DS/Materials/MeshLambertMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],(function(e,t,s){"use strict";var i=new e.Color;class a extends t{constructor(t){super(),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this.map=null,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.shading=e.SmoothShading,this.wireframe=!1,this.morphTargets=!1,this.morphNormals=!1,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this.setValues(t)}setLambertProperties(e){this._revision++,(e=e||{}).color&&(this.color=e.color),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.map&&((e.map&&!this.map||!e.map&&this.map)&&(this.needsUpdate=!0),this.map=e.map),e.ambient&&(this.ambient=e.ambient),e.emissive&&(this.emissive=e.emissive),void 0!==e.specularMap&&((e.specularMap&&!this.specularMap||!e.specularMap&&this.specularMap)&&(this.needsUpdate=!0),this.specularMap=e.specularMap),void 0!==e.wrapAround&&(e.wrapAround!==this.wrapAround&&(this.needsUpdate=!0),this.wrapAround=e.wrapAround),e.wrapRGB&&(this.wrapRGB=e.wrapRGB),void 0!==e.envMap&&((e.envMap&&!this.envMap||!e.envMap&&this.envMap)&&(this.needsUpdate=!0),this.envMap=e.envMap),void 0!==e.combine&&(this.combine=e.combine),e.reflectivity>=0&&(this.reflectivity=e.reflectivity),e.refractionRatio>=0&&(this.refractionRatio=e.refractionRatio)}_getTextures(e){var t=super._getTextures(e);return t=t.concat([this.map,this.specularMap])}getType(){return"Lambert"}_getLightsKey(e){return e.lambert}_dump(){var e=super._dump();return e.color=this.color.toArray(),this.map&&(e.color="textured"),e}_transparencyOnGPU(e){return super._transparencyOnGPU(e)||this.map&&this.transparent}areTexturesLoaded(){return!!super.areTexturesLoaded()&&!(this.envMap&&!this.envMap._canBeUsed())}clone(){var e=new a;return super.clone(e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.shading=this.shading,e.wireframe=this.wireframe,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.numSupportedMorphTargets=this.numSupportedMorphTargets,e.numSupportedMorphNormals=this.numSupportedMorphNormals,e}_defaultPDSFXOverridableFunctions(){var e=super._defaultPDSFXOverridableFunctions();return delete e.fragment.ComputeAlbedo,e}_computeAmbianceKeyAndProcessMaterial(e,t,s,i,a){return super._computeAmbianceKeyAndProcessMaterial(e,t,s,i,a)}loadGlobalUniforms(e,t,s){if(s.invScreenSize){let i=e.viewportData;t.uniform2f(s.invScreenSize,i.viewportInvWidth/i.viewportScale,i.viewportInvHeight/i.viewportScale)}s.aoTexture&&(t.uniform2f(s.aoParams,e.ssaoParams.contrast,e.ssaoParams.power),e.loadTexture(t,s.aoTexture,e._getAOBufferResult()))}loadUniformsLights(e,t,s){e.loadUniformsLightsCommons(t,s,!0)}loadUniforms(e,t,s,a,r,n){var o;s.ambient&&(o=e.gammaInput?i.copyToLinear(this.ambient,e.simpleGamma):this.ambient,t.uniform3f(s.ambient,o.r,o.g,o.b)),s.emissive&&(o=e.gammaInput?i.copyToLinear(this.emissive,e.simpleGamma):this.emissive,t.uniform3f(s.emissive,o.r,o.g,o.b)),s.wrapRGB&&this.wrapAround&&t.uniform3f(s.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z),e.loadUniformsCommon(t,this,s,a,r,n),e.loadUniformsEnvMap(t,this,s)}fillGlobalUBO(e,t){const s=e.layout;if(s.invScreenSize){let i=t.viewportData;e.setFlatV2(s.invScreenSize,i.viewportInvWidth/i.viewportScale,i.viewportInvHeight/i.viewportScale)}s.aoTexture&&(e.setTexture(s.aoTexture,t._getAOBufferResult()),e.setFlatV2(s.aoParams,t.ssaoParams.contrast,t.ssaoParams.power))}fillLightsUBO(e,t){t.fillLightsUBOCommons(e,!0)}fillUBO(e,t){const s=e.layout;s.ambient&&e.setColor(s.ambient,this.ambient,t.gammaInput,t.simpleGamma),s.emissive&&e.setColor(s.emissive,this.emissive,t.gammaInput,t.simpleGamma),s.wrapRGB&&e.setV3(s.wrapRGB,this.wrapRGB),t.fillMaterialCommonsUBO(e,this),t.fillMaterialEnvMapUBO(e,this)}fillUBOHigh(e,t,s,i,a){t.fillMaterialHighFrequencyCommonsUBO(e,this,s,i,a)}get wireframe(){return this._wireframe}set wireframe(e){e!==this._wireframe&&this._invalidateDisplayRangeLists(),this._wireframe=e}}return a.prototype._shaderID="lambert",a.prototype._autoForceSide=!0,a.prototype._usePhongLighting=!0,a})),define("DS/Materials/AbstractAmbianceMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],(function(e,t){"use strict";return class extends t{constructor(t){super(),this.ambienceMatrix=new e.Matrix4,this.ambienceMatrix2=new e.Matrix4,this.useHDR=!1,this.useHDRFloat=!1,this.useSRGB=!1,this.useLatLongMap=!1,this.useAmbianceV2=!1,this.tEnvMap=null,this.tEnvMap2=null,this.useEnvMap2=!1,this.envMapExposure=1,this.envMapExposure2=1,this.blurCoef=0,this.intensity=1,this.invScreenSize=new e.Vector2,this.invSize=new e.Vector2,this.offset=new e.Vector2,this.startOffset=new e.Vector2,this.endOffset=new e.Vector2,this.ambient=new e.Color(16777215),this.backgroundColor=new e.Color(16777215),this.backgroundAlpha=1,this.groundPosition=new e.Vector3,this.groundPositionLowPart=new e.Vector3,this.groundPosition2=new e.Vector3,this.groundPosition2LowPart=new e.Vector3,this.groundNormal=new e.Vector3(0,0,1),this.groundHeight=new e.Vector3(0,0,.23),this.groundRadius=5e3,this.groundRadius2=5e3,this.groundOffset=0,this.groundScale=.78,this.groundScale2=.78,this.transitionCoef=0,this.withGround=0,this.withPlane=0,this.planeColor=new e.Color(16777215),this.tFlip=-1,this.cameraSize=new e.Vector3,this.cameraSight=new e.Vector3,this.cameraUp=new e.Vector3,this.cameraRight=new e.Vector3,this.sceneHeight=new e.Vector3(0,0,.15),this.near=1,this.right=1,this.up=1,this.projectionConic=1,this.defines={},this.enableClipPlanes=!1,this.setValues(t),t&&t.defines&&Object.assign(this.defines,t.defines)}clone(){throw"Unsupported operation"}setUseEnvMap2(e){this.useEnvMap2!==e&&(this.useEnvMap2=e,this.needsUpdate=!0)}setUseLatLongMap(e){this.useLatLongMap!==e&&(this.useLatLongMap=e,this.needsUpdate=!0)}setUseAmbianceV2(e){this.useAmbianceV2!==e&&(this.useAmbianceV2=e,this.needsUpdate=!0)}setUseHDR(e){this.useHDR!==e&&(this.useHDR=e,this.needsUpdate=!0)}setUseSRGB(e){this.useSRGB!==e&&(this.useSRGB=e,this.needsUpdate=!0)}setUseHDRFloat(e){this.useHDRFloat!==e&&(this.useHDRFloat=e,this.needsUpdate=!0)}getPredefinedMaterial(e,t,s){return this}loadUniforms(e,t,s,i,a,r){t.uniform1f(s.envMapExposure,this.envMapExposure),t.uniform1f(s.tFlip,this.tFlip),t.uniform1f(s.groundRadius,this.groundRadius),t.uniform1f(s.groundScale,this.groundScale),t.uniform1f(s.groundOffset,this.groundOffset),t.uniform1f(s.projectionConic,this.projectionConic),t.uniform1f(s.up,this.up),t.uniform1f(s.right,this.right),t.uniform1f(s.near,this.near),t.uniform1f(s.intensity,this.intensity),t.uniform1f(s.withGround,this.withGround),t.uniform1f(s.blurCoef,this.blurCoef),t.uniform1f(s.envMapExposure2,this.envMapExposure2),t.uniform1f(s.groundRadius2,this.groundRadius2),t.uniform1f(s.groundScale2,this.groundScale2),t.uniform1f(s.transitionCoef,this.transitionCoef),t.uniform1f(s.withPlane,this.withPlane),t.uniform1f(s.backgroundAlpha,this.backgroundAlpha),t.uniform2f(s.startOffset,this.startOffset.x,this.startOffset.y),t.uniform2f(s.endOffset,this.endOffset.x,this.endOffset.y),t.uniform2f(s.invScreenSize,this.invScreenSize.x,this.invScreenSize.y),t.uniform2f(s.invSize,this.invSize.x,this.invSize.y),t.uniform2f(s.offset,this.offset.x,this.offset.y),t.uniform3f(s.ambient,this.ambient.r,this.ambient.g,this.ambient.b),t.uniform3f(s.groundPosition,this.groundPosition.x,this.groundPosition.y,this.groundPosition.z),t.uniform3f(s.groundPositionLowPart,this.groundPositionLowPart.x,this.groundPositionLowPart.y,this.groundPositionLowPart.z),t.uniform3f(s.groundPosition2,this.groundPosition2.x,this.groundPosition2.y,this.groundPosition2.z),t.uniform3f(s.groundPosition2LowPart,this.groundPosition2LowPart.x,this.groundPosition2LowPart.y,this.groundPosition2LowPart.z),t.uniform3f(s.groundNormal,this.groundNormal.x,this.groundNormal.y,this.groundNormal.z),t.uniform3f(s.groundHeight,this.groundHeight.x,this.groundHeight.y,this.groundHeight.z),t.uniform3f(s.cameraSize,this.cameraSize.x,this.cameraSize.y,this.cameraSize.z),t.uniform3f(s.cameraSight,this.cameraSight.x,this.cameraSight.y,this.cameraSight.z),t.uniform3f(s.cameraUp,this.cameraUp.x,this.cameraUp.y,this.cameraUp.z),t.uniform3f(s.cameraRight,this.cameraRight.x,this.cameraRight.y,this.cameraRight.z),t.uniform3f(s.sceneHeight,this.sceneHeight.x,this.sceneHeight.y,this.sceneHeight.z),t.uniform3f(s.planeColor,this.planeColor.r,this.planeColor.g,this.planeColor.b),t.uniform3f(s.backgroundColor,this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b),t.uniformMatrix4fv(s.ambienceMatrix,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix.elements)),t.uniformMatrix4fv(s.ambienceMatrix2,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix2.elements)),s.tEnvMap&&e.loadTexture(t,s.tEnvMap,this.tEnvMap),s.tEnvMap2&&e.loadTexture(t,s.tEnvMap2,this.tEnvMap2);var n=1,o=1;if(this.tEnvMap&&this.tEnvMap.hdr&&s.envMapHDRSize&&(this.tEnvMap.image?(n=parseInt(this.tEnvMap.image.width),o=parseInt(this.tEnvMap.image.height)):(n=parseInt(this.tEnvMap.width),o=parseInt(this.tEnvMap.height)),t.uniform2f(s.envMapHDRSize,n,o)),this.tEnvMap2&&(s.envMapHDRToMipsRatio||s.envMapHDRSize2)){var l=1;l=this.tEnvMap2.image?parseInt(this.tEnvMap2.image.width)/n:parseInt(this.tEnvMap2.width)/n,t.uniform1f(s.envMapHDRToMipsRatio,l),this.tEnvMap2.image?(n=parseInt(this.tEnvMap2.image.width),o=parseInt(this.tEnvMap2.image.height)):(n=parseInt(this.tEnvMap2.width),o=parseInt(this.tEnvMap2.height)),t.uniform2f(s.envMapHDRSize2,n,o)}}fillUBO(e,t){const s=e.layout;s.envMapExposure&&e.setF(s.envMapExposure,this.envMapExposure),s.tFlip&&e.setF(s.tFlip,this.tFlip),s.groundRadius&&e.setF(s.groundRadius,this.groundRadius),s.groundScale&&e.setF(s.groundScale,this.groundScale),s.groundOffset&&e.setF(s.groundOffset,this.groundOffset),s.projectionConic&&e.setF(s.projectionConic,this.projectionConic),s.up&&e.setF(s.up,this.up),s.right&&e.setF(s.right,this.right),s.near&&e.setF(s.near,this.near),s.intensity&&e.setF(s.intensity,this.intensity),s.withGround&&e.setF(s.withGround,this.withGround),s.blurCoef&&e.setF(s.blurCoef,this.blurCoef),s.envMapExposure2&&e.setF(s.envMapExposure2,this.envMapExposure2),s.groundRadius2&&e.setF(s.groundRadius2,this.groundRadius2),s.groundScale2&&e.setF(s.groundScale2,this.groundScale2),s.transitionCoef&&e.setF(s.transitionCoef,this.transitionCoef),s.withPlane&&e.setF(s.withPlane,this.withPlane),s.backgroundAlpha&&e.setF(s.backgroundAlpha,this.backgroundAlpha),s.startOffset&&e.setFlatV2(s.startOffset,this.startOffset.x,this.startOffset.y),s.endOffset&&e.setFlatV2(s.endOffset,this.endOffset.x,this.endOffset.y),s.invScreenSize&&e.setFlatV2(s.invScreenSize,this.invScreenSize.x,this.invScreenSize.y),s.invSize&&e.setFlatV2(s.invSize,this.invSize.x,this.invSize.y),s.offset&&e.setFlatV2(s.offset,this.offset.x,this.offset.y),s.ambient&&e.setFlatV3(s.ambient,this.ambient.r,this.ambient.g,this.ambient.b),s.groundPosition&&e.setFlatV3(s.groundPosition,this.groundPosition.x,this.groundPosition.y,this.groundPosition.z),s.groundPositionLowPart&&e.setFlatV3(s.groundPositionLowPart,this.groundPositionLowPart.x,this.groundPositionLowPart.y,this.groundPositionLowPart.z),s.groundPosition2&&e.setFlatV3(s.groundPosition2,this.groundPosition2.x,this.groundPosition2.y,this.groundPosition2.z),s.groundPosition2LowPart&&e.setFlatV3(s.groundPosition2LowPart,this.groundPosition2LowPart.x,this.groundPosition2LowPart.y,this.groundPosition2LowPart.z),s.groundNormal&&e.setFlatV3(s.groundNormal,this.groundNormal.x,this.groundNormal.y,this.groundNormal.z),s.groundHeight&&e.setFlatV3(s.groundHeight,this.groundHeight.x,this.groundHeight.y,this.groundHeight.z),s.cameraSize&&e.setFlatV3(s.cameraSize,this.cameraSize.x,this.cameraSize.y,this.cameraSize.z),s.cameraSight&&e.setFlatV3(s.cameraSight,this.cameraSight.x,this.cameraSight.y,this.cameraSight.z),s.cameraUp&&e.setFlatV3(s.cameraUp,this.cameraUp.x,this.cameraUp.y,this.cameraUp.z),s.cameraRight&&e.setFlatV3(s.cameraRight,this.cameraRight.x,this.cameraRight.y,this.cameraRight.z),s.sceneHeight&&e.setFlatV3(s.sceneHeight,this.sceneHeight.x,this.sceneHeight.y,this.sceneHeight.z),s.planeColor&&e.setFlatV3(s.planeColor,this.planeColor.r,this.planeColor.g,this.planeColor.b),s.backgroundColor&&e.setFlatV3(s.backgroundColor,this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b),s.ambienceMatrix&&e.setM4(s.ambienceMatrix,this.ambienceMatrix),s.ambienceMatrix2&&e.setM4(s.ambienceMatrix2,this.ambienceMatrix2),s.tEnvMap&&e.setTexture(s.tEnvMap,this.tEnvMap),s.tEnvMap2&&e.setTexture(s.tEnvMap2,this.tEnvMap2);var i=1,a=1;if(this.tEnvMap&&this.tEnvMap.hdr&&s.envMapHDRSize&&(this.tEnvMap.image?(i=parseInt(this.tEnvMap.image.width),a=parseInt(this.tEnvMap.image.height)):(i=parseInt(this.tEnvMap.width),a=parseInt(this.tEnvMap.height)),s.envMapHDRSize&&e.setFlatV2(s.envMapHDRSize,i,a)),this.tEnvMap2&&(s.envMapHDRToMipsRatio||s.envMapHDRSize2)){var r=1;r=this.tEnvMap2.image?parseInt(this.tEnvMap2.image.width)/i:parseInt(this.tEnvMap2.width)/i,s.envMapHDRToMipsRatio&&e.setF(s.envMapHDRToMipsRatio,r),this.tEnvMap2.image?(i=parseInt(this.tEnvMap2.image.width),a=parseInt(this.tEnvMap2.image.height)):(i=parseInt(this.tEnvMap2.width),a=parseInt(this.tEnvMap2.height)),s.envMapHDRSize2&&e.setFlatV2(s.envMapHDRSize2,i,a)}}_setMaterialShaderOptions(e,t,s,i,a,r){super._setMaterialShaderOptions(e,t,s,i,a,r),e.envMap2=this.useEnvMap2,e.useHDR=this.useHDR,e.useHDRFloat=this.useHDRFloat,e.useSRGB=this.useSRGB,e.useLatLongMap=this.useLatLongMap,e.useAmbianceV2=this.useAmbianceV2}_computeAmbianceKeyAndProcessMaterial(e,t,s,i,a){return this._revision++,super._computeAmbianceKeyAndProcessMaterial(e,t,s,i,a)}_canUseLights(){return!1}areTexturesLoaded(){return!!super.areTexturesLoaded()&&(!(this.tEnvMap&&!this.tEnvMap._canBeUsed())&&!(this.tEnvMap2&&!this.tEnvMap2._canBeUsed()))}}})),define("DS/Materials/FiniteEnvMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],(function(e,t){"use strict";class s extends t{constructor(e){super(e)}getType(){return"FiniteEnvMap"}}return s.prototype._shaderID="finiteenvmap",s})),define("DS/Materials/SimpleMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],(function(e,t){"use strict";class s extends t{constructor(e){super(e)}getType(){return"SimpleMap"}}return s.prototype._shaderID="simplemap",s})),define("DS/Materials/FiniteTransitionEnvMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],(function(e,t){"use strict";class s extends t{constructor(e){super(e)}getType(){return"FiniteTransition"}}return s.prototype._shaderID="finitetransition",s})),define("DS/Materials/CubeMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],(function(e,t){"use strict";class s extends t{constructor(e){super(e)}getType(){return"CubeMap"}}return s.prototype._shaderID="cubemap",s})),define("DS/Materials/LatLongMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],(function(e,t){"use strict";class s extends t{constructor(e){super(e)}getType(){return"LatLongMap"}}return s.prototype._shaderID="latlong",s})),define("DS/Materials/MeshBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],(function(e,t,s,i){"use strict";class a extends t{constructor(t){super(),this.color=new e.Color(16777215),this.map=null,this.wireframe=!1,this._depthValue=0,this._sceneGraphOrderMode=0,this.morphTargets=!1,this.morphNormals=!1,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this.canvasNodeTextureSaveParams=null,this.setValues(t)}static call(e,t){console.warn("Old school inheritance on MeshBasicMaterial, please migrate to ES6 classes");var s=new a(t);Object.assign(e,s)}_getTextures(e){var t=super._getTextures(e);return t=t.concat([this.map])}setMap(e){this.map=e,this._revision++}getType(){return this._isFromGAS?"GASBasic":"Basic"}_dump(){var e=super._dump();return e.color=this.color.toArray(),this.map&&(e.color="textured"),e}_canUseLights(){return!1}_transparencyOnGPU(e){return super._transparencyOnGPU(e)||this.map&&this.transparent}getPredefinedMaterial(t,s,r){var n=this.getBaseId();if(n+="NonLighted",n+="S"+this.side,n+="CP"+this.enableClipPlanes,n+="Type"+s,s!==e.DefaultAppearanceMode.__QA_AUTOMATION__)return this;var o=this.map?new e.Color(11184810):this.color;if(n+="Col"+o.getHex(),n="id"+(n+="Op"+this._opacity).hashCode(),!i.PredefinedMaterials.has(n)){var l=new a({side:this.side,enableClipPlanes:this.enableClipPlanes,color:o,opacity:this._opacity});l.activatePDSFX("PDSFXBasicQAAutomation");l.setPDSFXOverridableFunctions({},{ProcessFinalColor:function(e,t){const s=e.variableHandler,i=e.pdsfxDefines,a=s.dereference(t[0]);return`\n                                    ${a} = ${s.vec4(r)}(${e.vGetAlbedo()}, ${e.vGetOpacity()});\n                                    ${i.gammaOutput?`\n                                        (${a}).r = sqrt((${a}).r);\n                                        (${a}).g = sqrt((${a}).g);\n                                        (${a}).b = sqrt((${a}).b);\n                                        `:""}\n                                `;var r}});var h=new i.DeferredMaterial(l);i.PredefinedMaterials.set(n,h)}return i.PredefinedMaterials.get(n).get(this)}clone(e){return e||(e=new a),super.clone(e),e.color.copy(this.color),e.map=this.map,e.wireframe=this.wireframe,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.numSupportedMorphTargets=this.numSupportedMorphTargets,e.numSupportedMorphNormals=this.numSupportedMorphNormals,e.canvasNodeTextureSize=this.canvasNodeTextureSize,e.canvasNodeTextureSaveParams=this.canvasNodeTextureSaveParams,e}loadUniforms(e,t,s,i,a,r){e.loadUniformsCommon(t,this,s,i,a,r),e.loadUniformsDepthLayer(t,this,s)}fillUBO(e,t){t.fillMaterialCommonsUBO(e,this),t.fillDepthLayerUBO(e,this)}fillUBOHigh(e,t,s,i,a){t.fillMaterialHighFrequencyCommonsUBO(e,this,s,i,a)}get wireframe(){return this._wireframe}set wireframe(e){e!==this._wireframe&&this._invalidateDisplayRangeLists(),this._wireframe=e}}return a.prototype._shaderID="basic",a})),define("DS/Materials/OutlineMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,s){"use strict";const i=s.BridgeFunctions,a=(e,t,i)=>s.FunctionHandler.callFunction(e,t,i),r="",n=function(e,t){const s=e.functionHandler,i=e.userDefines;return`\n                occluded = ${s.cF("correctZFighting","b",[])};           \n                ${i.OUTLINES_SHOW_OCCLUDED?`\n                    if (occluded) {\n                        ${e.vSetFragDepth("0.001")};\n                    } else {\n                        ${e.vSetFragDepth("0.0")};\n                    }\n                    `:r}\n            `},o=function(e,t){const s=e.variableHandler,i=e.functionHandler,r=e.bridgeFunctions,n=(e.pdsfxDefines,e.userDefines),o=n.NB_OUTLINE_MAPS,l=n.LAST_OUTLINE_MAP_SIZE_X,h=n.LAST_OUTLINE_MAP_SIZE_Y,p=n.MAX_OUTLINE_MAP_SIZE,u=(e,t,a)=>i.cF("sampleOutlineMaps","v4",[i.prmI(e),i.prmV2(`${s.vec2()}(${t}, ${a})`)]);function c(e){const t="_"+e;return`\n                ${s.float("dx"+t)} ;\n                ${s.float("dy"+t)} ;  \n                ${s.float("x"+t)} ; \n                ${s.float("y"+t)} ; \n                if (texIds[4 - ${e}] == ${o} - 1) {\n                    dx${t} = 1.0 / ${l};\n                    dy${t} = 1.0 / ${h};\n                    y${t} = floor(idInTexture${t}/${l});\n                    x${t} = idInTexture${t} - y${t}*${l};\n                } else {\n                    dx${t} = 1.0 / ${p};\n                    dy${t} = 1.0 / ${p};\n                    y${t} = floor(idInTexture${t}/${p});\n                    x${t} = idInTexture${t} - y${t}*${p};\n                }\n                `}return`      \n                ${s.vec3("_position")} = ${e.vGetAttribPosition()};\n                ${s.vec3("_normal")}  = ${e.vGetAttribNormal()};\n\n                ${s.vec4("texShiftMul")}  = ${s.vec4()}(65536.0, 4096.0, 256.0, 16.0);\n                ${s.vec4("texShiftDiv")}  = ${s.vec4()}(1.0/4096.0, 1.0/256.0, 1.0/16.0, 1.0);\n                ${s.ivec4("texIds")}  = ${s.ivec4()}(floor(${r.modulo(`${s.vec4()}(_normal.z)`,"texShiftMul")} * texShiftDiv));\n\n                ${s.float("idInTexture_1")}  = _position.x;\n                ${s.float("idInTexture_2")}  = _position.y;\n                ${s.float("idInTexture_3")}  = _position.z;\n                ${s.float("idInTexture_4")}  = _normal.x;\n\n                ${c(1)}\n                ${c(2)}\n                ${c(3)}\n                ${c(4)}\n\n                ${s.vec3("current")}  = ${u("texIds.w","dx_1 * ( x_1 + 0.5 )","dy_1 * ( y_1 + 0.5 )")}.xyz;\n                ${s.vec3("opposite")}  = ${u("texIds.z","dx_2 * ( x_2 + 0.5 )","dy_2 * ( y_2 + 0.5 ) ")}.xyz;\n                ${s.vec3("firstSide")}  = ${u("texIds.y","dx_3 * ( x_3 + 0.5 )","dy_3 * ( y_3 + 0.5 )")}.xyz;\n                ${s.vec3("secondSide")}  = ${u("texIds.x","dx_4 * ( x_4 + 0.5 )","dy_4 * ( y_4 + 0.5 )")}.xyz;\n\n                ${s.mat4("PM")}  = ${e.vGetProjectionMatrix()};\n\n                ${s.vec4("mv_current")}  = ${a("computeModelViewPosition","v4",[i.prmV3("current")])};\n                ${s.vec4("mv_opposite")}  = ${a("computeModelViewPosition","v4",[i.prmV3("opposite")])};\n                ${s.vec4("mv_firstSide")}  = ${a("computeModelViewPosition","v4",[i.prmV3("firstSide")])};\n                ${s.vec4("mv_secondSide")}  = ${a("computeModelViewPosition","v4",[i.prmV3("secondSide")])};\n                viewCurrent = mv_current.xyz / mv_current.w;\n                viewOpposite = mv_opposite.xyz / mv_opposite.w;\n                ${s.vec3("viewFirst")}  = mv_firstSide.xyz / mv_firstSide.w;\n                ${s.vec3("viewSecond")}  = mv_secondSide.xyz / mv_secondSide.w;\n\n                isPersp = PM[3][3] < 0.5;\n\n                newViewPosition = ${s.vec4()}(viewCurrent, 1.0);\n\n                ${s.vec3("mv_firstNormal")}  = normalize(cross(viewOpposite - viewCurrent, viewFirst - viewCurrent));\n                ${s.vec3("mv_secondNormal")}  = normalize(cross(viewSecond - viewCurrent, viewOpposite - viewCurrent));\n\n                isOutline=false;\n                if (isPersp) {\n                    isOutline = ${i.cF("isOutlinePerspective","b",[i.prmV3("viewCurrent"),i.prmV3("viewOpposite"),i.prmV3("viewFirst"),i.prmV3("viewSecond"),i.prmV3("mv_firstNormal"),i.prmV3("mv_secondNormal")])};\n                } else {\n                    isOutline = ${i.cF("isOutlineOrthographic","b",[i.prmV3("mv_firstNormal"),i.prmV3("mv_secondNormal")])};\n                }\n            `},l=function(e,t){const s=t[0],i=e.variableHandler;e.functionHandler;return`         \n                ${i.float("far")} = ${e.vGetNearFarLogFactor()}.y;\n                if (isPersp) {\n                    if (!isOutline) {\n                        //if both side normals are on the same side with respect to the camera plan\n                        newViewPosition *= ${i.vec4()}(1000000000.0*far, 1000000000.0*far, 1000000000.0*far, 1.0);\n                    }\n                } else {\n                    if (!isOutline) {\n                        //if both side normals are on the same side with respect to the camera plan\n                        newViewPosition.z = 1000000000.0*far; \n                    }\n                }\n                ${i.dereference(s)}.Position = newViewPosition.xyz;\n            `},h={VS_global:function(e){const t=e.variableHandler,s=e.functionHandler,i=e.bridgeFunctions,a=(e.pdsfxDefines,e.userDefines.NB_OUTLINE_MAPS);let n=r;for(let t=0;t<a;t++)n=`\n                        ${n}\n                        if (idInTextureArray == ${t}) {\n                            return ${i.sample2DTexture((o="outlinePositionMaps",l=t,e.getTextureUniform(o,l)),"texCoords")};\n                        }\n                    `;var o,l;return`\n                    ${t.bool("isOutline",0,"private")};\n                    ${t.vec4("newViewPosition",0,"private")};\n                    ${t.vec3("viewCurrent",0,"private")};\n                    ${t.vec3("viewOpposite",0,"private")};\n                    ${t.float("far",0,"private")};\n                    ${t.float("near",0,"private")};\n                    ${t.bool("isPersp",0,"private")};\n\n                    ${s.dF("isOutlinePerspective","b",[s.prmV3("viewCurrent"),s.prmV3("viewOpposite"),s.prmV3("viewFirstSide"),s.prmV3("viewSecondSide"),s.prmV3("mv_firstNormal"),s.prmV3("mv_secondNormal")])} {\n                        ${t.vec3("viewRayCurrent")} = normalize(viewCurrent);\n                        ${t.vec3("viewRayOpposite")} = normalize(viewOpposite);\n                        ${t.vec3("viewRayFirst")} = normalize(viewFirstSide);\n                        ${t.vec3("viewRaySecond")} = normalize(viewSecondSide);\n\n                        //first triangle\n                        ${t.float("dot_curr_first")}  = dot(viewRayCurrent,mv_firstNormal);\n                        ${t.float("dot_opp_first")}  = dot(viewRayOpposite,mv_firstNormal);\n                        ${t.float("dot_first_first")}  = dot(viewRayFirst,mv_firstNormal);\n        \n                        //second triangle\n                        ${t.float("dot_curr_second")}  = dot(viewRayCurrent,mv_secondNormal);\n                        ${t.float("dot_opp_second")}  = dot(viewRayOpposite,mv_secondNormal);\n                        ${t.float("dot_second_second")}  = dot(viewRaySecond,mv_secondNormal);\n        \n                        if (dot_curr_first*dot_opp_first > 0.0\n                            && dot_curr_first*dot_first_first > 0.0\n                            && dot_curr_second*dot_opp_second > 0.0\n                            && dot_curr_second*dot_second_second > 0.0)\n                        {\n                            if (dot_first_first*dot_second_second < 0.0) {\n                                return true;\n                            }\n                        }\n        \n                        return false;\n                    }\n\n                    ${s.dF("isOutlineOrthographic","b",[s.prmV3("mv_firstNormal"),s.prmV3("mv_secondNormal")])} {\n                        return mv_firstNormal.z*mv_secondNormal.z < 0.0;\n                    }\n\n                    ${s.dF("sampleOutlineMaps","v4",[s.prmI("idInTextureArray"),s.prmV2("texCoords")])} {\n                        ${n}\n                        return ${t.vec4()}(0.0, 0.0, 0.0, 0.0);\n                    }\n                `},FS_global:function(e){const t=e.variableHandler,s=e.functionHandler,n=e.bridgeFunctions,o=e.pdsfxDefines,l=(e.userDefines,t=>e.getTextureUniform(t)),h=t=>e.getUniform(t);let p=r;p=o.renderToFloatTexture?`\n                        ${s.dF("getNormalDepth","v4",[s.prmV2("coord")])} {\n                            ${t.vec4("res")}  = ${n.sample2DTexture(l("depthBuffer"),"coord")};\n                            ${t.vec3("normal")}  = normalize(2.0 * res.xyz - 1.0);\n                            ${t.float("depth")}  = res.w;\n                            if (depth < 0.01) {\n                                depth = 1.0;\n                            }\n                            return ${t.vec4()}(normal,depth);\n                        }\n\n                        ${s.dF("getPolygonOffset","f",[s.prmV2("coord"),s.prmV3("vN"),s.prmF("depth")])} {\n                            ${t.mat4("P")} = ${e.vGetProjectionMatrix()};\n                            ${t.bool("isPersp")}  = P[3][3] < 0.5;\n\n                            ${t.float("slopeFactor")} = 0.1;\n                            if (isPersp) {\n                                slopeFactor = 1.0;\n                            }\n\n                            ${t.vec2("sr")}  = 2.0 / ${h("depthMapSize")};\n                            ${t.vec2("vC")}  = (${e.vGetFragCoord()}.xy - 0.5) / ${h("depthMapSize")};\n                            vC = 2.0*vC - 1.0;\n\n                            ${t.float("K")}  = dot(${t.vec3()}(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);\n                            ${t.vec2("offset")}  = ${t.vec2()}(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);\n\n                            ${t.float("factor")}  = (-depth - 0.5 * (P[2][2] - 1.0)) / K;\n                            ${t.float("dFdxOfZ")}  = abs(offset.x * factor);\n                            ${t.float("dFdyOfZ")}  = abs(offset.y * factor);\n\n                            ${t.float("slope")}  = max(dFdxOfZ, dFdyOfZ);\n                            slope = min(max(slope, 1e-6), 1e-3);\n\n                            return (slope * slopeFactor) + (DEPTH_PRECISION * 1.5);\n                        }\n\n                        ${s.dF("getDepth","f",[s.prmV2("coord")])} {\n                            ${t.vec4("nDepth")}  = ${s.cF("getNormalDepth","v4",[s.prmV2("coord")])};\n                            ${t.float("offset")}  =  ${s.cF("getPolygonOffset","f",[s.prmV2("coord"),s.prmV3("nDepth.xyz"),s.prmF("nDepth.w")])};\n\n                            return nDepth.w + offset;\n                        }\n                    `:`\n                        ${s.dF("getDepth","f",[s.prmV2("coord")])} {\n                            ${t.vec4("rgba_depth")}  = ${n.sample2DTexture(l("depthBuffer"),"coord")};\n        \n                            ${t.float("depth")}  = ${a("unpackRGBA","f",[s.prmV4("rgba_depth")])};\n                            if (depth > 1e-6) {\n                                return depth + DEPTH_PRECISION;\n                            }\n                            return 1.0;\n        \n                        }\n                    `;const u=e.getVarying("cP");let c=r;for(let e=-1;e<=1;e++)for(let i=-1;i<=1;i++)c=`\n                            ${c}\n                            coordtoUse = coord + ${t.vec2()}(${t.float()}(${e}), ${t.float()}(${i})) * ${t.vec2()}(dx, dy);\n                            test += ${s.cF("depthSampleTest","f",[s.prmV2("coordtoUse"),s.prmF("delta"),s.prmF("depth")])};\n                        `;return`               \n                    ${t.bool("occluded",0,"private")};\n                    ${p}\n        \n                    ${s.dF("depthSampleTest","f",[s.prmV2("coord"),s.prmF("delta"),s.prmF("depth")])} {\n                        ${t.vec2("coordToUse")} = coord;     \n                        ${n.uvConvention("coordToUse")}\n                        ${t.float("fDepth")}  = ${s.cF("getDepth","f",[s.prmV2("coordToUse")])};\n                        if ( fDepth < depth ) {\n                            return delta;\n                        }\n                        return 0.0;\n                    }\n                    ${s.dF("correctZFighting","b",[])}{\n\n                        ${t.vec2("coord")}  = 0.5 + 0.5*${u}.xy/${u}.w; // \n                        ${t.vec2("coordtoUse")};\n                        ${t.float("depth")}  = ${i.setDepthWithConvention(`${u}.z/${u}.w`)};\n                        ${t.float("delta")}  = 1.0/9.0;\n                        ${t.float("test")}  = 0.0;\n        \n                        ${t.float("dx")}  = 0.5/${h("depthMapSize")}.x;\n                        ${t.float("dy")}  = 0.5/${h("depthMapSize")}.y;\n        \n                        ${c}\n                        // if at this point 80% of the tests failed, discard\n                        if (test > 0.8) {\n                            return true;\n                        }\n                        return false;\n                    }\n                `},SimpleOutlinesShader:{VS_overridables:{ComputeCommonValues:o,ProcessViewTangentSpace:l,ProcessClipSpacePosition:function(e,t){const s=e.variableHandler,i=t[0];return`\n                            ${e.getVarying("cP")} = ${s.dereference(i)};\n                        `}},FS_overridables:{ComputeCommonValues:n,ComputeAlbedo:function(e,t){return`\n                            return ${e.vGetAlbedo()};\n                        `},ComputeDiscard:function(e,t){return`        \n                            ${e.userDefines.OUTLINES_SHOW_OCCLUDED?"\n                                return false;\n                                ":"\n                                return occluded;\n                                "}\n                        `},ComputeOpacity:function(e,t){const s=e.variableHandler,i=e.userDefines;return`        \n                            ${s.float("op")} = ${e.vGetOpacity()};\n                            ${i.OUTLINES_SHOW_OCCLUDED?"\n                                if (occluded) {\n                                    return 0.3 * op;\n                                }\n                                ":r}\n                            return op;\n                        `}}},WideOutlinesShader:{VS_overridables:{ComputeCommonValues:o,ProcessViewTangentSpace:l,ProcessClipSpacePosition:function(e,t){const s=e.variableHandler,i=e.bridgeFunctions,a=t[0],r=t=>e.getUniform(t);return`\n                            ${s.mat4("PM")} = ${e.vGetProjectionMatrix()};\n                            if (isOutline) {\n                                ${s.float("sideExtrusion")}  = ${e.vGetAttribNormal()}.y;\n                                ${s.bool("isOpposite")}  = ${i.modulo("abs(sideExtrusion)","2.0")} == 0.0;\n\n                                ${s.vec4("mvpCurr")}  = PM*${s.vec4()}(viewCurrent,1.0);\n                                ${s.vec4("mvpOpp")}  = PM*${s.vec4()}(viewOpposite,1.0);\n\n                                //from wideLineClip chunk: in case curr or opp have a negative w component (i.e. behind the camera)\n                                ${s.vec2("testClip")}  = ${s.vec2()}(sign(mvpCurr.w + mvpCurr.z), sign(mvpOpp.w + mvpOpp.z));\n                                if ( testClip.x * testClip.y < 0.0 ){\n                                        ${s.float("a")} = (mvpCurr.w + mvpCurr.z)/((mvpCurr.w + mvpCurr.z) - (mvpOpp.w + mvpOpp.z));\n                                        if (testClip.y < 0.0) {\n                                            mvpOpp = (1.0 - a) * mvpCurr + a * mvpOpp;\n                                        } else {\n                                            mvpCurr = (1.0 - a) * mvpCurr + a * mvpOpp;\n                                        }\n                                    }\n\n                                //curr and opp in real pixel\n                                // in [0,w]x[0,h] in pixel\n                                ${e.getVarying("screenCurr")} = (mvpCurr.xy / mvpCurr.w + 1.0) / (2.0 * ${r("pixelSize")}); \n                                // in [0,w]x[0,h] in pixel\n                                ${e.getVarying("screenOpp")} = (mvpOpp.xy / mvpOpp.w + 1.0) / (2.0 * ${r("pixelSize")}); \n\n                                ${s.float("offset")} = sign(sideExtrusion) * ${r("outlineHalfWidth")};\n                                ${s.vec2("line")}  = normalize(${e.getVarying("screenOpp")} - ${e.getVarying("screenCurr")});\n                                ${s.vec2("lineNormal")}  = ${s.vec2()}(-line.y, line.x);\n\n                                ${s.vec2("px_pos")}  = ${e.getVarying("screenCurr")} + offset*lineNormal - ${r("outlineHalfWidth")}*line;\n\n                                ${s.vec3("ndcPos")}  = ${s.vec3()}((px_pos * (2.0 * ${r("pixelSize")}) - 1.0), mvpCurr.z/mvpCurr.w);\n\n\n                                //so the 4 vertices of the outline have the same curr and opp for fragment shader treatment\n                                if (isOpposite) {\n                                    ${s.vec2("tmp")} = ${e.getVarying("screenCurr")};\n                                    ${e.getVarying("screenCurr")} = ${e.getVarying("screenOpp")};\n                                    ${e.getVarying("screenOpp")} = tmp;\n                                }\n\n                                //Final position\n                                ${s.vec4("clipSpacePos")}  = ${s.vec4()}(ndcPos*mvpCurr.w, mvpCurr.w);\n                                ${s.dereference(a)} = clipSpacePos;\n                                ${e.getVarying("cP")} = mvpCurr;\n\n                            } else {\n                                ${s.dereference(a)}  = PM*newViewPosition;\n                            }\n                        `}},FS_overridables:{ComputeCommonValues:n,ComputeAlbedo:function(e,t){return`\n                            return ${e.vGetAlbedo()};\n                        `},ComputeDiscard:function(e,t){const s=e.variableHandler,i=e.userDefines,a=e.__internalOptions__.WebGPU?`fCoord.y = f32(${e.vGetViewportSize()}.y) - fCoord.y;`:r;return`        \n                            ${i.OUTLINES_SHOW_OCCLUDED?"\n                                return false;\n                                ":`\n                                if (occluded) {\n                                    return true;\n                                }\n                                ${s.bool("toDiscard")} = false;\n                                ${s.vec2("fCoord")}  = ${e.vGetFragCoord()}.xy;\n                                ${a}\n\n                                ${s.vec2("currOpp")}  = ${e.getVarying("screenOpp")} - ${e.getVarying("screenCurr")};\n                                ${s.vec2("currFcoord")}  = fCoord - ${e.getVarying("screenCurr")};\n                                ${s.vec2("oppFcoord")}  = fCoord - ${e.getVarying("screenOpp")};\n\n                                //round caps so each individual line can nicely connect to its neighbour\n                                if (dot(currOpp, currFcoord ) < 0.0) {\n                                    if (length(currFcoord) > ${e.getUniform("outlineHalfWidth")}) {\n                                        toDiscard = true;\n                                    }\n                                } else if (dot(-currOpp, oppFcoord ) < 0.0) {\n                                    if (length(oppFcoord) > ${e.getUniform("outlineHalfWidth")}) {\n                                        toDiscard = true;\n                                    }\n                                }\n                                return toDiscard;\n                                `}\n                        `},ComputeOpacity:function(e,t){const s=e.variableHandler,i=e.userDefines;return`        \n                            ${s.float("op")} = ${e.vGetOpacity()};\n                            ${i.OUTLINES_SHOW_OCCLUDED?"\n                                if (occluded) {\n                                    return 0.3 * op;\n                                }\n                                ":r}\n                            return op;\n                        `}}}};class p extends t{constructor(){super(),this.activatePDSFX("PDSFX"+this.getType()),this.enableClipPlanes=!0,this.depthTest=!1,this.depthWrite=!1,this.force=!0,this.color=new e.Color(0),this.occludedColor=new e.Color(11184810),this.showHidden=!1,this.transparent=!0,this._allowFullMaterialOverride=-1}getPredefinedMaterial(e,t,s){return this}setShowHiddenOutlines(e){this.showHidden!==!!e&&(this.showHidden=!!e,this.showHidden?this.defines.OUTLINES_SHOW_OCCLUDED=1:delete this.defines.OUTLINES_SHOW_OCCLUDED,this.depthTest=this.showHidden,this.needsUpdate=!0)}set wireframe(e){this._wireframe=!1}}p.prototype.__dimension=1;class u extends p{constructor(t,s){if(super(),this.setPDSFXGlobalShaderCode(h.VS_global,h.FS_global),this.setPDSFXOverridableFunctions(h.SimpleOutlinesShader.VS_overridables,h.SimpleOutlinesShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var i={occludedColor:{type:"v3",value:new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:s,length:this.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)}};this.setPDSFXUniforms(i)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({cP:{type:"v4"}}),this._refreshPDSFXUniforms_private=function(t,s){this.updatePDSFXUniform("occludedColor",new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)),t.requestRealDepthBuffer(),t.dBuffer&&(this.updatePDSFXUniform("depthBuffer",t.dBuffer),this.updatePDSFXUniform("depthMapSize",new e.Vector2(t.dBuffer.width,t.dBuffer.height)))}}getType(){return"Outline"}clone(){let e=new u;return super.clone(e),e}}class c extends p{constructor(t,s,i){if(super(),this.forceSide=!0,this.side=e.DoubleSide,this.setPDSFXGlobalShaderCode(h.VS_global,h.FS_global),this.setPDSFXOverridableFunctions(h.WideOutlinesShader.VS_overridables,h.WideOutlinesShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var a={occludedColor:{type:"v3",value:new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:s,length:this.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)},outlineHalfWidth:{type:"f",value:i},pixelSize:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(a)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({screenCurr:{type:"v2"},screenOpp:{type:"v2"},cP:{type:"v4"}}),this._refreshPDSFXUniforms_private=function(t,s){this.updatePDSFXUniform("occludedColor",new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)),this.updatePDSFXUniform("pixelSize",new e.Vector2(1/t.domElement.width,1/t.domElement.height)),t.requestRealDepthBuffer(),t.dBuffer&&(this.updatePDSFXUniform("depthBuffer",t.dBuffer),this.updatePDSFXUniform("depthMapSize",new e.Vector2(t.dBuffer.width,t.dBuffer.height)))}}getType(){return"WideOutline"}clone(){let e=new c;return super.clone(e),e}}return{_OutlineMaterial:u,_WideOutlineMaterial:c}})),define("DS/Materials/HatchingMaterials",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],(function(e,t){"use strict";function s(e,t,s){let i=`${t?t.getHex():-1}/${s?s.getHex():-1}/${e.clipPlaneIndex}`;e.autoColorMap||(e.autoColorMap=new Map);let a=e.autoColorMap.get(i);return a||(a=e.clone(),e.autoSpaceColor&&(a.spaceColor=t),e.autoStripesColor&&(a.stripesColor=s),e.autoColorMap.set(i,a)),e.autoSpaceColor||(a.spaceColor=e.spaceColor),e.autoStripesColor||(a.stripesColor=e.stripesColor),a.stripesDirection=e.stripesDirection,a.spaceWidth=e.spaceWidth,a.stripesWidth=e.stripesWidth,a.clipPlaneIndex=e.clipPlaneIndex,a}var i;class a extends t{constructor(t){super({side:e.FrontSide,force:!0}),this.activatePDSFX("PDSFXHatchingMesh");var s={planeU:{type:"v3",value:new e.Vector3(1,0,0)},planeV:{type:"v3",value:new e.Vector3(0,1,0)},hatchingDirection:{type:"v2",value:new e.Vector2(1,-1)},hatchingNormal:{type:"v2",value:new e.Vector2(-1,-1)},hatchingSpaceWidth:{type:"f",value:10},hatchingSpaceColor:{type:"v4",value:new e.Vector4(10,10,10,1)},hatchingLineWidth:{type:"f",value:1},hatchingLineColor:{type:"v4",value:new e.Vector4(0,0,0,1)}};this.setPDSFXUniforms(s);this.setPDSFXVaryings({_uv:{type:"v2"}});this.setPDSFXGlobalShaderCode((function(e){const t=e.variableHandler;return`\n                        ${s="_mvPosition",t.vec4G(s)};\n                    `;var s}),null);this.setPDSFXOverridableFunctions({ProcessViewTangentSpace:function(e,t){const s=e.variableHandler,i=s.dereference(t[0]);return`\n                            _mvPosition = ${s.vec4(a)}(${i}.Position, 0.0);\n                        `;var a},ComputeVaryingValues:function(e,t){const s=e.variableHandler,i=t=>e.getUniform(t),a=e=>s.vec2(e),r=e=>s.vec3(e),n=e=>s.vec4(e);return`                   \n                            ${o="VM",s.mat4(o)}  = ${e.vGetViewMatrix()};\n                            ${r("mvPlaneU")}  = (VM * ${n()}(${i("planeU")}, 0.0)).xyz;\n                            ${r("mvPlaneV")}  = (VM * ${n()}(${i("planeV")}, 0.0)).xyz;\n                            ${(t=>e.getVarying(t))("_uv")} = ${a()}(dot(_mvPosition.xyz, mvPlaneU), dot(_mvPosition.xyz, mvPlaneV))-${a()}(dot(VM[3].xyz, mvPlaneU), dot(VM[3].xyz, mvPlaneV));\n                        `;var o}},{ProcessFinalColor:function(e,t){const s=e.variableHandler,i=e.bridgeFunctions,a=t=>e.getUniform(t),r=e=>s.float(e),n=e=>s.vec2(e),o=s.dereference(t[0]);return`\n                            ${n("norm")} = ${a("hatchingNormal")};\n                            ${n("uv")} = ${l="_uv",e.getVarying(l)};\n                            ${r("eval")}  = norm.x*uv.x + norm.y*uv.y;\n                            ${r("k")};\n                            if(eval < 0.0) {\n                                k = ${a("hatchingSpaceWidth")} - (${i.modulo("(-eval)",`${a("hatchingSpaceWidth")}`)});\n                            } else {\n                                k = ${i.modulo("eval",`${a("hatchingSpaceWidth")}`)};\n                            }\n                            ${n("fwx")}  = dot(norm, ${i.dpdx("uv")})*norm;\n                            ${n("fwy")}  = dot(norm, ${i.dpdy("uv")})*norm;\n                            ${n("fw")}  = abs(fwx) + abs(fwy);\n                            ${r("fwlen")}  = length(fw);\n                            ${r("tol")}  = min( ${a("hatchingLineWidth")}*fwlen, ${a("hatchingSpaceWidth")} - fwlen);\n                            if (k < tol/2.0 || k > ${a("hatchingSpaceWidth")} - tol/2.0) {\n                                ${o} = ${a("hatchingLineColor")};\n                            } else {\n                                ${o} = ${a("hatchingSpaceColor")};\n                            }\n                        `;var l}}),this.stripesDirection=new e.Vector2(1,1),this.spaceWidth=1,this.spaceColor=new e.Color(16777215),this.spaceOpacity=1,this.stripesWidth=1,this.stripesColor=new e.Color(0),this.stripesOpacity=1,this.autoSpaceColor=!1,this.autoStripesColor=!1,this.enableClipPlanes=!0,this._refreshPDSFXUniforms_private=function(t,s){var i=this._renderedClipPlane;if(i){var a=new e.Vector3;a.crossVectors(i.normal,i.upVector),a.normalize();var r=new e.Vector3;r.crossVectors(a,i.normal),this.updatePDSFXUniform("planeU",a),this.updatePDSFXUniform("planeV",r)}this.updatePDSFXUniform("hatchingDirection",this.stripesDirection.clone().normalize()),this.updatePDSFXUniform("hatchingNormal",new e.Vector2(this.stripesDirection.y,-this.stripesDirection.x).normalize()),this.updatePDSFXUniform("hatchingSpaceWidth",this.spaceWidth),this.updatePDSFXUniform("hatchingLineWidth",this.stripesWidth),t.gammaInput?(this.updatePDSFXUniform("hatchingSpaceColor",new e.Vector4(this.spaceColor.r*this.spaceColor.r,this.spaceColor.g*this.spaceColor.g,this.spaceColor.b*this.spaceColor.b,this.spaceOpacity)),this.updatePDSFXUniform("hatchingLineColor",new e.Vector4(this.stripesColor.r*this.stripesColor.r,this.stripesColor.g*this.stripesColor.g,this.stripesColor.b*this.stripesColor.b,this.stripesOpacity))):(this.updatePDSFXUniform("hatchingSpaceColor",new e.Vector4(this.spaceColor.r,this.spaceColor.g,this.spaceColor.b,this.spaceOpacity)),this.updatePDSFXUniform("hatchingLineColor",new e.Vector4(this.stripesColor.r,this.stripesColor.g,this.stripesColor.b,this.stripesOpacity)))},this.setValues(t),this.autoColorMap=null}clone(){var e=new a;return super.clone(e),e.stripesDirection=this.stripesDirection.clone(),e.spaceWidth=this.spaceWidth,e.spaceColor=this.spaceColor.clone(),e.spaceOpacity=this.spaceOpacity,e.stripesWidth=this.stripesWidth,e.stripesColor=this.stripesColor.clone(),e.stripesOpacity=this.stripesOpacity,e.autoStripesColor=this.autoStripesColor,e.autoSpaceColor=this.autoSpaceColor,e.updatePDSFXUniform("planeU",this.getPDSFXUniform("planeU").value.clone()),e.updatePDSFXUniform("planeV",this.getPDSFXUniform("planeV").value.clone()),e}getType(){return"Hatching"}set wireframe(e){this._wireframe=!1}getAutoColorVersion(e,t){return s(this,e,t)}}i=a;class r extends t{constructor(t){super({side:e.FrontSide,force:!0}),this.activatePDSFX("PDSFXScreenSizeHatchingMesh");var s={hatchingNormal:{type:"v2",value:new e.Vector2(-1,-1)},hatchingSpaceWidth:{type:"f",value:10},hatchingSpaceColor:{type:"v4",value:new e.Vector4(10,10,10,1)},hatchingLineWidth:{type:"f",value:1},hatchingLineColor:{type:"v4",value:new e.Vector4(0,0,0,1)},screenSize:{type:"v2",value:new e.Vector2(10,10)}};this.setPDSFXUniforms(s);this.setPDSFXGlobalShaderCode((function(e){const t=e.variableHandler;return`\n                        ${s="_mvPosition",t.vec4G(s)};\n                    `;var s}),null);this.setPDSFXOverridableFunctions(null,{ProcessFinalColor:function(e,t){const s=e.variableHandler,i=e.bridgeFunctions,a=t=>e.getUniform(t),r=e=>s.float(e),n=e=>s.vec2(e),o=s.dereference(t[0]);return`\n                            ${l="clipPos",s.vec4(l)}  = ${e.vGetClipSpacePosition()};\n                            ${n("pixelPosition")}  = ${n()}(${a("screenSize")}.x*(1.0+clipPos.x/clipPos.w)/2.0, ${a("screenSize")}.y*(1.0+clipPos.y/clipPos.w)/2.0);\n                            ${r("dotValue")} = dot(pixelPosition, ${a("hatchingNormal")});\n                            ${r("m")};\n                            if(dotValue < 0.0) {\n                                m = ${a("hatchingSpaceWidth")} - (${i.modulo("(-dotValue)",`${a("hatchingSpaceWidth")}`)});\n                            } else {\n                                m = ${i.modulo("dotValue",`${a("hatchingSpaceWidth")}`)};\n                            }\n                            // force m to be between 0 and hatchingSpaceWidth\n                            if (m < 0.0) {\n                                m += ${a("hatchingSpaceWidth")};\n                            }\n                            // compute distance to theoritical stripe\n                            m = abs(${a("hatchingSpaceWidth")}*0.5 - m);\n                            m -=  ${a("hatchingLineWidth")};\n                            ${r("k")} = 1.0;\n                            if (m < 0.0) {\n                                k = 0.0;\n                            } else if ( m < 1.0) {\n                                k = m;\n                            }\n                            ${o} = k*${a("hatchingSpaceColor")} + (1.0-k)*${a("hatchingLineColor")};\n                        `;var l}}),this.stripesDirection=new e.Vector2(1,1),this.spaceWidth=1,this.spaceColor=new e.Color(16777215),this.spaceOpacity=1,this.stripesWidth=1,this.stripesColor=new e.Color(0),this.stripesOpacity=1,this.autoSpaceColor=!1,this.autoStripesColor=!1,this.enableClipPlanes=!0,this._refreshPDSFXUniforms_private=function(t,s){this.updatePDSFXUniform("screenSize",new e.Vector2(t.domElement.width,t.domElement.height)),this.updatePDSFXUniform("hatchingNormal",new e.Vector2(this.stripesDirection.y,-this.stripesDirection.x).normalize()),this.updatePDSFXUniform("hatchingSpaceWidth",this.spaceWidth),this.updatePDSFXUniform("hatchingLineWidth",this.stripesWidth/2),t.gammaInput?(this.updatePDSFXUniform("hatchingSpaceColor",new e.Vector4(this.spaceColor.r*this.spaceColor.r,this.spaceColor.g*this.spaceColor.g,this.spaceColor.b*this.spaceColor.b,this.stripesOpacity)),this.updatePDSFXUniform("hatchingLineColor",new e.Vector4(this.stripesColor.r*this.stripesColor.r,this.stripesColor.g*this.stripesColor.g,this.stripesColor.b*this.stripesColor.b,this.stripesOpacity))):(this.updatePDSFXUniform("hatchingSpaceColor",new e.Vector4(this.spaceColor.r,this.spaceColor.g,this.spaceColor.b,this.stripesOpacity)),this.updatePDSFXUniform("hatchingLineColor",new e.Vector4(this.stripesColor.r,this.stripesColor.g,this.stripesColor.b,this.stripesOpacity)))},this.setValues(t),this.autoColorMap=null}clone(){var e=new r;return super.clone(e),e.stripesDirection=this.stripesDirection.clone(),e.spaceWidth=this.spaceWidth,e.spaceColor=this.spaceColor.clone(),e.spaceOpacity=this.spaceOpacity,e.stripesWidth=this.stripesWidth,e.stripesColor=this.stripesColor.clone(),e.stripesOpacity=this.stripesOpacity,e.autoStripesColor=this.autoStripesColor,e.autoSpaceColor=this.autoSpaceColor,e}getType(){return"ScreenSizeHatching"}set wireframe(e){this._wireframe=!1}getAutoColorVersion(e,t){return s(this,e,t)}}return{HatchingMeshMaterial:i,ScreenSizeHatchingMeshMaterial:r}})),define("DS/Materials/GridMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],(function(e,t){"use strict";let s=function(e){const t=e.variableHandler;return`\n            ${s="mixDistance",t.float(s,0,"private")};\n        `;var s},i=function(e,t){const s=e.variableHandler,i=t=>e.getUniform(t);return`\n            ${a="vecDist",s.vec3(a)}  = ${e.vGetViewPosition()} - ${i("gridCenter")};\n            mixDistance = 16.0 * dot(vecDist, vecDist);\n            mixDistance /= (${i("gridSize")} * ${i("gridSize")});\n            mixDistance = clamp(mixDistance, 0.0, 1.0);\n        `;var a},a=function(e,t){const s=e.variableHandler,i=e=>s.vec3(e);return`    \n            ${i("cCenter")}  = ${e.vGetAlbedo()}.rgb;\n            ${i("cBorder")}  = cCenter*cCenter;\n            return mix(cCenter, cBorder, mixDistance);\n        `};let r=function(e,t){const s=e.variableHandler,i=(e.functionHandler,e.bridgeFunctions),a=e.pdsfxDefines,r=t=>e.getUniform(t),n=e=>s.vec3(e),o=s.dereference(t[0]);return`\n            ${l="texelColor",s.vec4(l)}  = ${i.sample2DTexture((t=>e.getTextureUniform(t))("gridTexture"),`${r("gridRepeat")} * ${e.vGetTexCoord0()}.xy + ${r("gridOffset")} `)};\n            ${n("cCenter")}  = ${e.vGetAlbedo()}.rgb * texelColor.rgb;\n            ${n("cBorder")}  = cCenter*cCenter;\n            (${o}).r = mix(cCenter.r, cBorder.r, mixDistance);\n            (${o}).g = mix(cCenter.g, cBorder.g, mixDistance);\n            (${o}).b = mix(cCenter.b, cBorder.b, mixDistance);\n            (${o}).a = texelColor.a * ${e.vGetOpacity()} * mix(${e.getUniform("attenuation")}, 0.0, mixDistance);\n            \n            ${a.gammaOutput?`\n                (${o}).r = sqrt((${o}).r);\n                (${o}).g = sqrt((${o}).g);\n                (${o}).b = sqrt((${o}).b);\n                `:""}\n        `;var l},n=function(e,t){return`\n            return ${e.vGetOpacity()} * mix(${e.getUniform("attenuation")}, 0.0, mixDistance);\n        `};return class extends t{constructor(){super({}),this.useBlending=!0,this.side=e.DoubleSide,this.depthTest=!1,this.depthWrite=!1,this.force=!0,this.opacity=1,this.transparent=!0,this.enableClipPlanes=!1,this.defines={GRID_USE_TEXTURE:!1},this.activatePDSFX("PDSFXGrid");let t={gridCenter:{type:"v3",value:new e.Vector3},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1},gridTexture:{type:"t2",value:null},gridOffset:{type:"v2",value:new e.Vector2},gridRepeat:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(t),this.setPDSFXGlobalShaderCode(null,s),this.setPDSFXOverridableFunctions(null,{ComputeCommonValues:i,ComputeAlbedo:a,ComputeOpacity:n}),this._refreshPDSFXUniforms_private=function(e,t){var s=this.getPDSFXUniform("gridTexture").value;s&&(this.updatePDSFXUniform("gridOffset",s.offset),this.updatePDSFXUniform("gridRepeat",s.repeat))}}getType(){return"Grid"}setGridTexture(e){this.updatePDSFXUniform("gridTexture",e),this.needsUpdate=!0,e?(this.setPDSFXOverridableFunctions(null,{ComputeCommonValues:i,ProcessFinalColor:r}),this.defines.GRID_USE_TEXTURE=!0):(this.setPDSFXOverridableFunctions(null,{ComputeCommonValues:i,ComputeAlbedo:a,ComputeOpacity:n}),this.defines.GRID_USE_TEXTURE=!1)}_setMaterialShaderOptions(e,t,s,i,a,r){e.inlinedPostProActivated=!1,super._setMaterialShaderOptions(e,t,s,i,a,r)}getPredefinedMaterial(e,t,s){return this}updateDeferredMaterials(e){super.updateDeferredMaterials(e);for(let e=1;e<this._deferredMaterials.length;e++)this._deferredMaterials[e]=null}set wireframe(e){this._wireframe=!1}}})),define("DS/Materials/GaussianSplatMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],(function(e,t){"use strict";class s extends t{constructor(){super({force:!0,transparent:!0}),this.line=new e.LineBasicMaterial({visible:!1}),this.depthWrite=!1,this.depthTest=!0,this.focal=new e.Vector2,this.basisViewport=new e.Vector2,this.centersRGTexture=null,this.covariancesBATexture=null,this.centersTextureSize=null,this.covariancesTextureSize=null,this.splatIndexGPUBuffer=null,this.refreshUniforms=function(t,s){t.requestRealDepthBuffer();let i=t.camera,a=t.getViewportSize(),r=e.getDevicePixelRatio(),n=a.width,o=a.height,l=i.projectionMatrix.elements[0]*r*n*.45,h=i.projectionMatrix.elements[5]*r*o*.45;this.focal.set(l,h),this.basisViewport.set(1/(n*e.getDevicePixelRatio()),1/(o*e.getDevicePixelRatio())),this._revision++},this.name="GaussianSplatMaterial"}updateDataToTextures(t,s,i){const a=i.length/4;var r=null;const n=new e.Vector2(4096,1);var o=null;const l=new e.Vector2(4096,1);{const m=4,C=2===e.WebGLVersion||e.WebGPU?6:8;for(;n.x*n.y*m<4*a;)n.y*=2;for(;l.x*l.y*m<8*a;)l.y*=2;var h=null;h=2===e.WebGLVersion||e.WebGPU?new Uint32Array(n.x*n.y*m):new Float32Array(n.x*n.y*m);var p=null,u=null,c=null;let S=new Float32Array(l.x*l.y*C);if(2===e.WebGLVersion||e.WebGPU){const r=function(e,t,s,i){return e+(t<<8)+(s<<16)+(i<<24)},n=function(){const e=new Float32Array(1),t=new Uint32Array(e.buffer);return function(s){return e[0]=s,t[0]}}();for(let e=0;e<a;e++){const a=4*e;h[a]=n(s[3*e]),h[a+1]=n(s[3*e+1]),h[a+2]=n(s[3*e+2]),h[a+3]=r(i[4*e],i[4*e+1],i[4*e+2],i[4*e+3]),S[e*C]=t[6*e+0],S[e*C+1]=t[6*e+1],S[e*C+2]=t[6*e+2],S[e*C+3]=t[6*e+3],S[e*C+4]=t[6*e+4],S[e*C+5]=t[6*e+5]}u=e.RGBAIntegerFormat,p=e.UnsignedIntType,c=e.RGFormat}else{for(let e=0;e<a;e++){const a=4*e;h[a]=s[3*e],h[a+1]=s[3*e+1],h[a+2]=s[3*e+2];var d=i[4*e],f=i[4*e+1];255===d&&(d-=1),255===f&&(f-=1),h[a+3]=d/255+f/65025,S[e*C]=t[6*e],S[e*C+1]=t[6*e+1],S[e*C+2]=t[6*e+2],S[e*C+3]=t[6*e+3],S[e*C+4]=t[6*e+4],S[e*C+5]=t[6*e+5],S[e*C+6]=i[4*e+2]/255,S[e*C+7]=i[4*e+3]/255}u=e.RGBAFormat,p=e.FloatType,c=e.RGBAFormat}(r=new e.DataTexture(h,n.x,n.y,u,p,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter)).generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0,(o=new e.DataTexture(S,l.x,l.y,c,e.FloatType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter)).generateMipmaps=!1,o.flipY=!1,o.needsUpdate=!0}this.centersRGTexture=r,this.covariancesBATexture=o,this.centersTextureSize=(new e.Vector2).copy(n),this.covariancesTextureSize=(new e.Vector2).copy(l)}getType(){return"GaussianSplat"}clone(e){return e||(e=new s),super.clone(e),e}activatePDSFX(e){throw console.error("activatePDSFX params:"+JSON.stringify(e)),new Error("Cannot call activatePDSFX on GaussianSplatMaterial !")}loadUniforms(e,t,s,i=null,a=null,r=null){s.centersTextureSize&&t.uniform2f(s.centersTextureSize,this.centersTextureSize.x,this.centersTextureSize.y),s.covariancesTextureSize&&t.uniform2f(s.covariancesTextureSize,this.covariancesTextureSize.x,this.covariancesTextureSize.y),s.centersRGTexture&&e.loadTexture(t,s.centersRGTexture,this.centersRGTexture),s.covariancesBATexture&&e.loadTexture(t,s.covariancesBATexture,this.covariancesBATexture),s.focal&&t.uniform2f(s.focal,this.focal.x,this.focal.y),s.basisViewport&&t.uniform2f(s.basisViewport,this.basisViewport.x,this.basisViewport.y)}fillUBO(e,t){const s=e.layout;s.centersTextureSize&&e.setV2(s.centersTextureSize,this.centersTextureSize),s.covariancesTextureSize&&e.setV2(s.covariancesTextureSize,this.covariancesTextureSize),s.centersRGTexture&&e.setTexture(s.centersRGTexture,this.centersRGTexture),s.covariancesBATexture&&e.setTexture(s.covariancesBATexture,this.covariancesBATexture),s.focal&&e.setV2(s.focal,this.focal),s.basisViewport&&e.setV2(s.basisViewport,this.basisViewport),s.splatIndex2&&e.setStorageBuffer(s.splatIndex2,this.splatIndexGPUBuffer)}set wireframe(e){this._wireframe=!1}}return s.prototype._shaderID="gaussianSplat",s})),define("DS/Materials/SectionBuilderMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,s){"use strict";const i=(e,t,i)=>s.FunctionHandler.callFunction(e,t,i);var a={};a.VS_global=function(e){const t=e.variableHandler,a=e.functionHandler,r=t=>e.getUniform(t),n=e=>t.float(e),o=e=>t.vec3(e),l=e=>t.vec4(e);return`\n            ${h="getClipPlaneEquation",p="v4",u=[a.prmI("index")],s.FunctionHandler.declareFunction(h,p,u)};\n\n            ${a.dF("getDist","f",[a.prmV4("pos")])} {\n              ${l("clipPlaneEquation")}  = ${i("getClipPlaneEquation","v4",[a.prmI(`${r("currentClipPlane")}`)])};\n              ${n("dist")}  = dot( pos.xyz, clipPlaneEquation.xyz ) + clipPlaneEquation.w;\n              return dist;\n            }\n    \n            ${a.dF("getIntersection","v4",[a.prmV4("M"),a.prmV4("N")])} {\n              ${l("clipPlaneEquation")} = ${i("getClipPlaneEquation","v4",[a.prmI(`${r("currentClipPlane")}`)])};\n              ${o("direction")}  = ${o()}(N.x - M.x, N.y - M.y, N.z - M.z);\n              ${l("result")} ;\n              ${n("t")};\n              ${n("denominator")}  = dot(direction, clipPlaneEquation.xyz);\n              if(denominator == 0.0) {\n                return M;\n              } else {\n                t = -(dot(M.xyz, clipPlaneEquation.xyz) + clipPlaneEquation.w) / denominator;\n                result = ${l()}(t*direction+M.xyz, 1.0);\n                return result;\n              }\n            }\n\n            ${n("far")} ;\n            ${n("near")} ;\n            ${(e=>t.bool(e))("hide")} ;\n            ${l("mvCurrInter")} ;\n            ${l("mvOtherInter")} ;\n\n            ${a.dF("linearizeNDC","f",[a.prmF("iNonLinearNDC")])} {\n            \t${n("z01")}  = 0.5*iNonLinearNDC + 0.5;\n            \t${n("res")} = 2.0*near/(far + near - z01*(far - near));\n            \tres = res *2.0 - 1.0;\n            \treturn res;\n            }\n        `;var h,p,u},a.FS_global=null;var r=function(e){const t=e.variableHandler,s=e.functionHandler,a=e.bridgeFunctions,r=e.userDefines,n=e=>t.int(e),o=e=>t.float(e),l=e=>t.vec3(e),h=e=>t.vec4(e),p=r.NB_OUTLINE_MAPS,u=r.LAST_OUTLINE_MAP_SIZE_X,c=r.LAST_OUTLINE_MAP_SIZE_Y,d=r.MAX_OUTLINE_MAP_SIZE,f=(s,i,r)=>{return a.sample2DTexture((n=s,e.getTextureUniform(n)),`${t.vec2()}(${i}, ${r})`);var n};function m(e){const s="_"+e;return`\n                ${t.float("dx"+s)} ;\n                ${t.float("dy"+s)} ;  \n                ${t.float("x"+s)} ; \n                ${t.float("y"+s)} ; \n                if (texId${s} == ${p} - 1) {\n                    dx${s} = 1.0 / ${u};\n                    dy${s} = 1.0 / ${c};\n                    y${s} = floor(idInTexture${s}/${u});\n                    x${s} = idInTexture${s} - y${s}*${u};\n                } else {\n                    dx${s} = 1.0 / ${d};\n                    dy${s} = 1.0 / ${d};\n                    y${s} = floor(idInTexture${s}/${d});\n                    x${s} = idInTexture${s} - y${s}*${d};\n                }\n                `}return`\n                ${l("_position")}  = ${e.vGetAttribPosition()};\n                ${o("i1")}  = _position.x;\n                ${o("i2")}  = _position.y;\n                ${o("i3")}  = _position.z;\n                //both dimensions\n                ${o("maxMapTotalSize")}  = ${d} * ${d};\n                ${n("texId_1")}  = ${n()}(floor(i1/maxMapTotalSize));\n                ${n("texId_2")}  = ${n()}(floor(i2/maxMapTotalSize));\n                ${n("texId_3")}  = ${n()}(floor(i3/maxMapTotalSize));\n           \n                ${o("idInTexture_1")}  = i1 - ${o()}(texId_1)*maxMapTotalSize;\n                ${o("idInTexture_2")}  = i2 - ${o()}(texId_2)*maxMapTotalSize;\n                ${o("idInTexture_3")}  = i3 - ${o()}(texId_3)*maxMapTotalSize;\n        \n                ${m(1)}\n                ${m(2)}\n                ${m(3)}\n        \n                ${l("P")} = ${f("outlinePositionMaps[texId_1]","dx_1 * ( x_1 + 0.5 )","dy_1 * ( y_1 + 0.5 )")}.xyz;\n                ${l("M")} = ${f("outlinePositionMaps[texId_2]","dx_2 * ( x_2 + 0.5 )","dy_2 * ( y_2 + 0.5 )")}.xyz;\n                ${l("N")} = ${f("outlinePositionMaps[texId_3]","dx_3 * ( x_3 + 0.5 )","dy_3 * ( y_3 + 0.5 )")}.xyz;\n                \n                ${C="PM",t.mat4(C)} = ${e.vGetProjectionMatrix()};\n                ${o("m22")}  = PM[2][2];\n                ${o("m32")}  = PM[3][2];\n                ${(e=>t.bool(e))("isPersp")}  = PM[3][3] < 0.5;\n                if (isPersp) {\n                    near = m32 / (m22 - 1.0);\n                    far = ((m22 - 1.0)*near)/(m22 + 1.0);\n                } else {\n                    near = (m32+1.0)/m22;\n                    far = near - 2.0/m22;\n                }\n\n                ${h("mvP")}  = ${i("computeModelViewPosition","v4",[s.prmV3("P")])};\n                ${h("mvM")}  = ${i("computeModelViewPosition","v4",[s.prmV3("M")])};\n                ${h("mvN")}  = ${i("computeModelViewPosition","v4",[s.prmV3("N")])};\n        \n                mvCurrInter = mvP;\n                mvOtherInter = mvM;\n                hide = true;\n        `;var C};a.SimpleSectionShader={VS_overridables:{ComputeCommonValues:function(e,t){const s=e.functionHandler,i=e=>s.cF("getDist","f",[s.prmV4(e)]),a=(e,t)=>s.cF("getIntersection","v4",[s.prmV4(e),s.prmV4(t)]);return`\n                    \n                    ${r(e)}\n                    if (${e.vGetAttribTexCoord0()}.x > 0.0 && ${i("mvP")} > 0.0 && ${i("mvM")} < 0.0) {\n                      mvCurrInter = ${a("mvP","mvM")};\n                      hide = false;\n                    }\n                    if (${e.vGetAttribTexCoord0()}.x < 0.0 && ${i("mvP")} < 0.0 && ${i("mvN")} > 0.0) {\n                      if( ${i("mvM")} < 0.0) {\n                        mvCurrInter = ${a("mvM","mvN")};\n                      } else {\n                        mvCurrInter = ${a("mvM","mvP")};\n                      }\n                      hide = false;\n                    }\n                    `},ProcessViewTangentSpace:function(e,t){return`            \n                        ${e.variableHandler.dereference(t[0])}.Position = mvCurrInter.xyz;\n                    `},ProcessClipSpacePosition:function(e,t){return`\n                        if (hide) {\n                            ${e.variableHandler.dereference(t[0])}.z = 10000000.0 * far;\n                        }\n                    `}},FS_overridables:{}},a.WideSectionShader={VS_overridables:{ComputeCommonValues:function(e,t){const s=e.functionHandler,i=e=>s.cF("getDist","f",[s.prmV4(e)]),a=(e,t)=>s.cF("getIntersection","v4",[s.prmV4(e),s.prmV4(t)]);return`            \n                        ${r(e)}\n                        if (${e.vGetAttribTexCoord0()}.x > 0.0 && ${i("mvP")} > 0.0 && ${i("mvM")} < 0.0) {\n                            mvCurrInter = ${a("mvP","mvM")};\n                            if(${i("mvN")} > 0.0) {\n                                mvOtherInter = ${a("mvM","mvN")};\n                            } else {\n                                mvOtherInter = ${a("mvN","mvP")};\n                            }\n                            hide = false;\n                        }\n                        if (${e.vGetAttribTexCoord0()}.x < 0.0 && ${i("mvP")} < 0.0 && ${i("mvN")} > 0.0) {\n                            if(${i("mvM")} < 0.0) {\n                                mvCurrInter = ${a("mvM","mvN")};\n                            } else {\n                                mvCurrInter = ${a("mvM","mvP")};\n                            }\n                            mvOtherInter = ${a("mvN","mvP")};\n                            hide = false;\n                        }\n                    `},ProcessViewTangentSpace:function(e,t){return`            \n                        ${e.variableHandler.dereference(t[0])}.Position = mvCurrInter.xyz;\n                    `},ProcessClipSpacePosition:function(e,t){const s=e.variableHandler,i=e.functionHandler,a=t=>e.getUniform(t),r=t=>e.getVarying(t),n=e=>s.float(e),o=e=>s.vec2(e),l=e=>s.vec3(e),h=e=>s.vec4(e),p=e=>i.cF("linearizeNDC","f",[i.prmF(e)]),u=s.dereference(t[0]);return`\n                    \n                    ${c="PM",s.mat4(c)}  = ${e.vGetProjectionMatrix()};\n                    ${h("mvpCurr")}  = PM*${h()}(mvCurrInter.xyz,1.0);\n                    ${h("mvpOpp")}  = PM*${h()}(mvOtherInter.xyz,1.0);\n                    ${r("screenCurr")} = (mvpCurr.xy / mvpCurr.w + 1.0) / ${a("pixelSize")};\n                    ${r("screenOpp")} = (mvpOpp.xy / mvpOpp.w + 1.0) / ${a("pixelSize")};\n\n                    //extrusion of the wide outline quad + computing the z so the quad is flat\n                    ${l("ndcCurr")}  = mvpCurr.xyz/mvpCurr.w;\n                    ${l("ndcOpp")}  = mvpOpp.xyz/mvpOpp.w;\n\n                    ${n("sideExtrusion")}  = ${e.vGetAttribTexCoord0()}.y * ${e.vGetAttribTexCoord0()}.x;\n                    ${n("offset")}  = sign(sideExtrusion) * ${a("sectionLineHalfWidth")};\n                    ${o("line")}  = normalize(${r("screenOpp")} - screenCurr);\n                    ${o("lineNormal")}  = ${o()}(-line.y, line.x);\n\n                    ${o("ptAlongLine")}  = ${r("screenCurr")} - ${a("sectionLineHalfWidth")}*line;\n                    ${o("ndcPtAlongLine")}  = ptAlongLine*${a("pixelSize")} - 1.0;\n                    ${n("ndcD")}  = length(ndcCurr.xy - ndcPtAlongLine);\n                    ${n("lengthCurrOpp")}  = length(ndcCurr.xy - ndcOpp.xy);\n                    ${n("ndcZDelta")}  = ndcD*abs(ndcCurr.z-ndcOpp.z)/lengthCurrOpp;\n                    ${n("ndcZDeltaLin")}  = ndcD*abs(${p("ndcCurr.z")}-${p("ndcOpp.z")})/lengthCurrOpp;\n\n                    ${o("px_pos")} ;\n                    if (ndcZDeltaLin > 0.7*ndcD) {\n                        px_pos = ${r("screenCurr")} + offset*lineNormal;\n                        ndcZDelta = 0.0;\n                    } else {\n                        px_pos = ${r("screenCurr")} + offset*lineNormal - ${a("sectionLineHalfWidth")}*line;\n                    }\n\n                    ndcZDelta *= sign(ndcCurr.z - ndcOpp.z);\n                    ${n("ndcFinalZ")}  = mvpCurr.z/mvpCurr.w + ndcZDelta;\n\n\n                    ${l("ndcPos")}  = ${l()}((px_pos*${a("pixelSize")} - 1.0), ndcFinalZ);\n                    //so the 4 vertices of the outline have the same curr and opp for fragment shader treatment\n                    if (${e.vGetAttribTexCoord0()}.x < 0.0) {\n                        ${o("tmp")}  = ${r("screenCurr")};\n                        ${r("screenCurr")} = ${r("screenOpp")};\n                        ${r("screenOpp")} = tmp;\n                    }\n\n                    ${h("clipSpacePos")}  = ${h()}(ndcPos*mvpCurr.w, mvpCurr.w);\n                    ${u} = clipSpacePos;    \n\n                    if (hide) {\n                        ${u}.z = 10000000.0 * far;\n                    }\n                    `;var c}},FS_overridables:{ComputeDiscard:function(e,t){const s=e.variableHandler,i=t=>e.getUniform(t),a=t=>e.getVarying(t),r=e=>s.vec2(e);return`\n                        ${r("fCoord")}  = ${e.vGetFragCoord()}.xy;\n\n\t\t\t\t\t\t${r("currOpp")}  = ${a("screenOpp")} - ${a("screenCurr")};\n\t\t\t\t\t\t${r("currFcoord")}  = fCoord - ${a("screenCurr")};\n\t\t\t\t\t\t${r("oppFcoord")}  = fCoord - ${a("screenOpp")};\n\n\t\t\t\t\t\t${n="toDiscard",s.bool(n)}  = false;\n\t\t\t\t\t\t//round caps so each individual line can seamlessly connect to its neighbour\n\t\t\t\t\t\tif (dot(currOpp, currFcoord ) < 0.0) {\n\t\t\t\t\t\t    if (length(currFcoord) > ${i("sectionLineHalfWidth")}) {\n                                toDiscard = true;\n                            }\n\t\t\t\t\t\t} else if (dot(-currOpp, oppFcoord ) < 0.0) {\n\t\t\t\t\t\t    if (length(oppFcoord) > ${i("sectionLineHalfWidth")}) {\n                                toDiscard = true;\n                            }\n\t\t\t\t\t\t}\n                        return toDiscard;          \n                    `;var n}}};class n extends t{constructor(){super(),this.activatePDSFX("PDSFX"+this.getType()),this.force=!0,this.enableClipPlanes=!0,this.side=e.DoubleSide,this.polygonOffset=!0,this.clipPlaneIndex=0,this._allowFullMaterialOverride=-1}getPredefinedMaterial(e,t,s){return this}set wireframe(e){this._wireframe=!1}}n.prototype.__dimension=1,n.prototype.__isSectionLine=!0;class o extends n{constructor(e,t){if(super(),this.setPDSFXGlobalShaderCode(a.VS_global,a.FS_global),this.setPDSFXOverridableFunctions(a.SimpleSectionShader.VS_overridables,a.SimpleSectionShader.FS_overridables),e){this.defines={NB_OUTLINE_MAPS:e.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:e.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:e.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:e.LAST_OUTLINE_MAP_SIZE_Y};var s={outlinePositionMaps:{type:"t2v",value:t,length:this.defines.NB_OUTLINE_MAPS},currentClipPlane:{type:"i",value:0}};this.setPDSFXUniforms(s)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.refreshPDSFXUniforms=function(){this.updatePDSFXUniform("currentClipPlane",this.clipPlaneIndex-1)}}getType(){return"Section"}clone(){var e=new o;return super.clone(e),e}}class l extends n{constructor(t,s,i){if(super(),this.forceSide=!0,this.side=e.DoubleSide,this.setPDSFXGlobalShaderCode(a.VS_global,a.FS_global),this.setPDSFXOverridableFunctions(a.WideSectionShader.VS_overridables,a.WideSectionShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var r={outlinePositionMaps:{type:"t2v",value:s,length:this.defines.NB_OUTLINE_MAPS},currentClipPlane:{type:"i",value:0},sectionLineHalfWidth:{type:"f",value:i},pixelSize:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(r)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({screenCurr:{type:"v2"},screenOpp:{type:"v2"}}),this._refreshPDSFXUniforms_private=function(t,s){this.updatePDSFXUniform("pixelSize",new e.Vector2(2/t.domElement.width,2/t.domElement.height)),this.updatePDSFXUniform("currentClipPlane",this.clipPlaneIndex-1)}}getType(){return"WideSection"}clone(){var e=new l;return super.clone(e),e}}return{_SectionMaterial:o,_WideSectionMaterial:l}})),define("DS/Materials/LineDSMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],(function(e,t,s,i){"use strict";class a extends t{constructor(t){super(),this.color=new e.Color(16777215),this.scale=6.66666,this.dashSize=0,this.gapSize=0,this.dashPattern=new Float32Array(2),this._dashPatternInternal=null,this.dashType="None",this.patternOffset=0,this.linecap="square",this.linejoin="miter",this.lineWidth=1,this.side=e.Constants.DoubleSide,this.setValues(t),this._invertedPattern=t&&!!t.invertedPattern,"None"!==this.dashType&&(this.dashSize=this.gapSize=-1,this._setDashPatternType()),this.dashSize>0&&this.gapSize>0&&(console.error("DEPRECATED: Usage of dashSize and gapSize is deprecated, use dashPattern instead."),this.dashPattern[0]=this.dashSize,this.dashPattern[1]=this.gapSize,this.dashSize=-1,this.gapSize=-1),this._updateDashPattern(),this.isDashedLine&&"None"===this.dashType&&(this.dashType="Custom")}_updateDashPattern(e=!1){for(var t=this.isDashedLine,s=this.dashPattern,i=1;i<s.length;i++)s[i]+=s[i-1];this._revision++,this.isDashedLine=this._invertedPattern?s[0]>0:s[1]>s[0],!this.isDashedLine&&e&&(this.isDashedLine=!0,s[0]=this._invertedPattern?0:1e6,s[1]=1e6),t!==this.isDashedLine&&(this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())}clone(e){return void 0===e&&(e=new a),super.clone(e),e.color.copy(this.color),e.scale=this.scale,e.dashPattern=new Float32Array(this.dashPattern),e.dashType=this.dashType,e.patternOffset=this.patternOffset,e.lineWidth=this.lineWidth,e.linecap=this.linecap,e.linejoin=this.linejoin,e.side=this.side,e._invertedPattern=this._invertedPattern,e}_dump(){var e=super._dump();return e.color=this.color.toArray(),e.dashPattern=Array.from(this.dashPattern),e.lineWidth=this.lineWidth,e}_canUseLights(){return!1}_setMaterialShaderOptions(e,t,s,i,a,r){super._setMaterialShaderOptions(e,t,s,i,a,r);var n={},o=this;r||Object.assign(n,{dashedLine:o.isDashedLine,patternSize:o.isDashedLine&&o.dashPattern?o._dashPatternInternal.length/4:0,_originalPatternSize:o.isDashedLine&&o.dashPattern?o.dashPattern.length:0,invertedPattern:o._invertedPattern}),Object.assign(n,{wideLine:o.isWideLine||o.is2DLine,linejoin:o.linejoin,linecap:o.linecap}),Object.assign(e,n)}setLineJoin(e){this.linejoin=e,this._revision++}setLineCap(e){this.linecap=e,this._revision++}setPatternOffset(e){this.patternOffset=e,this._revision++}setScale(e){this.scale=e,this._revision++}_setDashPatternArray(e){e&&0!==e.length||(e=[0,0]),e.length<=1&&(e=[e[0],0]),this.dashPattern.length!==e.length&&(this.needsUpdate=!0),this.dashPattern=new Float32Array(e)}setDashPatternArray(e){this._setDashPatternArray(e),this.dashType="Custom",this._updateDashPattern()}_setDashPatternType(){this._invertedPattern=!1;var e=null;switch(this.dashType){case 1:this.dashType="Solid";case"Solid":(e=new Float32Array(2))[0]=-1,e[1]=-1;break;case 2:this.dashType="Dotted";case"Dotted":(e=new Float32Array(2))[0]=2,e[1]=2;break;case 3:this.dashType="Dashed";case"Dashed":(e=new Float32Array(2))[0]=3,e[1]=1;break;case 4:this.dashType="Dot-Dashed";case"Dot-Dashed":(e=new Float32Array(4))[0]=3,e[1]=2,e[2]=1,e[3]=2;break;case 5:this.dashType="Phantom";case"Phantom":(e=new Float32Array(6))[0]=6,e[1]=2,e[2]=2,e[3]=2,e[4]=2,e[5]=2;break;case 6:this.dashType="Small-Dotted";case"Small-Dotted":(e=new Float32Array(2))[0]=1,e[1]=1,this._invertedPattern=!0;break;case 7:this.dashType="JIS Axis";case"JIS Axis":(e=new Float32Array(4))[0]=2,e[1]=1,e[2]=12,e[3]=1;break;default:this.dashType="None",(e=new Float32Array(2))[0]=-1,e[1]=-1}this._setDashPatternArray(e)}setDashPatternType(e){this.dashType=e,this._setDashPatternType(),this._updateDashPattern()}setInvertedPattern(e){var t=this._invertedPattern;this._invertedPattern=e,this._updateDashPattern(),this._invertedPattern!==t&&(this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())}loadGlobalUniforms(e,t,s){s.pixelSize&&t.uniform2f(s.pixelSize,e._pixelSize.x,e._pixelSize.y)}loadUniforms(e,t,s,i,a,r){e.loadGASUniforms(t,this,s,i,a||this),s.colorBufferType&&t.uniform1f(s.colorBufferType,this.vertexColors),this.isDashedLine&&(s.dashPattern&&(t.uniform4fv(s.dashPattern,this._dashPatternInternal),t.uniform1f(s.totalSize,this._dashPatternInternal[this.dashPattern.length-1])),s.patternOffset&&t.uniform1f(s.patternOffset,this.patternOffset))}fillGlobalUBO(e,t){const s=e.layout;s.pixelSize&&e.setV2(s.pixelSize,t._pixelSize)}fillUBO(e,t){const s=e.layout;s.colorBufferType&&e.setF(s.colorBufferType,this.vertexColors),this.isDashedLine&&(s.dashPattern&&(e.setFlatV4Array(s.dashPattern,this._dashPatternInternal),e.setF(s.totalSize,this._dashPatternInternal[this.dashPattern.length-1])),s.patternOffset&&e.setF(s.patternOffset,this.patternOffset))}fillUBOHigh(e,t,s,i,a){t.fillGASUBO(e,this,s||this,a)}getPredefinedMaterial(t,s,a){var r=this.getBaseId();if(r+="Line",r+="S"+this.side,r+="CP"+this.enableClipPlanes,r+="Type"+s,s!==e.DefaultAppearanceMode.__QA_AUTOMATION__)return this;if(r+="Col"+this.color.getHex(),r="id"+(r+="Op"+this._opacity).hashCode(),!i.PredefinedMaterials.has(r)){var n=new e.LineBasicMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:this.color,opacity:this._opacity});n.activatePDSFX("PDSFXLineQAAutomation");n.setPDSFXOverridableFunctions({},{ProcessFinalColor:function(e,t){const s=e.variableHandler,i=e.pdsfxDefines,a=s.dereference(t[0]);return`\n                                    ${a} = ${s.vec4(r)}(${e.vGetAlbedo()}, ${e.vGetOpacity()});\n                                    ${i.gammaOutput?`\n                                        ${a}.r = sqrt(${a}.r);\n                                        ${a}.g = sqrt(${a}.g);\n                                        ${a}.b = sqrt(${a}.b);\n                                        `:""}\n                                `;var r}});var o=new i.DeferredMaterial(n);i.PredefinedMaterials.set(r,o)}return i.PredefinedMaterials.get(r).get(this)}getZOnlyMaterial(){return this}_defaultPDSFXOverridableFunctions(){var t=super._defaultPDSFXOverridableFunctions();return Object.assign(t.vertex,{ProcessLineDistance:e._ShaderChunk.PDSFXProcessLineDistance_VS,ComputeHalfWidth:e._ShaderChunk.PDSFXComputeHalfWidth_VS}),Object.assign(t.fragment,{ComputeHalfWidth:e._ShaderChunk.PDSFXComputeHalfWidth_FS,ProcessLinePattern:e._ShaderChunk.PDSFXProcessLinePattern_FS}),t}_getBodyEdgeMaterial(){return this}updateDeferredMaterials(t){super.updateDeferredMaterials(t),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=null}_computeAmbianceKeyAndProcessMaterial(e,t,s,i,a){if(super._computeAmbianceKeyAndProcessMaterial(e,t,s,i,a),this.isDashedLine){var r=this.dashPattern;this._dashPatternInternal&&this._dashPatternInternal.length===4*Math.ceil(r.length/4)||(this._dashPatternInternal=new Float32Array(4*Math.ceil(r.length/4)));for(var n=0;n<r.length;n++)this._dashPatternInternal[n]=r[n]}else this._dashPatternInternal=null;return 0}}return a.prototype.targetPrimitiveType="LINES",a.prototype.__dimension=1,a.prototype._sideMatters=!1,a})),define("DS/Materials/LineBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/LineDSMaterial","DS/Materials/DeferredCaches","DS/Mesh/Mesh","DS/CoreEvents/Events"],(function(e,t,s,i,a){"use strict";const r=new e.Color,n={createDiskXY:function(t,s=.5){const a=new Uint16Array(3*t),r=new Float32Array(3*(t+1));r[0]=0,r[1]=0,r[2]=s;for(let e=0;e<t;e++){let i=2*Math.PI*e/t;r[3*(e+1)+0]=Math.cos(i),r[3*(e+1)+1]=Math.sin(i),r[3*(e+1)+2]=s,a[3*e+0]=0,a[3*e+1]=e+1,a[3*e+2]=e+1==t?1:e+2}let n=new e.BufferGeometryDS;n.vertexIndexArray=a,n.vertexPositionArray=r;const o=new i.DrawingGroup(null,null,4,0,a.length);return o.geometry=n,n.drawingGroups=[o],n},homogeneousDistance:function(e,t){const s=e.x/e.w-t.x/t.w,i=e.y/e.w-t.y/t.w,a=e.z/e.w-t.z/t.w;return Math.sqrt(s*s+i*i+a*a)},screenDistance:function(t,s,i=NaN){function a(e,t){const s=e.x/e.w-t.x/t.w,i=e.y/e.w-t.y/t.w;return Math.sqrt(s*s+i*i)}const r=Math.abs(t.z)>Math.abs(t.w),n=Math.abs(s.z)>Math.abs(s.w);if(!r&&!n)return a(t,s);if(r&&n)return i;const o=-(t.w+t.z)/(s.z-t.z+(s.w-t.w)),l=new e.Vector4(t.x+o*(s.x-t.x),t.y+o*(s.y-t.y),t.z+o*(s.z-t.z),t.w+o*(s.w-t.w));return r?a(l,s):a(t,l)}},o=new e.Matrix4,l=new e.Color,h=function({is_triangle_mesh:t,upright:s}){const i={linePointsTexture:{type:"t2",value:null},linePointsTextureSize:{type:"f",value:1},lineShapeColor:{type:"v3",value:new e.Vector3(1,1,1)},lineScreenSpace:{type:"i",value:1},lineShapeThickness:{type:"f",value:1},lineCurvilinearScale:{type:"f",value:1},lineShapeTransform:{type:"m4",value:new e.Matrix4}};let a=new(t?e.MeshBasicMaterial:e.LineBasicMaterial)({color:16777215,force:!0,linecap:"butt"});return a.defines={UPRIGHT_LINETYPES:!1},a.activatePDSFX("PDSFXAdvancedLineTypes"),a.setPDSFXUniforms(i),a.setPDSFXVaryings({curvilinear:{type:"v3"}}),a.setPDSFXGlobalShaderCode((function(e){const t=e.variableHandler,s=e.functionHandler,i=e.bridgeFunctions,a=e.pdsfxDefines,r=t=>e.getUniform(t),n=e=>t.bool(e),o=e=>t.float(e),l=e=>t.vec2(e),h=e=>t.vec3(e),p=e=>t.vec4(e),u=e=>t.mat4(e),c=e.userDefines.UPRIGHT_LINETYPES;return`\n                    ${d="tmpCurve",t.vec3G(d)};\n                    ${s.dF("transpose","m4",[s.prmM4("m")])}\n                    {\n                        ${u("n")};\n                        n[0] = ${p()}(m[0][0], m[1][0], m[2][0], m[3][0]);\n                        n[1] = ${p()}(m[0][1], m[1][1], m[2][1], m[3][1]);\n                        n[2] = ${p()}(m[0][2], m[1][2], m[2][2], m[3][2]);\n                        n[3] = ${p()}(m[0][3], m[1][3], m[2][3], m[3][3]);\n                        return n;\n                    }\n\n                    ${c?`\n                        ${u("uprightTransform")}  = ${u()}(\n                            -1.0, 0.0, 0.0, 0.0,\n                            0.0, -1.0, 0.0, 0.0,\n                            0.0, 0.0, 1.0, 0.0,\n                            1.0, 0.0, 0.0, 1.0\n                        );\n                        `:""}                 \n                    // Utility: transform matrix (clip space -> screen space)\n                    ${s.dF("GetClip2Screen","m4",[])} {\n                        ${l("v")} = ${l()}(${e.vGetViewportSize()}) / 2.0;\n                        return ${u()}(\n                        \tv.x, 0.0, 0.0, 0.0,\n                        \t0.0, v.y, 0.0, 0.0,\n                        \t0.0, 0.0, 1.0, 0.0,\n                        \tv.x, v.y, 0.0, 1.0\n                        );\n                    }\n\n                    // Utility: transform matrix (screen space -> clip space)\n                    ${s.dF("GetScreen2Clip","m4",[])}{\n                        ${l("v")} = ${l()}(${e.vGetViewportSize()}) / 2.0;\n                        return ${u()}(\n                        \t1.0/v.x,     0.0, 0.0, 0.0,\n                        \t    0.0, 1.0/v.y, 0.0, 0.0,\n                        \t    0.0,     0.0, 1.0, 0.0,\n                        \t   -1.0,    -1.0, 0.0, 1.0\n                        );\n                    }\n                        \n                    ${s.dF("GetPoint","v4",[s.prmF("index")])} {\n                        ${o("i")} = floor((index + 0.5) / ${r("linePointsTextureSize")});\n                        ${o("j")} = index - i * ${r("linePointsTextureSize")};\n                        ${o("v")} = (i + 0.5) / (${r("linePointsTextureSize")});\n                        ${o("u")} = (j + 0.5) / (${r("linePointsTextureSize")});\n                        ${l("uv")} = ${l()}(u, v);\n                        return ${i.sample2DTextureGrad((t=>e.getTextureUniform(t))("linePointsTexture"),"uv")};\n                    }\n                    // TODO: check on Apple devices, int cast might be a problem\n                    ${s.dF("GetLinePtRangeBegin","f",[])}{\n                        return lineShapeSegment.z; \n                    }\n                    ${s.dF("GetLinePtRangeEnd","f",[])}{\n                        return lineShapeSegment.w; \n                    }\n                    ${s.dF("GetLineMaxDistance","f",[])}{\n                        ${o("index")} = ${s.cF("GetLinePtRangeEnd","f",[])} - 1.0;\n                        return ${s.cF("GetPoint","v4",[s.prmF("index")])}.w / ${r("lineCurvilinearScale")}; \n                    }\n                    /// Return the segment [i, i+1] to consider for the given curvilinear coord\n                    // The returned value is always valid, however that means that the first segment\n                    // is returned for lx <= 0 and the last segment is returned for lx >= total_distance\n                    ${s.dF("GetLineSegment","f",[s.prmF("lx")])}{\n                        ${o("begin")} = ${s.cF("GetLinePtRangeBegin","f",[])};\n                        ${o("end")}   = ${s.cF("GetLinePtRangeEnd","f",[])};\n                        ${o("i")} = begin + 1.0;\n                        // Hacky unroll\n                        for(${(e=>t.int(e))("aux")} =0; aux<64; aux++)\n                        {\n                            if(i >= end) {\n                                break;\n                            }\n                            ${p("pt")} = ${s.cF("GetPoint","v4",[s.prmF("i")])};\n                            if(lx <= ${s.cF("GetPoint","v4",[s.prmF("i")])}.w / ${r("lineCurvilinearScale")}) {\n                                return i - 1.0;\n                            }\n                            i += 1.0;\n                        }\n                        return end - 2.0;\n                    }\n                    /// Return a transformation from base space to clip space on the segment [Pi, Pj]\n                    // @param  lx  Curvilinear abscissa (screen-space) of where to position the frame\n                    // @param  Pi  Clip coords in XYZ, line distance in W\n                    // @param  Pj  Clip coords in XYZ, line distance in W\n                    // @note The returned matrix is normalized curvilinearly; you need to scale the X axis with the\n                    //       length of the shape (in curvilinear units); you can scale Y with the same factor (to\n                    //       keep the aspect ratio of the shape) or you can directly set the norm of the Y axis (to\n                    //       have a fixed thickness, this will break the aspect ratio).\n                    // @note The returned matrix is not invertible (input Z not used).\n                    ${s.dF("GetLineBase2Clip","m4",[s.prmF("lx"),s.prmV4("Pi"),s.prmV4("Pj")])}{\n                        ${l("half_screen")} = ${l()}(${e.vGetViewportSize()}) / 2.0;\n    \n                        // D.XY = screen delta, D.Z = clip depth delta, D.W = curvilinear delta\n                        ${p("D")}  = Pj - Pi;\n                        D.x *= half_screen.x;\n                        D.y *= half_screen.y;\n    \n                        // Curvilinear normalizations + going back to clip-space\n                        ${o("t")}  = (lx - Pi.w) / D.w;\n                        ${l("sXY")} = ${l()}(length(D.xy) / D.w) / half_screen;\n                        ${o("sZ")} = D.z / D.w;\n\n                        ${u("frame")};\n                        frame[0] = ${p()}(sXY * normalize(${l()}(D.x,  D.y)), sZ, 0.0);\n                        frame[1] = ${p()}(sXY * normalize(${l()}(-D.y, D.x)), 0.0, 0.0);\n                        frame[2] = ${p()}(0.0);\n                        frame[3] = ${p()}(Pi.xy + t * D.xy / half_screen, Pi.z + t * D.z, 1.0);\n                        return frame;\n                    }\n                    /// Return a transformation from base space to model space on the segment [Pi, Pj]\n                    // @param  lx  Curvilinear abscissa of where to position the frame\n                    // @param  Pi  Model coords in XYZ, line distance in W\n                    // @param  Pj  Model coords in XYZ, line distance in W\n                    // @note The returned matrix is normalized curvilinearly; you need to scale the X axis with the\n                    //       length of the shape (in curvilinear units); you can scale Y with the same factor (to\n                    //       keep the aspect ratio of the shape) or you can directly set the norm of the Y axis (to\n                    //       have a fixed thickness, this will break the aspect ratio).\n                    // @note The returned matrix is not invertible (input Z not used).\n                    ${s.dF("GetLineBase2Model","m4",[s.prmF("lx"),s.prmV4("Pi"),s.prmV4("Pj")])}{\n                        ${p("D")} = Pj - Pi;\n                        ${h("N")} = normalize(cross(${h()}(0.0, 0.0, 1.0), D.xyz));\n                        if(dot(N, N) < 0.9) {\n                            N = ${h()}(0.0, 1.0, 0.0);\n                        } \n    \n                        ${o("t")} = (lx - Pi.w) / D.w;\n                        ${o("len")} = length(D.xyz);\n    \n                        ${u("frame")};\n                        frame[0] = ${p()}(D.xyz / D.w, 0.0);\n                        frame[1] = ${p()}(N * len / D.w, 0.0);\n                        frame[2] = ${p()}(0.0);\n                        frame[3] = ${p()}(Pi.xyz + t * D.xyz, 1.0);\n                        return frame;\n                    }\n                    /// Determine the endpoints of the specified segment\n                    ${s.dF("GetLineEndpoints",null,[s.prmF("segment"),s.prmIOV4("Pi"),s.prmIOV4("Pj")])}{\n                        ${o("i")} = segment; \n                        ${o("j")} = segment + 1.0;\n                        ${t.dereference("Pi")} = ${s.cF("GetPoint","v4",[s.prmF("i")])};\n                        ${t.dereference("Pi")}.w /= ${r("lineCurvilinearScale")};\n                        ${t.dereference("Pj")} = ${s.cF("GetPoint","v4",[s.prmF("j")])};\n                        ${t.dereference("Pj")}.w /= ${r("lineCurvilinearScale")};\n                    }\n                    /// Clip the endpoints of the specified segment following the given projection\n                    // @return Whether the whole segment is clipped (ie, to discard)\n                    ${s.dF("ClipLineSegment","b",[s.prmIOV4("Pi"),s.prmIOV4("Pj"),s.prmM4("obj2clip")])}{\n                        ${p("P")} = obj2clip * ${p()}(${t.dereference("Pi")}.xyz, 1.0);\n                        ${p("Q")} = obj2clip * ${p()}(${t.dereference("Pj")}.xyz, 1.0);\n                        ${o("distP")}  = ${t.dereference("Pi")}.w;\n                        ${o("distQ")}  = ${t.dereference("Pj")}.w;\n    \n                        // If both points are clipped, just return that we can discard the segment\n                        ${a.WebGPU?`\n                            ${n("clipP")}  = abs(Q.z) > abs(Q.w);\n                            ${n("clipQ")}  = abs(P.z) > abs(P.w);\n                            `:`\n                            ${n("clipP")}  = abs(P.z) > abs(P.w);\n                            ${n("clipQ")}  = abs(Q.z) > abs(Q.w);\n                            `}\n                        if(clipP && clipQ) {\n                            return true;\n                        }\n    \n                        // Only 1 point is clipped, reproject the other on the near plane and recompute the curvilinear abcissa\n                        if(clipP != clipQ)\n                        {\n                            ${l("half_screen")} = ${l()}(${e.vGetViewportSize()}) / 2.0;\n                            ${o("t")} = -(P.w + P.z) / (Q.z - P.z + (Q.w - P.w));\n                            ${p("R")} = P + t * (Q - P);\n                            if(clipQ) {\n                                P = R;\n                            } else { \n                                Q = R;\n                            }\n                            ${o("new_delta")}  = length((Q.xy / Q.w - P.xy / P.w) * half_screen) / ${r("lineCurvilinearScale")};\n                            if(clipP) {\n                                distP = distQ - new_delta;\n                            } else {\n                                distQ = distP + new_delta;\n                            }\n                        }\n    \n                        ${t.dereference("Pi")} = ${p()}(P.xyz / P.w, distP);\n                        ${t.dereference("Pj")} = ${p()}(Q.xyz / Q.w, distQ);\n                        return false;\n                    }\n                    /// Compute the final (model-space) position from a vertex position\n                    // This function applies the correct transform for the instance.\n                    ${s.dF("ComputeModelPosition","v3",[s.prmV3("input_position"),s.prmIOGV3("curvilinear")])} {\n                        // These could be uniforms but are put here for better optimizations from the GLSL compiler\n                        ${(e=>t.intC(e))("lineKeepShapeAspect")}  = 1;\n    \n                        // Curvilinear abcissa\n                        // 'curvilinear' is the actual abcissa of the vertex and is needed to correctly discard pixels outside of the line\n                        // 'cx' is the curvilinear abscissa we use to recover the frame in which to position our vertex\n                        ${p("base")} = ${r("lineShapeTransform")} * ${p()}(input_position, 1.0);\n                        base /= base.w;\n                        ${o("inst_cx")}  = lineShapeSegment.x;\n                        ${t.dereference("curvilinear")} = ${h()}(inst_cx + base.x * lineShapeSegment.y, base.y, ${s.cF("GetLineMaxDistance","f",[])});\n                        ${o("cx")} = inst_cx + base.z * lineShapeSegment.y;\n                        base.x -= base.z;\n    \n                        // Get the segment on where this curvilinear X lies\n                        ${p("Pi")};\n                        ${p("Pj")};\n                        ${o("lineSeg")} = ${s.cF("GetLineSegment","f",[s.prmF("cx")])};\n                        ${s.cF("GetLineEndpoints",null,[s.prmF("lineSeg"),s.prmRefV4("Pi"),s.prmRefV4("Pj")])};\n                                              \n                        \n                        ${c?`                \n                                ${p("Pimv")}  = ${e.vGetWorldViewMatrix()} * ${p()}( Pi.xyz, 1.0) ;\n                                ${p("Pjmv")}  = ${e.vGetWorldViewMatrix()} * ${p()}( Pj.xyz, 1.0) ;\n                                ${o("dotValue")}  = dot(normalize(Pjmv.xy - Pimv.xy), ${l()}(1.0, 0.0));\n                                if (dotValue < 0.0) {\n                                    base = ${r("lineShapeOriginalTransform")} * uprightTransform * ${r("lineShapeBaseTransform")} * ${p()}(input_position, 1.0);\n                                    base /= base.w;\n                                    ${t.dereference("curvilinear")} = ${h()}(inst_cx + base.x * lineShapeSegment.y, base.y, ${s.cF("GetLineMaxDistance","f",[])};\n                                    cx = inst_cx + base.z * lineShapeSegment.y;\n                                    base.x -= base.z;\n                                    lineSeg= ${s.cF("GetLineSegment","f",[s.prmF("cx")])};\n                                    ${s.cF("GetLineEndpoints",null,[s.prmF("lineSeg"),s.prmRefV4("Pi"),s.prmRefV4("Pj")])};\n                                }\n                            `:""}\n                        if(${r("lineScreenSpace")} > 0 && ${s.cF("ClipLineSegment","b",[s.prmRefV4("Pi"),s.prmRefV4("Pj"),s.prmM4(`${e.vGetProjectionMatrix()} * ${e.vGetWorldViewMatrix()}`)])}){\n                            ${t.dereference("curvilinear")}.x = -1e12;\n                            return ${h()}(1e30, 1e30, 1e30);\n                        }\n    \n                        if(${r("lineScreenSpace")} > 0)\n                        {\n                            // Base -> Clip, from the position on the line\n                            ${u("base2Clip")}  = ${s.cF("GetLineBase2Clip","m4",[s.prmF("cx"),s.prmV4("Pi"),s.prmV4("Pj")])};\n                            base2Clip[0].x *= lineShapeSegment.y;\n                            base2Clip[0].y *= lineShapeSegment.y;\n                            base2Clip[0].z *= lineShapeSegment.y;\n                            if(lineKeepShapeAspect != 0) {\n                                base2Clip[1].x *= lineShapeSegment.y;\n                                base2Clip[1].y *= lineShapeSegment.y;\n                                base2Clip[1].z *= lineShapeSegment.y;\n                            } else {\n                                base2Clip[1] = ${s.cF("GetScreen2Clip","m4",[])} * normalize(${s.cF("GetClip2Screen","m4",[])} * base2Clip[1]) * ${r("lineShapeThickness")};\n                            }\n    \n                            // Final position\n                            ${p("clip")}  = base2Clip * base;\n    \n                            // Hack because PDSFX does not allow to directly return clip coordinates\n                            ${u("clip2obj")}  = ${s.cF("transpose","m4",[s.prmM4(e.vGetWorldViewInvTranspMatrix())])} * ${e.vGetProjectionInvMatrix()};\n                            ${p("model")}  = clip2obj * clip;\n                            return model.xyz / model.w;\n                        }\n                        else\n                        {\n                            // Base -> Model, from the position on the line\n                            ${u("base2Model")}  = ${s.cF("GetLineBase2Model","m4",[s.prmF("cx"),s.prmV4("Pi"),s.prmV4("Pj")])};\n                            base2Model[0].x *= lineShapeSegment.y;\n                            base2Model[0].y *= lineShapeSegment.y;\n                            base2Model[0].z *= lineShapeSegment.y;\n                            base2Model[1].x *= lineShapeSegment.y;\n                            base2Model[1].y *= lineShapeSegment.y;\n                            base2Model[1].z *= lineShapeSegment.y;\n    \n                            // Final position\n                            ${p("model")}  = base2Model * base;\n                            return model.xyz / model.w;\n                        }\n                    }\n                `;var d}),null),a.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){e.variableHandler;const s=e.functionHandler;return`\n                        return ${s.cF("ComputeModelPosition","v3",[s.prmV3(e.vGetAttribPosition()),s.prmRefGV3(e.getVarying("curvilinear"))])};\n                    `},ComputeObjectFollowingPosition:function(e,t){e.variableHandler;const s=e.functionHandler;return`\n                        return ${s.cF("ComputeModelPosition","v3",[s.prmV3(e.vGetAttribFollowingPosition()),s.prmRefGV3("tmpCurve")])};\n                    `},ComputeObjectPreviousPosition:function(e,t){e.variableHandler;const s=e.functionHandler;return`\n                        return ${s.cF("ComputeModelPosition","v3",[s.prmV3(e.vGetAttribPreviousPosition()),s.prmRefGV3("tmpCurve")])};\n                    `}},{ComputeViewNormal:function(e,t){const s=e.variableHandler;return`\n                        if (!(${e.vGetProjectionMatrix()}[3][3] > 0.0)) {\n                            return -normalize(${e.vGetViewPosition()});\n                        }\n                        return ${s.vec3(i)}(0.0, 0.0, -1.0); \n                    `;var i},ComputeAlbedo:function(e,t){const s=t=>e.getUniform(t);return`\n                        return ${s("lineShapeColor")} * ${s("lineShapeColor")};\n                    `},ComputeDiscard:function(e,t){const s=t=>e.getVarying(t);return`\n                        return ${s("curvilinear")}.x > ${s("curvilinear")}.z || ${s("curvilinear")}.x < 0.0;\n                    `}}),a.side=e.Constants.DoubleSide,a},p=function(t,s){void 0!==s.color&&t.updatePDSFXUniform("lineShapeColor",new e.Vector3(s.color.r,s.color.g,s.color.b)),void 0!==s.thickness&&(t.updatePDSFXUniform("lineShapeThickness",s.thickness),t.setLineWidth&&t.setLineWidth(s.thickness)),void 0!==s.patternScale&&t.updatePDSFXUniform("lineCurvilinearScale",s.patternScale),void 0!==s.screenSpace&&t.updatePDSFXUniform("lineScreenSpace",s.screenSpace?1:0),void 0!==s.shapeTransform&&t.updatePDSFXUniform("lineShapeTransform",s.shapeTransform),void 0!==s.shapeOriginalTransform&&t.updatePDSFXUniform("lineShapeOriginalTransform",s.shapeOriginalTransform),void 0!==s.shapeBaseTransform&&t.updatePDSFXUniform("lineShapeBaseTransform",s.shapeBaseTransform),void 0!==s.pointsTexture&&(t.updatePDSFXUniform("linePointsTexture",s.pointsTexture),t.updatePDSFXUniform("linePointsTextureSize",s.pointsTexture.image.width)),void 0!==s.opacity&&(t.opacity=s.opacity)};let u;class c{constructor(e){this.storage=e,this.updateKeys={vertexTransformMatrix:o,patternScale:1,patternOffset:0,start:0,count:0,color:l,opacity:1,thickness:1},this.drawingGroups=null,this.pattern=null,this.patternShapes=null}dispose(){if(this.drawingGroups)for(let e=0;e<this.drawingGroups.length;e++)this.drawingGroups[e].material.dispose(),this.drawingGroups[e].geometry.dispose();this.drawingGroups=null,this.pattern=null,this.patternShapes=null,this.updateKeys={vertexTransformMatrix:o,patternScale:1,patternOffset:0,start:0,count:0,color:l,opacity:1,thickness:1}}_needsUpdate(e,t,s,i){var a=this.updateKeys;this.updateKeys={vertexTransformMatrix:s,patternScale:e.scale/i,patternOffset:0,start:t.start,count:t.count,color:e.color,opacity:e._opacity,thickness:e.lineWidth};var r=this.updateKeys;return a.patternOffset!==r.patternOffset||a.patternScale!==r.patternOffset||a.start!==r.start||a.count!==r.count||a.opacity!==r.opacity||a.thickness!==r.thickness||(!a.color.equals(r.color)||!a.vertexTransformMatrix.equals(r.vertexTransformMatrix))}matches(e){return this.pattern===e._pattern&&this.patternShapes===e._patternShapes}updateMaterials(e,t,s,i){if(this._needsUpdate(e,t,s,i)){const a=!e._worldSizePattern,r=u.computeInstancePlacements({pattern:e._pattern,stride:e._patternStride,patternScale:e.scale/i,subDG:this,interval:t,pointTransform:s,distanceFunction:a?n.screenDistance:n.homogeneousDistance,initial_dist:this.updateKeys.patternOffset,wholePatternsOnly:e._wholePatternsOnly});r.dashes&&e.setDashPatternArray(r.dashes);for(let t=0;t<r.instances.length;t++){const s=this.drawingGroups[t],n=r.instances[t];s.setInstancingParameters(n.count(),[n.attrib],"mesh"),p(s.material,{pointsTexture:this.storage.geometryData.texture,color:e.color,patternScale:e.scale/i,thickness:e.lineWidth,opacity:e.opacity,screenSpace:a,shapeTransform:n.transform,shapeOriginalTransform:n.origTransform,shapeBaseTransform:n.baseTransform});const o=s.geometry.wideLinesLinker&&s.geometry.wideLinesLinker.originalDGToWideDG.get(s);o&&o.setInstancingParameters(n.count(),[n.attrib],"mesh")}}return this.drawingGroups}}class d{constructor(e){this.storage=new Map,this.dg=e,this.geometry=e.geometry,this._invalidator=null,this.geometryData={nbPoints:0,texture:null,starts:null,ids:null,pointTransfo:o,distanceOffset:0}}any(){return this.storage.size>0}checkIfNeedsDGUpdateOrDisposed(e){if(!e._isLineWithShapes||!e._pattern||0===e._patternShapes.length)return this.dispose(e),!0;if(!this.storage.has(e))return!1;return this.storage.get(e).matches(e)||this.dispose(e),!1}dispose(e=null){e?this.storage.has(e)&&(this.storage.get(e).dispose(),this.storage.delete(e)):(this.storage.forEach(((e,t)=>e.dispose())),this.storage.clear()),!this.any()&&this._invalidator&&(a.unsubscribe(this._invalidator),this._invalidator=null,this.geometryData.texture&&this.geometryData.texture.dispose(),this.geometryData={nbPoints:0,texture:null,starts:null,ids:null,pointTransfo:o,distanceOffset:0})}needsDGs(e){return!this.storage.has(e)||null===this.storage.get(e).drawingGroups}updateShapes(e,t,s){if(!this._invalidator){const e=this;this._invalidator=a.subscribe({event:"/VISU/_LINESHAPES_DG_UPDATE"},(function(t){t.extraData.geometry===e.geometry&&e.dispose()}))}let i=this.storage.get(e);i||(i=new c(this),this.storage.set(e,i)),i.drawingGroups=t;for(let e=0;e<t.length;e++)t[e]._updateLineWithShapes=s;i.pattern=e._pattern,i.patternShapes=e._patternShapes}updateMaterials(e,t,s,i){return this.storage.has(e)?this.storage.get(e).updateMaterials(e,t,s,i):[]}_needsGeomUpdate(){return!this.geometryData.texture}_needsDistanceUpdate(e,t){return this.geometryData.distanceOffset!==t||!this.geometryData.pointTransfo.equals(e)}_setGeometryData(t,s,i,a,r){const n=t.length/4,o=Math.ceil(Math.sqrt(n));var l=new Float32Array(4*o*o);for(let e=0;e<t.length;e++)l[e]=t[e];var h=new e.DataTexture(l,o,o,e.RGBAFormat,e.FloatType);h.minFilter=h.magFilter=e.NearestFilter,h.flipY=!1,h.needsUpdate=!0,this.geometryData={nbPoints:n,texture:h,starts:s,ids:i,pointTransfo:a,distanceOffset:r}}}const f={isValidPattern:e=>Array.isArray(e)||ArrayBuffer.isView(e),isDashPatternArray:e=>e.length>0&&"number"==typeof e[0],segmentIsDash:e=>e.length>0&&(void 0===e.shape||null===e.shape),segmentIsShape:e=>e.length>0&&void 0!==e.shape&&null!==e.shape,segmentIsOnEmptySpaceShape:e=>e.length>0&&void 0!==e.shape&&null!==e.shape&&!e.onSolidLine,segmentIsPoint:e=>0===e.length,collapseSameSign:function(e){if(0===e.length)return e;let t=0;for(let s=1;s<e.length;s++){const i=e[s];Math.sign(e[t])*Math.sign(i)>-.5?e[t]+=i:++t!==s&&(e[t]=i)}return e.length=t+1,e},instantiatePatternPoints:function(e,t,s,i){let a=!1;for(let r=0;r<e.length;r++){let n=e[r];this.segmentIsPoint(n)&&(n.length=s/i,n.shape=t.length,a=!0)}return a&&t.push(n.createDiskXY(31).drawingGroups[0]),a},extractDashPattern:function(e){const t=this.collapseSameSign(e.map((e=>this.segmentIsOnEmptySpaceShape(e)?-e.length:e.length)));return Float32Array.from(t,Math.abs)},trimUnusedShapes:function(e,t){let s=new Set(e.filter(this.segmentIsShape).map((e=>e.shape)));if(s=[...s].sort(((e,t)=>e-t)),0===s.length)return[];if(s[s.length-1]>=t.length)return console.error(`Complex line pattern requires shape n${s[s.length-1]}, but only ${t.length} were specified. No shapes will be used.`),[];for(let t=0;t<e.length;t++){let i=e[t];this.segmentIsShape(i)&&(i.shape=s.indexOf(i.shape))}return s.map((e=>t[e]))},setSegmentTransforms4x4:function(t){for(let s=0;s<t.length;s++){const i=t[s];if(i.matrix)if(16!==i.matrix.elements.length){let t=i.matrix.elements;i.matrix=new e.Matrix4,i.matrix.elements=[t[0],t[1],0,t[2],t[3],t[4],0,t[5],0,0,1,0,t[6],t[7],0,t[8]]}else if(!(i.matrix instanceof e.Matrix4)){const t=i.matrix.elements;i.matrix=new e.Matrix4,i.matrix.elements=t}}},computeOffsetsAndStride:function(e){let t=0;for(let s=0;s<e.length;s++){let i=e[s];i.offset=t,t+=Math.abs(i.length)}return t},computeBaseTransform:function(t){const s=1/t.size().x,i=new e.Vector3(-s*t.min.x,-s*(t.min.y+t.max.y)/2,0);let a=(new e.Matrix4).makeScale(s,s,1);return a.setPosition(i),a},computeBaseTransformNoScale:function(t){const s=new e.Vector3(-t.min.x,-(t.min.y+t.max.y)/2,0);let i=new e.Matrix4;return i.setPosition(s),i},normalizeSegments:function(t,s){for(let i=0;i<t.length;i++){let a,r=t[i];if(!this.segmentIsShape(r))continue;const n=s[r.shape],l=n.start,h=n.start+n.count,p=new e.Box3,u=new e.Vector3;for(let e=l;e<h;e++)n.geometry.getVertexPosition(n.geometry.vertexIndexArray[e],u),p.expandByPoint(u);a=r.noFit?this.computeBaseTransformNoScale(p):this.computeBaseTransform(p),r.upright&&(r.originalMatrix=r.matrix?(new e.Matrix4).copy(r.matrix):o,r.toBaseMatrix=a),r.matrix?r.matrix.multiply(a):r.matrix=a}}};function m(e,t,s){var i=e.getBaseId();if(i+="GT-Edge"+t+"S"+e.side+"CP"+e.enableClipPlanes+"TR"+(e.transparent||e.getOpacity()<1)+"LW"+e.lineWidth+NaN+e.lineGap,i+="PBM"+e.polygonBorderMode,i+="LC"+e.linecap+"LJ"+e.linejoin,i+="O"+e.opacity,e.lineGap>0&&null!==e.lineGapColor&&(i+="LWCR"+e.lineGapColor.r+"G"+e.lineGapColor.g+"B"+e.lineGapColor.b),e.isDashedLine){i+="SC"+e.scale,i+="IP"+e._invertedPattern+"WS"+e._worldSizePattern+"CPU"+e.isCPUPattern;for(var a=0;a<e.dashPattern.length;a++){i+=a+"p"+e.dashPattern[a]}}return i="id"+(i+=s||"").hashCode()}function C(t,s){var i={color:s||new e.Color,opacity:t.opacity,side:t.side,lineWidth:t.lineWidth,lineGap:t.lineGap,lineGapColor:t.lineGapColor,enableClipPlanes:t.enableClipPlanes,linejoin:t.linejoin,linecap:t.linecap,scale:t.scale,isCPUPattern:t.isCPUPattern,patternOffset:t.patternOffset,transparent:t.transparent||t.getOpacity()<1,polygonBorderMode:t.polygonBorderMode,invertedPattern:t._invertedPattern,_worldSizePattern:t._worldSizePattern};if(t.isDashedLine){i.dashPattern=new Float32Array(t.dashPattern);for(var a=i.dashPattern.length-1;a>0;a--)i.dashPattern[a]-=i.dashPattern[a-1]}return i}u={distanceOnly({dgStorage:t,pointTransform:s,distanceFunction:i,initial_dist:a=0}){const r=t.dg,n=t.geometry,o=n.vertexIndexArray,l=r.start,h=r.count;let p=t.geometryData.texture.image.data,u=new e.Vector4,c=new e.Vector4,d=new e.Vector3,f=new e.Vector3,m=0;for(var C=0;C<h;C++){const e=C+l;if(C>0){const t=o[e],r=o[e-1];if(t===r)continue;n.getVertexPosition(t,d),n.getVertexPosition(r,f);const l=d.distanceTo(f);if(Math.abs(l)>1e-6)if(C%2==0)p[4*m+3]=a,m++;else{c.set(d.x,d.y,d.z,1).applyMatrix4(s),u.set(f.x,f.y,f.z,1).applyMatrix4(s);let e=i(u,c);const t=p[4*m-1];p[4*m+3]=t+e,m++}}else p[4*m+3]=a,m++}},stripsDistanceAndSubStrips({dgStorage:t,pointTransform:s,distanceFunction:i,initial_dist:a=0}){const r=t.dg,n=t.geometry,o=n.vertexIndexArray,l=r.start,h=r.count;let p=[],u=[],c=[],d=new e.Vector4,f=new e.Vector4,m=new e.Vector3,C=new e.Vector3,S=0;for(var M=0;M<h;M++){const e=M+l;if(M>0){const t=o[e],r=o[e-1];if(t===r)continue;n.getVertexPosition(t,m),n.getVertexPosition(r,C);const l=m.distanceTo(C);if(Math.abs(l)>1e-6)if(M%2==0)u.push(S),S++,p.push(m.x),p.push(m.y),p.push(m.z),p.push(a),c.push(e);else{f.set(m.x,m.y,m.z,1).applyMatrix4(s),d.set(C.x,C.y,C.z,1).applyMatrix4(s);let t=i(d,f);const a=p[4*S-1];S++,p.push(m.x),p.push(m.y),p.push(m.z),p.push(a+t),c.push(e)}else c[S]=e}else{const t=o[e];n.getVertexPosition(t,m),u.push(S),S++,p.push(m.x),p.push(m.y),p.push(m.z),p.push(a),c.push(e)}}return{points:p,starts:u,ids:c}},computeInstancePlacements:function({pattern:e,stride:t,patternScale:s,subDG:i,interval:a,pointTransform:r,distanceFunction:n,initial_dist:o=0,wholePatternsOnly:l=!1}){const h=i.storage;if(h._needsGeomUpdate()){const e=this.stripsDistanceAndSubStrips({dgStorage:h,pointTransform:r,distanceFunction:n,initial_dist:o});h._setGeometryData(e.points,e.starts,e.ids,r,o)}else h._needsDistanceUpdate(r,o)&&(this.distanceOnly({dgStorage:h,pointTransform:r,distanceFunction:n,initial_dist:o}),h.geometryData.texture.needsUpdate=!0,h.geometryData.distanceOffset=o,h.geometryData.pointTransfo=r);let p=h.geometryData,u=e.map((e=>Number.isInteger(e.shape)?{count:function(){return this.attrib.data.length/4},transform:e.matrix,origTransform:e.upright?e.originalMatrix:void 0,baseTransform:e.upright?e.toBaseMatrix:void 0,attrib:{attribName:"lineShapeSegment",type:"v4",isFlattened:!0,data:[]}}:null));function c(s,i,a,r,n=0){if(s>i)return;const o=Math.floor(s/t),l=Math.ceil(i/t);for(let h=o;h<l;h++){const o=h*t;for(let t=0;t<e.length;t++){if(null===u[t])continue;const l=e[t],h=o+l.offset;h<s||h>=i||u[t].attrib.data.push(h+n,l.length,a,r)}}}function d(s,i,a){const r=t*Math.floor(s/t);for(let t=0;t<e.length;t++){if(null===u[t])continue;const n=e[t],o=r+n.offset,l=o+n.length;o>=s||l<=s||u[t].attrib.data.push(o,n.length,i,a)}}function m(e){for(let t=0;t<u.length;t++){if(null===u[t])continue;const s=u[t].count();if(s<1)continue;let i=u[t].attrib;const a=i.data[4*(s-1)+3];(a<0||a>e)&&(i.data[4*(s-1)+3]=e)}}const C=p.nbPoints,S=p.starts,M=p.starts.length;function _(e){return p.texture.image.data[4*e+3]/s}const g=p.ids,v=a.start,P=a.start+a.count;function y(e){return e>=v&&e<P}for(let e=0;e<M;e++){const s=S[e],i=e+1<M?S[e+1]:C;if(l){const e=_(s),a=_(i-1)-e,r=t*Math.floor(a/t),n=e+(a-r)/2;for(let t=s;t+1<i;t++)y(g[t])&&c(_(t)-e,Math.min(_(t+1)-e,r),t,-1,n)}else{y(g[s])&&d(_(s),s,-1);for(let e=s;e+1<i;e++)y(g[e])&&c(_(e),_(e+1),e,-1)}m(i)}for(let e=0;e<u.length;e++){if(null===u[e])continue;const t=u[e].count();let s=u[e].attrib;if(t<1)continue;let i=C;for(let e=t-1;e>=0;e--){let t=s.data[4*e+3];t>=0&&t<i&&(i=t),t=s.data[4*e+2];const a=Math.max(s.data[4*e+0],s.data[4*e+0]+s.data[4*e+1]);for(;a>_(t)&&t<i;)t++;t<i&&t++,s.data[4*e+3]=t,t<i&&(i=t)}}let T=null;if(l){T=[];const s=f.collapseSameSign(e.map((e=>f.segmentIsShape(e)?-e.length:e.length)));for(let e=0;e<M;e++){const i=S[e],a=e+1<M?S[e+1]:C,r=_(i),n=_(a-1)-r,o=Math.floor(n/t);if(o<1){T.push(n+2*r);continue}const l=r+(n-t*o)/2;T.push(l);for(let e=0;e<s.length*o;e++)T.push(s[e%s.length]);T.push(l)}T=Float32Array.from(f.collapseSameSign(T),Math.abs)}return{distances:_,instances:u.filter((e=>null!==e)),dashes:T}},createShapeDrawingGroup:function(e,t){let s=h({is_triangle_mesh:4===e.glType,upright:t});const a=new i.DrawingGroup(void 0,s,e.glType,e.start,e.count);return a._primitives=[{group:a,start:a.start,count:a.count}],a.geometry=e.geometry,a},computeDependentDGs:function(e,t,s,i,a){let r={needProjectionMatrix:!s._worldSizePattern,frameIndex:-1,cb:(i,a)=>this.computeDependentDGs(e,t,s,i,a)},n=e._dependentDGs;if(n||(n=e._dependentDGs=new d(e)),n.checkIfNeedsDGUpdateOrDisposed(s)||!e.geometry.vertexIndexArray)return n.any()||(e._dependentDGs=null),[];if(n.needsDGs(s)){const e=s._pattern.map((e=>Number.isInteger(e.shape)?{geometry:s._patternShapes[e.shape],upright:e.upright}:null)).filter((e=>null!==e)).map((e=>this.createShapeDrawingGroup(e.geometry,e.upright)));n.updateShapes(s,e,r)}return n.updateMaterials(s,t,i,a,this)}};class S extends t{constructor(e){e&&e.lineWidth&&(e.lineWidth=Math.round(e.lineWidth)),super(e),this._isLineWithShapes=!1,this._isBidimLine=!1,this._pattern=null,this._patternShapes=[],this._patternStride=NaN,this._worldSizePattern=e&&!!e._worldSizePattern,this._wholePatternsOnly=e&&!!e._wholePatternsOnly,this.polygonBorderMode=e&&!!e.polygonBorderMode,this.lineGap=e&&e.lineGap>0?e.lineGap:0,this.lineGapColor=e&&e.lineGapColor?e.lineGapColor.clone():null,this.lineGap>0&&(console.error("LineGap is for testing only, do not use in production"),this.linejoin="miter","round"===this.linecap&&(this.linecap="square")),this._worldSizePattern&&(this.backMaterial&&this.backMaterial._worldSizePattern!==this._worldSizePattern&&this.setBackMaterial(null),this.isCPUPattern&&this.setCPUPattern(!1),this.linecap="butt"),this.isWideLine=this._isWideLine(),this.backMaterial&&(this.backMaterial.isWideLine=this.backMaterial.lineWidth+this.backMaterial.lineGap>1||this.isCPUPattern&&this.backMaterial.isDashedLine),e&&e.pattern&&this.setPattern({pattern:e.pattern,shapes:e.patternShapes}),this._wholePatternsOnly&&(this._isBidimLine=!1,this._invertedPattern=!1)}_isWideLine(){return this.lineWidth+this.lineGap>1||this.isCPUPattern&&this.isDashedLine}clone(){var e=new S;return super.clone(e),e.polygonBorderMode=this.polygonBorderMode,e._isBidimLine=this._isBidimLine,e._isLineWithShapes=this._isLineWithShapes,e._pattern=this._pattern,e._patternShapes=this._patternShapes,e._patternStride=this._patternStride,e}_updateDashPattern(e=!1){super._updateDashPattern(e||this._wholePatternsOnly&&this._pattern)}_setMaterialShaderOptions(e,t,s,i,a,r){super._setMaterialShaderOptions(e,t,s,i,a,r);var n={},o=this;r||Object.assign(n,{worldSizePattern:o._worldSizePattern,cpuPattern:o.isCPUPattern,useLineGapColor:o.isWideLine&&o.lineGap>0&&!!o.lineGapColor}),Object.assign(n,{useLineGap:o.isWideLine&&o.lineGap>0,projectLineZToPolygon:o.isDashedLine&&o._worldSizePattern||o.polygonBorderMode}),this._pattern&&(n.linecap="butt"),Object.assign(e,n)}setPattern(e){if(!e||!e.pattern)return this._isLineWithShapes=!1,this._isBidimLine=!1,this._pattern=null,this._patternShapes=[],this._patternStride=NaN,this.setDashPatternArray([]),this._invalidateDisplayRangeLists(),void this.updateDeferredMaterials();if(!f.isValidPattern(e.pattern))return void console.error("Invalid pattern: expected an array (of numbers or of segments), got: ",e.pattern);if(f.isDashPatternArray(e.pattern))return void this.setDashPatternArray(e.pattern);let t=JSON.parse(JSON.stringify(e.pattern)),s=(e.shapes||[]).slice();f.setSegmentTransforms4x4(t),f.instantiatePatternPoints(t,s,this.lineWidth,this.scale),this.setInvertedPattern(!f.segmentIsDash(t[0])),this.setDashPatternArray(f.extractDashPattern(t)),s=f.trimUnusedShapes(t,s),0!==s.length&&(this.setCPUPattern(!0),f.normalizeSegments(t,s),this._pattern=t,this._patternShapes=s,this._patternStride=f.computeOffsetsAndStride(this._pattern),this._isLineWithShapes=!0,this._isBidimLine=!this._pattern.some(f.segmentIsDash),this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())}loadUniforms(e,t,s,i,a,n){if(super.loadUniforms(e,t,s,i,a,n),s.halfWidth&&t.uniform1f(s.halfWidth,this.lineWidth?e._renderScale*this.lineWidth/2:.5),s.lineGap&&(t.uniform1f(s.lineGap,this.lineGap),s.lineGapColor)){var o=this.lineGapColor;e.gammaInput&&(o=r.copyToLinear(o,e.simpleGamma)),t.uniform3f(s.lineGapColor,o.r,o.g,o.b)}if(s.scale){var l=this._worldSizePattern?1:e._renderScale;t.uniform1f(s.scale,this.scale?l*this.scale:.15)}this._pattern&&s.patternOffset&&t.uniform1f(s.patternOffset,0)}fillUBO(e,t){super.fillUBO(e,t);const s=e.layout;if(s.halfWidth&&e.setF(s.halfWidth,this.lineWidth?t._renderScale*this.lineWidth/2:.5),s.lineGap&&(e.setF(s.lineGap,this.lineGap),s.lineGapColor&&e.setColor(s.lineGapColor,this.lineGapColor,t.gammaInput,t.simpleGamma)),s.scale){var i=this._worldSizePattern?1:t._renderScale;e.setF(s.scale,this.scale?i*this.scale:.15)}this._pattern&&s.patternOffset&&e.setF(s.patternOffset,0)}getType(){return this._isFromGAS?"GASLine":"Line"}_computeDependentDGs(e,t,s,i){return u.computeDependentDGs(e,t,this,s,i)}setLineWidth(e){e<1&&(e=1);var t=Math.round(e);if(Math.abs(this.lineWidth-t)>1e-6){this._revision++;var s=this.isWideLine;this.lineWidth=t,this.polygonBorderMode&&(this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1,this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1,this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-10),this.isWideLine=this._isWideLine(),s!==this.isWideLine&&(this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())}}setLineGap(e,t=void 0){e<0?e=0:e>0&&console.error("LineGap is for testing only, do not use in production");let s=!1;if(null===t&&this.lineGapColor?(this.lineGapColor=null,this._revision++,s=!0):t&&(s=!this.lineGapColor,this.lineGapColor=t.clone(),this._revision++),this.lineGap!==e){this._revision++;let t=this.lineGap;var i=this.isWideLine;this.lineGap=e,this.isWideLine=this._isWideLine(),(0===t&&e>0||t>0&&0===e||i!==this.isWideLine)&&(s=!0),this.setLineJoin(this.linejoin),this.setLineCap(this.lineGap)}s&&(this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())}setLineJoin(e){this.lineGap>0&&"miter"!==e&&(console.warn("LineGap enabled, only allowed values are 'miter', defaulting to 'miter'"),e="miter"),super.setLineJoin(e)}setLineCap(e){this.lineGap>0&&"square"!==e&&"butt"!==e&&(console.warn("LineGap enabled, only allowed values are 'square' and 'butt', defaulting to 'square'"),e="square"),super.setLineCap(e)}getGeomTypeDeferredMaterial(t,s){return t&e.GeomTypeEnum.BOUNDARY_EDGE?this._getBoundaryEdgeMaterial(s.boundaryEdge):t&e.GeomTypeEnum.SMOOTH_EDGE?this._getSmoothEdgeMaterial(s.smoothEdge):this}setBackMaterial(e){e&&e._worldSizePattern!==this._worldSizePattern?console.error("Non matching pattern units in back material"):(super.setBackMaterial(e),this.backMaterial&&(this.backMaterial.isWideLine=this.backMaterial.lineWidth+this.backMaterial.lineGap>1||this.isCPUPattern&&this.backMaterial.isDashedLine),this.updateDeferredMaterials())}setDashPatternArray(e){super.setDashPatternArray(e),this.needsUpdate&&(this.isWideLine=this._isWideLine())}setCPUPattern(e){this._worldSizePattern&&e&&(e=!1),this.isCPUPattern!==e&&(this.isCPUPattern=e,this.needsUpdate=!0,this.isWideLine=this._isWideLine(),null!==this.backMaterial&&(this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern&&this.backMaterial.isDashedLine,this.backMaterial.needsUpdate=!0,this.backMaterial._invalidateDisplayRangeLists(),this.backMaterial.updateDeferredMaterials()),this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())}_getBoundaryEdgeMaterial(t){if(!t.enabled)return this;var i=m(this,e.GeomTypeEnum.BOUNDARY_EDGE);if(s.GeomTypeMaterials.has(i))return s.GeomTypeMaterials.get(i).get(this);var a=C(this,null),r=new S(a);r.color=t.color;var n=new s.DeferredMaterial(r);return s.GeomTypeMaterials.set(i,n),n.get(this)}_getSmoothEdgeMaterial(t){if(!t)return this;var i=m(this,e.GeomTypeEnum.SMOOTH_EDGE,"Col"+this.color.getHex());if(s.GeomTypeMaterials.has(i))return s.GeomTypeMaterials.get(i).get(this);var a=C(this,this.color);a.opacity*=.5;var r=new S(a),n=new s.DeferredMaterial(r);return s.GeomTypeMaterials.set(i,n),n.get(this)}_getBodyEdgeMaterial(){var e="BodyEdgeM"+this.id;if(e="id"+e.hashCode(),s.GeomTypeMaterials.has(e))return s.GeomTypeMaterials.get(e).get(this);var t=this.clone();t.setLineWidth(1),t.setLineGap(0),t.setDashPatternType("Solid"),this.politeMaterial&&(t.politeMaterial=this.politeMaterial&&(this.politeMaterial.isWideLine||this.politeMaterial.isDashedLine)?this.politeMaterial._getBodyEdgeMaterial():this.politeMaterial);var i=new s.DeferredMaterial(t);return s.GeomTypeMaterials.set(e,i),i.get(this)}_getLineMaterialFromFaceMaterial(e){if(!this._isFromGAS||e._isFromGAS||!this.isWideLine&&!this.isDashedLine)return e;var t="Other"+e.id;if(s.DefaultMaterials.has(t)){const i=s.DefaultMaterials.get(t).get(this);return i._PDSFXData=e._PDSFXData,i.useGASColor=e.useGASColor,i.color.copy(e.color),i._transparent=e._transparent,i._opacity=e._opacity,i}const i=this.clone();return i._isFromGAS=!1,i.useGASColor=e.useGASColor,i._PDSFXData=e._PDSFXData,i.color.copy(e.color),i._transparent=e._transparent,i._opacity=e._opacity,i}}return S.prototype._shaderID="line",S})),define("DS/Materials/PhysicalMaterialContainers",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial"],(function(e,t){"use strict";const s={SPEC_GLOSS:0,SPEC_GLOSS_NRE:.5,DSPBR:1,DSPBR21x:2,DSPBR22x:3,DSPBR25x:4};e.PhysicalMaterialMode=s;const i={_NO_SHEEN:"NONE",VELVET:"USE_VELVET",VELVET_SOFT:"USE_SOFT_VELVET",SATIN:"USE_SATIN"};e.SheenMode=i;const a={None:-1,Apple:0,Chicken1:1,Chicken2:2,Cream:3,Ketchup:4,Marble:5,Potato:6,Skimmilk:7,Skin1:8,Skin2:9,Wholemilk:10};e.SubsurfaceScatteringPresets=a;var r=[{absorptionCoeffs:[.003,.0034,.046],scatteringCoeffs:[2.29,2.39,1.97]},{absorptionCoeffs:[.015,.077,.19],scatteringCoeffs:[.15,.21,.38]},{absorptionCoeffs:[.018,.088,.2],scatteringCoeffs:[.19,.25,.32]},{absorptionCoeffs:[2e-4,.0028,.0163],scatteringCoeffs:[7.38,5.47,3.15]},{absorptionCoeffs:[.061,.97,1.45],scatteringCoeffs:[.18,.07,.03]},{absorptionCoeffs:[.0021,.0041,.0071],scatteringCoeffs:[2.19,2.62,3]},{absorptionCoeffs:[.0024,.009,.12],scatteringCoeffs:[.68,.7,.55]},{absorptionCoeffs:[.0014,.0025,.0142],scatteringCoeffs:[.7,1.22,1.9]},{absorptionCoeffs:[.032,.17,.48],scatteringCoeffs:[.74,.88,1.01]},{absorptionCoeffs:[.013,.07,.145],scatteringCoeffs:[1.09,1.59,1.79]},{absorptionCoeffs:[.0011,.0024,.014],scatteringCoeffs:[2.55,3.21,3.77]}];e.__DefaultUVTransform__=e.__DefaultUVTransform__||new e.Matrix3;const n=e.__DefaultUVTransform__,o=new e.Color;var l=function(e){return null===e||e.isIdentity()?n:e};const h=new Set;h.add("__parent__"),h.add("__needDisplacementUpdate"),h.add("_sssLUT"),h.add("_scatteringCoeffs"),h.add("_absorptionCoeffs"),h.add("_translucencyDepth"),h.add("_updateSSS"),h.add("_subsurface");class p{constructor(e,t){this.__parent__=t}loadUniforms(e,t,s,i){}fillUBO(e,t){}setParameters(t){var s=this.__parent__,i={};if(s&&!s.needsUpdate&&this.setMaterialShaderOptions(i),e.setValuesToObject(this,t,h),s&&!s.needsUpdate){var a={};this.setMaterialShaderOptions(a);for(var r=Object.keys(i),n=0;n<r.length;n++)if(i[r[n]]!==a[r[n]]){s.needsUpdate=!0;break}}}isEnabled(){return!1}setMaterialShaderOptions(e){}getTextures(){return[]}_isTextureAvailable(e){return t.__isTextureAvailable(this,e)}clone(e){return null}}class u extends p{constructor(t,s){super(t,s),this.flakesCoverage=0,this.flakesCoverageMap=null,this.flakesCoverageAddCoef=null,this.flakesCoverageMulCoef=null,this.flakesCoverageUvTransform=n,this.flakesSize=0,this.flakesSizeMap=null,this.flakesSizeAddCoef=null,this.flakesSizeMulCoef=null,this.flakesSizeUvTransform=n,this.flakesRoughness=0,this.flakesRoughnessMap=null,this.flakesRoughnessAddCoef=null,this.flakesRoughnessMulCoef=null,this.flakesRoughnessUvTransform=n,this.flakesColor=new e.Color(16777215),this.flakesColorMap=null,this.flakesColorAddCoef=null,this.flakesColorMulCoef=null,this.flakesColorUvTransform=n,this.flipFlopColor=new e.Color(16777215),this.flipFlopColorMap=null,this.flipFlopColorAddCoef=null,this.flipFlopColorMulCoef=null,this.flipFlopColorUvTransform=n,this.flipFlop=0,this.flipFlopMap=null,this.flipFlopAddCoef=null,this.flipFlopMulCoef=null,this.flipFlopUvTransform=n,this.setParameters(t)}loadUniforms(e,t,s,i){var a;this.isEnabled()&&(s.flakesColor&&(a=e.gammaInput?o.copyToLinear(this.flakesColor,e.simpleGamma):this.flakesColor,t.uniform3f(s.flakesColor,a.r,a.g,a.b)),s.flakesColorMap&&(e.loadTexture(t,s.flakesColorMap,this.flakesColorMap),t.uniformMatrix3fv(s.flakesColorUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.flakesColorUvTransform.elements))),s.flakesColorMulCoef&&(t.uniform3f(s.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z),t.uniform3f(s.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)),s.flakesCoverage&&t.uniform1f(s.flakesCoverage,this.flakesCoverage),s.flakesCoverageMap&&(e.loadTexture(t,s.flakesCoverageMap,this.flakesCoverageMap),t.uniformMatrix3fv(s.flakesCoverageUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.flakesCoverageUvTransform.elements))),s.flakesCoverageMulCoef&&(t.uniform1f(s.flakesCoverageMulCoef,this.flakesCoverageMulCoef),t.uniform1f(s.flakesCoverageAddCoef,this.flakesCoverageAddCoef)),s.flakesSize&&t.uniform1f(s.flakesSize,this.flakesSize),s.flakesSizeMap&&(e.loadTexture(t,s.flakesSizeMap,this.flakesSizeMap),t.uniformMatrix3fv(s.flakesSizeUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.flakesSizeUvTransform.elements))),s.flakesSizeMulCoef&&(t.uniform1f(s.flakesSizeMulCoef,this.flakesSizeMulCoef),t.uniform1f(s.flakesSizeAddCoef,this.flakesSizeAddCoef)),s.flakesRoughness&&t.uniform1f(s.flakesRoughness,this.flakesRoughness),s.flakesRoughnessMap&&(e.loadTexture(t,s.flakesRoughnessMap,this.flakesRoughnessMap),t.uniformMatrix3fv(s.flakesRoughnessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.flakesRoughnessUvTransform.elements))),s.flakesRoughnessMulCoef&&(t.uniform1f(s.flakesRoughnessMulCoef,this.flakesRoughnessMulCoef),t.uniform1f(s.flakesRoughnessAddCoef,this.flakesRoughnessAddCoef)),s.flipFlop&&t.uniform1f(s.flipFlop,this.flipFlop),s.flipFlopMap&&(e.loadTexture(t,s.flipFlopMap,this.flipFlopMap),t.uniformMatrix3fv(s.flipFlopUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.flipFlopUvTransform.elements))),s.flipFlopMulCoef&&(t.uniform1f(s.flipFlopMulCoef,this.flipFlopMulCoef),t.uniform1f(s.flipFlopAddCoef,this.flipFlopAddCoef)),s.flipFlopColor&&(a=e.gammaInput?o.copyToLinear(this.flipFlopColor,e.simpleGamma):this.flipFlopColor,t.uniform3f(s.flipFlopColor,a.r,a.g,a.b)),s.flipFlopColorMap&&(e.loadTexture(t,s.flipFlopColorMap,this.flipFlopColorMap),t.uniformMatrix3fv(s.flipFlopColorUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.flipFlopColorUvTransform.elements))),s.flipFlopColorMulCoef&&(t.uniform3f(s.flipFlopColorMulCoef,this.flipFlopColorMulCoef.x,this.flipFlopColorMulCoef.y,this.flipFlopColorMulCoef.z),t.uniform3f(s.flipFlopColorAddCoef,this.flipFlopColorAddCoef.x,this.flipFlopColorAddCoef.y,this.flipFlopColorAddCoef.z)))}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.flakesColor&&e.setColor(s.flakesColor,this.flakesColor,t.gammaInput,t.simpleGamma),s.flakesColorMap&&e.setTexture(s.flakesColorMap,this.flakesColorMap),s.flakesColorUvTransform&&e.setM3(s.flakesColorUvTransform,this.flakesColorUvTransform),s.flakesColorAddCoef&&(e.setV3(s.flakesColorAddCoef,this.flakesColorAddCoef),e.setV3(s.flakesColorMulCoef,this.flakesColorMulCoef)),s.flakesCoverage&&e.setF(s.flakesCoverage,this.flakesCoverage),s.flakesCoverageMap&&e.setTexture(s.flakesCoverageMap,this.flakesCoverageMap),s.flakesCoverageUvTransform&&e.setM3(s.flakesCoverageUvTransform,this.flakesCoverageUvTransform),s.flakesCoverageAddCoef&&(e.setF(s.flakesCoverageAddCoef,this.flakesCoverageAddCoef),e.setF(s.flakesCoverageMulCoef,this.flakesCoverageMulCoef)),s.flakesSize&&e.setF(s.flakesSize,this.flakesSize),s.flakesSizeMap&&e.setTexture(s.flakesSizeMap,this.flakesSizeMap),s.flakesSizeUvTransform&&e.setM3(s.flakesSizeUvTransform,this.flakesSizeUvTransform),s.flakesSizeAddCoef&&(e.setF(s.flakesSizeAddCoef,this.flakesSizeAddCoef),e.setF(s.flakesSizeMulCoef,this.flakesSizeMulCoef)),s.flakesRoughness&&e.setF(s.flakesRoughness,this.flakesRoughness),s.flakesRoughnessMap&&e.setTexture(s.flakesRoughnessMap,this.flakesRoughnessMap),s.flakesRoughnessUvTransform&&e.setM3(s.flakesRoughnessUvTransform,this.flakesRoughnessUvTransform),s.flakesRoughnessAddCoef&&(e.setF(s.flakesRoughnessAddCoef,this.flakesRoughnessAddCoef),e.setF(s.flakesRoughnessMulCoef,this.flakesRoughnessMulCoef)),s.flipFlop&&e.setF(s.flipFlop,this.flipFlop),s.flipFlopMap&&e.setTexture(s.flipFlopMap,this.flipFlopMap),s.flipFlopUvTransform&&e.setM3(s.flipFlopUvTransform,this.flipFlopUvTransform),s.flipFlopAddCoef&&(e.setF(s.flipFlopAddCoef,this.flipFlopAddCoef),e.setF(s.flipFlopMulCoef,this.flipFlopMulCoef)),s.flipFlopColor&&e.setColor(s.flipFlopColor,this.flipFlopColor,t.gammaInput,t.simpleGamma),s.flipFlopColorMap&&e.setTexture(s.flipFlopColorMap,this.flipFlopColorMap),s.flipFlopColorUvTransform&&e.setM3(s.flipFlopColorUvTransform,this.flipFlopColorUvTransform),s.flipFlopColorAddCoef&&(e.setV3(s.flipFlopColorAddCoef,this.flipFlopColorAddCoef),e.setV3(s.flipFlopColorMulCoef,this.flipFlopColorMulCoef))}isEnabled(){var e=this.__parent__._PDSFXData;return this.flakesCoverage>0||this._isTextureAvailable("flakesCoverageMap")||e&&e._extraDefines.dspbrFlakes}clone(e){return new u(this,e)}setParameters(e){super.setParameters(e),this.flakesRoughnessUvTransform=l(this.flakesRoughnessUvTransform),this.flakesSizeUvTransform=l(this.flakesSizeUvTransform),this.flakesCoverageUvTransform=l(this.flakesCoverageUvTransform),this.flakesColorUvTransform=l(this.flakesColorUvTransform),this.flipFlopUvTransform=l(this.flipFlopUvTransform),this.flipFlopColorUvTransform=l(this.flipFlopColorUvTransform)}setMaterialShaderOptions(e){var t=this,s=t.isEnabled(),i=this.__parent__._PDSFXData,a=s&&(t._isTextureAvailable("flipFlopMap")||t.flipFlop>0||i&&i._extraDefines.flipFlop);Object.assign(e,{dspbrFlakes:s,flakesSizeMap:s&&t._isTextureAvailable("flakesSizeMap"),flakesSizeMulCoef:s&&null!==t.flakesSizeMulCoef,flakesSizeAddCoef:s&&null!==t.flakesSizeAddCoef,flakesCoverageMap:s&&t._isTextureAvailable("flakesCoverageMap"),flakesCoverageMulCoef:s&&null!==t.flakesCoverageMulCoef,flakesCoverageAddCoef:s&&null!==t.flakesCoverageAddCoef,flakesRoughnessMap:s&&t._isTextureAvailable("flakesRoughnessMap"),flakesRoughnessMulCoef:s&&null!==t.flakesRoughnessMulCoef,flakesRoughnessAddCoef:s&&null!==t.flakesRoughnessAddCoef,flakesColorMap:s&&t._isTextureAvailable("flakesColorMap"),flakesColorMapLinear:s&&!!t.flakesColorMap&&t.flakesColorMap.hdr,flakesColorMulCoef:s&&null!==t.flakesColorMulCoef,flakesColorAddCoef:s&&null!==t.flakesColorAddCoef,flipFlop:a,flipFlopColorMap:a&&t._isTextureAvailable("flipFlopColorMap"),flipFlopColorMapLinear:a&&!!t.flipFlopColorMap&&t.flipFlopColorMap.hdr,flipFlopColorMulCoef:a&&null!==t.flipFlopColorMulCoef,flipFlopColorAddCoef:a&&null!==t.flipFlopColorAddCoef,flipFlopMap:a&&t._isTextureAvailable("flipFlopMap"),flipFlopMulCoef:a&&null!==t.flipFlopMulCoef,flipFlopAddCoef:a&&null!==t.flipFlopAddCoef})}getTextures(){return[this.flakesSizeMap,this.flakesCoverageMap,this.flakesRoughnessMap,this.flakesColorMap,this.flipFlopColorMap,this.flipFlopMap]}}class c extends p{constructor(t,s){super(t,s),this.flakes=!1,this.flakesColor=new e.Color(0),this.flakesColorMulCoef=new e.Vector3(1,1,1),this.flakesColorAddCoef=new e.Vector3(0,0,0),this.flakesBump=0,this.flakesDensity=0,this.flakesScale=0,this.flakesRoughness=0,this.pearlFlakesColor=new e.Color(0),this.pearlFlakesColorMulCoef=new e.Vector3(1,1,1),this.pearlFlakesColorAddCoef=new e.Vector3(0,0,0),this.pearlFlakesBump=0,this.pearlFlakesDensity=0,this.setParameters(t)}loadUniforms(e,t,s,i){var a;this.isEnabled()&&(s.flakesColor&&(a=e.gammaInput?o.copyToLinear(this.flakesColor,e.simpleGamma):this.flakesColor,t.uniform3f(s.flakesColor,a.r,a.g,a.b),t.uniform3f(s.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z),t.uniform3f(s.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)),s.pearlFlakesColor&&(a=e.gammaInput?o.copyToLinear(this.pearlFlakesColor,e.simpleGamma):this.pearlFlakesColor,t.uniform3f(s.pearlFlakesColor,a.r,a.g,a.b),t.uniform3f(s.pearlFlakesColorMulCoef,this.pearlFlakesColorMulCoef.x,this.pearlFlakesColorMulCoef.y,this.pearlFlakesColorMulCoef.z),t.uniform3f(s.pearlFlakesColorAddCoef,this.pearlFlakesColorAddCoef.x,this.pearlFlakesColorAddCoef.y,this.pearlFlakesColorAddCoef.z)),s.flakesBump&&t.uniform1f(s.flakesBump,this.flakesBump),s.flakesDensity&&t.uniform1f(s.flakesDensity,this.flakesDensity),s.flakesScale&&t.uniform1f(s.flakesScale,this.flakesScale),s.flakesRoughness&&t.uniform1f(s.flakesRoughness,this.flakesRoughness),s.pearlFlakesDensity&&t.uniform1f(s.pearlFlakesDensity,this.pearlFlakesDensity),s.pearlFlakesBump&&t.uniform1f(s.pearlFlakesBump,this.pearlFlakesBump))}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.flakesColor&&e.setColor(s.flakesColor,this.flakesColor,t.gammaInput,t.simpleGamma),s.flakesColorMulCoef&&(e.setV3(s.flakesColorAddCoef,this.flakesColorAddCoef),e.setV3(s.flakesColorMulCoef,this.flakesColorMulCoef)),s.pearlFlakesColor&&e.setColor(s.pearlFlakesColor,this.pearlFlakesColor,t.gammaInput,t.simpleGamma),s.pearlFlakesColorAddCoef&&(e.setV3(s.pearlFlakesColorAddCoef,this.pearlFlakesColorAddCoef),e.setV3(s.pearlFlakesColorMulCoef,this.pearlFlakesColorMulCoef)),s.flakesBump&&e.setF(s.flakesBump,this.flakesBump),s.flakesDensity&&e.setF(s.flakesDensity,this.flakesDensity),s.flakesScale&&e.setF(s.flakesScale,this.flakesScale),s.flakesRoughness&&e.setF(s.flakesRoughness,this.flakesRoughness),s.pearlFlakesDensity&&e.setF(s.pearlFlakesDensity,this.pearlFlakesDensity),s.pearlFlakesBump&&e.setF(s.pearlFlakesBump,this.pearlFlakesBump)}isEnabled(){return this.flakes}clone(e){return new c(this,e)}setMaterialShaderOptions(e){Object.assign(e,{specGlossFlakes:this.isEnabled()})}}class d extends p{constructor(t,s){super(t,s),this.clearCoat=0,this.clearCoatMap=null,this.clearCoatAddCoef=null,this.clearCoatMulCoef=null,this.clearCoatUvTransform=n,this.clearCoatRoughness=0,this.clearCoatRoughnessMap=null,this.clearCoatRoughnessAddCoef=null,this.clearCoatRoughnessMulCoef=null,this.clearCoatRoughnessUvTransform=n,this.clearCoatColor=new e.Color(3684408),this.clearCoatColorMap=null,this.clearCoatColorAddCoef=null,this.clearCoatColorMulCoef=null,this.clearCoatColorUvTransform=n,this.coatingGlossinessMap=null,this.coatingGlossinessMulCoef=null,this.coatingGlossinessAddCoef=null,this.clearCoatNormalMap=null,this.clearCoatNormalAddCoef=null,this.clearCoatNormalMulCoef=null,this.clearCoatNormalUvTransform=n,this.clearCoatNormalMapFlipY=!1,this.clearCoatNormalScaleMulCoef=1,this.clearCoatNormalScaleAddCoef=0,this.clearCoatNormalScale=1,this.orangePeel=!1,this.orangePeelScale=0,this.setParameters(t)}loadUniforms(e,t,s,i){if(this.isEnabled()){var a;if(s.clearCoat&&t.uniform1f(s.clearCoat,this.clearCoat),s.clearCoatMap&&(e.loadTexture(t,s.clearCoatMap,this.clearCoatMap),t.uniformMatrix3fv(s.clearCoatUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.clearCoatUvTransform.elements))),s.clearCoatMulCoef&&t.uniform1f(s.clearCoatMulCoef,this.clearCoatMulCoef),s.clearCoatAddCoef&&t.uniform1f(s.clearCoatAddCoef,this.clearCoatAddCoef),s.clearCoatRoughness&&t.uniform1f(s.clearCoatRoughness,this.clearCoatRoughness),s.clearCoatRoughnessMap&&(e.loadTexture(t,s.clearCoatRoughnessMap,this.clearCoatRoughnessMap),t.uniformMatrix3fv(s.clearCoatRoughnessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.clearCoatRoughnessUvTransform.elements))),s.clearCoatRoughnessMulCoef&&(t.uniform1f(s.clearCoatRoughnessMulCoef,this.clearCoatRoughnessMulCoef),t.uniform1f(s.clearCoatRoughnessAddCoef,this.clearCoatRoughnessAddCoef)),s.coatingGlossinessMap&&(e.loadTexture(t,s.coatingGlossinessMap,this.coatingGlossinessMap),t.uniformMatrix3fv(s.clearCoatRoughnessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.clearCoatRoughnessUvTransform.elements))),s.coatingGlossinessMulCoef&&(t.uniform1f(s.coatingGlossinessMulCoef,this.coatingGlossinessMulCoef),t.uniform1f(s.coatingGlossinessAddCoef,this.coatingGlossinessAddCoef)),s.clearCoatNormalMap&&(e.loadTexture(t,s.clearCoatNormalMap,this.clearCoatNormalMap),t.uniformMatrix3fv(s.clearCoatNormalUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.clearCoatNormalUvTransform.elements))),s.clearCoatNormalMulCoef&&(t.uniform3f(s.clearCoatNormalAddCoef,this.clearCoatNormalAddCoef.x,this.clearCoatNormalAddCoef.y,this.clearCoatNormalAddCoef.z),t.uniform3f(s.clearCoatNormalMulCoef,this.clearCoatNormalMulCoef.x,this.clearCoatNormalMulCoef.y,this.clearCoatNormalMulCoef.z)),s.clearCoatNormalScale&&t.uniform1f(s.clearCoatNormalScale,this.clearCoatNormalScaleMulCoef*this.clearCoatNormalScale+this.clearCoatNormalScaleAddCoef),s.clearCoatColor)a=e.gammaInput?o.copyToLinear(this.clearCoatColor,e.simpleGamma):this.clearCoatColor,t.uniform3f(s.clearCoatColor,a.r,a.g,a.b);s.clearCoatColorMap&&(e.loadTexture(t,s.clearCoatColorMap,this.clearCoatColorMap),t.uniformMatrix3fv(s.clearCoatColorUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.clearCoatColorUvTransform.elements))),s.clearCoatColorMulCoef&&(t.uniform3f(s.clearCoatColorMulCoef,this.clearCoatColorMulCoef.x,this.clearCoatColorMulCoef.y,this.clearCoatColorMulCoef.z),t.uniform3f(s.clearCoatColorAddCoef,this.clearCoatColorAddCoef.x,this.clearCoatColorAddCoef.y,this.clearCoatColorAddCoef.z)),s.orangePeelScale&&t.uniform1f(s.orangePeelScale,this.orangePeelScale)}}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.clearCoat&&e.setF(s.clearCoat,this.clearCoat),s.clearCoatMap&&e.setTexture(s.clearCoatMap,this.clearCoatMap),s.clearCoatUvTransform&&e.setM3(s.clearCoatUvTransform,this.clearCoatUvTransform),s.clearCoatAddCoef&&(e.setF(s.clearCoatAddCoef,this.clearCoatAddCoef),e.setF(s.clearCoatMulCoef,this.clearCoatMulCoef)),s.clearCoatRoughness&&e.setF(s.clearCoatRoughness,this.clearCoatRoughness),s.clearCoatRoughnessMap&&e.setTexture(s.clearCoatRoughnessMap,this.clearCoatRoughnessMap),s.clearCoatRoughnessUvTransform&&e.setM3(s.clearCoatRoughnessUvTransform,this.clearCoatRoughnessUvTransform),s.clearCoatRoughnessAddCoef&&(e.setF(s.clearCoatRoughnessAddCoef,this.clearCoatRoughnessAddCoef),e.setF(s.clearCoatRoughnessMulCoef,this.clearCoatRoughnessMulCoef)),s.coatingGlossinessMap&&e.setTexture(s.coatingGlossinessMap,this.coatingGlossinessMap),s.coatingGlossinessAddCoef&&(e.setF(s.coatingGlossinessAddCoef,this.coatingGlossinessAddCoef),e.setF(s.coatingGlossinessMulCoef,this.coatingGlossinessMulCoef)),s.clearCoatNormalMap&&e.setTexture(s.clearCoatNormalMap,this.clearCoatNormalMap),s.clearCoatNormalUvTransform&&e.setM3(s.clearCoatNormalUvTransform,this.clearCoatNormalUvTransform),s.clearCoatNormalAddCoef&&(e.setV3(s.clearCoatNormalAddCoef,this.clearCoatNormalAddCoef),e.setV3(s.clearCoatNormalMulCoef,this.clearCoatNormalMulCoef)),s.clearCoatNormalScale&&e.setF(s.clearCoatNormalScale,this.clearCoatNormalScaleMulCoef*this.clearCoatNormalScale+this.clearCoatNormalScaleAddCoef),s.clearCoatColor&&e.setColor(s.clearCoatColor,this.clearCoatColor,t.gammaInput,t.simpleGamma),s.clearCoatColorMap&&e.setTexture(s.clearCoatColorMap,this.clearCoatColorMap),s.clearCoatColorUvTransform&&e.setM3(s.clearCoatColorUvTransform,this.clearCoatColorUvTransform),s.clearCoatColorAddCoef&&(e.setV3(s.clearCoatColorAddCoef,this.clearCoatColorAddCoef),e.setV3(s.clearCoatColorMulCoef,this.clearCoatColorMulCoef)),s.orangePeelScale&&e.setF(s.orangePeelScale,this.orangePeelScale)}isEnabled(){var e=this.__parent__._PDSFXData;return this.clearCoat>0||this._isTextureAvailable("clearCoatMap")||e&&e._extraDefines.clearCoat}setMaterialShaderOptions(e){var t=this,s=t.isEnabled();Object.assign(e,{clearCoat:s,clearCoatMap:s&&t._isTextureAvailable("clearCoatMap"),clearCoatMulCoef:s&&null!==t.clearCoatMulCoef,clearCoatAddCoef:s&&null!==t.clearCoatAddCoef,clearCoatRoughnessMap:s&&t._isTextureAvailable("clearCoatRoughnessMap"),clearCoatRoughnessMulCoef:s&&null!==t.clearCoatRoughnessMulCoef,clearCoatRoughnessAddCoef:s&&null!==t.clearCoatRoughnessAddCoef,clearCoatColorMap:s&&t._isTextureAvailable("clearCoatColorMap"),clearCoatColorMapLinear:s&&!!t.clearCoatColorMap&&t.clearCoatColorMap.linear,clearCoatColorMulCoef:s&&null!==t.clearCoatColorMulCoef,clearCoatColorAddCoef:s&&null!==t.clearCoatColorAddCoef,coatingGlossinessMap:s&&!e.dspbr&&t._isTextureAvailable("coatingGlossinessMap"),coatingGlossinessMulCoef:s&&!e.dspbr&&null!==t.coatingGlossinessMulCoef,coatingGlossinessAddCoef:s&&!e.dspbr&&null!==t.coatingGlossinessAddCoef,clearCoatNormalMap:s&&t._isTextureAvailable("clearCoatNormalMap"),clearCoatNormalMapFlipY:s&&t.clearCoatNormalMapFlipY,clearCoatNormalMulCoef:s&&null!==t.clearCoatNormalMulCoef,clearCoatNormalAddCoef:s&&null!==t.clearCoatNormalAddCoef,orangePeel:s&&t.orangePeel&&!t.clearCoatNormalMap})}getTextures(){return[this.clearCoatMap,this.clearCoatColorMap,this.coatingGlossinessMap,this.clearCoatRoughnessMap,this.clearCoatNormalMap]}setParameters(e){super.setParameters(e),this.clearCoatUvTransform=l(this.clearCoatUvTransform),this.clearCoatRoughnessUvTransform=l(this.clearCoatRoughnessUvTransform),this.clearCoatColorUvTransform=l(this.clearCoatColorUvTransform),this.clearCoatNormalUvTransform=l(this.clearCoatNormalUvTransform)}clone(e){return new d(this,e)}}class f extends p{constructor(t,s){super(t,s),this.attenuationColor=new e.Color(16777215),this.attenuationDistance=1e6,this.subsurfaceColor=new e.Color(0),this.subsurfaceAnisotropy=0,this._sssLUT=null,this._scatteringCoeffs=null,this._absorptionCoeffs=null,this._translucencyDepth=null,this._updateSSS=0,this._subsurface=!1,this.setParameters(t)}loadUniforms(e,t,s,i){this.isEnabled()&&(s.sssLUT?(e.loadTexture(t,s.sssLUT,this._sssLUT),t.uniform3f(s.maxTranslucencyDepth,this._translucencyDepth[0],this._translucencyDepth[1],this._translucencyDepth[2])):s.absorptionCoefficients&&t.uniform3f(s.absorptionCoefficients,this._absorptionCoeffs[0],this._absorptionCoeffs[1],this._absorptionCoeffs[2]))}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.sssLUT?(e.setFlatV3(s.maxTranslucencyDepth,this._translucencyDepth[0],this._translucencyDepth[1],this._translucencyDepth[2]),e.setTexture(s.sssLUT,this._sssLUT)):s.absorptionCoefficients&&e.setFlatV3(s.absorptionCoefficients,this._absorptionCoeffs[0],this._absorptionCoeffs[1],this._absorptionCoeffs[2])}isEnabled(){return this._subsurface}setMaterialShaderOptions(e){var t=this.isEnabled();Object.assign(e,{subsurface:t,sssLUT:t&&!!this._sssLUT})}setParameters(t){var s=this.__parent__,i=this._subsurface,n=void 0!==t.subsurfacePreset&&t.subsurfacePreset!==a.None,o=t.subsurfaceColor?t.subsurfaceColor:this.subsurfaceColor,l=t.attenuationColor?t.attenuationColor:this.attenuationColor;this._subsurface=o.getHex()>0||n;var h=!0;if(!this._subsurface&&l.getHex()<16711422&&(h=!1,this._subsurface=!0),this._subsurface=this._subsurface&&!s.thinWalled,super.setParameters(t),this._subsurface){if(n){var p=r[t.subsurfacePreset];this.subsurfaceColor=new e.Color(16777215),this._absorptionCoeffs=p.absorptionCoeffs.slice(0),this._scatteringCoeffs=p.scatteringCoeffs.slice(0)}else{var u=this.attenuationColor,c=Math.max(this.attenuationDistance,1e-6),d=this.subsurfaceColor,f=new e.Color(0);f.r=-Math.log(Math.min(.999,Math.max(u.r,.001)))/c,f.b=-Math.log(Math.min(.999,Math.max(u.b,.001)))/c,f.g=-Math.log(Math.min(.999,Math.max(u.g,.001)))/c;var m=new e.Color(0);m.r=1-Math.pow(4.09712+4.20863*d.r-Math.sqrt(9.59217+41.6808*d.r+17.7126*d.r*d.r),2),m.b=1-Math.pow(4.09712+4.20863*d.b-Math.sqrt(9.59217+41.6808*d.b+17.7126*d.b*d.b),2),m.g=1-Math.pow(4.09712+4.20863*d.g-Math.sqrt(9.59217+41.6808*d.g+17.7126*d.g*d.g),2);var C=new e.Color(0);C.r=f.r*(1-m.r),C.g=f.g*(1-m.g),C.b=f.b*(1-m.b),this._absorptionCoeffs=C.toArray();var S=new e.Color(0);S.r=f.r*m.r,S.g=f.g*m.g,S.b=f.b*m.b,this._scatteringCoeffs=S.toArray()}this._updateSSS=h?2:1}s&&this._subsurface!==i&&(s.needsUpdate=!0)}clone(e){return new f(this,e)}}class m extends p{constructor(e,t){super(e,t),this.thickness=0,this.thicknessMap=null,this.thicknessAddCoef=null,this.thicknessMulCoef=null,this.thicknessUvTransform=n,this.setParameters(e)}loadUniforms(e,t,s,i){this.isEnabled()&&(s.thickness&&t.uniform1f(s.thickness,this.thickness),s.thicknessMap&&(e.loadTexture(t,s.thicknessMap,this.thicknessMap),t.uniformMatrix3fv(s.thicknessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.thicknessUvTransform.elements))),s.thicknessAddCoef&&(t.uniform1f(s.thicknessMulCoef,this.thicknessMulCoef),t.uniform1f(s.thicknessAddCoef,this.thicknessAddCoef)))}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.thickness&&e.setF(s.thickness,this.thickness),s.thicknessMap&&e.setTexture(s.thicknessMap,this.thicknessMap),s.thicknessUvTransform&&e.setM3(s.thicknessUvTransform,this.thicknessUvTransform),s.thicknessAddCoef&&(e.setF(s.thicknessAddCoef,this.thicknessAddCoef),e.setF(s.thicknessMulCoef,this.thicknessMulCoef))}isEnabled(){if(this.__parent__.thinWalled)return!1;var e=this.__parent__._PDSFXData;return this.thickness>0||this._isTextureAvailable("thicknessMap")||e&&e._extraDefines.thickness}setMaterialShaderOptions(e){var t=this,s=t.isEnabled();Object.assign(e,{thicknessMap:s&&t._isTextureAvailable("thicknessMap"),thickness:s,thicknessMulCoef:s&&null!==t.thicknessMulCoef,thicknessAddCoef:s&&null!==t.thicknessAddCoef})}getTextures(){return[this.thicknessMap]}setParameters(e){super.setParameters(e),this.thicknessUvTransform=l(this.thicknessUvTransform)}clone(e){return new m(this,e)}}class C extends p{constructor(e,t){super(e,t),this.anisotropy=0,this.anisotropyMap=null,this.anisotropyAddCoef=null,this.anisotropyMulCoef=null,this.anisotropyUvTransform=n,this.anisotropyAngle=0,this.anisotropyAngleMap=null,this.anisotropyAngleAddCoef=null,this.anisotropyAngleMulCoef=null,this.anisotropyAngleUvTransform=n,this.setParameters(e)}loadUniforms(e,t,s,i){this.isEnabled()&&(s.anisotropy&&t.uniform1f(s.anisotropy,this.anisotropy),s.anisotropyMap&&(e.loadTexture(t,s.anisotropyMap,this.anisotropyMap),t.uniformMatrix3fv(s.anisotropyUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.anisotropyUvTransform.elements))),s.anisotropyMulCoef&&(t.uniform1f(s.anisotropyMulCoef,this.anisotropyMulCoef),t.uniform1f(s.anisotropyAddCoef,this.anisotropyAddCoef)),s.anisotropyAngle&&t.uniform1f(s.anisotropyAngle,this.anisotropyAngle),s.anisotropyAngleMap&&(e.loadTexture(t,s.anisotropyAngleMap,this.anisotropyAngleMap),t.uniformMatrix3fv(s.anisotropyAngleUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.anisotropyAngleUvTransform.elements))),s.anisotropyAngleMulCoef&&(t.uniform1f(s.anisotropyAngleMulCoef,this.anisotropyAngleMulCoef),t.uniform1f(s.anisotropyAngleAddCoef,this.anisotropyAngleAddCoef)))}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.anisotropy&&e.setF(s.anisotropy,this.anisotropy),s.anisotropyMap&&e.setTexture(s.anisotropyMap,this.anisotropyMap),s.anisotropyUvTransform&&e.setM3(s.anisotropyUvTransform,this.anisotropyUvTransform),s.anisotropyAddCoef&&(e.setF(s.anisotropyAddCoef,this.anisotropyAddCoef),e.setF(s.anisotropyMulCoef,this.anisotropyMulCoef)),s.anisotropyAngle&&e.setF(s.anisotropyAngle,this.anisotropyAngle),s.anisotropyAngleMap&&e.setTexture(s.anisotropyAngleMap,this.anisotropyAngleMap),s.anisotropyAngleUvTransform&&e.setM3(s.anisotropyAngleUvTransform,this.anisotropyAngleUvTransform),s.anisotropyAngleAddCoef&&(e.setF(s.anisotropyAngleAddCoef,this.anisotropyAngleAddCoef),e.setF(s.anisotropyAngleMulCoef,this.anisotropyAngleMulCoef))}isEnabled(){var e=this.__parent__._PDSFXData;return this.anisotropy>0||this._isTextureAvailable("anisotropyMap")||e&&e._extraDefines.anisotropy}setMaterialShaderOptions(e){var t=this,s=t.isEnabled();Object.assign(e,{anisotropy:s,anisotropyMap:s&&t._isTextureAvailable("anisotropyMap"),anisotropyMulCoef:s&&null!==t.anisotropyMulCoef,anisotropyAddCoef:s&&null!==t.anisotropyAddCoef,anisotropyAngleMap:s&&t._isTextureAvailable("anisotropyAngleMap"),anisotropyAngleMulCoef:s&&null!==t.anisotropyAngleMulCoef,anisotropyAngleAddCoef:s&&null!==t.anisotropyAngleAddCoef})}setParameters(e){super.setParameters(e),this.anisotropyUvTransform=l(this.anisotropyUvTransform),this.anisotropyAngleUvTransform=l(this.anisotropyAngleUvTransform)}getTextures(){return[this.anisotropyMap,this.anisotropyAngleMap]}clone(e){return new C(this,e)}}class S extends p{constructor(e,t){super(e,t),this.displacementMap=null,this.displacementAddCoef=null,this.displacementMulCoef=null,this.displacementUvTransform=n,this.displacementScale=1,this.displacementBias=0,this.__needDisplacementUpdate=!1,this.setParameters(e)}loadUniforms(e,t,s,i){if(this.isEnabled()&&s.displacementMap){if(e.loadTexture(t,s.displacementMap,this.displacementMap),t.uniformMatrix3fv(s.displacementUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.displacementUvTransform.elements)),this.__needDisplacementUpdate)if(this.__needDisplacementUpdate=!("complete"===this.displacementMap.loadEndStatus||"error"===this.displacementMap.loadEndStatus),!this.__needDisplacementUpdate)this.__parent__._sendEvent("requestShadowMapUpdate");if(s.displacementBias&&t.uniform1f(s.displacementBias,this.displacementBias),s.displacementMapSize){var a=this.displacementMap.getSizes();t.uniform2f(s.displacementMapSize,a.width,a.height)}s.displacementScale&&t.uniform1f(s.displacementScale,this.displacementScale),s.displacementAddCoef&&(t.uniform3f(s.displacementAddCoef,this.displacementAddCoef.x,this.displacementAddCoef.y,this.displacementAddCoef.z),t.uniform3f(s.displacementMulCoef,this.displacementMulCoef.x,this.displacementMulCoef.y,this.displacementMulCoef.z))}}fillUBO(e,t){if(!this.isEnabled())return;this.__needDisplacementUpdate&&(this.__needDisplacementUpdate=!("complete"===this.displacementMap.loadEndStatus||"error"===this.displacementMap.loadEndStatus),this.__needDisplacementUpdate||this.__parent__._sendEvent("requestShadowMapUpdate"));const s=e.layout;if(s.displacementMap&&e.setTexture(s.displacementMap,this.displacementMap),s.displacementUvTransform&&e.setM3(s.displacementUvTransform,this.displacementUvTransform),s.displacementAddCoef&&(e.setV3(s.displacementAddCoef,this.displacementAddCoef),e.setV3(s.displacementMulCoef,this.displacementMulCoef)),s.displacementMapSize){var i=this.displacementMap.getSizes();e.setFlatV2(s.displacementMapSize,i.width,i.height)}s.displacementBias&&e.setF(s.displacementBias,this.displacementBias),s.displacementScale&&e.setF(s.displacementScale,this.displacementScale)}isEnabled(){return this._isTextureAvailable("displacementMap")}setMaterialShaderOptions(e){var t=this,i=this.__parent__.__physicalMode,a=!e._isDecal&&t.isEnabled()&&(e.specgloss||i>=s.DSPBR21x);Object.assign(e,{displacementMap:a,displacementAddCoef:a&&null!==t.displacementAddCoef,displacementMulCoef:a&&null!==t.displacementMulCoef})}getTextures(){return[this.displacementMap]}setParameters(e){super.setParameters(e),this.displacementUvTransform=l(this.displacementUvTransform),e&&(this.__needDisplacementUpdate=!!(e.displacementMap||e.displacementAddCoef||e.displacementMulCoef||void 0!==e.displacementBias||void 0!==e.displacementScale||e.displacementUvTransform))}clone(e){return new S(this,e)}}class M extends p{constructor(e,t){super(e,t),this.iridescence=0,this.iridescenceMap=null,this.iridescenceAddCoef=null,this.iridescenceMulCoef=null,this.iridescenceUvTransform=n,this.iridescenceThickness=.4,this.iridescenceThicknessMap=null,this.iridescenceThicknessAddCoef=null,this.iridescenceThicknessMulCoef=null,this.iridescenceThicknessUvTransform=n,this.iridescenceIoR=1.3,this.setParameters(e)}loadUniforms(e,t,s,i){this.isEnabled()&&(t.uniform1f(s.iridescenceIoR,this.iridescenceIoR),s.iridescence&&t.uniform1f(s.iridescence,this.iridescence),s.iridescenceMap&&(e.loadTexture(t,s.iridescenceMap,this.iridescenceMap),t.uniformMatrix3fv(s.iridescenceUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.iridescenceUvTransform.elements))),s.iridescenceAddCoef&&(t.uniform1f(s.iridescenceAddCoef,this.iridescenceAddCoef),t.uniform1f(s.iridescenceMulCoef,this.iridescenceMulCoef)),s.iridescenceThickness&&t.uniform1f(s.iridescenceThickness,this.iridescenceThickness),s.iridescenceThicknessMap&&(e.loadTexture(t,s.iridescenceThicknessMap,this.iridescenceThicknessMap),t.uniformMatrix3fv(s.iridescenceThicknessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.iridescenceThicknessUvTransform.elements))),s.iridescenceThicknessAddCoef&&(t.uniform1f(s.iridescenceThicknessAddCoef,this.iridescenceThicknessAddCoef),t.uniform1f(s.iridescenceThicknessMulCoef,this.iridescenceThicknessMulCoef)))}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.iridescenceIoR&&e.setF(s.iridescenceIoR,this.iridescenceIoR),s.iridescence&&e.setF(s.iridescence,this.iridescence),s.iridescenceMap&&e.setTexture(s.iridescenceMap,this.iridescenceMap),s.iridescenceUvTransform&&e.setM3(s.iridescenceUvTransform,this.iridescenceUvTransform),s.iridescenceAddCoef&&(e.setF(s.iridescenceAddCoef,this.iridescenceAddCoef),e.setF(s.iridescenceMulCoef,this.iridescenceMulCoef)),s.iridescenceThickness&&e.setF(s.iridescenceThickness,this.iridescenceThickness),s.iridescenceThicknessMap&&e.setTexture(s.iridescenceThicknessMap,this.iridescenceThicknessMap),s.iridescenceThicknessUvTransform&&e.setM3(s.iridescenceThicknessUvTransform,this.iridescenceThicknessUvTransform),s.iridescenceThicknessAddCoef&&(e.setF(s.iridescenceThicknessAddCoef,this.iridescenceThicknessAddCoef),e.setF(s.iridescenceThicknessMulCoef,this.iridescenceThicknessMulCoef))}isEnabled(){var e=this.__parent__._PDSFXData;return this.iridescence>0||this._isTextureAvailable("iridescenceMap")||e&&e._extraDefines.iridescence}setMaterialShaderOptions(e){var t=this,s=t.isEnabled();Object.assign(e,{iridescence:s,iridescenceMap:s&&t._isTextureAvailable("iridescenceMap"),iridescenceAddCoef:s&&null!==t.iridescenceAddCoef,iridescenceMulCoef:s&&null!==t.iridescenceAddCoef,iridescenceThicknessMap:s&&t._isTextureAvailable("iridescenceThicknessMap"),iridescenceThicknessAddCoef:s&&null!==t.iridescenceThicknessAddCoef,iridescenceThicknessMulCoef:s&&null!==t.iridescenceThicknessMulCoef})}getTextures(){return[this.iridescenceMap,this.iridescenceThicknessMap]}setParameters(e){super.setParameters(e),this.iridescenceThicknessUvTransform=l(this.iridescenceThicknessUvTransform),this.iridescenceUvTransform=l(this.iridescenceUvTransform)}clone(e){return new M(this,e)}}class _ extends p{constructor(t,a){super(t,a),this.sheen=0,this.sheenMap=null,this.sheenAddCoef=null,this.sheenMulCoef=null,this.sheenUvTransform=n,this.sheenRoughness=0,this.sheenRoughnessMap=null,this.sheenRoughnessAddCoef=null,this.sheenRoughnessMulCoef=null,this.sheenRoughnessUvTransform=n,this.sheenColor=new e.Color(0),this.sheenColorMap=null,this.sheenColorAddCoef=null,this.sheenColorMulCoef=null,this.sheenColorUvTransform=n,this.sheenMode=a.__physicalMode>=s.DSPBR21x?i.VELVET_SOFT:i.VELVET,this.setParameters(t)}loadUniforms(e,t,s,i){if(this.isEnabled()){var a;s.sheen&&t.uniform1f(s.sheen,this.sheen),s.sheenMap&&(e.loadTexture(t,s.sheenMap,this.sheenMap),t.uniformMatrix3fv(s.sheenUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.sheenUvTransform.elements))),s.sheenMulCoef&&(t.uniform1f(s.sheenMulCoef,this.sheenMulCoef),t.uniform1f(s.sheenAddCoef,this.sheenAddCoef)),s.sheenRoughness&&t.uniform1f(s.sheenRoughness,this.sheenRoughness),s.sheenRoughnessMap&&(e.loadTexture(t,s.sheenRoughnessMap,this.sheenRoughnessMap),t.uniformMatrix3fv(s.sheenRoughnessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.sheenRoughnessUvTransform.elements))),s.sheenRoughnessMulCoef&&(t.uniform1f(s.sheenRoughnessMulCoef,this.sheenRoughnessMulCoef),t.uniform1f(s.sheenRoughnessAddCoef,this.sheenRoughnessAddCoef)),s.sheenColor&&(a=e.gammaInput?o.copyToLinear(this.sheenColor,e.simpleGamma):this.sheenColor,t.uniform3f(s.sheenColor,a.r,a.g,a.b)),s.sheenColorMap&&(e.loadTexture(t,s.sheenColorMap,this.sheenColorMap),t.uniformMatrix3fv(s.sheenColorUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.sheenColorUvTransform.elements))),s.sheenColorMulCoef&&(t.uniform3f(s.sheenColorMulCoef,this.sheenColorMulCoef.x,this.sheenColorMulCoef.y,this.sheenColorMulCoef.z),t.uniform3f(s.sheenColorAddCoef,this.sheenColorAddCoef.x,this.sheenColorAddCoef.y,this.sheenColorAddCoef.z));var r=this.__parent__;s.envMapSheen&&e.loadTexture(t,s.envMapSheen,r._sheenData?r._sheenData.envMipMap:null)}}fillUBO(e,t){if(!this.isEnabled())return;const s=e.layout;s.sheen&&e.setF(s.sheen,this.sheen),s.sheenMap&&e.setTexture(s.sheenMap,this.sheenMap),s.sheenUvTransform&&e.setM3(s.sheenUvTransform,this.sheenUvTransform),s.sheenAddCoef&&(e.setF(s.sheenAddCoef,this.sheenAddCoef),e.setF(s.sheenMulCoef,this.sheenMulCoef)),s.sheenRoughness&&e.setF(s.sheenRoughness,this.sheenRoughness),s.sheenRoughnessMap&&e.setTexture(s.sheenRoughnessMap,this.sheenRoughnessMap),s.sheenRoughnessUvTransform&&e.setM3(s.sheenRoughnessUvTransform,this.sheenRoughnessUvTransform),s.sheenRoughnessAddCoef&&(e.setF(s.sheenRoughnessAddCoef,this.sheenRoughnessAddCoef),e.setF(s.sheenRoughnessMulCoef,this.sheenRoughnessMulCoef)),s.sheenColor&&e.setColor(s.sheenColor,this.sheenColor,t.gammaInput,t.simpleGamma),s.sheenColorMap&&e.setTexture(s.sheenColorMap,this.sheenColorMap),s.sheenColorUvTransform&&e.setM3(s.sheenColorUvTransform,this.sheenColorUvTransform),s.sheenColorMulCoef&&(e.setV3(s.sheenColorAddCoef,this.sheenColorAddCoef),e.setV3(s.sheenColorMulCoef,this.sheenColorMulCoef));var i=this.__parent__;s.envMapSheen&&e.setTexture(s.envMapSheen,i._sheenData.envMipMap)}isEnabled(){var e=this.__parent__._PDSFXData;return this.sheen>0||!!this._isTextureAvailable("sheenMap")||e&&e._extraDefines.sheen}setMaterialShaderOptions(e){var t=this,s=t.isEnabled();Object.assign(e,{sheen:s,sheenMap:s&&t._isTextureAvailable("sheenMap"),sheenMulCoef:s&&null!==t.sheenMulCoef,sheenAddCoef:s&&null!==t.sheenAddCoef,sheenColorMap:s&&t._isTextureAvailable("sheenColorMap"),sheenColorMapLinear:s&&!!t.sheenColorMap&&t.sheenColorMap.hdr,sheenColorMulCoef:s&&null!==t.sheenColorMulCoef,sheenColorAddCoef:s&&null!==t.sheenColorAddCoef,sheenRoughnessMap:s&&t._isTextureAvailable("sheenRoughnessMap"),sheenRoughnessMulCoef:s&&null!==t.sheenRoughnessMulCoef,sheenRoughnessAddCoef:s&&null!==t.sheenRoughnessAddCoef,sheenMode:s&&t.sheenMode})}getTextures(){return[this.sheenMap,this.sheenColorMap,this.sheenRoughnessMap]}setParameters(e){super.setParameters(e),this.sheenUvTransform=l(this.sheenUvTransform),this.sheenRoughnessUvTransform=l(this.sheenRoughnessUvTransform),this.sheenColorUvTransform=l(this.sheenColorUvTransform)}clone(e){return new _(this,e)}}return{DSPBRFlakesParametersContainer:u,SpecGlossFlakesParametersContainer:c,ClearCoatParametersContainer:d,VolumeParametersContainer:f,ThicknessParametersContainer:m,AnisotropyParametersContainer:C,DisplacementParametersContainer:S,IridescenceParametersContainer:M,SheenParametersContainer:_}})),define("DS/Materials/PhysicalMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PhysicalMaterialContainers","DS/Materials/PhysicalMaterialKeyUtils","DS/Materials/PDSFXData"],(function(e,t,s,i,a){"use strict";let r,n,o;const l={GGX:0,ASHIKMIN:1,BECKMANN:2,ESTEVEZKULLA:3};e._BRDFS=l;class h{constructor(e){this.hdr=e.hdr||null,this.brdf=l.GGX,this.direct=e.direct||!1,this.name=e.name||"",this.mips=e.mips||null,this.box=e.box?e.box.clone():null,this.position=e.position?e.position.clone():null,this.curID=-1}_useCustom(){return null!==this.hdr}clone(){return new h({hdr:this.hdr,direct:this.direct,name:this.name,mips:this.mips,box:this.box,position:this.position})}}e.IBLOverrider=h;const p=e.PhysicalMaterialMode;e.DSPBRSubTypes={Generic:0,Metal:1,Glass:2,Plastic:3,Textile:4,Leather:5,"Car Paint":6,Emissive:7,Basic:8,Wood:9};const u=e.SheenMode;class c{constructor(e){this.envMipMap=e.envMipMap||null,this.overrideIBL=e.overrideIBL||null}clone(){return new c({envMipMap:this.envMipMap,overrideIBL:null!==this.overrideIBL?this.overrideIBL.clone():null})}_useCustom(){return null!==this.overrideIBL&&this.overrideIBL._useCustom()}}const d=e.__DefaultUVTransform__,f=new e.Color;var m=function(e,t,s){t[s+"Map"]=e[s+"Map"],t[s+"AddCoef"]=e[s+"AddCoef"],t[s+"MulCoef"]=e[s+"MulCoef"],t[s+"UvTransform"]=e[s+"UvTransform"]},C=function(e,t,s,i){i?t[s].copy(e[s]):t[s]=e[s],m(e,t,s)},S=function(e){return null===e||e.isIdentity()?d:e};const M=i.AllowedDSPBRFlakesKeys,_=s.DSPBRFlakesParametersContainer,g=i.AllowedSpecGlossFlakesKeys,v=s.SpecGlossFlakesParametersContainer,P=i.AllowedClearCoatKeys,y=s.ClearCoatParametersContainer,T=i.AllowedVolumeKeys,b=s.VolumeParametersContainer,D=i.AllowedThicknessKeys,F=s.ThicknessParametersContainer,x=i.AllowedAnisotropyKeys,A=s.AnisotropyParametersContainer,U=i.AllowedDisplacementKeys,E=s.DisplacementParametersContainer,O=i.AllowedIridescenceKeys,L=s.IridescenceParametersContainer,w=i.AllowedSheenKeys,I=s.SheenParametersContainer,$=i.AllowedCoreKeys,k=i.UVKeysToInternalKeys,R=i.sanitizeForUVKeys,G=i.KeysToInternalKeys;class B extends t{constructor(t){for(var s in n||(n=e._SSSGenerator,r=e._AmbianceGenerators,o=e.LinearFilter),super(),(t=t||{}).__initializing__=!0,G)void 0!==t[s]&&void 0===t[G[s]]&&(t[G[s]]=t[s]);for(var s in k)void 0!==t[s]&&void 0===t[k[s]]&&(t[k[s]]=t[s]);this.__physicalMode=p.DSPBR,t&&t.dspbr21x&&(this.__physicalMode=p.DSPBR21x),t&&t.dspbr22x&&(this.__physicalMode=p.DSPBR22x),t&&t.dspbr25x&&(this.__physicalMode=p.DSPBR25x),this._phongFallbackMaterial=null,this.thinWalled=!0,this.uvSlot=1,this.color=new e.Color(16777215),this.map=null,this.diffuseUvTransform=d,this.diffuseMulCoef=null,this.diffuseAddCoef=null,this.specular=new e.Color(16777215),this.specularMap=null,this.specularAddCoef=null,this.specularMulCoef=null,this.specularUvTransform=d,this.metalness=0,this.metalnessMap=null,this.metalnessAddCoef=null,this.metalnessMulCoef=null,this.metalnessUvTransform=d,this.specularContrib=1,this.specularContribMap=null,this.specularContribAddCoef=null,this.specularContribMulCoef=null,this.specularContribUvTransform=d,this.emissionColor=new e.Color(16777215),this.emissionColorMap=null,this.emissionColorAddCoef=null,this.emissionColorMulCoef=null,this.emissionColorUvTransform=d,this.emissionValue=0,this.emissionNormalized=!1,this.transparency=0,this.transparencyMap=null,this.transparencyAddCoef=null,this.transparencyMulCoef=null,this.transparencyUvTransform=d,this.opacity=1,this.opacityMap=null,this.opacityAddCoef=null,this.opacityMulCoef=null,this.opacityUvTransform=d,this.useAlphaFromDiffuseMap=!0,this.ior=1.4,this.roughness=0,this.roughnessMap=null,this.roughnessAddCoef=null,this.roughnessMulCoef=null,this.roughnessUvTransform=d,this.glossinessMap=null,this.glossinessMulCoef=null,this.glossinessAddCoef=null,this.reflectionProbes=null,this.envMipMap=null,this.envMap=null,this.translucency=0,this.translucencyMap=null,this.translucencyAddCoef=null,this.translucencyMulCoef=null,this.translucencyUvTransform=d,this.translucencyColor=new e.Color(16777215),this.translucencyColorMap=null,this.translucencyColorAddCoef=null,this.translucencyColorMulCoef=null,this.translucencyColorUvTransform=d,this.useTranslucencyColorFromAlbedo=!1,this.bumpMap=null,this.bumpUvTransform=d,this.bumpScale=1,this.bumpScaleMap=null,this.bumpScaleAddCoef=null,this.bumpScaleMulCoef=null,this.bumpScaleUvTransform=d,this.normalMap=null,this.normalAddCoef=null,this.normalMulCoef=null,this.normalUvTransform=d,this.normalMapFlipY=!1,this.normalScale=new e.Vector2(1,1),this.normalScaleMap=null,this.normalScaleAddCoef=null,this.normalScaleMulCoef=null,this.normalScaleUvTransform=d,this.useLighting=!0,this.wireframe=!1,this.needTangent=!1,this.needTangentBinormal=!1,this.setValues(t),this._selectUvTransforms(),this._dspbrFlakes=null,this.setDSPBRFlakes(t),this._specGlossFlakes=null,this._dspbrFlakes||this.setSpecGlossFlakes(t),this._clearCoat=null,this.setClearCoat(t),this._volume=null,this.setVolume(t),this._mapFromOldParameters(t),this._sheenData=null,this._sheen=null,this.setSheen(t),this._anisotropy=null,this.setAnisotropy(t),this._displacement=null,this.setDisplacement(t),this._iridescence=null,this.setIridescence(t),this._thickness=null,this.setThickness(t),this._fromGLTF=t&&t._fromGLTF?1:0,this._fromGLTF=t&&t._fromGLTF_SpecGloss?2:this._fromGLTF}_selectUvTransforms(){this.normalUvTransform=S(this.normalUvTransform),this.bumpUvTransform=S(this.bumpUvTransform),this.bumpScaleUvTransform=S(this.bumpScaleUvTransform),this.normalScaleUvTransform=S(this.normalScaleUvTransform),this.diffuseUvTransform=S(this.diffuseUvTransform),this.specularUvTransform=S(this.specularUvTransform),this.metalnessUvTransform=S(this.metalnessUvTransform),this.emissionColorUvTransform=S(this.emissionColorUvTransform),this.specularContribUvTransform=S(this.specularContribUvTransform),this.transparencyUvTransform=S(this.transparencyUvTransform),this.opacityUvTransform=S(this.opacityUvTransform),this.translucencyUvTransform=S(this.translucencyUvTransform),this.translucencyColorUvTransform=S(this.translucencyColorUvTransform),this.roughnessUvTransform=S(this.roughnessUvTransform)}static _setTypeParams(e){e.specGloss=!1,e.specGlossNRE=!1,e.dspbr19x=!1,e.dspbr21x=!1,e.dspbr22x=!1,e.dspbr25x=!1}requireVertexTangentBinormal(){return this._displacement&&this._displacement.isEnabled()}_dump(){var e=super._dump(this);e.subType=this.getSubType(),e.color=this.color.toArray(),e.specular=this.specular.toArray(),this.specularMap&&(e.specularMap="textured"),e.roughness=this.roughness,this.roughnessMap&&(e.roughness="textured");var t=this.getType();return t.includes("DSPBR")?(this.map&&(e.color="textured"),e.transparency=this.transparency,this.transparencyMap&&(e.transparency="textured"),e.emissionColor=this.emissionColor.toArray(),this.emissionColorMap&&(e.emissionColor="textured"),e.emissionValue=this.emissionValue,e.metalness=this.metalness,this.metalnessMap&&(e.metalness="textured"),e.specularContribution=this.specularContrib,this.specularContribMap&&(e.specularContribution="textured"),e.ior=this.ior):t.includes("SpecGloss")?(this.map&&(e.color="textured"),e.transparency=this.transparency,this.transparencyMap&&(e.transparency="textured"),e.emissionColor=this.emissionColor.toArray(),this.emissionColorMap&&(e.emissionColor="textured")):"CATGraphicalMaterial"===t&&this.map&&(e.texture=!0),e}requireTangentBinormal(){return this.needTangentBinormal||this._anisotropy&&this._anisotropy.isEnabled()||!!this.normalMap||!(!this._clearCoat||!this._clearCoat.clearCoatNormalMap)||this.requireVertexTangentBinormal()}getSubType(){return"Generic"}getType(){switch(this.__physicalMode){case p.SPEC_GLOSS:case p.SPEC_GLOSS_NRE:return"SpecGloss";case p.DSPBR:return"DSPBR19x";case p.DSPBR21x:return"DSPBR21x";case p.DSPBR22x:return"DSPBR22x";case p.DSPBR25x:return"DSPBR25x"}return"DSPBR19x"}_deallocate(e){super._deallocate(e),r&&(r.decreaseUseCount("m"+this.id),r.decreaseUseCount("ms"+this.id)),n&&this._volume&&this._volume._sssLUT&&n.decreaseUseCount(this._volume._sssLUT.id),this._phongFallbackMaterial&&this._phongFallbackMaterial.dispose()}_transparencyOnGPU(e){return super._transparencyOnGPU(e)||this.opacityMap||this.transparencyMap||this._PDSFXData&&this._PDSFXData._extraDefines.transparency||this.map&&(this.useAlphaFromDiffuseMap||this.transparency>0)}_mapFromOldParameters(e){this.__physicalMode>=p.DSPBR21x||(e.hasOwnProperty("emissive")&&(this.emissionColor.copy(e.emissive),this.emissionColorMap=e.hasOwnProperty("emissiveMap")?e.emissiveMap:this.emissionColorMap,this.emissionColorAddCoef=e.hasOwnProperty("emissiveAddCoef")?e.emissiveAddCoef:this.emissionColorAddCoef,this.emissionColorMulCoef=e.hasOwnProperty("emissiveMulCoef")?e.emissiveMulCoef:this.emissionColorMulCoef,this.uvSlot=e.hasOwnProperty("emissiveUvSlot")?e.emissiveUvSlot:this.uvSlot,this.emissionColorUvTransform=e.hasOwnProperty("emissiveUvTransform")?e.emissiveUvTransform:this.emissionColorUvTransform,this.emissionValue=1,this.emissionNormalized=!1),e.hasOwnProperty("coating")&&(this._clearCoat||(this._clearCoat=new y(e,this)),this._clearCoat.clearCoat=e.coating),e.hasOwnProperty("glossiness")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=p.SPEC_GLOSS,this.metalness=0,this.metalnessMap=null),this.roughness=1-e.glossiness,this.roughnessMap=null,this.thinWalled=!0),e.hasOwnProperty("glossinessMap")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=p.SPEC_GLOSS,this.metalness=0,this.metalnessMap=null),this.roughnessMap=null,this.thinWalled=!0,this.uvSlot=e.hasOwnProperty("glossinessUvSlot")?e.glossinessUvSlot:this.uvSlot,this.roughnessUvTransform=e.hasOwnProperty("glossinessUvTransform")?e.glossinessUvTransform:this.roughnessUvTransform),this._clearCoat&&(e.hasOwnProperty("coatingGlossiness")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=p.SPEC_GLOSS,this.metalness=0,this.metalnessMap=null),this._clearCoat.clearCoatRoughness=1-e.coatingGlossiness),e.hasOwnProperty("coatingGlossinessMap")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=p.SPEC_GLOSS,this.metalness=0,this.metalnessMap=null),this._clearCoat.clearCoatRoughnessMap=null,this.thinWalled=!0,this.uvSlot=e.hasOwnProperty("coatingGlossinessUvSlot")?e.coatingGlossinessUvSlot:this.uvSlot,this._clearCoat.clearCoatRoughnessUvTransform=e.hasOwnProperty("coatingGlossinessUvTransform")?e.coatingGlossinessUvTransform:this._clearCoat.clearCoatRoughnessUvTransform)),e.specGloss&&(this.__physicalMode=p.SPEC_GLOSS,this.metalness=0,this.metalnessMap=null),e.specGlossNRE&&(this.__physicalMode=p.SPEC_GLOSS_NRE,this.metalness=0,this.metalnessMap=null))}_canUseLights(){return this.useLighting}_transparencyEnabled(){return!0}_emissionEnabled(){if(this.emissionValue<=0)return!1;const t=this.emissionColorAddCoef?this.emissionColorAddCoef:new e.Vector3(0,0,0),s=this.emissionColorMulCoef?this.emissionColorMulCoef:new e.Vector3(1,1,1),i=s.x*this.emissionColor.r+t.x>1/255||s.y*this.emissionColor.g+t.y>1/255||s.z*this.emissionColor.b+t.z>1/255;return this._isTextureAvailable("emissionColorMap")||i||this._PDSFXData&&this._PDSFXData._extraDefines.emissionColor}_translucencyEnabled(){if(this.__physicalMode<=p.DSPBR)return!1;const e=null!==this.translucencyMulCoef?this.translucencyMulCoef:1,t=null!==this.translucencyAddCoef?this.translucencyAddCoef:0,s=e*this.translucency+t;return this._isTextureAvailable("translucencyMap")||s>0||this._PDSFXData&&this._PDSFXData._extraDefines.translucency}_setCoreShaderOptions(e,t,s,i,a,r){var n=this,o={specgloss:n.__physicalMode===p.SPEC_GLOSS||n.__physicalMode===p.SPEC_GLOSS_NRE,specglossNRE:n.__physicalMode===p.SPEC_GLOSS_NRE,dspbr:n.__physicalMode>=p.DSPBR,dspbr19x:n.__physicalMode===p.DSPBR,dspbr21x:n.__physicalMode===p.DSPBR21x,dspbr22x:n.__physicalMode===p.DSPBR22x,dspbr25x:n.__physicalMode===p.DSPBR25x,useSpecularAA:!1,fromGLTF:n._fromGLTF};super._setMaterialShaderOptions(o,t,s,i,a,r),Object.assign(o,{diffuseMulCoef:null!==n.diffuseMulCoef,diffuseAddCoef:null!==n.diffuseAddCoef,diffuseBorderColorU:!!n.map&&n.map._useBorderColor().u,diffuseBorderColorV:!!n.map&&n.map._useBorderColor().v,specularContribMap:n._isTextureAvailable("specularContribMap"),specularContribMulCoef:null!==n.specularContribMulCoef,specularContribAddCoef:null!==n.specularContribAddCoef,specularMap:n._isTextureAvailable("specularMap"),specularMapLinear:!!n.specularMap&&n.specularMap.hdr,specularMulCoef:null!==n.specularMulCoef,specularAddCoef:null!==n.specularAddCoef,useTransparency:n._transparencyEnabled(),metalnessMap:n._isTextureAvailable("metalnessMap"),metalnessMulCoef:null!==n.metalnessMulCoef,metalnessAddCoef:null!==n.metalnessAddCoef,opacityMap:n._isTextureAvailable("opacityMap"),opacityBorderColorU:!!n.opacityMap&&n.opacityMap._useBorderColor().u,opacityBorderColorV:!!n.opacityMap&&n.opacityMap._useBorderColor().v,opacityMulCoef:null!==n.opacityMulCoef,opacityAddCoef:null!==n.opacityAddCoef,useAlphaFromDiffuseMap:n.useAlphaFromDiffuseMap}),o.useTransparency&&Object.assign(o,{transparencyMap:n._isTextureAvailable("transparencyMap"),transparencyMulCoef:null!==n.transparencyMulCoef,transparencyAddCoef:null!==n.transparencyAddCoef}),t&&(Object.assign(o,{useEmission:!e.vrDevice||n._emissionEnabled(),useTranslucency:n._translucencyEnabled()}),o.useEmission&&Object.assign(o,{emissionColorMap:n._isTextureAvailable("emissionColorMap"),emissionNormalized:n.emissionNormalized,emissionColorMapLinear:/*!!material.emissionColorMapLinear || */!!n.emissionColorMap&&n.emissionColorMap.hdr,emissionColorMulCoef:null!==n.emissionColorMulCoef,emissionColorAddCoef:null!==n.emissionColorAddCoef}),o.useTranslucency&&Object.assign(o,{translucencyMap:n._isTextureAvailable("translucencyMap"),translucencyMulCoef:null!==n.translucencyMulCoef,translucencyAddCoef:null!==n.translucencyAddCoef,translucencyColorMap:n._isTextureAvailable("translucencyColorMap"),translucencyColorMapLinear:!!n.translucencyColorMap&&n.translucencyColorMap.hdr,translucencyColorMulCoef:null!==n.translucencyColorMulCoef,translucencyColorAddCoef:null!==n.translucencyColorAddCoef})),(t||s||i)&&Object.assign(o,{normalScaleMap:n._isTextureAvailable("normalScaleMap"),normalMulCoef:null!==n.normalMulCoef,normalAddCoef:null!==n.normalAddCoef,normalScaleMulCoef:null!==n.normalScaleMulCoef,normalScaleAddCoef:null!==n.normalScaleAddCoef,bumpScaleMap:n._isTextureAvailable("bumpScaleMap"),bumpScaleMulCoef:null!==n.bumpScaleMulCoef,bumpScaleAddCoef:null!==n.bumpScaleAddCoef}),(t||a||i)&&Object.assign(o,{roughnessMap:n._isTextureAvailable("roughnessMap"),glossinessMap:!o.dspbr&&n._isTextureAvailable("glossinessMap"),glossinessMulCoef:!o.dspbr&&null!==n.glossinessMulCoef,glossinessAddCoef:!o.dspbr&&null!==n.glossinessAddCoef,roughnessMulCoef:null!==n.roughnessMulCoef,roughnessAddCoef:null!==n.roughnessAddCoef}),Object.assign(e,o)}_setMaterialShaderOptions(t,s,i,a,r,n){var o=this,l={};this._setCoreShaderOptions(l,s,i,a,r,n),l.thinWalled=this.thinWalled,o._thickness&&o._thickness.setMaterialShaderOptions(l),o._volume&&o._volume.setMaterialShaderOptions(l),o._displacement&&(l._isDecal=t._isDecal,o._displacement.setMaterialShaderOptions(l)),s&&(o._dspbrFlakes?(o._dspbrFlakes.setMaterialShaderOptions(l),l.flakesSizeOverriden=this._PDSFXData&&this._PDSFXData._extraDefines&&this._PDSFXData._extraDefines.flakesSizeOverriden):o._specGlossFlakes&&o._specGlossFlakes.setMaterialShaderOptions(l),o._clearCoat&&o._clearCoat.setMaterialShaderOptions(l),o._sheen&&o._sheen.setMaterialShaderOptions(l),o._anisotropy&&o._anisotropy.setMaterialShaderOptions(l),o._iridescence&&o._iridescence.setMaterialShaderOptions(l),l.useFlakes=l.dspbrFlakes||l.specGlossFlakes,(l.useFlakes||l.orangePeel)&&(l.needObjectSpaceData=!0,l.specGlossFlakes&&(l.advancedFlakesBlending=t.flakesMode<2,l.advancedPresenceNoise=t.flakesMode<2,l.flakesNormalPerturbation=t.flakesMode<1,l.pearlFlakesActivated=t.flakesMode<1),l.dspbrFlakes&&(l.dspbrFlakesFullGrid=0===t.flakesMode,l.dspbrFlakesThreeLayers=t.flakesMode<=1,l.dspbrFlakesTwoLayers=2===t.flakesMode,l.dspbrFlakesOneLayer=3===t.flakesMode,l.dspbrHemiFlakes=t.envMap||t.hasAreaLights)),l.subsurface&&(l.thickness?l.thicknessBasedTransmittance=!0:(t.maxDirIBLShadows=t._maxDirIBLShadows,t.maxShadows+=t._maxDirIBLShadows,t.shadowMapEnabled=t._shadowMapEnabled&&t.maxShadows>0),l.useMapTransmittance=t.shadowMapEnabled,l.useCubeTransmittance=t.shadowMapCubeEnabled,l.depthBasedTransmittance=l.useCubeTransmittance||l.useMapTransmittance,l.useTransmittance=l.thicknessBasedTransmittance||l.depthBasedTransmittance,l.useESMTransmittance=t.shadowMapType===e.ESMShadowMap||t.shadowMapType===e.ESMImprovedShadowMap,l.useIBLLights=t.maxDirIBLLights&&t.envMap&&l.useMapTransmittance),l.sheen&&(l.useSoftVelvet=l.sheenMode===e.SheenMode.VELVET_SOFT,l.useVelvet=l.sheenMode===e.SheenMode.VELVET,l.useSating=l.sheenMode===e.SheenMode.SATIN),o.__physicalMode>p.DSPBR&&(l.dspbrWithTranslucency=!!l.useTranslucency,l.dspbrWithClearCoatAboveEmissive=!0,l.dspbrWithSheenColorRoughness=!0,o.__physicalMode>p.DSPBR21x&&(l.dspbrWithFlipFlopColor=!!l.flipFlop,l.dspbrWithSquaredEstevezKullaRoughness=l.useSoftVelvet,l.dspbrWithNoSheenValue=!0,o.__physicalMode>p.DSPBR22x&&(l.dspbrWithTranslucencyColor=!!l.useTranslucency)))),this._getTextures(!0).filter((e=>null!==e)).length&&(l.needsUvSlot=!0),Object.assign(t,l)}getOpacity(){var e=this._opacity;null===this.opacityAddCoef||null===this.opacityMulCoef||this.opacityMap||(e=this.opacityMulCoef*e+this.opacityAddCoef);var t=this.transparency;return null===this.transparencyAddCoef||null===this.transparencyMulCoef||this.transparencyMap||(t=this.transparencyMulCoef*t+this.transparencyAddCoef),1-Math.max(1-e,Math.min(t,.99))}_getTextures(e){var t=super._getTextures(e);return t=t.concat([this.map,this.specularMap,this.metalnessMap,this.specularContribMap,this.emissionColorMap,this.transparencyMap,this.opacityMap,this.translucencyMap,this.translucencyColorMap,this.normalScaleMap,this.bumpScaleMap,this.roughnessMap,this.glossinessMap,this.bumpMap,this.normalMap]),this._dspbrFlakes?t=t.concat(this._dspbrFlakes.getTextures()):this._specGlossFlakes&&(t=t.concat(this._specGlossFlakes.getTextures())),this._clearCoat&&(t=t.concat(this._clearCoat.getTextures())),this._volume&&!e&&(t=t.concat(this._volume.getTextures())),this._thickness&&(t=t.concat(this._thickness.getTextures())),this._sheen&&(t=t.concat(this._sheen.getTextures())),this._anisotropy&&(t=t.concat(this._anisotropy.getTextures())),this._displacement&&(t=t.concat(this._displacement.getTextures())),this._iridescence&&(t=t.concat(this._iridescence.getTextures())),t}clone(e){return e||(e=new B),e.__physicalMode=this.__physicalMode,super.clone(e),e.useLighting=this.useLighting,e.thinWalled=this.thinWalled,e.uvSlot=this.uvSlot,e.color.copy(this.color),e.map=this.map,e.diffuseUvTransform=this.diffuseUvTransform,e.diffuseMulCoef=this.diffuseMulCoef,e.diffuseAddCoef=this.diffuseAddCoef,C(this,e,"specular",!0),C(this,e,"metalness",!1),C(this,e,"specularContrib",!1),C(this,e,"emissionColor",!0),e.emissionValue=this.emissionValue,e.emissionNormalized=this.emissionNormalized,C(this,e,"transparency",!1),C(this,e,"opacity",!1),e.useAlphaFromDiffuseMap=this.useAlphaFromDiffuseMap,e.ior=this.ior,C(this,e,"roughness",!1),e.glossinessMap=this.glossinessMap,e.glossinessMulCoef=this.glossinessMulCoef,e.glossinessAddCoef=this.glossinessAddCoef,e.reflectionProbes=this.reflectionProbes,e.envMipMap=this.envMipMap,e.envMap=this.envMap,C(this,e,"translucency",!1),C(this,e,"translucencyColor",!0),this.useTranslucencyColorFromAlbedo=e.useTranslucencyColorFromAlbedo,e.bumpMap=this.bumpMap,e.bumpUvTransform=this.bumpUvTransform,C(this,e,"bumpScale",!1),m(this,e,"normal"),e.normalMapFlipY=this.normalMapFlipY,C(this,e,"normalScale",!0),this._dspbrFlakes?e._dspbrFlakes=this._dspbrFlakes.clone(e):this._specGlossFlakes&&(e._specGlossFlakes=this._specGlossFlakes.clone(e)),this._clearCoat&&(e._clearCoat=this._clearCoat.clone(e)),this._volume&&(e._volume=this._volume.clone(e)),e._sheenData=null!==this._sheenData?this._sheenData.clone():null,this._sheen&&(e._sheen=this._sheen.clone(e)),this._anisotropy&&(e.anisotropy=this._anisotropy.clone(e)),this._displacement&&(e._displacement=this._displacement.clone(e)),this._iridescence&&(e._iridescence=this._iridescence.clone(e)),this._thickness&&(e._thickness=this._thickness.clone(e)),e.needTangent=this.needTangent,e.needTangentBinormal=this.needTangentBinormal,e._fromGLTF=this._fromGLTF,e.wireframe=this.wireframe,e}_needsIBLLightExtraction(){var e=this._volume&&this._volume.isEnabled(),t=this._thickness&&this._thickness.isEnabled();return e&&!t}_forceOpaqueShadowMapPass(){var e=this._volume&&this._volume.isEnabled(),t=this._thickness&&this._thickness.isEnabled();return e&&!t}_getLightsKey(e){return this.envMap?e.pbr-1:e.pbr}_getLightsUBOCache(e){return e.lightPBRBindingGroupCache}setPhysicalProperties(e){this.setCore(e),this.setAnisotropy(e),this.setDisplacement(e),this.setIridescence(e),this.setThickness(e),this.setVolume(e),this.__physicalMode>=p.DSPBR?this.setDSPBRFlakes(e):this.setSpecGlossFlakes(e),this.setClearCoat(e),this.setSheen(e)}isPropertyTextured(e){switch(e){case"sheenColor":return!!this._sheen&&!!this._sheen.sheenColorMap;case"sheenRoughness":return!!this._sheen&&!!this._sheen.sheenRoughnessMap;case"sheen":return!!this._sheen&&!!this._sheen.sheenMap;case"clearCoatNormal":return!!this._clearCoat&&!!this._clearCoat.clearCoatNormalMap;case"clearCoatColor":return!!this._clearCoat&&!!this._clearCoat.clearCoatColorMap;case"coatingGlossiness":return!!this._clearCoat&&!!this._clearCoat.coatingGlossinessMap;case"clearCoatRoughness":return!!this._clearCoat&&!!this._clearCoat.clearCoatRoughnessMap;case"clearCoat":return!!this._clearCoat&&!!this._clearCoat.clearCoatMap;case"flipFlop":return!!this._dspbrFlakes&&!!this._dspbrFlakes.flipFlopMap;case"flipFlopColor":return!!this._dspbrFlakes&&!!this._dspbrFlakes.flipFlopColorMap;case"flakesSize":return!!this._dspbrFlakes&&!!this._dspbrFlakes.flakesSizeMap;case"flakesRoughness":return!!this._dspbrFlakes&&!!this._dspbrFlakes.flakesRoughnessMap;case"flakesColor":return!!this._dspbrFlakes&&!!this._dspbrFlakes.flakesColorMap;case"flakesCoverage":return!!this._dspbrFlakes&&!!this._dspbrFlakes.flakesCoverageMap;case"diffuse":case"albedo":return!!this.map;case"transparency":return!!this.transparencyMap;case"specularContribution":return!!this.specularContribMap;case"metalness":return!!this.metalnessMap;case"emissionColor":return!!this.emissionColorMap;case"roughness":return!!this.roughnessMap;case"glossiness":return!!this.glossinessMap;case"translucency":return!!this.translucencyMap;case"translucencyColor":return this.useTranslucencyColorFromAlbedo?!!this.map:!!this.translucencyColorMap;case"normalScale":return!!this.normalScaleMap;case"bumpScale":return!!this.bumpScaleMap;case"anisotropy":return!!this._anisotropy&&!!this._anisotropy.anisotropyMap;case"anisotropyAngle":return!!this._anisotropy&&!!this._anisotropy.anisotropyAngleMap;case"displacement":return!!this._displacement&&!!this._displacement.displacementAngleMap;case"iridescence":return!!this._iridescence&&!!this._iridescence.iridescenceMap;case"iridescenceThickness":return!!this._iridescence&&!!this._iridescence.iridescenceThicknessMap;case"thickness":return!!this._thickness&&!!this._thickness.thicknessMap}return super.isPropertyTextured(e)}setCore(e){if(e&&0!==Object.keys(e).length&&!e.__initializing__){var t={};if($.forEach((s=>{void 0!==e[s]&&(G[s]&&void 0===e[G[s]]?t[G[s]]=e[s]:k[s]&&void 0===e[k[s]]?t[k[s]]=e[s]:G[s]||k[s]||(t[s]=e[s]))})),0!==Object.keys(t).length){this._revision++;var s={};if(this.needsUpdate||this._setCoreShaderOptions(s,!0,!1,!1,!1,!1),this.setValues(t),this._selectUvTransforms(),!this.needsUpdate){var i={};this._setCoreShaderOptions(i,!0,!1,!1,!1,!1);for(var a=Object.keys(s),r=0;r<a.length;r++)if(s[a[r]]!==i[a[r]]){this.needsUpdate=!0;break}}}}}setAnisotropy(e){if(e&&0!==Object.keys(e).length){var t={},s=R(x,e,t);-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length&&(this._revision++,this._anisotropy?this._anisotropy.setParameters(t):(t.anisotropyMap||t.anisotropy>0||!e.__initializing__)&&(this._anisotropy=new A(t,this),this.needsUpdate=!0))}}setDisplacement(e){if(e&&0!==Object.keys(e).length){var t={},s=R(U,e,t);-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length&&(this._revision++,this._displacement?this._displacement.setParameters(t):!t.displacementMap&&e.__initializing__||(this._displacement=new E(t,this),this.needsUpdate=!0))}}setIridescence(e){if(e&&0!==Object.keys(e).length){var t={},s=R(O,e,t);-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length&&(this._revision++,this._iridescence?this._iridescence.setParameters(t):(t.iridescence>0||t.iridescenceMap||!e.__initializing__)&&(this._iridescence=new L(t,this),this.needsUpdate=!0))}}setThickness(e){if(e&&0!==Object.keys(e).length){var t={},s=R(D,e,t);-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length&&(this._revision++,this._thickness?this._thickness.setParameters(t):(t.thicknessMap||t.thickness>0||!e.__initializing__)&&(this._thickness=new F(t,this),this.needsUpdate=!0),this.needsUpdate&&this._thickness&&(this._sendEvent("requestShadowMapUpdate"),this._invalidateDisplayRangeLists()))}}setVolume(e){if(e&&0!==Object.keys(e).length){var t={},s=R(T,e,t);if(-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length){this._revision++;var i=this.thinWalled;if(this.thinWalled=void 0!==t.thinWalled?!!t.thinWalled:this.thinWalled,this.ior=t.ior?t.ior:this.ior,this._volume)this._volume.setParameters(t);else{var a=void 0!==t.ior&&void 0!==t.thinWalled&&2===Object.keys(t).length;(a=(a=a||void 0!==t.ior&&1===Object.keys(t).length)||void 0!==t.thinWalled&&1===Object.keys(t).length)||!(t.subsurfacePreset||t.subsurfaceColor&&t.subsurfaceColor.getHex()>0||t.attenuationColor&&t.attenuationColor.getHex()<16711422)&&e.__initializing__||(this._volume=new b(t,this),this.needsUpdate=!0)}i!==this.thinWalled&&(this.needsUpdate=!0),this.needsUpdate&&this._volume&&(this._sendEvent("requestShadowMapUpdate"),this._invalidateDisplayRangeLists())}}}setDSPBRFlakes(e){if(e&&0!==Object.keys(e).length){var t={},s=R(M,e,t);-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length&&(this._revision++,null===this._dspbrFlakes?(t.flakesCoverageMap||t.flakesCoverage>0||!e.__initializing__)&&(this._dspbrFlakes=new _(t,this),this._specGlossFlakes&&(this._specGlossFlakes=null),this.needsUpdate=!0):this._dspbrFlakes.setParameters(t))}}setSpecGlossFlakes(e){if(!(!e||0===Object.keys(e).length||this._PDSFXData&&this._PDSFXData._extraDefines.dspbrFlakes)){var t={},s=R(g,e,t);-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length&&(this._revision++,null===this._specGlossFlakes?!t.flakes&&e.__initializing__||(this._specGlossFlakes=new v(t,this),this._dspbrFlakes&&(this._dspbrFlakes=null),this.needsUpdate=!0):this._specGlossFlakes.setParameters(t))}}setClearCoat(e){if(e&&0!==Object.keys(e).length){var t={},s=R(P,e,t);-1!==s&&(this.uvSlot=s),0!==Object.keys(t).length&&(this._revision++,null===this._clearCoat?(t.clearCoat>0||t.clearCoatMap||!e.__initializing__)&&(this._clearCoat=new y(t,this),this.needsUpdate=!0):this._clearCoat.setParameters(t))}}__prepareSheenData(){if(this._sheen&&this._sheen.isEnabled()){var e=this._sheen.sheenMode;if(e){var t=null;switch(null===this._sheenData?(t=new h({}),this._sheenData=new c({overrideIBL:t})):t=this._sheenData.overrideIBL,e){case u.VELVET:t.brdf=l.ASHIKMIN;break;case u.SATIN:t.brdf=l.BECKMANN;break;case u.VELVET_SOFT:t.brdf=l.ESTEVEZKULLA}}}}setSheen(t){if(t&&0!==Object.keys(t).length){var s={},i=R(w,t,s);if(-1!==i&&(this.uvSlot=i),0!==Object.keys(s).length){var a=!1;this.__physicalMode>=p.DSPBR22x?(delete s.sheen,delete s.sheenMap,delete s.sheenMulCoef,delete s.sheenAddCoef,delete s.sheenUvTransform,!s.sheenColor||s.sheenColor instanceof e.Color||(s.sheenColor=new e.Color(s.sheenColor)),s.sheenColor&&s.sheenColor.getHex()>0||s.sheenColorMap?(s.sheen=1,a=!0):s.sheenColor&&0===s.sheenColor.getHex()&&(s.sheen=0)):(s.sheen>0||s.sheenMap)&&(a=!0),0!==Object.keys(s).length&&(this._revision++,this._sheen?this._sheen.setParameters(s):!a&&t.__initializing__||(this._sheen=new I(s,this),this.needsUpdate=!0),this.__prepareSheenData())}}}_updateSubsurfaceScattering(){var e=this._volume;if(n.manager){this.needsUpdate=this.needsUpdate||null===e._sssLUT;var t=e._sssLUT;if(1===e._updateSSS)t&&n.decreaseUseCount(t.id),e._sssLUT=null,e._translucencyDepth=null,t&&(this.needsUpdate=!0);else{var s={absorptionCoeffs:e._absorptionCoeffs,scatteringCoeffs:e._scatteringCoeffs,eta:this.ior,subsurfaceAnisotropy:e.subsurfaceAnisotropy,color:e.subsurfaceColor.toArray()},i=n.getTextures(s);e._sssLUT=i.sssLUT,e._translucencyDepth=i.translucencyDepth,null!==t&&t.id!==e._sssLUT.id&&(n.decreaseUseCount(t.id),this._revision++)}e._updateSSS=0}else n.init()}loadGlobalUniforms(e,t,s){if(s.invScreenSize){let i=e.viewportData;t.uniform2f(s.invScreenSize,i.viewportInvWidth/i.viewportScale,i.viewportInvHeight/i.viewportScale)}s.aoTexture&&(t.uniform2f(s.aoParams,e.ssaoParams.contrast,e.ssaoParams.power),e.loadTexture(t,s.aoTexture,e._getAOBufferResult())),s.reflectionColorTexture&&e.loadTexture(t,s.reflectionColorTexture,e._getReflectionColorBufferResult(!1)),s.refractionColorTexture&&e.loadTexture(t,s.refractionColorTexture,e._getRefractionColorBufferResult(!1))}loadUniformsLights(e,t,s){e.loadUniformsLightsCommons(t,s,!1);const i=e.lights;if(s.directionalIBLLightColor&&i.directionalIBL.colors.length>0&&t.uniform4fv(s.directionalIBLLightColor,i.directionalIBL.colors),s.directionalIBLLightDirection&&i.directionalIBL.positions.length>0&&t.uniform4fv(s.directionalIBLLightDirection,i.directionalIBL.positions),s.iesLightColor&&i.ies.colors.length>0&&t.uniform4fv(s.iesLightColor,i.ies.colors),s.iesLightPosition&&i.ies.positions.length>0&&t.uniform4fv(s.iesLightPosition,i.ies.positions),s.iesLightTexture&&i.ies.iesLightTexture.length>0&&e.loadTextureArray(t,s.iesLightTexture,i.ies.iesLightTexture),s.matrixWorldInv&&e.loadMatrix4Array(t,s.matrixWorldInv,i.ies.matrixWorldInv),s.sphereLightColor&&i.sphere.colors.length>0&&t.uniform4fv(s.sphereLightColor,i.sphere.colors),s.sphereLightPosition&&i.sphere.positions.length>0&&t.uniform4fv(s.sphereLightPosition,i.sphere.positions),s.diskLightColor&&i.disk.colors.length>0&&t.uniform4fv(s.diskLightColor,i.disk.colors),s.diskLightNormal&&i.disk.normals.length>0&&t.uniform4fv(s.diskLightNormal,i.disk.normals),s.diskLightUp&&i.disk.ups.length>0&&t.uniform4fv(s.diskLightUp,i.disk.ups),s.diskLightPosition&&i.disk.positions.length>0&&t.uniform4fv(s.diskLightPosition,i.disk.positions),s.tubeLightColor&&i.tube.colors.length>0&&t.uniform4fv(s.tubeLightColor,i.tube.colors),s.tubeLightRight&&i.tube.rights.length>0&&t.uniform4fv(s.tubeLightRight,i.tube.rights),s.tubeLightPosition&&i.tube.positions.length>0&&t.uniform4fv(s.tubeLightPosition,i.tube.positions),s.rectangleLightColor&&i.rectangle.colors.length>0&&t.uniform4fv(s.rectangleLightColor,i.rectangle.colors),s.rectangleLightPosition&&i.rectangle.positions.length>0&&t.uniform4fv(s.rectangleLightPosition,i.rectangle.positions),s.rectangleLightNormal&&i.rectangle.normals.length>0&&t.uniform4fv(s.rectangleLightNormal,i.rectangle.normals),s.rectangleLightUp&&i.rectangle.ups.length>0&&t.uniform4fv(s.rectangleLightUp,i.rectangle.ups),(i.rectangle.colors.length>0||i.tube.colors.length>0||i.disk.colors.length>0||i.sphere.colors.length>0)&&s.precomputedAreaTexture&&e.loadTexture(t,s.precomputedAreaTexture,e.precomputedAreaTexture),s.precomputedTexture){var a=e.precomputedTexture;e.loadTexture(t,s.precomputedTexture,a)}const r=e.currentScene,n=r.envMipMap;if(s.envMap&&n&&n[0]){var o=1,l=1;if(s.envMap&&e.loadTexture(t,s.envMap,n[0]),s.envMap2&&e.loadTexture(t,s.envMap2,n[1]),n[0].hdr&&s.envMapHDRSize&&(n[0].image?(o=parseInt(n[0].image.width),l=parseInt(n[0].image.height)):(o=parseInt(n[0].width),l=parseInt(n[0].height)),t.uniform2f(s.envMapHDRSize,o,l)),n[1]&&s.envMapHDRToMipsRatio){var h=1;h=n[1].image?parseInt(n[1].image.width)/o:parseInt(n[1].width)/o,t.uniform1f(s.envMapHDRToMipsRatio,h)}var p=n[0].envMapExposureSpecular,u=n[0].envMapExposureDiffuse;s.envMapExposureSpecular&&t.uniform1f(s.envMapExposureSpecular,p||0===p?p:1),s.envMapExposureDiffuse&&t.uniform1f(s.envMapExposureDiffuse,u||0===u?u:1),s.ambienceMatrix&&t.uniformMatrix4fv(s.ambienceMatrix,!1,e.float32Matrix4x4Temp.setDoubles(r.ambienceMatrix.elements))}r.useFiniteEnvMap&&(s.sphereCenter&&t.uniform3f(s.sphereCenter,r.parallaxCorrectionParameters.sphereCenter.x,r.parallaxCorrectionParameters.sphereCenter.y,r.parallaxCorrectionParameters.sphereCenter.z),s.projectionCenter&&t.uniform3f(s.projectionCenter,r.parallaxCorrectionParameters.projectionCenter.x,r.parallaxCorrectionParameters.projectionCenter.y,r.parallaxCorrectionParameters.projectionCenter.z),s.sphereRadius&&t.uniform1f(s.sphereRadius,r.parallaxCorrectionParameters.sphereRadius))}loadUniforms(e,t,s,i,a,r){if(e.loadUniformsCommon(t,this,s,i,a,r),e.loadUniformsNormalMap(t,this,s),s.normalMap&&(t.uniformMatrix3fv(s.normalUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.normalUvTransform.elements)),s.normalScale&&t.uniform2f(s.normalScale,this.normalScale.x,this.normalScale.y),s.normalScaleMap&&(e.loadTexture(t,s.normalScaleMap,this.normalScaleMap),t.uniformMatrix3fv(s.normalScaleUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.normalScaleUvTransform.elements))),s.normalScaleAddCoef&&(t.uniform1f(s.normalScaleAddCoef,this.normalScaleAddCoef),t.uniform1f(s.normalScaleMulCoef,this.normalScaleMulCoef)),s.normalAddCoef&&(t.uniform3f(s.normalAddCoef,this.normalAddCoef.x,this.normalAddCoef.y,this.normalAddCoef.z),t.uniform3f(s.normalMulCoef,this.normalMulCoef.x,this.normalMulCoef.y,this.normalMulCoef.z))),s.bumpMap&&(t.uniformMatrix3fv(s.bumpUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.bumpUvTransform.elements)),s.bumpScale&&t.uniform1f(s.bumpScale,this.bumpScale),s.bumpScaleAddCoef&&(t.uniform1f(s.bumpScaleAddCoef,this.bumpScaleAddCoef),t.uniform1f(s.bumpScaleMulCoef,this.bumpScaleMulCoef)),e.loadTexture(t,s.bumpMap,this.bumpMap),s.bumpScaleMap&&(e.loadTexture(t,s.bumpScaleMap,this.bumpScaleMap),t.uniformMatrix3fv(s.bumpScaleUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.bumpScaleUvTransform.elements)))),s.diffuseAddCoef&&(t.uniform3f(s.diffuseAddCoef,this.diffuseAddCoef.x,this.diffuseAddCoef.y,this.diffuseAddCoef.z),t.uniform3f(s.diffuseMulCoef,this.diffuseMulCoef.x,this.diffuseMulCoef.y,this.diffuseMulCoef.z)),s.map&&(t.uniformMatrix3fv(s.diffuseUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.diffuseUvTransform.elements)),s.diffuseBorderColor)){var n={r:(l=this.map.borderColor).x,g:l.y,b:l.z};e.gammaInput&&(n=f.copyToLinear(n,e.simpleGamma)),t.uniform4f(s.diffuseBorderColor,n.r,n.g,n.b,l.w)}if(s.specular){var o=this.specular;n=e.gammaInput?f.copyToLinear(o,e.simpleGamma):o,t.uniform3f(s.specular,n.r,n.g,n.b)}if(s.specularAddCoef&&(t.uniform3f(s.specularAddCoef,this.specularAddCoef.x,this.specularAddCoef.y,this.specularAddCoef.z),t.uniform3f(s.specularMulCoef,this.specularMulCoef.x,this.specularMulCoef.y,this.specularMulCoef.z)),s.specularMap&&t.uniformMatrix3fv(s.specularUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.specularUvTransform.elements)),s.metalness&&t.uniform1f(s.metalness,this.metalness),s.metalnessMap&&(e.loadTexture(t,s.metalnessMap,this.metalnessMap),t.uniformMatrix3fv(s.metalnessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.metalnessUvTransform.elements))),s.metalnessMulCoef&&(t.uniform1f(s.metalnessMulCoef,this.metalnessMulCoef),t.uniform1f(s.metalnessAddCoef,this.metalnessAddCoef)),s.specularContrib&&t.uniform1f(s.specularContrib,this.specularContrib),s.specularContribMap&&(e.loadTexture(t,s.specularContribMap,this.specularContribMap),t.uniformMatrix3fv(s.specularContribUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.specularContribUvTransform.elements))),s.specularContribMulCoef&&(t.uniform1f(s.specularContribMulCoef,this.specularContribMulCoef),t.uniform1f(s.specularContribAddCoef,this.specularContribAddCoef)),s.emissionValue){if(t.uniform1f(s.emissionValue,this.emissionValue),s.emissionColor){n=this.emissionColor;e.gammaInput&&(n=f.copyToLinear(this.emissionColor,e.simpleGamma)),t.uniform3f(s.emissionColor,n.r,n.g,n.b)}s.emissionColorMap&&(e.loadTexture(t,s.emissionColorMap,this.emissionColorMap),t.uniformMatrix3fv(s.emissionColorUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.emissionColorUvTransform.elements))),s.emissionColorAddCoef&&(t.uniform3f(s.emissionColorAddCoef,this.emissionColorAddCoef.x,this.emissionColorAddCoef.y,this.emissionColorAddCoef.z),t.uniform3f(s.emissionColorMulCoef,this.emissionColorMulCoef.x,this.emissionColorMulCoef.y,this.emissionColorMulCoef.z))}if(s.transparency&&t.uniform1f(s.transparency,this.transparency),s.transparencyMap&&(e.loadTexture(t,s.transparencyMap,this.transparencyMap),t.uniformMatrix3fv(s.transparencyUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.transparencyUvTransform.elements))),s.transparencyMulCoef&&(t.uniform1f(s.transparencyMulCoef,this.transparencyMulCoef),t.uniform1f(s.transparencyAddCoef,this.transparencyAddCoef)),s.opacityMap&&(e.loadTexture(t,s.opacityMap,this.opacityMap),t.uniformMatrix3fv(s.opacityUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.opacityUvTransform.elements)),s.opacityBorderValue)){var l=this.opacityMap.borderColor;t.uniform1f(s.opacityBorderValue,l.x)}if(s.opacityMulCoef&&(t.uniform1f(s.opacityMulCoef,this.opacityMulCoef),t.uniform1f(s.opacityAddCoef,this.opacityAddCoef)),s.ior&&t.uniform1f(s.ior,this.ior),s.translucency&&t.uniform1f(s.translucency,this.translucency),s.translucencyMap&&(e.loadTexture(t,s.translucencyMap,this.translucencyMap),t.uniformMatrix3fv(s.translucencyUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.translucencyUvTransform.elements))),s.translucencyMulCoef&&(t.uniform1f(s.translucencyMulCoef,this.translucencyMulCoef),t.uniform1f(s.translucencyAddCoef,this.translucencyAddCoef)),s.translucencyColor){n=this.translucencyColor;e.gammaInput&&(n=f.copyToLinear(this.translucencyColor,e.simpleGamma)),t.uniform3f(s.translucencyColor,n.r,n.g,n.b)}s.translucencyColorMap&&(e.loadTexture(t,s.translucencyColorMap,this.translucencyColorMap),t.uniformMatrix3fv(s.translucencyColorUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.translucencyColorUvTransform.elements))),s.translucencyColorMulCoef&&(t.uniform3f(s.translucencyColorMulCoef,this.translucencyColorMulCoef.x,this.translucencyColorMulCoef.y,this.translucencyColorMulCoef.z),t.uniform3f(s.translucencyColorAddCoef,this.translucencyColorAddCoef.x,this.translucencyColorAddCoef.y,this.translucencyColorAddCoef.z)),s.useTranslucencyColorFromAlbedo&&t.uniform1i(s.useTranslucencyColorFromAlbedo,this.useTranslucencyColorFromAlbedo),s.roughness&&t.uniform1f(s.roughness,this.roughness),s.roughnessMap&&(e.loadTexture(t,s.roughnessMap,this.roughnessMap),t.uniformMatrix3fv(s.roughnessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.roughnessUvTransform.elements))),s.roughnessMulCoef&&(t.uniform1f(s.roughnessMulCoef,this.roughnessMulCoef),t.uniform1f(s.roughnessAddCoef,this.roughnessAddCoef)),s.glossinessMap&&(e.loadTexture(t,s.glossinessMap,this.glossinessMap),t.uniformMatrix3fv(s.roughnessUvTransform,!1,e.float32Matrix3x3Temp.setDoubles(this.roughnessUvTransform.elements))),s.glossinessMulCoef&&(t.uniform1f(s.glossinessMulCoef,this.glossinessMulCoef),t.uniform1f(s.glossinessAddCoef,this.glossinessAddCoef)),this._dspbrFlakes?this._dspbrFlakes.loadUniforms(e,t,s,i):this._specGlossFlakes&&this._specGlossFlakes.loadUniforms(e,t,s,i),this._clearCoat&&this._clearCoat.loadUniforms(e,t,s,i),this._sheen&&this._sheen.loadUniforms(e,t,s,i),this._volume&&this._volume.loadUniforms(e,t,s,i),this._thickness&&this._thickness.loadUniforms(e,t,s,i),this._anisotropy&&this._anisotropy.loadUniforms(e,t,s,i),this._displacement&&this._displacement.loadUniforms(e,t,s,i),this._iridescence&&this._iridescence.loadUniforms(e,t,s,i),s.reflectionProbePos&&this.reflectionProbes&&(t.uniform3f(s.reflectionProbePos,this.reflectionProbes.position.x,this.reflectionProbes.position.y,this.reflectionProbes.position.z),t.uniform3f(s.reflectionProbeProxyMin,this.reflectionProbes.box.min.x,this.reflectionProbes.box.min.y,this.reflectionProbes.box.min.z),t.uniform3f(s.reflectionProbeProxyMax,this.reflectionProbes.box.max.x,this.reflectionProbes.box.max.y,this.reflectionProbes.box.max.z)),!s.uvSlot||r&&r._mappingOperator||t.uniform1i(s.uvSlot,this.uvSlot)}fillGlobalUBO(e,t){const s=e.layout;if(s.invScreenSize){let i=t.viewportData;e.setFlatV2(s.invScreenSize,i.viewportInvWidth/i.viewportScale,i.viewportInvHeight/i.viewportScale)}s.aoTexture&&(e.setTexture(s.aoTexture,t._getAOBufferResult()),e.setFlatV2(s.aoParams,t.ssaoParams.contrast,t.ssaoParams.power)),s.reflectionColorTexture&&e.setTexture(s.reflectionColorTexture,t._getReflectionColorBufferResult(!1)),s.refractionColorTexture&&e.setTexture(s.refractionColorTexture,t._getRefractionColorBufferResult(!1))}fillLightsUBO(e,t){t.fillLightsUBOCommons(e,!1);const s=t.lights,i=e.layout;i.directionalIBLLightColor&&e.setFlatV4Array(i.directionalIBLLightColor,s.directionalIBL.colors),i.directionalIBLLightDirection&&e.setFlatV4Array(i.directionalIBLLightDirection,s.directionalIBL.positions),i.iesLightColor&&e.setFlatV4Array(i.iesLightColor,s.ies.colors),i.iesLightPosition&&e.setFlatV4Array(i.iesLightPosition,s.ies.positions),i.iesLightTexture&&e.setTextureArray(i.iesLightTexture,s.ies.iesLightTexture),i.matrixWorldInv&&e.setM4Array(i.matrixWorldInv,s.ies.matrixWorldInv),i.sphereLightColor&&e.setFlatV4Array(i.sphereLightColor,s.sphere.colors),i.sphereLightPosition&&e.setFlatV4Array(i.sphereLightPosition,s.sphere.positions),i.diskLightColor&&e.setFlatV4Array(i.diskLightColor,s.disk.colors),i.diskLightNormal&&e.setFlatV4Array(i.diskLightNormal,s.disk.normals),i.diskLightUp&&e.setFlatV4Array(i.diskLightUp,s.disk.ups),i.diskLightPosition&&e.setFlatV4Array(i.diskLightPosition,s.disk.positions),i.tubeLightColor&&e.setFlatV4Array(i.tubeLightColor,s.tube.colors),i.tubeLightRight&&e.setFlatV4Array(i.tubeLightRight,s.tube.rights),i.tubeLightPosition&&e.setFlatV4Array(i.tubeLightPosition,s.tube.positions),i.rectangleLightColor&&e.setFlatV4Array(i.rectangleLightColor,s.rectangle.colors),i.rectangleLightPosition&&e.setFlatV4Array(i.rectangleLightPosition,s.rectangle.positions),i.rectangleLightNormal&&e.setFlatV4Array(i.rectangleLightNormal,s.rectangle.normals),i.rectangleLightUp&&e.setFlatV4Array(i.rectangleLightUp,s.rectangle.ups),(s.rectangle.colors.length>0||s.tube.colors.length>0||s.disk.colors.length>0||s.sphere.colors.length>0)&&i.precomputedAreaTexture&&e.setTexture(i.precomputedAreaTexture,t.precomputedAreaTexture),i.precomputedTexture&&e.setTexture(i.precomputedTexture,t.precomputedTexture);const a=t.currentScene,r=a.envMipMap;if(r&&r[0]){var n=1,o=1;if(i.envMap&&e.setTexture(i.envMap,r[0]),i.envMap2&&e.setTexture(i.envMap2,r[1]),r[0].hdr&&i.envMapHDRSize&&(r[0].image?(n=parseInt(r[0].image.width),o=parseInt(r[0].image.height)):(n=parseInt(r[0].width),o=parseInt(r[0].height)),e.setFlatV2(i.envMapHDRSize,n,o)),r[1]&&i.envMapHDRToMipsRatio){var l=1;l=r[1].image?parseInt(r[1].image.width)/n:parseInt(r[1].width)/n,e.setF(i.envMapHDRToMipsRatio,l)}var h=r[0].envMapExposureSpecular,p=r[0].envMapExposureDiffuse;i.envMapExposureSpecular&&e.setF(i.envMapExposureSpecular,h||0===h?h:1),i.envMapExposureDiffuse&&e.setF(i.envMapExposureDiffuse,p||0===p?p:1),i.ambienceMatrix&&e.setM4(i.ambienceMatrix,a.ambienceMatrix)}a.useFiniteEnvMap&&(i.sphereCenter&&e.setV3(i.sphereCenter,a.parallaxCorrectionParameters.sphereCenter),i.projectionCenter&&e.setV3(i.projectionCenter,a.parallaxCorrectionParameters.projectionCenter),i.sphereRadius&&e.setF(i.sphereRadius,a.parallaxCorrectionParameters.sphereRadius))}fillUBO(e,t){t.fillMaterialCommonsUBO(e,this),t.fillNormalMapUBO(e,this);const s=e.layout;s.normalMap&&(s.normalUvTransform&&e.setM3(s.normalUvTransform,this.normalUvTransform),s.normalAddCoef&&(e.setV3(s.normalAddCoef,this.normalAddCoef),e.setV3(s.normalMulCoef,this.normalMulCoef)),s.normalScale&&e.setV2(s.normalScale,this.normalScale),s.normalScaleMap&&e.setTexture(s.normalScaleMap,this.normalScaleMap),s.normalScaleUvTransform&&e.setM3(s.normalScaleUvTransform,this.normalScaleUvTransform),s.normalScaleAddCoef&&(e.setF(s.normalScaleAddCoef,this.normalScaleAddCoef),e.setF(s.normalScaleMulCoef,this.normalScaleMulCoef))),s.bumpMap&&(e.setTexture(s.bumpMap,this.bumpMap),e.setM3(s.bumpUvTransform,this.bumpUvTransform),s.bumpScale&&e.setF(s.bumpScale,this.bumpScale),s.bumpScaleMap&&e.setTexture(s.bumpScaleMap,this.bumpScaleMap),s.bumpScaleUvTransform&&e.setM3(s.bumpScaleUvTransform,this.bumpScaleUvTransform),s.bumpScaleAddCoef&&(e.setF(s.bumpScaleAddCoef,this.bumpScaleAddCoef),e.setF(s.bumpScaleMulCoef,this.bumpScaleMulCoef))),s.diffuseUvTransform&&e.setM3(s.diffuseUvTransform,this.diffuseUvTransform),s.diffuseAddCoef&&(e.setV3(s.diffuseAddCoef,this.diffuseAddCoef),e.setV3(s.diffuseMulCoef,this.diffuseMulCoef)),s.diffuseBorderColor&&e.setColorPlusF(s.diffuseBorderColor,{r:this.map.borderColor.x,g:this.map.borderColor.y,b:this.map.borderColor.z},this.map.borderColor.w,t.gammaInput,t.simpleGamma),s.specular&&e.setColor(s.specular,this.specular,t.gammaInput,t.simpleGamma),s.specularMap&&e.setTexture(s.specularMap,this.specularMap),s.specularUvTransform&&e.setM3(s.specularUvTransform,this.specularUvTransform),s.specularAddCoef&&(e.setV3(s.specularAddCoef,this.specularAddCoef),e.setV3(s.specularMulCoef,this.specularMulCoef)),s.metalness&&e.setF(s.metalness,this.metalness),s.metalnessMap&&e.setTexture(s.metalnessMap,this.metalnessMap),s.metalnessUvTransform&&e.setM3(s.metalnessUvTransform,this.metalnessUvTransform),s.metalnessAddCoef&&(e.setF(s.metalnessAddCoef,this.metalnessAddCoef),e.setF(s.metalnessMulCoef,this.metalnessMulCoef)),s.specularContrib&&e.setF(s.specularContrib,this.specularContrib),s.specularContribMap&&e.setTexture(s.specularContribMap,this.specularContribMap),s.specularContribUvTransform&&e.setM3(s.specularContribUvTransform,this.specularContribUvTransform),s.specularContribAddCoef&&(e.setF(s.specularContribAddCoef,this.specularContribAddCoef),e.setF(s.specularContribMulCoef,this.specularContribMulCoef)),s.emissionValue&&e.setF(s.emissionValue,this.emissionValue),s.emissionColor&&e.setColor(s.emissionColor,this.emissionColor,t.gammaInput,t.simpleGamma),s.emissionColorMap&&e.setTexture(s.emissionColorMap,this.emissionColorMap),s.emissionColorUvTransform&&e.setM3(s.emissionColorUvTransform,this.emissionColorUvTransform),s.emissionColorAddCoef&&(e.setV3(s.emissionColorAddCoef,this.emissionColorAddCoef),e.setV3(s.emissionColorMulCoef,this.emissionColorMulCoef)),s.transparency&&e.setF(s.transparency,this.transparency),s.transparencyMap&&e.setTexture(s.transparencyMap,this.transparencyMap),s.transparencyUvTransform&&e.setM3(s.transparencyUvTransform,this.transparencyUvTransform),s.transparencyAddCoef&&(e.setF(s.transparencyAddCoef,this.transparencyAddCoef),e.setF(s.transparencyMulCoef,this.transparencyMulCoef)),s.opacityMap&&e.setTexture(s.opacityMap,this.opacityMap),s.opacityUvTransform&&e.setM3(s.opacityUvTransform,this.opacityUvTransform),s.opacityAddCoef&&(e.setF(s.opacityAddCoef,this.opacityAddCoef),e.setF(s.opacityMulCoef,this.opacityMulCoef)),s.opacityBorderValue&&e.setF(s.opacityBorderValue,this.opacityMap.borderColor.x),s.ior&&e.setF(s.ior,this.ior),s.translucency&&e.setF(s.translucency,this.translucency),s.translucencyMap&&e.setTexture(s.translucencyMap,this.translucencyMap),s.translucencyUvTransform&&e.setM3(s.translucencyUvTransform,this.translucencyUvTransform),s.translucencyAddCoef&&(e.setF(s.translucencyAddCoef,this.translucencyAddCoef),e.setF(s.translucencyMulCoef,this.translucencyMulCoef)),s.translucencyColor&&e.setColor(s.translucencyColor,this.translucencyColor,t.gammaInput,t.simpleGamma),s.translucencyColorMap&&e.setTexture(s.translucencyColorMap,this.translucencyColorMap),s.translucencyColorUvTransform&&e.setM3(s.translucencyColorUvTransform,this.translucencyColorUvTransform),s.translucencyColorAddCoef&&(e.setV3(s.translucencyColorAddCoef,this.translucencyColorAddCoef),e.setV3(s.translucencyColorMulCoef,this.translucencyColorMulCoef)),s.useTranslucencyColorFromAlbedo&&e.setI(s.useTranslucencyColorFromAlbedo,this.useTranslucencyColorFromAlbedo),s.roughness&&e.setF(s.roughness,this.roughness),s.roughnessMap&&e.setTexture(s.roughnessMap,this.roughnessMap),s.roughnessUvTransform&&e.setM3(s.roughnessUvTransform,this.roughnessUvTransform),s.roughnessAddCoef&&(e.setF(s.roughnessAddCoef,this.roughnessAddCoef),e.setF(s.roughnessMulCoef,this.roughnessMulCoef)),s.glossinessMap&&e.setTexture(s.glossinessMap,this.glossinessMap),s.glossinessAddCoef&&(e.setF(s.glossinessAddCoef,this.glossinessAddCoef),e.setF(s.glossinessMulCoef,this.glossinessMulCoef)),s.reflectionProbePos&&this.reflectionProbes&&(e.setV3(s.reflectionProbePos,this.reflectionProbes.position),e.setV3(s.reflectionProbeProxyMin,this.reflectionProbes.box.min),e.setV3(s.reflectionProbeProxyMax,this.reflectionProbes.box.max)),this._dspbrFlakes?this._dspbrFlakes.fillUBO(e,t):this._specGlossFlakes&&this._specGlossFlakes.fillUBO(e,t),this._clearCoat&&this._clearCoat.fillUBO(e,t),this._sheen&&this._sheen.fillUBO(e,t),this._volume&&this._volume.fillUBO(e,t),this._thickness&&this._thickness.fillUBO(e,t),this._anisotropy&&this._anisotropy.fillUBO(e,t),this._displacement&&this._displacement.fillUBO(e,t),this._iridescence&&this._iridescence.fillUBO(e,t)}fillUBOHigh(e,t,s,i,a){t.fillMaterialHighFrequencyCommonsUBO(e,this,s,i,a);const r=e.layout;!r.uvSlot||i&&i._mappingOperator||e.setI(r.uvSlot,this.uvSlot)}areTexturesLoaded(){return!!super.areTexturesLoaded()&&(!(this.envMipMap&&this.envMipMap[0]&&!this.envMipMap[0]._canBeUsed())&&!(this.envMipMap&&this.envMipMap[1]&&!this.envMipMap[1]._canBeUsed()))}_computeAmbianceKeyAndProcessMaterial(e,t,s,i,a){super._computeAmbianceKeyAndProcessMaterial(e,t,s,i,a),this._volume&&this._volume._updateSSS>0&&this._updateSubsurfaceScattering();var n=i._pbrCheck;if(n&&(n.has=!0,n.hasTransparent||(n.hasTransparent=this.transparency>0||!!this.transparencyAddCoef||!!this.transparencyMulCoef||!!this.transparencyMap)),!e)return 0;i.id;const h=this.reflectionProbes;if(this.envMipMap=null,this.envMap=null,this.reflectionProbes=null,t.envMipMap.length>0){if(t.envMipMap[0].hdr&&(null===t.envMipMap[1]||t.envMipMapID)){var p=t.envMipMap[0],u=t.id+"sm"+p.id,c=p.id;c+="-"+l.GGX,t.envMipMapID&&t.envMipMapID!==u&&r.decreaseUseCount(t.envMipMapID),t.envMipMapID=u,r.manager||r.init(0),t.envMipMap[1]=r.getAmbiance(c,!0,{hdr:p,brdf:l.GGX},u)}this.envMipMap=t.envMipMap,this.envMap=t.envMipMap[0]}var d=t.reflectionProbes,f=!!t.reflectionProbes;if(this._sheenData){const e=this._sheenData.envMipMap;this._sheenData.envMipMap=null;var m=this._sheenData;if(null!==m.overrideIBL&&t.envMipMap.length>0){var C=m.overrideIBL;p=t.envMipMap[0],u=t.id+"ss"+p.id,c=p.id+"-"+C.brdf;t.envMipMapSheenID&&t.envMipMapSheenID!==u&&r.decreaseUseCount(t.envMipMapSheenID),t.envMipMapSheenID=u;var S;r.manager||r.init(1),e!==(S=r.getAmbiance(c,!C.direct,{hdr:p,brdf:C.brdf},u))&&this._revision++,this._sheenData.envMipMap=S}}d&&(this.reflectionProbes=d);this.reflectionProbes!==h&&this._revision++,this._needsIBLLightExtraction()&&this.envMap&&!f&&0===s.dirIBLLights&&(i.needsExtractIBLLight=!0);let M=0;return this.envMap&&(M=this.envMap.encoding,this.envMap.magFilter===o&&(M+=128)),M+((this.reflectionProbes?16:0)|(this._sheenData&&this._sheenData.envMipMap?32:0)|(this.envMipMap&&this.envMipMap[1]&&this.envMipMap[1].hasDiffuse?64:0))}_defaultPDSFXOverridableFunctions(){var t=super._defaultPDSFXOverridableFunctions();return Object.assign(t.fragment,{ComputeViewNormal:e._ShaderChunk.PDSFXComputeViewNormal_FS,ComputeSpecularReflectance:e._ShaderChunk.PDSFXComputeSpecularReflectance_FS,ComputeEmissive:e._ShaderChunk.PDSFXComputeEmissive_FS,ComputeTranslucencyColor:e._ShaderChunk.PDSFXComputeTranslucencyColor_FS,ComputeClearcoatColor:e._ShaderChunk.PDSFXComputeClearcoatColor_FS,ComputeFlakeColor:e._ShaderChunk.PDSFXComputeFlakeColor_FS,ComputeFlipFlopColor:e._ShaderChunk.PDSFXComputeFlipFlopColor_FS,ComputeSheenColor:e._ShaderChunk.PDSFXComputeSheenColor_FS,ComputeRoughness:e._ShaderChunk.PDSFXComputeRoughness_FS,ComputeTransparency:e._ShaderChunk.PDSFXComputeTransparency_FS,ComputeClearcoatViewNormal:e._ShaderChunk.PDSFXComputeClearcoatViewNormal_FS,ComputeTranslucency:e._ShaderChunk.PDSFXComputeTranslucency_FS,ComputeThickness:e._ShaderChunk.PDSFXComputeThickness_FS,ComputeClearcoat:e._ShaderChunk.PDSFXComputeClearcoat_FS,ComputeClearcoatRoughness:e._ShaderChunk.PDSFXComputeClearcoatRoughness_FS,ComputeFlakeCoverage:e._ShaderChunk.PDSFXComputeFlakeCoverage_FS,ComputeFlakeRoughness:e._ShaderChunk.PDSFXComputeFlakeRoughness_FS,ComputeFlakeSize:e._ShaderChunk.PDSFXComputeFlakeSize_FS,ComputeFlipFlop:e._ShaderChunk.PDSFXComputeFlipFlop_FS,ComputeSheen:e._ShaderChunk.PDSFXComputeSheen_FS,ComputeSheenRoughness:e._ShaderChunk.PDSFXComputeSheenRoughness_FS,ComputeMetallic:e._ShaderChunk.PDSFXComputeMetallic_FS,ComputeSpecular:e._ShaderChunk.PDSFXComputeSpecular_FS,ComputeAnisotropy:e._ShaderChunk.PDSFXComputeAnisotropy_FS,ComputeAnisotropyRotation:e._ShaderChunk.PDSFXComputeAnisotropyRotation_FS,ComputeIridescence:e._ShaderChunk.PDSFXComputeIridescence_FS,ComputeIridescenceThickness:e._ShaderChunk.PDSFXComputeIridescenceThickness_FS}),t}setPDSFXOverridableFunctions(t,s){var i={};if(Object.assign(i,s),i.ComputeSpecularTint&&!i.ComputeSpecularReflectance&&(i.ComputeSpecularReflectance=i.ComputeSpecularTint),super.setPDSFXOverridableFunctions(t,i),this._PDSFXData){var a=this._PDSFXData._extraDefines,r=this.__physicalMode>p.DSPBR21x;a.clearCoat=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeClearcoat!==e._ShaderChunk.PDSFXComputeClearcoat_FS,a.clearCoat&&!this._clearCoat&&(this._clearCoat=new y({},this)),a.dspbrFlakes=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeFlakeCoverage!==e._ShaderChunk.PDSFXComputeFlakeCoverage_FS,a.flipFlop=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeFlipFlop!==e._ShaderChunk.PDSFXComputeFlipFlop_FS,a.dspbrFlakes&&!this._dspbrFlakes&&(this._dspbrFlakes=new _({},this),this._specGlossFlakes=null),a.sheen=!r&&this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeSheen!==e._ShaderChunk.PDSFXComputeSheen_FS||r&&this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeSheenColor!==e._ShaderChunk.PDSFXComputeSheenColor_FS,a.sheen&&!this._sheen&&(this._sheen=new I({},this)),a.anisotropy=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeAnisotropy!==e._ShaderChunk.PDSFXComputeAnisotropy_FS,a.anisotropy&&!this._anisotropy&&(this._anisotropy=new A({},this)),a.thickness=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeThickness!==e._ShaderChunk.PDSFXComputeThickness_FS,a.thickness&&!this._thickness&&(this._thickness=new F({},this)),a.iridescence=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeIridescence!==e._ShaderChunk.PDSFXComputeIridescence_FS,a.iridescence&&!this._iridescence&&(this._iridescence=new L({},this)),a.translucency=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeTranslucency!==e._ShaderChunk.PDSFXComputeTranslucency_FS,a.transparency=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeTransparency!==e._ShaderChunk.PDSFXComputeTransparency_FS,a.emissionColor=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeEmissive!==e._ShaderChunk.PDSFXComputeEmissive_FS,a.flakesSizeOverriden=this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeFlakeSize!==e._ShaderChunk.PDSFXComputeFlakeSize_FS,this.__prepareSheenData()}}updateDeferredMaterials(t){super.updateDeferredMaterials(t),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=this}get wireframe(){return this._wireframe}set wireframe(e){e!==this._wireframe&&this._invalidateDisplayRangeLists(),this._wireframe=e}}return B.prototype.isPhysicalMaterial=!0,B.prototype._shaderID="physicalDS",B.prototype._autoForceSide=!0,B})),define("DS/Materials/DSPBR21x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],(function(e,t){"use strict";class s extends t{constructor(e){e=e||{};var s={};Object.assign(s,e),t._setTypeParams(s),s.dspbr21x=!0,super(s)}clone(){var e=new s;return super.clone(e),e}}return s})),define("DS/Materials/DSPBR25x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],(function(e,t){"use strict";const s=e.DSPBRSubTypes;class i extends t{constructor(e){e=e||{};var i={};Object.assign(i,e),t._setTypeParams(i),i.dspbr25x=!0,super(i),this._subtype=void 0!==i._subtype?i._subtype:s.Generic}clone(){var e=new i;return super.clone(e),e._subtype=this._subtype,e}getSubType(){switch(this._subtype){case s.Metal:return"Metal";case s.Glass:return"Glass";case s.Plastic:return"Plastic";case s.Textile:return"Textile";case s.Leather:return"Leather";case s["Car Paint"]:return"Car Paint";case s.Emissive:return"Emissive";case s.Basic:return"Basic";case s.Wood:return"Wood"}return"Generic"}}return i})),define("DS/Materials/DSPBR22x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],(function(e,t){"use strict";const s=e.DSPBRSubTypes;class i extends t{constructor(e){e=e||{};var i={};Object.assign(i,e),t._setTypeParams(i),i.dspbr22x=!0,super(i),this._subtype=void 0!==i._subtype?i._subtype:s.Generic}clone(){var e=new i;return super.clone(e),e._subtype=this._subtype,e}getSubType(){switch(this._subtype){case s.Metal:return"Metal";case s.Glass:return"Glass";case s.Plastic:return"Plastic";case s.Textile:return"Textile";case s.Leather:return"Leather";case s["Car Paint"]:return"Car Paint";case s.Emissive:return"Emissive";case s.Basic:return"Basic";case s.Wood:return"Wood"}return"Generic"}}return i})),define("DS/Materials/DSPBR19x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],(function(e,t){"use strict";class s extends t{constructor(e){e=e||{};var s={};Object.assign(s,e),t._setTypeParams(s),s.dspbr19x=!0,super(s)}clone(e){return e||(e=new s),super.clone(e),e}}return s})),define("DS/Materials/GASPBR",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],(function(e,t){"use strict";class s extends t{constructor(e,t){if(!t)throw"Missing low quality material";super(e),this._phongFallbackMaterial=t,t._isFromGAS=!0,this._isFromGAS=!0,t._isGASFallback=!0}clone(){var e=new s(null,this._phongFallbackMaterial);return super.clone(e),e}getSubType(){return"GASPBR"}getType(){return"GASPBR"}activatePDSFX(e=null){}setCore(e){var t={diffuse:(e=e||{}).diffuse,color:e.color,albedo:e.albedo,opacity:e.opacity};super.setColor(t)}setAnisotropy(){}setDisplacement(){}setIridescence(){}setThickness(){}setVolume(){}setDSPBRFlakes(){}setSpecGlossFlakes(){}setClearCoat(){}setSheen(){}set wireframe(e){this._wireframe=!1}}return s})),define("DS/Materials/SmallPlaneMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],(function(e,t){"use strict";return class extends t{constructor(){super({specularContrib:0,metalness:0,ior:1,transparency:0,opacity:1,color:new e.Color(16777215)}),this.useLighting=!0,this.transparent=!1,this.useBlending=!0,this.blending=e.GroundShadowBlending,this.depthWrite=!1,this.side=e.DoubleSide,this.force=!0,this.polygonOffset=!0,this.polygonOffsetFactor=2,this.polygonOffsetUnits=1,this.enableClipPlanes=!1,this.defines={GROUND_SHADOW:0,INVISIBLE_PLANE_MATERIAL:!0},this.activatePDSFX("PDSFXSmallPlaneMaterial");this.setPDSFXUniforms({groundShadow:{type:"t2",value:null},smallPlaneSSAO:{type:"f",value:1}}),this.setPDSFXOverridableFunctions({},{ComputeDiscard:function(e,t){const s=e.variableHandler,i=(e.functionHandler,e.pdsfxDefines,e.userDefines,e=>s.vec3(e));return`\n                    ${i("I")} = ${i()}(0.0,0.0,1.0);\n                    if (!(${e.vGetProjectionMatrix()}[3][3] > 0.0)) {\n                        I = normalize(-${e.vGetViewPosition()});\n                    }\n                    return dot(I, ${e.vGetViewNormal()}) < 0.0;\n                    `},ProcessFinalColor:function(e,t){const s=e.variableHandler,i=e.bridgeFunctions,a=e.pdsfxDefines,r=e.userDefines,n=e=>s.float(e),o=e=>s.vec2(e),l=e=>s.vec3(e),h=s.dereference(t[0]);return`\n                        ${l("finalColor")} = clamp((${h}).rgb, ${l()}(0.0),  ${l()}(1.0));\n                        ${a.gammaOutput?"\n                            finalColor *= finalColor;\n                            ":""}\n                        ${o("uv")} = ${e.vGetTexCoord0()}.xy;\n                        ${r.GROUND_SHADOW?`\n                            finalColor *= ${i.sample2DTexture((p="groundShadow",e.getTextureUniform(p)),"uv")}.x;\n                            `:""}\n                        ${o("toCenter")}  = 2.0 * (${o()}(0.5) - uv);\n                        ${n("distToCenter")}  = min(1.0, dot(toCenter, toCenter));\n                        ${n("alpha")}  = 1.0-max(finalColor.x,max(finalColor.y,finalColor.z));\n                        finalColor = mix(finalColor, ${l()}(1.0), distToCenter);\n                        ${a.gammaOutput?"\n                            finalColor = sqrt(finalColor);\n                            ":""}\n                        finalColor = clamp(finalColor, ${l()}(0.0), ${l()}(1.0));\n                        (${h}).r = finalColor.r;\n                        (${h}).g = finalColor.g;\n                        (${h}).b = finalColor.b;\n                        (${h}).a = alpha;\n                    `;var p}})}getType(){return"Small Plane"}getPredefinedMaterial(e,t,s){return this}_getLightsKey(e){return-super._getLightsKey(e)}_setMaterialShaderOptions(e,t,s,i,a,r){e.useOIT=!1,e.inlinedPostProActivated=!1,e.invisiblePlaneMaterial=!0,e.maxDirIBLLights=0,e.maxDirPhongLights=0,e.maxSphereLights=0,e.maxTubeLights=0,e.maxDiskLights=0,e.maxRectangleLights=0,e.maxIESLights=0,super._setMaterialShaderOptions(e,t,s,i,a,r)}areTexturesLoaded(){return!0}updateDeferredMaterials(t){super.updateDeferredMaterials(t),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=null,this._deferredMaterials[e.MaterialToUse.depthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalMaterial]=null,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepth]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null}set wireframe(e){this._wireframe=!1}}})),define("DS/Materials/CATGraphicalMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,s){"use strict";const i=(e,t,i)=>s.FunctionHandler.callFunction(e,t,i);var a={User:0,ObjectLinearPlanar:1,EyeLinearPlanar:2,Environment:3},r={VisuBasic_diffuseTexCoord:{type:"v4"}},n=[null,function(e){const t=e.variableHandler,s=t=>e.getUniform(t),i=e=>t.vec4(e);return`         \n            ${e.functionHandler.dF("VisuBasic_ComputeDiffuseTexCoord","v4",[])} {             \n                ${i("res")}  = ${i()}(0.0);\n                ${i("pos")}  = ${i()}(${e.vGetAttribPosition()}, 1.0);\n                return ${i()}(\n                    dot(${s("VisuBasic_ProjectionPlaneS")}, pos),\n                    dot(${s("VisuBasic_ProjectionPlaneT")}, pos),\n                    0.0,\n                    0.0\n                );\n            } \n        `},function(e){const t=e.variableHandler,s=e.functionHandler,a=t=>e.getUniform(t),r=e=>t.vec4(e),n=e=>t.mat4(e);return`    \n            ${s.dF("VisuBasic_Transpose","m4",[s.prmM4("m")])}{\n                ${n("mT")};\n\n                mT[0] = ${r()}(m[0][0], m[1][0], m[2][0], m[3][0]);\n                mT[1] = ${r()}(m[0][1], m[1][1], m[2][1], m[3][1]);\n                mT[2] = ${r()}(m[0][2], m[1][2], m[2][2], m[3][2]);\n                mT[3] = ${r()}(m[0][3], m[1][3], m[2][3], m[3][3]);\n\n                return mT;\n            }\n\n            ${s.dF("VisuBasic_ComputeDiffuseTexCoord","v4",[])}{\n                ${r("res")}  = ${r()}(0.0);\n                ${r("pos")}  = ${r()}(${e.vGetAttribPosition()}, 1.0);\n                pos = ${i("computeModelViewPosition","v4",[s.prmV4("pos")])};\n\n                ${n("modelViewInv")}  = ${s.cF("VisuBasic_Transpose","m4",[s.prmM4(`${e.vGetWorldViewInvTranspMatrix()}`)])};\n                return ${r()}(\n                    dot(modelViewInv*${a("VisuBasic_ProjectionPlaneS")}, pos),\n                    dot(modelViewInv*${a("VisuBasic_ProjectionPlaneT")}, pos),\n                    0.0,\n                    0.0\n                );\n            }\n        `},function(e){const t=e.variableHandler,s=e.functionHandler,a=e=>t.vec4(e);return`\n        ${s.dF("VisuBasic_ComputeDiffuseTexCoord","v4",[])}{\n            ${a("res")}  = ${a()}(0.0);\n            ${a("pos")}  = ${a()}(${e.vGetAttribPosition()}, 1.0);\n            pos = ${i("computeModelViewPosition","v4",[s.prmV4("pos")])};\n\n            res = ${a()}(normalize(pos.xyz), 0.0);\n            return res;\n        }\n        `}],o=function(e){const t=e.functionHandler;return`\n        ${s="VisuBasic_diffuseTexCoord",e.getVarying(s)} = ${t.cF("VisuBasic_ComputeDiffuseTexCoord","v4",[])};\n        `;var s},l=function(e){const t=e.variableHandler,s=e.functionHandler;return`\n        \n        ${i="VisuBasic_diffuseTexUvToUse",t.vec2G(i)} ;\n\n        ${s.dF("VisuBasic_ComputeSphereMapCoord","v2",[s.prmV3("r")])}{\n            ${(e=>t.vec3(e))("R")} = r;\n            R.z += 1.0;\n            ${(e=>t.float(e))("m")} = 0.5/sqrt(dot(R,R));\n            return ${(e=>t.vec2(e))()}(R.x*m+0.5, R.y*m+0.5);\n        }\n        `;var i},h=function(e){return`\n        VisuBasic_diffuseTexUvToUse = ${t="VisuBasic_diffuseTexCoord",e.getVarying(t)}.xy;\n        `;var t},p=[null,h,h,function(e){const t=e.variableHandler,s=e.functionHandler,i=e=>t.vec3(e);return`\n        ${i("VisuBasic_orientedViewNormal")}  = ${e.vGetViewNormal()};\n        ${i("VisuBasic_dir")}  = reflect(${a="VisuBasic_diffuseTexCoord.xyz",e.getVarying(a)}, VisuBasic_orientedViewNormal);\n        VisuBasic_diffuseTexUvToUse = ${s.cF("VisuBasic_ComputeSphereMapCoord","v2",[s.prmV3("VisuBasic_dir")])}.xy;\n        `;var a}];const u=e.TextureBlendOperations;class c extends t{constructor(t){t=t||{};var s={};Object.assign(s,t),s.textureMapping=t.textureMapping||"User",s.sheen=0,s.flakesCoverage=0,s.specularContrib=1,s.clearCoat=0,s.thinWalled=!0,super(s),this.reflectivity=void 0!==s.reflectivity?s.reflectivity:1,this.reflectivityEnvMap=void 0!==s.reflectivityEnvMap?s.reflectivityEnvMap:null,this.combine=void 0!==s.combine?s.combine:e.MultiplyOperation,this.textureBlending=void 0!==s.textureBlending?s.textureBlending:u.KEEP_DEFAULT;var i=a[s.textureMapping],h=n[i];if(this._internalPDSFXData=null,null!==h){var c={VisuBasic_ProjectionPlaneS:{type:"v4",value:new e.Vector4(1,0,0,0)},VisuBasic_ProjectionPlaneT:{type:"v4",value:new e.Vector4(0,1,0,0)}};if(void 0!==s.projectionPlaneS){var d=s.projectionPlaneS;c.VisuBasic_ProjectionPlaneS.value.x=d[0],c.VisuBasic_ProjectionPlaneS.value.y=d[1],c.VisuBasic_ProjectionPlaneS.value.z=d[2],c.VisuBasic_ProjectionPlaneS.value.w=d[3]}if(void 0!==s.projectionPlaneT){d=s.projectionPlaneT;c.VisuBasic_ProjectionPlaneT.value.x=d[0],c.VisuBasic_ProjectionPlaneT.value.y=d[1],c.VisuBasic_ProjectionPlaneT.value.z=d[2],c.VisuBasic_ProjectionPlaneT.value.w=d[3]}this._internalPDSFXData={uniforms:c,varyings:r,VS_global:h,FS_global:l,ComputeVaryingValuesVSBody:o,ComputeCommonValuesFSBody:p[i]},this.activatePDSFX(),this.setPDSFXUniforms(null),this.setPDSFXVaryings(null),this.setPDSFXGlobalShaderCode(null,null),this.setPDSFXOverridableFunctions(null,null)}}clone(){var e=new c;return super.clone(e),e.reflectivity=this.reflectivity,e.reflectivityEnvMap=this.reflectivityEnvMap,e.combine=this.combine,e.textureBlending=this.textureBlending,e._internalPDSFXData=this._internalPDSFXData,e}setPDSFXUniforms(e){this._internalPDSFXData&&(e||(e={}),Object.assign(e,this._internalPDSFXData.uniforms)),super.setPDSFXUniforms(e)}setPDSFXVaryings(e){this._internalPDSFXData&&(e||(e={}),Object.assign(e,this._internalPDSFXData.varyings)),super.setPDSFXVaryings(e)}setPDSFXGlobalShaderCode(e,t){function s(e,t){let s=null;if(e){const i=e;s="string"==typeof e?function(e){return`\n                                ${i}\n                                ${t(e)}\n                            `}:function(e){return`\n                                ${i(e)}\n                                ${t(e)}\n                            `}}else s=t;return s}this._internalPDSFXData&&(e=s(e,this._internalPDSFXData.VS_global),t=s(t,this._internalPDSFXData.FS_global)),super.setPDSFXGlobalShaderCode(e,t)}setPDSFXOverridableFunctions(e,t){if(this._internalPDSFXData){function s(e,t){let s=null;if(e){const i=e;if("string"==typeof i){const e=i.lastIndexOf("}"),a=i.indexOf("{");if(-1===e||-1===a)throw"Invalid operation in CATGraphicalMaterial: PDSFX input incorrect";const r=i.substring(a+1,e);s=function(e,s){return`\n                                    ${r}\n                                    ${t(e)}\n                                `}}else s=function(e,s){return`\n                                    ${i(e,s)}\n                                    ${t(e)}\n                                `}}else s=t;return s}e||(e={}),t||(t={}),e.ComputeVaryingValues=s(e.ComputeVaryingValues,this._internalPDSFXData.ComputeVaryingValuesVSBody),t.ComputeCommonValues=s(t.ComputeCommonValues,this._internalPDSFXData.ComputeCommonValuesFSBody)}super.setPDSFXOverridableFunctions(e,t)}getSubType(){return"CATGraphicalMaterial"}getType(){return"CATGraphicalMaterial"}setPhysicalProperties(){}setCore(){}setAnisotropy(){}setDisplacement(){}setIridescence(){}setThickness(){}setVolume(){}setDSPBRFlakes(){}setSpecGlossFlakes(){}setClearCoat(){}setSheen(){}_canUseLights(){return(!this.map||this.textureBlending!==u.REPLACE)&&super._canUseLights()}_setMaterialShaderOptions(e,t,s,i,a,r){super._setMaterialShaderOptions(e,t,s,i,a,r),this.isPDSFX()&&null!==this._internalPDSFXData&&(e.visuBasicForceDiffuseUV=!0)}_transparencyOnGPU(e){return super._transparencyOnGPU(e)||this.map&&(this.textureBlending===u.BLEND||this.textureBlending===u.MODULATE||this.textureBlending===u.REPLACE&&1021===this.map.format)}_getTextures(e){var t=super._getTextures(e);return e||(t=t.concat([this.reflectivityEnvMap])),t}}return c})),define("DS/Materials/MeshPhongMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],(function(e,t,s){"use strict";const i=e.TextureBlendOperations;var a=new e.Color;class r extends t{constructor(t){super(),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.specular=new e.Color(1118481),this.shininess=30,this.shininessInSpecMap=!1,this.metal=!1,this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this._isGASFallback=!1,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new e.Vector2(1,1),this._firstDirOnly=!1,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.refractionRatioMap=null,this.shading=e.SmoothShading,this.wireframe=!1,this.morphTargets=!1,this.morphNormals=!1,this.textureBlending=i.KEEP_DEFAULT,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this.setValues(t)}_transparencyOnGPU(e){return super._transparencyOnGPU(e)||this.map&&(this.textureBlending===i.KEEP_DEFAULT||this.textureBlending===i.BLEND||this.textureBlending===i.MODULATE)}_getTextures(e){var t=super._getTextures(e);return t=t.concat([this.map,this.specularMap,this.bumpMap,this.normalMap,this.refractionRatioMap])}isPropertyTextured(e){return"refractionRatio"===e?!!this.refractionRatioMap:super.isPropertyTextured(e)}activatePDSFX(e=null){if(!this._isGASFallback)return super.activatePDSFX(e)}setPhongProperties(e){this._revision++,(e=e||{}).color&&(this.color=e.color),void 0!==e.opacity&&(this.opacity=e.opacity),this._isGASFallback||(void 0!==e.map&&((e.map&&!this.map||!e.map&&this.map)&&(this.needsUpdate=!0),this.map=e.map),e.ambient&&(this.ambient=e.ambient),e.emissive&&(this.emissive=e.emissive),e.specular&&(this.specular=e.specular),void 0!==e.specularMap&&((e.specularMap&&!this.specularMap||!e.specularMap&&this.specularMap)&&(this.needsUpdate=!0),this.specularMap=e.specularMap),e.shininess>=0&&(this.shininess=e.shininess),void 0!==e.shininessInSpecMap&&(e.shininessInSpecMap!==this.shininessInSpecMap&&(this.needsUpdate=!0),this.shininessInSpecMap=e.shininessInSpecMap),void 0!==e.wrapAround&&(e.wrapAround!==this.wrapAround&&(this.needsUpdate=!0),this.wrapAround=e.wrapAround),e.wrapRGB&&(this.wrapRGB=e.wrapRGB),void 0!==e.bumpMap&&((e.bumpMap&&!this.bumpMap||!e.bumpMap&&this.bumpMap)&&(this.needsUpdate=!0),this.bumpMap=e.bumpMap),e.bumpScale>=0&&(this.bumpScale=e.bumpScale),void 0!==e.normalMap&&((e.normalMap&&!this.normalMap||!e.normalMap&&this.normalMap)&&(this.needsUpdate=!0),this.normalMap=e.normalMap),e.normalScale&&(this.normalScale=e.normalScale),void 0!==e.envMap&&((e.envMap&&!this.envMap||!e.envMap&&this.envMap)&&(this.needsUpdate=!0),this.envMap=e.envMap),void 0!==e.combine&&(this.combine=e.combine),e.reflectivity>=0&&(this.reflectivity=e.reflectivity),e.refractionRatio>=0&&(this.refractionRatio=e.refractionRatio),void 0!==e.refractionRatioMap&&((e.refractionRatioMap&&!this.envMap||!e.refractionRatioMap&&this.refractionRatioMap)&&(this.needsUpdate=!0),this.refractionRatioMap=e.refractionRatioMap),void 0!==e.textureBlending&&(this.textureBlending=e.textureBlending))}_dump(){var e=super._dump();return e.color=this.color.toArray(),this.map&&(e.color="textured"),e.specular=this.specular.toArray(),this.specularMap&&(e.specular="textured"),e.shininess=this.shininess,e}areTexturesLoaded(){return!!super.areTexturesLoaded()&&!(this.envMap&&!this.envMap._canBeUsed())}clone(){var e=new r;return super.clone(e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.shininessInSpecMap=this.shininessInSpecMap,e.metal=this.metal,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalMap=this.normalMap,e.normalScale.copy(this.normalScale),e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.refractionRatioMap=this.refractionRatioMap,e.shading=this.shading,e._firstDirOnly=this._firstDirOnly,e.wireframe=this.wireframe,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.textureBlending=this.textureBlending,e.numSupportedMorphTargets=this.numSupportedMorphTargets,e.numSupportedMorphNormals=this.numSupportedMorphNormals,e._isGASFallback=this._isGASFallback,e}getType(){return this._isFromGAS?"GASPhong":"Phong"}_getLightsKey(e){return e.phong}_getLightsUBOCache(e){return e.lightPhongBindingGroupCache}_defaultPDSFXOverridableFunctions(){var t=super._defaultPDSFXOverridableFunctions();return Object.assign(t.fragment,{ComputeEmissive:e._ShaderChunk.PDSFXComputeEmissive_FS,ComputeSpecularReflectance:e._ShaderChunk.PDSFXComputeSpecularReflectance_FS}),t}_setMaterialShaderOptions(e,t,s,i,a,r){super._setMaterialShaderOptions(e,t,s,i,a,r),e.phongFirstDir=this._firstDirOnly,e.phong=!0,t&&Object.assign(e,{refractionRatioMap:this._isTextureAvailable("refractionRatioMap")})}_computeAmbianceKeyAndProcessMaterial(e,t,s,i,a){return super._computeAmbianceKeyAndProcessMaterial(e,t,s,i,a)}loadGlobalUniforms(e,t,s){if(s.invScreenSize){let i=e.viewportData;t.uniform2f(s.invScreenSize,i.viewportInvWidth/i.viewportScale,i.viewportInvHeight/i.viewportScale)}s.aoTexture&&(t.uniform2f(s.aoParams,e.ssaoParams.contrast,e.ssaoParams.power),e.loadTexture(t,s.aoTexture,e._getAOBufferResult()))}loadUniformsLights(e,t,s){e.loadUniformsLightsCommons(t,s,!0);const i=e.lights;s.directionalPhongLightColor&&i.directionalPhong.colors.length>0&&t.uniform4fv(s.directionalPhongLightColor,i.directionalPhong.colors),s.directionalPhongLightDirection&&i.directionalPhong.positions.length>0&&t.uniform4fv(s.directionalPhongLightDirection,i.directionalPhong.positions)}loadUniforms(e,t,s,i,r,n){var o;s.ambient&&(o=this.ambient,this._isGASFallback&&(o=this.color,i&&i.getColor()&&(o=a.set(i.getColor()))),e.gammaInput&&(o=a.copyToLinear(o,e.simpleGamma)),t.uniform3f(s.ambient,o.r,o.g,o.b)),s.emissive&&(o=e.gammaInput?a.copyToLinear(this.emissive,e.simpleGamma):this.emissive,t.uniform3f(s.emissive,o.r,o.g,o.b)),s.specular&&(o=e.gammaInput?a.copyToLinear(this.specular,e.simpleGamma):this.specular,t.uniform3f(s.specular,o.r,o.g,o.b)),s.shininess&&t.uniform1f(s.shininess,Math.max(this.shininess,1e-6)),s.shininessInSpecMap&&t.uniform1i(s.shininessInSpecMap,this.shininessInSpecMap),s.wrapRGB&&this.wrapAround&&t.uniform3f(s.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z),e.loadUniformsCommon(t,this,s,i,r,n),e.loadUniformsEnvMap(t,this,s),this.bumpMap&&(s.bumpScale&&t.uniform1f(s.bumpScale,this.bumpScale?this.bumpScale:1),s.bumpMap&&e.loadTexture(t,s.bumpMap,this.bumpMap)),e.loadUniformsNormalMap(t,this,s)}fillGlobalUBO(e,t){const s=e.layout;if(s.invScreenSize){let i=t.viewportData;e.setFlatV2(s.invScreenSize,i.viewportInvWidth/i.viewportScale,i.viewportInvHeight/i.viewportScale)}s.aoTexture&&(e.setTexture(s.aoTexture,t._getAOBufferResult()),e.setFlatV2(s.aoParams,t.ssaoParams.contrast,t.ssaoParams.power))}fillLightsUBO(e,t){t.fillLightsUBOCommons(e,!0);const s=t.lights,i=e.layout;i.directionalPhongLightColor&&e.setFlatV4Array(i.directionalPhongLightColor,s.directionalPhong.colors),i.directionalPhongLightDirection&&e.setFlatV4Array(i.directionalPhongLightDirection,s.directionalPhong.positions)}fillUBO(e,t){const s=e.layout;s.emissive&&e.setColor(s.emissive,this.emissive,t.gammaInput,t.simpleGamma),s.specular&&e.setColor(s.specular,this.specular,t.gammaInput,t.simpleGamma),s.shininess&&e.setF(s.shininess,Math.max(this.shininess,1e-6)),s.shininessInSpecMap&&e.setI(s.shininessInSpecMap,this.shininessInSpecMap),s.wrapRGB&&this.wrapAround&&e.setV3(s.wrapRGB,this.wrapRGB),t.fillMaterialCommonsUBO(e,this),t.fillMaterialEnvMapUBO(e,this),s.bumpScale&&e.setF(s.bumpScale,this.bumpScale?this.bumpScale:1),s.bumpMap&&e.setTexture(s.bumpMap,this.bumpMap),t.fillNormalMapUBO(e,this)}fillUBOHigh(e,t,s,i,r){const n=e.layout;if(n.ambient){var o=this.ambient;this._isGASFallback&&(o=this.color,r&&r.getColor()&&(o=a.set(r.getColor()))),e.setColor(n.ambient,o,t.gammaInput,t.simpleGamma)}t.fillMaterialHighFrequencyCommonsUBO(e,this,s,i,r)}get wireframe(){return this._wireframe}set wireframe(e){e!==this._wireframe&&this._invalidateDisplayRangeLists(),this._wireframe=e}}return r.prototype._shaderID="phong",r.prototype._autoForceSide=!0,r.prototype._usePhongLighting=!0,r})),define("DS/Materials/PlaneMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshPhongMaterial","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],(function(e,t,s){"use strict";const i="";let a=function(e){const t=e.variableHandler,s=e.userDefines,a=e=>t.floatC(e),r=e=>t.float(e,0,"private"),n=e=>t.vec4(e,0,"private"),o=!!s.PDSFX_PLANE_MAP;return!!s.PDSFX_PLANE_V2?`\n            ${r("stepFactor")};\n            ${n("borderColor")};\n            ${r("fresnelFactor")};\n            ${n("gridCol")};\n            ${r("planeAlpha")};\n\n            ${a("alphaSlope")}  = 0.66666666667;\n            ${a("alphaSlope2")}  = 0.44444444444;\n            ${a("edgeSize")}  = 0.01;\n            ${a("stepSize")}  = 0.001;\n            ${a("small2GridWidth")}  = 0.0005;\n            ${a("smallGridWidth")}  = 0.0005;\n            ${a("bigGridWidth")}  = 0.0005;\n\n            ${o?`\n                ${n("planeMapColor")};\n                `:i}\n        `:`\n                ${r("fresnelFactor")};\n                ${l="discardPlane",t.bool(l,0,"private")};       \n            `;var l},r=function(e,t){const s=e.variableHandler,a=e.bridgeFunctions,r=(e.pdsfxDefines,e.userDefines),n=t=>e.getTextureUniform(t),o=t=>e.getUniform(t),l=e=>s.float(e),h=e=>s.vec2(e),p=e=>s.vec3(e),u=e=>s.vec4(e),c=!!r.PDSFX_PLANE_MAP,d=!!r.PDSFX_PLANE_V2;let f=`           \n            ${p("I")} = ${p()}(0.0,0.0,1.0);\n            if (!(${e.vGetProjectionMatrix()}[3][3] > 0.0)) {\n                I = normalize(-${e.vGetViewPosition()});\n            }\n            fresnelFactor = dot(I, ${e.vGetViewNormal()});\n        `;return d?` \n            ${f}\n\n            ${h("planeUV")} = ${e.vGetTexCoord0()}.xy * 2.0 - 1.0;\n            stepFactor = length(planeUV);\n            ${l("borderMask")}  = ${o("planeBorder")} * smoothstep(1.0 - 2.0 * edgeSize, 1.0 - 2.0 * edgeSize + stepSize, stepFactor) * (1.0 - smoothstep(1.0 - edgeSize, 1.0 - edgeSize + stepSize, stepFactor));\n            borderColor = ${u()}(${o("border")}, borderMask);\n\n            ${l("gridCf")} = ${o("gridCoeff")};\n            ${l("a2")}  = max(1.0 - alphaSlope2 * (1.0 + gridCf) * (1.0 + gridCf), 0.0);\n            ${l("a1")}  = 1.0 - alphaSlope2 * gridCf * gridCf;\n            ${l("a0")}  = 1.0 - alphaSlope2 * (1.0 - gridCf) * (1.0 - gridCf);\n            ${l("a00")}  = max(1.0 - alphaSlope2 * (2.0 - gridCf) * (2.0 - gridCf), 0.0);\n            ${h("div")}  = 0.5 * ${o("planeSize")} * planeUV + ${o("gridOffset")};\n            ${h("big2Div")}  = (1.0 / (${o("nbSteps")} * ${o("nbSteps")})) * div / ${o("gridUnit")};\n            ${h("bigDiv")}  = (1.0 / ${o("nbSteps")}) * div / ${o("gridUnit")};\n            ${h("smallDiv")}  = div / ${o("gridUnit")};\n            ${h("small2Div")}  = ${o("nbSteps")} * div / ${o("gridUnit")};\n            ${l("gridAlpha")}  = ${a.sample2DTexture(n("gridTexture"),"small2Div")}.r;\n            gridAlpha *= a2;\n            gridAlpha += a1 * ${a.sample2DTexture(n("gridTexture2"),"smallDiv")}.r;\n            gridAlpha += a0 * ${a.sample2DTexture(n("gridTexture3"),"bigDiv")}.r;\n            gridAlpha += a00 * ${a.sample2DTexture(n("gridTexture4"),"big2Div")}.r;\n            gridAlpha = min(1.0, gridAlpha);\n\n            planeAlpha = 1.0001 - smoothstep(${o("planeFalloff")}, 1.0, stepFactor);\n            gridAlpha *= 1.0001 - smoothstep(${o("gridFalloff")}, 1.0, stepFactor);\n\n            planeAlpha *= ${o("planeOpacity")} * step(0.0, fresnelFactor) * ${o("displayPlane")};\n            gridAlpha *= step(-${o("gridFromBelow")}, fresnelFactor) * ${o("displayGrid")};\n\n            gridCol = ${u()}(${o("gridColor")} * ${o("gridColor")}, gridAlpha);\n            ${c?`\n                ${u("planeMapColor")}  = ${a.sample2DTexture(n("planeMap"),`${e.vGetTexCoord0()}.xy * ${o("uvScale")}`)};\n                `:i}\n        `:`\n                ${f}\n\n                discardPlane = fresnelFactor < 0.0;\n                if (${o("attenuation")} == 0) {\n                    fresnelFactor = 1.0;\n                }\n            `},n=function(e,t){const a=e.variableHandler,r=(e.functionHandler,e.pdsfxDefines),n=e.userDefines,o=t=>e.getUniform(t),l=e=>a.float(e),h=e=>a.vec3(e),p=e=>a.vec4(e),u=!!n.PDSFX_PLANE_MAP,c=!!n.PDSFX_PLANE_V2,d=a.dereference(t[0]);let f=`         \n            ${r.gammaOutput?`\n                ${d}.r *= ${d}.r;\n                ${d}.g *= ${d}.g;\n                ${d}.b *= ${d}.b;\n                `:i}\n        `;var m;return f=c?`\n                ${f}\n                ${h("cCenter")}  = ${d}.xyz * (1.0 - ${o("onlyDiffuse")}) + ${o("onlyDiffuse")} * ${e.vGetAlbedo()};\n                ${u?`\n                    ${r.gammaInput?`\n                        ${h("convertedColor")} = ${((e,t,i)=>s.FunctionHandler.callFunction(e,t,i))("convertToLinear","v3",[prmV3("planeMapColor.xyz")])};\n                        planeMapColor.x = convertedColor.x;\n                        planeMapColor.y = convertedColor.y;\n                        planeMapColor.z = convertedColor.z;\n                        `:i}\n                    cCenter = mix(cCenter, planeMapColor.xyz, planeMapColor.a);\n                    `:i}\n                ${p("planeCol")}  = ${p()}(mix(mix(cCenter, ${o("border")}, ${o("planeBorder")}), cCenter, planeAlpha), mix(planeAlpha, 1.0, ${o("planeBorder")}));\n                ${p("gridOverPlaneColor")}  = ${p()}((gridCol.xyz * gridCol.a + planeCol.xyz * planeCol.a * (1.0 - gridCol.a)) / (0.0001 + gridCol.a + planeCol.a * (1.0 - gridCol.a)), gridCol.a + planeCol.a * (1.0 - gridCol.a));\n                ${d} = mix(gridOverPlaneColor, borderColor, step(1.0 - 2.0 * edgeSize, stepFactor));\n            `:`\n                ${f}\n                ${m="dUV",a.vec2(m)}  = 2.0 * (${e.vGetTexCoord0()}.xy * 2.0 - 1.0);\n                ${l("dist")}  = dot(dUV, dUV);\n                ${l("dist2")}  = clamp(dist * dist, 0.0, 1.0);\n                dist = clamp(dist, 0.0, 1.0);\n                ${d} = ${p()}(mix(${d}.rgb, mix(${d}.rgb, ${o("border")}.rgb, ${o("borderAlpha")}), dist), fresnelFactor*(1.0 - dist2));\n            `,`\n            ${f}\n            ${r.gammaOutput?`\n                ${d}.r = sqrt(${d}.r);\n                ${d}.g = sqrt(${d}.g);\n                ${d}.b = sqrt(${d}.b);\n                `:i}\n        `},o=function(e,t){return"\n            return discardPlane;\n        "};return class extends t{constructor(){super({ambient:328965,specular:1118481}),this.useBlending=!0,this.depthTest=!1,this.depthWrite=!1,this.side=e.DoubleSide,this.force=!0,this.enableClipPlanes=!1,this.activatePDSFX("PDSFXPlaneMaterial");let t={border:{type:"c",value:new e.Color(516)},borderAlpha:{type:"f",value:1},attenuation:{type:"i",value:0,stage:e.FragmentStage},displayGrid:{type:"f",value:1},displayPlane:{type:"f",value:1},gridFromBelow:{type:"f",value:1},planeMap:{type:"t2",value:null},gridTexture:{type:"t2",value:null},gridTexture2:{type:"t2",value:null},gridTexture3:{type:"t2",value:null},gridTexture4:{type:"t2",value:null},nbSteps:{type:"f",value:5},gridUnit:{type:"f",value:1},gridOffset:{type:"v2",value:new e.Vector2},gridCoeff:{type:"f",value:0},gridColor:{type:"c",value:new e.Color(16777215)},planeSize:{type:"f",value:100},planeBorder:{type:"f",value:1},planeFalloff:{type:"f",value:0},onlyDiffuse:{type:"f",value:0},gridFalloff:{type:"f",value:0},uvScale:{type:"f",value:1},planeOpacity:{type:"f",value:1}};this._v2Plane=!0,this.setPDSFXUniforms(t),this.setPlaneV2(!1)}getType(){return"Plane"}setPlaneV2(e){if(this._v2Plane===e)return;this._v2Plane=e,this.setPDSFXGlobalShaderCode(null,a);let t={ComputeCommonValues:r,ProcessFinalColor:n};this.defines=this.defines||{},this.defines.PDSFX_PLANE_MAP=this.getPDSFXUniform("planeMap").value?1:0,this.defines.PDSFX_PLANE_V2=!!e,t.ComputeDiscard=e?null:o,this.setPDSFXOverridableFunctions(null,t),this.needsUpdate=!0}setPlaneTexture(e){(this.getPDSFXUniform("planeMap").value?!e:e)&&(this.defines=this.defines||{},this.updatePDSFXUniform("planeMap",e),e&&this._v2Plane?this.defines.PDSFX_PLANE_MAP=1:this.defines.PDSFX_PLANE_MAP=0,this.needsUpdate=!0)}getPredefinedMaterial(e,t,s){return this}_setMaterialShaderOptions(e,t,s,i,a,r){e.useOIT=!1,super._setMaterialShaderOptions(e,t,s,i,a,r)}updateDeferredMaterials(t){super.updateDeferredMaterials(t),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=null,this._deferredMaterials[e.MaterialToUse.depthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalMaterial]=null,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepth]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null}set wireframe(e){this._wireframe=!1}}}));