define("DS/PLMNewFolderActive/PLMNewFolderActiveController",["DS/ClassificationsFacet/PLMNewCommomCmpUXController","DS/FolderActive/service/FolderActiveWebServices","i18n!DS/FolderActive/assets/nls/FolderActive","DS/WebappsUtils/WebappsUtils","DS/ClassificationsFacet/service/PLMNewCommonWebService","DS/FolderEditor/service/FolderEditorWebService","UWA/Utils","DS/Controls/TooltipModel","i18n!DS/ClassificationsFacet/assets/nls/PLMNewCommCmpSel","DS/FolderActive/utils/PreferencesUtils","DS/IPClassifyUtil/IPClassifyAlert","DS/IPClassifyUtil/PlatformAPIWrapper","DS/IPClassifyUXUtil/service/IPClassifyUXUtilWebService","DS/IPClassifyUXUtil/IPClassifyConfirmation"],(function(e,t,o,n,s,i,r,a,l,c,d,p,u,m){"use strict";n.getWebappsAssetUrl("FolderEditor","icons/I_Bookmark_v2.png");var h={iconName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-bkmrk-folder-flash "},f=(n.getWebappsAssetUrl("FolderEditor","icons/folder_perso.png"),{iconName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-bkmrk-folder "});let C=!1;return e.extend({name:"FolderActive",_rootNodeFavorite:null,_rootNodeFolders:null,_rootNodeTrash:null,_requestInfo:{},_searchKeys:{},_nodesData:{},_isResetInProgress:!1,_pathInfo:{},_subBookmarkExpand:{},_personalSectionNode:null,_favoriteSection:"FolderSection_favorite",_allSection:"FolderSection_AllFolders",_findInTreeNLS:o,_getActiveBookmarkPromise:null,_currentActiveBookmarkId:null,_classNameMap:new Map,_parentInitMethod:null,_parentOptions:null,autocompleteErrorContainer:null,errorAlertIcon:null,init:function(e){let n;var r=this;this.PLMNewCommonWebService=Object.assign({},s),this.PLMNewCommonWebService.getSetting=i.getWidgetSettings,this.PLMNewCommonWebService._executeRequest=u._executeRequest,this.PLMNewCommonWebService._executeQuery=u._executeQuery,this.PLMNewCommonWebService.getRelatedBookmarks=i.getRelatedBookmarks,this.PLMNewCommonWebService.removecontent=i.removecontent,this.PLMNewCommonWebService.folderTree=i.folderTree,r.PLMNewCommonWebService.getSetting(!0).then((function(e){n=e})),e.multiSelectionComponent&&!e.multiSelectionComponent.NLS&&(e.multiSelectionComponent.NLS=o.multiSelectionComponent),this.PLMNewCommonWebService.addcontent=t.addcontent,this.PLMNewCommonWebService.getSearchQuery=function(){return n&&n.personal?'flattenedtaxonomies:("types/Workspace" OR  "types/Workspace Vault" OR  "types/Personal Workspace")':'flattenedtaxonomies:("types/Workspace" OR  "types/Workspace Vault")'},this.PLMNewCommonWebService.getType_filter_bo=function(){return["Workspace","Workspace Vault"]},this.PLMNewCommonWebService.isPersonalBookAvailable=function(){return!(!n||!n.personal)},this.PLMNewCommonWebService.getSpecificSearchQuery=function(){return"NOT(( [ds6w:status]:Workspace.Complete)  OR  ([ds6w:status]:Workspace.Archive))"},this._getActiveBookmarkPromise=r.getCurrentPreference(),this._parent(e),this._parentOptions=e,this._parentInitMethod=this._parent,r._nodesData={},this.plmNewContextProvider=e.securityContext,this.PLMNewCommonWebService.setSecurityContext(this.plmNewContextProvider),this._noAccessDataMap=new Map,this._accessData=[]},_createErrorContainerAlertIcon(e,t){this.autocompleteErrorContainer=UWA.createElement("span",{class:"plmnew-autocomplete-error"}).inject(e),this.autocompleteErrorContainer.setText(""),this.errorAlertIcon=UWA.createElement("div",{class:"fonticon fonticon-attention fonticon-warning plmnew-autocomplete-alert"}).inject(t)},_updateErrorContainer(e,t,o,n){if(!t||this._noAccessDataMap.has(e[0])||this._accessData.includes(e[0])||n){if(!t)if(1==e.length){let t=this._accessData.indexOf(e[0]);t<0?(this._noAccessDataMap.delete(e[0]),this._updateErrorContainerMessage()):this._accessData.splice(t,1)}else this._noAccessDataMap.clear(),this._accessData=[],this._updateErrorContainerMessage()}else this._checkConnectAccess(e,o),this._updateErrorContainerMessage()},_updateErrorContainerMessage(){this._noAccessDataMap.size?(this.autocompleteErrorContainer.setText(l.replace(l.errorForConnectAccessforBks,{number:this._noAccessDataMap.size})+this._noAccessDataMap.values().toArray().join(", ")),this.errorAlertIcon.style.display="block"):(this.autocompleteErrorContainer.setText(" "),this.errorAlertIcon.style.display="none")},_checkConnectAccess(e,o){return new Promise(((n,s)=>{this.options.isInformationPanel||this.autocompleteErrorContainer.setText(l.checkingConnectAccessforBks),t.checkConnectAccess({IDs:e,securityContext:this.plmNewContextProvider}).then((({noAccessData:e,accessData:t})=>{Object.keys(e).length&&Object.keys(e).forEach((e=>{this._noAccessDataMap.set(e,o.get(e))})),Object.keys(t).length&&(this._accessData=Object.keys(t)),n(t),this.options.isInformationPanel||this._updateErrorContainerMessage()})).catch((e=>{console.log(e),d.displayNotification({title:l.checkAccessFailure,subtitle:"string"==typeof e?e:null,className:"error"})}))}))},_getWebServiceRef:function(){return t},onSetActive:function(e){e&&"function"==typeof e&&(this.onSetActive=e)},_getPlmType:function(e){return-1===["Workspace","Workspace Vault","Bookmark","Bookmark Root"].indexOf(e)&&e?"Content":"Folder"},_getIcon:function(e,t){var o="subFolders"!==t&&!1,n=f;return e.icon?e.icon:n,e&&e.type&&"Personal Workspace"===e.type?e.icon?e.icon:n:"favorites"===t?e.inherit?h:n:e&&e.type&&["Workspace","Workspace Vault"].indexOf(e.type)<0&&e.icon?e.icon:o||e.iconType&&"SHARED"===e.iconType.toUpperCase()?h:n},couldBeValid:function(e){var t=e&&e.getID&&e.getID();return t&&t!==this._favoriteSection&&t!==this._allSection},getInitIcon:function(e){return e.iconType=e.folderClassification,this._getIcon(e)},saveNodes:function(e){this._nodesData[e.id]=e},isResetInProgress:function(e){return this._isResetInProgress},isConfirmModel:function(e){return this._nodesData.accordianData=e,!0},removeContents:function(e){var t=this,o=[];let n=e.classId.length;e.accordianData=t._nodesData.accordianData;var s=t._nodesData;delete s.accordianData;for(let e in s)o.push(s[e]);var i={deleteButtonLabel:l.titleRemove,titleLabel:l.titleRemove,warningMessage:l.replace(l.msg_removeSingleBks,{className:t._nodesData[e.classId[0]].label}),buttonColor:"blue"};n>1&&(i.warningMessage=l.replace(l.msg_removeMultipleBks,{number:n}),i.titleLabel=l.titleRemove+" - "+n+" "+l.bookmarks),"function"==typeof t.autoComplete.hidePopup&&t.autoComplete.hidePopup(),m.confirmDialog(i,(function(e){e.classId.forEach((o=>{var n=t._classNameMap.get(o);t.PLMNewCommonWebService.removecontent({pid:o,IDs:e.IDs,isLinkedFolder:!1,withChangeCtx:!0}).then((s=>{"failure"==s.status?(d.displayNotification({subtitle:s.error,className:"error"}),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})):(delete t._nodesData[o],d.displayNotification({message:l.replace(l.removeBookmarkedSuccess,{bkname:n}),className:"success"}),e.classId.length>1&&t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0}))})).catch((e=>{console.log("================",e),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})}))}))}),(function(e){t._isResetInProgress=!0,t.autoComplete._model.prepareUpdate();var o=t.autoComplete._model.getChildren().length;for(let e=0;e<o;e++)t.autoComplete._model.prepareUpdate(),t.autoComplete._model.nodeModel_reset=!0,t.autoComplete._model.removeRoot(0),t.autoComplete._model.pushUpdate(),t.autoComplete._model.nodeModel_reset=!1;t.autoComplete._model.nodeModel_reset=!0,t.autoComplete.selectedItems=[],t.autoComplete._model.nodeModel_reset=!1,t.previousPresentIds=[],e.forEach((e=>{t.autoComplete._model.prepareUpdate();let o=null;e.options.tooltip&&e.options.tooltip.shortHelp&&(o=e.options.tooltip.shortHelp),t.insertInAutocomplete(t._getAutocomplete(),e,o),t.autoComplete._model.pushUpdate();var n=t.autoComplete._model.getChildren().length;n>0&&t.autoComplete._model.getNthRoot(n-1).select()})),t._isResetInProgress=!1}),e,o)},addContents:function(e){var t=this;e.classId.forEach((o=>{var n=this._classNameMap.get(o);i.addcontent({pid:o,IDs:e.IDs,isLinkedFolder:!1,withChangeCtx:!0}).then((e=>{"failure"==e.status?("TypeNotSupported"==e.errorCode?d.displayNotification({subtitle:l.errorForUnSupportedType,className:"error"}):d.displayNotification({title:l.replace(l.errorForAddContentsToBks,{number:1,bkname:n}),subtitle:e.error,className:"error"}),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})):d.displayNotification({message:l.replace(l.bookmarkedSuccess,{bkname:n}),className:"success"})})).catch((e=>{let o=l.ErrorMsg_Generic_Add_Failure;e&&e.serverErr&&e.serverErr.error&&e.serverErr.error&&(o=e.serverErr.error),d.displayNotification({message:o,className:"error"}),console.log("error while adding content"),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})}))}))},fetchInitNodeProperties(e,t){s.fetch2({ids:e.id,label:"plmNewBk"+Date.now(),onComplete:function(e){if(e){let n={};if(e.results&&e.results.length>0){let s={};e.results[0].attributes.forEach((e=>{s[e.name]=e.value})),s["icon_2ddefaultthb.subtype"]&&"SHARED"===s["icon_2ddefaultthb.subtype"].toUpperCase()&&(n.icons=[{iconName:"bkmrk-folder-flash",fontIconFamily:1}]),n.tooltip=new a({title:s.label,shortHelp:s.label,mouseRelativePosition:!0}),n.label=s.label;var o=t.getChildren().length;let i=t.getNthRoot(o-1);i.select(),i.updateOptions(n),i.isSelected()&&(t.removeRoot(i),t.addRoot(i),i.select())}}},onFailure:function(e){console.error(e)}})},getAdditionalNodesAtInit:async function(e,t,o){let n=this;return new Promise(((s,i)=>{t?this.addExistingChips(o).then((e=>{if(e.folders){let t=[];e.folders.length>0&&(e.folders.forEach(((e,o)=>{t.push(e.id),n._classNameMap.set(e.id,e.label)})),n.PLMNewCommonWebService.getClassPaths({id:t,plmNewContextProvider:n.plmNewContextProvider,onComplete:function(t){const o=n.PLMNewCommonWebService.constructPath(t,"idPathMap");n._classPathMap=o,s(e.folders)},onFailure:function(e){console.log("================",e)}}))}})).catch((e=>{let t=l.ErrorMsg_Generic_Fetch_Failure;e&&e.serverErr&&e.serverErr.error&&e.serverErr.error.includes("Missing security context")&&(t=l.ErrorMsg_SecCtx_Is_Invalid),d.displayNotification({message:t,className:"error"})})):null!=this._getActiveBookmarkPromise&&this._getActiveBookmarkPromise.then((t=>{t&&""!=t.id&&(this._currentActiveBookmarkId=t.id,t.icons=this._getIcon(t),t.label=t.label?t.label:l.loading,t.isActiveNode=!0,t.plmType="Folder",s([t]),this.fetchInitNodeProperties(t,e))}))})).catch((e=>{console.log(e)}))},couldBeSelected:function(e){return!!["Folder","Workspace","Bookmark","Bookmark Root","Workspace Vault","RootFolder"].includes(e)},getFavoriteKey:function(){return"FolderEditorFavoriteFolderList"},_getComponentName:function(){return o.bookmark_defaultTitle},_autoCompleteName:function(){return"Folder"},_getAutocomplete:function(e){return this.autocompleteFolder},getCurrentPreference:function(){return new Promise((function(e,t){var o=c.getCurrentWidgetBookmark(),n=c.getWidgetPreference();o.then((o=>{o&&o.FolderID&&(n={id:o.FolderID,label:o.FolderLabel}),n?e(n):c.getUserPreferences().then((t=>{e(t.startsWith("!")?null:{id:t})})).catch(t)}))}))},_autocompleteComponent:function(e){var t=this;return t.autocompleteFolder=t.createAutocompleteComponent(t._getComponentName(),[],e,t.browseAssociations.bind(t,!0,!0)),t.autocompleteFolder},addExistingChips:function(e){let t={tenant:this.tenant};return t.contentId=e,this.PLMNewCommonWebService.getRelatedBookmarks(t)},onClickSelector:function(){var e=this;widget&&widget.addEvent("onLoad",(function(e){C=!1})),require(["DS/FolderActive/FolderActive"],(function(t){C||(e.folderActiveActionBar=new t({multiSelectionComponent:{withClassify:!0,launchDialog:!0,componentTitle:o.multiSelectionComponent.PLMNewBookmarkWidgetName,OKButtonLabel:o.multiSelectionComponent.button_OK,immersiveFrame:null},popOverDialogProperties:{width:250,height:350,minHeight:250,modalFlag:!0,minWidth:400,icon:"none"},dialogButtons:!0,selectionMode:"DefaultSingle",favoriteButton:!0,handleClassification:!0,OKButtonLabel:o.multiSelectionComponent.button_OK,componentTitle:o.multiSelectionComponent.PLMNewBookmarkWidgetName,isRootSelectable:!0,isClassifyMultiEveDispatch:!0,isonSetActiveEveDispatch:!1,container:widget.body,widgetName:o.multiSelectionComponent.PLMNewBookmarkWidgetName,tenant:e._parentOptions.tenant}),e.folderActiveActionBar.nestedMenuInContext.addEvent("onClassifyMultiple",(async function(t){var o=t.nodeData,n=[];e.autoComplete.selectedItems&&e.autoComplete.selectedItems.length?e.autoComplete.selectedItems.forEach((e=>{n.push(e.id)})):n=[];var s=[];let i=[],r=new Map;if(o.forEach((e=>{r.set(e.id,e.getLabel())})),e.options.isInformationPanel){let t=await e._checkConnectAccess([...r.keys()],r);Object.keys(t).length&&(i=Object.keys(t)),e._noAccessDataMap.size&&(d.displayNotification({title:l.replace(l.errorForConnectAccessforBks,{number:e._noAccessDataMap.size}),message:e._noAccessDataMap.values().toArray().join(", "),className:"error"}),e._noAccessDataMap.clear())}else e._checkConnectAccess([...r.keys()],r);if(o.forEach((function(t){e.options.isInformationPanel||n.includes(t.getID())||s.push(t.getID()),e.options.isInformationPanel&&!n.includes(t.getID())&&i.includes(t.getID())&&s.push(t.getID()),t.updateOptions({label:t.options.label,subLabel:l.loading,icon:[t.options.icons]}),C=!1})),e.options.isInformationPanel&&i.length||!e.options.isInformationPanel)if(s.length)e.PLMNewCommonWebService.getClassPaths({id:s,plmNewContextProvider:e.plmNewContextProvider,onComplete:function(t){const n=e.PLMNewCommonWebService.constructPath(t,"idPathMap");console.log(n),o.forEach((t=>{if(n.has(t.id)){t.updateOptions({tooltip:new a({title:t.options.label,shortHelp:n.get(t.id),mouseRelativePosition:!0}),subLabel:n.get(t.id),value:{subLabel:n.get(t.id)}}),e._classNameMap.set(t.id,t.options.label),e.autoComplete._model.prepareUpdate(),e.insertInAutocomplete(e._getAutocomplete(),t,n.get(t.id)),e.autoComplete._model.pushUpdate();var o=e.autoComplete._model.getChildren().length;e.autoComplete._model.getNthRoot(o-1).select()}}))},onFailure:function(e){console.error(e)}});else{let e="";e=1==o.length?l.replace(l.bkmAlreadyExist,{className:o[0].options.label}):l.bkmsAlreadyExist,d.displayNotification({message:e,className:"info"})}t.handleUI()})),e.folderActiveActionBar.nestedMenuInContext.addEvent("onSelectorCancel",(function(e){C=!1})),C=!0)}))},saveRespectiveAssociations:function(e,t,o){let n=this;return new Promise((function(s,r){const a=[];t.forEach((t=>{a.push(new Promise((function(s,r){i.addcontent({pid:t,IDs:[e],plmNewContextProvider:o}).then((o=>{if(o&&"failure"==o.status)s("fail"+t);else{if(n._currentActiveBookmarkId===t){const o={authored:{connected:[[t,e]]}};p.publish("FolderEditor.refresh",o)}s(t)}})).catch((()=>{s("fail"+t)}))})))})),Promise.allSettled(a).then((function(e){s(e)}))}))},setClassNameForSearchData:function(e){e.results.forEach((e=>{if(e.attributes){const t=e.attributes.find((e=>"physicalid"===e.name)),o=e.attributes.find((e=>"ds6w:label"===e.name));o&&this._classNameMap.set(t.value,o.value)}else{const t=e.id,o=e.label;o&&this._classNameMap.set(t,o)}}))}})}));