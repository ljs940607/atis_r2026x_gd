define("DS/WebApplication/WebApplication",["DS/WebUtils/FunctionDisposer","DS/WebSystem/Scripting","DS/WebSystem/Environment","DS/WebRunloop/Runloop","DS/WebUtils/Profiler","DS/WebApplicationBase/W3AManagerSet","DS/WebSystem/Context","DS/VCXWebExperienceBase/VCXExperienceBase","DS/WebUtils/Statistics","DS/Visualization/ModelLoader","DS/Visualization/Node3D","UWA/Promise"],(function(e,i,t,a,s,n,p,o,r,h,l,c){"use strict";return i.extend({init:function(i){this._parent(),this.context=p.createContext(),this.options=UWA.extend({},i,!0),this.viewer=null,this.options.container?"string"==typeof this.options.container&&(this.options.container=document.getElementById(this.options.container)):this.options.options.frmWindow&&(this.options.container=this.options.options.frmWindow.getUIFrame()),this.disposeFunctions=new e;var a=e=>{this.app=new e(this.options),this.options.__ODT_onAppInitialize&&this.options.__ODT_onAppInitialize(this);var i=e=>(e.createDom(),t.isSet("3DPlay.Statistics")&&(e.stats=new r),e.stats&&e.stats.set({container:e.options.container}),e.getViewer(),this.app.supportWebApplicationBase?e.RequestNewWebApplicationBase():e.requestNewExperienceBaseAsync());void 0!==this.app.onPreCreate?this.app.onPreCreate(this,(e=>{0===e&&i(this)})):i(this)},s=e=>{if("scripterror"==e.requireType){var i=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",i)}else console.error(e)};this.disposeFunctions.add((()=>{a=null,s=null})),void 0===this.options.application&&(this.options.application="DS/3DPlayApplication/3DPlayApplication"),window.extensionDictionaryApp||(window.extensionDictionaryApp={}),window.interfaceDictionaryApp||(window.interfaceDictionaryApp={}),window.componentDictionaryApp||(window.componentDictionaryApp={}),require([this.options.application],a,s)},getViewer(){return this.viewer||(this.viewer=this.frmWindow.getViewer?this.frmWindow.getViewer():null),this.viewer},RequestNewWebApplicationBase:async function(){if(this.webApplicationBase=new o,this.webApplicationBase.initialize&&await this.webApplicationBase.initialize(this.app,!0),this.webApplicationBase.webApplication=this,this.getViewer()&&(this.webApplicationBase.modelLoader=this.getModelLoader()),this.app.onPostCreate){await this.app.onPostCreate(this.webApplicationBase)}this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.initialize&&await this.webApplicationBase._ManagerSet.initialize(!0,!0);const e=this.webApplicationBase.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.frmWindow._experienceBase=this.webApplicationBase,this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.postInitialize&&await this.webApplicationBase._ManagerSet.postInitialize(!0,!0),this.app.onFinished&&await this.app.onFinished(this.webApplicationBase,!0),this.profileFrame=s.start("webApplication::frame"),this.runloop=new a({data:this,func:this.runloopFunc}),this.runloop.start(),this.webApplicationBase},RequestNewExperienceBase:async function(){if(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.webApplicationBase){this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.unInitialize&&await this.webApplicationBase._ManagerSet.unInitialize(!0,!0,!0),this.webApplicationBase.InterClean&&this.webApplicationBase.InterClean(),this.experienceBase=new o,this.experienceBase._parentBase=this.webApplicationBase,this.experienceBase.SetFactoryFromParent(!0),this.webApplicationBase.AddExperienceBaseChild(this.experienceBase),this.webApplicationBase._childrenBase.active=this.experienceBase,this.experienceBase.initialize&&await this.experienceBase.initialize(this.app),this.experienceBase.webApplication=this,this.getViewer()&&(this.experienceBase.modelLoader=this.getModelLoader()),this.app.onPostCreate&&await this.app.onPostCreate(this.experienceBase),this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.initialize&&await this.experienceBase._ManagerSet.initialize(!0,!0);const e=this.experienceBase.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.frmWindow._experienceBase=this.experienceBase,this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.postInitialize&&await this.experienceBase._ManagerSet.postInitialize(!0,!0),this.app.onFinished&&await this.app.onFinished(this.experienceBase,!0),this.profileFrame=s.start("webApplication::frame"),this.runloop=new a({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase}return console.error("A webApplicationBase needs to be created."),null},RequestCloseExperienceBase:async function(){if(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&(this.app.disposeExperienceBase&&await this.app.disposeExperienceBase(),this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize&&await this.experienceBase._ManagerSet.unInitialize(!0,!0),this.experienceBase.Clean(),this.experienceBase.SetFactoryFromParent(!1),this.webApplicationBase._childrenBase.active=null,this.experienceBase=null),this.webApplicationBase.initialize&&await this.webApplicationBase.initialize(this.app,!1),this.webApplicationBase.webApplication=this,this.getViewer()&&(this.webApplicationBase.modelLoader=this.getModelLoader()),this.app.onPostCreate){await this.app.onPostCreate(this.webApplicationBase)}this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.initialize&&await this.webApplicationBase._ManagerSet.initialize(!0,!0);const e=this.webApplicationBase.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.frmWindow._experienceBase=this.webApplicationBase,this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.postInitialize&&await this.webApplicationBase._ManagerSet.postInitialize(!0,!0),this.app.onFinished&&await this.app.onFinished(this.webApplicationBase,!1),this.profileFrame=s.start("webApplication::frame"),this.runloop=new a({data:this,func:this.runloopFunc}),this.runloop.start(),this.webApplicationBase},requestNewExperienceBaseAsync_:async function(){if(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&(this.app.disposeExperienceBase&&await this.app.disposeExperienceBase(),this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize&&await this.experienceBase._ManagerSet.unInitialize(!0),this.experienceBase.Clean(),this.experienceBase.webApplication=null,this.experienceBase=null),this.experienceBase=new o,this.experienceBase.initialize&&await this.experienceBase.initialize(this.app),this.experienceBase.webApplication=this,this.getViewer()&&(this.experienceBase.modelLoader=this.getModelLoader()),this.app.onPostCreate){await this.app.onPostCreate(this.experienceBase)}this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.initialize&&await this.experienceBase._ManagerSet.initialize(!0);const e=this.experienceBase.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.frmWindow._experienceBase=this.experienceBase,this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.postInitialize&&await this.experienceBase._ManagerSet.postInitialize(!0),this.app.onFinished&&await this.app.onFinished(this.experienceBase),this.profileFrame=s.start("webApplication::frame"),this.runloop=new a({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase},requestNewExperienceBaseAsync:function(){var e=UWA.Promise.resolve().then((()=>(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&this.app.disposeExperienceBase&&this.app.disposeExperienceBase()))).then((()=>this.experienceBase&&this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize(!0))).then((()=>(this.experienceBase&&(this.experienceBase.Clean(),this.experienceBase.webApplication=null,this.experienceBase=null),this.experienceBase=new o(null),this.experienceBase.requestPromise=e,this.experienceBase.initialize&&this.experienceBase.initialize(this.app)))).then((()=>(this.experienceBase.webApplication=this,this.getViewer()&&(this.experienceBase.modelLoader=this.getModelLoader()),this.app.onPostCreate(this.experienceBase)))).then((e=>this.experienceBase._ManagerSet.initialize(!0))).then((()=>{var e=this.experienceBase.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.frmWindow._experienceBase=this.experienceBase,this.experienceBase._ManagerSet.postInitialize(!0)})).then((()=>this.app.onFinished&&this.app.onFinished(this.experienceBase))).then((()=>(this.profileFrame=s.start("webApplication::frame"),this.runloop=new a({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase)));return e},getModelLoader:function(){if(this.app&&this.app.getModelLoader)return this.app.getModelLoader();var e=this.frmWindow.getViewer(),i=new l("RootBag");return e.addNode(i),new h({node:i,viewer:e})},getContext:function(){return this.context},createDom:function(e){if(!this.frmWindow){if(e&&e.frmWindow)this.frmWindow=e.frmWindow;else if(this.options.frmWindow)this.frmWindow=this.options.frmWindow;else{var i;if(void 0===e?i=this.options.FrameWindow:(i=e.frameWindowCtor,t=e.options),void 0===t){(t={}).uiOptions=this.options.ui||{displayTree:!1};var t={context:this.getContext()};if(this.app.getOptions&&(t=UWA.extend(t,this.app.getOptions(),!0)),this.app.getWorkBench){var a=this.app.getWorkBench();Array.isArray(a)&&(a=a[0]),t.workbenchModule=a.module,t.workbench=a.name+".xml",void 0!==a.defaultCommand&&(t.defaultCommand=a.defaultCommand)}}t.viewerOptions||(t.viewerOptions={}),t.viewerOptions.defaultAnimationLoop=!1,this.frmWindow=new i(t).inject(this.options.container)}this.frmWindow.getActionBar()&&(this.callbackActionBar=this.frmWindow.getActionBar().onActionBarReady((()=>{this.app.onActionBarReady&&this.app.onActionBarReady()})))}return this.frmWindow},runloopFunc:function(e){this.useCallback=void 0===this.useCallback||this.useCallback,this.profileFrame.start();let i=null;i=this.webApplicationBase?this.webApplicationBase.getManager("VCXContextManager"):this.experienceBase.getManager("VCXContextManager");var t=UWA.extend({viewer:this.getViewer()},e,!0);t.profiler=this.profileFrame.addProfile("managerSet::update"),this.experienceBase&&this.experienceBase._ManagerSet.update(t),this.webApplicationBase&&this.webApplicationBase._ManagerSet.update(t),this.skipFrame?this.skipFrame=!1:i.applyToViewers((e=>{e._modelEvent&&!e.registredCBs&&(e.registredCBs={preToken:e._modelEvent.subscribe({event:"PreRender"},(e=>{e.profiler=this.profile_animate.addProfile("preRender"),this.experienceBase&&this.experienceBase._ManagerSet.preRender(e),this.webApplicationBase&&this.webApplicationBase._ManagerSet.preRender(e),this.profile_render=this.profile_animate.addProfile("render")})),postToken:e._modelEvent.subscribe({event:"PostRender"},(e=>{e.renderingTime=this.profile_render.stop(),e.profiler=this.profile_animate.addProfile("postRender"),this.experienceBase&&this.experienceBase._ManagerSet.postRender(e),this.webApplicationBase&&this.webApplicationBase._ManagerSet.postRender(e)}))},e.defaultAnimationLoop=!1,this.disposeFunctions.add((()=>{}))),this.profile_animate=this.profileFrame.addProfile("viewer["+e.id+"]::animate"),e.animate(),this.profile_animate.stop()})),t.profiler=this.profileFrame.addProfile("managerSet::postUpdate"),this.experienceBase&&this.experienceBase._ManagerSet.postUpdate(t),this.webApplicationBase&&this.webApplicationBase._ManagerSet.postUpdate(t),this.profileFrame.stop(),this.stats&&this.stats.postProcess()},dispose:function(e){let i=null;this.experienceBase?i=this.experienceBase.getManager("VCXContextManager"):this.webApplicationBase&&(i=this.webApplicationBase.getManager("VCXContextManager")),i&&i.applyToViewers((e=>{e.registredCBs&&(e.defaultAnimationLoop=!0,e.disposed||(e._modelEvent.unsubscribe(e.registredCBs.preToken),e._modelEvent.unsubscribe(e.registredCBs.postToken)),delete e.registredCBs,e.animate())}));var t=this.frmWindow.getActionBar();t&&this.callbackActionBar&&t.removeCallback(this.callbackActionBar),this.experienceBase&&(this.experienceBase.modelLoader=null),this.webApplicationBase&&(this.webApplicationBase.modelLoader=null),this.frmWindow._experienceBase=null,this.experienceBase&&(this.experienceBase.frmWindow=null,this.experienceBase.webApplication=null),this.webApplicationBase&&(this.webApplicationBase.frmWindow=null,this.webApplicationBase.webApplication=null);const a=this.options&&this.options.Async||window.useAsyncExperienceBase;let s=this.experienceBase&&this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize(a),n=this.webApplicationBase&&this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.unInitialize(a);s||(s=new c((e=>{e()}))),n||(n=new c((e=>{e()})));let p=this;return this._parent(),s.then((()=>n)).then((()=>{p.experienceBase&&(p.experienceBase.Clean(),p.experienceBase=null),p.webApplicationBase&&(p.webApplicationBase.Clean(),p.webApplicationBase=null),p.disposeFunctions.dispose(),p.disposeFunctions=null,p.runloop.stop(),p.runloop.dispose(),p.runloop=null,p.options=null,p.viewer=null,p.app.dispose(),p.app=null,void 0!==!e.disposeFrameWindow&&!0!==e.disposeFrameWindow||p.frmWindow.dispose(),p.frmWindow=null,p.stats&&(p.stats.dispose(),p.stats=null),p=null}))}})}));