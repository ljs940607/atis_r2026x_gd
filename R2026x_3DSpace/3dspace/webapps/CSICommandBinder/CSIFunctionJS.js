define("DS/CSICommandBinder/CSIFunctionJS",["DS/CSICommandBinder/CSIParameters","DS/CSICommandBinder/CSIHeader"],(function(e,t){"use strict";const s=t.ENodeMessageType,r=t.MessageBuilder,i=/^[a-z][A-Za-z0-9]*$/,n=/^[a-z][A-Za-z0-9]*_v[0-9]*$/,o={userTypeMap_:{},getUserType:function(e,t){if(o.userTypeMap_&&o.userTypeMap_[e]&&o.userTypeMap_[e][t])return o.userTypeMap_[e][t]},addUserType:function(e,t,s){return o.userTypeMap_[e]||(o.userTypeMap_[e]={}),o.userTypeMap_[e][t]=s,!0},clearUserTypes:function(){o.userTypeMap_={}},computeTypePath:function(e,t){return"text!/"+e+"/assets/CSIDeployedTypes/"+t+".json"},loadTypeFilePromise:function(e,t){const s=o.computeTypePath(e,t);return new Promise(((e,t)=>{require([s],(function(t){e(t)}),(function(e){t(new Error("Load Error: "+e.message,{cause:e}))}))}))}},a=function(e,t){this.mwebModule_=e,this.errorContext_=t,this.index_=0,this.typesToLoad_=[],this.typesSignatures_=[],this.typesDependencies_=[],this.typesPropertiesChecker_=[]};a.prototype.pushTypeName=function(e,t){return"Parameters"!==e&&this.typesToLoad_.indexOf(e)<0&&(this.typesToLoad_.push(e),t&&(void 0===this.typesDependencies_[this.index_]&&(this.typesDependencies_[this.index_]=[]),this.typesDependencies_[this.index_].push(e)),!0)},a.prototype.recursiveSearchForTypeNamesToLoad=function(e,t){for(let s in e)e.hasOwnProperty(s)&&("type"===s?this.pushTypeName(e.type,t):"object"==typeof e[s]&&this.recursiveSearchForTypeNamesToLoad(e[s],t))},a.prototype.loadTypeFiles=function(e,t){if(this.index_<this.typesToLoad_.length){const s=this.typesToLoad_[this.index_];o.loadTypeFilePromise(this.mwebModule_,s).then((r=>{let i;try{i=JSON.parse(r)}catch(e){const t="Failed to parse json type file for "+o.computeTypePath(this.mwebModule_,s)+" - error = "+e;this.errorContext_.addMessage(t)}if(i){this.typesSignatures_[this.index_]=i;const e=!0;this.recursiveSearchForTypeNamesToLoad(i,e)}this.index_++,this.loadTypeFiles(e,t)})).catch((s=>{this.errorContext_.addMessage(s.message),this.index_++,this.loadTypeFiles(e,t)}))}else e()},a.prototype.loadTypesJsObjectPromise=function(){return this.index_=0,new Promise(((e,t)=>{this.loadTypeFiles(e,t)}))},a.prototype.getIndexFromTypeName=function(e){for(let t=0;t<this.typesToLoad_.length;++t)if(this.typesToLoad_[t]===e)return t;return-1},a.prototype.createPropertiesCheckerForType=function(e){if(this.typesPropertiesChecker_[e])return!0;const t=this.typesToLoad_[e],s=o.computeTypePath(this.mwebModule_,t),r=this.typesSignatures_[e],i=this.typesDependencies_[e];if(i&&i.length>0)for(let e=0;e<i.length;++e){const t=i[e];if(!o.getUserType(this.mwebModule_,t)){const e=this.getIndexFromTypeName(t);if(!this.createPropertiesCheckerForType(e))return!1}}const n=u(r,s,this.mwebModule_,this.errorContext_,t);return n instanceof l&&(this.typesPropertiesChecker_[e]=n,o.addUserType(this.mwebModule_,t,n))},a.prototype.loadTypesPropertiesChecker=function(){const e=[];for(let t=0;t<this.typesToLoad_.length;++t)e.push({index:t,depCount:this.typesDependencies_[t]?this.typesDependencies_[t].length:0});e.sort((function(e,t){return e.depCount-t.depCount}));for(let t=0;t<e.length;++t){const s=e[t].index;this.createPropertiesCheckerForType(s)}},o.buildCheckParametersForFunctionPromise=function(e,t,s,r,i){return new Promise(((n,o)=>{const p=new h(r,i,void 0,s),c=JSON.parse(e),l=new a(s,p);l.recursiveSearchForTypeNamesToLoad(c),l.loadTypesJsObjectPromise().then((()=>{l.loadTypesPropertiesChecker(),c.onCall.in||p.addMessage('missing mandatory "in"'),c.onCall.out||p.addMessage('missing mandatory "out"');const e={inputs:u(c.onCall.in,t,s,p,"onCall.in"),outputs:u(c.onCall.out,t,s,p,"onCall.out"),progress:u(c.progress,t,s,p,"progress"),error:u(c.throwError,t,s,p,"throwError")};p.isEmpty()?n(e):o(new Error(p.toString("Json parsing error(s)")))}))}))},o.publishSystemError=function(e){return console.warn(e),!1};const p=function(e,t,s,r,i,n){this.ekChannel_=e,this.guid_=t,this.poolName_=s,this.functionName_=r,this.functionVersion_=i,this.functionCheck_=n,this.answerErrorCalled_=!1,this.answerSuccessCalled_=!1};function c(e,t,s){let r=", label: "+e+" type: "+t;return s&&s.length>0&&(r+=" path: "+s),r}p.prototype.checkMultipleAnswers=function(e){const t=this.functionName_+"_v"+this.functionVersion_;return this.answerSuccessCalled_?o.publishSystemError("Unexpected call to CSI.Channel::"+e+"() when answerSuccess() has already been called - "+t):!this.answerErrorCalled_||o.publishSystemError("Unexpected call to CSI.Channel::"+e+"() when answerError() has already been called - "+t)},p.prototype.answerSuccess=function(e){if(this.checkMultipleAnswers("answerSuccess")){if(this.functionCheck_&&this.functionCheck_.outputs){const t=new h(this.poolName_,this.functionName_,this.functionVersion_);if(!this.functionCheck_.outputs.check(e,t))return this.answerSystemError(t.toString("Answer Success ParametersCheck failed"))}return this.ekChannel_.answerBinary(this.buildMessage(s.serverToClientSuccess,e)),this.answerSuccessCalled_=!0,!0}return!1},p.prototype.answerProgress=function(e){if(this.checkMultipleAnswers("answerProgress")){if(this.functionCheck_&&this.functionCheck_.progress){const t=new h(this.poolName_,this.functionName_,this.functionVersion_);if(!this.functionCheck_.progress.check(e,t))return this.answerSystemError(t.toString("Answer Progress ParametersCheck failed"))}return this.ekChannel_.answerBinary(this.buildMessage(s.serverToClientProgress,e)),!0}return!1},p.prototype.answerError=function(e){if(this.checkMultipleAnswers("answerError")){if(this.functionCheck_&&this.functionCheck_.error){const t=new h(this.poolName_,this.functionName_,this.functionVersion_);if(!this.functionCheck_.error.check(e,t))return this.answerSystemError(t.toString("Answer Error ParametersCheck failed"))}return this.ekChannel_.answerBinary(this.buildMessage(s.serverToClientError,e)),this.answerErrorCalled_=!0,!0}return!1},p.prototype.answerSystemError=function(t){if(this.checkMultipleAnswers("answerSystemError")){const r=new e;return o.publishSystemError(t),r.writeString("error",t),r.writeInt32("errorCode",1),r.declareAsObject("CSISystemError"),this.ekChannel_.answerBinary(this.buildMessage(s.serverToClientError,r)),this.answerErrorCalled_=!0,!0}return!1},p.prototype.buildMessage=function(e,t){var s=new r;return s.setMessageType(e),s.setGuid(this.guid_),s.setTargetName(this.functionName_),s.setTargetVersion(this.functionVersion_),s.setArguments(t),s.createBinary()},o.onClientFunctionCall=function(e,t,s){const r=t.getTargetName(),i=t.getTargetVersion(),n=t.getArguments(),o=t.getGuid(),a=t.getTargetName()+"_v"+t.getTargetVersion();let c,u;e.supportedCSIFunctions_&&(e.supportedCSIFunctions_.onCallFcts&&(c=e.supportedCSIFunctions_.onCallFcts[a]),e.supportedCSIFunctions_.checkParametersFcts&&(u=e.supportedCSIFunctions_.checkParametersFcts[a]));const l=new p(s,o,e.poolName_,r,i,u);if(void 0!==c){if(u&&u.inputs){const t=new h(e.poolName_,r,i);if(!u.inputs.check(n,t))return l.answerSystemError(t.toString("Parameters Check Failed"))}return c(n,l)}return l.answerSystemError("JS Function "+a+" not found")};const h=function(e,t,s,r){this.messages_=[],this.function_="",r&&(this.function_+="jsModule: "+r+", "),this.function_+="pool: "+e+", function: "+t,s&&(this.function_+="_v"+s)};h.prototype.setFilePath=function(e){e!==this.filePath_&&(this.filePath_=e,this.filePathChanged_=!0)},h.prototype.isEmpty=function(){return 0===this.messages_.length},h.prototype.addMessage=function(e){if("string"==typeof e){this.filePathChanged_&&(this.messages_.push("  file: "+this.filePath_),this.filePathChanged_=!1);let t="  ";this.filePath_&&(t+="  "),this.messages_.push(t+e)}return!1},h.prototype.toString=function(e){let t=e+" for "+this.function_;for(let e of this.messages_)t.length&&(t+="\n"),t+=e;return t};const u=function(e,t,s,r,i){if(!e)return;let n;if(r.setFilePath(t),e.hasOwnProperty("parameters"))n=new l(e.parameters,t,s,r);else if(e.hasOwnProperty("type")){const a=e.type;"Parameters"===e.type?n=new l(void 0,t,s,r,{acceptAll:!0}):(n=o.getUserType(s,a),n||r.addMessage(i+": "+a+" type not available"))}else e.hasOwnProperty("definition")?n=new l(e.definition,t,s,r):0===Object.keys(e).length&&(n=new l(void 0,t,s,r,{acceptNothing:!0}));return n&&n.valid_?n:void 0},l=function(e,t,s,r,n){if(this.properties_={},this.valid_=!0,this.mwebModule_=s,this.filePath_=t,n){if(n.acceptAll)return void(this.acceptAll_=!0);if(n.acceptNothing)return void(this.acceptNothing_=!0);n.userType&&(this.userType_=n.userType)}if("object"==typeof e)for(let n of e){const e=n.label;if("string"!=typeof e||0===e.length)return void(this.valid_=r.addMessage("Property without label"));if(!i.test(e))return void(this.valid_=r.addMessage("Label not camelCase "+e));const o=new y(n,t,s,r);o&&o.valid_&&(this.properties_[n.label]=o)}};l.prototype.check=function(t,s,r){if(!(t instanceof e))return!1;if(!this.valid_||this.acceptAll_)return!0;if(this.acceptNothing_&&!t.isEmpty())return s.addMessage("only empty arguments is accepted but received "+t.exportToString());if(0===Object.keys(this.properties_).length)return!0;let i=!0;for(let e in t.propertyMap_)if(!this.properties_.hasOwnProperty(e)){i=!1;const n="Unexpected property"+c(e,t.exists(e),r);s.addMessage(n)}void 0===r&&(r="");for(let e in this.properties_)this.properties_.hasOwnProperty(e)&&(i&=this.properties_[e].check(t,s,r));return i};const d=["label","desc","basic","basicArray","type","typeArray","parameters","parametersArray","optional"],_=["bool","int8","uint8","int16","uint16","int32","uint32","int64","uint64","float","double","string","buffer"],y=function(e,t,s,r){this.label_=e.label,this.typeName_="",this.type_="",this.array=!1,this.subProperties_=void 0,this.optional_=!1,this.defaultValue_=void 0,this.valid_=!0;for(let t in e)d.indexOf(t)<0&&(this.valid_=r.addMessage("Property "+this.label_+' contains unallowed member "'+t+'"'));e.hasOwnProperty("basic")?(this.type_="basic",this.typeName_=e.basic,_.indexOf(e.basic)<0&&(this.valid_=r.addMessage("Property "+this.label_+' with unknown basic type "'+e.basic+'"'))):e.hasOwnProperty("basicArray")?(this.type_="basic",this.typeName_=e.basicArray+"[]",this.array=!0,_.indexOf(e.basicArray)<0&&(this.valid_=r.addMessage("Property "+this.label_+' with unknown basicArray type "'+e.basicArray+'"'))):e.hasOwnProperty("parameters")?(this.type_="parameters",this.typeName_="parameters",this.subProperties_=new l(e.parameters,t,s,r),this.subProperties_.valid_||(this.valid_=!1)):e.hasOwnProperty("parametersArray")?(this.type_="parameters",this.typeName_="parameters[]",this.array=!0,this.subProperties_=new l(e.parameters,t,s,r),this.subProperties_.valid_||(this.valid_=!1)):e.hasOwnProperty("type")?(this.type_="type",this.typeName_=e.type,this.subProperties_=o.getUserType(s,e.type),this.subProperties_||(this.valid_=r.addMessage("Property "+this.label_+' with unknown type "'+e.type+'"'))):e.hasOwnProperty("typeArray")&&(this.type_="typeArray",this.typeName_=e.typeArray+"[]",this.array=!0,this.subProperties_=o.getUserType(s,e.typeArray),this.subProperties_||(this.valid_=r.addMessage("Property "+this.label_+' with unknown type "'+e.type+'"'))),e.hasOwnProperty("optional")&&(e.optional.default_value||e.optional.isOptional)&&(this.defaultValue_=e.default_value,this.optional_=!0)};function f(e,t){let s="";if(e.length){s+="Loaded functions:";for(let t of e)s+="\n  "+t}if(t.length){s.length&&(s+="\n"),s+="Failed load for functions:";for(let e of t)s+="\n  "+e}return s}return y.prototype.check=function(e,t,s){const r=e.exists(this.label_);if(void 0===r){if(this.optional_)return!0;const e="Missing expected property"+c(this.label_,this.typeName_,s);return t.addMessage(e)}if(this.typeName_===r)return!0;if("Parameters"===r){if(this.subProperties_){const r=e.readParameters(this.label_,"Parameters");return this.subProperties_.check(r,t,s+"/"+this.label_)}}else if("Parameters[]"===r&&this.subProperties_){const r=e.readParametersArray(this.label_,"Parameters");if(r&&r.length>0)for(let e of r)return this.subProperties_.check(e,t,s+"/"+this.label_)}const i="Unexpected type "+r+" for property"+c(this.label_,this.typeName_,s);return t.addMessage(i)},o.loadCSIPoolFunctions=function(e,t,s){this.initCSIFunctionJS();const r=this,i="DS/"+e+"/"+t;return new Promise(((a,p)=>{require([i],(function(i){const c=[],h=[],u=[];let l="";for(let d in i)if(i.hasOwnProperty(d)&&"function"==typeof i[d]&&n.test(d)){const _=i[d];r.supportedCSIFunctions_.onCallFcts[d]=_,c.push(d)}if(s){function y(s){if(s<c.length){const i="text!/"+e+"/assets/"+t+"/"+c[s]+".json";require([i],(function(n){o.buildCheckParametersForFunctionPromise(n,i,e,t,c[s]).then((e=>{r.supportedCSIFunctions_.checkParametersFcts[c[s]]=e,h.push(c[s]),y(s+1)})).catch((e=>{u.push(c[s]),delete r.supportedCSIFunctions_.onCallFcts[c[s]],l+=e.message+"\n",y(s+1)}))}),(function(e){u.push(c[s]),delete r.supportedCSIFunctions_.onCallFcts[c[s]],l+=e+"\n",y(s+1)}))}else!function(e,t,s,r,i,n){let a="";n.length&&o.publishSystemError(n),r.length?(a+='Successfull Loading of CSI Javascript pool "'+s+'".\n'+f(r,i)+" \n"+n,e(a)):(a+='Failed Loading of CSI Javascript pool "'+s+'".\n'+f(r,i)+" \n"+n,t(new Error(a)))}(a,p,t,h,u,l)}y(0)}else a("Load pool"+t+" successfull, ")}),(function(e){p(new Error("Load Error: "+e.message),{cause:e})}))}))},o.loadCSIFunction=function(e,t,s,r){this.initCSIFunctionJS();const i=this;return new Promise(((a,p)=>{n.test(s)?(i.supportedCSIFunctions_.onCallFcts[s]&&(i.supportedCSIFunctions_.checkParametersFcts[s]?a(s+" is already loaded with parameters check"):r||a(s+" is already loaded without parameters check")),function(){let n="DS/"+e+"/"+t;require([n],(function(c){if(c.hasOwnProperty(s)){const n=c[s];i.supportedCSIFunctions_.onCallFcts[s]=n,r?function(){const r="text!/"+e+"/assets/"+t+"/"+s+".json";require([r],(function(n){o.buildCheckParametersForFunctionPromise(n,r,e,t,s).then((e=>{i.supportedCSIFunctions_.checkParametersFcts[s]=e,a(s+" loaded (with parameters check)")})).catch((e=>{delete i.supportedCSIFunctions_.onCallFcts[s],"SyntaxError"===e.name?p(new Error(e.message+" in "+r,{cause:e})):p(new Error(e.message,{cause:e}))}))}),(function(e){delete i.supportedCSIFunctions_.onCallFcts[s],p(new Error("Load Error: "+e.message,{cause:e}))}))}():a(s+" loaded (without parameters check)")}else p(new Error(s+"() method not found in "+n))}),(function(e){p(new Error("Load Error: "+e.message,{cause:e}))}))}()):p(new Error(s+" must be camel case functionName_vX with X = number"))}))},o.initCSIFunctionJS=function(){void 0===this.supportedCSIFunctions_&&(this.supportedCSIFunctions_={onCallFcts:{},checkParametersFcts:{}})},o.unloadAllCSIFunctions=function(){this.supportedCSIFunctions_={onCallFcts:{},checkParametersFcts:{}}},o}));