define("DS/CSICommandBinder/CSICommandBinder",["DS/ExperienceKernel/ExperienceKernel","DS/CSICommandBinder/CSIParameters","DS/CSICommandBinder/CSIErrorReport","DS/CSICommandBinder/CSIArgumentCheck","DS/CSICommandBinder/CSIRecord","DS/CSICommandBinder/CSIHeader","DS/CSICommandBinder/CSIFunctionJS"],(function(e,t,n,r,o,i,s){"use strict";var a=i.ENodeMessageType,c=i.MessageBuilder,d=i.MessageReader,u=Object.freeze({select:0,functionCall:1,functionSuccess:2,functionError:3,functionProgress:4,commandBegin:5,commandDo:6,commandEnd:7,commandSuccess:8,commandError:9,commandTerminate:10,interrupt:11,event:12}),l=function(){},p={traceIOsParentTraceID_:void 0,defaultsOptions:e.defaultsOptions,Parameters:t,poolMap_:{},forwardRecordFunction_:function(){},onClientFunctionCall_:function(){}};s&&(p.onClientFunctionCall_=s.onClientFunctionCall),p.declareType=function(e){return t.prototype.declareType(e)},p.getPool=function(e){return void 0===this.poolMap_[e]&&(this.poolMap_[e]=new h(e)),this.poolMap_[e]},p.createNode=function(e,t){return o.isRecordActivated_&&(t.canDisconnectFromHypervisor=!1),this.getPool(e).createNode(t)};var m=function(e,t,n){var r=e.readString("error");return void 0===r&&(r=JSON.stringify(e.toJSObject())),t+" version "+n+" returned an error: "+r};if(p.createParameters=function(e,n){var r=new t;if(void 0===e&&void 0===n)return r;if("string"==typeof e&&void 0!==n){var o=t.prototype.serializeMap_[e];if(void 0!==o&&o(r,n))return r.typeName_=e,r}},p.ActivateTraceIOsInLog=function(e){"string"==typeof e&&e.length>0?this.traceIOsParentTraceID_=e:this.traceIOsParentTraceID_="boolean"==typeof e&&!0===e?function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let n="";const r=new Uint8Array(e);return crypto.getRandomValues(r),r.forEach((e=>{n+=t[e%62]})),n}(25):void 0,void 0===this.traceIOsParentTraceID_?console.log("CSI TraceIOs in log deactivated"):console.log("CSI TraceIOs in log activated, with parentTraceID = "+this.traceIOsParentTraceID_)},"object"==typeof window&&void 0!==window.sessionStorage){const e=sessionStorage.getItem("CSI_TRACEIOS");if(void 0!==e&&p.ActivateTraceIOsInLog(e),window.addEventListener("storage",(function(e){e.storageArea===sessionStorage&&"CSI_TRACEIOS"===e.key&&p.ActivateTraceIOsInLog(e.newValue)})),void 0!==window&&void 0!==window.sessionStorage){const e=window.sessionStorage.setItem;window.sessionStorage.setItem=function(t,n){let r;if("CSI_TRACEIOS"===t){const o=window.localStorage.getItem(t);r=e.apply(this,arguments);const i=new StorageEvent("storage",{storageArea:window.sessionStorage,key:"CSI_TRACEIOS",oldValue:o,newValue:n,url:window.location.href});window.dispatchEvent(i)}else r=e.apply(this,arguments);return r}}}var h=function(e){this.pool_=e,this.nodeCount_=1};h.prototype.createNode=function(e){(e=e||{}).pool=this.pool_;var t=new _(e);//!< each node has its own index to generate guid for commands
return t.index_=this.nodeCount_++,t};var _=function(t){this.poolName_=t.pool,this.eventUniqueIdentifier_=0,
//!< map <event> , <response>, client can subscribe to an event with callbacks (per domain)
this.subscribeMap_={},"boolean"==typeof t.rdf_bypass_getActiveTypes&&(this.rdf_bypass_getActiveTypes_=t.rdf_bypass_getActiveTypes,delete t.rdf_bypass_getActiveTypes),"boolean"==typeof t.replayMode&&(this.replayMode_=t.replayMode,delete t.replayMode),this.monitorIndex_=1,this.monitorCallback_=l,this.monitorCallbackOverrideInterrupt_=function(){};var r=this;t.onBinary=async function(e,t){var o=new d(e);if(!o.isValid())return n.warning("CSI Web Client (version "+i.EProtocolVersion.v3+") received an unsupported message"),!1;var s=o.getMessageType();if(s===a.emit){var c=o.getTargetName(),l=o.getArguments();r.monitorCallback_(u.event,void 0,c,void 0,l);var m=[];return r.subscribeMap_[c].forEach((function(e){e.nodeId.equals(t)&&("function"==typeof e.callback?m.push(e.callback(l)):e.callback instanceof y&&m.push(e.callback.callDomains(l)))})),await Promise.all(m),!0}return s===a.clientFunctionCall&&p.onClientFunctionCall_(r,o,t)},this.eknode_=new e.Node(t)};function f(e,t){var r=new d(e);if(r.isValid()){var o=r.getMessageType();return o!==a.serverToClientSuccess&&o!==a.serverToClientProgress&&o!==a.serverToClientError?o===a.clientCommandInstanceDeleted?"commandTerminated":void n.warning(t+"received unexpected callback -bad msgType-"):{reader:r,msgType:o}}n.warning(t+"CSI Web Client (version "+i.EProtocolVersion.v3+") received a message with an unsupported version")}function v(e,t){var r,o=e.onAnswer?e.onAnswer:e.onComplete;r="function"==typeof o?o:o instanceof y?function(e){o.callDomains(e)}:function(){};var i=e.onError;"function"!=typeof i&&(i=function(t){n.error(m(t,e.command,e.version))});var s="function"==typeof e.onTerminate?e.onTerminate:function(){},c="command: "+e.command+"_v"+e.version+" ";return function(n){var o=f(n,c);if(void 0===o)return!1;if("string"==typeof o)return t(u.commandTerminate,e.index_,e.command,e.version),s(),!0;var{reader:d,msgType:l}=o,p=d.getArguments();return l===a.serverToClientError?(t(u.commandError,e.index_,e.command,e.version,p),i(p),!0):l===a.serverToClientSuccess?(t(u.commandSuccess,e.index_,e.command,e.version,p),r(p),!0):void 0}}_.prototype.setMonitorCallback=function(t){t?(this.monitorCallback_=function(e,n,r,o,i){t({eventType:e,index:n,name:r,version:o,parameters:i})},this.monitorCallbackOverrideInterrupt_=function(t,n,r,o){o.interrupt=function(){e.Interruption.prototype.interrupt.apply(o,arguments),t.monitorCallback_(u.interrupt,r,n.name,n.version,n.parameters)}}):(this.monitorCallback_=l,this.monitorCallbackOverrideInterrupt_=function(){})},_.prototype.stop=function(){const e=Object.keys(this.subscribeMap_);if(e.length>0){for(const t of e){const e=this.subscribeMap_[t];for(const n of e)n&&this.eknode_&&n.nodeId&&this.eknode_.unsubscribe(n.nodeId,t)}this.subscribeMap_={}}if(void 0!==this.eknode_)return this.eknode_.stop()},_.prototype.isPoolProvisionable=function(e,t,n){if(void 0!==this.eknode_)return this.eknode_.isPoolProvisionable(e,t,n)},_.prototype.isPoolSelectable=function(e,t){if(void 0!==this.eknode_)return this.eknode_.isPoolSelectable(e,t)},_.prototype.createIterativeRequest=function(e){return r.check(e,"createIterativeRequest"),new C(this,e)},_.prototype.createRequest=function(e){return r.check(e,"createRequest"),new I(this,e)},_.prototype.call=function(t,n){if(!r.check(t,"callFunction"))return!1;var o=this.monitorIndex_++,i=new c;return i.setMessageType(a.clientFunctionCall),i.setTargetName(t.name),i.setTargetVersion(t.version),i.setGuid(o),i.setDebugMode(t.debug),i.setArguments(t.parameters),p.traceIOsParentTraceID_&&(void 0===t.traceContext&&(t.traceContext=new e.TraceContext,t.traceContext.setEKCurrentTraceId(p.traceIOsParentTraceID_)),t.traceContext.SetVerboseMode(!0)),this.callInternal(t,o,i,n)},_.prototype.toFunctionRequest=function(e,t,n,r,o,i,s,a){return{destinationNodeId:e,name:t,version:n,parameters:r,onSuccess:o,onError:i,onProgress:s,traceContext:a}},_.prototype.callPromise=function(e,t){return new Promise(((n,r)=>{e.onSuccess=e=>{n(e)},e.onError=e=>{r(e)},this.call(e,t)}))},_.prototype.callInternal=function(n,r,o,i){this.monitorCallback_(u.functionCall,r,n.name,n.version,n.parameters);var s=function(e,n,r){var o="function"==typeof e.onSuccess?e.onSuccess:function(){},i="function"==typeof e.onError?e.onError:function(t){throw new Error(m(t,e.name,e.version))},s="function"==typeof e.onProgress?e.onProgress:function(){},c=!1;return{onBinary:function(t){var d=f(t,"function: "+e.name+"_v"+e.version+" ");if(void 0===d)return!1;var{reader:l,msgType:p}=d,m=l.getArguments();return p===a.serverToClientSuccess?(c=!0,n(u.functionSuccess,r,e.name,e.version,m),o(m),!0):p===a.serverToClientError?(c=!0,n(u.functionError,r,e.name,e.version,m),i(m),!0):p===a.serverToClientProgress?(n(u.functionProgress,r,e.name,e.version,m),s(m),!0):void 0},join:function(){if(!c&&"csiGetActiveTypes"!==e.name){var n=new t;n.writeInt32("errorCode",500),n.writeString("error","The connection with the server node has been closed before any success or error answer"),n.declareType("CSISystemError"),i(n)}}}}(n,this.monitorCallback_,r),c=new e.Multiplexer(this.eknode_,s);i&&this.monitorCallbackOverrideInterrupt_(this,n,r,i);var d={interruption:i,traceContext:n.traceContext};return c.sendBinary(n.destinationNodeId,o.createBinary(),d),c.close(),!0},_.prototype.select=function(e,t){if(this.monitorCallback_(u.select,0,e),0!==e.length){var n=void 0;return n=void 0===t?this.eknode_.connect(e).select():this.eknode_.connect(e).select(t),!0===this.replayMode_&&o.setReplayMode(this,n,!0),p.forwardRecordFunction_(this,n,e),n}},_.prototype.connectNode=function(e){return this.eknode_.connectNode(e)},_.prototype.subscribe=function(e,t,r){return null==e?n.error("INVALID USE of Node.subscribe(); the target node id is invalid."):"string"!=typeof t||""===t?n.error("INVALID USE of Node.subscribe(); the event name must be a non-null string."):r instanceof y||"function"==typeof r?(this.eknode_.subscribe(e,t),this.subscribeMap_[t]=[{id:++this.eventUniqueIdentifier_,nodeId:e,callback:r}],!0):n.error("INVALID USE of Node.subscribe(); the subscribe object must be a function or a response.")},_.prototype.unsubscribe=function(e,t){return null==e?n.error("INVALID USE of Node.unsubscribe(); the target node id is invalid."):"string"!=typeof t||""===t?n.error("INVALID USE of Node.unsubscribe(); the event name must be a non-null string."):(this.subscribeMap_[t]&&(this.eknode_.unsubscribe(e,t),this.subscribeMap_[t]=[]),!0)},_.prototype.subscribeToEvent=function(e,t,r){if(null==e)return n.error("INVALID USE of Node.subscribeToEvent(); the target node id is invalid."),-1;if("string"!=typeof t||""===t)return n.error("INVALID USE of Node.subscribeToEvent(); the event name must be a non-null string."),-1;if("function"!=typeof r)return n.error("INVALID USE of Node.subscribeToEvent(); functionCB must be a Function."),-1;this.eknode_.subscribe(e,t),t in this.subscribeMap_||(this.subscribeMap_[t]=[]);var o=++this.eventUniqueIdentifier_;return this.subscribeMap_[t].push({id:o,nodeId:e,callback:r}),o},_.prototype.subscribeToEventWithSubject=function(e,t,r,o){return"string"!=typeof r||""===r?(n.error("INVALID USE of Node.subscribeToEventWithSubject(); the subject name must be a non-null string."),-1):this.subscribeToEvent(e,t+"/"+r,o)},_.prototype.unsubscribeFromEvent=function(e){var t=!1,n=null,r=null;for(var o in this.subscribeMap_)if(Object.prototype.hasOwnProperty.call(this.subscribeMap_,o)){var i,s=this.subscribeMap_[o];for(i=s.length-1;i>=0;--i)if(s[i].id===e){r=o,n=s[i].nodeId,s.splice(i,1),t=!0;break}if(t){var a=!0;for(i=0;i<s.length;++i)if(n.equals(s[i].nodeId)){a=!1;break}return a&&this.eknode_.unsubscribe(n,r),!0}}return!1},_.prototype.loadCSIPoolFunctions=s.loadCSIPoolFunctions,_.prototype.loadCSIFunction=s.loadCSIFunction,_.prototype.initCSIFunctionJS=s.initCSIFunctionJS,_.prototype.unloadAllCSIFunctions=s.unloadAllCSIFunctions;var y=function(){this.domainMap_={}};y.prototype.onAnswerDomain=function(e,t){this.domainMap_[e]=t},y.prototype.hasDomain=function(e){return this.domainMap_.hasOwnProperty(e)},y.prototype.getDomainCallback=function(e){if(this.domainMap_.hasOwnProperty(e))return this.domainMap_[e]},y.prototype.getDomains=function(){return Object.keys(this.domainMap_).sort()},y.prototype.callDomains=function(e){var t=e.readStringArray("domainNames"),n=e.readParameters("domains","Parameters");if(void 0!==n&&t instanceof Array&&t.length)for(var r=0;r<t.length;r++){var o=t[r],i=n.readParameters(o,"Parameters");this.domainMap_.hasOwnProperty(o)&&i&&this.domainMap_[o](i)}};var b=function(){this.EKInterruptions_=[]};b.prototype.interrupt=function(){return this.EKInterruptions_.forEach((function(e){e.interrupt()})),this.EKInterruptions_=[],!0},b.prototype.sendBinary=function(t,n,r){var o=new e.Interruption;return this.EKInterruptions_.push(o),t.sendBinaryWithInterrupt(n,r,o)};var g=function(e,n){n.index_=e.monitorIndex_++,this.node_=e,this.commandRequest_=n,this.beginHasBeenCalled_=!1,this.csiInterruption_=new b,void 0===this.commandRequest_.destinationNodeId&&(this.commandRequest_.destinationNodeId=e.select(n.destinationPool)),this.messageBuilder_=new c,this.messageBuilder_.setMessageType(a.clientToServer),this.messageBuilder_.setTargetName(n.command),this.messageBuilder_.setTargetVersion(n.version),this.messageBuilder_.setGuid(n.index_),this.messageBuilder_.setDebugMode(n.debug),this.messagePayload_=new t};(g.prototype={eBegin:0,eSend:1,eEnd:2}).setHeaderParameters=function(e,t){var r=void 0;if(e===g.prototype.eBegin){if(this.beginHasBeenCalled_)return n.error("INVALID USE of IterativeRequest.begin(parameters); has already been called and cannot be called anymore.");r="beginParameters",this.beginHasBeenCalled_=!0}else r=e===g.prototype.eSend?"sendParameters":"endParameters";return null==t||t.isEmpty()?this.messagePayload_.writeUint8(r,1):this.messagePayload_.writeParameters(r,"Parameters",t),!0},g.prototype.clearHeader=function(){this.messagePayload_=new t},g.prototype.interrupt=function(){return this.node_.monitorCallback_(u.interrupt,this.commandRequest_.index_,this.commandRequest_.command,this.commandRequest_.version),this.csiInterruption_.interrupt()},g.prototype.sendEKResult=function(){this.messageBuilder_.setArguments(this.messagePayload_);var t={onBinary:v(this.commandRequest_,this.node_.monitorCallback_)},n=new e.Multiplexer(this.node_.eknode_,t);return n.sendBinary(this.commandRequest_.destinationNodeId,this.messageBuilder_.createBinary()),n.close(),this.clearHeader(),!0},g.prototype.sendEKResultWithInterruption=function(){this.messageBuilder_.setArguments(this.messagePayload_);var t={onBinary:v(this.commandRequest_,this.node_.monitorCallback_)},n=new e.Interruption;this.csiInterruption_.EKInterruptions_.push(n);var r=new e.Multiplexer(this.node_.eknode_,t);return r.sendBinaryWithInterrupt(this.commandRequest_.destinationNodeId,this.messageBuilder_.createBinary(),n),r.close(),this.clearHeader(),!0},g.prototype.sendMsgOnDisconnection=function(){this.messageBuilder_.setArguments(this.messagePayload_);var e=this.node_.eknode_.sendBinaryOnDisconnection(this.commandRequest_.destinationNodeId,this.messageBuilder_.createBinary());return this.clearHeader(),e};var I=function(e,t){this.impl_=new g(e,t),this.command_=t.command};I.prototype.interrupt=function(){return this.impl_.interrupt()},I.prototype.send=function(e,t,r){if(3!==arguments.length&&0!==arguments.length)return n.error("INVALID USE of Request.send(beginParameters, doParameters, endParameters); requires 3 arguments (null or undefined accepted as empty parameters).");if(this.used_)return n.error("INVALID USE of Request.send(beginParameters, doParameters, endParameters); has already been called and cannot be called anymore on this one shot request.");this.used_=!0,this.impl_.setHeaderParameters(g.prototype.eBegin,e),this.impl_.setHeaderParameters(g.prototype.eSend,t),this.impl_.setHeaderParameters(g.prototype.eEnd,r);var o=this.impl_.node_.monitorCallback_,i=this.impl_.commandRequest_.index_,s=this.impl_.commandRequest_.command,a=this.impl_.commandRequest_.version;return o(u.commandBegin,i,s,a,e),o(u.commandDo,i,s,a,t),o(u.commandEnd,i,s,a,r),this.impl_.sendEKResultWithInterruption()},I.prototype.sendOnDisconnection=function(e,t,n){return this.impl_.setHeaderParameters(g.prototype.eBegin,e),this.impl_.setHeaderParameters(g.prototype.eSend,t),this.impl_.setHeaderParameters(g.prototype.eEnd,n),this.impl_.sendMsgOnDisconnection(),!0};var C=function(e,t){this.impl_=new g(e,t)};return C.prototype.interrupt=function(){return this.impl_.interrupt()},C.prototype.begin=function(e){return!!this.impl_.setHeaderParameters(g.prototype.eBegin,e)&&(this.impl_.node_.monitorCallback_(u.commandBegin,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResult())},C.prototype.send=function(e){return this.impl_.setHeaderParameters(g.prototype.eSend,e),this.impl_.node_.monitorCallback_(u.commandDo,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResultWithInterruption()},C.prototype.end=function(e){return this.impl_.setHeaderParameters(g.prototype.eEnd,e),this.impl_.node_.monitorCallback_(u.commandEnd,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResult()},p.defaultResponse_=new y,p.getDefaultResponse=function(){return this.defaultResponse_},p.Response=y,p.Private={Node:_,Request:I,IterativeRequest:C},p.MonitorEventType=u,o.initRecorder(p),p}));