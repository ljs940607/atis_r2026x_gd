define("DS/CSICommandBinder/CSIRecord",["DS/ExperienceKernel/ExperienceKernel","DS/CSICommandBinder/CSIParameters","DS/ExperienceKernel/EKBinaryHelpers","DS/CSICommandBinder/CSIValueType","DS/CSICommandBinder/CSIHeader"],(function(e,r,o,t,n){"use strict";var i=n.MessageBuilder,s={sessionCheckerTimer_:5e3,recordForwardedToPools_:[],csiRecordClientList_:[],isRecordActivated_:!1,setReplayMode:function(e,o,t){if(void 0!==e&&void 0!==o&&"boolean"==typeof t){var n=new r;n.writeBool("value",t),a(e,o,"recordReplay",1,n)}},setCSIRecordLoggingFunctions:function(e,r,o){void 0===e?"object"==typeof console?s.log=function(e){console.log(e)}:s.log=function(){}:s.log=function(r){e(r)},void 0===r?"object"==typeof console?s.warn=function(e){console.warn(e)}:s.warn=function(){}:s.warn=function(e){r(e)},void 0===o?"object"==typeof console?s.error=function(e){console.error(e)}:s.error=function(){}:s.error=function(e){o(e)}}},c={checkSessionOnStart:function(){g.csiRecordStartUsed||this.setTimer()},checkSessionOnTimer:function(){return"undefined"!=typeof sessionStorage&&!!sessionStorage.getItem("CSI_RECORD")},onTimer:function(){c.checkSessionOnTimer()||(clearInterval(c.timeoutVar_),c.timeoutVar_=void 0,s.stop())},setTimer:function(){this.timeoutVar_=setInterval(this.onTimer,s.sessionCheckerTimer_)}},a=function(o,t,s,c,a,d){var l=function(e,r,o){var t=new i;return t.setMessageType(n.ENodeMessageType.internalMessaging),t.setTargetName(e),t.setTargetVersion(r),t.setArguments(o),t.createBinary()}(s,c,a),u={onBinary:function(e){if(d){var o=new r;o.fromBinary(e)&&d(o,void 0)}},onText:function(e){d&&d(void 0,e)},join:function(){}},f=new e.Multiplexer(o.eknode_,u);f.sendBinary(t,l),f.close()},d=function(){this.setRecordArguments([],"",!1,!1)};d.prototype.clearSessionStorage=function(){s.isRecordActivated_=!1,sessionStorage.removeItem("CSI_RECORD"),this.setRecordArguments([],"",!1,!1)},d.prototype.setRecordArguments=function(e,r,o,t){return this.recorderName_=r||"",this.targetPoolNameArray_=e||[],this.csiRecordStartUsed=o||!1,this.allowMultipleClients_=t,""===this.recorderName_&&0===this.targetPoolNameArray_.length?s.isRecordActivated_=!1:s.isRecordActivated_=!0,s.isRecordActivated_},d.prototype.writeToSession=function(){var e=JSON.stringify({allowMultipleClients:this.allowMultipleClients_,recorderName:this.recorderName_,targetPools:this.targetPoolNameArray_,csiRecordStartUsed:this.csiRecordStartUsed});sessionStorage.setItem("CSI_RECORD",e)},d.prototype.loadFromSession=function(){if("undefined"==typeof sessionStorage)return s.isRecordActivated_=!1,!1;var e=sessionStorage.getItem("CSI_RECORD");if(e&&"string"==typeof e){if("{"===e[0]){var r=JSON.parse(e),o=r.targetPools?r.targetPools:r.poolsFilter;return this.setRecordArguments(o,"ExecGraph",r.csiRecordStartUsed,r.allowMultipleClients)}if("true"===e)return this.setRecordArguments([],"ExecGraph",!1,!1)}return this.setRecordArguments([],"",!1,!1)};var l=function(e,r,o){this.csiNode_=e,this.nodeId_=r,this.serverPool_=o,this.started_=!1,this.recordResults_={infoPaths:[],recordPaths:[],warnings:[]}};l.prototype.callCsiRecordStart=function(e){if(!this.started_&&g.loadFromSession()){var o=new r;o.writeStringArray("targetPools",g.targetPoolNameArray_),o.writeString("recorder",g.recorderName_),o.writeBool("allowMultipleClients",!!g.allowMultipleClients_);var t=this;a(this.csiNode_,this.nodeId_,"recordStart",1,o,(function(r){if(r){var o=r.readString("key"),n=r.readString("value");"infoPath"===o&&(t.recordResults_.infoPaths.push(n),s.log("CSIRecord activated on server, info path : "+n),e&&e(o,n)),"recordPath"===o&&(t.recordResults_.recordPaths.push(n),s.log("CSIRecord new record path : "+n),e&&e(n)),"warning"===o&&(t.recordResults_.warnings.push(n),s.log("CSIRecord warning : "+n),e&&e(n))}})),this.started_=!0}},l.prototype.callCsiRecordStop=function(e){this.started_&&(this.started_=!1,a(this.csiNode_,this.nodeId_,"recordStop",1,void 0,e))},s.start=function(e,r,o){if(s.recordResults=void 0,g.loadFromSession())s.warn("CSIRecord.start() already activated");else if(void 0===e||e instanceof Array)if(g.setRecordArguments(e,"ExecGraph",!0,r),g.writeToSession(),f.forwardRecordFunction_=u,0===s.csiRecordClientList_.length)s.log("CSIRecord.start() waiting for select()");else for(var t=0;t<s.csiRecordClientList_.length;++t)s.csiRecordClientList_[t].callCsiRecordStart(o);else s.error("CSIRecord.start() invalid 1st argument, targetPools must be undefined or an Array of string")},s.stop=function(e){if(0===s.csiRecordClientList_.length)return s.log("CSIRecord.stop() no recording in progress"),void s.clear();var r={infoPaths:[],recordPaths:[],warnings:[]},o=s.csiRecordClientList_.length;s.csiRecordClientList_.forEach((function(t){t.callCsiRecordStop((function(n,i){"ok"===i&&(r.infoPaths=r.infoPaths.concat(t.recordResults_.infoPaths),r.recordPaths=r.recordPaths.concat(t.recordResults_.recordPaths),r.warnings=r.warnings.concat(t.recordResults_.warnings),0===--o&&(s.recordResults=r,s.log("CSIRecord.stop() success"),r.infoPaths.length>0&&(s.log("CSIRecord infoPaths:"),r.infoPaths.forEach((function(e){s.log(e)}))),r.recordPaths.length>0&&(s.log("CSIRecord recordPaths:"),r.recordPaths.forEach((function(e){s.log(e)}))),r.warnings.length>0&&(s.log("CSIRecord warnings:"),r.warnings.forEach((function(e){s.log(e)}))),void 0!==e&&e(r)))}))})),s.clear()},s.clear=function(){g.clearSessionStorage(),s.csiRecordClientList_=[],s.recordForwardedToPools_=[],f.forwardRecordFunction_=function(){}};var u=function(e,r,o){if(-1===s.recordForwardedToPools_.indexOf(o)){s.recordForwardedToPools_.push(o);var t=new l(e,r,o);s.csiRecordClientList_.push(t),t.callCsiRecordStart()}};s.initRecorder=function(e){f=e,g.loadFromSession()&&(c.checkSessionOnStart(),f.forwardRecordFunction_=u)};var f=void 0,g=new d;return s.setCSIRecordLoggingFunctions(),"object"==typeof window&&(window.csiRecordStart=function(){return s.start.apply(s,arguments)},window.csiRecordStop=function(){return s.stop.apply(s,arguments)}),s}));