define("DS/RenderingMaterialOverrides/ApplyJOP",["DS/Visualization/ThreeJS_DS","DS/RenderingMaterialLib/MaterialMappingCoreServices","DS/RenderingMaterialLib/VisuConversionHelpers"],(function(a,e,n){"use strict";const r="true"===localStorage.getItem("XCT_AC_LOG_ENABLE");let t=function(a,t){let p={};if(t){for(let a in t){const e=n.GetVisParamDesc(a);e?e.isSupported()&&(p[e.id]=t[a]):r&&console.debug("[AC] Unsupported parameter id in ExtraParams:",a)}e.UnifyMappingScaleParams(p)}return Object.assign(p,a),p},p=function(a){const t={};for(let e of a){if(null==e.value){r&&console.debug("[AC] Invalid parameter value in JOP:",e.parameterID);continue}let a=n.GetVisParamDesc(e.parameterID);if(a){if(a.hasValue()){t[a.type]||(t[a.type]={});const r=n.ConvertValue(e.type,e.value);t[a.type][a.id]=r}}else r&&console.debug("[AC] Unsupported parameter ID in JOP:",e.parameterID)}return e.UnifyMappingScaleParams(t[n.ParamType.Mapping]),t},i=function(i,m){const s=i.material_appearance.reference_material_parameters,o=i.material_appearance.applied_material_parameters,c=p(s),f=p(o);let l=c[n.ParamType.Material],g=null,u=c[n.ParamType.Mapping],M=f[n.ParamType.Mapping];const _=m.applied_material_parameters?m.applied_material_parameters.mapping_parameters:{},P=m.reference_material_parameters?m.reference_material_parameters.mapping_parameters:{};if(u&&P){let p={};_&&(p=t(M,_.mapping_info),p.object_transform=_.object_transform);let i=t(u,P.mapping_info);const m={};m.MappingSemantics=P?P.Mapping_Semantic:e.CATMappingSemantic.LegacyMapping,m.RefMappingInfos=i,m.CnxMappingInfos=p;for(let a in P.parameters){let p=n.GetVisParamDesc(a);if(!p){r&&console.debug("[AC] Unsupported parameter ID in ExtraParams:",a);continue}if(!p.hasUvTransform()){r&&console.warn("[AC] Parameter does not support mapping:",a);continue}const i=P.parameters[a],s={};s.MappingInfos=t({},i.mapping_info),s.TextureSize={},s.TextureSize.Width=i.texture_size[0],s.TextureSize.Height=i.texture_size[1];const o=(S=m,T=s,e.computeChannelMapping(S.RefMappingInfos,S.CnxMappingInfos,T.MappingInfos,T.TextureSize,S.MappingSemantics));l[p.uvTransformId]=o.uv_transform}const s=function(n){const r=e.computeApplicationMapping(n.RefMappingInfos,n.CnxMappingInfos,n.MappingSemantics);return n.MappingSemantics==e.CATMappingSemantic.DecoupledMapping?r.trfSemantic=a.MappingTransformSemantic.ROTATION_AROUND_CENTER:r.trfSemantic=a.MappingTransformSemantic.DEFAULT,r}(m);g={},g.mappingType=n.GetVisMappingType(s.type),g.mappingUVTransformation=s.uv_transform,s.object_transform&&(g.mappingObjTransformation=s.object_transform),s.trfSemantic&&(g.mappingTransformSemantic=s.trfSemantic)}var S,T;return{matRefParams:l,matAppParams:g}};return{OverloadVisuMaterialWithJOP:function(a,e,n){const r=i(e,n);let t=r.matRefParams?Object.keys(r.matRefParams):[];r.matAppParams&&(t=t.concat(Object.keys(r.matAppParams))),a.setPhysicalProperties(r.matRefParams),r.matAppParams&&a.setMappingOperator(r.matAppParams.mappingType,r.matAppParams.mappingObjTransformation,r.matAppParams.mappingUVTransformation,!0,r.matAppParams.mappingTransformSemantic)},GetVisuParameterName:function(a){const e=n.GetVisParamDesc(a);return null!=e?e.id:void 0}}}));