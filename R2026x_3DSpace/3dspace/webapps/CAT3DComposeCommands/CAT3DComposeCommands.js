/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeRobotSnapMove",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/CATW3DRobot/CATW3DRobot","DS/PADUtils/PADContext","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var a=i.get();this.beginExecute=function(){var e=n.getMove3DRobot({context:a}),i=t.get();if(1===i.length){var r;r=t._items[0].pathElement.getBoundingSphere().center,e.modifyTargetAndPosition({pathElement:i[0].pathElement,robotPosition:r}),e.addCoordPanel({immersiveFrame:a.getFrameWindow().getImmersiveFrame(),w3dRobot:e,robotP:r});var s=o.getExamineController({context:a});s&&s.setActiveState(!1)}this.done()}}})})),define("DS/CAT3DComposeCommands/CATC3DReverseDirectionCmd",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,i,o,a,r,s){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!1}),this.setRepeatMode(!1),this.beginExecute=function(){var e=t.get();if(e.length){var c,l=i.get(),u=r.giveMoveManager({context:l}),d=o.getMoveReferentManager({context:l}),C=a.giveConstraintsController({context:l});if(e.some((function(e){var t;return c=d.getMoveReferent(e.pathElement),!!(C&&c&&(t=c.getLastElement(!0))&&s.isInstance(t)&&t.children.length>0)&&(c.addElement(t.children[0]),C.isThereACstSuppportingReverseDirection(c))}))&&c&&C){var m=C.simulateReverseDirection(c)||{},S=m.matrix||new n.Matrix4,g=new n.Matrix4,p=m.rc,E=m.redundancy;0!==p||E||(u.onMoveBegin({objectsMoved:e,from:this,moveMode:"Persistent"}),e.forEach((function(e){u.onMove({objectsMoved:[{path:e.pathElement}],from:this,worldMatrix:g.multiplyMatrices(S,e.pathElement.getWorldMatrix())})}),this),u.onMoveEnd({from:this,status:"Moved"}))}this.done()}}}})})),define("DS/CAT3DComposeCommands/CATC3DPasteAtLocalCoordinatesCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/DMUCommandsManager","DS/CATW3DMoveManager/CATW3DMoveManager"],(function(e,t,n,i,o,a){"use strict";var r=new i.Matrix4;let s,c,l;var u=e.extend({init:function(e){this._parent(e),l=this,s=a.getMoveManager({context:n.get()}),this.onStateChange((function(){l.getState()&&u.PasteAtLocalCoordinates()})),this.toggleState=function(){l.getState()||l.setState(!0)},this._destroy=function(){Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),l=void 0}}});return u.PasteAtLocalCoordinates=function(e,i){let l=[];!c&&i?c=i.executionContext.getComponent("Viewer"):c||i||(c=n.get()),s=a.getMoveManager({context:c});var d=[];let C;if(t.get().forEach((function(e){d.push({path:e.pathElement});var t=s.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(r)||l.push({pathElement:e.pathElement,path:t,matrix:n})}})),l.length&&require(["DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd"],(function(t){t&&t.storeOriginalPositionMatrix(e,l)})),d.length&&(s.onMoveBegin({objectsMoved:d,from:u,moveMode:"Persistent"}),s.onMove({objectsMoved:d,from:u,leafMatrix:r}),s.onMoveEnd({from:u,status:"Moved"}),c.getViewer().render()),i&&(C=i.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent)),C)C.setCheckState({id:"PasteAtOriginalPosition",state:!1});else{var m=n.get();o.getCommandCheckHeader("CATC3DPasteAtOriginalPositionHdr",m.getCommandContext?m.getCommandContext():null).setState(!1)}e&&e()},u.clean=function(e){l&&l.setState&&l.setState(!1),e&&e()},u})),define("DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXComponents/DMUCommandsManager"],(function(e,t,n,i,o,a){"use strict";var r=new i.Matrix4;let s,c,l,u,d,C=this,m=[],S=[],g=null;var p=e.extend({init:function(e){this._parent(e),C=this,S=[],l=n.get().getFrameWindow().getContextualUIManager(),u=o.giveMoveManager({context:n.get()}),d=function(){c=[],l.hideContextualMenus(),t.get().forEach((function(e){var t=u.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(r)||c.push({pathElement:e.pathElement,path:t,matrix:n})}})),c.length>0&&(l.showContextualBar({x:n.get().getViewer().SCREEN_WIDTH/2,y:n.get().getViewer().SCREEN_HEIGHT/2,hideWithDistance:!1,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"]},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"]}]}},context:n.get().getCommandContext?n.get().getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]}),C.setState(!0))},g=n.get().subscribe({event:"onAuthoringTransactionEnd"},d),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(e){var t=e.getDropManager({context:n.get()});S.push(t.subscribe({event:"onBeginInsertDrop3D"},(function(){n.get().unsubscribe(g)}))),S.push(t.subscribe({event:"onEndInsertDrop3D"},(function(e){e&&"inPosition"===e.type&&d(),g=n.get().subscribe({event:"onAuthoringTransactionEnd"},d)})))})),this.onStateChange((function(){C.getState()&&p.PasteAtOriginalPosition()})),this.toggleState=function(){this.getState()||C.setState(!0)},this._destroy=function(){n.get().unsubscribe(g),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(e){var t=e.getDropManager({context:n.get()});t&&S.forEach((function(e){t.unsubscribe(e)})),S=[]})),Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),u=c=g=l=d=C=void 0}}});return p.PasteAtOriginalPosition=function(e,i){!s&&i?s=i.executionContext.getComponent("Viewer"):s||i||(s=n.get()),u=o.giveMoveManager({context:s});let r,c=[];if(t.get().forEach((function(e){let t=m.find((t=>t.pathElement===e.pathElement));t&&c.push({pathElement:e.pathElement,path:t.path,matrix:t.matrix})})),c&&c.length>0&&(u.onMoveBegin({objectsMoved:c,from:p,moveMode:"Persistent"}),c.forEach((function(e){!e.path.getMatrix().equals(e.matrix)&&t.isIn(e)&&u.onMove({objectsMoved:[e],from:p,leafMatrix:e.matrix})})),u.onMoveEnd({from:p,status:"Moved"}),s.getViewer().render()),i&&(r=i.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent)),r)r.setCheckState({id:"PasteAtLocalCoordinates",state:!1});else{var l=n.get();a.getCommandCheckHeader("CATC3DPasteAtLocalCoordinatesHdr",l.getCommandContext?l.getCommandContext():null).setState(!1)}e&&e()},p.clean=function(e){C&&C.setState&&C.setState(!1),e&&e()},p.storeOriginalPositionMatrix=function(e,t){m=t,e&&e()},p})),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter",["DS/StateCommandEngine/PathElementAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/CATW3DUtils/CATC3DAxisSystemDisplayAgent","DS/WebappsUtils/WebappsUtils","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],(function(e,t,n,i,o,a,r,s,c){"use strict";var l;return e.extend({_frameWindow:null,_filterUI:null,_activeFilters:null,_filtersEnum:null,_postFilter:null,_axisAgent:null,geometryTypesEnum:{POINT:n.GeometryType.POINT,LINE:n.GeometryType.LINE,CIRCLE:n.GeometryType.CIRCLE,PLANE:n.GeometryType.PLANE,CYLINDER:n.GeometryType.CYLINDER,CONE:n.GeometryType.CONE,SPHERE:n.GeometryType.SPHERE,REFERENCE:10,AXISSYSTEM:n.GeometryType.AXISSYSTEM,AXISSYSTEMAXIS:n.GeometryType.AXISSYSTEMAXIS,AXISSYSTEMORIGIN:n.GeometryType.AXISSYSTEMORIGIN},init:function(e){var i,r=a.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),u=a.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");return this._preselection=!0,l=this,e.context?(this._frameWindow=e.context.getFrameWindow(),this._axisAgent=new o({context:e.context}),this._activeFilters=e.activeFilters||{POINT:1,CENTER:1,CIRCLE:1,AXISSYSTEM:1,AXISSYSTEMAXIS:1,AXISSYSTEMORIGIN:1,LINE:1,PLANE:1,CYLINDER:1,REFERENCE:1},this._postFilter=e.postFilter,this._filtersEnum={POINT:{type:"element",id:"POINT",nls:c.point,url:r+"I_Meas_Point.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.POINT},CENTER:{type:"element",id:"CENTER",nls:c.center,url:r+"I_Meas_PointCircle.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.CENTER},CIRCLE:{type:"element",id:"CIRCLE",nls:c.circle,url:r+"I_WebMarkerCircle.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.CIRCLE},AXISSYSTEM:{type:"element",id:"AXISSYSTEM",nls:c.axisSystem,url:u+"I_3DComposeAxisSystem.png",callback:function(){l._lastClicked="AXISSYSTEM",l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.AXISSYSTEM},AXISSYSTEMAXIS:{type:"element",id:"AXISSYSTEMAXIS",nls:c.axisSystemAxis,url:u+"I_C3DAxisAxis.png",callback:function(){l._lastClicked="AXISSYSTEMAXIS",l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.AXISSYSTEMAXIS},AXISSYSTEMORIGIN:{type:"element",id:"AXISSYSTEMORIGIN",nls:c.axisSystemOrigin,url:u+"I_C3DAxisOrigin.png",callback:function(){l._lastClicked="AXISSYSTEMORIGIN",l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.AXISSYSTEMORIGIN},LINE:{type:"element",id:"LINE",nls:c.line,url:r+"I_Meas_Line.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.LINE},PLANE:{type:"element",id:"PLANE",nls:c.plane,url:r+"I_Meas_Plane.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.PLANE},CYLINDER:{type:"element",id:"CYLINDER",nls:c.cylinder,url:r+"I_Meas_Cylinder.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.CYLINDER},REFERENCE:{type:"element",id:"REFERENCE",nls:c.reference,url:r+"I_Meas_Product.png",callback:function(){l.updateFilters()},bexclude:!0,bstateActif:l._activeFilters.REFERENCE}},(i={agentId:"CAT3DComposeAssemblyPatternSelect",frameWindow:this._frameWindow,withPrevaluation:!1,engWithPSOHSO:!1,withPSO:!0,withHSO:!1,valuedFromCSO:!1,saveToCSO:!1,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",withUndoStep:!1}).prePickingFilter=i.pickingFilter=function(i){var o,a,r=!1,c=0,u=t.getEquivalentGeometry({pathElement:i,axisSystemSub:!l._activeFilters.AXISSYSTEM,axisSystemOrigin:!l._activeFilters.AXISSYSTEMORIGIN,viewer:e.context.getViewer()}),d=u?u.getType():null;if((l._activeFilters.AXISSYSTEM||l._activeFilters.AXISSYSTEMAXIS||l._activeFilters.AXISSYSTEMORIGIN)&&l._axisAgent.analyze({pathElement:i}),(1===l._activeFilters.AXISSYSTEM&&d===l.geometryTypesEnum.AXISSYSTEM||1===l._activeFilters.AXISSYSTEMAXIS&&d===l.geometryTypesEnum.AXISSYSTEMAXIS||1===l._activeFilters.AXISSYSTEMORIGIN&&d===l.geometryTypesEnum.AXISSYSTEMORIGIN)&&(u&&(a=u.getPathElement())&&(i.internalPath=a.internalPath,i.externalPath=a.externalPath),r=!0),!r&&(1===l._activeFilters.POINT&&d===l.geometryTypesEnum.POINT||1===l._activeFilters.CENTER&&(d===l.geometryTypesEnum.CIRCLE||d===l.geometryTypesEnum.SPHERE)||1===l._activeFilters.CIRCLE&&d===l.geometryTypesEnum.CIRCLE||1===l._activeFilters.LINE&&d===l.geometryTypesEnum.LINE||1===l._activeFilters.PLANE&&(d===l.geometryTypesEnum.PLANE||n.GeometryType.REFPLANE)||1===l._activeFilters.CYLINDER&&(d===l.geometryTypesEnum.CYLINDER||d===l.geometryTypesEnum.CONE))&&(r=!0),!r&&1===l._activeFilters.REFERENCE)for(c=i.externalPath.length-1;c>=0;--c)if((o=i.externalPath[c])&&s.isReference(o)){i.setFromArray(i.externalPath.slice(0,c+1)),r=!0;break}return r&&"function"==typeof l._postFilter&&(r=l._postFilter(i)),r},this._parent(i),this.updateFilters(),null):null},activate:function(){var e=r.get();this._parent(),this._preselection&&e.length>0&&(this._preselection=!1,this.object3D=[],this.options.pickingFilter(e[0].pathElement)&&(this.object3D.push(e[0]),this._modelEvents.publish({event:this._agentId,data:this.object3D}))),this.updateFilters()},deactivate:function(){this._filterUI&&(this._filterUI.clear(),this._filterUI.destroy(),this._filterUI=null),l._axisAgent.deactivate(),this._parent()},getSelType:function(e){var n=t.getEquivalentGeometry({pathElement:e,axisSystemSub:!l._activeFilters.AXISSYSTEM}),i=n?n.getType():null;return e&&e.externalPath&&s.isAModelPath(e)?!i&&0===e.internalPath.length&&e.externalPath.some((function(e){return e&&s.isReference(e)}))?this.geometryTypesEnum.REFERENCE:"number"==typeof i?i:null:null},getActiveFilters:function(){return this._activeFilters},updateFilters:function(e,t){var n,o,a,r=!1,s=[];if("boolean"!=typeof t&&(t=!0),e&&"object"==typeof e){for(n in l._activeFilters={},e)e.hasOwnProperty(n)&&l._filtersEnum.hasOwnProperty(n)&&(l._activeFilters[n]=e[n],1!==l._activeFilters[n]&&(l._activeFilters[n]=0));r=!0}if(l._filterUI&&t)for(o in l._activeFilters)l._activeFilters.hasOwnProperty(o)&&(l._activeFilters[o]=l._filterUI.getActiveState(o)?1:0);if(l._lastClicked&&1===l._activeFilters[l._lastClicked]&&(l._activeFilters.AXISSYSTEM&&(l._activeFilters.AXISSYSTEM=0),l._activeFilters.AXISSYSTEMAXIS&&(l._activeFilters.AXISSYSTEMAXIS=0),l._activeFilters.AXISSYSTEMORIGIN&&(l._activeFilters.AXISSYSTEMORIGIN=0),l._activeFilters[l._lastClicked]=1,r=!0),l._lastClicked=null,l._activeFilters.AXISSYSTEM||l._activeFilters.AXISSYSTEMAXIS||l._activeFilters.AXISSYSTEMORIGIN?l._axisAgent.activate({type:"HSO",noPSOcb:!0}):l._axisAgent.deactivate(),r&&l._filterUI&&(l._filterUI.clear(),l._filterUI.destroy(),l._filterUI=null),!l._filterUI){for(o in l._activeFilters)l._activeFilters.hasOwnProperty(o)&&l._filtersEnum.hasOwnProperty(o)&&((a=l._filtersEnum[o]).bstateActif=l._activeFilters[o],s.push(a));l._filterUI=new i({body:l._frameWindow.getUIFrame(),frmWindow:l._frameWindow,Idpanel:"c3dPatternSelectionFilter",typeSeparator:"bubble",verticalPanel:!0,lJsonElement:s}),l._filterUI.build(),l._viewer.render()}}})})),define("DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent",["UWA/Class","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/DMUCommandsManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/PADUtils/PADContext"],(function(e,t,n,i,o,a,r,s,c,l,u){"use strict";var d=0,C=[],m=!1,S=null,g=!1;return e.extend({init:function(e){this._parent(e);var p,E,A,f,v,D=e.context,h=D.getCommandContext?D.getCommandContext():null,T=[],y=u.get(),I=[],R=new n.Matrix4;function x(e){return!e||e.empty()||e.isNaN()||e.min.distanceTo(e.max)<=0}function b(e){var t=y.getController().buildPathFromArray(e.data.paths[0],!0),n=e.data.paths[0];if(t){var i=t.getLastElement(!0);if(!function(e){if(!e)return!1;if(c.isReference(e))return!0;var t=c.getNodeType(e);return"CATDrawing"===t||"Drawing"===t||"CATAnalysis"===t||"PPRContext"===t}(i)||c.is3DLeaf(i))return;var o=y.getController().createReferenceIterator(c.getNodeID(i)),a=i.getChildren().map(c.getNodeID,c),r=o.getChildren().map((function(e){return-1===a.indexOf(e.getInstanceId())?e.getReferenceIterator().getReferenceId():null})).filter((function(e){return e&&-1===C.indexOf(e)&&n.indexOf(e)>=0}));if(!r.length)return;C=C.concat(r),y.getController().lockNodes({ids:r}),b(e)}}this.activate=function(){if(require("DS/PlatformAPI/PlatformAPI").subscribe("DS/PADUtils/PADCommandProxy/select",(e=>{if(e&&e.data&&1===e.data.paths.length){m=!1;var t=y.getController().buildPathFromArray(e.data.paths[0],!0);e.data.paths[0];if(t){if(b(e),!c.is3DLeaf(t.getLastElement(!0))){var n=(t=y.getController().buildPathFromArray(e.data.paths[0],!0)).getBoundingBox(null,y.getViewer(),"visibleSpace"),o=t.getBoundingBox(null,y.getViewer(),"invisibleSpace");x(n)&&x(o)&&setTimeout((function(){if(S=y.getController().buildPathFromArray(e.data.paths[0],!0),n=S.getBoundingBox(null,y.getViewer(),"visibleSpace"),o=S.getBoundingBox(null,y.getViewer(),"invisibleSpace"),x(n)&&x(o)){m=!0;var t=i.getCommand("CAT3DComposeRobotSnapMoveHdr",u.get()._context);t&&t._isRunning&&t.end();var a=i.getCommand("LevelSelectorHdr",u.get()._context);a&&a._isRunning&&(a.cancel(),a.end());var r={x:y.getViewer().div.clientWidth/2,y:y.getViewer().div.clientHeight/2};D.getFrameWindow().getExecutionContext,D.getFrameWindow().getContextualUIManager().hideContextualMenus(),D.getFrameWindow().getExecutionContext?D.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!1,x:r.x,y:r.y}):D.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!1,x:r.x,y:r.y})}else m=!1}),100)}}}else C.length&&y.getController().unlockNodes({ids:C}),C=[],m=!1,S=null})),0===T.length&&(p=D.getViewer(),E=r.getMoveReferentManager({context:D}),T=["CAT3DComposeCtxMenuAgent_"+d++,"CAT3DComposeCtxMenuAgent_"+d++],D.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,r){var s=t.get();m&&S&&0===s.length&&s.push({pathElement:S});var u=c.getRoots(D),d=[],C=!1,A=!1,f=a.giveConstraintsController({context:D});s.some((function(e){var t,n=E.getMoveReferent(e.pathElement);if(n&&(t=n.getLastElement(!0))&&c.isInstance(t)&&t.children.length>0){n.addElement(t.children[0]),f&&f.isThereACstSuppportingReverseDirection(n)&&(C=!0);var a=f?f.getAxisTypeIfCstOnProductAxis(n):null;if(a)if(A=!0,D.getExecutionContext){let e=D.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);e&&(a===o.GeometryType.AXISX?e.setRadioItemState({id:"SwitchToX",radioId:"CATC3DSwitchAxisHdr",state:!0}):a===o.GeometryType.AXISY?e.setRadioItemState({id:"SwitchToY",radioId:"CATC3DSwitchAxisHdr",state:!0}):e.setRadioItemState({id:"SwitchToZ",radioId:"CATC3DSwitchAxisHdr",state:!0}))}else a===o.GeometryType.AXISX?i.getCommandCheckHeader("CATC3DSwitchAxisXHdr",h).setState(!0):a===o.GeometryType.AXISY?i.getCommandCheckHeader("CATC3DSwitchAxisYHdr",h).setState(!0):i.getCommandCheckHeader("CATC3DSwitchAxisZHdr",h).setState(!0);return C&&A}return!1})),A&&d.push({name:"CATC3DSwitchAxisIcb",line:1,hdr_list:["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"],type:"handler",identifier:"CATC3DSwitchAxisHdr"}),C&&d.push({name:"CATC3DReverseDirectionStr",line:1,hdr_list:["CATC3DReverseDirectionHdr"],type:"handler",identifier:"CATC3DReverseDirectionHdr"});var v=s.some((function(e){var t=e.pathElement.getLastElement(!0);return u.some((function(n){var i=n!==t,o=e.pathElement.externalPath.some((function(e){return n===e}));return i&&o}))}));v&&r&&r.withContextMenu&&"number"==typeof r.XmousePosition&&"number"==typeof r.YmousePosition&&(0===p.pick(p.getMousePosition(new n.Vector2(r.XmousePosition,r.YmousePosition)),"mesh",!1).path.length&&(v=!1));if(g)d.push({name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"],type:"handler",identifier:"PasteAtOriginalPosition"}),d.push({name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"],type:"handler",identifier:"PasteAtLocalCoordinates"}),g=!1,I=[];else if(v){if(!m&&l.getExamineController({context:D}).canBeEnabled()&&d.push({name:"CAT3DComposeExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"],type:"handler",identifier:"CAT3DComposeExamineSelectionHdr"}),1===s.length){let e=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),t=y.getController&&y.getController().hasAnyEffectiveFlexibleAssembly();require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration")&&e&&t||d.push({name:"RobotSnapMove",line:1,hdr_list:["CAT3DComposeRobotSnapMoveHdr"],type:"handler",identifier:"CAT3DComposeRobotSnapMoveHdr"}),d.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"],type:"handler",identifier:"LevelSelectorHdr"})}m=!1,S=null}return y.getExecutionContext?d.length?{WAfrCtxBarRow1:{model:d}}:void 0:d.length?{cmdList:d}:void 0},context:h,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:"",merge:!0,subscriberId:T[0]}),D.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,i){var o=[],a=t.get();if(1===a.length){var r=a[0].pathElement.getLastElement(!0);c.getRoots(D).some((function(e){return e===r}))&&o.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"],type:"handler",identifier:"ENO3DRemoveRootCmd"})}if(i&&i.withContextMenu&&"number"==typeof i.XmousePosition&&"number"==typeof i.YmousePosition&&0===p.pick(p.getMousePosition(new n.Vector2(i.XmousePosition,i.YmousePosition)),"mesh",!1).path.length)return;return y.getExecutionContext?o.length?{WAfrCtxBarRow1:{model:o}}:void 0:o.length?{cmdList:o}:void 0},context:h,workbenchName:"ENOPAD3DViewerContextualBar",module:"ENOPAD3DViewer",cmdPrefix:"",merge:!0,subscriberId:T[1]}),D.getExecutionContext)){f=D.getFrameWindow().getContextualUIManager(),v=s.giveMoveManager({context:D});let e=function(){t.get().forEach((function(e){var t=v.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(R)||I.push({pathElement:e.pathElement,path:t,matrix:n})}})),I.length>0&&setTimeout((function(){g=!0,f._showContextualBar({x:p?p.SCREEN_WIDTH/2:D.getViewer().SCREEN_WIDTH/2,y:p?p.SCREEN_HEIGHT/2:D.getViewer().SCREEN_HEIGHT/2,hideWithDistance:!1});let e=D.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);e&&e.setCheckState({id:"PasteAtOriginalPosition",state:!0})}),10)};A=D.subscribe({event:"onAuthoringTransactionEnd"},e),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],(function(t){var n=t.getDropManager({context:D});T.push(n.subscribe({event:"onBeginInsertDrop3D"},(function(){D.unsubscribe(A),A=null}))),T.push(n.subscribe({event:"onEndInsertDrop3D"},(function(t){t&&"inPosition"===t.type&&e(),A=D.subscribe({event:"onAuthoringTransactionEnd"},(function(){e()}))})))}))}},this.deactivate=function(){p=E=null,T.forEach((function(e){D.getFrameWindow().getContextualUIManager().unregister(e)})),D.unsubscribe(A),T=[],A=null}}})})),define("DS/CAT3DComposeCommands/CATC3DSwitchAxisCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CATWebUXComponents/DMUCommandsManager","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,i,o,a,r,s,c,l){"use strict";var u,d,C,m=c.GeometryType;let S=e.extend({init:function(e){let t,n;switch(this._parent(e),e.ID){case"CATC3DSwitchAxisXHdr":t=m.AXISX,n=["CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"];break;case"CATC3DSwitchAxisYHdr":t=m.AXISY,n=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisZHdr"];break;default:t=m.AXISZ,n=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr"]}var i=this.onStateChange((function(){this.getState()&&S.SwitchAxis(void 0,e,t,n)}));this._destroy=function(){this._modelEvents.unsubscribe(i),Object.getPrototypeOf(this)._destroy.call(this),i=n=null}},toggleState:function(){this.getState()||this.setState(!0,!0)},_destroy:function(){this._parent()}});return S.SwitchAxis=function(e,c,g,p){if(!u&&c.executionContext?u=c.executionContext.getComponent("Viewer"):u||c.executionContext||(u=i.get()),g&&p&&(d=g,C=p),c.executionContext&&c.args&&c.args.Axis)switch(c.args.Axis){case"X":d=m.AXISX,C=["SwitchToX","SwitchToZ"];break;case"Y":d=m.AXISY,C=["SwitchToX","SwitchToZ"];break;default:d=m.AXISZ,C=["SwitchToX","SwitchToY"]}var E,A,f=a.giveConstraintsController({context:u}),v=s.giveMoveManager({context:u}),D=r.getMoveReferentManager({context:u}),h=n.get();if(h.some((function(e){var t;return A=D.getMoveReferent(e.pathElement),!!(f&&A&&(t=A.getLastElement(!0))&&l.isInstance(t)&&t.children.length>0)&&(A.addElement(t.children[0]),E=f.getAxisTypeIfCstOnProductAxis(A))})),f&&E&&E!==d&&A){var T=f.simulateSwitchAxis(A,d)||{},y=T.matrix||new o.Matrix4,I=new o.Matrix4,R=T.rc,x=T.redundancy;0!==R||x||(v.onMoveBegin({objectsMoved:h,from:S,moveMode:"Persistent"}),h.forEach((function(e){v.onMove({objectsMoved:[{path:e.pathElement}],from:S,worldMatrix:I.multiplyMatrices(y,e.pathElement.getWorldMatrix())})}),S),v.onMoveEnd({from:S,status:"Moved"}),f.setProductAxisForConstraint(d))}c.executionContext?C.forEach((function(e){let t=c.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent);t&&t.setRadioItemState({id:e,radioId:"CATC3DSwitchAxisHdr",state:!1})})):C.forEach((function(e){t.getCommandCheckHeader(e,u.getCommandContext?u.getCommandContext():null).setState(!1)})),e&&e()},S.clean=function(e,t){!u&&t?u=t.executionContext.getComponent("Viewer"):u||t||(u=i.get()),e&&e()},S})),define("DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/WebappsUtils/WebappsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DUtils/CATC3DAxisSystemDisplayAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DUtils/CATW3DUtils"],(function(e,t,n,i,o,a,r,s,c){"use strict";var l={};require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],(function(e){l.point=e.point,l.center=e.center,l.axisSystem=e.axisSystem,l.line=e.line,l.plane=e.plane,l.cylinder=e.cylinder,l.surface=e.surface,l.product=e.product}));var u,d,C=i.getWebappsAssetUrl("DMUMeasure","icons/32/"),m=i.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),S=e.extend({init:function(e){var i,S,g,p,E,A,f,v,D=e.context,h=!0,T=D.getViewer(),y={none:0,point:0,center:0,axisSystem:1,line:0,plane:1,cylinder:1,surface:0,product:1},I=localStorage.getItem("C3DSelectionFilter"),R=new a({context:D}),x=function(){y={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},E.getActiveState("point")&&(y.none=0,y.point=1),E.getActiveState("center")&&(y.none=0,y.center=1),E.getActiveState("axisSystem")&&(y.none=0,y.axisSystem=1),E.getActiveState("line")&&(y.none=0,y.line=1),E.getActiveState("plane")&&(y.none=0,y.plane=1),E.getActiveState("cylinder")&&(y.none=0,y.cylinder=1),E.getActiveState("surface")&&(y.none=0,y.surface=1),E.getActiveState("product")&&(y.none=0,y.product=1);var e="1-"+y.point+y.center+y.axisSystem+y.line+y.plane+y.cylinder+y.surface+y.product+"-"+(h?1:0);localStorage.setItem("C3DSelectionFilter",e),y.axisSystem?R.activate():R.deactivate()},b=function(){var e;function t(t){if(!t)return e=!1,void(E&&E.setVisibleFlag(!1));var n;e=!0,h?E?E.setVisibleFlag(!0):(n=function(){(E=new u({body:D.getFrameWindow().getUIFrame(),frmWindow:D.getFrameWindow(),Idpanel:"c3dSelectionFilter",classpanel:"c3dSelectionFilter",typeSeparator:"bubble",verticalPanel:!0,lJsonElement:[{type:"element",id:"point",nls:l.point,url:C+"I_Meas_Point.png",callback:x,bexclude:!1,bstateActif:y.point},{type:"element",id:"center",nls:l.center,url:C+"I_Meas_PointCircle.png",callback:x,bexclude:!1,bstateActif:y.center},{type:"element",id:"axisSystem",nls:l.axisSystem,url:m+"I_3DComposeAxisSystem.png",callback:x,bexclude:!1,bstateActif:y.axisSystem},{type:"element",id:"line",nls:l.line,url:C+"I_Meas_Line.png",callback:x,bexclude:!1,bstateActif:y.line},{type:"element",id:"plane",nls:l.plane,url:C+"I_Meas_Plane.png",callback:x,bexclude:!1,bstateActif:y.plane},{type:"element",id:"cylinder",nls:l.cylinder,url:C+"I_Meas_Cylinder.png",callback:x,bexclude:!1,bstateActif:y.cylinder},{type:"element",id:"surface",nls:l.surface,url:C+"I_Meas_Surface.png",callback:x,bexclude:!1,bstateActif:y.surface},{type:"element",id:"product",nls:l.product,url:C+"I_Meas_Product.png",callback:x,bexclude:!1,bstateActif:y.product}]})).build();var t=document.querySelector(".c3dSelectionFilter");t&&(t.style.position="absolute"),E.setVisibleFlag(!1),e&&h&&E.setVisibleFlag(!0)},u?n():d||(d=!0,require(["DS/Web3DUXFilterBar/Web3DUXFilterBar"],(function(e){d=!1,u=e,n()})))):E&&E.setVisibleFlag(!1)}return function(){t(!!A&&(D&&o.getRoots(D).length>0))}}();if(I&&I.length>8){var P=2,M=parseInt(I.split("-")[0]);y.point="1"===I.charAt(P++)?1:0,y.center="1"===I.charAt(P++)?1:0,y.axisSystem="1"===I.charAt(P++)?1:0,y.line="1"===I.charAt(P++)?1:0,y.plane="1"===I.charAt(P++)?1:0,y.cylinder="1"===I.charAt(P++)?1:0,M&&(y.surface="1"===I.charAt(P++)?1:0),y.product="1"===I.charAt(P++)?1:0,y.point||y.center||y.axisSystem||y.line||y.plane||y.cylinder||y.surface||y.product||(y.none=1),I.length>P&&"-"===I.charAt(P++)&&(h="1"===I.charAt(P))}function N(e){var n=e.pathElement;return e.pathElement=new t,n.externalPath.some((function(t){return e.pathElement.addElement(t),t&&o.is3DLeaf(t)})),n.internalPath.length>0&&(e.originalPathElement=n),e}function w(e){if(!(e&&e.pathElement&&e.pathElement.externalPath.length&&o.isAModelPath(e.pathElement)))return e;if(!A||y.none)return N(e);if(y.axisSystem||y.point||y.center||y.line||y.plane||y.cylinder||y.surface){var t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:T,nonCanonicGeometry:Boolean(y.surface)}),n=t?t.getType():null;if(y.axisSystem&&n===s.GeometryType.AXISSYSTEM)return e.originalPathElement=e.pathElement,e.pathElement=t.getPathElement(),e.equivalentGeometry=t,e;if(y.point&&n===s.GeometryType.POINT||y.center&&(n===s.GeometryType.CIRCLE||n===s.GeometryType.SPHERE)||y.line&&n===s.GeometryType.LINE||y.plane&&(n===s.GeometryType.PLANE||n===s.GeometryType.REFPLANE)||y.cylinder&&(n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE)||y.surface&&n===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e;if(y.surface&&(n===s.GeometryType.PLANE||n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE||n===s.GeometryType.SPHERE)&&(n=(t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:T,canonicGeometry:!1,nonCanonicGeometry:!0}))?t.getType():null)===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e}if(y.surface){for(var i,a=e.pathElement.externalPath.length-1;a>=0&&!i;a--)o.isRepReference(e.pathElement.externalPath[a])&&(i=e.pathElement.externalPath[a]);if(i&&!D.getController().hasMeshInRAM(o.getNodeID(i)))return N(e)}return y.product?N(e):(e.originalPathElement=e.pathElement,e.pathElement=null,e)}function L(e){Array.isArray(e)?e.forEach(w):w(e)}function F(){return{point:y.point,center:y.center,line:y.line,axisSystem:y.axisSystem,plane:y.plane,cylinder:y.cylinder,surface:y.surface,product:y.product}}function _(e){S&&S.cancel&&S.cancel(),S=null,e&&e.pickingResult&&e.pickingResult.path&&e.pickingResult.path.length&&(S=c.switchToAV1withMesh({pathElement:e.pickingResult.path[0],pad3DViewer:D,selectionFilter:F(),onComplete:function(){S=null},onFailure:function(){S=null}}))}function U(){if(A){var e=D.getViewer();e.setPicking(p),e.setPrePicking({primitive:g}),i&&e.unsubscribe(i),i=null,n.unsubscribe(A),D.unsubscribe(f),D.unsubscribe(v),A=f=v=null,b(),R.deactivate()}}this.filter={activate:function(e){if(!A){var t=D.getViewer();p={primitive:t.picking.primitive,trapSelection:t.picking.trapSelection,trapPrimitive:t.picking.trapPrimitive,trapGPU:t.picking.trapGPU},g=t.pPicking.primitive,t.setPicking({primitive:1,trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),t.setPrePicking({primitive:1}),e&&e.switchToAV1withMesh&&(i=t.onPreactivate(_)),A=n.onPreAdd(L),f=D.subscribe({event:"onRootAdded"},b),v=D.subscribe({event:"onRootRemoved"},b),b(),y.axisSystem&&R.activate()}},deactivate:U,isActive:function(){return Boolean(A)},display:function(e){"boolean"==typeof e&&e!==h&&(h=e,b())},filterPath:w,switchToAV1withMesh:_,getFiltersState:F},Object.freeze(this.filter),this.unreference=function(){U(),E&&E.clear(),R=E=D=null}}}),g=[];return e.singleton({init:function(){},giveDefaultSelectionFilter:function(e){var t,n;return n=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===n&&g.some((function(n){return n.context===e.context&&(t=n.mng.filter,!0)})),t},getDefaultSelectionFilter:function(e){var t,n;if(n=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===n&&(g.some((function(n){return n.context===e.context&&(t=n.mng.filter,!0)})),!t)){var i=new S({context:e.context});g.push({context:e.context,mng:i}),t=i.filter}return t},unreferenceDefaultSelectionFilter:function(e){e&&e.context&&g.some((function(t,n){return t.context===e.context&&(t.mng.unreference(),g.splice(n,1),!0)}))}})})),define("DS/CAT3DComposeCommands/CAT3DComposeMoveCmd",["DS/CATWebUXComponents/DMUCommand","DS/Visualization/SceneGraphUtils","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATW3DBoxes/CATW3DBoxController","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DCommands/CATW3DCmdsUtils","DS/CATW3DCommands/CATW3DMoveBarUX","DS/CoreEvents/Events"],(function(e,t,n,i,o,a,r,s,c,l,u,d,C){"use strict";var m,S,g,p,E;require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],(function(e){m=e.PositionModifiedSaveOK,S=e.PositionModifiedSaveKO,g=e.singleSplitInstance,p=e.multipleSplitInstance})),require(["DS/Selection/CSOManager"],(function(e){E=e}));var A,f=e.extend({init:function(f){this._parent(f,{mode:"exclusive",isAsynchronous:!0});var v,D,h,T,y,I,R,x,b,P=this,M=!0,N=!1,w=c.get(),L=w.getCommandContext(),F=l.getMoveManager({context:w}),_=r.getExamineController({context:w}),U=i.getDefaultSelectionFilter({context:w}),O=function(){N=!0,M=!1,F.terminateMove({save:!1}),w.getExecutionContext?P.cancelExecute():P.cancel()},W=function(){N=!0,M=!1,F.terminateMove({save:!0}),w.getExecutionContext?P.cancelExecute():P.cancel()},G=function(){F.cancelLocked()},k=function(e){var n="success"===e.eventID&&e.objectsMoved.length>0?m:"error"===e.eventID&&e.objectsCancelled.length>0?S:null;n&&w.displayNotification({eventID:e.eventID,msg:n});var i=o.getAnimation3DEngine({viewer:w.getViewer()});if(e&&e.splitInstances&&e.splitInstances.length){w.displayNotification({eventID:"info",msg:e.splitInstances.length>1?p:g});var a=[],r=w.getController(),s=w.getRootBagPath().getLastElement(!0);if(e.splitInstances.forEach((function(e){a=a.concat(t.buildPathesLeadingToNode(r.getNode({id:e.newId}),s).map((function(e){return{path:e}})))})),i.addAnimation({animationType:"opacityOnOff",objectListToAnimate:a,duration:1e3,createOverrideSet:!0}),i.addAnimation({animationType:"color",objectListToAnimate:a,duration:1e3,createOverrideSet:!0,color:"#ff821e"}),E){var c=E.get();c.length&&E.empty(),a.length&&E.add(a.map((function(e){return{pathElement:e.path}}))),c.length&&E.empty(),E.add(c)}}e.objectsCancelled&&e.objectsCancelled.length>0&&i.addAnimation({animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout((function(){h.begin()}),0)},createOverrideSet:!0}),i.startAnimation(),N&&(F.unsubscribe(R),F.unsubscribe(x))},X=function(e){if(v&&!0===e.bEmptyMove?(v.hideSave(),v.hideLock()):v&&!e.someMovedObjectsAreLocked&&v.hideLock(),e.objectsCancelled&&e.objectsCancelled.length>0){var t=o.getAnimation3DEngine({viewer:w.getViewer()}),n={animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout((function(){}),0)},createOverrideSet:!0};t.addAnimation(n),t.startAnimation()}else w.getViewer().render();N&&(F.unsubscribe(R),F.unsubscribe(x))},V=function(e){"Enter"!==e.key&&13!==e.keyCode||!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey&&(W(),document.removeEventListener("keydown",V))};y=F.subscribe("Move",(function(e){v||(v=new d({uiFrame:w.getFrameWindow().getUIFrame(),onSave:W,onCancel:O,onCancelLocked:G})),e.objectsMoved.length>0&&"Persistent"===e.moveMode&&e.objectsMoved.forEach((function(e){var t=e.path.getLastElement(!0);u.isPLMInstanceNode(t)&&(v.showSpinner(),F.isPathLocked({pathElement:e.path,onCompleted:function(e){v&&(v.hideSpinner(),e.isLocked?v.showLock():v.showSave())}}))}))})),A||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){A=e,P.isRunning()&&A.activate({context:w,withSnap:!0,selectionFilter:U})})),this.beginExecute=function(){T=F.subscribe("MoveBegin",(function(){_&&_.setActiveState(!1);var e=n.give3DGridController({context:w});e&&e.hide3DGrids()})),I=F.subscribe("MoveEnd",(function(){if(P.isRunning()){var e=a.getBoxController({context:w});e&&e.setActiveState(!0),_&&_.setActiveState(!0);var t=n.give3DGridController({context:w});t&&t.display3DGrids()}})),D||(D=new s({context:w})),h||(h=new e({ID:"CAT3DComposeFakeMoveHdr",mode:"shared",isAsynchronous:!1,context:L})),M=!0,N=!1,document.querySelector(".c3dMoveCmdDlg")||(v=new d({uiFrame:w.getFrameWindow().getUIFrame(),onSave:W,onCancel:O,onCancelLocked:G})),v&&v.show(),w.getExecutionContext&&C.publish({event:"onNotifAgentDisplayed",data:{notifAgent:v}}),D.activate();var t=a.getBoxController({context:w});t&&t.setActiveState(!F.isMoving());var i=n.give3DGridController({context:w});i&&i[F.isMoving()?"hide3DGrids":"display3DGrids"](),_&&_.setActiveState(!0),A&&A.activate({context:w,withSnap:!0,selectionFilter:U}),U.activate({switchToAV1withMesh:!0}),document.addEventListener("keydown",V),R=F.subscribe("onValidateMove",k),x=F.subscribe("onCancelMove",X),b=C.subscribe({event:P.getId()+"/CANCEL"},(()=>{P.cancelExecute()}))},this.cancelExecute=function(){document.removeEventListener("keydown",V),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(e){e._sendUsageProbe("command",M?"MoveCancel":"MoveOK")})),M&&(N=!0,F.terminateMove({save:!1})),v&&v.destroy(),v=null,D.deactivate(),U&&U.deactivate();var e=a.getBoxController({context:w});e&&e.setActiveState(!1),_&&_.setActiveState(!1),w.getFrameWindow().getContextualUIManager().hideContextualMenus(),A&&A.deactivate({context:w}),w.getExecutionContext&&C.publish({event:"onCommandStart/BEGIN",data:{_id:w.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getDefaultCommand()}}),this.done()},this.pauseExecute=function(){var e=a.getBoxController({context:w});e&&e.setActiveState(!1),v&&v.hide(),D.deactivate(),U.deactivate(),_&&_.setActiveState(!1),A&&A.deactivate({context:w}),document.removeEventListener("keydown",V),this.done()},this.resumeExecute=function(){var e=a.getBoxController({context:w});e&&e.setActiveState(!0),v&&v.show(),D.activate(),U.activate({switchToAV1withMesh:!0}),_&&_.setActiveState(!0),A&&A.activate({context:w,withSnap:!0,selectionFilter:U}),document.addEventListener("keydown",V),this.done()},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){Object.getPrototypeOf(this)._destroy.apply(this,arguments),F.unsubscribe(T),F.unsubscribe(y),F.unsubscribe(I),F.unsubscribe(R),F.unsubscribe(x),C.unsubscribe(b),A&&A.unreference({context:w}),w=F=D=v=R=x=T=y=I=P=null}}});return f})),define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmdV2",["DS/CATW3DBoxes/CATW3DBoxController","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUFrameWindow","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DRobot/CATW3DRobot","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,o,a,r,s,c,l,u,d,C,m){"use strict";let S;return class{constructor(g){var p=this,E=!1,A=g.executionContext,f=A?A.getComponent("Viewer"):a.get();r.init(f,{executionContext:A});let v,D,h=new o({context:f}),T=e.getBoxController({context:f}),y=m.getExamineController({context:f}),I=s.getMoveManager({context:f,saveToDatabase:!!A||void 0}),R=C.getSelectionManager({context:f}),x=c.getDefaultSelectionFilter({context:f}),b=l.getMove3DRobot({context:f}),P=[],M=[],N={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},w={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3},L=!0;function F(){if(p.isRunning()){var e=t.give3DGridController({context:f});e&&e.hide3DGrids(),p&&p.isRunning()&&(x&&x.activate(),R&&R.setActiveState(!1)),T&&T.setActiveState(!1)}}function _(){if(p.isRunning()){var e=t.give3DGridController({context:f});e&&e.display3DGrids(),p&&p.isRunning()&&x&&!b.hasTarget()&&(x.deactivate(),R&&R.setActiveState(!0)),T&&T.setActiveState(!0)}}S||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){S=e,p.isRunning()&&(S.activate({context:f,withSnap:!0,selectionFilter:x}),S.give().setAllowManipulation(L),M.length||(M.push(S.subscribe("onDirectMoveBegin",F)),M.push(S.subscribe("onDirectMoveEnd",_))))})),b.setSelectionFilter(x),P.push(b.subscribe("onRobotMoveBegin",(function(){p.isRunning()&&(p&&p.isRunning()&&(x&&x.activate(),R&&R.setActiveState(!1)),T&&T.setActiveState(!1))}))),P.push(b.subscribe("onRobotMoveEnd",_));var U=[];function O(){U.length>0||(U.push(I.subscribe("MoveBegin",(function(){y&&y.setActiveState(!1)}))),U.push(I.subscribe("Move",(function(){var e=i.giveDataLauncherController({context:f});e&&e.setVisibility(!1)}))),U.push(I.subscribe("MoveEnd",(function(){var e=i.giveDataLauncherController({context:f});e&&e.setVisibility(!0),y&&y.setActiveState(!0)}))))}function W(){U.forEach((function(e){I.unsubscribe(e)})),f.unsubscribe(v),f.unsubscribe(D),U=[],v=D=void 0}var G=u.getPreferenceManager({context:f.getFrameWindow()}),k=[];function X(e){p&&e.forEach((function(e){if("W3MprefMove"===e.name)e.preferences.forEach((function(e){if("C3DAllowDirectManipulation"===e.name){let t=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),n=f.getController&&f.getController().hasAnyEffectiveFlexibleAssembly(),i=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration");L=!(t&&n&&i)&&"true"===e.value,S&&S.give().setAllowManipulation(L)}else"defaultMoveReferent"===e.name&&(n.setMoveReferentDefault(e.value),T&&T.refreshBoxes(!0))}));else if("FrameGeneral"===e.name)e.preferences.forEach((function(e){if("ProjectionType"===e.name){var t="Perspective"===e.value?0:1;let n=f?f.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.setProjectionType(t)}}));else if("VisualizationRepository"===e.name)e.preferences.forEach((function(e){if("Gravity"===e.name){var t="true"===e.value;let n=f?f.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.control&&(n.currentViewpoint.getControl().setRotationRolling(!t),n.currentViewpoint.getControl().setRollingForTouchAvailable(!t))}}));else if("SelectionRepository"===e.name)e.preferences.forEach((function(e){if("Select3DGeometry"===e.name){var t=!!x&&x.isActive();t&&x.deactivate(),R.setPicking("true"===e.value?0:1),t&&x.activate()}else"SelectParentReferenceOr3DShape"===e.name&&R&&R.selectParentReference("select3DShape"!==e.value)}));else if("cke"===e.name){let t=!1,n=!1;e.preferences.forEach((function(e){"Length"===e.name?(N.unit=e.value,t=!0):"LengthCalcDisplay"===e.name?(N.decimalPlaceRO=parseInt(e.value),t=!0):"Angle"===e.name?(w.unit=e.value,n=!0):"AngleCalcDisplay"===e.name&&(w.decimalPlaceRO=parseInt(e.value),n=!0)})),t&&b.setLengthUnit(N),n&&b.setAngleUnit(w)}}))}G.addPreferences(n.getPreferencesDefinition()),G.setUnitsPreferencesDisplayFlag(!0),G.setDisplayPreferencesDisplayFlag(!0),G.set3DSelectionPreferencesDisplayFlag(!0),G.setMeasurePreferencesDisplayFlag(!0),G.setClippingPreferencesDisplayFlag(!0),G.setPreferredPreferenceContainersOrder(["W3MprefMove","MeasurePreferences","SectionPreferences"]),k.push(G.subscribe("com.ds.mep:onPrefUpdate",(function(e){X(JSON.parse(e[1].preferences).repositories)}))),f.getViewer().currentViewpoint.getControl().setRotationRolling(!0),f.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!0),R.setPicking(1),R.selectParentReference(!1);function V(){if(!f)return;let e=f.getRoots(),t=A.getComponent(WAfrStandardComponentKey.HandlerComponent);t.hasHandler("CATC3DNavigationStartHdr")&&(e.length?t.enableHandler("CATC3DNavigationStartHdr"):t.disableHandler("CATC3DNavigationStartHdr"))}d.readPreferences([{Repository:"W3MprefMove",PreferenceNames:["C3DAllowDirectManipulation","defaultMoveReferent"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]},{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Angle","AngleCalcDisplay"]}]).then((function(e){X(e.repositories)})).catch((function(e){window.console.warn("Error Preferences ",e)})),this.beginExecute=function(){f&&(v=f.subscribe({event:"onRootAdded"},(function(){V()})),D=f.subscribe({event:"onRootRemoved"},(function(){V()})),V(),R.setActiveState(!0),f.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),function(){if(f&&!E){h.activate(),T.setActiveState(!0);var e=i.giveDataLauncherController({context:f});e&&e.setActiveState(!0),S&&S.activate({context:f,withSnap:!0,selectionFilter:x}),y&&y.setActiveState(!0),O()}}())},this.destroy=function(){if(f){h.deactivate(),T.setActiveState(!1);var e=i.giveDataLauncherController({context:f});e&&e.setActiveState(!1),S&&S.deactivate({context:f}),R.setActiveState(!1),y&&y.setActiveState(!1),W()}},this.pauseExecute=function(){h.deactivate(),T.setActiveState(!1);var e=i.giveDataLauncherController({context:f});e&&e.setActiveState(!1),S&&S.deactivate({context:f}),x&&x.deactivate(),R.setActiveState(!1),y&&y.setActiveState(!1),W(),this.done()},this.resumeExecute=function(){if(f){x&&b.hasTarget()?(x.activate(),R.setActiveState(!1)):R.setActiveState(!0),f.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),h.activate(),T.setActiveState(!0);var e=i.giveDataLauncherController({context:f});e&&e.setActiveState(!0),S&&S.activate({context:f,withSnap:!0,selectionFilter:x}),y&&y.setActiveState(!0),O(),this.done()}},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this.isRunning=function(){let e,t,n;return e=f.getExecutionContext?f.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent):void 0,e&&(n=e.getDefaultCommand(),t=null===e.getRunningCommand()?n:e.getRunningCommand()),t===n},this._destroy=function(){W(),P.forEach(b.unsubscribe,b),M.forEach(b.unsubscribe,M),S&&(M.forEach(S.unsubscribe,M),S.unreference({context:f})),E=!0,k.forEach(G.unsubscribe,G),c.unreferenceDefaultSelectionFilter({context:f}),C.unreferenceSelectionManager({context:f}),m.unregisterExamineController({context:f}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),p=x=f=h=T=I=b=G=k=R=null}}}})),define("DS/CAT3DComposeCommands/CAT3DComposeExamineSelection",["UWA/Core","DS/CATWebUXComponents/DMUCommand","DS/CATWebUXComponents/DMUCommandsManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/CATW3DAnims/CATW3DAnimation3D","DS/PADUtils/PADContext","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/LevelSelector/LevelSelector","DS/CATW3DCommands/CATW3DCmdsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/CoreEvents/Events","css!DS/CAT3DComposeUI/CAT3DComposeUI.css"],(function(e,t,n,i,o,a,r,s,c,l,u,d,C,m,S,g,p,E,A){"use strict";var f=Math.PI/4;let v=!1;function D(e){var t,n,i,o=e&&e.externalPath.length>1;for(t=0;o&&t<e.externalPath.length-1;++t)n=e.externalPath[t],i=e.externalPath[t+1],n.children.indexOf(i)<0&&(o=!1);return o}var h=function(){var e,t,n,i,o,a;this.store=function(s,c){e=t=n=i=o=a=void 0;var l=c?(new r.Matrix4).extractRotation(c):null;e=s.getEyePosition(),c&&e.applyMatrix4(c),t=s.getUpDirection(),l&&t.applyMatrix4(l),n=s.getSightDirection(),l&&n.applyMatrix4(l),i=s.getTargetDistance(),o=s.getProjectionType(),a=s.getAngle()},this.restore=function(s,c){if(e){var l=c?(new r.Matrix4).extractRotation(c):null;s.moveTo({eyePosition:c?e.applyMatrix4(c):e,upDirection:l?t.applyMatrix4(l):t,sightDirection:l?n.applyMatrix4(l):n,distanceToTarget:i}),s.setProjectionType(o),s.setAngle(a)}}};h.prototype={constructor:h},Object.freeze(h);var T,y,I=t.extend({init:function(t){this._parent(t,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1);var I,R,x,b,P,M,N,w,L,F,_,U,O,W,G,k=this,X=c.get(),V=X.getViewer(),Y=X.getController(),B=V.getSceneGraphOverrideSetManager(),H=C.giveMoveManager({context:X}),j=[],q=[],K={},z=d.getMoveReferentManager({context:X}),J=E.getExamineController({context:X});function Z(){j.some((function(e){return"boolean"!=typeof B.getCurrentVisibility(e.path)}))&&(X.getExecutionContext&&k.cancelExecute(),k.cancel())}function Q(){I=null}function $(e){if(e&&e.from&&e.from.some((function(e){return e.view.id===V.canvas.id}))){var t=e.gesture?e.gesture.getEvents()[0]:e.from[0];if(t&&t.event&&0===t.event.button&&0===t.event.buttons){var n=V.pick(V.getMousePosition(t.getCurrentPosition(V.canvas)),"mesh",!1);n&&n.path&&0!==n.path.length||(Q(),X.getExecutionContext&&k.cancelExecute(),k.cancel())}}}require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],(function(e){G=e})),T||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){if(T=e,k.isRunning()){var t=p.giveDefaultSelectionFilter({context:X});t&&T.activate({context:X,withSnap:!0,selectionFilter:t})}})),y||require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],(function(e){y=e}));var ee,te=function(){var e=X.getFrameWindow().getViewpoint(),t=new r.Matrix4,n=e.getUpDirection(),i=e.getSightDirection();this.className.search("right")>=0?t.makeRotationAxis(n,f):this.className.search("left")>=0?t.makeRotationAxis(n,-f):this.className.search("top")>=0?t.makeRotationAxis(i.cross(n),-f):t.makeRotationAxis(i.cross(n),f),j.forEach((function(e){e.matrixRotation=t})),x.addAnimation({animationType:"rotate",objectListToAnimate:j.filter((function(e){return e.rotate})),callBackFct:function(){j.forEach((function(e){e.matrixSource=e.override.getPosition()}))}}),x.startAnimation()},ne=function(e,t,n,i){var o=[];if(e){var a=e.getKey();-1!==n.indexOf(a)||!0===i.getCurrentVisibilityFree(e)&&!i.getCurrentVisibility(e)||(t.some((function(t){return e.isAParentOf(t)}))?e.getChildrenPathes().forEach((function(e){o=o.concat(ne(e,t,n,i))})):o.push(e))}return o},ie=(ee=new r.Color,function(){return ee.set(V.backgroundColor),255*ee.getHSL().l>120?"black":"white"});function oe(){var e=60*Math.sqrt(2),t=48,n=X.getViewer(),i=n.SCREEN_WIDTH,o=n.SCREEN_HEIGHT,a=i/2,r=o/2;K.main.setStyles({top:r+"px",left:a+"px"}),document.querySelector(".c3dSelectionFilter")&&(t=document.querySelector(".c3dSelectionFilter").getSize().width),K.right.setStyle("left",a-e-t-10+"px"),K.left.setStyle("left",-1*a+e+10+"px"),K.top.setStyle("top",-1*r+e+10+"px");var s=X.getExecutionContext?document.querySelector(".WAfrPageObjectUseOnly-WAfr-Actionbar").offsetHeight+2:"true"===X.getFrameWindow().getActionBar().elements.container.getAttribute("data-open")?73:30;K.bottom.setStyle("top",r-e-s+"px");var c=setInterval((function(){K.main&&!document.querySelector(".c3dSelectionFilter")||(K.main&&(t=document.querySelector(".c3dSelectionFilter").getSize().width,K.right.setStyle("left",a-e-t-10+"px")),clearInterval(c))}),10)}function ae(e){var t;x.forward(),"ArrowLeft"===e.key||37===e.keyCode?t=K.left:"ArrowUp"===e.key||38===e.keyCode?t=K.top:"ArrowRight"===e.key||39===e.keyCode?t=K.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=K.bottom),t&&(t.addClassName("active"),te.call(t))}function re(e){var t;"ArrowLeft"===e.key||37===e.keyCode?t=K.left:"ArrowUp"===e.key||38===e.keyCode?t=K.top:"ArrowRight"===e.key||39===e.keyCode?t=K.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=K.bottom),t&&t.removeClassName("active")}function se(){j.length&&(U||(U=new u(j[0].path.externalPath)),D(U)?(W=new h).store(X.getFrameWindow().getViewpoint(),(new r.Matrix4).getInverse(U.getWorldMatrix())):U=W=null)}function ce(e){J&&J.setActiveState(!1);var t=p.giveDefaultSelectionFilter({context:X});t&&(T&&!e&&T.deactivate({context:X}),e||t.deactivate()),X.setRobotVisibility(R),G&&window.widget&&"true"===window.widget.getValue("changeControlActivation")&&G.show(),a.removeEvent(V.canvas,"onPrimaryPointerClick",$),w&&(H.unsubscribe(w),w=void 0),!e&&N&&(H.unsubscribe(N),N=void 0),q.forEach((function(e){X.unsubscribe(e)})),q=[],m.destroyView(),K.main&&K.main.hide(),L&&X.getViewer().unsubscribe(L);var n=X.getFrameWindow().getActionBar();F&&n.removeCallback(F),_&&n.removeCallback(_),L=F=_=void 0,document.removeEventListener("keydown",ae),document.removeEventListener("keyup",re)}function le(){se(),j=[],Q(),ce(!0);var e=X.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(b),b=P=null,e.render(),O.restore(X.getFrameWindow().getViewpoint())}function ue(){J&&J.setActiveState(!0);var e=p.giveDefaultSelectionFilter({context:X});if(e&&T&&y&&!y.isNavigationActivated({context:X})&&T.activate({context:X,withSnap:!0,selectionFilter:e}),e&&e.activate({switchToAV1withMesh:!0}),X.getFrameWindow().getContextualUIManager().hideContextualMenus(),R=X.isRobotVisible(),X.setRobotVisibility(!1),G&&G.hide(),a.addEvent(V.canvas,"onPrimaryPointerClick",$),w=H.subscribe("Move",le),N=H.subscribe("MoveEnd",(function(){X.getExecutionContext&&k.cancelExecute(),k.cancel()})),["onRootRemoved","onRootDetached","onAuthoringTransactionEnd","onEndDelete"].forEach((function(e){q.push(X.subscribe({event:e},Z))})),function(e){if(e){var t,n=z.getMoveReferent(e)||e,a=n.getLastElement(!0);if(S.isPLMInstanceNode(a)){a&&a.children.length&&n.addElement(a.children[0]);var r={display:{type:"docked",marginW:10,marginH:10},background:V,disableKeyboard:!0,displayWhileViewpointIsManipulated:!0,uiFrame:X.getFrameWindow().getUIFrame(),getLevels:function(t){var i=S.getLevelSelectorLevels({pathElement:e,pathElementCurrent:n,onInfoCompleted:t,context:X});if(i){i.selectColor="#ff821e",i.selectOverColor="#ffb477";for(var o=i.levels.length-1;o>=0;--o){var a=i.levels[o];S.isPLMReferenceNode(a.pathElement.getLastElement(!0))&&z.getMoveReferent(a.pathElement)||(a.selection="notSelectable")}}return i},onHover:function(e){P&&(P.setColor(ie(),!1),P.setOpacity(.05,!1),P.setVisibility(!0),P.setVisibilityFree(null)),(t=b.createOverride({pathes:[n]})).setColor(16744448,!0),t.setOpacity(1,!0),V.render(),i.empty(),i.add(e)},onLeave:function(){P&&(P.setColor(null,null),P.setOpacity(null,null),P.setVisibility(!1),P.setVisibilityFree(!0)),b.deleteOverride(t),t=null,V.render(),i.empty(),i.add(o.get())},onSelect:function(i){if(i&&i.pathElement&&z){if(z.addMoveReferent(i.pathElement),b.deleteOverride(t),t=null,!(n=z.getMoveReferent(e)))return;(a=n.getLastElement(!0))&&a.children.length&&n.addElement(a.children[0]),(t=b.createOverride({pathes:[n]})).setColor(16744448,!0),t.setOpacity(1,!0),V.render()}}};m.createView(r)}}}(1===j.length?j[0].path:null),K.main.show(),oe(),L=V.onViewerResize(oe),!X.getExecutionContext){var t=X.getFrameWindow().getActionBar();F=t.onActionBarOpen(oe),_=t.onActionBarClose(oe)}document.addEventListener("keydown",ae),document.addEventListener("keyup",re)}this.beginExecute=function(){if((M=g.getRoots(X).map(g.getNodeID,g).some(Y.isLargeDataStructure,Y))&&Y.pauseProgressiveLoading(),(O=new h).store(X.getFrameWindow().getViewpoint()),X.getExecutionContext||X.getFrameWindow().getActionBar().close(),x=s.getAnimation3DEngine({viewer:V}),j=[],b=new l(X.getRootBagPath().externalPath[0]),B.pushSceneGraphOverrideSet(b),X.getExecutionContext){A.subscribe({event:k.getId()+"/CANCEL"},(()=>{k.cancelExecute()}));let e=n.getCommandCheckHeader("CATRelatedData3DGridHdr");e&&e.getState()&&(e.setState(!1),e.disable(),v=!0)}var t=[],a=[],c=new r.Box3,d=V.getVisibleSpace();if(I=[],o.get().forEach((function(e){I.push(e);for(var n=new u(e.pathElement.externalPath);n&&!S.isPLMNode(n.getLastElement(!0));)n=n.getParentPath();if(n&&n.externalPath.length&&(!1===B.getCurrentVisibilityFree(n)||"boolean"==typeof B.getCurrentVisibility(n))){var i=n.getParentPath().getWorldMatrix(),o=(new r.Matrix4).getInverse(i),s=n.getMatrix(),l={path:n,override:b.createOverride({pathes:[n]}),matrixSource:s,matrixParent:i,matrixParentInv:o,rotate:!0},C=d?n.getBoundingBox(null,V,"visibleSpace"):n.getBoundingBox(null,V,"invisibleSpace");C&&!C.isNaN()?(C.applyMatrix4(n.getWorldMatrix()),c.union(C)):l.rotate=!1,j.push(l),t.push(n),a.push(n.getKey())}})),t.length>0){var C=c.center();j.forEach((function(e){e.centerRotation=(new r.Vector3).copy(C).applyMatrix4(e.matrixParentInv)}));var m=!1;U&&(U.isEqual(new u(t[0].externalPath))&&D(U)||(W=U=null)),W||(m=!0);var p=ne(X.getRootBagPath(),t,a,B);P=b.createOverride({pathes:p}),x.addAnimation({animationType:"mask",objectListToAnimate:[{override:P}],callBackFct:function(){m?X.getFrameWindow().getViewpoint().reframe(null,0,c.getBoundingSphere()):W&&(W.restore(X.getFrameWindow().getViewpoint(),U.getWorldMatrix()),W=null)}}),x.startAnimation();K.main=e.createElement("div",{id:"C3D-viewpoint"}).inject(X.getFrameWindow().getUIFrame()),["left","top","right","bottom"].forEach((function(t){var n=new e.createElement("div",{class:t}).inject(K.main);n.addEvents({click:te}),new e.createElement("div",{class:"background"}).inject(n);var i=new e.createElement("div",{class:"arrow"}).inject(n);new e.createElement("div",{class:"borderBottom"}).inject(i),new e.createElement("div",{class:"borderRight"}).inject(i),K[t]=n})),ue(),i.empty(),o.empty(),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(e){e._sendUsageProbe("command","ExamineSelection")}))}else X.getExecutionContext&&k.cancelExecute(),k.cancel()},this.cancelExecute=function(){if(se(),j=[],ce(),K.main&&K.main.destroy(),K={},b){var e=X.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(b),b=P=null,e.render(),X.getExecutionContext||X.getFrameWindow().getActionBar().open(),O.restore(X.getFrameWindow().getViewpoint())}I&&I.length&&0===o.get().length&&(i.empty(),o.empty(),I.filter((function(e){return"boolean"==typeof B.getCurrentVisibility(e.pathElement)})).length&&(i.add(I),o.add(I)));Q(),M&&Y.resumeProgressiveLoading(),M=!1,this.done()},this.pauseExecute=function(){ce(!1),this.done()},this.resumeExecute=function(){ue(),i.empty(),o.empty();var e=new r.Box3,t=V.getVisibleSpace();j.forEach((function(n){var i=n.path,o=t?i.getBoundingBox(null,V,"visibleSpace"):i.getBoundingBox(null,V,"invisibleSpace");o&&!o.isNaN()?(o.applyMatrix4(i.getWorldMatrix()),e.union(o),n.rotate=!0):n.rotate=!1}));var n=e.center();j.forEach((function(e){e.centerRotation=(new r.Vector3).copy(n).applyMatrix4(e.matrixParentInv)})),this.done()},this.destroy=function(){let e=n.getCommandCheckHeader("CATRelatedData3DGridHdr");e&&v&&(e.enable(),e.setState(!0),v=!1)},this.disable(),this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){k&&(T&&T.unreference({context:X}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),k=X=Y=V=B=null)}}});return I})),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeAssemblyPatternCmd",["DS/CATWebUXComponents/DMUStateCommand","DS/CoreEvents/Events","DS/CATWebUXComponents/CATWebUXNotifBar","DS/FlagPanel/FlagPanel","DS/FlagPanel/FlagPanelEnums","DS/FlagPanel/FlagPanelManager","DS/PADUtils/PADContext","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter","DS/Selection/HSOManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUtils/CATC3DUtils","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CATW3DAnims/CATW3DAnimation3D","DS/Mesh/Mesh","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeAssemblyPatternCmd","css!DS/UIKIT/UIKIT"],(function(e,t,n,i,o,a,r,s,c,l,u,d,C,m,S,g,p,E,A,f){"use strict";return e.extend({init:function(e){var v,D,h,T,y,I,R,x,b,P,M=this,N=0,w=r.get(),L=w.getFrameWindow(),F=w.getViewer(),_=!1,U=!1,O={},W={},G="NOPATTERN",k=!0,X="LINEAR",V="LINEAR",Y={count:2,spacing:50,angle:30,reverse:!1},B={count:2,spacing:50,angle:30,reverse:!1},H={NOPATTERN:{REFERENCE:1,POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0},NOPATTERN_LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_RECTANGULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_CIRCULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1},LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},RECTANGULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},CIRCULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1}},j={NOPATTERN:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEM","AXISSYSTEMORIGIN","AXISSYSTEMAXIS","REFERENCE"],NOPATTERN_LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_RECTANGULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_CIRCULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_USERDEFINED:["POINT","CENTER","AXISSYSTEM"],LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],RECTANGULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],CIRCULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],USERDEFINED:["POINT","CENTER","AXISSYSTEM"]},q=function(e){return e===R.geometryTypesEnum.POINT||e===R.geometryTypesEnum.CIRCLE||e===R.geometryTypesEnum.AXISSYSTEM||e===R.geometryTypesEnum.AXISSYSTEMORIGIN},K=function(){var e={version:3,reuse:k,radioPattern:V,direction1:Y,direction2:B,filters:H};e.reuse=!0,localStorage.setItem("CAT3DComposeAssemblyPatternCmd",JSON.stringify(e))},z=function(e,n,i,o){var a;i=void 0===i||i,o=void 0===o||o,b.removeFlag(D[e]),D[e].destroy(),delete D[e],e!==U&&o&&delete O[e],e===T?(T=null,y&&(Y.count=B.count,Y.spacing=B.spacing,Y.reverse=B.reverse,D[y].destroy(),delete D[y],T=y,y=null)):e===y?y=null:e===_&&(n&&"NOPATTERN"===n&&(a="NOPATTERN",U&&(a=a+"_"+V),H[a]=R.getActiveFilters(),G=null),F.removeNode(I),_=null),R.object3D[0]=null,i&&t.publish({event:"C3D_UNSELECT_EVT"})},J=function(e){var t,n,i,o,a,r,s=0,c=function(e){var t,n,i={bReference:Boolean(U),bOrigin:Boolean(_),typesCount:{}};for(t in R.geometryTypesEnum)R.geometryTypesEnum.hasOwnProperty(t)&&(i.typesCount[R.geometryTypesEnum[t]]=0);for(t in O)O.hasOwnProperty(t)&&t!==_&&t!==U&&i.typesCount[O[t].type]++;return R.object3D[0]&&!O[R.object3D[0].pathElement.getKey()]&&(n=R.getSelType(R.object3D[0].pathElement),U||n!==R.geometryTypesEnum.REFERENCE?!_&&q(n)?i.bOrigin=!0:!_&&e!==x.USERDEFINED.id&&q(n)||i.typesCount[n]++:i.bReference=!0),i}(e.stateID);if(!c||!c.bReference)return!1;for(s=0,a=(o=Object.keys(c.typesCount)).length,i=e.validTypes.length,t=0;t<a;++t)if(c.typesCount[o[t]]>0){for(r=!1,n=0;n<i;++n)if(o[t]===e.validTypes[n].type.toString()&&!(e.validTypes[n].maxcount&&c.typesCount[o[t]]>e.validTypes[n].maxcount)){s+=c.typesCount[o[t]],r=!0;break}if(!r)return!1}return e.stateID===x.USERDEFINED.id&&c.bOrigin&&s++,e.stateID===x.CIRCULAR.id&&c.bOrigin&&0===s&&s++,e.validSelCount>-1&&s===e.validSelCount||-1===e.validSelCount&&s>0},Z=function(e,t,n){var i=new u.Vector3;return e.type===R.geometryTypesEnum.POINT?i.subVectors(e.canonicGeom.getPoint(),t.position):e.type===R.geometryTypesEnum.LINE?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===R.geometryTypesEnum.CIRCLE?i.subVectors(e.canonicGeom.getCenter(),t.position):e.type===R.geometryTypesEnum.CYLINDER?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===R.geometryTypesEnum.AXISSYSTEM||e.type===R.geometryTypesEnum.AXISSYSTEMORIGIN?i.subVectors(e.position,t.position):e.type===R.geometryTypesEnum.AXISSYSTEMAXIS&&(i=e.canonicGeom.getDirection()),n?i.normalize():i},Q=function(e){var t,n,i;if(!e.getParentPath)return null;for(i=(n=e.getParentPath().clone()).getLength()-1;i>=0;--i)if((t=n.externalPath[i])&&A.isReference(t))return n.setFromArray(n.externalPath.slice(0,i+1)),n;return null},$=function(e){W.hasOwnProperty(e)&&(W[e].pRefParent.getLastElement().removeChild(W[e].node),delete W[e],N--),F.render()},ee=function(){var e;if(W)for(e in W)W.hasOwnProperty(e)&&$(e)},te=function(e,t,n){var i,o,a,r,s;return a=t.clone(),(s=t.getWorldMatrix()).getInverse(s),(i=new u.Matrix4).multiplyMatrices(s,n),N++,(o=new d("PreviewNode"+N)).setMatrix(i),o.addChild(e.pathElement.getLastElement()),t.getLastElement().addChild(o),a.addElement(o),r=a.getKey(),W[r]={node:o,activated:!0,pathElement:a,pRefParent:t},r},ne=function(e,t,n){var o={position:(new u.Matrix4).setPosition(O[e].position),iconUrl:O[e].iconUrl?O[e].iconUrl:"",closeButton:!0,closeCB:function(){z(e,n)}};D[e]=new i(F,o),t&&D[e].setOffset(t),b.addFlag(D[e])},ie=function(e,n,a,r,s){var c={position:O[n].clickPos?(new u.Matrix4).setPosition(O[n].clickPos):new u.Matrix4,label:a,iconUrl:O[n].iconUrl?O[n].iconUrl:"",closeButton:!0,closeCB:function(){z(n,e)},dialogs:[{type:o.fieldsTypeEnum.INTEGER,value:r.count,suffix:f.SUFFIX_INSTANCES,fnCallback:function(e){r.count=parseInt(e),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.DOUBLE,prefix:f.PREFIX_SPACING,value:"CIRCULAR"===e?r.angle:r.spacing,suffix:"CIRCULAR"===e?"":"mm",fnCallback:function(n){"CIRCULAR"===e?r.angle=parseInt(n):r.spacing=parseInt(n),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReverseDirection.png",value:r.reverse,fnCallback:function(e){r.reverse=e,t.publish({event:"C3D_PARAMETERS_CHG"})}}]};D[n]=new i(F,c),s&&D[n].setOffset(s),b.addFlag(D[n])},oe=function(e){var n,a,r,s,c,l,d,C,m,A,v,h,P="NOPATTERN"===e?V:e,M={};for(a in D)D.hasOwnProperty(a)&&(M[a]=D[a].getOffset(),b.removeFlag(D[a]),D[a].destroy(),delete D[a]);if(I&&F.removeNode(I),U){for(l=function(){var e,t=[];for(e in x)(x[e].conditions&&J(x[e].conditions)||U&&_&&2===Object.keys(O).length&&-1!==["LINEAR","CIRCULAR","USERDEFINED"].indexOf(e))&&t.push(e);return 0===t.length&&(t=["LINEAR","CIRCULAR","USERDEFINED"]),t}(),n=[{value:P,iconUrl:x[P].iconUrl,label:f["LABEL_"+P],isdefault:!0}],c=l.length||0,s=0;s<c;++s)l[s]!==P&&n.push({value:l[s],iconUrl:x[l[s]].iconUrl,label:f["LABEL_"+l[s]]});d={position:O[U].clickPos?(new u.Matrix4).setPosition(O[U].clickPos):(new u.Matrix4).setPosition(O[U].position),label:f.FLAG_REF_LABEL,iconUrl:O[U].iconUrl?O[U].iconUrl:"",closeButton:!0,closeCB:function(){b.removeFlag(D[U+"ref"]),D[U+"ref"].destroy(),delete D[U+"ref"],U!==_&&delete O[U],"NOPATTERN"===e&&(C="NOPATTERN",U&&(C=C+"_"+V),H[C]=R.getActiveFilters(),G=null),U=null,R.object3D[0]=null,t.publish({event:"C3D_UNSELECT_EVT"})},dialogs:[{type:o.fieldsTypeEnum.RADIO,radios:n,fnCallback:function(e){X=V,oe(V=e),t.publish({event:"C3D_PATTERN_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReuse.png",value:k}]},D[U+"ref"]=new i(F,d),D[U+"ref"].setOffset(M[U+"ref"]),(m=D[U+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1]).style.width=0,m.style.border=0,m.style.padding=0,m.style.margin=0,b.addFlag(D[U+"ref"])}if(U&&D[U+"ref"]&&U!==_?D[U+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].removeClassName("hidden"):U&&D[U+"ref"]&&D[U+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].addClassName("hidden"),_&&e!==x.USERDEFINED.id&&P!==x.USERDEFINED.id&&(A=O[_].worldMatrix.clone().setPosition(O[_].position),v=p.getAnimation3DEngine({viewer:F}),(h=new g({headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new E.Color(.25,.63,.85,1),colorY:new E.Color(.25,.63,.85,1),colorZ:new E.Color(.25,.63,.85,1)},head:g.types.ARROW})).exludeFromBounding(!0),h.setVisibilityInTree(!1),h.setPickable(E.PICKTHROUGH),h.setMatrix(A),F.addNode(h),v.axisSystemVisibility({objectListToAnimate:[h],visibility:!0,pickability:!1}),v.startAnimation(),I=h,e!==x.CIRCULAR.id||T||y?(d={position:(new u.Matrix4).setPosition(O[_].position),label:f.FLAG_ORIGIN_LABEL,iconUrl:O[_].iconUrl?O[_].iconUrl:"",closeButton:!0,closeCB:function(){z(_,e)}},_===U&&(d.offset=new u.Vector2(0,50)),D[_]=new i(F,d),D[_].setOffset(M[_]),b.addFlag(D[_])):ie(e,_,f.LABEL_AXIS,Y,M[_])),e===x.USERDEFINED.id||P===x.USERDEFINED.id)for(r in O)O.hasOwnProperty(r)&&r!==U&&ne(r,M[r],e);else T&&ie(e,T,f.LABEL_DIR1,Y,M[T]),y&&ie(e,y,f.LABEL_DIR2,B,M[y])},ae=function(e){var t,n,i,o,a,r,s,c,l,d,m,S,g,p,E,A,f,v,D,I,b=[],P=F.getSceneGraphOverrideSetManager();for(t in h&&(P.removeSceneGraphOverrideSet(h),h=null),h=new C(w.getRootBagPath().externalPath[0]),W)W.hasOwnProperty(t)&&$(t);if(U)switch(b.push(O[U].pathElement),i=_&&O.hasOwnProperty(_)?O[_]:null,"USERDEFINED"!==e&&"USERDEFINED"!==V&&(_&&(s=_),T&&(p=Z(O[T],i,!0),s=T,f=p.clone().setLength((Y.reverse?-1:1)*Y.spacing),E=(new u.Matrix4).makeTranslation(f.x,f.y,f.z)),y&&(f=Z(O[y],i,!0).clone().setLength((B.reverse?-1:1)*B.spacing),A=(new u.Matrix4).makeTranslation(f.x,f.y,f.z))),g=O[U],(S=(m=Q(g.pathElement)).getWorldMatrix()).getInverse(S),v=k?g.worldMatrix.clone().setPosition(g.position):g.worldMatrix.clone().setPosition(i.position),e){case x.LINEAR.id:if(T)for(o=0;o<Y.count;++o)(0!==o||k)&&o>0&&(v=E.clone().multiply(v),D=te(g,m,v),b.push(W[D].pathElement));break;case x.RECTANGULAR.id:if(T&&y)for(d=v.clone(),l=0;l<B.count;++l)for(l>0&&(d=A.clone().multiply(d)),v=d.clone(),o=0;o<Y.count;++o)0===o&&(l>0||!k)?(D=te(g,m,v),b.push(W[D].pathElement)):o>0&&(v=E.clone().multiply(v),D=te(g,m,v),b.push(W[D].pathElement));break;case x.CIRCULAR.id:if(s)for(r=p||O[s].canonicGeom.getNormal().clone(),n=(new u.Matrix4).makeRotationAxis(r,(Y.reverse?-1:1)*Y.angle*Math.PI/180),c=(new u.Matrix4).setPosition(O[s].position),o=0;o<Y.count;++o)(0!==o||k)&&o>0&&(v=c.clone().multiply(n.clone().multiply((new u.Matrix4).getInverse(c).multiply(v))),D=te(g,m,v),b.push(W[D].pathElement));break;case x.USERDEFINED.id:for(a in O)O.hasOwnProperty(a)&&a!==U&&(v=O[a].type===R.geometryTypesEnum.AXISSYSTEM?O[a].worldMatrix.clone():g.worldMatrix.clone().setPosition(O[a].position),D=te(g,m,v),b.push(W[D].pathElement))}h&&((I=h.createOverride({pathes:b}))&&(I.setOpacity(.5),I.setPickability("IGNORED")),P.pushSceneGraphOverrideSet(h))},re=function(){var e;for(e in l.empty(),O)O.hasOwnProperty(e)&&l.add(O[e]);for(e in W)W.hasOwnProperty(e)&&l.add(W[e])},se=function(e){var t=null,n=S.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),i=S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");switch(e){case R.geometryTypesEnum.POINT:t=n+"I_Meas_Point.png";break;case R.geometryTypesEnum.CENTER:case R.geometryTypesEnum.CIRCLE:t=n+"I_Meas_PointCircle.png";break;case R.geometryTypesEnum.AXISSYSTEM:t=i+"I_3DComposeAxisSystem.png";break;case R.geometryTypesEnum.AXISSYSTEMORIGIN:t=i+"I_C3DAxisOrigin.png";break;case R.geometryTypesEnum.AXISSYSTEMAXIS:t=i+"I_C3DAxisAxis.png";break;case R.geometryTypesEnum.PLANE:t=n+"I_Meas_Plane.png";break;case R.geometryTypesEnum.CYLINDER:t=n+"I_Meas_Cylinder.png";break;case R.geometryTypesEnum.LINE:t=n+"I_Meas_Line.png"}return t},ce=function(e){_=e},le=function(e){var t,n,i,o,a=e;for(G&&(H[G]=R.getActiveFilters()),U&&a===x.NOPATTERN.id&&(a=a+"_"+V),o=H[a],U&&o.REFERENCE&&delete o.REFERENCE,n=0,i=j[a].length;n<i;++n)o.hasOwnProperty(j[a][n])||(o[j[a][n]]=0);for(t in o)o.hasOwnProperty(t)&&-1===j[a].indexOf(t)&&delete o[t];e===x.CIRCULAR.id&&T&&(o={}),R.updateFilters(o,!1)},ue=function(e){var t,n=Object.keys(O),i=n.length;for(_||(y&&q(O[y].type)&&z(y,e,!1,!1),T&&q(O[T].type)&&z(T,e,!1,!1)),t=0;t<i;++t)if(q(O[n[t]].type)){if(!_&&n[t]!==T&&n[t]!==y){ce(n[t]);continue}if(!T&&n[t]!==_&&n[t]!==y){T=n[t];continue}if(!y&&n[t]!==T&&n[t]!==_){y=n[t];continue}}oe(e)},de=function(e,n,i){var o,a,r,c,l,d,C=null,m=new u.Vector3;R.object3D[0]&&R.object3D[0].pathElement&&(C=R.object3D[0].pathElement),C&&!O[C.getKey()]&&(r=(o=s.getEquivalentGeometry({pathElement:C,axisSystemSub:!0,viewer:F}))?o.getType():R.geometryTypesEnum.REFERENCE,c=C.getWorldMatrix(),a=C.getKey(),r===R.geometryTypesEnum.REFERENCE||r===R.geometryTypesEnum.AXISSYSTEM||r===R.geometryTypesEnum.AXISSYSTEMAXIS?m.getPositionFromMatrix(c):m=function(e){var t=null,n=e.getType();if(void 0===n)return null;switch(n){case R.geometryTypesEnum.POINT:t=e.getPoint();break;case R.geometryTypesEnum.LINE:case R.geometryTypesEnum.CYLINDER:t=e.getEndPoints().beginPoint;break;case R.geometryTypesEnum.CIRCLE:case R.geometryTypesEnum.CENTER:t=e.getCenter()}return t}(o),O[a]={pathElement:C,type:r,worldMatrix:c,position:m,clickPos:R.object3D[0].position,canonicGeom:o,iconUrl:se(r)},r===R.geometryTypesEnum.AXISSYSTEM&&(O[a].clickPos=m),U||r!==R.geometryTypesEnum.REFERENCE?!_&&e.id!==x.USERDEFINED.id&&q(r)?ce(a):a!==_&&a!==U&&(T?y||(y=a,!_||r!==R.geometryTypesEnum.POINT&&r!==R.geometryTypesEnum.CIRCLE&&r!==R.geometryTypesEnum.AXISSYSTEM||(B.spacing=Math.round(1e3*O[_].position.distanceTo(m))/1e3)):(T=a,!_||r!==R.geometryTypesEnum.POINT&&r!==R.geometryTypesEnum.CIRCLE&&r!==R.geometryTypesEnum.AXISSYSTEMORIGIN||(Y.spacing=Math.round(1e3*O[_].position.distanceTo(m))/1e3))):(l=a,d=A.getNodeID(O[l].pathElement.getLastElement(!0)),U=l,O[l].iconUrl="",w.getController().getAttributes({ids:[d],attributes:["type_icon_url"],callbacks:{onComplete:function(e){O[l].iconUrl=e[d]?e[d].type_icon_url:"",D[l+"ref"]&&D[l+"ref"].setIcon(O[l].iconUrl)},onFailure:function(){}}})),R.object3D=[]),oe(e.id),le(e.id),K(),ae(e.id),e.id!==x.NOPATTERN.id?v.removeAll((function(){v.add({message:f["LABEL_"+e.id],closable:!1,buttons:[{label:f.SAVEBTN,className:"primary",onClick:function(){t.publish({event:"C3D_SAVE_CLICK"})},doClose:!0},{label:f.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})})):v.removeAll((function(){var n=0;U&&(n=1),v.add({message:f["LABEL_"+e.id+"_"+n],closable:!1,buttons:[{label:f.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})})),i(),re()},Ce=function(e,t,n){ae(e.id),le(e.id),K(),n(),re()},me=function(){return!!U||(v.add({message:f.NOREFERROR,msgType:"warning",autoHide:!0,closable:!0}),!1)},Se=function(){var e;for(e in K(),l.empty(),_=null,U=null,T=null,y=null,W&&ee(),h&&(F.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(h),h=null),F.setDefaultPicking(!0),R&&R.deactivate(),ee(),v&&(v.destroy(),v=null),I&&F.removeNode(I),D)D.hasOwnProperty(e)&&(b.removeFlag(D[e]),D[e].destroy(),delete D[e]);D.length=0,M.end?M.end():M.done()},ge=function(e){var t,n,i,o=F,a={context:w,parentID:null,children:[],onCompleted:function(t){var n=t.length||0;if(0===n)return Se(),void e();t.forEach((function(t){n--,!t.instID&&t.message&&v.add({message:t.message,msgType:"error",autoHide:!0,closable:!0}),0===n&&(Se(),e())}))}};if(W&&O){for(t in n=O[U],i=A.getNodeID(n.pathElement.getLastElement()),a.parentID=A.getNodeID(Q(n.pathElement).getLastElement()),W)W.hasOwnProperty(t)&&W[t].activated&&a.children.push({id:i,matrix:W[t].pathElement.getMatrix(o)});m.insertExisting(a)}},pe=function(e){Se(),e()};this.buildGraph=function(){b||(b=new a(F)),_=null,U=null,T=null,y=null,O={},v=(new n).inject(L.getUIFrame()),D=[],l.isEmpty()&&v.add({message:f.LABEL_NOPATTERN_0,closable:!1,buttons:[{label:f.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]}),F.setDefaultPicking(!1);var e=S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),i=this.createInitialState("NoPatternState"),o=this.createState("LinearState"),r=this.createState("RectangularState"),s=this.createState("CircularState"),u=this.createState("UserDefineState"),d=this.getFinalState(),C=H.NOPATTERN;U||(C={POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0,REFERENCE:1}),R=new c({context:w,activeFilters:C,postFilter:function(e){var t=A.getRoots(w);return!!A.isAModelPath(e)&&(!Array.isArray(t)||-1===t.indexOf(e.getLastElement()))}}),x={NOPATTERN:{id:"NOPATTERN",iconUrl:"",chkConditions:function(){return!0},actions:function(e){de(x.NOPATTERN,0,e)}},LINEAR:{id:"LINEAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return("LINEAR"===V||"RECTANGULAR"===V)&&J(x.LINEAR.conditions)},conditions:{stateID:"LINEAR",debugTxt:"Linear pattern condition",validSelCount:1,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.LINE},{type:R.geometryTypesEnum.AXISSYSTEM},{type:R.geometryTypesEnum.AXISSYSTEMAXIS},{type:R.geometryTypesEnum.CYLINDER}]},actions:function(e){de(x.LINEAR,0,e)}},RECTANGULAR:{id:"RECTANGULAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return!("LINEAR"!==V&&"RECTANGULAR"!==V||!T)&&J(x.RECTANGULAR.conditions)},conditions:{stateID:"RECTANGULAR",debugTxt:"Rectangular pattern condition",validSelCount:2,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.LINE},{type:R.geometryTypesEnum.CYLINDER},{type:R.geometryTypesEnum.AXISSYSTEM},{type:R.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){de(x.RECTANGULAR,0,e),F.setDefaultPicking(!1)}},CIRCULAR:{id:"CIRCULAR",iconUrl:e+"I_C3DCircularPattern.png",chkConditions:function(){return"CIRCULAR"===V&&J(x.CIRCULAR.conditions)},conditions:{stateID:"CIRCULAR",debugTxt:"Circular pattern condition",validSelCount:1,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.CYLINDER},{type:R.geometryTypesEnum.LINE},{type:R.geometryTypesEnum.AXISSYSTEM},{type:R.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){de(x.CIRCULAR,0,e)}},USERDEFINED:{id:"USERDEFINED",iconUrl:e+"I_C3DUserPattern.png",chkConditions:function(){return"USERDEFINED"===V&&J(x.USERDEFINED.conditions)},conditions:{stateID:"USERDEFINED",debugTxt:"User defined pattern condition",validSelCount:-1,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.AXISSYSTEM}]},actions:function(e){de(x.USERDEFINED,0,e)}}},this.addTransition({iInitialState:i,iFinalState:o,iEvent:R,iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="NOPATTERN_LINEAR",x.LINEAR.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:R,iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){G="NOPATTERN_LINEAR",x.RECTANGULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:s,iEvent:R,iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="NOPATTERN_CIRCULAR",x.CIRCULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:u,iEvent:R,iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="NOPATTERN_USERDEFINED",x.USERDEFINED.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="NOPATTERN",U&&(G=G+"_"+V),pe(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:R,iCondition:function(){return x.NOPATTERN.chkConditions()},iAction:function(e){G="NOPATTERN",U&&(G=G+"_"+V),x.NOPATTERN.actions(e)},iSender:M}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:R,iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="LINEAR",x.LINEAR.actions(e)},iSender:M}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){G="LINEAR",Ce(x.LINEAR,0,e)}}),this.addTransition({iInitialState:o,iFinalState:r,iEvent:R,iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){G="LINEAR",x.RECTANGULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:o,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="LINEAR",pe(e)}}),this.addTransition({iInitialState:o,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return me()},iAction:function(e){G="LINEAR",ge(e)}}),this.addTransition({iInitialState:r,iFinalState:r,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){G="RECTANGULAR",Ce(x.RECTANGULAR,0,e)}}),this.addTransition({iInitialState:r,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="RECTANGULAR",pe(e)}}),this.addTransition({iInitialState:r,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return me()},iAction:function(e){G="RECTANGULAR",ge(e)}}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:R,iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="CIRCULAR",x.CIRCULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){G="CIRCULAR",Ce(x.CIRCULAR,0,e)}}),this.addTransition({iInitialState:s,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="CIRCULAR",pe(e)}}),this.addTransition({iInitialState:s,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return me()},iAction:function(e){G="CIRCULAR",ge(e)}}),this.addTransition({iInitialState:u,iFinalState:u,iEvent:R,iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="USERDEFINED",x.USERDEFINED.actions(e)},iSender:M}),this.addTransition({iInitialState:u,iFinalState:d,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="USERDEFINED",pe(e)}}),this.addTransition({iInitialState:u,iFinalState:d,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return me()},iAction:function(e){G="USERDEFINED",ge(e)}}),this.addTransition({iInitialState:o,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="LINEAR",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="LINEAR",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="CIRCULAR",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="CIRCULAR",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){ue(x.CIRCULAR.id),G="USERDEFINED",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="RECTANGULAR",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:r,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){ue(x.RECTANGULAR.id),G="USERDEFINED",x.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){ue(x.LINEAR.id),G="USERDEFINED",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="LINEAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="RECTANGULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="CIRCULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="USERDEFINED",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="NOPATTERN",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){G="NOPATTERN",x.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="NOPATTERN",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="NOPATTERN",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="NOPATTERN",U&&(G=G+"_"+X),x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:o,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="RECTANGULAR",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:u,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="LINEAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="CIRCULAR",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="CIRCULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="USERDEFINED",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="RECTANGULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){x.NOPATTERN.actions(e)}})},(P=JSON.parse(localStorage.getItem("CAT3DComposeAssemblyPatternCmd")))&&3===P.version&&(k=P.reuse,V=P.radioPattern,Y="object"==typeof P.direction1?P.direction1:Y,B="object"==typeof P.direction2?P.direction2:B,H="object"==typeof P.filters?P.filters:H),this._parent(e,{mode:"exclusive",isAsynchronous:!0,doServerCall:!1}),this.odtUtilsSetDefaultNbInstances=function(e){Y.count=e,B.count=e}}})})),define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATW3DBoxes/CATW3DBoxController","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUFrameWindow","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DRobot/CATW3DRobot","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,o,a,r,s,c,l,u,d,C,m,S){"use strict";var g,p=e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var p=this,E=!1,A=e.executionContext?e.executionContext.getComponent("Viewer"):r.get();s.init(A,{executionContext:e.executionContext});let f=new a({context:A}),v=t.getBoxController({context:A}),D=S.getExamineController({context:A}),h=c.getMoveManager({context:A}),T=m.getSelectionManager({context:A}),y=l.getDefaultSelectionFilter({context:A}),I=u.getMove3DRobot({context:A}),R=[],x=[],b={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},P={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3},M=!0;function N(){if(p.isRunning()){var e=n.give3DGridController({context:A});e&&e.hide3DGrids(),p&&p.isRunning()&&(y&&y.activate(),T&&T.setActiveState(!1)),v&&v.setActiveState(!1)}}function w(){if(p.isRunning()){var e=n.give3DGridController({context:A});e&&e.display3DGrids(),p&&p.isRunning()&&y&&!I.hasTarget()&&(y.deactivate(),T&&T.setActiveState(!0)),v&&v.setActiveState(!0)}}g||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],(function(e){g=e,p.isRunning()&&(g.activate({context:A,withSnap:!0,selectionFilter:y}),g.give().setAllowManipulation(M),x.length||(x.push(g.subscribe("onDirectMoveBegin",N)),x.push(g.subscribe("onDirectMoveEnd",w))))})),I.setSelectionFilter(y),y.deactivate(),R.push(I.subscribe("onRobotMoveBegin",(function(){p.isRunning()&&(p&&p.isRunning()&&(y&&y.activate(),T&&T.setActiveState(!1)),v&&v.setActiveState(!1))}))),R.push(I.subscribe("onRobotMoveEnd",w));var L=[];function F(){L.length>0||(L.push(h.subscribe("MoveBegin",(function(){D&&D.setActiveState(!1)}))),L.push(h.subscribe("Move",(function(){var e=o.giveDataLauncherController({context:A});e&&e.setVisibility(!1)}))),L.push(h.subscribe("MoveEnd",(function(){var e=o.giveDataLauncherController({context:A});e&&e.setVisibility(!0),D&&D.setActiveState(!0)}))))}function _(){L.forEach((function(e){h.unsubscribe(e)})),L=[]}var U=d.getPreferenceManager({context:A.getFrameWindow()}),O=[];function W(e){p&&e.forEach((function(e){if("W3MprefMove"===e.name)e.preferences.forEach((function(e){if("C3DAllowDirectManipulation"===e.name){let t=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),n=A.getController&&A.getController().hasAnyEffectiveFlexibleAssembly(),i=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration");M=!(t&&n&&i)&&"true"===e.value,g&&g.give().setAllowManipulation(M)}else"defaultMoveReferent"===e.name&&(i.setMoveReferentDefault(e.value),v&&v.refreshBoxes(!0))}));else if("FrameGeneral"===e.name)e.preferences.forEach((function(e){if("ProjectionType"===e.name){var t="Perspective"===e.value?0:1;let n=A?A.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.setProjectionType(t)}}));else if("VisualizationRepository"===e.name)e.preferences.forEach((function(e){if("Gravity"===e.name){var t="true"===e.value;let n=A?A.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.control&&(n.currentViewpoint.getControl().setRotationRolling(!t),n.currentViewpoint.getControl().setRollingForTouchAvailable(!t))}}));else if("SelectionRepository"===e.name)e.preferences.forEach((function(e){if("Select3DGeometry"===e.name){var t=!!y&&y.isActive();t&&y.deactivate(),T.setPicking("true"===e.value?0:1),t&&y.activate()}else"SelectParentReferenceOr3DShape"===e.name&&T&&T.selectParentReference("select3DShape"!==e.value)}));else if("cke"===e.name){let t=!1,n=!1;e.preferences.forEach((function(e){"Length"===e.name?(b.unit=e.value,t=!0):"LengthCalcDisplay"===e.name?(b.decimalPlaceRO=parseInt(e.value),t=!0):"Angle"===e.name?(P.unit=e.value,n=!0):"AngleCalcDisplay"===e.name&&(P.decimalPlaceRO=parseInt(e.value),n=!0)})),t&&I.setLengthUnit(b),n&&I.setAngleUnit(P)}}))}U.addPreferences(i.getPreferencesDefinition()),U.setUnitsPreferencesDisplayFlag(!0),U.setDisplayPreferencesDisplayFlag(!0),U.set3DSelectionPreferencesDisplayFlag(!0),U.setMeasurePreferencesDisplayFlag(!0),U.setClippingPreferencesDisplayFlag(!0),U.setPreferredPreferenceContainersOrder(["W3MprefMove","MeasurePreferences","SectionPreferences"]),O.push(U.subscribe("com.ds.mep:onPrefUpdate",(function(e){W(JSON.parse(e[1].preferences).repositories)}))),A.getViewer().currentViewpoint.getControl().setRotationRolling(!0),A.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!0),A.getViewer().currentViewpoint.setProjectionType(0),T.setPicking(1),T.selectParentReference(!1);C.readPreferences([{Repository:"W3MprefMove",PreferenceNames:["C3DAllowDirectManipulation","defaultMoveReferent"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]},{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Angle","AngleCalcDisplay"]}]).then((function(e){W(e.repositories)})).catch((function(e){window.console.warn("Error Preferences ",e)})),this.beginExecute=function(){A&&(T.setActiveState(!0),A.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),function(){if(A&&!E){f.activate(),v.setActiveState(!0);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!0),g&&g.activate({context:A,withSnap:!0,selectionFilter:y}),y&&y.deactivate(),D&&D.setActiveState(!0),F()}}(),this.done())},this.endExecute=function(){if(A){f.deactivate(),v.setActiveState(!1);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!1),g&&g.deactivate({context:A}),T.setActiveState(!1),D&&D.setActiveState(!1),_()}},this.pauseExecute=function(){f.deactivate(),v.setActiveState(!1);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!1),g&&g.deactivate({context:A}),y&&y.deactivate(),T.setActiveState(!1),D&&D.setActiveState(!1),_(),this.done()},this.resumeExecute=function(){if(A){y&&I.hasTarget()?(y.activate(),T.setActiveState(!1)):T.setActiveState(!0),A.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),f.activate(),v.setActiveState(!0);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!0),g&&g.activate({context:A,withSnap:!0,selectionFilter:y}),D&&D.setActiveState(!0),F(),this.done()}},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){_(),R.forEach(I.unsubscribe,I),x.forEach(I.unsubscribe,x),g&&(x.forEach(g.unsubscribe,x),g.unreference({context:A})),E=!0,O.forEach(U.unsubscribe,U),l.unreferenceDefaultSelectionFilter({context:A}),m.unreferenceSelectionManager({context:A}),S.unregisterExamineController({context:A}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),p=y=A=f=v=h=I=U=O=T=null}}});return p}));