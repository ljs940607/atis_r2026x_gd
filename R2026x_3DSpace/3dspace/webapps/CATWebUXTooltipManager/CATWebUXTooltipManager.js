/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXTooltipManager/CATWebUXTooltipManager",["UWA/Class","UWA/Core","DS/VisuEvents/EventsManager","DS/Selection/PSOManager","DS/CoreEvents/Events","css!DS/CATWebUXTooltipManager/CATWebUXTooltipManager.css"],(function(e,t,n,o,i){"use strict";var r=e.extend({init:function(e){var r,s,a,c,u,v,l,f,m,d,p,T,g,h=0,E={},y=[],x=e.context.getViewer();function b(e){var t=e;return y.some((function(n){if(n.obj.filterPath){var o=n.obj.filterPath(e);return o&&(t=o),Boolean(o)}})),t}function C(e){var t=x.pick(x.getMousePosition(e),x.picking.primitive?"primHybrid":"mesh",!1);return!t||!t.path||t.path.length<1?null:b(t.path[0])}function M(e){m.removeClassName("top"),m.removeClassName("left"),m.removeClassName("right");var t="top",n=E.x-d.offsetWidth/2,o=E.y-d.offsetHeight-8-e;o<0?((o=E.y-d.offsetHeight/2)<0&&(o=0),t="right",(n=E.x+10+e)+d.offsetWidth>x.SCREEN_WIDTH&&(t="left",n=E.x-d.offsetWidth-8-e)):n<0?(t="right",n=E.x+10+e,o=E.y-d.offsetHeight/2):n+d.offsetWidth>x.SCREEN_WIDTH&&(t="left",n=E.x-d.offsetWidth-8-e,o=E.y-d.offsetHeight/2),m.addClassName(t),m.setStyles({left:n+"px",top:o+"px"})}function W(){m&&m.removeClassName("visible")}function U(){clearTimeout(g),g=0,clearTimeout(u),clearTimeout(v),u=v=f=void 0,E={},W()}function w(){var e=o.get()[0];if(e&&(!e||e.event)){var t=e.event.getCurrentPosition(x.canvas);if(t&&(E.x!==t.x||E.y!==t.y)){E=t,clearTimeout(v),v=void 0;var n=e.pathElement;if(n=b(n)){if(f&&f.isEqual(n)){if(m&&m.hasClassName("visible"))return g&&(clearTimeout(g),g=0),void(v=setTimeout((function(){M(e.event&&"Touch"===e.event.type?70:4)}),500))}else{if(p&&m&&m.hasClassName("visible"))return void(g||(g=setTimeout((function(){A(),g=0}),1e3)));W(),f=n.clone()}clearTimeout(u),u=void 0;var i=setTimeout((function(){i===u&&L([n],e.event&&"Touch"===e.event.type?70:4)}),500);u=i}else U()}}}function A(){T||(U(),w())}function L(n,o,i){var r,s,a=[];m||(m=t.createElement("div",{id:"CATWebUXtooltip",class:"CATWebUXtooltip top"}).inject(e.context.getFrameWindow().getUIFrame()),t.createElement("div",{class:"CATWebUXtooltip-arrow"}).inject(m),d=t.createElement("div",{class:"CATWebUXtooltipbody"}).inject(m),m.addEventListener("mouseleave",(function(){T=!1,g||(g=setTimeout((function(){A(),g=0}),1e3))})),m.addEventListener("mouseenter",(function(){T=!0,g&&(clearTimeout(g),g=0)}))),p=!1,g&&(clearTimeout(g),g=0),W(),d.empty(),d.addClassName("prefill"),m.addClassName("visible"),M(o),r=y.length,y.forEach((function(e,t){e.obj.onTooltipReady({arrayPath:Array.isArray(n)?n:void 0,element:Array.isArray(n)?void 0:n,token:u,completed:function(e){var n,i;n=t,r--,(i=e)&&(s=i),s&&s.token&&s.div&&"number"==typeof s.token&&s.token===u?(s.interactiveContent&&(p=!0),a[n]=s.div,0===r&&(d.empty(),a.forEach((function(e){e.inject(d)})),d.removeClassName("prefill"),M(o),p?m.setStyle({"pointer-events":""}):m.setStyle({"pointer-events":"none !important"}))):m&&W()},fromTouchEvt:i})}))}function N(e){if("mouseenter"===e.type){E={x:e.clientX,y:e.clientY},clearTimeout(u),u=0;var t=setTimeout((function(){t===u&&L(e.target,"Touch"===e.type?70:4)}),100);u=t}else"mouseleave"===e.type&&(g&&(clearTimeout(g),g=0),u&&(clearTimeout(u),u=0),p?g=setTimeout((function(){A(),g=0}),100):U())}function S(e){"@onViewpointBeginMove"===e.eventType&&U()}function R(e){var t,o,i=e.from[0].getCurrentPosition(x.canvas);if("@onLeftMouseDownEvent"===e.eventType&&1===e.from[0].event.buttons){if(!(t=C(i)))return void U();E.x===i.x&&E.y===i.y&&m&&m.hasClassName("visible")||(U(),f=t.clone(),o=setTimeout((function(){o===u&&L([t],4)}),100),u=o),E=i}else if("@onLeftMouseUpEvent"===e.eventType||"@onRightMouseUpEvent"===e.eventType)U(),E=i;else if("@onLongHoldEvent"===e.eventType){if(E=i,!(t=C(i)))return void U();f&&f.isEqual(t)||(W(),f=t.clone()),clearTimeout(u),u=void 0,clearTimeout(v),v=void 0,o=setTimeout((function(){o===u&&(n.addEvent(x.canvas,"onRelease",R),L([t],70,!0))}),100),u=o}else"@onReleaseEvent"===e.eventType&&("Touch"===e.from[0].type&&p?g=setTimeout((function(){A(),g=0}),2e3):U(),E=i,n.removeEvent(x.canvas,"onRelease",R))}this.registerElements=function(e){e&&e.length&&e.forEach((function(e){e.addEventListener("mouseenter",N),e.addEventListener("mouseleave",N)}))},this.unregisterElements=function(e){e&&e.length&&e.forEach((function(e){e.removeEventListener("mouseenter",N),e.removeEventListener("mouseleave",N)}))},this.register=function(e){var t;if(e&&e.onTooltipReady)return y.some((function(n){if(n.obj===e)return t=n.token,!0}))||(t=++h,y.push({token:t,obj:e}),r||(r=o.onPostAdd(w),c=o.onRemove((function(){g&&(clearTimeout(g),g=0),p&&(g=setTimeout((function(){A(),g=0}),500))})),a=o.onEmpty((function(){g&&(clearTimeout(g),g=0),p?g=setTimeout((function(){A(),g=0}),500):U()})),s=x.onViewerResize(U),l=i.subscribe({event:"/VISU/"},S),n.addEvent(x.canvas,"onLeftMouseDown",R),n.addEvent(x.canvas,"onLeftMouseUp",R),n.addEvent(x.canvas,"onRightMouseUp",R),n.addEvent(x.canvas,"onLongHold",R))),t},this.unregister=function(e){var t;return y.some((function(n,o){if(n.token===e)return t=e,y.splice(o,1),!0})),0===y.length&&(o.unsubscribe(r),r=void 0,o.unsubscribe(a),a=void 0,o.unsubscribe(c),c=void 0,x.unsubscribe(s),s=void 0,i.unsubscribe(l),l=void 0,n.removeEvent(x.canvas,"onLeftMouseDown",R),n.removeEvent(x.canvas,"onLeftMouseUp",R),n.removeEvent(x.canvas,"onRightMouseUp",R),n.removeEvent(x.canvas,"onLongHold",R),this.destroyTooltip()),t},this.clearTooltipManager=function(){this.destroyTooltip();var e=this;y&&y.forEach((function(t){e.unregister(t.token),t.obj=null})),u&&(clearTimeout(u),u=void 0),v&&(clearTimeout(v),v=void 0),g&&(clearTimeout(g),g=void 0),E=f=y=m=d=x=null},this.destroyTooltip=function(){U(),m&&m.destroy(),m=d=void 0}}}),s=[];return e.singleton({init:function(){},giveTooltipManager:function(e){var t;return e&&e.context&&e.context.getViewer&&e.context.getFrameWindow&&s.some((function(n){if(n.context===e.context)return t=n.tooltipMng,!0})),t},getTooltipManager:function(e){var t,n;return e&&e.context&&e.context.getViewer&&e.context.getFrameWindow&&s.some((function(n){if(n.context===e.context)return t=n,!0})),!t&&e&&e.context&&e.context.getViewer&&e.context.getFrameWindow?(n=new r({context:e.context}),s.push({context:e.context,tooltipMng:n,counter:1})):t&&(t.counter++,n=t.tooltipMng),n},unreferenceTooltipManager:function(e){e&&e.context&&e.context.getViewer&&e.context.getFrameWindow&&s.some((function(t,n){if(t.context===e.context)return s[n].counter--,s[n].counter<=0&&(s[n].tooltipMng.clearTooltipManager(),s.splice(n,1)),!0}))}})}));