define("DS/FolderMigration/FolderMigration",["DS/IPClassifyUXUtil/service/IPClassifyUXUtilWebService","DS/IPClassifyUtil/IPClassifyUtility","DS/FolderEditor/utils/FolderEditorUtil","DS/IPClassifyUtil/IPServicesMgr","text!DS/FolderEditor/assets/FolderEditorColumns.json"],(function(e,n,t,i,r){var o=JSON.parse(r);let a=["kind","typeRepresentation","ds6w","tree","editionPolicy","visibleFlag","pinned","sortableFlag","customisation"];function s(e){var n=!1,t={};for(var i in e){var r=i,o=e[i];!0!==o.e?r="_X_"+i:n=!0;var a=s(o.c);(!0===o.e||a.oneIsExpanded)&&(t[r]=a.elements),n=n||a.oneIsExpanded}return{oneIsExpanded:n,elements:t}}function d(e){if(e){var n={},t=s(e.root.c);t.oneIsExpanded&&(n={root:t.elements}),widget.setValue("folderTreeStructure",JSON.stringify(n))}}function l(){var e=widget.getValue("vMigration");return e||0}function u(){var e,t,i=widget.getValue("FolderCusto_treelistview"),r=null;l()<3?i&&(r=v(decodeURIComponent(i))):r=i?(e=i,t=n.jsonUnzip(e),value=v(t,null),value):null;return r}function c(e,n,t,i){return new Promise((function(r){if(!e||n>=i||t<i||!e.columnsOptimized)return r();var o=["ds6wg:revision","ds6w:reserved"];e.columnsOptimized.forEach((function(e){e.minWidth&&!e.width&&(50!=e.minWidth||o.indexOf(e.dataIndex)>=0)&&(e.width=e.minWidth),delete e.minWidth})),r()}))}function f(e,n,t,i){return new Promise((function(r){if(!e||n>=i||t<i||!e.columnsOptimized)return r();var s=o.attributes,d={};s.forEach((e=>{var n=e.dataIndex;if(n=n||e.ds6w){d[n]={};for(let t in e)a.indexOf(t)>=0&&(d[n][t]=e[t])}})),o.order.forEach(((n,t)=>{var i=!1,r=d[n];if(r){for(var o=0;o<e.columnsOptimized.length;++o){var a=e.columnsOptimized[o];if(a.dataIndex===n){r.customisation&&!a.customisation&&(a.customisation=r.customisation),void 0!==r.sortableFlag&&(a.sortableFlag=r.sortableFlag),i=!0;break}}if(!i){var s=r;s.dataIndex=n,s.visibleFlag=!1,e.columnsOptimized.splice(t,0,s)}}})),r()}))}function m(e,n,t,i){return new Promise((function(r){if(!e||n>=i||t<i)return r();if(e.rowsHeader=!1,delete e.custoFromTree,columns=e.columnsOptimized,columns){var o=[];columns.forEach((function(e){if("bi_color"!==e.dataIndex){var n={width:e.width,editableFlag:!1,customisation:e.customisation,dataIndex:e.dataIndex};for(var t in e.xnav_options&&(n.kind=e.xnav_options.kind,n.kind="date"==n.kind?"datetime":n.kind,n.typeRepresentation="integer"===n.kind?"string":n.kind,"ds6w:reserved"===e.dataIndex&&(n.typeRepresentation="functionIcon"),n.ds6w=e.xnav_options.ds6w,!0===e.xnav_options.tree&&(n.tree=!0,n.editionPolicy="EditionOnDoubleClick")),!0===e.isHidden&&(n.visibleFlag=!1),a.forEach((t=>{void 0===n[t]&&void 0!==e[t]&&(n[t]=e[t])})),n)void 0===n[t]&&delete n[t];o.push(n)}})),e.columnsOptimized=o}r()}))}function v(e,n){var t=n=n||null;try{t=e?JSON.parse(e):n}catch(e){t=n}return t}return{migrate:function(n){return new Promise(function(r,o){var a=function(e){return new Promise((function(n){if(l()>=1||e<1)return n();var t=widget.getValue("folderTreeStructure");t&&t.indexOf('"e"')>=0?(d(t=v(t,{})),n()):n()}))}(n),s=function(e){return new Promise((function(n){var i=u(),r=l();c(i,r,e,2).then((()=>{m(i,r,e,7).then((()=>{f(i,r,e,7).then((()=>{i?t.setContentViewPreference(i,!1,e).then(n):n()}))}))}))}))}(n),p=function(n){return new Promise((function(r){if(l()>=3||n<3)return r();new Promise((function(n){i.app_initialization((function(){e.getUserPreferences({name:widget.getValue("x3dAppId")+"_template"}).then((e=>{var i=null,r=!1;e.length>0&&(i=v(decodeURIComponent(e)))&&(r=!0,t.setContentViewPreference(i,"only").then(n)),r||n()})).catch(n)}))})).then(r)}))}(n);Promise.all([s,a,p]).then((function(){widget.setValue("vMigration",n),r()}))}.bind(this))},migratePreferences:function(e,n){var i=e.preference;return new Promise(((r,o)=>{(function(e,n){return new Promise((function(t){var i=e.version?e.version:0;c(e,i,n,7).then((()=>{m(e,i,n,7).then((()=>{f(e,i,n,7).then(t)}))}))}))})(i,n).then((()=>{t.setContentViewPreference(i,!0===e.template&&"only").then((()=>{r(i)})).catch(o)})).catch(o)}))}}}));