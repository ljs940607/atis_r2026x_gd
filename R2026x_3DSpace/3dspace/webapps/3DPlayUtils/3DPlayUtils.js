/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/3DPlayUtils/IdentifyPLMType",["UWA/Class","DS/3DPlaySupport/SupportList"],(function(e,t){"use strict";return e.extend({init:function(){this._parent()},isKindOfDrawing:function(e,n){t["3DSPACE"].resolveParenting(e,(function(e){"drawing"===e.toLowerCase()?n(e):n(!1)}))}})})),define("DS/3DPlayUtils/ContextualBar",["DS/WebInfraUI/ContextualBar"],(function(e){"use strict";return console.log("WARNING!!! ContextualBar class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBar' to access it."),e})),define("DS/3DPlayUtils/NavigationArrows",["DS/WebInfraUI/NavigationArrows"],(function(e){"use strict";return console.log("WARNING!!! NavigationArrows class has been migrated to new module. Please use 'DS/WebInfraUI/NavigationArrows' to access it."),e})),define("DS/3DPlayUtils/PublishToSwym",["DS/3DPlay/3DPlay","UWA/Class","DS/WebSystem/Environment","DS/WebSystem/Nls","i18n!DS/3DPlay/assets/nls/3DPlay"],(function(e,t,n,r,i){"use strict";return t.extend({init:function(t){var r,o;require(["DS/UIKIT/Modal","DS/SwymPublishForm/script/publish-form-view","css!DS/3DPlayUtils/PublishToSwym"],(function(s,a){var l=e.getExperience(t.ctx);l&&l.getScreenShot({onSuccess:function(e){if(n.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],(function(e){e.publish({event:n.get("ODT_3DPlay_PanelManager")})}));else{var t=l.args.input.tenantID||l.args.input.asset.tenant;if(t)r=t;else try{for(var c=window;!c.ds&&c.parent&&c!==c.parent;)c=c.parent;(r=c.ds.swymTenant)&&(o=!0)}catch(e){}!function(){var t,n,l=function(){n&&n.destroy(),t&&t.destroy()},c={title:"title",description:"description",mode:"base64",base64image:e,onCancel:l,onContentCreated:l};window.widget&&window.widget.getValue("x3dPlatformId")&&(c.platformId=window.widget.getValue("x3dPlatformId")),r&&(c.platformId=r),o&&(c.forcePlatform=!0),n=new a(c),(t=new s({closable:!0,header:i.ShareSwymTitle,body:n.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),t.show()}()}},onFail:function(){e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:i.UnableToCreateScreenshot})}})}),(function(n){if("scripterror"===n.requireType){var r=n.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",r)}else console.error(n);e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:i.ScripNotFoundError})}))}})})),define("DS/3DPlayUtils/ContextualBarManager",["DS/WebInfraUI/ContextualBarManager"],(function(e){"use strict";return console.log("WARNING!!! ContextualBarManager class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBarManager' to access it."),e})),define("DS/3DPlayUtils/EventDisposer",["DS/WebUtils/EventDisposer"],(function(e){"use strict";return console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),e})),define("DS/3DPlayUtils/ConvertService",["UWA/Class"],(function(e){"use strict";return e.extend({init:function(){this.supportedFormats={};var e=0;this.getConversionFormat=function(e){return this.supportedFormats[e]||null},this.clearQueue=function(){e++},this.convert=function(t,n,r,i,o){var s=n.ConversionFeedBack.progress,a=s.registerSubProgress(),l=n.ConversionFeedBack.notifTimeoutID,c=t;!1===Array.isArray(c)&&(c=[c]);for(var u=0,p=0,d=function(t){t.queueIdx===e&&(clearTimeout(l),s.advanceToMax(a),u++,delete t.queueIdx,u+p===c.length?i(t):o?o(t):i(t))},h=function(e,t){clearTimeout(l),s.advanceToMax(a),p++,r(e,t)},v=0;v<c.length;v++)c[v].queueIdx=e,this._convert({asset:c[v],onConvertSuccess:d,onConvertError:h,ConversionOpts:n.ConversionOpts||{}})},this._convert=function(){console.error("PlayWeb - Something is wrong, _convert is not defined.")}}})})),define("DS/3DPlayUtils/FullScreen",["UWA/Class","DS/CoreEvents/Events"],(function(e,t){"use strict";return e.extend({init:function(e,n,r,i){this._parent();var o,s,a="none";try{window.getSwymContainer&&(e=window.getSwymContainer())}catch(e){}if(n&&"HTML5"===n.mode){for(var l=!0,c=window,u=document,p=c.parent;c!==p&&l;){var d,h,v=p.document,f=v.getElementsByTagName("iframe");for(d=0;d<f.length;d++)if((h=v.getElementsByTagName("iframe")[d])&&h.contentWindow.document===u){h.getAttribute("allowfullscreen")||(l=!1);break}u=v,p=(c=p).parent}if(l=(l=l&&(e.requestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen||e.msRequestFullscreen))&&(document.cancelFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen||document.msCancelFullScreen||document.msFullscreenEnabled)){a="html5",s=function(){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},o=function(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()};var g=function(t){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||!r.classList.contains("active")&&!e.classList.contains("PlayWeb-FullScreen")?(r.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(r.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))};document.onfullscreenchange=g,document.onmozfullscreenchange=g,document.onwebkitfullscreenchange=g,document.onmsfullscreenchange=g}}else if(n&&"CUSTOM"===n.mode&&n.onActivate&&n.onDeactivate&&i&&i.getView)a="custom",s=function(){setTimeout((function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}})}),500)},o=function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})},i.onViewChange=function(e){"maximized"===e.type||"fullscreen"===e.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==e.type&&"minimized"!==e.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}})},n.onViewChange&&n.onViewChange((function(t){!0===t?(r.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(r.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))}));else if(n&&"PLATFORM"===n.mode&&i&&i.getView&&i.requestView){a="platform";var m="none";s=function(){"fullscreen"!==(m=i.getView().type)&&i.requestView({type:"fullscreen"})},o=function(){"fullscreen"!==m&&i.requestView({type:m})},i.onViewChange=function(o){"maximized"===o.type||"fullscreen"===o.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==o.type&&"minimized"!==o.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}}),"fullscreen"!==o.type&&r.classList.contains("active")&&(e.classList.remove("PlayWeb-FullScreen"),r.removeClassName("active"),"fullscreen"!==m&&i.requestView({type:m}),n.onDeactivate&&n.onDeactivate())}}t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/BEGIN"},(function(){r.getParent().setStyle("top",r.getParent().offsetTop+50+"px")})),t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/END"},(function(){r.getParent().setStyle("top",r.getParent().offsetTop-50+"px")})),this.getMode=function(){return a},this.toggle=function(){e.classList.contains("PlayWeb-FullScreen")?(o(),r.removeClassName("active"),n&&n.onDeactivate&&n.onDeactivate(),e.classList.remove("PlayWeb-FullScreen")):(s(),e.classList.add("PlayWeb-FullScreen"),n&&n.onActivate&&n.onActivate(),r.addClassName("active"))}}})})),define("DS/3DPlayUtils/UIManager",["UWA/Class","DS/WebUtils/EventDisposer"],(function(e,t){"use strict";return e.extend({init:function(e){this.ActionBarEventArray=new Array,this.ResizeEventArray=new Array,this.PanelEventArray=new Array,this.registerEvents(e)},registerEvents:function(e){var n=e.frameWindow,r=e.ctx,i=this,o=n.getActionBar();o&&(o.onActionBarClose((function(e){if(i&&i.ActionBarEventArray)for(var t=0,n=i.ActionBarEventArray.length;t<n;t++){i.ActionBarEventArray[t].addClassName("wux-ui-state-close")}})),o.onActionBarOpen((function(e){if(i&&i.ActionBarEventArray)for(var t=0,n=i.ActionBarEventArray.length;t<n;t++){var r=i.ActionBarEventArray[t];r.removeClassName("wux-ui-state-close"),"none"===r.style.display&&(r.style.display="block")}})));var s=function(e,t){if(i&&i.PanelEventArray)for(var n=0,r=i.PanelEventArray.length;n<r;n++){var o=i.PanelEventArray[n];if("object"==typeof o&&o.customCB){var s=UWA.extend({},e);s.visible=t,o.customCB(s)}else o.style.display=1==t?"none":""}};this.EventDisposer=new t,n&&n.experience?(this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/OPEN",(function(e){s(e,!0)}))),this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/CLOSE",(function(e){s(e,!0)}))),this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/SHOW",(function(e){s(e,!0)}))),this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/HIDE",(function(e){s(e,!1)})))):(this.EventDisposer.add(WUX.Events.subscribe({event:"/"+r+"3DPLAY/RIGHTPANEL/OPEN"},(function(e){s(e,!0)})),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+r+"3DPLAY/RIGHTPANEL/CLOSE"},(function(e){s(e,!0)})),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+r+"3DPLAY/RIGHTPANEL/SHOW"},(function(e){s(e,!0)})),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+r+"3DPLAY/RIGHTPANEL/HIDE"},(function(e){s(e,!1)})),WUX.Events))},dispose:function(){this.ActionBarEventArray=null,this.ResizeEventArray=null,this.PanelEventArray=null,this.EventDisposer.dispose(),this.EventDisposer=null},addToActionBarEvent:function(e){e.addClassName("wux-afr-actionbar"),this.ActionBarEventArray.push(e)},addToResizeEvent:function(e){this.ResizeEventArray.push(e)},addToPanelEvent:function(e,t){var n=void 0!==t?{div:e,customCB:t}:e;this.PanelEventArray.push(n)}})})),define("DS/3DPlayUtils/VisibilityUtils",["DS/WebSystem/Settings","DS/CoreEvents/Events"],(function(e,t){"use strict";return{applyVisibilityToAll:function(e,t,n){if(t)for(var r=0;r<t.length;r++)this.applyVisibilityToPath(e,t[r],n)},reallyApplyVisibilityToAll:function(e,t,n){if(t){Array.isArray(t)||(t=[t]);for(var r=0;r<t.length;r++){var i=t[r].getChildrenPathes();0!=i.length?this.reallyApplyVisibilityToAll(e,i,n):this.applyVisibilityToPath(e,t[0],n)}}},showAll:function(e){var t,n=this.getCurrentSceneGraphState(e),r=this.getCurrentSceneGraphIsolateState(e),i=function(e){var t,n=e.getNodes();return n.forEach((function(e){"RootBag"===e.name&&(t=e)})),t||(t=n[0]),t}(e);t=n.getOverridesFromPathElement(i),n.deleteOverrides(t);var o,s=r.getRootsAndConcatinatedPaths(i);o=s.concatinated,r.deleteOverrides(o);var a=s.mainroot;a&&r.deleteOverride(a),0===e.getVisibleSpace()&&e.swapVisibleSpace()},applyVisibilityToPath:function(e,t,n,r){null==r&&(r=!0),e.setVisibility(t,n,r)},getTransparencyPercentage:function(){var t=Math.round(e.get("VisibilitySettings.TransparencySetting",11));return(t<0||t>100)&&(t=11),t},setTransparencyPercentage:function(t){t>=0&&t<=100?e.set("VisibilitySettings.TransparencySetting",t):console.error("Error: Visibility Utilities - Transparency settings value out of range")},updateTransparencyofObjects:function(e,t,n){if(1==n)this.removeTransparencyFromObjects(e,t);else{var r=function(t){t.length>0&&t.forEach((function(t){var i=e.getOpacity(t);if(null!=i&&i<1)e.setOpacity(t,n);else{var o=t.getChildrenOccurrencePathes();null!=o&&null!=o&&r(o)}}))};r(t)}},removeTransparencyFromObjects:function(e,t){for(var n=0;n<t.length;n++){var r=t[n];e.setOpacity(r,1,!0),e.setPickability(r,"PICKABLE",!0)}},applyTransparencyToObjects:function(e,t,n,r,i){if(1==n)this.removeTransparencyFromObjects(e,t);else{null==i&&(i=!0);for(var o=0;o<t.length;o++)e.setOpacity(t[o],n,i),1!=r&&e.setPickability(t[o],"IGNORED",i)}},getCurrentSceneGraphState:function(e,t,n){return e.sgState||(e.sgState=this.createNewSceneGraphStateHelper(e,t,"VisibilitySG")),e.sgState},getCurrentSceneGraphIsolateState:function(e,t,n){return this.createNewSceneGraphStateHelper(e,t,"VisibilitySG_Isolate")},createNewSceneGraphStateHelper:function(e,t,n){return e.createSceneGraph(n)},resetCurrentSceneGraphState:function(e){e.sgState=null},setCurrentSceneGraphState:function(e,t){e.sgState=t,e.setCurrentSceneGraphState(e.sgState)},setVisibilityOfAnnotations:function(e,t,n){(n||e.getRootNode()).children.forEach((function(e){"annotGroupNode"==e.name&&e.setVisibility(t)}))},setVisibilityOfSectionsAndMeasures:function(e,n,r){r||e.getRootNode();n?t.publish({event:"3DPLAY/EXPLODE/END"}):t.publish({event:"3DPLAY/EXPLODE/START"})}}})),define("DS/3DPlayUtils/DFATools",[],(function(){"use strict";return{getFormat:function(e){let t=e.mimetype||e.format;return e.DFA&&e.DFA.format&&(t=e.DFA.format),t},getTarget:function(e){if(e.DFA&&e.DFA.target)return e.DFA.target},getType:function(e){let t=e.type;return e.DFA&&e.DFA.target&&(t=e.DFA.target),t}}})),define("DS/3DPlayUtils/LeftPanel",["UWA/Core","UWA/Class","DS/Panels/SidePanel","css!DS/3DPlayUtils/LeftPanel"],(function(e,t,n,r){return t.extend({init:function(t){this.leftPanel=new n({side:"left"}).inject(t.container);for(var r=new e.Element("div",{id:"MAIN_CONTAINER",styles:{height:this.leftPanel.elements.panel.clientHeight+"px","overflow-y":"scroll"}}).inject(this.leftPanel),i=new e.Element("div",{id:"SHEET_LIST_CONTAINER"}).inject(r),o=[],s=function(e){for(var t=0;t<o.length;t++){var n=o[t];n.className.indexOf("selected")>0&&n.removeClassName("selected")}(e.target?e.target:e.srcElement).addClassName("selected")},a=0;a<t.items.length;a++){var l=t.items[a],c="Sheet_"+(a+1),u=new e.Element("div",{id:c,class:"leftpanel-item",events:{click:l.onClickCB}}).inject(i);u.addEvent("click",s),u.appendText(c),o.push(u)}},dispose:function(){}})})),define("DS/3DPlayUtils/SpreadGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],(function(e,t,n){"use strict";var r=n.extend({init:function(){return this._parent("Spread"),this.touches=[],this.fingersVector0_1=new e.Vector2,this.fingersVector1_2=new e.Vector2,this.fingersVector2_0=new e.Vector2,this.latencyTime=30,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMin=0,this},detect:function(e){switch(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view),3===this.touches.length&&(this.fingersVector0_1.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),this.fingersVector1_2.subVectors(this.touches[2].currentPosition,this.touches[1].currentPosition),this.fingersVector2_0.subVectors(this.touches[0].currentPosition,this.touches[2].currentPosition),null===this.distance&&(this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.lastDistance=this.distance,this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.state){case n.State.INIT:this.distance=null,3===this.touches.length&&(this.preventDefault(this.touches),this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.changeState(n.State.BEGIN));break;case n.State.BEGIN:case n.State.CHANGE:3===this.touches.length?(this.events=this.touches,this.preventDefault(this.events),this.changeState(n.State.CHANGE)):this.changeState(n.State.KO);break;case n.State.KO:case n.State.OK:case n.State.CANCEL:this.changeState(n.State.INIT),this.touches=[],this.distance=null}},preventDefault:function(e){for(var t=0;t<e.length;t++){var n=e[t].getJSEvent();n.preventDefault&&n.preventDefault()}}});return UWA.namespace("3DPlayModelViewer/SpreadGesture",r)})),define("DS/3DPlayUtils/BrowserSupportList",[],(function(){"use strict";return{winphone:{8.1:{ie:{isSupported:function(e){return BrowserSupport.ok}}}},win:{default:{version:{isSupported:function(e){try{var t=parseFloat(e);return 7===t||8===t||t>=10}catch(e){return!1}}},chrome:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},opera:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},ie:{isSupported:function(e){return BrowserSupport.ok}}}},android:{default:{version:{isSupported:function(e){return parseFloat(e)>=5}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return BrowserSupport.ok}}},4:{chrome:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}}}},macosx:{default:{version:{isSupported:function(e){try{return parseFloat(e)>=10.1}catch(e){return!1}}},safari:{isSupported:function(e){return BrowserSupport.ok}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}}},10.9:{safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}}}},ios:{default:{version:{isSupported:function(e){return e<8?BrowserSupport.partial:BrowserSupport.ok}},safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}},netscape:{isSupported:function(e){return BrowserSupport.ok}}}}}})),define("DS/3DPlayUtils/ServiceURL",["UWA/Core","DS/WebUtils/WebServices"],(function(e,t){"use strict";return console.error("DS/3DPlayUtils/ServiceURL has been moved to (DS/WebUtils/WebServices).getServiceURL"),t.getServiceUrl})),define("DS/3DPlayUtils/TestBrowser",["DS/3DPlayUtils/BrowserSupportList","DS/WebSystem/DetectBrowser"],(function(e,t){"use strict";return function(){var n,r=!1,i=document.createElement("canvas");try{(n=i.getContext("webgl"))&&(r=!0)}catch(e){}if(!n)try{(n=i.getContext("experimental-webgl"))&&(console.warn("experimental-webgl"),r=!0)}catch(e){}if(0==r)return BrowserSupport.none;if("undefined"==typeof Worker)return BrowserSupport.none;var o=t(),s=e[o.os.name];if(void 0!==s){var a=s[o.os.version];if(void 0===a&&(void 0===(a=s.default)||void 0!==a.version&&void 0!==a.version.isSupported&&!1!==a.version.isSupported(o.os.version)||(a=void 0)),void 0!==a){var l=a[o.browser.name];if(void 0!==l&&void 0!==l.isSupported)return l.isSupported(o.browser.version)}}return BrowserSupport.partial}})),define("DS/3DPlayUtils/XCADSpatialSupport",["DS/3DPlaySupport/XCADSpatialSupportedFormats","UWA/Core","DS/3DPlayUtils/ConvertService","DS/WebSystem/Environment","DS/WebInfraUI/Notification","DS/WebUtils/Logger","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/WebUtils/ProbesManager","DS/WebSystem/Nls","DS/WebSystem/App","DS/WAFData/WAFData","i18n!DS/3DPlay/assets/nls/3DPlay","DS/3DPlaySupport/OfficeFiles"],(function(e,t,n,r,i,o,s,a,l,c,u,p,d,h){"use strict";var v,f,g,m={},S={};return n.extend({init:function(n){var c;this._parent(),this.logger=o("3DPlay.XCADSpatialSupport","3DPlay.Log.Convert"),this._exp=n,this.connector3DSpace=null,this._counter=0,this.supportedFormats=e,n.extendedXCADSupport&&t.extend(this.supportedFormats,n.extendedXCADSupport,!0),this._convert=function(e){this._computeInfos(e),u.isOnCloud()||e.asset&&e.asset.filename&&e.asset.filename.includes&&e.asset.filename.includes("3DPlayExperiencesTest")||e.asset&&e.asset.serverurl&&e.asset.serverurl.includes&&e.asset.serverurl.includes("3DPlayExperiencesTest")?this._isOffice(e)?this._isSourceSourcing(e)||this._isSource3DSocialMedia(e)||this._isSource3DDrive(e)||this._isSource3DSpace(e)?this._convertDFA(e):this._displayFatal(e):this._isSource3DDrive(e)||this._isSourceSourcing(e)?"EXTERNAL"==e.computedInfos.provider.toUpperCase()||e.asset.user&&"guest"==e.asset.user&&null==e.asset.previewToken&&null==e.asset.originalAsset.previewToken||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest")||e.asset.serverurl&&e.asset.serverurl.includes("3DPlayExperiencesTest")?this._convertCO(e):this._convertDFA(e):this._isSource3DSpace(e)?this._isAssembly(e)?this._displayUnsupported(e):"ODT_Tenant"===e.asset.tenant||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest")?this._convertCO(e):this._convertDFA(e):this._convertCO(e):this._displayFatal(e)},this._computeInfos=function(e){e.computedInfos=e.asset,e.asset&&e.asset.originalAsset?(e.computedInfos=e.asset.originalAsset,e.asset.DFA?(e.computedInfos.provider=e.asset.DFA.provider,e.asset.DFA.realType&&(e.computedInfos.type=e.asset.DFA.realType),e.computedInfos.physicalid=e.asset.DFA.physicalid):"FILE"==e.asset.provider&&e.asset.physicalid&&(e.computedInfos.physicalid=e.asset.physicalid)):this._isSource3DDrive(e)?e.computedInfos={type:e.asset.format,provider:e.asset._3DPlayDatas&&!0===e.asset._3DPlayDatas.externalDrive?"EXTERNAL":"3DDRIVE",physicalid:e.asset.physicalid}:("ODT_Tenant"===e.asset.tenant||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest"))&&(window.isCloud=!0,e.computedInfos.provider||(e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&"prt"==e.asset.type&&(this.connector3DSpace={open:function(e,t){t({url:"test_url"})}}),e.computedInfos.provider="EV6"))},this._isAssembly=function(e){return"asm"===e.asset.dataFormat},this._isSourceSourcing=function(e){return e&&e.computedInfos&&e.computedInfos.provider&&"SOURCING"===e.computedInfos.provider.toUpperCase()},this._isSource3DSocialMedia=function(e){return e&&e.computedInfos&&e.computedInfos.provider&&"SOCIALMEDIA"===e.computedInfos.provider.toUpperCase()},this._isSource3DDrive=function(e){return u.is3DDrive()||e&&e.computedInfos&&e.computedInfos.provider&&"3DDRIVE"===e.computedInfos.provider.toUpperCase()},this._isSource3DSpace=function(e){return"EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider.toUpperCase()},this._isOffice=function(e){var t=e.asset.DFA?e.asset.DFA.format:e.asset.type;return h.indexOf(t.toUpperCase())>=0},this._displayFatal=function(e){this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:i.fatal},e.asset)},this._displayUnsupported=function(e){this.logger.error("Unsupported format"),this.logger.error(arguments),e.onConvertError({nls:"LoadingError_FORMAT",level:i.fatal},e.asset)},this._convertDFA=function(e){var t=this,n=e.asset,r=function(){t.profilerLocateOpen=l.createProbe("XCAD_Preprocess"),t.profilerLocateOpen.begin(),t._startLocate(e,!0),t=null,n=null};e.asset.guestDFAServerUrl?S[n.tenant]=e.asset.guestDFAServerUrl:e.asset.originalAsset.guestDFAServerUrl&&(S[n.tenant]=e.asset.originalAsset.guestDFAServerUrl),S[n.tenant]?r():s.getServiceUrl({serviceName:"derivedformataccess",logger:t.logger,platformId:n.tenant,onSuccess:function(e){S[n.tenant]=e.url,e.platformId!==n.tenant&&t.logger.warn("DerivedFileAccess desired Tenant:",n.tenant,"got ",e.platformId),t.logger.warn("DerivedFileAccess : URL found > ",S[n.tenant]),r()},onError:function(n){t.logger.error("Ooops, missing Service : ",n.serviceName,"Reason : ",n.error),t._displayFatal(e),t=null}})},this._convertCO=function(e){if(u.isOnCloud()&&this._isOffice(e))return this.logger.error("Conversion error"),this.logger.error(arguments),void e.onConvertError({nls:"LoadingError_FORMAT",level:"fatal"},t);if(v){var t=e.asset;if(!m[t.tenant]){if(!r.isSet("3DPlay.ProtoConvertSpatial")||"true"===r.get("3DPlay.ProtoConvertSpatial")){var n=this;return void s.getServiceUrl({serviceName:"SPAContentOptimizer",logger:n.logger,platformId:t.tenant,onSuccess:function(r){m[t.tenant]||(m[t.tenant]=y(r.url)),r.platformId!==t.tenant&&n.logger.warn("XCADSpatialSupport desired Tenant:",t.tenant,"got ",r.platformId),n.logger.warn("XCADSpatialSupport : URL found > ",m[t.tenant]),n._startConvert(e),n=null},onError:function(r){n.logger.error("Ooops, missing Service : ",r.serviceName,"Reason : ",r.error);var o={nls:"Convert_SERVICE_NOT_FOUND",level:i.warning,abort:!0};e.onConvertError(o,t),n=null}})}m[t.tenant]=r.get("3DPlay.ProtoConvertSpatial"),this.logger.warn("XCADSpatialSupport (using envar value) : URL found > ",m[t.tenant])}this._startConvert(e)}else{var o=this;require(["DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/COptConvertOption","DS/SPAContentOptimizer/coptConvertV1"],(function(t,n,r){v=t,f=n,g=r,o._convert(e),o=null}))}};var y=function(e){var n=t.Utils.parseUrl(e);return n.authority+n.directoryPath};this._startLocate=function(e,n){var i=this,o=e.asset;this.located=!1,this.logger.warn("XCADSpatialSupport._startLocate");var s=e.computedInfos.contextid?e.computedInfos.contextid:e.computedInfos.contextId?e.computedInfos.contextId:"preferred";r.get("PreferredCredentials")&&(s=r.get("PreferredCredentials"));var a="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==e.computedInfos.provider.toUpperCase()&&"3DSPACE"!==e.computedInfos.provider.toUpperCase()||(a+="&SecurityContext="+encodeURIComponent(s)),"asm"===o.dataFormat&&(o.dataFormat="3dxml");var c=S[o.tenant]+a,u={specificationFilter:[{format:o.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===e.computedInfos.provider.toUpperCase()?"3DSpace":e.computedInfos.provider,id:e.computedInfos.physicalid,type:e.computedInfos.type}]};!0===n&&(u.specificationFilter[0].notifyIfMissing=!0),0==i._counter&&l.begin("XCAD_Convert");var d={"Content-Type":"application/json",SecurityContext:s};e.asset.previewToken?d.previewToken=e.asset.previewToken:e.asset.originalAsset.previewToken&&(d.previewToken=e.asset.originalAsset.previewToken),p.authenticatedRequest(c,{method:"POST",headers:d,type:"json",data:JSON.stringify(u),onComplete:function(n){if(console.log("onComplete locate"),n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){i._counter=0;var s=S[o.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+n.derivedOutputs[0].id+"/DerivedOutputFiles/"+n.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";l.end("XCAD_Convert");var a=n;p.authenticatedRequest(s,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(n){console.log("onComplete download ticket");var l=n.data[0].dataelements,c=l.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(l.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",u=t.clone(o);e.onConvertSuccess(t.extend(u,{provider:"FILE",filename:c,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:o.type,mimetype:o.dataFormat||o.mimetype,format:o.dataFormat||o.mimetype,type:o.dataFormat||o.mimetype})),console.log("Loading from DFA : "+c),i.profilerLocateOpen.end(),r.isSet("3DPlay.downloadConvertResult")&&p.authenticatedRequest(s,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete second download ticket for debug");var t=e.data[0].dataelements,n=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",r=document.createElement("a");r.download="DFA_Download_File."+o.dataFormat||o.mimetype,r.innerHTML="Download File",r.href=n,r.onclick=function(e){document.body.removeChild(e.target)},r.style.display="none",document.body.appendChild(r),r.click()}}),i._handleCR(a,o)},onFailure:function(e){console.log("onFailure download ticket"),i.profilerLocateOpen.end()}})}else if(n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"KO"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status)i._handleCR(n,o);else if(!i._stop){i._counter>210&&(i._stop=!0);var c=i._counter++<10?1e3:3e3;console.log(" restart locate in "+c+" ms"),setTimeout(i._startLocate.bind(i,e,!1),c)}},onFailure:function(t){console.log("onFailure locate"),i._counter=0,i._displayFatal(e),i.profilerLocateOpen.end(),i.profilerLocateOpen=null}})},this._handleCR=function(e,t){var n=this,r=S[t.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+e.derivedOutputs[0].id+"/DerivedOutputFiles/"+e.derivedOutputs[0].derivedOutputFormats[0].id+"/ConversionReport/"+e.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.id+"/DownloadTicket";p.authenticatedRequest(r,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete report download ticket");var t=e.data[0].dataelements,r=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true";p.authenticatedRequest(r,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){if(console.log("onComplete report download"),1==e.reportFileVersion)e.warnings&&e.warnings.length>0&&(e.warnings[0].includes("Error : The input file is saved in Civil3D. Output might be incomplete.")?SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.warning,{msg:d.Convert_Civil3D_Warning}):e.warnings[0].includes("Alert ! Text layout could look different as some fonts are not present on the system !")&&SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.info,{msg:d.Convert_MissingFonts_Warning}));else if(2==e.reportFileVersion){for(var t=0;t<e.warnings.length;t++)"PartialResult"==e.warnings[t].category&&("IncompleteResultFromCivil3D"==e.warnings[t].id?SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.warning,{msg:d.Convert_Civil3D_Warning}):"CroppedPageForXLS"==e.warnings[t].id?SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.warning,{msg:d.Convert_CroppedPageForXLS_Warning}):"ConversionWithMissingFonts"==e.warnings[t].id&&SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.info,{msg:d.Convert_MissingFonts_Warning}));for(t=0;t<e.errors.length;t++)"UnsupportedInput"==e.errors[t].category&&("UnsupportedFileVersion"==e.errors[t].id?SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.fatal,{msg:d.Convert_NOTSUPPORTED_SOLIDWORKS}):"UnsupportedParasolidBareBinary"==e.errors[t].id&&SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.fatal,{msg:d.Convert_NOTSUPPORTED_BIN})),e._doFallback=!1;for(t=0;t<e.warnings.length;t++)if("MissingInput"==e.warnings[t].category&&"MissingInputFiles"==e.warnings[t].id){for(var r="",i=0;i<e.warnings[t].parameters.length;i++)r+=e.warnings[t].parameters[i];SHARE.Core.sendEvent(n._exp.args.ctx,eventType.notif,notification.warning,{msg:d.Convert_MISSING_FILES+" "+r})}}},onFailure:function(e){console.log("onFailure report download")}})},onFailure:function(e){console.log("onFailure report download ticket")}})};var D="Not initialized";this._startConvert=function(e){var t=this;this.connected=!1,this.logger.warn("XCADSpatialSupport._startConvert");var n={onHypervisorDisconnect:function(){t.logger.warn("XCADSpatialSupport._startConvert: CSIServer Hypervisor Disconnected"),t.connected?t.connected=!1:(t.logger.error("Unable to connect"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},e.asset))},onHypervisorConnect:function(){t.connected=!0,t.logger.warn("CSIServer Connected")},onDisconnect:function(){t.logger.warn("CSIServer Node Disconnected")},authentication:function(e,n,r){t.logger.warn("CSIServer authentication");var i=encodeURIComponent(D).replace(/'/g,"%27").replace(/"/g,"%22");a.authenticatedRequest(e.passportURL+"/login?service="+i,{method:"GET",headers:{Accept:"application/json"},onComplete:function(e){try{t.logger.warn("CSIServer authentication onComplete");var i=JSON.parse(e).access_token;n(D,i)}catch(n){r("Failed to parse ticket"),t.logger.error("Failed to parse ticket : "+e)}},onFailure:function(e,n){r("Failed to retrieve ticket"),t.logger.warn("CSIServer authentication onFailure"),t.logger.error("Failed to retrieve ticket: "+n)}},"XCAD_Authentication")}},r=m[e.asset.tenant];""===r||void 0===r?(n.hypervisorIp=c,n.webSocketPort=undefined,this.logger.warn("Trying to Connect via IP> "+c),D="https://"+n.hypervisorIp+":"+n.hypervisorPort):(n.hypervisorUrl=r,n.ssl=!0,this.logger.warn("Trying to Connect via hypervisorUrl : "+r),D="https://"+n.hypervisorUrl);var i=v.getPool("application.webWidget").createNode(n);"prt"===e.asset.type?this._execOpenCmd(e,i):this._execConvertCmd(e,i)}},_execOpenCmd:function(e,t,n){n=t.select("ContentOptimizer"),this.logger.warn("_execOpenCmd");var r,i=this,o=e.asset,s=function(){e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},o)};(r=l.createProbe("XCAD_Preprocess")).begin();var a=new v.Parameters;a.writeString("inputFileName",o.filename||"DummyName."+(o.format||o.mimetype)),a.writeString("inputFileUrl",o.url),t.call({destinationNodeId:n,name:"coptOpen",version:1,parameters:a,onSuccess:function(a){i.logger.warn("answerOpenResultCB._execOpenCmd"),r.end(),r=null,setTimeout((function(){var r;if(r=a.readUint8("DocumentType"),(2===r||3===r)&&"prt"===o.type)s();else if(e.asset&&e.computedInfos&&e.computedInfos.provider&&("EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider)){var c=l.createProbe("3DSpaceDocumentConnector");c.begin();var u=function(r){c&&(c.end(),c=null),e.asset.url=r.url,i._execConvertCmd(e,t,n)};i.connector3DSpace?i.connector3DSpace.open(e.computedInfos,u,s):(i.connector3DSpace="DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector",require([i.connector3DSpace],(function(t){i.connector3DSpace=new t,i.connector3DSpace.open(e.computedInfos,u,s)}),s))}else i._execConvertCmd(e,t,n)}),1)}.bind(this),onError:s.bind(this)})},_execConvertCmd:function(e,n,o){this.logger.warn("_execConvertCmd");var s=e.asset,c=function(o){var a,c=new g(n);c.onResultFile=function(n,i){if(this.logger.warn("launchConvert.onResultFile",n),l.end("Download"),l.end("_execConvertCmd"),!0!==n||(this._exp.loadingAsset.size=i.byteLength,!i))return this.onErrorsVisited||(this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:"fatal"},s)),this.cleanNode(c),!0;var o=new Blob([i]);r.isSet("3DPlay.downloadConvertResult")&&require(["DS/WebSystem/Downloader"],(function(e){e("XCAD-Converted-File."+s.dataFormat,o)}));var a=t.clone(s);e.onConvertSuccess(t.extend(a,{provider:"FILE",filename:window.URL.createObjectURL(o),proxyurl:"none",requiredAuth:null,serverurl:"",originalType:s.type,mimetype:s.dataFormat||s.mimetype,format:s.dataFormat||s.mimetype,type:s.dataFormat||s.mimetype}))}.bind(this),c.onErrors=function(t){var n;this.logger.error("Conversion error",t);try{n=JSON.parse(t)}catch(e){n=void 0}if(n&&n.errorCode>=500)return this.onErrorsVisited=!0,void("The connection with the server node has been closed before any success or error answer"===n.error&&e.onConvertError({nls:"Convert_ERROR",level:"fatal"},s));if(t&&t[0]&&t[0].split("\n")){var r=t[0].split("\n");"Please check the documentation for supported file versions and resave the file in one of supported versions if possible"===r[2]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_SOLIDWORKS",level:i.fatal},s),this.onErrorsVisited=!0):"InterOp Diagnostic: The input Parasolid file is Bare binary file which is an unsupported format."===r[1]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_BIN",level:i.fatal},s),this.onErrorsVisited=!0):"Translation failed for unknown error."===r[0]?(e.onConvertError({nls:"Convert_ERROR",level:i.fatal},s),this.onErrorsVisited=!0):"Error : The input file is saved in Civil3D. Output might be incomplete."===r[0]?SHARE.Core.sendEvent(this._exp.args.ctx,eventType.notif,notification.warning,{msg:d.Convert_Civil3D_Warning}):(e.onConvertError({nls:"Convert_ERROR",level:i.fatal},s),t[1]&&console.log("Error : "+t[1]),this.onErrorsVisited=!0)}}.bind(this),c.onMissingFiles=function(t){if(this.logger.error("Missing Files domain"),t&&("sldasm"!==s.type||"sldasm"!==s.format||"sldasm"!==s.mimetype)){this.logger.error(t);for(var n=0;n<t.length;n++){var r=t[n],o=Math.max(r.lastIndexOf("/"),r.lastIndexOf("\\"));-1!==o&&(r=r.substring(o+1,o.length));var a={nls:"Convert_MISSING_FILES",level:i.error,text:" "+r};this._exp&&this._exp.onModelLoadingError&&this._exp.onModelLoadingError(a)}e.onConvertError&&e.onConvertError({nls:"Convert_MISSING_FILES"})}return this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,100),this.cleanNode(c),!0}.bind(this),c.onProgress=function(e){this.logger.warn("launchConvert.onProgress",e),e<.01?(l.end("XCAD_Transfer"),l.begin("XCAD_Convert")):e>.99&&(l.end("XCAD_Convert"),l.begin("Download")),this._exp&&this._exp.getPhaseProgress()&&this.subProgressID&&e&&this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,e/1*100)}.bind(this),e.ConversionOpts&&(a=new f,Object.keys(e.ConversionOpts).forEach((function(t){void 0!==e.ConversionOpts[t]&&a["Set"+t](e.ConversionOpts[t])}))),l.begin("_execConvertCmd"),l.begin("XCAD_Transfer");var u=s.url,p=s.filename;(!u||e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&!0===e.asset._3DPlayDatas.externalDrive)&&(u=p,p="");var h=p||"DummyName."+(s.format||s.mimetype);"asm"===s.dataFormat&&(s.dataFormat="3dxml"),o?(this.logger.warn("_execConvertCmd.convert",h,o,s.dataFormat,a),c.convert(h,o,s.dataFormat,a)):(this.logger.warn("_execConvertCmd.convertUrl",h,u,s.dataFormat,a),c.convertUrl(h,u,s.dataFormat,a))};if(s._3DPlayDatas&&s._3DPlayDatas.externalDrive){if("asm"===s.dataFormat)return void e.onConvertError({nls:"Convert_FILE_NOT_LOADED",level:"fatal"},s);var u=s.requestsOptions||{};u.type="arraybuffer",u.timeout=5e4,l.begin("XCAD_DownloadExternalDrive");var p=this;u.onComplete=function(e){l.end("XCAD_DownloadExternalDrive");var t=new Uint8Array(e);c.apply(p,[t]),p=null},u.onFailure=u.onTimeout=function(t){l.end("XCAD_DownloadExternalDrive"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED",level:"fatal"},s),p=null},a.handleRequest(s.filename,u)}else c.apply(this)},cleanNode:function(e){setTimeout((function(){e._node.stop(),e=null}),1e3)},dispose:function(){this._exp=null,this._stop=!0,this._counter=0}})}));var t=["DS/TagNavigatorProxy/TagNavigatorProxy"];define("DS/3DPlayUtils/PanelManager",["DS/3DPlay/3DPlay","UWA/Core","UWA/Class","UWA/Controls/TabView","DS/TopBarProxy/TopBarProxy","DS/WebSystem/Environment","DS/3DPlayUtils/UIManager","DS/UIKIT/Spinner","DS/WebSystem/DataUrlTools","DS/WebSystem/DetectBrowser","DS/3DPlayUtils/PublishToSwym","DS/WebSystem/Nls","DS/3DPlayUtils/FullScreen","DS/WebUtils/ContextedSingleton","DS/WebSystem/Settings","DS/Utilities/Css","DS/WebSystem/App","DS/WebUtils/Tracker","i18n!DS/3DPlay/assets/nls/3DPlay","DS/WebSystem/SessionManager","DS/SwymUICore/script/feature/core/mobile/communication-manager"].concat(t),(function(e,t,n,r,i,o,s,a,l,c,u,p,d,h,v,f,g,m,S,y,D,C){"use strict";return n.extend({init:function(e){this.showVersion=!0,this.UIManager=new s(e);var t=new Date;this.lastClickTime=t.getTime(),this.panelContent={},this.panelContent.wait=this._generateWaitingUI(),this.experience=e.frameWindow.experience},getSession:function(){return y.getSession()},setTopBarId:function(e){if(void 0===this.generated){if(this.generated=!0,e.topBarId&&(e.topBar={id:e.topBarId},console.error("API Migration : please don t use options.topBarId"),console.error("API Migration : use instead options.topBar.id")),!o.isSet("3DPlay.DisableTagger")&&g.is3DPlay()){var n=window.widget&&window.widget.id;n&&(this.tagger={proxyOptions:{filteringMode:"WithFilteringServices",widgetId:n,pod:"6WTags"},TagNavigatorProxy:C,experience:this.experience,dispose:function(){this.tagger&&this.tagger.die(),this.tagger=null,this.token&&this.experience.unsubscribe(this.token),this.token=null},activate:function(e){this.tagger&&(void 0===e||!0===e?this.tagger.activate():this.tagger.deactivate())},proxyTag:function(){this.tagger||(this.tagger=this.TagNavigatorProxy.createProxy(this.proxyOptions),this.tagger.addEvent("onFilterSubjectsChange",function(e){e&&(e.filteredSubjectList&&e.filteredSubjectList[0]&&"3DPlayAsset"===e.filteredSubjectList[0]?this.experience.isLoadingFinished()||this.experience.load(this.experience.args.input):(this.experience.modelLoadComplete=void 0,this.experience.clearView()),this.experience.getInformationsOnAsset()&&m.trackPageEvent("interactions","6wTags",this.experience.getInformationsOnAsset().type))}.bind(this))),this.token?console.error("not supposed to be here"):this.token=this.experience.addOnLoadingStartedCB(function(e){if(this.experience.args&&this.experience.args.input){var n=this.experience.args.input.asset;if(n&&"FILE"===(this.experience.currentProvider||n.provider)){if(this.currentTag=[],n.swymAttr&&n.swymAttr.tags6w_implicit&&n.swymAttr.tags6w_implicit.length>0){var r=this.currentTag;n.swymAttr.tags6w_implicit.forEach((function(e){r.push({object:e.type,sixw:e.predicate,dispValue:e.tag})}))}else if(n.driveAttr){n.driveAttr.fullnameowner&&this.currentTag.push({object:n.driveAttr.fullnameowner,sixw:"ds6w:who/ds6w:responsible",dispValue:n.driveAttr.fullnameowner}),n.driveAttr.originator&&this.currentTag.push({object:n.driveAttr.originator,sixw:"ds6w:who/ds6w:responsible/ds6w:originator",dispValue:n.driveAttr.originator}),n.driveAttr.modified&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*n.driveAttr.modified),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:modified",type:"date"}),n.driveAttr.created&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*n.driveAttr.created),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:created",type:"date"}),n.driveAttr.type&&this.currentTag.push({object:n.driveAttr.type,sixw:"ds6w:what/ds6w:type",dispValue:n.driveAttr.type});var i=n.driveAttr.fileExtension||n.driveAttr.extension;i&&("string"==typeof i||i instanceof String)&&(i={catanalysis:"CATAnalysis",catdrawing:"CATDrawing",catmaterial:"CATMaterial",catpart:"CATPart",catprocess:"CATProcess",catproduct:"CATProduct",catshape:"CATShape",catsystem:"CATSystem"}[i.toLowerCase()]||i.toUpperCase(),this.currentTag.push({object:i,sixw:"ds6w:what/ds6w:docExtension",dispValue:i})),n.driveAttr.dataSource&&this.currentTag.push({object:n.driveAttr.dataSource,sixw:"ds6w:where/ds6w:source/ds6w:dataSource",dispValue:dataSource})}this.tagger.setSubjectsTags({"3DPlayAsset":this.currentTag||[]})}}else console.log((new Error).stack)}.bind(this)),this.tagger.setSubjectsTags({"3DPlayAsset":[]})}})}if(i){var r={};if(e.topBar&&e.topBar.id?r=e.topBar:window.widget&&window.widget.id&&(r.id=window.widget.id),r.id){for(var s=window;!s._swymData43DPlay&&s.parent&&s!==s.parent;)s=s.parent;if(s._swymData43DPlay)try{r.options={rightParentWindow:s.parent}}catch(e){}this.topBarProxy=new i(r),!1!==e.activeState&&"false"!==e.activeState||this.topBarProxy.deactivate()}}}},setVisibility:function(e){this.isTopBarAvailable()?this.topBarProxy&&(!1===e?this.topBarProxy.deactivate():this.topBarProxy.activate()):this.topMenuContainer&&(this.topMenuContainer.style.display=e?"":"none")},dispose:function(){this.UIManager&&(this.UIManager.dispose(),this.UIManager=null),this.panel=null,this.currentPanel=null,this.panelContainer=null,this.topMenuContainer=null,this.experience=null,this.panelClose=null,this.isTopBarAvailable()&&(this.topBarProxy.die(),this.topBarProxy=null),this.tagger&&(this.tagger.dispose(),this.tagger.experience=null,this.tagger=null)},isTopBarAvailable:function(){return void 0!==this.topBarProxy},createTopMenu:function(e){var n=e.container,r=this;if(this.experience=e.experience,this.ctx=e.ctx,this.panel=new t.Element("div",{attributes:{id:"PlayWeb-Panel",class:"SHAREPluginless_noSelect"}}),this.panelClose=new t.Element("span",{class:"CloseBtn"}).addEvent("click",(function(){r.panelContainer.style.display="none"})).addEvent("touchstart",(function(){r.panelContainer.style.display="none"})),new t.Element("span",{class:"fonticon fonticon-cancel"}).inject(r.panelClose),new t.Element("span",{class:"fonticon fonticon-cancel-circled"}).inject(r.panelClose),this.panel.appendChild(r.panelClose),this.panelContainer=f.verticalAlign(this.panel),this.panelContainer.id="PlayWeb-Panel-CSSV",this.panelContainer.setStyles({position:"absolute","text-align":"center","pointer-events":"none",display:"none","z-index":"10",top:"0px"}),this.panelContainer.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1),this.panelContainer.inject(n),this.isTopBarAvailable()){var i=!1,s=!1;require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],(function(e){e.getPlatformServices({onComplete:function(e){for(var t=0;t<e.length&&(e[t]["3DSwym"]&&""!==e[t]["3DSwym"]&&(s=!0),!0!==s);t++);i=!0},onFailure:function(){console.error(S.PlatformNotFound),i=!0}})}),(function(e){if("scripterror"===e.requireType){var t=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",t)}else console.error(e);console.error(S.ScripNotFoundError),i=!0}));var a=0,l=setInterval((function(){11!==++a&&!0!==i||(clearInterval(l),l=void 0,i=!1,(!0===s||o.isSet("ODT_3DPlay_PanelManager"))&&(s=!1),o.isSet("3DPlay.Statistics")&&r.topBarProxy&&r.topBarProxy.setContent({share:[{label:"Dump PCS",submenu:[{label:"All times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("Full")}},{label:"3DPlay Times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("3DPlay",!0)}}]}]}))}),100)}else if(!0===e.showBubbleMenu||o.isSet("3DPlay.ShowBubbleMenu")){this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container);var c=new t.Element("span",{id:"PlayWeb-Save-Annotations",class:"PlayWeb-button",events:{click:function(){if(v.get("3DPlay.PersistedAnnotationsEnabled")){var e=h.get(r.ctx,"ANNOTATION_MANAGER");if(e){var t=e.saveAnnotationsToJSON();v.set("3DPlay.AnnotJson",t),alert("Annotations saved !!!")}}}}}).inject(this.topMenuContainer),u=new t.Element("span",{id:"PlayWeb-Create-Saved-Annotations",class:"PlayWeb-button"}).inject(this.topMenuContainer),p=v.get("3DPlay.AnnotJson");p?u.addEvent("click",(function(){v.get("3DPlay.PersistedAnnotationsEnabled")&&require("DS/3DPlayAnnotationUtils/AnnotationManagerUtils",(function(e){e.getAnnotationManager(r.ctx).drawAnnotationsFromJSON(p)}))})):u.style.display="none",this.panelContent.publish=this._generatePublishUI();var g=new t.Element("span",{id:"PlayWeb-Publish",class:"PlayWeb-button"}).inject(this.topMenuContainer);g.addEvent("click",(function(){r._togglePanel(r.panelContent.publish)})),g.addEvent("touchend",(function(){r._togglePanel(r.panelContent.publish)})),this.helpBtn=new t.Element("span",{id:"PlayWeb-Help",class:"PlayWeb-button"}).inject(this.topMenuContainer),g.setAttribute("title",S.Publish_Title),r.helpBtn.setAttribute("title",S.Help_Title),c.setAttribute("title",S.SaveAnnotation_Title),u.setAttribute("title",S.CreateSavedAnnotation_Title),this.openHelpPanel=function(e){void 0!==e&&r.Tab.selectTab(e),r._togglePanel(r.panelContent.help)},this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,(function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")}))}var m=this.experience&&this.experience.args?this.experience.args:{};if(m.commandFullscreen||m.options.fullscreen){var y=new t.Element("span",{id:"PlayWeb-Fullscreen",class:"PlayWeb-button"}),D=new d(m.container,m.options.fullscreen,y,m.widget||window.widget);"none"!==D.getMode()&&(this.topMenuContainer||(this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container),this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,(function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")}))),y.inject(this.topMenuContainer),y.addEvent("click",(function(){D.toggle(y)})),m.options&&m.options.fullscreen&&m.options.fullscreen.activateOnStart&&y.click())}},_togglePanel:function(e){e!==this.currentPanel?(this.currentPanel&&this.panel.removeChild(this.currentPanel),this.panel.appendChild(e),this.currentPanel=e,this.panelContainer.style.display="table",this.currentPanel===this.panelContent.wait?this.panelClose.style.display="none":this.panelClose.style.display=""):"none"===this.panelContainer.style.display?this.panelContainer.style.display="table":this.panelContainer.style.display="none"},_generatePublishUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"}),n=this,r=function(){setTimeout((function(){n._printScreenshot()}),100)};new t.Element("li",{id:"Print_Menu_Item",html:S.Publish_Print,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",r).addEvent("touchstart",r);var i=function(){setTimeout((function(){n._saveScreenshot()}),100)};return new t.Element("li",{id:"Save_Menu_Item",html:S.Publish_Save,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",i).addEvent("touchstart",i),e},_generateWaitingUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"});return new a({className:"large",visible:"true"}).inject(e),e.appendChild(document.createElement("br")),new t.Element("span",{html:S.GeneratingScreenshot}).inject(e),e},createDefaultHelp:function(){var e=[];if(!0===this.experience.args.touch){e.push({id:"Menu_Touch",event:"touchend",array:[["icTouchPan","HelpTouchPan"],["icTouchZoom","HelpTouchZoom"],["icTouchRotate","HelpTouchRotate"],["icTouchReframe","HelpTouchReframe"]]})}e.push({id:"Menu_Mouse",event:"click",array:[["icMouseLeft","HelpRotateBtn"],["icMouseMiddle","HelpZoomBtn"],["icMouseRight","HelpZoomAltBtn"],["icMouseMiddle","HelpDragBtn"]]}),this.setHelpContent(e)},setHelpContent:function(e){this.panelContent.help=this._generateHelphUI(e)},_generateHelphUI:function(e){var n=this,i=[],o=[],s=[];this.maxHeight=0;for(var a=e,l=0;l<a.length;l++)s[l]=a[l].id;this.showVersion&&s.push("Menu_About");for(var c=new t.Element("div"),u=function(e){return function(){var t=new Date;n.currentClickTime=t.getTime(),n.currentClickTime-n.lastClickTime>500&&(n.openHelpPanel(e),n.lastClickTime=n.currentClickTime)}},p=!1,d=!1,h=0;h<s.length;h++)if(h<a.length){var v=a[h].event;if(void 0!==v){"click"===v?p=!0:"touchend"===v&&(d=!0);var f=s[h];n.helpBtn&&n.helpBtn.addEvent(v,u(f))}i.push(new r.Tab({id:s[h],text:S[s[h]]})),o.push(document.createElement("table")),n._fillPanel(c,o[h],a[h].array)}else"Menu_About"===s[h]&&(n.helpBtn&&(!1===p?n.helpBtn.addEvent("click",u("Menu_About")):!1===d&&n.helpBtn.addEvent("touchend",u("Menu_About"))),i.push(new r.Tab({id:s[h],text:S[s[h]]})),o.push(document.createElement("table")),n._fillVersionPanel(o[h]));n.Tab=new r({className:"help",tabs:i,events:{onSelectTab:function(){}}}).inject(c);for(var g=0;g<i.length;g++)i[g].setContent(o[g]);return c},_fillPanel:function(e,t,n){this.maxHeight<n.length&&(this.maxHeight=n.length),e.setStyles({height:66*this.maxHeight+60+"px"});for(var r=[],i=0;i<n.length;i++)r[i]=n[i][1];for(var o=0;o<n.length;o++){var s=document.createElement("tr"),a=document.createElement("td");a.setAttribute("class","ic "+n[o][0]);var l=document.createElement("td");l.appendChild(document.createTextNode(S[r[o]])),l.setAttribute("class","desc"),s.appendChild(a),s.appendChild(l),t.appendChild(s)}},_fillVersionPanel:function(e){var n=document.createElement("tr"),r=document.createElement("td");r.setAttribute("class","logoDS");var i=document.createElement("td");i.appendChild(document.createTextNode(S.Menu_AppName)),i.appendChild(document.createElement("br")),i.appendChild(document.createElement("br"));var o=new t.Element("div",{styles:{"pointer-events":"all"}}).inject(i);new t.Element("a",{html:S.Menu_Documentation,href:"http://www.3ds.com/support/3dplay-app/",target:"_blank",styles:{"pointer-events":"all",color:"#456077"}}).inject(o),i.setAttribute("style","font-size: initial;vertical-align: middle;"),n.appendChild(r),n.appendChild(i),e.appendChild(n),this.maxHeight>0&&(e.style.minHeight=66*this.maxHeight+"px")},_publishToSwYm:function(){this._pictureFlash();var e={ctx:this.ctx};setTimeout((function(){new u(e)}),1e3)},_printScreenshotAfterFlash:function(){var e=this,n=new t.Element("iframe",{styles:{position:"fixed",top:"0",left:"100%",width:"100%",height:"100%"}}).inject(document.body);c&&"firefox"===c().browser.name?n.onload=function(){e._printScreenshotAfterFrameLoaded(n)}:e._printScreenshotAfterFrameLoaded(n)},_printScreenshotAfterFrameLoaded:function(n){var r,i=this;if(c&&"ie"===c().browser.name&&void 0!==i.experience.frmWindow._3dViewer&&null!==i.experience.frmWindow._3dViewer&&void 0!==i.experience.frmWindow._3dViewer.getCurrentSheet&&null!==i.experience.frmWindow.getCurrentSheet&&(r=i.experience.frmWindow._3dViewer.getCurrentSheet()),r&&void 0!==r.svg&&null!==r.svg){if(void 0!==r.getSVGCloneNode&&null!==r.getSVGCloneNode){var s=r.getSVGCloneNode();n.contentWindow.document.body.appendChild(s);try{!1===n.contentWindow.document.execCommand("print",!1,null)&&n.contentWindow.print()}catch(e){n.contentWindow.print()}s=null,setTimeout((function(){document.body.removeChild(n),n=null}),6e4)}}else i.experience.getScreenShot({onSuccess:function(e){var r,i=new t.Element("img",{src:e,styles:{"max-width":"100%","max-height":"100%"}}).inject(n.contentWindow.document.body);r=setInterval((function(){if(i.offsetHeight||i.height){if(clearInterval(r),o.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],(function(e){e.publish({event:o.get("ODT_3DPlay_PanelManager")})}));else try{!1===n.contentWindow.document.execCommand("print",!1,null)&&n.contentWindow.print()}catch(e){n.contentWindow.print()}setTimeout((function(){document.body.removeChild(n),n=null}),6e4)}}),100)},onFail:function(){e.sendEvent(i.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}});r=null},_printScreenshot:function(){var e=this;this._pictureFlash((function(){e._printScreenshotAfterFlash(),e=void 0}))},_saveScreenshotAfterFlash:function(){var n=this;this.experience.getScreenShot({onSuccess:function(e){if(void 0!==window.Windows&&void 0!==window.Windows.Security&&void 0!==window.Windows.Storage){var n=e.replace("data:image/png;base64,",""),r=Windows.Security.Cryptography.CryptographicBuffer.decodeFromBase64String(n),i=new Windows.Storage.Pickers.FileSavePicker;i.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,i.fileTypeChoices.insert("Picture",[".png"]),i.suggestedFileName="myScreenshot",i.pickSaveFileAsync().then((function(e){if(e)return Windows.Storage.FileIO.writeBufferAsync(e,r)}))}else if("download"in document.createElement("a")){var s,a;if(v.get("3DPlay.PersistedAnnotationsEnabled")?(s=e,a="3DPlay_Screenshot.svg"):(s=l.toBlob(e),a="3DPlay_Screenshot.png"),window.WebSystemApp.is3DSwymApp())D.sendDownloadMediaRequest({transientURL:s,extension:"png"});else{var c=new t.Element("a",{href:s,download:a,styles:{visibility:"hidden"}}).inject(document.body);o.isSet("ODT_3DPlay_PanelManager")?require(["DS/CoreEvents/Events"],(function(e){e.publish({event:o.get("ODT_3DPlay_PanelManager")})})):c.click(),document.body.removeChild(c)}}else{if(window.WebSystemApp.is3DSwymApp())D.sendDownloadMediaRequest({transientURL:e,extension:"png"});else window.open("about:blank","3DPlay web","width=1024,height=860").document.body.innerHTML='<img style="max-width:100%;max-height:100%" src="'+e+'" />'}},onFail:function(){e.sendEvent(n.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}})},_saveScreenshot:function(){var e=this;this._pictureFlash((function(){e._saveScreenshotAfterFlash(),e=void 0}))},_pictureFlash:function(e){this.panelContainer.style.display="none";var n=this.experience.frmWindow.getViewerFrame(),r=this.experience.frmWindow.getUIFrame(),i=new t.Element("div",{id:"_3DPlay-Flash",styles:{position:"absolute",top:0,left:0,width:n.clientWidth+"px",height:n.clientHeight+"px","background-color":"white"}}).inject(r),o=1,s=function(){o-=.02,i.setStyle("opacity",o),o<0?(r.removeChild(i),"function"==typeof e&&e()):requestAnimationFrame(s)};s()},_shareTo3DComment:function(){var e=this.experience;this._pictureFlash((function(){var t=function(e,t){var n=new Blob([t],{type:"application/json"});e.getScreenShot({width:240,height:180,type:"jpeg",onSuccess:function(t){var r={screenshot:t,annotation:n};e.onAnnotationShared?(console.log("Social: onAnnotationShared found"),e.onAnnotationShared(r)):(console.log("3DPlay: Launching 3DPlay's social panel"),e.publish("3DPLAY/EXP/3DPLAY3DCOMMENT",{data:r})),e=null}})},n=e.frmWindow.getViewer(),r=n&&n.getCurrentState?n.getCurrentState():void 0;if(r){var i=h.get(e.ctx,"ANNOTATION_MANAGER");t(e,i.saveAnnotationsToJSON(null,r))}else e.updateSession().then((function(){t(e,JSON.stringify(y.getSession()))}))}))},_downloadSourceDocument:function(){!!(this.experience&&this.experience.args&&this.experience.args.input&&this.experience.args.input.asset&&"FILE"===this.experience.args.input.asset.provider&&"pdf"===this.experience.args.input.asset.type)&&window.open(this.experience.args.input.asset.filename,"_blank")}})}));