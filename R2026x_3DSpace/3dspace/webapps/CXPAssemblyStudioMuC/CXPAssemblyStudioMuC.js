define("DS/CXPAssemblyStudioMuC/StuMoveUnderConstraintsBe",["DS/StuCore/StuContext","DS/StuModel/StuBehavior","DS/EP/EP","DS/EPEventServices/EPEvent","DS/MathematicsES/MathsDef","DS/StuRenderEngine/StuActor3D","DS/StuRenderEngine/StuSubProductActor","DS/CXPAssemblyStudioMuCEngine/StuMoveUnderConstraintsManager","DS/EPInputs/EPMousePressEvent","DS/EPInputs/EPMouseMoveEvent","DS/EPInputs/EPMouseClickEvent","DS/EPInputs/EPMouseReleaseEvent","DS/StuCameras/StuInputManager","DS/StuClickable/StuSpatialDoubleTapEvent"],(function(e,t,n,i,o,r,s){"use strict";var a=function(){t.call(this),this.name="MoveUnderConstraints",this._MuCManager=null,this._grabbedActor=null,this._fixedActor=null,this._dragStarted=!1,this._count=0,this._rightHandPosInitial=null,this._leftHandPosInitial=null,this._rightHandPos=null,this._leftHandPos=null,this._lastLeftDeviceMoveEvent=null,this._lastRightDeviceMoveEvent=null,this._currentTrackerName=null};(a.prototype=new t).constructor=a;var l=function(){i.call(this)};(l.prototype=new i).constructor=l,l.prototype.type="MoveUnderConstraintStartedEvent",e.MoveUnderConstraintStartedEvent=l,n.EventServices.registerEvent(l);var c=function(){i.call(this)};(c.prototype=new i).constructor=c,c.prototype.type="MoveUnderConstraintEndedEvent",e.MoveUnderConstraintEndedEvent=c,n.EventServices.registerEvent(c);var h=function(){i.call(this)};return(h.prototype=new i).constructor=h,h.prototype.type="MoveUnderConstraintPositionResetEvent",e.MoveUnderConstraintPositionResetEvent=h,n.EventServices.registerEvent(h),a.prototype.resetPosition=function(){console.log(++this._count+" : resetPosition ");let e=!1;if(this._MuCManager){this._MuCManager.resetPosition(),e=!0;let t=new h;t&&this.dispatchEvent(t)}return e},a.prototype.onActivate=function(t){if(e.Behavior.prototype.onActivate.call(this,t),n.EventServices.addObjectListener(n.MouseDoubleClickEvent,this,"onMouseDoubleClickEvent"),n.EventServices.addObjectListener(n.MousePressEvent,this,"onMousePressEvent"),n.EventServices.addObjectListener(n.MouseMoveEvent,this,"onMouseMoveEvent"),n.EventServices.addObjectListener(n.MouseReleaseEvent,this,"onMouseReleaseEvent"),n.EventServices.addObjectListener(e.SpatialDoubleTapEvent,this,"onSpatialDoubleTapEvent"),n.EventServices.addObjectListener(n.DevicePressEvent,this,"onDevicePressEvent"),n.EventServices.addObjectListener(n.DeviceTrackerEvent,this,"onDeviceMoveEvent"),n.EventServices.addObjectListener(n.DeviceReleaseEvent,this,"onDeviceReleaseEvent"),this._MuCManager=new e.MoveUnderConstraintsManager,void 0===this._MuCManager||null===this._MuCManager)return console.log(++this._count+" : MoveUnderConstraints::onActivate | _MuCManager creation failed "),this;this._MuCManager.initialize(),this._MuCManager.storeActorInitialPositions()},a.prototype.onDeactivate=function(){this._MuCManager&&(this._MuCManager.dispose(),this._MuCManager=null),this._grabbedActor=null,this._fixedActor=null,this._dragStarted=!1,this._count=0,this._rightHandPosInitial=null,this._leftHandPosInitial=null,this._rightHandPos=null,this._leftHandPos=null,this._lastLeftDeviceMoveEvent=null,this._lastRightDeviceMoveEvent=null,this._currentTrackerName=null,n.EventServices.removeObjectListener(n.MouseDoubleClickEvent,this,"onMouseDoubleClickEvent"),n.EventServices.removeObjectListener(n.MousePressEvent,this,"onMousePressEvent"),n.EventServices.removeObjectListener(n.MouseMoveEvent,this,"onMouseMoveEvent"),n.EventServices.removeObjectListener(n.MouseReleaseEvent,this,"onMouseReleaseEvent"),n.EventServices.removeObjectListener(e.SpatialDoubleTapEvent,this,"onSpatialDoubleTapEvent"),n.EventServices.removeObjectListener(n.DevicePressEvent,this,"onDevicePressEvent"),n.EventServices.removeObjectListener(n.DeviceTrackerEvent,this,"onDeviceMoveEvent"),n.EventServices.removeObjectListener(n.DeviceReleaseEvent,this,"onDeviceReleaseEvent"),e.Behavior.prototype.onDeactivate.call(this)},a.prototype._toggleFixedState=function(e,t){let n=!1;return this._MuCManager&&(n=this._MuCManager.fixActorTemporarily(e,t)),n},a.prototype._manageToggleFixState=function(e){if(this._MuCManager&&e){let t=!0;const n=this._MuCManager._getPathOfActor(e);if(this._fixedActor){const e=this._MuCManager._getPathOfActor(this._fixedActor);this._MuCManager.IsPathSame(e,n)&&(t=!1),this._toggleFixedState(this._fixedActor,!1)&&(this._highlightActor(this._fixedActor,!1),this._fixedActor=null)}t&&this._toggleFixedState(e,!0)&&(this._fixedActor=e,this._highlightActor(this._fixedActor,!0))}},a.prototype.onMouseDoubleClickEvent=function(e){if(e)if(2===e.button)console.log(++this._count+" : onMouseDoubleClickEvent | resetPosition "),this.resetPosition();else{let t=this._getGrabbedActor(e);t?this._manageToggleFixState(t):console.log(++this._count+" : onMouseDoubleClickEvent | this._getGrabbedActor failed ")}},a.prototype.onMousePressEvent=function(e){if(this._grabbedActor=this._getGrabbedActor(e),this._grabbedActor){this._highlightActor(this._grabbedActor,!0),this._dragStarted=!0;let e=new l;e&&this.dispatchEvent(e),this._MuCManager&&this._MuCManager.setGrabbedActor(this._grabbedActor,null)}else console.log(++this._count+" : onMousePressEvent | this._getGrabbedActor failed ")},a.prototype.onSpatialDoubleTapEvent=function(e){let t=e.actor;t?this._manageToggleFixState(t):console.log(++this._count+" : onSpatialDoubleTapEvent | actor not retrieved ")},a.prototype.onDevicePressEvent=function(e){if(!1===this._dragStarted){let t=e.actor;if(t){let n=!1;if("controllerTracker_1"===e.trackerName?(this._leftHandPosInitial=null,this._currentTrackerName="controllerTracker_1",this._rightHandPosInitial=this._rightHandPos,n=!0):"controllerTracker_2"===e.trackerName?(this._rightHandPosInitial=null,this._currentTrackerName="controllerTracker_2",this._leftHandPosInitial=this._leftHandPos,n=!0):console.log(++this._count+" : MoveUnderConstraints Be :: onDevicePressEvent | invalid tracker"),n&&(this._grabbedActor=t,this._grabbedActor)){let e=new l;e&&this.dispatchEvent(e),this._highlightActor(this._grabbedActor,!0),this._dragStarted=!0,this._MuCManager&&this._MuCManager.setGrabbedActor(this._grabbedActor)}}else console.log(++this._count+" : onDevicePressEvent | getActor failed ")}},a.prototype.onMouseMoveEvent=function(e){if(!1!==this._dragStarted&&this._MuCManager){let t=this._getTransfoToApplyToGrabbedActor(e);this._MuCManager.computePositionOfActors(t)}},a.prototype.onExecute=function(){if(!1!==this._dragStarted&&this._MuCManager){let e=null;if(this._lastLeftDeviceMoveEvent&&this._lastLeftDeviceMoveEvent.trackerName===this._currentTrackerName&&(e=this._lastLeftDeviceMoveEvent),this._lastRightDeviceMoveEvent&&this._lastRightDeviceMoveEvent.trackerName===this._currentTrackerName&&(e=this._lastRightDeviceMoveEvent),e){let t=this._getTransfoToApplyToGrabbedActorFromDeviceMoveEvent(e);this._MuCManager.computePositionOfActors(t)}}},a.prototype.onDeviceMoveEvent=function(e){this._MuCManager&&e&&("controllerTracker_1"===e.trackerName?(this._rightHandPos=e.trackerValue,this._lastRightDeviceMoveEvent=e):"controllerTracker_2"===e.trackerName&&(this._leftHandPos=e.trackerValue,this._lastLeftDeviceMoveEvent=e))},a.prototype.onMouseReleaseEvent=function(e){this._dragStarted=!1;let t=new c;t&&this.dispatchEvent(t),this._grabbedActor&&(this._highlightActor(this._grabbedActor,!1),this._grabbedActor=null)},a.prototype.onDeviceReleaseEvent=function(e){if(e.trackerName===this._currentTrackerName){this._dragStarted=!1,this._rightHandPosInitial=null,this._leftHandPosInitial=null,this._currentTrackerName=null;let e=new c;e&&this.dispatchEvent(e),this._grabbedActor&&(this._highlightActor(this._grabbedActor,!1),this._grabbedActor=null)}},a.prototype._getTransfoToApplyToGrabbedActor=function(t){let n=null;if(this._grabbedActor&&this._MuCManager){let t=e.RenderManager.getInstance(),i=this._MuCManager.ComputeCoG(this._grabbedActor);if(void 0!==i&&i&&3===i.length){let e=new DSMath.Vector3D(i[0],i[1],i[2]),o=null;if(!o){let n=t.getCurrentCamera();n&&(o=n.getPosition().sub(e).norm())}if(o){let i=t.getMousePositionIn3D(o).sub(e),r=t.getMousePositionIn3D(o);r.sub(i),n=this._getRelativeTransfoFromPoint(e,r)}}}else console.log(++this._count+" : MoveUnderConstraints::_getTransfoToApplyToGrabbedActor _grabbedActor is null ");return n},a.prototype._getTransfoToApplyToGrabbedActorFromDeviceMoveEvent=function(e){let t=null;if(this._grabbedActor&&e){let n=e.trackerValue;"controllerTracker_1"===e.trackerName?this._rightHandPosInitial?(t=this._getRelativeTransfoFromPositions(this._rightHandPosInitial,n),this._rightHandPosInitial=n):console.log(++this._count+" : _getTransfoToApplyToGrabbedActorFromDeviceMoveEvent | _rightHandPosInitial is null "):"controllerTracker_2"===e.trackerName&&(this._leftHandPosInitial?(t=this._getRelativeTransfoFromPositions(this._leftHandPosInitial,n),this._leftHandPosInitial=n):console.log(++this._count+" : _getTransfoToApplyToGrabbedActorFromDeviceMoveEvent | _leftHandPosInitial is null "))}return t},a.prototype._getRelativeTransfoFromPoint=function(e,t){let n=new o.Vector3D(t.x,t.y,t.z),i=new o.Vector3D.sub(n,e).getArray();return{matrix:[1,0,0,0,1,0,0,0,1,i[0],i[1],i[2]]}},a.prototype._getRelativeTransfoFromPositions=function(e,t){let n=new o.Vector3D(t[9],t[10],t[11]),i=new o.Vector3D(e[9],e[10],e[11]),r=new o.Vector3D.sub(n,i).getArray();return{matrix:[1,0,0,0,1,0,0,0,1,r[0],r[1],r[2]]}},a.prototype._getGrabbedActor=function(e){let t=null,n=this._getIntersectionObject(e);if(n){var i=n.getActor();i instanceof r&&(t=i)}return t},a.prototype._highlightActor=function(t,n){if(t){let i=e.RenderManager.getInstance();i&&(n?i.highlight(t):i.dehighlight(t))}},a.prototype._getIntersectionObject=function(t){let n=null;if(t){let i=t.getPosition();if(i){let t=e.RenderManager.getInstance();if(t){let e={retrieveOnlyActor:!1};n=t.pickFromScreen(i,e)}}}return n},e.MoveUnderConstraints=a,a})),define("CXPAssemblyStudioMuC/StuMoveUnderConstraintsBe",["DS/CXPAssemblyStudioMuC/StuMoveUnderConstraintsBe"],(function(e){"use strict";return e})),define("DS/CXPAssemblyStudioMuC/CXPAssemblyStudioMuCDefine",["DS/CXPAssemblyStudioMuC/StuMoveUnderConstraintsBe"],(function(){}));