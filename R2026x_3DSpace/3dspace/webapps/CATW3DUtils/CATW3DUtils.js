/*!  Copyright 2020 Dassault Systemes. All rights reserved. */
define("DS/CATW3DUtils/CATW3DUtils",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/PSOManager"],(function(e,t){"use strict";var n={};function i(t){if(t&&t.pathElement&&e.isAModelPath(t.pathElement)){for(var n,i=t.pathElement.externalPath.length-1;i>=0&&!n;i--)e.isRepReference(t.pathElement.externalPath[i])&&(n=t.pathElement.externalPath[i]);if(n)return{repRefNode:n,repRefID:e.getNodeID(n)}}}function r(e){if(e){var n,r=t.get();1===r.length&&(n=i(r[0]))&&n.repRefID===e&&t.empty()}}return Object.freeze({switchToAV1withMesh:function(t){if(t&&t.pathElement&&t.pad3DViewer&&t.onComplete&&t.onFailure){var a=i(t),l=a?a.repRefID:null,s=a?a.repRefNode:null;if(l){if(!(!t.selectionFilter||Object.keys(t.selectionFilter).reduce((function(e,n){return e+("product"!==n&&"surface"!==n?t.selectionFilter[n]:0)}),0)))return{status:"filtered"};if(a=n[l])return a.callbacks.push(t),{status:a.timeOut?"existing":"switching",repRefNode:s,repRefID:l,cancel:a.cancel};var o=e.getLoadedStream(s,t.pad3DViewer),c=t.pad3DViewer.getController();return"thumbnail"!==o&&"cgr"!==o?(window.console.error("Unknown loaded stream!"),{status:"UnknownLoadedStream"}):"cgr"===o&&c.hasMeshInRAM(l)?{status:"done",repRefNode:s,repRefID:l}:((a={repRefNode:s,repRefID:l,callbacks:[t]}).timeOut=setTimeout((function(){a&&(clearTimeout(a.timeOut),delete a.timeOut,c.lockRepresentationMeshInRAM(l),"thumbnail"===o?c.switchNodeVisuStreamOnDemand({data:[{node:a.repRefNode,stream:"cgr"}],callbacks:{onComplete:function(){if(c.unlockRepresentationMeshInRAM(l),a){var e=a;r(a.repRefID),delete n[a.repRefID],a=null,e.callbacks.forEach((function(t){t.onComplete({status:"switchSuccess",repRefNode:e.repRefNode,repRefID:e.repRefID})}))}},onFailure:function(){if(c.unlockRepresentationMeshInRAM(l),a){var e=a;r(a.repRefID),delete n[a.repRefID],a=null,e.callbacks.forEach((function(t){t.onFailure({status:"switchFailure",repRefNode:e.repRefNode,repRefID:e.repRefID})}))}}}}):c.setForceReferencesLoad({data:[{id:a.repRefID,state:!0}],callback:function(){if(c.setForceReferencesLoad({data:[{id:l,state:!1}]}),c.unlockRepresentationMeshInRAM(l),a){var e=a;r(a.repRefID),delete n[a.repRefID],a=null,e.callbacks.forEach((function(t){t.onComplete({status:"switchSuccess",repRefNode:e.repRefNode,repRefID:e.repRefID})}))}}}))}),500),a.cancel=function(){return a?a.timeOut?(clearTimeout(a.timeOut),a.callbacks.forEach((function(e){e.onCancel&&e.onCancel({status:"cancelled",repRefNode:s,repRefID:l})})),delete n[a.repRefID],void(a=null)):{status:"SwitchInProgress"}:{status:"AlreadyDone"}},n[l]=a,{status:"created",repRefNode:s,repRefID:l,cancel:a.cancel})}}}})})),define("DS/CATW3DUtils/CATC3DAxisSystemDisplayAgent",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DAnims/CATW3DAnimation3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/RenderStyle","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,i,r,a,l,s,o){"use strict";return e.extend({init:function(e){var c,u,p,f,h,d,m,S=e.context,g=S.getViewer().getSceneGraphOverrideSetManager();function D(e,t){return e&&t&&e.isEqual(t)}function R(e){for(var n,i=e?new t(e.externalPath):null;i&&(!(n=i.getLastElement())||!o.is3DLeaf(n));)i=i.getParentPath();return i}function v(e,t){var n=null;t.push(e),(n=e.getChildrenPathes())&&n.length>0&&n.forEach((function(e){v(e,t)}))}function E(e){var t,n,i,r,a=R(e),l=null;if(a&&(i=[],n=(t=a.getLastElement(!0)).getChildByName("AxisSystems"))){for(r=n.getParents();r&&r[0]&&r[0]!==t;)i.unshift(r[0]),r=r[0].getParents();i.push(n),l=a,i.forEach((function(e){l.addElement(e)}))}if(l){var s=l.getChildrenPathes(),o=[];return s.forEach((function(e){var t={paths:[]};v(e,t.paths),o.push(t)})),{axisBagPath:l,axisSystems:o}}return null}function b(e){if(!e||!e.pathElement)return null;if(S.getViewer().getAxisFilter())return m&&(g.removeSceneGraphOverrideSet(m),m=null,S.getViewer().render()),null;m&&-1===g.getSceneGraphOverrideSetIndex(m)&&g.pushSceneGraphOverrideSet(m);var t=E(e.pathElement);if(t&&t.axisSystems&&t.axisSystems.length>0){var n=[];t.axisSystems.forEach((function(e){var t;t=e.paths[0],f&&!f.get().some((function(e){return e.pathElement.getLastElement(!0)===t.getLastElement(!0)}))&&(e.node=e.paths[0].getLastElement(!0),n.push(e))})),n.length===t.axisSystems.length&&n.push({paths:[t.axisBagPath]}),n.length>0&&n.forEach((function(e){m||(m=new l(S.getRootBagPath().externalPath[0]),g.pushSceneGraphOverrideSet(m));var t,n=m.getUniqueOverrideFromPathElement(e.paths[0]);n||(n=m.createOverride({pathes:e.paths}),(t=new s).setRenderMode("AxisSystem",!0),n.setRenderStyle(t)),e.override=n})),a.getAnimation3DEngine({viewer:S.getViewer()}).axisSystemVisibility({objectListToAnimate:n,visibility:e.visibility,pickability:e.pickability})}return e.pathElement}function y(e){var t=R(e.pathElement);D(h,t)||(b({pathElement:h,visibility:!1,pickability:!1}),h=b({pathElement:t,visibility:!0,pickability:!0}))}function w(){var e=n.get();clearTimeout(d),d=null,1===e.length?y({pathElement:e[0].pathElement?e[0].pathElement:e[0].originalPathElement}):b({pathElement:h,visibility:!1,pickability:!1})}function A(e){var t=R(e.pathElement?e.pathElement:e.originalPathElement);t&&(d=setTimeout((function(){b({pathElement:t,visibility:!1,pickability:!1}),h=null}),1e3))}function I(e){var t=R(e.pathElement);(!h||h&&t&&!D(t,h))&&b({pathElement:e.pathElement,visibility:!1,pickability:!1})}S.getViewer().onAxisFilterChange((function(){m&&(g.removeSceneGraphOverrideSet(m),m=null,S.getViewer().render())})),this.activate=function(e){f||(m&&(g.pushSceneGraphOverrideSet(m),S.getViewer().render()),c=n.onPostAdd(w),u=n.onRemove(A),f=e&&"HSO"===e.type?i:r,p=f.onRemove(I))},this.analyze=y,this.deactivate=function(){f&&(m&&(g.removeSceneGraphOverrideSet(m),S.getViewer().render()),n.unsubscribe(c),n.unsubscribe(u),f.unsubscribe(p),c=u=p=f=null)}}})}));