define("DS/CAT3DWSceneObject/CAT3DWSceneObject",["DS/CAT3DWInfra/CAT3DWLogger","DS/Visualization/ThreeJS_DS","UWA/Class","UWA/Core"],(function(t,e,i,r){"use strict";var s=i.extend({init:function(e){if(this._isLocked=!1,this._groupID=void 0,this._isInitialized=!1,e instanceof Object)if(this._lifecycleHistoryArray=[],this._transformationHistoryArray=[],this._propertiesHistoryArray=[],this._lockHistoryArray=[],this._groupHistoryArray=[],this._actionsHistoryMap=new Map,this._transient=void 0,this._transientMadePermanent=void 0,this._transientDiscarded=void 0,this._lifecycleHistoryArray.activeIndex=-1,this._transformationHistoryArray.activeIndex=-1,this._propertiesHistoryArray.activeIndex=-1,this._lockHistoryArray.activeIndex=-1,this._groupHistoryArray.activeIndex=-1,this._lifecycleHistoryArray.onChange=this._onChangeLifecycle.bind(this),this._transformationHistoryArray.onChange=this._onChangeTransformation.bind(this),this._propertiesHistoryArray.onChange=this._onChangeProperties.bind(this),this._lockHistoryArray.onChange=this._onChangeLockUnlock.bind(this),this._groupHistoryArray.onChange=this._onChangeGroup.bind(this),e.history){let t,i=e.history,r=(e,i)=>{for(t=0;t<e.length;t++)i.push(e[t]),e[t].active&&(i.activeIndex=t)};r(i.lifecycleHistory,this._lifecycleHistoryArray),r(i.transformationHistory,this._transformationHistoryArray),r(i.propertiesHistory,this._propertiesHistoryArray),r(i.lockHistory,this._lockHistoryArray),r(i.groupHistory,this._groupHistoryArray);let s,o,a=null;for(let e=0;e<i.actionsHistory.length;e++){for(a=i.actionsHistory[e],s=[],o=[],t=0;t<a.stacks.length;t++)s.push(this._getStackFromNumber(a.stacks[t])),o.push(a.indexes[t]);this._actionsHistoryMap.set(a.timestamp,{stacks:s,indexes:o})}this._groupHistoryArray.activeIndex>-1&&this._onChangeGroup(this._groupHistoryArray[this._groupHistoryArray.activeIndex],null),e.locked&&(this._isLocked=!0)}else{let i=null;i=e.state?e.state:this.getInititalState(e),this._addToStack(0,this._transformationHistoryArray,i.transformation),this._addToStack(0,this._propertiesHistoryArray,i.properties),e.timestamp?(this._addToStack(0,this._lifecycleHistoryArray,{alive:!1}),this._logAction(e.timestamp,this._lifecycleHistoryArray,{alive:!0}),e.locked&&(this._needsToBeLocked=e.timestamp)):(t.error("SceneObject created without timestamp !",this.getID?this.getID():""),this._addToStack(0,this._lifecycleHistoryArray,{alive:!0}),e.locked&&(this._needsToBeLocked=!0))}},initialize:function(){this._isInitialized=!0,this._needsToBeLocked&&("number"==typeof this._needsToBeLocked?this.lock(this._needsToBeLocked):this.lock())},garbage:function(e,i=!1){t.log("garbage",e,this.getID?this.getID():""),this._logAction(e,this._lifecycleHistoryArray,{alive:!1},i)},ungarbage:function(e){t.warn("ungarbage ?",this.getID?this.getID():""),this._logAction(e,this._lifecycleHistoryArray,{alive:!0})},isAlive:function(){return!this._lifecycleHistoryArray||!(this._lifecycleHistoryArray.activeIndex<0)&&this._lifecycleHistoryArray[this._lifecycleHistoryArray.activeIndex].data.alive},getID:function(){throw new Error("Must be implemented")},getType:function(){},select:function(){t.error("select method has to be implemented !")},deselect:function(){t.error("deselect method has to be implemented !")},coselect:function(){t.error("coselect method has to be implemented !")},decoselect:function(){t.error("decoselect method has to be implemented !")},lock:function(t){this._isLocked||(this._isLocked=!0,t?this._duplicateCurrentState(t)&&this._logAction(t,this._lockHistoryArray,{lifecycleIndex:this._lifecycleHistoryArray.length-1,transformationIndex:this._transformationHistoryArray.length-1,propertiesIndex:this._propertiesHistoryArray.length-1}):this._addToStack(0,this._lockHistoryArray,{lifecycleIndex:this._lifecycleHistoryArray.length-1,transformationIndex:this._transformationHistoryArray.length-1,propertiesIndex:this._propertiesHistoryArray.length-1}))},unlock:function(t){if(this._isLocked&&(this._isLocked=!1,this._lifecycleHistoryArray&&t)){let e=this._lockHistoryArray[this._lockHistoryArray.activeIndex].timestamp;this._logAction(t,this._lockHistoryArray,{lockTimestamp:e})}},isLocked:function(){return this._isLocked&&this._isInitialized},group:function(t,e){if(this._groupID=e.getID(),this._groupHistoryArray.activeIndex>-1){const e=this._groupHistoryArray[this._groupHistoryArray.activeIndex];if(e.timestamp===t&&e.data.group===this._groupID)return}this._duplicateCurrentState(t)&&this._logAction(t,this._groupHistoryArray,{group:this._groupID})},ungroup:function(t){if(this._groupID&&(this._groupID=void 0,t)){let e=this._groupHistoryArray[this._groupHistoryArray.activeIndex].timestamp;this._logAction(t,this._groupHistoryArray,{groupTimestamp:e})}},isGrouped:function(){return!!this._groupID},getGroupID:function(){return this._groupID},getAllLoggedGroupIDs:function(){const t=[];for(const e of this._groupHistoryArray)e.data.group&&t.push(e.data.group);return t},undoAction:function(e){let i=this._actionsHistoryMap.get(e);if(i){for(let t=0;t<i.stacks.length;t++)this._changeStackActiveIndex(i.stacks[t],i.indexes[t],!1);return!0}return t.error("No action found !",this.getID?this.getID():""),!1},redoAction:function(e){let i=this._actionsHistoryMap.get(e);if(i){for(let t=0;t<i.stacks.length;t++)this._changeStackActiveIndex(i.stacks[t],i.indexes[t],!0);return!0}return t.error("No action found !",this.getID?this.getID():""),!1},setTransformation:function(t,e,i=!1){return!(this.isLocked()||!this._actionsHistoryMap)&&(this._logAction(t,this._transformationHistoryArray,{matrixArray:e.toArray()},i),!0)},getCurrentTransformation:function(){if(this._transformationHistoryArray){let t=this._transformationHistoryArray[this._transformationHistoryArray.activeIndex];return(new e.Matrix4).fromArray(t.data.matrixArray)}return null},setProperties:function(t,e,i=!1){return!(this.isLocked()||!this._actionsHistoryMap)&&(this._logAction(t,this._propertiesHistoryArray,e,i),!0)},getCurrentProperties:function(){if(this._propertiesHistoryArray){return this._propertiesHistoryArray[this._propertiesHistoryArray.activeIndex].data}return null},setTransientPermanent:function(){return!!this._transient&&(this._transientMadePermanent=this._transient,this._transient=void 0,!0)},discardOngoingTransientAction:function(){if(this._transient){let t=this._actionsHistoryMap.get(this._transient);for(let e=0;e<t.stacks.length;e++)this._changeStackActiveIndex(t.stacks[e],t.indexes[e],!1),t.stacks[e].splice(t.indexes[e],1);this._actionsHistoryMap.delete(this._transient),this._transientDiscarded=this._transient,this._transient=void 0}},hasOngoingTransient:function(){return this._transient},dump:function(){const t=[];for(let e of this._actionsHistoryMap.keys())t.push(e);const e={};for(let t of this._lifecycleHistoryArray)e[t.timestamp]=t.data.alive;const i=[];for(let t of this._transformationHistoryArray)i.push(t.timestamp);const r=[];for(let t of this._propertiesHistoryArray)r.push(t.timestamp);return{id:this.getID(),transient:this._transient,transientMP:this._transientMadePermanent,histo:t,life:e,trans:i,prop:r}},getInititalState:function(){return{transformation:{matrixArray:null},properties:{}}},_lifecycleUpdate:function(){},_transformationUpdate:function(){},_propertiesUpdate:function(){},_lockUpdate:function(){},_getCurrentState:function(){const t=this._transformationHistoryArray[this._transformationHistoryArray.activeIndex],e=this._propertiesHistoryArray[this._propertiesHistoryArray.activeIndex];return{transformation:t.data,properties:e.data}},stream:function(t){let e={locked:this._isLocked};if(t){let t=[];if(this._actionsHistoryMap.forEach(((e,i)=>{if(this._transient===i)return;let r=[],s=[];for(let t=0;t<e.stacks.length;t++)r.push(this._getStackNumber(e.stacks[t])),s.push(e.indexes[t]);t.push({timestamp:i,stacks:r,indexes:s})})),e.history={lifecycleHistory:this._lifecycleHistoryArray,transformationHistory:this._transformationHistoryArray,propertiesHistory:this._propertiesHistoryArray,lockHistory:this._lockHistoryArray,groupHistory:this._groupHistoryArray,actionsHistory:t},this._transient){const t=this._actionsHistoryMap.get(this._transient);let i=null;for(let r=0;r<t.stacks.length;r++)i=t.stacks[r],i===this._lifecycleHistoryArray?(e.history.lifecycleHistory=[].concat(this._lifecycleHistoryArray),e.history.lifecycleHistory.splice(t.indexes[r],1)):i===this._transformationHistoryArray?(e.history.transformationHistory=[].concat(this._transformationHistoryArray),e.history.transformationHistory.splice(t.indexes[r],1)):i===this._propertiesHistoryArray?(e.history.propertiesHistory=[].concat(this._propertiesHistoryArray),e.history.propertiesHistory.splice(t.indexes[r],1)):i===this._lockHistoryArray?(e.history.lockHistory=[].concat(this._lockHistoryArray),e.history.lockHistory.splice(t.indexes[r],1)):i===this._groupHistoryArray&&(e.history.groupHistory=[].concat(this._groupHistoryArray),e.history.groupHistory.splice(t.indexes[r],1))}}else e.state=JSON.parse(JSON.stringify(this._getCurrentState()));return e},getAction:function(t){let e=this._actionsHistoryMap.get(t);if(!e)return null;if(this._isCreationAction(e))return this.stream(!0);if(this._transientDiscarded===t)return{transientDiscarded:!0};let i={stacks:[],indexes:[],states:[]};this._transient===t?i.transient=!0:this._transientMadePermanent===t&&(i.transient=!0,i.transientMadePermanent=!0);for(let t=0;t<e.stacks.length;t++)if(i.stacks.push(this._getStackNumber(e.stacks[t])),i.indexes.push(e.indexes[t]),e.stacks[t]===this._lockHistoryArray){let r=e.stacks[t][e.indexes[t]];if(r.data.lockTimestamp)i.states.push(e.stacks[t][e.indexes[t]]);else{let t={data:{lifecycleState:this._lifecycleHistoryArray[r.data.lifecycleIndex],transformationState:this._transformationHistoryArray[r.data.transformationIndex],propertiesState:this._propertiesHistoryArray[r.data.propertiesIndex]},active:!0};i.states.push(t)}}else i.states.push(e.stacks[t][e.indexes[t]]);return i},setAction:function(e,i){let r,s,o;if(this._actionsHistoryMap.get(e)&&this._transient!==e)throw new Error("There is already an exiting action with timestamp "+e);for(let a=0;a<i.stacks.length;a++)r=this._getStackFromNumber(i.stacks[a]),o=i.states[a],r&&o&&(r!==this._lockHistoryArray||o.data.lockTimestamp||(this._lifecycleHistoryArray.push(o.data.lifecycleState),this._lifecycleHistoryArray.activeIndex=this._lifecycleHistoryArray.length-1,this._transformationHistoryArray.push(o.data.transformationState),this._transformationHistoryArray.activeIndex=this._transformationHistoryArray.length-1,this._propertiesHistoryArray.push(o.data.propertiesState),this._propertiesHistoryArray.activeIndex=this._propertiesHistoryArray.length-1,o={data:{lifecycleIndex:this._lifecycleHistoryArray.activeIndex,transformationIndex:this._transformationHistoryArray.activeIndex,propertiesIndex:this._propertiesHistoryArray.activeIndex},active:!0}),s=this._logAction(e,r,o.data,i.transient),s!==i.indexes[a]&&t.warn("action created with a different index",this.getID?this.getID():""));i.transientMadePermanent&&(this._transient=void 0)},hasAction:function(t){return this._actionsHistoryMap.has(t)},_duplicateCurrentState:function(t){if(this._lifecycleHistoryArray.activeIndex<0)throw new Error("locking a deleted object !");return this._duplicateStateAtIndex(t,this._lifecycleHistoryArray,this._lifecycleHistoryArray.activeIndex),this._duplicateStateAtIndex(t,this._transformationHistoryArray,this._transformationHistoryArray.activeIndex),this._duplicateStateAtIndex(t,this._propertiesHistoryArray,this._propertiesHistoryArray.activeIndex),!0},_duplicateStateAtIndex:function(t,e,i){let r=e[i];this._logAction(t,e,r.data)},_logAction:function(e,i,r,s){let o=null;if(this._transient){let r=this._actionsHistoryMap.get(this._transient);if(!s)throw t.trace("Missing setTransientPermanent ?",this.getID?this.getID():""),new Error("logging a new action while there is an existing transient action !");if(r.indexes[0]!==r.stacks[0].activeIndex)throw t.trace("Existing transient action is not active ?",this.getID?this.getID():""),new Error("the existing transient action is not the active one !");if(this._transient!==e){for(let t=0;t<r.indexes.length;t++)r.stacks[t].splice(r.indexes[t],1);this._actionsHistoryMap.delete(this._transient),this._transient=void 0}else for(let t=0;t<r.indexes.length;t++)if(r.stacks[t]===i){r.stacks[t].splice(r.indexes[t],1),r.stacks.splice(t,1),r.indexes.splice(t,1);break}}else{if(s&&this._actionsHistoryMap.has(e))throw new Error("can't create a transient action on an already existing action");i.activeIndex>-1&&(o=i[i.activeIndex])}let a=this._addToStack(e,i,r);return this._addToHistoryMap(e,i,a),s&&(this._transient=e),i.onChange(i[a],o),a},_addToStack:function(t,e,i){let r={timestamp:t,active:!0,data:i},s=-1;for(let i=e.length-1;i>-1;--i){if(e[i].timestamp<t){s=i+1,e.splice(i+1,0,r);break}if(e[i].timestamp===t&&0===t){s=i,e.splice(i,1,r);break}}return-1===s&&(s=0,e.splice(0,0,r)),s>e.activeIndex&&(e.activeIndex=s),s},_addToHistoryMap:function(t,e,i){let r=this._actionsHistoryMap.get(t);r?(r.stacks.push(e),r.indexes.push(i)):this._actionsHistoryMap.set(t,{stacks:[e],indexes:[i]})},_changeStackActiveIndex:function(t,e,i){let r=null;if(t.activeIndex>-1&&(r=t[t.activeIndex]),i)t[e].active=!0,e>t.activeIndex&&(t.activeIndex=e,t.onChange(t[t.activeIndex],r));else if(t[e].active=!1,e===t.activeIndex){let e,i=t.activeIndex,s=null;for(t.activeIndex=-1,e=i;e>-1;--e)if(t[e].active){t.activeIndex=e,s=t[t.activeIndex];break}t.onChange(s,r)}},_onChangeLifecycle:function(t,e){e&&e.data.alive===t.data.alive||this._lifecycleUpdate(t.data)},_onChangeTransformation:function(t){this._transformationUpdate((new e.Matrix4).fromArray(t.data.matrixArray))},_onChangeProperties:function(t){this._propertiesUpdate(t.data)},_onChangeLockUnlock:function(t,e){if(t)if(t.data.lockTimestamp){let e=this._actionsHistoryMap.get(t.data.lockTimestamp),i=0;if(1===e.stacks.length)i=this._actionsHistoryMap.get(t.data.lockTimestamp).indexes[0];else for(let r=0;r<e.stacks.length;r++)if(e.stacks[r]===this._lockHistoryArray){i=this._actionsHistoryMap.get(t.data.lockTimestamp).indexes[r];break}let r=this._lockHistoryArray[i].data;this._isLocked=!1,this._changeStackActiveIndex(this._lifecycleHistoryArray,r.lifecycleIndex,!1),this._changeStackActiveIndex(this._transformationHistoryArray,r.transformationIndex,!1),this._changeStackActiveIndex(this._propertiesHistoryArray,r.propertiesIndex,!1)}else this._changeStackActiveIndex(this._lifecycleHistoryArray,t.data.lifecycleIndex,!0),this._changeStackActiveIndex(this._transformationHistoryArray,t.data.transformationIndex,!0),this._changeStackActiveIndex(this._propertiesHistoryArray,t.data.propertiesIndex,!0),this._isLocked=!0;else this._isLocked=!1,this._changeStackActiveIndex(this._lifecycleHistoryArray,e.data.lifecycleIndex,!1),this._changeStackActiveIndex(this._transformationHistoryArray,e.data.transformationIndex,!1),this._changeStackActiveIndex(this._propertiesHistoryArray,e.data.propertiesIndex,!1);this._lockUpdate(this._isLocked)},_onChangeGroup:function(t){t&&void 0===t.data.groupTimestamp?this._groupID=t.data.group:this._groupID=void 0},_isCreationAction:function(t){let e=!1;for(let i=0;i<t.stacks.length;i++)if(t.stacks[i]===this._lifecycleHistoryArray&&(0===t.indexes[i]||1===t.indexes[i]&&this._lifecycleHistoryArray[1].data.alive&&!this._lifecycleHistoryArray[0].data.alive)){e=!0;break}return e},_getStackNumber:function(t){switch(t){case this._lifecycleHistoryArray:return 0;case this._transformationHistoryArray:return 1;case this._propertiesHistoryArray:return 2;case this._lockHistoryArray:return 3;case this._groupHistoryArray:return 4;default:return-1}},_getStackFromNumber:function(t){switch(t){case 0:return this._lifecycleHistoryArray;case 1:return this._transformationHistoryArray;case 2:return this._propertiesHistoryArray;case 3:return this._lockHistoryArray;case 4:return this._groupHistoryArray;default:return null}}});return r.namespace("DS/CAT3DWSceneObject/CAT3DWSceneObject",s)})),define("DS/CAT3DWSceneObject/CAT3DWConnectableObject",["DS/CAT3DWSceneObject/CAT3DWSceneObject","DS/CAT3DWVisu/CAT3DWTolerance","DS/Visualization/ThreeJS_DS"],(function(t,e,i){"use strict";return t.extend({getCenter:function(){throw new Error("Must be implemented")},getCorners:function(){throw new Error("Must be implemented")},get2DPortPosition:function(){throw new Error("Must be implemented")},get2DProjectedPosition:function(){let t=new i.Vector3,r=new i.Vector3,s=new i.Vector3,o=new i.Vector3,a=new i.Vector3,n=new i.Vector3,c=new i.Vector3,h=new i.Vector3,y=new i.Vector3,l=new i.Vector3,d=new i.Vector3,p=new i.Vector3,_=new i.Vector3,f=new i.Vector3;return function(u,g,A){A.projectPoint(this.getCenter(),t),A.projectPoint(u,r),s.copy(r).sub(t),o.copy(r).sub(t).normalize();let H=this.getCorners();h.copy(H.topLeft).sub(t),y.copy(H.topRight).sub(t),l.copy(h).normalize(),d.copy(y).normalize();let m=o.dot(l),k=o.dot(d),x=null;if(m>e.toleranceForUnitaryVectors?(x=h.clone(),f.copy(h)):m<-e.toleranceForUnitaryVectors&&(x=h.clone().multiplyScalar(-1),f.copy(h)),k>e.toleranceForUnitaryVectors?(x=y.clone(),f.copy(y)):k<-e.toleranceForUnitaryVectors&&(x=y.clone().multiplyScalar(-1),f.copy(y)),!x){if(a.copy(A.normal),p.crossVectors(d,l).dot(A.normal)<0&&a.multiplyScalar(-1),p.crossVectors(o,l),_.crossVectors(o,d),p.dot(a)<0)if(_.dot(a)<0){n.copy(H.topRight).sub(H.topLeft).multiplyScalar(.5),c.copy(n).normalize();let t=n.length()/Math.abs(s.dot(c));x=s.multiplyScalar(t)}else{n.copy(H.topLeft).sub(H.bottomLeft).multiplyScalar(.5),c.copy(n).normalize();let t=n.length()/Math.abs(s.dot(c));x=s.multiplyScalar(t)}else if(_.dot(a)<0){n.copy(H.topLeft).sub(H.bottomLeft).multiplyScalar(.5),c.copy(n).normalize();let t=n.length()/s.dot(c);x=s.multiplyScalar(t)}else{n.copy(H.topRight).sub(H.topLeft).multiplyScalar(.5),c.copy(n).normalize();let t=n.length()/s.dot(c);x=s.multiplyScalar(t)}f.copy(c)}o.dot(f.normalize())<0&&f.normalize().negate();let I=A.projectPoint(x.add(t).add(f.multiplyScalar(g)));return new i.Vector2(I.x,I.y)}}()})}));