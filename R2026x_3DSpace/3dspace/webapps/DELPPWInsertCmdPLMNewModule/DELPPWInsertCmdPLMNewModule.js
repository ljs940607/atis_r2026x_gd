define("DS/DELPPWInsertCmdPLMNewModule/InsertPLMNewCommand",["DS/ENONewWidget/command/NewContentCommandBase","UWA/Core","DS/Logger/Logger","UWA/Class/Options"],(function(e,t,n,o){"use strict";var i=e.extend(o,{name:"InsertPLMNewCommand",_logger:null,_options:{context:null,type:null,dialogBoxTitle:null,callbacks:null,isCreateRoot:null,fatherReferenceID:null,ebomReferenceID:null,backendInfo:null,linkType:null,preferences:null},init:function(e){this._logger=n.getLogger(i),this._parent(e,{mode:"exclusive",isAsynchronous:!1}),this._options=e,this._options.context=this.getOption("context")},getType(){return this._options.type},getOptions(){var e={labelTopBar:this._options.dialogBoxTitle,options:{selectedIDs:["false","null","null",this._options.oneDelmiaAggregationMode?"true":"false","null",...this._options.preferences,"null","null","null"],parentOrigin:["false","null","null",this._options.oneDelmiaAggregationMode?"true":"false","null",...this._options.preferences,"null","null","null"]},events:this._options.callbacks,context:{serviceBaseUrl:this._options.backendInfo.url,tenant:this._options.backendInfo.tenant,header:this._options.backendInfo.headers,getENONewContext:function(){return{}}},viewType:"tabView",facets:[{name:"classificationFacet",facetoptions:{isBookmark:!0,isLibrary:!0,isExportControl:!0}}],activatelock:{show:!0},activateDraftMode:{show:!0}};return this._options.isXRev&&e.facets.push({name:"revisionFacet"}),!this._options.isCreateRoot&&t.is(this._options.fatherReferenceID)&&this._options.fatherReferenceID.length>0&&!t.is(this._options.linkType,"string")&&(e.options.parentPIDs=[this._options.fatherReferenceID],e.options.selectedIDs[0]="true",e.options.parentOrigin[0]="true",e.options.selectedIDs[4]=this._options.fatherReferenceID,e.options.parentOrigin[4]=this._options.fatherReferenceID,t.is(this._options.copyModelParentToChild)&&(e.options.selectedIDs[10]=this._options.copyModelParentToChild.toString(),e.options.parentOrigin[10]=this._options.copyModelParentToChild.toString())),t.is(this._options.linkType,"string")&&this._options.linkType.length>0&&t.is(this._options.ebomReferenceID,"string")&&this._options.ebomReferenceID.length>0&&(e.options.selectedIDs[1]=this._options.linkType,e.options.parentOrigin[1]=this._options.linkType,e.options.selectedIDs[2]=this._options.ebomReferenceID,e.options.parentOrigin[2]=this._options.ebomReferenceID,t.is(this._options.copyModelProductToItemUponSL)&&(e.options.selectedIDs[11]=this._options.copyModelProductToItemUponSL.toString(),e.options.parentOrigin[11]=this._options.copyModelProductToItemUponSL.toString())),t.is(this._options.firstUpperScopedPrdRefPID,"string")&&(e.options.selectedIDs[12]=this._options.firstUpperScopedPrdRefPID,e.options.parentOrigin[12]=this._options.firstUpperScopedPrdRefPID),e},execute:function(){var e=this.getCreateOptions(this.getType());this.launchCreateNew(e)}});return i})),define("DS/DELPPWInsertCmdPLMNewModule/InsertCmdPLMNewModule",["UWA/Core","DS/DELPPWInsertCmdPLMNewModule/InsertPLMNewCommand"],(function(e,t){"use strict";return{behaviors:["ModelBehavior","ResourceBehavior","SelectionBehavior","AppPreferencesBehavior","ProductImplementBehavior"],creator:function(n,o,i,s,r,l){var a,c,u,p,f,d,g,h,I={};return g=function(t){var n,i,r;if(e.is(t,"string")&&t.length>0)(n=s.getModuleSelections(t)).length>0&&(n=n[0].id,e.is(n,"string")&&n.length>0&&o.isInstance(n)&&(n=o.getReferenceIdFromInstance(n)));else if(r=s.getSelections(),e.is(r,"array")&&r.length>0)for(i=0;i<r.length&&(n=r[i][0],!e.is(n));i++);return e.is(n,"string")&&0!==n.length||(n=null),n},c=function(t,s){var r,l,a,c,u,p,f,d,h,I,m,P,D,R,S={},C=null,y=null,M=null,L=widget.getValue("fromXen"),_=e.is(t)&&e.is(t.linkType)?t.linkType:null,T=L?g("IMPMOD"):e.is(t.productRefId,"string")?t.productRefId:null,A=e.is(T)?o.getReference(T):null,k=null,N={instancesAndReferences:[],connections:[]};C=n.log(i.getNLSValue("InsertCmdPLMNewModule.FetchInformation.Start")),n.notify("startProgress",S),e.is(s)&&e.is(s.result,"array")&&e.is(s.result.length>0)?(y=e.is(s.result[0].identifier,"string")&&s.result[0].identifier.length>0?s.result[0].identifier:null,e.is(s.result[0].relations)&&(e.is(s.result[0].relations[0])&&e.is(s.result[0].relations[0].relationshipID)&&e.is(s.result[0].relations[0].relationshipID,"string")&&(M=s.result[0].relations[0].relationshipID.length>0?s.result[0].relations[0].relationshipID:null),e.is(s.result[0].relations[1])&&e.is(s.result[0].relations[1].firstUpperScopePrdRefPID)&&e.is(s.result[0].relations[1].firstUpperScopePrdRefPID,"string")&&(_="PARTIAL_SCOPE",k=s.result[0].relations[1].firstUpperScopePrdRefPID)),m=y,P=M,R=function(t){e.is(t)&&(l=t,r=t.get("PID"),a=o.getDisplayName(l),t.setAdditionalInfo({queriedForChildren:!0,queriedForConnections:!1,queriedForDocuments:!0}),N.instancesAndReferences.push(t),h=i.getNLSValue("ModelBehavior.CreateReference.Success",{name:a}))},n.debug("getFetchItemMdl, created PID: "+m),e.is(m)?D=e.is(P)?new Promise((function(t,s){var l={onComplete:function(s){R(e.is(s)&&s.instancesAndReferences.length>=2?s.instancesAndReferences[0]:null),function(t){e.is(t)&&(u=t,c=t.get("PID"),p=o.getDisplayName(u),N.instancesAndReferences.push(t),h=i.getNLSValue("ModelBehavior.CreateInstance.Success",{name:p}))}(e.is(s)&&s.instancesAndReferences.length>=2?s.instancesAndReferences[1]:null),n.debug("onDBFetchComplete, fetch ref/inst from DB completed: "+r+"/"+c),t(!0)},onFailure:function(){h=i.getNLSValue("ModelBehavior.CreateInstance.Failure"),n.debug("onDBFetchFailure for inst/ref!!!"),s(h)},forceDBMode:!0};o.fetchInstancesAndTheirReferences([P],l)})):new Promise((function(e,t){var s={onComplete:function(t){R(t),n.debug("onDBFetchComplete, fetch ref from DB completed: "+r),e(!1)},onFailure:function(){h=i.getNLSValue("ModelBehavior.CreateReference.Failure.ReferenceNotCreated"),n.debug("onDBFetchFailure for reference!!!"),t(h)},forceDBMode:!0};o.fetchRoot(m,s)})):(n.warn("_onComplete, no reference PID found from PLMNew"),D=Promise.reject(i.getNLSValue("ModelBehavior.CreateReference.Failure"))),I=D):(h=i.getNLSValue("ModelBehavior.CreateReference.Failure"),I=Promise.reject(h)),I.then((function(t){var n=Promise.resolve(t),s={queriedForConnections:!0},c=null;return e.is(_)&&(e.is(T)||e.is(k))?n=new Promise((function(n,p){var g={isRefRefOnly:!0,forceDBMode:!0,onComplete:function(){switch(_){case"SCOPE":d="createMfgItemAndScope",c="CreateMfgItemAndScope.Success",e.is(l)&&null!==l&&(f="ProductImplementLink|"+r+"|"+T);break;case"RESULTING_PRODUCT":d="createMfgItemAndResultingProduct",c="createMfgItemAndResultingProductLink.Success",e.is(l)&&null!==l&&(f="ResultingProductLink|"+r+"|"+T);break;case"PARTIAL_SCOPE":c="PartialScope.Success",e.is(u)&&null!==u&&e.is(k)&&null!==k&&(f="PartialProductImplementLink|"+r+"|"+k,u.setAdditionalInfo(s))}N.connections.push({PID:f}),l.setAdditionalInfo(s),e.is(d)&&(h=i.getNLSValue(c,{processName:a,productName:o.getDisplayName(A)})),n(t)},onFailure:function(){switch(_){case"SCOPE":c="CreateMfgItemAndScope.Failure";break;case"RESULTING_PRODUCT":c="createMfgItemAndResultingProductLink.Failure"}p(i.getNLSValue(c,{productName:o.getDisplayName(A)}))}};o.getConnectionsByModel(l,null,g)})):l.setAdditionalInfo(s),n})).then((function(e){n.debug("onDBFetchComplete, fetch from DB completed: "+r),n.info(h,C),e?(n.notify("instanceCreated",{instancePID:c}),n.notify("instanceAdded",[u,null,null])):(n.notify("referenceCreated",{referencePID:r}),n.notify("referenceAdded",[l,null,null])),n.notify("updateBIModelFromServerResponse",N),L&&n.notify(d),n.notify("stopProgress",S)})).catch((function(e){n.debug("notifyFailureInformation, fetch from DB Failed!!!"),n.warn(e,C),n.notify("stopProgress",S)}))},u=function(t){var o,i={};n.debug("_onFailure"),e.is(t)&&e.is(t.result,"array")&&e.is(t.result.length>0)&&e.is(t.result[0].errors)&&e.is(t.result[0].errors[0].length>0)&&e.is(t.result[0].errors[0].errorMessages,"array")&&(o=t.result[0].errors[0].errorMessages[0],i=n.log(this.labelTopBar),n.log(o,i))},p=function(){n.debug("_onCancel")},f=function(t,n){var o="InsertUI.CreateDialog.Title",s=i.getNLSValue(t);if(e.is(n,"string")&&n.length>0)switch(n){case"SCOPE":o="ImplementUI.CreateImplementingAndScope";break;case"RESULTING_PRODUCT":o="ImplementUI.CreateImplementingAndResultingProduct";break;default:o="ImplementUI.CreateImplementAndUnknownLink"}return i.getNLSValue(o,{type:s})},d=function(t,i){var s=null,r="Unkwown";e.is(i,"string")&&i.length>0?(s=o.getReference(o.getReferenceId(i)),e.is(s)&&(r=s.get("type")),n.debug(t+": "+i+", reference type: "+r)):n.debug("No "+t+" object ID")},h=function(t){let n=null;const i=function(t){let n=null;const i=o.getReferenceModel(t);if(e.is(i)){const o=i.get("PPRTYPE");if(["PROCESS","SERVICE","CONSTRUCTION"].includes(o)&&e.is(l)){const o=l.isScoped(t);if(e.is(o)&&!0===o){const o=l.getScopeLinksOfImplementing(t)[0];e.is(o)&&(n=o.get("to"))}}}return n};let r=o.getInstance(t);if(!e.is(r)&&e.is(s.getSelectedInsts()[0])){const e=s.getSelectedInsts()[0].get("PID");r=o.getInstance(e)}if(e.is(r)){if("DELFmiFunctionIdentifiedInstance"===r.get("type")){const t=r.get("isInstanceOf"),a=l.checkItemHasPartialScopeNImpLink(t,r.id);if(e.is(a)&&!1===a&&(n=i(t),!e.is(n)&&null===n)){let t=[];const r=s.getSelectionsWithPaths();if(e.is(r,"array")&&r.length>0)for(let n=0;n<r.length;n++){const o=r[n][0];if(e.is(o)&&(t=o.path,Array.isArray(t)&&t.length>0))break}if(Array.isArray(t)&&t.length>1&&(t.pop(),t.reverse(),t.forEach((function(t){if(!e.is(n)&&null===n){const s=o.getInstance(t),r=s.get("isInstanceOf"),a=l.checkItemHasPartialScopeNImpLink(r,s.id);e.is(a)&&!1===a&&(n=i(r))}}))),!e.is(n)&&null===n){const e=o.getInstance(t[0]).get("isAggregatedBy");n=i(e)}}}}else n=i(t);return n},a=function(i){var s,l=e.is(i)?i.arguments:null,a=null,I=null,m=widget.getValue("fromXen");i.options={isCreateRoot:null,fatherReferenceID:null,linkType:null,ebomReferenceID:null},i.options.type=null,i.options.oneDelmiaAggregationMode=n.getPreferenceValue("oneDelmiaAggregationMode"),i.options.isXRev=n.getPreferenceValue("isXRevisionActivated"),e.is(l,"array")&&l.forEach((function(t){if(e.is(t)&&e.is(t.ID,"string")&&e.is(t.Value,"string"))switch(t.ID){case"ReferenceType":i.options.type=e.is(t.Value,"string")?t.Value.split("/")[1]:null;break;case"LinkType":a=t.Value}})),s=g(i.sourceModuleId),e.is(s)&&(i.options.firstUpperScopedPrdRefPID=h(s)),I=g(m?"IMPMOD":"EBOM"),e.is(s,"string")&&s.length>0&&(i.options.isCreateRoot=!1,i.options.fatherReferenceID=o.getReferenceId(s)),e.is(I,"string")&&I.length>0&&(i.options.isCreateRoot=!0,i.options.fatherReferenceID=null,i.options.linkType=a,i.options.ebomReferenceID=I,i.options.copyModelProductToItemUponSL=n.getPreferenceValue("copyModelProductToItemUponSL")),i.options.callbacks={onSuccess:c.bind(null,{linkType:a,productRefId:I}),onFailure:u,onCancel:p},i.options.backendInfo={url:o.get3DSpaceUrl().slice(0,-1),tenant:o.getTenant(),securityContext:o.getSecurityContext(),headers:o.getHeaders({isAuthoringCtx:!0})},i.options.dialogBoxTitle=f(i.options.type,i.options.linkType),d("selectedObjectId",s),d("selectedEBOMrefId",e.is(I,"array")&&I.length>0?I[0]:I),i.options.preferences=[n.getPreferenceValue("MASS"),n.getPreferenceValue("VOLUME"),n.getPreferenceValue("AREA"),n.getPreferenceValue("LENGTH"),r.getConfigurationPID()],i.options.copyModelParentToChild=n.getPreferenceValue("copyModelParentToChild"),new t(i.options).execute()},{listenTo:function(){return{InsertCmdPLMNew:a,refreshAll:this.closeDialog}},onStart:function(t,n){I=e.extend(I,t),n()},onStop:function(){null},closeDialog:function(){}}}}}));