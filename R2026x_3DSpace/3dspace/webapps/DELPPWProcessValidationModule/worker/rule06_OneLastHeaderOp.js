define("DS/DELPPWProcessValidationModule/worker/rule06_OneLastHeaderOp",[],(function(){"use strict";return function(){var e={};self.onmessage=function(a){if(a&&a.data)switch(a.data.type){case"config":if(a.data.config&&(e=Object.assign(e,a.data.config),(a.data.config.sec_context||a.data.config.security_ctx)&&(self.sec_context=a.data.config.sec_context||a.data.config.security_ctx),a.data.config.COMPASS_CONFIG&&(self.COMPASS_CONFIG=Object.clone?Object.clone(a.data.config.COMPASS_CONFIG):a.data.config.COMPASS_CONFIG),a.data.config.require_config)){if(a.data.config.require_config.baseUrl)importScripts(a.data.config.require_config.baseUrl+"/AmdLoader/AmdLoader.js");else{const e=(self.location+"").replace(/\/[^/]+$/,"/").replace(/:444\/$/,"");var o=null;e.indexOf("blob:")>-1&&(o=e.replace(/^blob:/,"")),importScripts(o+"/3DSpace/webapps/AmdLoader/AmdLoader.js")}self.require&&self.require.config(a.data.config.require_config)}break;case"start":a.data.options&&a.data.options.workplan&&a.data.options.workplan.physicalid&&i(a.data.options);break;default:self.postMessage({type:"error",msg:"Invalid event type = "+a.data.type})}else self.postMessage({type:"error",msg:"Invalid event data"})};var i=function(i){var a={rule06_OneLastHeaderOp:{result:"pass"}},o=a.rule06_OneLastHeaderOp;self.require(["DS/DELWebInfrastructureControls/UWAUtils","DS/DELPPWProcessValidationModule/DELWebProcessValidationModel","DS/DELWebInfrastructureControls/DELWebIndexAuthoringMgmt"],(function(t,r,n){t.log("Inside rule06_OneLastHeaderOp require"),e&&(e.objAllServices&&r.updatePlatformServicesCache(e.objAllServices),e.navigateOn&&("Database"===e.navigateOn?n.setDatabase():n.setIndex())),r.getWorkPlan({workplan:i.workplan}).then((function(e){if(e){var i=[];"Advanced"===e.sequencingMode&&i.push(new Promise((function(i,a){r.getAllDescendantsForWorkplan({physicalid:e.physicalid||e.id,Depth:1}).then((function(n){if(n&&!t.Object.isEmptyObject(n)){var s={};t.each(n,(function(i,a){a&&a.physicalid&&!a.ReferencePhysicalid&&a.physicalid!==(e.physicalid||e.id)&&r.isHeaderOperation(a)&&(s[a.physicalid]=a)})),t.Object.isEmptyObject(s)||1===t.Object.keys(s).length?i(n):r.getAllTimeConstraints({physicalid:e.physicalid||e.id}).then((function(e){t.log("workplanTimeConstraintsReturn: "),t.log(e);var r=[];t.each(e,(function(e,i){i&&i.isProductFlow&&"Good"===i.flowType&&i.fromOperationOcc&&Array.isArray(i.fromOperationOcc)&&1===i.fromOperationOcc.length&&i.toOperationOcc&&Array.isArray(i.toOperationOcc)&&1===i.toOperationOcc.length&&r.push(i)}));var c=[];if(t.each(r,(function(e,i){var o={timeConstraint:i};if(t.each(["fromOperationOcc","toOperationOcc"],(function(e,a){if(i[a]&&Array.isArray(i[a])&&!(i[a].length<=0)&&i[a][i[a].length-1].instanceObject&&i[a][i[a].length-1].instanceObject.identifier){var r=i[a][i[a].length-1].instanceObject;if(r.physicalid||(r.physicalid=r.identifier),r.ReferencePhysicalid||(n[r.identifier]?r=Object.assign(r,n[r.identifier]):t.each(n,(function(e,i){return i&&i.physicalid===r.identifier&&(r=Object.assign(r,i)),!r.ReferencePhysicalid}))),r.ReferencePhysicalid||r.ReferenceOXID){var s="fromOperationOcc"===a?"operation":"operationTo";o[s+"Instance"]=r,n[r.ReferencePhysicalid]?o[s]=n[r.ReferencePhysicalid]:r.ReferenceOXID&&n[r.ReferenceOXID]?o[s]=n[r.ReferenceOXID]:t.each(n,(function(e,i){return!i||i.physicalid!==r.ReferencePhysicalid&&i.OXID!==r.ReferenceOXID||(o[s]=i,!1)}))}}})),o.operation&&o.operationTo)if(delete s[o.operation.physicalid],delete s[o.operationTo.physicalid],0===c.length)c.push(o);else{for(var r=c.length,l=c.length-1;l>=0;--l){var p=c[l];if(p.operationTo.physicalid===o.operation.physicalid)l===c[l].length-1?c.push(o):c.splice(l+1,0,o);else{if(p.operation.physicalid!==o.operationTo.physicalid)continue;0===l?c.unshift(o):c.splice(l,0,o)}break}r===c.length&&c.push(o)}else a(new Error("rule06: unable to retrieve all the references"))})),t.Object.isEmptyObject(s)){for(var l=!0,p=0;l&&p<c.length+1;++p){l=!1;for(var d=0;!l&&d<c.length-1;++d)for(var f=c[d],h=d+1;!l&&h<c.length;++h){var u=c[h];if(!(f&&u&&f.operation&&u.operation&&f.operationTo&&u.operationTo&&f.operationTo.physicalid&&u.operationTo.physicalid))break;f.operationTo.physicalid===u.operation.physicalid&&u.operation.physicalid!==c[h-1].operationTo.physicalid?(c.splice(h,1),c.splice(d+1,0,u)):f.operation.physicalid===u.operationTo.physicalid&&(c.splice(h+1,0,f),c.splice(d,1),l=!0)}}for(var g={},O=c.length-1;O>=0;--O){var y=c[O];t.Object.isEmptyObject(g)||g[y.operationTo.physicalid]||(o.issues||(o.issues=[]),o.issues.push({short:"Only one last Header Operation allowed.",operation:y.operationTo})),g[y.operation.physicalid]=y.operation,g[y.operationTo.physicalid]=y.operationTo}}else o.issues||(o.issues=[]),t.each(s,(function(e,i){o.issues.push({short:"Only one last Header Operation allowed.",operation:i})}));o.issues&&o.issues.length&&(o.result="blocking",o.messages||(o.messages={}),o.messages[o.issues[0].short]||(o.messages[o.issues[0].short]={long:"Only one last Header Operation (only one Header Operation with no successor).",fixes:["Add a valid flow for this operation.","Remove the Header Operation from the sequence."]})),i(r)}),a)}else a(new Error("invalid response from getAllDescendantsForWorkplan"))}),a)}))),Promise.all(i).then((function(){self.postMessage({type:"complete",result:a})}),(function(e){self.postMessage({type:"error",msg:"Unable to retrieve items for operations",objError:e})}))}else self.postMessage({type:"error",msg:"Unable to locate work plan"})}),(function(e){self.postMessage({type:"error",msg:"Error",objError:e})}))}))}}}));