define("DS/DELPPWProcessValidationModule/worker/rule08_ItemConsumption_role",[],(function(){"use strict";return function(){const e=["Add"];var i={};self.onmessage=function(e){if(e&&e.data)switch(e.data.type){case"config":if(e.data.config&&(i=Object.assign(i,e.data.config),(e.data.config.sec_context||e.data.config.security_ctx)&&(self.sec_context=e.data.config.sec_context||e.data.config.security_ctx),e.data.config.COMPASS_CONFIG&&(self.COMPASS_CONFIG=Object.clone?Object.clone(e.data.config.COMPASS_CONFIG):e.data.config.COMPASS_CONFIG),e.data.config.require_config)){if(e.data.config.require_config.baseUrl)importScripts(e.data.config.require_config.baseUrl+"/AmdLoader/AmdLoader.js");else{const e=(self.location+"").replace(/\/[^/]+$/,"/").replace(/:444\/$/,"");var n=null;e.indexOf("blob:")>-1&&(n=e.replace(/^blob:/,"")),importScripts(n+"/3DSpace/webapps/AmdLoader/AmdLoader.js")}self.require&&self.require.config(e.data.config.require_config)}break;case"start":e.data.options&&e.data.options.workplan&&e.data.options.workplan.physicalid&&t(e.data.options);break;default:self.postMessage({type:"error",msg:"Invalid event type = "+e.data.type})}else self.postMessage({type:"error",msg:"Invalid event data"})};var t=function(t){var n={rule08_ItemConsumption_role:{result:"pass"}};self.require(["DS/DELWebInfrastructureControls/UWAUtils","DS/DELPPWProcessValidationModule/DELWebProcessValidationModel","DS/DELWebInfrastructureControls/DELWebIndexAuthoringMgmt"],(function(c,a,s){i&&(i.objAllServices&&a.updatePlatformServicesCache(i.objAllServices),i.navigateOn&&("Database"===i.navigateOn?s.setDatabase():s.setIndex()));var o=t.workplan;a.getAllDescendantsForWorkplan({physicalid:o.physicalid||o.id,Depth:2}).then((function(i){if(c.log("workplanDescendantsReturn: "),c.log(i),i&&!c.Object.isEmptyObject(i)){var t=n.rule08_ItemConsumption_role,s=[];c.each(i,(function(e,t){return!t||t.physicalid!==(o.physicalid||o.id)||((o=Object.assign(o,t)).children&&o.children.length&&c.each(o.children,(function(e,t){t&&(t.OXID&&i[t.OXID]?o.children[e]=Object.assign(i[t.OXID],t):t.physicalid&&i[t.physicalid]?o.children[e]=Object.assign(i[t.physicalid],t):c.each(i,(function(n,c){return t.OXID&&t.OXID===c.OXID?(o.children[e]=Object.assign(i[n],t),!1):!t.physicalid||t.physicalid!==c.physicalid||(o.children[e]=Object.assign(i[n],t),!1)})))})),!1)}));var r=function(n,s){if(n&&s&&s.length)return new Promise((function(o,r){var l=[];c.each(s,(function(s,o){o&&!o.isScope&&o.itemOcc&&o.itemOcc.length>0&&e.indexOf(o.usage)<0&&l.push(new Promise((function(s,r){if(o.itemOcc[o.itemOcc.length-1].instanceObject&&o.itemOcc[o.itemOcc.length-1].instanceObject.identifier&&o.itemOcc[o.itemOcc.length-1].instanceObject.relativePath){var l=Object.assign({physicalid:o.itemOcc[o.itemOcc.length-1].instanceObject.identifier},o.itemOcc[o.itemOcc.length-1].instanceObject),d=new RegExp("dsmfg:MfgItem/([a-zA-Z0-9]*)/").exec(o.itemOcc[o.itemOcc.length-1].instanceObject.relativePath);d&&d.length>1&&(l.ParentPhysicalid=d[1]),a.getProducedItemInstance(l).then((function(a){if(a&&!c.Object.isEmptyObject(a)&&a.reference){t.result="warning",t.messages||(t.messages={}),t.messages["Items linked to operations must be of a specified role."]||(t.messages["Items linked to operations must be of a specified role."]={long:"Each and every implement link from Operation step to Item must be defined with a role contained in a list.",fixes:["Remove the Item from the Operation.","Change the Role linked to the Operation to one of the valid types.","Valid Roles: "+e.join(", ")]}),t.issues||(t.issues=[]);var l={short:"Items linked to operations must be of a specified role.",operation:n,item:{physicalid:a.reference}};o.operationOcc&&o.operationOcc.length&&o.operationOcc[o.operationOcc.length-1].instanceObject?(l.operationInstance=o.operationOcc[o.operationOcc.length-1].instanceObject,c.each(i,(function(e,i){return i&&i.physicalid===o.operationOcc[o.operationOcc.length-1].instanceObject.identifier&&(l.operationInstance=Object.assign(l.operationInstance,i)),!l.operationInstance.ReferencePhysicalid})),l.operationInstance.ReferencePhysicalid?(l.operation={physicalid:l.operationInstance.ReferencePhysicalid},i[l.operationInstance.ReferencePhysicalid]?l.operation=i[l.operationInstance.ReferencePhysicalid]:l.operationInstance.ReferenceOXID&&i[l.operationInstance.ReferenceOXID]?l.operation=i[l.operationInstance.ReferenceOXID]:c.each(i,(function(e,i){return!i||i.physicalid!==l.operationInstance.ReferencePhysicalid||(l.operation=i,!1)}))):c.log("rule08_ItemConsumption_role: unable to retrieve the operation ReferencePhysicalid!")):c.log("rule08_ItemConsumption_role: unable to retrieve the linked operation!"),t.issues.push(l),s(o)}else r(new Error("Unable to locate produced item reference"))}),r)}else r(new Error("unable to located the implement link's last instanceObject"))})))})),Promise.all(l).then(o,r)}))};c.each(i,(function(e,t){if(t&&!t.ReferencePhysicalid&&!t.ReferenceOXID)if(t.physicalid!==o.physicalid&&o.children&&o.children.length){var n=!1;if(c.each(o.children,(function(e,i){if(i)return(i.ReferenceOXID&&i.ReferenceOXID===t.OXID||i.ReferencePhysicalid&&i.ReferencePhysicalid===t.physicalid)&&(n=!0),!n})),n&&t.children&&t.children.length&&a.isHeaderOperation(t))return void c.each(t.children,(function(e,t){t.OXID&&i[t.OXID]?t=i[t.OXID]:t.physicalid&&i[t.physicalid]?t=i[t.physicalid]:c.each(i,(function(e,i){return n.OXID&&i.OXID===t.OXID||t.physicalid&&i.physicalid===t.physicalid?(t=i,!1):void 0}));var n={physicalid:t.ReferencePhysicalid,OXID:t.ReferenceOXID};n.OXID&&i[n.OXID]?n=i[n.OXID]:n.physicalid&&i[n.physicalid]?n=i[n.physicalid]:c.each(i,(function(e,i){return n.OXID&&i.OXID===n.OXID||n.physicalid&&i.physicalid===n.physicalid?(n=i,!1):void 0})),t.reference=n,t&&a.isOperation(t.reference)&&s.push(new Promise((function(e,i){a.getImplementedItemsForMfgProcess(t).then((function(t){t&&t.length>0?r(n,t).then(e,i):e(t)}),i)})))}))}else t.physicalid===o.physicalid&&s.push(new Promise((function(e,i){a.getImplementedItemsForMfgProcess(t).then((function(n){n&&n.length>0?r(t,n).then(e,i):e(n)}),i)})))})),Promise.all(s).then((function(){self.postMessage({type:"complete",result:n})}),(function(e){self.postMessage({type:"error",msg:"Unable to retrieve items for operations",objError:e})}))}else self.postMessage({type:"complete",result:n})}),(function(e){self.postMessage({type:"error",msg:"Error",objError:e})}))}))}}}));