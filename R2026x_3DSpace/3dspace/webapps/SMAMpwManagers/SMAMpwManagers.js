/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/SMAMpwManagers/SMAMpwMatOverrideManager",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/SceneGraphOverrides/SceneGraphOverrideSet"],(function(e,i,t,r,s,o){"use strict";var n="MPW_PASSFAILMAT_ID",a=function(e,i){var t;if(e&&e.rootNode&&i){for(var r=[i],o=i.parents[0];o&&o!==e.rootNode;)r.unshift(o),o=o.parents[0];r.unshift(e.rootNode),t=new s(r)}return t},h=function(e,i,t){var r;if(e&&t){var s=e.getOverridesFromPathElement(t);if(s)for(var o,n=0;n<s.length&&!o;n++){var a=s[n].getMaterial();(o=a&&a.mpwMatID===i)&&(r=s[n])}}return r},l=function(e,i,t,r){if(e&&e.rootNode&&i&&t){var s=a(e,i),o=h(e,r,s);o||(o=e.createOverride(s)),o?o.setMaterial(t,!0):console.warn("SMAMpwMatOverrideManager - createOverride failed. check that the provided node is actually attached to SG")}},v=function(e,i,t,r){if(e&&e.rootNode&&i&&t){var s=a(e,i),o=h(e,r,s);o&&o.setMaterial(null,!0)}},g=function(e,i){var t;if(e.length>0&&i){for(var r=0;e[r].id!==i&&r<e.length;)r++;r<e.length&&(t={index:r,set:e[r]})}return t},p=i.extend({init:function(){this._parent(),this._sets=[]},getOverrideSet:function(e){var i=g(this._sets,e);return i&&i.set?i.set.sgOverrideSet:void 0},createOverrideSet:function(e){if(e&&e.id&&e.viewer&&e.root){this.getOverrideSet(e.id)&&console.error("SMAMpw SceneGraphOverrideSet is already defined for this viewer");var i=e.viewer.getSceneGraphOverrideSetManager();if(i){var t=new o(e.root);this._sets.push({id:e.id,sgOverrideSet:t,viewer:e.viewer}),i.pushSceneGraphOverrideSet(t)}}else console.error("SMAMpwMatOverrideManager createOverrideSet :invalid args")},cleanOverrideSet:function(e){var i=g(this._sets,e);if(i&&i.set){var t=i.set.sgOverrideSet.getOverrides();i.set.sgOverrideSet.deleteOverrides(t),this._sets.splice(i.index,1)}},applyMaterialOverride:function(e,i,t,r){var s=this.getOverrideSet(e);l(s,i,t,r)},removeMaterialOverride:function(e,i,t,r){var s=this.getOverrideSet(e);v(s,i,t,r)},getPassFailMaterial:function(){if(!this._passFailMat){var e=r.ImageUtils.loadTexture(t.getWebappsBaseUrl()+"SMAMpwManagers/assets/textures/SMAMpwPassFail.jpg");this._passFailMat=new r.PhysicalMaterial({color:16777215,map:e}),this._passFailMat.mpwMatID=n}return this._passFailMat},updatePassFailMaterialMap:function(e,i,t,r){var s=this.getOverrideSet(e);if(s)for(var o=s.getOverridesTargetingNode(i),a=0;a<o.length;a++){var h=o[a],l=h?h.getMaterial():void 0;l&&l.mpwMatID===n&&(l.map.offset.x=t,l.map.repeat.x=r)}},applyPassFailMaterial:function(e,i){var t=this.getOverrideSet(e);t&&i&&l(t,i,this.getPassFailMaterial(),n)},removePassFailMaterial:function(e,i){var t=this.getOverrideSet(e);t&&i&&v(t,i,!0,n)}});return e.namespace("DS/SMAMpwManagers/SMAMpwMatOverrideManager",p)})),define("DS/SMAMpwManagers/SMAMpwResultProbingManager",["css!DS/SMAMpwManagers/SMAMpwResultProbing.css","UWA/Core","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/ThreeJS_DS","i18n!DS/SMAMpwManagers/assets/nls/SMAMpwProbing"],(function(e,i,t,r,s,o,n){"use strict";class a{constructor(e){this._texturePathFilter=e.texturePathFilter,this._computeProbingValue=e.computeProbingValue}testPathForTextureFS(e){return this._texturePathFilter(e)}computeProbingValue(e,i,t){return this._computeProbingValue({element:e,u:i,v:t})}}const h="NOTEXTUREVALUE",l=window.devicePixelRatio||1,v=5*l,g=100*l,p=5*l,d=70*l,c={nonTouch:{L:new o.Vector2(35*l,0),R:new o.Vector2(-65*l,0),T:new o.Vector2(0,40*l),TL:new o.Vector2(35,40*l),TR:new o.Vector2(-65,40*l)},touch:{L:new o.Vector2(50*l,0),R:new o.Vector2(-50*l,0),T:new o.Vector2(-70*l,70*l),TL:new o.Vector2(170*l,70*l),TR:new o.Vector2(-60*l,70*l)}},_={L:new o.Vector2(30*l,0),R:new o.Vector2(-25*l,0),T:new o.Vector2(-35*l,-40*l),TL:new o.Vector2(90*l,-40*l),TR:new o.Vector2(-25*l,-40*l)};let u=i.Class.extend({_remapTexCoordInResultRange:function(e){return(this._textureMax-this._textureMin)*e+this._textureMin},init:function(e){this._isProbingActive=!1,this._viewer=e.viewer,this._rootNode=e.viewer.getRootNode(),this._syncEvent=e.syncEvent,this._valueDisplayPrecision=e.valueDisplayPrecision?e.valueDisplayPrecision:3,this._probingDiv=i.createElement("div",{id:"probingField_"+this._viewer.id.toString(),class:"simux-probing-field"}),this._probingText=new i.Element("span",{class:"simux-probing-value"}).inject(this._probingDiv),this._probingMarkerDiv=i.createElement("div",{id:"probingMarker"+this._viewer.id.toString(),class:"simux-probing-marker"});let t=this;this.onSwipeProbing=function(e){let i=t._viewer.magnifier;if(i&&i.active){let r=i.getContent();("function"==typeof r.isHidden?r.isHidden():"none"===r.style.display)||t.onMoveProbing(e)}},this.onMoveProbing=function(e){if(e&&t._viewer){let i=e.from[0].getCurrentPosition(t._viewer.canvas);if(t._syncEvent){let e={position2D:{x:i.x,y:i.y}};r.publish({event:t._syncEvent,data:e})}t.processProbingPosition(i)}},this.onReleaseProbing=function(){t._probingCSS2DNode&&t._probingCSS2DNode.setVisibility(!t._probeShow),t._probingMarker&&t._probingMarker.setVisibility(!t._probeShow)}},startProbing:function(e){if(this._textureMin=void 0,this._textureMax=void 0,e&&(void 0!==e.labels?this._labels=e.labels:(this._textureMin=e.textureMin,this._textureMax=e.textureMax),this._unitText="",this._idFilter=e.idFilter,e.textureFSProbingOptions&&(this._textureFSProbingStrategy=new a(e.textureFSProbingOptions)),this._uvTransformDetected=!0===e.uvTransformDetected,this._testNodeForUVTransform=e.testNodeForUVTransform,this._getUVTransform=e.getUVTransform,t&&r&&this._viewer&&this._viewer.canvas)){if(this._probeShow=this._viewer.visibleSpace,this._viewer.unsubscribe(this._visSwapCb),this._visSwapCb=this._viewer.onSwapVisibleSpace(function(e){this._probeShow=e.visibleSpace,this._probingCSS2DNode&&this._probingCSS2DNode.setVisibility(!this._probeShow),this._probingMarker&&this._probingMarker.setVisibility(!this._probeShow)}.bind(this)),!this._probingCSS2DNode){let e=this._rootNode;e&&(this._probingCSS2DNode=new s({html:this._probingDiv,name:"SimNavProbingCSS2D"}),this._probingCSS2DNode.setPickability(!1),this._probingCSS2DNode.setVisibility(!this._probeShow),e.add(this._probingCSS2DNode),this._probingMarker=new s({html:this._probingMarkerDiv,name:"SimNavProbingMarker"}),this._probingMarker.setPickability(!1),this._probingMarker.setVisibility(!this._probeShow),e.add(this._probingMarker)),this._probingPosMatrix||(this._probingPosMatrix=new o.Matrix4);let i=window.devicePixelRatio||1;this._magStateToRestore=this._viewer.magnifier&&this._viewer.magnifier.active,t.isTouch&&(this._viewer.setMagnifier({activated:!0}),this._viewer.magnifier&&(this._magShiftVector={x:this._viewer.magnifier.shiftVector.x,y:this._viewer.magnifier.shiftVector.y},t.addEvent(this._viewer.canvas,"onSwipe",this.onSwipeProbing),t.addEvent(this._viewer.canvas,"onRelease",this.onReleaseProbing)));let r=t.isTouch&&this._magShiftVector?this._magShiftVector.x:-30,n=t.isTouch&&this._magShiftVector?-40-this._magShiftVector.y:-40;this._probingOffset=new o.Vector2(r*i,n*i)}t.addEvent(this._viewer.canvas,"onMouseMove",this.onMoveProbing),this._viewpointChangeCallback=r.subscribe({event:"/VISU/"},function(e){"@onViewpointBeginMove"===e.eventType?this._viewpointManipulation=!0:"@onViewpointEndMove"===e.eventType&&(this._viewpointManipulation=!1)}.bind(this)),this._isProbingActive=!0}},stopProbing:function(){if(t&&r&&this._viewer&&this._viewer.canvas&&(t.removeEvent(this._viewer.canvas,"onMouseMove",this.onMoveProbing),t.removeEvent(this._viewer.canvas,"onSwipe",this.onSwipeProbing),t.removeEvent(this._viewer.canvas,"onRelease",this.onReleaseProbing),r.unsubscribe(this._viewpointChangeCallback),this._viewpointManipulation=!1),this._isProbingActive=!1,this._textureMin=void 0,this._textureMax=void 0,this._labels=void 0,this._uvTransformDetected=!1,this._testNodeForUVTransform=void 0,this._getUVTransform=void 0,this._viewer&&this._viewer.canvas){let e=this._rootNode;e&&this._probingCSS2DNode&&e.remove(this._probingCSS2DNode),e&&this._probingMarker&&e.remove(this._probingMarker),this._probingCSS2DNode=void 0,this._probingMarker=void 0,this._viewer.magnifier&&this._viewer.setMagnifier({activated:this._magStateToRestore}),this._viewer.unsubscribe(this._visSwapCb)}},isProbingActive:function(){return this._isProbingActive},getUnitPostFix:function(){return this._unitText},setProbingUnit:function(e,i){e?this._unitText="":i&&(this._unitText=" "+i.toString())},processProbingPosition:function(e,i){if(this._probingCSS2DNode&&this._probingCSS2DNode.setVisibility(!this._probeShow),this._probingMarker&&this._probingMarker.setVisibility(!this._probeShow),this._viewer&&this._viewer.canvas&&this._isProbingActive&&!this._viewpointManipulation&&(void 0!==this._textureMin&&void 0!==this._textureMax||void 0!==this._labels)&&(i=i||this._viewer.pick(this._viewer.getMousePosition(e),"primHybrid",!0))){let e=i.path;if(e.length>0){let t=e[0].externalPath,r=t[0].name,s=t[1].getModelIdentification(),o="annotGroupNode"===t[1].name;if("Experience"!==r&&"DMUReviewBag"!==r&&"root-bag-web"!==r&&!o&&(!this._idFilter||this._idFilter&&s===this._idFilter)){let e=i.position,r=i.uv,s=!1;if(this._textureFSProbingStrategy){let i=t.filter((e=>this._textureFSProbingStrategy.testPathForTextureFS(e))),o=i[i.length-1];if(o){let i=this._textureFSProbingStrategy.computeProbingValue(o,r.x,r.y),t=isNaN(i)?"":i.toPrecision(this._valueDisplayPrecision);this.updateProbingToDisplay(t,e),s=!0}}if(!s&&r&&!isNaN(r.x)){let i;if(void 0!==this._labels){if(this._uvTransformDetected)i=this._labels[r.x];else{let e=Math.round(this._labels.length*r.x+.5);0<e&&e<=this._labels.length&&(i=this._labels[e-1])}this.updateProbingToDisplay(i,e)}else{let s,o=r.x,a=r.y;if(this._uvTransformDetected)if(a>=1)i=n.get(h);else{let e=t.filter((e=>this._testNodeForUVTransform(e)));if(e.length>0){let i=this._getUVTransform(e[0]),t=i.elements[0];o=i.elements[6]+t*r.x,o<0&&(o=0),o>1&&(o=1)}s=this._remapTexCoordInResultRange(o),i=s.toPrecision(this._valueDisplayPrecision)}else a>1?i=n.get(h):(s=this._remapTexCoordInResultRange(o),i=s.toPrecision(this._valueDisplayPrecision));this.updateProbingToDisplay(i,e)}}}}}},updateProbingToDisplay:function(e,i){if(this._viewer&&this._viewer.canvas){if(this._probingPosMatrix.setPosition(i),this._probingCSS2DNode){this._probingText.setText(e+this.getUnitPostFix()),this._probingCSS2DNode.setMatrix(this._probingPosMatrix);let i=new o.Vector2(0,0);i=i.addVectors(i,this._probingOffset),this._probingCSS2DNode.setOffset(i),this._probingCSS2DNode.updatePosition();let r=new o.Vector2(0,0),s={w:parseInt(this._probingCSS2DNode.css2DNode.element.parentElement.clientWidth),h:parseInt(this._probingCSS2DNode.css2DNode.element.parentElement.clientHeight)},n=parseInt(this._probingCSS2DNode.css2DNode.element.style.top),a=parseInt(this._probingCSS2DNode.css2DNode.element.style.left),h=t.isTouch,l=h?c.touch:c.nonTouch,u=function(e){e.length>0&&(i=i.addVectors(i,l[e]),h&&(r=r.addVectors(r,_[e])))},f="";n<p&&(f="T"),u(f),a<v||"T"===f&&a<d?f="T"===f?"TL":"L":(a>s.w-g||"T"===f&&a>s.w-g)&&(f="T"===f?"TR":"R"),u(f);let S=this._viewer.magnifier;h&&S&&S.active&&(S.shiftVector.x=this._magShiftVector.x+r.x,S.shiftVector.y=this._magShiftVector.y+r.y),this._probingCSS2DNode.setOffset(i),this._probingCSS2DNode.updatePosition(),this._probingCSS2DNode.setVisibility(this._probeShow)}this._probingMarker&&(this._probingMarker.setMatrix(this._probingPosMatrix),this._probingMarker.setVisibility(this._probeShow)),this._viewer.render()}}});return i.namespace("DS/SMAMpwManagers/SMAMpwResultProbingManager",u)})),define("DS/SMAMpwManagers/SMAMpwTextureMapProcessor",["UWA/Core","UWA/Class"],(function(e,i){"use strict";var t=function(e,i){var t={uvOffset:0,uvScale:1};if(e&&e.from&&e.to&&(e.from.min!==e.to.min||e.from.max!==e.to.max)){var r=isNaN(i)?3:i;t.uvScale=0,parseFloat(e.from.max.toPrecision(r))>parseFloat(e.from.min.toPrecision(r))&&(parseFloat(e.to.max.toPrecision(r))>parseFloat(e.to.min.toPrecision(r))&&(t.uvScale=(e.to.max-e.to.min)/(e.from.max-e.from.min)),t.uvOffset=(e.to.min-e.from.min)/(e.from.max-e.from.min))}return t},r=function(e,i,t){e&&(e.offset.x=i,e.repeat.x=t)},s="RetexturingScale",o="RetexturingShift",n=function(e,i,t){if(e){var n=e.getPrimitives();if(n)for(var a=0;a<n.length;a++){var h=n[a];if(h&&h.sgNode&&h.sgNode.getGroup()){var l=h.sgNode.getGroup();if(l){var v=!1;if(l.material){var g=l.material.getPDSFXUniform(s),p=l.material.getPDSFXUniform(o);g&&p?(l.material.updatePDSFXUniform(s,t),l.material.updatePDSFXUniform(o,i),v=!0):l.material.map&&(r(l.material.map,i,t),v=!0)}v||l.gas&&l.gas.map&&r(l.gas.map,i,t)}}}}};let a=e=>{let i,t=!1;if(e){const r=e.getPrimitives();r&&r.some((e=>{if(e&&e.sgNode&&e.sgNode.getGroup()){const r=e.sgNode.getGroup();r&&r.material&&(i=r.material.diffuseUvTransform,i&&(t=!i.isIdentity()))}return t}))}return t?i:void 0};var h=i.extend({init:function(){this._parent()},applyToNode:function(e){!function(e){if(e&&e.node){var i=e.uvOffset,r=e.uvScale;if(Array.isArray(e.rangeTransformations)&&e.rangeTransformations.length>0){i=0,r=1;for(var s=0;s<e.rangeTransformations.length;s++){var o=e.rangeTransformations[s];if(o){var a=t(o,e.precision);i=i*a.uvScale+a.uvOffset,r*=a.uvScale}}}if(!isNaN(i)&&!isNaN(r))for(var h=e.node.children,l=0;l<h.length;l++){var v=h[l];if(v&&(void 0===e.childCondition||e.childCondition(v))){if(0===v.children.length)n(v,i,r);else for(var g=0;g<v.children.length;g++){var p=v.children[g];if(e.frameCondition&&(e.frameCondition(p,g)||(p=null)),p){var d=p.children[0];d&&n(d,i,r)}}e.childPostProcessing&&e.childPostProcessing(v,i,r)}}}}(e)},searchForUVTransform:function(e){return this._uvTransform=(e=>{let i,t=!1;const r=e.node.children;return r&&r.forEach((r=>{if(r&&(void 0===e.childCondition||e.childCondition(r))){let s=!1;if(0===r.children.length)i=a(r),s=void 0!==i;else{const e=r.children[0];if(e){const t=e.children[0];t&&(i=a(t),s=void 0!==i)}}s&&e.nodeUpdateOperator&&e.nodeUpdateOperator(r,i),t=t||s}})),t})(e),this._uvTransformFound=void 0!==this._uvTransform,this._uvTransformFound}});return e.namespace("DS/SMAMpwManagers/SMAMpwTextureMapProcessor",h)}));