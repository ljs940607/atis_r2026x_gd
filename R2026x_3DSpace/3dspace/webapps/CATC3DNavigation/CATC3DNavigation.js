/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATC3DNavigation/CAT3DComposeExamineController",["UWA/Class","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATWebUXComponents/DMUCommandsManager"],(function(e,t,n,i){"use strict";var a=e.extend({init:function(e){var a=e||{};this._parent(a);var o,r,l,s,c=a.ctxViewer,d=c.getViewer(),u=d.getSceneGraphOverrideSetManager(),m=!1,h=[],v=function(){var e=t.get();return!(!e||!Array.isArray(e))&&(e.length>50||e.some((function(e){if(!e||!e.pathElement||e.pathElement.externalPath.length<2||!n.isAModelPath(e.pathElement))return!1;var t=e.pathElement,i=u.getCurrentVisibilityFree(t);return"boolean"==typeof i&&((!0!==i||u.getCurrentVisibility(t))&&(!t.getBoundingBox(null,d,"visibleSpace").isNaN()||!t.getBoundingBox(null,d,"invisibleSpace").isNaN()))})))};function g(){var e=i.getCommand("CAT3DComposeExamineSelectionHdr",c.getCommandContext());e&&(v()?e.isEnabled()||e.enable():e.isEnabled()&&!e.isRunning()&&e.disable())}o=function(e){if((" "===e.key||"Spacebar"===e.key||32===e.keyCode)&&!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey){document.removeEventListener("keypress",o),document.addEventListener("keyup",r);var t=i.getCommand("CAT3DComposeExamineSelectionHdr",c.getCommandContext());if(!t)return;v()?t.begin():t.cancel()}},r=function(e){" "!==e.key&&"Spacebar"!==e.key&&32!==e.keyCode||(document.removeEventListener("keyup",r),document.addEventListener("keypress",o))};this.clearController=function(){this.setActiveState(!1)},this.canBeEnabled=function(){return v()},this.setActiveState=function(e){if(m!==e){m=e;var n=i.getCommand("CAT3DComposeExamineSelectionHdr",c.getExecutionContext?c.getExecutionContext():c.getCommandContext());m?(n&&n.enable(),document.addEventListener("keypress",o),0===h.length&&(h.push(t.onPostAdd(g)),h.push(t.onPostRemove(g))),l||(l=c.subscribe({event:"onShow"},g)),s||(s=c.subscribe({event:"onHide"},g)),g()):(document.removeEventListener("keypress",o),document.removeEventListener("keyup",r),h.forEach((function(e){t.unsubscribe(e)})),c.unsubscribe(l),c.unsubscribe(s),h.length=0,l=s=null,n&&!n.isRunning()&&n.disable())}}}}),o=[];return e.singleton({init:function(){},getExamineController:function(e){var t;if(e&&e.context){for(var n=0;n<o.length;n++)if(o[n].context===e.context){t=o[n].ExamineController;break}if(!t){var i=new a({ctxViewer:e.context});o.push({context:e.context,ExamineController:i}),t=i}}return t},unregisterExamineController:function(e){if(e&&e.context)for(var t=0;t<o.length;t++)if(o[t].context===e.context){o[t].ExamineController.clearController(),o.splice(t,1);break}}})})),function(){"use strict";var e=[];e.giveNavigationObject=function(t){var n;return t&&t.context&&(n=null,e.some((function(e){return e.context===t.context&&(n=e,!0)}))),n},e.getNavigationObject=function(t){var n=this.giveNavigationObject(t);return null===n&&(n={context:t.context,onStart:null,onExit:null,controller:null,activated:!1},e.push(n)),n},define("DS/CATC3DNavigation/CATD3CBoxNavigation",["UWA/Core","UWA/Class","DS/VisuEvents/EventsManager","DS/Visualization/PathElement","DS/CATW3DAnims/CATW3DAnimation3D","DS/PADUtils/PADWSAccess","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/SceneGraphNodes/FixedSizeNode3D","DS/CATC3DNavigation/CATBreadCrumbs","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DComposeUtils/CATC3DDropManager","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(e,t,n,i,a,o,r,l,s,c,d,u,m,h,v,g,p,x,f,C,b,y,D){function w(e){this.pts=[new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3],this.vecU=new r.Vector3,this.vecV=new r.Vector3,this.vecW=new r.Vector3,e&&(this.pts[0].set(e.min.x,e.min.y,e.min.z),this.pts[1].set(e.max.x,e.min.y,e.min.z),this.pts[2].set(e.min.x,e.max.y,e.min.z),this.pts[3].set(e.max.x,e.max.y,e.min.z),this.pts[4].set(e.min.x,e.min.y,e.max.z),this.pts[5].set(e.max.x,e.min.y,e.max.z),this.pts[6].set(e.min.x,e.max.y,e.max.z),this.pts[7].set(e.max.x,e.max.y,e.max.z),this.vecU.subVectors(this.pts[1],this.pts[0]),this.vecV.subVectors(this.pts[2],this.pts[0]),this.vecW.subVectors(this.pts[4],this.pts[0]))}function A(){var e,t,n,i,a,o;this.store=function(l,s){var c=s?(new r.Matrix4).getInverse(s):null,d=c?(new r.Matrix4).extractRotation(c):null;e=l.getEyePosition(),c&&e.applyMatrix4(c),t=l.getUpDirection(),d&&t.applyMatrix4(d),n=l.getSightDirection(),d&&n.applyMatrix4(d),i=l.getTargetDistance(),a=l.getProjectionType(),o=l.getAngle()},this.restore=function(l,s){if(e){var c=s?(new r.Matrix4).extractRotation(s):null;l.moveTo({eyePosition:s?e.applyMatrix4(s):e,upDirection:c?t.applyMatrix4(c):t,sightDirection:c?n.applyMatrix4(c):n,distanceToTarget:i}),l.setProjectionType(a),l.setAngle(o)}}}function S(e){var t,n,i,a,o=e&&e.externalPath.length>1;for(t=0,n=e.externalPath.length-1;o&&t<n;++t)i=e.externalPath[t],a=e.externalPath[t+1],i.children.indexOf(a)<0&&(o=!1);return o}function E(e){if(!e)return!1;if(D.isReference(e))return!0;var t=D.getNodeType(e);return"CATDrawing"===t||"Drawing"===t||"CATAnalysis"===t||"PPRContext"===t}function M(e){if(!e)return!1;if(D.isInstance(e))return!0;var t=D.getNodeType(e);return"CatDrawing"===t||"CatAnalysis"===t||"CatProcess"===t}function P(e){return!e||e.empty()||e.isNaN()||e.min.distanceTo(e.max)<=0}w.prototype={constructor:w,copy:function(e){for(var t=0;t<8;++t)this.pts[t].copy(e.pts[t]);return this.vecU.copy(e.vecU),this.vecV.copy(e.vecV),this.vecW.copy(e.vecW),this},clone:function(){return(new this.constructor).copy(this)},center:function(e){return(e||new r.Vector3).set(.5*(this.pts[0].x+this.pts[7].x),.5*(this.pts[0].y+this.pts[7].y),.5*(this.pts[0].z+this.pts[7].z))},applyMatrix4:function(e){for(var t=0;t<8;++t)this.pts[t].applyMatrix4(e);var n=(new r.Matrix4).extractRotation(e);return this.vecU.applyMatrix4(n),this.vecV.applyMatrix4(n),this.vecW.applyMatrix4(n),this},containsPoint:function(e){return!(e.x<this.pts[0].x||e.x>this.pts[7].x||e.y<this.pts[0].y||e.y>this.pts[7].y||e.z<this.pts[0].z||e.z>this.pts[7].z)},minX:function(){for(var e=this.pts[0].x,t=1;t<8;++t)e=Math.min(e,this.pts[t].x);return e},maxX:function(){for(var e=this.pts[0].x,t=1;t<8;++t)e=Math.max(e,this.pts[t].x);return e},minY:function(){for(var e=this.pts[0].y,t=1;t<8;++t)e=Math.min(e,this.pts[t].y);return e},maxY:function(){for(var e=this.pts[0].y,t=1;t<8;++t)e=Math.max(e,this.pts[t].y);return e},minZ:function(){for(var e=this.pts[0].z,t=1;t<8;++t)e=Math.min(e,this.pts[t].z);return e},maxZ:function(){for(var e=this.pts[0].z,t=1;t<8;++t)e=Math.max(e,this.pts[t].z);return e},min:function(){for(var e=(new r.Vector3).copy(this.pts[0]),t=1;t<8;++t)e.x=Math.min(e.x,this.pts[t].x),e.y=Math.min(e.y,this.pts[t].y),e.z=Math.min(e.z,this.pts[t].z);return e},max:function(){for(var e=(new r.Vector3).copy(this.pts[0]),t=1;t<8;++t)e.x=Math.max(e.x,this.pts[t].x),e.y=Math.max(e.y,this.pts[t].y),e.z=Math.max(e.z,this.pts[t].z);return e}},A.prototype={constructor:A},Object.freeze(A);var T,N,V=-1,R=144,B=108,L=1e-6,k=y.getOption("C3DSTR"),I=new r.Vector3(0,0,1),U=new r.Vector3(1,0,0),W=new r.Vector3(-1,0,0),O=Math.PI,z=.5*Math.PI,F=.25*Math.PI,_=.75*Math.PI,H=new r.Color("rgb(202,202,202)").getHex(),j=new r.Color("rgb(54,142,196)").getHex(),X=0,Y={},q=new r.MeshBasicMaterial({map:new r.ImageUtils.loadTexture(d.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",void 0,null,null,!0),side:r.DoubleSide,force:!0,transparent:!0}),Z=new r.MeshBasicMaterial({map:new r.ImageUtils.loadTexture(d.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",void 0,null,null,!0),side:r.DoubleSide,force:!0,transparent:!0});function G(){T=new r.MeshBasicMaterial({color:H,opacity:.95}),N=new r.MeshBasicMaterial({color:j,opacity:.95}),T.line=N.line=new r.LineBasicMaterial({color:X,opacity:.95}),T.force=N.force=!0}return G(),t.extend({init:function(t){var d,y,H,j,K,J,Q,$,ee,te,ne,ie,ae,oe,re,le,se,ce,de=t.context,ue=de.getController(),me=de.getViewer(),he=me.getSceneGraphOverrideSetManager(),ve=!1,ge=[],pe=de.getRootBagPath().getLastElement(!0),xe=a.getAnimation3DEngine({viewer:me}),fe={},Ce=[],be=[];function ye(t,n,a){var o=t.pathElement.getLastElement(!0);if(o&&o.navigationAssociatedPath)t.pathElement=2===n?o.navigationAssociatedPath.clone():new i(t.pathElement.externalPath.slice(0,3));else if(t.pathElement.externalPath[0]===pe){if(1===n&&a){var r=fe.levels[fe.levels.length-1].node.getChildByName("EmptyNodes");r&&r.getChildren().some((function(n){if(n.children.length&&t.pathElement.isAParentOf(n.navigationAssociatedPath)){var a=e.extend({},t,!1);return a.pathElement=new i([fe.levels[fe.levels.length-1].node,r,n,n.children[0]]),s.isIn(a)||s.add(a),!0}return!1}))}var l=j.clone(),c=j.getLastElement(!0);t.pathElement.externalPath.length>l.externalPath.length&&(l.addElement(t.pathElement.externalPath[l.externalPath.length]),c!==pe&&t.pathElement.externalPath.length>l.externalPath.length&&l.addElement(t.pathElement.externalPath[l.externalPath.length]),t.pathElement=l)}return t}function De(e,t,n){Array.isArray(e)?e.forEach((function(e){ye(e,t,n)})):ye(e,t,n)}function we(e){De(e,0,!0)}function Ae(e){De(e,1,!0)}function Se(e){De(e,2,!0)}function Ee(e){De(e,1,!1)}function Me(e){return ye({pathElement:e},2,!0).pathElement}function Pe(t){if(t&&t.completed)if(t.arrayPath&&1===t.arrayPath.length&&t.token){var n=Me(t.arrayPath[0]);if(n){var i,a=n.getLastElement(!0),o=a?D.getNodeID(a):void 0;if(o){n.externalPath.length>1&&D.isInstance(n.externalPath[n.externalPath.length-2])&&(i=D.getNodeID(n.externalPath[n.externalPath.length-2]));var r=[o];i&&r.push(i),de.getController().getAttributes({ids:r,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(n){var a,r=n[o]?n[o]["ds6w:label"]:"";if(i&&n[i]&&n[i]["ds6w:label"]&&(r+=" ("+n[i]["ds6w:label"]+")"),r&&"string"==typeof r&&0!==r.trim().length){(a=e.createElement("div")).setText(r);var l=n[o].type_icon_url;l&&"string"==typeof l&&l.length>0&&(a.setStyles({"background-image":"url("+l+")","background-repeat":"no-repeat","background-position-y":"center"}),a.setStyle("padding-left","21px"))}t.completed({token:t.token,div:a})},onFailure:function(){t.completed({token:t.token})}}})}else t.completed()}else t.completed()}else t.completed()}function Te(){$?$.restore(de.getFrameWindow().getViewpoint(),j.getWorldMatrix()):($=new A,de.getFrameWindow().getViewpoint().reframe(null))}function Ne(e,t){var n=d.createOverride({pathes:e});return t.push(n),n}function Ve(t){var n=t.getLastElement(!0),i=!0===he.getCurrentVisibility(t)?0:!0===he.getCurrentVisibilityFree(t)?-1:1;if(E(n)||D.is3DLeaf(n))return i;var a=n.getChildren();if(1!==a.length)return e.log("Instance or RepInstance with no or more than one Reference or RepReference"),i;var o=t.clone();return o.addElement(a[0]),!0===he.getCurrentVisibility(o)?0:!0===he.getCurrentVisibilityFree(o)?-1:1}function Re(e,t){if(e){var n=null,i=e.angleTo(t);return i>L&&O-i>L&&(n=new r.Matrix4,i<=z||i-z<L?n.makeRotationAxis((new r.Vector3).crossVectors(e,t).normalize(),i):n.makeRotationAxis((new r.Vector3).crossVectors(e,t).normalize().negate(),O-i)),n}}function Be(e,t,n){if(k){var i,a,o,l,s=e.clone(),c=s.vecU.length(),d=s.vecV.length(),u=s.vecW.length(),m=s.vecU,h=s.vecV,v=s.vecW;return n?((l=v.angleTo(I))>L&&(i=(new r.Matrix4).makeRotationAxis((new r.Vector3).crossVectors(v,I).normalize(),l),s.applyMatrix4(i)),(l=m.angleTo(U))>L&&O-l>L&&Math.abs(l-z)>L&&(a=new r.Matrix4,l<=F?a.makeRotationAxis((new r.Vector3).crossVectors(m,U).normalize(),l):l>=_?a.makeRotationAxis((new r.Vector3).crossVectors(m,W).normalize(),O-l):(l=h.angleTo(U))<=F?a.makeRotationAxis((new r.Vector3).crossVectors(h,U).normalize(),l):a.makeRotationAxis((new r.Vector3).crossVectors(h,W).normalize(),O-l),i=i?a.multiply(i):a)):(u<=c&&u<=d?(m=s.vecU,h=s.vecV,o=s.vecW):c<=d&&c<u?(m=s.vecV,h=s.vecW,o=s.vecU):(m=s.vecW,h=s.vecU,o=s.vecV),(i=Re(o,I))&&s.applyMatrix4(i),t&&(a=Re(o=(c=m.length())===(d=h.length())?t.x?m:h:c>d?m:h,t))&&(i=i?a.multiply(i):a)),i}}function Le(e,t,n){var i=(new r.Matrix4).setPosition(e),a=(new r.Matrix4).copy(t).multiply((new r.Matrix4).getInverse(i).multiply(n));return i.multiply(a)}function ke(e,t){var n=new r.Vector3(0,0,0);return n.applyMatrix4(t),e.containsPoint(n)||e.center(n),n}function Ie(e,t,n){return e.setSSAO(!1),e.setShadow(!1,!1),e.setRenderDepth(1),t||(e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.exludeFromBounding(!0)),n&&(e.name=n),e}function Ue(e){if(e.box){var t=!1;if(1===e.node.children.length){var n=e.node.children[0];(D.is3DLeaf(n)||D.is3DLeaf(e.node)||M(e.node)&&!E(n)||E(e.node)&&!M(n))&&(t=!0)}var i=e.box,a=i.minX(),o=i.maxX(),l=i.minY(),s=i.maxY(),c=i.minZ();if(o-a>0&&s-l>0){var d=m.createRectangleNode({width:o-a,height:s-l,fill:!0,material:t?N:T});d.setMatrix((new r.Matrix4).setPosition(new r.Vector3(a,l,c))),fe.levels[fe.levels.length-1].node.addChild(Ie(d))}}}function We(t,n,i){if(t.length){var a=new v({name:"EmptyNodes",ratio:1});a.setMatrix((new r.Matrix4).setPosition(new r.Vector3(i.max.x,(n.minY()+n.maxY())/2,i.min.z))),fe.levels[fe.levels.length-1].node.addChild(a);for(var l,s={},c={},d=t.length>3?(S=t.length,M=Math.sqrt(S),P=Math.floor(M),M-P<.5?P:P+1):1,u=t.length>3?function(e){return Math.ceil(Math.sqrt(e))}(t.length):t.length,h=118*(.5*d-1),g=0,p=0;p<d;++p){for(var x=0,f=0;f<u;++f){var C=t[g].node,b=!1;0===C.children.length?E(C)||(e.log("Inst or RepInst with no Ref or RepRef"),b=!0):1===C.children.length||E(C)?(D.isRepInstance(C)||D.is3DLeaf(C.children[0])||D.is3DLeaf(C))&&(b=!0):(e.log("Inst or RepInst with more than one Ref or RepRef"),b=!1);var y=m.createRectangleNode({width:154,height:118,fill:!0,material:b?N:T});y.setMatrix((new r.Matrix4).setPosition(new r.Vector3(x,h,0))),a.addChild(Ie(y,!1,"Node_"+t[g].id)),y.navigationAssociatedPath=t[g].pathElement,(l=Y[t[g].type])||(l=b?q:Z,s[t[g].type]||(s[t[g].type]=t[g].id),c[t[g].id]=t[g].type);var w=m.createRectangleNode({width:R,height:B,fill:!0,noEdge:!0,material:l});if(w.setMatrix((new r.Matrix4).setPosition(new r.Vector3(5,5,5))),x+=154,y.addChild(Ie(w,!0,"Texture_"+t[g].id)),w.navigationAssociatedPath=t[g].pathElement,++g>=t.length)break}if(h-=118,g>t.length)break}var A=Object.keys(s).map((function(e){return s[e]}));if(!A.length)return;o.fetch({enopad_webapis:require("DS/PADUtils/PADSettingsMgt").getSetting("enopad_webapis"),data:{intent:"explore_2D",select_file:["preview_url","thumbnail_2d"],select_predicate:["physicalid"]},pids:A,onComplete:function(e){var t=JSON.parse(e),n={};(t&&t.results||[]).forEach((function(e){if(e.attributes){for(var t,i,a=0,o=e.attributes.length;a<o&&(!t||!i);++a){var r=e.attributes[a];t||"ds6w:type"!==r.name?i||"preview_url"!==r.name&&"thumbnail_2d"!==r.name||(i=r.value):t=r.value}t&&i&&(n[t]=i)}})),a.getChildren().forEach((function(e){var t=e.getChildren();if(t&&t.length){var i,a,o=t[0].name.replace("Texture_","");c[o]&&(!(i=Y[c[o]])&&n[c[o]]&&(a=new r.ImageUtils.loadTexture(n[c[o]],void 0,(function(){Y[c[o]]?i=Y[c[o]]:Y[c[o]]=i=new r.MeshBasicMaterial({map:a,side:r.DoubleSide,force:!0,transparent:!0}),t[0].setMaterial(i)}),(function(){}),!0)),i&&t[0].setMaterial(i))}})),me.render()},onFailure:function(){}})}var S,M,P}function Oe(e,t){var n,i,a,o=null;return E(e)||D.is3DLeaf(e)?((o=t.clone()).addElement(e),i=D.getNodeID(e),a=D.getNodeType(e)):1===(n=e.getChildren()).length&&((o=t.clone()).addElement(e),o.addElement(n[0]),i=D.getNodeID(n[0]),a=D.getNodeType(n[0])),{id:i,node:e,pathElement:o,type:a}}function ze(e,t){return e.valueForSort<t.valueForSort?-1:e.valueForSort>t.valueForSort?1:0}function Fe(e,t){return e.valueForSort>t.valueForSort?-1:e.valueForSort<t.valueForSort?1:0}function _e(e,t){var n=new r.Box3;e.forEach((function(e){n.union(new r.Box3(e.box.min(),e.box.max()))})),e.delta=0,t.min.y>n.min.y&&(e.delta=t.min.y-n.min.y),t.max.y<n.max.y&&(e.delta=Math.min(e.delta,n.max.y-t.max.y))}function He(e,t){var n=new r.Box3;e.forEach((function(e){n.union(new r.Box3(e.box.min(),e.box.max()))})),e.delta=0,t.min.x>n.min.x&&(e.delta=t.min.x-n.min.x),t.max.x<n.max.x&&(e.delta=Math.min(e.delta,n.max.x-t.max.x))}function je(e,t,n,i,a){var o=(new r.Matrix4).setPosition((new r.Vector3).copy(i.dir).multiplyScalar(a));return n.box.applyMatrix4(o),n.worldMatrixTarget=n.worldMatrixSource.multiplyMatrices(o,n.worldMatrixSource),n.matrixTarget=(new r.Matrix4).multiplyMatrices(e,n.worldMatrixTarget),delete n.worldMatrixSource,n.centerRotation&&n.centerRotation.applyMatrix4(o),t.union(new r.Box3(n.box.min(),n.box.max())),t}function Xe(){var e=de.getFrameWindow();e&&e.removeReviewModel&&e.removeReviewModel()}function Ye(t){if(xe.forward(),de.getFrameWindow().getContextualUIManager().hideContextualMenus(),t.div!==fe.levels[fe.levels.length-1].button){for(var n,i,a,o,r=[],l=[],s=[],c=[];fe.levels.length;){var u,m=fe.levels.pop();if(m.button===t.div){fe.levels.push(m),j=m.path,ee&&ee.setCurrentPath(j);break}if(1===fe.levels.length)for(n=fe.levels[0].overridesMove.length-1;n>=0;--n)if(1!==(o=(a=fe.levels[0].overridesMove[n]).getPathes()).length&&e.log("More than one path in override, not expected"),o[0].isEqual(m.path)){u=a.getPosition();break}for(n=0,i=m.overridesMove?m.overridesMove.length:0;n<i;++n){a=m.overridesMove[n],r.push(a),1!==(o=a.getPathes()).length&&e.log("More than one path in override, not expected");var h=o[0].getLastElement(!0).getMatrix();u&&o[0].isEqual(m.path)&&(h=u,u=null),c.push({override:a,matrixSource:a.getPosition(),matrixTarget:h})}for(n=0;n<(m.overridesHide?m.overridesHide.length:0);++n)r.push(m.overridesHide[n]),l.push({override:m.overridesHide[n]});fe.mainDiv.removeBreadCrumb(m.button.idthumb),me.removeNode(m.node),Ce.push({path:m.path,pathReference:m.pathReference})}Xe(),xe.addAnimation({animationType:"unmask",objectListToAnimate:l,duration:1e3}),xe.addAnimation({animationType:"move",objectListToAnimate:c,duration:1e3,callBackFct:function(){d.deleteOverrides(r),d.deleteOverrides(s),me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0})}}),xe.startAnimation(),me.render({updateInfinitePlane:!0})}}function qe(e,t){j=e,ee&&ee.setCurrentPath(j);var n=me.getVisibleSpace(),i={button:fe.mainDiv.addHomeBreadCrumb({cb:Ye}),path:e};i.node=new u("Navigation_"+fe.levels.length),i.node.setVisibility(1===me.getVisibleSpace()),i.node.setVisibilityFree(!1),i.node.setVisibilityInTree(!1),me.addNode(i.node),fe.levels.push(i);var a,o,l,s,c,d=[],m=[],h=[],v=e.getLastElement(!0);fe.levels[fe.levels.length-1].overridesMove=d,v.getChildren().forEach((function(t){var i=e.clone();i.addElement(t);var u=Ve(i);if(-1!==u)if(o=i.getBoundingBox(null,me,"visibleSpace"),l=i.getBoundingBox(null,me,"invisibleSpace"),P(o)&&P(l))(0===u&&n||1===u&&!n)&&h.push(Oe(t,e));else if(!P(a=n?o:l)){a=new w(a);var v=e.clone();v.addElement(t);var g=v.getMatrix(),p=(new r.Matrix4).copy(g),x=v.getWorldMatrix();a.applyMatrix4(x);var f=a.center(),C=Be(a,null,!0);if(C&&(x=p=Le(f,C,x),(a=new w(i.getBoundingBox(null,me,n?"visibleSpace":"invisibleSpace"))).applyMatrix4(p),f=a.center()),s){var b=a.min(),y=new r.Vector3;y.x=f.x<c.x?s.min.x-Math.abs(f.x-b.x):s.max.x+Math.abs(f.x-b.x),y.y=c.y,y.z=s.min.z+(f.z-b.z);var D=(new r.Matrix4).setPosition(y.sub(f));a.applyMatrix4(D),p=(new r.Matrix4).copy(D).multiply(p),m.push({override:Ne(v,d),matrixSource:g,matrixTarget:p,box:a,node:t}),s.union(new r.Box3(a.min(),a.max()))}else c=(new r.Vector3).copy(f),s=new r.Box3(a.min(),a.max()),m.push({override:Ne(v,d),matrixSource:g,matrixTarget:p,box:a,node:t})}})),s||(s=new r.Box3(new r.Vector3,new r.Vector3)),!$&&t&&de.getFrameWindow().getViewpoint().reframe("iso",0),xe.addAnimation({animationType:"move",objectListToAnimate:m,duration:t?1e3:0,callBackFct:function(){t&&(me.render({updateInfinitePlane:!0}),$||Te())}}),xe.startAnimation(),We(h,new w(s),s),m.forEach(Ue)}function Ze(t,n,i,a){xe.forward();var o=[],l=[],s=t.getLastElement(!0),c=!1;if(E(s)&&!D.is3DLeaf(s)){c=!0;var d=ue.createReferenceIterator(D.getNodeID(s)),m=s.getChildren().map(D.getNodeID,D),v=d.getChildren().map((function(e){return-1===m.indexOf(e.getInstanceId())?e.getReferenceIterator().getReferenceId():null})).filter((function(e){return e&&-1===ge.indexOf(e.refID)}));v.length&&(ge=ge.concat(v),ue.lockNodes({ids:v})),s.children.forEach((function(e){var n=t.clone();n.addElement(e),-1!==Ve(n)&&o.push(n)}))}else if(M(s)){var g=t.clone();g.addElement(s.children[0]),Ze(g,n,i,a)}if(o.length||c){j=t,Xe(),ee&&ee.setCurrentPath(j),fe.levels&&fe.levels.length&&fe.levels[fe.levels.length-1].node&&me.removeNode(fe.levels[fe.levels.length-1].node);var p=[],x=j.externalPath.length>1?j.externalPath[j.externalPath.length-2]:null;M(x)&&1===x.parents.length?l=l.concat(j.getParentPath().getSiblingsPathes()):x&&x===pe&&(l=l.concat(j.getSiblingsPathes())),l.length&&xe.addAnimation({animationType:"mask",objectListToAnimate:[{override:Ne(l,p),duration:i?1e3:0}]});var f={path:j,node:new u("Navigation_"+fe.levels.length),overridesHide:p,pathReference:n};f.node.setVisibility(1===me.getVisibleSpace()),f.node.setVisibilityFree(!1),f.node.setVisibilityInTree(!1),fe.levels.push(f);var b=s.getChildren().every((function(t){var n=t.getChildren();return 0===n.length||(1!==n.length?(e.log("Instance or RepInstance with no or more than one Reference or RepReference"),!1):D.isPLMNode(n[0])?!!D.is3DLeaf(n[0]):(e.log("Navigation to a non PAD3DViewer node should not be possible"),!0))})),y=D.getNodeID(s),A=[y],S=D.getNodeID(j.externalPath[j.externalPath.length-2]);S&&A.push(S),f.button||(f.button=fe.mainDiv.addBreadCrumb({cb:Ye,lastBreadCrumb:b})),de.getController().getAttributes({ids:A,attributes:["ds6w:label"],callbacks:{onComplete:function(e){var t=e[y]?e[y]["ds6w:label"]:"";S&&e[S]&&e[S]["ds6w:label"]&&(t+=" ("+e[S]["ds6w:label"]+")"),fe.mainDiv&&fe.mainDiv.setLabel(f.button.idthumb,t)},onFailure:function(){}}}),o.length?function(t){var n,i,a=t.path.getWorldMatrix(),o=(new r.Matrix4).getInverse(a),l=me.getVisibleSpace(),s=t.pathReference?t.pathReference.getLastElement(!0):null,c=[];if(!s){var d=0;t.pathsToExplode.forEach((function(e){var n,i=e.getBoundingBox(null,me,"visibleSpace"),o=e.getBoundingBox(null,me,"invisibleSpace");P(i)&&P(o)||(P(i)?n=0:((i=new w(i)).applyMatrix4(a),n=(i.maxX()-i.minX())*(i.maxY()-i.minY())),n>d&&(d=n,t.pathReference=e,s=e.getLastElement(!0)))}))}if(!$&&t.applyViewpoint&&de.getFrameWindow().getViewpoint().reframe("iso",0),!t.pathReference){var u=fe.levels[fe.levels.length-2].node.getChildByName("EmptyNodes");t.pathsToExplode.forEach((function(e){c.push(Oe(e.getLastElement(!0),t.path))}));var m=(new r.Vector3).getPositionFromMatrix(u?u.getMatrix():a);return n=new w(i=new r.Box3(new r.Vector3(m.x-R,m.y-54,m.z),new r.Vector3(m.x,m.y+54,m.z))),xe.startAnimation(),We(c,n,i),t.startAnimation&&(me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0})),void(t.applyViewpoint&&Te())}var h=[];fe.levels[fe.levels.length-1].overridesMove=h;var v=t.pathReference.getMatrix(),g=(new r.Matrix4).multiplyMatrices(a,v);P(n=t.pathReference.getBoundingBox(null,me,l?"visibleSpace":"invisibleSpace"))&&(n=new r.Box3(new r.Vector3,new r.Vector3)),(n=new w(n)).applyMatrix4(g);var p=ke(n,g),x=Be(n,null,!1);if(x){var f={override:Ne(t.path,h),matrixSource:a,matrixRotation:x,centerRotation:p,matrixParentInv:(new r.Matrix4).getInverse(t.path.getParentPath().getWorldMatrix())};xe.addAnimation({animationType:"rotate",objectListToAnimate:[f],duration:t.startAnimation?500:0,callBackFct:function(){t.startAnimation&&me.render({updateInfinitePlane:!0})}}),a=Le(p,x,a),o=(new r.Matrix4).getInverse(a),g=(new r.Matrix4).multiplyMatrices(a,v),(n=new w(t.pathReference.getBoundingBox(null,me,l?"visibleSpace":"invisibleSpace"))).applyMatrix4(g),p=ke(n,g)}var C=n.minZ();if(!k){var b=t.path.getBoundingBox(null,me,l?"visibleSpace":"invisibleSpace");b&&(b.applyMatrix4(a),C=b.min.z)}var y={path:t.pathReference,override:Ne(t.pathReference,h),node:s,matrixSource:v,matrixTarget:v,worldMatrixTarget:g,box:n};y.vectorZMatrix=(new r.Matrix4).setPosition(new r.Vector3(0,0,C-n.minZ())),n.applyMatrix4(y.vectorZMatrix);var D=[y],A={min:[],max:[]},S={min:[],max:[]};A.min.dir=new r.Vector3(-1,0,0),A.max.dir=new r.Vector3(1,0,0),S.min.dir=new r.Vector3(0,-1,0),S.max.dir=new r.Vector3(0,1,0),t.pathsToExplode.forEach((function(e){if(!e.isEqual(t.pathReference)){var n=e.getBoundingBox(null,me,"visibleSpace"),i=e.getBoundingBox(null,me,"invisibleSpace");if(P(n)&&P(i))c.push(Oe(e.getLastElement(!0),t.path));else{var s=l?n:i;if(!P(s)){s=new w(s);var d={path:e,node:e.getLastElement(!0)};D.push(d),d.override=Ne(d.path,h),d.matrixSource=d.path.getMatrix();var u,m=(new r.Matrix4).multiplyMatrices(a,d.matrixSource),v=(new r.Matrix4).getInverse(m);s.applyMatrix4(m),d.worldMatrixSource=m.clone();var g=new r.Vector3;s.center(g),Math.abs(s.maxX()-s.minX())>Math.abs(s.maxY()-s.minY())?(d.valueForSort=g.y,g.y<p.y?S.min.push(d):S.max.push(d),u=(new r.Vector3).copy(A.max.dir)):(d.valueForSort=g.x,g.x<p.x?A.min.push(d):A.max.push(d),u=(new r.Vector3).copy(S.max.dir));var x=Be(s,u,!1);x&&(d.matrixRotation=x,d.centerRotation=g,d.matrixParent=a,d.matrixParentInv=o,m=Le(g,x,m),s.applyMatrix4(v),s.applyMatrix4(m),v.getInverse(m)),d.vectorZMatrix=(new r.Matrix4).setPosition(new r.Vector3(0,0,C-s.minZ())),s.applyMatrix4(d.vectorZMatrix),d.box=s}}}})),A.min.sort(Fe),A.max.sort(ze),S.min.sort(Fe),S.max.sort(ze);var E=0;E+=A.min.length?0:1,E+=A.max.length?0:1,E+=S.min.length?0:1,3===(E+=S.max.length?0:1)&&(A.min.length||A.max.length?p.x=A.min.length?A.min[0].box.maxX():A.max[0].box.minX():p.y=S.min.length?S.min[0].box.maxY():S.max[0].box.minY()),i=new r.Box3(new r.Vector3(n.minX(),n.minY(),n.minZ()),new r.Vector3(n.maxX(),n.maxY(),n.maxZ())),_e(A.min,i),_e(A.max,i),He(S.min,i),He(S.max,i);var M=[A.min,A.max,S.min,S.max];M.sort((function(e,t){return e.delta-t.delta})),M.forEach((function(e){e===A.min?A.min.forEach((function(e,t,n){i=je(o,i,e,n,-1*((i?i.min.x:p.x)-e.box.maxX()))})):e===A.max?A.max.forEach((function(e,t,n){i=je(o,i,e,n,(i?i.max.x:p.x)-e.box.minX())})):e===S.min?S.min.forEach((function(e,t,n){i=je(o,i,e,n,-1*((i?i.min.y:p.y)-e.box.maxY()))})):e===S.max&&S.max.forEach((function(e,t,n){i=je(o,i,e,n,(i?i.max.y:p.y)-e.box.minY())}))}));var T,N=[],V=[];D.forEach((function(t){t.matrixRotation&&(T=e.extend({},t),V.push(T),T.matrixSource=t.matrixTarget,T.worldMatrixTarget=Le(t.centerRotation,t.matrixRotation,t.worldMatrixTarget),t.centerRotation.applyMatrix4(o),T.matrixTarget=(new r.Matrix4).multiplyMatrices(o,T.worldMatrixTarget),t=T),T=e.extend({},t),N.push(T),T.matrixSource=t.matrixTarget,T.worldMatrixTarget.multiplyMatrices(t.vectorZMatrix,t.worldMatrixTarget),T.matrixTarget=(new r.Matrix4).multiplyMatrices(o,T.worldMatrixTarget)})),xe.addAnimation({animationType:"move",objectListToAnimate:D,duration:t.startAnimation?300:0,offsetTime:x?500:0}),xe.addAnimation({animationType:"rotate",objectListToAnimate:V,duration:t.startAnimation?400:0,offsetTime:x?800:300}),xe.addAnimation({animationType:"move",objectListToAnimate:N,duration:t.startAnimation?300:0,offsetTime:x?V.length?1200:800:V.length?700:300,callBackFct:function(){t.startAnimation&&(me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0})),t.applyViewpoint&&Te()}}),xe.startAnimation(),me.render({updateInfinitePlane:!0}),We(c,n,i),D.forEach(Ue)}({path:f.path,pathsToExplode:o,pathReference:f.pathReference,startAnimation:i,applyViewpoint:a}):function(e,t,n){!$&&n&&de.getFrameWindow().getViewpoint().reframe("iso",0);var i=new C({headLength:10,arrowLength:50,arrowWidth:2,head:C.types.ARROW});i.exludeFromBounding(!0),i.setVisibilityInTree(!1),i.setPickable(h.PICKTHROUGH);var a=fe.levels[fe.levels.length-2].node.getChildByName("EmptyNodes");a&&i.setMatrix(a.getMatrix()),fe.levels[fe.levels.length-1].node.addChild(i),xe.axisSystemVisibility({objectListToAnimate:[i],visibility:!0,pickability:!1,callBackFct:function(){me.addNode(fe.levels[fe.levels.length-1].node),$||Te()}}),xe.startAnimation()}()}}function Ge(e){var t=e.gesture?e.gesture.getEvents()[0]:e.from[0],n=me.pick(me.getMousePosition(t.getCurrentPosition(me.canvas)),"mesh",!1);if(n.path&&n.path.length&&j){var i=n.path[0].getLastElement(!0);i.navigationAssociatedPath&&(n.path[0]=i.navigationAssociatedPath);var a=j.clone();if(n.path[0].externalPath.length>a.externalPath.length){a.addElement(n.path[0].externalPath[a.externalPath.length]);var o,r=M(a.externalPath[a.externalPath.length-1])?[0,1]:[0];n.path[0].externalPath.length>=a.externalPath.length+r.length&&(o=a.clone(),r.forEach((function(e){o.addElement(n.path[0].externalPath[a.externalPath.length+e])}))),s.empty(),c.empty(),Ce=[],Ze(a,o,!0,!1)}}}function Ke(e){if("ArrowLeft"===e.key||37===e.keyCode||"ArrowUp"===e.key||38===e.keyCode)fe.levels.length>1&&(document.removeEventListener("keydown",Ke),fe.mainDiv.activate(fe.levels[fe.levels.length-2].button.idthumb),document.addEventListener("keydown",Ke));else if(("ArrowRight"===e.key||39===e.keyCode||"ArrowDown"===e.key||40===e.keyCode)&&Ce.length>0){var t=Ce.pop();document.removeEventListener("keydown",Ke),Ze(t.path,t.pathReference,!0,!1),document.addEventListener("keydown",Ke)}}function Je(){!te&&(te=D.getRoots(de).map(D.getNodeID,D).some(ue.isLargeDataStructure,ue))&&(de.freezeProgressiveLoading?de.freezeProgressiveLoading():ue.pauseProgressiveLoading())}function Qe(){te&&(de.unfreezeProgressiveLoading?de.unfreezeProgressiveLoading():ue.resumeProgressiveLoading()),te=!1}var $e,et=function(e,t){var n,i,a,o,r,l;if(t===be[0]?Je():t===be[1]&&(Qe(),Je()),t===be[2]){for($e=!0,fe.levels.forEach((function(e){me.removeNode(e.node),e.node=null})),i=fe.levels.length-1;i>0;--i)fe.mainDiv.removeBreadCrumb(i-1);return ge.length&&ue.unlockNodes({ids:ge}),void(ge=[])}if($e&&t===be[3]){$e=!1;var s=de.getController();fe.levels.forEach((function(e,t,i){if(0!==t){var l=e.path,c=i[t-1].path.clone();for(a=c.externalPath.length,o=l.externalPath.length;a<o&&(n=D.getNodeID(l.externalPath[a]),r=s.getNode({id:n}));++a)c.addElement(r);var d=e.pathReference,u=d?c.clone():void 0;if(u)for(a=u.externalPath.length,o=d.externalPath.length;a<o&&(n=D.getNodeID(d.externalPath[a]),r=s.getNode({id:n}));++a)u.addElement(r);e.path=c,e.pathReference=u}}))}if(!$e){xe.forward(),he.removeSceneGraphOverrideSet(d),d=null,fe.mainDiv.destroy(),K=[],fe.levels.forEach((function(e){me.removeNode(e.node),e.node=null,K.push({path:e.path,pathReference:e.pathReference})})),fe.mainDiv=new g({parentFrame:de.getFrameWindow().getUIFrame()}),fe.levels=[],d=new b(de.getRootBagPath().externalPath[0]),he.pushSceneGraphOverrideSet(d);var c,u=K;for((t===be[0]&&(c=D.getRoots(de))&&1===c.length&&!D.is3DLeaf(c[0])&&(1===u.length||u.length>1&&!S(u[1].path))||t===be[1]&&u.length>1&&!S(u[1].path)&&(c=D.getRoots(de))&&1===c.length&&!D.is3DLeaf(c[0]))&&((l=u[0].path.clone()).addElement(c[0]),u.length=1,u.push({path:l})),ee&&ee.setCurrentPath(j=null),i=0;i<u.length;++i)if(0===i)qe(u[i].path,u.length-1===i);else{if(!S(l=u[i].path)||-1===Ve(l)){xe.startAnimation(),me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0});break}Ze(l,u[i].pathReference,u.length-1===i,!1)}xe.forward()}};function tt(){de.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,t){var n=c.get();if(0!==n.length){var i=D.getRoots(de),a=[],o=!1,l=n.some((function(e){var t=e.pathElement.getLastElement(!0);return i.some((function(n){var i=n!==t,a=e.pathElement.externalPath.some((function(e){return n===e}));return!o&&a&&(o=!0),i&&a}))}));if(o&&t&&t.withContextMenu&&"number"==typeof t.XmousePosition&&"number"==typeof t.YmousePosition)0===me.pick(me.getMousePosition(new r.Vector2(t.XmousePosition,t.YmousePosition)),"mesh",!1).path.length&&(l=o=!1);return l&&p.getExamineController({context:de}).canBeEnabled()&&a.push({name:"CATC3DNavigationExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"],type:"handler",identifier:"CAT3DComposeExamineSelectionHdr"}),k||!o||1!==n.length||D.is3DLeaf(n[0].pathElement.getLastElement(!0))||a.push({name:"CATC3DNavigationOnChildStr",line:1,hdr_list:["CATC3DNavigationOnChildHdr"],type:"handler",identifier:"CATC3DNavigationOnChildHdr"}),de.getExecutionContext?a.length?{WAfrCtxBarRow1:{model:a}}:void 0:a.length?{cmdList:a}:void 0}},context:de.getCommandContext?de.getCommandContext():null,workbenchName:"CATC3DNavigation",module:"CATC3DNavigation",cmdPrefix:"",merge:!0,subscriberId:"CATC3DNavigation_"+ ++V})}this.start=function(){ve=!0,Je(),(Q=new A).store(de.getFrameWindow().getViewpoint()),X=me.backgroundColor,G(),ne=de.isRobotVisible(),de.setRobotVisibility(!1),de.setDefaultContextualBarVisibility(!1),H=me.picking.primitive,y=me.pPicking.primitive,me.setPrePicking({primitive:0}),me.setPicking({primitive:0}),ie=l.onPreAdd(we),ae=s.onPreAdd(Ae),oe=s.onRemove(Ee),re=c.onPreAdd(Se),J=x.getTooltipManager({context:de}),le=J.register({onTooltipReady:Pe,filterPath:Me}),be.push(de.subscribe({event:"onLoadingComplete"},et)),be.push(de.subscribe({event:"onEndRootRemoved"},et)),be.push(de.subscribe({event:"onRefreshBegin"},et)),be.push(de.subscribe({event:"onEndProgressiveLoad"},et)),be.push(de.subscribe({event:"onRootDetached"},et)),be.push(de.subscribe({event:"onRootAttached"},et)),be.push(de.subscribe({event:"onAuthoringTransactionEnd"},et)),be.push(de.subscribe({event:"onShow"},et)),be.push(de.subscribe({event:"onHide"},et)),be.push(de.subscribe({event:"onEndDelete"},et)),be.push(de.subscribe({event:"onEndMatriceUpdate"},et)),ce=me.onSwapVisibleSpace?me.onSwapVisibleSpace(et):null,(ee=f.getDropManager({context:de})).connect(),se=ee.subscribe({event:"onEndInsertDrop3D"},et),d=new b(de.getRootBagPath().externalPath[0]),he.pushSceneGraphOverrideSet(d),n.addEvent(me.canvas,"onLeftDoubleClick",Ge),n.addEvent(me.canvas,"onDoubleTap",Ge),fe.mainDiv=new g({parentFrame:de.getFrameWindow().getUIFrame()}),fe.levels=[];var e,t=[];if(j&&S(j)&&K&&0!==K.length)t=K;else{t.push({path:de.getRootBagPath()});var i=D.getRoots(de);1!==i.length||D.is3DLeaf(i[0])||((e=t[0].path.clone()).addElement(i[0]),t.push({path:e})),$=null}j=null,ee&&ee.setCurrentPath(j);for(var a=0;a<t.length;++a)if(0===a)qe(t[a].path,t.length-1===a);else{if(!S(e=t[a].path)||-1===Ve(e)){xe.startAnimation(),me.addNode(fe.levels[fe.levels.length-1].node),me.render({updateInfinitePlane:!0}),Te();break}Ze(e,t[a].pathReference,t.length-1===a,t.length-1===a)}document.addEventListener("keydown",Ke),tt()},this.end=function(){ve=!1,xe.stop(),de.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+V),document.removeEventListener("keydown",Ke),Xe(),de.setRobotVisibility(ne),de.setDefaultContextualBarVisibility(!1),me.setPicking({primitive:H}),me.setPrePicking({primitive:y}),ee.disconnect(),ee.unsubscribe(se),l.unsubscribe(ie),s.unsubscribe(ae),c.unsubscribe(re),s.unsubscribe(oe),J.unregister(le),x.unreferenceTooltipManager({context:de}),ie=ae=re=oe=le=ee=se=null;for(var e=s.get(),t=e.length-1;t>=0;--t){var i=e[t];i&&i.pathElement.externalPath[0]!==pe&&i.pathElement.getLastElement(!0).navigationAssociatedPath&&(s.remove(i),i.pathElement=i.pathElement.getLastElement(!0).navigationAssociatedPath.clone(),s.isIn(i)||s.add(i))}ge.length&&ue.unlockNodes({ids:ge}),ge=[],be.forEach((function(e){de.unsubscribe(e)})),be=[],me.unsubscribe(ce),ce=null;var a=de.getFrameWindow().getViewpoint();$&&$.store(a,S(j)?j.getWorldMatrix():null),Q.restore(a),he.removeSceneGraphOverrideSet(d),d=null,n.removeEvent(me.canvas,"onLeftDoubleClick",Ge),n.removeEvent(me.canvas,"onDoubleTap",Ge),fe.mainDiv.destroy(),K=[],fe.levels.forEach((function(e){me.removeNode(e.node),K.push({path:e.path,pathReference:e.pathReference})})),fe={},Ce=[],Qe(),me.render({updateInfinitePlane:!0})},this.pause=function(){ie&&ve&&(document.removeEventListener("keydown",Ke),me.setPicking({primitive:H}),me.setPrePicking({primitive:y}),l.unsubscribe(ie),ie=void 0,s.unsubscribe(ae),ae=void 0,s.unsubscribe(oe),oe=void 0,c.unsubscribe(re),re=void 0,J.unregister(le),le=void 0,n.removeEvent(me.canvas,"onLeftDoubleClick",Ge),n.removeEvent(me.canvas,"onDoubleTap",Ge),de.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+V),fe.mainDiv.hide(),fe.levels[fe.levels.length-1].node&&me.removeNode(fe.levels[fe.levels.length-1].node))},this.resume=function(){!ie&&ve&&(H=me.picking.primitive,y=me.pPicking.primitive,me.setPrePicking({primitive:0}),me.setPicking({primitive:0}),ie=l.onPreAdd(we),ae=s.onPreAdd(Ae),oe=s.onRemove(Ee),re=c.onPreAdd(Se),le=J.register({onTooltipReady:Pe,filterPath:Me}),n.addEvent(me.canvas,"onLeftDoubleClick",Ge),n.addEvent(me.canvas,"onDoubleTap",Ge),document.addEventListener("keydown",Ke),tt(),fe.mainDiv.show(),fe.levels[fe.levels.length-1].node&&me.addNode(fe.levels[fe.levels.length-1].node))},this.navigateOnChild=function(e){var t=e&&e.pathToExplode?e.pathToExplode:null;[1,2].some((function(){return(t=t?t.getParentPath():null)?t.isEqual(j):null}))&&(s.empty(),c.empty(),Ce=[],Ze(e.pathToExplode,null,!0,!1))}}})})),define("DS/CATC3DNavigation/CATC3DNavigationStartCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUCommandsManager","DS/CATC3DNavigation/CATD3CBoxNavigation","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],(function(t,n,i,a,o){var r=t.extend({init:function(t){var r=this;this._parent(t,{mode:"exclusive",isAsynchronous:!1}),this.beginExecute=function(){var t=e.getNavigationObject({context:n.get()}),o=this._ctx;t.onExit&&t.onExit.actionBar&&t.onExit.actionBar.length&&t.onStart&&t.onStart.onStart&&(t.done=function(){if(delete t.done,n.get().getExecutionContext){t.activated=!0,t.controller||(t.controller=new a({context:t.context})),t.controller.start(),n.get().getExecutionContext().switchApp("CATC3D_AP","C3DSelection_AP").then((()=>{r.done()}))}else{var e=t.context.subscribe({event:"onActionBarReady"},(function(){t.context.unsubscribe(e),i.setDefaultCommand({ID:"CATD3CNavigationDefaultHdr",className:"DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",context:o}),t.activated=!0,t.controller||(t.controller=new a({context:t.context})),t.controller.start()}));t.context.loadActionBar({merge:!1,file:"CATC3DNavigation.xml",module:"CATC3DNavigation"})}},t.onStart.onStart(t)),require(["DS/CAT3DComposeUtils/CATC3DUtils"],(function(e){e._sendUsageProbe("command","StructureMode")}))};var l=n.get(),s=l.subscribe({event:"onRootAdded"},(function(){1===o.getRoots(l).length&&r.enable()})),c=l.subscribe({event:"onEndRootRemoved"},(function(){0===o.getRoots(l).length&&r.disable()}));0===o.getRoots(l).length&&this.disable(),this.cancelExecute=function(){this.done&&this.done()},this._destroy=function(){l.unsubscribe(s),s=null,l.unsubscribe(c),c=null,Object.getPrototypeOf(this)._destroy.apply(this,arguments),r=null}}});return r}));var t=function(e,t,n){["_commands","_cmdCheckHeader"].forEach((function(i){var a=n?e[i][n]:e[i];a[t]&&(a[t]._destroy&&a[t]._destroy(),delete a[t])}))};define("DS/CATC3DNavigation/CATC3DNavigationEndCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUCommandsManager"],(function(n,i,a){var o,r="CATC3DNavigation";return r+=require("DS/CAT3DComposeUI/CAT3DComposeWidgetOptions").getOption("authoring3d")?"Next":"",require(["text!DS/CATC3DNavigation/assets/afr/"+r+".xml"],(function(e){o=e})),n.extend({init:function(n){let r=this;this._parent(n,{mode:"exclusive",isAsynchronous:!1}),this.beginExecute=function(){var n=e.getNavigationObject({context:i.get()});if(n.activated=!1,n.controller&&n.controller.end(),i.get().getExecutionContext){i.get().getExecutionContext().switchApp("CATC3D_AP","CATC3D_AP").then((()=>{n.onExit.actionBar[0]&&n.onExit.actionBar[0].onActionBarReady&&n.onExit.actionBar[0].onActionBarReady(),r.done()}))}else{var l={lastCommand:[],currentCommand:null,defaultCommand:null};this._ctx?a._commandsState[this._ctx]=l:a._commandsState=l,a.resetDefaultCommand(this._ctx),t(a,"CATD3CNavigationDefaultHdr",this._ctx);for(var s=(new DOMParser).parseFromString(o,"text/xml").getElementsByTagName("CATCommandHeader"),c=s.length-1;c>=0;--c){var d=s[c].attributes.getNamedItem("ClassName").value;if(!d.startsWith("DS/ViewerCommands")&&!d.startsWith("DS/ENOPAD3DViewer")&&!d.startsWith("DS/PADUtils")){var u=s[c].attributes.getNamedItem("ID").value;"CAT3DComposeExamineSelectionHdr"!==u&&t(a,u,this._ctx)}}var m=0,h=n.context.subscribe({event:"onActionBarReady"},(function(){n.onExit.actionBar[m-1].onActionBarReady&&n.onExit.actionBar[m-1].onActionBarReady(),m<n.onExit.actionBar.length?(n.context.loadActionBar({merge:!0,file:n.onExit.actionBar[m].file,module:n.onExit.actionBar[m].module}),m++):n.context.unsubscribe(h)}));n.context.loadActionBar({merge:!1,file:n.onExit.actionBar[0].file,module:n.onExit.actionBar[0].module}),m++}},this.cancelExecute=function(){this.done&&this.done()}}})})),define("DS/CATC3DNavigation/CATC3DNavigationOnChildCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/Selection/CSOManager"],(function(t,n,i){return t.extend({init:function(t){this._parent(t,{mode:"exclusive",isAsynchronous:!1}),this.beginExecute=function(){var t=n.get(),a=i.get(),o=1===a.length?a[0].pathElement:null,r=o?e.giveNavigationObject({context:t}):null;t.getFrameWindow().getContextualUIManager().hideContextualMenus(),r&&setTimeout((function(){r.controller.navigateOnChild({pathToExplode:o})}),0),this.done&&this.done()}}})})),define("DS/CATC3DNavigation/CATC3DNavigationContoller",["UWA/Class"],(function(t){return t.singleton({init:function(){},getNavigationContoller:function(t){return e.getNavigationObject({context:t.context}).controller},isNavigationActivated:function(t){var n=e.giveNavigationObject({context:t.context});return!!n&&n.activated},onNavigationStart:function(t){var n=e.getNavigationObject({context:t.context});n.activated||(n.onStart=t.start)},onNavigationExit:function(t){var n=e.getNavigationObject({context:t.context});n.activated||(n.onExit=t.exit)}})}))}(),define("DS/CATC3DNavigation/CATBreadCrumbs",["UWA/Core","UWA/Class","DS/CoreEvents/Events","css!DS/CATC3DNavigation/CATC3DNavigation.css"],(function(e,t,n){"use strict";return t.extend({init:function(t){var i,a,o,r,l=[],s=t.parentFrame,c=null,d=function(){for(var e=0;e<l.length;e++)l[e].div.removeClassName("first-crumb"),l[e].div.removeClassName("crumbs-with-home"),l[e].div.removeClassName("last-crumb"),0===e&&(l[e].div.addClassName("first-crumb"),a&&l[e].div.addClassName("crumbs-with-home")),l[e].lastBreadCrumb&&l[e].div.addClassName("last-crumb"),l[e].div.setStyle("z-index",1e4-e);a&&(a.div.setStyle("z-index",10001),l.length?(a.div.setStyle("border-top-right-radius","0px"),a.div.setStyle("border-bottom-right-radius","0px")):(a.div.setStyle("border-top-right-radius","5px"),a.div.setStyle("border-bottom-right-radius","5px")))},u=function(e){var t=null,n=e.changedTouches[0].clientX,a=e.changedTouches[0].clientY,o=i.getPosition();return i.getChildren().some((function(e){var i=e.getPosition(),r=e.getDimensions(),s=i.x+o.x,c=s+r.width,d=i.y+o.y,u=d+r.height;return"number"==typeof e.idthumb&&e.idthumb<l.length-1&&(c+=16),s<=n&&n<=c&&d<=a&&a<=u&&(t=e,!0)})),t},m=function(e){e&&o===e&&e.addClassName("navigationBreadCrumbActivated"),e&&"Home"!==e.idthumb&&!c&&(c=setTimeout((function(){e.querySelector("p").addClassName("navigationBreadCrumbExpand"),c=null}),1e3))},h=function(e){e&&e.removeClassName("navigationBreadCrumbActivated"),e&&"Home"!==e.idthumb&&(c?(clearTimeout(c),c=null):o&&o===e||e.querySelector("p").removeClassName("navigationBreadCrumbExpand"))},v=function(e){o&&e&&o===e.div&&(o.removeClassName("navigationBreadCrumbActivated"),e.cb()),o=null},g=function(e){1===e.touches.length&&(e.preventDefault(),e.stopPropagation(),m(o=r=u(e)))},p=function(e){if(1===e.touches.length){e.preventDefault(),e.stopPropagation();var t=u(e);t!==r&&(h(r),m(t),r=t)}},x=function(e){e.preventDefault(),e.stopPropagation();var t=u(e);v(t?"Home"===t.idthumb?a:l[t.idthumb]:null),h(t)},f=function(e){var t=e.target.idthumb;m("Home"===t?a.div:l[t].div)},C=function(e){var t=e.target.idthumb;h("Home"===t?a.div:l[t].div)},b=function(e){if(0===e.button&&1===e.buttons){var t=e.target.idthumb;m(o="Home"===t?a.div:l[t].div);var i=n.subscribe({event:"/VISU/onLeftMouseUp"},(function(e){n.unsubscribe(i),i=void 0,("Home"===(t=e.from[0].event.target.idthumb)?a.div:"number"==typeof t?l[t].div:null)!==o&&(o.querySelector("p").removeClassName("navigationBreadCrumbExpand"),o=null)}))}},y=function(e){if(o&&0===e.button&&0===e.buttons){var t=e.target.idthumb;v("Home"===t?a:l[t])}};function D(){i||(i=e.createElement("ul",{class:"navigationBreadCrumb"}).inject(s))}function w(){i&&(0!==l.length||a?d():(i.destroy(),i=null))}function A(e,t){i&&(l[e].div.setStyle("opacity","0"),l[e].div.setStyle("right","25px"),l[e].div.removeEvents(),i.removeChild(l[e].div),l.splice(e,1)),t&&w()}this.activate=function(e){i&&("Home"!==e?l[e].cb():a.cb())},this.addHomeBreadCrumb=function(t){if(t&&!a)return D(),(a={}).div=e.createElement("li",{class:"navigationBreadCrumb homeBreadCrumb"}),e.createElement("span",{class:"homeBreadCrumb fonticon fonticon-home"}).inject(a.div).idthumb="Home",0===l.length?i.appendChild(a.div):i.insertBefore(a.div,l[0].div),a.cb=function(){return t.cb?t.cb({div:a.div}):void 0},a.div.setStyle("opacity","1"),a.div.setStyle("right","0px"),a.div.idthumb="Home",a.div.addEvents({mousedown:b,mouseup:y,mouseenter:f,mouseleave:C}),a.div.addEvents({touchstart:g,touchmove:p,touchend:x}),d(),a.div},this.removeHomeBreadCrumb=function(){i&&a&&(a.div.removeEvents(),i.removeChild(a.div),a=null),w()},this.addBreadCrumb=function(t){D();var n=e.createElement("li",{class:"navigationBreadCrumb"}).inject(i);n.idthumb=l.length;var a=e.createElement("p").inject(n);return a.idthumb=l.length,a.innerHTML=e.is(t.label)&&e.is(t.label,"string")?t.label:"",e.createElement("span").inject(n).idthumb=l.length,l.push({div:n,cb:function(){return t.cb?t.cb({div:n}):void 0},lastBreadCrumb:t.lastBreadCrumb}),n.addEvents({mousedown:b,mouseup:y,mouseenter:f,mouseleave:C}),n.addEvents({touchstart:g,touchmove:p,touchend:x}),d(),setTimeout((function(){n.setStyle("opacity","1"),n.setStyle("right","0px")}),10),n},this.removeBreadCrumb=function(e){A(e,!0)},this.setLabel=function(e,t){i&&"Home"!==e&&e<l.length&&(l[e].div.querySelector("p").innerHTML=t)},this.destroy=function(){for(var e=l.length-1;e>=0;e--)A(e,!1);this.removeHomeBreadCrumb()},this.show=function(){i&&i.show()},this.hide=function(){i&&i.hide()}}})})),define("DS/CATC3DNavigation/CATC3DNavigationDefaultCmdV2",["DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext","DS/CATC3DNavigation/CATC3DNavigationContoller","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i){"use strict";return class{constructor(){var a=t.get(),o=n.getNavigationContoller({context:a}),r=i.getExamineController({context:a});this.beginExecute=function(){var t=e.giveDataLauncherController({context:a});t&&t.setActiveState(!0),r&&r.setActiveState(!0),o&&o.resume()},this.destroy=function(){var t=e.giveDataLauncherController({context:a});t&&t.setActiveState(!1),r&&r.setActiveState(!1),o&&o.pause()},this.pauseExecute=function(){var t=e.giveDataLauncherController({context:a});t&&t.setActiveState(!1),r&&r.setActiveState(!1),o&&o.pause(),this.done()},this.resumeExecute=function(){var t=e.giveDataLauncherController({context:a});t&&t.setActiveState(!0),r&&r.setActiveState(!0),o&&o.resume(),this.done()}}}})),define("DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext","DS/CATC3DNavigation/CATC3DNavigationContoller","DS/CATC3DNavigation/CAT3DComposeExamineController"],(function(e,t,n,i,a){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var o=n.get(),r=i.getNavigationContoller({context:o}),l=a.getExamineController({context:o});this.beginExecute=function(){var e=t.giveDataLauncherController({context:o});e&&e.setActiveState(!0),l&&l.setActiveState(!0),r&&r.resume(),this.done()},this.endExecute=function(){var e=t.giveDataLauncherController({context:o});e&&e.setActiveState(!1),l&&l.setActiveState(!1),r&&r.pause()},this.pauseExecute=function(){var e=t.giveDataLauncherController({context:o});e&&e.setActiveState(!1),l&&l.setActiveState(!1),r&&r.pause(),this.done()},this.resumeExecute=function(){var e=t.giveDataLauncherController({context:o});e&&e.setActiveState(!0),l&&l.setActiveState(!0),r&&r.resume(),this.done()}}})}));