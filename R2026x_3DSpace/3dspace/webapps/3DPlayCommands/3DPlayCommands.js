/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/3DPlayCommands/CmdENOPADStream",["DS/3DPlayWAFRMigration/WAFR2Utils","DS/3DPlayWAFRMigration/Command","DS/WebUtils/Tracker"],(function(e,t,i){"use strict";return function(t,n){var o={init:function(e){this.visuOptions=n||{needCGR:!0},this._parent&&this._parent(e)},testStream:function(t){var n;if(e.isAFR2())n=e.getExperience();else{n=this.getFrameWindow().experience}if(!n)throw"No Experience";var o=this,a=function(){o._isAsynchronous||(o.end(),o=void 0)};n.checkReloadNeeded(this.visuOptions,{onConfirm:function(){i.command(o.getId()),t.apply(o),a()},onCancel:a})}};return o[t]=function(){this.testStream(this._parent)},o}}));var cmd="DS/DMUMeasure/DMUCreateMeasureCmd";define("DS/3DPlayCommands/Proxy/CmdMeasureProxy",[cmd,"DS/WebUtils/Tracker"],(function(e,t){"use strict";return e.extend({init:function(e){let t=[{ID:"3dAuthoring",Value:"3dAuthoring",Mode:"In"},{ID:"RemoveNonPersistent",Value:"false",Mode:"In"}];e.args?t.forEach((i=>{e.args[i.ID]=t[i.Value]})):e.arguments=t,this._parent(e)},execute:function(){t.command(this.getId()),this._parent.apply(this,arguments)},hasActiveMeasures:function(){var e=this.getMeasureContainer?this.getMeasureContainer():null;return e&&e.getDMUObjects("DMUMeasure")&&e.getDMUObjects("DMUMeasure").length}})})),define("DS/3DPlayCommands/Proxy/VisuShadingMaterialEdgesCmdProxy",["DS/ViewerCommands/VisuShadingMaterialEdgesCmd","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t){"use strict";return e.extend(t("beginExecute",{needCGR:!0,needMaterial:!0}))}));cmd="DS/DMUSection/DMUCreateSectionCmd";define("DS/3DPlayCommands/Proxy/CmdSectionProxy",[cmd,"DS/WebUtils/Tracker"],(function(e,t){"use strict";return e.extend({init:function(e){e.args?e.args["3dPlay"]="3dPlay":e.arguments=[{ID:"3dPlay",Value:"3dPlay",Mode:"In"}],this._parent(e)},execute:function(){t.command(this.getId()),this._parent.apply(this,arguments)}})})),define("DS/3DPlayCommands/ExplodeServices",["DS/VisuEvents/EventsManager"],(function(e){"use strict";return{onSpreadLaunchToken:void 0,init:function(e,t){this.xp=e,this.viewer=t,this.running=!0},isExplodeAvailable:function(){var e=0;return this.xp.getRootBag().children.forEach((function(t){"annotGroupNode"!==t.name&&t.traverse((function(t){return 0==t.children.length&&e++,e>1}))})),e>1},pauseSpread:function(e){this.running=!e},listenToSpread:function(t){this.onSpreadLaunchToken||(this.onSpreadLaunchToken=e.addEvent(this.viewer.canvas,"onSpread",function(){this.running&&(this.launchedFromSpread=!0,t())}.bind(this)))},unsubscribeFromSpread:function(){this.onSpreadLaunchToken&&(e.removeEventFromToken(this.onSpreadLaunchToken),this.onSpreadLaunchToken=null)},registerExplodeCollab:function(e){this.xp.registerCollabAction("explodeBeginExecute",e)}}})),define("DS/3DPlayCommands/Proxy/VisuOrthographicViewCmdProxy",["DS/ViewerCommands/VisuOrthographicViewCmd","DS/WebUtils/Tracker"],(function(e,t){"use strict";return e.extend({beginExecute:function(){t.command(this.getId()),this._parent.apply(this,arguments)}})})),define("DS/3DPlayCommands/CmdShareBase",["DS/3DPlayWAFRMigration/Command","DS/WebUtils/Tracker"],(function(e,t){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!1,mode:"shared"}),this.enable()},beginExecute:function(){t.command(this.getId());var e=this.getFrameWindow().experience;e&&this.shareWithPanelManager&&this.shareWithPanelManager(e.PanelManager),this.AFR2_Done()}})})),define("DS/3DPlayCommands/CmdRightSidePanel",["UWA/Core","DS/3DPlayWAFRMigration/CommandCheckHeader","UWA/Promise","DS/PADUtils/PADUtilsServices","i18n!DS/PADUtils/assets/nls/PADUtils.json","i18n!DS/3DPlayCommands/assets/nls/3DPlayCommands","DS/WebUtils/Tracker"],(function(e,t,i,n,o,a,r){"use strict";var s,l,d,c,h,u=function(t){if(t=parseInt(t,10),e.is(t,"number")){var i=t,n=0,o=[];for(o[0]="b",o[1]="Kb",o[2]="Mb",o[3]="Gb",o[4]="Tb",o[5]="Pb",o[6]="Eb",o[7]="Zb",o[8]="Yb";i>1;)t=i,i/=1024,n++;return t!==i&&(n-=1),Math.round(t)+" "+o[n]}return""},p=function(e,t){if(!e)throw new Error("Missing input");var i=new Date(e),n=i.toLocaleString(widget.lang,{year:"numeric",month:"short",day:"2-digit"}),o=i.toLocaleString(widget.lang,{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1});return t?n:n+" - "+o};return t.extend({_promises:[],_propertiesWdg:null,_readOnly:!0,init:function(e){this._parent(e,{}),h=this;var t=this.getFrameWindow();t&&t.experience&&t.experience.EventDisposer.add(t.experience.subscribe("ASSET/CHANGE",(function(){!0===h.getState()&&h.setState(!1)}))),this._buildView(),require(["DS/PADServices/utils/GlobalModelEvents"],(function(e){e.subscribe({event:"ENXViews/Triptych/onOverlayClick"},(function(e){e&&"right"===e&&!0===h.getState()&&(h.toggleState(),h.getTriptych().togglePanel("right"))}))})),t&&t.experience&&(this.token=t.experience.subscribe("3DPLAY/EXP/3DPLAY3DCOMMENT",(function(e){0==h.getState()?(h.data=e.data,h.setState(!0)):h._propertiesWdg&&h._propertiesWdg.addAnnotationData({screenshot:e.data.screenshot,annotation:e.data.annotation})})))},_IsProvider3DSpace:function(){return"3DSpace"===this.getFrameWindow().experience.getInformationsOnAsset().provider},_selectionChange:function(e){i.all(this._promises).then((function(){h._promises.push(new i((function(t){var i=[],n=h.getFrameWindow().experience.getInformationsOnAsset();if(h._IsProvider3DSpace())h.forEachPropFacet((function(t){t.visible&&"social"==t.facet.name&&(e=void 0)})),e&&e.length||(e=[{}]),e.forEach((function(e){"function"!=typeof e.getID&&(e.getID=function(){return h.getID(this)}),"function"!=typeof e.getRelationID&&(e.getRelationID=function(){return h.getRelationID(this)}),void 0===e.type&&(e.options&&e.options.type?e.type=e.options.type:e.type=h.getType(e)),e.tenant=n.tenant;var t=s.getModelFromSelectedNode(e);t&&i.push(t)}));else{var o={"3DDRIVE":"3DDrive","3DSWYM":"3DSwym",socialmedia:"3DSwym",FILE:"Desktop File"}[n.provider],r=new l({metatype:"businessobject",objectId:n.id,source:o,tenant:n.tenant,"3DSwymServerToken":n.swymServerToken});r.set("isTransient",!0);for(var c={},m=function(e){var t=[];if("3DSWYM"==e.provider||"socialmedia"==e.provider){var i=e.swymAttr,n=i.author,o=n.first_name+" "+n.last_name,r=(f=i.crdate).split(" ")[0],s=(S=i.update).split(" ")[0],l=i.size;l=u(l);var d=i.media_type,c=i.title;t=[{id:"1",title:a.type,value:d},{id:"2",title:a.title,value:c},{id:"3",title:a.crDate,value:r},{id:"4",title:a.modDate,value:s},{id:"5",title:a.owner,value:o},{id:"6",title:a.size,value:l}]}else if("3DDRIVE"==e.provider){var h=e.driveAttr,m=(d="File",1);t.push({id:m,title:a.type,value:d}),m++;var g=h.extension;g=g.toUpperCase(),t.push({id:m,title:a.flType,value:g}),m++,c=h.title,t.push({id:m,title:a.title,value:c}),m++;var f=h.created;f=parseInt(f),f=p(f*=1e3,!0),t.push({id:m,title:a.crDate,value:f}),m++;var S=h.modified;S=parseInt(S),S=p(S*=1e3,!0),t.push({id:m,title:a.modDate,value:S}),m++,t.push({id:m,title:a.owner,value:h.fullnameowner}),m++,t.push({id:m,title:a.creator,value:h.originator}),m++,l=h.size,l=u(l),t.push({id:m,title:a.size,value:l}),m++,t.push({id:m,title:a.description,value:h.description}),m++}else if("FILE"==e.provider){t.push({id:1,title:a.type,value:a.LocalFileTitle}),t.push({id:2,title:a.flType,value:e.type.toUpperCase()}),t.push({id:3,title:a.title,value:e.fileAttr.name});let i=p(parseInt(e.fileAttr.lastModified),!0);t.push({id:4,title:a.modDate,value:i}),t.push({id:5,title:a.size,value:u(e.fileAttr.size)})}return t}(n),g=m.length,f=0;f<g;f++){var S=new d,v=m[f];S.set("name",v.id),S.set("path",v.id),S.set("label",v.title),S.set("value",v.value),a.title==v.title?S.sectionIdentityCard="title":a.owner==v.title?S.sectionIdentityCard="ownerName":a.crDate==v.title&&(S.sectionIdentityCard="date"),c[v.id]=S}r.set(c),i.push(r)}h._propertiesWdg.initDatas(i),t(),h.data&&h._propertiesWdg&&setTimeout((function(){h._propertiesWdg.addAnnotationData({screenshot:h.data.screenshot,annotation:h.data.annotation}),h.data=void 0}),1e3)})))}))},_buildView:function(){if(h.getTriptych()){var t=h.getTriptych().getRightPanelContainer().querySelector(".rightSidePanel");t&&t.firstElementChild&&this.clearView(),t&&null===t.firstElementChild?h._promises.push(new i((function(e){require(["DS/EditPropWidget/EditPropWidget","DS/EditPropWidget/utils/EditPropUtils","DS/EditPropWidget/constants/EditPropConstants","DS/EditPropWidget/models/EditPropModel","DS/EditPropWidget/models/EditPropAttributeModel"],(function(i,n,a,r,u){s=n,l=r,d=u;var p=h.getFrameWindow().experience.args.options.propertiesFacet;h._propertiesWdg=new i({className:"enxpropertiestab",setEditButton:!h._readOnly,readOnly:h._readOnly,typeOfDisplay:a.ALL,selectionType:a.NO_SELECTION,warningOnUnsaved:!1,multiselection:a.MULTISEL_NO,collapseTabs:!1,facets:p,clickOnAnnotationData:h.loadAnnotation,actions:[{name:"action_close_panel",text:o.closeProperties,icon:"close",handler:function(){h.setState(!1)}}]}),c=h._propertiesWdg.inject(t),!0===h.getState()&&h._selectionChange(),h._propertiesWdg.stopSelection(!h.getState()),e()}))}))):t&&null!==t.firstElementChild&&t.getElement&&t.getElement(".enxpropertiestab")&&(h._propertiesWdg=c,h._propertiesWdg.options&&h._propertiesWdg.options.actions&&e.is(h._propertiesWdg.options.actions,"array")&&"action_close_panel"===h._propertiesWdg.options.actions[0].name&&(h._propertiesWdg.options.actions[0].handler=function(){h.setState(!1)})),h.onStateChange((function(){try{h.getState()?r.startCommand(h._id):r.endCommand(h._id)}catch(e){}h.getTriptych().getRightOpen()&&h.getState()||!h.getTriptych().getRightOpen()&&!h.getState()||(h._propertiesWdg.stopSelection(!h.getState()),!0===h.getState()&&h._selectionChange(),h.getTriptych().togglePanel("right"))})),h.getTriptych().getRightOpen()&&h.setState(!0)}else console.log("Triptych not ready yet. Wait for it to compvare the side panel"),this._promises.push(new i((function(e){h.onTriptychReady(h._buildView.bind(h)),e()})))},getID:function(){return this.getFrameWindow().experience.getInformationsOnAsset().id},getRelationID:function(){return""},getType:function(){return this.getFrameWindow().experience.getInformationsOnAsset().type},getTriptych:function(e){var t,i=this.getFrameWindow();if(i){var n=i.experience;n&&(t=n.triptych)}return t},onTriptychReady:function(){},clearView:function(){if(this.getTriptych()){var e=this.getTriptych().getRightPanelContainer().querySelector(".rightSidePanel");e.removeChild(e.firstElementChild)}this._propertiesWdg=null},loadAnnotation:function(e,t){if(h.getFrameWindow()&&h.getFrameWindow().experience){var i=e&&e.annotation?e.annotation:null,n=!(!t||!t.clean);i&&h.getFrameWindow().experience.loadAnnotations(i,n)}},destroy:function(){this.clearView(),this._promises=[],this.token&&this.getFrameWindow()&&this.getFrameWindow().experience&&(this.getFrameWindow().experience.unsubscribe(this.token),this.token=void 0),this._parent()},forEachPropFacet:function(e){this._propertiesWdg&&this._propertiesWdg.elements.container._lFacets.forEach((function(t){e(t)}))},HidePanel:function(){this.setState(!1)},SHowPanel:function(){this.setState(!0)}})})),define("DS/3DPlayCommands/CmdQualityManager",["DS/3DPlayWAFRMigration/Command","UWA/Core","DS/WebInfraUI/SliderPanel","DS/QualityManager/QMController","css!DS/3DPlayCommands/CmdExplode"],(function(e,t,i,n){"use strict";const o=["Low","Medium","High","Ultra"],a=["Low","Medium","High"];return e.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this._qualityProfiles=this._availableQualityProfiles(),this._viewer=this.getFrameWindow().getViewer(),this._createUI(),this._panel.hide(),this._panel.slider.addEventListener("change",this._onSliderChange.bind(this)),this._onProfileChangeToken=this._viewer.onQMGlobalProfileChange(this._updateSliderWithCurrentProfile.bind(this)),this._firstLaunch=!0,this._updateSliderWithCurrentProfile()},beginExecute:function(){this._updateMobileUI(),this._updateMobileUIFunc=this._updateMobileUI.bind(this),this.getFrameWindow().getViewerFrame().addEvent("resize",this._updateMobileUIFunc),this._panel.show()},endExecute:function(){this._panel.hide(),this._updateMobileUI(),this.getFrameWindow().getViewerFrame().removeEvent("resize",this._updateMobileUIFunc)},dispose:function(){this._onProfileChangeToken&&this._viewer.unsubscribe(this._onProfileChangeToken)},_availableQualityProfiles:function(){if(n.isAvailablePreset){const e=[];for(const t of o)n.isAvailablePreset(t)&&e.push(t);return e}return a},_createUI:function(){this._panel=new i({customValues:this._qualityProfiles,withStepMarkers:!0,touchMode:!0,leftButtons:[{fonticon:"chart-gauge-angular",onClick:this._onRecommendedClick.bind(this),popup:"Optimized",desktopOnly:!0}]}).inject(this.getFrameWindow().getActionBar().getContent())},_onSliderChange:function(e){this._viewer.getQMDefaultProfileEquivalent().then(function(t){const i=this._qualityProfiles[e.dsModel.value];this._recommendedClicked&&t==i||this._panel.leftButtons[0].removeAttribute("active"),this._recommendedClicked=!1,this._onProfileChangeToken&&this._viewer.unsubscribe(this._onProfileChangeToken),this._viewer.setQMGlobalProfile(i,null),this._onProfileChangeToken=this._viewer.onQMGlobalProfileChange(this._updateSliderWithCurrentProfile.bind(this))}.bind(this))},_updateSliderWithCurrentProfile:function(){this._viewer.getQMGlobalProfile("Static").then(function(e){"Custom"!=e&&("Default"!=e?this._viewer.getQMDefaultProfileEquivalent().then(function(t){const i=this._qualityProfiles.indexOf(e);-1===i?(console.warn(`CmdQualityManager : ${e} profile is not in the slider profile list`),this._panel.slider.value=0):this._panel.slider.value=i,this._firstLaunch&&e==t&&(this._onRecommendedClick(),this._firstLaunch=!1)}.bind(this)):this._onRecommendedClick())}.bind(this)).catch((function(e){console.warn(e),this._panel.slider.value=0}))},_onRecommendedClick:function(){this._viewer.getQMDefaultProfileEquivalent().then(function(e){this._viewer.setQMGlobalProfile(e,null),this._updateSliderWithCurrentProfile(),this._panel.leftButtons[0].setAttribute("active",!0),this._recommendedClicked=!0}.bind(this))},_updateMobileUI:function(){let e=this.getFrameWindow().getMAB();e&&e.state&&"mobile"===e.state.mode?(e.showCustomFlyout(1,this._panel.getContent()),this._panel.getContent().classList.add("Mobile"),this._mobileUI=!0):this._mobileUI&&(ab.MAB.showFlyout(0),this._panel.getContent().classList.remove("Mobile"),this._panel.inject(ab.getContent()),this._mobileUI=!1)}})})),define("DS/3DPlayCommands/Proxy/VisuShadingIllustrationCmdProxy",["DS/ViewerCommands/VisuShadingIllustrationCmd","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t){"use strict";return e.extend(t("beginExecute",{needCGR:!0,needMeshInRam:!0}))})),define("DS/3DPlayCommands/Proxy/VisuNoShadingEdgesCmdProxy",["DS/ViewerCommands/VisuNoShadingEdgesCmd","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t){"use strict";return e.extend(t("beginExecute",{needCGR:!0}))})),define("DS/3DPlayCommands/ExplodeUI",["css!DS/3DPlayCommands/CmdExplode","DS/3DPlay/3DPlay","UWA/Core","DS/Controls/Slider","DS/VisuEvents/EventsManager","DS/3DPlayUtils/SpreadGesture","DS/WebUtils/Tracker","DS/Core/PointerEvents","DS/3DPlayWAFRMigration/CommandsManager"],(function(e,t,i,n,o,a,r,s,l){"use strict";var d=i.Class.extend({init:function(e){this._frameWindow=e.frameWindow,this._explodeFunction=e.explodeFunction,this._totalSteps=e.totalSteps,this._withBeginAndEndButtons=e.withBeginAndEndButtons,this._viewer=this._frameWindow.getViewer(),this._mobileUI=null,this._explodeSlider=null,this._UIShown=!1,this._container=i.Element("div",{class:"CmdExplode-Container"}),this._closeAnimationTime=1e3,this._updateFunc=this._update.bind(this),this._createUI();var t=new a;o.addGestureRecognizer(t)},show:function(){this._container.classList.remove("close"),this._container.classList.remove("open"),this._container.classList.add("open"),this._frameWindow.getViewerFrame().addEvent("resize",this._updateFunc),this._onSpreadToken=o.addEvent(this._viewer.canvas,"onSpread",this._onSpread.bind(this)),this._spreadCount=0,this._onPointerUpFunc=this._onPointerUp.bind(this),this._viewer.canvas.addEventListener(s.POINTERUP,this._onPointerUpFunc),this._update()},dispose:function(){this._frameWindow.getViewerFrame().removeEvent("resize",this._updateFunc),this._explodeSlider.pause(),this._viewer.canvas.removeEventListener(s.POINTERUP,this._onPointerUpFunc),this._onSpreadToken&&(o.removeEventFromToken(this._onSpreadToken),delete this._onSpreadToken),this._spreadCount&&(r.trackPageEvent("commands","explode","Spread",this._spreadCount),this._spreadCount=0),this._container.remove()},getCurrentStep:function(){return this._explodeSlider._currentStep},setValue:function(e){this._explodeFunction(e),this._explodeSlider.setValue(e)},play:function(e){this._explodeSlider.play(e)},setTotalStepCount:function(e){this._totalSteps=e,this._explodeSlider.setTotalSteps(e)},_createUI:function(){var e=i.Element("div",{class:"CmdExplode-Container-Panel"}).inject(this._container);this._withBeginAndEndButtons&&new i.Element("a",{class:"fonticon fonticon-to-start CmdExplode-Button"}).inject(e).addEventListener("pointerdown",function(){this._explodeSlider.play(0)}.bind(this));(new i.Element("a",{class:"fonticon fonticon-expand-left CmdExplode-Button"}).inject(e).addEventListener("pointerdown",function(){this._explodeSlider.playPreviousStep()}.bind(this)),this._explodeSlider=new c({stepPlayTimeInMilliseconds:1e3,totalSteps:this._totalSteps,minValue:0,maxValue:1,value:0,stepValue:.001,valuePopupFlag:!1,withStepMarkers:!0,touchMode:!0,onChange:this._explodeFunction}).inject(e),this._explodeSlider.getContent().classList.add("CmdExplode-Slider"),new i.Element("a",{class:"fonticon fonticon-expand-right CmdExplode-Button"}).inject(e).addEventListener("pointerdown",function(){this._explodeSlider.playNextStep()}.bind(this)),this._withBeginAndEndButtons)&&new i.Element("a",{class:"fonticon fonticon-to-end CmdExplode-Button"}).inject(e).addEventListener("pointerdown",function(){this._explodeSlider.play(this._totalSteps)}.bind(this))},_update:function(){let e=this._frameWindow.getMAB(),t=e&&e.state&&"mobile"===e.state.mode||!0===e.state.visible;if(!t||this._UIShown&&this._mobileUI){if(!t&&(!this._UIShown||this._mobileUI)){this._mobileUI=!1,e.showFlyout(0);let t=this._frameWindow.getActionBar();t&&this._container.inject(t.getContent()),this._container.classList.remove("Mobile")}}else this._mobileUI=!0,e.showCustomFlyout(1,this._container),this._container.classList.add("Mobile")},_onSpread:function(e){this._currentlySpreading=!0;var t=this._explodeSlider.getPercentage(),i=e.gesture.distance-e.gesture.lastDistance,n=(i*=.2)+t;n<0?n=0:n>100&&(n=100),this._explodeSlider.setPercentage(n)},_onPointerUp:function(){this._currentlySpreading&&(this._currentlySpreading=!1,this._spreadCount++)}}),c=n.extend({init:function(e){this._parent(e),this._container=e.container,this._stepPlayTimeInMilliseconds=e.stepPlayTimeInMilliseconds,this._totalSteps=e.totalSteps,this._snapMargin=e.snapMargin,this._onChangeCB=e.onChange,this._withStepMarkers=e.withStepMarkers,this._isPlaying=!1,this._currentStep=0,this._animationToken=null,this._enableSnapping=!1,this._maxStepCountForSnap=15,this._stepPlayTimeInSeconds||(this._stepPlayTimeInSeconds=1),this._snapMargin||this._updateSnappingSensibility(),this._withStepMarkers&&this._updateSliderStepMarkers(),this.addEventListener("change",function(e){this._currentStep=e.dsModel.value*this._totalSteps,this._onChangeCB(e.dsModel.value)}.bind(this)),this.addEventListener("beginEdit",function(e){this._enableSnapping=!0,this._valueBeforePointerDown=e.dsModel.initialValue,this._onSliderBeginEdit=!0}.bind(this)),this.addEventListener("endEdit",function(e){this._enableSnapping=!1;var t=e.dsModel.value;this._currentValue===t&&(this.setValue(this._valueBeforePointerDown),this.play(this._mapValueToRange(t,0,1,0,this._totalSteps),200,this._linearFunction))}.bind(this))},setValue:function(e){this.pause(),this.setPercentage(this._mapValueToRange(e,0,1,0,100))},playNextStep:function(){this.play(Math.floor(this._currentStep)+1)},playPreviousStep:function(){this.play(Math.ceil(this._currentStep)-1)},play:function(e,t,i){if(!this._isPlaying&&!(e>this._totalSteps||e<0)){t||(t=this._stepPlayTimeInMilliseconds),i||(i=this._easeOutQuint),this._isPlaying=!0;var n=this.value*this._totalSteps;this._animate(n,e,t,i,function(){this._isPlaying=!1,this._currentStep=e}.bind(this))}},pause:function(){window.cancelAnimationFrame(this._animationToken),this._isPlaying=!1},setTotalSteps:function(e){this._totalSteps=e,this._updateSnappingSensibility(),this._withStepMarkers&&this._updateSliderStepMarkers()},_updateSnappingSensibility:function(){if(0===this._totalSteps||this._totalSteps>this._maxStepCountForSnap)this._snapMargin=0;else{var e=1/this._totalSteps,t=e/2-.2*e;this._snapMargin=Math.min(.1,t)}},_updateSliderStepMarkers:function(){if(this._linesContainer)this._linesContainer.empty();else{var e=this.getContent().querySelector(".wux-controls-slider-container");this._linesContainer=new i.Element("div",{class:"CmdExplode-Slider-LinesContainer"}).inject(e)}if(this._totalSteps<=this._maxStepCountForSnap)for(var t=0;t<=this._totalSteps;t++)new i.Element("div",{class:"CmdExplode-Slider-Line"}).inject(this._linesContainer)},_animate:function(e,t,i,n,o){var a=0,r=0;e/=this._totalSteps,t/=this._totalSteps;var s=function(l){a||(a=l),r=l-a;var d=this._mapValueToRange(r,0,i,0,1);if(d>1)return this.setPercentage(100*t),void o();var c=n(d),h=this._mapValueToRange(c,0,1,e,t);this.setPercentage(100*h),this._animationToken=window.requestAnimationFrame(s)}.bind(this);this._animationToken=window.requestAnimationFrame(s)},_applyValue:function(e,t){if(this._onSliderBeginEdit)this._onSliderBeginEdit=!1,this._currentValue=t;else{var i=!1;if(this._enableSnapping)for(var n=1/this._totalSteps,o=0;o<=this._totalSteps;o++){var a=n*o;t<=a+this._snapMargin&&t>=a-this._snapMargin&&(t=a,this.setPercentage(100*a),i=!0)}this._parent(e,t),i&&(this._currentStep=Math.floor(Math.ceil(t*this._totalSteps)))}},_easeOutQuint:function(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2},_linearFunction:function(e){return e},_mapValueToRange:function(e,t,i,n,o){return n+(e-t)*(o-n)/(i-t)}});return d})),define("DS/3DPlayCommands/Proxy/VisuShadingEdgesHiddenEdgesCmdProxy",["DS/ViewerCommands/VisuShadingEdgesHiddenEdgesCmd","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t){"use strict";return e.extend(t("beginExecute",{needCGR:!0}))})),define("DS/3DPlayCommands/CmdScenario",["UWA/Core","DS/3DPlayWAFRMigration/Command","DS/3DPlay/3DPlay","DS/3DPlay/3DPlayScenarioManager","DS/CoreEvents/Events","DS/WebUtils/Tracker","DS/Core/PointerEvents","DS/WebSystem/Nls","DS/WebSystem/DetectBrowser","DS/WebInfraUI/CmdScenarioUI","i18n!DS/3DPlay/assets/nls/3DPlay"],(function(e,t,i,n,o,a,r,s,l,d,c){"use strict";return t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),n._updateScenarioChooser()},beginExecute:function(){o.publish({event:"3DPLAY/SPECTREE/DISABLE",data:{}}),this.AFR2_Execute()},execute:function(){if(a.command(this.getId()),n.getAllScenarios().length<2)this.end();else{var e=this,t=[],i=n.getAllRegisters(),o=n.getExperience();o&&(o._iOS||o._android)&&!0;e.getFrameWindow().getViewer().SCREEN_WIDTH;var r=n.getCurrentScenario(),s=n._getDefaultScenario();for(var l in i)for(var h=n.getAllScenarioForRegister(l),u=0;u<h.length;u++){var p=h[u].scenario;if((!o.frmWindow.getMAB().state.visible||p.isMobileCompatible())&&h[u].available){var m=!1;m=r?r.scenarioID===p.scenarioID:s&&s.scenarioID===p.scenarioID,t.push({selected:m,name:p.title,thumbnail:p.icon,data:{registerId:l,scenarioId:p.scenarioID,reset:p.getScenarioResetActionBarPolicy()},onSelectCB:function(t){n.changeScenario(t.registerId,t.scenarioId,t.subScenarioId,t.reset,void 0,!1),e.end(),d.dispose()}})}}d.create({frmWnd:e.getFrameWindow(),listchooser:t,title:c.Scenario_PanelTitle,endcb:function(){e.end();var t=e.getFrameWindow().getMAB();t&&t.showFlyout(0),e=null}})}},endExecute:function(){d.dispose(),n._updateScenarioChooser()}})})),define("DS/3DPlayCommands/Proxy/VisuShadingEdgesNoSmoothEdgesCmdProxy",["DS/ViewerCommands/VisuShadingEdgesNoSmoothEdgesCmd","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t){"use strict";return e.extend(t("beginExecute",{needCGR:!0}))})),define("DS/3DPlayCommands/Proxy/VisuShadingMaterialCmdProxy",["DS/ViewerCommands/VisuShadingMaterialCmd","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t){"use strict";return e.extend(t("beginExecute",{needCGR:!0,needMaterial:!0}))})),define("DS/3DPlayCommands/Proxy/VisuShadingEdgesCmdProxy",["DS/ViewerCommands/VisuShadingEdgesCmd","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t){"use strict";return e.extend(t("beginExecute",{needCGR:!0}))})),define("DS/3DPlayCommands/CmdMouseControl",["DS/3DPlayWAFRMigration/Command","DS/3DPlay/3DPlay"],(function(e,t){"use strict";var i=e.extend({init:function(e){this._parent(e,{mode:"shared"})},beginExecute:function(){try{this.getFrameWindow().getViewpoint().control.setTrackPadSupport("no",-1)}catch(e){console.error(`Cannot set mouse control :\n${e}`),t.sendEvent(this.getFrameWindow().experience,eventType.notif,"warning",{msg:"Unable to set Mouse control"})}window.localStorage.setItem("3DPlay.TrackPadControl",!1)}});return UWA.namespace("DS/3DPlayCommands/CmdMouseControl",i)})),define("DS/3DPlayCommands/CmdTrackPadControl",["DS/3DPlayWAFRMigration/Command","DS/3DPlay/3DPlay"],(function(e,t){"use strict";var i=e.extend({init:function(e){this._parent(e,{mode:"shared"})},beginExecute:function(){try{this.getFrameWindow().getViewpoint().control.setTrackPadSupport("yes",-1)}catch(e){console.error(`Cannot set trackpad control :\n${e}`),t.sendEvent(this.getFrameWindow().experience,eventType.notif,"warning",{msg:"Unable to set TrackPad control"})}window.localStorage.setItem("3DPlay.TrackPadControl",!0),this.AFR2_Done()}});return UWA.namespace("DS/3DPlayCommands/CmdTrackPadControl",i)})),define("DS/3DPlayCommands/cmdExperienceChooser",["UWA/Core","DS/3DPlayWAFRMigration/Command"],(function(e,t){"use strict";return t.extend({})})),define("DS/3DPlayCommands/EmptyCmd",["UWA/Core","DS/3DPlayWAFRMigration/Command"],(function(e,t){"use strict";return t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.AFR2_Done()}})})),define("DS/3DPlayCommands/Proxy/VisuPerspectiveViewCmdProxy",["DS/ViewerCommands/VisuPerspectiveViewCmd","DS/WebUtils/Tracker"],(function(e,t){"use strict";return e.extend({beginExecute:function(){t.command(this.getId()),this._parent.apply(this,arguments)}})})),define("DS/3DPlayCommands/Proxy/VisuReframeViewCmdProxy",["DS/ViewerCommands/VisuReframeViewCmd","DS/WebUtils/Tracker"],(function(e,t){"use strict";return e.extend({execute:function(){t.command("Reframe3D"),this._parent.apply(this,arguments)}})})),define("DS/3DPlayCommands/3DPlayCommands",[],(function(){})),define("DS/3DPlayCommands/CmdLineicFilter",["DS/3DPlayWAFRMigration/Command","DS/CoreEvents/Events","DS/WebappsUtils/WebappsUtils","DS/WebInfraUI/ContextualBarManager","DS/WebSystem/Settings","DS/WebUtils/Tracker","DS/3DPlayCommands/CmdENOPADStream"],(function(e,t,i,n,o,a,r){"use strict";var s,l=e.extend({destroy:function(){s&&(s._frmWindow=null,s._viewer=null,s.token&&t.unsubscribe(s.token),s=null)},init:function(e){if((s=this)._parent(e,{isAsynchronous:!0,mode:"exclusive"}),s._frmWindow=s.getFrameWindow(),s._viewer=s._frmWindow.getViewer(),s._iconDir=i.getWebappsAssetUrl("3DPlay","icons/32/"),s._axisState="true"===o.get("axisState3DPlay",!0),s._linesState="true"===o.get("linesState3DPlay",!0),s._edgesState="true"===o.get("edgesState3DPlay",!0),s._pointsState="true"===o.get("pointsState3DPlay",!0),s._exp=s._frmWindow.experience,void 0!==s._exp&&(s._exp.registerCollabAction("lineicFilterExecute",s.beginExecute.bind(s)),s._exp.registerCollabAction("lineicFilterResumeExecute",s.resumeExecute.bind(s)),s._exp.registerCollabAction("lineicFilterEndExecute",s.endExecute.bind(s))),s.setAxis=function(e){s.getFrameWindow().experience.getRootBag()&&(s._frmWindow.hello=s._axisState),s._viewer.setAxisFilter(s._axisState),s._viewer.render(),s._exp.notifyAction&&!0===s._exp.collabMode&&s._exp.notifyAction("lineicFilterSetAxis",[s._axisState])},s.setAxisFF=function(e){s._axisState=e,s.setAxis()},void 0!==s._exp&&s._exp.registerCollabAction("lineicFilterSetAxis",s.setAxisFF.bind(s)),s.setPoints=function(e){s._viewer.setPointsFilter(s._pointsState),s._viewer.render(),s._exp&&s._exp.notifyAction&&!0===s._exp.collabMode&&s._exp.notifyAction("lineicFilterSetPoints",[s._pointsState])},s.setPointsFF=function(e){s._pointsState=e,s.setPoints()},void 0!==s._exp&&s._exp.registerCollabAction("lineicFilterSetPoints",s.setPointsFF.bind(s)),s.setEdges=function(e){s._viewer.render(),s._exp&&s._exp.notifyAction&&!0===s._exp.collabMode&&s._exp.notifyAction("lineicFilterSetEdges",[s.edgesState])},s.setEdgesFF=function(e){s._edgesState=e,s.setEdges()},void 0!==s._exp&&s._exp.registerCollabAction("lineicFilterSetEdges",s.setEdgesFF.bind(s)),s.setLines=function(e){s._viewer.setLinesFilter(s._linesState),s._viewer.render(),s._exp&&s._exp.notifyAction&&!0===s._exp.collabMode&&s._exp.notifyAction("lineicFilterSetLines")},s.setLinesFF=function(e){s._linesState=e,s.setLines()},void 0!==s._exp&&s._exp.registerCollabAction("lineicFilterSetLines",s.setLinesFF.bind(s)),1==s._frmWindow.hello)s.setAxis();else{var t=s._frmWindow.experience;t&&(this.token=t.subscribe("ASSET/LOADINGFINISHED",s.setAxis),t.EventDisposer.add(this.token))}s._exp.dontrecordVisuChange=!0,s.setPoints(),s.setLines(),s._exp.dontrecordVisuChange=!1},execute:function(){s.contextualMenu=new n({frameWindow:s._frmWindow});var e={type:s.contextualMenu.Button.Check,id:"FilterAxis",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",selected:s._axisState,onclickCB:function(){s._axisState=!s._axisState,o.set("axisState3DPlay",s._axisState),s.setAxis()}},t={type:s.contextualMenu.Button.Check,id:"FilterLines",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",selected:s._linesState,onclickCB:function(){s._linesState=!s._linesState,o.set("linesState3DPlay",s._linesState),s.setLines()}},i={type:s.contextualMenu.Button.Check,id:"FilterPoints",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",selected:s._pointsState,onclickCB:function(){s._pointsState=!s._pointsState,o.set("pointsState3DPlay",s._pointsState),s.setPoints()}};s.axisToolToken=s.contextualMenu.addButtons([e],{barType:s.contextualMenu.Toolbar.New}),s.linesToolToken=s.contextualMenu.addButtons([t],{barType:s.contextualMenu.Toolbar.Append}),s.pointsToolToken=s.contextualMenu.addButtons([i],{barType:s.contextualMenu.Toolbar.Append,showContextBarBackground:!0}),s._viewer.render(),s._exp&&s._exp.notifyAction&&!0===s._exp.collabMode&&s._exp.notifyAction("lineicFilterExecute")},resumeExecute:function(){var e=this;e._viewer.render(),e.end(),e._exp&&e._exp.notifyAction&&!0===e._exp.collabMode&&e._exp.notifyAction("lineicFilterResumeExecute")},endExecute:function(){var e=this;e.contextualMenu&&(e.contextualMenu.removeButtons(e.axisToolToken),e.contextualMenu.removeButtons(e.linesToolToken),e.contextualMenu.removeButtons(e.pointsToolToken),e.contextualMenu.dispose(),e.contextualMenu=void 0),e._exp&&e._exp.notifyAction&&!0===e._exp.collabMode&&e._exp.notifyAction("lineicFilterEndExecute")}}).extend(r("execute"));return UWA.namespace("ViewerCommands/LineicFilter",l)})),define("DS/3DPlayCommands/CmdViewSelector",["UWA/Core","DS/3DPlay/3DPlay","DS/3DPlayWAFRMigration/Command","DS/Visualization/ThreeJS_DS","DS/WebInfraUI/Touch","DS/WebappsUtils/WebappsUtils","DS/3DPlayUtils/VisibilityUtils","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebInfraUI/NavigationArrows","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/WebUtils/Tracker","DS/3DPlayWAFRMigration/CommandsManager","DS/3DPlayWAFRMigration/3DPlayCommandsTools"],(function(e,t,i,n,o,a,r,s,l,d,c,h,u,p,m,g){"use strict";var f,S=i.extend({init:function(e){this._parent(e,{isAsynchronous:!0,mode:"exclusive"}),this.frameWindow=this.getFrameWindow(),this.rotationQueue=[],this._isReadyForAnimation=!0,this._isCurrentViewISO=!1,f=this},destroy:function(){f=null,this.viewer=null,this.viewerFrame=null,this.viewpoint=null,this.viewControl=null},getNearestAxis:function(e){var t=[];t.push(new n.Vector3(1,0,0)),t.push(new n.Vector3(0,1,0)),t.push(new n.Vector3(0,0,1)),t.push(new n.Vector3(-1,0,0)),t.push(new n.Vector3(0,-1,0)),t.push(new n.Vector3(0,0,-1));for(var i=0,o=1/0,a=0;a<t.length;a++){var r=e.angleTo(t[a]);r<o&&(i=a,o=r)}return t[i]},applyNearestStdView:function(){f.rotationQueue.push("nearestUP","nearestSIGHT"),f.callForAnimation()},_animate:function(e,t){e.normalize(),t.normalize(),f._isReadyForAnimation=!1;var i=Math.acos(t.dot(e))*(180/Math.PI),o=Math.floor(Math.abs(i)),a=i-o,r=0,s=t.cross(e);s.normalize();var l=function(){var e=(new n.Quaternion).setFromAxisAngle(s,Math.PI/180*-10),t=o-r;t>=10?e.setFromAxisAngle(s,Math.PI/180*-10):t<10?e.setFromAxisAngle(s,-t*(Math.PI/180)):r>o&&e.setFromAxisAngle(s,-a*(Math.PI/180)),f.viewControl&&f.viewControl.orientation.multiplyQuaternions(e,f.viewControl.orientation.clone()),f.viewControl&&f.viewControl.update(),f.frameWindow.getViewer().render(),(r+=10)<o?requestAnimationFrame(l):f.rotationQueue.length>0?f.callForAnimation():f._isReadyForAnimation=!0};l()},updateRotationQueue:function(e,t){t&&t.srcEvent&&t.srcEvent.preventDefault(),this.rotationQueue.push(e),this._isReadyForAnimation&&this.callForAnimation()},callForAnimation:function(){var e=this.rotationQueue.shift(),t={};if(this._isCurrentViewISO){switch(e){case"left":case"rotateCCW":t={stdView:"right"};break;case"right":case"rotateCW":t={stdView:"front"};break;case"up":t={stdView:"bottom"};break;case"down":t={stdView:"top"}}this._isCurrentViewISO="iso"===e}else{switch(e){case"left":t={from:this.viewpoint.getSightDirection(),to:this.viewpoint.getUpDirection().cross(this.viewpoint.getSightDirection())};break;case"right":t={from:this.viewpoint.getSightDirection(),to:this.viewpoint.getSightDirection().clone().cross(this.viewpoint.getUpDirection())};break;case"up":t={from:this.viewpoint.getSightDirection(),to:this.viewpoint.getUpDirection()};break;case"down":t={from:this.viewpoint.getSightDirection(),to:this.viewpoint.getUpDirection().multiplyScalar(-1)};break;case"iso":t={stdView:"iso"},this._isCurrentViewISO=!0;break;case"rotateCW":t={from:this.viewpoint.getUpDirection(),to:this.viewpoint.getUpDirection().cross(this.viewpoint.getSightDirection())};break;case"rotateCCW":t={from:this.viewpoint.getUpDirection(),to:this.viewpoint.getSightDirection().cross(this.viewpoint.getUpDirection())};break;case"nearestUP":t={from:this.viewpoint.getUpDirection(),to:this.getNearestAxis(this.viewpoint.getUpDirection())};break;case"nearestSIGHT":t={from:this.viewpoint.getSightDirection(),to:this.getNearestAxis(this.viewpoint.getSightDirection())}}"nearestSIGHT"!==e&&"nearestUP"!==e&&"iso"!==e&&f.rotationQueue.unshift("nearestUP","nearestSIGHT")}t&&t.from?this._animate(t.from,t.to):t&&t.stdView&&this.viewpoint.reframe(t.stdView),this.frameWindow.getViewer().render()},saveCurrentViewSettings:function(){var e=this.frameWindow.getViewer();this.viewSettings={},this.viewSettings.shadow=e.getShadow(),this.viewSettings.mirror=e.getMirror(),this.viewSettings.grid=e.getGrid(),this.viewSettings.infinitePlane=e.getInfinitePlane(),e&&(e.setShadow(!1),e.setGrid(!1),e.setMirror(!1,!1),e.displayInfinitePlane(!1),e.setPrePicking({activated:!1,displayHL:!1},!0),e.setPicking({activated:!1,displayHL:!1},!0)),this.viewControl.setActive(!1),this.viewControl.resetGestureCB(),r.setVisibilityOfAnnotations(f.viewer,!1),r.setVisibilityOfSectionsAndMeasures(f.viewer,!1)},applySavedViewSettings:function(){f.viewer&&(f.viewer.setShadow(this.viewSettings.shadow),f.viewer.setMirror(this.viewSettings.mirror),f.viewer.setGrid(this.viewSettings.grid),f.viewer.setPicking({activated:!0,displayHL:!0},!0),f.viewer.setPrePicking({activated:!0,displayHL:!0},!0),f.viewer.displayInfinitePlane(this.viewSettings.infinitePlane),delete this.viewSettings)},onModelLoadingEnd:function(){f.rotationQueue=[],f._refreshView()},onSwipeLeft:function(e){f.updateRotationQueue("left",e)},onSwipeRight:function(e){f.updateRotationQueue("right",e)},onSwipeUp:function(e){f.updateRotationQueue("up",e)},onSwipeDown:function(e){f.updateRotationQueue("down",e)},rotateLeft:function(e){f.updateRotationQueue("left",e)},rotateRight:function(e){f.updateRotationQueue("right",e)},rotateUp:function(e){f.updateRotationQueue("up",e)},rotateDown:function(e){f.updateRotationQueue("down",e)},rotateCW:function(e){f.updateRotationQueue("rotateCW",e)},rotateCCW:function(e){f.updateRotationQueue("rotateCCW",e)},applyISOView:function(e){e&&e.srcEvent&&e.srcEvent.stopPropagation&&e.srcEvent.stopPropagation(),f.updateRotationQueue("iso",e)},onPinch:function(e){e.rotation=0,e.srcEvent.preventDefault()},onRotate:function(e){if(f.startRotation){var t=e.rotation-f.startRotation;Math.abs(t)>45&&(f.startRotation=e.rotation,f.leastOneRotation=!0,t>0?f.updateRotationQueue("rotateCW",e):t<0&&f.updateRotationQueue("rotateCCW",e))}else f.startRotation=e.rotation},onRotateStart:function(e){f.startRotation=e.rotation},onRotateEnd:function(e){var t=e.rotation-f.startRotation;f.startRotation=void 0,Math.abs(t)<45&&(f.leastOneRotation||(t>0?f.updateRotationQueue("rotateCW",e):t<0&&f.updateRotationQueue("rotateCCW",e))),f.leastOneRotation=!1},endCommand:function(e){if(e&&e.center&&!e.target.id.contains("iso")&&-1===e.target.className.indexOf("arrow")){var t=new n.Vector2(e.center.x,e.center.y),i=f.viewer.getMousePosition(t);if(0===f.viewer.pick(i,"mesh",!0).path.length){var o=f.frameWindow.getActionBar();o&&("closed"===!f.actionBarState&&o.toggle(),f.actionBarState="open",o.open());var a=f.frameWindow.getActionMAB();a&&a.showFlyout(0)}}},_buildUI:function(){var t=f.frameWindow.getActionBar();if(t){g.isActionBarOpen(t)&&t.toggle();var i=t.onActionBarOpen((function(){t.removeCallback(i),f.end()}))}var n=f.frameWindow.getUIFrame();f.mainContainer=new e.Element("div",{id:"mainContainer",styles:{position:"absolute",width:"100%",height:"100%",top:0,left:0,"touch-action":"none"}}).inject(n);var s={arrowCB:{left:f.rotateLeft,right:f.rotateRight,up:f.rotateUp,down:f.rotateDown,clockwise:f.rotateCW,counterClockwise:f.rotateCCW},gestureCB:{tap:f.endCommand,swipeleft:f.onSwipeLeft,swiperight:f.onSwipeRight,swipeup:f.onSwipeUp,swipedown:f.onSwipeDown,rotate:f.onRotate,rotatestart:f.onRotateStart,rotateend:f.onRotateEnd}};f.navigationArrows=new c(s,{container:f.mainContainer,frmWindow:f.frameWindow});var l,d=0;document.getElementById("PlayWeb-Fullscreen")&&(d=36),f.isometricDiv=new e.Element("div",{id:"navigate3DPlay-isometric-div",styles:{position:"absolute","background-size":"contain",width:"10%",height:"10%",display:"block","min-width":"64px","min-height":"64px",cursor:"pointer","background-repeat":"no-repeat","background-image":"url("+a.getWebappsBaseUrl()+"3DPlayCommands/assets/icons/I_3DSHARE_ISO_View_Icon.png)",right:d,top:0}}).inject(n),f._checkKey=function(e){if(e&&e.from[0]&&e.from[0].event){var t=e.from[0].event;73!==t.keyCode&&105!==t.keyCode||!1!==t.ctrlKey||!f.applyISOView||f.applyISOView(e)}},f.touchIso=o(f.isometricDiv),f.touchIso.on("tap",f.applyISOView),window.__karma__&&(f.isometricDiv.onclick=f.applyISOView),h.addEvent(document,"onKeyDown",f._checkKey),r.setVisibilityOfAnnotations(f.viewer,!0),f.frameWindow.experience&&f.frameWindow.experience.ctx&&(l=m.getCommand("measure2CmdHdr",f.frameWindow.experience.ctx)),(f.viewer.getClippingPlanes()&&f.viewer.getClippingPlanes().length||l&&l.hasActiveMeasures())&&r.setVisibilityOfSectionsAndMeasures(f.viewer,!0)},beginExecute:function(){p.startCommand(this.getId()),this._initializeView(),u.publish({event:"3DPLAY/SPECTREE/DISABLE",data:{}}),f.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize)},_onWidgetResize:function(){if(f&&f.frameWindow){var e=f.frameWindow.getActionBar();e&&(g.isActionBarOpen(e)||e.toggle()),f.frameWindow.getMAB()&&f.frameWindow.getMAB().showFlyout(0)}},_initializeView:function(){s.empty(),d.empty(),l.empty(),f.viewer=f.frameWindow.getViewer(),f.viewerFrame=f.frameWindow.getViewerFrame(),f.viewpoint=f.frameWindow.getViewpoint(),f.viewControl=f.viewpoint.getControl(),f.saveCurrentViewSettings(),f._buildUI(),f.frameWindow.experience?!0===f.frameWindow.experience.modelLoadComplete&&f._refreshView():f._refreshView()},_clearView:function(){f.viewControl.setActive(!0),f.viewControl.initGestureCB(),f.applySavedViewSettings(),f.navigationArrows.dispose(),f.navigationArrows=null,f.touchIso.off("tap",f.applyISOView),h.removeEvent(document,"onKeyDown",f._checkKey),f.mainContainer.remove(),f.isometricDiv.remove(),f.touchIso=null,f.mainContainer=null,f.isometricDiv=null,f.viewSettings=null,f.viewControl=void 0,f.viewer=null,f.viewerFrame=null,f._isReadyForAnimation=null,f._isCurrentViewISO=null,f.rotationQueue=[];var e=f.frameWindow.getActionBar();e&&!g.isActionBarOpen(e)&&e.toggle()},_refreshView:function(){f&&f.viewpoint&&(f.viewpoint.reframe(null,200),this.timeoutToken=setTimeout((function(){f.applyNearestStdView()}),400))},endExecute:function(){if(p.endCommand(this.getId()),this.timeoutToken&&(clearTimeout(this.timeoutToken),this.timeoutToken=void 0),f){f._clearView();var e=f.frameWindow.getMAB();e&&!1===e.state.visible&&u.publish({event:"3DPLAY/SPECTREE/ENABLE",data:{}})}else u.publish({event:"3DPLAY/SPECTREE/ENABLE",data:{}});f.frameWindow.getViewerFrame().removeEvent("resize",f._onWidgetResize),this.AFR2_Done()}});return S})),define("DS/3DPlayCommands/Proxy/VisuShadingCmdProxy",["DS/ViewerCommands/VisuShadingCmd","DS/WebUtils/Tracker"],(function(e,t){"use strict";return e.extend({beginExecute:function(){t.command(this.getId()),this._parent.apply(this,arguments)}})})),define("DS/3DPlayCommands/Cmd3DRightSidePanel",["DS/3DPlayCommands/CmdRightSidePanel","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Utilities/Utils"],(function(e,t,i,n,o,a,r){"use strict";var s;return e.extend({_tokenCSO:[],_tokenPSO:[],_tokenHSO:[],init:function(e){this._parent(e),s=this;var o=r.debounce((function(){s&&s.getState()&&s._selectionChange()}),50);function l(e){if(!s.getState())return;function t(e){if(!(e&&e.pathElement&&e.pathElement.externalPath.length&&a.isAModelPath(e.pathElement)))return;let t=e.pathElement,i=t.getLastElement(!0),n=!1;if(t&&t.externalPath)for(var o=0;o<t.externalPath.length;o++)if("annotGroupNode"===t.externalPath[o].name){n=!0;break}if(!n){for(;t&&!a.isReference(i)&&t.externalPath.length>2;)t=t.getParentPath(),t&&(i=t.getLastElement(!0));e.pathElement=t}}let i=s.getFrameWindow().experience;if(!i.pad3DViewer._lockCSONotification&&"ENOPAD"===i.currentProvider)if(e instanceof Array)for(let i=e.length;i--;)e[i].event&&t(e[i]);else e.event&&t(e)}this._tokenCSO.push(t.onPreAdd(l)),this._tokenHSO.push(n.onPreAdd(l)),this._tokenPSO.push(i.onPreAdd(l)),this._tokenCSO.push(t.onPostAdd(o)),this._tokenCSO.push(t.onPostRemove(o)),this._tokenCSO.push(t.onEmpty(o))},destroy:function(){this._tokenCSO.forEach((e=>{t.unsubscribe(e)})),this._tokenCSO=[],this._tokenPSO.forEach((e=>{i.unsubscribe(e)})),this._tokenPSO=[],this._tokenHSO.forEach((e=>{n.unsubscribe(e)})),this._tokenHSO=[],this._parent(),s=null},_selectionChange:function(){this._parent(t.get())},getID:function(e){var t,i=e.pathElement;if(i&&"ENOPAD"===this.getFrameWindow().experience.currentProvider){for(;i&&!a.isPLMNode(i.getLastElement(!0));)i=i.getParentPath();if(!i&&o.get().isSelectiveLoadingActivated())null==(t=o.get().getController().getOOCSelectedReferenceID())&&(t="");else if(i){var n=i.getLastElement(!0);t=a.getNodeID(n)}}return t||this._parent()},getRelationID:function(e){var t,i=e.pathElement;if(i&&"ENOPAD"===this.getFrameWindow().experience.currentProvider){for(;i&&!a.isPLMNode(i.getLastElement(!0));)i=i.getParentPath();if(i){var n=i.getLastElement(!0);if(a.isInstance(n))t=a.getNodeID(n);else{var o=i.getParentPath().getLastElement(!0);t=a.getNodeID(o)}}}return t||this._parent()},getType:function(e){var t,i=e.pathElement;if(i&&"ENOPAD"===this.getFrameWindow().experience.currentProvider){for(;i&&!a.isPLMNode(i.getLastElement(!0));)i=i.getParentPath();if(i){var n=i.getLastElement(!0);t=a.getNodeType(n)}}return t||this._parent()},getTriptych:function(){return o.get().elements.triptych},onTriptychReady:function(e){var t=o.get().subscribe({event:"on3DTriptychReady"},(function(i){e.call(o.get().elements.triptych),require("DS/PADServices/utils/GlobalModelEvents").unsubscribe(t)}))}})})),define("DS/3DPlayCommands/CmdShareDownload",["DS/3DPlayCommands/CmdShareBase"],(function(e){"use strict";return e.extend({shareWithPanelManager:function(e){e&&e._saveScreenshot()}})})),define("DS/3DPlayCommands/CmdShareTo3DSwYm",["DS/3DPlayCommands/CmdShareBase"],(function(e){"use strict";return e.extend({shareWithPanelManager:function(e){if(window.WinJS&&void 0===window.HybridAppArgs){var t=this._ctx;require(["i18n!DS/3DPlayCommands/assets/nls/CmdPublishToSwymWin10"],(function(e){window.SHARE&&window.SHARE.Core.sendEvent(t,"notif","warning",{msg:e.NotConnected})})),this.cancel()}else e&&e._publishToSwYm()}})})),define("DS/3DPlayCommands/CmdShare3DComment",["DS/3DPlayCommands/CmdShareBase"],(function(e){"use strict";return e.extend({shareWithPanelManager:function(e){e&&e._shareTo3DComment()}})})),define("DS/3DPlayCommands/CmdSharePrint",["DS/3DPlayCommands/CmdShareBase"],(function(e){"use strict";return e.extend({shareWithPanelManager:function(e){e&&e._printScreenshot()}})})),define("DS/3DPlayCommands/CmdPublishToMake",["DS/3DPlay/3DPlay","DS/WebSystem/Nls","DS/WebInfraUI/Notification","DS/3DPlayCommands/CmdShareBase","i18n!DS/3DPlay/assets/nls/3DPlay"],(function(e,t,i,n,o){"use strict";return n.extend({shareWithPanelManager:function(){var t=this.getFrameWindow().experience,n=t.args.input.asset;Array.isArray(n)&&(n=n[0]);var a=n.type.toLowerCase();if("3DSPACE"===n.provider||"catproduct"===a)e.sendEvent(t.args.ctx,eventType.notif,i.info,{msg:o.PUBLISHTOMAKE_NOT_READY});else{require(["DS/PlatformAPI/PlatformAPI"],(function(e){e.publish("marketplace.make.sendContent",n)}))}}})}));var e=[];"false"!==window.localStorage["3DPlay.pad3DViewer"]&&e.push("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),define("DS/3DPlayCommands/VisibilityCommands",["DS/3DPlayWAFRMigration/Command","DS/WebInfraUI/ContextualBarManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/CoreEvents/Events","DS/Visualization/PathElement","DS/3DPlay/3DPlay","DS/WebUtils/State","DS/WebUtils/Tracker","DS/WebInfraUI/Notification","DS/3DPlayWAFRMigration/CommandsManager","i18n!DS/3DPlay/assets/nls/3DPlay","DS/3DPlayCommands/ExplodeServices"].concat(e),(function(e,t,n,o,a,r,s,l,d,c,h,u,p,m,g){"use strict";var f,S=function(e){var t,i=e.getNodes();return i.forEach((function(e){"RootBag"===e.name&&(t=e)})),t||(t=i[0]),t},v=!1,_=e.extend({init:function(e){this._parent(e,{isAsynchronous:!0,mode:"exclusive"}),this.framewindow=this.getFrameWindow(),this.isIsolateOn=!1,this._token_swapVisibleSpace=null,f=this;var t=this.framewindow.getViewer();t&&(this._token_swapVisibleSpace=t.onSwapVisibleSpace((function(){var e={AnnotationCommands:u.getCommand("AnnotationCommands",f.framewindow.experience.ctx),AnnotationTour:u.getCommand("AnnotationTour",f.framewindow.experience.ctx),AnnotationCommand3DText:u.getCommand("AnnotationCommand3DText",f.framewindow.experience.ctx),AnnotationCommand3DEditShape:u.getCommand("AnnotationCommand3DEditShape",f.framewindow.experience.ctx),EnhancedExplode:u.getCommand("EnhancedExplode",f.framewindow.experience.ctx),LockUnlockSectionHdr:u.getCommandCheckHeader("LockUnlockSectionHdr",f.framewindow.experience.ctx),measure2CmdHdr:u.getCommand("measure2CmdHdr",f.framewindow.experience.ctx),section2CmdHdr:u.getCommand("section2CmdHdr",f.framewindow.experience.ctx)};0===t.getVisibleSpace()?(e.AnnotationCommands.disable(),e.AnnotationCommand3DText.disable(),e.AnnotationCommand3DEditShape.disable(),f.isTourActive=e.AnnotationTour.isEnabled(),e.AnnotationTour.disable(),e.measure2CmdHdr&&e.measure2CmdHdr.disable(),e.section2CmdHdr&&e.section2CmdHdr.disable(),e.LockUnlockSectionHdr&&e.LockUnlockSectionHdr.disable(),e.EnhancedExplode&&e.EnhancedExplode.disable()):(e.AnnotationCommands.enable(),e.AnnotationCommand3DText.enable(),e.AnnotationCommand3DEditShape.enable(),f.isTourActive&&e.AnnotationTour.enable(),e.measure2CmdHdr&&e.measure2CmdHdr.enable(),e.section2CmdHdr&&e.section2CmdHdr.enable(),e.LockUnlockSectionHdr&&e.LockUnlockSectionHdr.enable(),m.isExplodeAvailable()&&e.EnhancedExplode.enable()),f.framewindow.experience.publish("3DPLAY/2DEXP/MAB/SCROLL/NAVIGATIONSTATEUPDATE",{})})));var i=function(e){v=e.loadAssetInfo&&"r2vsurvey"===e.loadAssetInfo.serviceId};this.getFrameWindow().experience&&(this.getFrameWindow().experience.modelLoadComplete&&i({loadAssetInfo:f.framewindow.experience.args.input.asset}),this.getFrameWindow().experience.addOnLoadingFinishedCB(i))},beginExecute:function(){c.startCommand("command-"+this.getId());var e=this.framewindow.getViewer();this.myDestroy=function(){e=null},this.sceneGraphState||(this.sceneGraphState=e.createSceneGraph("VisibilitySG",this.framewindow.experience.getRootBag())),this.sceneGraphStateIsolate||(this.sceneGraphStateIsolate=e.createSceneGraph("VisibilitySG_Isolate",this.framewindow.experience.getRootBag()));var i=S(e);this.modifiedObjectsInitial=this.sceneGraphState.getOverridesFromPathElement(i),this.modifiedRoot,this.modifiedObjectsConcatinated=[];var n=this.sceneGraphStateIsolate.getRootsAndConcatinatedPaths(i);f.modifiedRoot=n.mainroot,f.modifiedObjectsConcatinated=n.concatinated,this.prepicking=new d({getValue:function(){return e.pPicking.activated},restore:function(t){e.setPrePicking({activated:t})}}),e.setPrePicking({activated:!0}),this.contextualMenu=new t({frameWindow:this.framewindow});var a=function(){f.framewindow.getMAB()&&f.framewindow.experience.notifScreen.removeNotifications();var e=f.framewindow.getViewer(),t=f.sceneGraphState,i=f.sceneGraphStateIsolate,n=o.get();if(!0===f.isIsolateOn)f.isolateCurrentObjects(n);else for(var a=S(e),r=0;r<n.length;r++){var s=n[r].pathElement||n[r],d=f._checkIfAnnotationSelected(s);if(0===e.getVisibleSpace())if(d){(h=t.getSceneGraphOverride(s))&&(t.deleteOverride(h),f._removeOverideFromList(f.modifiedObjectsInitial,h))}else{var c=s;if(!v)for(;s&&!g.isPLMNode(s.getLastElement(!0))&&!f._isReferenceOrInst(s.getLastElement(!0));)s=s.getParentPath();if(s){var h=t.getSceneGraphOverride(s);if(f.modifiedRoot){(p=i.getConcatinatedOverride(c,a))&&(i.deleteOverride(p),f._removeOverideFromList(f.modifiedObjectsConcatinated,p)),t.setVisibility(s,!0),f._getOverridesFromPathElement(s)||f.modifiedObjectsInitial.push(h);var u=i.createAndModifyConcatinatedOverrides(c,!1);f.modifiedObjectsConcatinated.push(u)}else t.deleteOverride(h),f._removeOverideFromList(f.modifiedObjectsInitial,h)}}else if(d){t.setVisibility(s,!1),(h=t.getSceneGraphOverride(s))&&(f._getOverridesFromPathElement(s)||f.modifiedObjectsInitial.push(h))}else{c=s;if(!v)for(;s&&!g.isPLMNode(s.getLastElement(!0))&&!f._isReferenceOrInst(s.getLastElement(!0));)s=s.getParentPath();if(s){h=t.getSceneGraphOverride(s);if(f.modifiedRoot){var p=i.getConcatinatedOverride(c,a);t.deleteOverride(h),p&&i.deleteOverride(p),f._removeOverideFromList(f.modifiedObjectsInitial,h),p&&f._removeOverideFromList(f.modifiedObjectsConcatinated,p)}else{t.setVisibility(s,!1),(h=t.getSceneGraphOverride(s))&&(f._getOverridesFromPathElement(s)||f.modifiedObjectsInitial.push(h))}}}}e.render({updateInfinitePlane:!0}),l.publish(f._ctx,"3DPLAY/HIDE",{ctx:f._ctx,data:n});require(["DS/PADUtils/PADContext"],(function(t){t.get().getHideShowController().publish({event:"onHide",data:{nodes:[S(e)]}}),n=null}))},s={type:this.contextualMenu.Button.Check,onclickCB:function(t){if(!f.preventDoubleClick){f.preventDoubleClick=!0,f.token&&(o._modelEvents.unsubscribe(f.token),f.token=null);var i=f.sceneGraphState,n=f.sceneGraphStateIsolate,r=S(e),s=f.modifiedObjectsInitial?f.modifiedObjectsInitial.length:0;i.deleteOverrides(f.modifiedObjectsInitial),f.modifiedObjectsInitial=[],n.deleteOverrides(f.modifiedObjectsConcatinated),f.modifiedObjectsConcatinated=[],f.modifiedRoot&&(n.deleteOverride(f.modifiedRoot),f.modifiedRoot=null),0===e.getVisibleSpace()&&e.swapVisibleSpace(),!0===f.isIsolateOn&&(f.isIsolateOn=!1,f.uncheckIsolate&&f.uncheckIsolate()),f.clearSelection(),l.publish(f._ctx,"3DPLAY/SHOW_ALL",{ctx:f._ctx});require(["DS/PADUtils/PADContext"],(function(e){var t=s;e.get().getHideShowController().publish({event:"onShow",data:{nodes:[r],modifiedObjectsLength:t}}),r=null})),setTimeout((function(){f.token=o.onAdd(a),a()}),200),setTimeout((function(){f.preventDoubleClick=!1}),1e3),f.uncheckShowAll=t.uncheck,setTimeout((function(){f.uncheckShowAll()}),200),e.render({updateInfinitePlane:!0})}},id:"ShowAll",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D"},u={type:this.contextualMenu.Button.Check,onclickCB:function(t){f.clearSelection(),e.swapVisibleSpace(),!0===f.isIsolateOn&&(f.isIsolateOn=!1,f.uncheckIsolate&&f.uncheckIsolate()),f.uncheckHideShowReversal=t.uncheck,setTimeout((function(){f.uncheckHideShowReversal()}),200),e.render({updateInfinitePlane:!0})},id:"HideShowReversal",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D"},m={type:this.contextualMenu.Button.Check,onclickCB:function(e){!1===f.isIsolateOn?(f.isIsolateOn=!0,f.uncheckIsolate=e.uncheck):f.isIsolateOn=!1},id:"HideShowIsolate",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D"};this.contextualMenuToken=this.contextualMenu.addButtons([s,u,m],{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.token=o.onAdd(a);f.contextualMenu.panel.container.buttons[0];a();var _=this.framewindow.getMAB();_&&_.onVisibilityChangeSubscribe("3DPlay-VisibilityCommands",(function(e){f.framewindow.experience.notifScreen&&!f.msgdisplayed&&(f.framewindow.experience.notifScreen.removeNotifications(),l.sendEvent(f._ctx,eventType.notif,h.info,{msg:p.visibilityAssistance}),f.msgdisplayed=!0)})),r.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!0}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!1,"FLY_WALK")},isolateCurrentObjects:function(e){if(e&&e.length){var t=f.framewindow.getViewer(),i=S(t),n=f.sceneGraphState,o=f.sceneGraphStateIsolate;if(n.deleteOverrides(f.modifiedObjectsInitial),f.modifiedObjectsInitial=[],o.deleteOverrides(f.modifiedObjectsConcatinated),f.modifiedObjectsConcatinated=[],f.modifiedRoot&&(o.deleteOverride(f.modifiedRoot),f.modifiedRoot=null),0===t.getVisibleSpace())for(var a=0;a<e.length;a++){var r=e[a].pathElement||e[a];if(!(c=f._checkIfAnnotationSelected(r))&&!v)for(;r&&!g.isPLMNode(r.getLastElement(!0))&&!f._isReferenceOrInst(r.getLastElement(!0));)r=r.getParentPath();if(r)n.setVisibility(r,!1),(u=n.getSceneGraphOverride(r))&&(f._getOverridesFromPathElement(r)||f.modifiedObjectsInitial.push(u))}else{var l=function(e){var t=new s;return t.addElement(e),e.children&&e.children.length>0&&t.addElement(e.children[0]),t}(i);o.setVisibilityOnRoot(l,!1);var d=o.getRootsAndConcatinatedPaths(i);f.modifiedRoot=d.mainroot;for(a=0;a<e.length;a++){var c,h=r=e[a].pathElement||e[a];if(!(c=f._checkIfAnnotationSelected(r))&&!v)for(;r&&!g.isPLMNode(r.getLastElement(!0))&&!f._isReferenceOrInst(r.getLastElement(!0));)r=r.getParentPath();if(r)if(n.setVisibility(r,!0),(u=n.getSceneGraphOverride(r))&&!f._getOverridesFromPathElement(r)&&(f.modifiedObjectsInitial.push(u),!1===c)){var u=o.createAndModifyConcatinatedOverrides(h,!1);f.modifiedObjectsConcatinated.push(u)}}var p=f._getAllAnnotations(i);if(p&&p.length>0)for(a=0;a<p.length;a++){r=p[a];(u=n.getSceneGraphOverride(r))&&(f._getOverridesFromPathElement(r)||(n.setVisibility(r,!1),f.modifiedObjectsInitial.push(u)))}}f.isIsolateOn=!1,f.uncheckIsolate&&f.uncheckIsolate(),f.clearSelection(),t.render({updateInfinitePlane:!0})}},endExecute:function(){f.msgdisplayed=!1,c.endCommand("command-"+this.getId()),this.framewindow.experience.notifScreen.removeNotifications();let e=this.framewindow.getMAB();e&&(e.onVisibilityChangeUnsubscribe("3DPlay-VisibilityCommands"),e.showFlyout(0)),this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenu=void 0,this.token&&(o._modelEvents.unsubscribe(this.token),this.token=null),this.clearSelection(),this.prepicking.restore(),this.myDestroy&&this.myDestroy(),this.myDestroy=null,this.frameWindow=void 0,this.modifiedRoot=void 0,this.modifiedOpaqueRoot=void 0,this.modifiedObjectsConcatinated=[],this.modifiedObjectsInitial=[],r.publish({event:"/VISU/onFlyWalkStateOverride",data:{eventChannel:"/VISU/onFlyWalkStateOverride",eventType:"@onFlyWalkStateOverride",viewer:this.getFrameWindow().getViewer(),forceHideUI:!1}}),this.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!0,"FLY_WALK"),this.AFR2_Done()},_checkIfAnnotationSelected:function(e){var t=!1;if(e&&e.externalPath)for(var i=0;i<e.externalPath.length;i++)if("annotGroupNode"===e.externalPath[i].name){t=!0;break}return t},_getAllAnnotations:function(e){var t=[],n=void 0;if(e.children&&e.children.length>0)for(i=0;i<e.children.length;i++)if("annotGroupNode"===e.children[i].name){n=e.children[i];break}if(n)for(i=0;i<n.children.length;i++)if(n.children[i])for(var o=0;o<n.children[i].children.length;o++){var a=new s;a.addElement(e),a.addElement(n),a.addElement(n.children[i]),a.addElement(n.children[i].children[o]),t.push(a)}return t},_removeOverideFromList:function(e,t){var i,n,o="";if(t._pathes.length)for(i=0;i<t._pathes.length;i++){o+=t._pathes[i].getKey()}for(i=0;i<e.length;i++){var a="";if((n=e[i])._pathes.length)for(var r=0;r<n._pathes.length;r++){a+=n._pathes[r].getKey()}if(a&&o&&o===a){e.splice(i,1);break}}},_getOverridesFromPathElement:function(e){return this._buildPathElementToOverridesMap()[e.getKey()]||null},_buildPathElementToOverridesMap:function(){var e,t,i={};for(e=0;e<this.modifiedObjectsInitial.length;e++)t=this.modifiedObjectsInitial[e],this._addOverrideToMap(t,i);return i},_addOverrideToMap:function(e,t){var i,n,o;for(i=0;i<e._pathes.length;i++)(o=t[n=e._pathes[i].getKey()])||(o=[],t[n]=o),o.push(e)},_isReferenceOrInst:function(e){return!(!e||""===e.productType)},clearSelection:function(){o.empty(),n.empty(),a.empty(),this.framewindow.getViewer().render({updateInfinitePlane:!0})},destroy:function(){this.sceneGraphState&&(this.sceneGraphState.dispose(),this.sceneGraphState=null),this.sceneGraphStateIsolate&&(this.sceneGraphStateIsolate.dispose(),this.sceneGraphStateIsolate=null),this._token_swapVisibleSpace=null,f=null}});return _}));var transparencyVal=.1;define("DS/3DPlayCommands/FunctionExplode",["DS/3DPlay/3DPlay","UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/VisuEvents/EventsManager","DS/WebUtils/State","DS/3DPlayUtils/VisibilityUtils","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/WebViewer/SceneGraphHelper","DS/3DPlayCommands/ExplodeUI","DS/WebUtils/Tracker","DS/WebUtils/Profiler","css!DS/3DPlayCommands/CmdExplode"],(function(e,t,i,n,o,a,r,s,l,d,c,h,u,p,m){"use strict";var g,f=function(e,t){var i=t.filter((function(e){return g.isInstance(e)||g.isRepInstance(e)})).length>0;return t.length>1&&(g.isInstance(e)||i&&g.isRepInstance(e))},S=function(e,t,i,n){return{path:t,explodeVector:function(e){var t=e.getMatrix().clone(),o=e.bSphere.center.clone();return n.applyMatrix4(i),o.applyMatrix4(t).applyMatrix4(i).sub(n)}(e)}},v=function(e){for(var t=[],i=e.parents[0];i;)t.push(i),i=i.parents[0];var o=new n;return o.setFromArray(t),o};return t.Class.extend({begin:function(e){this.beginExecute(e)},end:function(e){this.endExecute(e)},init:function(e,t){g=t,this.frameWindow=e.frameWindow,this.viewer=this.frameWindow.getViewer(),this._exp=this.frameWindow.experience,void 0!==this._exp&&(this._exp.registerCollabAction("translateExplode",this.translate.bind(this)),this._exp.registerCollabAction("transparencyExplode",this.applyTrans.bind(this))),this._profiling=!1},dispose:function(){this.frameWindow=null,this.viewer=null,this._explodeUI.dispose(),this._explodeUI=null,this.sceneGraphState=null},addUIControls:function(){},_explode:function(e){var t,i,n=this._explodeStateStack[this._explodeStateStack.length-1];n.manipulationOverrideSet&&(this._overrideSetManager.removeSceneGraphOverrideSet(n.manipulationOverrideSet),n.manipulationOverrideSet=null),t=performance?performance.now():null,this.createExplodedView(e,n),i=performance?performance.now():null,this.viewer.render({updateInfinitePlane:!0}),this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("explodeExplode",e),this._profiling&&i&&t&&(this._execTimeArray.push(i-t),this._frameTimeArray.push(p.getTime("webApplication::frame")))},_saveInitialWorldMatrices:function(){var e,t,n,o,a=(e=this._rootNode,t=function(e){var i=[];for(let a=0;a<e.children.length;a++){var o=e.children[a];n(o)&&i.push(o),i.concat(t(o))}return i},n=function(e){return!!e.getMatrixWorld()&&!e.getMatrixWorld().equals(new i.Matrix4)},o=t(e),n(e)&&o.push(e),o);this._overrideSetSavedWorldMatrices=this._createSceneGraphOverrideSet("WorldMatrixSave");for(let e=0;e<a.length;e++){var r=a[e];this._overrideSetSavedWorldMatrices.createOverride(v(r)).setPosition(r.getMatrixWorld())}},createExplodedView:function(e,t){var n=t.partList;if(n&&n.length){for(var o=Math.floor(t.explodeValue*t.levelNumber),a=Math.floor(e*t.levelNumber),r=Math.abs(a-o)+1,s=1e4,l=e*s%(1/t.levelNumber*s)/s*t.levelNumber*2,d=0;d<r;d++){var c=Math.min(o,a)+d,h=l;c<a&&(h=2);for(var u=0;u<n[c].length;u++){var p=n[c][u],m=new i.Matrix4,g=p.path.getParentPath().getLastElement();c<=a&&m.setPosition(p.explodeVector.clone().multiplyScalar(h)),m=g.getMatrix().multiply(m).clone(),p.override.setPosition(m)}}t.explodeValue=e}},_createState:function(e,t,i){for(var n=this._createSceneGraphOverrideSet(),o=function(e,t){var i=[];function n(e,t){return e.path.getLength()<t.path.getLength()?-1:e.path.getLength()>t.path.getLength()?1:0}!function e(t,n,o){for(var a=t.children,r=0;r<a.length;r++){var s=t.children[r],l=n.clone();l.addElement(s);var d=t.getMatrix().clone(),c=t.bSphere.center.clone();i[o]||(i[o]=[]),i[o].push(S(s,l,d,c)),e(s,l,f(s,a)?o+1:o)}}(e,t,0);for(var o=0;o<i.length;o++)i[o].sort(n);return i}(e,t),a=0;a<o.length;a++)for(var r=0;r<o[a].length;r++)o[a][r].override=n.createOverride(o[a][r].path);return{explodeOverrideSet:n,manipulationOverrideSet:this._createSceneGraphOverrideSet("SGOverrideSet ExplodeManualManip"),rootNode:e,rootPath:t,partList:o,levelNumber:o.length-1,startingLevel:i,explodeValue:0}},deleteExplodedView:function(e){void 0!==e.saveMatrix&&delete e.saveMatrix,void 0!==e.saveCenter&&delete e.saveCenter,void 0!==e.exVector&&delete e.exVector,e.explodeVisibility&&delete e.explodeVisibility;for(var t=e.children.length,i=0;i<t;i++)this.deleteExplodedView(e.children[i])},applyTrans:function(e){var t=e[0],i=e[1];this.applyTransparentSelection(t,i)},applyTransparentSelection:function(e,t){var i=this.viewer,n=[];if(e.forEach((function(e){null!=e&&null!=e.pathElement&&n.push(e.pathElement)})),"add"==t)1!=i.isAllTransparent&&(l.applyTransparencyToObjects(this.sceneGraphState,[this._rootPath],transparencyVal,!0),i.isAllTransparent=!0),l.applyTransparencyToObjects(this.sceneGraphState,n,1,!0);else if("remove"==t)l.applyTransparencyToObjects(this.sceneGraphState,n,transparencyVal,!0);else if("empty"==t){var o=this.sceneGraphState.getOverridesFromPathElement(this._rootNode);o&&o.forEach((function(e){e.getOpacity()&&e.getPathes().forEach((function(e){this.sceneGraphState.setOpacity(e,null)}),this)}),this),i.isAllTransparent=void 0}a.empty(),i.render(),this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("transparencyExplode",[e,t])},beginExecute:function(e){var t,i,o;if(this._pad3DViewerController=this._exp&&this._exp.pad3DViewer&&this._exp.pad3DViewer.getController(),this._pad3DViewerController&&this._pad3DViewerController.isLargeSession&&this._pad3DViewerController.pauseProgressiveLoading(),this._rootNode=(t=this.viewer,(i=this._exp)&&(o=i.getRootBag()),o||t.getNodes().forEach((function(e){"RootBag"===e.name&&(o=e)})),o),this._rootPath=new n,this._rootPath.addElement(this._rootNode),this._overrideSetManager=this.viewer.getSceneGraphOverrideSetManager(),this._saveInitialWorldMatrices(),this._initExplodeStructure(),this._explodeUI=new h({frameWindow:this.frameWindow,explodeFunction:this._explode.bind(this),totalSteps:this._explodeStateStack[0].levelNumber,withBeginAndEndButtons:!1}),this._explodeUI.show(),this._doubleClickCount=0,this._translateCount=0,this._currentlyTranslating=!1,this.addUIControls(),!this.sceneGraphState)if(this.viewer.createSceneGraph)this.sceneGraphState=this.viewer.createSceneGraph("ExplodeSG",this._rootNode);else{var a=function(e){var t=this.viewer.getSceneGraphOverrideSetManager();if(t)for(var i=t.getNumberOfSceneGraphOverrideSets();i--;){var n=t.getSceneGraphOverrideSetAt(i);if(n&&n.helper&&n.helper.name===e)return n.helper}return null};this.sceneGraphState=function(e,t){var i=a.apply(this,[t]);if(!i){var n=new d(e),o=this.viewer.getSceneGraphOverrideSetManager();o&&o.pushSceneGraphOverrideSet(n)&&(i=n.helper=new c(n,t))}return i}.apply(this.viewer,[this._rootNode,"ExplodeSG"])}l.setVisibilityOfAnnotations(this.viewer,!1,this._rootNode),l.setVisibilityOfSectionsAndMeasures(this.viewer,!1,this._rootNode);var u=this.viewer;this.Shadow=new s({getValue:function(){return u.getShadow()},restore:function(){u.setShadow(this.getInitialValue())}}),this.picking=new s({getValue:function(){return u.picking.displayHL},restore:function(){u.setPicking({displayHL:this.getInitialValue()})}}),this.prepicking=new s({getValue:function(){return u.pPicking.activated},restore:function(){u.setPrePicking({activated:this.getInitialValue()})}}),this.viewer.setPicking({displayHL:!0}),this.viewer.setPrePicking({activated:!0});e&&e.data&&!0===e.data.animateOnBegin&&this._explodeUI.play(.5),this._pointerDownToken=r.addEvent(this.viewer.canvas,"onLeftMouseDown",this._onPointerDownCB.bind(this)),this._touchToken=r.addEvent(this.viewer.canvas,"onTouch",this._onPointerDownCB.bind(this)),this._doublePointerClickCB=r.addEvent(this.viewer.canvas,"onPrimaryPointerDoubleClick",this._onPointerDoubleClickCB.bind(this)),this._profiling&&(this._execTimeArray=[],this._frameTimeArray=[])},endExecute:function(e){if(this._explodeUI.dispose(),this._explode(0),this._explodeStateStack.length>1&&this._returnToRootDepth(),this.picking.restore(),this.Shadow.restore(),this.prepicking.restore(),this.deleteExplodedView(this._rootNode),l.setVisibilityOfAnnotations(this.viewer,!0,this._rootNode),l.setVisibilityOfSectionsAndMeasures(this.viewer,!0,this._rootNode),this._overrideSetManager.removeSceneGraphOverrideSet(this._overrideSetSavedWorldMatrices),this._explodeStateStack.forEach(function(e){this._overrideSetManager.removeSceneGraphOverrideSet(e.explodeOverrideSet),this._overrideSetManager.removeSceneGraphOverrideSet(e.manipulationOverrideSet)}.bind(this)),this._explodeStateStack=[],this._pointerDownToken&&(r.removeEventFromToken(this._pointerDownToken),delete this._pointerDownToken),this._touchToken&&(r.removeEventFromToken(this._touchToken),delete this._touchToken),this._doublePointerClickCB&&(r.removeEventFromToken(this._doublePointerClickCB),delete this._doublePointerClickCB),this._pad3DViewerController&&(this._pad3DViewerController.resumeProgressiveLoading(),this._pad3DViewerController=null),this._doubleClickCount&&u.trackPageEvent("commands","explode","Subassembly",this._doubleClickCount),this._translateCount&&u.trackPageEvent("commands","explode","Displacement",this._translateCount),this._profiling){var t=this._execTimeArray.reduce((function(e,t,i,n){return e+t/n.length}),0),i=this._execTimeArray.reduce((function(e,t){return Math.min(e,t)})),n=this._execTimeArray.reduce((function(e,t){return Math.max(e,t)}));console.log("==== Explode Time ===="),console.log("Explode time average: "+t),console.log("Explode time min: "+i),console.log("Explode time max: "+n),this._execTimeArray=null;t=this._frameTimeArray.reduce((function(e,t,i,n){return e+t/n.length}),0),i=this._frameTimeArray.reduce((function(e,t){return Math.min(e,t)})),n=this._frameTimeArray.reduce((function(e,t){return Math.max(e,t)}));console.log("==== Frame Time ===="),console.log("Frame time average: "+t),console.log("Frame time min: "+i),console.log("Frame time max: "+n),this._frameTimeArray=null}},_onPointerDoubleClickCB:function(e){var t=this.viewer.getMousePosition(e.from[0].getCurrentPosition(this.viewer.canvas)),i=this.viewer.pick(t,"mesh",!1),n=null;if(i&&i.path&&i.path.length>0&&(n=i.path[0].clone()),n){var o,a=null,r=this._explodeStateStack[this._explodeStateStack.length-1],s=Math.max(0,Math.floor(r.startingLevel+this._explodeUI.getCurrentStep())),l=[],d=function(e){var t=e.getParentOccurrencePath();if(null!=t){var i=t.getLastElement(!0);t.getParentPath()&&f(i,t.getParentPath().getLastElement().getChildren())&&l.unshift(t),d(t)}else o=e};d(n),this.realRoot=o,(a=l[s])||(a=n),this._explodeStateStack.length>1&&r.rootPath&&!this._isADescendantOf(a,r.rootPath)&&(this._returnToRootDepth(),r=this._explodeStateStack[this._explodeStateStack.length-1],s=Math.max(0,Math.ceil(r.startingLevel+this._explodeUI.getCurrentStep())-1),(a=l[s])||(a=n));var c=a.getLastElement(!0),h=this._createState(c,a,s+1);this._explodeStateStack.push(h),this._explodeUI.setTotalStepCount(h.levelNumber),this._explodeUI.setValue(h.explodeValue),this._explodeUI.play(.5),this.viewer.currentViewpoint.reframeOn(200,[a]),this.applyTransparentSelection([],"empty"),this.applyTransparentSelection([{pathElement:a}],"add"),this._doubleClickCount++}else this._explodeStateStack.length>1&&(this._returnToPreviousDepth(),this._doubleClickCount++)},_onPointerDownCB:function(e){if(e&&e.from[0]&&e.from[0].event&&e.from[0].event.target&&"CANVAS"===e.from[0].event.target.nodeName)if(this._pointerUpToken)this._disposeEvents(e);else{this._pointerUpToken||(this._pointerUpToken=r.addEvent(this.viewer.canvas,"onPrimaryPointerUpUnique",this._onPointerUp.bind(this)));var t,o=this.viewer.getMousePosition(e.from[0].getCurrentPosition(this.viewer.canvas)),a=this.viewer.pick(o,"mesh",!0);if(a&&a.path&&a.path.length>0&&(t=a.path[0].clone()),t){var s=this._explodeStateStack[this._explodeStateStack.length-1];if(t&&this._explodeStateStack.length>1){var l=performance?performance.now():null,d=this._isADescendantOf(t,s.rootPath),c=performance?performance.now():null;if(this._profiling&&l&&c&&console.log("Time for descendant check : "+(c-l)),!d)return void this.viewer.setPicking({displayHL:!1})}this.viewer.currentViewpoint.setControlActive({viewpoint:!1}),s.manipulationOverrideSet||(s.manipulationOverrideSet=this._createSceneGraphOverrideSet("SGOverrideSet ExplodeManualManip")),this.viewerPrePicking=this.viewer.pPicking.activated,this.viewer.setPrePicking({activated:!1}),this.viewer.setPicking({displayHL:!0});var h,u,p,m=null,g=Math.max(0,Math.floor(s.startingLevel+this._explodeUI.getCurrentStep())),S=(h=this.viewer,u=h.getNodes(),p=[],u.forEach((function(e){var t=new n;t.addElement(e),p.push(t)})),[]),v=function(e){var t=e.getParentOccurrencePath();if(null!=t){var i=t.getLastElement(!0);t.getParentPath()&&f(i,t.getParentPath().getLastElement().getChildren())&&S.unshift(t),v(t)}};v(t),(m=S[g])||(m=t);var _=a.position.clone(),w=(new i.Vector3).subVectors(this.viewer.currentViewpoint.target,this.viewer.currentViewpoint.position).normalize(),x=new i.Plane(w,0).setFromNormalAndCoplanarPoint(w,_);this._initInfos={data:e,pickInfo:a,pathElementToMove:m,plane3D:x,mousePos:o},this._isDragging=!1,this._lastPosition=_,this._pointerDragToken||(this._pointerDragToken=r.addEvent(this.viewer.canvas,"onPrimaryPointerMoveUnique",this._translate()))}}},_onPointerUp:function(){this._disposeEvents(),this._currentlyTranslating&&(this._currentlyTranslating=!1,this._translateCount++)},_translate:function(){var e=this;return function(t){if(e._initInfos&&e._lastPosition){var n=e.viewer.getMousePosition(t.from[0].getCurrentPosition(e.viewer.canvas));if(!e._isDragging){var o=e._initInfos.mousePos;if(Math.max(Math.abs(n.xPix-o.xPix),Math.abs(n.yPix-o.yPix))<3)return;e._isDragging=!0}var a=e.viewer.pick(n,"mesh",!1).ray.intersectPlane(e._initInfos.plane3D),r=e._initInfos.pathElementToMove,s=(new i.Vector3).subVectors(a,e._lastPosition),l=e._explodeStateStack[e._explodeStateStack.length-1];e._translateWithOverrideSet(r,s,l.manipulationOverrideSet),e._lastPosition=a.clone(),e._currentlyTranslating=!0}}},_disposeEvents:function(e){this._pointerDragToken&&r.removeEventFromToken(this._pointerDragToken),this._pointerDragToken=null,this._pointerUpToken&&r.removeEventFromToken(this._pointerUpToken),this._pointerUpToken=null,this.viewer.currentViewpoint.setControlActive({viewpoint:!0}),this.viewerPrePicking&&this.viewer.setPrePicking({activated:this.viewerPrePicking}),delete this.viewerPrePicking,this._initInfos=null,this._translateCB=null,this._disposeCB=null,this._isDragging=!1},_createSceneGraphOverrideSet:function(e){var t=null;return this._rootNode&&(t=new d(this._rootNode),this._overrideSetManager.pushSceneGraphOverrideSet(t),e&&(t.name=e)),t},translate:function(e){var t=this._exp.createPathFromId(e[0],this.viewer),i=e[1],n=this._explodeStateStack[this._explodeStateStack.length-1];n.manipulationOverrideSet||(n.manipulationOverrideSet=this._createSceneGraphOverrideSet("SGOverrideSet ExplodeManualManip")),this._translateWithOverrideSet(t,i,n.manipulationOverrideSet)},_translateWithOverrideSet:function(e,t,n){if(n){var o=e,a=o.getParentPath().getWorldMatrix(this._viewer),r=(new i.Matrix4).getInverse(a),s=(new i.Matrix4).extractRotation(r),l=(new i.Vector3).copy(t).applyMatrix4(s),d=o.getMatrix(this._viewer);if(d){var c=(new i.Vector3).getPositionFromMatrix(d).add(l);d.setPosition(c);var h=n.getUniqueOverrideFromPathElement(o);if((h||(h=n.createOverride(o)))&&(h.setPosition(d),this.viewer.render(),this._exp.notifyAction&&!0===this._exp.collabMode)){var u=this._exp.createIdFromPath({pathElement:e},this.viewer);this._exp.notifyAction("translateExplode",[u,t])}}}else console.warn("FunctionExplode::_translateWithOverrideSet() : No Override Set given")},_initExplodeStructure:function(){var e=performance?performance.now():null,t=this._createState(this._rootNode,this._rootPath,0);this._explodeStateStack=[t];for(var i=t.partList,n=0;n<i.length;n++)for(var o=0;o<i[n].length;o++){var a=i[n][o],r=a.path.getParentPath().getLastElement();a.override.setPosition(r.getMatrix())}var s=performance?performance.now():null;this._profiling&&e&&s&&console.log("Init explode structure time : "+(s-e)+"ms")},_returnToRootDepth:function(){for(var e=this._explodeStateStack.length-1;e>=1;e--)this._returnToPreviousDepth()},_returnToPreviousDepth:function(){if(!(this._explodeStateStack.length<=1)){var e=this.viewer.getSceneGraphOverrideSetManager(),t=this._explodeStateStack.pop();e.removeSceneGraphOverrideSet(t.explodeOverrideSet),e.removeSceneGraphOverrideSet(t.manipulationOverrideSet);var i=this._explodeStateStack[this._explodeStateStack.length-1],n=i.manipulationOverrideSet;this.viewer.currentViewpoint.reframeOn(200,[i.rootPath]),this._explodeUI.setTotalStepCount(i.levelNumber),this._explodeUI.setValue(i.explodeValue),this._overrideSetManager.pushSceneGraphOverrideSet(n),i.manipulationOverrideSet=n,this.applyTransparentSelection([],"empty"),this._explodeStateStack.length>1&&this.applyTransparentSelection([{pathElement:i.rootPath}],"add")}},_isADescendantOf(e,t){for(var i=e.clone(),n=t.clone(),o=i.isEqual(n);!o&&(i=i.getParentPath());)i.isEqual(n)&&(o=!0);return o}})})),define("DS/3DPlayCommands/CmdExplode",["DS/3DPlayWAFRMigration/Command","DS/WebUtils/Tracker","DS/3DPlayWAFRMigration/CommandsManager","DS/3DPlayCommands/FunctionExplode","DS/3DPlayCommands/ExplodeServices"].concat(["DS/3DPlayExperienceModule/SceneGraphNodeServices"]),(function(e,t,i,n,o,a){"use strict";var r;return e.extend({init:function(e){r=this,this._parent(e,{isAsynchronous:!0});var t=this.getFrameWindow(),i=t.experience;o.init(i,t.getViewer()),this._exp=i,void 0!==this._exp&&(this.executionContext||o.registerExplodeCollab("explodeBeginExecute",(function(){r.beginExecute()})),this._exp.registerCollabAction("explodeSetValue",this.setExplodeTimelineValue.bind(this)),this._exp.registerCollabAction("explodeEndExecute",this.endExecute.bind(this)))},_destroy:function(){r=null,this.executionContext||o.unsubscribeFromSpread(),this._onModelLoadingFinshedToken&&this.getFrameWindow().experience.unsubscribe(this._onModelLoadingFinshedToken),this.exp&&this._isRunning&&this.exp.end(),this.exp&&(this.exp.dispose(),this.exp=null),this._parent()},beginExecute:function(){o.pauseSpread(!0),t.startCommand("EnhancedExplode"),o.launchedFromSpread&&t.trackPageEvent("commands","explode","SpreadLaunch",1);var e={animateOnBegin:!o.launchedFromSpread};o.launchedFromSpread=!1,this.exp||(this.exp=new n({frameWindow:this.getFrameWindow(),ctx:this._ctx},a)),this.exp.begin({data:e}),this._exp.notifyAction&&!0===this._exp.collabMode?this._exp.notifyAction("explodeBeginExecute"):0==this._isRunning&&(this._isRunning=!0)},endExecute:function(){t.endCommand("EnhancedExplode"),this._isRunning&&this.exp&&this.exp.end(),this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("explodeEndExecute"),o.pauseSpread(!1),this.AFR2_Done()},setExplodeTimelineValue:function(e){this.exp._explodeUI.setValue(e),this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("explodeSetValue")}})})),define("DS/3DPlayCommands/CmdEnhancedExplode",["DS/3DPlayCommands/CmdExplode"],(function(e){"use strict";return e}));