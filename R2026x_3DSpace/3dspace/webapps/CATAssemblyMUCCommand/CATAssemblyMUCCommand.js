define("DS/CATAssemblyMUCCommand/CAT3DPlayMUCCmd",["UWA/Core","DS/CoreEvents/Events","DS/ApplicationFrame/Command","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/VisuEvents/EventsManager","DS/CATSolverCDSWeb/CATSolverCDSSolver","i18n!DS/CATAssemblyMUCCommand/assets/nls/CAT3DPlayMUCSplash","css!DS/CATAssemblyMUCCommand/assets/CAT3DPlayMUCSplash"],(function(e,t,i,n,s,o,r,a,l,h){"use strict";return i.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.is3dxml=null,this.pathOfMoving=null,this._largeSession=null,this._experienceBase=null,this._manipulationOverrideSet=null,this._NodeList=[],this._tokenChangeCurrentModel=t.subscribe({event:"Model.changeCurrent"},(e=>{this._reloadJson=!0})),this.canvasDiv=document.getElementById("canvas-div"),this.createMUCSplash()},getWidgetMessage:function(t){if(e.is(t,"string")){if(l[t])return l[t];console.error("Unable to find Nls key for :",t)}else console.error("Invalid nls key ",t)},createMUCSplash:function(){if(this.canvasDiv||(this.canvasDiv=document.getElementById("lightbox--content")),this.canvasDiv){if(this.mucSplash=document.getElementById("mucsplash_container"),!this.mucSplash){this.mucSplash=e.createElement("div",{id:"mucsplash_container",class:"mucsplash_container",styles:{display:"none"}}),this.mucSplash.inject(this.canvasDiv);let t=this.getWidgetMessage("MUC_SPLASH_LABEL");this.mucSplash.setContent({tag:"div",class:"mucsplash_container_msg",html:[{tag:"h3",id:"splash_msg",class:"font-3dsregular",html:t}]}),this.mucSplash.addContent({tag:"div",id:"mucsplash_display",class:"mucsplash_display"})}}else console.error("no canvas for MUC splash")},beginExecute:function(){this._parent();let e=this.getFrameWindow();this._experienceBase=e._experienceBase;let t=this._experienceBase.getManager("VCXContextManager");this._viewer=t.getMainViewer();let i=e.experience;this._pad3DViewerController=i&&i.pad3DViewer&&i.pad3DViewer.getController(),this._solver=new a;let n=i.getRootBag();this.is3dxml=window.is3dxml;var s=this;var o;o=window.cdsJSON,console.log("voici le json:\n",o),s._onCDSJSONLoaded(o),s._registerCallbacks(),s.mucSplash&&(s.mucSplash.setStyle("display","flex"),setTimeout((()=>{s.mucSplash.setStyle("display","none")}),5e3)),n.children[0].traverse((e=>{(e.getID?e.getID():e.id)&&this._NodeList.push(e)}))},_registerCallbacks:function(){this._tokens||(this._tokens={}),this._tokens.lmdToken||(this._tokens.lmdToken=r.addEvent(this._viewer.canvas,"onLeftMouseDown",this._onPointerDownCB.bind(this))),this._tokens.touchToken||(this._tokens.touchToken=r.addEvent(this._viewer.canvas,"onTouch",this._onPointerDownCB.bind(this))),this._tokens.touchTwoFingerTapToken||(this._tokens.touchTwoFingerTapToken=r.addEvent(this._viewer.canvas,"onTwoFingerTap",this._ResetSceneGraph.bind(this)))},pauseExecute:function(){},resumeExecute:function(){},endExecute:function(){this._parent();let e=this.getFrameWindow();if(!(e&&e.experience))return;t.unsubscribe(this._tokenSceneGraphUpdated),this._tokenSceneGraphUpdated=null,t.unsubscribe(this._tokenChangeCurrentModel),this._tokenChangeCurrentModel=null,this._onSpreadToken&&r.removeEventFromToken(this._onSpreadToken),this._onSpreadToken=null,r.removeEvent(this._viewer.canvas,"onPrimaryPointerDoubleClick",this._doublePointerClickCB);let i=e.experience,s=i.getRootBag(),o=s&&s.children[0];this._pad3DViewerController&&o&&o.modelIdentification&&(this._largeSession?(this._pad3DViewerController.resumeProgressiveLoading(),i.DynamicProgressUI&&i.DynamicProgressUI.play()):this._pad3DViewerController.unlockNodes({ids:this._leavesRefIDS}),this._leavesRefIDS=null,this._largeSession=null,this._pad3DViewerController=null),this._tokens&&(t.unsubscribe(this._tokens.pointerDownToken),this._tokens.pointerDownToken=null,this._tokens.lmdToken&&r.removeEventFromToken(this._tokens.lmdToken),this._tokens.lmdToken=null,this._tokens.touchToken&&r.removeEventFromToken(this._tokens.touchToken),this._tokens.touchToken=null,this._tokens.touchTwoFingerTapToken&&r.removeEventFromToken(this._tokens.touchTwoFingerTapToken),this._tokens.touchTwoFingerTapToken=null),this._tokens=null,this._solver.clean(),this._solver=void 0;let a=this._manipulationOverrideSet;n.removeSceneGraphOverrideSet(this._experienceBase,a,this._viewer),this._updateGroundIfExistsAndRender(),this._manipulationOverrideSet=null},_onPointerDownCB:function(e){let t=e?e.from[0]:null;if(!t||!t.event||!t.event.target||"CANVAS"!==t.event.target.nodeName)return;if(this._tokens.pointerUpToken)return void this._disposeEvents(e);this._tokens.pointerUpToken||(this._tokens.pointerUpToken=r.addEvent(this._viewer.canvas,"onPrimaryPointerUpUnique",this._disposeEvents.bind(this)));let i,o=this._viewer.getMousePosition(t.getCurrentPosition(this._viewer.canvas)),a=this._viewer.pick(o,"mesh",!0);if(a&&a.path&&a.path.length>0&&(i=a.path[0].clone()),!i)return;this._viewer.currentViewpoint.setControlActive({viewpoint:!1}),null===this._manipulationOverrideSet&&(this._manipulationOverrideSet=n.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer),this._manipulationOverrideSet.name="MUC ManualManip"),this.viewerPrePicking=this._viewer.pPicking.activated,this._viewer.setPrePicking({activated:!1});let l=i,h=a.position.clone(),u=(new s.Vector3).subVectors(this._viewer.currentViewpoint.target,this._viewer.currentViewpoint.position).normalize(),c=new s.Plane(u,0).setFromNormalAndCoplanarPoint(u,h);this._initInfos={data:e,pickInfo:a,pathElementToMove:l,plane3D:c,mousePos:o},this._isDragging=!1,this._lastPosition=h,this._tokens.pointerDragToken||(this._tokens.pointerDragToken=r.addEvent(this._viewer.canvas,"onPrimaryPointerMoveUnique",this._translateCB.bind(this))),this.pathOfMoving=l;let d=[];for(let e=0;e<l.getLength();e++){let t=l.getElement(e);t&&("Instance3D"===t.productType?d.push(t.persistentId):t.userData&&"VPMInstance"===t.userData.type&&d.push(t.modelIdentification))}this._solver.setMovingEntity(d.join("\\u0005"))},getMovingPath:function(){return this.pathOfMoving},_translateCB:function(e){if(!this._initInfos||!this._lastPosition)return;let t=this._viewer.getMousePosition(e.from[0].getCurrentPosition(this._viewer.canvas));if(!this._isDragging){let e=this._initInfos.mousePos;if(Math.max(Math.abs(t.xPix-e.xPix),Math.abs(t.yPix-e.yPix))<3)return;this._isDragging=!0}let i=this._viewer.pick(t,"mesh",!1).ray.intersectPlane(this._initInfos.plane3D),n=(new s.Vector3).subVectors(i,this._lastPosition).toArray(),o=(new s.Matrix4).makeRotationAxis(this._initInfos.pickInfo.ray.direction,0).elements,r={matrix:[o[0],o[1],o[2],o[4],o[5],o[6],o[8],o[9],o[10],n[0],n[1],n[2]]};this._solver.setMoveType("movebytransfo"),this._solver.setTarget(r);let a=this._solver.run(),l=this.getFrameWindow().experience;for(let e of a.results){let t=e.path.split("\\u0005"),i=this._getPathElementByInstancePath(l.getRootBag(),t),n=e.transfo.getArray(),o=new s.Matrix4(n[0],n[3],n[6],n[9],n[1],n[4],n[7],n[10],n[2],n[5],n[8],n[11],0,0,0,1);this.translateWithOverrideSet(i,o,this._manipulationOverrideSet)}this._lastPosition=i.clone()},_disposeEvents:function(){this._tokens.pointerDragToken&&r.removeEventFromToken(this._tokens.pointerDragToken),this._tokens.pointerDragToken=null,this._tokens.pointerUpToken&&r.removeEventFromToken(this._tokens.pointerUpToken),this._tokens.pointerUpToken=null,this._viewer.currentViewpoint.setControlActive({viewpoint:!0}),this.viewerPrePicking&&this._viewer.setPrePicking({activated:this.viewerPrePicking}),delete this.viewerPrePicking,this._initInfos=null,this._isDragging=!1},translateWithOverrideSet:function(e,t,i){let o=e.getWorldMatrix(this._viewer);if(!o)return;let r=(new s.Matrix4).multiplyMatrices(t,o),a=n.getSceneGraphOverride(i,null,e);if(!a)return;let l=e.getParentPath().getWorldMatrix();var h=(new s.Matrix4).getInverse(l);let u=(new s.Matrix4).multiplyMatrices(h,r);a.setPosition(u),this._updateGroundIfExistsAndRender()},_updateGroundIfExistsAndRender:function(){this._experienceBase.getManager("VCXContextManager").renderAll({updateInfinitePlane:!0})},_ResetSceneGraph:function(){let e=this._manipulationOverrideSet;n.removeSceneGraphOverrideSet(this._experienceBase,e,this._viewer),this._updateGroundIfExistsAndRender(),this._manipulationOverrideSet=null,null===this._manipulationOverrideSet&&(this._manipulationOverrideSet=n.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer),this._manipulationOverrideSet.name="MUC ManualManip"),this._solver.clean()},_getPathElementByNode:function(e,t){if(!e)return null;if(e===t)return new o([e]);for(const i of e.children){if(i===t)return new o([e,i]);const n=this._getPathElementByNode(i,t);if(n){let t=new o([e]);for(let e=0;e<n.getLength();++e)t.addElement(n.getElement(e));return t}}return null},_getPathElementByInstancePath:function(e,t){let i=e,n=[i];for(const e of t){let t=this._getPathElementById(i,e);if(t){for(let e=1;e<t.getLength();++e)n.push(t.getElement(e));i=t.getLastElement()}}return new o(n)},_getPathElementById:function(e,t){let i=this._getChildByName(e,t);return this._getPathElementByNode(e,i)},_getChildByName:function(e,t,i){let n=t;const s=e=>{for(const t of e.children){if((this.is3dxml?t.persistentId:t.modelIdentification)===n)return t;let e=s(t);if(null!==e)return e}return null},o=e=>{for(const i of e.parents){if(i.persistentId===t)return i;let e=o(i);if(null!==e)return e}return null};return void 0!==i&&i?o(e):s(e)},_onCDSJSONLoaded:function(e){try{this._solver&&(this._solver.initialize(e),this._solver.load())}catch(e){console.error("onCDSJSONLoaded: solver initialization failed")}}})}));