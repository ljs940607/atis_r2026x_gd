define("DS/DMUBaseUIWafrComponents/DMUApplicativeManagerComponent",["require","exports","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CATWebUXSlideShow/CATWebUXSlideShowController","UWA/Core","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseExperience/DMUContextManager"],(function(e,t,n,o,i,l,r,s,d){"use strict";class c{constructor(e){let t=this,n=null,o=null,i=null;const l={selection:100,preselection:500},s={selection:0,preselection:500};let d=r.createElement("div",{class:"CATWebUXtooltip"}).inject(e.targetDiv),c=r.createElement("div",{class:"CATWebUXtooltipbody"}).inject(d);d.style.display="none",d.style.visibility="hidden",d.style.opacity="0";const a=function(){"preselection"===n&&t.hide("preselection")},u=function(e){let t={x:0,y:0,width:275,height:0},n=d.getParent().getBoundingClientRect(),o=d.getBoundingClientRect();const i=n.right-e.position.x,l=e.position.x-n.left,r=e.position.y-n.top,s=n.bottom-e.position.y;e.width?i>=275?t.x=e.position.x:l>=275&&(t.x=e.position.x-e.width-t.width):t.x=(n.width-t.width)/2,e.width?(t.height=Math.min(n.height,o.height),t.y=Math.max(0,e.position.y+e.height/2-t.height/2)):r>=s?(t.height=Math.min(r,o.height),t.y=e.position.y-t.height):(t.height=Math.min(s,o.height),t.y=e.position.y+e.height),t.height<o.height?c.style.overflow="hidden scroll":c.style.overflow="hidden",c.style.width=t.width+"px",c.style.height=t.height+"px",d.style.top=t.y+"px",d.style.left=t.x+"px"},m=function(){c.style.width="unset",c.style.height="unset",c.style.overflow="hidden",d.style.top="unset",d.style.left="unset"};let h=function(){null!==i&&(clearTimeout(i),i=null)};const p=function(){null!==o&&(clearTimeout(o),o=null)};this.hide=function(e){"selection"===n&&"preselection"===e||(p(),o=setTimeout((()=>{d.style.opacity="0",document.addEventListener("transitionend",(()=>{c.innerHTML="",d.style.display="none",d.style.visibility="hidden",n=null,m()}),{once:!0}),o=null}),s[e]))},this.forceHide=function(){p(),d.style.opacity="0",c.innerHTML="",d.style.display="none",d.style.visibility="hidden",n=null,m()},this.show=function(e){"selection"===n&&"preselection"===e.triggerType||(n=e.triggerType,p(),h(),i=setTimeout((async()=>{this.forceHide();const t=e.getTooltip();if(!t)return;const o=await e.getPosition();o&&(n=e.triggerType,function(e){c.innerHTML="",c.appendChild(e)}(t),d.style.display="block",d.style.visibility="visible",d.style.opacity="100",u(o))}),l[e.triggerType]))},this.updatePosition=function(e){u(e)},this.dispose=function(){d.removeEventListener("mouseenter",p),d.removeEventListener("mouseleave",a),p(),h(),t.forceHide(),d.remove()},d.addEventListener("mouseenter",p),d.addEventListener("mouseleave",a)}}return class{constructor(e){let t,r,a,u,m,h,p,f,g=this,v=e.applicativeCommentControllerIDs,b={},O={},y=!1,C=function(e){let t=e[e.length-1],n=t.match(/^([^|:]*)([|:].*)?$/);return n?n.slice(1).map((e=>null!=e?e:"")):[t,""]},S=function(e){return e.map((e=>{let t=C([e.idPath]);return{idPath:[t[0]],attrName:t[1],pointedObjectPhysicalID:e.pointedObjectPhysicalID}}))},j=async function(e){for(let t of Object.values(O))if(t){let n=await t.getObjectPosition(e);if(n)return n}},P=function(e){let n=d.getReviewContext({context:t});return e.reduce(((e,t)=>{var o,i,l,r;if((null===(i=null===(o=null==t?void 0:t.pathElement)||void 0===o?void 0:o.getLastElement())||void 0===i?void 0:i.getDMUType)&&"DMUCommentOnTable"===(null===(r=null===(l=null==t?void 0:t.pathElement)||void 0===l?void 0:l.getLastElement())||void 0===r?void 0:r.getDMUType())){let o=null==n?void 0:n.getDMUObjectFromPathElement(t.pathElement);if("DMUCommentOnTable"===(null==o?void 0:o.getType())){let t=o.getPointedElement();t&&e.push({idPath:t})}}return e}),[])},w=function(){if(p)return;p=!0;let e=P(i.get());for(let t of Object.values(O))t&&t.preSelectObjects(e);p=!1},E=function(){if(p)return;p=!0;let e=P(o.get());for(let t of Object.values(O))t&&t.selectObjects(e);p=!1},M=function(e){p||(p=!0,h!==e.preSelectedObjects&&(h=e.preSelectedObjects,y&&f.hide("preselection")),r.preSelectCommentsFromPointedObjectsIdPath(e.preSelectedObjects.map((e=>({idPath:e.idPath})))),y&&1===e.preSelectedObjects.length&&f.show({getPosition:()=>j(e.preSelectedObjects[0]),getTooltip:()=>r.getCommentTooltipFromPointedObjectIdPath(e.preSelectedObjects[0]),triggerType:"preselection"}),p=!1)},D=function(e){if(p)return;p=!0,m!==e.selectedObjects&&(m=e.selectedObjects,y&&f.hide("selection")),n.empty(),r.selectCommentsFromPointedObjectsIdPath(e.selectedObjects.map((e=>({idPath:e.idPath}))));let t=S(e.selectedObjects);a&&(null==a||a.fireEvent("onApplicativeSelectionChanged",{listOfSelectedObjects:t})),y&&1===e.selectedObjects.length&&f.show({getPosition:()=>j(e.selectedObjects[0]),getTooltip:()=>r.getCommentTooltipFromPointedObjectIdPath(e.selectedObjects[0]),triggerType:"selection"}),p=!1};function x(e){let t=null==e?void 0:e.listOfSelectedObjects.map((e=>({idPath:e.idPath[e.idPath.length-1]+e.attrName})));for(let e of Object.values(O))e&&e.selectObjects(t||[])}let U=async function(e){if(e.currentGroupName&&r.scrollToContainer({containerName:e.currentGroupName}),y){let e=1===m.length?m[0]:1===h.length?h[0]:void 0;if(!e)return;for(let t of Object.values(O))if(t){let n=await t.getObjectPosition(e);n&&f.updatePosition(n)}}};function T(e){if(!(e&&e.dmuObject&&e.dmuObject.getPointedElement&&e.dmuObject.getPointedElement()))return;let t=e.dmuObject.getPointedElementInfo(),n=[];for(let e of Object.values(O))e&&n.push(e.addCommentOnObject({idPath:t.id}));if(n.every((e=>!1===e)))e.dmuObject.setAlertFlag(!0);else{let n=C([t.id]);n&&g.getDataOfObjectPointedByComment([{idPath:n[0],attrName:n[1]}]).then((t=>{let o=null==t?void 0:t.get(n[0]);o&&(e.dmuObject.setPointedElementInfo(o),e.dmuObject.getDMUComments().forEach((e=>{e.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:e})})))}))}}function A(e){if(!(e&&e.parentObject&&e.parentObject.getPointedElement&&e.parentObject.getPointedElement()))return;let t=e.parentObject.getPointedElement(),n=[];for(let e of Object.values(O))e&&n.push(e.deleteCommentOnObject({idPath:t}))}function I(e){if(!e)return;let t=new Map;t.add("processed",[]),t.add("withdrawn",[]),t.add("null",[]);for(let e of Object.values(O))e&&e.updateCommentStatus&&(e.updateCommentStatus(t.get("processed"),"processed"),e.updateCommentStatus(t.get("withdrawn"),"withdrawn"),e.updateCommentStatus(t.get("null"),null))}function F(e){y=e.state,e.state||f.forceHide();for(let t of Object.values(O))t&&t.setMinimalUIFlag&&t.setMinimalUIFlag(e.state)}function H(){null==r||r.cleanCommentsPanel()}function L(e){null==v||v.forEach((t=>{(null==e?void 0:e.getComponent(t))?(O[t]=null==e?void 0:e.getComponent(t),b[t]={onObjectPreSelected:O[t].subscribe("onObjectsPreSelected",M),onObjectSelected:O[t].subscribe("onObjectsSelected",D),onCurrentGroupChanged:O[t].subscribe("onCurrentGroupChanged",U)}):window.console.error("No component found for "+t)})),O&&0!==Object.keys(O).length&&(b.PSOManager={onPSOAdd:i.onAdd(w),onPSOEmpty:i.onEmpty(w),onPSORemove:i.onRemove(w)},b.HSOManager={onHSOAdd:o.onAdd(E),onHSORemove:o.onEmpty(E),onHSOEmpty:o.onRemove(E)},a||(a=d.getEventsController({viewer:null==t?void 0:t.getFrameWindow().getViewer()})),b.EventsController={onCommentStatusChanged:a.addEvent("onCommentStatusChanged",I),onDMUObjectInitialized:a.addEvent("onDMUObjectInitialized",T),onDMUCommentDeleted:a.addEvent("onDMUCommentDeleted",A),onApplicativeSelectionRequested:a.addEvent("onApplicativeSelectionRequested",x),onRootDataRemoved:a.addEvent("onRootDataRemoved",H)},u||(u=l.getSlideShowController({context:null==t?void 0:t.getFrameWindow(),id:"DMU3DMarkupSlideShow"})),b.slideShowController={onActiveStateModified:u.subscribe("onActiveStateModified",F)})}this.getCurrentSelection=function(){return m?S(m):[]},this.getDataOfObjectPointedByComment=async function(e){let t=e.map((e=>e.idPath)),n=function(e,t){return e.findIndex((e=>e.idPath===t))+1};for(let o of Object.values(O))if(o){let i=await o.getObjectGroups(t.map((e=>({idPath:e}))));if(i&&(!i.size||0===i.size))continue;const l=new Map,r=Array.from(i.keys());for(const t of e){const e=Array.from(i.entries());for(const[o,i]of e){let e=i.objects.find((e=>e.idPath===t.idPath)),s=n(i.objects,t.idPath+t.attrName);if(e){l.set(t.idPath,{index:s||1/0,group:{title:o,id:"",index:(void 0!==i.index?i.index:r.indexOf(o))+1}});break}}}return l}},this.initialize=function(){return new Promise((function(e){let n=g.getExecutionContext(),o=null==n?void 0:n.getComponent(WAfrStandardComponentKey.ModelEvents);t=null==n?void 0:n.getComponent("Viewer");let i=null==t?void 0:t.getFrameWindow();r=s.getDMUCommentsController({context:i,commandContext:t.getCommandContext()}),a=d.getEventsController({viewer:i.getViewer()}),u=l.getSlideShowController({context:i,id:"DMU3DMarkupSlideShow"}),o?(b.modelEvent={onDidLoadApp:""},b.modelEvent.onDidLoadApp=o.subscribe({event:"onDidLoadApp"},(function(){var e,t;L(n),(null===(e=b.modelEvent)||void 0===e?void 0:e.onDidLoadApp)&&o.unsubscribe(null===(t=b.modelEvent)||void 0===t?void 0:t.onDidLoadApp),b.modelEvent=void 0}))):L(n);let m=t.getFrameWindow().getImmersiveFrame().getFreeZone();f=new c({targetDiv:m}),e()}))},this.clean=function(){!function(){if(b.HSOManager){for(let e of Object.values(b.HSOManager))e&&o.unsubscribe(e);b.HSOManager=void 0}if(b.PSOManager){for(let e of Object.values(b.PSOManager))e&&i.unsubscribe(e);b.PSOManager=void 0}if(a&&b.EventsController){for(let e of Object.values(b.EventsController))e&&a.removeEvent(e);b.EventsController=void 0}if(u&&b.slideShowController){for(let e of Object.values(b.slideShowController))e&&u.unsubscribe(e);b.slideShowController=void 0}v.forEach((e=>{var t;if(b[e]){for(let n of Object.values(b[e]))n&&(null===(t=O[e])||void 0===t||t.unsubscribe(n));b[e]=void 0}delete O[e]})),v.length=0}();let e=null==t?void 0:t.getFrameWindow();return f.dispose(),s.unreferenceDMUCommentsController({context:e}),d.unreferenceEventsController({context:e}),l.unreferenceSlideShowController({context:e}),Promise.resolve()},this.destroy=function(){return Promise.resolve()}}}}));