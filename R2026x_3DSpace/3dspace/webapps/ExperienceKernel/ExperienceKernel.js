define("DS/ExperienceKernel/ExperienceKernel",["DS/ExperienceKernel/EKCuidImpl","DS/ExperienceKernel/EKBinaryHelpers"],(function(t,e){"use strict";return"undefined"!=typeof EK?EK:function(){const n={};n.window="undefined"!=typeof window?window:void 0,n.defaultsOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:void 0,webSocketPort:2097,urlQueryParameter:void 0,pool:"browser",ssl:!1,canDisconnectFromHypervisor:!0,onText:function(){return!0},onBinary:function(){return!0},onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},onHypervisorStopping:function(){},onNodeStopping:function(){},onDisconnect:function(){},onError:function(t){n.window.console.error(t)},authentication:function(t,e,i){n.defaultAuthentication(t,e,i)},tenant:""}),n.defaultsMultiplexerOptions=Object.freeze({onText:function(){return!0},onBinary:function(){return!0},join:function(){return!0}}),n.defaultsStoreOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:void 0,webSocketPort:2097,ssl:!1,canDisconnectFromHypervisor:!0,distant:!1,onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},onError:function(t){n.window.console.error(t)},authentication:function(t,e,i){n.defaultAuthentication(t,e,i)}}),n.Status=Object.freeze({pending:0,connected:1,disconnected:2}),n.TraceContext=function(){this.ekCurrentTraceId_=void 0,this.verbose_=!1},n.TraceContext.prototype.getEKCurrentTraceId=function(){return this.ekCurrentTraceId_},n.TraceContext.prototype.setEKCurrentTraceId=function(t){this.ekCurrentTraceId_=t||void 0},n.TraceContext.prototype._getEstimatedBinarySize=function(){return 38},n.TraceContext.prototype.SetVerboseMode=function(t){this.verbose_=t},n.TraceContext.prototype.GetVerboseMode=function(){return this.verbose_},n.TraceContext.prototype.write=function(t){const e={ek:this.ekCurrentTraceId_||""};void 0!==this.verbose_&&(e.v=this.verbose_),t.writeString(JSON.stringify(e))},n.TraceContext.read=function(t){var e=t.readString();try{var i=JSON.parse(e),s=((i?i.ek:"")||"").trim();if(s.length){const t=new n.TraceContext;return t.setEKCurrentTraceId(s),i&&i.rec&&t.setActivateRecord(),t}}catch(t){}},n.WebSocket=function(t){this.ws=null,this.monitor=null,this.callback=function(){return!0},this.onopen=[],this.onclose=[],this.inputs=[],this.outputs=[],this.waitingOutputs=[],this.connected=!1,this.waitRelease=!0===t};var i=Object.freeze({version:1}),s=Object.freeze({hypervisor:-2,unknown:0}),o=Object.freeze({myHypervisorId:0,noHypervisorId:16777215}),r=Object.freeze({webConnection:3,noConnection:4}),a=Object.freeze({noConstraint:0,onlyMyHypervisor:1,notMyHypervisor:2,preferMyHypervisor:3,identifier:5}),h=Object.freeze({none:0,channelRename:2,resultsSend:3,resultsAnswer:4,resultsAnswerEnd:5,resultsInterrupt:7,onDisconnect:8,subscribe:9,unsubscribe:10,onHypervisorStop:11,onHypervisorStopFromNode:12}),u=Object.freeze({GetFromWeb:9,SnapshotFromWeb:11,PutFromWeb:15,CommitFromWeb:17,LastSnapshotFromWeb:28,CreateObserverFromWeb:33,ReadKeysFromWeb:34,CreateKeysFromWeb:35,GetLocalMasterIdentifierFromWeb:38,DeleteObserverFromWeb:39,NotifyObserverFromWeb:40,StoreNodeDisconnectFromWeb:41});function c(t){for(var e=Object(t),n=1;n<arguments.length;++n){var i=arguments[n];if(void 0!==i)for(var s in i)i.hasOwnProperty(s)&&(e[s]=i[s])}return e}function p(t){if(t.hasOwnProperty("onHypervisorConnect")||t.hasOwnProperty("onHypervisorDisconnect")){if(!0===t.canDisconnectFromHypervisor)throw new Error("Invalid options combination. Do not set canDisconnectFromHypervisor to true with onHypervisorConnect and/or onHypervisorDisconnect");void 0===t.canDisconnectFromHypervisor&&n.window.console.warn("Disabling canDisconnectFromHypervisor because of onHypervisorConnect/onHypervisorDisconnect callbacks"),t.canDisconnectFromHypervisor=!1}}var d={index:0,uniqueId:0,getTimestamp:function(t){var e=new Date,n=Math.floor(e.getTime()/1e3),i=Math.floor(1e3*e.getMilliseconds());return function(t){return t!==h.channelRename&&t!==h.resultsAnswerEnd&&t!==h.resultsInterrupt}(t)?{sec:n,usec:i,index:this.index++}:{sec:n,usec:i}},createUniqueId:function(){return++this.uniqueId}};function l(t,e,n,i,s,o,r,a,h){var u=e;u.type=o,u.headerType=r,u.isBinary=s,u.uniqueId=n,u.hypervisorId=a.hypervisorId,u.id=a.id,u.eventId=h,u.pool=a.pool,t.sendText(JSON.stringify(u)),t.sendBinary(i)}function f(t,e,n,i,s){var o=d.getTimestamp(n);o.type=n,o.uniqueId=e,o.hypervisorId=i.hypervisorId,o.id=i.id,o.hresult=s,t.sendText(JSON.stringify(o))}function y(t,e){return t===h.none||t===h.channelRename||t===h.onDisconnect||t===h.subscribe||t===h.unsubscribe||t===h.onHypervisorStop||t===h.onHypervisorStopFromNode?e?8:1:t===h.resultsSend||t===h.resultsAnswer||t===h.resultsAnswerEnd||t===h.resultsInterrupt?e?8:4:-1}n.WebSocket.prototype.flushMessages=function(){for(;this.outputs.length;){this.outputs.pop()()}};var v=Object.freeze({traceContext:1});const w=function(){this.extensions_=0};function m(t,e,n){var i=void 0!==n,s=y(t,i),o=new Uint8Array(s),r=new DataView(o.buffer);return s>=4&&void 0!==e&&r.setInt32(0,16777215&e),o[0]=t,i&&(o[0]|=64,r.setInt32(4,n)),o}function g(t,e,i,s){if(!t.ws||2!==t.ws.readyState&&3!==t.ws.readyState||(t.ws=null),!t.ws)return!1;"string"!=typeof i&&(e[0]|=128),void 0!==s&&(e[0]|=32);var o=[e];return void 0!==s&&o.push(s.toBinary()),void 0!==i&&o.push(i),t.ws.send(new n.window.Blob(o)),!0}function b(t,e,n,i,s,o,r){n=n||h.none;var a=function(){var o,a=m(n,i,s),h=r?r.traceContext:void 0;return h&&(o=new w).setTraceContext(h),g(t,a,e,o)};if(t.waitRelease&&!o)t.waitingOutputs.unshift(a);else{if(t.connected)return a();t.outputs.unshift(a)}return!0}function M(t,e,n){return function(){return t(e+" occurred during request to 3DPassport\n"+n)}}function S(t,e,i,s,o){if(e&&t&&t.waitingCredentials){var r=function(t){throw new Error(t)},a=i,h=r;if(s&&t.timeoutInSeconds){h=function(t){clearTimeout(u),r(t)},a=function(t,e){clearTimeout(u),i(t,e,s)};var u=n.window.setTimeout((function(){var t="Provided authentication callback for a web node from pool "+s.pool+" didn't called onSuccess or onError in time";k(s.wsHypervisor,{_:"clientRejected",hypervisorId:o.hypervisorId,id:o.id}),s.onError(t)}),1e3*t.timeoutInSeconds)}return e({forWho:t.from,passportURL:t.passportURL},a,h),!0}return!1}function I(t,e,n){this.key.subMessage={_:"proxyValidate",serviceURL:t,serviceTicket:e},n&&n.tenant&&0!==n.tenant.length&&(this.key.subMessage.tenant=n.tenant),g(this.ws,this.header,JSON.stringify(this.key)),this.ws.release()}function k(t,e,n){return t&&t.sendMessage(JSON.stringify(e),void 0,void 0,void 0,n)}function x(t,e,n){return b(t,JSON.stringify(e),void 0,void 0,void 0,!0,n)}function C(t,e){for(var n in t)t.hasOwnProperty(n)&&e(n,t[n])}var U,O;w.prototype.hasTraceContext=function(){return(this.extensions_&v.traceContext)===v.traceContext},w.prototype.getTraceContext=function(){return this.traceContext_},w.prototype.setTraceContext=function(t){this.traceContext_=t,this._setExtensionId(v.traceContext,void 0!==this.traceContext_)},w.prototype._setExtensionId=function(t,e){e?this.extensions_|=t:this.extensions_&=~t},w.readExtensions=function(t){const e=new w;return e.extensions_=t.readUint8(),e.hasTraceContext()&&(e.traceContext_=n.TraceContext.read(t)),e},w.fromBinary=function(t){const e=new n.BinaryReader(t);return w.readExtensions(e)},w.prototype.toBinary=function(){const t=new n.BinaryWriter(this._getEstimatedBinarySize());return t.writeUint8(this.extensions_),this.hasTraceContext()&&(this.traceContext_?this.traceContext_.write(t):t.writeString("")),t.createArrayBuffer()},w.prototype._getEstimatedBinarySize=function(){var t=1;return this.hasTraceContext()&&(t+=this.traceContext_._getEstimatedBinarySize()),t},n.WebSocket.prototype.connect=function(t,e){var i;this.connected=!1,this.name=e;try{i=new n.window.WebSocket(t)}catch(e){i={close:function(){},readyState:0,url:t},n.window.setTimeout(function(){this.ws.readyState=3,this.ws.onclose()}.bind(this),1)}this.ws=i,this.ws.binaryType="arraybuffer",this.ws.onopen=function(){this.connected=!0,this.flushMessages(),this.onopen.forEach((function(t){t()})),null===this.ws&&i.close()}.bind(this),this.ws.onclose=function(){var t=this.connected;t&&this.flushMessages(),this.ws=null,this.onclose.forEach((function(e){e(t)}))}.bind(this),this.ws.onmessage=function(t){0!==t.data.byteLength&&(this.inputs.push(t.data),1===this.inputs.length&&r())}.bind(this);var s=async function(t,e,n,i,s){var o=e===h.resultsSend;this.monitor&&0!==i&&f(this.monitor,i,2,this.name);var a=await this.callback(t,n,o,s,e);o&&b(this,void 0,h.resultsAnswerEnd,n),this.monitor&&0!==i&&f(this.monitor,i,3,this.name,Number(a)),this.inputs.shift(),r()}.bind(this),o=function(t,e){this.monitor&&0!==e&&f(this.monitor,e,2,this.name),this.callbackResultsEnd(t),this.monitor&&0!==e&&f(this.monitor,e,3,this.name,0),this.inputs.shift(),r()}.bind(this),r=function(){var t=this.inputs[0];if(t){var e=new Uint8Array(t),i=31&e[0],r=64==(64&e[0]),a=y(i,r),u=-1,c=new DataView(t);i!==h.resultsSend&&i!==h.resultsAnswer&&i!==h.resultsAnswerEnd||(u=16777215&c.getInt32(0));var p=r?c.getInt32(4):0,f=t.slice(a),v=32==(32&e[0]),m=void 0;if(v){const t=new n.BinaryReader(f);m=w.readExtensions(t),f=f.slice(t.tell())}var g=128==(128&e[0]);if(this.monitor){r||(p=-d.createUniqueId());var b=d.getTimestamp(i);l(this.monitor,b,p,f,g,1,i,this.name)}if(i===h.resultsAnswerEnd)o(u,p);else if(g)s(f,i,u,p,m);else{var M=new n.window.FileReader;M.onload=function(t){s(t.target.result,i,u,p,m)},M.readAsText(new n.window.Blob([f]))}}}.bind(this)},n.WebSocket.prototype.close=function(){this.monitor=null,this.ws&&0!==this.ws.readyState&&this.ws.close&&this.ws.close(),this.ws=null},n.WebSocket.prototype.release=function(){for(this.waitRelease=!1;this.waitingOutputs.length;)this.outputs.unshift(this.waitingOutputs.pop());this.connected&&this.flushMessages()},n.WebSocket.prototype.sendMessage=function(t,e,n,i,s){return b(this,t,e,n,i,void 0,s)},n.defaultServiceURL="EXECFWK",n.defaultAuthentication=function(t,e,i){var s=t.passportURL+"/login?service="+n.defaultServiceURL+"&xrequestedwith=xmlhttprequest",o=new XMLHttpRequest;o.open("GET",s,!0),o.setRequestHeader("Accept","application/json"),o.withCredentials=!0,o.onloadend=function(s){if(s.currentTarget&&s.currentTarget.responseText)try{var o=JSON.parse(s.currentTarget.responseText).access_token;if(o)return e(n.defaultServiceURL,o)}catch(t){}return i("Invalid response from 3DPassport (click on this URL to check it)\n"+t.passportURL+"\nThe response:\n"+s)},o.ontimeout=M(i,"A timeout",t.passportURL),o.onabort=M(i,"An abort",t.passportURL),o.onerror=M(i,"An error",t.passportURL),o.send(null)},n.WebSocket.prototype.channelRename=function(t,e,n,i,s,o){var r=function(){var r=m(h.channelRename);t._="setPool",t.uniqueName=e,n&&(t.replyId=n),S(s,i,I.bind({ws:this,header:r,key:t}),o,this.name)||(g(this,r,JSON.stringify(t)),this.release())}.bind(this);this.outputs.push(r)},n.WebSocket.prototype.onMessage=function(t){this.callback=t},n.WebSocket.prototype.onMessageResultsEnd=function(t){this.callbackResultsEnd=t},n.WebSocket.prototype.onOpen=function(t){this.ws&&1===this.ws.readyState?t():this.onopen.push(t)},n.WebSocket.prototype.onClose=function(t){this.ws&&3===this.ws.readyState?t(this.connected):this.onclose.push(t)};var H=function(t,e){this.index=0,this.nodes=[],this.timeout=0,this.url=t,this.checkSentMessages=e};H.prototype.init=function(t){this.buffer=t.response,200===t.status&&(this.dataView=new DataView(this.buffer),this.version=this.dataView.getUint8(0),this.offset=1)},H.prototype.reset=function(){n.window.clearTimeout(this.timeout),this.timeout=0},H.prototype.addNode=function(t){return void 0===this.buffer?U("Missing EK.replayIsReady call"):void 0===this.version?U("Record file not found: "+this.url):this.version!==i.version?U("Version mismatch: please update your record file"):(t.replayer=new T(this.index),this.index++,this.nodes.push(t),void this.processMessages())},H.prototype.getMessage=function(){var t,e=this.dataView.getInt8(this.offset),n=this.dataView.getInt8(this.offset+1),i=this.dataView.getInt8(this.offset+2),s=this.dataView.getInt32(this.offset+3,!0);if(this.offset+=7,n)t=this.buffer.slice(this.offset,this.offset+s);else{t="";for(var o=0;o<s;++o)t+=String.fromCharCode(this.dataView.getUint8(this.offset+o));try{t=decodeURIComponent(window.escape(t))}catch(t){}}return this.offset+=s,{index:e,isSent:i,message:t}},H.prototype.processMessages=function(){0===this.timeout&&(this.offset>=this.dataView.byteLength?O=void 0:this.dataView.getInt8(this.offset+2)||(this.timeout=n.window.setTimeout(function(){for(;this.offset<this.dataView.byteLength&&!this.dataView.getInt8(this.offset+2);){var t=this.getMessage();this.nodes[t.index].replayer.callback(t.message,-1)}this.timeout=0,this.processMessages()}.bind(this),1)))},n.setReplayUrl=function(t,e){if(void 0===(e=e||{}).checkSentMessages&&(e.checkSentMessages=!0),void 0===e.onerror&&(e.onerror=function(t){jasmine.addMatchers({toFail:function(){return{compare:function(t){return{pass:!1,message:t}}}}}),expect(t).toFail()}),U=function(t){O instanceof H&&O.reset(),O=void 0,e.onerror(t)},"boolean"==typeof O)return U("EK.Node created before calling EK.setReplayUrl");var n=new H(t+=".ekr",e.checkSentMessages),i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&n.init(i)},i.open("GET",t,!0),i.responseType="arraybuffer",i.send(null),O=n},n.replayIsReady=function(){return O instanceof H?void 0!==O.buffer:U("Missing EK.setReplayUrl call")},n.replayHasFinished=function(){return void 0===O};var T=function(t){this.index=t};function E(t){return t instanceof Uint8Array?t:t.buffer instanceof ArrayBuffer?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t)}function B(t){if("string"==typeof t)return t;for(var e=E(t),n="",i=0;i<e.length;++i){var s=e[i].toString(16);1===s.length&&(s="0"+s),n+=s+" "}return n}T.prototype.sendMessage=function(t){if(void 0===O)return U("Unexpected send "+B(t));var e=O.getMessage();if(e.index!==this.index)return U("Send "+B(t)+" with the wrong node");if(!e.isSent)return U("Send "+B(t)+" but expect to receive "+B(e.message));if(!function(t,e){if("string"==typeof t||"string"==typeof e)return t===e;var n=E(t),i=E(e);if(n.length!==i.length)return!1;for(var s=0;s!==n.length;++s)if(n[s]!==i[s])return!1;return!0}(e.message,t)){var i="Send "+B(t)+" but expect to send "+B(e.message);if(O.checkSentMessages)return U(i);n.window.console.warn("Ignoring because checkSentMessages is false: "+i)}return O.processMessages(),!0},T.prototype.onMessage=function(t){this.callback=t},T.prototype.onMessageResultsEnd=function(t){this.callbackResultsEnd=t},T.prototype.onOpen=function(){},T.prototype.onClose=function(){};var P=function(e,n){var i;this.uuid=t(),this.pool=n,this.clients={},this.uniqueId=0,this.index=-1,this.handlers=[],this.authentication=e.authentication,this.tenant=e.tenant,this.onError=e.onError,this.onPoolProvisionable=[],O instanceof H?O.addNode(this):(O=!1,this.selectTimeouts={},this.pools={},this.inputs={},this.onHypervisorConnect=e.onHypervisorConnect,this.onHypervisorDisconnect=e.onHypervisorDisconnect,this.onDisconnect=e.onDisconnect,this.onHypervisorStopping=e.onHypervisorStopping,this.onNodeStopping=e.onNodeStopping,this.onText=e.onText,this.onBinary=e.onBinary,this.canDisconnect=e.canDisconnectFromHypervisor,this.wsHypervisor=null,this.addQueryParameter=(i=e.urlQueryParameter,function(t){var e=new URL(t);for(var n in i)e.searchParams.append(n,i[n]);return e}),void 0===e.hypervisorUrl&&(e.hypervisorUrl=e.hypervisorIp+":"+e.webSocketPort),"string"==typeof e.hypervisorUrl&&(e.hypervisorUrl=[e.hypervisorUrl]),this.hypervisorUrl=e.hypervisorUrl.map((function(t){return function(t,e){return/^\s*wss?:/.test(t)?t:(e?"wss://":"ws://")+t}(t,e.ssl)})),this.canDisconnect||this.connectToHypervisor())};function R(t,e){for(var n=0;n<t.length;++n){var i=t[n];if(i&&i.multiplexer===e)return}e.canJoin=!0,e.join()}function N(t,e,n){var i={_:"proxyValidate",serviceURL:t,serviceTicket:e};n&&n.tenant&&0!==n.tenant.length&&(i.tenant=n.tenant),x(this.wsHypervisor,i),this.wsHypervisor&&this.wsHypervisor.release()}P.prototype.connectToHypervisor=function(){var t=0;this.index++;var e=function(t){var e=this.hypervisorUrl[t],n={hypervisorId:o.myHypervisorId,id:s.hypervisor};this.wsHypervisor.connect(this.addQueryParameter(e),n)}.bind(this),i=function(){this.onHypervisorConnect()}.bind(this),r=function(n){n?this.onHypervisorDisconnect(n):t<this.hypervisorUrl.length?e(t++):(this.onError("Can't connect to the Hypervisor on "+this.hypervisorUrl),this.onHypervisorDisconnect(n))}.bind(this);this.wsHypervisor=new n.WebSocket(!0),this.wsHypervisor.onOpen(i),this.wsHypervisor.onClose(r),this.wsHypervisor.onMessage(this.privateOnText.bind(this)),e(t++);var a={_:"createNode",uuid:this.uuid,uniqueName:this.uuid+"/"+d.createUniqueId(),pool:this.pool,web:!0};this.tenant&&0!==this.tenant.length&&(a.tenant=this.tenant),x(this.wsHypervisor,a)},P.prototype.uniqueKey=function(t){return this.index+"_"+t.hypervisorId+"_"+t.id},P.prototype.setNodeId=function(t){var e;if(void 0!==t.status?((e=new n.WebSocket).name={},e.ws={readyState:3}):e=this.clients[this.uniqueKey(t)],void 0===e){var i=t.pool;this.inputs[i]=this.inputs[i]||[],this.inputs[i].push(t)}else{var s=t.uniqueId,o=this.pools[s];delete this.pools[s],void 0!==o&&o.setId(e,t.pool,this.onDisconnect);var r=this.selectTimeouts[s];delete this.selectTimeouts[s],clearTimeout(r)}},P.prototype.connect=function(t){var e={hypervisorId:t.hypervisorId,id:t.id},i=t.url,s=new n.WebSocket(!0);t.name.pool=this.pool,this.canDisconnect&&(t.name.canDisconnect=!0),s.channelRename(t.name,t.uniqueName,t.replyId,this.authentication,t.credentials,this),s.connect(this.addQueryParameter(i),e),this.clients[this.uniqueKey(t)]=s;var o=this.inputs[t.pool];if(void 0!==o)for(this.inputs[t.pool]=[];o.length;)this.setNodeId(o.shift());else{var r=new D(this);r.ws=s;var a=new _(r);s.onMessage(this.onMessage(a)),s.onMessageResultsEnd(this.onMessageResultsEnd(a))}s.pool=t.pool,this.monitor&&"ek.local.monitor"!==t.pool&&(s.monitor=this.monitor)},P.prototype.connectNode=function(t,e){var n=d.createUniqueId(),i={_:"id!",pool:e,uniqueId:n,hypervisorId:o.noHypervisorId,id:n},a={_:"connect!",pool:e,uniqueName:this.uuid+"/"+n,hypervisorId:o.noHypervisorId,id:n,type:r.webConnection,url:e,name:{hypervisorId:o.noHypervisorId,id:s.unknown},replyId:i},h=new D(this);return this.pools[n]=h,this.privateOnText(JSON.stringify(i)),this.privateOnText(JSON.stringify(a)),new F(new q(t,e),null,h)},P.prototype.deleteHandler=function(t){for(var e=0;e<this.handlers.length;++e){var n=this.handlers[e];n&&n.nodeIdImpl.ws===t&&(delete this.handlers[e],R(this.handlers,n.multiplexer))}var i=this.uniqueKey(t.name);delete this.clients[i]},P.prototype.closeIfNeeded=function(){if(this.canDisconnect&&null!==this.wsHypervisor&&!(this.onPoolProvisionable.length>0)){for(var t in this.pools)if(this.pools.hasOwnProperty(t))return;for(var e in this.clients)if(void 0===this.clients[e].canClose)return;this.wsHypervisor.close(),this.wsHypervisor=null}},P.prototype.privateOnText=function(t){try{t=JSON.parse(t)}catch(t){return!1}var e=t._;if("setId"===e)t.monitor&&(this.monitor=this.askConnect("ek.local.monitor",{criterion:n.Criterion.onlyMyHypervisor()}),this.monitor.onMessage(this.privateOnText.bind(this))),this.hypervisorUuid=t.uuid,!S(t.credentials,this.authentication,N.bind(this),this)&&this.wsHypervisor&&this.wsHypervisor.release();else if("connect!"===e)void 0===this.clients[this.uniqueKey(t)]&&t.type!==r.noConnection&&this.connect(t);else if("id!"===e)this.setNodeId(t),void 0!==t.status&&this.closeIfNeeded();else if("isPoolSelectable!"===e||"isPoolProvisionable!"===e){var i=this.onPoolProvisionable.shift();void 0!==i&&i(t.pool,!!t.answer),this.closeIfNeeded()}else if("clientRemoved"===e){var s=this.uniqueKey(t),o=this.clients[s];void 0!==o&&(delete this.clients[s],"ek.local.monitor"===o.pool&&(C(this.clients,(function(t,e){e.monitor=null})),this.monitor=void 0),o.close())}else if("monitorMessages"===e)"ek."!==this.pool.substr(0,3)&&(this.monitor||(this.monitor=this.askConnect("ek.local.monitor",{criterion:n.Criterion.onlyMyHypervisor()}),this.monitor.onMessage(this.privateOnText.bind(this))),C(this.clients,function(t,e){e.monitor=this.monitor}.bind(this)));else if("webAdded"===e){var a=this.clients[this.uniqueKey(t)];void 0!==a&&(a.canClose=!0),this.closeIfNeeded()}else{if("stop"!==e){var h="A web node from pool "+this.pool+" received an unknown message: "+JSON.stringify(t);return k(this.wsHypervisor,{_:"publishError",message:h}),this.onError(h),!1}this.stop()}return!0};var W=function(t,e){this.policy=t,this.name=e};W.prototype.withTimeout=function(t){return this.timeout=t>0?t:0,this},W.prototype.withoutQueuing=function(){return this.noQueuing=!0,this},W.prototype.withoutProcessCreation=function(){return this.noProcess=!0,this},W.prototype.withCmdLine=function(t){return this.cmdLine=t,this},W.prototype.withEstimatedMemoryInMB=function(t){return this.estimatedMemoryInMB=t,this},W.prototype.withEstimatedGPUMemoryInMB=function(t){return this.estimatedGPUMemoryInMB=t,this},n.Criterion={none:function(){return new W(a.noConstraint)},onlyMyHypervisor:function(){return new W(a.onlyMyHypervisor)},notMyHypervisor:function(){return new W(a.notMyHypervisor)},preferMyHypervisor:function(){return new W(a.preferMyHypervisor)},identifier:function(t){return new W(a.identifier,t)},timeout:function(t){return new W(a.noConstraint).withTimeout(t)},noQueuing:function(){return new W(a.noConstraint).withoutQueuing()},noProcessCreation:function(){return new W(a.noConstraint).withoutProcessCreation()}},P.prototype.askConnect=function(t,e){var i=new D(this);if(O instanceof H)i.setId(this.replayer);else{var s=e?.criterion||{policy:a.noConstraint},o=d.createUniqueId(),r={_:"id?",pool:t,uniqueId:o,policy:s.policy,name:s.name,cmdLine:s.cmdLine,timeout:void 0!==s.timeout?s.timeout:-1,noQueuing:s.noQueuing,noProcess:s.noProcess,estimatedMemoryInMB:s.estimatedMemoryInMB,estimatedGPUMemoryInMB:s.estimatedGPUMemoryInMB};this.pools[o]=i,null===this.wsHypervisor&&this.connectToHypervisor(),k(this.wsHypervisor,r,{traceContext:e?.traceContext}),s.timeout>0&&(this.selectTimeouts[o]=n.window.setTimeout((function(){i.getStatus()!==n.Status.connected&&i.close()}),1e3*s.timeout))}return i},P.prototype.unserializeNodeId=function(t,e,n,i,s){var o=new D(this),r=d.createUniqueId(),h={_:"unserializeId",uuid:e,pool:n,hypervisorId:i,id:s,uniqueId:r,policy:a.noConstraint};this.pools[r]=o,null===this.wsHypervisor&&this.connectToHypervisor(),k(this.wsHypervisor,h);var u=new q(t,n);return new F(u,void 0,o)},P.prototype.stop=function(){var t=this.onDisconnect;C(this.pools,(function(e,i){var s=new n.WebSocket;s.name={},s.ws={readyState:3},i.setId(s,i.nodePool.pool,t)})),C(this.clients,(function(t,e){e.close()})),this.wsHypervisor&&this.wsHypervisor.close(),this.wsHypervisor=null};var D=function(t){this.nodeImpl=t,this.outputs=[],this.onStatusChange=[],this.reduced=!1};D.prototype.setId=function(t,e,n){var i=null===this.ws;this.ws=t,i&&this.ws.onOpen(function(){this.close(this.reduced)}.bind(this));var s=t.ws&&t.ws.url;this.ws.onClose(function(t){s&&!t&&(k(this.nodeImpl.wsHypervisor,{_:"clientRejected",hypervisorId:this.ws.name.hypervisorId,id:this.ws.name.id}),this.nodeImpl.onError("Can't connect to the Node from pool '"+e+"' on "+s));this.ws&&this.nodeImpl.deleteHandler(this.ws)}.bind(this));var o=function(){if(this.ws){var t=new F;t.impl=this,this.onStatusChange.forEach((function(n){n(t,e)}))}}.bind(this);if(this.ws.onOpen(o),this.ws.onClose(o),"function"==typeof n&&"ek."!==e.substr(0,3)){var r=function(){if(this.ws){var t=new F;t.impl=this,n(t,e)}}.bind(this);this.ws.onClose(r)}for(;this.outputs.length;){this.outputs.shift()()}},D.prototype.close=function(t){var e={_:"closeId",reduced:t};if(this.reduced=t,this.ws&&!0===this.ws.canClose)this.ws.sendMessage(JSON.stringify(e),h.channelRename);else if(this.nodeImpl.wsHypervisor){var n=this.nodeImpl.wsHypervisor;e.pool=this.nodePool.pool,e.uniqueId=function(t,e){for(var n in e)if(e.hasOwnProperty(n)&&e[n]===t)return Number(n);return-1}(this,this.nodeImpl.pools),this.ws?(e.hypervisorId=this.ws.name.hypervisorId,e.id=this.ws.name.id):this.ws=null,k(n,e)}else this.ws&&this.ws.close()},D.prototype.push=function(t){if(this.ws){if(!t()&&"boolean"==typeof O)throw new Error("ExperienceKernel was unable to send a message since the distant node is unreachable")}else this.outputs.push(t)},D.prototype.sendText=function(t){this.push(function(){return this.ws.sendMessage(t)}.bind(this))},D.prototype.sendBinary=function(t){this.push(function(){return"string"==typeof t&&(t=new String(t)),this.ws.sendMessage(t)}.bind(this))},D.prototype.sendMessage=function(t,e,n,i){if(i?i.interruption:void 0){var s={onText:this.nodeImpl.onText,onBinary:this.nodeImpl.onBinary},o=new K(this.nodeImpl,s);return o.sendMessage(this,t,i),void o.close()}var r=d.getTimestamp(e),a=this.nodeImpl,h=++a.uniqueId;this.push(function(){if(a.monitor){var s=void 0===this.ws?{}:this.ws.name;s.pool=this.nodePool.pool,l(a.monitor,r,h,t,"string"!=typeof t,0,e,s,n)}else h=void 0;return this.ws.sendMessage(t,e,n,h,i)}.bind(this))},D.prototype.onMessage=function(t){this.push(function(){return this.ws.onMessage(t),!0}.bind(this))},D.prototype.onMessageResultsEnd=function(t){this.push(function(){return this.ws.onMessageResultsEnd(t),!0}.bind(this))},D.prototype.getStatus=function(){if(void 0===this.ws)return n.Status.pending;if(null===this.ws||null===this.ws.ws)return n.Status.disconnected;var t=this.ws.ws;return 0===t.readyState?n.Status.pending:1===t.readyState?n.Status.connected:n.Status.disconnected},n.Node=function(t){for(var e in t=t||{})if(t.hasOwnProperty(e)&&!n.defaultsOptions.hasOwnProperty(e))throw new Error("Unknown EK.Node option named '"+e+"'. Valid options are: "+JSON.stringify(Object.keys(n.defaultsOptions)));if(t.hasOwnProperty("hypervisorUrl")&&(t.hasOwnProperty("hypervisorIp")||t.hasOwnProperty("webSocketPort")))throw new Error("Invalid options combination. Do not use hypervisorUrl with hypervisorIp and/or webSocketPort");p(t);var i=c({},n.defaultsOptions,t);this.onMessage=function(t){return function(e,n,s,o,r){if(t.id=n,t.resultsAnswer=s,t.extensions=o,s||-1===n){var a="string"==typeof e;return a&&r===h.onHypervisorStopFromNode?i.onNodeStopping(e,t):a&&r===h.onHypervisorStop?i.onHypervisorStopping(e,t):(a?i.onText:i.onBinary)(e,t)}if(void 0!==this.impl.handlers[n]){var u=this.impl.handlers[n].multiplexer.results;return("string"==typeof e?u.onText:u.onBinary)(e,t)}}.bind(this)},this.onMessageResultsEnd=function(){return function(t){var e=this.impl.handlers[t];e&&0==--e.cnt&&(delete this.impl.handlers[t],R(this.impl.handlers,e.multiplexer))}.bind(this)},this.impl=new P(i,i.pool),this.impl.onMessage=this.onMessage.bind(this),this.impl.onMessageResultsEnd=this.onMessageResultsEnd.bind(this)};var A=function(t,e){this.cnt=1,this.multiplexer=t,this.nodeIdImpl=e},_=function(t){this.impl=t,this.id=-1,this.resultsAnswer=!1,this.extensions=void 0};_.prototype.answerText=function(t){return this.answerMessage(t+"")},_.prototype.answerBinary=function(t){return this.answerMessage(t)},_.prototype.answerMessage=function(t){if(-1===this.id)this.impl.sendMessage(t);else if(this.resultsAnswer)this.impl.sendMessage(t,h.resultsAnswer,this.id);else{var e=this.impl.nodeImpl.handlers[this.id];e&&(++e.cnt,this.impl.sendMessage(t,h.resultsSend,this.id))}return this},_.prototype.getTraceContext=function(){return this.extensions?.getTraceContext()||void 0};var q=function(t,e){this.node=t,this.pool=e};q.prototype.select=function(t){return new F(this,t)};var F=function(t,e,n){if(void 0!==t){var i=e instanceof W?{criterion:e}:e,s=t.node;this.impl=void 0!==n?n:s.impl.askConnect(t.pool,i),this.impl.nodePool=t;var o=new _(this.impl);this.impl.onMessage(s.onMessage(o)),this.impl.onMessageResultsEnd(s.onMessageResultsEnd(o))}};function L(t,e){if(t.nodePool.node.impl!==e)throw new Error("The NodeId doesn't belong to the right node")}F.prototype.equals=function(t){var e=this.impl.ws,n=t.impl.ws;return void 0!==e&&void 0!==n&&(e.name.id===n.name.id&&e.name.hypervisorId===n.name.hypervisorId)},F.prototype.close=function(){return this.impl.close(!1),this},F.prototype.closeWithReducedTimeout=function(){return this.impl.close(!0),this},F.prototype.getStatus=function(){return this.impl.getStatus()},F.prototype.isConnected=function(){return this.impl.getStatus()===n.Status.connected},F.prototype.onStatusChange=function(t){"function"==typeof t&&this.impl.onStatusChange.push(t)},F.prototype.unregisterStatusChange=function(t){"function"==typeof t&&(this.impl.onStatusChange=this.impl.onStatusChange.filter((function(e){return e!==t})))},n.Node.prototype.connect=function(t){return new q(this,t)},n.Node.prototype.connectNode=function(t){return this.impl.connectNode(this,t)},n.Node.prototype.isPoolProvisionable=function(t,e,n){if("function"==typeof n){this.impl.onPoolProvisionable.push(n),null===this.impl.wsHypervisor&&this.impl.connectToHypervisor();var i=e?.criterion||{policy:a.noConstraint},s=d.createUniqueId();k(this.impl.wsHypervisor,{_:"isPoolProvisionable",pool:t,uniqueId:s,policy:i.policy,name:i.name,cmdLine:i.cmdLine,timeout:void 0!==i.timeout?i.timeout:-1,noQueuing:i.noQueuing,noProcess:i.noProcess})}},n.Node.prototype.isPoolSelectable=function(t,e){"function"==typeof e&&(this.impl.onPoolProvisionable.push(e),null===this.impl.wsHypervisor&&this.impl.connectToHypervisor(),k(this.impl.wsHypervisor,{_:"isPoolSelectable",pool:t}))},n.Node.prototype.sendText=function(t,e,n){return L(t.impl,this.impl),e=e||"",t.impl.sendMessage(e+"",void 0,void 0,n),this},n.Node.prototype.sendBinary=function(t,e,n){return L(t.impl,this.impl),t.impl.sendMessage(e,void 0,void 0,n),this},n.Node.prototype.sendBinaryWithInterrupt=function(t,e,n){return L(t.impl,this.impl),t.impl.sendMessage(e,void 0,void 0,{interruption:n}),this},n.Node.prototype.sendTextWithInterrupt=function(t,e,n){return L(t.impl,this.impl),t.impl.sendMessage(e+"",void 0,void 0,{interruption:n}),this},n.Node.prototype.sendTextOnDisconnection=function(t,e,n){return L(t.impl,this.impl),e=e||"",t.impl.sendMessage(e+"",h.onDisconnect,void 0,n),this},n.Node.prototype.sendBinaryOnDisconnection=function(t,e,n){return L(t.impl,this.impl),t.impl.sendMessage(e,h.onDisconnect,void 0,n),this},n.Node.prototype.subscribe=function(t,e){return L(t.impl,this.impl),e=e||"",t.impl.sendMessage(e+"",h.subscribe),this},n.Node.prototype.unsubscribe=function(t,e){return L(t.impl,this.impl),e=e||"",t.impl.sendMessage(e+"",h.unsubscribe),this},n.Node.prototype.stop=function(){this.stop=function(){},this.impl.stop();var t=function(){throw new Error("EK.Node is closed")};for(var e in this.constructor.prototype)"function"==typeof this[e]&&(this[e]=t)},n.Interruption=function(){this.id=-1,this.interrupted=!1},n.Interruption.prototype.interrupt=function(){return!this.interrupted&&-1!==this.id&&(this.toImpl.sendMessage(void 0,h.resultsInterrupt,this.id),this.interrupted=!0,!0)},n.Multiplexer=function(t,e){this.impl=new K(t.impl,e)},n.Multiplexer.prototype.sendBinary=function(t,e,n){this.impl.sendMessage(t.impl,e,n)},n.Multiplexer.prototype.sendText=function(t,e,n){this.impl.sendMessage(t.impl,e+"",n)},n.Multiplexer.prototype.sendBinaryWithInterrupt=function(t,e,n){this.impl.sendMessage(t.impl,e,{interruption:n})},n.Multiplexer.prototype.sendTextWithInterrupt=function(t,e,n){this.impl.sendMessage(t.impl,e+"",{interruption:n})},n.Multiplexer.prototype.close=function(){this.impl.close()};var K=function(t,e){for(var i in e=e||{})if(e.hasOwnProperty(i)&&!n.defaultsMultiplexerOptions.hasOwnProperty(i))throw new Error("Unknown EK.Multiplexer option named '"+i+"'. Valid options are: "+JSON.stringify(Object.keys(n.defaultsMultiplexerOptions)));this.nodeImpl=t,this.results=c({},n.defaultsMultiplexerOptions,e),this.isClosed=!1,this.canJoin=!1};function j(t){return"number"==typeof t?t={low:t,high:0}:void 0!==t&&t.hasOwnProperty("low")||(t={low:0,high:0}),t}K.prototype.sendMessage=function(t,e,n){if(!this.isClosed){var i=n?n.interruption:void 0;if(void 0===i||-1===i.id){L(t,this.nodeImpl);var s=this.nodeImpl.handlers.push(new A(this,t))-1;void 0!==i&&(i.id=s,i.toImpl=t),t.sendMessage(e,h.resultsSend,s,{traceContext:n?n.traceContext:void 0})}}},K.prototype.join=function(){this.canJoin&&(this.results.join(),this.canJoin=!1)},K.prototype.close=function(){this.join(),this.isClosed=!0},n.Store=function(t,e){for(var i in e=e||{})if(e.hasOwnProperty(i)&&!n.defaultsStoreOptions.hasOwnProperty(i))throw new Error("Unknown EK.Store option named '"+i+"'. Valid options are: "+JSON.stringify(Object.keys(n.defaultsStoreOptions)));p(e);var s=c({},n.defaultsStoreOptions,e);s.onBinary=function(t){var e=new n.BinaryReader(t),i=e.getSize();if(i&&e.readUint8()===u.NotifyObserverFromWeb)!function(t,e){var n=[],i=e.readUint32();if(void 0!==t.observedSnapshots[i]){for(t.observedSnapshots[i].snapshot.timeStamp=e.readUint64();e.tell()<e.getSize();){var s=n[n.length]={low:e.readUint32(),high:e.readUint32()},o=e.readInt64();t.observedSnapshots[i].snapshot.keys[s.high][s.low]=e.readArrayBuffer(o)}t.observedSnapshots[i].callback(t.observedSnapshots[i].snapshot,n)}}(this,e);else{var s=t.slice(i?1:0);this.callbacks.pop()(s)}}.bind(this),this.onMessage=function(t){return function(e){return("string"==typeof e?s.onText:s.onBinary)(e,t)}},this.onMessageResultsEnd=function(){return function(){}},this.observedSnapshots={},this.observedCounter=0,this.callbacks=[],this.impl=new P(s,(e.distant?"ek.distant.store.":"ek.local.store.")+t),this.impl.onMessage=this.onMessage.bind(this),this.impl.onMessageResultsEnd=this.onMessageResultsEnd.bind(this);var o=new q(this,"ek.store."+t);this.master=o.select(n.Criterion.preferMyHypervisor());var r=new n.BinaryWriter(1);r.writeUint8(u.StoreNodeDisconnectFromWeb),this.master.impl.sendMessage(r.createArrayBuffer(),h.onDisconnect);var a=new n.BinaryWriter(1);a.writeUint8(u.GetLocalMasterIdentifierFromWeb),this.master.impl.sendMessage(a.createArrayBuffer()),this.callbacks.unshift(function(t){var e=new n.BinaryReader(t);return this.port=e.readUint32(),this.hostname=e.readString(),!0}.bind(this))},n.Store.prototype.get=function(t,e){var i=new n.BinaryWriter(9);i.writeUint8(u.GetFromWeb);var s=j(t);return i.writeUint32(s.low),i.writeUint32(s.high),this.master.impl.sendMessage(i.createArrayBuffer()),this.callbacks.unshift(e),this},n.Store.prototype.put=function(t,e){var i=j(t);e=E(e);var s=new n.BinaryWriter(17+e.byteLength);return s.writeUint8(u.PutFromWeb),s.writeUint32(i.low),s.writeUint32(i.high),s.writeUint64(e.byteLength),s.writeUint8Array(e),this.master.impl.sendMessage(s.createArrayBuffer()),this},n.Store.prototype.del=function(t){var e=j(t),i=new n.BinaryWriter(17);return i.writeUint8(u.PutFromWeb),i.writeUint32(e.low),i.writeUint32(e.high),i.writeInt64(-1),this.master.impl.sendMessage(i.createArrayBuffer()),this};var z=function(t){for(var e=[],i=new n.BinaryReader(t),s=i.readUint64(),o=0;o<s;++o)e[o]={low:i.readUint32(),high:i.readUint32()};return e};n.Store.prototype.createKeys=function(t,e,i){var s=[];"string"==typeof i&&s.push(i);var o=new n.BinaryWriter(9);return o.writeUint8(u.CreateKeysFromWeb),o.writeUint64(t),o.writeUint64(s.length),o.writeStrings(s),this.master.impl.sendMessage(o.createArrayBuffer()),this.callbacks.unshift((function(t){var n=z(t);return e(n)})),this},n.Store.prototype.readKeys=function(t,e){var i=new n.BinaryWriter(1);i.writeUint8(u.ReadKeysFromWeb);var s=E(t);return i.writeUint8Array(s),this.master.impl.sendMessage(i.createArrayBuffer()),this.callbacks.unshift((function(t){var n=z(t);return e(n)})),this};var J,V=function(t,e,i){var s=new n.BinaryReader(i);this.store=t,this.keys={};for(var o=0;o<e.length;++o)void 0===this.keys[e[o].high]&&(this.keys[e[o].high]={}),this.keys[e[o].high][e[o].low]=void 0;for(this.fullSnapshot=s.readBool(),this.timeStamp=s.readUint64();s.tell()<i.byteLength;){var r={low:s.readUint32(),high:s.readUint32()},a=s.readInt64();void 0===this.keys[r.high]&&(this.keys[r.high]={}),this.keys[r.high][r.low]=s.readArrayBuffer(a)}};function Q(t){var e={_:"graph"};t.options.cpu&&(e.cpu=!0),t.options.cpuLoad&&(e.cpuLoad=!0),t.options.ram&&(e.ram=!0),t.options.network&&(e.network=!0),t.lastRequest=Date.now(),t.timeout=void 0,t.ws.sendMessage(JSON.stringify(e))}function G(t){var e={revision:(t=JSON.parse(t)).revision};this.options.cpu&&(e.cpu=t.cpu),this.options.cpuLoad&&(e.cpuLoad=t.cpuLoad),this.options.ram&&(e.currentMemory=t.currentMemory,e.estimatedMemory=t.totalMemory-t.availableMemory,e.totalMemory=t.totalMemory,e.ram=100*e.currentMemory/e.totalMemory),this.options.probes&&(e.probes=t.probes),this.options.network&&(e.network=t.network);var i=!this.hypervisors.has(t.id);if(this.hypervisors.add(t.id),this.current.add(t.id),0===t.id&&(t.links=t.links||[],t.links.forEach((function(t){this.hypervisors.has(t.id)||(this.callbacks.onHypervisorAdd(t.id,t.hostname+":"+t.port),this.hypervisors.add(t.id))}),this),this.current.forEach((function(t){this.hypervisors.delete(t)}),this),this.hypervisors.forEach((function(e){0!==t.links.filter((function(t){return t.id===e})).length?(this.callbacks.onHypervisorUnresponsive(e),this.current.add(e)):this.callbacks.onHypervisorDelete(e)}),this),this.hypervisors=this.current,this.current=new Set),i&&this.callbacks.onHypervisorAdd(t.id,t.hostname+":"+t.port),this.callbacks.onHypervisorUpdate(t.id,e),0===t.id&&this.running){var s=Math.max(this.lastRequest+this.options.refreshIntervalInMilliseconds-Date.now(),0);this.timeout=n.window.setTimeout(Q,s,this)}}return V.prototype.get=function(t){var e=j(t);return this.keys[e.high][e.low]?this.keys[e.high][e.low]:new ArrayBuffer(0)},n.Store.prototype.createSnapshot=function(t,e){var i,s=9+8*(e=e||[]).length,o=new n.BinaryWriter(s);o.writeUint8(u.SnapshotFromWeb),o.writeUint64(e.length);for(var r=0;r<e.length;++r)i=j(e[r]),o.writeUint32(i.low),o.writeUint32(i.high);this.master.impl.sendMessage(o.createArrayBuffer());var a=this;return this.callbacks.unshift((function(n){return t(new V(a,e,n))})),this},V.prototype.last=function(t){var e,i,s=0;for(e in this.keys){if(this.keys.hasOwnProperty(e))s+=Object.keys(this.keys[e]).length}var o=17+8*s,r=new n.BinaryWriter(o);for(e in r.writeUint8(u.LastSnapshotFromWeb),r.writeUint64(this.timeStamp),r.writeUint64(s),this.keys)if(this.keys.hasOwnProperty(e))for(i in this.keys[e])this.keys[e].hasOwnProperty(i)&&(r.writeUint32(i),r.writeUint32(e));this.store.master.impl.sendMessage(r.createArrayBuffer());var a=this;return this.store.callbacks.unshift((function(e){var i=function(t,e){var i=[],s=new n.BinaryReader(e);for(t.timeStamp=s.readUint64();s.tell()<e.byteLength;){var o=i[i.length]={low:s.readUint32(),high:s.readUint32()},r=s.readInt64();t.keys[o.high][o.low]=s.readArrayBuffer(r)}return i}(a,e);return t(a,i)})),this},V.prototype.createObserver=function(t,e){var i,s,o=0;for(i in this.keys){if(this.keys.hasOwnProperty(i))o+=Object.keys(this.keys[i]).length}var r=17+8*o,a=new n.BinaryWriter(r);for(i in a.writeUint8(u.CreateObserverFromWeb),a.writeBool(this.fullSnapshot),a.writeUint32(this.store.observedCounter),a.writeUint64(this.timeStamp),a.writeDouble(e),a.writeUint64(o),this.keys)if(this.keys.hasOwnProperty(i))for(s in this.keys[i])this.keys[i].hasOwnProperty(s)&&(a.writeUint32(s),a.writeUint32(i));return this.store.observedSnapshots[this.store.observedCounter]={snapshot:this,callback:t},this.store.observedCounter++,this.store.master.impl.sendMessage(a.createArrayBuffer()),this},V.prototype.deleteObserver=function(){var t=new n.BinaryWriter(5);t.writeUint8(u.DeleteObserverFromWeb);for(var e=0;e<this.store.observedCounter;++e)if(void 0!==this.store.observedSnapshots[e]&&this.store.observedSnapshots[e].snapshot===this){t.writeUint32(e),this.store.observedSnapshots[e]=void 0,this.store.master.impl.sendMessage(t.createArrayBuffer());break}return this},n.Batch=function(t){this.commands={},this.store=t},n.Batch.prototype.put=function(t,e){var n=j(t);return e=E(e),void 0===this.commands[n.high]&&(this.commands[n.high]={}),this.commands[n.high][n.low]={size:e.byteLength,binary:e},this},n.Batch.prototype.del=function(t){var e=j(t);return void 0===this.commands[e.high]&&(this.commands[e.high]={}),this.commands[e.high][e.low]={size:-1},this},n.Batch.prototype.commit=function(){var t,e,i,s=5,o=0;for(e in this.commands)if(this.commands.hasOwnProperty(e))for(i in this.commands[e])this.commands[e].hasOwnProperty(i)&&(o++,s+=16,-1!==(t=this.commands[e][i]).size&&(s+=t.size));var r=new n.BinaryWriter(s);for(e in r.writeUint8(u.CommitFromWeb),r.writeUint32(o),this.commands)if(this.commands.hasOwnProperty(e))for(i in this.commands[e])if(this.commands[e].hasOwnProperty(i)){t=this.commands[e][i];var a=new n.BinaryWriter(16);a.writeUint32(i),a.writeUint32(e),a.writeInt64(t.size),r.writeUint8Array(new Uint8Array(a.arrayBuffer)),-1!==t.size&&r.writeUint8Array(t.binary)}return this.store.master.impl.sendMessage(r.createArrayBuffer()),this},n.defaultsMonitorCallbacks=Object.freeze({onConnect:function(){},onDisconnect:function(){},onHypervisorAdd:function(){},onHypervisorUpdate:function(){},onHypervisorUnresponsive:function(){},onHypervisorDelete:function(){}}),n.defaultsMonitorOptions=Object.freeze({cpu:!1,cpuLoad:!1,ram:!1,network:!1,probes:!1,refreshIntervalInMilliseconds:1e3}),n.Monitor=function(t,e,i){void 0===J&&(J=new WeakMap);var o={};J.set(this,o),o.callbacks=c({},n.defaultsMonitorCallbacks,e),o.options=c({},n.defaultsMonitorOptions,i),o.ws=new n.WebSocket,o.ws.onOpen(o.callbacks.onConnect),o.ws.onClose(o.callbacks.onDisconnect),o.ws.onMessage(G.bind(o)),o.ws.connect(t,{hypervisorId:0,id:s.hypervisor}),o.hypervisors=new Set,o.current=new Set,o.running=!0,o.lastRequest=0,o.timeout=void 0,Q(o)},n.Monitor.prototype.pause=function(){var t=J.get(this);clearTimeout(t.timeout),t.running=!1,t.timeout=void 0},n.Monitor.prototype.resume=function(){var t=J.get(this),e=!t.running;t.running=!0,e&&void 0===t.timeout&&Q(t)},n.Monitor.prototype.updateOptions=function(t){var e=J.get(this);if(e.options=c(e.options,t),e.running&&void 0!==e.timeout){clearTimeout(e.timeout);var i=Math.max(e.lastRequest+e.options.refreshIntervalInMilliseconds-Date.now(),0);e.timeout=n.window.setTimeout(Q,i,e)}},n.Monitor.prototype.disconnect=function(){J.get(this).ws.close()},Object.keys(e).forEach((function(t){n[t]=e[t]})),n}()}));