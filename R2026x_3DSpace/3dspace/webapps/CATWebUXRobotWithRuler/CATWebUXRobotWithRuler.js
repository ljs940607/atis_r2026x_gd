/*!  Copyright 2020 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],(function(n,i,e,t,o,r,a){"use strict";var l=1;return n.extend({init:function(n){var s,u,c,g,p,d,f,b,v,M,y,V=n.frameWindow,h=V.getViewer(),x=n.lightDisplay,m=!1,w=!1,P=n.getRulerUnitCB,R=n.getAngularRulerUnitCB,D=n.checkDirforRuler;Object.defineProperty(this,"robotMatrixCompute",{set:function(n){"function"==typeof n&&(s=n)},get:void 0}),Object.defineProperty(this,"robotOrigin3DCompute",{set:function(n){"function"==typeof n&&(u=n)},get:void 0}),Object.defineProperty(this,"moveBegin",{set:function(n){"function"==typeof n&&(c=n)},get:void 0}),Object.defineProperty(this,"move",{set:function(n){"function"==typeof n&&(g=n)},get:void 0}),Object.defineProperty(this,"moveEnd",{set:function(n){"function"==typeof n&&(p=n)},get:void 0}),Object.defineProperty(this,"moveRobotBegin",{set:function(n){"function"==typeof n&&(d=n)},get:void 0}),Object.defineProperty(this,"moveRobot",{set:function(n){"function"==typeof n&&(f=n)},get:void 0}),Object.defineProperty(this,"moveRobotEnd",{set:function(n){"function"==typeof n&&(b=n)},get:void 0}),Object.defineProperty(this,"moveRulerOriginBegin",{set:function(n){"function"==typeof n&&(v=n)},get:void 0}),Object.defineProperty(this,"moveRulerOrigin",{set:function(n){"function"==typeof n&&(M=n)},get:void 0}),Object.defineProperty(this,"moveRulerOriginEnd",{set:function(n){"function"==typeof n&&(y=n)},get:void 0});var O=new e("",h,!1,!1);O.name="RobotWithRuler_"+l++,O.target={getWorldMatrix:function(){return O.getMatrix()}},O.setMoveMode("CALLBACK_ONLY"),O.scalingNodeX.setVisibility(!1),O.scalingNodeX.setVisibilityFree(!0),O.scalingNodeY.setVisibility(!1),O.scalingNodeY.setVisibilityFree(!0),O.scalingNodeZ.setVisibility(!1),O.scalingNodeZ.setVisibilityFree(!0),O.setVisibility(!1),h.addNode(O),n.disablePickingDuringManipulation&&O.setDisablePickingDuringManipulation&&O.setDisablePickingDuringManipulation(!0);var C,T,A,E,S,B,k,N,U,X,L,F,Y,Z,W=[],j=[],z=[],G={origin:new i.Vector3,initOrigin:new i.Vector3,direction:null,initValue:null,value:null,origin3D:null},I={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},H=!1,K=function(){var n={x:new i.Vector3,y:new i.Vector3,z:new i.Vector3};function e(n,i){var e,t=.9995;return n.normalize(),n.x>t?e="x":n.y>t?e="y":n.z>t&&(e="z"),e?i+"|"+e:i}return function(i){i?(O.getMatrix().extractBasis(n.x,n.y,n.z),O.setLabels({labelX:e(n.x,"u"),labelY:e(n.y,"v"),labelZ:e(n.z,"w")})):O.setLabels()}}();function _(n){O.setPickable(n?o.PICKABLE:o.PICKTHROUGH)}function q(){A&&A.clear(),E&&E.clear()}function J(){A&&(A.direction=null,A.origin=null,A.origin3DPos=null,A.setValue(0)),E&&(E.direction=null,E.origin=null,E.originVector=null,E.setValue(0)),q()}function Q(){O.setToNonGhostState()}function $(){_(!1),N=A.displayOrigin,k=(A.origin3DPos||A.origin).clone(),v&&v()}function nn(n){if(U=null,u){var i=u({event:n.event,viewer:h});U=i&&i.origin3D}return A.displayOrigin=N,U?(A.displayOrigin=!0,M&&M(),U.clone()):k}function en(){_(!0),U&&(G.origin3D=U.clone()),y&&y()}function tn(n){if("RulerManipulateBegin"===n.eventName||"AngularRulerManipulateBegin"===n.eventName)w=!0,X=new i.Vector3,L=0,T=O.getMatrix(),c&&c({robotMatrix:O.getMatrix(),from:"ruler",axis:(new i.Vector3).copy(n.direction),kind:"RulerManipulateBegin"===n.eventName?"translation":"rotation",event:n.event});else if("RulerManipulate"===n.eventName)K(),X.add(n.translationVector),O.setMatrix((new i.Matrix4).copy(T).setPosition((new i.Vector3).getPositionFromMatrix(T).add(X))),g&&g({robotMatrix:O.getMatrix(),translationVector:n.translationVector,from:"ruler",axis:(new i.Vector3).copy(n.direction),kind:"translation",event:n.event}),h.render({forceDynamicMode:!0});else if("AngularRulerManipulate"===n.eventName){K();var e=n.diffAngle*Math.PI/180;L+=e;var t=(new i.Matrix4).makeRotationAxis(n.direction,L).multiply((new i.Matrix4).extractRotation(T));O.setMatrix(t.setPosition((new i.Vector3).getPositionFromMatrix(T))),I.value=E.value,g&&g({robotMatrix:O.getMatrix(),rotationAngle:e,from:"ruler",axis:(new i.Vector3).copy(n.direction),kind:"rotation",event:n.event})}else"RulerManipulateEnd"!==n.eventName&&"AngularRulerManipulateEnd"!==n.eventName||(O.setRobotMatrix(O.getMatrix()),w=!1,p&&p({robotMatrix:O.getMatrix(),from:"ruler",axis:(new i.Vector3).copy(n.direction),kind:"RulerManipulateEnd"===n.eventName?"translation":"rotation",event:n.event}),K(!0),h.render({forceDynamicMode:!0}))}function on(n){var e,t;if(_(!1),w=!0,h.setCursor("pointer"),q(),e=n.manipulator,[O.arrowX,O.arrowY,O.arrowZ,O.translationPlaneYZ,O.translationPlaneXY,O.translationPlaneXZ,O.rotationArcYZ,O.rotationArcXZ,O.rotationArcXY].forEach((function(n){n&&n.manipulator&&n.manipulator!==e&&n.setToGhostState()})),O.robotHandle.setToGhostState(),"LineTranslationBegin"===n.eventChannel){t=(new i.Vector3).copy(n.manipulator.axis),D&&(t=D(t));var o=(new i.Vector3).getPositionFromMatrix(O.getMatrix()),a=(new i.Vector3).copy(t).multiplyScalar((new i.Vector3).copy(G.baseOrigin).sub(o).dot(t));G.initOrigin=(new i.Vector3).copy(o).add(a);var l=(new i.Vector3).copy(G.initOrigin);if(G.origin3D)l=new i.Line3(G.initOrigin,(new i.Vector3).copy(G.initOrigin).add(t)).closestPointToPoint(G.origin3D,!1);G.origin=l;var s=(new i.Vector3).copy(G.origin).sub(o).dot(t);if(G.direction=t,G.value=l.distanceTo(o)*(s>0?-1:1),G.initValue=G.value,A){let n;A.origin=G.origin,A.origin3DPos=G.origin3D,A.initOrigin=G.initOrigin,A.setValue(G.value),A.direction=G.direction,A.initValue=G.initValue,A.displayOrigin=Boolean(G.origin3D),P&&(n=P()),A.unit=n||r.getCurrentUnit("length").unit,A.display(),A.beginManipulation()}}else if("RotationBegin"===n.eventChannel){if(t=(new i.Vector3).copy(n.manipulator.axis),!I.direction||0===Math.round(100*t.dot(I.direction))){var u=new i.Vector3,g=new i.Vector3,p=new i.Vector3;O.getMatrix().extractBasis(u,g,p),u.normalize(),g.normalize();var d=Math.round(100*u.dot(t)),f=Math.round(100*g.dot(t));0===d?I.originVector=(new i.Vector3).copy(u):0===f&&(I.originVector=(new i.Vector3).copy(g)),I.value=0,I.direction=t}if(I.origin=(new i.Vector3).getPositionFromMatrix(O.getMatrix()),I.initValue=I.value,E){let n;E.originVector=I.originVector,E.setValue(I.value),E.origin=I.origin,E.direction=I.direction,E.initValue=I.initValue,R&&(n=R()),E.unit=n||r.getCurrentUnit("angle").unit,E.display(),E.beginManipulation()}}c&&c({robotMatrix:O.getMatrix(),from:"robot",axis:(new i.Vector3).copy(n.manipulator.axis),kind:"LineTranslationBegin"===n.eventChannel?"translation":"rotation",event:n.event})}function rn(n){if(h.setCursor("pointer"),K(),"LineTranslationManipulation"===n.eventChannel)G.value=G.initValue+n.translationVector.length()*(G.direction.dot(n.translationVector)>0?1:-1),A&&A.setValue(G.value);else if("RotationManipulation"===n.eventChannel){var e=(new i.Vector3).copy(n.axis),t=I.direction.dot(e)<0?2*Math.PI-n.angle:n.angle;I.value=I.initValue+180*t/Math.PI,E&&E.setValue(I.value)}n.translationVector&&g?g({robotMatrix:O.getMatrix(),axis:(new i.Vector3).copy(n.manipulator.axis),translationVector:n.translationVector,from:"robot",kind:"translation",event:n.event}):n.angle&&g&&g({robotMatrix:O.getMatrix(),axis:(new i.Vector3).copy(n.axis),rotationAngle:n.angle,from:"robot",kind:"rotation",event:n.event}),h.render({forceDynamicMode:!0})}function an(n){_(!0),Q(),"LineTranslationEnd"===n.eventChannel?A&&(A.endManipulation(),A.display()):"RotationEnd"===n.eventChannel&&E&&(E.endManipulation(),E.display()),w=!1,p&&p({robotMatrix:O.getMatrix(),from:"robot",axis:(new i.Vector3).copy(n.manipulator.axis),kind:"LineTranslationEnd"===n.eventChannel?"translation":"rotation",event:n.event}),K(!0),h.render({forceDynamicMode:!0})}function ln(){H||(H=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],(function(n,i){O&&((A=new n(V,{displayOrigin:!1,offset:150,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:x})).setVisibilityFree(!0),j.push(A.subscribe("OriginManipulateBegin",$)),A.onOriginManipulator=nn,j.push(A.subscribe("OriginManipulateEnd",en)),j.push(A.subscribe("RulerManipulateBegin",(function(n){tn(n)}))),j.push(A.subscribe("RulerManipulate",(function(n){tn(n)}))),j.push(A.subscribe("RulerManipulateEnd",(function(n){tn(n)}))),(E=new i(V,{radius:150,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0,lightDisplay:x})).setVisibilityFree(!0),z.push(E.subscribe("AngularRulerManipulateBegin",(function(n){tn(n)}))),z.push(E.subscribe("AngularRulerManipulate",(function(n){tn(n)}))),z.push(E.subscribe("AngularRulerManipulateEnd",(function(n){tn(n)}))))}))),S||(S=a.givePreferenceManager({context:V}))&&(B=S.subscribe("onPreferencesChanged",(function(){A&&A.getVisibleFlag()&&(A.unit=r.getCurrentUnit("length").unit,A.display()),E&&E.getVisibleFlag()&&(E.unit=r.getCurrentUnit("angle").unit,E.display())})))}function sn(n){d&&d({event:n.event}),h.setCursor("pointer"),w=!0,_(!1),O.arrowX.mat.opacity=.2,O.arrowY.mat.opacity=.2,O.arrowZ.mat.opacity=.2,O.translationPlaneYZ.planeMat.opacity=.2,O.translationPlaneXY.planeMat.opacity=.2,O.translationPlaneXZ.planeMat.opacity=.2,O.rotationArcYZ.planeMat.opacity=.2,O.rotationArcXZ.planeMat.opacity=.2,O.rotationArcXY.privilegedPlaneMat.opacity=.2,F=O.getMatrix(),Z=new i.Plane(h.currentViewpoint.getSightDirection()),ln()}O.snapTranslationCallback=function(n){var i=n.translationVector;if(A){var e=A.getSnappedTranslationVector(n);0===e.returnCode&&(i=e.snappedTranslationVector)}return i},O.snapRotationCallback=function(n){var i={value:180*n.angle/Math.PI,axis:n.axis};if(I.direction.dot(n.axis)<0&&(i.value=360-i.value),E){var e=E.getSnappedRotationValue(n);0===e.returnCode&&(i={value:e.snappedRotationAngle,axis:e.axis})}return i};var un=!1;W.push(O.subscribe("LineTranslationBegin",(function(n){on(n)}))),W.push(O.subscribe("RotationBegin",(function(n){on(n)}))),W.push(O.subscribe("ScalingBegin",(function(n){on(n)}))),W.push(O.subscribe("PlaneTranslationBegin",(function(n){on(n)}))),W.push(O.subscribe("LineTranslationManipulation",(function(n){rn(n)}))),W.push(O.subscribe("RotationManipulation",(function(n){rn(n)}))),W.push(O.subscribe("ScalingManipulation",(function(n){rn(n)}))),W.push(O.subscribe("PlaneTranslationManipulation",(function(n){rn(n)}))),W.push(O.subscribe("LineTranslationEnd",(function(n){an(n)}))),W.push(O.subscribe("RotationEnd",(function(n){an(n)}))),W.push(O.subscribe("ScalingEnd",(function(n){an(n)}))),W.push(O.subscribe("PlaneTranslationEnd",(function(n){an(n)}))),W.push(O.subscribe("ScreenPlaneTranslationBegin",(function(n){sn(n)}))),W.push(O.subscribe("ScreenPlaneTranslationManipulation",(function(n){!function(n){K(),q(),h.setCursor("pointer"),f&&f({event:n.event});var i=O.getMatrix().setPosition(n.intersection.ray.intersectPlane(Z));if(s){var e=s({event:n.event,viewer:h});Y=e&&e.robotMatrix.clone()}O.setRobotMatrix(Y||i),h.render({forceDynamicMode:!0})}(n)}))),W.push(O.subscribe("ScreenPlaneTranslationEnd",(function(n){!function(n){w=!1,_(!0),Q(),q(),J(),O.setRobotMatrix(Y||F);var e=O.getMatrix(),t=(new i.Vector3).getPositionFromMatrix(e);G.origin=t,G.initOrigin=t.clone(),G.baseOrigin=t.clone(),b&&b({event:n.event}),K(!0),h.render({forceDynamicMode:!0})}(n)}))),C=t.subscribe({event:"/VISU/"},(function(n){m&&("@onViewpointBeginMove"===n.eventType?un=!0:"@onViewpointChange"===n.eventType?un&&(O.setVisibility(!1),h.render({forceDynamicMode:!0})):"@onViewpointEndMove"===n.eventType&&(O.setVisibility(!0),un=!1,h.render({forceDynamicMode:!0})))})),this.disablePickingDuringManipulation=function(n){O.setDisablePickingDuringManipulation&&O.setDisablePickingDuringManipulation(n)},this.setPosition=function(n){if(!w){if(!n||!n.robotMatrix&&!n.translationRulerOrigin)throw new Error("No valid positions defined!");var e,t;n.robotMatrix&&(e=n.robotMatrix.clone(),t=(new i.Vector3).getPositionFromMatrix(e),O.setRobotMatrix(e),G.origin=t,G.initOrigin=t.clone(),G.baseOrigin=t.clone(),A&&(A.initOrigin=G.initOrigin,A.origin=G.origin)),n.translationRulerOrigin?G.origin3D=n.translationRulerOrigin.clone():null===n.translationRulerOrigin&&(G.origin3D=null),ln(),n.doNotResetRuler||J(),K(),h.render({forceDynamicMode:!0})}},this.setVisibility=function(n){if("boolean"!=typeof n)throw new Error("Argument must be a boolean");m=n,O.setVisibility(n),K(!0)},this.setPickable=function(n){_(n)},this.destroy=function(){W.forEach(O.unsubscribe,O),W=null,t.unsubscribe(C),C=null,S&&(B=S.unsubscribe(B)),S=B=null,h.removeNode(O),q(),A&&j.forEach(A.unsubscribe,A),E&&z.forEach(E.unsubscribe,E),O=V=h=null,A=E=null}}})}));