define("DS/MMPrint/MMPrintCmd",["DS/Windows/Dialog","DS/Controls/Button","DS/ApplicationFrame/Command","i18n!DS/MMPrint/assets/nls/MMPrint","DS/Visualization/ThreeJS_DS","DS/WAFData/WAFData","DS/WebUtils/WebServices","DS/Notifications/NotificationsManagerUXMessages","DS/WebUtils/PhaseProgress"],(function(e,t,n,i,r,o,a,s,c){"use strict";var l="",d="";function u(e,t,n,i,r,a,s){var c=i+"/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes",g=r,m={specificationFilter:[{format:"pdf",filterConversionParams:[{key:"streamId",value:"print"}]}],referencedObject:[{source:"3DSpace",type:"Drawing",relativePath:""}]};!0===s&&(m.specificationFilter[0].notifyIfMissing=!0),n?m.referencedObject[0].id=n.physicalid:e.experience&&(m.referencedObject[0].id=e.experience.args.input.asset.originalAsset.physicalid),o.authenticatedRequest(c,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:g},type:"json",data:JSON.stringify(m),onComplete:function(s){if(0==a&&s.notificationsForMissingObjects&&s.notificationsForMissingObjects[0]&&s.notificationsForMissingObjects[0].objects[0]&&"UnknownObject"==s.notificationsForMissingObjects[0].objects[0].notificationStatus)console.log("derivedOutputs is NULL"),v(e,t);else if(s.derivedOutputs&&s.derivedOutputs[0]&&s.derivedOutputs[0].derivedOutputFormats&&s.derivedOutputs[0].derivedOutputFormats[0]&&s.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===s.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===s.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){a=0;var c=i+"/api/v2/modeler/dsdo/DerivedOutputs/"+s.derivedOutputs[0].id+"/DerivedOutputFiles/"+s.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";o.authenticatedRequest(c,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){var t=e.data[0].dataelements,n=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true";console.log("Loading from DFA : "+n),p(n),d.resetProgress(),d.hideProgressBar(),setTimeout((()=>{l.style.display="none"}),2e3)},onFailure:function(n){console.log("onFailure download ticket"),v(e,t)}})}else{++a<7?(console.log("restart locate in 4000 ms"),setTimeout((()=>u(e,t,n,i,r,a,!1)),4e3)):(console.log("derivedOutputs is NULL"),v(e,t))}},onFailure:function(n){console.log("onFailure derivedOutputs"),v(e,t)}})}function g(e,t,n,i){var r=null,o=null;n?o=n.tenant:e.experience&&(o=e.experience.args.input.asset.originalAsset.tenant),async function(e){return await a.getSecurityContext(e)}(o).then((e=>(console.log("MMPrint ctx="+e),e))).then((function(s){a.getServiceUrl({serviceName:"derivedformataccess",platformId:o,onSuccess:function(o){r||(r=o.url),u(e,t,n,r,s,i,!0)},onError:function(n){console.error("OnFailure getServiceUrl()",n.error),v(e,t)}})}),(function(e){console.log("MMPrint- failed to read ctx="+e)}))}var p=function(e){o.authenticatedRequest(e,{proxy:"passport",method:"GET",responseType:"arraybuffer",onComplete:function(e){!function(e){var t=function(e,t="",n=512){for(var i=atob(e),r=[],o=0;o<i.length;o+=n){for(var a=i.slice(o,o+n),s=new Array(a.length),c=0;c<a.length;c++)s[c]=a.charCodeAt(c);var l=new Uint8Array(s);r.push(l)}var d=new Blob(r,{type:t});return d}(e,"application/pdf"),n=URL.createObjectURL(t),i=window.open(n);i.focus(),i.print()}(function(e){for(var t="",n=new Uint8Array(e),i=n.byteLength,r=0;r<i;r++)t+=String.fromCharCode(n[r]);return window.btoa(t)}(e))},onFailure:function(e){e&&console.log(e)}})};function m(e){try{!1===e.contentWindow.document.execCommand("print",!1,null)&&e.contentWindow.print()}catch(t){e.contentWindow.print()}}function v(n,o){var a={level:"info",title:i.get("DerivedOutputTitle"),message:i.get("DerivedOutputMessage")};s.addNotif(a);var c=n.experience,u=n.getImmersiveFrame(),g="udl";if(o&&o.svgStream&&(g="svg"),n&&c||o){var p=null;if(c&&null==o&&(p=c.args.input.asset),null!=p&&("svg"===p.type||"Drawing"===p.type||"V6Drawing"===p.type)||"svg"===g){var v=document.createElement("iframe");document.body.appendChild(v);var f=null,h=0,y=0;c&&null==o?(f=c.getSource(),h=c.getCurrentSheetIndex(),y=c.getNumberOfSheets()):(f=o.svgStream,h=o.currentSheetIndex,y=o.numberOfSheets);var w=f;if(1===y){var S=f.search("<svg");w=f.substring(S,w.length)}else w=function(e,t){var n=t.indexOf("<svg",t.search("<svg")+4),i=t.lastIndexOf("</svg>"),r=t.substring(n,i),o=r.split("<svg");return"<svg"+o[e+1]}(h,f);v.contentDocument.write(w.replaceAll(/(\<script)[\s\S]*?(<\/script\>)/gim,"")),v.contentDocument.documentElement.getElementsByTagName("body")[0].style.margin="0",v.position="fixed",v.top="0",v.left="100%",v.width="100%",v.height="100%",m(v),document.body.removeChild(v),v=null}else if(null!=p&&"udl"===p.type||"udl"===g){var b={GenerateCanvasSheet:function(e,t,n,i){e.currentViewpoint.reframe();var o,a,s,c,l=window.devicePixelRatio||1;o=e.currentViewpoint,a=e.SCREEN_HEIGHT*l/(o.camera.top-o.camera.bottom),s=i/a,c=o.getTargetDistance()/s,o.setTargetDistance(c);var d,u,g=n.width,p=n.height,m=new r.Vector3(e.SCREEN_WIDTH*l/i,0,0),v=new r.Vector3(0,e.SCREEN_HEIGHT*l/i,0),f=((u=new r.Vector3(0,n.height,0)).add(new r.Vector3(e.SCREEN_WIDTH*l/(2*i),-e.SCREEN_HEIGHT*l/(2*i),0)),u),h=0,y=0,w=0,S=0,b=0;t.set({height:p*i,width:g*i});for(var O=t.getContext("2d"),C=O.getImageData(0,0,t.width,t.height);y<=p;){for(h=0,S=0,d=f.clone();h<=g;){e.currentViewpoint.setEyePosition(d);var E,D,T={data:null,width:Math.floor(e.SCREEN_WIDTH*l),height:Math.floor(e.SCREEN_HEIGHT*l)};e.renderToTarget(T,e.currentViewpoint);for(var F=w*C.width*T.height*4,x=0;x<T.height;x++){D=F+x*C.width*4+S*T.width*4,E=(T.height-x-1)*T.width*4;for(var M=0;M<4*T.width;M+=4)T.width*S+M/4<=C.width&&(C.data[D+M]=T.data[E+M],C.data[D+M+1]=T.data[E+M+1],C.data[D+M+2]=T.data[E+M+2],C.data[D+M+3]=T.data[E+M+3])}T.data=null,T=null,d.add(m),h+=m.x,b=++S>b?S:b}f.sub(v),y+=v.y,w++}O.putImageData(C,0,0)}};v=document.createElement("iframe");document.body.appendChild(v);var O=n.getViewer(),C=UWA.createElement("canvas"),E=0,D=0;c&&null==o?(E=c.getCurrentSheet().id,D=c._UDLLoader.getSheetSize(E)):D=o.currentSheetSize;O.setReferenceAxisSystem(!1),b.GenerateCanvasSheet(O,C,D,5.5),O.setReferenceAxisSystem(!0);var T=C.toDataURL("image/png"),F=UWA.createElement("img");F.src=T,F.style.width="100%",v.contentDocument.write(F.outerHTML),v.contentDocument.documentElement.getElementsByTagName("body")[0].style.margin="0",v.position="fixed",v.top="0",v.left="100%",v.width="100%",v.height="100%",F.addEventListener("load",(function(){m(v),document.body.removeChild(v),v=null,F=null}),!0)}else{(M=document.createElement("div")).innerHTML="<p>"+i.printRealSizeError+"</p>",u.visibleFlag=!0;var x=new e({title:i.get("printErrorTitle"),content:M,immersiveFrame:u,buttons:{Ok:new t({onClick:function(e){x.destroy(),u.visibleFlag=!1,u=null}})}})}}else{var M;(M=document.createElement("div")).innerHTML="<p>"+i.printRealSizeError+"</p>",u.visibleFlag=!0;x=new e({title:i.get("printErrorTitle"),content:M,immersiveFrame:u,buttons:{Ok:new t({onClick:function(e){x.destroy(),u.visibleFlag=!1,u=null}})}})}d.resetProgress(),d.hideProgressBar(),setTimeout((()=>{l.style.display="none"}),2e3)}return n.extend({init:function(e){this._parent(e,{isAsynchronous:!1,mode:"exclusive"}),this._counter=0},beginExecute:function(){var e=this.getFrameWindow(),t=e.drawingPrintInfo,n=e.assetInfo,r={level:"info",title:i.get("PrintLaunchedTitle"),message:i.get("PrintLaunchedMessage")};s.addNotif(r),n?l=document.querySelector(".topBarContainer"):e.experience&&(l=document.querySelector(".PlayWeb-Progress-Container")),l.style.display="block";var o=new UWA.Element("div",{class:"linear-container"});o.inject(l),(d=new c({shape:"linear",infiniteFlag:!0,displayStyle:"lite"})).addProgressBarIntoUI(o),d.setIndeterminateState(),d.showProgressBar(),g(e,t,n,this._counter)}})}));