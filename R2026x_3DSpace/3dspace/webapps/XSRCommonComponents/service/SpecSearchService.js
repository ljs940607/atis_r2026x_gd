define("DS/XSRCommonComponents/service/SpecSearchService",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/utils/IndexServiceProvider","DS/XSRCommonComponents/utils/Notification"],(function(e,t,n,s,a,i,r,o){"use strict";return n.extend({predicates:["PID","name","revision","state","ds6w:realizedChangeAction","ds6w:proposedChangeAction","ds6w:changeRequired","ds6w:changeContext","ds6w:description","ds6w:label","ds6w:created","ds6wg:EnterpriseExtension.V_PartNumber","ds6w:identifier","ds6w:modified","ds6w:type","ds6w:responsible","ds6w:status","ds6wg:revision","ds6w:policy","ds6w:ManufacturerEquivalentItemExtension.ManufacturerName","owner","ds6w:status_value","ds6wg:ManufacturerEquivalentItemExtension.PartSource","ds6wg:ManufacturerEquivalentItemExtension.PartSourceURL","ds6wg:ManufacturerEquivalentItemExtension.ManufacturerPartNumber"],keyMapping:{resourceid:"physicalid","ds6w:modified":"modified","ds6w:status":"CURRENT","ds6w:label":"LABEL","ds6w:identifier":"name",preview_url:"thumbnail","ds6w:type":"type","ds6w:created":"originated","ds6w:description":"DESCRIPTION","ds6wg:revision":"revision","ds6w:policy":"policy","ds6wg:EnterpriseExtension.V_PartNumber":"partNumber","ds6w:what/ds6w:realizedChangeAction":"ds6w:realizedChangeAction","ds6w:what/ds6w:proposedChangeAction":"ds6w:proposedChangeAction","ds6w:what/ds6w:changeRequired":"ds6w:changeRequired","ds6w:what/ds6w:changeContext":"ds6w:changeContext","ds6w:when/ds6w:modified":"modified","ds6w:what/ds6w:status":"CURRENT","ds6w:what/ds6w:type":"type","ds6w:when/ds6w:created":"originated","ds6w:who/ds6w:responsible":"owner"},init:function(e){this.appCore=e.appCore,this.basicModelEvents=e.appCore.basicModelEvents,this.nextStart=0,this.total=null},getKeyMappings:function(){return this.keyMapping},getSpecifications:function(e,n){var s=this;s.selectedPanel=e.currentPanel;var o=i.getloginUser(),c=e.globalSearchQuery?e.globalSearchQuery.trim():"",u=""!==c,d={};return d=u?{key:"query",value:"("+a.TEXT_FLAT_TAXONOMY+':"'+a.TEXT_TYPES+"/"+a.TYPE_DOCUMENT+'" OR '+a.TEXT_FLAT_TAXONOMY+':"'+a.TEXT_TYPES+"/"+a.TYPE_VPMREFERENCE+'") AND NOT([ds6w:kind]:"ManufacturerEquivalentItemExtension") AND ('+e.filter+") AND NOT("+a.TEXT_POLICY+'=="'+a.POLICY_PRD_DATA_SPEC+'" OR '+a.TEXT_POLICY+'=="'+a.POLICY_RES_PRD_DATA_SPEC+'") AND owner=='+o.login+' AND (label:"'+c+'"OR description:"'+c+'"OR ds6wg_58_enterpriseextension_46_v_95_partnumber:"'+c+'"OR identifier:"'+c+'")'}:{key:"query",value:"("+a.TEXT_FLAT_TAXONOMY+':"'+a.TEXT_TYPES+"/"+a.TYPE_DOCUMENT+'" OR '+a.TEXT_FLAT_TAXONOMY+':"'+a.TEXT_TYPES+"/"+a.TYPE_VPMREFERENCE+'") AND NOT([ds6w:kind]:"ManufacturerEquivalentItemExtension") AND ('+e.filter+") AND NOT("+a.TEXT_POLICY+'=="'+a.POLICY_PRD_DATA_SPEC+'" OR '+a.TEXT_POLICY+'=="'+a.POLICY_RES_PRD_DATA_SPEC+'") AND owner=='+o.login},new t((function(e,t){(new r).searchSpecifications(d,s.predicates,s.nextStart,void 0).then((function(n){s.processRecentsData(n,u).then((function(t){e(t)})).catch((function(e){console.log(e),t()}))})).catch((function(e){console.log(e),t()}))}))},getSearchData:function(e,n){var s,a=this;return s={key:"query",value:'(flattenedtaxonomies:"types/'+e+'")'},new t((function(e,t){(new r).searchSpecifications(s,a.predicates,0,n,void 0).then((async function(t){let n=await a.processSearchResult(t);e(n)})).catch((function(e){console.log(e),t()}))}))},getRecentSpecsData:function(){var e=this;return new t((function(t,n){var s={key:"select_type",value:[a.TYPE_DOCUMENT,a.TYPE_VPMREFERENCE]};return(new r).recentSpecifications(s,e.predicates,e.nextStart).then((function(s){s?t.call(e,s):n()}))}))},processSearchResult:async function(e){var t=this;let n=this.getKeyMappings();var s=[];"string"==typeof e&&(e=JSON.parse(e));var i=e.infos.nresults,r=e.results;t.nextStart=e.infos.next_start,t.total=e.infos.nhits;for(var o=0;o<i;o++){var c,u=r[o].attributes,d=[];(c={}).isMEI=!1;for(var l=0;l<u.length;l++){var E=u[l],p=E.name;"ds6wg:ManufacturerEquivalentItemExtension.ManufacturerPartNumber"===p&&(c.isMEI=!0),n.hasOwnProperty(p)?(c[n[p]]=E.value,E.value&&(c[n[p].concat("actualValue")]=E.value)):(c[E.name]=E.value,"ds6w:what/ds6w:kind"===p&&d.push(E.value),E.value&&(c[E.name.concat("actualValue")]=E.value))}(c=await t.resolveNLSTypeAndState(c)).kindOfs=d,"Version"!==c.policy&&c.policy!==a.POLICY_PRD_DATA_SPEC&&c.policy!==a.POLICY_RES_PRD_DATA_SPEC&&s.push(c)}return s},_combinewithRecents:function(e,t){for(var n=this,s=0;s<t.length;s++){for(var a=t[s],i=a.physicalid,r=!1,o=0;o<e.length;o++){if(e[o].physicalid===i){r=!0;var c=a.CURRENT;n.isNodeStatebelongsToPanel(c,n.selectedPanel)?Object.assign(e[o],a):e.splice(o,1),o=e.length+1}}r||n.isNodeStatebelongsToPanel(a.CURRENT,n.selectedPanel)&&e.push(a)}return e},resolveNLSTypeAndState:async function(e){var t={"ds6w:type":[e.type],"ds6w:status":[e.CURRENT]};let n=await s.getNlsOfPropertiesValues(t);return e.type=n["ds6w:type"]?n["ds6w:type"][e.type]:e.type,e.CURRENT=n["ds6w:status"]?n["ds6w:status"][e.CURRENT]:e.CURRENT,e},processRecentsData:function(e,n){var s=this;return new t((function(t,n){s.getRecentSpecsData().then((async function(n){var a=await s.processSearchResult(n);"string"==typeof e&&(e=JSON.parse(e)),s.nextStart=e.infos.next_start,s.total=e.infos.nhits;var i=await s.processSearchResult(e);a&&a.length>0?t(s._combinewithRecents(i,a)):t(i)})).catch((function(e){s.displayErrorNotification(e)}))}))},isNodeStatebelongsToPanel:function(e,t){var n=e?e.toUpperCase():void 0;if(n)return t===a.WELCOMEPANEL_ID_INWORK?n!=="Released".toUpperCase()&&n!=="Obsolete".toUpperCase():t===a.WELCOMEPANEL_ID_RELEASED?n==="Released".toUpperCase():t===a.WELCOMEPANEL_ID_OBSOLETE?n==="Obsolete".toUpperCase():void 0},displayErrorNotification:function(e){console.log(e),o.displayNotification({eventID:"error",msg:e.message})},allUserData:function(){var e=this,n=i.getloginUser(),s={key:"query",value:"("+a.TEXT_FLAT_TAXONOMY+':"'+a.TEXT_TYPES+"/"+a.TYPE_DOCUMENT+'" OR '+a.TEXT_FLAT_TAXONOMY+':"'+a.TEXT_TYPES+"/"+a.TYPE_VPMREFERENCE+'") AND NOT('+a.TEXT_POLICY+'=="'+a.POLICY_PRD_DATA_SPEC+'" OR '+a.TEXT_POLICY+'=="'+a.POLICY_RES_PRD_DATA_SPEC+'") AND '+a.TEXT_OWNER+"=="+n.login};return new t((function(t,n){(new r).searchSpecifications(s,e.predicates,e.nextStart,void 0).then((async function(n){"string"==typeof n&&(n=JSON.parse(n));var s=await e.processSearchResult(n);t(s)})).catch((function(e){console.log(e),n()}))}))}})}));