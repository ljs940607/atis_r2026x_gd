define("DS/XSRCommonComponents/utils/DocumentServiceProvider",["UWA/Class/Model","UWA/Promise","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/Constants","DS/DocumentManagement/DocumentManagement","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/RequestUtil"],(function(e,t,n,o,r,a,i){"use strict";var d;return e.extend({convertb64toBlob:function(e,t,n){t=t||"",n=n||512;for(var o=atob(e),r=[],a=0;a<o.length;a+=n){for(var i=o.slice(a,a+n),d=new Array(i.length),l=0;l<i.length;l++)d[l]=i.charCodeAt(l);var u=new Uint8Array(d);r.push(u)}return new Blob(r,{type:t})},defaults:{generatePDF:!1},setup:function(e){this.id=e&&e.id?e.id:"",d=i.getPlatformId()},getDocumentsFromParent:function(e,n){return new t((function(t,a){console.log("************start********"+new Date);var d={getVersions:!0,relInfo:{parentId:e,parentRelName:n||o.RELATED_DOC_REL_NAME,parentDirection:"from"},tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),onComplete:function(e){Array.isArray(e.data)&&(console.log("************end********"+new Date),t(e.data))},onFailure:function(e){a(e)}};r.getDocumentsFromParent(d)}))},createDocument:function(e,n,a){return new t((function(t,d){var l=a.title||e.name,u=a.description?a.description:"",c=a.type?a.type:"",s=a.policy?a.policy:"",m=a.relationName?a.relationName:"",f={title:l,description:u,type:c,policy:s};e&&(f.fileInfo={comments:"",file:e}),n&&(f.relInfo={parentId:n,parentRelName:m||o.RELATED_DOC_REL_NAME,parentDirection:"from"});var p={tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),onFailure:d,onComplete:function(e){Array.isArray(e.data)&&t(e.data)}};r.createDocument(f,p)}))},deleteDocument:function(e){var n=e;if(n)return new t((function(e,t){var o={tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),onComplete:e,onFailure:t};r.deleteDocument(n,o)}))},detachDocuments:function(e,n,o){var r=this,a=[];return new t((function(i,d){e.length&&e.length>0&&(e.forEach((function(e){var t=r.removeDocument(e,n,o);t&&a.push(t)})),t.all(a).then(i.bind(this)).catch(d.bind(this)))}))},removeDocument:function(e,n,a){var d=e;if(d)return new t((function(e,t){var l={relInfo:{parentId:n,parentRelName:a||o.RELATED_DOC_REL_NAME,parentDirection:"from"},tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),onComplete:e,onFailure:t};r.disconnectDocumentFromParent(d,l)}))},attachDocument:function(e,n,a){return new t((function(t,d){var l={relInfo:{parentId:e,parentRelName:a||o.RELATED_DOC_REL_NAME,parentDirection:"from"},tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),onComplete:t,onFailure:d};r.connectDocumentToParent(n,l)}))},uploadFile:function(e){var n=(e=e.data).itemPid,o=e.files[0]||e.files,a=e.fileComments?e.fileComments:" ",d=i.getSecurityContext(),l=this,u={};return u.file=o,u.fileName=o.name,a&&(u.comments=a),"modify"!==e.mode?new t((function(e,t){var o={securityContext:d,additionalHeaders:i.getWorkUnderHeaders(),tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),onComplete:function(t){e.call(l,t)},onFailure:t};r.addFileToDocument({id:n,fileInfo:u},o)})):new t((function(e,t){var o={securityContext:d,additionalHeaders:i.getWorkUnderHeaders(),tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),onComplete:function(t){e.call(l,t)},onFailure:t};r.modifyDocument({id:n,fileInfo:u,newFile:!1},o)}))},updateAttributes:function(e){var n={requests:[]},o={method:"PATCH",body:[],queryParams:{select:["physicalid","modified"]}},r=e.request;o.path="model/bus/"+e.itemid,o.body=[];for(var a=0;a<r.length;a++){var l={},u=r[a];l.op="replace",l.path=u.attribute,l.value=u.value,o.body.push(l),u.isBasicAttribute?o.queryParams.select.push(u.attribute):o.queryParams.select.push("attribute["+u.attribute+"]")}return n.requests.push(o),new t((function(e,t){i.send3DSpaceRequest("resources/v1/collabServices/attributes/op/update?="+d,"PUT",{type:"json",headers:{"Content-type":"application/json;"},data:JSON.stringify(n)},e,t)}))},getDocumentInfo:function(e){return new t((function(t,n){var o=this,a=e.data,d=!!a.getVersions,l=a.itemPid&&Array.isArray(a.itemPid)?a.itemPid:[a.itemPid],u={getVersions:d,tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),onComplete:function(e){var n=e.data;n&&UWA.is(n,"array")&&(n=n[0]),t.call(o,n)},onFailure:n};r.getDocuments(l,u)}))},downloadFile:function(e){var n=e.data,o=n.itemPid,a=n.versionId,d=n.checkout,l=(n.filename,i.getSecurityContext());return new t(d?function(e,t){var n={securityContext:l,tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),autoDownload:!0,onComplete:e,onFailure:t};r.downloadDocument(o,a,d,n)}:function(e,t){var n={securityContext:l,tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),autoDownload:!0,onComplete:e,onFailure:t};r.downloadDocument(a,void 0,d,n)})},downloadDocuments:function(e){var n=this,o=function(e){e&&Array.isArray(e)&&e.forEach((function(e){var t=e.downloadUrl,o=e.fileName,r=e.errorMessage;r?console.log("Failed to download : "+r):n.downloadFileFromFCS(t,o)}))},a=e.itemIds;return new t((function(e,t){var n={tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),autoDownload:!0,onFailure:function(e){var n=e.data&&e.data[0]?e.data[0].updateMessage:e;t(n)},onComplete:o.bind(this)};r.downloadDocuments(a,n)}))},downloadFileFromFCS:function(e,t){var n=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(e){200==this.status&&function(e,t){n.downloadFileonBrowser({blob:e,fileName:t})}(this.response,t)},o.onerror=function(e){console.log("error")},o.send()},generatePDFReport:function(e){return this.set("generatePDF",!0),new a({id:"generatePDFReport"}).invoke({data:e})},checkout:function(e){var n=this,o=function(t,o){var r=new a({id:e.webservice?e.webservice:"downloadPDFReport"}),i={data:e};r.invoke(i).then((function(e){var o=n.convertb64toBlob(e.fileContent,"application/pdf");t({blob:o,generatedTime:e.generatedTime,fileName:e.fileName,isTemplateObsolete:e.isTemplateObsolete})}),o)};return new t((function(e,t){o.call(n,e,t)}))},downloadPDFReport:function(e){var t=this;t.checkout.call(t,e).then(t.downloadFileonBrowser.bind(this))},downloadFileonBrowser:function(e){n.downloadFileonBrowser(e)},isPDFReportCheckedIn:function(e){return new a({id:"isPDFReportCheckedIn"}).invoke({data:e})}})}));