define("DS/DMUBaseUIControllers/DMUWebPreferencesController",["require","exports","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CoreEvents/ModelEvents"],(function(e,t,n,i,o){"use strict";let r;const a=new o,l=function(e){let t;if(e)switch(e.toLowerCase()){case"length":t="Length";break;case"area":t="Area";break;case"angle":t="Angle";break;case"volume":t="Volume";break;case"mass":t="Mass"}return t},s=e=>{const t=JSON.parse(e[1].preferences).repositories;let n=!1;for(let e=0;e<t.length;e++)if(t[e].preferences&&t[e].preferences.length>0)for(let i=0;i<r.repositories.length;i++)if(r.repositories[i].name===t[e].name)for(let o=0;o<r.repositories[i].preferences.length;o++)for(let a=0;a<t[e].preferences.length;a++)r.repositories[i].preferences[o].name===t[e].preferences[a].name&&(r.repositories[i].preferences[o].value=t[e].preferences[a].value,n=!0);n&&((e,t)=>{a&&a.publish({event:e,data:t})})("onDMUWebpreferencesUpdate",r)};class d{static async init(e){let t=i.givePreferenceManager({context:e.context.getFrameWindow()});return t||(t=i.getPreferenceManager({context:e.context.getFrameWindow()})),t.subscribe("com.ds.mep:onPrefUpdate",s),r=await(async e=>{let t;try{return t=await n.readPreferences(e),r=t,t}catch(e){return t={repositories:[{name:"cke",preferences:[{name:"TrailingZeros",datatype:"boolean",value:!1},{name:"Length",datatype:"enum",value:"Millimeter"},{name:"LengthDisplay",datatype:"uint",value:"3"},{name:"LengthCalcDisplay",datatype:"uint",value:"3"},{name:"Angle",datatype:"enum",value:"Degree"},{name:"AngleDisplay",datatype:"uint",value:"3"},{name:"AngleCalcDisplay",datatype:"uint",value:"3"},{name:"Volume",datatype:"enum",value:"CubMm"},{name:"VolumeDisplay",datatype:"uint",value:"3"},{name:"VolumeCalcDisplay",datatype:"uint",value:"3"},{name:"Area",datatype:"enum",value:"SqMm"},{name:"AreaDisplay",datatype:"uint",value:"3"},{name:"AreaCalcDisplay",datatype:"uint",value:"3"},{name:"Mass",datatype:"enum",value:"Kilogram"},{name:"MassDisplay",datatype:"uint",value:"3"},{name:"MassCalcDisplay",datatype:"uint",value:"3"}]},{name:"MeasureRepository",preferences:[{name:"DMUMeasureRemovePreviousNonPersistent",datatype:"boolean",value:"false"},{name:"DMUMeasureCenterValue",datatype:"boolean",value:"true"}]},{name:"DMURepository",preferences:[{name:"ValidationRestrictedAccess",datatype:"enum",value:"Activated"},{name:"ReviewRestrictedAccess",datatype:"enum",value:"Deactivated"}]}]},r=t,t}})([{Repository:"cke",PreferenceNames:["TrailingZeros","Length","LengthDisplay","LengthCalcDisplay","Angle","AngleDisplay","AngleCalcDisplay","Volume","VolumeDisplay","VolumeCalcDisplay","Area","AreaDisplay","AreaCalcDisplay","Mass","MassDisplay","MassCalcDisplay"]},{Repository:"MeasureRepository",PreferenceNames:["DMUMeasureRemovePreviousNonPersistent","DMUMeasureCenterValue"]},{Repository:"DMURepository",PreferenceNames:["ValidationRestrictedAccess","ReviewRestrictedAccess"]}]),r}static readPreferences(e){let t=[];for(let n=0;n<r.repositories.length;n++)if(r.repositories[n].name===e.name)for(let i=0;i<e.PreferenceNames.length;i++)for(let o=0;o<r.repositories[n].preferences.length;o++)r.repositories[n].preferences[o].name===e.PreferenceNames[i]&&t.push(r.repositories[n].preferences[o]);return{name:e.name,preferences:t}}static convertUnitValueToString(e,t,i,o,r,a,s=!1){let u=l(e),c=i&&i.getDMUPreferenceRepository?i.getDMUPreferenceRepository().getPreference(e):null;null===c&&(c=d.readPreferences({name:"cke",PreferenceNames:[e]}).preferences[0].value);const g=d.readPreferences({name:"cke",PreferenceNames:[u+"CalcDisplay"]}).preferences[0].value,p={displaySpace:!0!==o&&void 0,displaySymbol:!0!==r&&void 0,displayFeetInchFractionOrDecimal:!0===s||void 0};let m=e;switch(m.toLowerCase()){case"length":u="Length";break;case"area":u="Area";break;case"angle":u="Angle";break;case"volume":u="Volume"}return t*=function(e){let t;if(e)switch(e){case"Length":t=Math.pow(10,-3);break;case"Angle":t=Math.PI/180;break;case"Volume":t=Math.pow(10,-9);break;case"Area":t=Math.pow(10,-6)}return t}(m),n.convertUnitValueToString(t,u,c,g,a,p)}static getCurrentUnit(e){const t=l(e);if(!t)return window.console.warn("Magnitude not supported"),{unit:"",nls:""};let i=this.readPreferences({name:"cke",PreferenceNames:[t]}).preferences[0].value;const o=this.readPreferences({name:"cke",PreferenceNames:[t+"Display"]}).preferences[0].value,r=this.readPreferences({name:"cke",PreferenceNames:[t+"CalcDisplay"]}).preferences[0].value,a=n.Types[t];return i||(i=a.defaultValue),{unit:i,nls:n[t][i].symbol,decimalPlaceRW:o,decimalPlaceRO:r}}static subscribe(e,t){if(e&&t&&a)return a.subscribe({event:e},t)}static unsubscribe(e){a&&e&&a.unsubscribe(e)}}return d})),define("DS/DMUBaseUIControllers/utils/OpenWithMenuBuilder",["UWA/Core","UWA/Promise","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/i3DXCompassPlatformServices/OpenWith"],(function(e,t,n,i,o){"use strict";function r(){}var a;return r.prototype={openWithApps:function(r,a){return new t((function(l,s){if(r&&r.type&&r.id){let s={options:{}};s.options.type=r.type,s.options.serviceId=r.service,s.options.grid={},s.getID=function(){return r.id},s.getLabel=function(){};let c=[];c.push(s);c&&c.length&&c[0].options&&c[0].options.type&&"Requirement"===c[0].options.type?(d=c[0],u=function(t){var n=new o;n.set3DXContent(t,!0),e.is(n.retrieveCompatibleApps,"function")?n.retrieveCompatibleApps((function(e){var t=[];e.forEach((function(e){t.push({type:"PushItem",title:e.text,fonticon:e.fonticon&&e.fonticon.length>0?{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+e.fonticon,family:WUXManagedFontIcons.Font3DS}:void 0,icon:e.icon?e.icon:"",action:{callback:function(){e.handler()}}})})),l(t)})):l([])},new t(((e,t)=>{var o=d.getID(),r=a?a.get3DSpaceUrl():n.get3DSpaceUrl();let l=encodeURI(`${r}/resources/trm/dictionary/info?pid=${o}&select=type,attribute[Content Data],attribute[Title],attribute[Content Text]`);require("DS/WAFData/WAFData").authenticatedRequest(l,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:i.getSetting("pad_security_ctx")},timeout:6e4,onComplete:function(e){let o=JSON.parse(e);if(o&&"success"===o.status&&o.results[0]){var r=o.results[0],a={protocol:"3DXContent",version:"1.1",source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):void 0,widgetId:window.widget&&window.widget.id?window.widget.id:void 0,data:{items:[{envId:n.getPlatformId(),serviceId:"3DSpace",contextId:i.getSetting("pad_security_ctx")?i.getSetting("pad_security_ctx"):void 0,objectId:d.getID(),objectType:r.type.value,displayName:r["attribute[Content Text]"],displayType:r.type.displayName,displayPreview:r.thumbnails,displayIcon:r.type_icon_url}]}};u(a)}else t(new Error("Requirement has no content"))},onFailure:function(){t(new Error("Requirement content Request Failed"))},onTimeout:function(){t(new Error("Requirement content Request Timeout"))}})}))):function(e,t){var o=[];e.forEach((function(e){-1===o.indexOf(e.options.type)&&o.push(e.options.type)})),require(["DS/PADUtils/PADTypesMgt"],(function(r){r.retrieveHierarchy(o,(function(o){var r={protocol:"3DXContent",version:"1.1",source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):void 0,widgetId:window.widget&&window.widget.id?window.widget.id:void 0,data:{items:[]}};e.forEach((function(e){!0!==e.isGroupingNode&&r.data.items.push(function(e,t){var o=[e.options.type];return t&&t[e.options.type]&&(o=t[e.options.type]),{envId:n.getPlatformId(),serviceId:e.options.serviceId?e.options.serviceId:"3DSpace",contextId:i.getSetting("pad_security_ctx")?i.getSetting("pad_security_ctx"):void 0,objectId:e.getID(),objectType:e.options.type,objectTaxonomies:o,displayName:e.options.display?e.options.display:e.getLabel(),displayType:e.options.grid["ds6w:type"]}}(e,o))})),t(r)}))}))}(c,(function(t){var n=new o;n.set3DXContent(t,!0),e.is(n.retrieveCompatibleApps,"function")?n.retrieveCompatibleApps((function(e){var t=[];e.forEach((function(e){t.push({type:"PushItem",title:e.text,fonticon:e.fonticon&&e.fonticon.length>0?{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+e.fonticon,family:WUXManagedFontIcons.Font3DS}:void 0,icon:e.icon?e.icon:"",action:{callback:function(){e.handler()}}})})),l(t)})):l([])}))}else s(new Error);var d,u}))}},a||(a=new r),a})),define("DS/DMUBaseUIControllers/DMUReqCompareController",["require","exports","DS/CATWebUXComponents/DMUCommandsManager","DS/HTMLCompareLib/HTMLDiff","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/DMUControls/EXPNotify","DS/DMUMeasurable/DMUToolsSceneGraph","UWA/Utils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/DMUControls/DMURequirementCompareLegend","DS/DMUBaseExperience/DMUContextManager"],(function(e,t,n,i,o,r,a,l,s,d,u,c,g,p,m,f){"use strict";let h=[];class v{constructor(e){let t,h,v,C,D,b,M,y,w,S,E,x,U,O,P,I=this,R=e.context,A=f.giveEventsController({viewer:R.getViewer()}),k={},T=[],V=!1,j=0,F=!0,N=u.givePreferenceManager({context:R.getFrameWindow()});function L(e,t){E&&(E.destroy(),E=null),E=new l({body:R.getFrameWindow().getUIFrame(),type:e,message:t})}function B(e=!0){if(b=null,M=void 0,s.getNodeID(R.getRoots()[0])===t&&e){if(j++,I.updateSideBarData(),A){let e=R.getViewer(),n=null==e?void 0:e.currentViewpoint;n&&(C=n.getTargetDistance(),D=n.getEyePosition()),A.fireEvent("on2DDocumentLoadRequired",{documentType:S&&S[t]?S[t]["ds6w:type"]:void 0,rootID:t,objectName:S&&S[t]?S[t]["ds6w:label"]:void 0})}}else s.getNodeID(R.getRoots()[0])===v&&R.removeRoots({pids:[v]});W()}function W(){b=null,R&&R.getRoots()&&R.getRoots().length&&!V&&(w&&w.clear(),S=[]),x&&x.clean(),x=null,r.empty(),a.empty()}function H(e,t,i){let r=p.giveWebDocumentVisualizationController({context:R}),a=f.getReviewContext({viewer:R.getViewer()});r&&a&&(r.removeDocument(),r.loadDocumentStream({phyId:t?h+"_"+v:h,type:"Requirement",elementsToLoad:e,fatherNode:R.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:async()=>{let e=R.getFrameWindow().getViewer(),r=e?e.currentViewpoint:void 0;r&&(r.setTargetDistance(C),r.setEyePosition(new o.Vector3(D.x,D.y,D.z)),e.render()),t&&function(){let e=I.getActiveCompareTitle();if(e){let t=e[0],n=e[1];x=new m(R.getFrameWindow()),x.build({leftButtonColor:O,rightButtonColor:P,firstReqName:t,secondReqName:n})}}();let a=f.getReviewContext({viewer:R.getViewer()}),l=null==a?void 0:a.getVisibleMarkups();F&&l&&l.length&&(t&&b||j)&&await async function(){let e=f.getReviewContext({viewer:R.getViewer()}),t=e?e.getValidation():null,n=t?t.getMarkups():[null==e?void 0:e.getCurrentSessionMarkup()];if(F&&n&&n.length){let e=[];n.forEach((n=>{let i=t&&n.getRepRef?n.getRepRef().getMarkupContent():n;if(i){let t=i.getSlides();if(b){let e=!1;for(let n=0;n<t.length;n++)if(t[n].getDMUObjects("DMUCompareRequirement").length){let o=t[n].getDMUObjects("DMUCompareRequirement")[0].getAttribute("oSelections");if(o&&o.length>1&&o[0].id===h&&o[1].id===v){i.setCurrentSlide(t[n]),e=!0;break}}e||i.setCurrentSlide(null)}else i.setCurrentSlide(t[0]);e.push(i)}}));let i=f.getReviewContext({viewer:R.getViewer()});i&&await i.setVisibleMarkups(e)}}();let s=n.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",R.getCommandContext());s&&"true"===localStorage.getItem("DMUBookmarksPanelDisplayed")&&(s.setState(!1),s.setState(!0)),t&&b?b.fireEvent("onRequirementComparisonDisplayed",{dmuObject:b}):A&&A.fireEvent("onRequirementComparisonEnded",void 0),i&&i(),j--},onFailure:()=>{L("info",g.comparisonFailed),window.console.warn("Issue in loading the document"),I.toggleRequirementCompareCmd(!1)}}))}function q(){null==x||x.update({leftButtonColor:O,rightButtonColor:P});let e=p.giveWebDocumentVisualizationController({context:R});e&&e.isADocumentDisplayed()&&(e.setCompareColor(O,P),e.renderDocument())}this.getActiveCompareFeature=function(){return b},this.isRequirementCompareActive=function(){return Boolean(b)},this.loadCompareRequirement=function(e,n,o){n?(y=e,y.forEach((e=>{let t;t=e.pathId.split("/").pop(),T.push(t),w.set(e.pathId,e)})),R.getController().getAttributes({ids:T,attributes:["ds6wg:revision","logicalid","versionid","ds6w:type","ds6w:label"],callbacks:{onComplete:async function(e){S=e;let r=function(){let e=[],n=[],i=[],o=[],r=[],a=[];M&&M.forEach((t=>{let n=t.pathId.split("/").pop();e.push(t.pathId),r.push(n),S&&S[n]&&S[n].logicalid&&i.push(S[n].logicalid)}));y.forEach((e=>{let t=e.pathId.split("/").pop();n.push(e.pathId),a.push(t),S&&S[t]&&S[t].logicalid&&o.push(S[t].logicalid)}));let l=new Map;function s(t,i,o,r,a=!1){for(let n=t;n<o-1;n++)l.set(e[n],null);for(let e=i;e<r-1;e++)l.set(n[e],null);a||l.set(e[o-1],n[r-1])}let d=new Map,u=new Map;for(let e=0;e<o.length;e++){let t=JSON.stringify({logID:o[e],occ:0});if(d.has(t)){let n=u.get(o[e])+1;t=JSON.stringify({logID:o[e],occ:n}),d.set(t,e+1),u.set(o[e],n)}else d.set(t,e+1),u.set(o[e],0)}let c=[];for(let e=0;e<i.length;e++){let t=JSON.stringify({logID:i[e],occ:0});d.has(t)&&c.push(d.get(t))}function g(e,t){const n=e.length,i=t.length,o=Array.from({length:n+1},(()=>Array(i+1).fill(0)));for(let r=1;r<=n;r++)for(let n=1;n<=i;n++)e[r-1]===t[n-1]?o[r][n]=o[r-1][n-1]+1:o[r][n]=Math.max(o[r-1][n],o[r][n-1]);let r=o[n][i];const a=Array(r).fill(null);let l=n,s=i;for(;l>0&&s>0;)e[l-1]===t[s-1]?(a[r-1]=l,l--,s--,r--):o[l-1][s]>o[l][s-1]?l--:s--;return a}let p=g(i,o),m=g(o,i);t!==h&&(0===m.length||1===p.length&&r[p[0]]!==h)&&(p[0]=r.indexOf(h)+1,m.push(1));let f=S&&S[v]?S[v]["ds6w:type"]:"",C=S&&S[h]?S[h]["ds6w:type"]:"";if(0===m.length)if(p=[],"Requirement"===C&&"Requirement"===f){let e=r.length>a.length?a.length:r.length;for(let t=1;t<=e;t++)p.push(t),m.push(t)}else if("Requirement Specification"===C&&"Requirement Specification"===f||"Requirement"===C&&"Requirement Specification"===f||"Requirement Specification"===C&&"Requirement"===f){let e,t;for(let n=0,i=0;n<r.length&&i<a.length;)e=r[n],t=a[i],S[e]&&S[t]&&(S[e]["ds6w:type"]===S[t]["ds6w:type"]||"Requirement"===S[e]["ds6w:type"]&&"Comment"===S[t]["ds6w:type"]||"Comment"===S[e]["ds6w:type"]&&"Requirement"===S[t]["ds6w:type"]?(p.push(n+1),m.push(i+1),n++,i++):i++)}let D=0,b=0;for(let e=0;e<p.length;e++){s(D,b,p[e],m[e]),D=p[e],b=m[e],p.length-1===e&&s(D,b,i.length+1,o.length+1,!0)}return l}();if(r&&r.size){let e=function(e){let t=[];return e.forEach(((e,n)=>{let o;if(w.has(n)&&(o=w.get(n)),o)if(e){let r=e.split("/").pop(),a=n.split("/").pop(),l=a&&S[a]?S[a]["ds6wg:revision"]:"",s=r&&S[r]?S[r]["ds6wg:revision"]:"",d=o.content;d&&(d=d.replaceAll("&lt;","<"),d=d.replaceAll("&gt;",">"));let u,c=w.get(e);if(c&&c.content){u=c.content,u=u.replaceAll("&lt;","<"),u=u.replaceAll("&gt;",">");const e={ignoreWhiteSpaceDifferences:!0,matchGranularity:100,combineWords:!1};let n=i.default(d,u,e),r=i.default(o.title+" "+l,c.title+" "+s,e),a=i.default(o.content+" "+l,c.content+" "+s,e),g={...o,content:"Chapter"===o.type?a:n,pathId:o.pathId+"_"+c.pathId,displayTitle:o.title+" "+l+" | "+c.title+" "+s,title:r};t.push(g)}}else t.push(o)})),t}(r);if(e&&e.length){try{let e=(await c.readPreferences([{Repository:"DMURepository",PreferenceNames:["CompareFirstColor","CompareSecondColor"]}])).repositories[0].preferences;for(let t=0;t<e.length;t++)"CompareFirstColor"===e[t].name?O=e[t].value:"CompareSecondColor"===e[t].name&&(P=e[t].value)}catch(e){O="#CC092F",P="#6FBC4B",window.console.warn("Could not get server value, default value set instead.",e)}let i=p.giveWebDocumentVisualizationController({context:R});null==i||i.setCompareColor(O,P),function(e){if(e){let n=[],i=[],o=[];for(let e=0;e<y.length;e++)n.push(y[e].pathId);e.forEach(((e,r)=>{e||(-1!==n.indexOf(r)?o.push(r):t===h&&i.push(r))})),(i.length||o.length)&&I.updateSideBarData(i,o)}}(r),H(e,n,o)}}else L("info",g.compareNoObjectToCompare),I.toggleRequirementCompareCmd(!1)},onFailure:function(){L("info",g.compareServerFailed),I.toggleRequirementCompareCmd(!1)}}})):(H(e,n,o),h="",v="")},this.updateSideBarData=function(e=[],t=[]){let n=p.giveWebDocumentVisualizationController({context:R});n&&n.setRequirementCompareData({firstReqData:e,secondReqData:t})},this.getActiveCompareTitle=function(){if(b&&S&&S[h]&&S[h]["ds6w:label"]&&S[v]&&S[v]["ds6w:label"]){return[S[h]&&S[h]["ds6wg:revision"]?S[h]["ds6w:label"]+" "+S[h]["ds6wg:revision"]:S[h]["ds6w:label"],S[v]&&S[v]["ds6wg:revision"]?S[v]["ds6w:label"]+" "+S[v]["ds6wg:revision"]:S[v]["ds6w:label"]]}},this.isLoading=function(){return j>0},this.displayRequirementComparison=function(e){if(!e)return;let n=s.getRootReferences(R.getFrameWindow().getViewer())[0];n&&(t=s.getNodeID(n));let i=e.getAttribute("oSelections");if(i&&i.length>1&&(h=i[0].id,v=i[1].id),R){let n=R.getViewer(),i=n?n.currentViewpoint:n;if(i&&(C=i.getTargetDistance(),D=i.getEyePosition()),W(),V=!1,b=e,!M){let e=p.getWebDocumentVisualizationController({context:R});M=e?e.getLoadedReqElement():void 0}M&&M.length&&(w=new Map,T=[t,v],M.forEach((e=>{let t=e.pathId.split("/").pop();T.push(t),w.set(e.pathId,e)})),R.getController().getAttributes({ids:[v],attributes:["ds6w:type","ds6w:label"],callbacks:{onComplete:function(e){A&&(j++,A.fireEvent("on2DDocumentLoadRequired",{documentType:e&&e[v]?e[v]["ds6w:type"]:void 0,rootID:v,objectName:e&&e[v]?e[v]["ds6w:label"]:void 0}),I.toggleRequirementCompareCmd(!0),r.empty(),a.empty())},onFailure:function(){L("info",g.compareServerFailed),I.toggleRequirementCompareCmd(!1)}}}))}},this.clean=function(){if(B(!1),A){let e=Object.keys(k);for(let t=0;t<e.length;t++)A.removeEvent(k[e[t]]||"")}U&&(N.unsubscribe(U),U=null),k={}},this.toggleRequirementCompareCmd=function(e){let t=setInterval((function(){let i=n.getCommandCheckHeader("DMUReqCompareCmdHdr",R.getCommandContext());i&&(clearInterval(t),i.getState()!==e?i.setState(e):e?null==b||b.fireEvent("onRequirementComparisonDisplayed",{dmuObject:b}):null==A||A.fireEvent("onRequirementComparisonEnded",void 0))}),100)},this.getCurrentComparedObjectIDPaths=function(){return b?{feature:b,rootObject:t?t.slice():null,firstObject:h?h.slice():null,secondObject:v?v.slice():null}:null},this.addActiveCompareToNewSlide=e=>{let t=f.getReviewContext({viewer:R.getViewer()}),n=null==t?void 0:t.getCurrentSessionMarkup();if(n)return e.getDMUObjects("DMUCompareRequirement").length?void 0:new Promise((t=>{window.require(["DS/DMUPlayCompare/DMUCompareRequirement"],(function(i){let o=new i(R.getFrameWindow().getViewer(),n);o.setAttributes([{name:"sID",value:n.computeNewID()},{name:"sUuid",value:d.getUUID()},{name:"sName",value:n.computeNewName({object:o,prefix:"RequirementCompare"})},{name:"oSelections",value:[{id:h},{id:v}]}]),e.addDMUObject(o),null==A||A.fireEvent("onSaveRequested",void 0),t()}))}))},N&&(U=N.subscribe("com.ds.mep:onPrefUpdate",(function(e){let t=JSON.parse(e[1].preferences),n=!1;for(let e=0;e<t.repositories.length;e++){if("DMURepository"===t.repositories[e])for(let i=0;i<t.repositories[e].preferences.length;i++){const o=t.repositories[e].preferences;"CompareFirstColor"===o[i].name?(O=o[i].value,n=!0):"CompareSecondColor"===o[i].name&&(P=o[i].value,n=!0)}n&&q()}}))),A&&(k.onDMUReqCompareCancelled=A.addEvent("onDMUReqCompareCancelled",(function(e){if(e&&e.dmuObject&&"DMUCompareRequirement"===e.dmuObject.getType()&&M&&M.length){let t=e.dmuObject.getParent();if(t)if("DMUMarkup"===t.getType()){let e=t.getSlides();if(e&&e.length&&e.length>1){let e=t.getCurrentSlide();if(e&&0===e.getDMUObjects("DMUComment").length){let n=e.getDMUObjects();for(let t=0;t<n.length;t++)e.removeDMUObject(n[t]);t.removeSlide(e)}}}else"DMUTemporaryBag"===t.getType()&&t.removeDMUObjects("DMUCompareRequirement");B()}})),k.onDMUSlideCompareDisplayRequired=A.addEvent("onDMUSlideCompareDisplayRequired",(function(e){var t;if(e&&e.dmuObject){let n=e.dmuObject.getDMUObjects("DMUCompareRequirement");n.length&&n[0]&&(!b||b!==n[0]||b.getParent()&&"DMUTemporaryBag"===(null===(t=b.getParent())||void 0===t?void 0:t.getType()))&&(V=!0,I.displayRequirementComparison(n[0]))}})),k.onDMUObjectDeleted=A.addEvent("onDMUObjectDeleted",(function(e){if(e&&e.dmuObject&&"DMUComment"===e.dmuObject.getType()){let t=e.dmuObject.getParent(),n=t.getSlides();for(let e=0;e<n.length;e++)if(t.getCurrentSlide()!==n[e]){let i=n[e].getDMUObjects("DMUCompareRequirement");if(i&&i.length&&!n[e].getDMUObjects("DMUComment").length){let i=n[e].getDMUObjects();for(let t=0;t<i.length;t++)n[e].removeDMUObject(i[t]);t.removeSlide(n[e])}}}})),k.onDMUReviewVisbilityChanged=A.addEvent("onDMUReviewVisbilityChanged",(function(e){if(e)if(e.status){F=!0;let e=f.getReviewContext({viewer:R.getViewer()}),t=null==e?void 0:e.getCurrentSessionMarkup(),n=null==t?void 0:t.getCurrentSlide(),i=null==n?void 0:n.getDMUObjects("DMUCompareRequirement");i&&i.length&&I.displayRequirementComparison(i[0])}else F=!1,I.toggleRequirementCompareCmd(!1)})),k.onDMUMarkupLoaded=A.addEvent("onDMUMarkupLoaded",(function(e){if(e&&e.dmuObject){let t=e.dmuObject;if(t){let e=t.getSlides();if(e.length>1){let n=new Map,i=[];if(e.forEach((e=>{let t=e.getDMUObjects("DMUCompareRequirement");if(e.getDMUObjects("DMUCompareRequirement").length){let e=t[0].getAttribute("oSelections");e&&e.length>1&&(i.includes(e[0].id)||i.push(e[0].id),i.includes(e[1].id)||i.push(e[1].id))}})),i.length&&R.getController().getAttributes({ids:i,attributes:["ds6wg:revision","ds6w:label"],callbacks:{onComplete:function(t){e.forEach((e=>{let i=e.getDMUObjects("DMUCompareRequirement");if(e.getDMUObjects("DMUCompareRequirement").length){let o=i[0].getAttribute("oSelections");if(o&&o.length>1){e.getDMUObjects("DMUComment").forEach((e=>{n.set(e.getAttribute("sUuid"),t[o[0].id]["ds6w:label"]+" "+t[o[0].id]["ds6wg:revision"]+" | "+t[o[1].id]["ds6w:label"]+" "+t[o[1].id]["ds6wg:revision"])}))}}})),null==A||A.fireEvent("onUpdateReqCompareContainers",{commentContainerMap:n})},onFailure:function(){}}}),!I.getActiveCompareFeature()){let n=t.getAttribute("sCurrentSlideId");if("string"==typeof n)for(let t=0;t<e.length;t++)if(e[t].getAttribute("sID")===n){let n=e[t].getDMUObjects("DMUCompareRequirement");if(n&&n.length){let e=p.giveWebDocumentVisualizationController({context:R});if(e)if(e.isADocumentDisplayed())I.displayRequirementComparison(n[0]);else{let e=null==A?void 0:A.addEvent("on2DDocumentLoadSuccess",(()=>{null==A||A.removeEvent(e),I.displayRequirementComparison(n[0])}))}}break}}}}}})),k.onDMUMarkupCreationSucceeded=A.addEvent("onDMUMarkupCreationSucceeded",(function(e){if(e&&e.dmuObject&&I.isRequirementCompareActive()){let t=e.dmuObject,n=null==t?void 0:t.getCurrentSlide();I.addActiveCompareToNewSlide(n)}})))}static getReqCompareController(e){let t=this.giveReqCompareController(e);if(t)for(let t=0;t<h.length;t++)h[t].context===e.context&&h[t].count++;else t=new v(e),h.push({context:e.context,controller:t,count:1});return t}static giveReqCompareController(e){if(e&&e.context)for(let t=0;t<h.length;t++)if(h[t].context===e.context)return h[t].controller}static unreferenceReqCompareController(e){if(e&&e.context)for(let t=0;t<h.length;t++){h[t].context===e.context&&(h[t].count--,0===h[t].count&&(h[t].controller.clean(),h.length=0));break}}}return v})),define("DS/DMUBaseUIControllers/DMUApplicativeContextManager",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","text!DS/DMUBaseUIControllers/assets/config/DMUApplicativeContextManager.json"],(function(e,t,n,i,o){"use strict";var r=[{wkbID:"3D",module:"DS/CAT3DAnnotControllerForReview/CAT3DAnnotControllerForReview"},{wkbID:"3D",module:"DS/DMUBaseUIControllers/DMUEnrichApplicativeController"},{wkbID:"R2V3D",module:"DS/CAT3DAnnotControllerForReview/CAT3DAnnotControllerForReview"},{wkbID:"R2V3D",module:"DS/DMUBaseUIControllers/DMUEnrichApplicativeController"},{wkbID:"ITF",module:"DS/PIMwebViewController/PIMwebItfCtrl"},{wkbID:"MSR",module:"DS/SMAMpw3DMarkupImpl/SMAMpwMSRAppCtrl"},{wkbID:"Workplan",componentId:"DelOERDMULoader"}],a=["ITF","MSR"],l=["FTA","POI"],s=e.extend({init:function(e){var s;this._parent(e);var d,u=[],c=e.context,g={},p=t.getEventsController({viewer:c.getViewer()}),m=i.getPreferenceManager({context:c.getFrameWindow()}),f=[],h=this,v=JSON.parse(o),C={};let D=[];function b(e){if(!e)return[];let t=e.getValidation?e.getValidation():null,n=[];if(t){let e=t.getMarkups();for(let t=0;t<e.length;t++){let i=e[t].getMarkupContent();!i&&e[t].getRepRef()&&(i=e[t].getRepRef().getMarkupContent()),i&&(n=n.concat(i.getSlides()))}}else n=e.getCurrentSessionMarkup&&e.getCurrentSessionMarkup()?e.getCurrentSessionMarkup().getSlides():[];return n}function M(e,n){var i=t.getReviewContext({context:c}),o=[],r=n||b(i);if(r.length&&i&&i.getUIManager()&&!i.getUIManager().getFormatEditionModeFlag()){let t;for(var a=0;a<r.length;a++)t=r[a].getSlideApplicativeContext(e),t&&o.push({state:t})}return o}function y(){C={},d&&(clearTimeout(d),d=0),d=setTimeout((function(){if(d=null,!u)return;let e=t.getReviewContext({context:c}),n=e?e.getCurrentSessionMarkup():null;for(var i=0;i<u.length;i++)if(u[i].controller){let e=M(u[i].controller.getApplicativeContainerID());u[i].controller.updateAppContainer({slidesEditableFlag:Boolean(n&&!n.isReadOnly()),slidesAppData:e})}}),100)}function w(e,t,n){if(e===t)return null!=e||!n.mandatory;var i=typeof e;if(i!==typeof t)return!1;if(!("array"!==n.type||Array.isArray(e)&&Array.isArray(t)))return!1;if("array"!==n.type&&"enum"!==n.type&&i!==n.type)return!1;var o,r=!0;switch(n.type){case"object":var a=Object.keys(n.attributes);for(o=0;o<a.length;o++)if(!(r=w(e[a[o]],t[a[o]],n.attributes[a[o]])))return r;break;case"array":if(n.partialContentAllowed){if(e.length>t.length)return!1;for(o=0;o<e.length;o++){r=!1;for(var l=0;l<t.length;l++)if(w(e[o],t[l],n.childStructure)){r=!0;break}if(!r)return r}r=!0}else{if(e.length!==t.length)return!1;for(o=0;o<e.length;o++)if(!(r=w(e[o],t[o],n.childStructure)))return r}break;case"string":case"enum":case"boolean":case"number":r=e===t}return r}function S(e,t,n){return e===t||!n||!(!e&&t||e&&!t)&&(e.version===t.version&&w(e.context,t.context,n.attributes.context))}var E=function(){setTimeout((async function(){if(c){var e=[],n=!1;if(1===h.getApplicativeControllers().length&&h.getApplicativeControllers()[0].getActiveState()){var i=h.getApplicativeControllers()[0].getApplicativeContainerID();if(-1!==a.indexOf(i)){n=!0;var o=t.getReviewContext({context:c}),r=await h.getApplicativeControllers()[0].getCurrentAppContainerState();if(o&&o.getUIManager()){let t=b(o);if(t.length)for(var l,d=0;d<t.length;d++)(l=t[d].getSlideApplicativeContext(i))&&S(r,l,v[i])&&e.push(t[d])}}}if(s){var u=s.giveDMUSlidesController({context:c.getFrameWindow()});u&&n&&(u.setSlideFilteringAvailability(!0),u.setListOfFilteredSlides(e))}}}),10)};g.onLeavingR3DApp=p.addEvent("onLeavingR3DApp",(function(e){u.forEach((function(t){t&&t.controller&&t.controller.onLeavingApp&&t.controller.onLeavingApp(e)}))})),g.onComparisonStarted=p.addEvent("onComparisonStarted",(function(){u.forEach((function(e){e&&-1===l.indexOf(e.id)&&e.controller&&e.controller.getActiveState()&&(e.controller.setActiveState(!1),D.push(e))}))})),g.onComparisonEnded=p.addEvent("onComparisonEnded",(function(){D.forEach((function(e){e&&e.controller&&!e.controller.getActiveState()&&e.controller.setActiveState(!0)})),D.length=0})),g.onDMUObjectInitialized=p.addEvent("onDMUObjectInitialized",(function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUMarkup"===e.dmuObject.getType())&&(y(),E())})),g.onDMUObjectDeleted=p.addEvent("onDMUObjectDeleted",(function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&(y(),E())})),g.onDMUSlideDisplayed=p.addEvent("onDMUSlideDisplayed",(function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&E()})),g.onDMUObjectActiveFlagChanged=p.addEvent("onDMUObjectVisibleFlagChanged",(function(e){e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&y()}));var x=function(e){if(null===e&&n.empty(),s){var t=s.giveDMUSlidesController({context:c.getFrameWindow()});t&&t.setActiveSlide(e)}};let U=function(){let e;function t(n,i){if(!i)return!0;Array.isArray(i)&&[].concat(i).some((t=>"fromVersion"in t?e>=t.fromVersion&&(i=t):"toVersion"in t?e<=t.toVersion&&(i=t):i=t));var o=typeof n;if("fromVersion"in i&&e<i.fromVersion)return void 0===n;if("toVersion"in i&&e>i.toVersion)return void 0===n;if(void 0===n)return!i.mandatory;if("array"===i.type&&!Array.isArray(n))return!1;if("array"!==i.type&&"enum"!==i.type&&o!==i.type)return!1;var r,a=!0;switch(i.type){case"object":var l,s,d=Object.keys(i.attributes);for(r=0;r<d.length;r++){if((s=d[r].split("|")).length>1){let e=0;l=null;for(let t=0;t<s.length;++t)n[s[t]]&&(e++,l||(l=s[t]));if(1!==e)return!1}else l=d[r];if(!(a=t(n[l],i.attributes[d[r]])))return a}break;case"array":if(void 0!==i.minimal&&n.length<i.minimal)return!1;if(void 0!==i.maximal&&n.length>i.maximal)return!1;for(r=0;r<n.length;r++)if(!(a=t(n[r],i.childStructure)))return a;break;case"enum":a=i.values.includes(n)}return a}return function(n,i){return e=n&&n.version?n.version:0,t(n,i)}}();this.initApplicativeContainer=async function(e,n){var i=[],o=[];r.forEach((function(t){t.wkbID===e&&t.module&&i.push(t.module)})),i.length?o=await new Promise((e=>{require(["DS/DMUBaseUIControllers/DMUSlidesController"].concat(i),(function(t,...n){s=t,e(n)}))})):s=await new Promise((e=>{require(["DS/DMUBaseUIControllers/DMUSlidesController"],(function(t){e(t)}))}));let a=r.filter((t=>t.wkbID===e&&t.componentId)).map((e=>c&&c.getExecutionContext().getComponent(e.componentId)));[...o,...a].forEach((e=>{if(!c)return;const i=!e.getApplicativeController;var o=i?e:e.getApplicativeController({context:c});if(o){u.push({id:o.getApplicativeContainerID(),controller:o,lib:i?void 0:e});const r=()=>{let e=t.getReviewContext({context:c}),i=e?e.getCurrentSessionMarkup():null;if(o.updateAppContainer({slidesEditableFlag:Boolean(i&&!i.isReadOnly()),slidesAppData:M(o.getApplicativeContainerID())}),i&&i.getCurrentSlide())o.displayAppContainerState({state:i.getCurrentSlide().getSlideApplicativeContext(o.getApplicativeContainerID()),callback:()=>{if(n&&n.onReady){var e=[];u.forEach((function(t){e.push(t.controller)})),n.onReady(e)}},noCtxChangedEvt:!0});else if(n&&n.onReady){var r=[];u.forEach((function(e){r.push(e.controller)})),n.onReady(r)}E()};i?r():o.initializeAppContainer({onApplicativeControllerInitialized:r,onDataWorkbenchReadyCB:function(e){p&&e&&p.fireEvent("onApplicativeContextCommandsRequired",e)},onPreferencesReadyCB:function(e){m&&e&&e.length&&(e.forEach((function(e){f.push(e.id)})),m.addPreferences(e))},options:n}),o.subscribe("onApplicativeContextActiveStateModified",(function(e){if(C={},c&&e&&e.id&&(E(),e.state)){var n=t.getReviewContext({context:c});n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getCurrentSlide()&&x(n.getCurrentSessionMarkup().getCurrentSlide())}})),o.subscribe("onApplicativeContentChanged",(async function(e){if(c&&e&&e.id){var n,i=t.getReviewContext({context:c});if(u.some((function(t){if(t.id===e.id)return n=t.controller,!0})),n&&i&&i.getCurrentSessionMarkup()&&!i.getCurrentSessionMarkup().isReadOnly()&&i.getCurrentSessionMarkup().isVisible()&&i.getCurrentSessionMarkup().getCurrentSlide()&&i.getCurrentSessionMarkup().getCurrentSlide().isVisible()){var o=await h.getVerifiedApplicativeContainerState(e.id);if(o){var r=i.getCurrentSessionMarkup().getCurrentSlide().getSlideApplicativeContext(e.id);r&&("FTA"===e.id&&r&&"number"!=typeof r.version?i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,o):(r.content=o.content,i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,r)),i.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlideApplicativeContextModified",{dmuObject:i.getCurrentSessionMarkup().getCurrentSlide()}))}}}})),o.subscribe("onApplicativeContextRequested",(function(e){if(!c||!e||!e.id)return;E();let n=t.getReviewContext({context:c});if(n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&(n.getCurrentSessionMarkup().isVisible()||e.forceDisplay)){var i=null;if(n.getUIManager().getFormatEditionModeFlag())return;let t=b(n);if(t.length){let n,a=[],l=[];for(let i=0;i<t.length;i++)n=t[i].getSlideApplicativeContext(e.id),n&&(l.push(n),a.push(t[i]));if(l.length){var r=o.getOrderedAppContainerStates(l,e.data);r&&r.length&&(C.id===e.id&&e.data&&JSON.stringify(e.data)===C.data?C.counter=C.counter+1:e.data&&(C={id:e.id,data:JSON.stringify(e.data),counter:0}),C.counter=C.counter%r.length,r&&r.length&&-1!==l.indexOf(r[0])&&(i=a[l.indexOf(r[C.counter])]))}}i?x(i):e.data&&e.data.selectedFeature&&p?p.fireEvent("onNewSlideCreationRequest"):x(null)}})),o.subscribe("onApplicativeContextChanged",(async function(e){if(C={},c&&e&&e.id){E();var n=t.getReviewContext({context:c});if(n){const t=n.getCurrentSessionMarkup();if(t&&t.getActiveFlag()){const i=t.getCurrentSlide();if(i&&i.isVisible()){if(n.getUIManager().getFormatEditionModeFlag())return;if(v[e.id]&&S(await o.getCurrentAppContainerState(),i.getSlideApplicativeContext(e.id),v[e.id]))return;x(null)}}}}}))}}))},this.removeApplicativeContainer=function(e){C.id===e&&(C={});for(var t=u.length-1;t>=0;t--)u[t]&&u[t].id===e&&u[t].lib&&(u[t].lib.unreferenceApplicativeController({context:c}),u.splice(t,1))},this.clear=function(){C={},D.length=0;for(var e=Object.keys(g),n=0;n<e.length;n++)p.removeEvent(g[e[n]]);t.unreferenceEventsController({viewer:c.getViewer()}),m&&(m.removePreferences(f),i.unreferencePreferenceManager({context:c.getFrameWindow()})),u.forEach((function(e){e.lib&&e.lib.unreferenceApplicativeController({context:c})})),c=m=null,f=[],u=[]},this.getVerifiedApplicativeContainerState=async function(e){for(var t=0;t<u.length;t++)if(u[t].controller.getActiveState()&&u[t].controller.getApplicativeContainerID()===e){var n=await u[t].controller.getCurrentAppContainerState();return v[e]&&!U(n,v[e])?void window.console.error("ERROR: the provided applicative container state does not match its structure."):n}},this.getApplicativeControllers=function(){var e=[];return u.forEach((function(t){t.controller.getActiveState()&&e.push(t.controller)})),e},this.getApplicativeContainersTICInfo=function(e,t){if(!e||"Issue"!==e&&"CA"!==e&&"IssueTemplate"!==e&&"Task"!==e)return;var i,o=[],r=0,a=0,l=function(e){r++,e&&o.push(e),r===a&&t(o)};let s=[];n.get().map((e=>e.pathElement)).forEach((e=>{if(e.getLastElement()&&e.getLastElement().getDMUType&&"DMUValidationExposedPresentation"===e.getLastElement().getDMUType()){let n=e.getLastElement().getOwner(),i=n.getParent();if(n&&i){let e=n.getPresentationSlideID(),o=i.getRepRef(n.getAttribute("sRepRefMarkupID"));var t=o?o.getMarkupContent():null;if(t&&e){let n=t.getSlides();for(let t=0;t<n.length;t++)if(n[t].getAttribute("sUuid")===e){s.push(n[t]);break}}}}}));for(var d=0;d<u.length;d++)u[d].controller.getAppContainerTICInfo&&(i=M(u[d].controller.getApplicativeContainerID(),s.length?s:null))&&(a++,u[d].controller.getAppContainerTICInfo(e,i,l));a||t(o)}}}),d=[];return e.singleton({init:function(){},getDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t=!1,n=0;n<d.length;n++)if(d[n].context===e.context){t=!0;break}if(!t){var i=new s(e);d.push({context:e.context,appController:i})}return this.giveDMUApplicativeContextManager(e)}},giveDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t,n=0;n<d.length;n++)if(d[n].context===e.context){t=d[n].appController;break}if(t)return Object.freeze({initApplicativeContainer:function(e,n){t&&t.initApplicativeContainer(e,n)},getVerifiedApplicativeContainerState:function(e){return t?t.getVerifiedApplicativeContainerState(e):void 0},getApplicativeContainersTICInfo:function(e,n){return t?t.getApplicativeContainersTICInfo(e,n):void 0},removeApplicativeContainer:function(e){t&&t.removeApplicativeContainer(e)},getApplicativeControllers:function(){return t?t.getApplicativeControllers():void 0}})}},unreferenceDMUApplicativeContextManager:function(e){if(e&&e.context)for(var t=0;t<d.length;t++)if(d[t].context===e.context)return d[t].appController&&d[t].appController.clear(),void d.splice(t,1)}})})),define("DS/DMUBaseUIControllers/DMUEnrichApplicativeController",["require","exports","DS/DMUControls/EXPNotify","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CoreEvents/ModelEvents","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],(function(e,t,n,i,o,r,a){"use strict";class l{constructor(e){const t=this,l="POI",s=["ENO3DViewer_POI","ENO3DViewer_ZOI","ENO3DViewer_GP"];let d,u,c,g,p,m=!1,f=new o,h={},v={layerIds:[],bookmarkId:"",workspaceId:""},C=!1,D=[],b=!1,M=!0;function y(e,t){f.publish({event:e,data:t})}function w(i,{title:o,message:r}){t&&(u&&(u.destroy(),u=null),u=new n({body:e.context.getFrameWindow().getUIFrame(),type:i,title:o,message:r}))}function S(e){return e.startsWith("3DAnalytics_")}function E({id:e}){if(m||t.setActiveState(!0),!v.layerIds.includes(e)){if(v.layerIds.push(e),S(e)&&C)return;D.includes(e)?(D.splice(D.indexOf(e),1),0===D.length&&c&&c()):M&&(v.bookmarkId="",v.workspaceId="",y("onApplicativeContextChanged",{id:l}))}}function x({id:e}){const t=v.layerIds.indexOf(e);-1!==t&&(v.layerIds.splice(t,1),!C&&M&&(v.bookmarkId="",v.workspaceId="",y("onApplicativeContextChanged",{id:l})))}function U({id:e}){!C&&v.layerIds.includes(e)&&y("onApplicativeContentChanged",{id:l})}async function O(){const e=parent;let t=await new Promise((t=>{e.require(["DS/WidgetLink/WidgetLink"],(e=>{t(e.get(window.widget))}),t)}));try{if(!t||!t.getLinked().length)throw new Error("no widget link")}catch(e){return c=void 0,void w("info",{message:r.noWidgetLinkedToEnrichView})}return t}this.setActiveState=t=>{if(t!==m){if(m=t,m)h.layerModified=e.context.getController().get3DLayerController().subscribe({event:"layerModified"},U),h.layerDeleted=e.context.getController().get3DLayerController().subscribe({event:"layerDeleted"},x);else{const t=Object.keys(h);for(let n=0;n<t.length;n++)e.context.getController().get3DLayerController().unsubscribe(h[t[n]]);h={},C=!1,v={bookmarkId:"",workspaceId:"",layerIds:[]}}y("onApplicativeContextActiveStateModified",{id:l,state:m})}},this.getActiveState=()=>m,this.subscribe=(e,t)=>f.subscribe({event:e},t),this.unsubscribe=e=>{f.unsubscribe(e)},this.initializeAppContainer=async({onApplicativeControllerInitialized:n})=>{d=e.context.getController().get3DLayerController().subscribe({event:"layerCreated"},E);const o=e.context.getController().streamLayers();o&&o.length&&(v.layerIds=o.map((e=>e.id)),t.setActiveState(!0));try{M="true"===(await a.readPreferences([{Repository:"DMURepository",PreferenceNames:["CaptureSpecLayers"]}])).repositories[0].preferences[0].value}catch(e){M=!0,window.console.warn("Could not get server value, default value set instead.",e)}t.setActiveState(M),p=i.getPreferenceManager({context:e.context.getFrameWindow()}),g||(g=p.subscribe("com.ds.mep:onPrefUpdate",(function(e){let t=JSON.parse(e[1].preferences).repositories;for(let e=0;e<t.length;e++)if("DMURepository"===t[e].name)for(let n=0;n<t[e].preferences.length;n++)"CaptureSpecLayers"===t[e].preferences[n].name&&(M="true"===t[e].preferences[n].value)}))),n()},this.updateAppContainer=e=>{e.slidesAppData.length&&e.slidesAppData.some((e=>e.state&&e.state.context&&e.state.context.layerIds&&e.state.context.layerIds.length))&&t.setActiveState(!0)},this.onLeavingApp=e=>{"X3DPLAW_AP"===e.targetApp&&t.setActiveState(!1)},this.displayAppContainerState=async t=>{var n;if(t.state&&t.state.context&&t.state.context.layerIds&&t.state.context.layerIds.length)if(D=t.state.context.layerIds.filter((e=>!v.layerIds.includes(e))),v.layerIds.length!==t.state.context.layerIds.length||D.length){if(v.layerIds.length=0,!await O())return t.callback();C=!0;(await new Promise((e=>{try{let t=window.require("DS/ENOXInterWdgCom/LinkManager");e(t)}catch(t){const n="DS/ENOXInterWdgCom/LinkManager";window.require([n],(t=>{e(t)}))}}))).publish("DS/ExternalWdgtCom/RestoreLayers",{layerIds:t.state.context.layerIds});let n=setTimeout((()=>{t.callback(),setTimeout((()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),C=!1})),w("warning",{message:r.layersMayBeMissing})}),5e3);c=()=>{c=void 0,clearTimeout(n),t.callback(),setTimeout((()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),C=!1}))}}else setTimeout((()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),t.callback()}));else if(t.state&&t.state.context&&t.state.context.bookmarkId&&t.state.context.workspaceId){if(v.bookmarkId===t.state.context.bookmarkId&&v.workspaceId===t.state.context.workspaceId)return void setTimeout((()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),t.callback()}));const i=await O();if(!i){const e=null===(n=window.widget)||void 0===n?void 0:n.getValue("appId");return["ENOR3D_AP","ENOR3R_AP","ENOR3V_AP"].includes(e)?w("warning",{title:r.missingLayers,message:`${r.someLayersNotDisplayed} ${r.linkADataPerspectiveWidget}`}):w("warning",{title:r.missingLayers,message:`${r.someLayersNotDisplayed} ${r.linkADataPerspectiveWidgetToReviewApp}`}),void t.callback()}C=!0;let o=null,a=i.subscribe("DS/DataPerspective/stateLoaded",(({payload:n})=>{i.unsubscribe(a),o&&clearTimeout(o),o=null,v.bookmarkId=t.state.context.bookmarkId||"",v.workspaceId=t.state.context.workspaceId||"",v.layerIds=(null==n?void 0:n.layerIds)||[],C=!1,t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),t.callback()}));e.context.getController().enrich3D({});const l={protocol:"3DAnalytics",apiVersion:"1.0",payload:{bookmarkId:t.state.context.bookmarkId,workspaceId:t.state.context.workspaceId}};i.publish("DS/DataPerspective/loadState",l),o=setTimeout((()=>{C=!1,i.unsubscribe(a),t.callback(),w("warning",{title:r.missingLayers,message:r.someLayersNotDisplayed})}),5e3)}else v.layerIds.length&&M?(v={layerIds:[],bookmarkId:"",workspaceId:""},e.context.getController().enrich3D({}).then(t.callback)):t.callback()},this.getCurrentAppContainerState=async()=>{if(M){const t=[],n=[],i=e.context.getController().streamLayers()||[];if(!i.length)return;if(i.forEach((e=>{s.includes(e.kind)&&(t.push(e.id),n.push({id:e.id,visible:e.visible,clustered:e.clustered,color:e.color}))})),i[0]&&S(i[0].id)){const{bookmarkId:e,workspaceId:t}=v.bookmarkId&&v.workspaceId?v:await new Promise((e=>{let t=null;O().then((n=>{var i;if(!n){const t=null===(i=window.widget)||void 0===i?void 0:i.getValue("appId");return["ENOR3D_AP","ENOR3R_AP","ENOR3V_AP"].includes(t)?w("warning",{title:r.missingLayers,message:`${r.someLayersNotDisplayed} ${r.linkADataPerspectiveWidget}`}):w("warning",{title:r.missingLayers,message:`${r.someLayersNotDisplayed} ${r.linkADataPerspectiveWidgetToReviewApp}`}),v.bookmarkId="",v.workspaceId="",e(v)}let o=n.subscribe("DS/DataPerspective/stateSaved",(({payload:{isActionSuccess:i,bookmarkId:r,workspaceId:a}})=>{n.unsubscribe(o),t&&clearTimeout(t),t=null,i?(v.bookmarkId=r,v.workspaceId=a):(v.bookmarkId="",v.workspaceId=""),e(v)}));n.publish("DS/DataPerspective/saveState",{protocol:"3DAnalytics",apiVersion:"1.0",payload:{title:"testBookmarkId",description:"testSaveStateDescription",origin:"ENOR3D_AP"}}),t=setTimeout((()=>{t=null,n.unsubscribe(o),w("warning",{title:r.layersCannotBeStored,message:r.layersNotStoredAreRemoved}),v.bookmarkId="",v.workspaceId="",e(v)}),5e3)}))}));return e&&t?{version:1,context:{bookmarkId:e,workspaceId:t},content:{layerOverloads:n}}:void 0}return{version:1,context:{layerIds:t},content:{layerOverloads:n}}}},this.getApplicativeContainerID=()=>l,this.getOrderedAppContainerStates=()=>{},this.getCurrentAppContainerStateTitle=()=>{},this.setMinimalUIFlag=e=>{b=e},this.getMinimalUIFlag=()=>b,this.clean=function(){t.setActiveState(!1),g&&(p.unsubscribe(g),i.unreferencePreferenceManager({context:e.context.getFrameWindow()}),p=g=null),d&&(e.context.getController().get3DLayerController().unsubscribe(d),d=null)}}}let s=[];return class{static getApplicativeController(e){let t;for(let n=0;n<s.length;n++)if(s[n].context===e.context)return t=s[n].controller,s[n].count++,t;let n=new l(e);return t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return!!n&&n.getActiveState()},subscribe:function(e,t){return n?n.subscribe(e,t):""},unsubscribe:function(e){n&&n.unsubscribe(e)},initializeAppContainer:function(e){n&&n.initializeAppContainer(e)},updateAppContainer:function(e){n&&n.updateAppContainer(e)},onLeavingApp:function(e){n&&n.onLeavingApp(e)},displayAppContainerState:function(e){n&&n.displayAppContainerState(e)},getCurrentAppContainerState:function(){return n?n.getCurrentAppContainerState():void 0},getApplicativeContainerID:function(){return n?n.getApplicativeContainerID():null},getOrderedAppContainerStates:function(e,t){return n?n.getOrderedAppContainerStates(e,t):null},getCurrentAppContainerStateTitle:function(){return n?n.getCurrentAppContainerStateTitle():void 0},setMinimalUIFlag:function(e){n&&n.setMinimalUIFlag(e)},getMinimalUIFlag:function(){return!!n&&n.getMinimalUIFlag()},clean:function(){n&&n.clean()}}),s.push({context:e.context,controller:t,count:1}),t}static giveApplicativeController(e){if(e&&e.context)for(let t=0;t<s.length;t++)if(s[t].context===e.context)return s[t].controller}static unreferenceApplicativeController(e){if(e&&e.context)for(let t=0;t<s.length;t++)if(s[t].context===e.context){s[t].count--,0===s[t].count&&(s[t].controller.clean(),s.splice(t,1));break}}}})),define("DS/DMUBaseUIControllers/DMUGraphicPropertiesCtr",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUControls/panels/DMUGraphicPropertiesPanel","DS/DMUControls/panels/DMUCustomColorPanel","DS/DMUBaseExperience/DMUContextManager","DS/Utilities/TouchUtils","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseUIControllers/DMUWebPreferencesController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],(function(e,t,n,i,o,r,a,l,s,d,u){"use strict";var c=e.extend({init:function(e){this._parent(e);var c,g,p,m,f,h,v=!1,C=(e||{}).ctxViewer,D=this,b=[];function M(){g&&g.clean(),g=null,p&&p.clean(),p=null,m&&m.clean(),m=null,f&&f.clean(),f=null}function y(e,t,n){var i,o;for(let r=0;r<t.length;r++)if(t[r].hasAttribute(e)&&!t[r].isAttributeReadOnly(e)&&(void 0===o&&(o=t[r].getAttribute(e)),void 0===o&&void 0!==n&&(o=n),i=t[r].getAttribute(e),JSON.stringify(i)!==JSON.stringify(o)))return null;return i}function w(){C.render();var e=a.getReviewContext({viewer:C.getViewer()});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().isVisible()&&e.getCurrentSessionMarkup().getCurrentSlide()&&e.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:e.getCurrentSessionMarkup().getCurrentSlide()})}function S(){m&&(m.clean(),f.clean(),f=m=null)}function E(e){localStorage.setItem("DMUGraphicPropertiesCustomColors",JSON.stringify(e.customColors)),g.setCustomColors(e.customColors),e.selectedColor&&g.setCurrentColor(e.selectedColor),S()}function x(e){if(m)S();else{m=new r({touchMode:l.getTouchMode()});var t=localStorage.getItem("DMUGraphicPropertiesCustomColors"),n=[];t&&(n=JSON.parse(t));let a=l.getTouchMode()?405:365;var o={id:"DMUCustomColorPanel",className:"DMUCustomColorPanel",title:u.grpCustomColorPanel,showTitleFlag:!0,frameWindow:C.getFrameWindow(),immersiveFrame:C.getFrameWindow().getImmersiveFrame(),content:m.build(n),minWidth:a,width:a,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:S};(f=new i(o)).setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-100}),m.setCurrentCustomColor(e),m.subscribe("onCustomColorPanelOk",E),m.subscribe("onCustomColorPanelCancel",S)}}function U(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("bIsFilled")||(b[t].setAttribute("bIsFilled",e),b[t].refreshNode());g.update({hasBorder:y("bHasBorder",b)}),w()}function O(e,n){for(var i=0;i<b.length;i++)b[i].isAttributeReadOnly(e)||(b[i].setAttribute(e,new t.Color(n)),b[i].refreshNode());w()}function P(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fOpacity")||(b[t].setAttribute("fOpacity",e),b[t].refreshNode());w()}function I(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("bHasBorder")||(b[t].setAttribute("bHasBorder",e),b[t].refreshNode());g.update({isFilled:y("bIsFilled",b)}),w()}function R(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("sLineStylePattern")||(b[t].setAttribute("sLineStylePattern",e),b[t].setAttribute("sLeaderStylePattern",e),b[t].refreshNode());w()}function A(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fLineStyleThicknessIndex")||(b[t].setAttribute("fLineStyleThicknessIndex",e),b[t].setAttribute("fLeaderStyleThicknessIndex",e),b[t].refreshNode());w()}function k(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fLineStyleOpacity")||(b[t].setAttribute("fLineStyleOpacity",e),b[t].refreshNode());w()}function T(e){for(var t=0;t<b.length;t++)b[t].setAttribute("fFontSize",e),b[t].refreshNode();w()}function V(e){for(var t=0;t<b.length;t++)b[t].setAttribute("sFontStyle",e),b[t].refreshNode();w()}function j(e){if(M(),!v)return;let t=y("sLineStylePattern",b);t&&(t=parseFloat(t));let n=y("fLineStyleThicknessIndex",b);var r={unitDetails:d.getCurrentUnit("Length"),isFilled:y("bIsFilled",b),hasBorder:y("bHasBorder",b),fillColor:y("cFillStyleColor",b),lineColor:y("cLineStyleColor",b),fillOpacity:y("fOpacity",b,0),thickness:void 0!==n?n:s.getLineThicknessIndex(y("fLineStyleThickness",b)),lineOpacity:y("fLineStyleOpacity",b,0),pattern:t,fontColor:y("cFontColor",b),fontStyle:y("sFontStyle",b),fontSize:y("fFontSize",b)};let a=localStorage.getItem("DMUGraphicPropertiesCustomColors");g||(g=new o({touchMode:l.getTouchMode()})),g.subscribe("onFilledPropertyChanged",U),g.subscribe("onFillColorChanged",(function(e){O("cFillStyleColor",e)})),g.subscribe("onLineColorChanged",(function(e){O("cLineStyleColor",e),O("cLeaderStyleColor",e)})),g.subscribe("onTextColorChanged",(function(e){O("cFontColor",e)})),g.subscribe("onFillOpacityChanged",P),g.subscribe("onHasBorderPropertyChanged",I),g.subscribe("onLineTypeChanged",R),g.subscribe("onLineThicknessChanged",A),g.subscribe("onLineOpacityChanged",k),g.subscribe("onFontSizeChanged",T),g.subscribe("onFontStyleChanged",V),g.subscribe("onCustomColorPanelRequired",x),g.subscribe("onActiveTabChanged",(function(e){localStorage.setItem("DMUGraphicPropsPanelActiveTab",e.activeTab)}));var c=g.build({values:r,activeTab:localStorage.getItem("DMUGraphicPropsPanelActiveTab"),customColors:a?JSON.parse(a):[]});if(!p&&c){var m={id:"DMUGraphicPropsPanel",className:"DMUGraphicPropsPanel",title:u.grpPanel,showTitleFlag:!0,frameWindow:C.getFrameWindow(),immersiveFrame:C.getFrameWindow().getImmersiveFrame(),content:c,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:function(){D&&D.setActiveState(!1)}};if(p=new i(m),e)p.setPanelPosition({offsetX:e.x,offsetY:e.y});else{var f=C.getFrameWindow().getContextualUIManager().getContextualBar(),h=f&&f.getPosition?f.getPosition():f.options&&f.options.Xposition&&f.options.Yposition?{x:f.options.Xposition,y:f.options.Yposition}:null,w=l.getTouchMode()?300:200;h?p.setPanelPosition({offsetX:h.x+f.elements.container.getDimensions().width/2-w/2,offsetY:h.y-w/2}):p.setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-w/2}),f&&f.hide()}}}function F(){v&&(h&&(clearTimeout(h),h=null),h=setTimeout((()=>{b.length=0;let e=n.get();if(e&&e.length){var t=a.getReviewContext({viewer:C.getViewer()}),i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),e.forEach((function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&b.push(t)})),b.length)return void j(p?p.getAbsolutePosition():void 0)}D.setActiveState(!1)})))}this.setActiveState=function(e){if(v!==e)if(v=e,b.length=0,v){c||((c={}).onAdd=n.onAdd(F),c.onRemove=n.onRemove(F),c.onEmpty=n.onEmpty(F));var t=a.getReviewContext({context:C});if(t){var i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),!i)return void(v=!1);if(n.get().forEach((function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&b.push(t)})),!b.length)return void D.setActiveState(!1);j()}}else c&&(n.unsubscribe(c.onAdd),n.unsubscribe(c.onRemove),n.unsubscribe(c.onEmpty),c=null),M();else if(v){let e=C.getFrameWindow().getContextualUIManager().getContextualBar();e&&e.hide()}},this.getActiveState=function(){return v},this.clearController=function(){D.setActiveState(!1),h&&(clearTimeout(h),h=null),p=g=C=D=null}}}),g=[];return e.singleton({init:function(){},getDMUGraphicPropsController:function(e){var t=this.giveDMUGraphicPropsController(e);if(!t&&e&&e.context){var n=new c({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},clearController:function(){n&&(n.clearController(),n=null)}}),g.push({context:e.context,graphicPropsController:t})}return t},giveDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].graphicPropsController},unreferenceDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context){g[t].graphicPropsController.clearController(),g.splice(t,1);break}}})})),define("DS/DMUBaseUIControllers/DMUSlidesController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUControls/panels/DMUSlidesPanel","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/DMUBaseExperience/DMUContextManager","DS/UIKIT/Spinner","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIServices/DMUObjectsServices","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/CATWebUXThumbnail","DS/CATWebUXComponents/DMUCommandsManager","DS/ApplicationFrame/ContextualMenu","DS/ApplicationFrame/ContextualBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUBaseExperience/EXPManagerSet","DS/DMUControls/EXPNotify","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseExperience/EXPUtils","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],(function(e,t,n,i,o,r,a,l,s,d,u,c,g,p,m,f,h,v,C,D,b,M,y,w,S,E,x,U,O,P){"use strict";let I=!1,R=e=>{if(!e||!e.context)return;e.opts.isExporting&&(I=!0);let n=e.opts&&"number"==typeof e.opts.duration?e.opts.duration:400,i=r.getReviewContext({context:e.context}),o=i?i.getCurrentSessionMarkup():null;if(o){let a=o.getCurrentSlide();if(C.cleanClippingFromSlide(a),e.onBeforeApplySlide&&e.onBeforeApplySlide({previousSlide:a,nextSlide:e.slide}),o.setCurrentSlide(e.slide),a&&a.refreshNode(),e.slide){e.context.getViewer().getVisibleSpace()||(e.context.getViewer().swapVisibleSpace(),e.context.getViewer().render());let o,a=e.slide,l=e.viewpoint,s=a.getAttribute("mRelativePosMatrix");if(s){let e=a.getAttribute("sPointedReference"),n=i.getEnvironment(),r=c.getAbsolutePositionMatrix(a,s,e);if(r){let e=new t.Vector3,i=new t.Vector3;r.extractBasis(new t.Vector3,i,e);let a=(new t.Vector3).getPositionFromMatrix(r);o={vViewpointPosition:a,vViewpointSight:e,vViewpointUp:i,iViewpointType:n.getAttribute("iViewpointType"),fViewpointFieldOfView:n.getAttribute("fViewpointFieldOfView"),fViewpointTargetDistance:n.getAttribute("fViewpointTargetDistance")}}}let d,u=async()=>{let t=i.getEnvironment().refresh({duration:n,viewpoint:l,envInfos:o}).then((()=>{e.context.getController&&e.context.getController().forceRefresh()})),r=[],s=w.giveDMUApplicativeContextManager({context:e.context}),d=s?s.getApplicativeControllers():[];if(d&&d.length)for(let e=0;e<d.length;e++)r.push(new Promise((t=>{d[e].displayAppContainerState({state:a.getSlideApplicativeContext(d[e].getApplicativeContainerID()),callback:t,noCtxChangedEvt:!0})})));await Promise.all([t,...r]),a.refreshNode(),setTimeout((()=>{e.onSlideActivated&&e.onSlideActivated({slide:a})}),n)},g=!1,p=a.getDMUObjects();for(let e=0;e<p.length;e++)if(-1!==p[e].getType().indexOf("DMUCompare")&&(d=p[e],"DMUCompareRequirement"===p[e].getType())){g=!0;break}if(!d&&a.getPointedFormats&&a.getPointedFormats().length){p=a.getPointedFormats()[0].getDMUObjects();for(let e=0;e<p.length;e++)if(-1!==p[e].getType().indexOf("DMUCompare")&&(d=p[e],"DMUCompareRequirement"===p[e].getType())){g=!0;break}}let m=O.giveReqCompareController({context:e.context});const f=m&&m.isRequirementCompareActive();if(d){if(!g){let t,n,i=r.giveEventsController({viewer:e.context.getViewer()});if(!i)return;n=i.addEvent("onComparisonDisplayed",(()=>{i.removeEvent(n),i.removeEvent(t),u()})),t=i.addEvent("onComparisonEnded",(()=>{i.removeEvent(n),i.removeEvent(t),u()}))}let t=r.giveEventsController({viewer:e.context.getViewer()});if(t){let e;e=t.addEvent("onRequirementComparisonDisplayed",(()=>{t.removeEvent(e),u()}))}a.fireEvent("onDMUSlideCompareDisplayRequired",{dmuObject:a})}else if(f){let t,n=r.giveEventsController({viewer:e.context.getViewer()});if(!n)return;t=n.addEvent("onRequirementComparisonEnded",(()=>{n.removeEvent(t),u()})),m.toggleRequirementCompareCmd(!1)}else u()}else e.onSlideActivated&&e.onSlideActivated({slide:e.slide});let l=C.getClippingCmdService();l&&!I&&l.updateClippingCommandState({contextViewer:r.getContextViewer({viewer:e.context.getViewer()}),reviewContext:r.getReviewContext({viewer:e.context.getViewer()}),slideActivateEvent:!0}),e.context.getViewer().render()}};var A=e.extend({init:function(e){this._parent(e);var c,A,k,T,V,j,F,N,L,B,W,H,q,_,z,X,G,K,J,Z,Q=e||{},Y=this,$=!1,ee=[],te=[],ne=[],ie=[],oe=Q.context,re=!0,ae=!0,le=new o,se=!1,de=[],ue=null,ce=!1,ge=!0,pe=new t.Vector2,me=!1,fe=[],he=!0,ve={},Ce={},De=r.getContextViewer({viewer:oe.getViewer()}),be=!1,Me=r.giveEventsController({viewer:oe.getViewer()});let ye,we,Se,Ee=1,xe=null;var Ue,Oe;window.require(["DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],(e=>{e&&(xe=e)}));var Pe=new Map;Pe.set("PRIVATE","IN_WORK"),Pe.set("IN_WORK","FROZEN"),Pe.set("FROZEN","RELEASED"),Pe.set("RELEASED","OBSOLETE"),Pe.set("OBSOLETE",void 0);var Ie=new Map;Ie.set("PRIVATE",void 0),Ie.set("IN_WORK","PRIVATE"),Ie.set("FROZEN","IN_WORK"),Ie.set("RELEASED",void 0),Ie.set("OBSOLETE",void 0);var Re=new Map;Re.set("PRIVATE","#9b2c98"),Re.set("IN_WORK","#007da3"),Re.set("FROZEN","#018308"),Re.set("RELEASED","#757575"),Re.set("OBSOLETE","#80808080");var Ae,ke=new Map;function Te(){return r&&"R2V"===r.getCurrentReviewContext()}function Ve(){ue&&ue.getEnvironmentOverload().state&&void 0!==ue.getEnvironmentOverload().state.b360Mode&&(De.getViewer().get360Mode()||ue.getEnvironmentOverload().state.b360Mode||He(ue))}function je(){z||(Dt(!1),z=setInterval((function(){if(!$||!oe)return clearInterval(z),void(z=null);if(A&&De&&De.getRootBagPath().getChildrenPathes().length){var e=D.getManager({name:"DMU2DSheetManager",context:oe});(e&&e.isADocumentDisplayed()&&!e.isRunning()||!e||e&&!e.isADocumentDisplayed()&&"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType())&&(clearInterval(z),z=null,Dt(!0),ve.onDMUMarkupApplicativeContextLoaded||Fe())}}),100))}function Fe(){var e=r.getReviewContext({viewer:oe.getViewer()}),t=e&&!e.getValidation()?e.getCurrentSessionMarkup():null;if(t){var n=t.getSlides(),i=t.getAttribute("sCurrentSlideId");if("string"==typeof i){for(var o=0;o<n.length;o++)if(n[o].getAttribute("sID")===i){Y.setActiveSlide(n[o]);break}}else n.length&&Y.setActiveSlide(n[0])}}function Ne(e,t){return!(e&&!t)&&(!(!e&&t)&&(Math.round(1e3*e.x)/1e3==Math.round(1e3*t.x)/1e3&&(Math.round(1e3*e.y)/1e3==Math.round(1e3*t.y)/1e3&&Math.round(1e3*e.z)/1e3==Math.round(1e3*t.z)/1e3)))}function Le(e,t){return!(Ne(e.vViewpointSight,t.vViewpointSight)&&Ne(e.vViewpointUp,t.vViewpointUp)&&Ne(e.vViewpointPosition,t.vViewpointPosition))||!t.b360Mode&&Math.round(1e3*e.fViewpointTargetDistance)/1e3!=Math.round(1e3*t.fViewpointTargetDistance)/1e3||e.iViewpointType!==t.iViewpointType||e.b360Mode!==t.b360Mode}function Be(e){if(!e)return"";let t=e.getAttribute("sUuid");return t||(t="MarkupID_"+e.parentID+"_SlideID_"+e.getAttribute("sID")),t}function We(e){return new Promise((t=>{xe&&(xe.give3DGridController({context:e})&&t());t()}))}async function He(e){if(I)return;let t=e||ue;if(!($&&ae&&oe.getViewer().getVisibleSpace()&&t&&t.isDisplayed()))return;var n=r.getReviewContext({viewer:oe.getViewer()}),i=n?n.getCurrentSessionMarkup():null;if(!i||i&&!i.getActiveFlag()||i&&i.getActiveFlag()&&!i.isVisible()||i&&i.getActiveFlag()&&i.isVisible()&&i.isImporting())return;var o=n.getEnvironment().getEnvironmentInfo(),a=Le(o,n.getEnvironment().getCurrentSlideEnvironmentInfo());if(a&&window.navigator.userAgent.indexOf("Firefox")>-1)return;a&&(n.getEnvironment().refresh({duration:0}),oe.getViewer().render());let l=t?(t.getDMUObjects("DMUClipping")||[]).filter((e=>!e.getAttribute("bClippingActiveState"))):[],s=t?(t.getDMUObjects("DMUSection")||[]).filter((e=>!e.getAttribute("bClippingActiveState"))):[];await We(De);let d=l.concat(s);d.length&&await Ge(De,!1);let u=C.getClippingCmdService();u&&u.setClippingVisualizationState(De,d,!0);var g,p,m=await y.computeImage({viewer:oe.getViewer(),width:200,height:113});if(u&&u.setClippingVisualizationState(De,d,!1),d.length&&await Ge(De,!0),await We(De),c){let e=Be(t);c.updateSlide(e,{img:m.src}),Z&&Z.has(e)&&Z.get(e).forEach((e=>e.setPreview(m.src))),g="onSlidePreviewUpdated",p={slide:t,img:m.src},le.publish({event:g,data:p,context:Y})}if(!t.isReadOnly()){let e=U.convertImageDataUrl(m.src);e&&(t.setAttribute("sImageType",e.type),t.setAttribute("sImageData",e.data))}a&&(n.getEnvironment().refresh({envInfos:o,duration:0}),oe.getViewer().render())}async function qe(e){let t;if(e){const n=144,i=108;t=document.createElement("canvas");const o=t.getContext("2d");if(o){const t=await new Promise((t=>{let n=new Image;n.onload=function(){t(n)},n.src=e.getPreview()})),r=Math.floor(t.height*n/i);o.drawImage(t,(t.width-r)/2,0,r,t.height,0,0,n,i)}}return e&&t?t.toDataURL("image/png"):null}async function _e(e){const t=await qe(e);Me&&Me.fireEvent("onPreviewThumbnailUpdateRequested",{elementId:e?e.getAttribute("sUuid"):void 0,thumbnailData:t})}function ze(e){ae&&(I||(e||function(){if(ue&&ue.getEnvironmentOverload().state&&ue.getEnvironmentOverload().state.b360Mode){var e=r.getReviewContext({viewer:oe.getViewer()});if(Le(e.getEnvironment().getEnvironmentInfo(),e.getEnvironment().getCurrentSlideEnvironmentInfo()))return!1}return!0}())&&(X&&(clearInterval(X),X=null),Ae&&clearTimeout(Ae),Ae=setTimeout((function(){Ae=null,$&&"false"!==localStorage.getItem("DMUAutomaticThumbnailRefresh")&&(X=setInterval((function(){if(!be&&!h._isShown&&!f._isShown){var e=r.getReviewContext({viewer:oe.getViewer()}),t=e?e.getUIManager():null,n=t?t.getSelectedObjects():void 0;if(t&&n){for(var i=0;i<n.length;i++)if("DMUSlide"!==n[i].getType()&&"DMUFormat"!==n[i].getType())return;clearInterval(X),X=null,Ae=setTimeout((()=>{if(be)return ze();He().then((()=>{if(ue){const e=ue.getAttribute("sUuid");e&&e===Se&&_e(ue),ue&&ue.getAssociatedHighlightData&&ue.getAssociatedHighlightData().length&&qe(ue).then((t=>{Me&&Me.fireEvent("onPreviewUpdateOnHighlightRequested",{elementId:e,imageData:t})}))}}))}),Te()?1e3:500)}}}),100))}),100)))}let Xe;function Ge(e,t){if(!Xe)return new Promise((n=>{window.require(["DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController"],(i=>{i&&(Xe=i,De&&i.setSectionVisibilityFlag(e,t)),n()}),n)}));Xe.setSectionVisibilityFlag(e,t)}var Ke;function Je(e){oe&&(Ke&&clearTimeout(Ke),Ke=setTimeout((async function(){Ke=null;var t=r.getReviewContext({viewer:oe.getViewer()});if(t){var n=function(e){if(!e)return;function t(e){let t;return!!(e&&(t=e.getDMUObjects("DMUClipping"),(!t||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let n,i=!1,o=!1,r=e.getCurrentSessionMarkup();r&&r.getActiveFlag()&&r.isVisible()&&r.getCurrentSlide&&(n=r.getCurrentSlide(),i=t(n));var a=e.getTransientReviewBag();return o=t(a),i||n&&!o?n:a}(t);if(n){var i=n.areSectionPlanesDisplayed?!n.areSectionPlanesDisplayed():!function(e){if(!e||!e.getDMUObjects)return!1;let t;if(0!==e.getDMUObjects("DMUSection").length||0!==e.getDMUObjects("DMUClipping").length){let n=e.getDMUObjects("DMUSection");for(t=0;t<n.length;t++)if(n[t].isSectionDisplayed())return!0;let i=e.getDMUObjects("DMUClipping");for(t=0;t<i.length;t++)if(i[t].isSectionDisplayed())return!0}return!1}(n);await Ge(De,i);var o,a=w.giveDMUApplicativeContextManager({context:De}),l=a?a.getApplicativeControllers():[];if(l&&l.length)for(o=0;o<l.length;o++)l[o].setAppSectionPlanesVisibleFlag&&l[o].setAppSectionPlanesVisibleFlag(i)}}e&&ze()}),10))}function Ze(){if(c&&(c.setSlideTitleVisibleFlag(!!se||(void 0!==B?B:L)),Z)){let e=Z.keys();for(let t=0;t<Z.size;t++){let t=e.next().value,n=Z.get(t);for(let e=0;e<n.length;e++)n[e].setTitleAndIconSectionVisibleFlag(void 0!==B?B:L)}}}function Qe(e){let t=D.getManager({name:"DMU2DSheetManager",context:oe});if(t&&t.isADocumentDisplayed())return;let n=e.slide.getEnvironmentOverload();if(n){let t=n.state;if(!(t&&t.vViewpointPosition&&t.vViewpointRight&&t.vViewpointSight&&t.vViewpointUp))return void window.console.error("State overload is not defined");let r={protocol:"3DXContent",version:"2.0",data:{items:[{serviceId:"3DSpace",envId:S.getPlatformId(),contextId:E.getSetting("pad_security_ctx")?E.getSetting("pad_security_ctx"):void 0,objectId:"",objectType:"DMUSlideView",objectOverloads:[],dmuObjects:[],environmentOverload:{targetDistance:t.fViewpointTargetDistance,viewpointAngle:t.fViewpointFieldOfView||De.getViewpoint().getAngle(),viewpointPosition:{x:t.vViewpointPosition.x,y:t.vViewpointPosition.y,z:t.vViewpointPosition.z},viewpointRight:{x:t.vViewpointRight.x,y:t.vViewpointRight.y,z:t.vViewpointRight.z},viewpointSight:{x:t.vViewpointSight.x,y:t.vViewpointSight.y,z:t.vViewpointSight.z},viewpointUp:{x:t.vViewpointUp.x,y:t.vViewpointUp.y,z:t.vViewpointUp.z}}}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},a=[],l=e.slide.getObjectOverloads();if(l)for(let e=0;e<l.length;e++)if(l[e].state.hasOwnProperty("bVisible")){let t=l[e].target.getOccurrenceIDPath();r.data.items[0].objectOverloads.push({data:{type:"Visible",value:l[e].state.bVisible},targetPath:t}),a.push(JSON.stringify(t))}else if("mTransfoMatrix"in l[e].state&&l[e].state.mTransfoMatrix){let t=l[e].target.getOccurrenceIDPath();r.data.items[0].objectOverloads.push({data:{type:"Transformation",value:l[e].state.mTransfoMatrix.elements},targetPath:t}),a.push(JSON.stringify(t))}const s=e.slide.getSlideApplicativeContext();s&&Object.keys(s).length&&(r.data.items[0].appCtxData={...s});let d=e.slide.getPointedFormats();if(d&&d.length){let e=d[0].getObjectOverloads();if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t].state.hasOwnProperty("bVisible")){let n=e[t].target.getOccurrenceIDPath();a.includes(JSON.stringify(n))||r.data.items[0].objectOverloads.push({data:{type:"Visible",value:e[t].state.bVisible},targetPath:n})}}var i=function(e){return e&&e.getAttribute("bVisible")&&e.getAttribute("bClippingActiveState")},o=function(e,t){if(!e)return{};var n=function(e){let t=[];return e&&(t=[255*e.r,255*e.g,255*e.b]),t};let i=[],o=e.getAttribute("mPlaneReferential");o&&(i=o.elements);var r=e.getAttribute("fOpacity");return r&&(r*=255),{type:t||"Clipping",data:{offset:e.getAttribute("fSliceOffset"),xDirSize:e.getAttribute("fXDirSize"),yDirSize:e.getAttribute("fYDirSize"),planeBoxMode:e.getClippingModeForDragDrop(),planeReferential:i,sectionCurvesVisible:Boolean(e.getAttribute("bSectionCurvesVisible")),customCappingColor:e.isCustomColorSorce("Capping"),cappingColor:n(e.getAttribute("cCappingColor")),customContourColor:e.isCustomColorSorce("Contour"),lineStyleColor:n(e.getAttribute("cLineStyleColor")),lineStyleThickness:e.getAttribute("fLineStyleThickness")||e.getAttribute("fLineStyleThicknessIndex"),lineStylePattern:e.getAttribute("sLineStylePattern")||1,fillStyleColor:n(e.getAttribute("cFillStyleColor")),fOpacity:r,clippingPlaneVisible:e.getAttribute("bClippingPlaneVisible")||!1,hatchingDisplay:e.getAttribute("bHatchingDisplay"),hatchingColor:n(e.getAttribute("cHatchingColor")),hatchingLineStyleThickness:e.getAttribute("fHatchingLineStyleThickness"),hatchingAnglesMode:e.getAttribute("sHatchingAnglesMode"),hatchingSingleAngleValue:e.getAttribute("fHatchingSingleAngleValue"),hatchingPitchValue:e.getAttribute("fHatchingPitchValue"),cutUncutMode:e.getAttribute("iCutUncutMode"),targetPaths:e.getSelectedObjectsIdsPathForCutUncut()}}};let u=e.slide.getDMUObjects("DMUSection");if(u&&u.length?i(u[0])&&r.data.items[0].dmuObjects.push(o(u[0],"Section")):(u=e.slide.getDMUObjects("DMUClipping"),u&&u.length&&i(u[0])&&r.data.items[0].dmuObjects.push(o(u[0]))),d&&d.length&&0===r.data.items[0].dmuObjects.length){let e=d[0].getDMUObjects("DMUSection");e&&e[0]?i(e[0])&&r.data.items[0].dmuObjects.push(o(e[0],"Section")):(e=d[0].getDMUObjects("DMUClipping"),e&&e[0]&&i(e[0])&&r.data.items[0].dmuObjects.push(o(e[0])))}let g={id:e.id,parentSlideId:e.parentSlideID,data:JSON.stringify(r)};c&&c.setSlideDragContent(g)}}function Ye(e){if(e)for(let t=0;t<ee.length;t++)if(ee[t].id===e){Qe(ee[t]);break}}function $e(){if(!c)return;let e=!c.getPanelActiveFlag();c&&c.setPanelActiveFlag(e);var t,n=l.get();for(t=n.length-1;t>=0;t--)n[t].pathElement&&n[t].pathElement.getLastElement(!0).getDMUType&&l.remove(n[t]);for(t=(n=s.get()).length-1;t>=0;t--)n[t].pathElement&&n[t].pathElement.getLastElement(!0).getDMUType&&s.remove(n[t]);var i=r.getReviewContext({viewer:oe.getViewer()});i&&(i.getTransientReviewBag().removeDMUObjects(),i.getUIManager().setMarkupVisualizationActiveState(Boolean(e&&i.getCurrentSessionMarkup())))}function et(){c&&$&&!c.getPanelActiveFlag()&&$e()}function tt(){return c?c.getColumnMinimumWidth():250}function nt(){return c?c.getColumnWidthStep():233}function it(){if(A){if(sessionStorage)if("true"===sessionStorage.getItem("DMUSlidesExpFlag_"+widget.id))sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"false"),A.setWidth(tt());else{var e=parseFloat(sessionStorage.getItem("DMUSlidesWidth_"+widget.id));e&&e!==tt()&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),A.setWidth(e))}c&&c.resizePanel({width:A.getWidth(),height:A.getHeight()})}}function ot(){c&&(c.resetSlideDisplayHistory(),ue&&c.setActiveSlide(Be(ue))),q&&q.destroy(),q=new b({body:oe.getUIFrame(),type:"info",message:P.displayHistoryRemoved})}function rt(e,t){if(et(),e&&e.id){c&&c.setActiveSlide(e.id,t);for(var n=0;n<ee.length;n++)if(ee[n].isActiveSlide=ee[n].id===e.id,ee[n].id===e.id){l.empty(),Y.setActiveSlide(ee[n].slide,{updatePreviousPreview:!0});break}}A&&A.isSmallWidth()&&A.collapsePanel()}function at(e){if(!T)for(var t=0;t<ee.length;t++)if(ee[t].id===e.id){var n=v.buildPathElement(ee[t].slide.getNode());e.prehighlightedFlag?d.add({pathElement:n}):d.remove({pathElement:n})}}function lt(e){if(!T)for(var t=0;t<ee.length;t++)if(ee[t].id===e.id){var n=v.buildPathElement(ee[t].slide.getNode());e.checkFlag?l.add({pathElement:n}):l.remove({pathElement:n})}}async function st(e){if(ue){l.empty();var t=m.getCommand("sectionCmdHdr",De.getCommandContext());t&&t.isRunning()&&t.cancel&&t.cancel(),await He(ue)}for(let t=0;t<ee.length;t++)ee[t].id===e.id&&(J=ee[t].slide);m.getCommand("DMUCreateSlideReplyHdr",Q.commandContext).begin(),A&&A.isSmallWidth()&&A.collapsePanel()}function dt(e){var t,n=r.getReviewContext({viewer:oe.getViewer()}),i=n?n.getValidation():null;if(i){let n=i.getRepRef(e.markupID);t=n?n.getMarkupContent():null}else t=n?n.getCurrentSessionMarkup():null;if(t&&e.orderedSlideIDs&&e.orderedSlideIDs.length){let n=se?t.getFormats():t.getSlides();e.orderedSlideIDs.forEach((function(e){let t=n.findIndex((t=>t.getAttribute("sUuid")===e));if(t>=0){let e=n.splice(t,1)[0];n.push(e)}})),te.sort(((t,n)=>{const i=t.getAttribute("sUuid"),o=n.getAttribute("sUuid");return e.orderedSlideIDs.includes(i)&&e.orderedSlideIDs.includes(o)?Math.sign(e.orderedSlideIDs.indexOf(t.getAttribute("sUuid"))-e.orderedSlideIDs.indexOf(n.getAttribute("sUuid"))):0})),t.setAttribute(se?"lFormats":"lSlides",n),Me&&(Me.fireEvent("onDMUSlideReordered"),Me.fireEvent("onSaveRequested"))}}function ut(e){var t=r.getReviewContext({viewer:oe.getViewer()}),n=t?t.getValidation():null;n&&e.orderedMarkupIDs&&n.reorderMarkups(e.orderedMarkupIDs)}function ct(){he&&(G||(G=setInterval((function(){if(!K&&!be){if(clearInterval(G),G=null,c&&c.removeSlideUpdateRequiredFlags(),!$||T||!c||de.length||ce||!c.getPanelActiveFlag()||!he||!oe)return;let t=r.getReviewContext({viewer:oe.getViewer()});const n=ue&&ue.getParent(),i=Boolean(ue&&ue.getAttribute("sParentSlideID"));if(ue&&!ue.isReadOnly()&&ue.getActiveFlag()&&n&&t&&t.getRestrictions(n)[i?"reply":"markup"].canEdit){var e=ue.getEnvironmentOverload();if(e)Le(e=e.state,r.getReviewContext({viewer:oe.getViewer()}).getEnvironment().getEnvironmentInfo())?c.setSlideUpdateRequiredFlag(Be(ue),!0):Te()&&He()}}}),100)))}async function gt(e){for(var t=0;t<ee.length;t++)if(ee[t].id===e.id){var n=m.getCommand("DMUUpdateFormatSessionOverloadHdr",Q.commandContext);return n&&await n.begin(),void ct()}}function pt(){et();var e=m.getCommand(se?"DMUExitFormatsHdr":"DMUEditFormatsHdr",Q.commandContext);e&&e.begin()}function mt(){et(),l.empty();var e=m.getCommand("DMUEditPropertiesHdr",Q.commandContext);e&&e.begin()}function ft(e){et();for(var t=0;t<ee.length;t++)if(ee[t].id===e.id)return ee[t].slide.setAttribute("sName",e.title),Z&&Z.has(e.id)&&Z.get(e.id).forEach((t=>t.setThumbnailTexts({title:e.title}))),Me&&Me.fireEvent("onDMUSlideNameChanged",{dmuObject:ee[t].slide,value:e.title}),void(ee[t].title=e.title)}function ht(e){for(var t=0;t<ne.length;t++)if(ne[t].id===e.id&&ne[t].content){let i=ne[t].content.getMarkupContent();if(i){var n=v.buildPathElement(i.getNode());l.empty(),s.empty(),l.add({pathElement:n}),d.add({pathElement:n}),pe=e.position.clone(),oe.getExecutionContext?oe.getContextualUIManager()._showContextMenu(pe):oe.getContextualUIManager()._showContextualMenu(pe)}}}function vt(e){if(Me){let i=!1;for(var t=0;t<ne.length;t++)if(ne[t].id===e.id){i=!0;break}if(i){var n=r.getReviewContext({viewer:oe.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some((t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return Me.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0}))}}}function Ct(e){for(var t=0;t<ee.length;t++)if(ee[t].id===e.id){J=ee[t].slide;var n=v.buildPathElement(ee[t].slide.getNode());e.shiftKeyPressed||e.ctrlKeyPressed||e.openFromButton||(l.empty(),s.empty()),l.add({pathElement:n}),pe=e.position.clone();var i=D.getManager({name:"DMUUserExperienceManager",context:oe});i&&i.setCCPTarget(ee[t].slide),oe.getExecutionContext?oe.getContextualUIManager()._showContextMenu(pe):oe.getContextualUIManager()._showContextualMenu(pe)}}function Dt(e){e?Ee++:Ee--,A&&A.setEnableFlag(Ee>0)}function bt(){if(!oe||!Y)return;var e=D.getManager({name:"DMU2DSheetManager",context:oe});let t=r.getContextViewer({viewer:oe.getViewer()});!e||!e.isADocumentDisplayed()&&!e.isRunning()||"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType()?t&&t.getRoots().some((e=>!!e.userData&&"FailureModesEffectsAnalysis"===e.userData.type))?Y.setVisibleFlag(!1):Y.setVisibleFlag(!0):Y.setVisibleFlag(!1)}if(ke.set("PRIVATE",P.maturityValue.PRIVATE),ke.set("IN_WORK",P.maturityValue.IN_WORK),ke.set("FROZEN",P.maturityValue.FROZEN),ke.set("RELEASED",P.maturityValue.RELEASED),ke.set("OBSOLETE",P.maturityValue.OBSOLETE),this.subscribe=function(e,t){if(e&&t)return le.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&le.unsubscribe(e)},Me){var Mt=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(_=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:S.getPlatformId(),serviceId:"3DSpace",contextId:E.getSetting("pad_security_ctx")?E.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),c&&c.setDragContent(_))},yt=r.getReviewContext({viewer:oe.getViewer()});yt&&Mt(yt.getReviewCtxInformation()),ve.onReviewCtxInformationChanged=Me.addEvent("onReviewCtxInformationChanged",Mt),ve.onDMUSlidePreferencesChanged=Me.addEvent("onDMUSlidePreferencesChanged",(function(){var e=u.getSlidePreferences({context:oe});if(e&&(e.panelTitle&&"string"==typeof e.panelTitle&&j!==e.panelTitle&&(j=e.panelTitle,!V&&c&&c.setPanelTitle(j)),"boolean"==typeof e.displaySlideTitle&&L!==e.displaySlideTitle&&(B=e.displaySlideTitle,Ze()),e.slideDragAndDropOperation)){ye="TransferView"===e.slideDragAndDropOperation;let t=D.getManager({name:"DMU2DSheetManager",context:oe});c&&(t&&t.isADocumentDisplayed()?c.enableDragContent(!1):c.enableDragContent(ye))}})),ve.onDMUSlideAssociatedToHighlight=Me.addEvent("onDMUSlideAssociatedToHighlight",(function(e){e&&e.dmuObject&&e.dmuObject.getAssociatedHighlightData&&Y.updateSlide(e.dmuObject,{highlights:e.dmuObject.getAssociatedHighlightData()})})),ve.onApplyingSlideView=Me.addEvent("onApplyingSlideView",(function(){let e=r.getReviewContext({viewer:oe.getViewer()});if(e){e.getUIManager().setMarkupVisualizationActiveState(!1);let t=e.getTransientReviewBag();t&&(t.removeDMUObjects("DMUSection"),t.removeDMUObjects("DMUClipping"))}})),ve.onDMUObjectActiveFlagChanged=Me.addEvent("onDMUObjectActiveFlagChanged",(function(e){var t=r.getReviewContext({viewer:oe.getViewer()});!(t&&c&&e)||e&&!e.dmuObject||e&&e.dmuObject&&!e.dmuObject.isVisible()||(!t.getValidation()&&"DMUMarkup"===e.dmuObject.getType()||t.getValidation()&&"DMUValidationValidation"===e.dmuObject.getType())&&et()})),ve.onDMUMarkupLoaded=Me.addEvent("onDMUMarkupLoaded",(function(){let e=r.getReviewContext({viewer:oe.getViewer()}).getReviewCtxInformation();e&&!e.modifiable&&c.setAllowSlideReorderFlag(!1),je()})),ve.onDMUMarkupApplicativeContextLoadBegin=Me.addEvent("onDMUMarkupApplicativeContextLoadBegin",(function(){ve.onDMUMarkupApplicativeContextLoaded=Me.addEvent("onDMUMarkupApplicativeContextLoaded",(function(){Fe(),Me.removeEvent(ve.onDMUMarkupApplicativeContextLoaded),ve.onDMUMarkupApplicativeContextLoaded=null}))})),ve.onDMUObjectInitialized=Me.addEvent("onDMUObjectInitialized",(function(e){if(e&&e.dmuObject){if(!ue||e.dmuObject!==ue&&-1===ue.getDMUObjects().indexOf(e.dmuObject)||ze(),ue&&"DMUFormat"!==ue.getType()&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType())){Ye(Be(ue))}"DMUMarkup"!==e.dmuObject.getType()||c||(Ot(),c&&c.addMarkup({id:"default"}))}})),ve.onFormatsEditionModeEnded=Me.addEvent("onFormatsEditionModeEnded",(function(){for(let e=0;e<ee.length;e++){Ye(ee[e].id)}})),ve.onSaveRequested=Me.addEvent("onSaveRequested",ze),ve.onEndSectionManipulation=Me.addEvent("onEndSectionManipulation",(function(e){if(e&&e.dmuObject&&ue&&"DMUFormat"!==ue.getType()&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType())){Ye(Be(ue))}})),ve.onDMUObjectDeleted=Me.addEvent("onDMUObjectDeleted",(function(e){if(e&&e.dmuObject&&e.dmuObject.getType)if("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType()){var t=r.getReviewContext({viewer:oe.getViewer()});t&&t.getValidation()&&e.dmuObject===ue&&Y.setActiveSlide(null),Y.removeSlide(e.dmuObject)}else if("DMUMarkup"===e.dmuObject.getType()){for(let t=ne.length-1;t>=0;t--)if(ne[t].content&&ne[t].content.getMarkupContent()===e.dmuObject){for(let e=ie.length-1;e>=0;e--)ie[e].parentID===ne[t].id&&(c&&c.removeReply(ie[e].id),ie.splice(e,1));c&&c.removeMarkup(ne[t].id),ne.splice(t,1);break}}else if(!ue||"DMUFormat"===ue.getType()||"DMUSection"!==e.dmuObject.getType()&&"DMUClipping"!==e.dmuObject.getType())"DMUMarker3DPoint"!==e.dmuObject.getType()&&"DMUMarker2DPoint"!==e.dmuObject.getType()&&ze();else{Ye(Be(ue))}})),ve.onDMUSlideSessionInfoChanged=Me.addEvent("onDMUSlideSessionInfoChanged",(function(e){if(e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()){Ye(Be(e.dmuObject))}ze()})),ve.onSlidePreviewRefreshRequired=Me.addEvent("onSlidePreviewRefreshRequired",(function(e){if(e&&e.dmuObject===ue){if("DMUSlide"===e.dmuObject.getType()){Ye(Be(e.dmuObject))}ze()}})),ve.onDMUSlideOrFormatRefreshRequired=Me.addEvent("onDMUSlideOrFormatRefreshRequired",(function(e){e&&e.dmuObject===ue&&ze()})),ve.onDMUOverloadPropertiesChanged=Me.addEvent("onDMUOverloadPropertiesChanged",(function(){if(ue&&"DMUFormat"!==ue.getType()){Ye(Be(ue))}ze()})),ve.onOccurenceVisibleFlagChanged=Me.addEvent("onOccurenceVisibleFlagChanged",(function(){if(ue&&"DMUFormat"!==ue.getType()){Ye(Be(ue))}})),ve.onDMUOccOverloadRemoved=Me.addEvent("onDMUOccOverloadRemoved",(function(){if(ze(),ue&&"DMUFormat"!==ue.getType()){Ye(Be(ue))}})),ve.onWorkplanLoadSuccess=Me.addEvent("onWorkplanLoadSuccess",(function(){Ut()})),ve.onDMUObjectAddedInObject=Me.addEvent("onDMUObjectAddedInObject",(function(e){e&&e.dmuObject&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType())&&Je()})),ve.onDMUObjectRemovedFromObject=Me.addEvent("onDMUObjectRemovedFromObject",(function(e){if(e&&e.dmuObject&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType())){if(ue&&"DMUFormat"!==ue.getType()){Ye(Be(ue))}Je()}})),ve.onDMUFormatAssociatedListeModified=Me.addEvent("onDMUSlideFormatListModified",(function(e){if(e&&e.dmuObject&&e.dmuObject.isDisplayed()&&(Je(),"DMUFormat"!==e.dmuObject.getType())){Ye(Be(e.dmuObject))}})),ve.onDMUObjectVisibleFlagChanged=Me.addEvent("onDMUObjectVisibleFlagChanged",(function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType()||"DMUSection"===e.dmuObject.getType())&&Je()})),ve.onContextVisuChangeEnd=Me.addEvent("onContextVisuChangeEnd",ze),ve.onNewSlideCreationRequest=Me.addEvent("onNewSlideCreationRequest",Et);let e=!1;ve.onDMUSlideCompareDisplayRequired=Me.addEvent("onDMUSlideCompareDisplayRequired",(()=>{Dt(!1),e=!0})),ve.onComparisonDisplayed=Me.addEvent("onComparisonDisplayed",(()=>{e&&Dt(!0),e=!1})),ve.onComparisonEnded=Me.addEvent("onComparisonEnded",(()=>{e&&Dt(!0),e=!1})),ve.on2DDocumentLoadStarted=Me.addEvent("on2DDocumentLoadStarted",(()=>{let e=O.giveReqCompareController({context:De});if(!e||!e.isLoading()){let e=D.getManager({name:"DMU2DSheetManager",context:oe});Y.setVisibleFlag(!(e&&!e.getLoadedDocuments().length))}})),ve.on2DDocumentLoadError=Me.addEvent("on2DDocumentLoadError",(()=>{Y.setVisibleFlag(!0)})),ve.onEmptyDocument=Me.addEvent("onEmptyDocument",(()=>{Y.setVisibleFlag(!0)})),ve.on2DDocumentLoadSuccess=Me.addEvent("on2DDocumentLoadSuccess",bt),ve.onMarkupObjectAttributesModified=Me.addEvent("onMarkupObjectAttributesModified",(function(e){e&&e.object&&e.attr&&"DMUMarkup"===e.object.getType()&&e.attr.forEach((function(e){e.currentState&&c&&(Ue=e.currentState,Oe&&(Oe.destroy(),Oe=null),c.setPanelQuickAccessCommands(xt()),c.setPanelSubMenuCommands(St()))}))})),ve.onCurrentSessionMarkupChanged=Me.addEvent("onCurrentSessionMarkupChanged",(function(){c&&c.setPanelQuickAccessCommands(xt())})),ve.onReviewObjectAttributesModified=Me.addEvent("onReviewObjectAttributesModified",(function(){if(c){let e=r.getReviewContext({viewer:oe.getViewer()});c.allowReplies(e&&e.getValidation()&&!se&&e.getRestrictions().reply.canCreate),c.setAllowSlideReorderFlag(e&&(!e.getValidation()||e.getRestrictions(e.getCurrentSessionMarkup()).markup.canEdit))}}))}var wt=i.subscribe({event:"/VISU/"},(function(e){var t=e.eventType||e.event;"@onViewpointBeginMove"===t?be=!0:"@onViewpointEndMove"===t&&(be=!1,ct())}));function St(){var e=[];if(!T){var t=r.getReviewContext({viewer:oe.getViewer()});if(t){let i=t.getCurrentSessionMarkup(),o="Reply"===(i&&i.getMarkupOwner()&&i.getMarkupOwner().getParent()&&i.getMarkupOwner().getParent().getType());var n=t?t.getValidation():null;let r=n&&n.getContext()?n.getContext().getMainContextType():void 0,l=t.getReviewCtxInformation()?t.getReviewCtxInformation().contextType:void 0;n||se||(Pe.get(Ue)&&e.push({id:"Next State",type:"button",nls:P.maturityValue.SetTo+' "'+ke.get(Pe.get(Ue))+'"',fontIcon:"fonticon fonticon-double-chevron-right wux-ui-3ds",fontIconColor:Re.get(Pe.get(Ue)),separator:!1,cb:function(){let e=oe.getUIFrame();var t=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],n=e.getElementsByClassName("rp-maturity-"+Ue)[0];(Oe=new a({visible:!0})).inject(t);var i=Oe.getContent().getSize().width,o=(n.getSize().width-i)/2;Oe.getContent().setStyles({position:"absolute",height:"20px",right:(33+o).toString()+"px"}),Me.fireEvent("onMarkupMaturityModificationRequested",{fromState:Ue,toState:Pe.get(Ue)})}}),Ie.get(Ue)&&e.push({id:"Previous State",type:"button",nls:P.maturityValue.SetTo+' "'+ke.get(Ie.get(Ue))+'"',fontIcon:"fonticon fonticon-double-chevron-left wux-ui-3ds",fontIconColor:Re.get(Ie.get(Ue)),separator:!1,cb:function(){let e=oe.getUIFrame();var t=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],n=e.getElementsByClassName("rp-maturity-"+Ue)[0];(Oe=new a({visible:!0})).inject(t);var i=Oe.getContent().getSize().width,o=(n.getSize().width-i)/2;Oe.getContent().setStyles({position:"absolute",height:"20px",right:(53-o).toString()+"px"}),Me.fireEvent("onMarkupMaturityModificationRequested",{fromState:Ue,toState:Ie.get(Ue)})}}),e.push({id:"DMUMarkupMaturityChange",type:"button",nls:P.changeMaturity,fontIcon:"fonticon fonticon-collaborative-lifecycle-management wux-ui-3ds",separator:!0,cb:function(){var e=m.getCommand("DMUMarkupMaturityChangeHdr",Q.commandContext);e&&e.begin()}})),re&&t&&t.getRestrictions(t.getCurrentSessionMarkup())[o?"reply":"markup"].canEdit&&!t.isReadOnly()&&t.getCurrentSessionMarkup()&&!t.getCurrentSessionMarkup().isReadOnly()&&(!r||"DELLmiWorkPlanSystemReference"!==r&&"DELLmiPPRHeaderProcessReferenceAbstract"!==r&&"DELLmiHeaderWorkPlanReference"!==r)&&(!l||"DELLmiWorkPlanSystemReference"!==l&&"DELLmiPPRHeaderProcessReferenceAbstract"!==l&&"DELLmiHeaderWorkPlanReference"!==l)&&e.push({id:"DMUFormats",type:"button",nls:se?P.exitFormatsUI:P.launchFormatsUI,fontIcon:se?"fonticon fonticon-upload wux-ui-3ds":"fonticon fonticon-template wux-ui-3ds",separator:!0,cb:pt})}}let i=m.getCommand("DMUCopyLinkHdr",Q.commandContext);return i&&e.push({id:"DMUCopyLink",type:"button",nls:P.launchCopyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",cb:()=>{i=m.getCommand("DMUCopyLinkHdr",Q.commandContext),i&&i.begin()}}),i=m.getCommand("DMUEditPropertiesHdr",Q.commandContext),null!=i&&e.push({id:"DMUEditProperties",type:"button",nls:P.launchEditProperties,fontIcon:"fonticon fonticon-info wux-ui-3ds",cb:mt}),T&&e.push({id:"DMUResetDisplayHistory",type:"button",nls:P.resetDisplayHistoryLabel,icon:M.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:ot}),e}async function Et(e){if(ue){let e=l.get(),n=[];e&&e.forEach((e=>{let t=e.pathElement.getLastElement();Boolean(t&&t.getDMUType&&t.getDMUType().includes("Marker"))||n.push(e)})),l.empty();var t=m.getCommand("sectionCmdHdr",De.getCommandContext());t&&t.isRunning()&&t.cancel&&t.cancel(),await He(ue),l.add(n)}if(e&&e.id){var n=r.getReviewContext({viewer:oe.getViewer()}),i=n?n.getValidation():null;i&&i.setCurrentMarkup(i.getRepRef(e.id)),Ut()}m.getCommand(se?"DMUFormatCmdHdr":"slideCmdHdr",Q.commandContext).begin(),A&&A.isSmallWidth()&&A.collapsePanel()}function xt(){var e=[];T||e.push({id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:P.switchMarkupVisibility,cb:function(e){var t=e.dsModel.checkFlag;if($e(),t){var n=D.getManager({name:"DMU2DSheetManager",context:oe});if(n&&n.isADocumentDisplayed()){var i=r.getReviewContext({viewer:oe.getViewer()});i&&i.getEnvironment().refresh()}}A&&A.isSmallWidth()&&A.collapsePanel()}}),me&&e.push({id:"filterButton",type:"checkbox",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter",title:P.filterSlides,checkFlag:!!c&&c.getFilterActivationFlag(),cb:function(){c&&c.switchFilterActivation()}}),!T&&re&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:se?P.newFormat:P.newSlide,cb:Et});var t=r.getReviewContext({viewer:oe.getViewer()}),n=t?t.getCurrentSessionMarkup():null;const i=n?n.getMaturityState():null;return!se&&i&&e.push({id:"maturityStateButton",type:"label",title:P.maturityState,label:P.maturityValue[i],className:"rp-ms-box rp-maturity-"+i}),e}function Ut(){re=!0;let e=r.getReviewContext({viewer:oe.getViewer()}),t=e?e.getValidation():null;if(t){let e=t.getCurrentMarkup();if(e){for(;e&&"Markup"!==e.getValType();)e=e.getParentRepRef().getParent();e&&(re=(e.isWebMarkup&&e.isWebMarkup()||e.getRepRef&&e.getRepRef()&&e.getRepRef().isWebMarkup&&e.getRepRef().isWebMarkup())&&!e.isReadOnly())}}if(c){c.setPanelSubMenuCommands(St()),c.setPanelQuickAccessCommands(xt());let e=m.getCommand(se?"DMUFormatCmdHdr":"slideCmdHdr",Q.commandContext);c.setQuickAccessCommandActiveFlag("newButton",e&&e.isEnabled())}}function Ot(){var e=u.getSlidePreferences({context:oe});if(e&&("boolean"==typeof e.displaySlidePanel&&(ge=e.displaySlidePanel),"string"==typeof e.panelTitle&&(j=e.panelTitle),"boolean"==typeof e.displaySlideTitle&&(B=e.displaySlideTitle),ye="TransferView"===e.slideDragAndDropOperation,void 0===T&&"boolean"==typeof e.playMode&&(T=e.playMode),!W&&e.beforeApplySlideCB&&(W=e.beforeApplySlideCB),!H&&e.afterApplySlideCB&&(H=e.afterApplySlideCB)),ge){var t,i=r.getReviewContext({viewer:oe.getViewer()});if(i&&(t=i.getValidation()),c||(c=new n({allowMarkupReorder:Boolean(window.__karma__&&window.allowMarkupReorder),allowSlideReorder:!0,allowReplies:t&&!se&&i.getRestrictions().reply.canCreate}),(k={}).onTopBarDoubleClick=c.subscribe("onTopBarDoubleClick",it),k.onSlideDisplayed=c.subscribe("onSlideDisplayed",rt),k.onSlidePreselected=c.subscribe("onSlidePreselected",at),k.onSlideSelected=c.subscribe("onSlideSelected",lt),k.onSlideUpdateRequired=c.subscribe("onSlideUpdateRequired",gt),k.onSlideNameChanged=c.subscribe("onSlideNameChanged",ft),k.onSlideCtxMenuRequired=c.subscribe("onSlideCtxMenuRequired",Ct),k.onMarkupCtxMenuRequired=c.subscribe("onMarkupCtxMenuRequired",ht),k.onMarkupRenamed=c.subscribe("onMarkupRenamed",vt),k.onNewSlideCreated=c.subscribe("onNewSlideCreated",Et),k.onSlideReplyCreated=c.subscribe("onSlideReplyCreated",st),k.onSlideReordered=c.subscribe("onSlideReordered",dt),k.onSlideDragStart=c.subscribe("onSlideDragStart",(e=>{e.isTouch&&setTimeout(oe.getContextualUIManager().hideContextualMenu,1e3)})),k.onMarkupReordered=c.subscribe("onMarkupReordered",ut),k.onSlideHighlightSelected=c.subscribe("onSlideHighlightSelected",(({slideId:e,highlightId:t})=>{const n=ee.find((t=>t.id===e));n&&Me&&Me.fireEvent("onCommentOrSlideInformationIconClicked",{dmuObject:n.slide,highlightId:t})}))),!A){var o=c.buildPanel({panelTitle:V||j,noSlideLabel:F,createSlideLabel:N,contextualCmdList:St(),quickAccessBtnList:xt()});_&&c.setDragContent(_),c.setReadOnlyFlag(T);var a={id:"DesignReview",className:"DMUSlidesPanel",title:P.slidePanelTitle,closeButtonFlag:!1,showTitleFlag:!1,icon:"fonticon fonticon-DMUSlidePanelIcon DMUSlidePanelIcon",immersiveFrame:oe.getImmersiveFrame(),viewerFrame:oe.getViewerFrame(),content:o,minWidth:tt(),widthStep:nt(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizeCB:function(e){c&&c.resizePanel(e)},onPanelResizedCB:function(e){e.currentDockArea!==WUXDockAreaEnum.RightDockArea&&e.currentDockArea!==WUXDockAreaEnum.LeftDockArea||e.widthModifiedInteractively&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),sessionStorage.setItem("DMUSlidesWidth_"+widget.id,e.width)),c&&c.resizePanel(e)}};(A=new g(a)).setPanelVisibilityFlag(ae)}if(c){c.setPanelActiveFlag(he),c.resizePanel({width:A.getWidth(),height:A.getHeight()});let e=D.getManager({name:"DMU2DSheetManager",context:oe});e&&e.isADocumentDisplayed()?c.enableDragContent(!1):c.enableDragContent(ye),A&&(A.setMinWidth(c.getColumnMinimumWidth()),A.setWidthStep(c.getColumnWidthStep()))}Ze(),Y.setPlayMode(T)}}function Pt(e){if(c||Ot(),e.titleEditionAllowed=e.isEditable()&&!T,null!==e.index&&void 0!==e.index?ee.splice(e.index,0,e):ee.push(e),e.markedAsDeleted){if(!ee.some((t=>t.parentSlideID===e.id)))return}c&&(c.addSlide(e),1===ee.length&&A.setMinWidth(tt()),"DMUFormat"!==e.slide.getType()&&Ye(e.id))}async function It(e,t){de.splice(0,1),ce=!0;var n=ue;if(ue=e,t&&t.updatePreviousPreview&&n){var i=m.getCommand("sectionCmdHdr",De.getCommandContext());i&&i.isRunning()&&i.cancel&&i.cancel(),ue!==n&&(Te()&&(ue.getEnvironmentOverload().state.b360Mode||n.getEnvironmentOverload().state.b360Mode)||await He(n))}var o=r.getReviewContext({viewer:oe.getViewer()});o.getTransientReviewBag().removeDMUObjects();var a=o?o.getValidation():null;e&&a&&(a.setCurrentMarkup(a.getRepRef(e.parentID)),Ut());var d=o?o.getCurrentSessionMarkup():null;if(d){if(I||ct(),ue){var u,g=l.get();for(u=g.length-1;u>=0;u--)g[u].pathElement&&g[u].pathElement.getLastElement(!0).getDMUType&&"DMUValidationExposedPresentation"!==g[u].pathElement.getLastElement(!0).getDMUType()&&l.remove(g[u]);for(u=(g=s.get()).length-1;u>=0;u--)g[u].pathElement&&g[u].pathElement.getLastElement(!0).getDMUType&&"DMUValidationExposedPresentation"!==g[u].pathElement.getLastElement(!0).getDMUType()&&s.remove(g[u]);if(!o.isReadOnly()&&!d.isReadOnly()){var p=v.buildPathElement(ue.getNode());l.add({pathElement:p}),Y.updateSelectedSlides([ue])}}c&&c.setActiveSlide(Be(ue));var f=w.giveDMUApplicativeContextManager({context:De});(f?f.getApplicativeControllers():[]).forEach((function(e){e.setAppViewpointManipFlag&&e.setAppViewpointManipFlag(!ue)})),R({context:De,slide:e,opts:t,onBeforeApplySlide:function(){we&&c.setInProgress(we,!1),c&&(we=Be(ue),c.setInProgress(we,!0)),ue&&Te()&&De.set360Mode({checkFlag:ue.getEnvironmentOverload().state.b360Mode}),W&&W(n,ue),Me&&Me.fireEvent("onDMUSlideStartDisplay",{dmuObject:ue})},onSlideActivated:function(e){t.afterSlideActivationCB&&t.afterSlideActivationCB(n,e.slide),H&&H(n,e.slide),Me&&Me.fireEvent("onDMUSlideDisplayed",{dmuObject:e.slide}),I||(ue&&Te()?ue.getEnvironmentOverload().state.b360Mode&&ze(!0):He()),de.length?It(de[0].slide,de[0].options):(ce=!1,I||Je(!0)),c&&(c.setInProgress(we,!1),we=null),I&&(I=!1)}})}}Ce.onEndProgressiveLoad=De.subscribe({event:"onEndProgressiveLoad"},(()=>{var e=r.getReviewContext({viewer:oe.getViewer()});let t,n;if(e){t=e.getEnvironment().getEnvironmentInfo(),n=e.getEnvironment().getCurrentSlideEnvironmentInfo(),Le(t,n)||ze()}})),Ce.onR2VLoaded=De.subscribe({event:"onR2VLoaded"},je),ve.onDMUObjectAttributeModified=Me.addEvent("onDMUObjectAttributeModified",(function(e){e&&"bMarkedAsDeleted"===e.attrName&&"DMUSlide"===e.dmuObject.getType()&&e.value&&c&&c.removeSlide(e.dmuObject.getAttribute("sUuid"))})),ve.onHighlightAttributeChanged=Me.addEvent("onHighlightAttributeChanged",(function(e){if(e&&e.objectIds&&e.objectIds.length){const t=e.objectIds.slice();for(let n=0;n<ee.length;n++){const i=ee[n].slide,o=i.getAssociatedHighlightData();if(o&&o.length){if(t.filter((e=>o.some((t=>t.id===e)))).forEach((n=>{i.updateAssociatedHighlightData({id:n,rating:e.rating}),t.splice(t.indexOf(n),1)})),!t.length)break}}}})),ve.onHighlightIssueOrTaskCreated=Me.addEvent("onHighlightIssueOrTaskCreated",(function({highlightId:e,type:t}){if(e&&t)for(let n=0;n<ee.length;n++){const i=ee[n].slide,o=i.getAssociatedHighlightData();if(o&&o.length&&o.some((t=>t.id===e))){i.updateAssociatedHighlightData({id:e,..."issue"===t?{hasIssue:!0}:{hasTask:!0}});break}}})),ve.onDMUOverloadPropertiesChanged=Me.addEvent("onDMUOverloadPropertiesChanged",(function(e){if(e&&e.overloads&&e.overloads.length){const e=r.getReviewContext({viewer:oe.getViewer()}),t=e&&e.getCurrentSessionMarkup(),n=t&&t.getCurrentSlide();if(n){n.getDMUObjects().filter((e=>e.getPointedReference&&e.getPointedReference(0))).forEach((e=>{e.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:e})}))}}})),this.editMarkupName=function(e){if(ae&&c&&e&&e.getPlmID){let t;for(let n=0;n<ne.length;n++)if(ne[n].id===e.getPlmID()){t=e.getPlmID();break}t&&c.editMarkupName(t)}},this.getRepliedSlide=function(){return J},this.getActiveThumbnailCtxMenuPosition=function(){return pe.clone()},this.setSlideFilteringAvailability=function(e){me!==e&&(me=e,c&&c.setPanelQuickAccessCommands(xt()))},this.setListOfFilteredSlides=function(e){fe=e&&e.length?e.slice():[];var t=[];ee.forEach((function(e){-1!==fe.indexOf(e.slide)&&t.push(e.id)})),c&&c.setListOfVisibleSlides(t)},this.setActiveFlag=function(e){var t;if(e!==$)if($=e){for(Te()&&De.getFrameWindow().getImmersiveFrame().addEventListener("endEdit",Ve),bt(),t=0;t<te.length;t++)Y.addSlide(te[t]);ue&&Y.setActiveSlide(ue)}else{if(Te()&&De.getFrameWindow().getImmersiveFrame().removeEventListener("endEdit",Ve),fe.length=0,c){c.cleanPanel();var n=Object.keys(k);for(t=0;t<n.length;t++)c.unsubscribe(k[n[t]]);ee.length=0,k={}}A&&(A.setPanelVisibilityFlag(!1),A.clean()),z&&clearInterval(z),G&&clearInterval(G),X&&clearInterval(X),A=c=G=z=X=null}},this.getActiveFlag=function(){return $},this.setPanelActiveFlag=function(e){he=e,c&&c.setPanelActiveFlag(he),ct()},this.getPanelActiveFlag=function(){return he},this.addSlide=function(e,t,n){if(!$||!e)return;var i;et();var o=r.getReviewContext({viewer:oe.getViewer()});if(n)i=n;else{if(!o||o&&!o.getCurrentSessionMarkup())return;i=o.getCurrentSessionMarkup()}ee.length||e.parentID||(e.parentID="default");let a=Be(e);for(var l=0;l<ee.length;l++)if(Be(ee[l].slide)===a)return;-1===te.indexOf(e)&&("number"==typeof t?te.splice(t,0,e):te.push(e));var s=e.getAttribute("sOwner"),d={slide:e,id:Be(e),parentID:e.parentID,parentSlideID:e.getAttribute("sParentSlideID"),index:t,isPreview:Se===a,markedAsDeleted:e.getAttribute("bMarkedAsDeleted"),isEditable:function(){return!e.isReadOnly()}};d.isPreview&&e.setPreviewFlag(!0),"DMUSlide"===e.getType()||"DMUFormat"===e.getType()?(d.title=e.getAttribute("sName"),d.icon="DMUFormat"===e.getType()?M.getWebappsAssetUrl("DMUPlaySlide","icons/22/I_DMUFormat.png"):void 0,d.img=e.getPreview(),d.isActiveSlide=!i.isImporting()):d.text=e.getAttribute("sTextContents"),s&&s.length?x.getUserName(s,void 0,(function(t){d.userName=t,d.userColor=x.getUserColor(s),d.userPic=x.getUserImageURL(s),d.defaultUserPic=M.getWebappsAssetUrl("DMUBaseUI","icons/I_DefaultUserPic.png"),d.date=e.getAttribute("fCreationDate"),Pt(d)})):Pt(d)},this.removeSlide=function(e){if($&&e){et();for(let t=ee.length-1;t>=0;t--)(ee[t].slide===e||ee[t].parentSlideID&&e.getAttribute("sUuid")===ee[t].parentSlideID)&&(te.splice(te.indexOf(e),1),c&&c.removeSlide(ee[t].id),ee.splice(t,1))}},this.addReply=function(e){ie.push(e),e.webMarkup=e.content.isWebMarkup(),c&&c.addReply(e)},this.forcePanelVisibility=function(){A&&A.ensureVisible()},this.addMarkup=function(e){var t=r.getReviewContext({viewer:oe.getViewer()}),n=t?t.getValidation():null,i=t?t.getCurrentSessionMarkup():null;t&&e&&(n||i)&&(ne.push(e),c||Ot(),e.allowSlideReorder=!0,e.webMarkup=e.content.isWebMarkup(),e.owner=e.content.getOwner(),c&&c.addMarkup(e))},this.updateSlide=function(e,t){if($&&e&&t){if(t.uuid)for(var n=0;n<ee.length;n++)if(ee[n].slide===e){let t=ee[n].id;return ee[n].id=Be(e),void(c&&c.updateSlide(t,{id:ee[n].id}))}if(c){let n=Be(e);c.updateSlide(n,t),Z&&Z.has(n)&&Z.get(n).forEach((e=>{t.name&&e.setThumbnailTexts({title:t.name}),t.img&&e.setPreview(t.img)}))}}},this.updateSlideEditableFlag=function(e){if($&&e)for(var t=0;t<ee.length;t++)if(ee[t].slide===e)return ee[t].titleEditionAllowed=ee[t].isEditable()&&!T,void(c&&c.updateSlide(ee[t].id,{titleEditionAllowed:ee[t].titleEditionAllowed}))},this.update=function(){if($&&ee)for(var e=0;e<ee.length;e++)ee[e].titleEditionAllowed=ee[e].isEditable()&&!T,c&&c.updateSlide(ee[e].id,{titleEditionAllowed:ee[e].titleEditionAllowed})},this.setPlayMode=function(e){if($&&T!==e){if(T=e,et(),ct(),c){if(c.setReadOnlyFlag(T),c.setPanelSubMenuCommands(St()),c.setPanelQuickAccessCommands(xt()),ee)for(var t=0;t<ee.length;t++)ee[t].titleEditionAllowed=ee[t].isEditable()&&!T,c.updateSlide(ee[t].id,{titleEditionAllowed:ee[t].titleEditionAllowed,checkFlag:!T&&void 0});c.resetSlideDisplayHistory(),ue&&c.setActiveSlide(Be(ue))}Ut()}},this.getPlayMode=function(){return T},this.setVisibleFlag=function(e){$&&(ae=e,A&&A.setPanelVisibilityFlag(ae))},this.getVisibleFlag=function(){return ae},this.getActiveSlide=function(){return ue},this.getSlideRepresentation=function(e,t){let n=ee.findIndex((t=>t.id===e));if(n>=0){Z||(Z=new Map);let i=new p({id:e,data:ee[n].slide,displayMode:t,displayPrefix:!1,width:202,height:127,displayTitleAndIcon:L,title:ee[n].title,allowCtxMenu:!1,isCheckable:!1,clickCB:e=>{rt(e,{recenter:!0})},preview:ee[n].slide.getPreview(),allowTitleEdition:!1});return Z.has(e)?Z.get(e).push(i):Z.set(e,[i]),{getDiv:i.getContent,updateDisplayMode:i.updateDisplayMode,getImage:()=>qe(ee[n].slide),remove:()=>{if(Z){let t=Z.get(e);t&&(t.splice(t.indexOf(i),1),0===t.length&&Z.delete(e)),i.clear()}}}}},this.setPanelOptions=function(e){if($&&e){et();var t,n=Object.keys(e);for(t=0;t<n.length;t++){if("panelTitle"===n[t]&&(V=e.panelTitle,c&&c.setPanelTitle(V||j)),"noSlideLabel"===n[t]&&(F=e.noSlideLabel,c&&c.setNoSlideLabel(F)),"createSlideLabel"===n[t]&&(N=e.createSlideLabel,c&&c.setCreateSlideLabel(N)),"editingFormats"===n[t]){se=e.editingFormats,c&&c.setPanelSubMenuCommands(St()),c.setPanelQuickAccessCommands(xt());var i=r.getReviewContext({viewer:oe.getViewer()});c.allowReplies(i&&i.getValidation()&&!se&&i.getRestrictions().reply.canCreate),c.setAllowMarkupReorderFlag(!1),c.setAllowSlideReorderFlag(i&&(!i.getValidation()||i.getRestrictions(i.getCurrentSessionMarkup()).markup.canEdit)),A&&(A.setMinWidth(tt()),A.setWidthStep(nt())),Ze()}"playMode"===n[t]&&Y.setPlayMode(e.playMode),"beforeApplySlideCB"===n[t]&&(W=e.beforeApplySlideCB),"afterApplySlideCB"===n[t]&&(H=e.afterApplySlideCB)}}},this.setActiveSlide=function(e,t){if($){et();var n=!0;if(n){for(var i=0;i<de.length;i++)if((de[i].slide?de[i].slide.getAttribute("sID"):null)===(e?e.getAttribute("sID"):null)){n=!1;break}n&&de.push({slide:e,options:t||{}})}1===de.length&&It(de[0].slide,de[0].options)}},this.updateSelectedSlides=function(e){if($)for(var t,n=0;n<ee.length;n++){t=!1;for(var i=0;i<e.length;i++)if(ee[n].slide===e[i]){t=!0;break}c&&c.updateSlide(ee[n].id,{checkFlag:t})}},this.hasReplies=function(e){return ee.some((t=>t.parentSlideID===e))},this.setSlideAsPreview=(e,t)=>{if(Se===e)return;let n;if(ee&&(n=ee.find((t=>t.id===e)),n&&c)){if(Se){const e=ee.find((e=>e.id===Se));e&&(e.slide.setPreviewFlag(!1),c.updateSlide(e.id,{isPreview:!1}))}n.slide.setPreviewFlag(!0),c.updateSlide(n.id,{isPreview:!0})}Se=e,t&&_e(n?n.slide:void 0)},this.setSlideLoading=(e,t)=>{if(ee){let n=ee.find((t=>t.id===e));n&&c&&c.setInProgress(n.id,t)}},this.getSlideIndex=e=>te.findIndex((t=>t.getAttribute("sUuid")===e)),this.updateHeaderCommandsAvailability=()=>{if(c){var e=r.getReviewContext({viewer:oe.getViewer()}),t=e?e.getCurrentSessionMarkup():null;Ue=t?t.getMaturityState():null,c.setPanelSubMenuCommands(St());let n=m.getCommand(se?"DMUFormatCmdHdr":"slideCmdHdr",Q.commandContext);c.setQuickAccessCommandActiveFlag("newButton",n&&n.isEnabled())}},this.clear=function(){var e,t;if(et(),Ee=1,Y.setActiveFlag(!1),ue=null,te.length=0,ee.length=0,de.length=0,Me)for(t=Object.keys(ve),e=0;e<t.length;e++)Me.removeEvent(ve[t[e]]);for(ve={},t=Object.keys(Ce),e=0;e<t.length;e++)De.unsubscribe(Ce[t[e]]);Ce={},Z&&Z.clear(),wt&&i.unsubscribe(wt),wt=null,q&&q.destroy(),q=null,Z=W=H=Me=le=null}}}),k=[];return e.singleton({init:function(){},setActiveSlide:e=>R(e),getDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<k.length;n++)if(k[n].context===e.context){k[n].counter++,t=k[n].slidesController;break}if(e&&e.context&&!t){var i=new A(e);t={setActiveFlag:function(e){i&&i.setActiveFlag(e)},getActiveFlag:function(){if(i)return i.getActiveFlag()},setPanelActiveFlag:function(e){i&&i.setPanelActiveFlag(e)},getPanelActiveFlag:function(){if(i)return i.getPanelActiveFlag()},forcePanelVisibility:function(){if(i)return i.forcePanelVisibility()},addSlide:function(e,t,n){if(i)return i.addSlide(e,t,n)},addReply:function(e){if(i)return i.addReply(e)},addMarkup:function(e){if(i)return i.addMarkup(e)},editMarkupName:function(e,t){i&&i.editMarkupName(e,t)},removeSlide:function(e){if(i)return i.removeSlide(e)},updateSlide:function(e,t){i&&i.updateSlide(e,t)},updateSlideEditableFlag:function(e){i&&i.updateSlideEditableFlag(e)},update:function(){i&&i.update()},clear:function(){i&&i.clear()},setPlayMode:function(e){i&&i.setPlayMode(e)},getPlayMode:function(){return!!i&&i.getPlayMode()},setVisibleFlag:function(e){i&&i.setVisibleFlag(e)},getVisibleFlag:function(){if(i)return i.getVisibleFlag()},setActiveSlide:function(e,t){i&&i.setActiveSlide(e,t)},getActiveSlide:function(){if(i)return i.getActiveSlide()},getSlideRepresentation:function(e,t){if(i)return i.getSlideRepresentation(e,t)},setPanelOptions:function(e){i&&i.setPanelOptions(e)},setSlideFilteringAvailability:function(e){i&&i.setSlideFilteringAvailability(e)},setListOfFilteredSlides:function(e){i&&i.setListOfFilteredSlides(e)},updateSelectedSlides:function(e){i&&i.updateSelectedSlides(e)},getActiveThumbnailCtxMenuPosition:function(){return i?i.getActiveThumbnailCtxMenuPosition():{}},getRepliedSlide:function(){return i?i.getRepliedSlide():null},hasReplies:function(e){return i?i.hasReplies(e):null},setSlideAsPreview:function(e,t){return i?i.setSlideAsPreview(e,t):null},setSlideLoading:function(e,t){return i?i.setSlideLoading(e,t):null},updateHeaderCommandsAvailability:function(){return i?i.updateHeaderCommandsAvailability():null},getSlideIndex:function(e){return i?i.getSlideIndex(e):null}},k.push({context:e.context,slidesController:t,counter:1})}return t?Object.freeze(t):t},giveDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<k.length;n++)if(k[n].context===e.context){t=k[n].slidesController;break}return t?Object.freeze(t):t},unreferenceDMUSlidesController:function(e){if(e&&e.context)for(var t=0;t<k.length;t++)if(k[t].context===e.context){k[t].counter--,k[t].counter<=0&&(k[t].slidesController.clear(),k.splice(t,1));break}}})})),define("DS/DMUBaseUIControllers/DMUCommentsController",["require","exports","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/DMUControls/EXPNotify","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/UIKIT/Spinner","DS/DMUBaseUIControllers/DMUSlidesController","UWA/Core","UWA/Utils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUI/DMUToolsUsers","DS/WebappsUtils/WebappsUtils","DS/DMUControls/panels/DMUCommentsPanel","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIComponents/DMUComment","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","DS/DMUBaseUIServices/DMUObjectsServices"],(function(e,t,n,i,o,r,a,l,s,d,u,c,g,p,m,f,h,v,C,D,b,M,y,w,S,E){"use strict";class x{constructor(e){let t,x,U=this,O=new Map;O.set("PRIVATE","IN_WORK"),O.set("IN_WORK","FROZEN"),O.set("FROZEN","RELEASED"),O.set("RELEASED","OBSOLETE"),O.set("OBSOLETE",void 0);let P=new Map;P.set("PRIVATE",void 0),P.set("IN_WORK","PRIVATE"),P.set("FROZEN","IN_WORK"),P.set("RELEASED",void 0),P.set("OBSOLETE",void 0);let I=new Map;I.set("PRIVATE","#9b2c98"),I.set("IN_WORK","#007da3"),I.set("FROZEN","#018308"),I.set("RELEASED","#757575"),I.set("OBSOLETE","#80808080");let R=new Map;R.set("PRIVATE",S.maturityValue.PRIVATE),R.set("IN_WORK",S.maturityValue.IN_WORK),R.set("FROZEN",S.maturityValue.FROZEN),R.set("RELEASED",S.maturityValue.RELEASED),R.set("OBSOLETE",S.maturityValue.OBSOLETE);let A,k,T,V,j,F,N,L,B,W,H,q,_,z,X,G,K,J=new Map,Z=e.context,Q=!1,Y=!0,$=!1,ee=!1,te=!0,ne={},ie=!1,oe=y.getContextViewer({viewer:Z.getViewer()}),re=y.giveEventsController({viewer:Z.getViewer()}),ae=r.getManager({name:"DMU2DSheetManager",context:Z}),le=!0,se=[],de=new Map;function ue(){if(ae&&("Requirement"===ae.getDocumentType()||"Document"===ae.getDocumentType()))return!0;let e=oe.getRoots(),t=["Requirement","Document","FailureModesEffectsAnalysis"];return!(!e||!e.some((e=>!!e.userData&&t.includes(e.userData.type))))}function ce(e){let t=y.getReviewContext({viewer:Z.getViewer()});if(t){if(e.flag===t.getUIManager().getMarkupVisualizationActiveState())return;let n,i=l.get();for(n=i.length-1;n>=0;n--)i[n].pathElement.getLastElement(!0).getDMUType&&l.remove(i[n]);for(i=s.get(),n=i.length-1;n>=0;n--)i[n].pathElement.getLastElement(!0).getDMUType&&s.remove(i[n]);t.getTransientReviewBag().removeDMUObjects(),t.getUIManager().setMarkupVisualizationActiveState(e.flag),re&&re.fireEvent("onDMUReviewVisbilityChanged",{status:e.flag}),null==U||U.setGuidelineVisibility(e.flag),A&&A.setCurrentMarkup(e.flag?X:null)}}function ge(){A&&A.restoreCommentSelection(),ce({flag:!0}),A&&A.setReviewVisuCheckFlag(!0)}function pe(){A&&A.resetCommentDisplayHistory(),j&&j.destroy(),j=new a({body:Z.getUIFrame(),type:"info",message:S.resetDisplayHistoryLabel}),l.empty(),s.empty()}function me(){let n=[];if(!ue())return n;let o=y.getReviewContext({viewer:Z.getViewer()});const r=o?o.getCurrentSessionMarkup():null;if(!r)return n;if(!Q){X&&o&&!o.getValidation()&&o.getRestrictions(r).markup.canEdit&&(O.get(t)&&n.push({id:"Next State",type:"button",nls:S.maturityValue.SetTo+' "'+R.get(O.get(t))+'"',fontIcon:"fonticon fonticon-double-chevron-right wux-ui-3ds",fontIconColor:I.get(O.get(t)),cb:function(){let e=Z.getUIFrame(),n=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[1],i=e.getElementsByClassName("rp-maturity-"+t)[1];x=new m({visible:!0}),x.inject(n);let o=x.getContent().getSize().width,r=(i.getSize().width-o)/2;x.getContent().setStyles({position:"absolute",height:"20px",right:(33+r).toString()+"px"}),re&&re.fireEvent("onMarkupMaturityModificationRequested",{fromState:t,toState:O.get(t)})}}),P.get(t)&&n.push({id:"Previous State",type:"button",nls:S.maturityValue.SetTo+' "'+R.get(P.get(t))+'"',fontIcon:"fonticon fonticon-double-chevron-left wux-ui-3ds",fontIconColor:I.get(P.get(t)),cb:function(){let e=Z.getUIFrame(),n=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[1],i=e.getElementsByClassName("rp-maturity-"+t)[1];x=new m({visible:!0}),x.inject(n);let o=x.getContent().getSize().width,r=(i.getSize().width-o)/2;x.getContent().setStyles({position:"absolute",height:"20px",right:(33+r).toString()+"px"}),re&&re.fireEvent("onMarkupMaturityModificationRequested",{fromState:t,toState:P.get(t)})}}),n.push({id:"DMUMarkupMaturityChange",type:"button",nls:S.changeMaturity,fontIcon:"fonticon fonticon-collaborative-lifecycle-management wux-ui-3ds",separator:!0,cb:function(){let t=i.getCommand("DMUMarkupMaturityChangeHdr",e.commandContext);t&&t.begin()}}));let a=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext);a&&n.push({id:"DMUExportReviewAsPdf",type:"button",nls:S.launchExportAsPDF,fontIcon:"fonticon fonticon-export-to-pdf wux-ui-3ds",cb:function(){a=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext),a&&a.begin()}})}let a=i.getCommand("DMUCopyLinkHdr",e.commandContext);return a&&n.push({id:"DMUCopyLink",type:"button",nls:S.launchCopyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",cb:()=>{a=i.getCommand("DMUCopyLinkHdr",e.commandContext),a&&a.begin()}}),a=i.getCommand("DMUEditPropertiesHdr",e.commandContext),n.push({id:"DMUEditProperties",type:"button",nls:S.launchEditProperties,fontIcon:"fonticon fonticon-info wux-ui-3ds",cb:function(){ge(),a=i.getCommand("DMUEditPropertiesHdr",e.commandContext),a&&a.begin()}}),Q&&n.push({id:"DMUResetDisplayHistory",type:"button",nls:S.resetDisplayHistoryLabel,icon:b.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:pe}),n}function fe(){let t=y.getReviewContext({viewer:Z.getViewer()}),n=t?t.getCurrentSessionMarkup():null,o=[];const r=ae&&("Requirement"===ae.getDocumentType()||"Document"===ae.getDocumentType());n&&!Q&&(X&&r&&o.push({id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:S.switchMarkupVisibility,cb:function(e){ce({flag:e.dsModel.checkFlag}),k&&k.isSmallWidth()&&k.collapsePanel()}}),o.push({id:"newCommentButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:S.newComment,cb:function(){let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t.isRunning()?t.end():t.begin(),k&&k.isSmallWidth()&&k.collapsePanel()}})),!Q&&(null==t?void 0:t.getValidation())&&A?o.push({id:"filterCommentsButton",type:"button",fontIcon:A&&A.hasFiltersApplied()?"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter-select-on CATWebUXSectionHeaderSectionBulletsSelected":"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter",title:S.filterComments,cb:function(){A&&(l.empty(),A.setFilterViewFlag(!A.getFilterViewFlag()))}}):r&&(o.push({id:"previousButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-left",title:S.previousComment,cb:function(){i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext).begin()}}),o.push({id:"nextButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-right",title:S.nextComment,cb:function(){i.getCommand("DMUNextCommentCmdHdr",e.commandContext).begin()}}));const a=n?n.getMaturityState():null;return a&&r&&o.push({id:"maturityStateButton",type:"label",title:S.maturityState,label:S.maturityValue[a],className:"rp-ms-box rp-maturity-"+a}),o}function he(){!W&&A&&(W=setInterval((function(){if(A){if(!Z)return W&&clearInterval(W),void(W=null);if(k&&oe&&oe.getRootBagPath().getChildrenPathes().length){let t=i.getCommand("DMUNextCommentCmdHdr",e.commandContext);if(t&&(!ae||!ae.isRunning())){W&&clearInterval(W),W=null;let n=y.getReviewContext({viewer:Z.getViewer()}),o=S.commentsPanelTitle;if(ue()){let e=n?n.getValidation():null,t=n?n.getCurrentSessionMarkup():null;e?o=e.getName():t&&(o=t.getAttribute("sName"))}A.updatePanelHeader({panelTitle:o,contextualCmdList:me(),quickAccessBtnList:fe(),headerDrag:Boolean(B)}),t=i.getCommand("DMUCommentCmdHdr",e.commandContext),A.updatePanelHeader({quickAccessBtnAvailability:{flag:t&&t.isEnabled(),id:"newCommentButton"}}),t=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),A.updatePanelHeader({quickAccessBtnAvailability:{flag:t&&t.isEnabled(),id:"nextButton"}}),t=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext),A.updatePanelHeader({quickAccessBtnAvailability:{flag:t&&t.isEnabled(),id:"previousButton"}})}}}}),500))}function ve(e){var t;if(e){let n=y.getReviewContext({viewer:Z.getViewer()}),i=n?n.getValidation():null;if(i){let n=null===(t=e.getMarkupOwner())||void 0===t?void 0:t.getParent();if(!n){let t=i.getMarkups();t&&t.some((t=>{let i=t.getRepRef();if(i){if(i.getMarkupContent()===e)return n=t,!0;let o=t.getReplies();o&&o.some((t=>{let i=t.getRepRef();if(i&&i.getMarkupContent()===e)return n=t,!0}))}}))}if(n)return{id:n.getRepRef().getPlmID(),name:n.getName(),type:n.getValType()}}}return{id:"default"}}function Ce(e,t){if(t){const n=t.getPointedReference&&t.getPointedReference(0);if(n){let i=t.getParent();if(i){let t=i.getAttribute("oLinksManager");if(t){let i=t.getOccurrencePathElement(n);i&&e.add({pathElement:i})}}}else{let n=o.buildPathElement(t.getNode());l.isIn({pathElement:n})||e.add({pathElement:n})}}}function De(e){if(ge(),e&&e!==X){X=e;let t=y.getReviewContext({viewer:Z.getViewer()});if(t){t.getTransientReviewBag().removeDMUObjects();let e=t?t.getValidation():null;e&&e.setCurrentMarkup(e.getRepRef(X))}}}function be(e){A&&(A.restoreCommentSelection(),e&&e.length&&(F=null,e.forEach((e=>{var t,n;if(e.isReply()&&z){let t=e.getAttribute("sParentCommentId");const n=J.get(t);if(n&&n.replies&&A){const t=n.replies.find((t=>t.dmuObject===e));t&&(A.selectReply(t.uuid,n.uuid),F=n.uuid,Ce(s,n.parentObject))}}else{const i=J.get(e.getAttribute("sUuid"));if(i){let e;if(Y&&k){let o=ae.getElementMatrix("Document"===ae.getDocumentType()?i.pointedPage:null===(t=i.pointedElement)||void 0===t?void 0:t.id),r=C.getViewerPositionFromPoint(oe.getViewer(),null===(n=i.pointedPosition)||void 0===n?void 0:n.clone().applyMatrix4(o));r&&(e=r.top-k.getAbsolutePosition().y)}A&&A.selectComment(i.uuid,e,ee),ee=!1,F=i.uuid,Ce(s,i.parentObject)}}}))))}function Me(e){if(!e)return;if(e.isReply()&&z){let t=e.getAttribute("sParentCommentId");const n=J.get(t);return n?n.dmuObject:void 0}let t=e.getNode().getParents();if(!t||!t.length)return;let n=e.getParent()||y.getReviewContext({viewer:Z.getViewer()}),i=o.buildPathElement(t[0]);return null==n?void 0:n.getDMUObjectFromPathElement(i)}function ye(e){let t=y.getReviewContext({viewer:Z.getViewer()});const n=t&&t.getValidation();if(!n){const n=t&&t.getCurrentSessionMarkup(),i=n&&n.getSlides();return null==i?void 0:i.find((t=>t.getDMUObjects("DMUComment").find((t=>t===e))))}{let t=n.getMarkups();if(t){let n;return t.some((t=>{var i;let o=t.getRepRef();if(o){const r=o.getMarkupContent();if(r){const t=r.getSlides(),o=e.isReply()?null===(i=J.get(e.getParentCommentId()))||void 0===i?void 0:i.dmuObject:e;if(o&&(n=null==t?void 0:t.find((e=>e.getDMUObjects("DMUComment").find((e=>e===o)))),n))return!0}let a=t.getReplies();a&&a.some((t=>{let i=t.getRepRef();if(i){const t=i.getMarkupContent();if(t){const i=t.getSlides();if(n=null==i?void 0:i.find((t=>t.getDMUObjects("DMUComment").find((t=>t===e)))),n)return!0}}}))}})),n}}}function we(e){const t=y.getReviewContext({viewer:Z.getViewer()}),n=null==t?void 0:t.getCurrentSessionMarkup(),i=null==n?void 0:n.getCurrentSlide();return i&&i===ye(e)}function Se(e,t){const n=y.getReviewContext({viewer:Z.getViewer()});if(!q||!_||ie||!k.getContentVisibleState()||!oe.getViewer().getVisibleSpace()||!n||!n.getUIManager().getMarkupVisualizationActiveState())return;if(!(e&&e.length||t&&t.length))return void q.setStyle("display","none");"none"===q.getStyle("display")&&q.setStyle("display","block");let i=function(e){var t;if(!A)return;const n="string"==typeof e?J.get(e):e.isReply()?J.get(e.getAttribute("sParentCommentId")):J.get(e.getAttribute("sUuid"));if(n&&!n.hasAlertFlag()&&!A.isCommentFiltered(n.uuid)&&(!n.parentObject.hasAttribute("bVisible")||n.parentObject.getAttribute("bVisible"))){let e=C.getViewerPositionFromPoint(oe.getViewer(),E.getAbsolutePosition(n.parentObject,n.pointedPosition,n.pointedPosition,(null===(t=n.parentObject)||void 0===t?void 0:t.getPointedReference)&&n.parentObject.getPointedReference(0)));if(e){let t=k.getAbsolutePosition().x<e.left,i=A.getDivPositionFrom(n.uuid,oe.getViewer().canvas,t);_&&i&&(_.moveTo(e.left,e.top),_.lineTo(i.x+(t?45:-45),e.top),_.lineTo(i.x+(t?-10:-20),i.y),_.lineTo(i.x+(t?-25:-7),i.y))}}};_.clearRect(0,0,q.width,q.height),e&&e.length&&(_.setLineDash([]),_.strokeStyle="#368EC4",_.beginPath(),e.forEach(i),_.stroke()),t&&t.length&&(_.setLineDash([5,5]),_.strokeStyle="#78BEFA",_.beginPath(),t.forEach(i),_.stroke())}function Ee(){let e=d.get(),t=[],n=y.getReviewContext({viewer:Z.getViewer()});for(let i=0;i<e.length;i++){if(!e[i].pathElement)continue;let o;if(n&&(o=n.getDMUObjectFromPathElement(e[i].pathElement)),o||(o=null==U?void 0:U.getDMUObjectFromPathElement(e[i].pathElement)),o){if("DMUComment"!==o.getType()||!we(o)||o.isReply()&&z){if(o.getDMUComments&&te){let e=o.getDMUComments();t=t.concat(e.map((e=>e.getAttribute("sUuid"))))}}else t.push(o.getAttribute("sUuid"))}}var i;H&&Se(H.filter((e=>we(e))),t),i=t,A&&(A.restoreCommentPreSelection(),i&&i.length&&(i.forEach((e=>{if(!A)return;let t=J.get(e);if(t){if(G&&G.has(t.uuid)){let e=G.get(t.uuid);e&&e.forEach((e=>{t&&e.updateDate(D.formatDate(t.dateInMs))}))}A.preSelectComment(t.uuid),Ce(d,t.parentObject)}})),te=!0))}function xe(){let e=l.get();H||(H=[]),H.length=0;let t=y.getReviewContext({viewer:Z.getViewer()});for(let n=0;n<e.length;n++){let i;if(t&&(i=t.getDMUObjectFromPathElement(e[n].pathElement)),i||(i=null==U?void 0:U.getDMUObjectFromPathElement(e[n].pathElement)),i){if("DMUComment"===i.getType())H.push(i);else if(i.getDMUComments){let e=i.getDMUComments();H=H.concat(e),ae.fireCrossWidgetSelection(i.getAttribute("sPointedElementID"))}}}H&&Se(H.filter((e=>we(e)))),be(H)}function Ue(e,t){let n,i=e.isReply()&&z;if(t=t||(e.isExternal()?void 0:Me(e)),!i){let t=function(e){let t=y.getReviewContext({viewer:Z.getViewer()}),n=t?t.getValidation():null;if(!n)return;let i=[];return n.getAllRepRefs().forEach((t=>{let n=t.getMarkupContent();if(n){let t=n.getComments();t&&t.forEach((t=>{t.getAttribute("sParentCommentId")===e&&i.push(t)}))}})),i}(e.getAttribute("sUuid")||"");t&&t.length&&(n=[],t.forEach((function(t){let i=Ue(t,e);i.uuid&&(null==n||n.push(i))})),n.sort(((e,t)=>e.dateInMs-t.dateInMs)))}const o=t&&t.getAttribute("sPointedElementID"),r=t&&t.getAttribute("fPointedPageNumber");let a=function(e){return"DMUCommentOnTable"===(null==t?void 0:t.getType())?t.getPointedElementInfo():e?ae.getElementInfo(e):void 0}(o),l=y.getReviewContext({viewer:Z.getViewer()});const s=e.getParent(),d=s&&s.getMarkupOwner(),u=ve(s);if(!a&&!o&&!r){const t=ye(e),n=f.giveDMUSlidesController({context:Z});if(t&&n){const e=t.getAttribute("sUuid");a={id:e,title:t.getAttribute("sName"),index:n.getSlideIndex(e)}}}const c=l&&l.getValidation()&&"Activated"===l.getValidation().getRestrictedEditionFlag(),g=e.isExternal()?e.getExternalStatus():null==d?void 0:d.getCommentStatus(null==e?void 0:e.getAttribute("sUuid")),p=e.getAssociatedHighlightData();return{parentObject:t,markupId:e.isExternal()?"externalCommentsBag":u.id,markupName:e.isExternal()?void 0:u.name,dmuObject:e,uuid:e.getAttribute("sUuid")||"",isReply:i,owner:{login:e.getAttribute("sOwner")||""},dateInMs:e.getAttribute("fLastModificationDate")||0,replies:n,content:(m=e.getAttribute("sTextContents"),Array.isArray(m)&&m.length?m[0].endsWith(">")?m.join("\n"):m.map((e=>`<p>${e}</p>`)).join(""):""),isReadOnly:e.isReadOnly,isExternal:e.isExternal(),markedAsDeleted:Boolean(e.getAttribute("bMarkedAsDeleted")),isPreview:K&&K.id===e.getAttribute("sUuid"),disableEdition:!l||!l.getRestrictions(d)[i||"Reply"===u.type?"reply":"markup"].canEdit||c&&(g||p.length>0),allowReply:!e.isReadOnly()&&z&&l&&l.getValidation()&&l.getRestrictions().reply.canCreate&&!(null==t?void 0:t.getAttribute("bMarkedAsDeleted"))&&!(c&&(g||p.length>0)),hasAlertFlag:e.hasAlertFlag,pointedPage:r,pointedElement:a||(o?{id:o}:void 0),pointedPosition:t&&t.getPointedPosition?t.getPointedPosition():void 0,status:g||""};var m}function Oe(){se.length&&se.sort((function(e,t){const n=J.get(e),i=J.get(t);if(!n)return-1;if(!i)return 1;if(n.pointedElement&&i.pointedElement){if(n.pointedElement.group&&i.pointedElement.group){if("number"!=typeof n.pointedElement.group.index)return-1;if("number"!=typeof i.pointedElement.group.index)return 1;if(n.pointedElement.group.index<i.pointedElement.group.index)return-1;if(n.pointedElement.group.index>i.pointedElement.group.index)return 1}return"number"!=typeof n.pointedElement.index?-1:"number"!=typeof i.pointedElement.index?1:n.pointedElement.index<i.pointedElement.index?-1:n.pointedElement.index>i.pointedElement.index?1:n.pointedPosition?i.pointedPosition?-1===n.pointedElement.id.indexOf("_")&&i.pointedElement.id.indexOf("_")>-1?1:-1===i.pointedElement.id.indexOf("_")&&n.pointedElement.id.indexOf("_")>-1||n.pointedPosition.y>i.pointedPosition.y?-1:n.pointedPosition.y<i.pointedPosition.y?1:Math.sign(n.dateInMs-i.dateInMs):1:-1}return void 0===n.pointedPage?-1:void 0===i.pointedPage?1:n.pointedPage<i.pointedPage?-1:n.pointedPage>i.pointedPage?1:n.pointedPosition?i.pointedPosition?n.pointedPosition.y>i.pointedPosition.y?-1:n.pointedPosition.y<i.pointedPosition.y?1:Math.sign(n.dateInMs-i.dateInMs):1:-1}))}function Pe(){if(!A)return;let n=y.getReviewContext({viewer:Z.getViewer()}),o=n?n.getCurrentSessionMarkup():null;t=o?o.getMaturityState():null;let r=i.getCommand("DMUCommentCmdHdr",e.commandContext);A.updatePanelHeader({quickAccessBtnAvailability:{flag:r&&r.isEnabled(),id:"newCommentButton"}});let a=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),l=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext);J&&0!==J.size?(a&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"nextButton"}}),a.isEnabled()||a.enable()),l&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"previousButton"}}),l.isEnabled()||l.enable())):(a&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"nextButton"}}),a.isEnabled()&&a.disable()),l&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"previousButton"}}),l.isEnabled()&&l.disable()))}async function Ie(e,t){const n=J.get(t||e);if(n){const{min:e,max:t}=n.parentObject.getNode().getBoundingBox();if(e.x===1/0)return;const i=(new p.Vector3).getPositionFromMatrix(n.parentObject.getNode().getMatrixWorld()),o=C.getMMPerPixelRatio(oe.getViewer(),i),r=oe.getViewer().currentViewpoint.getEyePosition(),a=i.sub(r),l=oe.getViewer().canvas.getSize(),u=5,c={x:(a.x+e.x)/o+l.width/2-u,y:-(a.y+t.y)/o+l.height/2-u},g=s.get(),m=d.get();s.empty(),d.empty();const f=new ImageData(l.width,l.height);oe.getViewer().renderToTarget(f,oe.getViewer().currentViewpoint),s.add(g),d.add(m);const h=144,v=108,D=document.createElement("canvas"),b=D.getContext("2d");if(b){let e=await createImageBitmap(f,0,0,f.width,f.height);b.scale(1,-1),b.drawImage(e,c.x,f.height-c.y,h,-v,0,0,h,-v),e.close()}return D.toDataURL("image/png")}}async function Re(e,t){const n=await Ie(e,t);n&&re&&re.fireEvent("onPreviewThumbnailUpdateRequested",{elementId:e,thumbnailData:n})}function Ae(e){de.forEach(((t,n)=>{const i=t.findIndex((t=>t.uuid===e.uuid));-1!==i&&(t.splice(i,1),0===t.length&&de.delete(n))}))}function ke(e){var t;if(!e.pointedElement)return;Ae(e);let n=e.pointedElement.id;de.has(n)||de.set(n,[]),null===(t=de.get(n))||void 0===t||t.push(e)}function Te(e,t){var n;if(e.isTemporary()||!A)return;k.ensureVisible(),ge();let i=y.getReviewContext({viewer:Z.getViewer()});if(e&&(e.isExternal()||i)&&!J.has(e.getAttribute("sUuid"))){let i=Ue(e,t);if(e.getAttribute("bMarkedAsDeleted")&&!(null===(n=i.replies)||void 0===n?void 0:n.length))return void("DMUCommentHighlight"!==(null==t?void 0:t.getType())&&"DMUCommentPositioned"!==(null==t?void 0:t.getType())&&"DMUCommentOnTable"!==(null==t?void 0:t.getType())||null==t||t.getParent().getSlides()[0].getNode().removeChild(t.getNode()));i.uuid&&(se.push(i.uuid),A.addComment(i),J.set(e.getAttribute("sUuid"),i),Oe(),Pe(),e.setPreviewFlag(i.isPreview),i.isExternal||ke(i),!i.isPreview||ae&&ae.isRunning()||Re(i.uuid))}}function Ve(e,t,n){var i,o,r,a,l,s,d,u;if(J&&A){let c=n||Ue(e,t);const g=J.get(e.getAttribute("sUuid"));if(g){let t=Object.keys(c),n=!1;for(let e=0;e<t.length;e++){const s=t[e],d=c[s];d||!1===d?("pointedPage"===s&&d!==g[s]?n=!0:"pointedElement"!==s||d.id===(null===(i=g[s])||void 0===i?void 0:i.id)&&d.index===(null===(o=g[s])||void 0===o?void 0:o.index)&&(null===(r=d.group)||void 0===r?void 0:r.id)===(null===(l=null===(a=g[s])||void 0===a?void 0:a.group)||void 0===l?void 0:l.id)?"pointedPosition"===s&&d&&g[s]&&!d.equals(g[s])&&(n=!0):n=!0,"owner"===s?g[s].login=d.login:g[s]=d):"highlights"!==s&&"status"!==s||(g[s]=void 0)}G&&(G.has(g.uuid)&&(null===(s=G.get(g.uuid))||void 0===s||s.forEach((e=>e.update({...g,disableEdition:!0})))),G.has(g.uuid+"-tooltip")&&(null===(d=G.get(g.uuid+"-tooltip"))||void 0===d||d.forEach((e=>e.update({...g,disableEdition:!0}))))),g.isExternal||ke(g),window.widget&&"X3DPLAW_AP"!==window.widget.getValue("appId")&&(null===(u=c.replies)||void 0===u||u.forEach((t=>{var n;t.dmuObject.setReadOnly(Boolean(c.status)||(null===(n=e.getAssociatedHighlightData())||void 0===n?void 0:n.length)>0)}))),A.updateComment(g,n),n&&Oe()}}}function je(e,t){ge();let n=y.getReviewContext({viewer:Z.getViewer()});if(!(n&&n&&n.getCurrentSessionMarkup()&&e))return;const i=J.get(t.getAttribute("sUuid"));if(i&&A){let n=Ue(e,t);if(n.uuid){if(-1===(i.replies?i.replies.findIndex((function(e){return e.uuid===n.uuid})):-1)){A.addReply(n,i.uuid);let e=i.replies||[];e.push(n),i.replies=e}e.setPreviewFlag(n.isPreview),n.isPreview&&Re(n.uuid,i.uuid)}}}function Fe(e,t){ge(),l.empty();let n=y.getReviewContext({viewer:Z.getViewer()}),i=n?n.getCurrentSessionMarkup():null;if(!n||!e||!i)return;let r=t||Me(e);if(r){const t=J.get(r.getAttribute("sUuid"));if(t&&t&&t.replies&&t.replies.length){let n=t.replies.findIndex((function(t){return t.dmuObject===e}));if(n>=0){A&&A.removeReply(t.replies[n].uuid,t.uuid),t.replies.splice(n,1),e.getParent().removeComment(e);let i=o.buildPathElement(t.dmuObject.getNode());l.add({pathElement:i})}}}}function Ne(e){if(!e||!e.target||!e.target.dmuObject)return;ge(),Y=!1,ee=!0;let t=o.buildPathElement(e.target.dmuObject.getNode());l.empty(),l.add({pathElement:t}),ae.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:0})}function Le(e){if(!e||!e.target||!e.target.dmuObject)return;let t=e.target.isReply?null:o.buildPathElement(e.target.dmuObject.getNode());d.empty(),t&&e.prehighlightedFlag&&(te=!1,d.add({pathElement:t}))}function Be(e){if(!ae||"Document"===ae.getDocumentType())return;let t=y.getReviewContext({viewer:Z.getViewer()}),n=t&&t.getCurrentSessionMarkup(),i=n&&n.getCurrentSlide();const o=ye(e.dmuObject);return o!==i?new Promise((e=>{if(!re)return e();let t=re.addEvent("onDMUSlideDisplayed",(()=>{re&&re.removeEvent(t),e()}));const n=f.giveDMUSlidesController({context:Z});n&&n.setActiveSlide(o)})):void 0}async function We(e,t=!1){var n,i;let r=o.buildPathElement(e.target.dmuObject.getNode()),a=function(){if(!t){if(e.target.parentObject){let t=o.buildPathElement(e.target.parentObject.getNode());s.remove({pathElement:t})}l.remove({pathElement:r})}};if(e.ctrlKeyPressed)l.isIn({pathElement:r})?a():l.add({pathElement:r});else if(e.shiftKeyPressed)if(window.getSelection?null===(n=window.getSelection())||void 0===n||n.empty():null===(i=document.getSelection())||void 0===i||i.empty(),l.isIn({pathElement:r}))a();else{let t=F?se.indexOf(F):-1,n=se.indexOf(e.target.isReply?e.target.parentObject.getAttribute("sUuid"):e.target.uuid);if(-1!==t&&-1!==n&&t!==n){let e=function(e){let t=se[e],n=J.get(t);if(n&&!(null==A?void 0:A.isCommentFiltered(t))&&!n.isReply){let e=o.buildPathElement(n.dmuObject.getNode());l.add({pathElement:e})}};if(t>n)for(let i=t;i>=n;i--)e(i);else for(let i=t;i<=n;i++)e(i)}}else t&&l.isIn({pathElement:r})||(l.empty(),s.empty(),await Be(e.target),l.add({pathElement:r}))}async function He(e){if(!e||!e.target||!e.target.dmuObject)return;ge(),Y=!1;e.selected&&await We({target:e.target,ctrlKeyPressed:e.event.from[0].event.ctrlKey,shiftKeyPressed:e.event.from[0].event.shiftKey});let t=oe.getViewer();if(t.getVisibleSpace()||(t.swapVisibleSpace(),t.render()),e.target.pointedPosition){let n=e.div.getPosition(t.canvas);ae.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:t.SCREEN_HEIGHT/2-n.y-30})}e.selected&&!e.isEnableEdition&&k.isSmallWidth()&&k.collapsePanel()}function qe(e){if(e&&e.target&&e.target.dmuObject){let t=e.value.split(/(?:\r\n|\r|\n)/g);const n=e.target.dmuObject.getAttribute("sTextContents");Array.isArray(n)&&n.length===t.length&&!n.some(((e,n)=>e!==t[n]))||(t.find((e=>e))&&e.target.dmuObject.setAttributes([{name:"sTextContents",value:t},{name:"fLastModificationDate",value:Date.now()}]),e.target.dmuObject.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:e.target.dmuObject}),k&&k.isSmallWidth()&&k.collapsePanel())}}function _e(t){if(t&&t.target&&t.target.dmuObject){let n=o.buildPathElement(t.target.isReply?t.target.parentObject.getNode():t.target.dmuObject.getNode());l.empty(),Y=!1,l.add({pathElement:n});let r=i.getCommand("DMUReplyCmdHdr",e.commandContext);r&&r.begin()}}async function ze(e){if(!e||!e.target.dmuObject)return;await We({target:e.target,ctrlKeyPressed:e.ctrlKeyPressed,shiftKeyPressed:e.shiftKeyPressed},!0);let t=l.get().filter((e=>{const t=null==U?void 0:U.getDMUObjectFromPathElement(e.pathElement);return t&&!t.isExternal()&&!t.isReadOnly()}));l.empty(),s.empty(),Y=!1,l.add(t),Z.getExecutionContext?Z.getContextualUIManager()._showContextMenu(e.position.clone()):Z.getContextualUIManager()._showContextualMenu(e.position.clone())}function Xe(e){if(!q||!_)return;let t=e.eventType||e.event||e.type;"scroll"!==t&&"@onViewpointBeginMove"!==t||_.clearRect(0,0,q.width,q.height),"scroll"!==t&&"@onViewpointEndMove"!==t||Se(H)}function Ge(e){if("freeZoneResize"!==e.type&&"move"!==e.type&&q){let e=Z.getViewerFrame().getDimensions();q.width=e.width,q.height=e.height}Se(H)}function Ke(t){let n;y.getReviewContext({viewer:Z.getViewer()})&&(t.target&&("textarea"===t.target.type||"input"===t.target.type||"P"===t.target.tagName||t.target.isContentEditable)||(!t.ctrlKey||"ArrowRight"!==t.key&&39!==t.keyCode?!t.ctrlKey||"ArrowLeft"!==t.key&&37!==t.keyCode||(n=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext),n&&n.isEnabled()&&n.begin()):(n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),n&&n.isEnabled()&&n.begin())))}function Je(e){let t=y.getReviewContext({viewer:Z.getViewer()});if(!t)return;let n=t.getValidation();n&&n.getMarkups().some((t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return re&&re.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0}))}function Ze(e){var t;let n=y.getReviewContext({viewer:Z.getViewer()}),i=n?n.getValidation():null;if(i){let n=i.getMarkups().find((t=>{let n=t.getRepRef();return n.getPlmID&&n.getPlmID()===e.id})),r=null===(t=null==n?void 0:n.getRepRef())||void 0===t?void 0:t.getMarkupContent();if(r){let t=o.buildPathElement(r.getNode());l.empty(),s.empty(),l.add({pathElement:t}),d.add({pathElement:t}),Z.getExecutionContext?Z.getContextualUIManager()._showContextMenu(e.position.clone()):Z.getContextualUIManager()._showContextualMenu(e.position.clone())}}}function Qe(e){null==U||U.setGuidelineVisibility(e.dsModel.contentVisibleState)}function Ye(){if(A||(A=new M,T={onCommentSelected:A.subscribe("onCommentSelected",He),onCommentEditionEnd:A.subscribe("onCommentEditionEnd",qe),onCommentReply:A.subscribe("onCommentReply",_e),onCommentCtxMenuRequired:A.subscribe("onCommentCtxMenuRequired",ze),onCommentPreselected:A.subscribe("onCommentPreselected",Le),onPanelScroll:A.subscribe("onPanelScroll",Xe),onMarkupRenamed:A.subscribe("onMarkupRenamed",Je),onSetCurrentMarkup:A.subscribe("onSetCurrentMarkup",De),onMarkupCtxMenuRequired:A.subscribe("onMarkupCtxMenuRequired",Ze),onNewCommentCreated:A.subscribe("onNewCommentCreated",(()=>{let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t&&(t.isRunning()?t.end():t.begin(),k&&k.isSmallWidth()&&k.collapsePanel())})),onNewMentions:A.subscribe("onNewMentions",(e=>{re&&re.fireEvent("onNewCommentMentionsCreated",{commentId:e.commentId,mentions:e.mentions})})),onCommentCheckSelected:A.subscribe("onCommentCheckSelected",(e=>{re&&re.fireEvent("onCommentOrSlideInformationIconClicked",e)})),onCommentHighlightSelected:A.subscribe("onCommentHighlightSelected",(e=>{re&&re.fireEvent("onCommentOrSlideInformationIconClicked",e)})),onCommentFiltersApplied:A.subscribe("onCommentFiltersApplied",(()=>{A&&A.updatePanelHeader({quickAccessBtnList:fe()})}))},V={},V.onPSOEmpty=d.onEmpty(Ee),V.onPSORemove=d.onRemove(Ee),V.onPSOAdd=d.onAdd(Ee),V.onCSOEmpty=l.onEmpty(xe),V.onCSORemove=l.onRemove(xe),V.onCSOAdd=l.onAdd(xe),A.setReadOnlyFlag(Q)),!k){let e=y.getReviewContext({viewer:Z.getViewer()}),t=S.commentsPanelTitle;const i=ue();if(i){let n=e?e.getValidation():null,i=e&&e.getCurrentSessionMarkup()||void 0;n?t=n.getName():i&&(t=i.getAttribute("sName"))}let o=A.buildPanel({draggable:i,allowReplies:Boolean(e&&e.getValidation()),panelTitle:t,contextualCmdList:me(),quickAccessBtnList:fe(),sortComments:i||$}),r=e&&e.getCurrentSessionMarkup()||void 0;A.setRestrictedModeFlag(Boolean(e&&!e.getRestrictions(r).markup.canEdit)),B&&A.setDragContent(B),he();let a=300,l=160,s=250;k=new n({id:"DMUCommentsPanel",className:"DMUCommentsPanel",showTitleFlag:!1,autoCloseFlag:!1,closeButtonFlag:!1,icon:"fonticon wux-ui-3ds-comment",immersiveFrame:Z.getImmersiveFrame(),viewerFrame:Z.getViewerFrame(),content:o,minWidth:s,width:a,minHeight:l,height:l,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea}),null==U||U.setVisibleFlag(le),ae&&ae.isRunning()&&k.setEnableFlag(!1)}let t=Z.getUIFrame();if(t){q=new h.Element("canvas",{id:"DMUCommentGidelineCanvas",styles:{height:"100%",width:"100%",pointerEvents:"none",float:"left",position:"absolute"}}).inject(t);let e=Z.getViewerFrame(),n=e.getDimensions();q&&(q.width=n.width,q.height=n.height,_=q.getContext("2d")),e.addEvent("resize",Ge),Z.getImmersiveFrame().addEventListener("freeZoneResize",Ge)}L=g.subscribe({event:"/VISU/"},Xe),k.addEventListener("move",Ge),k.addEventListener("contentVisibleStateChange",Qe),document.addEventListener("keyup",Ke)}function $e(){let e=y.getReviewContext({viewer:Z.getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(t&&!t.isReadOnly()){let e=r.getManager({name:"DMUUserExperienceManager",context:Z});e&&(e.registerContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),e.registerContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}))}}function et(){if($e(),ae.isADocumentDisplayed()&&"Document"===ae.getDocumentType()){let e=ae?ae.getExternalComments():null;if(e&&e.length){let t=["DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUCommentHighlight"];window.require(t,(function(t,n){if(!U)return;let i;N||(N=[]),A||Ye();let o=Z.getViewer().getNodes();for(let e=0;e<o.length;e++)if("DecorationBag"===o[e].name){i=o[e];break}e.forEach((function(e){let o=new t(oe.getViewer(),null,!0,e.status);o.setAttributes([{name:"sUuid",value:v.getUUID()},{name:"sOwner",value:e.owner.name},{name:"sTextContents",value:e.content}]);let r=new n(oe.getViewer(),null,!0);r.setAttributes([{name:"sUuid",value:v.getUUID()},{name:"vPosition",value:e.pointedPosition},{name:"fPointedPageNumber",value:e.pointedPage},{name:"oSelection",value:[{page:e.pointedPage,rects:[e.rect]}]}]),r.addDMUComment(o),Te(o,r),i&&i.addChild(r.getNode()),N&&N.push(r),r.refreshNode()})),Z.getViewer().render()}))}}}if(re){let e=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(B=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:u.getPlatformId(),serviceId:"3DSpace",contextId:c.getSetting("pad_security_ctx")?c.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),A&&A.setDragContent(B))},n=y.getReviewContext({viewer:Z.getViewer()});n&&e(n.getReviewCtxInformation()||void 0),ne.onReviewCtxInformationChanged=re.addEvent("onReviewCtxInformationChanged",e),ne.onUpdateReqCompareContainers=re.addEvent("onUpdateReqCompareContainers",(e=>{var t;e&&e.commentContainerMap&&(t=e.commentContainerMap)&&t.forEach(((e,t)=>{null==A||A.updateCommentContainerTitle(t,e)}))})),ne.onDMUObjectActiveFlagChanged=re.addEvent("onDMUObjectActiveFlagChanged",(function(e){n=y.getReviewContext({viewer:Z.getViewer()}),n&&A&&e&&(!e||e.dmuObject)&&(n.getValidation()||"DMUMarkup"!==e.dmuObject.getType()||ge())})),ne.onDMUCommentEditionRequired=re.addEvent("onDMUCommentEditionRequired",(function(e){e&&e.dmuObject&&"DMUComment"===e.dmuObject.getType()&&function(e,t,n){if(!A)return;let i=0;J.size||(i=500),setTimeout((()=>{A&&A.enableContentEdition(e.getAttribute("sUuid"),t?t.getAttribute("sUuid"):void 0,n)}),i)}(e.dmuObject,e.parentObject,e.selectText)})),ne.onDMUObjectInitialized=re.addEvent("onDMUObjectInitialized",(function(e){let t=y.getReviewContext({viewer:Z.getViewer()}),n=t?t.getCurrentSessionMarkup():null;if(e&&e.dmuObject){let t=e.dmuObject.getType();"DMUComment"===t?e.dmuObject.isReply()&&z?je(e.dmuObject,e.parentObject):(A||Ye(),Te(e.dmuObject,null),Se(H)):"DMUMarkup"!==t&&"ReviewMarkup"!==t||(ue()&&Ye(),he(),$e()),n||"DMUValidationValidation"!==t||he()}})),ne.onCurrentSessionMarkupChanged=re.addEvent("onCurrentSessionMarkupChanged",(function(e){let t=y.getReviewContext({viewer:Z.getViewer()});if(z=Boolean(t&&t.getValidation()),e&&e.currentMarkup){let n=ve(e.currentMarkup).id;if(X=n,t&&!t.getValidation()){let t=e.currentMarkup.getSlides();t&&(t.forEach((e=>{e.getDMUObjects().filter((function(e){return e.getDMUComments&&e.getDMUComments().length})).forEach((function(e){e.getDMUComments().forEach((function(t){A||Ye(),Te(t,e)}))}))})),Se(H),A&&he())}}else X=null;A&&(A.setCurrentMarkup(X),A.setAllowReplies(Boolean(t&&t.getValidation())),A.updatePanelHeader({quickAccessBtnList:fe(),contextualCmdList:me()}))})),ne.onDMUObjectVisuRefreshRequired=re.addEvent("onDMUObjectVisuRefreshRequired",(function(e){if(e&&e.dmuObject){let t=e.dmuObject.getType();if("DMUSlide"===t)N&&N.forEach((function(e){e.refreshNode()})),Z.getViewer().render();else if("DMUComment"===t)e.dmuObject.isReply()&&z?function(e,t,n){var i;if(!J||!e)return;let o=t||Me(e),r=n||Ue(e,o);if(o&&r){const t=J.get(o.getAttribute("sUuid"));if(t&&t.replies&&A&&t.replies){let n=t.replies.find((t=>t.dmuObject===e));if(!n)return;let o=Object.keys(r);for(let e=0;e<o.length;e++)r[o[e]]&&(n[o[e]]=r[o[e]]);G&&G.has(n.uuid+"-tooltip")&&(null===(i=G.get(n.uuid+"-tooltip"))||void 0===i||i.forEach((e=>{n&&e.update({...n,disableEdition:!0})}))),A.updateComment(t)}}}(e.dmuObject):Ve(e.dmuObject);else if(e.dmuObject.getDMUComments){e.dmuObject.getDMUComments().forEach((function(t){const n=t.getAttribute("sUuid");Ve(t,e.dmuObject),K&&n===(K.parentId||K.id)&&Re(K.id,K.parentId),t.getAssociatedHighlightData().length&&Ie(n).then((e=>{re&&re.fireEvent("onPreviewUpdateOnHighlightRequested",{elementId:n,imageData:e})}))}))}}})),ne.onDMUObjectsVisuRefreshRequired=re.addEvent("onDMUObjectsVisuRefreshRequired",(function(){let e=y.getReviewContext({viewer:Z.getViewer()}),t=e?e.getVisibleMarkups():null;if(t){t.map((e=>e.getCurrentSlide())).forEach((e=>{e&&e.refreshNode()}))}N&&N.forEach((function(e){e.refreshNode()})),Z.getViewer().render()})),ne.onDMUObjectDeleted=re.addEvent("onDMUObjectDeleted",(function(e){if(e&&e.dmuObject){let t=e.dmuObject.getType();if("DMUComment"===t)null==U||U.removeComment(e.dmuObject);else if("DMUMarkup"===t&&A){let t=ve(e.dmuObject).id;A.removeMarkup(t),Pe()}}})),ne.onDMUObjectAttributeModified=re.addEvent("onDMUObjectAttributeModified",(function(e){e&&"bMarkedAsDeleted"===e.attrName&&"DMUComment"===e.dmuObject.getType()&&e.value&&A&&A.removeComment(e.dmuObject.getAttribute("sUuid"))})),ne.onUpdateImpactedChecksList=re.addEvent("onUpdateImpactedChecksList",(function(e){if(!e||!e.highlight)return;const t=e.highlight.getPlmID(),n=J.values();for(let i=0;i<J.size;i++){const i=n.next().value;if(i.highlights&&i.highlights.some((e=>e.id===t))){i.dmuObject.updateAssociatedHighlightData({id:t,hasImpactedChecks:Boolean((e.highlight.getAssociatedCheck()||[]).length)});break}}})),ne.onCurrentElementChanged=re.addEvent("onCurrentElementChanged",(function(e){e&&e.currentElement&&A&&(Y&&A.scrollPanelToContainer({containerNumber:e.currentElement}),e.endMove&&(Y=!0))})),ne.onDMUObjectReadOnlyFlagChanged=re.addEvent("onDMUObjectReadOnlyFlagChanged",(function(e){var t;e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&((t=e.dmuObject.isReadOnly())!==Q&&(Q=t,ge(),he(),A&&(A.resetCommentDisplayHistory(),A.setReadOnlyFlag(t))))})),ne.on2DDocumentLoadSuccess=re.addEvent("on2DDocumentLoadSuccess",(()=>{N&&N.length||et(),k&&k.setEnableFlag(!0),he();const e=ae&&("Requirement"===ae.getDocumentType()||"Document"===ae.getDocumentType());A&&A.setSortComments(e)})),ne.onFMEALoadSuccess=re.addEvent("onFMEALoadSuccess",(()=>{$=!0,A&&A.setSortComments(!0)})),ne.OnReviewMarkupLoaded=re.addEvent("OnReviewMarkupLoaded",(function(e){let t=y.getReviewContext({viewer:Z.getViewer()}),n=t?t.getValidation():null;if(n){let t=n.getAllRepRefs(),i=[],o=[];for(let e=0;e<t.length;e++){let n=t[e],r=n.getParent().getValType();"Markup"===r?i.push({title:n.getParent().getName(),content:n,id:n.getPlmID()}):"Reply"===r&&o.push({title:n.getParent().getName(),content:n,id:n.getPlmID(),parentID:n.getParentRepRef().getPlmID()})}let r={};i.forEach((e=>{null==U||U.addMarkup(e);let t=e.content.getMarkupContent();if(!t)return;let n=t.getSlides(),i=t.getAttribute("sCurrentSlideId");n.forEach((e=>{i===e.getAttribute("sID")&&t.setCurrentSlide(e);let n=e.getDMUObjects();n&&n.forEach((e=>{if(e.getDMUComments){let t=e.getDMUComments();t&&t.forEach((t=>{Te(t,e),r[t.getAttribute("sUuid")]=t}))}}))}))})),o.forEach((e=>{var t;let n=null===(t=e.content.getMarkupContent())||void 0===t?void 0:t.getComments();n&&n.forEach((e=>{let t=e.getAttribute("sParentCommentId");r[t]&&je(e,r[t])}))}));let a=n.getCurrentMarkup();if(a&&A&&(X=a.getRepRef().getPlmID(),A.setCurrentMarkup(X)),n.updateVisibleMarkups(),null==e?void 0:e.commentId)if(J.has(e.commentId)){const t=J.get(e.commentId);if(t)if(ae&&ae.isRunning()){if(re){let e=re.addEvent("on2DDocumentLoadSuccess",(()=>{re&&re.removeEvent(e),Ne({target:t})}))}}else Ne({target:t})}else J.forEach((t=>{t.replies&&t.replies.some((t=>{if(t.uuid===e.commentId){if(ae&&ae.isRunning()){if(re){let e=re.addEvent("on2DDocumentLoadSuccess",(()=>{re&&re.removeEvent(e),Ne({target:t})}))}}else Ne({target:t});return!0}}))}))}})),ne.onDMURemoveSessionReview=re.addEvent("onDMURemoveSessionReview",(function(){A&&J&&(N&&N.length?(J.forEach(((e,t)=>{e.isExternal||J.delete(t)})),Pe(),he()):null==U||U.cleanCommentsPanel())})),ne.onDMUCommentAssociatedToHighlight=re.addEvent("onDMUCommentAssociatedToHighlight",(function(e){e&&e.dmuObject&&(Ve(e.dmuObject,null,{highlights:e.highlights}),e.dmuObject.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:e.dmuObject}))})),ne.onMarkupObjectAttributesModified=re.addEvent("onMarkupObjectAttributesModified",(function(e){e&&e.object&&e.attr&&"DMUMarkup"===e.object.getType()&&e.attr.forEach((function(e){e.currentState&&A&&(t=e.currentState,x&&(x.destroy(),x=null),A.updatePanelHeader({quickAccessBtnList:fe(),contextualCmdList:me()}))}))})),ne.onValidationObjectAttributesModificationRequest=re.addEvent("onValidationObjectAttributesModificationRequest",(function(e){var t,n;e&&e.dmuObject&&"name"===(null===(t=e.attr)||void 0===t?void 0:t.key)&&"Markup"===(null===(n=e.dmuObject.getParent())||void 0===n?void 0:n.getType())&&J.forEach((t=>{t.markupId===e.dmuObject.getPlmID()&&Ve(t.dmuObject,t.parentObject,{markupName:e.attr.value})}))})),ne.onHighlightAttributeChanged=re.addEvent("onHighlightAttributeChanged",(function(e){if(e&&e.objectIds&&e.objectIds.length){const t=e.objectIds.slice(),n=J.values();for(let i=0;i<J.size;i++){const i=n.next().value;if(i.highlights&&i.highlights.length){if(t.filter((e=>{var t;return null===(t=i.highlights)||void 0===t?void 0:t.some((t=>t.id===e))})).forEach((n=>{i.dmuObject.updateAssociatedHighlightData({id:n,rating:e.rating}),t.splice(t.indexOf(n),1)})),!t.length)break}}}})),ne.onHighlightIssueOrTaskCreated=re.addEvent("onHighlightIssueOrTaskCreated",(function(e){if(e&&e.highlightId&&e.type){const t=J.values();for(let n=0;n<J.size;n++){const n=t.next().value;if(n.highlights&&n.highlights.some((t=>t.id===e.highlightId))){n.dmuObject.updateAssociatedHighlightData({id:e.highlightId,..."issue"===e.type?{hasIssue:!0}:{hasTask:!0}});break}}}})),ne.onDMUSlideNameChanged=re.addEvent("onDMUSlideNameChanged",(function(e){e&&e.dmuObject&&J.forEach((t=>{var n;t.pointedElement&&(null===(n=t.pointedElement)||void 0===n?void 0:n.id)===e.dmuObject.getAttribute("sUuid")&&(t.pointedElement.title=e.value,null==A||A.updateCommentContainerTitle(t.uuid,e.value))}))})),ne.onDMUSlideReordered=re.addEvent("onDMUSlideReordered",(function(){const e=f.giveDMUSlidesController({context:Z});e&&(J.forEach((t=>{if(t.pointedElement){const n=e.getSlideIndex(t.pointedElement.id);t.pointedElement.index=n,null==A||A.updateCommentContainerNumber(t.uuid,n)}})),null==A||A.sortContainers())})),ne.onReviewObjectAttributesModified=re.addEvent("onReviewObjectAttributesModified",(function(e){var t;if(e&&e.attr&&e.attr.length&&A){let e=y.getReviewContext({viewer:Z.getViewer()});if(e&&e.getValidation()){e.getValidation().getMarkups().forEach((t=>{if(A&&e&&t){let n=t.getRepRef();n.getMarkupContent()&&(e.getRestrictions(t).markup.canEdit?A.addMarkup({id:n.getPlmID(),owner:n.getOwner(),title:n.getParent().getName()}):A.removeMarkup(n.getPlmID()))}}));const n=e.getCurrentSessionMarkup();n&&(A.setCurrentMarkup(null===(t=n.getMarkupOwner())||void 0===t?void 0:t.getPlmID()),A.setRestrictedModeFlag(!e.getRestrictions(n).markup.canEdit))}J.forEach((t=>{const n=t.dmuObject.getParent(),i=n&&n.getMarkupOwner();t.allowReply=z&&(null==e?void 0:e.getRestrictions().reply.canCreate),t.disableEdition=!(null==e?void 0:e.getRestrictions(i).markup.canEdit),t.replies&&t.replies.forEach((t=>{const n=t.dmuObject.getParent(),i=n&&n.getMarkupOwner();t.allowReply=z&&(null==e?void 0:e.getRestrictions().reply.canCreate),t.disableEdition=!(null==e?void 0:e.getRestrictions(i).reply.canEdit)})),null==A||A.updateComment(t)})),he()}}))}this.addMarkup=function(e){let t=y.getReviewContext({viewer:Z.getViewer()}),n=t?t.getValidation():null;z=Boolean(n),e&&n&&ae&&(A||Ye(),A&&(null==t?void 0:t.getRestrictions(e.content).markup.canEdit)&&(A.addMarkup({id:e.id,owner:e.content.getOwner(),title:e.title,parentID:e.parentID}),A.setCurrentMarkup(e.id),A.setRestrictedModeFlag(!1)))},this.editMarkupName=function(e){A&&e&&e.getPlmID&&A.editMarkupName(e.getPlmID())},this.getSelectedComments=function(){return H&&H.filter((e=>!e.isExternal()))},this.getCommentTooltip=function(e){const t={processed:{fontIcon:"wux-ui-3ds-check",color:"rgb(1, 131, 8)"},withdrawn:{fontIcon:"wux-ui-3ds-wrong",color:"rgb(204, 9, 47)"},accepted:{fontIcon:"wux-ui-3ds-thumbs-up",color:"rgb(1, 131, 8)"},rejected:{fontIcon:"wux-ui-3ds-thumbs-down",color:"rgb(204, 9, 47)"},1:{fontIcon:"wux-ui-3ds-attention",color:"#007DA3"},2:{fontIcon:"wux-ui-3ds-level-low",color:"rgb(71,119,56)"},3:{fontIcon:"wux-ui-3ds-level-medium",color:"rgb(232,123,0)"},4:{fontIcon:"wux-ui-3ds-level-high",color:"rgb(234,79,55)"},5:{fontIcon:"wux-ui-3ds-check",color:"rgb(71, 119, 56)"},6:{fontIcon:"wux-ui-3ds-alert",color:"rgb(153, 7, 7)"}};if(!ie)return null;const n=[];if(J.forEach((t=>{t.parentObject.getNode()===e&&n.push(t)})),n.length){G||(G=new Map);let e=h.createElement("div",{class:"DMUCommentTooltipMainDiv"});return n.forEach((n=>{var i;if(!G)return;const o=G.get(n.uuid+"-tooltip");let r=o?o[0]:null,a=r?r.getCommentDiv():null;if(!a){let e=new w({commentData:{...n,disableEdition:!0},allowReplies:!0});G.set(n.uuid+"-tooltip",[e]),r=e,a=e.getCommentDiv()}let l=n.status&&n.status in t?n.status:null;if(null===(i=n.highlights)||void 0===i?void 0:i.length){let e={id:"",rating:"0"};n.highlights.forEach((t=>{(5===parseInt(t.rating)?0:parseInt(t.rating))>=(5===parseInt(e.rating)?0:parseInt(e.rating))&&(e=t)})),l=e.rating}l&&l in t&&r&&r.addInformationIcon({id:"commentStatus",...t[l]}),e.appendChild(a),n.replies&&n.replies.forEach((function(e){if(!G)return;const t=G.get(e.uuid+"-tooltip");let n=t&&t[0]?t[0].getCommentDiv():null;if(!n){let t=new w({commentData:{...e,disableEdition:!0},allowReplies:z});G.set(e.uuid+"-tooltip",[t]),n=t.getCommentDiv()}null==a||a.appendChild(n)}))})),e}},this.getCommentRepresentation=function(e,t){var n;const i=J.get(e);if(i){G||(G=new Map);let o={displayMode:t,commentData:{...i,disableEdition:!0},onClickCB:Ne,onEnterCB:Le,onLeaveCB:Le},r=new w(o);return G.has(e)?null===(n=G.get(e))||void 0===n||n.push(r):G.set(e,[r]),{getDiv:r.getCommentDiv,updateDisplayMode:r.updateDisplayMode,getImage:()=>Ie(e),remove:()=>{if(G){let t=G.get(e);t&&(t.splice(t.indexOf(r),1),0===t.length&&G.delete(e)),r.remove()}}}}},this.hasComments=function(){return Boolean(J&&J.size)},this.applyComment=function(e){if(!e.commentId)return;const t=J.get(e.commentId);t&&Ne({target:t})},this.setVisibleFlag=function(e){le=e,k&&k.setPanelVisibilityFlag(e),q&&q.setStyle("display",e?"block":"none")},this.setPresentationModeFlag=function(e){ie=e},this.addCommentToPanel=function(e){Te(e,null)},this.removeCommentFromPanel=function(e){if(!e)return;ge();let t=J.get(e.getAttribute("sUuid"));A&&t&&(A.removeComment(t.uuid),J.delete(t.uuid),se.splice(se.indexOf(t.uuid),1),Pe())},this.removeComment=function(e,t){if(!e)return;if(e.isReply()&&z)return void Fe(e);ge();const n=J.get(e.getAttribute("sUuid"));if(n){n.replies&&n.replies.slice().forEach((function(t){Fe(t.dmuObject,e)})),n.status&&(null==re||re.fireEvent("onDMUCommentWithStatusDeleted",{markupId:n.markupId,commentId:n.uuid})),null==re||re.fireEvent("onDMUCommentDeleted",{dmuObject:e,parentObject:n.parentObject}),se.splice(se.indexOf(n.uuid),1),A&&A.removeComment(n.uuid),J.delete(n.uuid),n.isExternal||Ae(n);ue()||J.size||null==U||U.setVisibleFlag(!1);let i=n.parentObject;Pe();let o=y.getReviewContext({viewer:Z.getViewer()}),r=i?i.getParent():null;if(i&&r){let n;s.empty();const a=o&&o.getValidation()&&"Activated"===o.getValidation().getRestrictedEditionFlag();if(t){let t=r.getSlides();if(t.length>1)for(let e=0;e<t.length;e++){let o=t[e].getDMUObjects();if(o&&o.includes(i)){n=t[e];break}}else n=t[0];n&&(a&&!e.isReply()?(e.setAttribute("bMarkedAsDeleted",!0),i.setAttribute("bMarkedAsDeleted",!0),n.getNode().removeChild(i.getNode())):n.removeDMUObject(i)),Z.getViewer().render()}else{a&&!e.isReply()?e.setAttribute("bMarkedAsDeleted",!0):i.removeDMUComment(e);let t=i.getType();if("DMUCommentHighlight"===t||"DMUCommentPositioned"===t||"DMUCommentOnTable"===t){let t=i.getAttribute("lComments");if(!t||!t.length||1===t.length&&-1!==t.indexOf(e)){let t=r.getSlides();if(t.length>1)for(let e=0;e<t.length;e++){let o=t[e].getDMUObjects();if(o&&o.includes(i)){n=t[e];break}}else n=t[0];n&&(a&&!e.isReply()?(i.setAttribute("bMarkedAsDeleted",!0),n.getNode().removeChild(i.getNode())):n.removeDMUObject(i)),Z.getViewer().render()}}}}}},this.selectNextOrPreviousComment=async function(e){ge();let t,n=e?1:-1,i=F?se.indexOf(F):-1;do{let o=(i+n)%se.length;o<0&&(o=se.length-1),t=se[o],n+=e?1:-1}while((null==A?void 0:A.isCommentFiltered(t))&&n<=se.length);const r=J.get(t);if(l.empty(),s.empty(),r){await Be(r);let e=o.buildPathElement(r.dmuObject.getNode());Y=!1,ee=!0,l.add({pathElement:e}),ae.centerViewpointAtElementPosition({elementID:(r.pointedElement?r.pointedElement.id:null)||r.pointedPage,position:r.pointedPosition}),k&&k.isSmallWidth()&&k.collapsePanel()}},this.hasReplies=e=>{const t=J.get(e);return Boolean(t&&t.replies&&t.replies.length)},this.getDMUObjectFromPathElement=function(e){if(!e)return;let t=e.getLastElement(!0),n=t.getDMUType?t.getDMUType():null;if(n){let e;if("DMUComment"===n){let n=J.values();for(let i=0;i<J.size;i++){let i=n.next().value;if(i){if(i.dmuObject.getNode()===t)return i.dmuObject;if(i.replies&&i.replies.length&&(e=i.replies.findIndex((e=>e.dmuObject.getNode()===t)),e>=0))return i.dmuObject}}}else if(N&&(e=N.findIndex((function(e){return e.getNode()===t})),e>=0))return N[e]}},this.getMarkupIdFromCommentId=function(e){var t;if(e)return null===(t=J.get(e))||void 0===t?void 0:t.markupId},this.getTargetedObject=function(e){let t=this.getTargetedObjectIdPath(e);if(t&&t.length){let e=t[t.length-1];return e||void 0}},this.getTargetedObjectIdPath=function(e){var t;let n=null===(t=J.get(e))||void 0===t?void 0:t.parentObject,i=(null==n?void 0:n.getPointedReference)&&(null==n?void 0:n.getPointedReference(0));if(i){let e=n.getParent();if(e){let t=e.getAttribute("oLinksManager");if(t){t.getOccurrencePathElement(i);let e=t.getOccurrencePathElement(i);for(;e&&!o.isReference(e.getLastElement());)e=e.getParentPath();return o.getIdPath(e)}}}},this.setGuidelineVisibility=function(e){_&&q&&(e?(q.setStyle("display","block"),Se(H)):q.setStyle("display","none"))},this.setCommentAsPreview=(e,t,n)=>{if(K&&K.id===e)return;const i=J.get(z&&t||e);if(i&&A){if(K&&K.id){const e=J.get(z&&K.parentId||K.id);e&&(K.parentId&&e.replies?e.replies.some((e=>{if(K&&e.uuid===K.id)return e.dmuObject.setPreviewFlag(!1),e.isPreview=!1,!0})):(e.dmuObject.setPreviewFlag(!1),e.isPreview=!1),A.updateComment(e))}t&&i.replies?i.replies.some((t=>{if(K&&t.uuid===e)return t.dmuObject.setPreviewFlag(!0),t.isPreview=!0,!0})):(i.dmuObject.setPreviewFlag(!0),i.isPreview=!0),A.updateComment(i)}K={id:e,parentId:z?t:void 0},n&&Re(e,t)},this.updateHeaderCommandsAvailability=()=>{Pe()},this.setCommentLoading=(e,t)=>{A&&A.setCommentLoading(e,t)},this.setCommentUnselectableFlags=e=>{J.forEach((t=>{null==A||A.setCommentUnselectable(t.uuid,e&&(Boolean(t.status)||t.isExternal))}))},this.cleanCommentsPanel=function(){let e;ge(),document.removeEventListener("keyup",Ke),Pe();let t=Z.getViewer()?Z.getViewer().getNodes():[];if(N&&N.length){for(let n=0;n<t.length;n++)if("DecorationBag"===t[n].name){e=t[n];break}N.forEach((function(t){e&&e.removeChild(t.getNode())}))}if(A){let e=Object.keys(T);for(let t=0;t<e.length;t++)A.unsubscribe(T[e[t]]||"");T={},A.clear()}V&&(d.unsubscribe(V.onPSOEmpty),d.unsubscribe(V.onPSORemove),d.unsubscribe(V.onPSOAdd),l.unsubscribe(V.onCSOEmpty),l.unsubscribe(V.onCSORemove),l.unsubscribe(V.onCSOAdd)),q&&_&&(Z.getViewerFrame().removeEvent("resize",Ge),Z.getImmersiveFrame().removeEventListener("freeZoneResize",Ge),_.clearRect(0,0,q.width,q.height),_=null,q.remove()),L&&g.unsubscribe(L),j&&j.destroy(),W&&clearInterval(W),k&&(k.removeEventListener("move",Ge),k.removeEventListener("contentVisibleStateChange",Qe),k.setPanelVisibilityFlag(!1),k.clean()),J.clear(),Q=!1,B=q=j=A=k=N=W=V=null},this.clear=function(){null==U||U.cleanCommentsPanel();let e,t,n=r.getManager({name:"DMUUserExperienceManager",context:Z});if(n&&(n.unregisterContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),n.unregisterContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"})),re)for(t=Object.keys(ne),e=0;e<t.length;e++)re.removeEvent(ne[t[e]]||"");G&&G.clear(),ne={},j&&j.destroy(),j=null,W&&clearInterval(W),J.clear(),se.length=0,U=G=re=A=W=F=null},this.preSelectCommentsFromPointedObjectsIdPath=e=>{A&&A.restoreCommentPreSelection(),e.length&&(te=!1,e.forEach((e=>{let t=de.get(e.idPath);null==t||t.forEach((e=>{A&&A.preSelectComment(e.uuid)}))})))},this.selectCommentsFromPointedObjectsIdPath=e=>{te=!1;let t=[];e.forEach((e=>{var n,i;let o=de.get(e.idPath),r=null==o?void 0:o.map((e=>e.dmuObject));r&&r.length&&t.push(...r),o&&o.length&&this.scrollToContainer({containerName:null===(i=null===(n=o[0].pointedElement)||void 0===n?void 0:n.group)||void 0===i?void 0:i.title})})),be(t)},this.getCommentTooltipFromPointedObjectIdPath=e=>{if(!e)return;let t=de.get(e.idPath);if(!(null==t?void 0:t.length))return;let n=new h.createElement("div");return t.forEach((e=>{let t=e.parentObject;if(!t||!t.getNode())return;let i=this.getCommentTooltip(t.getNode());i&&n.appendChild(i)})),n},this.scrollToContainer=e=>{if(A){if(e.containerNumber||e.containerName)return A.scrollPanelToContainer(e);if(e.pointedElement&&e.pointedElement.getPointedElementInfo){let t=e.pointedElement.getPointedElementInfo();return A.scrollPanelToContainer({containerNumber:t.group?t.group.index:t.index})}}},this.getCommentsPointingElement=e=>{let t=de.get(e);return null==t?void 0:t.map((e=>e.dmuObject))},ae&&ae.isADocumentDisplayed()&&!ae.isRunning()&&et()}}let U=[];return class{static getDMUCommentsController(e){let t;for(let n=0;n<U.length;n++)if(U[n].context===e.context)return t=U[n].controller,U[n].count++,t;let n=new x(e);return t=Object.freeze({addMarkup:function(e){n&&n.addMarkup(e)},editMarkupName:function(e){n&&n.editMarkupName(e)},setVisibleFlag:function(e){n&&n.setVisibleFlag(e)},setPresentationModeFlag:function(e){n&&n.setPresentationModeFlag(e)},getCommentTooltip:function(e){if(n)return n.getCommentTooltip(e)},getCommentRepresentation:function(e,t){if(n)return n.getCommentRepresentation(e,t)},getSelectedComments:function(){if(n)return n.getSelectedComments()},hasComments:function(){return!!n&&n.hasComments()},applyComment:function(e){if(n)return n.applyComment(e)},addCommentToPanel:function(e){n&&n.addCommentToPanel(e)},removeComment:function(e,t){n&&n.removeComment(e,t)},removeCommentFromPanel:function(e){n&&n.removeCommentFromPanel(e)},setGuidelineVisibility:function(e){n&&n.setGuidelineVisibility(e)},setCommentAsPreview:function(e,t,i){n&&n.setCommentAsPreview(e,t,i)},selectNextOrPreviousComment:function(e){n&&n.selectNextOrPreviousComment(e)},getDMUObjectFromPathElement:function(e){if(n)return n.getDMUObjectFromPathElement(e)},getMarkupIdFromCommentId:function(e){if(n)return n.getMarkupIdFromCommentId(e)},getTargetedObject:function(e){if(n)return n.getTargetedObject(e)},getTargetedObjectIdPath:function(e){if(n)return n.getTargetedObjectIdPath(e)},hasReplies:function(e){return!!n&&n.hasReplies(e)},updateHeaderCommandsAvailability:function(){if(n)return n.updateHeaderCommandsAvailability()},setCommentLoading:function(e,t){if(n)return n.setCommentLoading(e,t)},setCommentUnselectableFlags:function(e){if(n)return n.setCommentUnselectableFlags(e)},cleanCommentsPanel:function(){if(n)return n.cleanCommentsPanel()},clear:function(){if(n)return n.clear()},preSelectCommentsFromPointedObjectsIdPath:function(e){if(n)return n.preSelectCommentsFromPointedObjectsIdPath(e)},selectCommentsFromPointedObjectsIdPath:function(e){if(n)return n.selectCommentsFromPointedObjectsIdPath(e)},getCommentTooltipFromPointedObjectIdPath:function(e){if(n)return n.getCommentTooltipFromPointedObjectIdPath(e)},scrollToContainer:function(e){if(n)return n.scrollToContainer(e)},getCommentsPointingElement:function(e){if(n)return n.getCommentsPointingElement(e)}}),U.push({context:e.context,controller:t,count:1}),t}static giveDMUCommentsController(e){if(e&&e.context)for(let t=0;t<U.length;t++)if(U[t].context===e.context)return U[t].controller}static unreferenceDMUCommentsController(e){if(e&&e.context)for(let t=0;t<U.length;t++)if(U[t].context===e.context){U[t].count--,0===U[t].count&&(U[t].controller.clear(),U.splice(t,1));break}}}})),define("DS/DMUBaseUIControllers/DMUSceneDisplayController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUCompareVisu/DMUBaseCompareServices","DS/DMUControls/DMUBaseSlider","DS/DMUControls/EXPNotify","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/DMUBaseUIControllers/DMUApplicativeContextManager","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],(function(e,t,n,i,o,r,a,l,s,d,u,c){"use strict";var g=e.extend({init:function(e){this._parent(e);let g=null,p=e.context,m=o.createSceneGraphOverrideSet(p.getViewer()),f=o.createSceneGraphOverrideSet(p.getViewer()),h=new r(p.getFrameWindow(),{ctxViewer:p});h.setLegendVisibleFlag(!1);let v,C,D,b,M,y,w,S,E,x,U,O,P,I,R,A,k,T,V=null,j=null,F=this,N=0,L=0,B=[],W=50,H="unset",q=!0,_=[],z=!1,X=null,G=null,K=null,J=!1,Z=!1,Q=!1,Y=null,$=d.givePreferenceManager({context:p.getFrameWindow()});function ee(e,t){var i,r,a=[],l=[];if(e&&e.length)for(i=0;i<e.length;i++)if(e[i]&&e[i].getLastElement){var s=e[i].clone();if(o.isAModelPath(s)){for(;s&&!o.isPLMNode(s.getLastElement(!0));)s=s.getParentPath();s&&s.externalPath.length>1&&(r=o.getIdPath(s),a.push(r),l.push(o.getI3DXPath(s)))}}else r=e[i].ids?e[i].ids.slice():e[i],a.push(r);if(g&&p&&a.length){var d=n.getReviewContext({viewer:p.getViewer()});if(d&&d.getActiveFlag()){var u=!1,c=d.getCurrentSessionMarkup();if(d&&c&&c.getActiveFlag()&&c.isVisible()&&!d.isReadOnly()&&!c.isReadOnly()){for(i=0;i<a.length;i++)if(a[i][0]===B[0]){var f=c.getOrCreateOccurrenceOverloader({idPath:a[i],i3dxPath:l[i]},!0);if(!f)continue;var h=o.getOverrides(m,{idPaths:[f.getOccurrenceIDPath()]});h&&1===h.length&&h[0].setVisibility(void 0===t?null:t),t!==f.getAttribute("bVisible")&&(u=!0,f.setAttribute("bVisible",t))}u&&c.fireEvent("onSaveRequested",{}),c.fireEvent("onOccurenceVisibleFlagChanged"),p.getViewer().render()}}}}function te(e,t){C&&(C.destroy(),C=null),C=new l({body:p.getFrameWindow().getUIFrame(),type:e,message:t})}function ne(e,n){if(m&&e&&e.length){var i=[],r=[];o.ensurePriorityOfSceneGraphOverrideSet(p.getViewer(),m),e.forEach((function(e){var a=e.target;if(a){var l=a.getOccurrenceIDPath();if(l){var s=o.getOverrides(m,{idPaths:[l]},!0);if(e.state&&a.getActiveFlag()&&a.isVisible()){if(s.length||(s=o.getOverrides(m,{idPaths:[l]})),s&&1===s.length){s=s[0];var d=e.state.bVisible;if(n||void 0!==d){s.setVisibility(void 0===d?null:d);var u=l.slice();!1===d?i.push(u):r.push(u)}if(d=e.state.fOpacity,(n||void 0!==d)&&s.setOpacity(void 0===d?null:d,!0),d=e.state.cColor,(n||void 0!==d)&&s.setColor(d&&d.getHexString?"#"+d.getHexString():null,!0),void 0!==(d=e.state.mTransfoMatrix))s.setPosition(d);else if(void 0!==(d=e.state.mPosition)){if(d){var c=e.target.getOccurrencePathElement(),g=c&&c.getParentPath()?c.getParentPath().getWorldMatrix():null;if(g){var p=(new t.Matrix4).getInverse(g);d=(new t.Matrix4).multiplyMatrices(p,d)}}s.setPosition(d)}}}else s&&1===s.length&&!1===s[0].getVisibility()&&r.push(l),o.removeOverride(m,{idPath:l})}}})),r.length&&(N++,p.getHideShowController().show({idPaths:r,dispatch:!0})),i.length&&(L++,p.getHideShowController().hide({idPaths:i,dispatch:!0})),p.getViewer().render()}}function ie(){if(B&&B.length){var e=p.getHideShowController().getSGOverrideSet();if(e){var t,i=[],o=[],r=[],a=e.getOverrides();for(t=0;t<a.length;t++){let e=a[t].getIdPathes();if(e&&e.length)for(var l=0;l<e.length;l++)B.includes(e[l].getElement(1))&&r.push(e[l])}if(B.forEach((e=>p.getHideShowController().clearOverrides(e))),n.getReviewContext({viewer:p.getViewer()}).isReadOnly()){require(["DS/3DPlay/3DPlay"],(function(e){if(p){const t=e.getExperience(p.getCommandContext());t&&t.executeScriptingFunction("showAll")}}),(()=>null))}for(t=0;t<r.length;t++){var s=r[t].buildPathElement(p.getViewer().getIdPathMatcher());s&&(p.getHideShowController().isVisible(s)?o.push(r[t].ids.slice(1,r[t].ids.length)):i.push(r[t].ids.slice(1,r[t].ids.length)))}i.length&&(L++,p.getHideShowController().publish({event:"onHide",data:{paths:i,dispatch:!0}}),p.getHideShowController()._commandProxy&&p.getHideShowController()._commandProxy.hide({paths:i})),o.length&&(N++,p.getHideShowController().publish({event:"onShow",data:{paths:o,dispatch:!0}}),p.getHideShowController()._commandProxy&&p.getHideShowController()._commandProxy.show({paths:o}))}}}function oe(e){let t=[],n=[];if(e&&e.getObjectOverloads){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let o=i[e].target.getOccurrenceIDPath();n.push(JSON.stringify(o)),t.push(i[e])}}e.getPointedFormats&&e.getPointedFormats().length&&e.getPointedFormats().forEach((function(e){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let o=i[e].target.getOccurrenceIDPath();n.includes(JSON.stringify(o))||t.push(i[e])}}}))}return t}function re(){if(_.length&&(p.getController().unlockNodes({ids:_}),_.length=0),I=!1,M&&M.fireEvent("onComparisonEnded",{dmuObject:M}),h&&h.clean(),D&&D.clean(),f&&f.deleteOverrides(f.getOverrides()),z&&U&&U.setNavBarVisibleFlag(!0),!z&&p&&p.getHideShowController()&&E&&p.getHideShowController().hide({paths:[E],dispatch:!0}),p&&M&&!J&&!Z&&z&&w&&w.length){O=null;let e=p.getRoots();for(let t=0;t<e.length;t++)o.getNodeID(e[t])===w[0]&&(e[t].isBeingRemoved=!0);let t=[w[0]];p.getStatusBar()&&p.getStatusBar().clearFilter({ids:t}),p.getController().removeRoots({pids:t},!0,!1)}y=null,w=null,z=!1,M=null,S=null,E=null,D=null}function ae(e){var t=[];return void 0===e&&(t=[1,1]),e>=50?(t.push(1),t.push(1-.02*(e-50))):(t.push(1-.02*(50-e)),t.push(1)),t}function le(){if(p){let e=n.getReviewContext({viewer:p.getViewer()});if(e&&e.getTransientReviewBag()&&e.getTransientReviewBag().getDMUObjects(z?"DMUCompare2D":"DMUCompare3D").length){J=!1;let t=z;re(),e.getTransientReviewBag().removeDMUObjects(t?"DMUCompare2D":"DMUCompare3D")}}}async function se(e){if(f&&f.deleteOverrides(f.getOverrides()),M&&S&&(q=e,void 0===q&&(q=!0),q)){let e=M.getAttribute("oSelections");if(e&&2===e.length&&e[1].id){let i=M.getParent().getAttribute("oLinksManager");var n;if("ENOStrRefinementSpecification"===O){let e=await p.getController().getPrdIdFromFilterId(w);n=i.getOccurrence({idPath:[e]},!1)}else n=i.getChildWithID(e[1].id);if(n){let e=n.path?i.getOccurrenceIdPath(n.path):n.identifier?[n.identifier]:null;if(e&&1===e.length){let n=S&&S.getParentPath()?S.getParentPath().getWorldMatrix():null;if(n){let i=p.getController().createReferenceIterator(e[0]),r=[];i&&i.isRepRef()?r.push({idPath:e,matrix:new t.Matrix4}):i.getChildren().forEach((function(n){n.getInstanceId&&n.getInstanceId()&&r.push({idPath:[].concat(e).concat(n.getInstanceId()),matrix:n.getMatrix&&n.getMatrix()?n.getMatrix():new t.Matrix4})})),r&&r.length&&r.forEach((e=>{let i=o.getOverrides(f,{idPaths:[e.idPath]});i&&i.length&&i.forEach((i=>{i.setPosition((new t.Matrix4).multiplyMatrices(n,e.matrix))}))}))}}}}}p.getViewer().render()}function de(){let e=[];if(!z&&y&&y[0]&&w&&w[0]){let t=F.getDisplayedAndHiddenOccurrences(y[0]);t&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths)),t=F.getDisplayedAndHiddenOccurrences(w[0]),t&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths))}return e}function ue(e,t){if(D&&"number"==typeof e){W=e;let n,i=ae(e),r=R,a=A;n=z?T:k,h.updateCompareModel({Old:{color:a,pathElements:[E],opacity:i[0]},New:{color:r,pathElements:[S],opacity:i[1]},Common:{color:n},compareMode:z?"2D":"3D",noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:de()}),t&&D.update({leftButton:{color:r},rightButton:{color:a},value:W});let l=o.getOverrides(f,{idPaths:[y,w]});l&&l.length&&l.forEach((e=>{e.setPickability("PICKABLE")})),0!==e&&100!==e||(l=o.getOverrides(f,{idPaths:[100===e?y:w]}),l&&l.length&&l.forEach((e=>{e.setPickability("IGNORED")})))}}async function ce(){try{let e=(await s.readPreferences([{Repository:"DMURepository",PreferenceNames:["CompareFirstColor","CompareSecondColor","Compare3DCommonColor","Compare2DCommonColor"]}])).repositories[0].preferences;for(let t=0;t<e.length;t++)"CompareFirstColor"===e[t].name?R=e[t].value:"CompareSecondColor"===e[t].name?A=e[t].value:"Compare3DCommonColor"===e[t].name?k=e[t].value:"Compare2DCommonColor"===e[t].name&&(T=e[t].value)}catch(e){R="#CC092F",A="#6FBC4B",k="#D3D3D3",T="#000000",window.console.warn("Could not get server value, default value set instead.",e)}if(x=null,!(M&&M.getParent()&&p&&g&&y&&y.length&&w&&w.length))return re();let e=M.getAttribute("oSelections");if(e&&2===e.length){let n=M.getParent().getAttribute("oLinksManager");if(n){if("ENOStrRefinementSpecification"===P){let e=await p.getController().getPrdIdFromFilterId(y),t=n.getOccurrence({idPath:[e]},!1);t&&(S=n.getOccurrencePathElement(t.id))}else S=n.getOccurrencePathElement(e[0].id);if(!S)return C=te("info",c.comparisonFailed),void re();if("ENOStrRefinementSpecification"===O){let e=await p.getController().getPrdIdFromFilterId(w),t=n.getOccurrence({idPath:[e]},!1);t&&(E=n.getOccurrencePathElement(t.id))}else E=n.getOccurrencePathElement(e[1].id);if(!E)return C=te("info",c.comparisonFailed),void re();if(z){let e=M.getAttribute("oSheetIDs");if(e&&e.length&&(K=e[1].id,U)){let e=U.getDocumentData(w[0]);e&&(X=e.sheetNames,G=e.sheetIDList.indexOf(K),U.setCurrentSheet({parentID:w[0],sheet:K}))}}let i=S.getLastElement(!0),r=E.getLastElement(!0),l=[];o.isRepReference(i)&&l.push(i),o.isRepReference(r)&&l.push(r);try{await(t=l,t&&t.length?new Promise(((e,n)=>{var i=[],r=[],a=p.getController();t.forEach((function(e){if("cgr"!==a.getLoadedStream(e)){r.push({node:e,stream:"cgr"});let t=o.getNodeID(e);_.includes(t)||i.push(t)}})),i.length?(_=_.concat(i),a.lockNodes({ids:i}),a.setForceReferencesLoad({data:i.map((function(e){return{id:e,state:!0}})),callback:()=>{r.length?a.switchNodeVisuStreamOnDemand({data:r,callbacks:{onComplete:e,onFailure:n}}):e()}})):e()})):Promise.resolve())}catch(e){window.console.error("Error Locking Nodes",e)}finally{let e=[],t=p.getHideShowController();t&&(t.isVisible(S)||e.push(S),t.isVisible(E)||e.push(E),e.length&&t.show({paths:e,dispatch:!0})),z||await se(M.getAttribute("bLocalAxis")),W=M.getAttribute("fBalance"),void 0===W&&(W=50);let n,i=ae(W),o=R,r=A;n=z?T:k,h.compare({Old:{color:r,pathElements:[E],opacity:i[0]},New:{color:o,pathElements:[S],opacity:i[1]},Common:{color:n},noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:de(),compareMode:z?"2D":"3D"}),I=!0,M.fireEvent("onComparisonDisplayed",{is2DCompare:z});let l,s,d=[y[y.length-1],w[w.length-1]];"DMUTemporaryBag"===M.getParent().getType()&&(l={icon:c.compareLastButtonTitle,iconClassName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-close",title:c.compareLastButtonTitle,callBack:le},S.externalPath.length>2&&(s=[{type:"checkbox",label:c.localAxisTitle,checkFlag:M.getAttribute("bLocalAxis"),callBack:se}]),z&&X&&X.length>1&&-1!==G&&(s=[{type:"combo",elementList:X,enableSearchFlag:!0,value:X[G],callBack:e=>{if(G=X.indexOf(e),-1!==G){let e=U.getDocumentData(w[0]);if(e&&e.sheetIDList&&e.sheetIDList.length){let t=e.sheetIDList[G];if(U){U.setCurrentSheet({parentID:w[0],sheet:t});let e=M.getAttribute("oSheetIDs");e&&e.length>1&&(e[1].id=t,M.setAttribute("oSheetIDs",e))}}}}}])),D&&D.clean(),D=new a(p.getFrameWindow()),D.build({viewerCanvas:p.getViewer().canvas,value:W,minValue:0,maxValue:100,stepValue:5,onChangeCB:ue,leftButton:{color:o},rightButton:{color:r},lastButton:l,subMenuItems:s}),p.getController().getAttributes({ids:d,attributes:["ds6w:label","ds6wg:revision"],callbacks:{onComplete:function(e){let t=e[d[0]]?e[d[0]]["ds6w:label"]:"",n=e[d[0]]?e[d[0]]["ds6wg:revision"]:"";n&&(t=t+" "+n);let i=e[d[0]]?e[d[1]]["ds6w:label"]:"",o=e[d[0]]?e[d[1]]["ds6wg:revision"]:"";o&&(i=i+" "+o),D&&D.update({leftButton:{title:t||""},rightButton:{title:i||""}})},onFailure:function(){}}})}}}var t}function ge(){let e=p.getRoots(),t=[];for(let n=0;n<e.length;n++){let i=o.getNodeID(e[n]);t.push(p.getController().isFiltered(i).hasFilter?p.getController().isFiltered(i).filterId:i)}w&&w.length&&-1!==t.indexOf(w[0])&&(x&&clearTimeout(x),x=setTimeout(ce))}function pe(e){let t,n=!0;if(e.slide){var i=e.slide.getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e]);if(!t&&e.slide.getPointedFormats&&e.slide.getPointedFormats().length){i=e.slide.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e])}}else t=e.compare;if(t){if(t===M)return!1;let e,i,r,a=t.getParent()?t.getParent().getAttribute("oLinksManager"):null;if(a&&(e=t.getAttribute("oSelections")),e&&2===e.length&&(i=a.getChildWithID(e[1].id)),i&&(r=i.idPath&&i.idPath.length?i.idPath:a.getOccurrenceIdPath(i.path)),r=r&&r.length?r[0]:null,r){let e=p.getRoots();for(let t=0;t<e.length;t++)o.getNodeID(e[t])===r&&(n=!1)}}return n}function me(){"DIFSheet"===O||"DIFLayout"===O?v&&v.fireEvent("on2DDocumentLoadRequired",{documentType:O,rootID:w[0],isATemporaryRoot:!0}):(V.onLoadingFailure=p.subscribe({event:"onLoadingFailure"},(function(){re(),V.onLoadingFailure&&p.unsubscribe(V.onLoadingFailure),V.onLoadingFailure=null})),"ENOStrRefinementSpecification"===O?p.addFilter([{objectId:w[0]}]):p.addRoots({objects:[{path:[w[0]]}]}))}function fe(e){if(C&&C.destroy(),z&&e===M)return;let t=function(e){let t={};if(!e)return t;var n=e.getAttribute("oSelections");if(!n||2!==n.length)return t;let i=e.getParent()?e.getParent().getAttribute("oLinksManager"):null;if(i){let e=i.getChildWithID(n[0].id);e&&(t.firstCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path)),e=i.getChildWithID(n[1].id),e&&(t.secondCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path))}return t}(e);if(e&&"DMUCompare2D"===e.getType()&&!J&&(J=t&&w&&t.secondCompareRootID&&t.secondCompareRootID[0]&&t.secondCompareRootID[0]===w[0]),re(),!p||!e||!e.getParent()||!e.getType||"DMUCompare3D"!==e.getType()&&"DMUCompare2D"!==e.getType())return;if(M=e,z="DMUCompare2D"===M.getType(),M.fireEvent("onComparisonStarted",{is2DCompare:z}),z&&(U||(U=i.getManager({name:"DMU2DSheetManager",context:p.getFrameWindow()})),U.setNavBarVisibleFlag(!1)),!(t&&t.firstCompareRootID&&t.firstCompareRootID.length&&t.secondCompareRootID&&t.secondCompareRootID.length))return C=te("info",c.comparisonFailed),void re();y=t.firstCompareRootID.slice(),w=t.secondCompareRootID.slice();let n=p.getRoots().map((e=>{if(e.isBeingRemoved)return"";let t=o.getNodeID(e);return p.getController().isFiltered(t).hasFilter?p.getController().isFiltered(t).filterId:t}));n&&-1===n.indexOf(w[0])?(b=p.getAutomaticReframePolicy(),H=window.ENOPADNoReframe,window.ENOPADNoReframe=!0,p.setAutomaticReframePolicy(!1),O?me():p.getController().getAttributes({ids:[y[0],w[0]],attributes:["ds6w:type"],callbacks:{onComplete:function(e){w&&w.length&&e[w[0]]&&(P=e[y[0]]["ds6w:type"],O=e[w[0]]["ds6w:type"],me())},onFailure:re}})):ge()}this.getCurrentComparedObjectIDPaths=function(){return M?{feature:M,firstObject:y?y.slice():null,secondObject:w?w.slice():null}:null},this.getCurrentCompareBalance=function(){return W},this.getCurrentLocalAxisValue=function(){return q},this.setActiveState=function(e){if(e!==g){var t,i;if(g=e,g){v=n.giveEventsController({viewer:p.getViewer()}),j={},j.onDMUOverloadPropertiesChanged=v.addEvent("onDMUOverloadPropertiesChanged",(function(e){e&&e.overloads&&e.overloads.length&&ne(e.overloads)})),j.onDMUObjectDeleted=v.addEvent("onDMUObjectDeleted",(function(e){m&&e&&e.dmuObject&&e.dmuObject.getOccurrenceIDPath&&e.dmuObject.getOccurrenceIDPath()?ne([{target:e.dmuObject}]):e&&e.dmuObject&&e.dmuObject===M&&re()})),j.onDMUOccOverloadRemoved=v.addEvent("onDMUOccOverloadRemoved",(function(e){m&&e&&e.length&&ne(e)}));var o=function(e){if(e&&e.getOccurrenceOverloaders&&p){var t;if(e.getOccurrenceOverloaders().length&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath().length)t=e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()[0];else{var i=n.getReviewContext({viewer:p.getViewer()});if(i){var o=i.getReviewCtxInformation();o&&o.contextId&&(t=o.contextId);let e=u.giveDMUApplicativeContextManager({context:p});if(e){(e.getApplicativeControllers()||[]).forEach((e=>{e.getContextRootID&&(t=e.getContextRootID())}))}}}t&&!B.includes(t)&&(ie(),B.push(t)),p.getController().isFilterOpen((e=>{e&&e.filterAvailable&&t&&p.getController().getPrdIdFromFilterId([t]).then((e=>{e&&!B.includes(e)&&(ie(),B=[e])}),(()=>{B.includes(t)||ie()}))}))}};j.onDMUMarkupLoaded=v.addEvent("onDMUMarkupLoaded",(function(e){o(e.dmuObject)})),j.onDMUMarkupCreationSucceeded=v.addEvent("onDMUMarkupCreationSucceeded",(function(e){o(e.dmuObject)})),j.onReviewCtxInformationChanged=v.addEvent("onReviewCtxInformationChanged",(function(e){if(!e)return;let t=u.giveDMUApplicativeContextManager({context:p}),n=e.contextId;if(t){(t.getApplicativeControllers()||[]).forEach((e=>{e.getContextRootID&&(n=e.getContextRootID())}))}n&&n!==B[0]&&(ie(),B=[n],p.getController().isFilterOpen((e=>{e&&e.filterAvailable&&p.getController().getPrdIdFromFilterId([n]).then((e=>{e&&(B=[e])}),(()=>{B.length&&n!==B[0]&&ie()}))})))}));var r=function(e){e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.dmuObject.getActiveFlag()&&e.dmuObject.isVisible()?e.dmuObject.getCurrentSlide()&&(m&&m.deleteOverrides(m.getOverrides()),ie(),ne(oe(e.dmuObject.getCurrentSlide()),!0)):(m&&m.deleteOverrides(m.getOverrides()),ie()))};j.onDMUObjectVisibleFlagChanged=v.addEvent("onDMUObjectVisibleFlagChanged",r),j.onDMUObjectActiveFlagChanged=v.addEvent("onDMUObjectActiveFlagChanged",r),j.onDMUSlideOrFormatRefreshRequired=v.addEvent("onDMUSlideOrFormatOverloadsRefreshRequired",(function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(m.deleteOverrides(m.getOverrides()),ne(oe(e.dmuObject),!0))})),j.onDMUSlideFormatListModified=v.addEvent("onDMUSlideFormatListModified",(function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(m.deleteOverrides(m.getOverrides()),ie(),ne(oe(e.dmuObject),!0))})),j.onDMUSlideStartDisplay=v.addEvent("onDMUSlideStartDisplay",(function(e){Q=!0,"Requirement"!==O&&"Requirement Specification"!==O&&(J=!pe({slide:e.dmuObject}),re()),m&&g&&(m.deleteOverrides(m.getOverrides()),ie())})),j.onDMUSlideCompareDisplayRequired=v.addEvent("onDMUSlideCompareDisplayRequired",(function(e){if(e.dmuObject){let n;var t=e.dmuObject.getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&"DMUCompareRequirement"!==t[e].getType()&&(n=t[e]);if(!n&&e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().length){t=e.dmuObject.getPointedFormats()[0].getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&"DMUCompareRequirement"!==t[e].getType()&&(n=t[e])}n&&fe(n)}})),j.onDMUSlideDisplayed=v.addEvent("onDMUSlideDisplayed",(function(){Q=!1})),j.onDMUObjectInitialized=v.addEvent("onDMUObjectInitialized",(function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"===e.dmuObject.getParent().getType()&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()&&-1!==e.dmuObject.getType().indexOf("Compare")&&(J=!pe({compare:e.dmuObject}),fe(e.dmuObject))})),$&&(Y=$.subscribe("com.ds.mep:onPrefUpdate",(function(e){let t=JSON.parse(e[1].preferences),n=!1;for(let e=0;e<t.repositories.length;e++)if("DMURepository"===t.repositories[e])for(let i=0;i<t.repositories[e].preferences.length;i++){const o=t.repositories[e].preferences;"CompareFirstColor"===o[i].name?(R=o[i].value,n=!0):"CompareSecondColor"===o[i].name?(A=o[i].value,n=!0):"Compare3DCommonColor"===o[i].name?(k=o[i].value,n=!0):"Compare2DCommonColor"===o[i].name&&(T=o[i].value,n=!0)}n&&ue(W,!0)}))),j.onDMUAdd2DCompareRoot=v.addEvent("onDMUAdd2DCompareRoot",(function(e){e&&e.documentType&&e.compare2DSecondRoot&&p&&(O=e.documentType,"Drawing"===O?p.addRoots({objects:[{path:[e.compare2DSecondRoot]}]}):v&&v.fireEvent("on2DDocumentLoadRequired",{documentType:e.documentType,rootID:e.compare2DSecondRoot,isATemporaryRoot:!0}))})),j.on2DDocumentLoadSuccess=v.addEvent("on2DDocumentLoadSuccess",(function(){z&&w&&w[0]&&ge()})),j.onDMUCompareRefreshRequired=v.addEvent("onDMUCompareRefreshRequired",(function(e){Q||e&&e.dmuObject&&(e.dmuObject.getParent()&&(e.dmuObject.getParent().getType&&"DMUTemporaryBag"===e.dmuObject.getParent().getType()||!e.dmuObject.getParent().isImporting())&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()?z||"DMUCompareRequirement"===e.dmuObject.getType()||fe(e.dmuObject):M&&M===e.dmuObject&&"DMUCompareRequirement"!==e.dmuObject.getType()&&(J=!1,re()))})),j.onTransientCompareRemoved=v.addEvent("onTransientCompareRemoved",le),j.onBeginDMUObjectDuplication=v.addEvent("onBeginDMUObjectDuplication",(function(){let e=n.getReviewContext({viewer:p.getViewer()});if(e){let t=e.getTransientReviewBag().getDMUObjects("DMUCompare2D");Z=!!t.length}else Z=!1})),j.onDMUObjectDuplicated=v.addEvent("onDMUObjectDuplicated",(function(){Z=!1})),V={},V.onHide=p.subscribe({event:"onHide"},(function(e){g&&e&&Array.isArray(e.paths)&&!L&&ee(e.paths,!1),L>0&&L--})),V.onShow=p.subscribe({event:"onShow"},(function(e){g&&e&&Array.isArray(e.paths)&&!N&&ee(e.paths,!0),N>0&&N--})),V.onExclusiveShow=p.subscribe({event:"onExclusiveShow"},(function(){var e=F.getDisplayedAndHiddenOccurrences();e&&(ee(e.shown.paths,!0),ee(e.shown.idPaths,!0),ee(e.hidden.paths,!1),ee(e.hidden.idPaths,!1))})),V.onRefreshBegin=p.subscribe({event:"onRefreshBegin"},(function(){z&&"Drawing"===O&&sessionStorage.setItem("DMU2DCompareTempRoot",w[0])})),V.onRootAdded=p.subscribe({event:"onRootAdded"},(function(e){"unset"!==H&&(window.ENOPADNoReframe=H),H="unset",void 0!==b&&b!==p.getAutomaticReframePolicy()&&p.setAutomaticReframePolicy(b),b=void 0,z||!e||!w||e.id!==w[0]&&e.filterId!==w[0]||(V.onLoadingComplete=p.subscribe({event:"onLoadingComplete"},(function(){if(V.onLoadingFailure&&(p.unsubscribe(V.onLoadingFailure),V.onLoadingFailure=null),!w||!w.length)return p.unsubscribe(V.onLoadingComplete),V.onLoadingComplete=null,void re();let t=p.getController().createReferenceIterator(e.id);t&&(t.isRepRef()||t.getChildren().length)&&(p.unsubscribe(V.onLoadingComplete),V.onLoadingComplete=null,ge())})));let t,i,o,r=[],a=p.getRoots(),l=[];t=n.getReviewContext({viewer:p.getViewer()}),t&&(r=t.getValidation()?t.getValidation().getMarkups().map((e=>e&&e.getRepRef()?e.getRepRef().getMarkupContent():void 0)):[t.getCurrentSessionMarkup()]),r.length&&r.forEach((e=>{e&&(o=e.getAttribute("oLinksManager"),i=e.getSlides(),i.forEach((e=>{e.getDMUObjects("DMUCompare3D").forEach((e=>{let t,n,i=e.getAttribute("oSelections");i&&i.length&&(t=o.getChildWithID(i[1].id),t&&t.path&&t.path[0]&&(n=o.getChildWithID(t.path[0]),n&&l.push(n.identifier)))}))})),a.forEach((e=>{l.length&&l.includes(e.modelIdentification)&&e.isVisible()&&e.setVisibility(!1)})))}))})),V.onRootRemoved=p.subscribe({event:"onRootRemoved"},(function(e){var t=n.getReviewContext({viewer:p.getViewer()});let i=p.getController().isFiltered(e.id).hasFilter?p.getController().isFiltered(e.id).filterId:e.id;w&&w[0]===i&&M&&"DMUTemporaryBag"===M.getParent().getType()&&t.getTransientReviewBag()&&(t.getTransientReviewBag().removeDMUObjects(z?"DMUCompare2D":"DMUCompare3D"),re(),p.getHideShowController().clearOverrides(e.id))}))}else{if(void 0!==b&&b!==p.getAutomaticReframePolicy()&&p.setAutomaticReframePolicy(b),"unset"!==H&&(window.ENOPADNoReframe=H),H="unset",b=void 0,V){for(t=Object.keys(V),i=0;i<t.length;i++)p.unsubscribe(V[t[i]]);V=null}if(v&&j){for(t=Object.keys(j),i=0;i<t.length;i++)v.removeEvent(j[t[i]]);j=null}Y&&($.unsubscribe(Y),Y=null),m.deleteOverrides(m.getOverrides()),ie(),re(),v=null,C&&(C.destroy(),C=null)}N=0,L=0}},this.getDisplayedAndHiddenOccurrences=function(e){let t=e?[e]:B;var n,i={shown:{idPaths:[],paths:[]},hidden:{idPaths:[],paths:[]}};if(p&&g){var r=p.getHideShowController().getSGOverrideSet();if(r)for(var a=r.getOverrides(),l=0;l<a.length;l++)if(null!==a[l].getVisibility())if(n=a[l].getVisibility()?i.shown:i.hidden,a[l].isIdPathOverride()){let e=a[l].getIdPathes()||[];e=e.map((e=>e.ids.slice(1,e.ids.length))),n.idPaths=n.idPaths.concat(e.filter((e=>t.includes(e[0]))))}else n.paths=n.paths.concat(a[l].getPathes().filter((e=>t.includes(o.getNodeID(e.externalPath[1])))))}return i},this.isAComparisonDisplayed=()=>I,this.toggleVisibility=function(e){if(e&&e.length&&g&&p&&p.getHideShowController()){var t=p.getHideShowController(),n=[],i=[];if(e.forEach((function(e){t.isVisible(e)?n.push(e):i.push(e)})),n.length)return void t.hide({paths:n,dispatch:!0});i.length&&t.show({paths:i,dispatch:!0})}},this.setRootIds=function(e){e&&e.length&&(B=[...e])},this.clear=function(){this.setActiveState(!1),p&&m&&o.removeSceneGraphOverrideSet(p.getViewer(),m),p&&f&&o.removeSceneGraphOverrideSet(p.getViewer(),f),B.length=0,p=m=f=h=null}}}),p=[];return e.singleton({init:function(){},getDMUSceneDisplayController:function(e){if(e&&e.context){for(var t=!1,n=0;n<p.length;n++)if(p[n].context===e.context){p[n].counter++,t=!0;break}if(!t){var i=new g(e);i.setActiveState(!0),p.push({counter:1,context:e.context,ctrl:i})}return this.giveDMUSceneDisplayController(e)}},giveDMUSceneDisplayController:function(e){if(e&&e.context){for(var t,n=0;n<p.length;n++)if(p[n].context===e.context){t=p[n].ctrl;break}if(t)return Object.freeze({isAComparisonDisplayed:function(){return t?t.isAComparisonDisplayed():null},getCurrentComparedObjectIDPaths:function(){return t?t.getCurrentComparedObjectIDPaths():null},getCurrentCompareBalance:function(){return t?t.getCurrentCompareBalance():[]},getCurrentLocalAxisValue:function(){return!t||t.getCurrentLocalAxisValue()},getDisplayedAndHiddenOccurrences:function(e){return t?t.getDisplayedAndHiddenOccurrences(e):{}},toggleVisibility:function(e){return t?t.toggleVisibility(e):{}},setRootIds:function(e){return t?t.setRootIds(e):{}}})}},unreferenceDMUSceneDisplayController:function(e){if(e&&e.context)for(var t=0;t<p.length;t++)if(p[t].context===e.context)return p[t].counter--,void(p[t].counter<=0&&(p[t].ctrl&&p[t].ctrl.clear(),p.splice(t,1)))}})})),define("DS/DMUBaseUIControllers/DMUUserExperienceManager",["UWA/Core","UWA/Class","UWA/Utils","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/DMUBaseExperience/DMUContextManager","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUBaseExperience/DMUFactory","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUModelServices","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],(function(e,t,n,i,o,r,a,l,s,d,u,c,g,p,m,f,h,v){"use strict";return t.extend({init:function(t){var C,D=[],b=[],M=t.frmWindow,y=this,w=null,S={},E=s.getContextViewer({viewer:M.getViewer()});function x(e){let t=s.getReviewContext({viewer:M.getViewer()});if(!t)return!1;let n=t.getValidation()&&"Activated"===t.getValidation().getRestrictedEditionFlag(),i=h.giveDMUCommentsController({context:M});const o=e=>e&&e.getMarkupOwner()&&e.getMarkupOwner().getParent()&&e.getMarkupOwner().getParent().getType();return e.every((e=>{if(!e||!e.getType)return!0;let r=e.getType();if("DMUMarkup"===r)return t.getRestrictions(e)["Reply"===o(e)?"reply":"markup"].canDelete;if(["DMUSlide","DMUComment","DMUFormat"].includes(r)||r.includes("DMUMarker")){const a=t.getRestrictions(e.getParent())["Reply"===o(e.getParent())?"reply":"markup"].canEdit;if("DMUComment"===r&&!e.isReply())return a&&!e.isReadOnly()&&(!n||i&&!i.hasReplies(e.getAttribute("sUuid")));if("DMUSlide"===r&&!e.getAttribute("sParentSlideID")){let t=f.giveDMUSlidesController({context:M});return a&&!e.isReadOnly()&&(!n||t&&!t.hasReplies(e.getAttribute("sUuid")))}return a}return!0}))}function U(e){var t=s.getReviewContext({viewer:M.getViewer()});if(t){var n=s.getContextViewer({reviewContext:t});if(n){var i,r=o.get();if(!e.target||"textarea"!==e.target.type&&"input"!==e.target.type&&"P"!==e.target.tagName&&!e.target.isContentEditable)if("Delete"===e.key||46===e.keyCode){if(!r.length)return;for(var a=[],l=0;l<r.length;l++){var u=t.getDMUObjectFromPathElement(r[l].pathElement);u&&a.push(u)}if(1===a.length&&a[0].isTextEdited&&a[0].isTextEdited())return;let o=h.giveDMUCommentsController({context:M});if(o){(o.getSelectedComments()||[]).forEach((e=>{e.getAttribute("bMarkedAsDeleted")||a.push(e)}))}if(!x(a))return;if(e.shiftKey||!t.getCurrentSessionMarkup()||t.getCurrentSessionMarkup()&&!t.getCurrentSessionMarkup().getActiveFlag()||t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().getActiveFlag()&&t.getCurrentSessionMarkup().isReadOnly())if(i=d.getCommand("DMUQuickDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],(function(e){var t=new e({ID:"tmpQuickDelete",context:n.getExecutionContext?n.getExecutionContext():n.getCommandContext(),executionContext:n.getExecutionContext?n.getExecutionContext():void 0});t.begin(),t.destroy(),t=null}))}else if(i=d.getCommand("DMUDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],(function(e){var t=new e({ID:"tmpDelete",context:n.getCommandContext()});t.begin(),t.destroy(),t=null}))}}else if(!e.ctrlKey||"c"!==e.key&&67!==e.keyCode)if(!e.ctrlKey||"x"!==e.key&&88!==e.keyCode)!e.ctrlKey||"v"!==e.key&&86!==e.keyCode||(i=d.getCommand("DMUPasteHdr",n.getCommandContext()))&&i.begin();else{if(!r.length)return;(i=d.getCommand("DMUCutHdr",n.getCommandContext()))&&i.begin()}else{if(!r.length)return;(i=d.getCommand("DMUCopyHdr",n.getCommandContext()))&&i.begin()}}}}E&&E.getExecutionContext&&d.dmuSetExecutionContext(E.getExecutionContext()),this.clean=function(){if(M){var e;for(e=D.length-1;e>=0;e--)M.getContextualUIManager().unregister(D[e].type);for(e=b.length-1;e>=0;e--)M.getContextualUIManager().unregister(b[e].type);w&&document.removeEventListener("keyup",U),w=null,D.length=0,b.length=0,M=null}},this.pick=function(e,t){if(M)return e.x===S.x&&e.y===S.y&&t===S.type||(S={x:e.x,y:e.y,type:t||"mesh",path:M.getViewer().pick({xPix:e.x,yPix:e.y},t||"mesh",!0).path}),S.path};var O,P=[],I=[],R=!1,A=!1,k=!1;const T=["CommentPositioned","CommentHighlight"];async function V(e,t,i,o,r){var a,l;if(e&&(t&&"DMUMarkup"===t.getType()?a=t:e.getParent?a=e.getParent():t.getParent&&(a=t.getParent()),a&&a.getType&&"DMUMarkup"===a.getType())){var s,d=e.getAttribute?e.getAttribute("sType"):e.type,c=t;if(c&&("Clipping"===d||"Section"===d)){var p=c.getDMUObjects("DMUSection"),f=c.getDMUObjects("DMUClipping");if(p&&p.length&&"Clipping"===d||f&&f.length&&"Section"===d)return void(p&&p.length?p[0]:f[0]).notifyWrongPaste("Clipping"===d);if(f&&f.length&&((s=f[0]).cleanNode&&s.cleanNode(),!1===r&&"Clipping"===d))return void f[0].displayWarning(e,c)}if(s||(s=u.buildComponent(i||d,t,a)),s){var h,D=e.getAttribute?{}:e;if(C||(C=new g({viewer:M.getViewer(),experience:a})),e.getAttribute&&(D=await m.getObjectDefinition(e)),"Slide"===d&&(D="DMUObjects"in(h=D)?{...h,DMUObjects:h.DMUObjects.filter((e=>!T.includes(e.type)))}:h),s.importData(D,C,a),i&&s.setAttribute("sType",i),"Clipping"===d&&s.manageConstrutionItemModeafterClone&&s.manageConstrutionItemModeafterClone(),("Slide"===d||"Format"===d)&&s.getParent()!==e.getParent()){let t=e.getObjectOverloads(),n=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if("Slide"===d&&e.getPointedFormats&&e.getPointedFormats().length&&s.getPointedFormats&&!s.getPointedFormats().length){let i=e.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)("DMUCompare3D"!==i[e].getType()&&"DMUCompare2D"!==i[e].getType()||!n.length)&&s.addDMUObject(await V(i[e]));t=t.concat(e.getPointedFormats()[0].getObjectOverloads()),n.length||(n=e.getPointedFormats()[0].getDMUObjects("DMUCompare3D")?e.getPointedFormats()[0].getDMUObjects("DMUCompare3D"):e.getPointedFormats()[0].getDMUObjects("DMUCompare2D")),s.setAttribute("sPointedFormats",[])}if(t.length){let e=s.getObjectOverloads();for(l=e.length-1;l>=0;l--)s.removeObjectOverload(e[l]);for(l=0;l<t.length;l++)if(t[l].target){let e=s.getParent().getOrCreateOccurrenceOverloader({idPath:t[l].target.getOccurrenceIDPath()},!0),n={};t[l].state.cColor&&t[l].state.cColor.clone&&(n.cColor=t[l].state.cColor.clone()),null!==t[l].state.fOpacity&&void 0!==t[l].state.fOpacity&&(n.fOpacity=t[l].state.fOpacity),"boolean"==typeof t[l].state.bVisible&&(n.bVisible=t[l].state.bVisible),t[l].state.mTransfoMatrix&&t[l].state.mTransfoMatrix.clone&&(n.mTransfoMatrix=t[l].state.mTransfoMatrix.clone()),s.addObjectOverload({state:n,target:e})}}let i=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if(1===n.length&&1===i.length){let t=e.getParent().getAttribute("oLinksManager"),o=n[0].getAttribute("oSelections"),r="Compare2D"===n[0].getAttribute("sType")?n[0].getAttribute("oSheetIDs"):null;if(o&&o.length){let e=[];o.forEach((n=>{let i=t.getChildWithID(n.id);if(i){let n=i.idPath&&i.idPath.length?i.idPath:t.getOccurrenceIdPath(i.path),o=s.getParent().getOccurence({idPath:n},!0);o&&e.push({id:o.id})}})),2===e.length&&i[0].setAttribute("oSelections",e)}r&&r.length&&i[0].setAttribute("oSheetIDs",r)}}if(s.setAttribute("sID","-1"),s.setAttributes([{name:"sID",value:a.computeNewID()},{name:"sUuid",value:n.getUUID()}]),"Slide"===d||"Format"===d){var b,y=s.getDMUObjects();for(l=0;l<y.length;l++)y[l].setAttribute("sID","-1"),y[l].setAttributes([{name:"sID",value:a.computeNewID()},{name:"sUuid",value:n.getUUID()}]),y[l].afterImport(o);i?b=a.computeNewName({object:s,prefix:("DMUSlide"===s.getType()?v.slideDefaultName:v.formatDefaultName)+s.getAttribute("sName"),noSuffixIfPossible:!0,separator:"parenthesis"}):R||(b=a.computeNewName({object:s,prefix:s.getAttribute("sName")+v.copySuffix,noSuffixIfPossible:!0,separator:"parenthesis"})),b&&s.setAttribute("sName",b)}return s}}}function j(e,t){if(t&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())){var n,i,o,r=s.getReviewContext({viewer:M.getViewer()}),a=Object.keys(t);for(n=0;n<a.length;n++)if("camera"!==a[n]||t[a[n]])if("formatting"!==a[n]||t[a[n]])if("markers3D"!==a[n]||t[a[n]])if("markers2D"!==a[n]||t[a[n]])"format"!==a[n]||t[a[n]]||e.setAttribute("sPointedFormats",null);else for(i=(o=e.get2DMarkers()).length-1;i>=0;i--)e.removeDMUObject(o[i]);else for(i=(o=e.get3DMarkers()).length-1;i>=0;i--)e.removeDMUObject(o[i]);else{for(i=(o=e.getDMUObjects("DMUSection")).length-1;i>=0;i--)e.removeDMUObject(o[i]);for(i=(o=e.getDMUObjects("DMUClipping")).length-1;i>=0;i--)e.removeDMUObject(o[i]);for(i=(o=e.getObjectOverloads()).length-1;i>=0;i--)e.removeObjectOverload(o[i])}else e.updateEnvironmentOverload({target:r.getEnvironment(),state:r.getEnvironment().getEnvironmentInfo()})}}this.duplicateDMUElements=async function(e){if(e&&(e.elements||e.elementDefinitions)){var t=async function(t,n){var i=await V(t,e.parent,e.newType,e.markupRepRef);if(i){n&&n.length&&i.setAttributes(n);let t=i.getType();"DMUSlide"!==t&&"DMUFormat"!==t||e.parent["DMUSlide"===t?"addSlide":"addFormat"](i),e.parent?i.afterImport(e.markupRepRef):(i.refreshNode(),i.setTemporary(!0),"DMUMarker3DSpline"!==t&&"DMUMarker3DCloud"!==t&&"DMUMarker3DFreehand"!==t||i.updateProjectionPlaneDefinition({up:M.getViewer().currentViewpoint.getUpDirection(),right:M.getViewer().currentViewpoint.getSightDirection().cross(M.getViewer().currentViewpoint.getUpDirection())})),j(i,e.duplicationOptions)}return i},n=[];if(e.elements&&e.elements.length)for(var i=0;i<e.elements.length;i++)n.push(e.elements[i].getAttribute("sType"));else if(e.elementDefinitions&&e.elementDefinitions.length)for(var o=0;o<e.elementDefinitions.length;o++)n.push(e.elementDefinitions[o].type);u.initFactoryOf(M.getViewer(),n);var r,a,l=[],s=e.elements&&e.elements.length?e.elements:e.elementDefinitions;if(s&&s.length)for(r=0;r<s.length;r++)(a=await t(s[r],e.attributes&&e.attributes.length&&e.attributes[r]?e.attributes[r]:null))&&l.push(a);e.cb&&(l.length?e.cb({duplicatedElements:l}):e.cb({error:"Element not duplicated"}))}else e&&e.cb&&e.cb({error:"Element not duplicated"})},this.setCCPTarget=function(e){O=null,e&&e.getType&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())&&(O=e)},this.getCCPTarget=function(){return O},this.areOccurenceOverloadsCopied=function(){return 0!==I.length},this.copySelectedDMUElements=function(e){O=null,P.length=0,I.length=0,A=!1,k=!1;var t,n=o.get(),r=s.getReviewContext({viewer:M.getViewer()});if(r){var a=r.getCurrentSessionMarkup();if(a)for(var l=a.getCurrentSlide(),d=function(e,t){if(e){var n,o,r,a;if(e.state){var s=e.target.getOccurrencePathElement();e.state.mTransfoMatrix?(a=e.state.mTransfoMatrix.clone(),r=(new i.Matrix4).getInverse(s.getLastElement(!0).getMatrix()),o=(new i.Matrix4).multiplyMatrices(a,r)):e.state.mPosition&&(a=(u=s)&&u.getParentPath()?(new i.Matrix4).multiplyMatrices(u.getParentPath().getWorldMatrix(),u.getLastElement(!0).getMatrix()):null,r=(new i.Matrix4).getInverse(a),o=(new i.Matrix4).multiplyMatrices(r,s.getWorldMatrix()))}var d=!1;for(let i=0;i<I.length;i++)I[i].originalPath.isEqual(t)&&(I[i].overloads.push({slideOverload:e,parent:l,transfo:n,transfoMatrix:o}),d=!0);d||I.push({originalPath:t.clone(),overloads:[{slideOverload:e,parent:l,transfo:n,transfoMatrix:o}]})}var u},u=0;u<n.length;u++)if((t=r.getDMUObjectFromPathElement(n[u].pathElement))&&"DMUOccurrenceOverloader"!==t.getType()){var g=a;if(t.isReadOnly()||!t.isEditable())continue;"DMUSlide"===t.getType()?(A||(P.length=0),A=!0,k=!1):"DMUFormat"===t.getType()?(k||(P.length=0),A=!1,k=!0):((A||k)&&(P.length=0),A=!1,k=!1,g=l),P.push({object:t,parent:g})}else{var p=a.getOrCreateOccurrenceOverloader(n[u]);p&&d(l.getOverloadForTarget(p),n[u].pathElement),n[u].pathElement.getParentPath()&&c.isInstance(n[u].pathElement.getParentPath().getLastElement(!0))&&(p=a.getOrCreateOccurrenceOverloader({pathElement:n[u].pathElement.getParentPath()}))&&d(l.getOverloadForTarget(p),n[u].pathElement)}}y.refreshCCPCommandsAvailability(),R=e};let F=function(e){let t,n=e.getType(),o=M.getViewer().currentViewpoint.getUpDirection();if("DMUMarker3DArrow"===n){t=o.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vFirstPoint"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vFirstPoint").add(t),i=e.getAttribute("vSecondPoint").add(t);e.setAttribute("vFirstPoint",n),e.setAttribute("vSecondPoint",i)}else if("DMUMarker3DCircle"===n||"DMUMarker3DEllipse"===n){t=o.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vCenter"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vCenter").add(t);e.setAttribute("vCenter",n)}else if("DMUMarker3DRectangle"===n){t=o.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vPosition"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vPosition").add(t);e.setAttribute("vPosition",n)}else if("DMUMarker3DSpline"===n||"DMUMarker3DLine"===n||"DMUMarker3DFreehand"===n||"DMUMarker3DCloud"===n){let n=e.getAttribute("oPoints");n&&n.length&&(t=o.multiplyScalar(p.convertPixelToModel({coords:n[0].getAttribute("vPosition"),sizeInPixels:50,viewer:M.getViewer()})),n.forEach((e=>{let n=e.getAttribute("vPosition").add(t);e.setAttribute("vPosition",n)})))}else if("DMUMarker3DText"===n||"DMUMarker3DStamp"===n||"DMUMarker3DPicture"===n){t=o.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vLeaderBreakPoint3D"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vLeaderBreakPoint3D").add(t);e.setAttribute("vLeaderBreakPoint3D",n)}else if("DMUMarker2DText"===n||"DMUMarker2DPicture"===n){t=new i.Vector2(0,-50);let n=e.getAttribute("vLeaderBreakPoint2D").add(t);e.setAttribute("vLeaderBreakPoint2D",n)}};this.pasteDMUElements=async function(t){var n,a,l,d;if(P&&P.length||I&&(!I||I.length)){var g=s.getReviewContext({viewer:M.getViewer()});if(g){var p=g.getCurrentSessionMarkup();if(p){var m=p.getCurrentSlide(),h=O||m;if(h&&h.isReadOnly())return;var v=h===m,C=[],D=function(e){for(var t=0;t<t.length;t++)if(C[t].isEqual(e))return;C.push(e.clone())},b=function(){if(o.empty(),C.length){var e=[],t=[];C.forEach((function(n){e.push({pathElement:n});var i=n.getLastElement(!0);i&&(!i.getDMUType||i.getDMUType&&"DMUSlide"!==i.getDMUType()&&"DMUFormat"!==i.getDMUType())&&t.push({pathElement:n})})),o.add(e),r.add(t)}M.getViewer().render()};if(P&&P.length){var y=P.slice(),w=A||k;if(w&&t&&!1===t.createNewSlide&&h&&("Slide"===h.getAttribute("sType")||"Format"===h.getAttribute("sType"))){y=[];var S,E,x=[],U=function(e,t){e&&e.length&&(y=y.concat(e.map((function(e){return{object:e,parent:t}}))))};for(n=0;n<P.length;n++)if(P[n].object&&P[n].object.getDMUObjects){if(t.formatting){U(P[n].object.getDMUObjects("DMUSection"),P[n].object),U(P[n].object.getDMUObjects("DMUClipping"),P[n].object),h.getDMUObjects("DMUCompare3D").length||U(P[n].object.getDMUObjects("DMUCompare3D"),P[n].object);let e=P[n].object.getDMUObjects("DMUCompare2D");if(e&&e.length){!h.getDMUObjects("DMUCompare2D").length&&e[0].getAttribute("oSheetIDs")&&h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty[0]&&"string"==typeof h.getEnvironmentOverload().state.sFocusProperty[0]&&e[0].getAttribute("oSheetIDs")[0]&&-1!==h.getEnvironmentOverload().state.sFocusProperty[0].indexOf(e[0].getAttribute("oSheetIDs")[0].id)&&U(e,P[n].object)}for(a=(S=P[n].object.getObjectOverloads()).length-1;a>=0;a--){for(E=!0,l=0;l<x.length;l++)x[l].target===S[a].target&&(x[l].state=S[a].state,E=!1);E&&x.push(S[a])}}t.markers3D&&U(P[n].object.get3DMarkers(),P[n].object),t.markers2D&&U(P[n].object.get2DMarkers(),P[n].object)}if(w=!1,t.camera){let t=P[P.length-1].object.getEnvironmentOverload(),n={};Object.keys(t.state).forEach((i=>{t.state[i]&&t.state[i].clone?n[i]=t.state[i].clone():n[i]=e.clone(t.state[i])})),h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty.length&&(n.sFocusProperty=h.getEnvironmentOverload().state.sFocusProperty.slice()),h.updateEnvironmentOverload({state:n,target:h.getEnvironmentOverload().target})}if(t.formatting){for(n=0;n<x.length;n++)h.addObjectOverload(x[n]);h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:x})}t.format&&h.setAttribute("sPointedFormats",P[P.length-1].object.getAttribute("sPointedFormats"))}var T=[];for(l=0;l<y.length;l++)T.push(y[l].object.getAttribute("sType"));u.initFactoryOf(M.getViewer(),T),h||(h=p);var N,L=[];if(h){if(h.isReadOnly())return;if(w){for(n=y.length-1;n>=0;n--){var B;if("Slide"===y[n].object.getAttribute("sType")&&g.getUIManager().getFormatEditionModeFlag()&&(B="Format"),"Format"!==y[n].object.getAttribute("sType")||g.getUIManager().getFormatEditionModeFlag()||(B="Slide"),N=await V(y[n].object,p,B)){let e;if(L.push(N),"DMUSlide"===h.getType()){let t=p,n=function(){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(e=n.getRepRef(),t=e.getMarkupContent())};if(N.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")!==N.getAttribute("sParentSlideID")||!h.getAttribute("sParentSlideID")?(N.setAttribute("sParentSlideID",void 0),t&&t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType()&&n()):!N.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&n(),t){var W,H=t.getSlides();for(d=0;d<H.length;d++)if(H[d]===h){W=d+1;break}t.addSlide(N,W)}}else if("DMUFormat"===h.getType()){var q;N.setAttribute("sParentSlideID",void 0);var _=p.getFormats();for(d=0;d<_.length;d++)if(_[d]===h){q=d+1;break}p.addFormat(N,q)}else if(g.getUIManager().getFormatEditionModeFlag())N.setAttribute("sParentSlideID",void 0),p.addFormat(N);else{let t=p;if(N.getAttribute("sParentSlideID")&&(N.setAttribute("sParentSlideID",void 0),t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType())){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(e=n.getRepRef(),t=e.getMarkupContent())}t&&t.addSlide(N)}N.afterImport(e),j(N,t)}}if(L&&L.length){var z=f.giveDMUSlidesController({context:M});z&&z.setActiveSlide(L[0])}}else{if("DMUSlide"!==h.getType()&&"DMUFormat"!==h.getType())return;for(n=y.length-1;n>=0;n--)y[n].object&&(N=await V(y[n].object,h,void 0,void 0,Boolean(t)))&&(P.forEach((e=>{e.parent.getAttribute("sUuid")===h.getAttribute("sUuid")&&F(N)})),N.afterImport(),L.push(N))}h.refreshNode(),R&&P.forEach((function(e){"DMUSlide"===e.object.getType()||"DMUFormat"===e.object.getType()?h!==e.object&&"DMUSlide"===e.object.getType()?p.removeSlide(e.object):h!==e.object&&"DMUFormat"===e.object.getType()&&p.removeFormat(e.object):e.parent.removeDMUObject(e.object)}))}if(v)for(n=0;n<L.length;n++)D(c.buildPathElement(L[n].getNode()));R&&(P.length=0,A=!1,k=!1,R=!1),O=null,b()}if(h&&I&&I.length){if(t&&!t.graphicProps&&!t.positions)return;var X=[],G=o.get();for(n=0;n<G.length;n++)G[n].pathElement.getLastElement(!0).getDMUType||X.push(G[n].pathElement.clone());var K=function(e){var n,o,r,a=h.getOverloadForTarget(e.slideOverload.target),l={},s=e.slideOverload.target.getOccurrencePathElement();if(a)for(n=Object.keys(a.state),r=0;r<n.length;r++)o=a.state[n[r]],l[n[r]]=o.clone?o.clone():o;for(n=Object.keys(e.slideOverload.state),r=0;r<n.length;r++)(!t||t&&t.graphicProps&&"cColor"===n[r]||t&&t.graphicProps&&"bVisible"===n[r]||t&&t.graphicProps&&"fOpacity"===n[r]||t&&t.positions&&("mPosition"===n[r]||"mTransfoMatrix"===n[r]))&&("mPosition"===n[r]||"mTransfoMatrix"===n[r]?l.mTransfoMatrix=(new i.Matrix4).multiplyMatrices(s.getLastElement(!0).getMatrix(),e.transfoMatrix):(o=e.slideOverload.state[n[r]],l[n[r]]=o.clone?o.clone():o));h.addObjectOverload({target:e.slideOverload.target,state:l}),h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:[{target:e.slideOverload.target,state:l}]})},J=!1;if(!X.length&&h&&h.addObjectOverload)for(n=I.length-1;n>=0;n--)for(a=I[n].overloads.length-1;a>=0;a--)h!==I[n].overloads[a].parent&&(K(I[n].overloads[a]),D(I[n].overloads[a].slideOverload.target.getOccurrencePathElement()),J=!0);else if(h&&h.addObjectOverload&&X.length){var Z,Q=0,Y=[],$=function(e,n){for(var o=Object.keys(e.slideOverload.state),r=0;r<o.length;r++)if(!t||t&&t.graphicProps&&"cColor"===o[r]||t&&t.graphicProps&&"bVisible"===o[r]||t&&t.graphicProps&&"fOpacity"===o[r]||t&&t.positions&&("mPosition"===o[r]||"mTransfoMatrix"===o[r]))if(J=!0,"mPosition"===o[r]||"mTransfoMatrix"===o[r]){for(var a=n.clone();a&&!c.isInstance(a.getLastElement(!0));)a=a.getParentPath();if(!a)for(a=n.clone();a&&!c.isReference(a.getLastElement(!0))&&!c.isRepReference(a.getLastElement(!0));)a=a.getParentPath();if(a&&(Z=p.getOrCreateOccurrenceOverloader({pathElement:a},!0))){var l=(new i.Matrix4).multiplyMatrices(Z.getOccurrencePathElement().getLastElement(!0).getMatrix(),e.transfoMatrix);Z.setAttribute("mTransfoMatrix",l),Y.push({target:Z,state:{mTransfoMatrix:l}}),D(n)}}else if(Z=p.getOrCreateOccurrenceOverloader({pathElement:n},!0)){Z.setAttribute(o[r],e.slideOverload.state[o[r]]);var s={};s[o[r]]=e.slideOverload.state[o[r]],Y.push({target:Z,state:s}),D(n)}};for(a=0;a<X.length;a++){for(l=0;l<I[Q].overloads.length;l++)$(I[Q].overloads[l],X[a]);++Q>=I.length&&(Q=0)}Y.length&&s.giveEventsController({viewer:M.getViewer()}).fireEvent("onDMUOverloadPropertiesChanged",{overloads:Y})}if(J){if(R)for(n=I.length-1;n>=0;n--)for(a=I[n].overloads.length-1;a>=0;a--)I[n].overloads[a].parent.removeObjectOverload(I[n].overloads[a].slideOverload);v&&h.refreshNode()}R&&(I.length=0,R=!1),O=null,b()}s.giveEventsController({viewer:M.getViewer()}).fireEvent("onSaveRequested",{})}}}},this.refreshCCPCommandsAvailability=function(){var e=s.getReviewContext({viewer:M.getViewer()}),t=s.getContextViewer({viewer:M.getViewer()});if(t&&e){var n=e.getCurrentSessionMarkup(),i=n&&n.isVisible()&&!n.isReadOnly(),r=i?e.getUIManager().getSelectedObjects():[],a=function(e,a){var l=!1;if(i&&!r.length)for(var s=o.get(),u=0;u<s.length;u++){var g=n.getOrCreateOccurrenceOverloader(s[u]);if(g&&g.isOverloadedInCurrentSlide()){l=!0;break}if(s[u].pathElement.getParentPath()&&c.isInstance(s[u].pathElement.getParentPath().getLastElement(!0))&&(g=n.getOrCreateOccurrenceOverloader({pathElement:s[u].pathElement.getParentPath()}))&&g.isOverloadedInCurrentSlide()){l=!0;break}}var p=d.getCommand(e+"DMUCopyHdr",t.getCommandContext());p&&(r.length||l?p.enable():p&&p.disable(),!(p=d.getCommand(e+"DMUCutHdr",t.getCommandContext()))||!r.length&&!l||a&&!a.canEdit?p&&p.disable():p.enable(),p=d.getCommand(e+"DMUPasteHdr",t.getCommandContext()),i&&p&&(P.length||I.length)&&(!a||a.canEdit)?p.enable():p&&p.disable(),(p=d.getCommand(e+"DMUPasteSpecialHdr",t.getCommandContext()))&&(!i||a&&!a.canEdit||(1!==P.length||"DMUSlide"!==P[0].object.getType()&&"DMUFormat"!==P[0].object.getType())&&!I.length?p.disable():p.enable()))};const l=n&&n.getMarkupOwner(),s=l&&l.getParent()&&"Reply"===l.getParent().getType(),u=e&&e.getRestrictions(s?l.getParentRepRef():l).markup;a("",u),a("Format_",u)}},this.refreshCommandsAvailability=()=>{y.refreshCCPCommandsAvailability();let e=f.giveDMUSlidesController({context:M});e&&e.updateHeaderCommandsAvailability();let t=h.giveDMUCommentsController({context:M});t&&t.updateHeaderCommandsAvailability()},this.refreshCtxCommandsAvailability=function(){var e=s.getReviewContext({viewer:M.getViewer()}),t=s.getContextViewer({viewer:M.getViewer()});if(t&&e){var n=e.getCurrentSessionMarkup();let o=e.getUIManager().getSelectedObjects()||[];var i=h.giveDMUCommentsController({context:M});if(i){(i.getSelectedComments()||[]).forEach((e=>{e.getAttribute("bMarkedAsDeleted")||o.push(e)}))}const r=x(o);let a=d.getCommand("DMUDeleteHdr",t.getCommandContext());a&&(r?a.enable():a.disable()),a=d.getCommand("Format_DMUDeleteHdr",t.getCommandContext()),a&&(r?a.enable():a.disable());const l=e&&e.getRestrictions(n);let s=o.map((e=>e.getType()));s.includes("DMUMarkup")&&(a=d.getCommand("DMURenameMarkupHdr",t.getCommandContext()),a&&(!l||l.markup.canEdit?a.enable():a.disable())),s.includes("DMUSlide")&&(a=d.getCommand("DMUFormatChooserHdr",t.getCommandContext()),a&&(!l||l.markup.canEdit?a.enable():a.disable()))}},this.registerContextualMenu=function(e){if(M&&!function(e){for(var t=0;t<b.length;t++)if(b[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:M.getViewer()});if(!t)return;w||(w=!0,document.addEventListener("keyup",U)),M.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualMenuReady:function(t,n){y.refreshCtxCommandsAvailability(e.type);var i,r=M.getExecutionContext||M.getContextualUIManager()._executionContext,l=r?[]:{cmdList:[]};if(t&&t.event&&t.event.getCurrentPosition?((i=t.event.getCurrentPosition(M.getViewer().canvas)).x*=window.devicePixelRatio,i.y*=window.devicePixelRatio):i=r?{x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio}:{x:n.XmousePositionWithDevPxRatio,y:n.YmousePositionWithDevPxRatio},0===y.pick(i,"mesh").length&&0===a.get().length)return l;var d=s.getReviewContext({viewer:M.getViewer()});if(d){var u=d.getUIManager().getSelectedObjects(),c=o.get();if(c.length&&u.length===c.length){for(var g=0;g<u.length;g++)if(-1!==u[g].getType().indexOf(e.type))return u[g].getSharedContextualMenuCommandList?r?u[g].getSharedContextualMenuCommandList(u,s.getCurrentReviewContext()):{cmdList:u[g].getSharedContextualMenuCommandList(u,s.getCurrentReviewContext())}:l}else if(c.length&&"DMUComment"===e.type){var p=h.giveDMUCommentsController({context:M});if(p){var m=p.getSelectedComments();if(m&&m.length===c.length)for(var f=0;f<m.length;f++)if("DMUComment"===m[f].getType())return r?m[f].getSharedContextualMenuCommandList(m):{cmdList:m[f].getSharedContextualMenuCommandList(m)}}}else if(c.length)for(let t=0;t<c.length;t++){if("Checks"===e.type&&c[t].pathElement.getLastElement().getDMUType&&"Checks"===c[t].pathElement.getLastElement().getDMUType()){let e=[c[t].pathElement.getLastElement().getOwner()];return r?e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):[]:{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):void 0}}if(c.length&&"Highlights"===e.type&&c[t].pathElement.getLastElement().getDMUType&&"Highlights"===c[t].pathElement.getLastElement().getDMUType()){let e=[c[t].pathElement.getLastElement().getOwner()];return r?e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):[]:{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):void 0}}}}return l},onCtxMenuPostXmlLoadingCB:function(){var t=s.getReviewContext({viewer:M.getViewer()});if(t){var n=t.getUIManager().getSelectedObjects(),i=o.get();if(i.length&&n.length===i.length)for(var r=0;r<n.length;r++)if((-1!==n[r].getType().indexOf(e.type)||n[r].getType().includes("DMUComment")&&"DMUMarker"===e.type)&&n[r].setCheckCmdHdrState&&n[r].cmdHdrState_list)return n[r].setCheckCmdHdrState(n[r].cmdHdrState_list),Promise.resolve()}return Promise.resolve()}})}var n,i;n=e.type,(i=b.findIndex((function(e){return e.type===n})))>=0?b[i].count++:b.push({type:n,count:1})},this.unregisterContextualMenu=function(e){var t=b.findIndex((function(t){return t.type===e.type}));t>=0&&(b[t].count--,0===b[t].count&&(b.splice(t,1),M.getContextualUIManager().unregister(e.type)))},this.registerContextualBar=function(e){if(M&&!function(e){for(var t=0;t<D.length;t++)if(D[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:M.getViewer()});if(!t)return;M.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:function(){var t=s.getReviewContext({viewer:M.getViewer()}),n=M.getExecutionContext||M.getContextualUIManager()._executionContext,i=n?void 0:{cmdList:[]};if(t){var r=t.getUIManager().getSelectedObjects(),a=o.get();if(a.length&&r.length===a.length){for(var d=0;d<r.length;d++)if(-1!==r[d].getType().indexOf(e.type)||r[d].getType().includes("DMUComment")&&"DMUMarker"===e.type){if(!r[d].getSharedContextualCommandList)return i;if(n){const e=r[d].getSharedContextualCommandList(r);let t=M.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);return e&&t&&e.some((e=>{if(e.selectedHdr)return t.getRadioItemState({id:e.selectedHdr,radioId:e.identifier})||t.setRadioItemState({id:e.selectedHdr,radioId:e.identifier,args:{onOpenCtxBar:!0},state:!0}),!0})),{WAfrCtxBarRow1:{model:e}}}return{cmdList:r[d].getSharedContextualCommandList(r)}}}else if("DMUMarker"===e.type&&!t.isReadOnly()&&!l.getTouchMode()){var u=window.getSelection();if(u&&""!==u.toString())for(var c=0,g=u.getRangeAt(0).commonAncestorContainer;g&&c<15;){if(g===M.getViewer().currentViewpoint.divCameraCSSElement)return n?{WAfrCtxBarRow1:{model:[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}]}}:{cmdList:[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}]};g=g.parentNode,c++}}}return i}})}var n,i;n=e.type,(i=D.findIndex((function(e){return e.type===n})))>=0?D[i].count++:D.push({type:n,count:1})},this.unregisterContextualBar=function(e){var t=D.findIndex((function(t){return t.type===e.type}));t>=0&&(D[t].count--,0===D[t].count&&(D.splice(t,1),M.getContextualUIManager().unregister(e.type)))}}})})),define("DS/DMUBaseUIControllers/DMUReviewController",["UWA/Core","UWA/Class","DS/Visualization/Node3D","DS/DMUControls/panels/DMUReviewPanel","DS/DMUControls/panels/DMUHighlightsPanel","DS/DMUControls/panels/DMUChecksPanel","DS/DMUControls/panels/DMUMembersPanel","DS/DMUControls/DMUAddMembersPanel","DS/UIKIT/Spinner","DS/DMUBaseExperience/DMUContextManager","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUBaseExperience/EXPManagerSet","DS/CoreEvents/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/PADUtils/PADUtilsServices","DS/WebappsUtils/WebappsUtils","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseExperience/EXPToolsContext","DS/DMUBaseUIComponents/DMUSearchMembersServices","DS/DMUBaseUIControllers/utils/OpenWithMenuBuilder","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],(function(e,t,n,i,o,r,a,l,s,d,u,c,g,p,m,f,h,v,C,D,b,M,y,w,S,E,x,U,O,P){"use strict";var I=t.extend({init:function(t){this._parent(t);var I,R,A,k,T=t||{},V={TRANSIENT:{WIDTH:700,HEIGHT:800},APP_ID_MY_PROFILE:"X3DPRFL_AP"},j=T.context,F=new g,N=d.giveEventsController({viewer:j.getViewer()}),L=b.giveDMUSlidesController({context:j}),B=!1,W=!0,H=!1,q=!1,_=!1,z="issue";localStorage.setItem("issueCreationType","issue");var X,G,K,J,Z,Q,Y,$,ee,te,ne,ie,oe,re,ae,le,se,de,ue,ce={},ge=new Map;ge.set("PRIVATE","IN_WORK"),ge.set("IN_WORK","FROZEN"),ge.set("FROZEN","RELEASED"),ge.set("RELEASED","OBSOLETE"),ge.set("OBSOLETE",void 0);var pe=new Map;pe.set("PRIVATE",void 0),pe.set("IN_WORK","PRIVATE"),pe.set("FROZEN","IN_WORK"),pe.set("RELEASED",void 0),pe.set("OBSOLETE",void 0);var me=new Map;me.set("PRIVATE","#9b2c98"),me.set("IN_WORK","#007da3"),me.set("FROZEN","#018308"),me.set("RELEASED","#757575"),me.set("OBSOLETE","#80808080");var fe,he,ve,Ce=new Map;Ce.set("PRIVATE",P.maturityValue.PRIVATE),Ce.set("IN_WORK",P.maturityValue.IN_WORK),Ce.set("FROZEN",P.maturityValue.FROZEN),Ce.set("RELEASED",P.maturityValue.RELEASED),Ce.set("OBSOLETE",P.maturityValue.OBSOLETE);var De,be,Me,ye,we,Se=-1,Ee=-1,xe={},Ue={},Oe={},Pe={},Ie="noType",Re=[],Ae=[],ke=[],Te=[],Ve=0,je=!1,Fe=!1,Ne=!1,Le=!1,Be=new e.createElement("div",{class:"thumbnailsDiv"}),We=new Map,He=[];let qe=[],_e="noWarning";He.statusOK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-check",fonticonColor:"rgb(71,119,56)"},He.statusKO={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-wrong",fonticonColor:"rgb(234,79,55)"},He.statusUNK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question",fonticonColor:"#007DA3"},He.statusTBA={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention",fonticonColor:"#007DA3"},He.requirement={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-requirement",fonticonColor:"black"},He.highlight_urgent={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-alert",fonticonColor:"rgb(153, 7, 7)"},He.highlight_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-high",fonticonColor:"rgb(234,79,55)"},He.highlight_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-medium",fonticonColor:"rgb(232,123,0)"},He.highlight_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-low",fonticonColor:"rgb(71,119,56)"},He.ca_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(234,79,55)"},He.ca_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(232,123,0)"},He.ca_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(71,119,56)"};var ze=[He.statusUNK,He.statusOK,He.statusKO,He.requirement],Xe=[He.statusTBA,He.highlight_low,He.highlight_medium,He.highlight_high,He.statusOK,He.highlight_urgent],Ge=[];function Ke(e){var t=!0;if(e&&"3DPart"===e.usage)return t;var n=d.getReviewContext({viewer:j.getViewer()}),i=d.getContextViewer({viewer:j.getViewer()}).getController(),o=n&&n.getValidation()&&n.getValidation().getContext()&&n.getValidation().getContext().getMainContextID()?n.getValidation().getContext().getMainContextID():null,r=[],a=i.getNode({id:o});if(a){r.push(a);var l=new m(r);if(l.externalPath.length){var s=l.externalPath[0].getChildren();for(let e=0;e<s.length;e++)if(!p.isRepInstance(s[e])){t=!1;break}}}else t=!1;return t}function Je(e){if(N){let i=!1;for(var t=0;t<qe.length;t++)if(qe[t].id===e.id){i=!0;break}if(i){var n=d.getReviewContext({viewer:j.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some((t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return N.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0}))}}}function Ze(e){for(var t=0;t<qe.length;t++)if(qe[t].id===e.id&&qe[t].content){let i=qe[t].content.getMarkupContent();if(i){var n=p.buildPathElement(i.getNode());f.empty(),h.empty(),f.add({pathElement:n}),v.add({pathElement:n});let t=e.position.clone();j.getExecutionContext?j.getContextualUIManager()._showContextMenu(t):j.getContextualUIManager()._showContextualMenu(t)}}}function Qe(e){let t=JSON.parse(e.dataTransfer.getData("Text"));if(t.data&&t.data.items&&t.data.items.length>0){let e=[];for(let n=0;n<t.data.items.length;n++)-1!==["Requirement","Requirement Specification","Chapter"].indexOf(t.data.items[n].objectType)&&e.push(t.data.items[n]);N.fireEvent("onRequirementDropped",e)}}function Ye(){var e=u.getCommand("DMUAddHighlightHdr",T.commandContext);e&&e.begin()}function $e(e){return new Promise(((t,n)=>{d.getContextViewer({viewer:j.getViewer()}).getController().getAttributes({ids:e,attributes:["ds6w:identifier"],callbacks:{onComplete:function(n){if(n){var i=[];e.forEach((function(e){n[e]&&i.push(n[e]["ds6w:identifier"])})),t(i)}},onFailure:function(e){n(e)}}})}))}function et(e,t){return new Promise(((n,i)=>{var o=[];for(let n=0;n<e.length;n++){var r=E.getUserName(e[n].user);o.push(r.then((function(i){return{siteName:i,name:e[n].user,userType:e[n].type,contribution:!0===t?e[n].contribution:null,contributionNls:!0===t?P.contributionValue[e[n].contribution]:null}})).catch((function(e){i(e)})))}n(Promise.all(o))}))}function tt(){var e=d.getReviewContext({viewer:j.getViewer()}).getValidation().getMembers(),t=null,n=null,i=null,o=null;e&&(t=e.getCoordinators(),n=e.getAssignees(),i=e.getContributors(),o=e.getInformedUsers()),new l({immersiveFrame:j.getImmersiveFrame()}).buildAdditionPanel({getMembers:function(e){return U.getMembers({text:e})},searchMember:function(e){return U.searchMember(e)},saveMembers:function(e){N.fireEvent("onUpdateMembersRequested",e)},additionalMembersInfo:$e,valCoordinators:t,valAssignees:n,valContributors:i,valInformedUsers:o})}function nt(e){k=e.iEvt?e.iEvt:e;var t=u.getCommand("DMUAddCheckHdr",T.commandContext);t&&t.begin()}Ge.Low=He.ca_low,Ge.Medium=He.ca_medium,Ge.High=He.ca_high;var it=function(e){var t,n=e.object.getElementsByClassName("highlightsPanel-editableHighlightThumbDiv")[0];if(!n.getElementsByClassName("DMUCommentMainDiv").length&&!n.getElementsByClassName("highlightsPanel-thumbnail").length){var i=e.object.getElementsByClassName("highlightsPanel-slide")[0],o=e.object.getElementsByClassName("highlightsPanel-slideIcon")[0],r=Ae[e.id]._repRefMarkupId;if(r){var a=d.getReviewContext({viewer:j.getViewer()}).getValidation().getRepRef(r);if(fe=Ae[e.id]._slideID,Me=n,ye=i,we=o,a){var l=a.getMarkupContent(),s=l?l.getSlides():[];for(let e=0;e<s.length;e++)if(s[e].getAttribute("sUuid")===fe)t=s[e];else if(s[e].getDMUObjects().length){var u=s[e].getDMUObjects();for(let e=0;e<u.length;e++){var c=u[e].getDMUComments?u[e].getDMUComments():[];if(c.length)for(let e=0;e<c.length;e++)if(c[e].getAttribute("sUuid")===fe){t=c[e];break}}}}t&&function(e,t){var n=M.giveDMUCommentsController({context:j});if("DMUComment"===e.getType()){var i=n.getCommentRepresentation(fe,"normal").getDiv(),o=n.getCommentRepresentation(fe,"light").getDiv();o.addClassName("lightCommentRepresentation"),i.addClassName("normalCommentRepresentation"),i.inject(Me),o.inject(Me),o.hide()}else{var r=e.getAttribute("sName"),a=L.getSlideRepresentation(e.getAttribute("sUuid"),"normal");a.getDiv().dsModel=a,a.getDiv().addClassName("highlightsPanel-thumbnail"),a.getDiv().inject(Me),We.has(t)||We.set(t,a),ye.setText(r),ye.title=r,we.addClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-presentation-slide"),a.getDiv().setStyles({padding:"0px"}),C.getTouchMode()&&a.getDiv().setStyles({width:"178px"})}}(t,e.id)}}},ot=function(e){N.fireEvent("onIssueOrCaSelected",e)},rt=function(e){N.fireEvent("onRequirementSelected",e)};function at(e){var t=e.path;ke[ke.length]={name:e.name,id:Ve,path:t},Te[Ve]={name:e.name,index:ke.length-1,path:t},je=!1,Ve+=7}var lt=function(){N.fireEvent("onUpdateValidatedRequested",!1),X.deactiveValidatedButton(),H=!1,be&&N.removeEvent(be)},st=function(e){if("Escape"===e.key||27===e.keyCode){H&&lt(),q&&(q=!1);var t=u.getCommand("DMUAddHighlightHdr");t&&t.isRunning()&&t.end(),Y&&Y.deactiveButtons()}if("Delete"===e.key||46===e.keyCode){var n=f.get();if(n.length&&(!e.target||"text"!==e.target.type&&"textarea"!==e.target.type)){var i=n[0].pathElement.getLastElement();if(i.getOwner&&("DMUValidationCheck"===i.getOwner().getType()||"DMUValidationExposedPresentation"===i.getOwner().getType()))if(e.shiftKey){let e=u.getCommand("DMUQuickDeleteHdr",T.commandContext);if(e)e.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],(function(e){var t=new e({ID:"tmpQuickDelete",context:T.commandContext});t.begin(),t.destroy(),t=null}))}}else{u.getCommand("DMUDeleteHdr",T.commandContext).begin()}}}},dt=function(){var e=u.getCommand("DMUAddValidatedObjectHdr",T.commandContext);e&&!e.isRunning()&&(H=!0,e.options.arguments[0].Value="add",e.begin(),window.addEventListener("keydown",st,!0),be=N.addEvent("onDMUValidatedCreated",(function(e){if(H=!1,N.fireEvent("onUpdateValidatedRequested",!1),e){Ke()&&X.setAddValidatedButtonVisibilityFlag(!0);for(let n=0;n<e.validatedNames.length;n++){var t=X.addValidatedObject(e.validatedNames[n],e.validatedIcons[n]);at({name:e.validatedNames[n],id:e.validatedId,path:e.validatedPaths[n]}),t.getMainDiv().setAdditionalDivVisibleFlag(!0),t.getMainDiv().setSelectedFlag(!0)}}else X.deactiveValidatedButton(),H=!1;N.removeEvent(be)})))};function ut(){return X?X.getColumnMinimumWidth():273}function ct(){return X?X.getColumnWidthStep():240}function gt(e){Ve=0,ke=[],Te=[];var t=ae.getPathElements(),n=0;for(let e=0;e<t.length;e++)"Change Action"!==t[e].referenceType&&(ke[n]={name:t[e].instanceName?t[e].instanceName:t[e].referenceName,id:Ve,path:t[e].pathElement},Te[Ve]={name:t[e].instanceName?t[e].instanceName:t[e].referenceName,index:e,path:t[e].pathElement},Ve+=7,n++);e&&e()}function pt(e){const t=d.getReviewContext({viewer:j.getViewer()}),n=t&&t.getValidation();if(!n||e&&"DMUTemporaryBag"===e.getType())return null;var i={};const o=E.getUserLogin(),r=n.getOwner(),a=n.getStatus(),l=n.getCurrentState();let s="Activated"===n.getRestrictedEditionFlag()?"Activated":"Deactivated";const u=n.getMembers(),c=o===r,g=u&&Object.keys(u.getAttribute("sJsonMembers")).length,p=!!g&&u.getCoordinators().some((e=>e.user===o)),m=!!g&&u.getAssignees().some((e=>e.user===o)),f=!!g&&u.getContributors().some((e=>e.user===o)),h=f?u.getContributors().find((e=>e.user===o)):m?u.getAssignees().find((e=>e.user===o)):void 0,v=h&&"Completed"===h.contribution,C=e=>{let t,n=S.getSetting("pad_security_ctx");const i=/::([^.]+)/;switch(n=n.match(i)?n.match(i)[1]:"",e){case"PRIVATE":t=["VPLMAdmin"];break;case"IN_WORK":t=["VPLMProjectLeader","VPLMAdmin"]}return o===r||t.includes(n)},D={Deactivated:!g||p&&C("IN_WORK")?"edit":"readOnly",PRIVATE:"readOnly",IN_WORK:"inProgress"!==a||!C("IN_WORK")||g&&!p?"readOnly":"edit",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let b=D[s]||D[l]||"readOnly";const M={Deactivated:!g||c?"edit":"readOnly",PRIVATE:"inProgress"===a&&C("PRIVATE")&&!g||g&&c?"edit":"readOnly",IN_WORK:"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let y=M[s]||M[l]||"readOnly";const w={Deactivated:!g||p||c?"edit":"readOnly",PRIVATE:"readOnly",IN_WORK:C("IN_WORK")&&(!g||p||c)?"edit":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let x=w[s]||w[l]||"readOnly";const U={Deactivated:!g||p||c?"edit":"readOnly",PRIVATE:"inProgress"===a&&g&&p||"inProgress"===a&&c?"edit":"readOnly",IN_WORK:"inProgress"===a&&g&&p||"inProgress"===a&&c?"edit":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let O=U[s]||U[l]||"readOnly";const P={Deactivated:!g||c?"edit":"readOnly",PRIVATE:"inProgress"===a&&c?"edit":"readOnly",IN_WORK:"inProgress"===a&&c?"edit":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let I=P[s]||P[l]||"readOnly";const R={Deactivated:!g||p||c?"edit":"readOnly",PRIVATE:"inProgress"===a&&g&&(f||m)||!g&&"inProgress"===a?"edit":"readOnly",IN_WORK:"inProgress"===a&&g&&(f||m)||!g&&"inProgress"===a?"edit":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let A=R[s]||R[l]||"readOnly";i.review={canEditValObj:"edit"===y,canEditState:"edit"===x,canEditMembers:"edit"===O,canAddContext:"edit"===I,canEditMaturity:!g||c||p,canChangeOwner:c,canSetContribCompleted:"edit"===A,canSetContribFromNSToOnGoing:"edit"===A,canSetContribFromCompletedToOnGoing:"edit"===O},i.check={canCreate:"edit"===y,canEditDef:"edit"===y,canEditState:"edit"===b,canDelete:"edit"===y},i.highlight={canCreate:"edit"===b,canEditDef:"edit"===b,canEditPriority:"edit"===b,canDelete:"edit"===b};const k={Deactivated:!g||m&&!v?"create":"readOnly",PRIVATE:"readOnly",IN_WORK:"inProgress"!==a||g&&!m||v?"readOnly":"create",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let T=k[s]||k[l]||"readOnly";const V={Deactivated:!g||(f||m)&&!v?"create":"readOnly",PRIVATE:"readOnly",IN_WORK:"inProgress"!==a||g&&(!f&&!m||v)?"readOnly":"create",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let F=V[s]||V[l]||"readOnly";if(i.markup={canCreate:"create"===T},i.reply={canCreate:"create"===F},e){"DMUMarkup"===e.getType()&&(e=e.getMarkupOwner()),"ReviewMarkup"===e.getType()&&(e=e.getParent());const t=e.getOwner(),n={Deactivated:!g||m?"edit":"readOnly",PRIVATE:"readOnly",IN_WORK:"inProgress"!==a||t!==o||g&&(!m||v)?"readOnly":"edit",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let r=n[s]||n[l]||"readOnly";const d={Deactivated:!g||(f||m)&&!v?"edit":"readOnly",PRIVATE:"readOnly",IN_WORK:"inProgress"!==a||t!==o||g&&(!f&&!m||v)?"readOnly":"edit",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let u=d[s]||d[l]||"readOnly";if("Markup"===e.getType()){i.markup.canEdit="edit"===r;var N=e.getReplies();i.markup.canDelete="edit"===r&&0===N.length}else"Reply"===e.getType()&&(i.reply.canEdit="edit"===u,i.reply.canDelete="edit"===u)}return i}function mt(e,t){let n=[];if(e&&"RootBag"!==e.getName()){let i=e.getParents();if(i&&i.length>0)for(let o=0;o<i.length;o++){let r;r=t?[i[o]].concat(t):[i[o],e];let a=mt(i[o],r);if(a)for(let e=0;e<a.length;e++)n.push(a[e])}}else n.push(t);return n}function ft(){Re=[];let e=oe.getContext()?oe.getContext().getMainContextType():null,t=x.getParentType(e)?x.getParentType(e):e,i=d.getContextViewer({viewer:j.getViewer()});for(let e=0;e<ke.length;e++){let o=[],r=ke[e].id,a=Te[r].path;if("Requirement Specification"===t||"Requirement"===t||"Document"===t||"Specification Report"===t||"DesignSight"===t){let t=oe.getNode().getChildren(),n=ke[e].path[0];t.forEach((e=>{"Validated"===e.name&&e.getDocInfo().validatedPaths[0]===n&&o.push(e)}));let i=new m(o);Re[r]=i}else if(""===Te[r].instanceName&&(Re[r]=void 0),Te[r].path.externalPath)Re[r]=Te[r].path;else if(a.length>1){if(i){let e=i.getRootBagPath();if(e){let t=e.getLastElement();t&&o.push(t)}}for(let e=0;e<a.length;e++){let t=I.getNode({id:a[e]});t&&o.push(t)}if(o.length){let e=new m(o);Re[r]=e}}else if(1===a.length){let e=I.getNode({id:a[0]});if(e){let t=mt(e);if(t&&t.length>0){let e=[];for(let n=0;n<t.length;n++)e.push(new m(t[n]));Re[r]={allPaths:e}}}else if("DELLmiWorkPlanSystemReference"===t||"DELLmiPPRHeaderProcessReferenceAbstract"===t){e=new n,e.setName(Te[r].name),e.setModelIdentification(Te[r].path[0]),e.setUserData({type:t});let i=p.buildPathElement(e);Re[r]=i}else if("FailureModesEffectsAnalysis"===t){if(!e){let t=Te[r].path[0];e=i.getRoots().find((e=>e.modelIdentification===t))}let t=p.buildPathElement(e);Re[r]=t}}}je=!0}function ht(){if(te){let e=te.getSectionHeader(),t=Et();e.setSubMenuCommands(t)}if(Y){let e=Y.getSectionHeader(),t=St();e.setSubMenuCommands(t)}}function vt(e){if("Check"===e.type){var t=oe.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){let i=p.buildPathElement(t[n].getNode());"add"===e.updateType?f.add({pathElement:i}):(Fe=!0,f.remove({pathElement:i})),ht()}}else if("Highlight"===e.type){var n=oe.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){let i=p.buildPathElement(n[t].getNode());"add"===e.updateType?f.add({pathElement:i}):(Fe=!0,f.remove({pathElement:i})),N.fireEvent("onHighlightSelectionCompleted"),ht()}}}function Ct(e){var t=f.get(),n=t[t.length-1].pathElement;if(n&&n.getLastElement&&n.getLastElement().getOwner&&n.getLastElement().getOwner().getPlmID){var i=t[t.length-1].pathElement.getLastElement().getOwner().getPlmID();for(let t=0;t<e.expanders.length;t++)e.expanders[t].id===i&&(Ee=t)}else Ee=-1}function Dt(e){var t,n;e.expanders&&(t=e.expanders),n=e.index;var i=f.get();if(e.event&&e.event&&(e.event.shiftKey||e.event.options&&e.event.options.shiftKey)&&Ee>-1){var o=n>Ee?Ee:n,r=n>Ee?n:Ee;if(t[o].type===t[r].type)for(let e=0;e<t.length;e++)e>=o&&e<=r?t[e].expander.getMainDiv().setSelectedFlag(!0):vt({id:t[e].id,type:t[e].type,index:e,updateType:"remove"})}else{var a;if(i.length)if("DMUValidationExposedPresentation"===(a=i[0].pathElement.getLastElement().getDMUType&&"DMUComment"===i[0].pathElement.getLastElement().getDMUType()?"Highlight":i[0].pathElement.getLastElement().getOwner?i[0].pathElement.getLastElement().getOwner().getType():i[0].pathElement.getLastElement().modelIdentification?"Validated":void 0)?a="Highlight":"DMUValidationCheck"===a&&(a="Check"),t[n].type!==a){for(let e=i.length-1;e>=0;e--){var l=i[e].pathElement;Fe=!0,"Highlight"===a?Y.unSelectExpander(l.getLastElement().getOwner?l.getLastElement().getOwner().getPlmID():void 0):"Check"===a?te.unSelectExpander(l.getLastElement().getOwner?l.getLastElement().getOwner().getPlmID():void 0):"Validated"!==a&&"Context"!==a&&X.unSelectExpander(l.getLastElement().getOwner?l.getLastElement().getOwner().getPlmID():void 0)}Ne?Fe=!1:(f.empty(),h.empty()),"Validated"===a&&X.unSelectAllValidated()}else t[n].expander.getMainDiv().isCheckBoxClicked()||!e.event||e.event.options&&e.event.options.shiftKey||e.event.shiftKey||e.event.options&&e.event.options.ctrlKey||e.ctrlKey||i[0].pathElement.getLastElement().getDMUType()&&"DMUComment"===i[0].pathElement.getLastElement().getDMUType()||(Fe=!0,h.empty());Ee=n}vt({id:t[n].id,type:t[n].type,index:n,updateType:"add"})}function bt(e){if("Check"===e.type){var t=oe.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){Fe=!0;let i=p.buildPathElement(t[n].getNode());f.remove({pathElement:i}),f.get().length?Ct(e):Ee=-1}}else if("Highlight"===e.type){var n=oe.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){Fe=!0;let i=p.buildPathElement(n[t].getNode());f.remove({pathElement:i}),f.get().length?Ct(e):Ee=-1}}else if("Validated"===e.type){var i=e.id;if(Fe=!0,Re[i])if(Re[i].allPaths)for(let e=0;e<Re[i].allPaths.length;e++)Fe=!0,f.remove({pathElement:Re[i].allPaths[e]}),h.remove({pathElement:Re[i].allPaths[e]});else f.remove({pathElement:Re[i]}),h.remove({pathElement:Re[i]});Se=-1}else if("Context"===e.type){var o=I.getNode({id:re.getSubContextID()?re.getSubContextID():re.getMainContextID()}),r=p.buildPathElement(o);Fe=!0,f.remove({pathElement:r}),h.remove({pathElement:r})}else if("Change Action"===e.type){var a=p.buildPathElement(ae.getChangeActionNode());Fe=!0,f.remove({pathElement:a})}ht()}function Mt(){f.empty();var e=u.getCommand("DMUEditPropertiesHdr",T.commandContext);e&&e.begin()}function yt(){f.empty();var e=u.getCommand("DMUCopyLinkHdr",T.commandContext);e&&e.begin()}function wt(){let e=d.getContextViewer({viewer:j.getViewer()});if(e){let t,n,i,o=d.getReviewContext({viewer:j.getViewer()}),r=o.getValidation();if(r){t=r.getPlmID();let e=o.getCurrentSessionMarkup();if(e){let t=e.getCurrentSlide();t&&(n=t.getAttribute("sUuid"));let o=e.getMarkupOwner();o&&(i=o.getPlmID())}}d.removeReviewContext({context:e}),N&&(N.fireEvent("onDMURemoveSessionReview"),t&&N.fireEvent("onDMUReviewRefreshRequest",{reviewId:t,type:"DMUValidationValidation",displayType:"DMUValidationValidation",refreshData:{slideId:n,mkpId:i}}))}}function St(){var e=[],t=function(e){var t=f.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&(oe.isReadOnly()||"Checks"!==n&&"Highlights"!==n||(Fe=!0,v.remove({pathElement:t[e].pathElement}),f.remove({pathElement:t[e].pathElement})))}let i=p.buildPathElement(oe.getNode().getChildByName("Highlights"));const o=pt(),r=i.getLastElement().getOwner();let a=!A||!o.highlight.canEditDef;if(r.setReadOnly(a),f.add({pathElement:i}),v.add({pathElement:i}),"expand"===e){var l=u.getCommand("DMUExpandAllHdr",T.commandContext);l&&l.begin()}else{var s=u.getCommand("DMUCollapseAllHdr",T.commandContext);s&&s.begin()}};e.push({id:"ExpandAll",type:"button",nls:P.expandAll,fontIcon:"fonticon fonticon-expand-all wux-ui-3ds",separator:!1,cb:function(){t("expand")}}),e.push({id:"CollapseAll",type:"button",nls:P.collapseAll,fontIcon:"fonticon fonticon-collapse-all wux-ui-3ds",separator:!1,cb:function(){t("collapse")}}),e.push({id:"HideShowThumbnail",type:"button",nls:P.hideShowPreview,fontIcon:"fonticon fonticon-eye-off wux-ui-3ds",separator:!0,cb:function(){Y.highlightUpdatePreview()}});var n=[],i=pt();!A||!i.highlight.canEditDef||(n.push({id:"NewIssue",type:"subCommand",nls:P.newIssue,defaultCheckValue:!0,fontIcon:"fonticon fonticon-issue-type wux-ui-3ds",separator:!1,cb:function(){z="issue",localStorage.setItem("issueCreationType","issue")}}),n.push({id:"NewIssueFromTemplate",type:"subCommand",nls:P.newIssueFromTemplate,defaultCheckValue:!1,fontIcon:"fonticon fonticon-template wux-ui-3ds",separator:!1,cb:function(){z="issueTemplate",localStorage.setItem("issueCreationType","issueTemplate")}}),e.push({id:"GenerateIssue",type:"subMenuDisplayButton",nls:P.generateIssue,icon:w.getWebappsAssetUrl("DMUBaseCtxCommands","icons/32/")+"I_DMU_LeaderXCross.png",separator:!0,subCommands:n,subCommandsCheckable:!0}));var o=f.get(),r=0;for(let e=0;e<o.length;e++)o[e].pathElement.getLastElement().getDMUType&&"DMUValidationExposedPresentation"!==o[e].pathElement.getLastElement().getDMUType()||r++;return 1===o.length&&1===r&&e.push({id:"CopyLink",type:"button",nls:P.copyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",cb:function(){var e=u.getCommand("DMUCopyLinkHdr",T.commandContext);e&&e.begin()}}),(i=pt())&&A&&i.highlight.canDelete&&oe.getModifyAccessFlag()&&o.length>0&&r===o.length&&e.push({id:"Delete",type:"button",nls:P.delete,fontIcon:"fonticon fonticon-trash wux-ui-3ds",separator:!1,cb:function(){var e=u.getCommand("DMUDeleteHdr",T.commandContext);e&&e.begin()}}),e}function Et(){var e=[],t=function(e){var t=f.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&(oe.isReadOnly()||"Checks"!==n&&"Highlights"!==n||(Fe=!0,v.remove({pathElement:t[e].pathElement}),f.remove({pathElement:t[e].pathElement})))}let i=p.buildPathElement(oe.getNode().getChildByName("Checks"));const o=pt(),r=i.getLastElement().getOwner();let a=!A||!o.check.canEditDef;if(r.setReadOnly(a),f.add({pathElement:i}),v.add({pathElement:i}),"expand"===e){var l=u.getCommand("DMUExpandAllHdr",T.commandContext);l&&l.begin()}else{var s=u.getCommand("DMUCollapseAllHdr",T.commandContext);s&&s.begin()}},n=pt(),i=f.get();e.push({id:"ExpandAll",type:"button",nls:P.expandAll,fontIcon:"fonticon fonticon-expand-all wux-ui-3ds",cb:function(){t("expand")}}),e.push({id:"CollapseAll",type:"button",nls:P.collapseAll,fontIcon:"fonticon fonticon-collapse-all wux-ui-3ds",separator:n&&A&&n.check.canDelete&&oe.getModifyAccessFlag()&&i.length>0,cb:function(){t("collapse")}});var o=0;for(let e=0;e<i.length;e++)i[e].pathElement.getLastElement().getDMUType&&"DMUValidationCheck"!==i[e].pathElement.getLastElement().getDMUType()||o++;return n&&A&&n.check.canDelete&&oe.getModifyAccessFlag()&&i.length>0&&i.length===o&&e.push({id:"Delete",type:"button",nls:P.delete,fontIcon:"fonticon fonticon-trash wux-ui-3ds",cb:function(){var e=u.getCommand("DMUDeleteHdr",T.commandContext);e&&e.begin()}}),e}function xt(){var e=[],t=pt();return ge.get(de)&&t.review.canEditMaturity&&e.push({id:"Next State",type:"button",nls:P.maturityValue.SetTo+' "'+Ce.get(ge.get(de))+'"',fontIcon:"fonticon fonticon-double-chevron-right wux-ui-3ds",fontIconColor:me.get(ge.get(de)),separator:!1,cb:function(){var e=K.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],t=K.getElementsByClassName("rp-maturity-"+de)[0];(ue=new s({visible:!0})).inject(e);var n=ue.getContent().getSize().width,i=(t.getSize().width-n)/2;ue.getContent().setStyles({position:"absolute",height:"20px","margin-left":i.toString()+"px"}),N.fireEvent("onMaturityModificationRequested",{fromState:de,toState:ge.get(de)})}}),pe.get(de)&&t.review.canEditMaturity&&e.push({id:"Previous State",type:"button",nls:P.maturityValue.SetTo+' "'+Ce.get(pe.get(de))+'"',fontIcon:"fonticon fonticon-double-chevron-left wux-ui-3ds",fontIconColor:me.get(pe.get(de)),separator:!1,cb:function(){var e=K.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],t=K.getElementsByClassName("rp-maturity-"+de)[0];(ue=new s({visible:!0})).inject(e);var n=ue.getContent().getSize().width,i=(t.getSize().width-n)/2;ue.getContent().setStyles({position:"absolute",height:"20px","margin-left":i.toString()+"px"}),N.fireEvent("onMaturityModificationRequested",{fromState:de,toState:pe.get(de)})}}),e.push({id:"DMURefreshReview",type:"button",nls:P.refreshReview,fontIcon:"fonticon fonticon-refresh wux-ui-3ds",separator:!1,cb:wt}),t.review.canEditMaturity&&e.push({id:"DMUReviewMaturityChange",type:"button",nls:P.changeMaturity,fontIcon:"fonticon fonticon-collaborative-lifecycle-management wux-ui-3ds",separator:!0,cb:function(){var e=u.getCommand("DMUReviewMaturityChangeHdr",T.commandContext);e&&e.begin()}}),t&&t.review&&t.review.canEditState&&oe&&oe.getModifyAccessFlag()&&e.push({id:"DMUReviewStatusChange",type:"button",nls:P.validationStatus,fontIcon:"fonticon fonticon-check wux-ui-3ds",separator:!0,cb:function(){var e=u.getCommand("DMUReviewStatusChangeHdr",T.commandContext);e&&e.begin()}}),e.push({id:"DMUCopyLink",type:"button",nls:P.launchCopyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",separator:!1,cb:yt}),e.push({id:"DMUEditProperties",type:"button",nls:P.launchEditProperties,fontIcon:"fonticon fonticon-info wux-ui-3ds",separator:!1,cb:Mt}),e}function Ut(){var e=[];e.push({id:"newDropZone",type:"dropZone",zoneText:P.reqDropZoneInfo,title:P.newReqCheck,cb:Qe});var t=pt();return t&&t.check.canCreate&&oe.getModifyAccessFlag()&&A&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:P.newCheck,cb:nt}),e}function Ot(){var e=[],t=pt();return t&&t.highlight.canCreate&&oe.getModifyAccessFlag()&&A&&oe.getContext()&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:P.newHighlight,cb:Ye}),e}function Pt(){var e=[],t={},n={},i=d.getReviewContext({viewer:j.getViewer()}).getValidation().getMembers(),o=null,r=null,a=null;let l=E.getUserLogin();if(i){a=i.getCoordinators(),o=i.getAssignees(),r=i.getContributors();for(let t of o)e.push(t.contribution);for(let t of r)e.push(t.contribution);n.valAssignees=o,n.valContributors=r,t.valCoordinators=a}_=!0;let s=function(e){const{valAssignees:t,valContributors:n}=e,i=E.getUserLogin();if((t||n)&&(t.length||n.length)){let e=t.find((e=>e.user===i))||n.find((e=>e.user===i));if(e)return e.contribution?e.contribution:"NotStarted"}}(n);return s||(s=function(e){let t=!1,n=!1,i=!1;return e.forEach((e=>{switch(e){case"NotStarted":t=!0;break;case"OnGoing":n=!0;break;case"Completed":i=!0}})),n||t&&i?"OnGoing":t||!t&&!n&&!i?"NotStarted":i?"Completed":void 0}(e),_=!1),t.currentUser=l,t.membersContribution=s,t.bIsUserContribution=_,t._createAddMembersPanel=tt,t}function It(){if(J){let e=J.getSectionHeader(),t=Pt(),n=J.createQuickAccessCmdButtonsList(t),i=n.find((e=>"contributionStateButton"===e.id));e.setQuickAccessCommands(n),i.isUserContribution?e.setHeaderLabel(P.myContributionPanelHeaderTitle):e.setHeaderLabel(P.membersPanelHeaderTitle)}}function Rt(){var e=[];if(oe){const t=oe.getCurrentState();t&&e.push({id:"maturityStateButton",type:"label",title:P.maturityState,label:P.maturityValue[t],className:"rp-ms-box rp-maturity-"+t.toString()});const n=oe.getStatus();n&&(e.push({id:"assessValidationButton",type:"label",title:P.validationState,label:P.statusValue[n],className:"rp-ms-box rp-status-"+n.toString()}),_e&&e.push({id:"assessValidationWarningButton",type:"label",title:P.valStatusWarning[_e],fontIcon:"wux-ui-3ds-attention wux-ui-3ds",className:"rp-status-warning-"+_e}))}return e}function At(){let e=null;if(oe.getContext()){let t=oe.getContext().getMainContextType();e=x.getParentType(t)?x.getParentType(t):t}if(se.length||A){Y=new o;var t=pt();ee=Y.buildPanel({contextualCmdList:St(),quickAccessBtnList:Ot(),highlights:se,checks:le,icons:ze,highlightIcons:Xe,readOnlyFlag:oe.isReadOnly(),thumbnail:Be,onHighlightExpand:it,allowEditProperties:!0,getHighlightDragContent:function(e,t){return JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:y.getPlatformId(),serviceId:"3DSpace",contextId:S.getSetting("pad_security_ctx")?S.getSetting("pad_security_ctx"):void 0,objectId:e,objectType:"DMUValidationExposedPresentation",displayName:t}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0})},onRequirementObjClicked:rt,onAttachedObjClicked:ot,panelTitle:oe.getName()?oe.getName():R,editionMode:A,frmWindow:j,ctxViewer:d.getContextViewer({viewer:j.getViewer()}),contextType:e,restrictions:t,appId:window.widget.getValue("appId")});var n={id:"DMUHighlightsPanel",className:"DMUHighlightsPanel",title:"Highlights",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-highlight-review DMUHighlightPanelIcon",immersiveFrame:j.getImmersiveFrame(),viewerFrame:j.getViewerFrame(),closeButtonFlag:!1,content:ee,minWidth:ut(),widthStep:ct(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};$=new D(n)}}function kt(e){N.fireEvent("onValidationUserContributionModificationRequest",e)}function Tt(){require(["DS/ENOCollabSharingCmds/commands/TransferOwnershipCmd/ActionBar_TransferOwnershipCmd"],(function(t){var n=[],i={getID:function(){return oe.getPlmID()},getLabel:function(){return oe.getName()?oe.getName():R}};n.push(i);var o={securityContext:{SecurityContext:S.getSetting("pad_security_ctx")},getSecurityContext:function(){return this.securityContext},getSelectedNodes:function(){return n}},r=new t({ID:"ActionBar_TransferOwnershipCmd_"+window.widget.id,context:o});f.empty(),e.is(r,"object")||r.onEnd((function(){var e=setInterval((function(){r.transferOwnershipPanel&&r.transferOwnershipPanel.addEvent&&(clearInterval(e),r.transferOwnershipPanel.addEvent("onValidation",(function(e){if((void 0===event||"click"===event.type)&&e.owner){var t=[{user:e.owner.person.personID,type:"person"}];J.updateOwnerView(t)}})))}))}),200),e.is(r,"object")&&r.begin()}))}function Vt(e){var t={mode:"panel",height:V.TRANSIENT.HEIGHT,width:V.TRANSIENT.WIDTH};require(["DS/TransientWidget/TransientWidget"],(function(n){n.showWidget(V.APP_ID_MY_PROFILE,"",{login:e,url:y.getPlatformURL("3DSwym")},t)}))}function jt(e){var t=d.getReviewContext({viewer:j.getViewer()}).getValidation().getAllRepRefs();let n=t.some((t=>"Reply"===t.getParent().getValType()&&t.getOwner()===e)),i=t.some((t=>"Markup"===t.getParent().getValType()&&t.getOwner()===e));return i&&n?"Markup_Reply":n&&!i?"Reply":i&&!n?"Markup":""}function Ft(){let e=d.getReviewContext({viewer:j.getViewer()}).getValidation().getMembers();var t=[],n=[],i=[],o=[];e&&(t=e.getCoordinators(),n=e.getAssignees(),i=e.getContributors(),o=e.getInformedUsers());let r=window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):null;var l=null;if(!A&&(t.length>0||n.length>0||i.length>0||o.length>0)||A){l=pt();const e=E.getUserLogin(),d=y.getPlatformURL("3DSwym");J=new a({frameWindow:j}),Q=J.buildPanel({options:{currentUser:e,appId:"X3DPLAW_AP"===r?r:null,owner:[{user:oe.getOwner(),type:"person"}],coordinators:t,assignees:n,contributors:i,informedUsers:o,cellDataJsonCreation:et,fireContributionEvent:kt,transferOwnership:Tt,openWindow:Vt,quickAccessBtnData:Pt(),saveMembers:function(e){N.fireEvent("onUpdateMembersRequested",e)},platformUrl:d,isMarkupsOfUserExist:jt},readOnlyFlag:oe.isReadOnly(),editionMode:A,restrictions:l});var s={id:"DMUMembersPanel",className:"DMUMembersPanel",title:"Members",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-users DMUMembersPanelIcon",immersiveFrame:j.getImmersiveFrame(),viewerFrame:j.getViewerFrame(),closeButtonFlag:!1,content:Q,minWidth:ut(),widthStep:ct(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};Z=new D(s),It()}}function Nt(){let e=null;if(oe.getContext()){let t=oe.getContext().getMainContextType();e=x.getParentType(t)?x.getParentType(t):t}if(le.length||A){te=new r,he={envId:y.getPlatformId(),contextId:S.getSetting("pad_security_ctx")?S.getSetting("pad_security_ctx"):void 0,source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},ve=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:y.getPlatformId(),serviceId:"3DSpace",contextId:S.getSetting("pad_security_ctx")?S.getSetting("pad_security_ctx"):void 0,objectId:oe.getPlmID(),objectType:"DMUValidationValidation",displayName:oe.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0});var t=pt();ie=te.buildPanel({contextualCmdList:Et(),quickAccessBtnList:Ut(),openWithMenu:qt,checks:le,highlights:se,icons:ze,highlightIcons:Xe,readOnlyFlag:oe.isReadOnly(),thumbnail:Be,onHighlightExpand:it,allowEditProperties:!0,highlightDragContent:he,reviewDragContent:ve,onRequirementObjClicked:rt,onAttachedObjClicked:ot,panelTitle:oe.getName()?oe.getName():R,editionMode:A,frmWindow:j,ctxViewer:d.getContextViewer({viewer:j.getViewer()}),contextType:e,restrictions:t,appId:window.widget.getValue("appId")});var n={id:"DMUChecksPanel",className:"DMUChecksPanel",title:"Checks",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-check-review DMUChecksPanelIcon",immersiveFrame:j.getImmersiveFrame(),viewerFrame:j.getViewerFrame(),closeButtonFlag:!1,content:ie,minWidth:ut(),widthStep:ct(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};ne=new D(n)}}function Lt(e,t){if(e&&t){let i="noWarning";var n=e.getChecks();n&&n.length>0&&("inProgress"===e.getStatus()?n.some((e=>"1"===e.getStatus()))||(i="warningProgress"):"failed"===e.getStatus()?n.some((e=>"3"===e.getStatus()))||(i="warningFailed"):"passed"===e.getStatus()&&(n.every((e=>"2"===e.getStatus()))||(i="warningPassed"))),_e!==i&&(_e=i,t.setPanelQuickAccessCommands(Rt()))}}function Bt(e){return new Promise(((t,n)=>{je||ft(),function(e){let t;var n={},i=Re[e];t=i.allPaths?i.allPaths[0].getLastElement(!0):i.getLastElement(!0),"Document"!==re.getMainContextType()&&"Specification Report"!==re.getMainContextType()||(n.id=re.getSubContextID()?re.getSubContextID():re.getMainContextID(),n.type=re.getSubContextType()?re.getSubContextType():re.getMainContextType()),t&&(t.getModelIdentification()?n.id=t.getModelIdentification():t.getDocInfo()&&t.getDocInfo().validatedPaths&&t.getDocInfo().validatedPaths.length>0&&(n.id=t.getDocInfo().validatedPaths[0]),t.getUserData()?(n.type=t.getUserData().type,"R2V_FeatureState"===n.type&&(n.service="r2vsurvey")):t.getDocInfo()&&t.getDocInfo()&&t.getDocInfo().validatedType?n.type=t.getDocInfo().validatedType:t.getDocInfo()&&t.getDocInfo()&&t.getDocInfo().referenceType&&(n.type=t.getDocInfo().referenceType)),Re[e].infos=n}(e),Re&&Re[e]&&Re[e].infos?("R2V_Activity"===Re[e].infos.ctxType&&(Re[e].infos.service="r2vsurvey"),O.openWithApps(Re[e].infos).then((function(e){t(e)})).catch((function(){n(new Error)}))):n(new Error)}))}function Wt(){return new Promise(((e,t)=>{var n=ae.getPathElements();for(let i=0;i<n.length;i++)"Change Action"===n[i].referenceType&&1===n[i].pathElement.length&&O.openWithApps({id:n[i].pathElement[0],type:"Change Action"}).then((function(t){e(t)})).catch((function(){t(new Error)}))}))}function Ht(){return new Promise(((e,t)=>{var n,i,o=oe.getContext();o.getSubContextID()?(n=o.getSubContextID(),i=o.getSubContextType()):(n=o.getMainContextID(),i=o.getMainContextType());var r={id:n,type:i};"R2V_Activity"===i&&(r.service="r2vsurvey"),O.openWithApps(r).then((function(t){e(t)})).catch((function(){t(new Error)}))}))}function qt(e){return new Promise(((t,n)=>{var i,o=oe.getContext();i=o.getSubContextID()?o.getSubContextType():o.getMainContextType();var r={id:e,type:"Requirement"};"R2V_Activity"===i&&(r.service="r2vsurvey"),O.openWithApps(r).then((function(e){t(e)})).catch((function(){n(new Error)}))}))}function _t(){var e=d.getReviewContext({viewer:j.getViewer()});B=!0,I=d.getContextViewer({viewer:j.getViewer()}).getController(),oe=e.getValidation(),re=oe.getContext(),ae=oe.getValidated(),gt(),le=oe.getChecksData(),se=oe.getHighlightsData(),function(){for(let t=0;t<se.length;t++){var e={_repRefMarkupId:se[t].repRefMarkupId,_slideID:se[t].slideId};Ae[se[t].id]=e}}(),X=new i,de=oe.getCurrentState();let t=null;if(oe.getContext()){let e=oe.getContext().getMainContextType();t=x.getParentType(e)?x.getParentType(e):e}var o,r=pt();At(),Nt(),Ft(),ve=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:y.getPlatformId(),serviceId:"3DSpace",contextId:S.getSetting("pad_security_ctx")?S.getSetting("pad_security_ctx"):void 0,objectId:oe.getPlmID(),objectType:"DMUValidationValidation",displayName:oe.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),1===ae.getPathElements().length&&"Change Action"!==ae.getPathElements()[0].referenceType&&(Ke(re.getMainContext())||(o=re.getMainContext())&&["Drawing","Document","Specification Report","Requirement","DIFSheet","R2V_Activity","FailureModesEffectsAnalysis"].includes(o.type))&&(re.getMainContextID()!==ae.getPathElements()[0].pathElement[0]&&re.getSubContextID()!==ae.getPathElements()[0].pathElement[0]||X.setAddValidatedButtonVisibilityFlag(!0));let a=null;var l;re&&(a=[],re.getSubContextName()?a.push(re.getSubContextName()):re.getMainContextName()&&a.push(re.getMainContextName())),K=X.buildPanel({contextualCmdList:oe.isReadOnly()?(l=[],l.push({id:"DMURefreshReview",type:"button",nls:P.refreshReview,fontIcon:"fonticon fonticon-refresh wux-ui-3ds",separator:!1,cb:wt}),l.push({id:"DMUCopyLink",type:"button",nls:P.launchCopyLink,icon:w.getWebappsAssetUrl("DMUBaseCommands","icons/22/")+"I_DMUCopyLink.png",cb:yt}),l.push({id:"DMUEditProperties",type:"button",nls:P.launchEditProperties,icon:w.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:Mt}),l):xt(),quickAccessBtnList:Rt(),openWithMenu:Bt,openWithCAMenu:Wt,openCtxWithMenu:Ht,contextNames:a,validatedNames:oe.getValidated().getValidatedInstanceNames(),changeActionName:oe.getValidated().getChangeActionName(),checks:le,highlights:se,icons:ze,highlightIcons:Xe,readOnlyFlag:oe.isReadOnly(),thumbnail:Be,onHighlightExpand:it,allowEditProperties:!0,reviewDragContent:ve,onRequirementObjClicked:rt,onAttachedObjClicked:ot,onAddValidatedClicked:dt,panelTitle:oe.getName()?oe.getName():R,editionMode:A,frmWindow:j,ctxViewer:d.getContextViewer({viewer:j.getViewer()}),contextType:t,restrictions:r,appId:window.widget.getValue("appId")});var s={id:"DMUReviewPanel",className:"DMUReviewPanel",title:"Review",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-review DMUReviewPanelIcon",immersiveFrame:j.getImmersiveFrame(),viewerFrame:j.getViewerFrame(),closeButtonFlag:!1,content:K,minWidth:ut(),widthStep:ct(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};function g(){let t=[];re&&ce.id&&t.push(ce.id);for(let e=0;e<ae.getPathElements().length;e++){let n=ae.getPathElements()[e];t.push(n.pathElement[n.pathElement.length-1])}if(re&&"R2V_Activity"===ce.type){let t;t=e.getReviewCtxInformation()&&e.getReviewCtxInformation().loadedR2VInfo?e.getReviewCtxInformation().loadedR2VInfo:e.getValidation().getContext().getJsonContexts()[0].loadedR2VInfo,t.forEach((e=>{if(e.id===re.getJsonContextIDs()[0]){let n=e.info[0].icon||e.info[0]["ds6w:icon"],i=e.info[0]["ds6w:label"],o=K.getElementsByClassName("validatedObjectExpander");for(let t=0;t<o.length;t++)if(""!==ae.getPathElements()[t].instanceName){let n=e.info[0].icon||e.info[0]["ds6w:icon"];X.updateHeaderIcon(o[t].id,n)}else X.updateHeaderIcon(o[t].id,n);var t=K.getElementsByClassName("contextObjectExpander");for(let e=0;e<t.length;e++)X.updateHeaderIcon(t[e].id,n),X.updateHeaderLabel(t[e].id,i)}}))}else ce.id&&t.length>0&&I.getAttributes({ids:t,attributes:["type_icon_url"],callbacks:{onComplete:function(e){let t=e[ce.id].type_icon_url,n=e[ce.id]["ds6w:label"],i=K.getElementsByClassName("validatedObjectExpander");var o=0,r=ae.getPathElements();for(let n=0;n<r.length;n++)if("Change Action"!==r[n].referenceType){var a=r[n].pathElement[r[n].pathElement.length-1];if(""!==r[n].instanceName){let t=e[a];X.updateHeaderIcon(i[o].id,t.type_icon_url)}else X.updateHeaderIcon(i[o].id,t);o++}else{let t=e[r[n].pathElement[0]];X.updateHeaderIcon("-2",t.type_icon_url)}var l=K.getElementsByClassName("contextObjectExpander");for(let e=0;e<l.length;e++)X.updateHeaderIcon(l[e].id,t),X.updateHeaderLabel(l[e].id,n)},onFailure:function(){let t=e.getReviewCtxInformation().tempObjectInfo.icon,n=K.getElementsByClassName("reviewPanel-validIcon");for(let e=0;e<n.length;e++)n[e].src=t;var i=K.getElementsByClassName("reviewPanel-ctxIcon");for(let e=0;e<i.length;e++)i[e].src=t;return null}}})}G=new D(s),re&&(ce.id=re.getSubContextID()?re.getSubContextID():re.getMainContextID(),ce.type=re.getSubContextType()?re.getSubContextType():re.getMainContextType()),g();var C,b=[];for(C=0;C<le.length;C++)if(0!==le[C].requirements.length){let e;for(e=0;e<le[C].requirements.length;e++)b.push(le[C].requirements[e].getPlmID())}b.length>0&&I.getAttributes({ids:b,attributes:["label","type_icon_url","ds6w:status"],callbacks:{onComplete:function(t){if(t){let l=e.getValidation();if(l){let e=l.getChecks();for(var n=0;n<e.length;n++){let r=e[n].getJsonRequirements();for(var i=0;i<r.length;i++)for(var o=0;o<b.length;o++)b[o]===r[i].getPlmID()&&r[i].setName(t[b[o]].label)}}var r=ie.getElementsByClassName("checksPanel-requirement");for(let e=0;e<r.length;e++){var a=r[e].id;r[e].setText(t[a].label),r[e].title=t[a].label}}},onFailure:function(){return null}}}),window.addEventListener("keydown",st,!0),Lt(oe,X),X&&(xe.updateIconValidated=X.subscribe("updateIconValidated",g),xe.onValidatedSelected=X.subscribe("onValidatedSelected",(function(e){var t=f.get();for(let e=t.length-1;e>=0;e--)if(t[e].pathElement.getLastElement().getOwner){var n=t[e].pathElement.getLastElement().getOwner().getType();if("DMUValidationCheck"===n||"DMUValidationExposedPresentation"===n){Fe=!0;var i=t[e].pathElement;h.remove({pathElement:t[e].pathElement}),f.remove({pathElement:t[e].pathElement}),X.unSelectExpander(i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0),te.unSelectExpander(i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0),Y.unSelectExpander(i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0),ht()}}!function(e){je||ft();var t,n=e.element.header,i=e.element.getContent().id;let o;if((re=oe.getContext()).getSubContextName()?o=re.getSubContextName():re.getMainContextType()&&(o=re.getMainContextType()),n===o&&"Requirement"!==o){var r=[];t=I.getNode({id:re.getSubContextID()?re.getSubContextID():re.getMainContextID()}),r.push(t);var a=new m(r);Re[i]=a}if(!0===e.element.isSelected())if(e.event&&e.event.shiftKey&&Se>-1)if(-1!==Se){f.add({pathElement:Re[i]}),h.add({pathElement:Re[i]});var l=Te[i].index>Te[Se].index+1?Te[Se].index+1:Te[i].index,s=Te[i].index>Te[Se].index-1?Te[i].index:Te[Se].index-1;for(let t=l;t<=s;t++)t>=l&&t<=s&&(e.validatedRects[t].getMainDiv().isSelected()||e.validatedRects[t].getMainDiv().setSelectedFlag(!0))}else f.add({pathElement:Re[i]}),h.add({pathElement:Re[i]}),Se=i;else{if(["Requirement Specification","Requirement"].includes(re.getMainContextType())){let e=c.getManager({name:"DMU2DSheetManager",context:j});Re.length&&(f.unsubscribe(De),e.setCurrentElement({elementID:Re[i].getLastElement(!0).modelIdentification?Re[i].getLastElement(!0).modelIdentification:Re[i].getLastElement(!0).getDocInfo().validatedPaths[0]}),De=f.onPostRemove((function(e){var t;e&&e.length&&e[0].pathElement&&e[0].pathElement.getLastElement(!0).getDMUType&&(t=e[0].pathElement.getLastElement(!0).getDMUType()),Fe||"DMUSlide"===t||(X.unSelectAllExpanders(Ie),te.unSelectAllExpanders(Ie),Y.unSelectAllExpanders(Ie)),Fe=!1,f.get().length||(Ee=-1)})))}if(e.element.isCheckBoxClicked()||!event||event.shiftKey||event.ctrlKey||e.event&&(f.get().length&&e.event.target&&e.event.target.getParents().find((e=>e.hasClassName("flowContainer")))&&(Fe=!0),f.empty(),h.empty()),Re[i]){var d={};if("Document"===re.getMainContextType()||"Specification Report"===re.getMainContextType())(t=I.getNode({id:re.getSubContextID()?re.getSubContextID():re.getMainContextID()}))&&(f.add({pathElement:p.buildPathElement(I.getNode({id:re.getSubContextID()?re.getSubContextID():re.getMainContextID()}))}),h.add({pathElement:p.buildPathElement(I.getNode({id:re.getSubContextID()?re.getSubContextID():re.getMainContextID()}))})),d.id=re.getSubContextID()?re.getSubContextID():re.getMainContextID(),d.type=re.getSubContextType()?re.getSubContextType():re.getMainContextType();else{let e;if(Re[i].allPaths){for(let e=0;e<Re[i].allPaths.length;e++)f.add({pathElement:Re[i].allPaths[e]}),h.add({pathElement:Re[i].allPaths[e]});e=Re[i].allPaths[0].getLastElement(!0)}else f.add({pathElement:Re[i]}),h.add({pathElement:Re[i]}),e=Re[i].getLastElement(!0);e&&(e.getModelIdentification()?d.id=e.getModelIdentification():e.getDocInfo()&&e.getDocInfo().validatedPaths&&e.getDocInfo().validatedPaths.length>0&&(d.id=e.getDocInfo().validatedPaths[0]),e.getUserData()?(d.type=e.getUserData().type,"R2V_Activity"===d.type&&(d.service="r2vsurvey")):e.getDocInfo()&&e.getDocInfo()&&e.getDocInfo().validatedType?d.type=e.getDocInfo().validatedType:e.getDocInfo()&&e.getDocInfo()&&e.getDocInfo().referenceType&&(d.type=e.getDocInfo().referenceType))}Re[i].infos=d,Se=i}else if("-2"===i){var u=p.buildPathElement(ae.getChangeActionNode());Fe=!1,f.add({pathElement:u})}}}(e)})),xe.onContextSelected=X.subscribe("onContextSelected",(function(e){!function(e){var t=I.getNode({id:re.getSubContextID()?re.getSubContextID():re.getMainContextID()});t||1!==re.getJsonContextTypes().length||"FailureModesEffectsAnalysis"!==re.getJsonContextTypes()[0]||(t=d.getContextViewer({viewer:j.getViewer()}).getRoots().find((e=>e.modelIdentification===re.getJsonContextIDs()[0])));t||1!==re.getJsonContextTypes().length||"DELLmiWorkPlanSystemReference"!==re.getJsonContextTypes()[0]||((t=new n).setName(re.getJsonContextNames[0]),t.setModelIdentification(re.getJsonContextIDs[0]),t.setUserData({type:"DELLmiWorkPlanSystemReference"}));var i=p.buildPathElement(t);if(!0===e.element.isSelected()&&i.externalPath.length){if(!e.event.ctrlKey){var o=f.get();o.length&&o[0].pathElement&&o[0].pathElement.getLastElement&&o[0].pathElement.getLastElement().getDMUType&&"DMUSlide"===o[0].pathElement.getLastElement().getDMUType()&&(Fe=!0),f.empty(),h.empty()}f.add({pathElement:i}),h.add({pathElement:i})}else Fe=!0,f.remove({pathElement:i}),h.remove({pathElement:i})}(e)})),xe.onExpanderSelectionRequested=X.subscribe("onExpanderSelectionRequested",(function(e){Dt(e)})),xe.onExpanderUnselectRequested=X.subscribe("onExpanderUnselectRequested",(function(e){bt(e)})),xe.onValidatedRemove=X.subscribe("onValidatedRemove",(function(e){!function(){var e=u.getCommand("DMURemoveValidatedObjectHdr",T.commandContext);e&&(e.options.arguments[0].Value="remove",e.begin());var t=N.addEvent("onValidatedSaved",(function(e){["Requirement","R2V_Activity","Requirement Specification"].includes(re.getMainContextType())&&X.setDropZoneVisibilityFlag(!0),X._processValidatedObjDeletion(e),f.empty(),h.empty(),gt((function(){ft()})),N.removeEvent(t)}))}()})),xe.onUpdateValidatedListCancel=X.subscribe("onUpdateValidatedListCmdCancel",(function(){var e=u.getCommand("DMUAddValidatedObjectHdr",T.commandContext);e&&e.isRunning()&&(e.end(),X.deactiveValidatedButton(),H=!1,be&&N.removeEvent(be))})),xe.onMarkupCreationRequested=X.subscribe("onMarkupCreationRequested",(function(){var e=u.getCommand("DMUReviewMarkupHdr",T.commandContext);e&&e.begin()})),xe.onMarkupCtxMenuRequired=X.subscribe("onMarkupCtxMenuRequired",Ze),xe.onMarkupRenamed=X.subscribe("onMarkupRenamed",Je)),te&&(Ue.onExpanderSelectionRequested=te.subscribe("onExpanderSelectionRequested",(function(e){Dt(e)})),Ue.onExpanderUnselectRequested=te.subscribe("onExpanderUnselectRequested",(function(e){bt(e)})),Ue.onCheckAttributeChanged=te.subscribe("onCheckAttributeChanged",(function(e){!function(e){var t=f.get();if(e.status){var n=[];for(let o=0;o<t.length;o++){var i=t[o].pathElement.getLastElement().getOwner().getPlmID();n.push(i),te.updateCheckStatus(i,e.status)}var o={objectIds:n,status:e.status};N.fireEvent("onCheckAttributeChanged",o)}else N.fireEvent("onCheckAttributeChanged",e)}(e)})),Ue.onRequirementAddRequested=te.subscribe("onRequirementAddRequested",(function(e){!function(e){N.fireEvent("requirementAddRequested",e)}(e)})),Ue.onObjectRemoveRequested=te.subscribe("onRequirementRemoveRequested",(function(e){!function(e){N.fireEvent("onRequirementRemoveRequested",e)}(e)})),xe.onCheckCreationRequested=te.subscribe("onCheckCreationRequested",nt)),Y&&(Oe.onExpanderSelectionRequested=Y.subscribe("onExpanderSelectionRequested",(function(e){Dt(e)})),Oe.onExpanderUnselectRequested=Y.subscribe("onExpanderUnselectRequested",(function(e){bt(e)})),Oe.onHighlightAttributeChanged=Y.subscribe("onHighlightAttributeChanged",(function(e){!function(e){var t=f.get();if(e.rating){var n=[];for(let o=0;o<t.length;o++)if(t[o].pathElement.getLastElement().getOwner&&"DMUValidationExposedPresentation"===t[o].pathElement.getLastElement().getOwner().getType()){var i=t[o].pathElement.getLastElement().getOwner().getPlmID();i&&(n.push(i),Y.updateHighlightSeverity(i,e.rating))}var o={objectIds:n,rating:e.rating};N.fireEvent("onHighlightAttributeChanged",o)}else N.fireEvent("onHighlightAttributeChanged",e)}(e)})),Oe.onImpCheckRemoveRequested=Y.subscribe("onImpCheckRemoveRequested",(function(e){!function(e){var t,n;if(oe){var i=oe.getHighlights();if(i)for(let n=0;n<i.length;n++)if(i[n].getPlmID()===e.highlightId){t=i[n];break}var o=oe.getChecks();if(o)for(let t=0;t<o.length;t++)if(o[t].getPlmID()===e.checkId){n=o[t];break}}t&&n&&N.fireEvent("onRemoveImpactedCheckRequested",{highlight:t,check:n})}(e)})),Oe.onIssueAddRequested=Y.subscribe("onIssueAddRequested",(function(e){var t,n,i=f.get();for(let t=0;t<i.length;t++)if(i[t].pathElement.getLastElement().getOwner&&i[t].pathElement.getLastElement().getOwner().getPlmID()!==e.id){Fe=!0;let n=i[t].pathElement.getLastElement().getOwner().getPlmID(),o=0;for(;o<e.expanders.length;){if(e.expanders[o].id===n){e.expanders[o].expander.getMainDiv().setSelectedFlag(!1);break}o++}t++}if("issueTemplate"===z){var o=u.getCommand("CATWebUXGenerateIssueTemplateHdr",T.commandContext);o&&o.begin()}else{var r=u.getCommand("CATWebUXGenerateIssueHdr",T.commandContext);r&&r.begin()}t=N.addEvent("onTICCreationComplete",(function(e){Y.deactiveButtons(),N.fireEvent("onIssueDataRequested",{physicalId:e.ticID,onComplete:function(t){Y.addIssue({highlightId:e.attachmentIDs[0],name:t.issueTitle,id:e.ticID})}}),N.fireEvent("onHighlightIssueOrTaskCreated",{highlightId:e.attachmentIDs[0],type:"issue"}),N.removeEvent(t),N.removeEvent(n)})),n=N.addEvent("onTICCreationCancel",(function(){Y.deactiveButtons(),N.removeEvent(t),N.removeEvent(n)})),window.addEventListener("keydown",st,!0)})),Oe.onTaskAddRequested=Y.subscribe("onTaskAddRequested",(function(e){var t=f.get();for(let n=0;n<t.length;n++)if(t[n].pathElement.getLastElement().getOwner&&t[n].pathElement.getLastElement().getOwner().getPlmID()!==e.id){Fe=!0;let i=t[n].pathElement.getLastElement().getOwner().getPlmID(),o=0;for(;o<e.expanders.length;){if(e.expanders[o].id===i){e.expanders[o].expander.getMainDiv().setSelectedFlag(!1);break}o++}n++}var n,i,o=u.getCommand("CATWebUXGenerateTaskHdr",T.commandContext);o&&o.begin(),n=N.addEvent("onTICCreationComplete",(function(e){Y.deactiveButtons(),N.fireEvent("onTaskDataRequested",{physicalId:e.ticID,onComplete:function(t){Y.addTask({highlightId:e.attachmentIDs[0],name:t.taskTitle,id:e.ticID})}}),N.fireEvent("onHighlightIssueOrTaskCreated",{highlightId:e.attachmentIDs[0],type:"task"}),N.removeEvent(n),N.removeEvent(i)})),i=N.addEvent("onTICCreationCancel",(function(){Y.deactiveButtons(),N.removeEvent(n),N.removeEvent(i)})),window.addEventListener("keydown",st,!0)})),Oe.onCaAddRequested=Y.subscribe("onCaAddRequested",(function(e){var t=f.get();for(let n=0;n<t.length;n++)if(t[n].pathElement.getLastElement().getOwner&&t[n].pathElement.getLastElement().getOwner().getPlmID()!==e.id){Fe=!0;let i=t[n].pathElement.getLastElement().getOwner().getPlmID(),o=0;for(;o<e.expanders.length;){if(e.expanders[o].id===i){e.expanders[o].expander.getMainDiv().setSelectedFlag(!1);break}o++}n++}var n,i,o=u.getCommand("CATWebUXGenerateCAHdr",T.commandContext);o&&o.begin(),n=N.addEvent("onTICCreationComplete",(function(e){Y.deactiveButtons(),Y.addCa({highlightId:e.attachmentIDs[0],name:e.title,id:e.ticID}),N.removeEvent(n),N.removeEvent(i)})),i=N.addEvent("onTICCreationCancel",(function(){Y.deactiveButtons(),N.removeEvent(n),N.removeEvent(i)})),window.addEventListener("keydown",st,!0)})),xe.onImpCheckRequested=Y.subscribe("onImpCheckRequested",(function(e){var t;if(oe){var n=oe.getHighlights();if(n)for(let i=0;i<n.length;i++)if(n[i].getPlmID()===e.objectId){t=n[i];break}}N.fireEvent("onSetImpCheckRequested",{highlightObject:t}),q=!0,window.addEventListener("keydown",st,!0)})),xe.onHighlightCreationRequested=Y.subscribe("onHighlightCreationRequested",Ye)),Ue.onRequirementRemoved=N.addEvent("onRequirementRemoved",(function(t){te.removeRequirement(t),(e=e||d.getReviewContext({viewer:j.getViewer()}))&&e.getValidation().getChecks().forEach((e=>{e._sPlmID&&e.removeJsonRequirement(t.requirementId)}))})),Pe.onExpanderSelectRequested=N.addEvent("onExpanderSelectRequested",(function(e){var t;if(e.type&&e.id){t="Highlight"===e.type?Y.getExpanders():"Check"===e.type?te.getExpanders():X.getExpanders();for(let n=0;n<t.length;n++)t[n].id===e.id&&t[n].expander.getMainDiv().setSelectedFlag(!0,!0)}})),Pe.onValidationMembersUpdated=N.addEvent("onValidationMembersUpdated",(function(e){if(e){var t=e.validationMembersDiff.assignees,n=e.validationMembersDiff.coordinators,i=e.validationMembersDiff.contributors,o=e.validationMembersDiff.informedusers;if(J.updateMembersView({assignees:t,coordinators:n,contributors:i,informedUsers:o}),N.fireEvent("onValidationChangeRequested"),te){te.setRestrictions(pt()),te.updatePanel(),te.setPanelQuickAccessCommands(Ut());let e=te.getSectionHeader(),t=Et();e.setSubMenuCommands(t)}if(X){X.setRestrictions(pt()),X.updatePanel(),X.setPanelQuickAccessCommands(Rt());let e=X.getSectionHeader(),t=xt();e.setSubMenuCommands(t)}if(Y){Y.setRestrictions(pt()),Y.updatePanel(),Y.setPanelQuickAccessCommands(Ot());let e=Y.getSectionHeader(),t=St();e.setSubMenuCommands(t)}It()}})),Pe.onValidationUserContributionUpdated=N.addEvent("onValidationUserContributionUpdated",(function(e){let t=e.concernedMember;J.updateContributionCells(t),N.fireEvent("onValidationChangeRequested"),It()})),Pe.issueCreationTokenEvent=N.addEvent("onTICFromSelectionCreationComplete",(function(e){Y.deactiveButtons(),N.fireEvent("onIssueDataRequested",{physicalId:e.ticID,onComplete:function(t){Y.addIssue({highlightId:e.attachmentIDs[0],name:t.issueTitle,id:e.ticID})}}),N.fireEvent("onHighlightIssueOrTaskCreated",{highlightId:e.attachmentIDs[0],type:"issue"})})),Pe.onCommentOrSlideInformationIconClicked=N.addEvent("onCommentOrSlideInformationIconClicked",(function(e){Ne=!0,e.highlightId?Y.scrollToHighlight(e,(function(){Ne=Le=!1})):e.checkId&&te.scrollToCheck(e,(function(){Ne=Le=!1}))})),Pe.onExpandRequested=N.addEvent("onExpandRequested",(function(e){"DMUValidationCheck"===e?te.expandAll():Y.expandAll();var t=f.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&("Checks"!==n&&"Highlights"!==n||(Fe=!0,v.remove({pathElement:t[e].pathElement}),f.remove({pathElement:t[e].pathElement}),ht()))}})),Pe.onExpanderSelectionRequested=N.addEvent("onExpanderSelectionRequested",(function(e){Dt(e)})),Pe.onSetImpactedCheckRequested=N.addEvent("onSetImpactedCheckRequested",(function(e){var t,n=[];if(oe){var i=oe.getHighlights();if(i)for(let n=0;n<i.length;n++)if(i[n].getPlmID()===e.highlightId){t=i[n];break}var o=oe.getChecks();if(o)for(let t=0;t<o.length;t++)if(o[t].getPlmID()===e.checkId){n.push(o[t].getPlmID());break}}N.fireEvent("onSetImpCheckRequested",{highlightObject:t,checkObject:n}),q=!0,window.addEventListener("keydown",st,!0)})),Pe.onCollapseRequested=N.addEvent("onCollapseRequested",(function(e){"DMUValidationCheck"===e?te.collapseAll():Y.collapseAll();var t=f.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&("Checks"!==n&&"Highlights"!==n||(Fe=!0,v.remove({pathElement:t[e].pathElement}),f.remove({pathElement:t[e].pathElement})))}})),Pe.onValidatedCmdCancel=N.addEvent("onValidatedObjCancelRequested",(function(){lt()})),Pe.updateHighlightAttributes=N.addEvent("updateHighlightAttributes",(function(e){Y.updateHighlightAttributes(e)})),Pe.onDMUCheckRemoveRequested=N.addEvent("onDMUCheckRemoveRequested",(function(e){te.updateCheckDisplay(e),Lt(oe,X)})),Pe.onCrossWidgetSelection=N.addEvent("onCrossWidgetSelection",(function(e){if(e.paths&&e.paths.length&&e.paths[0].length){var t=e.paths[0][0];if(e.attributes&&e.attributes[t]){var n=e.attributes[t];if(n.type&&"Requirement"===n.type){var i=function(e){var t=d.getReviewContext({viewer:j.getViewer()});if(!t)return;let n=t.getValidation().getChecks();for(let t=0;t<n.length;t++){var i=n[t].getJsonRequirements();if(i.length&&i[0].getPlmID()===e)return n[t].getPlmID()}}(t);i&&(Ne=!0,te.scrollToCheck({checkId:i},(function(){Ne=Le=!1})))}}}})),Pe.onRequirementAdded=N.addEvent("onRequirementAdded",(function(t){te.addRequirement(t),(e=e||d.getReviewContext({viewer:j.getViewer()}))&&e.getValidation().getChecks().forEach((e=>{e.getPlmID()===t.checkId&&e.addJsonRequirement({type:"Requirement",id:t.requirementId,name:t.requirementTitle})}))})),Pe.onDMUHighlightRemoveRequested=N.addEvent("onDMUHighlightRemoveRequested",(function(e){Y.updateHighlightDisplay(e),e.forEach((function(e){oe.getMarkups().forEach((function(t){t.getChildren().forEach((function(t){if("ReviewMarkup"===t.getType())(t.getMarkupContent()?t.getMarkupContent().getSlides():[]).forEach((function(t){"Document"===re.getMainContextType()||"Specification Report"===re.getMainContextType()?t.getDMUObjects().forEach((function(t){t.getDMUComments().forEach((function(t){t.getAssociatedHighlightData().forEach((function(n){n.id===e&&t.removeAssociatedHighlightData({id:e})}))}))})):t.getAssociatedHighlightData().forEach((function(n){n.id===e&&t.removeAssociatedHighlightData({id:e})}))}));else if("Reply"===t.getType()){t.getChildren().forEach((function(t){(t.getMarkupContent()?t.getMarkupContent().getSlides():[]).forEach((function(t){t.getAssociatedHighlightData().forEach((function(n){n.id===e&&t.removeAssociatedHighlightData({id:e})}))}))}))}}))}));let t=We.get(e);t&&t.remove(),We.delete(e)}))})),Pe.onAttributeSaved=N.addEvent("onAttributeSaved",(function(e){te.updateImpactedCheckDisplay(e),Y.updateImpactedCheckDisplay(e),void 0!==e.status&&e.object&&Lt(e.object.getParent(),X)})),Pe.onImpCheckFailed=N.addEvent("onImpCheckFailed",(function(){Y.deactiveButtons()})),Pe.onReviewCtxLoaded=N.addEvent("onReviewCtxLoaded",(function(e){X.updateContextInformations(e),(re=oe.getContext())&&(ce.id=re.getSubContextID()?re.getSubContextID():re.getMainContextID(),ce.type=re.getSubContextType()?re.getSubContextType():re.getMainContextType()),Y&&Y.setPanelQuickAccessCommands(Ot())})),Pe.onHighlightPreviewUpdateRequested=N.addEvent("onHighlightPreviewUpdateRequested",(function(e){Y.updateSlidePreview({id:e.highlightId})})),Pe.onIssueTemplateOnlySet=N.addEvent("onIssueTemplateOnlySet",(function(e){!0===e&&(z="issueTemplate",localStorage.setItem("issueCreationType","issueTemplate"))})),Pe.onDMUSlideDelete=N.addEvent("onDMUSlideDelete",(function(e){if("DMUSlide"===e.dmuObject.getType()){let t=e.dmuObject.getAssociatedHighlightData();for(let e=0;e<t.length;e++)Y.updateSlidePreview(t[e]),N&&N.fireEvent("onPreviewDeleteOnHighlightRequested",{elementId:t[e].id})}})),Pe.onDMUObjectAttributeModified=N.addEvent("onDMUObjectAttributeModified",(function(e){if(e&&"bMarkedAsDeleted"===e.attrName&&"DMUSlide"===e.dmuObject.getType()&&e.value){let t=e.dmuObject.getAssociatedHighlightData();for(let e=0;e<t.length;e++)Y.updateSlidePreview(t[e]),N&&N.fireEvent("onPreviewDeleteOnHighlightRequested",{elementId:t[e].id})}})),Pe.onUpdateImpactedChecksList=N.addEvent("onUpdateImpactedChecksList",(function(e){if("add"===e.mode)for(let t=0;t<e.checks.length;t++)te.addImpactedCheck({highlightRating:parseInt(e.highlight.getRating()),highlightTitle:e.highlight.getName(),highlightId:e.highlight.getPlmID(),checkId:e.checks[t].getPlmID(),checkStatus:parseInt(e.checks[t].getStatus()),checkTitle:e.checks[t].getName()}),Y.addImpactedCheck({highlightRating:parseInt(e.highlight.getRating()),highlightTitle:e.highlight.getName(),highlightId:e.highlight.getPlmID(),checkId:e.checks[t].getPlmID(),checkStatus:parseInt(e.checks[t].getStatus()),checkTitle:e.checks[t].getName()});else for(let t=0;t<e.checks.length;t++)te.removeImpactedCheck({highlightId:e.checks[t].highlightId,checkId:e.checks[t].checkId}),Y.removeImpactedCheck({highlightId:e.checks[t].highlightId,checkId:e.checks[t].checkId});Y.deactiveButtons()})),Pe.onReviewObjectAttributesModified=N.addEvent("onReviewObjectAttributesModified",(function(e){if(e&&e.object&&e.attr){const t=p.getRoots(d.getContextViewer({viewer:j.getViewer()})).length;if(e.attr[0]&&(e.attr[0].currentState||e.attr[0].sValidationState)&&e.object.getRestrictedEditionFlag&&"Activated"===e.object.getRestrictedEditionFlag()){if(X.setRestrictions(pt()),te&&te.setRestrictions(pt()),Y&&Y.setRestrictions(pt()),se.forEach((function(e){let t=We.get(e.id);t&&t.remove(),We.delete(e.id)})),t){X.updateValidatedList(oe.getValidated().getValidatedInstanceNames()),X.updateChangeActionList(oe.getValidated().getChangeActionName()),X.updatePanel();let e=X.getSectionHeader(),t=xt();e.setSubMenuCommands(t)}else X.updateReviewPanelContent({reviewNoContextMode:!0});if(te){te.updatePanel();let e=te.getSectionHeader(),t=Et();e.setSubMenuCommands(t)}if(Y)if(t){Y.updatePanel();let e=Y.getSectionHeader(),t=St();e.setSubMenuCommands(t)}else Y&&Y.updateReviewPanelContent({reviewNoContextMode:!0})}e.object.getValType&&"DMUValidationValidation"===e.object.getValType()&&e.attr.forEach((function(t){if(t.sValidationState&&Lt(e.object,X),t.sValidationState||t.currentState){t.currentState&&(de=t.currentState),ue&&(ue.destroy(),ue=null),X.setPanelQuickAccessCommands(Rt()),te&&te.setPanelQuickAccessCommands(Ut()),Y&&Y.setPanelQuickAccessCommands(Ot());let e=xt();X.getSectionHeader().setSubMenuCommands(e)}}))}})),Pe.setEditionMode=N.addEvent("setEditionMode",(function(e){A=e.editionMode,X.updateValidatedList(oe.getValidated().getValidatedInstanceNames()),X.updateChangeActionList(oe.getValidated().getChangeActionName()),X.setPanelReadOnlyFlag(e);var t=oe.getContext();te?te.setPanelReadOnlyFlag(e):e.editionMode&&t&&t.getJsonContexts().length&&Nt(),Y?Y.setPanelReadOnlyFlag(e):e.editionMode&&t&&t.getJsonContexts().length&&At(),J?J.setPanelReadOnlyFlag(e):e.editionMode&&t&&t.getJsonContexts().length&&Ft()})),Pe.onSetIssueCreationTypeRequested=N.addEvent("onSetIssueCreationTypeRequested",(function(e){z=e.type,localStorage.setItem("issueCreationType",e.type)})),Pe.onValidationObjectDeleted=N.addEvent("onValidationObjectDeleted",(function(e){if(e&&e.dmuObject&&e.dmuObject[0].getType&&"Markup"===e.dmuObject[0].getType())X&&X.removeMarkup(e);else if(e&&e.dmuObject[0]&&"DMUValidationExposedPresentation"===e.dmuObject[0].getType()){var t=e.dmuObject[0].getParent();if(t){var n,i=t.getRepRef(e.dmuObject[0].getAttribute("sRepRefMarkupID")),o=e.dmuObject[0].getPresentationSlideID(),r=t.getHighlights();for(let t=0;t<r.length;t++)if(r[t]!==e.dmuObject[0]&&r[t].getPresentationSlideID()===o){n=r[t];break}if(i){var a=i.getMarkupContent();if(a){var l,s=a.getSlides();for(let e=0;e<s.length;e++){if(s[e].getAttribute("sUuid")===o){l=s[e];break}if(s[e].getDMUObjects().length){var d=s[e].getDMUObjects();for(let e=0;e<d.length;e++){var u=d[e].getDMUComments?d[e].getDMUComments():[];if(u.length)for(let e=0;e<u.length;e++)if(u[e].getAttribute("sUuid")===o){l=u[e];break}}}}l&&n&&l.addAssociatedHighlightData({id:n.getPlmID(),rating:n.getRating(),hasIssue:Boolean(n._lIssuesIDs.length),hasTask:Boolean(n._lTasksIDs.length),hasImpactedChecks:Boolean((n.getAssociatedCheck()||[]).length)})}}}}})),Pe.tokenOnDropCA=N.addEvent("onDropCA",(function(e){var t=X.addChangeAction(e.changeName[0],e.changeIcon[0]);t.getMainDiv().setAdditionalDivVisibleFlag(!0),t.getMainDiv().setSelectedFlag(!0)})),Pe.tokenOnRemoveCA=N.addEvent("onRemoveCA",(function(){X.processChangeActionDeletion()})),Pe.tokenDMUValidatedCreated=N.addEvent("onReviewCtxUpdateOrDropValidated",(function(e){if((re=oe.getContext())&&re.getMainContextType()&&-1!==["Document","Specification Report","Requirement","Requirement Specification","Drawing","SIMItfSimulation","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_Activity","DELLmiWorkPlanSystemReference","DELLmiHeaderWorkPlanReference","DELLmiPPRHeaderProcessReferenceAbstract","FailureModesEffectsAnalysis"].indexOf(re.getMainContextType())){X.setContextType(re.getMainContextType());for(let i=0;i<e.validatedNames.length;i++){let o=re.getMainContextType();"R2V_Activity"!==o&&"Document"!==o&&"Specification Report"!==o&&"Drawing"!==o&&"DIFSheet"!==o&&"Requirement"!==o||X.setAddValidatedButtonVisibilityFlag(!0),"Requirement"!==t&&"R2V_Activity"!==o||X.setDropZoneVisibilityFlag(!1);var n=X.addValidatedObject(e.validatedNames[i],e.validatedIcons[i]);at({name:e.validatedNames[i],id:e.validatedId,path:e.validatedPaths[i]}),n.getMainDiv().setAdditionalDivVisibleFlag(!0),n.getMainDiv().setSelectedFlag(!0)}"Requirement"!==re.getMainContextType()&&"DesignSight"!==re.getMainContextType()&&"Requirement Specification"!==re.getMainContextType()&&"DIFLayout"!==re.getMainContextType()&&"DELLmiWorkPlanSystemReference"!==re.getMainContextType()&&"DELLmiHeaderWorkPlanReference"!==re.getMainContextType()&&"DELLmiPPRHeaderProcessReferenceAbstract"!==re.getMainContextType()&&N.removeEvent(Pe.tokenDMUValidatedCreated)}})),De=f.onPostRemove((function(){Ne&&!Le?(X.unSelectAllExpanders(Ie),te&&te.unSelectAllExpanders(Ie)):Ne||Le||Fe||(X.unSelectAllExpanders(Ie),te&&te.unSelectAllExpanders(Ie),Y&&Y.unSelectAllExpanders(Ie)),Fe=!1,f.get().length||(Ee=-1),ht()}))}this.addReview=function(){X||_t()},this.addCheck=function(e){h.empty(),k&&(e.evt=k,k=null),te&&te.addNewCheck(e),Lt(oe,X)},this.addHighlight=function(e){f.empty(),h.empty();var t=e.slideObject,n=[];if(Y){var i={_repRefMarkupId:e.repRefMarkupId,_slideID:t.getAttribute("sUuid")};if(Ae[e.id]=i,"DMUComment"===t.getType()){var o=M.giveDMUCommentsController({context:j});e.normalComment=o.getCommentRepresentation(t.getAttribute("sUuid"),"normal").getDiv(),e.lightComment=o.getCommentRepresentation(t.getAttribute("sUuid"),"light").getDiv();let i=t.getAttribute("sUuid");n=t.getReferencedCheckIds(),oe.getAllRepRefs().forEach((e=>{let t=e.getMarkupContent();if(t){let e=t.getComments();e&&e.forEach((e=>{if(i===e.getParentCommentId()){var t=e.getReferencedCheckIds();if(t.length)for(let e=0;e<t.length;e++)-1===n.indexOf(t[e])&&n.push(t[e])}}))}}))}var r=[],a=oe.getChecks();for(let e=0;e<n.length;e++)for(let t=0;t<a.length;t++)n[e]===a[t].getPlmID()&&r.push(n[e]);Y.addNewHighlight(e),r.length?(N.fireEvent("onSetImpCheckRequested",{highlightObject:e.highlightObject,checkObject:r}),N.addEvent("onImpactedChecksCmdEnd",(function(){N.fireEvent("onHighlightCreationCompleted",e)}))):N.fireEvent("onHighlightCreationCompleted",e)}},this.addMarkup=function(e){X&&X.addNewMarkup(e),qe.push(e)},this.editMarkupName=function(e){if(W&&X&&e&&e.getPlmID){let t;for(let n=0;n<qe.length;n++)if(qe[n].id===e.getPlmID()){t=e.getPlmID();break}t&&X.editMarkupName(t)}},this.subscribe=function(e,t){if(e&&t)return F.subscribe({event:e},t)},this.setVisibleFlag=function(e){B&&(W=e,G&&G.setPanelVisibilityFlag(W),Z&&Z.setPanelVisibilityFlag(W),ne&&ne.setPanelVisibilityFlag(W),$&&$.setPanelVisibilityFlag(W))},this.setEditionMode=function(e){A=e},this.clear=function(){if(N){var e=Object.keys(Pe);for(let t=0;t<e.length;t++)N.removeEvent(Pe[e[t]])}Pe={},this.setActiveFlag(!1)},this.setActiveFlag=function(e){if(e!==B&&!(B=e)){if(X){var t=Object.keys(xe);for(let e=0;e<t.length;e++)X.unsubscribe(xe[t[e]]);xe={},X.cleanPanel()}if(te){var n=Object.keys(Ue);for(let e=0;e<n.length;e++)te.unsubscribe(Ue[n[e]]);Ue={},te.cleanPanel()}if(Y){var i=Object.keys(Oe);for(let e=0;e<i.length;e++)Y.unsubscribe(Oe[i[e]]);Oe={},Y.cleanPanel()}J&&J.cleanPanel(),G&&(G.setPanelVisibilityFlag(!1),G.clean()),Z&&(Z.setPanelVisibilityFlag(!1),Z.clean()),ne&&(ne.setPanelVisibilityFlag(!1),ne.clean()),$&&($.setPanelVisibilityFlag(!1),$.clean()),f.unsubscribe(De),G=Z=ne=$=J=te=Y=X=null}},this.updateReviewPanelContent=function(e){X&&X.updateReviewPanelContent(e)},this.getRestrictions=function(e){return pt(e)}}}),R=[];return t.singleton({init:function(){},getDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<R.length;n++)if(R[n].context===e.context){R[n].counter++,t=R[n].reviewController;break}if(e&&e.context&&!t){var n=new I(e);t={addReview:function(){if(n)return n.addReview()},addCheck:function(e){if(n)return n.addCheck(e)},addMembers:function(e){if(n)return n.addMembers(e)},addMarkup:function(e){if(n)return n.addMarkup(e)},addHighlight:function(e){if(n)return n.addHighlight(e)},setVisibleFlag:function(e){if(n)return n.setVisibleFlag(e)},setEditionMode:function(e){if(n)return n.setEditionMode(e)},clear:function(){n&&n.clear()},editMarkupName:function(e){n&&n.editMarkupName(e)},updateReviewPanelContent:function(e){if(n)return n.updateReviewPanelContent(e)},getRestrictions:function(e){if(n)return n.getRestrictions(e)}},R.push({context:e.context,reviewController:t,counter:1})}return t?Object.freeze(t):t},giveDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<R.length;n++)if(R[n].context===e.context){t=R[n].reviewController;break}return t?Object.freeze(t):t},unreferenceDMUReviewController:function(e){if(e&&e.context)for(let t=0;t<R.length;t++)if(R[t].context===e.context){R[t].counter--,R[t].counter<=0&&(R[t].reviewController.clear(),R.splice(t,1));break}}})})),define("DS/DMUBaseUIControllers/DMUMarkupsController",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/CoreEvents/Events","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIControllers/DMUWebPreferencesController"],(function(e,t,n,i,o,r,a,l,s){"use strict";var d=t.extend({init:function(t){this._parent(t);var d,u,c=null,g=[],p=t.context.getExecutionContext?t.context.getViewer():t.context,m=null,f=null,h=null,v=null,C=null,D=!1,b="true"===localStorage.getItem("DMU3DMarkersResponsiveDisplay");function M(t){if(!c||D)return;if(!d){var n=p.getSceneGraphOverrideSetManager();n&&p.getRootNode().getChildByName("DMUReviewBag")&&(d=new i(p.getRootNode().getChildByName("DMUReviewBag")),n.pushSceneGraphOverrideSet(d))}let o=r.getReviewContext({viewer:p}),s=o?o.getCurrentSessionMarkup():null,u=s?s.getCurrentSlide():null;if(!u||!d)return;d&&d.deleteOverrides(d.getOverrides());let g=u.get3DMarkers(),m=u.get2DMarkers();if(u.getPointedFormats&&u.getPointedFormats().forEach((e=>{g=g.concat(e.get3DMarkers()),m=m.concat(e.get2DMarkers())})),g.length){let n=function(){let t=a.getViewpointInfo(p.currentViewpoint);var n=1;if(1===p.getVisibleSpace()&&C&&C.vViewpointPosition&&C.vViewpointSight&&C.fViewpointTargetDistance){let i=(new e.Vector3).addVectors(C.vViewpointPosition,C.vViewpointSight.clone().multiplyScalar(C.fViewpointTargetDistance)),o=t.position.distanceTo(i),r=C.fViewpointTargetDistance;n=r&&o>r?1-3*Math.abs(o-r)/o:1,(n=Math.max(n,0))>.5?n=1:n*=2,n=Math.round(10*n)/10}return n}(),i={};g.forEach((e=>{let o=!b||e.isInEdition()?1:n;if(e.getNode()._updateVisibility(o,t),o){i[o]||(i[o]={opacity:o,paths:[]});let t=e.getNode().getRepNode(),n=[],r=Object.keys(t);if(-1!==r.indexOf("box"))for(let i=0;i<r.length;i++)"box"===r[i]&&e.getNode().hasTessellatedRepresentation&&!e.getNode().hasTessellatedRepresentation()||n.push(t[r[i]]);else n.push(e.getNode());n.forEach((e=>{i[o].paths.push(l.buildPathElement(e))}))}}));let o=Object.keys(i);if(o.length){let e;for(let t=0;t<o.length;t++)1!==i[o[t]].opacity&&i[o[t]]&&i[o[t]].paths&&i[o[t]].paths.length&&(e=d.createOverride({pathes:i[o[t]].paths}),e&&e.setOpacity(i[o[t]].opacity))}}m&&m.length&&m.forEach((function(e){e.getNode().updateScreenPosition()})),p.render()}var y=function(e){if(g&&(!g||g.length)){var t,n=e.eventType||e.event,i=!1,o=!1,a=e;if("@onWindowResized"===n||"@onViewpointEndMove"===n||"@onViewpointBeginMove"===n||"@onPinchPanRotate"===n||"beginExplodeCmd"===n||"endExplodeCmd"===n||"onSwapVisibleSpace"===n||"onPreferenceModified"===n||"onDMUSlideStartDisplay"===n||"onDMUSlideDisplayed"===n)i=!0;else if("@onViewpointChange"===n&&e.viewpoint.isMoving()||"EXPEndProgressiveLoad"===n||"onRepresentationLoaded"===n)o=!0;else if("EXPHideShowEvent"===n&&(e&&e.occurrence||e.paths))if(i=!0,a={eventType:"onHideShow",flag:e.flag,paths:[]},e.occurrence){var l=r.getReviewContext({viewer:p});if(l){var s=l.getCurrentSessionMarkup(),d=s?s.getAttribute("oLinksManager"):null;if(d){var u=d.getOccurrencePathElement(e.occurrence.id);u&&a.paths.push(u.clone())}}}else if(e.areIdPaths)a.idPaths=a.paths.slice();else for(t=0;t<e.paths.length;t++)a.paths.push(e.paths[t].clone());if(("@onViewpointChange"===n&&e.viewpoint.isMoving()||"@onViewpointEndMove"===n||"onDMUSlideEnvironmentOverloadChanged"===n||"onSwapVisibleSpace"===n||"@onWindowResized"===n)&&M("@onViewpointChange"===n),i||o)for(t=0;t<g.length;t++)g[t]&&g[t].onViewerEventCB&&(i||o&&g[t].isDisplayed())&&g[t].onViewerEventCB(a)}};this.setResponsiveDisplayFlag=function(e){b=e,M()},this.getResponsiveDisplayFlag=function(){return b},this.setActiveState=function(e){if(e!==c){c=e;var t=r.giveEventsController({viewer:p}),i=r.getContextViewer({viewer:p});if(c){var a;if(v||(v=s.subscribe("onDMUWebpreferencesUpdate",(function(){y({eventType:"onPreferenceModified"})}))),t)(h={}).OnHideShow=t.addEvent(o.Events.EXPHideShowEvent,(function(e){e.eventType="EXPHideShowEvent",y(e)})),h.EndProgressiveLoad=t.addEvent(o.Events.EXPEndProgressiveLoad,(function(e){e.eventType="EXPEndProgressiveLoad",y(e)})),h.onDMUSlideEnvironmentOverloadChanged=t.addEvent("onDMUSlideEnvironmentOverloadChanged",(function(){let e=r.getReviewContext({viewer:p});e&&e.getEnvironment()&&(C=e.getEnvironment().getCurrentSlideEnvironmentInfo(),M())})),h.onDMUSlideStartDisplay=t.addEvent("onDMUSlideStartDisplay",(function(e){if(D=!0,e&&e.dmuObject){let t=e.dmuObject.get2DMarkers(),n=1;if(e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().forEach((e=>{t=t.concat(e.get2DMarkers())})),t&&t.length){let e;for(let i=0;i<t.length;i++)e=t[i].getMaximumProportionalWidth?t[i].getMaximumProportionalWidth():-1,e>n&&(n=e)}n>1&&t.forEach((function(e){e.setMaximalProportionalZoneWidth(n)}))}y({eventType:"onDMUSlideStartDisplay"})})),h.onDMUSlideDisplayed=t.addEvent("onDMUSlideDisplayed",(function(e){if(D=!1,C=null,y({eventType:"onDMUSlideDisplayed"}),e&&e.dmuObject){let e=r.getReviewContext({viewer:p});C=e.getEnvironment().getCurrentSlideEnvironmentInfo()}M()})),h.onDMUObjectEdited=t.addEvent("onDMUObjectEdited",(function(){a&&clearInterval(a),a=setTimeout((()=>{M(),a=null}))}));u=i.subscribe({event:"onRepresentationLoaded"},(function(){y({eventType:"onRepresentationLoaded"})})),m||((m={}).onVISUEvents=n.subscribe({event:"/VISU/"},y),m.onResize=n.subscribe({event:"/VISU/onWindowResized"},(function(){y({eventType:"@onWindowResized"})})),m.onExplodeStart=n.subscribe({event:"3DPLAY/EXPLODE/START"},(function(){y({eventType:"beginExplodeCmd"})})),m.onExplodeEnd=n.subscribe({event:"3DPLAY/EXPLODE/END"},(function(){y({eventType:"endExplodeCmd"})}))),f||(f=p.onSwapVisibleSpace((function(){y({eventType:"onSwapVisibleSpace"})})));let e=r.getReviewContext({viewer:p});e&&(C=e.getEnvironment().getCurrentSlideEnvironmentInfo())}else{let e,o;if(C=null,d&&(p.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(d),d=null),g.length=0,t&&h){for(e=Object.keys(h),o=0;o<e.length;o++)t.removeEvent(h[e[o]]);h=null}if(i.unsubscribe(u),v&&(s.unsubscribe(v),v=null),m){for(e=Object.keys(m),o=0;o<e.length;o++)n.unsubscribe(m[e[o]]);m=null}f&&(p.unsubscribe(f),f=null)}}},this.clear=function(){this.setActiveState(!1),g=p=null},this.registerMarker=function(e){g.push(e)},this.unregisterMarker=function(e){for(var t=g.length-1;t>=0;t--)if(g[t]===e){g.splice(t,1);break}}}}),u=[];return t.singleton({init:function(){},getDMUMarkupsController:function(e){if(e&&e.context){for(var t=!1,n=0;n<u.length;n++)if(u[n].context===e.context){u[n].counter++,t=!0;break}if(!t){var i=new d(e);i.setActiveState(!0),u.push({counter:1,context:e.context,markersController:i})}return this.giveDMUMarkupsController(e)}},giveDMUMarkupsController:function(e){if(e&&e.context){for(var t,n=0;n<u.length;n++)if(u[n].context===e.context){t=u[n].markersController;break}if(t)return Object.freeze({setResponsiveDisplayFlag:function(e){t&&t.setResponsiveDisplayFlag(e)},getResponsiveDisplayFlag:function(){return t?t.getResponsiveDisplayFlag():void 0},registerMarker:function(e){if(t)return t.registerMarker(e)},unregisterMarker:function(e){t&&t.unregisterMarker(e)}})}},unreferenceDMUMarkupsController:function(e){if(e&&e.context)for(var t=0;t<u.length;t++)if(u[t].context===e.context)return u[t].counter--,void(u[t].counter<=0&&(u[t].markersController&&u[t].markersController.clear(),u.splice(t,1)))}})})),define("DS/DMUBaseUIControllers/DMUReviewContextInitializer",["UWA/Class","UWA/Utils","DS/CATWebUXComponents/DMUCommandsManager","DS/CATWebUXComponents/DMUFrameWindow","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/DMUBaseExperience/DMUExperience","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUUserExperienceManager","DS/DMUBaseExperience/EXPManagerSet","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewController","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseExperience/EXPUtils","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIManipulators/DMUBaseRepManipulator","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseUIControllers/DMUReqCompareController","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUToolsClipping","DS/WebappsUtils/WebappsUtils","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],(function(e,t,n,i,o,r,a,l,s,d,u,c,g,p,m,f,h,v,C,D,b,M,y,w,S,E,x,U,O,P,I,R){"use strict";let A=e.extend({init:function(e){var i,d,U,A,k,T=e.context.getFrameWindow(),V=this,j=!1,F=[],N=!1,L=!0,B={},W={};let H;var q,_,z,X,G=u.getContextViewer({viewer:T.getViewer()}),K=u.giveEventsController({viewer:T.getViewer()}),J=null;let Z=null;var Q,Y,$,ee,te,ne,ie,oe,re,ae=null;let le,se,de,ue,ce=I.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/");g.addManager({name:"DMUUserExperienceManager",context:T,manager:new c({frmWindow:T})});let ge,pe=g.getManager({name:"DMU2DSheetManager",context:T}),me=pe&&pe.isADocumentDisplayed()&&pe.getDocumentType()||"3D";function fe(e){if(e&&e.completed)if(e.arrayPath){var t=X?X.getCommentTooltip(e.arrayPath[0].getLastElement(!0)):null;if(!(t||e.arrayPath&&1===e.arrayPath.length&&e.token&&e.arrayPath[0].getLastElement(!0).getTooltip))return void e.completed();e.completed({token:e.token,div:t||e.arrayPath[0].getLastElement(!0).getTooltip(),interactiveContent:!0})}else if(e.element&&_&&_.length){var n=_.findIndex((function(t){return t.div===e.element}));n>=0?e.completed({token:e.token,div:_[n].content,interactiveContent:!0}):e.completed()}else e.completed()}function he(e){for(var t=e;t&&t.getLastElement(!0).getPickParent();)t=t.getParentPath();return t}function ve(e){if(J&&e&&e.length){let n=0;for(var t=0;t<e.length;t++)"DMUSlide"!==e[t].getType()&&"DMUFormat"!==e[t].getType()||(e[t].getActiveFlag()&&!N&&"DMUSlide"===e[t].getType()||N&&"DMUFormat"===e[t].getType()?(J.addSlide(e[t],e[t].getAttribute("sParentSlideID")?n:null),e[t].getAttribute("sParentSlideID")||n++):J.removeSlide(e[t]))}}function Ce(t){if(J&&t&&t.dmuObject&&e.reviewContext&&e.reviewContext.getActiveFlag()){var n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup();if(n&&("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType())){let i=e.reviewContext.getValidation();i&&(t.mkpRepRef?t.dmuObject.parentID=t.mkpRepRef.getPlmID():t.dmuObject.parentID=i.getCurrentMarkup()?i.getCurrentMarkup().getRepRef().getPlmID():null),t.dmuObject.getActiveFlag()&&(!N&&"DMUSlide"===t.dmuObject.getType()||N&&"DMUFormat"===t.dmuObject.getType())?J.addSlide(t.dmuObject,function(e,t){if(e&&t)for(var n="DMUSlide"===e.getType()?t.getSlides():t.getFormats(),i=0;i<n.length;i++)if(n[i]===e)return i}(t.dmuObject,n),n):J.removeSlide(t.dmuObject)}}}function De(t){if(X&&t&&t.dmuObject&&(e.reviewContext&&e.reviewContext.getActiveFlag()&&(t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup())&&"DMUSlide"===t.dmuObject.getType())){let e=t.dmuObject.getDMUObjects("DMUComment");e.length&&e.forEach((e=>{t.dmuObject.getActiveFlag()&&!N?X.addCommentToPanel(e):X.removeCommentFromPanel(e)}))}}function be(){le&&clearTimeout(le),le=setTimeout((()=>{if(le=null,T){let e=T.getContextualUIManager();T.getExecutionContext||e._executionContext?setTimeout((function(){e._showContextualBar({hideWithDistance:!0,backMAB:function(){o.empty()}})}),100):e.showContextualBar({hideWithDistance:!0,backMAB:function(){o.empty()}})}}),100)}function Me(e){if(T){var t=T.getActionBar();t&&t.MAB&&!0===t.MAB.state.visible?l.publish({event:"/"+T.options.context+"/WUX/ContextualBar/Hide/"}):e||T.getContextualUIManager().getContextualBar().hide()}}var ye,we,Se,Ee;function xe(e){if(!T)return;let t=T.getViewer();t&&t.getCursor().contains("WebViewerRotate")&&(e&&void 0===e.handleType?t.canvas.setStyle("cursor","url("+ce+"DMUPositionCursorHL.png) 10 10, auto"):e&&"Center"===e.handleType?t.canvas.setStyle("cursor","move"):e&&"Rot"===e.handleType?t.canvas.setStyle("cursor","url("+ce+"DMURotationCursorSel.png) 16 16, auto"):t.canvas.setStyle("cursor","crosshair"))}function Ue(e){if(setTimeout((function(){xe(e)}),100),Q&&Q.length){oe||(oe=new y(T.getViewer())),e&&e.event&&e.event.from&&(de&&s.removeEventFromToken(de),de=s.addEvent(e.event.from[0].view,"onPrimaryPointerUpUnique",(()=>{null!=de&&(s.removeEventFromToken(de),de=null),oe.setTextSelectionFlag(!0),oe.setTouchPanActive(!0)}))),oe.setTextSelectionFlag(!1),oe.setTouchPanActive(!1);for(var t=0;t<Q.length;t++)"DMUMarker3DFreehand"!==Q[t].dmuObj.getType()&&(Q[t].manipulator?Q[t].manipulator.onBeginManipulateCB(e):Q[t].repManip&&Q[t].repManip.onBeginManipulateCB(e));ge&&ge.onBeginManipulateCB(e)}}function Oe(e){if(xe(e),Q&&Q.length&&oe){var t,n=e&&e.translationVector2D&&(!te||!te.length),i=e&&e.translationVector2D&&(e.ctrlKey||void 0===e.ctrlKey&&e.event&&e.event.from&&e.event.from.length&&e.event.from[0].event&&e.event.from[0].event.ctrlKey);oe.updateManipulationData(e);for(var o=0;o<Q.length;o++){var l=Q[o].dmuObj.getType();n&&"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&(te||(te=[]),t||(t=[]),"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&t.push(Q[o].dmuObj)),Q[o].manipulator?(Q[o].dmuObj.setGhostMode(i),"DMUMarker3DFreehand"!==Q[o].dmuObj.getType()&&(Q[o].manipulator.onManipulateCB(e),Y||Q[o].manipulator.setHandlesVisibility(!1))):Q[o].repManip&&Q[o].repManip.onManipulateCB(e)}if(ge&&(ge.onManipulateCB(e),Y||ge.setHandlesVisibility(!1)),n&&t&&t.length)oe.addToListener("Control",Oe),oe.activate(),g.getManager({name:"DMUUserExperienceManager",context:T}).duplicateDMUElements({elements:t,cb:function(e){e&&e.duplicatedElements&&(te=e.duplicatedElements.slice())}});if(i){if(!ee&&te&&te.length&&re){ee=!0,z&&z.setCursors({canvas:"copy",pages:"copy"});for(var s=0;s<te.length;s++)re.addChild(te[s].getNode())}}else if(ee&&te&&te.length&&re){z&&z.setCursors({canvas:"move",pages:"move"});for(var d=0;d<te.length;d++)re.removeChild(te[d].getNode());ee=!1}Y||(a.empty(),Y=r.get().slice(),r.empty(),X&&X.setGuidelineVisibility(!1)),Me(),T.getViewer().render()}}async function Pe(n){if(Q&&Q.length&&oe){if(null!=de&&(s.removeEventFromToken(de),de=null),oe.setTextSelectionFlag(!0),oe.setTouchPanActive(!0),oe.remove(),te&&te.length&&re){for(var i=0;i<te.length;i++)re.removeChild(te[i].getNode()),te[i].remove();te=null}if(ee){for(var o=e.reviewContext.getCurrentSessionMarkup(),a=g.getManager({name:"DMUUserExperienceManager",context:T}),l=[],d=0;d<Q.length;d++)"DMUMeasure"!==Q[d].dmuObj.getType()&&"DMUCommentPositioned"!==Q[d].dmuObj.getType()&&l.push(Q[d].dmuObj);l.length&&await a.duplicateDMUElements({elements:l,parent:o.getCurrentSlide(),cb:function(e){if(e&&e.duplicatedElements)for(var n=0;n<e.duplicatedElements.length;n++)e.duplicatedElements[n].setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:t.getUUID()}])}}),ee=!1}for(var u=0;u<Q.length;u++)Q[u].dmuObj.setGhostMode(!1),"DMUMarker3DFreehand"!==Q[u].dmuObj.getType()&&(Q[u].manipulator?(Q[u].manipulator.onEndManipulateCB(n),Q[u].manipulator.setHandlesVisibility(!0)):Q[u].repManip&&Q[u].repManip.onEndManipulateCB(n));ge&&(ge.setHandlesVisibility(!0),ge.onEndManipulateCB(n)),Y&&Y.length&&r.add(Y),Y=null,X&&X.setGuidelineVisibility(!0),be(),z&&z.restoreCursors()}}function Ie(){var e=D.checkIfCommandIsRunning(T.getViewer());if(e){var t=D.getCurrentCommand(T.getViewer());"measureCmdHdr"!==t&&"measure2DCmdHdr"!==t&&"measure3CmdHdr"!==t&&"measure2CmdHdr"!==t&&"thicknessCmdHdr"!==t&&"sectionCmdHdr"!==t&&"section2CmdHdr"!==t||(e=!1)}return e}function Re(t){if(t){if(!re)for(var n=T.getViewer().getNodes(),i=0;i<n.length;i++)if("DecorationBag"===n[i].name){re=n[i];break}require(["DS/DMUMarkerManipulators/DMUMarkerRecManipulator","DS/DMUMarkerManipulators/DMUMarkerLineManipulator","DS/DMUMarkerManipulators/DMUMarkerFreehandManipulator","DS/DMUMarkerManipulators/DMUMarkerCircleManipulator","DS/DMUMarkerManipulators/DMUMarkerArrowManipulator","DS/DMUMarkerManipulators/DMUMarkerLabelManipulator","DS/DMUMarkerManipulators/DMUMarkerCloudManipulator"],(function(t,n,i,o,r,a,l){Se=function(s){if(s){Ee&&(clearTimeout(Ee),Ee=null);var d=[];if(0===(d=s.filter((function(e){return e.getType().includes("Marker")||"DMUMeasure"===e.getType()||"DMUCommentPositioned"===e.getType()}))).length){if(Q&&Q.length){for(var u=0;u<Q.length;u++){if(Q[u].manipulator&&"DMUMarker3DFreehand"!==Q[u].dmuObj.getType()&&Q[u].manipulator.remove(),Q[u].repManipTokens&&Q[u].repManipTokens.length)for(var c=0;c<Q[u].repManipTokens.length;c++)Q[u].repManip.unsubscribe(Q[u].repManipTokens[c]);Q[u]=null}ge&&(ge.remove(),ge=null),Q=null,$&&K&&(ne&&ne.destroy(),K.fireEvent("onSaveRequested"),$=!1)}}else{var g=function(){var s=[];if(Q||(Q=[]),d.forEach((function(d){var u=Q.findIndex((function(e){return e.dmuObj.getNode().id===d.getNode().id}));-1===u?(!function(s){var d=s.getType();const u=s.getParent(),c=e.reviewContext.getRestrictions(u);if(!Ie()&&!s.isReadOnly()&&s.isEditable()&&s.getAttribute("bVisible")&&(c.markup.canEdit||c.reply.canEdit)){var g,p=s.getNode().getRepManipulator();p&&("DMUMarker3DRectangle"===d||"DMUMarker3DEllipse"===d||"DMUMarker3DSpline"===d?(g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)],manipulator:new t({viewer:T.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:Oe,onEndManipulateCB:Pe})},Q.push(g)):"DMUMarker3DCircle"===d?(g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)],manipulator:new o({viewer:T.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:Oe,onEndManipulateCB:Pe})},Q.push(g)):"DMUMarker3DLine"===d?(g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)],manipulator:new n({viewer:T.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:Oe,onEndManipulateCB:Pe})},Q.push(g)):"DMUMarker3DFreehand"===d?(ge?ge.registerMarker(s):ge=new i({viewer:T.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:Oe,onEndManipulateCB:Pe}),g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)],manipulator:ge},Q.push(g)):"DMUMarker3DCloud"===d?(g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)],manipulator:new l({viewer:T.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:Oe,onEndManipulateCB:Pe})},Q.push(g)):"DMUMarker3DArrow"===d?(g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)],manipulator:new r({viewer:T.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:Oe,onEndManipulateCB:Pe})},Q.push(g)):"DMUMarker2DText"===d||"DMUMarker3DStamp"===d||"DMUMarker3DText"===d||"DMUMarker2DPicture"===d||"DMUMarker3DPicture"===d||"DMUMeasure"===d?(g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)],manipulator:new a({viewer:T.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:Oe,onEndManipulateCB:Pe})},Q.push(g)):"DMUCommentPositioned"===d&&(g={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",Oe),p.subscribe("onMarkerRepEndManipulate",Pe)]},Q.push(g)))}}(d),s.push(Q.length-1)):s.push(u)})),s.length!==Q.length){for(var u=0;u<Q.length;u++)if(!s.includes(u)){if(Q[u].manipulator&&("DMUMarker3DFreehand"===Q[u].dmuObj.getType()?Q[u].manipulator.unregisterMarker(Q[u].dmuObj):Q[u].manipulator.remove()),Q[u].repManipTokens&&Q[u].repManipTokens.length)for(var c=0;c<Q[u].repManipTokens.length;c++)Q[u].repManip.unsubscribe(Q[u].repManipTokens[c]);Q[u]=void 0}ge&&!ge.registeredMarkersLength()&&(ge.remove(),ge=null),Q.sort(),Q=Q.slice(0,s.length)}};Ie()?Ee=setTimeout(g):g()}}}}))}else Se=function(e){if(e){Ee&&(clearTimeout(Ee),Ee=null);var t=[];if(0===(t=e.filter((function(e){return"DMUMeasure"===e.getType()}))).length){if(Q&&Q.length){for(var n=0;n<Q.length;n++){if(Q[n].repManipTokens&&Q[n].repManipTokens.length)for(var i=0;i<Q[n].repManipTokens.length;i++)Q[n].repManip.unsubscribe(Q[n].repManipTokens[i]);Q[n]=null}Q=null}}else{var o=function(){Q||(Q=[]);var e=[];if(t.forEach((function(t){var n=Q.findIndex((function(e){return e.dmuObj.getNode().id===t.getNode().id}));-1===n?(!function(e){if(!Ie()&&!e.isReadOnly()&&e.isEditable()&&e.getAttribute("bVisible")){var t,n=e.getNode().getRepManipulator();n&&(t={dmuObj:e,repManip:n,repManipTokens:[n.subscribe("onMarkerRepBegingManipulate",Ue),n.subscribe("onMarkerRepManipulate",Oe),n.subscribe("onMarkerRepEndManipulate",Pe)]},Q.push(t))}}(t),e.push(Q.length-1)):e.push(n)})),e.length!==Q.length){for(var n=0;n<Q.length;n++)if(!e.includes(n)){if(Q[n].repManipTokens&&Q[n].repManipTokens.length)for(var i=0;i<Q[n].repManipTokens.length;i++)Q[n].repManip.unsubscribe(Q[n].repManipTokens[i]);Q[n]=void 0}Q.sort(),Q=Q.slice(0,e.length)}};Ie()?Ee=setTimeout(o):o()}}}}function Ae(){var t,n,i,a=F.slice(),l=[];if(F.forEach((function(e){e.setInEdition(!1),"DMUSection"!==e.getType()&&"DMUClipping"!==e.getType()||ie&&e.isManipulationOnGo&&!e.isManipulationOnGo()&&ie.destroy()})),F.length=0,e.reviewContext){var s,d,u=function(e,t,n){for(var i,o=0;o<l.length;o++)if(l[o].path.isEqual(e)){i=l[o];break}i||(i={path:e.clone(),counter:1,dmuObj:t},l.push(i)),i.counter=i.counter+(n?1:-1)},c=o.get(),p=[],m=[],f=[],h=[],v=e.reviewContext.getCurrentSessionMarkup();for(n=0;n<c.length;n++){if(d=e.reviewContext.getDMUObjectFromPathElement(c[n].pathElement))"DMUSlide"===d.getType()||"DMUFormat"===d.getType()?(p.push(d),h.push(c[n])):m.push(c[n]),-1===F.indexOf(d)&&F.push(d),d.setInEdition(!0);else{if(!(v?v.getOrCreateOccurrenceOverloader(c[n]):null))continue;f.push(c[n])}p.length&&c.length>1&&n===c.length-1&&(s=p[p.length-1]===d?m.concat(f):h)}var C=F.length!==a.length;if(!C)for(n=0;n<F.length;n++)if(-1===a.indexOf(F[n])){C=!0;break}if(s&&s.length)o.remove(s);else{F.forEach((function(n){for("DMUSection"!==n.getType()&&"DMUClipping"!==n.getType()||n.refreshNode(),t=function(t){var n=[];if(!t)return n;t.getPathElement&&n.push(t.getPathElement());var i=t.getPointedReferences?t.getPointedReferences():[];if(i&&i.length&&e.reviewContext){var o=e.reviewContext.getCurrentSessionMarkup();if(!o&&t.getType&&"DMUMeasure"===t.getType()&&(o=e.reviewContext.getTransientReviewBag()),o){var r=o.getAttribute("oLinksManager");if(r)for(var a=0;a<i.length;a++)if("null"!==i[a]){var l=r.getOccurrencePathElement(i[a]);l&&n.push(l)}}}return n}(n),i=0;i<t.length;i++)u(t[i],n,!0)}));var D=g.getManager({name:"DMUUserExperienceManager",context:T});if(D&&D.refreshCCPCommandsAvailability(),J&&J.updateSelectedSlides(p.concat([])),Se&&Se(F),C){Me(!0),be();var b=[],M=[];l.forEach((function(e){e.counter>0&&b.push({pathElement:e.path})})),c.length?(r.get().forEach((function(e){if(!o.isIn(e)){for(var t=0;t<b.length;t++)if(b[t].pathElement.isEqual(e.pathElement))return;M.push(e)}})),r.remove(M)):r.empty(),r.add(b),T.getViewer().render()}}}}function ke(e){if(e&&e.pathElement){var t=e.pathElement.getLastElement(!0);t&&t.processPathForTrimedText&&(e=t.processPathForTrimedText(e))}return e}function Te(t){const n="DMUSlide"===t.getType(),i=e.reviewContext.getValidation();if(i){let e,t;i.getMarkups().some((i=>{let o=i.getRepRef();if(o){const i=o.getMarkupContent();if(i){const o=i.getSlides();if(o&&o.length)return n?(e=i,t=o.find((e=>!e.getAttribute("bMarkedAsDeleted"))),!0):o.some((n=>n.getDMUObjects().some((n=>{const o=n.getDMUComments();if(o&&o.length)return e=i,t=o.find((e=>!e.getAttribute("bMarkedAsDeleted"))),!0}))))}}})),e&&t?V.registerElementIdAsPreview(t.getAttribute("sUuid"),e):V.registerElementIdAsPreview(null)}else{const t=e.reviewContext.getCurrentSessionMarkup();if(t&&t.getActiveFlag()){const e=t.getSlides();let i;e&&e.length?n?V.registerElementIdAsPreview(e[0].getAttribute("sUuid"),t):e.some((e=>e.getDMUObjects().some((e=>{const t=e.getDMUComments();if(t&&t.length)return i=t[0],!0}))))?V.registerElementIdAsPreview(i.getAttribute("sUuid"),t):V.registerElementIdAsPreview(null):V.registerElementIdAsPreview(null)}}}Re(-1!==u.getAuthoringFeatureTypes().indexOf("Marker")),this.getMarkupVisualizationActiveState=()=>L,this.setMarkupVisualizationActiveState=function(t){let n;const i=e.reviewContext.getCurrentSessionMarkup();i&&(n=i.getApplicativeContext());const r=u.getEventsController({viewer:G.getViewer()});function a(){if(L!==t&&(L=t,e.reviewContext.getVisibleMarkups().forEach((function(e){if(e){e.setVisibleFlag(L),e.refreshNode(),T.getViewer().render(),require([].concat(["DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd"]),(e=>{e&&e.updateGridCommandState()}));let t=P.getClippingCmdService();t&&t.updateClippingCommandState({contextViewer:u.getContextViewer({viewer:T.getViewer()}),reviewContext:u.getReviewContext({viewer:T.getViewer()})}),J.setPanelActiveFlag(L)}})),!L&&F&&F.length)){let t=[];o.get().forEach((function(n){e.reviewContext.getDMUObjectFromPathElement(n.pathElement)&&t.push(n)})),t.length&&o.remove(t)}r.fireEvent("onMarkupVisualizationActiveState",{markupVisualizationActiveState:L})}if(n&&n.PIM){require([{isr:"DS/PIMwebViewController/PIMwebItfCtrl"}.isr],(function(e){t?(r.fireEvent("onDMUMarkupApplicativeContextLoadBegin"),e.loadApplicativeContext(n.PIM,G).then((()=>{r.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!0}),a()}))):e.cleanApplicativeContext(n.PIM,G).then((()=>{r.fireEvent("onDMUMarkupApplicativeContextCleaned"),a()}))}))}else r.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!1}),a()},this.setFormatEditionModeFlag=function(t){if(J&&e.reviewContext){o.empty();var n=e.reviewContext.getCurrentSessionMarkup(),i=n&&n.getCurrentSlide?n.getCurrentSlide():null;N=t;let l=e.reviewContext.getValidation(),s=l?l.getAllRepRefs():[],d=[];s.length?s.forEach((e=>{e.getMarkupContent()&&d.push(e.getMarkupContent())})):d.push(n);let u=[],c=[];if(d.forEach((e=>{c=c.concat(e.getFormats()),u=u.concat(e.getSlides())})),l&&l.getCurrentMarkup()&&"Reply"===l.getCurrentMarkup().getAttribute("sValType")){let e=l.getCurrentMarkup();for(;e&&"Markup"!==e.getValType();)e=e.getParentRepRef().getParent();e&&"Markup"===e.getAttribute("sValType")&&(e=e.getRepRef()),l.setCurrentMarkup(e)}if(N)for(let e=0;e<c.length;e++)c[e].setReadOnly(!1,!0);J.setPanelOptions({panelTitle:N?R.formatPanelTitle:void 0,noSlideLabel:N?R.noFormatLabel:void 0,createSlideLabel:N?R.createFormatLabel:void 0,editingFormats:N});var r=q||n.getCurrentSlide();r||(r=N?c[0]:u[0]),q=i,ve(N?c:u),ve(N?u:c),a=u,X&&a&&a.length&&e.reviewContext&&e.reviewContext.getActiveFlag()&&a.forEach((e=>{if("DMUSlide"===e.getType()){let t=e.getDMUObjects("DMUComment");t.length&&t.forEach((t=>{e.getActiveFlag()&&!N?X.addCommentToPanel(t):X.removeCommentFromPanel(t)}))}})),J.setActiveSlide(r,{duration:0}),q&&(q.refreshNode(),"DMUSlide"===q.getType()&&q.getPointedFormats().length&&-1!==q.getPointedFormats().indexOf(r)&&(r.setDisplayedFlag(!0),r.setReadOnly(!1),r.refreshNode()),T.getViewer().render())}var a},this.getFormatEditionModeFlag=function(){return N},this.setReadOnly=function(e){e&&U&&(U.clean(),U=null),C.setSlidePreferences({context:T,preferences:{playMode:e}}),J&&J.setPanelOptions({playMode:e}),Re(!e)},this.registerElementIdAsPreview=(e,t,n)=>{if(!require("DS/PADUtils/PADUtilsServices").isCloud())return;const i=!t||!t.isImporting();if("Document"===me||"Specification Report"===me||"PDF"===me||"Requirement Specification"===me||"Requirement"===me){let t=f.giveDMUCommentsController({context:T});t&&t.setCommentAsPreview(e,n,i)}else{let t=m.giveDMUSlidesController({context:T});t&&t.setSlideAsPreview(e,i)}ue&&ue.getAttribute("sPreviewElementUuid")!==e&&ue.setAttribute("sPreviewElementUuid",void 0),t&&!t.isImporting()&&t.setAttribute("sPreviewElementUuid",e),ue=t,K.fireEvent("onSaveRequested")},this.isAPreviewRegistered=()=>Boolean(ue),this.getSelectedObjects=function(){return F},this.remove=function(){if(V.setActiveFlag(!1),U&&U.clean(),g.removeManager({name:"DMUUserExperienceManager",context:T}),p.unreferenceTooltipManager(e),ne&&(ne.destroy(),ne=null),ie&&(ie.destroy(),ie=null),te&&te.length)for(var t=0;t<te.length;t++)T.getViewer().removeNode(te[t].getNode());oe&&oe.remove(),te=Q=Y=$=ee=null,F=null,K=null,q=null,oe=T=null,d=null,U=null},this.setActiveFlag=function(t){let r=!1,s="SlideReorder",c=!0,D=!0,y="0.001",I=!0,F="1.5708",L="highlightTypeIssue";if(C.setSlidePreferences({context:T,preferences:{displaySlideTitle:r,slideDragAndDropOperation:s,slideNameFromfeature:c}}),x.readPreferences([{Repository:"DMURepository",PreferenceNames:["DisplaySlideTitle","SlideDragAndDropOperation","SlideNameFromFeature","SnapHandlesToGrid","SnapHandlesGridValue","SnapRotationToggle","SnapRotationAngle","defaultHighlightType"]}]).then((function(e){let t=e.repositories[0].preferences;for(let e=0;e<t.length;e++)"DisplaySlideTitle"===t[e].name?r="true"===t[e].value:"SlideDragAndDropOperation"===t[e].name?s=t[e].value:"SlideNameFromFeature"===t[e].name?c="true"===t[e].value:"SnapHandlesToGrid"===t[e].name?D="true"===t[e].value:"SnapHandlesGridValue"===t[e].name?y=t[e].value:"SnapRotationToggle"===t[e].name?I="true"===t[e].value:"SnapRotationAngle"===t[e].name?F=t[e].value:"defaultHighlightType"===t[e].name&&(L=t[e].value);C.setSlidePreferences({context:T,preferences:{displaySlideTitle:r,slideDragAndDropOperation:s,slideNameFromfeature:c,highlightPreference:L}}),O.setManipulationPrefs({snapHandlesToGrid:D,snapHandlesGridValue:y,snapRotationToggle:I,snapRotationAngle:F})})).catch((function(e){window.console.warn("Could not get server value, default value set instead.",e)})),j!==t){if(j=t)J=m.getDMUSlidesController({context:T,commandContext:G.getCommandContext()}),X=f.getDMUCommentsController({context:T,commandContext:G.getCommandContext()}),ae=h.getDMUReviewController({context:T,commandContext:G.getCommandContext()}),e.reviewContext.setRestrictions(ae.getRestrictions),z=v.getDMUCursorsController({context:T,commandContext:G.getCommandContext()}),Z=E.getPreferenceManager({context:G.getFrameWindow()}),J.setActiveFlag(!0),w.getDMUSceneDisplayController({context:G}),S.getReqCompareController({context:G}),W.onDMUObjectCreated=K.addEvent("onDMUObjectCreated",(function(e){e.dmuObject&&"DMUFormat"===e.dmuObject.getType()&&e.dmuObject.setReadOnly(!N)})),W.onDMUObjectInitialized=K.addEvent("onDMUObjectInitialized",(function(t){if(t&&t.dmuObject){var n,i,o;if("DMUMarkup"===t.dmuObject.getType()&&t.dmuObject.getAttribute("sPreviewElementUuid"))V.registerElementIdAsPreview(t.dmuObject.getAttribute("sPreviewElementUuid"),t.dmuObject);else if("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType()){t.dmuObject.setDisplayedFlag(!1),U&&U.hide();let e=g.getManager({name:"DMU2DSheetManager",context:T});"DMUSlide"!==t.dmuObject.getType()||ue||e&&e.isADocumentDisplayed()||V.registerElementIdAsPreview(t.dmuObject.getAttribute("sUuid"),t.dmuObject.getParent())}else if("DMUSection"===t.dmuObject.getType()||"DMUClipping"===t.dmuObject.getType()){if(e.reviewContext&&(n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&n.isVisible()){var r=n.getCurrentSlide();r&&"DMUSlide"===r.getType()&&(r.refreshNode(),T.getViewer().render())}}else if("DMUValidationValidation"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),J&&i){var a=i.getAllRepRefs();let e=[],n=[];for(var l=0;l<a.length;l++){var s=(o=a[l]).getParent().getValType();"Markup"===s?e.push({title:o.getParent().getName(),content:o,id:o.getPlmID()}):"Reply"===s&&n.push({title:o.getParent().getName(),content:o,id:o.getPlmID(),parentID:o.getParentRepRef().getPlmID()})}e.forEach((e=>{t.dmuObject.getModifyAccessFlag()||e.content.setReadOnly(!0),J.addMarkup(e),X&&X.addMarkup(e)})),n.forEach((e=>{J.addReply(e)}))}if(ae&&i){ae.setEditionMode(t.editionMode&&t.dmuObject.getModifyAccessFlag());var d=pe&&("Document"===pe.getDocumentType()||"Requirement"===pe.getDocumentType());i.enableMultipleMarkupVisibility(d),ae.addReview(),se&&ae.updateReviewPanelContent({reviewNoContextMode:!0}),J&&!d&&J.forcePanelVisibility()}}else if("ReviewMarkup"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),o=t.dmuObject,ae.addMarkup({title:o.getParent().getName(),content:o,id:o.getPlmID()}),J&&i){var u=o.getParent();"Markup"===u.getType()?(J.addMarkup({title:o.getParent().getName(),content:o,id:o.getPlmID()}),X&&(X.addMarkup({title:o.getParent().getName(),content:o,id:o.getPlmID()}),se&&X.setVisibleFlag(!1))):"Reply"===u.getType()&&J.addReply({title:o.getParent().getName(),content:o,id:o.getPlmID(),parentID:o.getParentRepRef().getPlmID()})}}else if("DMUValidationCheck"===t.dmuObject.getType()){var c=t.dmuObject;ae&&ae.addCheck({id:c.getPlmID(),name:c.getName(),status:c.getStatus(),description:c.getDescription(),requirements:c.getJsonRequirements()?c.getJsonRequirements():[]})}else if("DMUValidationExposedPresentation"===t.dmuObject.getType()){var p=t.dmuObject;ae&&ae.addHighlight({repRefMarkupId:t.dmuObject.getAttribute("sRepRefMarkupID"),slideObject:t.slideObject,id:p.getPlmID(),name:p.getName(),rating:p.getRating(),description:p.getDescription(),issues:[],tasks:[],changeAction:[],highlightObject:p,index:e.reviewContext.getValidation().getHighlights().length-1})}else if("DMUComment"!==t.dmuObject.getType()||ue){var m=t.dmuObject.getType();!m.includes("DMUMarker")&&"DMUMeasure"!==m&&"DMUCommentPositioned"!==m||"DMUMarker3DPoint"===m||"DMUMarker2DPoint"===m||"DMUCommentHighlight"===m||t.dmuObject.getNode().setRepManipulator(new M(t.dmuObject)),e.reviewContext&&(n=e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&!n.isImporting()&&(t.dmuObject.refreshNode(),T.getViewer().render())}else V.registerElementIdAsPreview(t.dmuObject.getAttribute("sUuid"),t.dmuObject.getParent());Ce(t),De(t)}})),W.onDMUObjectVisuRefreshRequired=K.addEvent("onDMUObjectVisuRefreshRequired",(function(e){e&&e.dmuObject&&(e.dmuObject.refreshNode(),T.getViewer().render())})),W.onDMUObjectDeleted=K.addEvent("onDMUObjectDeleted",(function(t){if(t&&t.dmuObject)if("DMUSection"===t.dmuObject.getType()||"DMUClipping"===t.dmuObject.getType()){if(e.reviewContext){var n=e.reviewContext.getCurrentSessionMarkup();if(n){var i=n.getCurrentSlide();i&&"DMUSlide"===i.getType()&&(i.refreshNode(),T.getViewer().render())}}}else ue&&("DMUSlide"===t.dmuObject.getType()||"DMUComment"===t.dmuObject.getType())&&t.dmuObject.getParent()===ue&&e.reviewContext&&t.dmuObject.isPreview()&&Te(t.dmuObject)})),W.onDMUObjectActiveFlagChanged=K.addEvent("onDMUObjectActiveFlagChanged",(function(e){Ce(e),De(e),e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.flag?J&&e.dmuObject.getCurrentSlide()&&J.setActiveSlide(e.dmuObject.getCurrentSlide()):U&&(U.clean(),U=null),e.dmuObject.refreshNode(),T.getViewer().render())})),W.onDMUObjectVisibleFlagChanged=K.addEvent("onDMUObjectVisibleFlagChanged",(function(t){t&&t.dmuObject===e.reviewContext.getCurrentSessionMarkup()&&V.setMarkupVisualizationActiveState(t.flag)})),W.onDMUObjectAttributeModified=K.addEvent("onDMUObjectAttributeModified",(function(t){if(t&&"bShortDisplay"===t.attrName&&Q&&Q.length){var i=Q.findIndex((function(e){return e.dmuObj.getNode().id===t.dmuObject.getNode().id}));i>=0&&setTimeout((function(){Q[i].manipulator&&(Q[i].manipulator.updateHandlePosition(),T.getViewer().render())}))}(!N&&"DMUSlide"===t.dmuObject.getType()||N&&"DMUFormat"===t.dmuObject.getType())&&J&&t.dmuObject.getActiveFlag()&&t.dmuObject.isVisible()&&J.updateSlide(t.dmuObject),t&&t.dmuObject&&"DMUComment"===t.dmuObject.getType()&&"sTextContents"===t.attrName&&t.value&&K.fireEvent("onSaveRequested"),t&&t.dmuObject&&"3DGrid"===t.dmuObject.getType()&&"vBBMin"!==t.attrName&&"vBBMax"!==t.attrName&&K.fireEvent("onSaveRequested"),t&&t.dmuObject&&("DMUClipping"===t.dmuObject.getType()||"DMUSection"===t.dmuObject.getType())?function(t){if(t&&t.dmuObject&&(!t.dmuObject.isManipulationOnGo||!t.dmuObject.isManipulationOnGo())){var n=t.dmuObject.getType(),i=t.dmuObject,o=e.reviewContext.getCurrentSessionMarkup(),r=P.getEditCmd(G),a=function(){r&&r.isRunning()&&o&&o.getActiveFlag()&&o.isVisible()&&!o.isReadOnly()&&i&&i.isManipulationOnGo&&!i.isManipulationOnGo()&&("DMUClipping"!==n&&"DMUSeciton"!==n||(ie||(ie=new b),ie.display({frmWindow:G.getFrameWindow(),label:R.saveMarkup,type:"button",onClick:function(){ie.destroy(),$=!1,K.fireEvent("onSaveRequested")}}),$=!0))};r&&(we&&(clearTimeout(we),we=null),r.isRunning()?a():we=setTimeout(a))}}(t):function(t){if(t&&t.dmuObject&&Q&&Q.length){var i,o=t.dmuObject.getParent();i=o&&o.getType().includes("DMUMarker")?o.getNode():t.dmuObject.getNode();var r=e.reviewContext.getCurrentSessionMarkup(),a=n.getCommand("DMU3ReviewWidgetDefaultHdr",G.getCommandContext())||n.getCommand("DMUReviewWebAppDefaultHdr",G.getCommandContext())||n.getCommand("DMUValidationWebAppDefaultHdr",G.getCommandContext()),l=function(){(!a||a.isRunning())&&r&&r.getActiveFlag()&&r.isVisible()&&i&&Q&&Q.length&&-1!==Q.findIndex((function(e){var t=e.dmuObj.getNode();return t&&t.id===i.id}))&&(ne||(ne=new b),ne.display({frmWindow:G.getFrameWindow(),label:R.saveMarkup,type:"button",onClick:function(){ne.destroy(),$=!1,K.fireEvent("onSaveRequested")}}),$=!0)};a&&(ye&&(clearTimeout(ye),ye=null),a.isRunning()?l():ye=setTimeout(l))}}(t),t&&"bMarkedAsDeleted"===t.attrName&&t.dmuObject&&("DMUSlide"===t.dmuObject.getType()||"DMUComment"===t.dmuObject.getType())&&(t.dmuObject.getParent()===ue&&Te(t.dmuObject),K.fireEvent("onSaveRequested"))})),W.onDMUObjectReadOnlyFlagChanged=K.addEvent("onDMUObjectReadOnlyFlagChanged",(function(e){e&&e.dmuObject&&(!N&&"DMUSlide"===e.dmuObject.getType()||N&&"DMUFormat"===e.dmuObject.getType())&&J&&J.updateSlideEditableFlag(e.dmuObject)})),W.onDMUSlideDisplayed=K.addEvent("onDMUSlideDisplayed",(function(){U&&U.hide()})),W.onLoadingReviewContext=K.addEvent("onLoadedReviewContext",(function(t){if(me=t.rootType,"Document"===t.rootType||"Specification Report"===t.rootType||"PDF"===t.rootType||"Requirement Specification"===t.rootType||"Requirement"===t.rootType||"FailureModesEffectsAnalysis"===t.rootType){J&&J.setVisibleFlag(!1);const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!0)}if("DXF"===t.rootType||"DWG"===t.rootType){J&&J.setVisibleFlag(!0),X&&X.setVisibleFlag(!0);const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!1)}})),W.on2DDocumentLoadSuccess=K.addEvent("on2DDocumentLoadSuccess",(e=>{if(e&&"Document"===e.type){me=e.type;var t=u.getReviewContext({viewer:T.getViewer()}),n=t?t.getValidation():null;n&&n.getMarkups().forEach((e=>{let t=e.getRepRef();t&&t.getMarkupContent()&&t.getMarkupContent().refreshNode()}))}})),W.onReviewNoContextModeOn=K.addEvent("reviewNoContextModeOn",(function(e){se=!0,X&&X.setVisibleFlag(!1),J&&J.setVisibleFlag(!1),ae.updateReviewPanelContent({reviewNoContextMode:!0}),e&&e.markups&&e.markups.forEach((e=>{ae.addMarkup({title:e.getName(),content:e,id:e.getPlmID()})}))})),W.onReviewNoContextModeOff=K.addEvent("reviewNoContextModeOff",(function(e){se=!1;let t=e.rootType;!X||"PDF"!==t&&"Requirement"!==t&&"Requirement Specification"!==t?"DXF"===t||"DWG"===t?X.setVisibleFlag(!1):"Document"!==t&&J&&(J.setVisibleFlag(!0),X&&(f.unreferenceDMUCommentsController({context:T}),X=null)):X.setVisibleFlag(!0),ae&&ae.updateReviewPanelContent({reviewNoContextMode:!1,rootType:t})})),Z&&(H=Z.subscribe("com.ds.mep:onPrefUpdate",(function(e){let t={},n={},i=JSON.parse(e[1].preferences);for(let e=0;e<i.repositories.length;e++)if("DMURepository"===i.repositories[e].name)for(let o=0;o<i.repositories[e].preferences.length;o++)"DisplaySlideTitle"===i.repositories[e].preferences[o].name?t.displaySlideTitle="true"===i.repositories[e].preferences[o].value:"SlideDragAndDropOperation"===i.repositories[e].preferences[o].name?t.slideDragAndDropOperation=i.repositories[e].preferences[o].value:"SlideNameFromFeature"===i.repositories[e].preferences[o].name?t.slideNameFromfeature="true"===i.repositories[e].preferences[o].value:"defaultHighlightType"===i.repositories[e].preferences[o].name?t.highlightPreference=i.repositories[e].preferences[o].value:"SnapHandlesToGrid"===i.repositories[e].preferences[o].name?n.snapHandlesToGrid="true"===i.repositories[e].preferences[o].value:"SnapHandlesGridValue"===i.repositories[e].preferences[o].name?n.snapHandlesGridValue=i.repositories[e].preferences[o].value:"SnapRotationToggle"===i.repositories[e].preferences[o].name?n.snapRotationToggle="true"===i.repositories[e].preferences[o].value:"SnapRotationAngle"===i.repositories[e].preferences[o].name&&(n.snapRotationAngle=i.repositories[e].preferences[o].value);C.setSlidePreferences({context:T,preferences:t}),O.setManipulationPrefs(n)}))),d=p.getTooltipManager(e),i=d.register({onTooltipReady:fe,filterPath:he}),pe=g.getManager({name:"DMU2DSheetManager",context:T}),pe&&(_=pe.getPDFHyperlinks())&&_.length&&d.registerElements(_.reduce((function(e,t){return e.concat(t.div)}),[])),B.onPostAdd=o.onPostAdd(Ae),B.onPostRemove=o.onPostRemove(Ae),B.onEmpty=o.onEmpty(Ae),k=a.onPreAdd(ke),A=l.subscribe({event:"/VISU/onWindowResized"},(function(){var t=e.reviewContext.getCurrentSessionMarkup();if(t){var n=t.getCurrentSlide();if(n){var i=n.getDMUObjects();if(i&&i.length)for(let e=0;e<i.length;e++)i[e].refreshNode&&-1===i[e].getType().indexOf("Compare")&&i[e].refreshNode()}}}));else{if(J&&(m.unreferenceDMUSlidesController({context:T}),J=null),X&&(f.unreferenceDMUCommentsController({context:T}),X=null),e.reviewContext.setRestrictions(void 0),ae&&(h.unreferenceDMUReviewController({context:T}),ae=null),z&&(v.unreferenceDMUCursorsController({context:T}),z=null),X&&(f.unreferenceDMUCommentsController({context:T}),X=null),w.unreferenceDMUSceneDisplayController({context:G}),S.unreferenceReqCompareController({context:G}),U&&(U.clean(),U=null),K)for(var q=Object.keys(W),Y=0;Y<q.length;Y++)K.removeEvent(W[q[Y]]);W={},B.onPostAdd&&o.unsubscribe(B.onPostAdd),B.onPostRemove&&o.unsubscribe(B.onPostRemove),B.onEmpty&&o.unsubscribe(B.onEmpty),B={},k&&a.unsubscribe(k),k=null,H&&(Z.unsubscribe(H),H=null),Z&&(E.unreferencePreferenceManager({context:G.getFrameWindow()}),Z=null),_&&_.length&&(d.unregisterElements(_.reduce((function(e,t){return e.concat(t.div)}),[])),_=null),d.unregister(i),i=null,l.unsubscribe(A),A=null}ue=null,Se&&Se([])}}}});return Object.freeze({createReviewContext:async e=>{if(e&&e.context){e.context.getExecutionContext&&i.init(e.context,{executionContext:e.context.getExecutionContext()});var t=u.getReviewContext(e);if(!t){await U.init({context:e.context}),(t=new d(e.context.getFrameWindow())).setUIManager(new A({context:e.context,reviewContext:t}));var n=e.context.getFrameWindow();n.removeReviewModel||(n.removeReviewModel=function(t){if(t){var i=u.getReviewContext(e);if(i){var o=i.getTransientReviewBag();o.removeDMUObjects(t),o.getDMUObjects().length||i.getCurrentSessionMarkup()||(u.removeReviewContext(e),n.removeReviewModel=void 0)}}else u.removeReviewContext(e),n.removeReviewModel=void 0}),n.setReviewModelVisibleFlag||(n.getReviewModelVisibleFlag=function(){var t=u.getReviewContext(e);return!!t&&t.isVisible()},n.setReviewModelVisibleFlag=function(t){var n=u.getReviewContext(e);n&&n.setVisibleFlag(t)}),t&&u.setReviewContext({context:e.context,controller:t})}return t}}})})),define("DS/DMUBaseUIControllers/DMU2DSheetManager",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUControls/EXPNavBar","DS/DMUControls/DMUCurrentPageWidget","DS/SVGLoader/SVGNode","DS/Mesh/MeshUtils","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseExperience/DMUContextManager","DS/DibUDLWebLoader/CATDibUDLWebLoader","DS/WAFData/WAFData","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIControllers/DMUMarkupsController","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],(function(e,t,n,i,o,r,a,l,s,d,u,c,g,p,m,f,h,v){"use strict";return e.extend({init:function(e){let C,D,b,M,y,w,S,E,x,U,O,P,I,R,A,k,T,V=this,j=e.ctxViewer,F=!1,N=null,L=[],B=[],W=1,H=[],q=0,_=new Map;function z(e,t){let n;if(e&&t)for(let i=0;i<B.length;i++)if(B[i]&&B[i].sheetNodes&&B[i].sheetNodes.length){for(let o=0;o<B[i].sheetNodes.length;o++)"modelID"===e&&B[i].sheetNodes[o].sheetID===t&&(n=B[i].sheetNodes[o].modelID),"sheetID"===e&&B[i].sheetNodes[o].modelID===t&&(n=B[i].sheetNodes[o].sheetID),"parentID"===e&&B[i].sheetNodes[o].sheetID===t&&(n=B[i].parentID);if(n)break}return n}function X(){C=new t({body:j.getFrameWindow().getUIFrame(),type:"error",message:v.objectWithoutUDL})}function G(e){var t,n;let i=e&&e.parentID?e.parentID:B[0].parentID;for(let e=0;e<B.length;e++)if(B[e].parentID===i){n=e;break}if(void 0===n&&B&&B.length&&(i=B[n=0].parentID),i)if(B[n].svg){for(t=0;t<B[n].sheetNodes.length;t++)B[n].sheetNodes[t].setVisibility(B[n].sheetNodes[t].sheetID===e.sheetID),B[n].sheetNodes[t].setVisibilityFree(B[n].sheetNodes[t].sheetID!==e.sheetID);e.callback&&e.callback(),j.getViewer().render()}else{q++;var o=l.giveEventsController({context:j}),r=function(){q--,e.callback&&e.callback(),o&&o.fireEvent("onContextVisuChangeEnd")};o&&o.fireEvent("onContextVisuChangeBegin");let t=z("modelID",e.sheetID);if(B[n].fatherNode&&B[n].fatherNode.removeChildren(),"DXF/DWG"===B[n].dataType||"DIFSheet"===B[n].dataType||"DIFLayout"===B[n].dataType)B[n].getSheet3DNode({modelID:t,noUdlMessage:L,noUdlWarningMessage:function(){X()},end:r,cb:function(e){!function(){_?_.clear():_=new Map;let e=function(t){if(t.getLastElement(!0).getDibInfo&&t.getLastElement(!0).getDibInfo()&&t.getLastElement(!0).getDibInfo().id){let e=t.getLastElement(!0).getDibInfo().id;if(e){_.has(e)||_.set(e,[]);let n=_.get(e);n&&n.push(t)}}let n=t.getChildrenPathes();n&&n.length&&n.forEach(e)};e(j.getRootBagPath())}(),j.getViewer().setBackgroundColor(e&&e.getHex?e.getHex():16777215)}});else{let i=B[n].UDLLoader;if(i){let o=i.getSheetBackgroundColor(t);j.getViewer().setBackgroundColor(o&&o.getHex?o.getHex():16777215),i.getSheet3DNode({sheetID:t,onSheetNodeCreated:function(e){B[n].fatherNode&&B[n].fatherNode.addChild(e),j&&j.getViewer().render()},onSheetLoaded:function(){L.includes(e.sheetID)&&X(),j&&j.getViewer().render(),r()},onFailure:function(){L.push(e.sheetID),X(),r()}})}}}}function K(e){var t=l.getReviewContext({context:j}),n=t?t.getCurrentSessionMarkup():null,i=a.giveDMUSlidesController({context:j.getFrameWindow()});if(n&&n.getActiveFlag()&&n.isVisible()&&i){var o=null;if(e)for(var r=t.getUIManager().getFormatEditionModeFlag()?n.getFormats():n.getSlides(),s=0;s<r.length;s++)if(r[s].getEnvironmentOverload().state.sFocusProperty&&r[s].getEnvironmentOverload().state.sFocusProperty.length&&r[s].getEnvironmentOverload().state.sFocusProperty[0]===e){o=r[s];break}i.setActiveSlide(o)}else t&&t.getTransientReviewBag&&t.getTransientReviewBag().removeDMUObjects(),j.getViewpoint().reframe()}function J(e){if(!j)return void(e&&e.callback&&e.callback({error:!0}));var n=null;let i,o=e&&e.parentID?e.parentID:B.length?B[0].parentID:null;if(!o)return;for(let e=0;e<B.length;e++)if(B[e].parentID===o){i=e;break}let r=o===B[0].parentID;if(void 0===i&&(i=0),e&&e.sheetID?n=e.sheetID:B[i].sheetNodes&&B[i].sheetNodes.length&&(n=B[i].sheetNodes[0].sheetID),n){let a=!1,l=z("sheetID",B[i].activatedSheet);if(n!==l){a=!0;let e=parseInt(n);e&&B[i].sheetNodes&&B[i].sheetNodes.length&&(B[i].sheetNodes[e-1].sheetID===l?a=!1:n=B[i].sheetNodes[e-1].sheetID)}if(a||e.forceLoad)C&&C.destroy(),function(e){for(let t=0;t<B.length;t++)if(B[t].sheetNodes)for(let n=0;n<B[t].sheetNodes.length;n++)if(B[t].sheetNodes[n].sheetID===e)return B[t].sheetNodes[n]}(n)?(e.changeActiveSlide&&K(""),B[i].activatedSheet=z("modelID",n),G({sheetID:n,parentID:o,callback:function(t){r&&e.changeActiveSlide&&K(n),e.callback&&e.callback(t)}}),r&&n&&y&&o===B[0].parentID&&y.setActiveNarBarItem(n)):(C=new t({body:j.getFrameWindow().getUIFrame(),type:"error",message:v.sheetNotExistWarning}),e.callback&&e.callback({error:!0}));else e&&e.callback&&e.callback()}else e&&e.callback&&e.callback()}function Z(e){S&&S.updateCurrentPage(e.value);var t=l.giveEventsController({viewer:j.getViewer()});t&&t.fireEvent("onCurrentElementChanged",{currentElement:e.value,endMove:e.endMove})}function Q(e){if(O&&e&&e.paths&&e.paths.length&&e.paths[0].length){let t=e.paths[0]?e.paths[0].join("/"):void 0;t&&(k=t,O.setCurrentElement({elementID:t,duration:200}))}}function Y(e){if(e&&e.paths&&e.paths.length){let t=[];if(e.paths.forEach((e=>{if(O&&O.isADocumentDisplayed()&&"Requirement"===O.getDocumentType()){O.forceElementsLoad([e[e.length-1]]);let n=O.getElementInfo(e[e.length-1]);n&&n.pathElement&&t.push(n.pathElement)}else{let n=e&&e.length>2?[e[e.length-2],e[e.length-1]]:e.length?e:[],i=[];for(let e=n.length-1;e>=0;e--)if(_.has(n[e])&&_.get(n[e]).length){let t=_.get(n[e]);if(i.length)for(let e=i.length-1;e>=0;e--){let n=i[e];t.some((e=>e.isAParentOf(n)))||i.splice(e,1)}else i=t.slice()}t=t.concat(i)}})),t.length){T=t.slice();let e=f.getCommand("DMUFocusOnRepresentationHdr",j.getCommandContext());e&&e.begin()}}}function $(){if(B&&1===B.length){j.getViewer().set2DMode(!0,"CATIA"),D=j.getViewer().antiAliasing,j.getViewer().setAntiAliasing("MSAA"),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select2DGeometry"]}]).then((e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:j});n&&n.setPicking(t?0:1)}));var e=p.giveSelectionManager({context:j});e&&e.setPicking(1),M=j.getViewer().getVisuEnv(),-1!==M.indexOf("OCA")&&(M=M.split("OCA")[0]),j.getViewer().setVisuEnvOCA("Basic")}}function ee(){if(!j.getFrameWindow())return;let e=0,t=j.getFrameWindow().getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea);(t.getContainedVisibleWindows().length>0||t.interactiveDockAreaVisibleFlag)&&(e=t._collapserSize,t.collapseDockingZoneFlag||(e+=t.dockingZoneSize)),S&&S.setOffset(e)}this.isRunning=function(){return q>0},this.load2DDocument=function(e){if(!e||!j)return;if(!e.onFailure)return;if(!e.phyID)return void e.onFailure();if(!e.dataType)return void e.onFailure();if(!e.parentNode&&"DIFLayout"!==e.dataType&&"DIFSheet"!==e.dataType)return void e.onFailure();if(!e.onComplete)return void e.onFailure();for(let t=0;t<B.length;t++)if(e.phyID===B[t].parentID)return;if(-1!==H.indexOf(e.phyID))return;let i=l.giveEventsController({viewer:j.getViewer()});i&&i.fireEvent("on2DDocumentLoadStarted",{id:e.phyID,type:"2DData"}),e.onLoadingStarted&&e.onLoadingStarted(),q++,H.push(e.phyID);var a=function(n,o){C&&C.destroy(),C=new t({body:j.getFrameWindow().getUIFrame(),type:"error",message:n}),q--,i&&i.fireEvent(o,{id:e.phyID,type:"2DData"}),-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1),e.onComplete("fail")},u=function(t){J({sheetID:t,parentID:e.phyID,forceLoad:!0,callback:function(){if(j){1===B.length&&function(){if(y&&y.clean(),B[0]&&B[0].sheetNodes&&B[0].sheetNodes.length){for(var e=[],t=0;t<B[0].sheetNodes.length;t++)e.push({id:B[0].sheetNodes[t].sheetID,label:B[0].sheetNodes[t].label});if(e.length){let t=z("sheetID",B[0].activatedSheet);y=new n({frameWindow:j.getFrameWindow(),tabs:e,onClickCB:e=>{e&&B&&B.length&&J({sheetID:e,parentID:B[0].parentID,changeActiveSlide:!0})},activeTabIndex:t||e[0].id}),y.setVisibleFlag(W>0)}}}();var t=l.getReviewContext({context:j}),o=t?t.getCurrentSessionMarkup():null;(!o||o&&!o.getSlides().length)&&j.getViewpoint().reframe(),q--,-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1),V.initializeDMUEvents(),i&&i.fireEvent("on2DDocumentLoadSuccess",{id:e.phyID,type:"2DData"})}e.onComplete()}})},c=function(){q--,-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1),i&&i.fireEvent("on2DDocumentLoadError",{id:e.phyID,type:"2DData"}),e.onFailure()},g=function(){j.getController().getAttributes({ids:[e.phyID],attributes:["svg"],callbacks:{onComplete:function(t){if(-1!==H.indexOf(e.phyID))if(t[e.phyID]&&t[e.phyID].svg&&""!==t[e.phyID].svg){var n={method:"GET",authentication:"passport",proxy:"none",type:"text",timeout:6e4,cache:3600,onComplete:function(t){if(-1===H.indexOf(e.phyID))return;N||(N=new DOMParser);let n=N.parseFromString(t,"image/svg+xml");if(!n)return void a(v.sheetNotSupported,"on2DDocumentLoadError");let i=[],l=[];if(n.documentElement&&n.documentElement.id?l=[n.documentElement]:n.documentElement&&n.documentElement.childNodes&&n.documentElement.childNodes.length&&n.documentElement.childNodes[0].id&&(l=n.documentElement.childNodes),!l.length)return void a(v.sheetNotSupported,"on2DDocumentLoadError");let s,d,c=l.length-1;for(d=l.length-1;d>=0;d--){if(!l[d].id)return void a(v.sheetNotSupported,"on2DDocumentLoadError");if(-1!==i.indexOf(l[d].id))return void a(v.sheetNotSupported,"on2DDocumentLoadError");i.push(l[d].id)}for(B.push({parentID:e.phyID,dataType:e.dataType,svg:!0,sheetNodes:[],activatedSheet:null,fatherNode:e.parentNode}),d=l.length-1;d>=0;d--)s=new o(l[d],"Drw."+e.phyID+"_"+l[d].id,j.getViewer()),s.modelID=l[d].id,s.sheetID="Drw."+e.phyID+"_"+l[d].id,s.label=l[d].textContent,s.setPickable(r.PICKTHROUGH),B[B.length-1].sheetNodes.unshift(s),c>0&&"svg"===l[d].localName&&s.setVisibility(!1),c--;for(d=0;d<B[B.length-1].sheetNodes.length;d++)B[B.length-1].fatherNode.addChild(B[B.length-1].sheetNodes[d]);$(),u(B[B.length-1].sheetNodes[0].sheetID)},onCancel:c,onFailure:c};d.handleRequest(t[e.phyID].svg,n)}else c()},onFailure:c}})};let p=new s;if(p.setMaxSheetInCache(4),p.set3DAccuracy(.001),p.set2DAccuracy(.001),"Drawing"===e.dataType)e.serverUrl?p.loadModel({data:{physicalid:e.phyID,dataType:e.dataType},serverUrl:e.serverUrl,securityContext:e.securityContext?e.securityContext:"prefered",onComplete:function(t){if(-1!==H.indexOf(e.phyID))if(t.sheetIDList&&t.sheetIDList.length){L=[],B.push({parentID:e.phyID,dataType:e.dataType,sheetNodes:[],sheetIDList:t.sheetIDList,activatedSheet:t.currentSheetID||null,fatherNode:e.parentNode,UDLLoader:p});for(var n=0;n<t.sheetIDList.length;n++)B[B.length-1].sheetNodes.push({parentID:e.phyID,modelID:t.sheetIDList[n],sheetID:"Drw."+e.phyID+"_"+t.sheetIDList[n],label:p.getSheetName(t.sheetIDList[n])});if($(),B[B.length-1].activatedSheet){let e=B[B.length-1].sheetNodes.find((e=>e.modelID===B[B.length-1].activatedSheet));u(e.sheetID)}else u(B[B.length-1].sheetNodes[0].sheetID)}else a(v.objectWithoutSheet,"on2DDocumentLoadError")},onFailure:g}):g();else if("DXF/DWG"===e.dataType||"DIFSheet"===e.dataType||"DIFLayout"===e.dataType){L=[];var m=e.loadedSheetInformations;if(!m||!m.sheetIDList||!m.sheetIDList.length)return void a(v.objectWithoutSheet,"onEmptyDocument");if(B.push({parentID:"DXF/DWG"===e.dataType?e.parentNode.modelIdentification:e.phyID,dataType:e.dataType,sheetNodes:e.sheetNodes,sheetIDList:m.sheetIDList,activatedSheet:m.currentSheetID||null,fatherNode:e.parentNode,UDLLoader:p,getSheet3DNode:e.getSheet3DNode}),$(),B[B.length-1].activatedSheet){let e=B[B.length-1].sheetNodes.find((e=>e.modelID===B[B.length-1].activatedSheet));u(e.sheetID)}else u(B[B.length-1].sheetNodes[0].sheetID)}else c()},this.loadDocumentStream=function(e){if(!e||!j)return;if(!e.onFailure)return;if(!e.documentID)return void e.onFailure();if(!e.type)return void e.onFailure();if(!e.fatherNode)return void e.onFailure();if(!e.onComplete)return void e.onFailure();let t=h.giveReqCompareController({context:j});t&&t.isLoading()||V.clean2DDocument();let n=l.giveEventsController({viewer:j.getViewer()});n&&n.fireEvent("on2DDocumentLoadStarted",{type:"Document"}),q++;let o=!1;if(B)for(let t=0;t<B.length;t++)if(B[t]&&B[t].parentID&&B[t].parentID===e.documentID){o=!0;break}o||B.push({parentID:e.documentID,dataType:e.type,fatherNode:null}),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select2DGeometry"]}]).then((e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:j});n&&n.setPicking(t?0:1)}));var r=p.giveSelectionManager({context:j});r&&r.setPicking(1),T=void 0,t&&(t.isLoading()||t.isRequirementCompareActive())?t.loadCompareRequirement(e.elementsToLoad,t.isRequirementCompareActive(),(()=>{q--,V.initializeDMUEvents(),e.onComplete()})):"Document"===e.type||"Requirement"===e.type?require(["DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/WebDocumentVisualization/WebDocumentBookmarksController"],(function(t,o){R=t,A=o,O||(O=t.getWebDocumentVisualizationController({context:j})),O.loadDocumentStream({phyId:e.documentID,type:e.type,dataBuffer:e.dataBuffer,elementsToLoad:e.elementsToLoad,fatherNode:e.fatherNode,password:e.password,onPasswordOk:e.onPasswordOk,onIncorrectPassword:()=>{q--,e.onIncorrectPassword()},onComplete:async()=>{if("Document"===e.type){S||(j.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",ee),S=new i({frameWindow:j.getFrameWindow(),onValueChanged:function(e){O.setCurrentElement({elementID:e})},maxValue:O.getDocumentLength()}));let e=O.getExternalComments(),t=O.getPDFHyperlinks();if(e&&e.length||t&&t.length)l.getReviewContext({viewer:j.getViewer()})||(await require("DS/DMUBaseUIControllers/DMUWebPreferencesController").init({context:j}),await u.createReviewContext({context:j}))}if(V.documentHasBookmarks()){E||(E=o.getWebDocumentBookmarksController({context:j}));let t=localStorage.getItem("DMUBookmarksPanelDisplayed");if("true"===t||"false"!==t&&"Requirement"===e.type){let e=f.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",j.getCommandContext());if(e){let t=setInterval((function(){e.isEnabled()&&(clearInterval(t),e.getState()?E.displayBookmarksPanel():e.setState(!0))}),100)}}}q--,V.initializeDMUEvents(),n&&n.fireEvent("on2DDocumentLoadSuccess",{id:e.documentID,type:"Document"}),e.onComplete()},onFailure:t=>{n&&n.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),q--,t&&window.console.error("Error Loading Document Stream",t.message),e.onFailure(t)}})})):(q--,n&&n.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),e.onFailure(new Error("Data type not supported")))},this.cleanDocumentData=function(e){if(e&&e.id){-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1);for(let t=0;t<B.length;t++)if(B[t].parentID===e.id){B[t].fatherNode&&(B[t].fatherNode.removeChildren(),B[t].fatherNode=null),B.splice(t,1);break}}else if(B&&B.length){H.length=0;for(let e=0;e<B.length;e++)B[e].fatherNode&&(B[e].fatherNode.removeChildren(),B[e].fatherNode=null);B.length=0}},this.clean2DDocument=function(e){if(j&&(V.cleanDocumentData(e),y&&!B.length&&(y.clean(),y=null),!B||!B.length)){if(S&&(S.clean(),j.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",ee)),b&&j.getViewer().setPicking(b),M&&j.getViewer().setVisuEnvOCA(M),j.getViewer().get2DMode()){D&&j.getViewer().antiAliasing!==D&&"MSAA"===j.getViewer().antiAliasing&&j.getViewer().setAntiAliasing(D),j.getViewer().set2DMode(!1),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry"]}]).then((e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:j});n&&n.setPicking(t?0:1)}));var t=p.giveSelectionManager({context:j});t&&t.setPicking(1)}j.getViewer().render(),void 0!==U&&x&&(x.setResponsiveDisplayFlag(U),U=void 0),V.removeDMUEvents(),O&&R&&(O.removeDocument(),R.unreferenceWebDocumentVisualizationController({context:j})),E&&A&&A.unreferenceWebDocumentBookmarksController({context:j}),x&&g.unreferenceDMUMarkupsController({context:j.getViewer()}),x=null,y=D=O=E=k=null,S=b=M=null}},this.updateDocumentControllers=function(){O=R?R.giveWebDocumentVisualizationController({context:j}):null,E=A?A.giveWebDocumentBookmarksController({context:j}):null,O&&(B.length||B.push({}),B[0].dataType=O.getDocumentType(),B[0].parentID=O.getDocumentLoadedID())},this.initializeDMUEvents=function(){if(O&&(w||(w=new c),P||(P={onCurrentElementChange:O.subscribe("onCurrentElementChange",Z),onZoomChange:O.subscribe("onZoomChange",(function(e){if("start"===e.type)w.display({modal:!0,pointerEvents:!1,frmWindow:j.getFrameWindow(),type:"message",message:v.zoomLabel+" : "+e.value+" %"});else if("change"===e.type)w.updateMessage(v.zoomLabel+" : "+e.value+" %");else if(w.destroy(),O.getMultiPageVisibility()){var t=l.giveEventsController({viewer:j.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")}})),onElementSelection:O.subscribe("onElementSelection",V.fireCrossWidgetSelection),onDocumentRotationAngleChange:O.subscribe("onDocumentRotationAngleChange",(function(){var e=l.getReviewContext({context:j}),t=e?e.getVisibleMarkups():null;t&&t.map((e=>e.getCurrentSlide())).forEach((t=>{t&&t.updateEnvironmentOverload({target:e.getEnvironment(),state:e.getEnvironment().getEnvironmentInfo()})}));var n=l.giveEventsController({viewer:j.getViewer()});n&&n.fireEvent("onDMUObjectsVisuRefreshRequired")}))}),x=g.getDMUMarkupsController({context:j.getViewer()}),x&&(U=x.getResponsiveDisplayFlag(),U&&x.setResponsiveDisplayFlag(!1))),!I){I={};var e=l.giveEventsController({viewer:j.getViewer()});"Requirement"===B[0].dataType&&e&&(I.onCrossWidgetSelection=e.addEvent("onCrossWidgetSelection",Q)),e&&(I.onCrossWidgetFind=e.addEvent("onCrossWidgetFind",Y))}},this.removeDMUEvents=function(){if(O){if(P){Object.keys(P).forEach((e=>O.unsubscribe(P[e])))}w&&w.destroy(),void 0!==U&&x&&(x.setResponsiveDisplayFlag(U),U=void 0),g.unreferenceDMUMarkupsController({context:j.getViewer()})}if(I){var e=l.giveEventsController({viewer:j.getViewer()});e&&(I.onCrossWidgetSelection&&e.removeEvent(I.onCrossWidgetSelection),I.onCrossWidgetFind&&e.removeEvent(I.onCrossWidgetFind))}x=w=P=I=null},this.setCurrentElement=function(e){if(O)return O.setCurrentElement(e)},this.isADocumentDisplayed=function(){return B&&B[0]&&B[0].sheetNodes&&B[0].sheetNodes.length>0||O&&O.isADocumentDisplayed()},this.getDocumentRotationAngle=function(){if(O)return O.getDocumentRotationAngle()},this.getDocumentType=function(){return B&&B.length?B[0].dataType:null},this.getDocumentLoadedID=function(){if(B&&B.length&&B[0].parentID)return B[0].parentID},this.getExternalComments=function(){if(O)return O.getExternalComments()},this.getPDFHyperlinks=function(){if(O)return O.getPDFHyperlinks()},this.enableCurrentPageEdition=function(){if(S)return S.enableCurrentPageEdition()},this.setCurrentPageWidgetVisibleFlag=function(e){S&&S.setVisibility(e)},this.setTouchPanActive=function(e){if(O)return O.setTouchPanActive(e)},this.getElementsVisualizationData=function(){if(O)return O.getElementsVisualizationData()},this.getSelectedElementIDs=function(){if(O)return O.getSelectedElementIDs()},this.getElementInfo=function(e){if(O)return O.getElementInfo(e)},this.getElementMatrix=function(e){if(O)return O.getElementMatrix(e)},this.getPageRotation=function(e){if(O)return O.getPageRotation(e)},this.getPointedElemIDAtPosition=function(e){if(O)return O.getPointedElemIDAtPosition(e)},this.enableTextSelection=function(e){if(O)return O.enableTextSelection(e)},this.setTextSelectionFlag=function(e){if(O)return O.setTextSelectionFlag(e)},this.setLinkActivationFlag=function(e){if(O)return O.setLinkActivationFlag(e)},this.centerViewpointAtElementPosition=function(e){O&&(O.centerViewpointAtElementPosition(e),V.fireCrossWidgetSelection(e.elementID))},this.getPathElementsToFocusOn=()=>{let e=T&&T.slice();return T=void 0,e},this.centerViewpointAtNextOrPreviousElement=function(e){if(O)return O.centerViewpointAtNextOrPreviousElement(e)},this.documentHasMultipleElements=function(){if(O)return O.getDocumentLength()>1},this.documentHasBookmarks=function(){if(!O)return!1;let e=O.getDocumentBookmarks();return Boolean(e&&e.length)},this.setDocumentRotation=function(e){O&&O.setDocumentRotationAngle(e)},this.setMultiPageVisibility=function(e){O&&O.setMultiPageVisibility(e);var t=l.giveEventsController({viewer:j.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")},this.setBookmarksVisibility=function(e){E&&E.setPanelVisibilityFlag(e)},this.getElementToDraw=function(e){let t=B&&B.length?B[0].dataType:null;if(!t||"Document"!==t&&"Requirement"!==t)return j.getViewer().canvas;var n,i="Document"===t?"WebDocPageLayerPage":"WebDocReqElem";if(e){if(e.id.includes(i))return"Requirement"===t?e.parentElement.parentElement:e;for(n=e.parentNode;n;){if(n.id&&n.id.includes(i))return"Requirement"===t?n.parentElement.parentElement:n;n=n.parentElement}}return null},this.getPointedElem=function(){let e=B&&B.length?B[0].dataType:null;return"Document"===e||"Requirement"===e?j.getViewer().divCssElement:j.getViewer().canvas},this.getPageNumber=function(e){const t="WebDocPageLayerPage";return e&&e!==j.getViewer().canvas&&e.id.includes(t)?parseInt(e.id.slice(19)):null},this.getElementId=function(e){return e&&e!==j.getViewer().canvas&&e.id.includes("WebDocReqElem")?e.id.slice(14):null},this.fireCrossWidgetSelection=function(e){let{dataType:t,parentID:n}=B&&B.length?B[0]:{};if(e&&e!==n&&k!==e&&"Requirement"===t){k=void 0;var i=l.giveEventsController({viewer:j.getViewer()});i&&i.fireEvent("onFireCrossWidgetSelection",{paths:[e.split("/")]})}},this.setNavBarVisibleFlag=function(e){e?W++:W--,y&&y.setVisibleFlag(W>0)},this.getNavBarVisibleFlag=function(){return y?y.getVisibleFlag():void 0},this.clean=function(){V.clean2DDocument(),C&&C.destroy(),C=N=j=null},this.setCurrentSheet=function(e){var t=e;t&&t.sheet&&(t.sheetID=z("sheetID",t.sheet)),J({sheetID:t.sheetID,parentID:t.parentID?t.parentID:z("parentID",t.sheetID),changeActiveSlide:!1,callback:t.callback})},this.getCurrentSheet=function(){return B&&B.length&&B[0].activatedSheet?z("sheetID",B[0].activatedSheet):null},this.setReviewPlayMode=function(e){F=e},this.getReviewPlayMode=function(){return F},this.getLoadedDocuments=()=>B?B.slice():[],this.getDocumentData=function(e){let t,n,i,o=[];for(let t=0;t<B.length;t++)if(B[t].parentID===e){i=t;break}if(void 0!==i&&B[i]&&B[i].sheetIDList){t=B[i].activatedSheet,n=B[i].sheetIDList;for(let e=0;e<B[i].sheetNodes.length;e++)o.push(B[i].sheetNodes[e].label);return{activatedSheetID:t,sheetIDList:n,sheetNames:o}}}}})}));