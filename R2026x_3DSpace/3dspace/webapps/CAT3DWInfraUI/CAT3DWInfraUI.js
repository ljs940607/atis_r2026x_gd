define("DS/CAT3DWInfraUI/CAT3DWHandleManipulator",["UWA/Core","DS/CAT3DWVisu/CAT3DWVisuServices","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Manipulators/PointHandle","DS/CoreEvents/Events","DS/WebUtils/ContextedSingleton","DS/WebappsUtils/WebappsUtils","DS/CAT3DWVisu/CAT3DWPickingControllerFactory","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWText/CAT3DWTextServices","DS/WebUtils/GeometryUtils"],(function(t,e,i,o,n,s,a,r,l,h,c,d){"use strict";var g=n.extend({init:function(t){if(!t.media&&!t.group)throw Error('"DS/CAT3DWInfraUI/CAT3DWHandleManipulator" constructor missing config parameter "media" or "group"');if(!t.planeChoiceNode)throw Error('"DS/CAT3DWInfraUI/CAT3DWHandleManipulator" constructor missing config parameter "planeChoiceNode"');if(this._parent(t),this.name=t.name||"",(t.number||0===t.number)&&(this._number=t.number),this._viewer=t.viewer,this._planeChoiceNode=t.planeChoiceNode,this._refPlane=new i.Plane,this._setReferencePlane(),this.annotationManager=a.get(null,"ANNOTATION_MANAGER"),this._mediaController=t.mediaController,t.media?this.objects=[t.media]:t.group&&this.setGroup(t.group),this.setMatrix((new i.Matrix4).setPosition(this._getPosition())),this._isRotationActivated=!0,this._isScaleActivated=!0,this._isSnappingForImageActivated=!0,this._maxSuccessfulScaleRatio=1,this._authorizeTextScaling=!0,this._onBeginPreactivateCB=this._onBeginPreactivate.bind(this),this.subscribe("BeginPreactivate",this._onBeginPreactivateCB),this._onEndPreactivateCB=this._onEndPreactivate.bind(this),this.subscribe("EndPreactivate",this._onEndPreactivateCB),this._onBeginManipulateCB=this._onBeginManipulate.bind(this),this._onManipulateCB=this._onManipulate.bind(this),this._onEndManipulateCB=this._onEndManipulate.bind(this),this.subscribe("BeginManipulate",this._onBeginManipulateCB),this.subscribe("Manipulate",this._onManipulateCB),this.subscribe("EndManipulate",this._onEndManipulateCB),this._beginManipulateCB=t.beginManipulate,this._manipulateCB=t.manipulate,this._endManipulateCB=t.endManipulate,this._updateAllOtherHandlers=t.updateAll,this._subscribeEvents(),"rotationHandler"===t.name){var e=r.getWebappsAssetUrl("CAT3DWInfraUI","/icons/CAT3DWRotateHandle.png"),o=new i.ImageUtils._loadTextureWithProxy(e,void 0,null,null,i.ImageUtils.crossOriginPolicy);this.pointMat.map=o}this._rootLinksNodeName=l.getRootLinksNodeName(),this._rootStickersNodeName=l.getRootStickersNodeName(),this._rootComparisonNodeName=l.getRootComparisonNodeName(),this._rootaiGenerationNodeName=l.getRootAIGenerationNodeName()},dispose:function(){if(this._group&&(this._group=null),this._manipulator&&(this.sceneGraph.add(this),this._manipulator=null),this.unsubscribe("BeginPreactivate",this._onBeginPreactivateCB),this.unsubscribe("EndPreactivate",this._onEndPreactivateCB),this.unsubscribe("BeginManipulate",this._onBeginManipulateCB),this.unsubscribe("Manipulate",this._onManipulateCB),this.unsubscribe("EndManipulate",this._onEndManipulateCB),this._viewer.currentViewpoint.setControlActive(!0),this._objectsPickability){for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]&&this.objects[t].setPickable(o.PICKABLE);this._objectsPickability=null}this.objects=null,this._viewer=null,this._unsubscribeEvents(),this._parent()},subscribe:function(t,e){this["_"+t+"Token"]&&this.unsubscribe(this["_"+t+"Token"]),this["_"+t+"Token"]=this._parent(t,e)},unsubscribe:function(t){this["_"+t+"Token"]&&(this._parent(this["_"+t+"Token"]),this["_"+t+"Token"]=null)},_subscribeEvents:function(){this._onViewpointToken||(this._onViewpointToken=s.subscribe({event:"/VISU/"},function(t){("@onViewpointChange"===t.eventType||"@onViewpointEndMove"===t.eventType)&&this.update(!0)}.bind(this)))},_unsubscribeEvents:function(){this._onViewpointToken&&s.unsubscribe(this._onViewpointToken),this._onViewpointToken=null},setManipulationCallbacks:function(t,e,i){this._beginManipulateCB=t,this._manipulateCB=e,this._endManipulateCB=i},setGroup:function(t){this._group=t,this.objects=this._group.getObjects(),this.update(!1)},hideManipulator:function(){this.setVisibility(!1)},showManipulator:function(){this._group&&this._group.isLocked()||this.setVisibility(!0)},getManipulatedObject:function(){return this._group?this._group:this.objects[0]},getLastTimestamp:function(){return this._timestamp},getNumber:function(){return this._number},isActivated:function(){return this._activated||this._manipulating},isManipulated:function(){return this._manipulating},setReferencePlane:function(t){this._refPlane=t},getReferencePlane:function(){return this._refPlane},setRotationActivation:function(t){this._isRotationActivated=t},isRotationActivated:function(){return this._isRotationActivated},setScaleActivation:function(t){this._isScaleActivated=t},isScaleActivated:function(){return this._isScaleActivated},setSnappingForImageActivation:function(t){this._isSnappingForImageActivated=t},isSnappingForImageActivated:function(){return this._isSnappingForImageActivated},update:function(t=!0,e){t&&this._updateAllOtherHandlers&&this._updateAllOtherHandlers(e),this.isPaused()||(this.setMatrix((new i.Matrix4).setPosition(this._getPosition())),this._viewer.render())},pause:function(){this._manipulator||(this._manipulator=this,this.sceneGraph.remove(this),this._unsubscribeEvents()),this._viewer.render()},isPaused:function(){return!!this._manipulator},resume:function(){this._manipulator&&(this._manipulator=null,this.sceneGraph.add(this),this._subscribeEvents(),this.update(!1)),this._viewer.render()},setAdditionalObjectsToUpdate:function(t){this._connectionsToUpdate=t},move:function(t){var e=this.getMatrix(),o=(new i.Vector3).getPositionFromMatrix(e);o.add(t),e.setPosition(o),this.setMatrix(e)},getScreenPosition:function(){return e.compute2DPointFrom3DPoint(this._getPosition(),this._viewer)},_onBeginPreactivate:function(){if(!this._manipulating){this._objectsPickability=[];for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]=this.objects[t].getPickable(),this.objects[t].setPickable(o.NOPICKABLE)}this._activated=!0},_onEndPreactivate:function(){if(!this._manipulating&&this._objectsPickability){for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]&&this.objects[t].setPickable(o.PICKABLE);this._objectsPickability=null}this._activated=!1},_onBeginManipulate:function(t){this._timestamp=Date.now(),this.setPickable(o.PICKTHROUGH);var n=this._getPosition(),s=e.compute2DPointFrom3DPoint(n,this._viewer);if(this._planeChoiceNode)this._refPlane.setFromNormalAndCoplanarPoint(this._planeChoiceNode.getNormal().negate(),this._planeChoiceNode.getCenter()),this._refPlaneU=this._planeChoiceNode.getUDirection();else{this._refPlane||(this._refPlane=(new i.Plane).setFromNormalAndCoplanarPoint((new i.Vector3).subVectors(this._viewer.currentViewpoint.target,this._viewer.currentViewpoint.camera.position).normalize(),new i.Vector3(0,0,0)));var a=this._viewer.currentViewpoint.getUpDirection(),r=this._refPlane.normal;this._viewer.currentViewpoint.getSightDirection().dot(r)>0&&r.negate(),this._refPlaneU=(new i.Vector3).crossVectors(a,r),this._refPlaneU.normalize()}const l=this.getManipulatedObject();this._originalMatrix=l.getCurrentTransformation?l.getCurrentTransformation():l.getMatrix();const h=(new i.Vector3).getPositionFromMatrix(this._originalMatrix);this._originalTranslationMatrix=(new i.Matrix4).makeTranslation(h.x,h.y,h.z),this._originalRotation=(new i.Matrix4).extractRotation(this._originalMatrix),this._originalMatrix.setPosition(new i.Vector3(0,0,0)),this._refOrigin2D=e.compute2DPointFrom3DPoint(h,this._viewer),this._centerOnRefPlane=this._refPlane.projectPoint(h),this._rotationVector=(new i.Vector3).subVectors(this._refPlane.projectPoint(n),this._centerOnRefPlane).normalize(),this._angleConeHeigth=180*new i.Vector3(1,0,0).angleTo(new i.Vector3(s.x,s.y,0).sub(new i.Vector3(this._refOrigin2D.x,this._refOrigin2D.y,0)))/Math.PI,this._rotationActivated=!1;var d=new i.Vector3,g=new i.Vector3,p=new i.Vector3;this._originalRotation.extractBasis(d,g,p);var u=d.dot(this._refPlaneU),m=new i.Vector3;if(Math.abs(u)>.5?(m.copy(d),this._originalRight=new i.Vector3(1,0,0)):(u=g.dot(this._refPlaneU),Math.abs(u)>.5?(m.copy(g),this._originalRight=new i.Vector3(0,1,0)):(m.copy(p),this._originalRight=new i.Vector3(0,0,1))),u<0&&(m.negate(),this._originalRight.negate()),("connectionHandlerPointA"===this.name||"connectionHandlerPointB"===this.name||"connectionMiddlePoint"===this.name)&&!this._manipulating)if(this._objectsPickability)for(let t=0;t<this.objects.length;t++)this.objects[t].setPickable(o.NOPICKABLE);else{this._objectsPickability=[];for(let t=0;t<this.objects.length;t++)this._objectsPickability[t]=this.objects[t].getPickable(),this.objects[t].setPickable(o.NOPICKABLE)}var f=(new i.Vector3).crossVectors(this._refPlane.normal,m),b=this._refPlaneU.dot(f)>0?1:-1;this._snapMatrix=(new i.Matrix4).makeRotationAxis(this._refPlane.normal,b*m.angleTo(this._refPlaneU)),this._manipulating=!0,this._beginManipulateCB&&this._beginManipulateCB(t);let w=l.getManipulatorsPositions();if(this._widthMargin=0,l.getPreciseCorners){let t=w.topLeft.distanceTo(w.topRight);w=l.getPreciseCorners();let e=w.topLeft.distanceTo(w.topRight);this._widthMargin=(t-e)/2}if(this.currentScalingFactor=void 0,this.minimumYScale=void 0,this.font=void 0,this.corners=void 0,1===this.objects.length&&"CAT3DSKAnnotationShape"===this.objects[0].getType()&&this.objects[0].getSubTextMedia()){let t=this.objects[0].getSubTextMedia().getView().getPixelDimensions(),e=this.objects[0].getSubTextMedia().getDataService().getValue("inputDimensions");this.currentScalingFactor=t.height/e.height;let i=this.objects[0].getSubTextMedia().getFontStyle(),o=this.objects[0].getSubTextMedia().getFontWeight(),n=this.objects[0].getSubTextMedia().getFontFamily(),s=this.objects[0].getSubTextMedia().getFontSize()+"px",a=this.objects[0].getSubTextMedia().getLineHeight()+"px";this.font="","italic"===i&&(this.font=this.font+"italic "),"bold"===o&&(this.font=this.font+"700 "),this.font=this.font+s+" / "+a+" "+n;let r=c.getApproxMinLineWidthInShape(this.font)*this.currentScalingFactor,l=this._viewer.currentViewpoint.project(w.topLeft),h=this._viewer.currentViewpoint.project(w.topRight);this.minimumYScale=r/l.distanceTo(h),this.corners=w}let x=()=>{let t=(new i.Vector3).subVectors(this.movingCorner,this.fixedCorner);this._fixedToMovingCornerDistance=t.length(),this._fixedToMovingCornerDir=t.normalize()};if("bottomRightHandler"===this.name)this.movingCorner=w.bottomRight,this.fixedCorner=w.topLeft,this._scaleVector=new i.Vector3(1,1,1),x();else if("bottomLeftHandler"===this.name)this.movingCorner=w.bottomLeft,this.fixedCorner=w.topRight,this._scaleVector=new i.Vector3(1,1,1),x();else if("topRightHandler"===this.name)this.movingCorner=w.topRight,this.fixedCorner=w.bottomLeft,this._scaleVector=new i.Vector3(1,1,1),x();else if("topLeftHandler"===this.name)this.movingCorner=w.topLeft,this.fixedCorner=w.bottomRight,this._scaleVector=new i.Vector3(1,1,1),x();else if("rightCenterHandler"===this.name)this.movingCorner=w.topRight.clone().sub(w.bottomRight).multiplyScalar(.5).add(w.bottomRight),this.fixedCorner=w.topLeft.clone().sub(w.bottomLeft).multiplyScalar(.5).add(w.bottomLeft),this._scaleVector=new i.Vector3(0,1,0),x();else if("leftCenterHandler"===this.name)this.movingCorner=w.topLeft.clone().sub(w.bottomLeft).multiplyScalar(.5).add(w.bottomLeft),this.fixedCorner=w.topRight.clone().sub(w.bottomRight).multiplyScalar(.5).add(w.bottomRight),this._scaleVector=new i.Vector3(0,1,0),x();else if("topCenterHandler"===this.name)this.movingCorner=w.topLeft.clone().sub(w.topRight).multiplyScalar(.5).add(w.topRight),this.fixedCorner=w.bottomLeft.clone().sub(w.bottomRight).multiplyScalar(.5).add(w.bottomRight),this._scaleVector=new i.Vector3(1,0,0),x();else if("bottomCenterHandler"===this.name)this.movingCorner=w.bottomLeft.clone().sub(w.bottomRight).multiplyScalar(.5).add(w.bottomRight),this.fixedCorner=w.topLeft.clone().sub(w.topRight).multiplyScalar(.5).add(w.topRight),this._scaleVector=new i.Vector3(1,0,0),x();else if("connectionHandlerPointA"===this.name||"connectionHandlerPointB"===this.name||"connectionMiddlePoint"===this.name){this._isScaleActivated=!1;let t=this.objects[0].getConnection();this._previousDepth=t.getView().getDepth()}},_onManipulate:function(){const t=new i.Matrix4,o=new i.Vector3,n=new i.Matrix4,s=new i.Vector3;let r,l,c,d,g,p;return function(u){this._timestamp=Date.now();var m=a.get(null,"HISTORY_MANAGER"),f=u.event.from[0]._currentPosition,b=u.viewer.canvas.getBoundingClientRect().top,w=u.viewer.canvas.getBoundingClientRect().left;f=new i.Vector2(f.x-w,f.y-b);var x=e.compute3DPointFrom2DPoint(f,this._refPlane,this._viewer);if(this.isRotationActivated()&&"rotationHandler"===this.name&&!this._rotationActivated){var v=180*new i.Vector3(1,0,0).angleTo(new i.Vector3(f.x,f.y,0).sub(new i.Vector3(this._refOrigin2D.x,this._refOrigin2D.y,0)))/Math.PI;this._rotationActivated=Math.abs(this._angleConeHeigth-v)>5}if(this._rotationActivated){var y=new i.Matrix4,D=(new i.Vector3).subVectors(x,this._centerOnRefPlane).normalize(),_=(new i.Vector3).crossVectors(this._rotationVector,D),I=this._rotationVector.dot(D),T=1/(1+I);if(y.set(_.x*_.x*T+I,_.y*_.x*T-_.z,_.z*_.x*T+_.y,0,_.x*_.y*T+_.z,_.y*_.y*T+I,_.z*_.y*T-_.x,0,_.x*_.z*T-_.y,_.y*_.z*T+_.x,_.z*_.z*T+I,0,0,0,0,1),this.isSnappingForImageActivated()&&(this.objects.length>1||!this.objects[0].parents||"images"===this.objects[0].parents[0].name||"comparisons"===this.objects[0].parents[0].name||"texts"===this.objects[0].parents[0].name||"links"===this.objects[0].parents[0].name||"stickers"===this.objects[0].parents[0].name)){var C=y.clone().multiply(this._originalRotation),P=this._originalRight.clone().applyMatrix4(C),R=180*P.angleTo(this._refPlaneU)/Math.PI;if(R<=5||R>=85&&R<=95||R>=175&&R<=185){var S=(new i.Vector3).crossVectors(this._refPlane.normal,P),A=this._refPlaneU.dot(S)>0?-1:1;R=R>=85&&R<=95?90*A:R<=5?0:180,C.makeRotationAxis(this._refPlane.normal,R*Math.PI/180),C.multiply(this._snapMatrix),y.copy(C)}}n.copy(this._originalTranslationMatrix),n.multiply(y),n.multiply(this._originalMatrix);var M=a.get(null,"CONNECTION_MANAGER"),E=!1;if(M.getListConnection().forEach((t=>{if(t.getMiddlePoint())for(let e=0;e<t.getMiddlePoint().length;e++)t.getMiddlePoint()[e]&&t.getMiddlePoint()[e].getPointedObject()&&t.getMiddlePoint()[e].getPointedObject().getID()===this.objects[0].getID()?(E=!0,d=t):t.getMiddlePoint()[e].isFixed()&&t.setRotation(!0)})),1===this.objects.length&&M.isConnected(this.objects[0])){if(d=M.isConnected(this.objects[0]),g=d[0].getConnectionPointA(),p=d[0].getConnectionPointB(),g.getPointedObject().getID()===this.objects[0].getID()){let t=this.objects[0].getMediaObj?this.objects[0].getMediaObj():this.objects[0];if(g.getRelativePosition()){let e=g.getRelativePosition(),o=t.getView().getCorners(),n=(new i.Vector3).copy(o.topRight),s=(new i.Vector3).copy(o.topLeft),a=(new i.Vector3).copy(o.bottomLeft),r=(new i.Vector3).subVectors(a,s),l=(new i.Vector3).subVectors(n,s);r.multiplyScalar(e.x/100),l.multiplyScalar(e.y/100),s.add(r),s.add(l),this._lastParam={connectionPointA_ID:t.getID(),connectionPointA_position:s,connectionPointA_relativePosition:e,isAutoMode:!1,timestamp:this._timestamp,isTransient:!0},d[0].updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d[0].getText()&&m.registerAction(this._timestamp,[d[0]],!1,!0)}}else if(p.getPointedObject().getID()===this.objects[0].getID()){let t=this.objects[0].getMediaObj?this.objects[0].getMediaObj():this.objects[0];if(p.getRelativePosition()){let e=p.getRelativePosition(),o=t.getView().getCorners(),n=(new i.Vector3).copy(o.topRight),s=(new i.Vector3).copy(o.topLeft),a=(new i.Vector3).copy(o.bottomLeft),r=(new i.Vector3).subVectors(a,s),l=(new i.Vector3).subVectors(n,s);r.multiplyScalar(e.x/100),l.multiplyScalar(e.y/100),s.add(r),s.add(l),this._lastParam={connectionPointB_ID:t.getID(),connectionPointB_position:s,connectionPointB_relativePosition:e,isAutoMode:!1,timestamp:this._timestamp,isTransient:!0},d[0].updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d[0].getText()&&m.registerAction(this._timestamp,[d[0]],!1,!0)}}}else if(E){let t=d.getMiddlePoint(),e=this.objects[0].getMediaObj?this.objects[0].getMediaObj():this.objects[0];if(t[this._number]&&!t[this._number].getRelativePosition()){let o=t[this._number].getRelativePosition(),n=e.getView().getCorners(),s=(new i.Vector3).copy(n.topRight),a=(new i.Vector3).copy(n.topLeft),r=(new i.Vector3).copy(n.bottomLeft),l=(new i.Vector3).subVectors(r,a),c=(new i.Vector3).subVectors(s,a);l.multiplyScalar(o.x/100),c.multiplyScalar(o.y/100),a.add(l),a.add(c),this._lastParam={connectionMiddlePoint_ID:e.getID(),connectionMiddlePoint_number:this._number,connectionMiddlePoint_position:a,connectionMiddlePoint_relativePosition:o,isAutoMode:!1,timestamp:this._timestamp,isTransient:!0},d.updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d.getText()&&m.registerAction(this._timestamp,[d],!1,!0)}}if(1===this.objects.length?this.objects[0].setTransformation(this._timestamp,n,!0):this._group.setTransformation(this._timestamp,n,!0),this._connectionsToUpdate&&this._connectionsToUpdate.length)for(let t of this._connectionsToUpdate)t.calculateMiddlePointAndUpdateTextPosition(!0,this._timestamp),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&t.getText()&&m.registerAction(this._timestamp,[t,t.getText()],!1,!0);this.update(),this._viewer.render(),this._manipulateCB&&this._manipulateCB()}if("rotationHandler"!==this.name){const a=this.getManipulatedObject();if(r=a.getCurrentTransformation?a.getCurrentTransformation():a.getMatrix(),this.isScaleActivated()&&this._authorizeTextScaling?(s.subVectors(x,this.fixedCorner),l=s.dot(this._fixedToMovingCornerDir)-this._widthMargin,l<.1&&(l=.1),x.copy(this._fixedToMovingCornerDir).multiplyScalar(l).add(this.fixedCorner),o.copy(this._fixedToMovingCornerDir).multiplyScalar(.5*l).add(this.fixedCorner),c=l/this._fixedToMovingCornerDistance,t.makeScale(this._scaleVector.x?this._scaleVector.x*c:1,this._scaleVector.y?this._scaleVector.y*c:1,this._scaleVector.z?this._scaleVector.z*c:1)):(t.identity(),o.getPositionFromMatrix(r)),n.makeTranslation(o.x,o.y,o.z),n.multiply(this._originalMatrix),n.multiply(t),1===this.objects.length){if("connectionHandlerPointA"===this.name||"connectionHandlerPointB"===this.name||"connectionMiddlePoint"===this.name){var O=e.compute3DPointFrom2DPoint(f,this._refPlane,this._viewer);d=this.objects[0].getConnection(),g=d.getConnectionPointA(),p=d.getConnectionPointB();var V=d.getMiddlePoint();const t=new i.Vector2(u.event.from[0]._currentPosition.x-w,u.event.from[0]._currentPosition.y-b);let o=this._doPickingDown(t);if(o&&this._pickedObject&&"CAT3DSKAIGeneration"===this._pickedObject.getType()&&!this._pickedObject.getActivatedPortName()&&(o=!1),o){this._pickedObject!==this.previouslyPickedObject&&("connectionHandlerPointB"===this.name?this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==g.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject):"connectionHandlerPointA"===this.name?this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==p.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject):this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==V[this._number].getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject)),this._activateFeedback(this._pickedObject),this.previouslyPickedObject=this._pickedObject;let t=this._pickedObject;if(d.setAutoMode(!1),"connectionHandlerPointA"===this.name){if(t&&t.getID()!==p.getPointedObject().getID()){let e,n=t.getMediaObj?t.getMediaObj():t,s=n.getView().getCorners(),a=Math.abs(s.topRight.y-s.topLeft.y),r=Math.abs(s.bottomLeft.x-s.topLeft.x);if(Math.abs(s.topLeft.x-s.topRight.x)>.01||s.topRight.x>s.bottomRight.x){let t=(new i.Vector3).subVectors(s.bottomLeft,s.topLeft),n=(new i.Vector3).subVectors(s.topRight,s.topLeft),a=(new i.Vector3).subVectors(o,s.topLeft),r=(new i.Vector3).copy(a).projectOnVector(t),l=(new i.Vector3).copy(a).projectOnVector(n);r.divide(t).multiplyScalar(100),l.divide(n).multiplyScalar(100),e=new i.Vector3(r.x,l.y,50)}else{let t=(o.x-s.topLeft.x)/r*100,n=(o.y-s.topLeft.y)/a*100;e=new i.Vector3(t,n,50)}this._lastParam={connectionPointA_ID:n.getID(),connectionPointA_position:O,connectionPointA_relativePosition:e,isAutoMode:!1,timestamp:this._timestamp,isTransient:!0},d.updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d.getText()&&m.registerAction(this._timestamp,[d],!1,!0)}}else if("connectionHandlerPointB"===this.name){if(t&&t.getID()!==g.getPointedObject().getID()){let e,n=t.getMediaObj?t.getMediaObj():t,s=n.getView().getCorners(),a=Math.abs(s.topRight.y-s.topLeft.y),r=Math.abs(s.bottomLeft.x-s.topLeft.x);if(Math.abs(s.topLeft.x-s.topRight.x)>.01||s.topRight.x>s.bottomRight.x){let t=(new i.Vector3).subVectors(s.bottomLeft,s.topLeft),n=(new i.Vector3).subVectors(s.topRight,s.topLeft),a=(new i.Vector3).subVectors(o,s.topLeft),r=(new i.Vector3).copy(a).projectOnVector(t),l=(new i.Vector3).copy(a).projectOnVector(n);r.divide(t).multiplyScalar(100),l.divide(n).multiplyScalar(100),e=new i.Vector3(r.x,l.y,50)}else{let t=(o.x-s.topLeft.x)/r*100,n=(o.y-s.topLeft.y)/a*100;e=new i.Vector3(t,n,50)}this._lastParam={connectionPointB_ID:n.getID(),connectionPointB_position:O,connectionPointB_relativePosition:e,isAutoMode:!1,timestamp:this._timestamp,isTransient:!0},d.updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d.getText()&&m.registerAction(this._timestamp,[d],!1,!0)}}else if("connectionMiddlePoint"===this.name&&t){let e,n=t.getMediaObj?t.getMediaObj():t,s=n.getView().getCorners(),a=Math.abs(s.topRight.y-s.topLeft.y),r=Math.abs(s.bottomLeft.x-s.topLeft.x);if(Math.abs(s.topLeft.x-s.topRight.x)>.01||s.topRight.x>s.bottomRight.x){let t=(new i.Vector3).subVectors(s.bottomLeft,s.topLeft),n=(new i.Vector3).subVectors(s.topRight,s.topLeft),a=(new i.Vector3).subVectors(o,s.topLeft),r=(new i.Vector3).copy(a).projectOnVector(t),l=(new i.Vector3).copy(a).projectOnVector(n);r.divide(t).multiplyScalar(100),l.divide(n).multiplyScalar(100),e=new i.Vector3(r.x,l.y,50)}else{let t=(o.x-s.topLeft.x)/r*100,n=(o.y-s.topLeft.y)/a*100;e=new i.Vector3(t,n,50)}this._lastParam=[];for(let t=0;t<V.length;t++){let i=null,o=V[t].getPosition(),s=V[t].getRelativePosition(),a=V[t].isFixed();t===this._number&&(i=n.getID(),o=O,s=e,a=!0),this._lastParam.push({connectionMiddlePoint_ID:i,connectionMiddlePoint_number:t,connectionMiddlePoint_position:o,connectionMiddlePoint_relativePosition:s,isAutoMode:!1,connectionMiddlePoint_PortPos:V[t].getPortPosition(),isFixed:a})}this._lastParam.timestamp=this._timestamp,this._lastParam.isTransient=!0,d.updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d.getText()&&m.registerAction(this._timestamp,[d],!1,!0)}this._viewer.render()}else{if("connectionHandlerPointA"===this.name?this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==p.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject):"connectionHandlerPointB"===this.name?this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==g.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject):"connectionMiddlePoint"===this.name&&this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==V[this._number].getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject),d.setAutoMode(!1),"connectionHandlerPointA"===this.name)this._lastParam={connectionPointA_ID:null,connectionPointA_position:O,connectionPointA_relativePosition:null,isAutoMode:!1,timestamp:this._timestamp,isTransient:!0},d.updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d.getText()&&m.registerAction(this._timestamp,[d],!1,!0);else if("connectionHandlerPointB"===this.name)this._lastParam={connectionPointB_ID:null,connectionPointB_position:O,connectionPointB_relativePosition:null,isAutoMode:!1,timestamp:this._timestamp,isTransient:!0},d.updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d.getText()&&m.registerAction(this._timestamp,[d],!1,!0);else if("connectionMiddlePoint"===this.name){this._lastParam=[];for(let t=0;t<V.length;t++){let e=V[t].getPosition(),i=null;t===this._number&&(e=O,i=!0),this._lastParam.push({connectionMiddlePoint_ID:null,connectionMiddlePoint_number:t,connectionMiddlePoint_position:e,connectionMiddlePoint_relativePosition:null,isAutoMode:!1,connectionMiddlePoint_PortPos:"left",isFixed:i})}this._lastParam.timestamp=this._timestamp,this._lastParam.isTransient=!0,d.updateView(this._lastParam),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&!d.getText()&&m.registerAction(this._timestamp,[d],!1,!0)}this._viewer.render()}}else"CAT3DSKAnnotationShape"===this.objects[0].getType()&&this.objects[0].getSubTextMedia()?this._manipulateAnnotationAndTextSimultaneously(this.objects[0],this._timestamp,f):this.objects[0].setTransformation(this._timestamp,n,!0);this.objects[0].parents&&"bbox"===this.objects[0].parents[0].name&&this.objects[0].updateShadowNode(this._refPlane)}else this._group.setTransformation(this._timestamp,n,!0);if(this._connectionsToUpdate&&this._connectionsToUpdate.length)for(let t of this._connectionsToUpdate)t.calculateMiddlePointAndUpdateTextPosition(!0,this._timestamp),h.getPreferenceValue("coreview")&&h.getPreferenceValue("LiveCollab")&&t.getText()&&m.registerAction(this._timestamp,[t,t.getText()],!1,!0);this.update(),this._viewer.render(),this._manipulateCB&&this._manipulateCB(u)}}}(),_onEndManipulate:function(t){this._originalMatrix=null,this._originalRotation=null,this.setPickable(o.PICKABLE);var e=a.get(null,"HISTORY_MANAGER"),i=a.get(null,"CONNECTION_MANAGER"),n=!1;let s;if(i.getListConnection().forEach((t=>{if(t.getMiddlePoint()){let e=t.getMiddlePoint();for(let i=0;i<e.length;i++)e[i].getPointedObject()&&e[i].getPointedObject().getID()===this.objects[0].getID()&&(n=!0,s=t)}})),this._rotationActivated)if(1===this.objects.length&&i.isConnected(this.objects[0])){let t=i.isConnected(this.objects[0]);t[0].setTransientPermanent(),e&&e.registerAction(this._timestamp,[t[0]],!1)}else n&&(s.setTransientPermanent(),e&&e.registerAction(this._timestamp,[s],!1));else if("connectionHandlerPointA"===this.name||"connectionHandlerPointB"===this.name||"connectionMiddlePoint"===this.name){var r=this.objects[0].getConnection();null!==r.getConnectionPointA().getRelativePosition()&&null!==r.getConnectionPointB().getRelativePosition()&&r.getView().setDepth(this._previousDepth);let t=[];t.push(r),r.setTransientPermanent(),r.getText()&&(r.getText().setTransientPermanent(),t.push(r.getText())),this._pickedObject&&(this._deactivateFeedback(this._pickedObject),this._pickedObject=null),e&&e.registerAction(this._timestamp,t,!1)}var l=0;if(this._objectsPickability)for(l=0;l<this.objects.length;l++)this._objectsPickability[l]&&this.objects[l].setPickable(o.PICKABLE);if(this._endManipulateCB&&this._endManipulateCB(t),this._manipulating=!1,this._activated)for(l=0;l<this.objects.length;l++)this._objectsPickability[l]&&this.objects[l].setPickable(o.NOPICKABLE);else this._viewer.currentViewpoint.setControlActive(!0);this.update(!0,this.objects)},_getReferenceCorner:function(){if("CAT3DWModel"===this.objects[0].getType()&&"Interactive3D"===this.objects[0].getMediaObj().getDataService().getValue("viewType"))return this.objects[0].getBboxViewCorner();let t,o;t=this._group?this._group:this.objects[0];let n,s,a,r,l=t.getManipulatorsPositions();switch(l.topLeft&&(n=l.topLeft,s=l.topRight,a=l.bottomRight,r=l.bottomLeft),this.name){case"scaleRotateHandler":case"bottomRightHandler":o=a;break;case"topLeftHandler":o=n;break;case"topRightHandler":o=s;break;case"bottomLeftHandler":o=r;break;case"rotationHandler":o=g.getRotationHandlePosition(t),o=e.compute3DPointFrom2DPoint(o,this._refPlane,this._viewer);break;case"topCenterHandler":o=new i.Vector3((n.x+s.x)/2,(n.y+s.y)/2,(n.z+s.z)/2);break;case"bottomCenterHandler":o=new i.Vector3((r.x+a.x)/2,(r.y+a.y)/2,(r.z+a.z)/2);break;case"rightCenterHandler":o=new i.Vector3((a.x+s.x)/2,(a.y+s.y)/2,(a.z+s.z)/2);break;case"leftCenterHandler":o=new i.Vector3((r.x+n.x)/2,(r.y+n.y)/2,(r.z+n.z)/2);break;case"connectionHandlerPointA":o=l.positionManipulatorA;break;case"connectionHandlerPointB":o=l.positionManipulatorB;break;case"connectionMiddlePoint":o=l.positionMiddlePoint[this._number]}return o},_getPosition:function(){return this._getReferenceCorner()},_setReferencePlane:function(){this._planeChoiceNode&&(this._refPlane.setFromNormalAndCoplanarPoint(this._planeChoiceNode.getNormal().negate(),this._planeChoiceNode.getCenter()),this._refPlaneU=this._planeChoiceNode.getUDirection())},_doPickingDown:function(t){this._pickingController=this.annotationManager.getPickingController();let e=this._pickingController.pick(t,!0,!0);if(e&&e.path){let t=!1;if("model3DNode"===e.path.externalPath[0].name||"images"===e.path.externalPath[0].name||e.path.externalPath[0].name===this._rootLinksNodeName||e.path.externalPath[0].name===this._rootStickersNodeName||e.path.externalPath[0].name===this._rootComparisonNodeName||e.path.externalPath[0].name===this._rootaiGenerationNodeName||"texts"===e.path.externalPath[0].name)"model3DNode"===e.path.externalPath[0].name?this._pickedObject=e.path.externalPath[2]:this._pickedObject=e.path.externalPath[1],t=this._pickedObject.getMediaObj().isThirdPartySelected();else if("annotGroupNode"===e.path.externalPath[0].name){let i=this.annotationManager.getAnnotationFromAnnotId(e.path.externalPath[2].annotID);this._pickedObject=i,t=this._pickedObject.isThirdPartySelected()}return!t&&this._pickedObject?e.point.position:(this._pickedObject=null,!1)}return!1},_activateFeedback:function(t){t.activateSelectionFeedback?t.activateSelectionFeedback(new i.Color("orange"),t.isGrouped()):t.setMultiSelected&&t.setMultiSelected()},_deactivateFeedback:function(t){t.deactivateSelectionFeedback?t.deactivateSelectionFeedback():t.setMultiDeselected&&t.setMultiDeselected()},_getPortNearest:function(t,e){let i=e.get2DPortPositions();return Object.keys(i).reduce((function(e,o){return Math.hypot(t.x-i[e].pointCoordinates.x,t.y-i[e].pointCoordinates.y)<Math.hypot(t.x-i[o].pointCoordinates.x,t.y-i[o].pointCoordinates.y)?e:o}))},_manipulateAnnotationAndTextSimultaneously:function(){let t,o,n,s,a,r,l,h,g,p,u,m;const f=new i.Vector3,b=new i.Vector3,w=new i.Matrix4,x=new i.Matrix4,v=new i.Matrix4,y=new i.Matrix4;return function(D,_,I){let T,C,P,R;h=this._viewer.currentViewpoint.project(this.corners.topLeft),g=this._viewer.currentViewpoint.project(this.corners.topRight),p=this._viewer.currentViewpoint.project(this.corners.bottomLeft),u=this._viewer.currentViewpoint.project(this.corners.bottomRight),"bottomRightHandler"===this.name||"rightCenterHandler"===this.name||"bottomCenterHandler"===this.name?(t=this.corners.topLeft,r=(new i.Vector3).subVectors(this.corners.topRight,t),a=r.length(),o=r.normalize(),r=(new i.Vector3).subVectors(this.corners.bottomLeft,t),s=r.length(),n=r.normalize()):"bottomLeftHandler"===this.name||"leftCenterHandler"===this.name?(t=this.corners.topRight,r=(new i.Vector3).subVectors(this.corners.topLeft,t),a=r.length(),o=r.normalize(),r=(new i.Vector3).subVectors(this.corners.bottomRight,t),s=r.length(),n=r.normalize()):"topRightHandler"===this.name||"topCenterHandler"===this.name?(t=this.corners.bottomLeft,r=(new i.Vector3).subVectors(this.corners.bottomRight,t),a=r.length(),o=r.normalize(),r=(new i.Vector3).subVectors(this.corners.topLeft,t),s=r.length(),n=r.normalize()):"topLeftHandler"===this.name&&(t=this.corners.bottomRight,r=(new i.Vector3).subVectors(this.corners.bottomLeft,t),a=r.length(),o=r.normalize(),r=(new i.Vector3).subVectors(this.corners.topRight,t),s=r.length(),n=r.normalize()),l=e.compute3DPointFrom2DPoint(I,this._refPlane,this._viewer),f.subVectors(l,t),o&&"bottomCenterHandler"!==this.name&&"topCenterHandler"!==this.name&&(C=f.dot(o)-this._widthMargin,C<.1&&(C=.1),this.minimumYScale>C/a&&(C=this.minimumYScale*a)),n&&"rightCenterHandler"!==this.name&&"leftCenterHandler"!==this.name&&(T=f.dot(n)-this._widthMargin,T<.1&&(T=.1)),T&&C?(b.copy(n).multiplyScalar(.5*T).add(t),b.addVectors(b,(new i.Vector3).copy(o).multiplyScalar(.5*C)),P=T/s,R=C/a):T?(b.copy(n).multiplyScalar(.5*T).add(t),b.addVectors(b,(new i.Vector3).copy(o).multiplyScalar(.5*a)),P=T/s):C&&(b.copy(o).multiplyScalar(.5*C).add(t),b.addVectors(b,(new i.Vector3).copy(n).multiplyScalar(.5*s)),R=C/a),w.makeScale(P||1,R||1,1),x.copy(y),x.makeTranslation(b.x,b.y,b.z),x.multiply(this._originalMatrix),x.multiply(w);let S=D.getSubTextMedia().getLineHeight()+"px",A=D.getTemporaryModifiedLocalPoints(x);v.copy(y);let M=new i.Vector3,E=new i.Quaternion,O=new i.Vector3;x.decompose(M,E,O),v.compose(M,E,new i.Vector3(1,1,1));let V=[];for(let t=0;t<A.length;++t)V.push(this._viewer.currentViewpoint.project(A[t]));let L=d.convexHullCompute(V),k=d.boundingBoxCompute(L),j=new i.Vector2((k[0].x+k[2].x)/2,(k[0].y+k[2].y)/2);try{let t=D.getSubTextCreationParams({currentMatrix:v,currentCenter2D:j,currentLocal2DPoints:V});m=t}catch{}let W,N=m.rectangle.topLeft.distanceTo(m.rectangle.topRight)/this.currentScalingFactor,B=m.rectangle.topLeft.distanceTo(m.rectangle.bottomLeft)/this.currentScalingFactor,U=c.wrapText(D.getSubTextMedia().getText(),this.font,N),H=c.measureText(U,this.font,S),F=H.height,z=H.width;if(F>B)if("bottomRightHandler"===this.name||"bottomLeftHandler"===this.name||"rightCenterHandler"===this.name||"leftCenterHandler"===this.name||"topRightHandler"===this.name||"topLeftHandler"===this.name){let e=(F+2*c.BoundTextPadding)*this.currentScalingFactor;"circle"===D.getPreDefinedShapeType()||"ellipse"===D.type?e=Math.round((F+2*c.BoundTextPadding)/Math.sqrt(2)*2)*this.currentScalingFactor:"rhombus"===D.getPreDefinedShapeType()||"triangle"===D.getPreDefinedShapeType()?e*=2:"arrow"===D.getPreDefinedShapeType()||"doublearrow"===D.getPreDefinedShapeType()?e*=2.235294117647:"callout"===D.getPreDefinedShapeType()?e*=1.26628895184:"cloud"===D.getPreDefinedShapeType()?e/=.53604436229205:"cross"===D.getPreDefinedShapeType()?e*=3.589887640449:"pentagon"===D.getPreDefinedShapeType()?e*=1.288629737609:"star"===D.getPreDefinedShapeType()?e/=.56893819334389:"verticalCylinder"===D.getPreDefinedShapeType()?e/=.396804260985353:"foursideCircle"===D.getPreDefinedShapeType()&&(e/=.50328515111695),P=e/g.distanceTo(u),T=P*s,w.makeScale(P,R,1),b.copy(n).multiplyScalar(.5*T).add(t),b.addVectors(b,(new i.Vector3).copy(o).multiplyScalar(.5*C)),x.copy(y),x.makeTranslation(b.x,b.y,b.z),x.multiply(this._originalMatrix),x.multiply(w)}else if("bottomCenterHandler"===this.name||"topCenterHandler"===this.name){let e=(F+2*c.BoundTextPadding)*this.currentScalingFactor;"circle"===D.getPreDefinedShapeType()||"ellipse"===D.type?e=Math.round((F+2*c.BoundTextPadding)/Math.sqrt(2)*2)*this.currentScalingFactor:"rhombus"===D.getPreDefinedShapeType()||"triangle"===D.getPreDefinedShapeType()?e*=2:"arrow"===D.getPreDefinedShapeType()||"doublearrow"===D.getPreDefinedShapeType()?e*=2.235294117647:"callout"===D.getPreDefinedShapeType()?e*=1.26628895184:"cloud"===D.getPreDefinedShapeType()?e/=.53604436229205:"cross"===D.getPreDefinedShapeType()?e*=3.589887640449:"pentagon"===D.getPreDefinedShapeType()?e*=1.288629737609:"star"===D.getPreDefinedShapeType()?e/=.56893819334389:"verticalCylinder"===D.getPreDefinedShapeType()?e/=.396804260985353:"foursideCircle"===D.getPreDefinedShapeType()&&(e/=.50328515111695),P=e/g.distanceTo(u),T=P*s,w.makeScale(P,1,1),b.copy(n).multiplyScalar(.5*T).add(t),b.addVectors(b,(new i.Vector3).copy(o).multiplyScalar(.5*a)),x.copy(y),x.makeTranslation(b.x,b.y,b.z),x.multiply(this._originalMatrix),x.multiply(w)}let $=D.getTemporaryModifiedLocalPoints(x);V=[];for(let t=0;t<$.length;++t)V.push(this._viewer.currentViewpoint.project($[t]));v.copy(y);let G=new i.Vector3,Y=new i.Quaternion,X=new i.Vector3;x.decompose(G,Y,X),v.compose(G,Y,new i.Vector3(1,1,1));let J=V[0].clone(),K=V[0].clone();for(var q=1;q<V.length;q++)V[q].x<J.x?J.x=V[q].x:V[q].x>K.x&&(K.x=V[q].x),V[q].y<J.y?J.y=V[q].y:V[q].y>K.y&&(K.y=V[q].y),V[q].z<J.z?J.z=V[q].z:V[q].z>K.z&&(K.z=V[q].z);let Q=J.clone().add(K.clone().sub(J).multiplyScalar(.5)),Z=D.getSubTextCreationParams({currentMatrix:v,currentCenter2D:Q,currentLocal2DPoints:V});N=Z.rectangle.topLeft.distanceTo(Z.rectangle.topRight)/this.currentScalingFactor,B=Z.rectangle.topLeft.distanceTo(Z.rectangle.bottomLeft)/this.currentScalingFactor,U=c.wrapText(D.getSubTextMedia().getText(),this.font,N),H=c.measureText(U,this.font,S),z=H.width;let tt={width:z+5,height:F},et=new i.Vector2(Z.center.x,Z.center.y),it=new i.Vector2((Z.rectangle.topLeft.x+Z.rectangle.topRight.x)/2,(Z.rectangle.topLeft.y+Z.rectangle.topRight.y)/2);if(Z.center.distanceTo(it)<tt.height*this.currentScalingFactor/2){let t=[],e=1;t.push(Z.rectangle.topLeft),t.push(Z.rectangle.topRight),t.push(Z.rectangle.bottomRight),t.push(Z.rectangle.bottomLeft),d._isInsidePolygon(Z.center,t)||(e=-1);let o=tt.height*this.currentScalingFactor/2-e*Z.center.distanceTo(it),n=(new i.Vector2).subVectors(Z.rectangle.bottomLeft,Z.rectangle.topLeft).normalize();et=(new i.Vector2).addVectors(et,(new i.Vector2).copy(n).multiplyScalar(o))}if("left"===D.getSubTextMedia().getDataService().getValue("textAlign")||"right"===D.getSubTextMedia().getDataService().getValue("textAlign")){let t=new i.Vector2(Z.rectangle.topRight.x-Z.rectangle.topLeft.x,Z.rectangle.topRight.y-Z.rectangle.topLeft.y).normalize();if("left"===D.getSubTextMedia().getDataService().getValue("textAlign")){let e=new i.Vector2((Z.rectangle.bottomLeft.x+Z.rectangle.topLeft.x)/2,(Z.rectangle.bottomLeft.y+Z.rectangle.topLeft.y)/2);et=(new i.Vector2).addVectors(e,(new i.Vector2).copy(t).multiplyScalar(tt.width*this.currentScalingFactor/2))}else{let e=new i.Vector2((Z.rectangle.bottomRight.x+Z.rectangle.topRight.x)/2,(Z.rectangle.bottomRight.y+Z.rectangle.topRight.y)/2);et=(new i.Vector2).addVectors(e,(new i.Vector2).copy(t).multiplyScalar(tt.width*this.currentScalingFactor*-1/2))}}let ot=e.compute3DPointFrom2DPoint(et,this._refPlane,this._viewer),nt=D.getSubTextMedia().getMatrix(),st=(new i.Matrix4).makeScale(1,1,1),at=new i.Matrix4;at.makeRotationFromQuaternion(Y);let rt=(new i.Matrix4).getInverse(at),lt=new i.Vector3,ht=new i.Quaternion,ct=new i.Vector3;nt.decompose(lt,ht,ct);let dt=new i.Matrix4;dt.makeRotationFromQuaternion(ht);let gt=(new i.Matrix4).makeScale(ct.x,ct.y,ct.z);nt=(new i.Matrix4).multiply(dt).multiply(gt),nt.setPosition(ot),W=nt.clone(),W.multiply(rt),W.multiply(st);let pt=(new i.Vector3).getPositionFromMatrix(x.clone());ot.applyMatrix4(rt),pt.applyMatrix4(rt),W.setPosition(new i.Vector3(ot.x-pt.x,ot.y-pt.y,ot.z-pt.z)),W=JSON.stringify(W),D.getSubTextMedia().redrawText({inputDimensions:tt,isTransient:!0,timestamp:_,textMasterDifferentialMatrix:W},(()=>{})),D.setTransformation(_,x,!0)}}()});return g.getRotationHandlePosition=function(t,o=!1){let n,s,a,r,l=t.getManipulatorsPositions();l.topLeft&&(n=l.topLeft,s=l.topRight,a=l.bottomLeft,r=l.bottomRight);let h=new i.Vector3((n.x+s.x)/2,(n.y+s.y)/2,(n.z+s.z)/2),c=new i.Vector3((a.x+r.x)/2,(a.y+r.y)/2,(a.z+r.z)/2),d=(new i.Vector3).addVectors(c,h).multiplyScalar(.5),g=e.compute2DPointFrom3DPoint(d,t._viewer),p=e.compute2DPointFrom3DPoint(h,t._viewer),u=(new i.Vector2).subVectors(g,p);u.normalize();let m,f=2*g.distanceTo(p);return m=o?f>50?45:f-5:f>50?50:f,u.multiplyScalar(-m),(new i.Vector2).addVectors(u,p)},t.namespace("DS/CAT3DWInfraUI/CAT3DWHandleManipulator",g)})),define("DS/CAT3DWInfraUI/CAT3DWRenameReplaceDialog",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/LineEditor","DS/ApplicationFrame/FrameWindowsManager","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWRenameReplaceDialog"],(function(t,e,i,o,n,s,a,r){"use strict";function l(t,e,i){return(t.replace(/\.[^.]*$/,"")||e)+"."+i}return{generateRenameReplaceDialog:function(e,h,c,d,g){var p="replace",u=new n({type:"radio",label:r.get("ReplaceOption"),checkFlag:!0}),m=new n({type:"radio",label:r.get("RenameOption")}),f=new s({sizeInCharNumber:40,value:d+"."+g,disabled:!0}),b=new t.createElement("div",{styles:{"margin-left":"22px","margin-top":"5px"},html:'<p style="margin-bottom:4px;">'+r.get("RenameDescription")+"</p>"});f.inject(b);var w=new t.createElement("div",{styles:{"margin-left":"10px","margin-top":"7px","margin-bottom":"15px"}});t.createElement("div",{styles:{"margin-bottom":"7px"}}).inject(w).textContent=c+"."+g,u.inject(w),m.inject(w),b.inject(w);var x=new t.createElement("div",{styles:{width:350,"margin-top":"10px","margin-left":"7px"},html:"<p>"+r.get("ReplaceDialogMessage")+"</p>"});w.inject(x);var v=a.getFrameWindow(),y=new i({immersiveFrame:v.getImmersiveFrame(),title:r.get("ReplaceDialogTitle"),closeButtonFlag:!1,content:x,buttons:{Ok:new o({label:r.get("ReplaceDialogAccept"),onClick:function(t){f.value=l(f.value,d,g);var i={type:p,newFilename:f.value};e(i)}}),Cancel:new o({onClick:function(t){h()}})}});return m.addEventListener("change",(function(t){f.disabled=!m.checkFlag,p=m.checkFlag?"rename":"replace"})),f.addEventListener("blur",(function(t){f.value=l(f.value,d,g)})),y}}})),define("DS/CAT3DWInfraUI/CAT3DWAssistantTool",["DS/Manipulators/Manipulator","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","UWA/Core"],(function(t,e,i){"use strict";var o=e.extend({init:function(t,e,i,o){i||(i=e.getUIFrame());var n={body:i,viewer:t,frmWindow:e,heightElem:"28",widthElem:"28",offset:(o=o||{}).offset?o.offset:{x:-9,y:10},title:"Assistant tools Control",mode:o.mode?o.mode:"horizontal",dir:"left",lJsonElement:[]};this._parent(n),this.setVisibleFlag(!1)}});return i.namespace("DS/CAT3DWInfraUI/CAT3DWAssistantTool",o)})),define("DS/CAT3DWInfraUI/CAT3DWCopyLinkDialog",["UWA/Core","DS/Windows/Dialog","DS/ApplicationFrame/FrameWindowsManager","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWCopyLinkDialog","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],(function(t,e,i,o){"use strict";return{generateCopyLinkDialog:function(n,s){var a=s?o.get("RootFolderErrorMsg"):o.get("MainMsg"),r=new t.createElement("div",{class:"copylinkdialog-maindiv",html:"<p>"+a+"</p>"}),l=new t.createElement("div",{class:"copylinkdialog-copylinkdiv"});l.inject(r);var h=new t.createElement("input",{class:"copylinkdialog-sharebylinkinput"});h.value=n,h.disabled=!0,h.inject(l);var c=new t.createElement("button",{class:"copylinkdialog-copylinkbtn"});c.onclick=function(e){!function(e){var i=document.createElement("textarea");if(i.value=e,document.body.appendChild(i),t.Utils.Client.Platform.ios||t.Utils.Client.Platform.ipad){i.contentEditable=!0,i.readOnly=!0;var o=document.createRange();o.selectNodeContents(i);var n=window.getSelection();n.removeAllRanges(),n.addRange(o),i.setSelectionRange(0,i.value.length)}else i.select();document.execCommand("copy"),document.body.removeChild(i)}(n)},c.inject(l),new t.createElement("i",{class:"fonticon fonticon-link"}).inject(c),new t.createElement("span",{html:"  "+o.get("CopyLinkBtn")}).inject(c);var d=new t.createElement("div",{class:"copylinkdialog-openlinkdiv",html:"<p>"+o.get("OpenLinkMsg")+"</p>"});d.inject(r);var g=new t.createElement("button",{class:"copylinkdialog-openlinkbutton"});g.onclick=function(t){g.blur(),window.open(n,"_blank")},g.inject(d),new t.createElement("i",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-in-a-new-window"}).inject(g),new t.createElement("span",{html:"  "+o.get("OpenLinkBtn")}).inject(g);var p=i.getFrameWindow();return new e({immersiveFrame:p.getImmersiveFrame(),title:o.get("CopyLinkDialogTitle"),modalFlag:!0,content:r})}}})),define("DS/CAT3DWInfraUI/CAT3DWDataModelConverter",["UWA/Class","DS/CAT3DWRichLinksUI/CAT3DWLinkProcessingUtils","DS/Visualization/ThreeJS_DS"],(function(t,e,i){"use strict";var o=t.extend({init:function(t){this._version=t.version,this._webapp=t.webapp,this._platformId=t.platformId,this._platformUrl=t.platformUrl,this._originUrl=t.originUrl,this._appName=t.appName,this._viewer=t.viewer,this._viewpoint=t.viewpoint,this._versionMap=new Map,this._versionMap.set("1.0",null),this._versionMap.set("2.0",this._from1Dot0To2Dot0.bind(this)),this._versionMap.set("2.1",this._from2Dot0To2Dot1.bind(this)),this._versionMap.set("3.0",this._from2Dot1To3Dot0.bind(this)),this._versionMap.set("4.0",this._from3Dot0To4Dot0.bind(this)),this._versionMap.set("5.0",this._from4Dot0To5Dot0.bind(this))},convertToLatestVersion:function(t){return new Promise(async function(e,i){var o=JSON.parse(t).ver;if(console.log("[CAT3DWDataModelConverter] START CONVERSION ..."),console.log("[CAT3DWDataModelConverter] The current version is "+this._version),console.log("[CAT3DWDataModelConverter] The json version is "+o),o!==this._version){if(!this._versionMap.has(o))return console.error("[CAT3DWDataModelConverter] The JSON version does not match any known version"),void i();var n=t,s=1;for(var[a,r]of this._versionMap)parseFloat(a)<=parseFloat(o)||(console.log("[CAT3DWDataModelConverter] From "+s+" to "+a),r&&(n=await r(n))),s=a;console.log("[CAT3DWDataModelConverter] ... CONVERSION FINISHED"),e(n)}else e(t)}.bind(this))},_from1Dot0To2Dot0:function(t){return new Promise(function(e){var i=JSON.parse(t);i.ver="2.0";var o=[];if(i.Textboxes&&i.Textboxes.length)for(let t=0;t<i.Textboxes.length;t++){let e=i.Textboxes[t],n={id:"",matrix:e.matrix,selectionGroupID:e.selectionGroupID,color:e.color,backgroundColor:"",text:e.text,renderDepth:e.renderDepth,locked:""},s=new UWA.Element("div",{styles:{position:"fixed",display:"block"}}),a=new UWA.Element("div",{styles:{fontSize:"66px",lineHeight:"90px",paddingTop:"0px",paddingLeft:"10px",paddingBottom:"0px",paddingRight:"10px"}}).inject(s);new UWA.Element("div",{styles:{whiteSpace:"pre",textAlign:"left"}}).inject(a).setText(e.text),s.inject(document.body),n.inputDimensions=a.getSize(),s.destroy(),s=null,o.push(n)}i.Textboxes=o,e(JSON.stringify(i))}.bind(this))},_from2Dot0To2Dot1:function(t){return new Promise(function(e){var o=JSON.parse(t);if(o.ver="2.1",o.Textboxes&&o.Textboxes.length)for(let t=0;t<o.Textboxes.length;t++){let e="",n=o.Textboxes[t];if(n.matrix){e=new i.Matrix4;let s=JSON.parse(n.matrix);if(e.setFromArray(s.elements),!n.worldDimensions){let n=e.getScaleOnAxisX(),s=e.getScaleOnAxisY(),a=e.getScaleOnAxisZ(),r=100;o.Textboxes[t].worldDimensions={width:r*n,height:r*s};let l=(new i.Matrix4).extractPosition(e),h=(new i.Matrix4).extractRotation(e);l.multiply(h);let c=(new i.Matrix4).makeScale(a,a,a);l.multiply(c),e=l}o.Textboxes[t].matrix=JSON.stringify(e)}}e(JSON.stringify(o))}.bind(this))},_from2Dot1To3Dot0:function(t){return new Promise(async function(n){var s=JSON.parse(t);if(s.links=[],s.ver="3.0",this._webapp===o.APP_3DWHITEBOARD){var a=new e({platformId:this._platformId,platformUrl:this._platformUrl,originUrl:this._originUrl,appName:this._appName}),r=function(t){return new Promise(function(e){var i=t.trim();i.startsWith("http://")||i.startsWith("https://")||(i="https://"+i),a.processLink(i).then(function(t){t.notreachable?e():e(t)}.bind(this))}.bind(this))}.bind(this),l=[];if(s.Textboxes&&s.Textboxes.length)for(let t=0;t<s.Textboxes.length;t++){if(s.Textboxes[t].backgroundColor){l.push(s.Textboxes[t]);continue}let e=s.Textboxes[t].text;if(!a.isLinkFormat(e.trim())){l.push(s.Textboxes[t]);continue}let o=await r(e);if(!o){l.push(s.Textboxes[t]);continue}let n=s.Textboxes[t];o.content||(o.content={});let g={id:n.id,renderDepth:n.renderDepth,url:o.url,locked:n.locked,selectionGroupID:n.selectionGroupID,matrix:"",linkData:{type:o.type,content_type:o.content_type,view_type:"small"}},p="";if(n.matrix){let t=new i.Matrix4,e=JSON.parse(n.matrix);t.setFromArray(e.elements);var h=new i.Vector3,c=new i.Quaternion,d=new i.Vector3;t.decompose(h,c,d);let o=n.worldDimensions.width/100;p=(new i.Matrix4).compose(h,c,new i.Vector3(o,o,1))}p&&(g.matrix=JSON.stringify(p)),"internal"===o.type?(g.smallViewThumbnailSubject6wuri=o.content.thumbnail_id,g.smallViewThumbnailPublished=o.content.thumbnail_published):g.smallViewThumbnailUrl=o.content.thumbnail_blob_url,o.content.title&&(g.linkData.title=o.content.title),o.content.author&&(g.linkData.author=o.content.author),o.content.community&&(g.linkData.community=o.content.community),o.content.description&&(g.linkData.description=o.content.description),o.content.mediaType&&(g.linkData.mediaType=o.content.mediaType),o.content.hostname&&(g.linkData.hostname=o.content.hostname),s.links.push(g)}s.Textboxes=l}else s.Textboxes=[];n(JSON.stringify(s))}.bind(this))},_from3Dot0To4Dot0:function(t){return new Promise(async function(e){var i=JSON.parse(t);i.stickers||this._webapp!==o.APP_3DWHITEBOARD||(i.stickers=[]),i.ver="4.0",e(JSON.stringify(i))}.bind(this))},_from4Dot0To5Dot0:function(t){return new Promise(async function(e){var i=JSON.parse(t);if(i.Textboxes&&i.Textboxes.length)for(let t=0;t<i.Textboxes.length;t++){if(i.Textboxes[t].inputDimensions){let e=i.Textboxes[t].inputDimensions;i.Textboxes[t].inputDimensions={width:e.width/3,height:e.height/3}}i.Textboxes[t].fontStyle="normal",i.Textboxes[t].fontWeight="normal",i.Textboxes[t].textAlign="left",i.Textboxes[t].fontFamily="GochiHand",i.Textboxes[t].fontSize=22,i.Textboxes[t].lineHeight=30}i.ver="5.0",e(JSON.stringify(i))}.bind(this))}});return o.APP_3DWHITEBOARD="3dwhiteboard",o.APP_3DSKETCH="3dsketch",o})),define("DS/CAT3DWInfraUI/CAT3DSKHistoryManager",["UWA/Class","DS/ApplicationFrame/CommandsManager","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CoreEvents/Events"],(function(t,e,i,o){"use strict";var n=t.extend({init:function(t){this._mediaController=t.mediaController,this._objectsStateID={},this._actionsHistory=[],this._undoableActions=[],this._redoableActions=[],this._objectActionList=[],this._objectList=[],this._debugTraces=!1,this._undoStack=[],this._redoStack=[]},registerAction:function(t,e,i=!1,s=!1){let a=[];for(let i=0;i<e.length;i++)e[i].hasAction(t)&&a.push(e[i]);a.length&&!s?(i?this._undoStack=[]:this._undoStack.push({timestamp:t,objects:a}),this._redoStack=[]):i&&(this._undoStack=[]),o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{timestamp:t,objects:a,isEmpty:!!i,isRedoEmpty:!0,updateType:n.UPDATE_TYPE.NEW_ACTION}})},registerLayersChange:function(){this._objectActionList=[],this._objectList=[],this._registerLayersChange()&&this._registerNewAction(n.UPDATE_TYPE.NEW_COMPLEX_ACTION)},_registerLayersChange:function(){let t=this._mediaController.getDepthOrder();if(!t.length)return!1;const e="LAYERS";var i,o=void 0,s=null,a=t,r=this._objectsStateID[e];return r?(o=r.updateID,r.updateID++,s=n.ACTION.EDITED):((r={object:this._mediaController,objectType:n.DATA_TYPE.LAYERS,updateID:0,actions:{}}).actions[n.ACTION.EDITED]=[{actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length}],this._objectsStateID[e]=r,s=n.ACTION.CREATED),i=r.updateID,this._objectActionList.push({id:e,type:n.DATA_TYPE.LAYERS,precedentUpdateID:o,newUpdateID:i,action:s,actionData:a}),this._objectList.push(this._mediaController),!0},_registerNewAction:function(t){var e={timestamp:Date.now(),objectActionList:this._objectActionList},i={objects:this._objectList,updateType:t,isEmpty:0===this._undoStack.length,isRedoEmpty:0===this._redoStack.length,action:e,states:[]};o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:i}),this._objectActionList=[],this._objectList=[]},dumpHistoryStackToJson:function(){return JSON.stringify(this._actionsHistory)},restoreHistoryStackFromJson:function(t){this._actionsHistory=JSON.parse(t)},_isUndoEmpty:function(){return 0===this._undoableActions.length},_isRedoEmpty:function(){return 0===this._redoableActions.length},undo:function(){let t=this._undoStack.pop();if(t){for(let e=0;e<t.objects.length;e++)t.objects[e].undoAction(t.timestamp);this._redoStack.push(t),o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{timestamp:t.timestamp,objects:t.objects,isEmpty:0===this._undoStack.length,isRedoEmpty:0===this._redoStack.length,updateType:n.UPDATE_TYPE.UNDO}})}},redo:function(){let t=this._redoStack.pop();if(t){for(let e=0;e<t.objects.length;e++)t.objects[e].redoAction(t.timestamp);this._undoStack.push(t),o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{timestamp:t.timestamp,objects:t.objects,isEmpty:0===this._undoStack.length,isRedoEmpty:0===this._redoStack.length,updateType:n.UPDATE_TYPE.REDO}})}},clear:function(){this._actionsHistory=[],this._undoableActions=[],this._redoableActions=[],o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{isEmpty:this._isUndoEmpty(),isRedoEmpty:this._isRedoEmpty(),updateType:n.UPDATE_TYPE.CLEAR}})}});return n.ACTION={CREATED:0,DISCARDED:1,MOVED:2,EDITED:3},n.UPDATE_TYPE={NEW_ACTION:0,NEW_COMPLEX_ACTION:1,UNDO:2,REDO:3,CLEAR:4},n.DATA_TYPE={SKETCH:0,MEDIA:1,GROUP:2,LAYERS:3,CONNECTION:4},n})),define("DS/CAT3DWInfraUI/CAT3DWCanvasLimits",["DS/CAT3DWInfra/CAT3DWPreferenceManager"],(function(t){"use strict";const e={get MPLimit(){return t.getPreferenceValue("R2VPerspectiveModeOn")?2e6:5e6},areDimensionsWithinLimits:function(t,i){return!t||!i||t*i<e.MPLimit}};return e})),define("DS/CAT3DWInfraUI/CAT3DWLoader",["UWA/Class","DS/Controls/Loader","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWLoader","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],(function(t,e,i){var o=t.extend({init:function(){this._loaderDiv=null,this._loader=null,this._container=null,this._defaultText=i.get("defaultLoader"),this._defaultFadeDuration=500},initialize:function(t){this._container=t},show:function(t,e){document.getElementById("x3DPhotoLoader")?this.reset():this._createLoader(),t&&(this._loader.text=t),null!=e&&(this._loader.fadeDuration=e),this._loader.on(),this._loaderDiv.show()},update:function(t){document.getElementById("x3DPhotoLoader")||this.show(),this._loader.update(t)},on:function(t){this._loader.on(t)},showSuccessAndhide:function(){document.getElementById("x3DPhotoLoader")&&(this._successDiv.show(),this._loader.elements.progressBar.emphasize="success",this._loader.text="",this._loaderDiv.hide(),setTimeout(function(){this._successDiv.hide(),this.reset()}.bind(this),1500))},showFailureAndhide:function(){document.getElementById("x3DPhotoLoader")&&(this._failureDiv.show(),this._loader.elements.progressBar.emphasize="high-attention",this._loader.text="",this._loaderDiv.hide(),setTimeout(function(){this._loaderDiv.hide(),this.reset()}.bind(this),1500))},hide:function(){document.getElementById("x3DPhotoLoader")&&(this._loaderDiv.hide(),this.reset())},reset:function(){this._loader.text=this._defaultText,this._loader.fadeDuration=this._defaultFadeDuration,this._loader.elements.progressBar.statusFlag=!1,this._loader.elements.progressBar.infiniteFlag=!0},remove:function(){this._loaderDiv.empty(),this._loaderDiv=null,this._loader=null},_createLoader:function(){this._loaderDiv=new UWA.Element("div",{class:"loader",id:"x3DPhotoLoader"}).inject(this._container);var t=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._loaderDiv),i=new UWA.Element("div",{class:"loader-content"}).inject(t);this._loader=new e({text:this._defaultText,fadeDuration:this._defaultFadeDuration}).inject(i),this._successDiv=new UWA.Element("div",{class:"loader loaderSuccessOrFailure"}).inject(this._container);var o=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._successDiv),n=new UWA.Element("div",{class:"loader-content"}).inject(o);n.classList.add("wux-ui-3ds","wux-ui-3ds-5x","wux-ui-3ds-check"),n.style="color:green;",this._successDiv.hide(),this._failureDiv=new UWA.Element("div",{class:"loader loaderSuccessOrFailure"}).inject(this._container);var s=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._failureDiv),a=new UWA.Element("div",{class:"loader-content"}).inject(s);a.classList.add("wux-ui-3ds","wux-ui-3ds-5x","wux-ui-3ds-attention"),a.style="color:red;",this._failureDiv.hide()}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWLoader",o.singleton())})),define("DS/CAT3DWInfraUI/CAT3DWInternalClipboard",["UWA/Class","UWA/Core"],(function(t,e){"use strict";var i=t.extend({init:function(t,e){this._debugMode=t,this._mediaController=e,this._mediaToCopy=null},empty:function(){this._mediaToCopy=null},isEmpty:function(){return!this._mediaToCopy},getCopiedMedia:function(){if(!this._mediaToCopy)return null;var t=this._getClone(this._mediaToCopy);if(this._mediaToCopy.objects){let e=[];for(let t=0;t<this._mediaToCopy.objects.length;t++){let i=this._getClone(this._mediaToCopy.objects[t]);e.push(i)}t.objects=e}return t},_getClone:function(t){var e=Object.assign({},t);return t.object?e.object=Object.assign({},t.object):t.annot,e},writeText:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.masterMediaID=void 0,i.object.renderDepth=void 0,i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeLink:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,t.getDataService().getValue("isReady")||(i.object.linkData.view_type=void 0),i.object.mediaOccId=t.getMediaOccId(),i.object.fullViewUrl=t.getFullViewUrl(),i.object.smallViewThumbnailUrl=t.getSmallViewThumbnailUrl(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeSticker:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeImage:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getDataService().getData().url,i.object.cropData=t.getDataService().getData().cropData,i.object.opacity=t.getDataService().getData().opacity,i.object.file=t.getFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeImageTemplate:function(t,e,i){var o;if(i?o=i:(this.empty(),this._mediaToCopy={},o=this._mediaToCopy),o.object=t.stream(),o.object.id=void 0,o.object.currentMediaId=void 0,o.object.renderDepth=void 0,o.object.url=t.getDataService().getData().url,o.object.cropData=t.getDataService().getData().cropData,o.object.opacity=t.getDataService().getData().opacity,o.object.file=t.getFile(),o.object.mediaOccId=t.getMediaOccId(),o.type=t.getType(),o.previousID=t.getID(),o.objects=[],e){let t={};this.writeImage(e,t),t.tag="image",o.objects.push(t)}return Promise.resolve()},writeVideo:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getTexture().image.currentSrc,i.object.streams=t.getDataService().getData().streams,i.object.thumbnailURL=t.getDataService().getData().thumbnailURL,i.object.currentStream=t.getDataService().getData().currentStream,i.object.file=t.getFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeModel:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getDataService().getData().url,i.object.file=t.getFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeHybridModel:function(t,e){var i;e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy);var o=t.getTextureClone();return i.object=t.stream(),i.object.imagepublished=void 0,i.object.mediaIdImage=void 0,i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getDataService().getData().url,i.object.file=t.getModelFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),i.object.viewType=t.getDataService().getData().viewType,i.object.viewMode=t.getDataService().getData().viewMode,i.object.shadingMode=t.getDataService().getData().shadingMode,i.object.sessionData=t.getDataService().getData().sessionData,i.object.spaceData=t.getDataService().getData().spaceData,i.object.imageurl=o.image.currentSrc,i.object.fileImage=t.getImageFile(),i.previousPositionModel=t.getModelView().getMatrix().clone(),i.title=t.getDataService().getData().title,i.extension=t.getDataService().getData().extension,i.mediaType=t.getDataService().getData().mediaType,i.filetype=t.getDataService().getData().filetype,i.title_thumbnail=t.getDataService().getData().title_thumbnail,i.extension_thumbnail=t.getDataService().getData().extension_thumbnail,i.mediaType_thumbnail=t.getDataService().getData().mediaType_thumbnail,i.filetype_thumbnail=t.getDataService().getData().filetype_thumbnail,i.isVideo=!1,Promise.resolve()},writeComparison:function(t,e){var i;if(e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.type=t.getType(),i.objects=[],i.object.comparisonInfo&&i.object.comparisonInfo.img1){let e=t.getImageMedia(i.object.comparisonInfo.img1.id);if(e){let t={};"CAT3DWModel"===e.getType()?this.writeHybridModel(e,t):"CAT3DWImage"===e.getType()&&this.writeImage(e,t),t.tag="image1",i.objects.push(t)}}if(i.object.comparisonInfo&&i.object.comparisonInfo.img2){let e=t.getImageMedia(i.object.comparisonInfo.img2.id);if(e){let t={};"CAT3DWModel"===e.getType()?this.writeHybridModel(e,t):"CAT3DWImage"===e.getType()&&this.writeImage(e,t),t.tag="image2",i.objects.push(t)}}return Promise.resolve()},writeAIGeneration:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeAnnot:function(t,e){var i;if(e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.type=t.getType(),i.annot=t,i.previousID=t.getID(),t.getSubTextMedia&&t.getSubTextMedia()){let e={};this.writeText(t.getSubTextMedia(),e),i.subText=e}return Promise.resolve()},writeGroupOrMultiselection:function(t,e){var i;let o;e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.type=t.getType(),i.objects=[],i.layeredObjects=[],i.matrix=t.getCurrentTransformation();const n=(t,e)=>{switch(o=t.getType(),o){case"CAT3DWText":this.writeText(t.getMediaObj(),e);break;case"CAT3DSKLink":this.writeLink(t.getMediaObj(),e);break;case"CAT3DSKSticker":this.writeSticker(t.getMediaObj(),e);break;case"CAT3DWImage":if(t.getMediaObj().getDataService().getValue("isTemplate")){let i,o=t.getMediaObj().getDataService().getValue("currentMediaId");o&&(i=this._mediaController.getImageFromID(o)),this.writeImageTemplate(t.getMediaObj(),i,e)}else this.writeImage(t.getMediaObj(),e);break;case"CAT3DWVideo":this.writeVideo(t.getMediaObj(),e);break;case"CAT3DWModel":this.writeHybridModel(t.getMediaObj(),e);break;case"CAT3DSKAnnotationShape":this.writeAnnot(t,e);break;case"CAT3DSKGroupOfObjects":this.writeGroupOrMultiselection(t,e);break;case"CAT3DSKComparison":this.writeComparison(t,e);break;case"CAT3DSKAIGeneration":this.writeAIGeneration(t.getMediaObj(),e);break;default:throw new Error("unknown type of object",o)}},s=t.getLayeredObjects();for(let t=0;t<s.length;t++)i.layeredObjects.push(s[t].getID());const a=t.getObjects();for(let t=0;t<a.length;t++){let e={};n(a[t],e),i.objects.push(e)}}});return e.namespace("DS/CAT3DWInfra/CAT3DWInternalClipboard",i)})),define("DS/CAT3DWInfraUI/CAT3DW3DDriveDialog",["UWA/Core","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/ComboBox","DS/TreeModel/TreeNodeModel","DS/Tree/FileTreeView","DS/TreeModel/TreeDocument","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CAT3DWInfra/CAT3DW3DDriveUtils","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DW3DDriveDialog"],(function(t,e,i,o,n,s,a,r,l,h){"use strict";var c=0,d=null,g=null,p=new Map,u=null,m=null,f=null,b=[],w=0,x=function(t,e){this.service=t,this.name=e,this.folderList=new Map},v=function(t,e,i,o,n){this.title=t,this.extension=n,this.path=o,this.id=e,this.node=i,this.children=[]};function y(t,e,i,o){var s=new n({label:t,icons:e?[{iconName:"3dpart"}]:"folder",children:e?null:[]});o?o.addChild(s):g.addRoot(s);var a=b[c].folderList.get(i);if(a)a.node=s;else{var r=o?p.get(o).path+"\\"+t:t;a=new v(t,i,s,r,e),b[c].folderList.set(i,a),o&&p.get(o).children.push(a)}p.set(s,a)}function D(){g.removeRoots(),p.clear(),y(h.get("myfiles"),null,"DSROOT",null),y(h.get("sharedwithme"),null,"sharedwithme",null)}function _(t,e){var i=[],o=[];e.forEach((function(t){if(null!==t.extension&&""!==t.extension){var e="."+t.extension;null!=f&&f.includes(e)&&o.push(t)}else i.push(t)})),i.sort((function(t,e){return t.title>e.title?1:-1})),i.forEach((function(e){y(e.title,null,e.id,t)})),o.sort((function(t,e){return t.title>e.title?1:-1})),o.forEach((function(e){y(e.title,e.extension,e.id,t)}))}function I(){var e=new t.createElement("div",{class:"3ddrivebrowser-treediv"});return g=new a({useAsyncPreExpand:!0}),(d=new s({treeDocument:g})).inject(e),g.onPreExpand((function(t){t&&function(t){if(t&&t.data&&t.data.nodeModel){var e=t.data.nodeModel,i=p.get(e);if(i&&t.target){var o=i.id,n=b[c].service;if(Array.isArray(e.options.children)&&e.options.children.length<1){var s=p.get(e);if(!(s.children.length>0))return l.getFolderContentsInTenant(o,n).then((function(i){Array.isArray(i.items)&&i.items.length>0&&_(e,i.items),t.target.preExpandDone()})).catch((function(){return t.target.preExpandDone(),!1}));_(e,s.children),t.target.preExpandDone()}else t.target.preExpandDone()}else t.target.preExpandDone()}}(t)})),d.onNodeClick((function(t){t&&t.nodeModel&&function(t){if(t){var e=p.get(t);e&&(console.log(e.path),t.isSelected()?(u.disabled=!1,m=t):(u.disabled=!0,m=null))}}(t.nodeModel)})),g.getXSO().onEmpty((function(){m=null,u.disabled=!0})),e}function T(n,s){var a=new t.createElement("div");(function(){for(var e=0;e<b.length;++e)if(b[e].service.platformId===widget.getValue("x3dPlatformId")){c=e;break}var i=new t.createElement("div",{styles:{padding:"10px"}});new t.createElement("img",{styles:{width:"25px"},src:require.toUrl("DS/SWXWebUI/assets/icons/32/SWXWeb3DDriveIcon.png")}).inject(i);var n=new o({domId:"3ddrivebrowser-combo",elementsList:b.map((t=>t.name)),selectedIndex:c,enableSearchFlag:!1});return n.addEventListener("change",(function(t){t&&t.dsModel&&(c=t.dsModel.selectedIndex,D())})),n.inject(i),i})().inject(a),I().inject(a),D(),u=new i({label:h.get("OKButton"),disabled:!0,onClick:function(t){var e=null;if(m){var i=p.get(m);e={fileId:i.id,filePath:i.path,fileName:i.title,tenant:b[c].service}}s(e)}});var r=new e({immersiveFrame:n,title:h.get("BrowseDialogTitle"),closeButtonFlag:!1,resizableFlag:!0,touchMode:!0,minWidth:300,width:300,modalFlag:!0,content:a,buttons:{Cancel:new i({onClick:function(t){s()}}),Ok:u}});return r.addEventListener("startResize",(function(t){t&&(w=t.srcElement.clientHeight)})),r.addEventListener("stopResize",(function(t){if(t){var e=t.srcElement.clientHeight-w;r.height-=e}})),r}return{generate3DDriveBrowser:async function(t,e,i){b=[];for(var o=await async function(){return new Promise((function(t){r.getServiceUrl({serviceName:"3DDrive",onComplete:function(e){t(e)}})}))}(),n=await async function(){return new Promise((function(t){return r.getPlatformServices({onComplete:function(e){t(e),console.log("data "+e)}})})).then((function(t){return t.map((function(t){return t.displayName}))}))}(),s=0;s<o.length;++s)if("url"in o[s]){var a=new x(o[s],n[s]);b.push(a)}f=i;var l=T(t,e);return document.getElementById("3ddrivebrowser-combo").style.width="250px",Promise.resolve(l)}}})),define("DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle",["DS/CAT3DWInfraUI/CAT3DWHandleManipulator","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/CAT3DWVisu/CAT3DWVisuServices","DS/Visualization/MaterialApplication","UWA/Class","UWA/Core"],(function(t,e,i,o,n,s,a,r){"use strict";var l=a.extend({init:function(t){this._parent(t),this._viewer=t.viewer,t.updateAll=this.updateAll.bind(this),this._createManipulators(this._getListOfManipulatorNames(),t),this.rotationHandler=this._manipulators.find((t=>"rotationHandler"===t.name)),t.media?this.objects=[t.media]:t.group&&this.setGroup(t.group),this.rotationHandler&&this.createLineNode()},_getListOfManipulatorNames:function(){return["bottomRightHandler","bottomLeftHandler","topRightHandler","topLeftHandler","rotationHandler"]},_createManipulators:function(e,i){if(this._manipulators)for(let t of this._manipulators)t.dispose();this._manipulators=[];for(let o of e)i.name=o,this._manipulators.push(new t(i))},updateAll:function(){for(let t of this._manipulators)t.update(!1);this._lineNode&&(this.disposeLineNode(),this.createLineNode())},createLineNode:function(){let a=this._manipulators.find((t=>"topLeftHandler"===t.name)),r=(new e.Vector3).getPositionFromMatrix(a.getMatrix());a=this._manipulators.find((t=>"topRightHandler"===t.name));let l,h=(new e.Vector3).getPositionFromMatrix(a.getMatrix());l=this._group?this._group:this.objects[0],a=this._manipulators.find((t=>"rotationHandler"===t.name));let c=t.getRotationHandlePosition(l,!0);c=n.compute3DPointFrom2DPoint(c,a.getReferencePlane(),this._viewer);let d=[c,new e.Vector3((r.x+h.x)/2,(r.y+h.y)/2,(r.z+h.z)/2)];this._lineNode=o.createLineNode({points:d,drawMode:i.ConnectivityTypeEnum.LINES,editable:!0}),this._lineNode.setPickable(i.PICKTHROUGH),this._lineNode.setExcludeFromBounding(!0),this._lineNode.setMaterialApplication(new s({lineMaterial:this._buildDottedBorderMaterial()})),this._viewer.getRootNode().getChildByName("sceneUINode").addChild(this._lineNode),this._lineNode.setNoZ(!0)},disposeLineNode:function(){this._lineNode&&(this._viewer.getRootNode().getChildByName("sceneUINode").removeChild(this._lineNode),this._lineNode=null)},_buildDottedBorderMaterial:function(){var t=new e.LineBasicMaterial({color:new e.Color("#42A2DA"),force:!0,transparent:!0,opacity:1,lineWidth:2});return t.depthTest=!0,t.depthWrite=!1,t.polite=!0,t.politeMaterial=t.clone(),t.politeMaterial.opacity=.15,t.politeMaterial.depthTest=!1,t.politeMaterial.depthWrite=!1,t},setManipulationCallbacks:function(t,e,i){for(let o of this._manipulators)o.setManipulationCallbacks(t,e,i)},removeManipulationCallbacks:function(){for(let t of this._manipulators)t.setManipulationCallbacks(null,null,null)},dispose:function(){for(let t of this._manipulators)t.dispose();this._manipulators=null,this.disposeLineNode(),this._parent()},setGroup:function(t){this._group=t,this.objects=this._group.getObjects(),this.update()},hideManipulator:function(){this.disposeLineNode();for(let t of this._manipulators)t.setVisibility(!1)},showManipulator:function(){if(!this._group||!this._group.isLocked()){this.disposeLineNode(),this.rotationHandler&&this.createLineNode();for(let t of this._manipulators)t.setVisibility(!0)}},getManipulatedObject:function(){return this._group?this._group:this.objects[0]},getLastTimestamp:function(){let t,e=0;for(let i of this._manipulators)t=i.getLastTimestamp(),t>e&&(e=t);return e},isActivated:function(){for(let t of this._manipulators)if(t.isActivated())return!0;return!1},setReferencePlane:function(t){for(let e of this._manipulators)e.setReferencePlane(t)},setRotationActivation:function(t){for(let e of this._manipulators)e.setRotationActivation(t)},isRotationActivated:function(){for(let t of this._manipulators)if(t.isRotationActivated())return!0;return!1},setScaleActivation:function(t){for(let e of this._manipulators)e.setScaleActivation(t)},isScaleActivated:function(){for(let t of this._manipulators)if(t.isScaleActivated())return!0;return!1},setSnappingForImageActivation:function(t){for(let e of this._manipulators)e.setSnappingForImageActivation(t)},isSnappingForImageActivated:function(){for(let t of this._manipulators)if(t.isSnappingForImageActivated())return!0;return!1},update:function(){for(let t of this._manipulators)t.update(!1)},updateRotationHandler:function(){this.rotationHandler&&this.rotationHandler.update(!0)},pause:function(){this.disposeLineNode();for(let t of this._manipulators)t.pause()},isPaused:function(){let t=!0;for(let e of this._manipulators)t=t&&e.isPaused();return t},resume:function(){for(let t of this._manipulators)t.resume()},getScreenPosition:function(){for(let t of this._manipulators)if(t.isActivated())return t.getScreenPosition()},setAdditionalObjectsToUpdate:function(t){for(let e of this._manipulators)e.setAdditionalObjectsToUpdate(t)}});return r.namespace("DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle",l)})),define("DS/CAT3DWInfraUI/CAT3DWPointerEvents",["UWA/Class","DS/Core/PointerEvents"],(function(t,e){"use strict";var i=t.extend({init:function(){this._palmThreshold=40},initialize:function(){document.addEventListener(e.POINTERDOWN,this._onPointerDown.bind(this)),document.addEventListener(e.POINTERMOVE,this._onPointerMove.bind(this)),document.addEventListener(e.POINTERUP,this._onPointerUp.bind(this)),document.addEventListener(e.POINTERHIT,this._onPointerHit.bind(this))},getPalmThreshold:function(){return this._palmThreshold},_onPointerDown:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSDOWN,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var o=this._createEvent(i.POINTERDOWN,t);t.target.dispatchEvent(o)}}},_onPointerMove:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSMOVE,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var o=this._createEvent(i.POINTERMOVE,t);t.target.dispatchEvent(o)}}},_onPointerUp:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSUP,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var o=this._createEvent(i.POINTERUP,t);t.target.dispatchEvent(o)}}},_onPointerHit:function(t){if(!(this._isPalm(t)||this._getNbFingers(t)>1)){var e=this._createEvent(i.POINTERHIT,t);t.target.dispatchEvent(e)}},_isMobile:function(){var t=navigator.userAgent;return!!new RegExp("Mobile").test(t)},_isPalm:function(t){if(this._isMobile()||!t.touches||!t.touches.length)return!1;for(var e=!1,i=0;i<t.touches.length;i++){var o=t.touches[0];(o.radiusX>this._palmThreshold||o.radiusY>this._palmThreshold)&&(e=!0)}return e},_getNbFingers:function(t){return t.touches?t.touches.length:0},_createEvent:function(t,e){var i=new MouseEvent(t,e);return i.oldPreventDefault=i.preventDefault,i.oldStopPropagation=i.stopPropagation,i.oldStopImmediatePropagation=i.stopImmediatePropagation,i.touchFlag=e.touchFlag,i.preventDefault=function(t){i.oldPreventDefault(),e.preventDefault()},i.stopPropagation=function(t){i.oldStopPropagation(),e.stopPropagation()},i.stopImmediatePropagation=function(t){i.oldStopImmediatePropagation(),e.stopImmediatePropagation()},i}});return i.POINTERDOWN="CAT3DWPointerDown",i.POINTERSDOWN="CAT3DWPointersDown",i.POINTERMOVE="CAT3DWPointerMove",i.POINTERSMOVE="CAT3DWPointersMove",i.POINTERUP="CAT3DWPointerUp",i.POINTERSUP="CAT3DWPointersUp",i.POINTERHIT="CAT3DWPointerHit",UWA.namespace("DS/CAT3DWInfraUI/CAT3DWPointerEvents",i)})),define("DS/CAT3DWInfraUI/CAT3DWClipboard",["UWA/Class","UWA/Utils/Client","DS/WAFData/WAFData"],(function(t,e,i){"use strict";var o=UWA.Class.extend({init:function(t,e){this._debugMode=t,this._isODT=e},writeText:function(t,i){return new Promise(function(n,s){if(this._isODT)return console.warn("Dont write text in the clipboard in ODT context"),void setTimeout((function(){n()}),200);if(navigator.clipboard&&navigator.clipboard.writeText&&!i)navigator.clipboard.writeText(t).then(function(){this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard : "+t,"background-color:rgba(0, 255, 0, 0.1);color: green"),n()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write text in the clipboard"),t&&console.error(t)),s({error:t,errortype:o.ERRORWRITETEXT})}.bind(this));else if(navigator.clipboard&&navigator.clipboard.write&&i){var a=new Blob([i.outerHTML],{type:"text/html"}),r=new Blob([t],{type:"text/plain"}),l=[e.Platform.android?new ClipboardItem({"text/plain":r}):new ClipboardItem({"text/plain":r,"text/html":a})];navigator.clipboard.write(l).then(function(){this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),n()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write text in the clipboard"),t&&console.error(t)),s({error:t,errortype:o.ERRORWRITETEXT})}.bind(this))}else{this._debugMode&&console.error("FAILED to write image in the clipboard due to navigator/OS incompatibility reason"),e.Engine.firefox&&i&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var h=o.ERRORCOMPATIBILITYWRITE;e.Engine.firefox&&i&&(h=o.ERRORCOMPATIBILITYFIREFOXWRITE),s({error:null,errortype:h})}}.bind(this))},writeImage:function(t,i){return new Promise(function(n,s){if(this._isODT)return console.warn("Dont write image in the clipboard in ODT context"),void setTimeout((function(){n()}),200);if(navigator.clipboard&&navigator.clipboard.write){var a=new Blob([i.outerHTML],{type:"text/html"}),r=[e.Platform.android?new ClipboardItem({"image/png":t}):new ClipboardItem({"image/png":t,"text/html":a})];navigator.clipboard.write(r).then(function(){this._debugMode&&console.log("%c SUCCESS - Image copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),n()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write image in the clipboard"),t&&console.error(t)),s({error:t,errortype:o.ERRORWRITEIMAGE})}.bind(this))}else if("http:"===document.location.protocol)this._debugMode&&console.error("FAILED to write image in the clipboard due to security reason"),s({error:new Error("Run app in secure context"),errortype:o.ERRORPERMISSIONDENIED});else{this._debugMode&&console.error("FAILED to write image in the clipboard due to navigator/OS incompatibility reason"),e.Engine.firefox&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var l=o.ERRORCOMPATIBILITYWRITE;e.Engine.firefox&&(l=o.ERRORCOMPATIBILITYFIREFOXWRITE),s({error:null,errortype:l})}}.bind(this))},read:function(){return new Promise(function(t,e){if(this._isODT)return console.warn("Dont read data in the clipboard in ODT context"),void setTimeout((function(){t({data:"",type:o.TYPETEXT})}),200);this.readText().then(function(i){i&&" "===i?e({error:null,errortype:o.ERROREMPTY}):this.readData().then(function(i){if(i&&i.length){var n=i[0],s={},a=0,r=function(){++a===n.types.length&&(s.type&&s.data?t(s):e({error:null,errortype:o.ERRORINVALIDDATA}))};n.types&&n.types.length||e({error:null,errortype:o.ERRORINVALIDDATA});for(var l=0;l<n.types.length;l++)"image/png"===n.types[l]?n.getType(n.types[l]).then((function(t){s.data=URL.createObjectURL(t),s.type=o.TYPEIMAGE,r()})).catch((function(){r()})):"text/plain"===n.types[l]?n.getType(n.types[l]).then((function(t){t.text().then((function(t){s.type||(s.data=t,s.type=o.TYPETEXT),r()})).catch((function(){r()}))})).catch((function(){r()})):"text/html"===n.types[l]?n.getType(n.types[l]).then(function(t){t.text().then(function(t){var e=document.createRange().createContextualFragment(t);s.html=e;var i=e.querySelectorAll("img");!s.type&&i.length?this._requestImage(i[0].src).then((function(t){s.data=t,s.type=o.TYPEIMAGE,r()})).catch((function(){r()})):r()}.bind(this)).catch((function(){r()}))}.bind(this)).catch((function(){r()})):"text/uri-list"===n.types[l]?n.getType(n.types[l]).then(function(t){t.text().then(function(t){s.type?r():this._requestImage(t).then((function(t){s.data=t,s.type=o.TYPEIMAGE,r()})).catch((function(){r()}))}.bind(this)).catch((function(){r()}))}.bind(this)).catch((function(){r()})):r()}else e({error:null,errortype:o.ERROREMPTY})}.bind(this)).catch((function(t){e(t)}))}.bind(this)).catch((function(t){e(t)}))}.bind(this))},readText:function(){return new Promise(function(t,i){navigator.clipboard&&navigator.clipboard.readText&&!this._isSamsungBrowser()?navigator.clipboard.readText().then(function(e){this._debugMode&&console.log("%c SUCCESS - Text read in the clipboard : "+e,"background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to read text in the clipboard"),t&&console.error(t)),i({error:t,errortype:o.ERRORREADTEXT})}.bind(this)):e.Engine.firefox?this.readData().then((function(e){for(var i=e[0],o=0;o<i.types.length;o++)if("text/plain"===i.types[o]){i.getType(i.types[o]).then((function(e){e.text().then(function(e){this._debugMode&&console.log("%c SUCCESS - Text read in the clipboard : "+e,"background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this))}));break}})).catch(function(t){this._debugMode&&(console.error("FAILED to read text in the clipboard"),t.error&&console.error(t.error)),i({error:t.error,errortype:t.errortype})}.bind(this)):"http:"===document.location.protocol?(this._debugMode&&console.error("FAILED to read text in the clipboard due to security reason"),i({error:new Error("Run app in secure context"),errortype:o.ERRORPERMISSIONDENIED})):(this._debugMode&&console.error("FAILED to read text in the clipboard due to navigator/OS incompatibility reason"),i({error:null,errortype:o.ERRORCOMPATIBILITYREAD}))}.bind(this))},readData:function(){return new Promise(function(t,i){if(navigator.clipboard&&navigator.clipboard.read&&!this._isSamsungBrowser())navigator.clipboard.read().then(function(e){this._debugMode&&console.log("%c SUCCESS - Data read in the clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to read data in the clipboard"),t&&console.error(t)),i({error:t,errortype:o.ERRORREADDATA})}.bind(this));else if("http:"===document.location.protocol)this._debugMode&&console.error("FAILED to read data in the clipboard due to security reason"),i({error:new Error("Run app in secure context"),errortype:o.ERRORPERMISSIONDENIED});else{this._debugMode&&console.error("FAILED to read data in the clipboard due to navigator/OS incompatibility reason"),e.Engine.firefox&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var n=o.ERRORCOMPATIBILITYREAD;e.Engine.firefox&&(n=o.ERRORCOMPATIBILITYFIREFOXREAD),i({error:null,errortype:n})}}.bind(this))},_requestImage:function(t){return new Promise((function(e,o){i.proxifiedRequest(t,{method:"GET",type:"blob",onComplete:function(t){if(t.type.includes("image/")){var i=URL.createObjectURL(t);e(i)}else o()},onFailure:function(t){t&&console.error(t),o()}})}))},writeTextInCPD:function(t,e,i){e?(e.setData("text/plain",t),i&&e.setData("text/html",i.outerHTML),this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard : "+t,"background-color:rgba(0, 255, 0, 0.1);color: green")):this._debugMode&&console.warn("An event.clipboardData must be provided")},writeImageInCPD:function(t,e,i){i?(i.setData("image/png",t),i.setData("text/html",e.outerHTML),this._debugMode&&console.log("%c SUCCESS - Image copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green")):this._debugMode&&console.warn("An event.clipboardData must be provided")},readInCPD:function(t){if(!t)return this._debugMode&&console.warn("An event.clipboardData must be provided"),{error:null,errortype:o.ERROREMPTY};var e=this.readTextInCPD(t);if(e&&" "===e)return{error:null,errortype:o.ERROREMPTY};var i=this.readDataInCPD(t);if(!i||!i.length)return{error:null,errortype:o.ERROREMPTY};for(var n={},s=0;s<i.length;s++)if("file"===i[s].kind&&"image/png"===i[s].type){var a=i[s].getAsFile();n.type=o.TYPEIMAGE,a&&(n.data=URL.createObjectURL(a))}else if("string"===i[s].kind&&"text/plain"===i[s].type)n.data=t.getData("text/plain"),n.type=o.TYPETEXT;else if("string"===i[s].kind&&"text/html"===i[s].type){var r=t.getData("text/html"),l=document.createRange().createContextualFragment(r);n.html=l}else"string"===i[s].kind&&"text/uri-list"===i[s].type&&(n.type||(n.type=o.TYPELINK,n.data=t.getData("text/uri-list")));if(n.type===o.TYPEIMAGE&&!n.data&&n.html){var h=n.html.querySelector("img");n.data=h.src}return n.type&&n.data?n:{error:null,errortype:o.ERRORINVALIDDATA}},readTextInCPD:function(t){return t.getData("text")},readDataInCPD:function(t){return t.items},empty:function(){return this.writeText(" ")},_isSamsungBrowser:function(){return navigator.userAgent.match(/SamsungBrowser/i)}});return o.TYPETEXT="typetext",o.TYPEIMAGE="typeimage",o.TYPELINK="typelink",o.ERROREMPTY="errorempty",o.ERRORINVALIDDATA="errorinvaliddata",o.ERRORREADTEXT="errorreadtext",o.ERRORWRITETEXT="errorwritetext",o.ERRORWRITEIMAGE="errorwriteimage",o.ERRORREADDATA="errorreaddata",o.ERRORCOMPATIBILITYFIREFOXWRITE="errorcompatibilityfirefoxwrite",o.ERRORCOMPATIBILITYFIREFOXREAD="errorcompatibilityfirefoxread",o.ERRORPERMISSIONDENIED="errorpermissiondenied",o.ERRORCOMPATIBILITYWRITE="errorcompatibilitywrite",o.ERRORCOMPATIBILITYREAD="errorcompatibilityread",UWA.namespace("DS/CAT3DWInfraUI/CAT3DWClipboard",o)})),define("DS/CAT3DWInfraUI/CAT3DWHandleResources",["UWA/Class","UWA/Promise","DS/RuntimeView/NLSManager"],(function(t,e,i){"use strict";var o=t.extend({load:function(t,o){return new e((function(e,n){t||(console.warn("Using a invalid syntax... Should specify the module."),n());var s=t+"/"+o;i.onResourceLoaded({resourceFile:s},(function(){if(this._manager&&this._manager._listOfResources){var t=this._manager._listOfResources;e(t[s][o])}else n()})),i.loadResource({resourceFile:s,resourceConverter:function(t){return t='{"'+(t=(t=(t=(t=t.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"")).replace(/(\r\n|\r|\n|\u0085|\u000C|\u2028|\u2029)/g,"")).replace(/\s+(?=([^"]*"[^"]*")*[^"]*$)/g,"")).replace(/[=]/g,'":').replace(/;/g,',"')).substring(0,t.length-2)+"}",function(t){var e,i,o,n={};for(var s in t){e=n;for(var a=(i=s.split(".")).pop();i.length;){o=i.shift();var r=UWA.typeOf(e[o]);r&&"object"!==r&&"array"!==r&&(e[o]={_value:e[o]}),"Case"===o&&(isNaN(a)||(a=parseInt(a)),"array"!==r&&(e[o]=[])),e=e[o]=e[o]||{}}"array"==UWA.typeOf(e)?e.push({id:"True"===a||"False"===a?Boolean("True"===a):a,_value:t[s]}):e[a]?e[a]._value=t[s]:e[a]=t[s]}return n}(UWA.Json.decode(t))}})}))}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWHandleResources",o.singleton())})),define("DS/CAT3DWInfraUI/CATLSLadibug",["UWA/Core","UWA/Class","WebappsUtils/WebappsUtils"],(function(t,e,i){"use strict";var o=e.singleton({init:function(){this._logList=[],this._initialized=!1},initialize:function(){this._initialized||(this._initialized=!0,this._createUI(),this._createButton(),this._rewriteConsoleLog())},log:function(e,i){let o=e;void 0===o?o="undefined":null===o?o="null":"string"!=typeof o&&(o.eventChannel&&"/VISU/"===o.eventChannel&&(o=Object.assign({},e),o.gesture=null,o.from=null),o=JSON.stringify(o));let n=new Date;o="["+(n.getHours()+":"+n.getMinutes()+":"+n.getSeconds()+":"+n.getMilliseconds())+"] "+o,this._logList.push(o);for(var s=o.indexOf("error")>0?"error":i,a=o.split("\n"),r=[],l={},h=0;h<a.length;h++)l={tag:"div"},h>0&&"error"===s&&!a[h].match(/^\s{0,}at\s/)?l.text="at "+a[h]:l.text=a[h],h>0&&(l.styles={marginLeft:"25px"}),r.push(l);new t.Element("div",{class:"ladibug-log "+s,html:r}).inject(this._content,"bottom"),this._content.scrollTop=this._content.scrollHeight},displayImage:function(e){new t.Element("div",{class:"ladibug-log image",html:[{tag:"img",src:e}]}).inject(this._content,"bottom"),this._content.scrollTop=this._content.scrollHeight},toggle:function(){this._body.hasClassName("hide")?(this._body.removeClassName("hide"),this._content.scrollTop=this._content.scrollHeight):this._body.addClassName("hide")},isVisible:function(){return this._button&&!this._button.hasClassName("hide")},show:function(){this.initialize(),this._body.removeClassName("hide"),this._button.removeClassName("hide"),this._content.scrollTop=this._content.scrollHeight},hide:function(){this.initialize(),this._body.addClassName("hide"),this._button.addClassName("hide")},_rewriteConsoleLog:function(){console.log=function(t){this.log(t)}.bind(this),console.error=function(t){var e=t;"string"!=typeof t&&(e=t.stack),this.log(e,"error")}.bind(this),console.warn=function(t){this.log(t,"warn")}.bind(this),console.time=function(t){this.log(t,"time")}.bind(this),console.timeEnd=function(t){this.log(t,"time")}.bind(this),console.info=function(t){this.log(t)}.bind(this),window.addEventListener("error",function(t){var e=t.error;"string"==typeof e?this.log(e,"error"):e.stack&&(e.message&&-1===e.stack.indexOf(e.message)&&this.log(e.constructor.name+": "+e.message,"error"),this.log(e.stack,"error"))}.bind(this)),console.image=function(t){this.displayImage(t)}.bind(this)},_createUI:function(){this._body=new t.Element("div",{id:"ladibug-body",class:"hide"}).inject(document.body),this._topBar=new t.Element("div",{id:"ladibug-topbar"}).inject(this._body),new t.Element("span",{class:"ladibug-title",text:"Lad'iBug"}).inject(this._topBar),this._content=new t.Element("div",{class:"ladibug-content"}).inject(this._body),this._dragElement()},_createButton:function(){this._button=new t.Element("div",{id:"ladibug-button",html:{tag:"img",src:i.getWebappsAssetUrl("CAT3DWInfraUI","icons/CAT3DWLadibug.png")},events:{click:this.toggle.bind(this)}}).inject(document.body)},_dragElement:function(){this._pos1=0,this._pos2=0,this._pos3=0,this._pos4=0,this._topBar.onmousedown=this._dragDown.bind(this),this._topBar.ontouchstart=this._dragDown.bind(this)},_dragDown:function(t){var e,i;(t=t||window.event).preventDefault(),t.changedTouches?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY),this._pos3=e,this._pos4=i,document.onmouseup=this._closeDragElement.bind(this),document.ontouchend=this._closeDragElement.bind(this),document.onmousemove=this._elementDrag.bind(this),document.ontouchmove=this._elementDrag.bind(this)},_elementDrag:function(t){var e,i;(t=t||window.event).preventDefault(),t.changedTouches?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY),this._pos1=this._pos3-e,this._pos2=this._pos4-i,this._pos3=e,this._pos4=i,this._body.style.top=this._body.offsetTop-this._pos2+"px",this._body.style.left=this._body.offsetLeft-this._pos1+"px"},_closeDragElement:function(){document.onmouseup=null,document.onmousemove=null,document.ontouchend=null,document.ontouchmove=null}});return t.namespace("DS/CAT3DPhotoNR/CATLSLadibug",o)})),define("DS/CAT3DWInfraUI/CAT3DWProgressBar",["UWA/Class","UWA/Core","DS/Controls/ProgressBar","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWProgressBar","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],(function(t,e,i,o){"use strict";var n=t.extend({init:function(t){this._parentContainer=t.container,this._id=t.id?t.id:this._getUniqueId(),this._container=null,this._overlay=null,this._label=t.label?t.label:o.get("defaultLabel"),this._hideTimeouts=[]},show:function(){if(this._clearTimeouts(),this._container)return this._container.setStyle("opacity",1),void this._container.show();this._container=new e.Element("div",{id:this._id,class:"CAT3DWProgressBar"}).inject(this._parentContainer),this._overlay||(this._overlay=new e.Element("div",{class:"CAT3DWProgressBar-overlay"}).inject(this._parentContainer));var t=new e.Element("div",{class:"progressBar-container"}).inject(this._container),o=new e.Element("div",{class:"progressBar-wrap"}).inject(t);new e.Element("span",{class:"progressBar-label",text:this._label}).inject(o),new i({displayStyle:"lite",infiniteFlag:!0,emphasize:"info"}).inject(o)},hide:function(){this._clearTimeouts(),this._hideTimeouts.push(setTimeout(function(){this._container&&(this._container.setStyle("opacity",0),this._hideTimeouts.push(setTimeout(function(){this._container&&(this._container.destroy(),this._container=null)}.bind(this),200))),this._overlay&&this._hideTimeouts.push(setTimeout(function(){this._overlay&&(this._overlay.destroy(),this._overlay=null)}.bind(this),200))}.bind(this),400))},_clearTimeouts:function(){for(;this._hideTimeouts.length>0;)clearTimeout(this._hideTimeouts.shift())},_getUniqueId:function(){var t="CAT3DWPB_";return t+=(new Date).getUTCMilliseconds()}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWProgressBar",n)})),define("DS/CAT3DWInfraUI/CAT3DWHandleErrors",["UWA/Class","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/Notifications/NotificationsManagerViewOnConsole","DS/CAT3DWInfraUI/CAT3DWHandleResources","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],(function(t,e,i,o,n){"use strict";var s,a=t.extend({SUCCESS:"success",INFORMATION:"info",WARNING:"warning",ERROR:"error",init:function(){this._notificationsList=[]},initialize:function(){s={},n.load("CAT3DWInfraUI","CAT3DWHandleErrors").then((function(t){return s=t,1}),(function(){})),void 0===window.notifs&&(window.notifs=e),void 0===window.notifsDisp&&(window.notifsDisp=o),i.setNotificationManager(window.notifs)},DisplayGeneralMessage:function(t){this.DisplayMessage(this.getResource(t),this.getSeverity(t))},setGeneralErrorMessage:function(t,e,o,n){switch(n=n.toLowerCase()){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:n=this.ERROR}var s={level:n,title:t,subtitle:e,message:o,sticky:!1},a=window.notifs.addNotif(s);this._notificationsList.push(a),n===this.ERROR?setTimeout(function(t){i.removeNotification(t)}.bind(this,a),6e3):n===this.WARNING&&setTimeout(function(t){i.removeNotification(t)}.bind(this,a),4e3)},modifyErrorMessage:function(t,e,i,o,n){switch(n){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:n=this.ERROR}var s={level:n,title:e,subtitle:i,message:o,sticky:!1};window.notifs.modifyNotif(t,s)},DisplayMessage:function(t,e){switch(e){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:e=this.ERROR}var i={level:e,title:s.Title[e],message:t,sticky:!1};window.notifs.addNotif(i)},clearAllErrors:function(){for(var t=this._notificationsList.length,e=0;e<t;e++)i.removeNotification(this._notificationsList[e])},getSeverityFromInt:function(t){var e=this.ERROR;switch(t){case 0:e=this.SUCCESS;break;case 1:case 2:e=this.ERROR;break;case 3:e=this.WARNING;break;case 4:e=this.INFORMATION;break;default:t=this.ERROR}return e},getSeverity:function(t){"string"!=typeof t&&(t=t._value);var e=t.split(".");if(e.length<2)return this.ERROR;switch(e[1].toUpperCase()){case"SUCCESS":return this.SUCCESS;case"INFO":return this.INFORMATION;case"WARNING":return this.WARNING;default:return this.ERROR}},getResource:function(t){"string"!=typeof t&&(t=t._value);var e='Unknown resource id "'+t+'"',i=t.split(".");if(i.length<2)return e;for(var o=s,n=1;n<i.length;n++){if(!Object.hasOwn(o,i[n]))return e;o=o[i[n]]}return o}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWHandleErrors",a.singleton())})),define("DS/CAT3DWInfraUI/CAT3DWExtenderBoxUI",["UWA/Class","UWA/Core","DS/Visualization/ThreeJS_DS","DS/CAT3DWInfraUI/CAT3DWPointerEvents"],(function(t,e,i,o){"use strict";return t.extend({init:function(t){this.srcImage=new Image,this.srcImage.onload=function(){this._cropBoxUIOptions=e.extend(t,{actualImageWidth:this.srcImage.width,actualImageHeight:this.srcImage.height}),this.buildUI(this._cropBoxUIOptions)}.bind(this),this.srcImage.crossOrigin="use-credentials",this.srcImage.src=t.imageURL},onMouseDown:function(t){this.isDragging=!0,this.startingWidth=parseInt(this.actualImageBlackOverlay.style.width),this.startingHeight=parseInt(this.actualImageBlackOverlay.style.height);let e=new WebKitCSSMatrix(window.getComputedStyle(this.actualImageBlackOverlay).getPropertyValue("transform"));this.currtransformLeft=e.m41,this.currtransformTop=e.m42,t.preventDefault(),t.stopPropagation()},onMouseMove:function(t){if(this.isDragging){parseInt(this.actualImageBlackOverlay.style.width),parseInt(this.actualImageBlackOverlay.style.height);let e=new i.Vector2(this.mouseDownPos.x,this.mouseDownPos.y),o=t.clientX-this.masterContainer.getBoundingClientRect().x,n=t.clientY-this.masterContainer.getBoundingClientRect().y,s=new i.Vector2(o,n),a=(new i.Vector2).subVectors(e,s),r=0,l=0,h=new i.Vector2(this.topLeft.x-this.topRight.x,this.topLeft.y-this.topRight.y),c=new i.Vector2(this.topRight.x-this.topLeft.x,this.topRight.y-this.topLeft.y),d=new i.Vector2(this.topLeft.x-this.bottomLeft.x,this.topLeft.y-this.bottomLeft.y),g=new i.Vector2(this.topRight.x-this.bottomRight.x,this.topRight.y-this.bottomRight.y),p=new i.Vector2(this.bottomRight.x-this.topRight.x,this.bottomRight.y-this.topRight.y),u=new i.Vector2(this.bottomLeft.x-this.bottomRight.x,this.bottomLeft.y-this.bottomRight.y),m=new i.Vector2(this.bottomRight.x-this.bottomLeft.x,this.bottomRight.y-this.bottomLeft.y),f=0,b=0,w=this.startingWidth,x=this.startingHeight;switch(this.targetElem){case"top-left-handle":r=a.dot(h)/h.length(),l=a.dot(d)/d.length(),w=this.startingWidth-r,x=this.startingHeight-l,b=r,f=l,w<this.actualWidthOfImageNode?(w=this.actualWidthOfImageNode,b=this.startingWidth-w):w>this.maxWidth&&(w=this.maxWidth,b=this.startingWidth-w),x<this.actualHeightOfImageNode?(x=this.actualHeightOfImageNode,f=this.startingHeight-x):x>this.maxHeight&&(x=this.maxHeight,f=this.startingHeight-x);break;case"top-handle":l=a.dot(d)/d.length(),x=this.startingHeight-l,f=l,x<this.actualHeightOfImageNode?(x=this.actualHeightOfImageNode,f=this.startingHeight-x):x>this.maxHeight&&(x=this.maxHeight,f=this.startingHeight-x);break;case"top-right-handle":r=a.dot(c)/c.length(),l=a.dot(g)/g.length(),w=this.startingWidth-r,x=this.startingHeight-l,f=l,w<this.actualWidthOfImageNode?w=this.actualWidthOfImageNode:w>this.maxWidth&&(w=this.maxWidth),x<this.actualHeightOfImageNode?(x=this.actualHeightOfImageNode,f=this.startingHeight-x):x>this.maxHeight&&(x=this.maxHeight,f=this.startingHeight-x);break;case"right-handle":r=a.dot(c)/c.length(),w=this.startingWidth-r,w<this.actualWidthOfImageNode?w=this.actualWidthOfImageNode:w>this.maxWidth&&(w=this.maxWidth);break;case"bottom-right-handle":r=a.dot(m)/m.length(),l=a.dot(p)/p.length(),w=this.startingWidth-r,x=this.startingHeight-l,w<this.actualWidthOfImageNode?w=this.actualWidthOfImageNode:w>this.maxWidth&&(w=this.maxWidth),x<this.actualHeightOfImageNode?x=this.actualHeightOfImageNode:x>this.maxHeight&&(x=this.maxHeight);break;case"bottom-handle":l=a.dot(p)/p.length(),x=this.startingHeight-l,x<this.actualHeightOfImageNode?x=this.actualHeightOfImageNode:x>this.maxHeight&&(x=this.maxHeight);break;case"bottom-left-handle":r=a.dot(u)/u.length(),l=a.dot(p)/p.length(),w=this.startingWidth-r,x=this.startingHeight-l,b=r,f=l,w<this.actualWidthOfImageNode?(w=this.actualWidthOfImageNode,b=this.startingWidth-w):w>this.maxWidth&&(w=this.maxWidth,b=this.startingWidth-w),x<this.actualHeightOfImageNode?(x=this.actualHeightOfImageNode,f=this.startingHeight-x):x>this.maxHeight&&(x=this.maxHeight,f=this.startingHeight-x);break;case"left-handle":r=a.dot(u)/u.length(),w=this.startingWidth-r,b=r,w<this.actualWidthOfImageNode?(w=this.actualWidthOfImageNode,b=this.startingWidth-w):w>this.maxWidth&&(w=this.maxWidth,b=this.startingWidth-w)}let v="translate("+(this.currtransformLeft+b)+"px, "+(this.currtransformTop+f)+"px) ",y="rotate("+180/Math.PI*0+"deg)";this.actualImageBlackOverlay.setStyles({width:w+"px",height:x+"px"}),this.actualImageBlackOverlay.style.transform=v+y,t.preventDefault()}},onMouseUp:function(t){if(this.isDragging){this.isDragging=!1;let e=this.actualImageBlackOverlay.getBoundingClientRect(),o=this.masterContainer.getBoundingClientRect();this.topLeft=new i.Vector2(e.left-o.left,e.top-o.top),this.topRight=new i.Vector2(e.left-o.left+e.width,e.top-o.top),this.bottomRight=new i.Vector2(e.left-o.left+e.width,e.top-o.top+e.height),this.bottomLeft=new i.Vector2(e.left-o.left,e.top-o.top+e.height),t.preventDefault()}},buildUI:function(t){this.isDragging=!1,this.mouseDownPos=null,this.fixedPosition={},this.targetElem="";let i=0,n=0,s=0,a=0;i=t.topLeft.y,n=t.topLeft.x,s=t.imageWidth,a=t.imageHeight,this.topLeft=t.topLeft,this.topRight=t.topRight,this.bottomRight=t.bottomRight,this.bottomLeft=t.bottomLeft,this.originalCenterX=t.centerX,this.originalCenterY=t.centerY,this.originalAngle=t.angle,this.masterContainer=new e.Element("div",{id:"cropbox-ui-container",styles:{width:"100%",height:"100%",position:"absolute",top:"0px",left:"0px","background-color":"rgba(0, 0, 0, 0.5)"}}).inject(t.container);let r="translate("+(t.centerX-.5*s)+"px, "+(t.centerY-.5*a)+"px) ",l="rotate("+t.angle*(180/Math.PI)+"deg)";this.angle=t.angle;this.maxWidth=1.5*s,this.maxHeight=1.5*a,this.actualImageBlackOverlay=new e.Element("div",{id:"actual-image-black-overlay",styles:{position:"absolute",top:"0px",left:"0px",width:s+"px",height:a+"px","background-color":"rgba(0, 0, 0, 0.6)","background-image":"linear-gradient(135deg, rgb(26, 26, 27) 25%, transparent 25%), linear-gradient(225deg, rgb(26, 26, 27) 25%, transparent 25%), linear-gradient(45deg, rgb(26, 26, 27) 25%, transparent 25%), linear-gradient(315deg, rgb(26, 26, 27) 25%, rgb(229, 229, 247) 25%)","background-repeat":"repeat","background-position":"10px 0px, 10px 0px, 0px 0px, 0px 0px","background-size":"10px 10px",transform:r+l}}).inject(this.masterContainer);let h=new WebKitCSSMatrix(window.getComputedStyle(this.actualImageBlackOverlay).getPropertyValue("transform"));this.originaltransformLeft=h.m41,this.originaltransformTop=h.m42,this.container=new e.Element("div",{id:"full-background-image",styles:{position:"absolute",top:"0px",left:"0px",width:s+"px",height:a+"px","pointer-events":"auto",transform:r+l,opacity:1,"background-image":"url("+t.imageURL+")","background-size":"contain","background-repeat":"no-repeat"}}).inject(this.masterContainer),this.actualWidthOfImageNode=parseInt(this.container.style.width),this.actualHeightOfImageNode=parseInt(this.container.style.height),new e.Element("div",{id:"top-left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 31,1 31,8 8,8 8,31 1,31 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"-4px",left:"-4px",cursor:"nw-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="top-left-handle",this.mouseDownPos=this.topLeft,this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"top-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="30" height="8" stroke="black" stroke-width="2" fill="white" x="1" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"-4px",left:"calc(50% - 10px)",cursor:"n-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="top-handle",this.mouseDownPos={x:.5*(this.topLeft.x+this.topRight.x),y:.5*(this.topLeft.y+this.topRight.y)},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"top-right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 31,1 31,31 24,31 24,8 1,8 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"-4px",right:"-4px",cursor:"ne-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="top-right-handle",this.mouseDownPos=this.topRight,this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="8" height="30" stroke="black" stroke-width="2" fill="white" x="23" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",right:"-4px",top:"calc(50% - 10px)",cursor:"e-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="right-handle",this.mouseDownPos={x:.5*(this.topRight.x+this.bottomRight.x),y:.5*(this.topRight.y+this.bottomRight.y)},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"bottom-right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="31,31 31,1 24,1 24,24 1,24 1,31 31,31"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"-4px",right:"-4px",cursor:"se-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="bottom-right-handle",this.mouseDownPos=this.bottomRight,this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"bottom-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="30" height="8" stroke="black" stroke-width="2" fill="white" x="1" y="23"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"-4px",left:"calc(50% - 10px)",cursor:"s-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="bottom-handle",this.mouseDownPos={x:.5*(this.bottomRight.x+this.bottomLeft.x),y:.5*(this.bottomRight.y+this.bottomLeft.y)},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"bottom-left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 1,31 31,31 31,24 8,24 8,1 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"-4px",left:"-4px",cursor:"sw-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="bottom-left-handle",this.mouseDownPos=this.bottomLeft,this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="8" height="30" stroke="black" stroke-width="2" fill="white" x="1" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"calc(50% - 10px)",left:"-4px",cursor:"w-resize","z-index":1}}).inject(this.actualImageBlackOverlay).addEvent(o.POINTERDOWN,function(t){this.targetElem="left-handle",this.mouseDownPos={x:.5*(this.bottomLeft.x+this.topLeft.x),y:.5*(this.bottomLeft.y+this.topLeft.y)},this.onMouseDown(t)}.bind(this)),this.masterContainer.addEvent(o.POINTERMOVE,this.onMouseMove.bind(this)),this.masterContainer.addEvent(o.POINTERUP,this.onMouseUp.bind(this)),this.masterContainer.addEventListener("mouseleave",this.onMouseUp.bind(this))},getCropInfo:function(t,e){let i=parseInt(this.cropBox.style.top),o=parseInt(this.cropBox.style.left),n=parseInt(this.cropBox.style.width),s=parseInt(this.cropBox.style.height),a=this.srcImage.width/t;return{srcData:{width:this.srcImage.width,height:this.srcImage.height},cropData:{top:i*a,left:o*a,width:n*a,height:s*a,hRatio:n/t,vRatio:s/e}}},resizeEqually:function(){let t="translate("+(this.originaltransformLeft-(this.maxWidth-this.actualWidthOfImageNode)/2)+"px, "+(this.originaltransformTop-(this.maxHeight-this.actualHeightOfImageNode)/2)+"px) ",e="rotate("+180/Math.PI*0+"deg)";this.actualImageBlackOverlay.setStyles({width:this.maxWidth+"px",height:this.maxHeight+"px"}),this.actualImageBlackOverlay.style.transform=t+e;let o=this.actualImageBlackOverlay.getBoundingClientRect(),n=this.masterContainer.getBoundingClientRect();this.topLeft=new i.Vector2(o.left-n.left,o.top-n.top),this.topRight=new i.Vector2(o.left-n.left+o.width,o.top-n.top),this.bottomRight=new i.Vector2(o.left-n.left+o.width,o.top-n.top+o.height),this.bottomLeft=new i.Vector2(o.left-n.left,o.top-n.top+o.height)},dispose:function(){this.actualImageBlackOverlay&&(this.actualImageBlackOverlay.remove(),this.actualImageBlackOverlay=void 0),this.container&&(this.container.remove(),this.container=void 0),this.masterContainer&&(this.masterContainer.remove(),this.masterContainer=void 0)}})})),define("DS/CAT3DWInfraUI/CAT3DWCanvasServices",["UWA/Class","UWA/Core","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfraUI/CAT3DWCanvasLimits","DS/Visualization/ThreeJS_DS","DS/Utilities/Color"],(function(t,e,i,o,n,s){"use strict";return t.extend({createCanvas:function(t){var i=t||{},n=new e.Element("canvas");return i.id&&(n.id=i.id),o.areDimensionsWithinLimits(i.width,i.height)||console.warn("[CAT3DWCanvasServices] "+i.tag+" : the dimensions of the canvas exceed the safety limits. A memory crash may occur."),i.height&&(n.height=i.height),i.width&&(n.width=i.width),n},resizeCanvas:function(t,e,i){var o=this.createCanvas({width:e,height:i,tag:"resizeCanvas"});return o.getContext("2d").drawImage(t,0,0,o.width,o.height),o},loadImage:function(t,e,o,n){var s=new Image;s.onload=function(){o&&o(s)},s.onerror=function(e){console.error("Failed to load image "+t),n&&n(e)},s.crossOrigin=e?"anonymous":i.getPreferenceValue("CrossOrigin"),s.src=t},arrayBufferToBase64:function(t){for(var e="",i=new Uint8Array(t),o=i.byteLength,n=0;n<o;n++)e+=String.fromCharCode(i[n]);return window.btoa(e)},getBase64FromImage:function(t,e,i,o,n){fetch(t).then((t=>t.blob())).then((t=>{const e=new FileReader;e.onloadend=()=>{const t=e.result.replace("data:","").replace(/^.+,/,"");o&&o(t)},e.readAsDataURL(t)}))},loadVideo:function(t,e,o,n){var s=document.createElement("video");s.addEventListener("loadedmetadata",(function(){o&&o(s)})),s.onerror=function(e){console.error("Failed to load video "+t),n&&n(e)},s.crossOrigin=e?"anonymous":i.getPreferenceValue("CrossOrigin"),s.src=t},getOptimizedDataUrlFromUrl:function(t,e,i,o,n){this.loadImage(t,!1,function(t){var s=this.getOptimizedDataUrlFromImg(t,e,i,n);o&&o(s)}.bind(this))},getOptimizedDataUrlFromImg:function(t,e,i,o){var n=e||2e3,s=i||1500,a=this._getNewDimensions(t,n,s),r=this.createCanvas({width:a.width,height:a.height,tag:"getOptimizedDataUrlFromImgCanvas"}),l=r.getContext("2d");l.fillStyle="white",l.fillRect(0,0,a.width,a.height),l.drawImage(t,0,0,a.width,a.height);var h=r.toDataURL(o||"image/jpeg");return r=null,l=null,h},getDataUrlFromImg:function(t,e){var i,n=this.createCanvas({tag:"getDataUrlFromImgCanvas"}),s=null,a=e||"image/jpeg";if(o.areDimensionsWithinLimits(t.width,t.height))n.height=t.height,n.width=t.width,s=n.getContext("2d"),"image/jpeg"!==a&&"image/jpg"!==a||(s.fillStyle="white",s.fillRect(0,0,n.width,n.height)),s.drawImage(t,0,0,t.width,t.height);else{var r=t.width/t.height,l=Math.floor(Math.sqrt(o.MPLimit/r)),h=Math.floor(r*l);n.height=l,n.width=h,s=n.getContext("2d"),"image/jpeg"!==a&&"image/jpg"!==a||(s.fillStyle="white",s.fillRect(0,0,n.width,n.height)),s.drawImage(t,0,0,t.width,t.height,0,0,h,l)}i=n.toDataURL(a);var c={height:n.height,width:n.width};return n=null,s=null,{dataUrl:i,dimensions:c}},getCanvasFromImageUrl:function(t){return new Promise(function(e){this.loadImage(t,!1,function(t){var i=this.createCanvas({width:t.width,height:t.height,tag:"getCanvasFromImageUrlCanvas"});i.getContext("2d").drawImage(t,0,0,t.width,t.height),e(i)}.bind(this),(function(){e(null)}))}.bind(this))},getBlobUrlFromImg:function(t,e,i,o){this.getDataUrlFromImgSrc(t,function(t,i){var n=this.getBlobUrlFromDataUrl(t,o);e(n,i)}.bind(this),o,i)},getBlobFromCanvas:function(t,e){if(!t)return null;var i=e||"image/jpg",o=t.toDataURL(i);return this.getBlobFromDataUrl(o,i)},getBlobUrlFromCanvas:function(t,e){if(!t)return null;var i=e||"image/jpg",o=t.toDataURL(i);return this.getBlobUrlFromDataUrl(o,i)},getBlobUrlFromDataUrl:function(t,e){if(!t)return"";var i=this._fromBase64ToBlob(t,e);return this._fromBlobToImage(i)},getBlobFromDataUrl:function(t,e){return t?this._fromBase64ToBlob(t,e):""},getBlobFromImageSrc:function(t,e,i,o){this.getDataUrlFromImgSrc(t,function(t){var o=this.getBlobFromDataUrl(t,i);e(o)}.bind(this),i,o)},getDataUrlFromImgSrc:function(t,e,i,o){this.loadImage(t,!1,function(t){var o=this.getDataUrlFromImg(t,i).dataUrl;e(o,{width:t.width,height:t.height}),t=null}.bind(this),o)},getBlobFromVideoSrc:function(t,e,i,o){this.getDataUrlFromVideoSrc(t,function(t){var o=this.getBlobFromDataUrl(t,i);e(o)}.bind(this),i,o)},getDataUrlFromVideoSrc:function(t,e,i,o){this.loadVideo(t,!1,function(t){var o=this.getDataUrlFromImg(t,i).dataUrl;e(o,{width:t.width,height:t.height}),t=null}.bind(this),o)},base64ToArrayBuffer:function(t){for(var e=window.atob(t),i=e.length,o=new Uint8Array(i),n=0;n<i;n++)o[n]=e.charCodeAt(n);return o.buffer},imageToBuffer:function(t,e){var i=e||"image/jpeg",o=this.getDataUrlFromImg(t,i).dataUrl,n=this.getDataUrlFromImg(t,i).dimensions;return{imgBuffer:this.base64ToArrayBuffer(o.split(",")[1]),newDimensions:n}},_fromBase64ToBlob:function(t,e){return this._b64toBlob(t.split(",")[1],e)},_fromBlobToImage:function(t){return URL.createObjectURL(t)},_b64toBlobNoType:function(t){for(var e=atob(t),i=e.length,o=new Uint8Array(i),n=0;n<i;n++)o[n]=e.charCodeAt(n);return new Blob([o],{type:""})},_b64toBlob:function(t,e){for(var i=e||"image/jpeg",o=atob(t),n=o.length,s=new Uint8Array(n),a=0;a<n;a++)s[a]=o.charCodeAt(a);return new Blob([s],{type:i})},_getNewDimensions:function(t,e,i){var o=t.width,n=t.height;return o>n?o>e&&(n*=e/o,o=e):n>i&&(o*=i/n,n=i),{width:o,height:n}},StringToArrayBuffer:function(t){return this.StringToUint8Array(t).buffer},StringToBinary:function(t){var e,i,o,n,s,a;for(s=t.length,e=[],n=!1,o=a=0;0<=s?a<s:a>s;o=0<=s?++a:--a){if((i=String.prototype.charCodeAt.call(t,o))>255){n=!0,e=null;break}e.push(i)}return!0===n?unescape(encodeURIComponent(t)):String.fromCharCode.apply(null,Array.prototype.slice.apply(e))},StringToUint8Array:function(t){var e,i,o,n,s,a;for(i=(e=this.StringToBinary(t)).length,o=new ArrayBuffer(i),n=new Uint8Array(o),s=a=0;0<=i?a<i:a>i;s=0<=i?++a:--a)n[s]=String.prototype.charCodeAt.call(e,s);return n},getCroppedImageUrl:function(t,i,o){if(!t||!i||!o)return;let s;s=i.cropData?i.cropData:i;let a=new Image;a.onload=()=>{let t=s.top,r=s.left,l=s.width,h=s.height,c=this.createCanvas({width:l,height:h,tag:"getCroppedImageUrlCanvas"}),d=c.getContext("2d");if(i.profile){let o=JSON.parse(i.profile.points),s=[],c=[],w=[];for(var g=0;g<o.length;++g)s.push(new n.Vector2(o[g].x,o[g].y)),c.push(o[g].x),w.push(o[g].y);c.sort((function(t,e){return t-e})),w.sort((function(t,e){return t-e}));let x,v,y=c.length-1,D=[new n.Vector2(c[0],w[0]),new n.Vector2(c[y],w[0]),new n.Vector2(c[y],w[y]),new n.Vector2(c[0],w[y])],_={x:(D[0].x+D[2].x)/2,y:(D[0].y+D[2].y)/2},I=D[0].distanceTo(D[1]),T=D[0].distanceTo(D[3]);x=h,v=l;let C=new n.Vector2(r,t),P=x;var p=I;let R=v-p,S=C.x;var u=T,m=P-u,f=C.y;let A=[];for(g=0;g<s.length;++g){let t=s[g].x-_.x+I/2+C.x,e=s[g].y-_.y+T/2+C.y;A.push(new n.Vector2(t+(t-S)/p*R,e+(e-f)/u*m))}let M=new e.Element("canvas",{id:"editCanvas",styles:{height:a.height+"px",width:a.width+"px"}}),E=M.getContext("2d");M.width=a.width,M.height=a.height,E.strokeStyle="transparent";let O=A.length;E.beginPath(),E.moveTo(A[0].x,A[0].y);for(var b=1;b<O;++b)E.lineTo(A[b].x,A[b].y);E.closePath(),E.stroke(),E.clip(),E.drawImage(a,0,0,M.width,M.height),d.strokeStyle="transparent",d.drawImage(M,C.x,C.y,v,x,0,0,v,x),M.remove()}else d.drawImage(a,r,t,l,h,0,0,l,h);c.toBlob((t=>{let e=URL.createObjectURL(t);c.remove(),c=void 0,o(e)}))},a.crossOrigin="use-credentials",a.src=t},_getCroppedImageUrlFromActualImage:function(t,e,i){if(!t||!e||!i)return;let o=e.top,n=e.left,s=e.width,a=e.height,r=this.createCanvas({width:s,height:a,tag:"_getCroppedImageUrlCanvas"});r.getContext("2d").drawImage(t,n,o,s,a,0,0,s,a),r.toBlob((function(t){try{let e=URL.createObjectURL(t);r.remove(),r=void 0,i(e)}catch(t){console.log(t),i(null)}}))},_createTextureImageFromSVG:function(t){let i=new Blob([t.svgString],{type:"image/svg+xml"}),o=URL.createObjectURL(i),n=t.width,s=t.height,a=new Image;a.width=n,a.height=s,a.onload=function(i){let o=new e.Element("canvas",{width:n,height:s});o.getContext("2d").drawImage(a,0,0,n,s),o.toBlob((function(e){let i=URL.createObjectURL(e);t.onTextureImageCreatedCB(i)}),{type:"image/jpeg"})},a.src=o},cropImageFromCanvas:function(t){var e,i,o,n=t.getContext("2d",{willReadFrequently:!0}),s=t.width,a=t.height,r={x:[],y:[]},l=n.getImageData(0,0,t.width,t.height),h=-1,c=-1,d=-1,g=-1;for(i=0;i<a;i++)for(e=0;e<s;e++)o=4*(i*s+e),l.data[o+3]>5&&(r.x.push(e),r.y.push(i),-1===h?(h=e,d=e,c=i,g=i):(e<=h&&(h=e),e>=d&&(d=e),i<=c&&(c=i),i>=g&&(g=i)));s=1+d-h,a=1+g-c;var p=n.getImageData(h,c,s,a);t.width=s,t.height=a,n.putImageData(p,0,0)},findcolorCoordinatesFromCanvas:function(t,e,i){t.getContext("2d",{willReadFrequently:!0});var o,n,a,r=t.width,l=t.height;let h=s.hexToRgb(i),c={},d=0,g=0,p=1e7;for(n=0;n<l;n++)for(o=0;o<r;o++){d++,a=4*(n*r+o);let t=Math.sqrt((e.data[a]-h.r)*(e.data[a]-h.r)+(e.data[a+1]-h.g)*(e.data[a+1]-h.g)+(e.data[a+2]-h.b)*(e.data[a+2]-h.b));t<p&&(p=t,g=d)}return g<r?(c.x=g,c.y=1):(c.y=Math.floor(g/r)+1,c.x=g%r),c},findcolorFromCoordinatesFromCanvas:function(t,e,i){t.getContext("2d",{willReadFrequently:!0});var o,n=t.width,a=t.height;o=4*(Math.floor(a*i.y)*n+Math.floor(n*i.x));let r={r:e.data[o],g:e.data[o+1],b:e.data[o+2],a:e.data[o+3]};return"#"+s.rgbToHex(r).slice(0,6)},getImageUrlWithValidResolution:function(t,e,i,n){if(!t||!n||"function"!=typeof n)return;let s=e||"image/jpeg",a=void 0!==i&&i;this.loadImage(t,a,(e=>{if(o.areDimensionsWithinLimits(e.width,e.height))n(t,{height:e.height,width:e.width});else{let t=this.createCanvas({tag:"image-resize-canvas"}),i=e.width/e.height,a=Math.floor(Math.sqrt(o.MPLimit/i)),r=Math.floor(i*a);t.height=a,t.width=r;let l=t.getContext("2d");"image/jpeg"!==s&&"image/jpg"!==s||(l.fillStyle="white",l.fillRect(0,0,t.width,t.height)),l.drawImage(e,0,0,e.width,e.height,0,0,r,a),t.toBlob((e=>{let i=URL.createObjectURL(e);n(i,{height:t.height,width:t.width})}))}}),(t=>{console.log("Image loading failed.",t),n(null)}))}})})),define("DS/CAT3DWInfraUI/CAT3DWCropBoxUI",["UWA/Class","UWA/Core","DS/Visualization/ThreeJS_DS","DS/CAT3DWInfraUI/CAT3DWPointerEvents","DS/ApplicationFrame/CommandsManager","DS/CAT3DWInfraUI/CAT3DWCanvasServices"],(function(t,e,i,o,n,s){"use strict";return t.extend({init:function(t){this.srcImage=new Image,this.srcImage.onload=function(){this._cropBoxUIOptions=e.extend(t,{actualImageWidth:this.srcImage.width,actualImageHeight:this.srcImage.height}),this.buildUI(this._cropBoxUIOptions)}.bind(this),this.srcImage.crossOrigin="use-credentials",this.srcImage.src=t.imageURL,this.canvasServices=new s},onMouseDown:function(t){this.isDragging=!0,this.initialTop=parseInt(this.cropBox.style.top),this.initialLeft=parseInt(this.cropBox.style.left);let e=new i.Vector2(this.mouseDownPos.x,this.mouseDownPos.y),o=t.clientX-this.masterContainer.getBoundingClientRect().x,s=t.clientY-this.masterContainer.getBoundingClientRect().y,a=new i.Vector2(o,s);this.actualWidthOfImageNode=parseInt(this.container.style.width),this.actualHeightOfImageNode=parseInt(this.container.style.height);let r=new i.Vector2(this.topLeft.x-this.topRight.x,this.topLeft.y-this.topRight.y),l=new i.Vector2(this.topLeft.x-this.bottomLeft.x,this.topLeft.y-this.bottomLeft.y),h=new i.Vector2(this.initialLeft,this.initialTop),c=h.length(),d=0,g=0;if(c>0){let t=Math.atan(r.y/r.x);this.topRight.x<this.topLeft.x&&(t+=Math.PI);let e=Math.atan(h.y/h.x);e<.5*-Math.PI&&(e+=Math.PI);let i=t+e;d=Math.cos(i)*c,g=Math.sin(i)*c}let p=(new i.Vector2).subVectors(new i.Vector2(d+e.x,g+e.y),a);this._dx_1=p.dot(r)/r.length(),this._dy_1=p.dot(l)/l.length(),t.preventDefault(),t.stopPropagation();let u={topLeft:this.topLeft,topRight:this.topRight,bottomRight:this.bottomRight,bottomLeft:this.bottomLeft},m=this.getCropInfo(this._cropBoxUIOptions.imageWidth,this._cropBoxUIOptions.imageHeight),f=m.srcData.width/this._cropBoxUIOptions.imageWidth;this.innerRectangle=n.getCommand("CropImageCmd").findInnerRectangle(u,m.cropData.width/f,m.cropData.height/f,{x:m.cropData.left/f,y:m.cropData.top/f})},onMouseMove:function(t){if(this.isDragging){let h,c,d,g,p,u,m,f=parseInt(this.cropBox.style.width),b=parseInt(this.cropBox.style.height),w=new i.Vector2(this.mouseDownPos.x,this.mouseDownPos.y),x=t.clientX-this.masterContainer.getBoundingClientRect().x,v=t.clientY-this.masterContainer.getBoundingClientRect().y,y=new i.Vector2(x,v),D=(new i.Vector2).subVectors(w,y),_=0,I=0,T="",C="",P="",R="",S=new i.Vector2(this.topLeft.x-this.topRight.x,this.topLeft.y-this.topRight.y),A=new i.Vector2(this.topRight.x-this.topLeft.x,this.topRight.y-this.topLeft.y),M=new i.Vector2(this.topLeft.x-this.bottomLeft.x,this.topLeft.y-this.bottomLeft.y),E=new i.Vector2(this.topRight.x-this.bottomRight.x,this.topRight.y-this.bottomRight.y),O=new i.Vector2(this.bottomRight.x-this.topRight.x,this.bottomRight.y-this.topRight.y),V=new i.Vector2(this.bottomLeft.x-this.bottomRight.x,this.bottomLeft.y-this.bottomRight.y),L=new i.Vector2(this.bottomRight.x-this.bottomLeft.x,this.bottomRight.y-this.bottomLeft.y),k=this.innerRectangle.topLeft.distanceTo(this.innerRectangle.topRight)/this.innerRectangle.topLeft.distanceTo(this.innerRectangle.bottomLeft),j=new i.Vector3(y.x,y.y,0);switch(this.targetElem){case"top-left-handle":g={A:new i.Vector3(this.innerRectangle.topLeft.x,this.innerRectangle.topLeft.y,0),B:new i.Vector3(this.innerRectangle.bottomRight.x,this.innerRectangle.bottomRight.y,0)},p=this._getFootOfPerpendicularOnLineFromPoint(g,j),y=new i.Vector2(p.x,p.y),D=(new i.Vector2).subVectors(w,y),_=D.dot(S)/S.length(),I=D.dot(M)/M.length(),f=this.actualWidthOfImageNode-_-this.fixedPosition.right,b=this.actualHeightOfImageNode-I-this.fixedPosition.bottom,m=(new i.Vector2).subVectors(this.innerRectangle.topLeft,this.innerRectangle.bottomRight).normalize().multiplyScalar(2e4),m.addVectors(this.innerRectangle.bottomRight,m),u=this.findIntersectionOfLineSegments(this.topLeft,this.topRight,m,this.innerRectangle.bottomRight),u?b+this.fixedPosition.bottom>this.actualHeightOfImageNode&&(b=this.actualHeightOfImageNode-this.fixedPosition.bottom,f=b*k):f+this.fixedPosition.right>this.actualWidthOfImageNode&&(f=this.actualWidthOfImageNode-this.fixedPosition.right,b=f/k),P=this.fixedPosition.bottom+"px",R=this.fixedPosition.right+"px";break;case"top-handle":I=D.dot(M)/M.length(),b=this.actualHeightOfImageNode-I-this.fixedPosition.bottom,b+this.fixedPosition.bottom>this.actualHeightOfImageNode&&(b=this.actualHeightOfImageNode-this.fixedPosition.bottom),P=this.fixedPosition.bottom+"px",R=this.fixedPosition.right+"px",C=this.fixedPosition.left+"px";break;case"top-right-handle":g={A:new i.Vector3(this.innerRectangle.topRight.x,this.innerRectangle.topRight.y,0),B:new i.Vector3(this.innerRectangle.bottomLeft.x,this.innerRectangle.bottomLeft.y,0)},p=this._getFootOfPerpendicularOnLineFromPoint(g,j),y=new i.Vector2(p.x,p.y),D=(new i.Vector2).subVectors(w,y),_=D.dot(A)/A.length(),I=D.dot(E)/E.length(),f=this.actualWidthOfImageNode-_-this.fixedPosition.left,b=this.actualHeightOfImageNode-I-this.fixedPosition.bottom,m=(new i.Vector2).subVectors(this.innerRectangle.topRight,this.innerRectangle.bottomLeft).normalize().multiplyScalar(2e4),m.addVectors(this.innerRectangle.bottomLeft,m),u=this.findIntersectionOfLineSegments(this.topLeft,this.topRight,m,this.innerRectangle.bottomLeft),u?b+this.fixedPosition.bottom>this.actualHeightOfImageNode&&(b=this.actualHeightOfImageNode-this.fixedPosition.bottom,f=b*k):f+this.fixedPosition.left>this.actualWidthOfImageNode&&(f=this.actualWidthOfImageNode-this.fixedPosition.left,b=f/k),P=this.fixedPosition.bottom+"px",C=this.fixedPosition.left+"px";break;case"right-handle":_=D.dot(A)/A.length(),f=this.actualWidthOfImageNode-_-this.fixedPosition.left,f+this.fixedPosition.left>this.actualWidthOfImageNode&&(f=this.actualWidthOfImageNode-this.fixedPosition.left),C=this.fixedPosition.left+"px",T=this.fixedPosition.top+"px",P=this.fixedPosition.bottom+"px";break;case"bottom-right-handle":g={A:new i.Vector3(this.innerRectangle.bottomRight.x,this.innerRectangle.bottomRight.y,0),B:new i.Vector3(this.innerRectangle.topLeft.x,this.innerRectangle.topLeft.y,0)},p=this._getFootOfPerpendicularOnLineFromPoint(g,j),y=new i.Vector2(p.x,p.y),D=(new i.Vector2).subVectors(w,y),_=D.dot(L)/L.length(),I=D.dot(O)/O.length(),f=this.actualWidthOfImageNode-_-this.fixedPosition.left,b=this.actualHeightOfImageNode-I-this.fixedPosition.top,m=(new i.Vector2).subVectors(this.innerRectangle.bottomRight,this.innerRectangle.topLeft).normalize().multiplyScalar(2e4),m.addVectors(this.innerRectangle.topLeft,m),u=this.findIntersectionOfLineSegments(this.bottomLeft,this.bottomRight,m,this.innerRectangle.topLeft),u?b+this.fixedPosition.top>this.actualHeightOfImageNode&&(b=this.actualHeightOfImageNode-this.fixedPosition.top,f=b*k):f+this.fixedPosition.left>this.actualWidthOfImageNode&&(f=this.actualWidthOfImageNode-this.fixedPosition.left,b=f/k),T=this.fixedPosition.top+"px",C=this.fixedPosition.left+"px";break;case"bottom-handle":I=D.dot(O)/O.length(),b=this.actualHeightOfImageNode-I-this.fixedPosition.top,b+this.fixedPosition.top>this.actualHeightOfImageNode&&(b=this.actualHeightOfImageNode-this.fixedPosition.top),T=this.fixedPosition.top+"px",C=this.fixedPosition.left+"px",R=this.fixedPosition.right+"px";break;case"bottom-left-handle":g={A:new i.Vector3(this.innerRectangle.bottomLeft.x,this.innerRectangle.bottomLeft.y,0),B:new i.Vector3(this.innerRectangle.topRight.x,this.innerRectangle.topRight.y,0)},p=this._getFootOfPerpendicularOnLineFromPoint(g,j),y=new i.Vector2(p.x,p.y),D=(new i.Vector2).subVectors(w,y),_=D.dot(V)/V.length(),I=D.dot(O)/O.length(),f=this.actualWidthOfImageNode-_-this.fixedPosition.right,b=this.actualHeightOfImageNode-I-this.fixedPosition.top,m=(new i.Vector2).subVectors(this.innerRectangle.bottomLeft,this.innerRectangle.topRight).normalize().multiplyScalar(2e4),m.addVectors(this.innerRectangle.topRight,m),u=this.findIntersectionOfLineSegments(this.bottomLeft,this.bottomRight,m,this.innerRectangle.topRight),u?b+this.fixedPosition.top>this.actualHeightOfImageNode&&(b=this.actualHeightOfImageNode-this.fixedPosition.top,f=b*k):f+this.fixedPosition.right>this.actualWidthOfImageNode&&(f=this.actualWidthOfImageNode-this.fixedPosition.right,b=f/k),T=this.fixedPosition.top+"px",R=this.fixedPosition.right+"px";break;case"left-handle":_=D.dot(V)/V.length(),f=this.actualWidthOfImageNode-_-this.fixedPosition.right,f+this.fixedPosition.right>this.actualWidthOfImageNode&&(f=this.actualWidthOfImageNode-this.fixedPosition.right),T=this.fixedPosition.top+"px",R=this.fixedPosition.right+"px",P=this.fixedPosition.bottom+"px";break;case"center-handle":h=(new i.Vector2).subVectors(w,y),c=h.dot(S)/S.length(),d=h.dot(M)/M.length(),""!==this.cropBox.style.left&&(C=c-this._dx_1,C<0?C=0:C>this.actualWidthOfImageNode-f&&(C=this.actualWidthOfImageNode-f),C+="px"),""!==this.cropBox.style.top&&(T=d-this._dy_1,T<0?T=0:T>this.actualHeightOfImageNode-b&&(T=this.actualHeightOfImageNode-b),T+="px")}if(this.cropBox.setStyles({width:(f<60?60:f)+"px",height:(b<60?60:b)+"px",top:T,left:C,right:R,bottom:P}),this.croppedImage.setStyles({top:T?"-"+T:"",left:C?"-"+C:"",right:R?"-"+R:"",bottom:P?"-"+P:""}),t.preventDefault(),this._cropBoxUIOptions.launchProfile){let t=JSON.parse(this._cropBoxUIOptions.launchProfile.points),h=[],c=[],d=[];for(var o=0;o<t.length;++o)h.push(new i.Vector2(t[o].x,t[o].y)),c.push(t[o].x),d.push(t[o].y);c.sort((function(t,e){return t-e})),d.sort((function(t,e){return t-e}));let g,p,u=c.length-1,m=[new i.Vector2(c[0],d[0]),new i.Vector2(c[u],d[0]),new i.Vector2(c[u],d[u]),new i.Vector2(c[0],d[u])],f={x:(m[0].x+m[2].x)/2,y:(m[0].y+m[2].y)/2},b=this.topLeft.distanceTo(this.topRight)/this.srcImage.width,w=m[0].distanceTo(m[1]),x=m[0].distanceTo(m[3]);g=parseFloat(this.cropBox.style.height),p=parseFloat(this.cropBox.style.width);let v=new i.Vector2(parseFloat(getComputedStyle(this.cropBox).getPropertyValue("left")),parseFloat(getComputedStyle(this.cropBox).getPropertyValue("top"))),y=g;var n=w;let D=p-n,_=v.x;var s=x,a=y-s,r=v.y;let I=[];for(o=0;o<h.length;++o){let t=h[o].x-f.x+w/2+v.x,e=h[o].y-f.y+x/2+v.y;I.push(new i.Vector2(t+(t-_)/n*D,e+(e-r)/s*a))}let T=new e.Element("canvas",{id:"editCanvas",styles:{height:this.srcImage.height*b+"px",width:this.srcImage.width*b+"px"}}),C=T.getContext("2d");T.width=this.srcImage.width*b,T.height=this.srcImage.height*b,C.strokeStyle="transparent";let P=I.length;C.beginPath(),C.moveTo(I[0].x,I[0].y);for(var l=1;l<P;++l)C.lineTo(I[l].x,I[l].y);C.closePath(),C.stroke(),C.clip(),C.drawImage(this.srcImage,0,0,T.width,T.height);let R=this.cropBox.querySelector("#finalcanvas");R.style.width=p+"px",R.style.height=g+"px";let S=R.getContext("2d");R.width=p,R.height=g,S.strokeStyle="transparent",S.drawImage(T,v.x,v.y,p,g,0,0,p,g),T.remove()}}},onMouseUp:function(t){if(this.isDragging){this.isDragging=!1;let e=0,i=0;e=""!==this.cropBox.style.top?parseInt(this.cropBox.style.top):""!==this.cropBox.style.bottom?parseInt(this.container.style.height)-(parseInt(this.cropBox.style.bottom)+parseInt(this.cropBox.style.height)):0,i=""!==this.cropBox.style.left?parseInt(this.cropBox.style.left):""!==this.cropBox.style.right?parseInt(this.container.style.width)-(parseInt(this.cropBox.style.right)+parseInt(this.cropBox.style.width)):0,this.cropBox.setStyles({top:e+"px",left:i+"px"}),this.masterContainer.style.cursor="auto",t.preventDefault()}},_getFootOfPerpendicularOnLineFromPoint:function(t,e){let o,n,s,a,r,l,h,c,d,g;return o=t.B.x-t.A.x,n=t.B.y-t.A.y,s=t.B.z-t.A.z,r=t.A.x,l=t.A.y,h=t.A.z,c=e.x,d=e.y,g=e.z,a=((c-r)*o+(d-l)*n+(g-h)*s)/(o*o+n*n+s*s),new i.Vector3(a*o+r,a*n+l,a*s+h)},buildCustomCursorSVG:function(t,e){let i=window.devicePixelRatio>1?2:1,o=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" \n                        width="32"\n                        height="32"\n                        viewBox="0 0 ${32*i} ${32*i}">\n                        <g>\n                          <polygon points="${16*i},${0*i} \n                                          ${22*i},${8*i} \n                                          ${17*i},${8*i} \n                                          ${17*i},${24*i} \n                                          ${22*i},${24*i} \n                                          ${16*i},${32*i} \n                                          ${10*i},${24*i} \n                                          ${15*i},${24*i} \n                                          ${15*i},${8*i} \n                                          ${10*i},${8*i}" \n                                  stroke="black" \n                                  fill="white" \n                                  transform="rotate(${t.angle*(180/Math.PI)+e}, ${16*i}, ${16*i})"/>\n                        </g>\n                      </svg>`,n=new Blob([o],{type:"image/svg+xml"});return URL.createObjectURL(n)},buildCustomMoveCursorSVG:function(t,e){let i=window.devicePixelRatio>1?2:1,o=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" \n                    viewBox="0 0 ${32*i} ${32*i}">\n                    <g>\n                      <polygon points="${16*i},${0*i}\n                                        ${22*i},${8*i}\n                                        ${17*i},${8*i}\n                                        ${17*i},${15*i}\n                                        ${24*i},${15*i}\n                                        ${24*i},${10*i}\n                                        ${32*i},${16*i}\n                                        ${24*i},${22*i}\n                                        ${24*i},${17*i}\n                                        ${17*i},${17*i}\n                                        ${17*i},${24*i}\n                                        ${22*i},${24*i}\n                                        ${16*i},${32*i}\n                                        ${10*i},${24*i}\n                                        ${15*i},${24*i}\n                                        ${15*i},${17*i}\n                                        ${8*i},${17*i}\n                                        ${8*i},${22*i}\n                                        ${0*i},${16*i}\n                                        ${8*i},${10*i}\n                                        ${8*i},${15*i}\n                                        ${15*i},${15*i}\n                                        ${15*i},${8*i}\n                                        ${10*i},${8*i}\n                                        ${16*i},${0*i}" \n                                  stroke="black" fill="white"\n                                  transform="rotate(${t.angle*(180/Math.PI)+e}, ${16*i}, ${16*i})"/>\n                        </g>\n                      </svg>`,n=new Blob([o],{type:"image/svg+xml"});return URL.createObjectURL(n)},buildUI:function(t){this.isDragging=!1,this.mouseDownPos=null,this.fixedPosition={},this.targetElem="";let n=0,s=0,a=0,r=0;n=void 0===t.cropSectionTop?t.topLeft.y:t.cropSectionTop*(t.imageWidth/t.actualImageWidth),s=void 0===t.cropSectionLeft?t.topLeft.x:t.cropSectionLeft*(t.imageHeight/t.actualImageHeight),a=(t.cropSectionWidth,t.imageWidth),r=(t.cropSectionHeight,t.imageHeight),this.topLeft=t.topLeft,this.topRight=t.topRight,this.bottomRight=t.bottomRight,this.bottomLeft=t.bottomLeft,this.masterContainer=new e.Element("div",{id:"cropbox-ui-container",styles:{width:"100%",height:"100%",position:"absolute",top:"0px",left:"0px","background-color":"rgba(0, 0, 0, 0.5)"}}).inject(t.container),this.masterContainer.addEvent("wheel",(t=>{t.preventDefault&&t.preventDefault()}));let l="translate("+(t.centerX-.5*a)+"px, "+(t.centerY-.5*r)+"px) ",h="rotate("+t.angle*(180/Math.PI)+"deg)";this.angle=t.angle;if(this.container=new e.Element("div",{id:"full-background-image",styles:{position:"absolute",top:"0px",left:"0px",width:a+"px",height:r+"px","pointer-events":"auto",transform:l+h,opacity:.2,"background-image":"url("+t.imageURL+")","background-size":"contain","background-repeat":"no-repeat"}}).inject(this.masterContainer),this.actualImageBlackOverlay=new e.Element("div",{id:"actual-image-black-overlay",styles:{position:"absolute",top:"0px",left:"0px",width:a+"px",height:r+"px","background-color":"rgba(0, 0, 0, 0.6)",transform:l+h}}).inject(this.masterContainer),this.cropBox=new e.Element("div",{id:"image-crop-box",styles:{width:t.cropSectionWidth?t.cropSectionWidth*(t.imageWidth/t.actualImageWidth):t.imageWidth+"px",height:t.cropSectionWidth?t.cropSectionHeight*(t.imageHeight/t.actualImageHeight):t.imageHeight+"px",top:t.cropSectionTop?n:"0px",left:t.cropSectionLeft?s:"0px",position:"absolute",overflow:"hidden"}}).inject(this.actualImageBlackOverlay),this.cropBox.addEvent(o.POINTERDOWN,function(t){this.targetElem="center-handle",this.mouseDownPos=this.topLeft,this.onMouseDown(t)}.bind(this)),this.croppedImage=new e.Element("img",{id:"cropped-image",src:t.imageURL,styles:{width:a+"px",height:r+"px",top:t.cropSectionTop?-n:"0px",left:t.cropSectionLeft?-s:"0px",position:"absolute","pointer-events":"none"}}).inject(this.cropBox),t.launchProfile){this.croppedImage.style.display="none";let o=JSON.parse(t.launchProfile.points),n=[],s=[],a=[];for(var c=0;c<o.length;++c)n.push(new i.Vector2(o[c].x,o[c].y)),s.push(o[c].x),a.push(o[c].y);s.sort((function(t,e){return t-e})),a.sort((function(t,e){return t-e}));let r,l,h=s.length-1,f=[new i.Vector2(s[0],a[0]),new i.Vector2(s[h],a[0]),new i.Vector2(s[h],a[h]),new i.Vector2(s[0],a[h])],b={x:(f[0].x+f[2].x)/2,y:(f[0].y+f[2].y)/2},w=this.topLeft.distanceTo(this.topRight)/this.srcImage.width,x=f[0].distanceTo(f[1]),v=f[0].distanceTo(f[3]);if(void 0===t.cropSectionTop){let t=f[0].distanceTo(f[1])/f[0].distanceTo(f[3]),o=this.srcImage.width/this.srcImage.height;t>1&&o>1||t<=1&&o<=1?t>o?l=this.srcImage.width:r=this.srcImage.height:1==t&&1==o?r=this.srcImage.height:t>1?l=this.srcImage.width:r=this.srcImage.height,r?l=r*t:r=l/t,l*=w,r*=w;let s=new i.Vector2(this.srcImage.width*w/2-l/2,this.srcImage.height*w/2-r/2),a=r;let h=l-(u=x),y=s.x;var d=a-(m=v),g=s.y;let D=[];for(c=0;c<n.length;++c){let t=n[c].x-b.x+x/2+s.x,e=n[c].y-b.y+v/2+s.y;D.push(new i.Vector2(t+(t-y)/u*h,e+(e-g)/m*d))}this.cropBox.style.height=r+"px",this.cropBox.style.width=l+"px",this.cropBox.style.left=s.x+"px",this.cropBox.style.top=s.y+"px";let _=new e.Element("canvas",{id:"editCanvas",styles:{height:this.srcImage.height*w+"px",width:this.srcImage.width*w+"px"}}),I=_.getContext("2d");_.width=this.srcImage.width*w,_.height=this.srcImage.height*w,I.strokeStyle="transparent";let T=D.length;I.beginPath(),I.moveTo(D[0].x,D[0].y);for(var p=1;p<T;++p)I.lineTo(D[p].x,D[p].y);I.closePath(),I.stroke(),I.clip(),I.drawImage(this.srcImage,0,0,_.width,_.height);let C=new e.Element("canvas",{id:"finalcanvas",styles:{height:r+"px",width:l+"px"}}),P=C.getContext("2d");C.width=l,C.height=r,P.strokeStyle="transparent",P.drawImage(_,s.x,s.y,l,r,0,0,l,r),this.cropBox.appendChild(C),C.style.position="absolute",C.style.top="0px",C.style.left="0px",_.remove()}else{r=parseFloat(this.cropBox.style.height),l=parseFloat(this.cropBox.style.width);let t=new i.Vector2(parseFloat(this.cropBox.style.left),parseFloat(this.cropBox.style.top)),o=r;var u;let s=l-(u=x),a=t.x;var m;d=o-(m=v),g=t.y;let h=[];for(c=0;c<n.length;++c){let e=n[c].x-b.x+x/2+t.x,o=n[c].y-b.y+v/2+t.y;h.push(new i.Vector2(e+(e-a)/u*s,o+(o-g)/m*d))}let f=new e.Element("canvas",{id:"editCanvas",styles:{height:this.srcImage.height*w+"px",width:this.srcImage.width*w+"px"}}),y=f.getContext("2d");f.width=this.srcImage.width*w,f.height=this.srcImage.height*w,y.strokeStyle="transparent";let D=h.length;y.beginPath(),y.moveTo(h[0].x,h[0].y);for(p=1;p<D;++p)y.lineTo(h[p].x,h[p].y);y.closePath(),y.stroke(),y.clip(),y.drawImage(this.srcImage,0,0,f.width,f.height);let _=new e.Element("canvas",{id:"finalcanvas",styles:{height:r+"px",width:l+"px"}}),I=_.getContext("2d");_.width=l,_.height=r,I.strokeStyle="transparent",I.drawImage(f,t.x,t.y,l,r,0,0,l,r),this.cropBox.appendChild(_),_.style.position="absolute",_.style.top="0px",_.style.left="0px",f.remove()}}new e.Element("div",{id:"top-left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 31,1 31,8 8,8 8,31 1,31 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"0px",left:"0px",cursor:`url(${this.buildCustomCursorSVG(t,-45)}) 16 16, nw-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,-45)}) 16 16, n-resize`,this.targetElem="top-left-handle",this.mouseDownPos=this.topLeft,this.fixedPosition={bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height)),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width))},this.onMouseDown(e)}.bind(this)),new e.Element("div",{id:"top-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="30" height="8" stroke="black" stroke-width="2" fill="white" x="1" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"0px",left:"calc(50% - 10px)",cursor:`url(${this.buildCustomCursorSVG(t,0)}) 16 16, n-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,0)}) 16 16, n-resize`,this.targetElem="top-handle",this.mouseDownPos={x:.5*(this.topLeft.x+this.topRight.x),y:.5*(this.topLeft.y+this.topRight.y)},this.fixedPosition={bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height)),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width)),left:parseInt(this.cropBox.style.left)},this.onMouseDown(e)}.bind(this)),new e.Element("div",{id:"top-right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 31,1 31,31 24,31 24,8 1,8 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"0px",right:"0px",cursor:`url(${this.buildCustomCursorSVG(t,45)}) 16 16, ne-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,45)}) 16 16, ne-resize`,this.targetElem="top-right-handle",this.mouseDownPos=this.topRight,this.fixedPosition={left:parseInt(this.cropBox.style.left),bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height))},this.onMouseDown(e)}.bind(this)),new e.Element("div",{id:"right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="8" height="30" stroke="black" stroke-width="2" fill="white" x="23" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",right:"0px",top:"calc(50% - 10px)",cursor:`url(${this.buildCustomCursorSVG(t,90)}) 16 16, e-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,90)}) 16 16, e-resize`,this.targetElem="right-handle",this.mouseDownPos={x:.5*(this.topRight.x+this.bottomRight.x),y:.5*(this.topRight.y+this.bottomRight.y)},this.fixedPosition={top:parseInt(this.cropBox.style.top),left:parseInt(this.cropBox.style.left),bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height))},this.onMouseDown(e)}.bind(this)),new e.Element("div",{id:"bottom-right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="31,31 31,1 24,1 24,24 1,24 1,31 31,31"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"0px",right:"0px",cursor:`url(${this.buildCustomCursorSVG(t,-45)}) 16 16, se-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,-45)}) 16 16, se-resize`,this.targetElem="bottom-right-handle",this.mouseDownPos=this.bottomRight,this.fixedPosition={top:parseInt(this.cropBox.style.top),left:parseInt(this.cropBox.style.left)},this.onMouseDown(e)}.bind(this)),new e.Element("div",{id:"bottom-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="30" height="8" stroke="black" stroke-width="2" fill="white" x="1" y="23"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"0px",left:"calc(50% - 10px)",cursor:`url(${this.buildCustomCursorSVG(t,0)}) 16 16, s-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,0)}) 16 16, s-resize`,this.targetElem="bottom-handle",this.mouseDownPos={x:.5*(this.bottomRight.x+this.bottomLeft.x),y:.5*(this.bottomRight.y+this.bottomLeft.y)},this.fixedPosition={top:parseInt(this.cropBox.style.top),left:parseInt(this.cropBox.style.left),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width))},this.onMouseDown(e)}.bind(this)),new e.Element("div",{id:"bottom-left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 1,31 31,31 31,24 8,24 8,1 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"0px",left:"0px",cursor:`url(${this.buildCustomCursorSVG(t,45)}) 16 16, sw-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,45)}) 16 16, sw-resize`,this.targetElem="bottom-left-handle",this.mouseDownPos=this.bottomLeft,this.fixedPosition={top:parseInt(this.cropBox.style.top),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width))},this.onMouseDown(e)}.bind(this)),new e.Element("div",{id:"left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="8" height="30" stroke="black" stroke-width="2" fill="white" x="1" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"calc(50% - 10px)",left:"0px",cursor:`url(${this.buildCustomCursorSVG(t,90)}) 16 16, w-resize`,"z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(e){this.masterContainer.style.cursor=`url(${this.buildCustomCursorSVG(t,90)}) 16 16, w-resize`,this.targetElem="left-handle",this.mouseDownPos={x:.5*(this.bottomLeft.x+this.topLeft.x),y:.5*(this.bottomLeft.y+this.topLeft.y)},this.fixedPosition={top:parseInt(this.cropBox.style.top),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width)),bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height))},this.onMouseDown(e)}.bind(this));let f=new e.Element("div",{id:"center-handle",styles:{height:"8px",width:"8px",position:"absolute",top:"calc(50% - 4px)",left:"calc(50% - 4px)","z-index":1,"background-color":"white",border:"1px solid black"}}).inject(this.cropBox);new e.Element("div",{id:"center-handle",styles:{height:"20px",width:"20px",position:"absolute",top:"-7px",left:"-7px",cursor:`url(${this.buildCustomMoveCursorSVG(t,0)}) 16 16, move`}}).inject(f),this.masterContainer.addEvent(o.POINTERMOVE,this.onMouseMove.bind(this)),this.masterContainer.addEvent(o.POINTERUP,this.onMouseUp.bind(this)),this.masterContainer.addEventListener("mouseleave",this.onMouseUp.bind(this))},findIntersectionOfLineSegments:function(t,e,o,n){let s=t.x,a=t.y,r=e.x,l=e.y,h=o.x,c=o.y,d=n.x,g=n.y,p=(s-r)*(c-g)-(a-l)*(h-d);if(0===p)return null;let u=((s-h)*(c-g)-(a-c)*(h-d))/p,m=-((s-r)*(a-c)-(a-l)*(s-h))/p;if(u>=0&&u<=1&&m>=0&&m<=1){let t=s+u*(r-s),e=a+u*(l-a);return new i.Vector2(t,e)}return null},getCropInfo:function(t,e){let i=parseInt(this.cropBox.style.top),o=parseInt(this.cropBox.style.left),n=parseInt(this.cropBox.style.width),s=parseInt(this.cropBox.style.height),a=this.srcImage.width/t;return{srcData:{width:this.srcImage.width,height:this.srcImage.height},cropData:{top:i*a,left:o*a,width:n*a,height:s*a,hRatio:n/t,vRatio:s/e},profile:this._cropBoxUIOptions.launchProfile?this._cropBoxUIOptions.launchProfile:void 0}},dispose:function(){this.actualImageBlackOverlay&&(this.actualImageBlackOverlay.remove(),this.actualImageBlackOverlay=void 0),this.container&&(this.container.remove(),this.container=void 0),this.masterContainer&&(this.masterContainer.remove(),this.masterContainer=void 0)}})})),define("DS/CAT3DWInfraUI/CAT3DWPublishServices",["UWA/Class","UWA/Core","DS/ApplicationFrame/FrameWindowsManager","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/ZipJS/zip","DS/CAT3DWInfraUI/CAT3DWCanvasServices"],(function(t,e,i,o,n,s){"use strict";var a=t.extend({getScreenShot:function(t){var e;t.viewer?e=t.viewer:i.getFrameWindow().getViewer()&&(e=i.getFrameWindow().getViewer());var n=e.currentViewpoint,a=o.getPreferenceValue("MobileMode"),r=null,l=null;const h=268435456,c=16777216;if(t.quality?"low"===t.quality?l=a?2097152:33554432:"medium"===t.quality?l=a?4194304:67108864:"high"===t.quality&&(l=a?c:h):l=c,t.width&&t.height){let e=t.width,i=t.height,o=e*i,n=Math.sqrt(l/o);n<1&&(e*=n,i*=n),r={width:Math.floor(e),height:Math.floor(i)}}else{let t=e.SCREEN_WIDTH*window.devicePixelRatio,i=e.SCREEN_HEIGHT*window.devicePixelRatio,o=t*i,n=Math.sqrt(l/o);n>1&&(n=Math.floor(n)),r={width:Math.floor(t*n),height:Math.floor(i*n)}}r.data=new Uint8ClampedArray(4*r.width*r.height),r.bufferWidth=r.width,r.bufferHeight=r.height,n.getControl().update(),e.renderToTarget(r,n);var d,g,p,u,m=new Uint8ClampedArray(4*r.width*r.height),f=r.height,b=r.width,w=4*b;for(g=0;g<f;g++)for(p=g*b*4,u=(f-g)*b*4-w,d=w;d--;)m[p+d]=r.data[u+d],m[p+d];var x=(new s).createCanvas({width:r.width,height:r.height,tag:"PublishScreenshotCanvas"}),v=x.getContext("2d"),y=new ImageData(m,x.width,x.height);v.putImageData(y,0,0),t.onSuccess(x)},renderZBuffer:function(t){var e;t.viewer?e=t.viewer:i.getFrameWindow().getViewer()&&(e=i.getFrameWindow().getViewer());var o={data:null,width:0,height:0};o.width=e.SCREEN_WIDTH,o.height=e.SCREEN_WIDTH,e.grabDepthBuffer(o);let n=0,a=1;for(let t=0;t<o.data.length;t++){let e=o.data[t];e>n&&(n=e),e<a&&0!=e&&(a=e)}let r=n-a;for(let t=0;t<o.data.length;t++)0!=o.data[t]&&(o.data[t]=(o.data[t]-a)/r,o.data[t]=1-o.data[t]);var l=(new s).createCanvas({width:o.width,height:o.height,tag:"PublishScreenshotCanvas"}),h=l.getContext("2d"),c=h.getImageData(0,0,l.width,l.height),d=c.data,g=(o.width-1)/(c.width-1),p=(o.height-1)/(c.height-1);function u(t,e,i,o,n){return n&&(e=o-e),i*Math.floor(e)+Math.floor(t)}for(var m=0;m<c.height;m++)for(var f=0;f<c.width;f++){var b=u(f,m,c.width,c.height,!1),w=u(g*f,p*m,o.width,o.height,!0);d[4*b]=255*o.data[w],d[4*b+1]=255*o.data[w],d[4*b+2]=255*o.data[w],d[4*b+3]=255}h.putImageData(c,0,0,0,0,l.width,l.height),t.onSuccess(l)},zip:function(t){return new Promise((function(e,i){var o=null,s=function(t){if(0===t.length)o.close((function(t){e(t)}));else{var i=t.shift(),a=null;"text"===i.type?a=new n.TextReader(i.data):"blob"===i.type&&(a=new n.BlobReader(i.data)),o.add(i.filename,a,(function(){s(t)}))}},a=new n.BlobWriter;n.createWriter(a,(function(e){o=e,s(t)}),(function(){console.log("zip creation error"),i()}))}))},unzip:function(t,e){return new Promise((function(i){var o=new n.BlobReader(t);n.createReader(o,(function(t){var o=t;o.getEntries((function(t){var s=t.find((function(t){return t.filename===e}));s&&s.getData(new n.TextWriter,(function(t){var e=t.target.result;o.close((function(){i(e)}))}))}))}),(function(){console.log("zip error")}))}))},unzipWithAllFiles:function(t,e){return new Promise((i=>{let o=new n.BlobReader(t),s=new Map;n.createReader(o,(t=>{let o=t;o.getEntries(async function(t){for(let i=0;i<t.length;i++){let n=t[i],a=i==t.length-1,r=e==n.filename;if(n){let t=await this.getzipEntryData(o,n,a,r);s.set(n.filename,t)}}i(s)}.bind(this))}),(function(){console.log("zip error")}))}))},getzipEntryData:function(t,e,i,o){return new Promise((function(s){var a=!1===o?new n.BlobWriter:new n.TextWriter;e.getData(a,(function(e){if(o){var n=e.target.result;i?t.close((function(){s(n)})):s(n)}else{var a=new FileReader;a.onload=function(){var e=this.result;i?t.close((function(){s(e)})):s(e)},a.readAsArrayBuffer(e)}}))}))}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWPublishServices",a)})),define("DS/CAT3DWInfraUI/CAT3DWAnnotHandleManipulator",["DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle","UWA/Core"],(function(t,e){"use strict";var i=t.extend({init:function(t){t.mode="AnnotShapeEdit",this._parent(t)},_getListOfManipulatorNames:function(){return["bottomRightHandler","bottomLeftHandler","topRightHandler","topLeftHandler","rotationHandler","bottomCenterHandler","topCenterHandler","leftCenterHandler","rightCenterHandler"]},updateAll:function(t){if(t){this.objects=t;for(let e of this._manipulators)e.objects=t}this._parent(t)}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWAnnotHandleManipulator",i)})),define("DS/CAT3DWInfraUI/CAT3DWAINodeHandleManipulator",["DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle","UWA/Core"],(function(t,e){"use strict";var i=t.extend({init:function(t){this._parent(t)},_getListOfManipulatorNames:function(){return["bottomRightHandler","bottomLeftHandler","topRightHandler","topLeftHandler"]}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWAINodeHandleManipulator",i)})),define("DS/CAT3DWInfraUI/CAT3DWManageManipulators",["DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle","UWA/Class","UWA/Core","DS/CAT3DWInfraUI/CAT3DWAnnotHandleManipulator","DS/CAT3DWInfraUI/CAT3DWAINodeHandleManipulator"],(function(t,e,i,o,n){"use strict";var s=e.extend({assignManipulator:function(e){return"CAT3DSKAnnotationShape"===e.media.getType()?new o(e):"CAT3DSKAIGeneration"===e.media.getType()?new n(e):new t(e)},assignManipulatorToGroup:function(e){var i=new t({viewer:e.viewer,sceneGraph:e.sceneGraph,group:e.group,mediaController:e.mediaController,planeChoiceNode:e.planeChoiceNode});i.pause(),e.group.setHandle(i)}});return i.namespace("DS/CAT3DWInfraUI/CAT3DWManageManipulators",s)}));