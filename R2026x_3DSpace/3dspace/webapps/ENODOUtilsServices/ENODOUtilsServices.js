define("DS/ENODOUtilsServices/DOServices",["UWA/Core","UWA/Promise","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/WidgetServices/securityContextServices/SecurityContextServices","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/Notifications/NotificationsManagerViewOnScreen","DS/Notifications/NotificationsManagerUXMessages","i18n!DS/ENODOUtilsServices/assets/nls/enodo_notifications.json","text!DS/ENODOUtilsServices/assets/enodo_webservices.json"],(function(e,t,n,i,r,o,a,c,s,l){"use strict";var u=JSON.parse(l),f=null;return{DownloadURL:function(e,t){var n=new XMLHttpRequest;n.open("POST",e),n.responseType="blob",n.onload=function(){if(window.navigator.msSaveBlob)window.navigator.msSaveBlob(n.response,t);else{var e=document.createElement("a");e.href=window.URL.createObjectURL(n.response),t&&(e.download=t),e.style.display="none",document.body.appendChild(e),e.click(),e=void 0}},n.send()},DownloadBinary:function(e,t){var n=new Blob([e],{type:"application/zip"}),i=document.createElement("a");i.href=URL.createObjectURL(n),t&&(i.download=t+".zip"),i.style.display="none",document.body.appendChild(i),i.click(),i=void 0},isAccessforDownloadDO:function(){var e=this;return new t((function(t,n){var i={webService:{url:u.getFilterValidSC.url,verb:u.getFilterValidSC.verb},callback:{onComplete:function(e){t(e)},onFailure:function(e){n(e||new Error("Issue retrieving Access for Download DO"))}}};e.SendServerRequest(i)}))},getDownloadTicket:function(e){var n=this,i=e.Filename,r=e.Format,o=e.ObjectID,a=e.DOID,c=e.DOFID,s=e.Title?e.Title:i;return new t((function(e,t){var l={data:{reps:[{id:o,keys:[{format:r,filename:i,DO_ID:a,DOF_ID:c,title:s}]}]},webService:{url:u.downloadTicket.url,verb:u.downloadTicket.verb},callback:{onComplete:function(t){if(void 0!==(t=UWA.is(t,"string")?JSON.parse(t):t).ticketURL&&void 0!==t.ticket){var n=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket);e(n)}},onFailure:function(e){t(e||new Error("Error retrieving download ticket"))}}};n.SendServerRequest(l)}))},retrieveSelectionInfo:function(e,n,i){var r=this;return new t((function(t,o){var a={data:{physicalid:e,label:"FetchObjectInfo_DOSP",select_predicate:n},webService:{url:u.fetch.url,verb:u.fetch.verb},callback:{onComplete:function(e){var n=UWA.is(e,"string")?JSON.parse(e):e;t(i(n))},onFailure:function(e){o(e||new Error("Issue retrieving selection informations"))}}};r.SendServerRequest(a)}))},GetCurrentSecurityContext:function(){var e=this;return new t((function(t,n){r.getInstance().getSecurityContext({onSuccess:function(e){var n=e.SecurityContext.replace("ctx::","");t(n)},onFailure:function(){e.GetValidSecurityContext().then((function(e){t(e)}),(function(e){n(e)}))}})}))},GetValidSecurityContext:function(){return new t((function(e,t){r.getInstance().getValidSecurityContext({onSuccess:function(t){var n=t.SecurityContext.replace("ctx::","");e(n)},onFailure:function(){var e={message:s.error.security_context_fail};t(e)}})}))},GetCurrentRole:function(){var e=this;return new t((function(t,n){e.GetCurrentSecurityContext().then((function(e){var n=e.split(".");t(n[0])}),(function(e){n(e)}))}))},GetCurrentUser:function(){return null==f&&(f=i.getUser()),f},getUserLogin:function(){var e=this.GetCurrentUser(),t="";return void 0!==e&&(t=e.login),t},get3DSpaceUrl:function(e){if(null==e)throw new Error("Platform services not initialize yet");return this.getPlatformURL("3DSpace",e)},getPlatformId:function(){return"undefined"!=typeof widget&&widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise"},retrievePlatformUrl:function(){return new t((function(e,t){o.getPlatformServices({onComplete:function(t){e(t)},onFailure:function(e){t(e)}})}))},getTenantInfo:function(e,t){for(var n={},i=0;i<t.length;i++)if(t[i].platformId===e){n=t[i];break}return n},getPlatformURL:function(e,t){if(!UWA.is(t,"array"))throw new Error("Platform services not initialize yet");var n=this.getPlatformId(),i=this.getTenantInfo(n,t);if(void 0===i[e])throw new Error("Unknown service "+e);return i[e]},getCompassURL:function(){var e=this;return new t((function(t,n){e.retrievePlatformUrl().then((function(n){if(null==n)throw new Error("Platform services not initialize yet");var i={},r=e.getPlatformURL("3DCompass",n);i.iconURL=r+"/widget/images/MyApps/X3DPLAW_AP_AppIcon.svg",i.spaceURL=e.getPlatformURL("3DSpace",n),t(i)}),(function(e){n(e)}))}))},_displayNotification:function(e,t,n,i){window.notifs=c,a.setNotificationManager(window.notifs);var r={level:e,title:t,subtitle:i,message:n,sticky:!1};window.notifs.addNotif(r)},SendServerRequest:function(e){var t=this,i=this.getUserLogin(),r={};r.method=e.webService.verb,t.GetCurrentSecurityContext().then((function(o){r.headers={Accept:e.webService.hasOwnProperty("accept")?e.webService.accept:"application/json","Content-Type":"application/json","Accept-Language":widget.lang,SecurityContext:encodeURIComponent("ctx::"+o),SecurityToken:encodeURIComponent(i+"|ctx::"+o+"|"+widget.lang)},r.type=e.webService.hasOwnProperty("type")?e.webService.type:"json",r.proxy="passport",r.timeout=void 0!==e.timeout?e.timeout:3e5,r.onComplete=e.callback.onComplete,r.onFailure=e.callback.onFailure,r.onTimeout=void 0!==e.callback.onTimeout?e.callback.onTimeout:e.callback.onFailure;var a=e.data;r.data=JSON.stringify(a),t.retrievePlatformUrl().then((function(i){var o=t.get3DSpaceUrl(i);n.authenticatedRequest(o+e.webService.url,r)}))})).catch((function(t){e.callback.onFailure(t)}))}}}));