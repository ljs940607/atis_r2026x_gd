define("DS/DMUMarkerManipulators/DMUMarkerLineManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Manipulators/PointHandle","DS/DMUBaseExperience/EXPToolsVisualization","DS/Mesh/Mesh","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIServices/DMUObjectsServices"],(function(e,t,i,n,o,a,r,s){"use strict";return e.extend({init:function(e){if(e&&e.dmuObj&&e.viewer){var l,c,h,p,u,d,M=e.dmuObj,g=M.getManipulationData(),f=e.viewer,v=new a(f),P=v.getPointedElem();if(this.onBeginManipulateCB=function(e){if(e){h=g.slice(),p=[];for(var i=0;i<h.length;i++){var o=n.getViewerPositionFromPoint(f,h[i]);o=new t.Vector2(o.left,o.top),p.push(o)}}},this.onManipulateCB=function(e){if(e){if(e.translationVector2D&&h&&h.length&&p&&p.length)for(var t=0;t<h.length;t++)g[t]=n.getPositionFromIntersection(f,p[t].clone().add(e.translationVector2D),h[t]);else if(e.handleType&&"Center"===e.handleType&&e.transVec2D)for(var i=0;i<h.length;i++)g[i]=n.getPositionFromIntersection(f,p[i].clone().add(e.transVec2D),h[i]);M.updateRepresentation&&M.updateRepresentation(g,!1)}},this.onEndManipulateCB=function(){if(h)for(var e=0;e<h.length;e++)b(e);M.updateRepresentation&&M.updateRepresentation(g,!0)},!l){l=[];for(var w=0;w<g.length;w++){var m=new i({viewer:f,sceneGraph:M.getNode().getRepNode()});m.subscribe("BeginManipulate",x),m.subscribe("Manipulate",y),m.subscribe("EndManipulate",D),m.subscribe("EndPreactivate",(function(){P.setStyle("cursor","")})),m.subscribe("BeginPreactivate",(function(){P.setStyle("cursor","move")})),m.setCursor(!1),m.diskNode.setNoHighlightNoZ(!0),m.manipulator.setPreActivationDuringManipulation(!1),l.push({uid:m.manipulator.getUID(),handleNb:w,handle:m}),b(w)}}this.setHandlesVisibility=function(e){if(l&&l.length)for(var t=0;t<l.length;t++)l[t].handle.setVisibility(e)},this.remove=function(){l&&l.length&&l.forEach((function(e){e.handle.dispose()})),v&&v.remove(),v=l=c=p=u=d=h=g=null}}function b(e){l&&l.length&&l[e].handle.setMatrix((new t.Matrix4).setPosition(g[e]))}function y(i){if(i&&v.isCanvasToDraw(i.event.from[0].getView())){v.updateManipulationData(i);var o,a=i.intersection,l=0===c?1:0,h=i.shiftKey||void 0===i.shiftKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.shiftKey;if(a.position&&a.path.length){if(r.isAPOIPath(a.path[0])){const{position:e}=s.getPOIInformationFromPathElement(a.path[0]);e&&(o=e)}o||(o=n.getPositionFromIntersection(f,a.position,a.position,!0))}else o=n.getPositionFromIntersection(f,a.position,g[l],!0);var p,P=i.event.from[0].getCurrentPosition(f.canvas),w=n.getViewerPositionFromPoint(f,g[l]);w=new t.Vector2(w.left,w.top);var m=(new t.Vector2).subVectors(P,w),b=new t.Vector2(1,0).dot(m.clone().normalize());if(p=P.y<=w.y?Math.acos(b):2*Math.PI-Math.acos(b),d!==h){var y=Math.round(p/u)*u,x=new t.Vector2(Math.cos(y),-Math.sin(y));if(x.setLength(m.dot(x)),x.distanceTo(m)<v.ROTATION_SNAP_THRESHOLD){x.normalize();var D=0===c?1:0,V=(new t.Vector2).subVectors(n.get2DSnappedPosition(P,y),w);x.setLength(V.dot(x)),g[c]=n.getPositionFromIntersection(f,w.add(x),g[l]),v.displayAxis(g[D],y,V.length()+20)}else g[c]=o,v.removeAxis()}else g[c]=o,v.removeAxis();M.updateRepresentation&&M.updateRepresentation(g,!1),e.onManipulateCB&&e.onManipulateCB()}}function x(t){if(t){M.setNodePickable(o.INVISIBLE);for(var i=0;i<l.length;i++)if(l[i].uid===t.manipulator.getUID()){c=l[i].handleNb;break}var a=parseFloat(n.getSnapRotationInfos().snapRotationAngle);u=(isNaN(a)?90:a)*Math.PI/180,d=n.getSnapRotationInfos().snapRotationToggle,v.addToListener("Shift",y),v.activate(),P.setStyle("cursor","crosshair"),e.onBeginManipulateCB&&e.onBeginManipulateCB({handleType:c})}}function D(t){t&&(P.setStyle("cursor",""),v.remove(),b(c),M.setNodePickable(o.PICKABLE),c=null,e.onEndManipulateCB&&e.onEndManipulateCB())}}})})),define("DS/DMUMarkerManipulators/DMUMarkerRecManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/PointHandle","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPToolsMaterial","DS/DMUBaseExperience/EXPToolsVisualization","DS/Mesh/Mesh","DS/WebappsUtils/WebappsUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseUIManipulators/DMUManipulatorsHelper"],(function(e,t,i,n,o,a,r,s,l,c,h,p){"use strict";return e.extend({init:function(e){if(e&&e.dmuObj&&e.viewer){var u,d,M,g,f,v,P,w,m,b,y,x,D,V,S=e.viewer,C=e.dmuObj,R=C.getManipulationData(),I=C.getNode().getRepNode(),B=new p(S),U=B.getPointedElem(),T=l.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/"),k=["url("+T+"DMUPositionCursorHL.png) 10 10, auto","url("+T+"DMURotationCursorHL.png) 16 16, auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];if(this.onBeginManipulateCB=function(e){e&&(g||(g={}),e.boundingBox&&(g.height=e.boundingBox.height,g.width=e.boundingBox.width,g.position=e.boundingBox.position),x=R.width,y=R.height,D=R.rotation,b=R.position,m=r.getViewerPositionFromPoint(S,b),m=new t.Vector2(m.left,m.top))},this.onManipulateCB=function(e){e&&(e.handleType&&"Vertex"!==e.handleType?function(e){if(e)if(void 0!==e.rotationAngle&&"Rot"===e.handleType)R.rotation=D+e.rotationAngle;else if(e.transVec2D)if("Center"===e.handleType){R.position=r.getNearPositionFrom2DCoordinates(m.clone().add(e.transVec2D),S,b);var i=r.getMMPerPixelRatio(S,b),n=r.getMMPerPixelRatio(S,R.position);R.width=x*n/i,R.height=y*n/i}else{var o,a,s,l,c=e.transVec2D.clone(),h=r.getMMPerPixelRatio(S,b),p=r.getMMPerPixelRatio(S,g.position),u=x/h/(g.width/p),d=y/h/(g.height/p);switch(c.setX(c.x*u),c.setY(c.y*d),h*=e.ctrlKey?2:1,e.handleType){case"TL":a=x-c.x*h,s=y-c.y*h,l=new t.Vector3(-1,-1),o=!0;break;case"TR":a=x+c.x*h,s=y-c.y*h,l=new t.Vector3(-1,1),o=!0;break;case"BL":a=x-c.x*h,s=y+c.y*h,l=new t.Vector3(1,-1),o=!0;break;case"BR":a=x+c.x*h,s=y+c.y*h,l=new t.Vector3(1,1),o=!0;break;case"Top":s=y-c.y*h,c.setX(0);break;case"Right":a=x+c.x*h,c.setY(0);break;case"Bottom":s=y+c.y*h,c.setX(0);break;case"Left":a=x-c.x*h,c.setY(0)}if(e.shiftKey&&o){var M=Math.max(Math.abs(a/x),Math.abs(s/y));R.width=x*M,R.height=y*M;var f=new t.Vector2(Math.sin(R.rotation),Math.cos(R.rotation)).multiplyScalar(l.x*(R.height*Math.sign(s)-y)/h),v=new t.Vector2(Math.cos(R.rotation),-Math.sin(R.rotation)).multiplyScalar(l.y*(R.width*Math.sign(a)-x)/h);c=f.add(v)}else if(R.width=a?Math.abs(a):R.width,R.height=s?Math.abs(s):R.height,!e.ctrlKey&&R.rotation){var P=c.x*Math.cos(-R.rotation)-c.y*Math.sin(-R.rotation),w=c.x*Math.sin(-R.rotation)+c.y*Math.cos(-R.rotation);c.setX(P),c.setY(w)}e.ctrlKey?R.position=b:R.position=r.getPositionFromIntersection(S,m.clone().add(c.multiplyScalar(.5)),b)}}(e):e.translationVector2D&&(R.position=r.getPositionFromIntersection(S,m.clone().add(e.translationVector2D),b)),C.updateRepresentation&&C.updateRepresentation(R,!1))},this.onEndManipulateCB=function(){K(),C.updateRepresentation&&C.updateRepresentation(R,!0)},!u){u=[];for(var E=0;E<10;E++){var N=20;1===E&&(N=24);var A,H,L=new n({viewer:S,sceneGraph:I,size:N});switch(L.subscribe("BeginManipulate",z),L.subscribe("Manipulate",F),L.subscribe("EndManipulate",O),L.subscribe("BeginPreactivate",X),L.subscribe("EndPreactivate",(function(){U.setStyle("cursor","")})),L.setCursor(!1),L.diskNode.setNoHighlightNoZ(!0),L.manipulator.setPreActivationDuringManipulation(!1),E){case 0:A="Center",H="move";break;case 1:A="Rot",H="url("+T+"DMURotationCursorSel.png) 16 16, auto";break;case 2:A="TL",H="crosshair";break;case 3:A="Top",H="crosshair";break;case 4:A="TR",H="crosshair";break;case 5:A="Right",H="crosshair";break;case 6:A="BR",H="crosshair";break;case 7:A="Bottom",H="crosshair";break;case 8:A="BL",H="crosshair";break;case 9:A="Left",H="crosshair"}0!==E&&(L.manipulator.setPrePickingDuringManipulation(!1),L.manipulator.setPickingDuringManipulation(!1)),1===E&&(L.pointMat.map=new t.ImageUtils.loadTexture(T+"DMURotationManip.png",void 0,null,null,t.ImageUtils.crossOriginPolicy)),u.push({uid:L.manipulator.getUID(),type:A,handle:L,cursor:H})}d||((d=new i).setPickable(s.PICKTHROUGH),d.setNoHighlightNoZ(!0),M||(M=a.createLineMaterial({color:new t.Color(11843258),opacity:1,lineWidth:window.devicePixelRatio,pattern:"6"})),I.addChild(d)),K()}this.setHandlesVisibility=function(e){if(u&&u.length)for(var t=0;t<u.length;t++)u[t].handle.setVisibility(e);d&&d.setVisibility(e)},this.remove=function(){u&&u.length&&u.forEach((function(e){e.handle.dispose()})),u=null,d&&(d.removeChildren(),I.removeChild(d)),B&&B.remove(),M&&M.dispose(),d=I=g=C=f=M=R=S=null,B=null}}function F(i){if(i&&B.isCanvasToDraw(i.event.from[0].getView())){B.updateManipulationData(i);var n,o,a=i.event.from[0].getCurrentPosition(i.viewer.canvas),s=i.ctrlKey||void 0===i.ctrlKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.ctrlKey,l=i.shiftKey||void 0===i.shiftKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.shiftKey;if("Center"===f){if(i.intersection&&i.intersection.path&&i.intersection.path.length&&c.isAPOIPath(i.intersection.path[0])){const{position:e}=h.getPOIInformationFromPathElement(i.intersection.path[0]);if(e){const n=r.getViewerPositionFromPoint(i.viewer,e);n&&(a=new t.Vector2(n.left,n.top))}}n=r.get2DSnappedPosition(a).sub(w),l&&(Math.abs(n.y)>=Math.abs(n.x)?n.setX(0):n.setY(0))}else if("Rot"===f){var p=(new t.Vector2).subVectors(a,m),u=new t.Vector2(1,0).dot(p.clone().normalize());if(o=a.y<=m.y?Math.acos(u):2*Math.PI-Math.acos(u),P!==l){var d=Math.round(o/v)*v,M=new t.Vector2(Math.cos(d),-Math.sin(d));M.setLength(p.dot(M)),M.distanceTo(p)<B.ROTATION_SNAP_THRESHOLD?(o=d,B.displayAxis(R.position,o,p.length()+20)):B.removeAxis()}else B.removeAxis();o-=D+Math.PI/2}else if(n=r.get2DSnappedPosition(a,R.rotation).sub(w),R.rotation){var g=n.x*Math.cos(R.rotation)-n.y*Math.sin(R.rotation),b=n.x*Math.sin(R.rotation)+n.y*Math.cos(R.rotation);n.setX(g),n.setY(b)}e.onManipulateCB&&e.onManipulateCB({transVec2D:n,rotationAngle:o,handleType:f,ctrlKey:s,shiftKey:l})}}function z(i){if(i){var n;C.setNodePickable(s.INVISIBLE);for(var o=0;o<u.length;o++)if(u[o].uid===i.manipulator.getUID()){f=u[o].type,U.setStyle("cursor",u[o].cursor),n=(new t.Vector3).getPositionFromMatrix(u[o].handle.getMatrixWorld());break}var a=parseFloat(r.getSnapRotationInfos().snapRotationAngle);v=(isNaN(a)?90:a)*Math.PI/180,P=r.getSnapRotationInfos().snapRotationToggle,w=r.getViewerPositionFromPoint(S,n),w=new t.Vector2(w.left,w.top),"Center"===f?B.createHVAxis((new t.Vector3).getPositionFromMatrix(I.getMatrixWorld()),{key:"Shift",keyCode:16},F):"Rot"===f?B.addToListener("Shift",F):(B.addToListener("Shift",F),B.addToListener("Control",F)),B.activate(),e.onBeginManipulateCB&&e.onBeginManipulateCB({boundingBox:R,handleType:f})}}function O(t){t&&(U.setStyle("cursor",""),B.remove(),e.onManipulateCB&&e.onEndManipulateCB(),C.setNodePickable(s.PICKABLE),f=null)}function K(){var e=function(e){for(var t=0;t<e;t++){var i=V.pop();V.splice(2,0,i)}};V=k.slice();var i=Math.sin(R.rotation),n=Math.cos(R.rotation);n<Math.cos(7*Math.PI/8)?e(4):n<Math.cos(Math.PI/8)&&(n>Math.cos(3*Math.PI/8)?e(i<0?7:1):n<Math.cos(5*Math.PI/8)?e(i<0?5:3):e(i<0?6:2));var a=r.getMMPerPixelRatio(S,R.position),s=(new t.Matrix4).makeRotationZ(R.rotation);if(u&&u.length)for(var l=R.width/2,c=R.height/2,h=0;h<u.length;h++)switch(u[h].type){case"TL":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-l,c,0).applyMatrix4(s)));break;case"TR":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(l,c,0).applyMatrix4(s)));break;case"BL":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-l,-c,0).applyMatrix4(s)));break;case"BR":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(l,-c,0).applyMatrix4(s)));break;case"Rot":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,30*a+c,0).applyMatrix4(s))),u[h].handle.diskNode.setMatrix(s.clone().setPosition(new t.Vector3(-.5,-.5,0).applyMatrix4(s)));break;case"Top":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,c,0).applyMatrix4(s)));break;case"Right":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(l,0,0).applyMatrix4(s)));break;case"Bottom":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,-c,0).applyMatrix4(s)));break;case"Left":u[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-l,0,0).applyMatrix4(s)))}if(d){d.removeChildren();var p=R.height,g=R.width,f=o.createRectangleNode({width:g,height:p,fill:!1,material:M});f.excludeFromHighlight(!0,!0),d.addChild(f);var v=o.createLineNode({points:[new t.Vector3(g/2,p<0?0:p,0),new t.Vector3(g/2,30*a+p,0)],fill:!1,material:M});v.excludeFromHighlight(!0,!0),d.addChild(v);var P=(new t.Matrix4).makeRotationZ(R.rotation);d.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-g/2,-p/2,0).applyMatrix4(P)).multiply(P))}}function X(e){if(e)for(var t=0;t<u.length;t++)if(u[t].uid===e.manipulator.getUID()){U.setStyle("cursor",V[t]);break}}}})})),define("DS/DMUMarkerManipulators/DMUMarkerCircleManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/PointHandle","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPToolsMaterial","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/WebappsUtils/WebappsUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIServices/DMUObjectsServices","DS/Mesh/Mesh"],(function(e,t,i,n,o,a,r,s,l,c,h,p){"use strict";return e.extend({init:function(e){if(e&&e.dmuObj&&e.viewer){var u,d,M,g,f,v,P,w,m,b,y,x=e.viewer,D=e.dmuObj,V=D.getManipulationData(),S=D.getNode().getRepNode(),C=new s(x),R=C.getPointedElem(),I=l.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/");if(this.onBeginManipulateCB=function(e){e&&(v||(v={}),e.circleParams&&(v.radius=e.circleParams.radius),w=V.position,m=V.radius,y=r.getViewerPositionFromPoint(x,w),y=new t.Vector2(y.left,y.top))},this.onManipulateCB=function(e){e&&(e.handleType?function(e){if("Center"===e.handleType&&e.transVec2D){V.position=r.getNearPositionFrom2DCoordinates(y.clone().add(e.transVec2D),x,w);var t=r.getMMPerPixelRatio(x,w),i=r.getMMPerPixelRatio(x,V.position);V.radius=m*i/t}else"Radius"===e.handleType&&e.radius&&(V.radius=e.radius*m/v.radius)}(e):e.translationVector2D&&(V.position=r.getPositionFromIntersection(x,y.clone().add(e.translationVector2D),w)),D.updateRepresentation&&D.updateRepresentation(V,!1))},this.onEndManipulateCB=function(){H(),D.updateRepresentation&&D.updateRepresentation(V,!0)},!u){u=[];for(var B=0;B<2;B++){var U,T,k=new n({viewer:x,sceneGraph:S});switch(k.subscribe("BeginManipulate",N),k.subscribe("Manipulate",E),k.subscribe("EndManipulate",A),k.subscribe("EndPreactivate",(function(){R.setStyle("cursor","")})),k.setCursor(!1),k.diskNode.setNoHighlightNoZ(!0),k.manipulator.setPreActivationDuringManipulation(!1),B){case 0:U="Center",T="move",k.subscribe("BeginPreactivate",(function(){R.setStyle("cursor","url("+I+"DMUPositionCursorHL.png) 10 10, auto")}));break;case 1:U="Radius",T="crosshair",k.subscribe("BeginPreactivate",L)}0!==B&&k.manipulator.setPrePickingDuringManipulation(!1),u.push({uid:k.manipulator.getUID(),type:U,handle:k,cursor:T})}(d=new i).setPickable(p.PICKTHROUGH),d.setNoHighlightNoZ(!0),S.addChild(d),M||(M=a.createLineMaterial({color:new t.Color(11843258),opacity:1,lineWidth:window.devicePixelRatio,pattern:"6"})),H()}this.setHandlesVisibility=function(e){if(u&&u.length){for(var t=0;t<u.length;t++)u[t].handle.setVisibility(e);d&&d.setVisibility(e)}},this.remove=function(){u&&u.length&&u.forEach((function(e){e.handle.dispose()})),u=null,d&&(d.removeChildren(),S.removeChild(d)),C&&C.remove(),M&&M.dispose(),C=d=M=S=v=D=f=g=null}}function E(i){if(i&&C.isCanvasToDraw(i.event.from[0].getView())){var n,o,a;if(C.updateManipulationData(i),"Center"===g){let e;if(i.intersection&&i.intersection.path&&i.intersection.path.length&&c.isAPOIPath(i.intersection.path[0])){const{position:n}=h.getPOIInformationFromPathElement(i.intersection.path[0]);if(n){const o=r.getViewerPositionFromPoint(i.viewer,n);o&&(e=new t.Vector2(o.left,o.top))}}e||(e=i.event.from[0].getCurrentPosition(i.viewer.canvas));var s=i.shiftKey||void 0===i.shiftKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.shiftKey;n=r.get2DSnappedPosition(e).sub(b),s&&(Math.abs(n.y)>=Math.abs(n.x)?n.setX(0):n.setY(0))}else"Radius"===g&&(o=r.getPositionFromIntersection(x,i.intersection.position,w,!0),a=w.clone().sub(o).length());e.onManipulateCB&&e.onManipulateCB({transVec2D:n,radius:a,handleType:g})}}function N(i){if(i){var n;D.setNodePickable(p.INVISIBLE);for(var o=0;o<u.length;o++)if(u[o].uid===i.manipulator.getUID()){g=u[o].type,R.setStyle("cursor",u[o].cursor),n=(new t.Vector3).getPositionFromMatrix(u[o].handle.getMatrixWorld());break}b=r.getViewerPositionFromPoint(x,n),b=new t.Vector2(b.left,b.top),"Center"===g&&(C.createHVAxis(n,{key:"Shift",keyCode:16},E),C.activate()),e.onBeginManipulateCB&&e.onBeginManipulateCB({circleParams:V,handleType:g})}}function A(t){t&&(R.setStyle("cursor",""),"Center"===g&&C.remove(),D.setNodePickable(p.PICKABLE),g=null,e.onEndManipulateCB&&e.onEndManipulateCB())}function H(){var e=x.currentViewpoint.project(V.position);e=new t.Vector2(e.x,e.y);var i=Math.PI;if(f){var n=x.currentViewpoint.project(f);n=new t.Vector2(n.x,n.y);var a=e.sub(n);(i=Math.atan2(a.y,a.x))<0&&(i+=2*Math.PI)}var r=(new t.Matrix4).makeRotationZ(Math.PI-i).multiply((new t.Matrix4).makeTranslation(V.radius,0,0));if(P=i>Math.PI/8&&i<=3*Math.PI/8||i>9*Math.PI/8&&i<=11*Math.PI/8?"nwse-resize":i>3*Math.PI/8&&i<=5*Math.PI/8||i>11*Math.PI/8&&i<=13*Math.PI/8?"ns-resize":i>5*Math.PI/8&&i<=7*Math.PI/8||i>13*Math.PI/8&&i<=15*Math.PI/8?"nesw-resize":"ew-resize",u&&u.length&&(u.forEach((function(e){"Radius"===e.type&&e.handle.setMatrix(r)})),d)){d.removeChildren();var s=o.createLineNode({points:[new t.Vector3,(new t.Vector3).getPositionFromMatrix(r)],material:M});s.excludeFromHighlight(!0,!0),d.addChild(s)}}function L(){R.setStyle("cursor",P)}}})})),define("DS/DMUMarkerManipulators/DMUMarkerArrowManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Manipulators/PointHandle","DS/DMUBaseExperience/EXPToolsVisualization","DS/Mesh/Mesh","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseUIManipulators/DMUManipulatorsHelper"],(function(e,t,i,n,o,a,r,s){"use strict";return e.extend({init:function(e){if(e&&e.dmuObj&&e.viewer){var l,c,h,p,u,d,M,g,f,v,P,w,m,b=e.dmuObj,y=b.getManipulationData(),x=e.viewer,D=new s(x),V=D.getPointedElem();if(this.onBeginManipulateCB=function(e){e&&(P=y.pointingPoint,v=y.endingPoint,w=n.getViewerPositionFromPoint(x,P),w=new t.Vector2(w.left,w.top),m=n.getViewerPositionFromPoint(x,v),m=new t.Vector2(m.left,m.top))},this.onManipulateCB=function(e){e&&(e.translationVector2D?(y.pointingPoint=n.getPositionFromIntersection(x,w.clone().add(e.translationVector2D),P),y.endingPoint=n.getPositionFromIntersection(x,m.clone().add(e.translationVector2D),v)):e.handleType&&"Center"===e.handleType&&e.transVec2D&&(y.pointingPoint=n.getPositionFromIntersection(x,w.clone().add(e.transVec2D),P),y.endingPoint=n.getPositionFromIntersection(x,m.clone().add(e.transVec2D),v)),b.updateRepresentation&&b.updateRepresentation(y,!1))},this.onEndManipulateCB=function(){b.updateRepresentation&&b.updateRepresentation(y,!0)},!l){l=[];for(var S=0;S<3;S++){var C,R=new i({viewer:x,sceneGraph:b.getNode().getRepNode()});switch(R.subscribe("BeginManipulate",U),R.subscribe("Manipulate",B),R.subscribe("EndPreactivate",(function(){V.setStyle("cursor","")})),R.subscribe("BeginPreactivate",(function(){V.setStyle("cursor","move")})),R.setCursor(!1),R.subscribe("EndManipulate",T),R.diskNode.setNoHighlightNoZ(!0),R.manipulator.setPreActivationDuringManipulation(!1),2===S&&R.manipulator.setPrePickingDuringManipulation(!1),S){case 0:C="Pointing";break;case 1:C="Ending";break;case 2:C="Shaft"}l.push({uid:R.manipulator.getUID(),type:C,handle:R})}I()}this.setHandlesVisibility=function(e){if(l&&l.length)for(var t=0;t<l.length;t++)l[t].handle.setVisibility(e)},this.remove=function(){l&&l.length&&l.forEach((function(e){e.handle.dispose()})),D&&D.remove(),D=l=c=v=P=h=p=null,u=d=M=g=f=null}}function I(){if(l&&l.length){var e=y.endingPoint.clone().sub(y.pointingPoint);l.forEach((function(i){switch(i.type){case"Ending":i.handle.setMatrix((new t.Matrix4).makeTranslation(0,0,e.length()));break;case"Shaft":i.handle.setMatrix((new t.Matrix4).makeTranslation(y.width/2,0,e.length()*(1-y.shaftRatio)))}}))}}function B(i){i&&D.isCanvasToDraw(i.event.from[0].getView())&&(D.updateManipulationData(i),function(e){if(e&&e.intersection){var i,o=e.intersection;if(o.position&&o.path.length){if(a.isAPOIPath(o.path[0])){const{position:e}=r.getPOIInformationFromPathElement(o.path[0]);e&&(i=e)}i||(i=n.getPositionFromIntersection(x,o.position,o.position,!0))}else i=n.getPositionFromIntersection(x,o.position,y.pointingPoint,!0);var s,l,v,P,w,m=e.event.from[0].getCurrentPosition(x.canvas),V=e.shiftKey||void 0===e.shiftKey&&e.event.from&&e.event.from.length&&e.event.from[0].event&&e.event.from[0].event.shiftKey;switch(c){case"Pointing":var S=n.getViewerPositionFromPoint(x,y.endingPoint);if(S=new t.Vector2(S.left,S.top),l=(new t.Vector2).subVectors(m,S),v=new t.Vector2(1,0).dot(l.clone().normalize()),s=m.y<=S.y?Math.acos(v):2*Math.PI-Math.acos(v),p!==V)if(P=Math.round(s/h)*h,(w=new t.Vector2(Math.cos(P),-Math.sin(P))).setLength(l.dot(w)),w.distanceTo(l)<D.ROTATION_SNAP_THRESHOLD){w.normalize();var C=(new t.Vector2).subVectors(n.get2DSnappedPosition(m,P),S);w.setLength(C.dot(w)),y.pointingPoint=n.getPositionFromIntersection(x,S.clone().add(w),y.endingPoint),D.displayAxis(y.endingPoint,P,C.length()+20)}else y.pointingPoint=i,D.removeAxis();else y.pointingPoint=i,D.removeAxis();break;case"Ending":var R=n.getViewerPositionFromPoint(x,y.pointingPoint);if(R=new t.Vector2(R.left,R.top),l=(new t.Vector2).subVectors(m,R),v=new t.Vector2(1,0).dot(l.clone().normalize()),s=m.y<=R.y?Math.acos(v):2*Math.PI-Math.acos(v),p!==V)if(P=Math.round(s/h)*h,(w=new t.Vector2(Math.cos(P),-Math.sin(P))).setLength(l.dot(w)),w.distanceTo(l)<D.ROTATION_SNAP_THRESHOLD){w.normalize();var I=(new t.Vector2).subVectors(n.get2DSnappedPosition(m,P),R);w.setLength(I.dot(w)),y.endingPoint=n.getPositionFromIntersection(x,R.add(w),y.pointingPoint),D.displayAxis(y.pointingPoint,P,I.length()+20)}else y.endingPoint=i,D.removeAxis();else y.endingPoint=i,D.removeAxis();break;case"Shaft":var B=(new t.Vector2).copy(e.event.from[0].getCurrentPosition(x.canvas)),U=e.event.viewer.currentViewpoint.create3DRayFrom2DPoint(B),T=U.computeShortestPointToLine(u,d),k=U.computeShortestPointToLine(u,M),E=y.endingPoint.clone().sub(y.pointingPoint),N=(new t.Vector3).subVectors(T,g);y.width=2*N.length();var A=(new t.Vector3).subVectors(k,f).length()/E.length();("beginSide"===b.getAttribute("sStyle")&&A<=.9&&A>=.1||"bothSide"===b.getAttribute("sStyle")&&A<=.9&&A>=.55)&&(y.shaftRatio=A)}}}(i),b.updateRepresentation&&b.updateRepresentation(y,!1),e.onManipulateCB&&e.onManipulateCB())}function U(t){if(t){b.setNodePickable(o.INVISIBLE);for(var i=0;i<l.length;i++)if(l[i].uid===t.manipulator.getUID()){c=l[i].type;break}if("Shaft"===c){u=t.intersection.position;var a=y.endingPoint.clone().sub(y.pointingPoint),r=x.currentViewpoint.getSightDirection().clone().cross(a);d=u.clone().add(r),M=u.clone().add(a),g=a.clone().normalize().multiplyScalar((1-y.shaftRatio)*a.length()).add(y.pointingPoint),f=r.clone().normalize().multiplyScalar(y.width/2).add(y.endingPoint)}var s=parseFloat(n.getSnapRotationInfos().snapRotationAngle);h=(isNaN(s)?90:s)*Math.PI/180,p=n.getSnapRotationInfos().snapRotationToggle,D.addToListener("Shift",B),D.activate(),V.setStyle("cursor","crosshair"),e.onBeginManipulateCB&&e.onBeginManipulateCB()}}function T(){V.setStyle("cursor",""),I(),D.remove(),b.setNodePickable(o.PICKABLE),c=null,e.onEndManipulateCB&&e.onEndManipulateCB()}}})})),define("DS/DMUMarkerManipulators/DMUMarkerFreehandManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/PointHandle","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPToolsMaterial","DS/DMUBaseExperience/EXPToolsVisualization","DS/Mesh/Mesh","DS/WebappsUtils/WebappsUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/SceneGraphNodes/BillBoardNode3D"],(function(e,t,i,n,o,a,r,s,l,c,h,p,u){"use strict";return e.extend({init:function(e){if(!e||!e.dmuObj||!e.viewer)return;let d=this;var M=e.viewer,g=[e.dmuObj],f=g[0].getManipulationData();let v=[g[0].getManipulationData()];var P,w,m,b,y,x,D,V,S,C,R,I,B,U,T=new p(M),k=T.getPointedElem(),E=l.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/"),N=new u({type:"Spherical"});M.getRootNode().getChildByName("DecorationBag").addChild(N);var A,H=["url("+E+"DMUPositionCursorHL.png) 10 10, auto","url("+E+"DMURotationCursorHL.png) 16 16, auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];function L(i){if(i&&T.isCanvasToDraw(i.event.from[0].getView())){T.updateManipulationData(i);var n,o,a=i.event.from[0].getCurrentPosition(i.viewer.canvas),s=i.ctrlKey||void 0===i.ctrlKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.ctrlKey,l=i.shiftKey||void 0===i.shiftKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.shiftKey;if("Center"===y){if(i.intersection&&i.intersection.path&&i.intersection.path.length&&c.isAPOIPath(i.intersection.path[0])){const{position:e}=h.getPOIInformationFromPathElement(i.intersection.path[0]);if(e){const n=r.getViewerPositionFromPoint(i.viewer,e);n&&(a=new t.Vector2(n.left,n.top))}}n=r.get2DSnappedPosition(a).sub(V),l&&(Math.abs(n.y)>=Math.abs(n.x)?n.setX(0):n.setY(0))}else if("Rot"===y){var p=(new t.Vector2).subVectors(a,U),u=new t.Vector2(1,0).dot(p.clone().normalize());if(o=a.y<=U.y?Math.acos(u):2*Math.PI-Math.acos(u),D!==l){var d=Math.round(o/x)*x,M=new t.Vector2(Math.cos(d),-Math.sin(d));M.setLength(p.dot(M)),M.distanceTo(p)<T.ROTATION_SNAP_THRESHOLD?(o=d,T.displayAxis(f.position,o,p.length()+20)):T.removeAxis()}else T.removeAxis();o-=f.rotation+Math.PI/2}else if(n=r.get2DSnappedPosition(a,f.rotation).sub(V),f.rotation){var g=n.x*Math.cos(f.rotation)-n.y*Math.sin(f.rotation),v=n.x*Math.sin(f.rotation)+n.y*Math.cos(f.rotation);n.setX(g),n.setY(v)}e.onManipulateCB&&e.onManipulateCB({transVec2D:n,rotationAngle:o,handleType:y,ctrlKey:s,shiftKey:l})}}function F(i){if(i){var n;g.forEach((e=>e.setNodePickable(s.INVISIBLE)));for(var o=0;o<P.length;o++)if(P[o].uid===i.manipulator.getUID()){y=P[o].type,k.setStyle("cursor",P[o].cursor),n=(new t.Vector3).getPositionFromMatrix(P[o].handle.getMatrixWorld());break}var a=parseFloat(r.getSnapRotationInfos().snapRotationAngle);x=(isNaN(a)?90:a)*Math.PI/180,D=r.getSnapRotationInfos().snapRotationToggle,V=r.getViewerPositionFromPoint(M,n),V=new t.Vector2(V.left,V.top),U=r.getViewerPositionFromPoint(M,f.position),U=new t.Vector2(U.left,U.top),"Center"===y?T.createHVAxis(f.position,{key:"Shift",keyCode:16},L):"Rot"===y?T.addToListener("Shift",L):(T.addToListener("Shift",L),T.addToListener("Control",L)),T.activate(),e.onBeginManipulateCB&&e.onBeginManipulateCB({boundingBox:f,handleType:y})}}function z(t){t&&(k.setStyle("cursor",""),T.remove(),e.onManipulateCB&&e.onEndManipulateCB({handleType:y}),g.forEach((e=>e.setNodePickable(s.PICKABLE))),y=null)}function O(){var e=function(e){for(var t=0;t<e;t++){var i=A.pop();A.splice(2,0,i)}};A=H.slice();var i=Math.sin(f.rotation),n=Math.cos(f.rotation);n<Math.cos(7*Math.PI/8)?e(4):n<Math.cos(Math.PI/8)&&(n>Math.cos(3*Math.PI/8)?e(i<0?7:1):n<Math.cos(5*Math.PI/8)?e(i<0?5:3):e(i<0?6:2));var a=r.getMMPerPixelRatio(M,f.position),s=(new t.Matrix4).makeRotationZ(f.rotation);if(P&&P.length){var l=f.width/2,c=f.height/2;const e=new t.Vector3,i=M.currentViewpoint.getUpDirection(),n=(new t.Vector3).crossVectors(M.currentViewpoint.getSightDirection(),i);let r=e.dot(n),d=e.dot(i);e.setX(r),e.setY(d),e.setZ(0);for(var h=0;h<P.length;h++)switch(P[h].type){case"Center":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,0,0).applyMatrix4(s).sub(e)));break;case"TL":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-l,c,0).applyMatrix4(s).sub(e)));break;case"TR":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(l,c,0).applyMatrix4(s).sub(e)));break;case"BL":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-l,-c,0).applyMatrix4(s).sub(e)));break;case"BR":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(l,-c,0).applyMatrix4(s).sub(e)));break;case"Rot":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,30*a+c,0).applyMatrix4(s).sub(e))),P[h].handle.diskNode.setMatrix(s.clone().setPosition(new t.Vector3(-.5,-.5,0).applyMatrix4(s)));break;case"Top":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,c,0).applyMatrix4(s).sub(e)));break;case"Right":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(l,0,0).applyMatrix4(s).sub(e)));break;case"Bottom":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,-c,0).applyMatrix4(s).sub(e)));break;case"Left":P[h].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-l,0,0).applyMatrix4(s).sub(e)))}if(w){w.removeChildren();var p=f.height,u=f.width,g=o.createRectangleNode({width:u,height:p,fill:!1,material:m});g.excludeFromHighlight(!0,!0),w.addChild(g);var v=o.createLineNode({points:[new t.Vector3(u/2,p<0?0:p,0),new t.Vector3(u/2,30*a+p,0)],fill:!1,material:m});v.excludeFromHighlight(!0,!0),w.addChild(v);var b=(new t.Matrix4).makeRotationZ(f.rotation);w.setMatrix(b.setPosition(new t.Vector3(-u/2,-p/2,0).applyMatrix4(b).sub(e)))}N.setMatrix(N.getMatrix().setPosition(f.position))}0===f.width?d.setHandlesVisibility(!1):d.setHandlesVisibility(!0)}function K(){if(!g.length)return;let e,i,n=-1/0,o=1/0,a=-1/0,s=1/0;g.forEach(((l,c)=>{const h=l.getManipulationData();if(h){const l=r.getMMPerPixelRatio(M,h.position);0===c&&(f.rotation=h.rotation,e=l,i=r.getViewerPositionFromPoint(M,h.position));const p=h.width/l,u=h.height/l,d=r.getViewerPositionFromPoint(M,h.position),g=new t.Vector2(d.left-i.left,d.top-i.top),v=g.x*Math.cos(f.rotation)-g.y*Math.sin(f.rotation),P=g.x*Math.sin(f.rotation)+g.y*Math.cos(f.rotation);g.setX(v),g.setY(P);const w=h.rotation-f.rotation,m=new t.Vector2(Math.cos(w),-Math.sin(w)),b=new t.Vector2(Math.sin(w),Math.cos(w)),y=Math.max(Math.abs(p*Math.cos(w)-u*Math.sin(w)),Math.abs(p*Math.cos(-w)-u*Math.sin(-w))),x=Math.max(Math.abs(p*Math.sin(w)+u*Math.cos(w)),Math.abs(p*Math.sin(-w)+u*Math.cos(-w)));n=Math.max(n,g.dot(m)+y/2),o=Math.min(o,g.dot(m)-y/2),a=Math.max(a,g.dot(b)+x/2),s=Math.min(s,g.dot(b)-x/2),n=Math.max(n,g.dot(m)+y/2),o=Math.min(o,g.dot(m)-y/2),a=Math.max(a,g.dot(b)+x/2),s=Math.min(s,g.dot(b)-x/2)}}));const l=new t.Vector2(o,s),c=new t.Vector2(n,a),h=new t.Vector2((c.x+l.x)/2,(c.y+l.y)/2),p=h.x*Math.cos(-f.rotation)-h.y*Math.sin(-f.rotation),u=h.x*Math.sin(-f.rotation)+h.y*Math.cos(-f.rotation);h.setX(p),h.setY(u);const d=new t.Vector2(h.x+i.left,h.y+i.top);f.position=r.getPositionFromIntersection(M,d,g[0].getManipulationData().position),f.width=(n-o)*e,f.height=(a-s)*e,O()}function X(e){if(e)for(var t=0;t<P.length;t++)if(P[t].uid===e.manipulator.getUID()){k.setStyle("cursor",A[t]);break}}if(this.setHandlesVisibility=function(e){if(P&&P.length)for(var t=0;t<P.length;t++)P[t].handle.setVisibility(e);w&&w.setVisibility(e)},this.onBeginManipulateCB=function(e){e&&(b||(b={}),e.boundingBox&&(b.height=e.boundingBox.height,b.width=e.boundingBox.width,b.position=e.boundingBox.position),I=[],R=[],B=[],C=[],S=[],U||(U=r.getViewerPositionFromPoint(M,f.position),U=new t.Vector2(U.left,U.top)),g.forEach((e=>{const i=e.getManipulationData();I.push(i.width),R.push(i.height),B.push(i.rotation),C.push(i.position);const n=r.getViewerPositionFromPoint(M,i.position);S.push(new t.Vector2(n.left,n.top))})))},this.onManipulateCB=function(e){e&&(e.handleType&&"Vertex"!==e.handleType?function(e){if(e)if(void 0!==e.rotationAngle&&"Rot"===e.handleType)v.forEach(((t,i)=>{const n=S[i].clone().sub(U),o=-1*e.rotationAngle,a=n.x*Math.cos(o)-n.y*Math.sin(o),s=n.x*Math.sin(o)+n.y*Math.cos(o);n.setX(a),n.setY(s),t.rotation=B[i]+e.rotationAngle,t.position=r.getPositionFromIntersection(M,U.clone().add(n),C[i])}));else if(e.transVec2D)if("Center"===e.handleType)v.forEach(((t,i)=>{t.position=r.getPositionFromIntersection(M,S[i].clone().add(e.transVec2D),C[i]);var n=r.getMMPerPixelRatio(M,C[i]),o=r.getMMPerPixelRatio(M,t.position);t.width=I[i]*o/n,t.height=R[i]*o/n}));else{var i=e.transVec2D.clone();let p=r.getMMPerPixelRatio(M,f.position),u=r.getMMPerPixelRatio(M,b.position),d=f.width/p/(b.width/u),g=f.height/p/(b.height/u);var n,o,a,s;i.setX(i.x*d),i.setY(i.y*g),p*=e.ctrlKey?2:1;const P=new t.Vector2(0,0),w=new t.Vector2(0,0);switch(e.handleType){case"TL":o=f.width-i.x*p,a=f.height-i.y*p,s=new t.Vector3(-1,-1),n=!0,P.setX(f.width/2/p),P.setY(f.height/2/p),w.setX(-f.width/2/p),w.setY(-f.height/2/p);break;case"TR":o=f.width+i.x*p,a=f.height-i.y*p,s=new t.Vector3(-1,1),n=!0,P.setX(-f.width/2/p),P.setY(f.height/2/p),w.setX(f.width/2/p),w.setY(-f.height/2/p);break;case"BL":o=f.width-i.x*p,a=f.height+i.y*p,s=new t.Vector3(1,-1),n=!0,P.setX(f.width/2/p),P.setY(-f.height/2/p),w.setX(-f.width/2/p),w.setY(f.height/2/p);break;case"BR":o=f.width+i.x*p,a=f.height+i.y*p,s=new t.Vector3(1,1),n=!0,P.setX(-f.width/2/p),P.setY(-f.height/2/p),w.setX(f.width/2/p),w.setY(f.height/2/p);break;case"Top":a=f.height-i.y*p,i.setX(0),P.setY(f.height/2/p),w.setY(-f.height/2/p);break;case"Right":o=f.width+i.x*p,i.setY(0),P.setX(-f.width/2/p),w.setX(f.width/2/p);break;case"Bottom":a=f.height+i.y*p,i.setX(0),P.setY(-f.height/2/p),w.setY(f.height/2/p);break;case"Left":o=f.width-i.x*p,i.setY(0),P.setX(f.width/2/p),w.setX(-f.width/2/p)}e.ctrlKey&&(P.setX(0),P.setY(0));var l=Math.abs(o/f.width);let m=Math.abs(a/f.height),y=Math.max(l,m);const x=f.rotation;if(e.shiftKey&&n){let e=f.width*y,n=f.height*y;var c=new t.Vector2(Math.sin(x),Math.cos(x)).multiplyScalar(s.x*(n*Math.sign(a)-f.height)/p),h=new t.Vector2(Math.cos(x),-Math.sin(x)).multiplyScalar(s.y*(e*Math.sign(o)-f.width)/p);i=c.add(h)}else if(!e.ctrlKey&&x){let e=i.x*Math.cos(-x)-i.y*Math.sin(-x),t=i.x*Math.sin(-x)+i.y*Math.cos(-x);i.setX(e),i.setY(t)}let D=P.x*Math.cos(-x)-P.y*Math.sin(-x),V=P.x*Math.sin(-x)+P.y*Math.cos(-x);P.setX(D),P.setY(V),D=w.x*Math.cos(-x)-w.y*Math.sin(-x),V=w.x*Math.sin(-x)+w.y*Math.cos(-x),w.setX(D),w.setY(V),v.forEach(((o,a)=>{e.shiftKey&&n?(o.width=I[a]*y,o.height=R[a]*y):(o.width=l?I[a]*l:o.width,o.height=m?R[a]*m:o.height);const s=S[a].clone().sub(P.clone().add(U)),c=new t.Vector2(s.x/(f.width/p),s.y/(f.height/p)),h=new t.Vector2(i.x*c.x*Math.sign(w.x),i.y*c.y*Math.sign(w.y));o.position=r.getPositionFromIntersection(M,S[a].clone().add(h),C[a])}))}}(e):e.translationVector2D&&v.forEach(((t,i)=>{t.position=r.getPositionFromIntersection(M,S[i].clone().add(e.translationVector2D),C[i])})),g.forEach(((e,t)=>{e.updateRepresentation&&e.updateRepresentation(v[t],!1)})))},this.onEndManipulateCB=function(){g.forEach(((e,t)=>{e.updateRepresentation&&e.updateRepresentation(v[t],!0)})),O(),K()},!P){P=[];for(var W=0;W<10;W++){var Y=20;1===W&&(Y=24);var G,Z,j=new n({viewer:M,sceneGraph:N,size:Y});switch(j.subscribe("BeginManipulate",F),j.subscribe("Manipulate",L),j.subscribe("EndManipulate",z),j.subscribe("BeginPreactivate",X),j.subscribe("EndPreactivate",(function(){k.setStyle("cursor","")})),j.setCursor(!1),j.diskNode.setNoHighlightNoZ(!0),j.manipulator.setPreActivationDuringManipulation(!1),W){case 0:G="Center",Z="move";break;case 1:G="Rot",Z="url("+E+"DMURotationCursorSel.png) 16 16, auto";break;case 2:G="TL",Z="crosshair";break;case 3:G="Top",Z="crosshair";break;case 4:G="TR",Z="crosshair";break;case 5:G="Right",Z="crosshair";break;case 6:G="BR",Z="crosshair";break;case 7:G="Bottom",Z="crosshair";break;case 8:G="BL",Z="crosshair";break;case 9:G="Left",Z="crosshair"}0!==W&&(j.manipulator.setPrePickingDuringManipulation(!1),j.manipulator.setPickingDuringManipulation(!1)),1===W&&(j.pointMat.map=new t.ImageUtils.loadTexture(E+"DMURotationManip.png",void 0,null,null,t.ImageUtils.crossOriginPolicy)),P.push({uid:j.manipulator.getUID(),type:G,handle:j,cursor:Z})}w||((w=new i).setPickable(s.PICKTHROUGH),w.setNoHighlightNoZ(!0),m||(m=a.createLineMaterial({color:new t.Color(11843258),opacity:1,lineWidth:window.devicePixelRatio,pattern:"6"})),N.addChild(w)),O()}this.registerMarker=function(e){g.push(e),v.push(e.getManipulationData()),K()},this.registeredMarkersLength=function(){return g.length},this.unregisterMarker=function(e){var t=g.indexOf(e);-1!==t&&(g.splice(t,1),v.splice(t,1),K())},this.remove=function(){P&&P.length&&P.forEach((function(e){e.handle.dispose()})),P=null,w&&(w.removeChildren(),N.removeChild(w)),T&&T.remove(),m&&m.dispose(),N.remove(),w=N=b=g=y=m=f=M=null,T=null}}})})),define("DS/DMUMarkerManipulators/DMUMarkerCloudManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/PointHandle","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPToolsMaterial","DS/DMUBaseExperience/EXPToolsVisualization","DS/Mesh/Mesh","DS/WebappsUtils/WebappsUtils","DS/DMUBaseUIManipulators/DMUManipulatorsHelper"],(function(e,t,i,n,o,a,r,s,l,c){"use strict";return e.extend({init:function(e){if(!e||!e.dmuObj||!e.viewer)return;var h=e.viewer,p=e.dmuObj,u=p.getManipulationData(),d=u.points.slice();let M=u.boundingBoxDimensions;var g,f,v,P,w,m,b,y,x,D,V,S,C,R=p.getNode().getRepNode(),I=new c(h),B=I.getPointedElem(),U=l.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/");function T(){let e=(new t.Matrix4).makeRotationZ(M.rotation),i=r.getMMPerPixelRatio(h,M.position);for(let o=0;o<g.length;o++)if("Vertex"===g[o].type&&g[o].handle.setMatrix((new t.Matrix4).setPosition(d[o].clone().applyMatrix4(e))),"Rot"===g[o].type){var n=M.height/2;g[o].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(0,30*i+n,0).applyMatrix4(e))),g[o].handle.diskNode.setMatrix(e.clone().setPosition(new t.Vector3(-.5,-.5,0).applyMatrix4(e)))}if(f){f.removeChildren();var s=M.width,l=M.height,c=o.createRectangleNode({width:s,height:l,fill:!1,material:v});c.excludeFromHighlight(!0,!0),f.addChild(c);var p=new t.Vector3(s/2,l/2,0),u=a.retrieveMaterialFromGAS({size:10,withoutDPR:!0,scale:1,symbol:1,color:new t.Color(11843258)});u.force=!0;var P=o.createPointsNode({positions:p.toArray(),material:u});P.excludeFromHighlight(!0,!0),f.addChild(P);var w=o.createLineNode({points:[new t.Vector3(s/2,l<0?0:l,0),new t.Vector3(s/2,30*i+l,0)],fill:!1,material:v});w.excludeFromHighlight(!0,!0),f.addChild(w);var m=(new t.Matrix4).makeRotationZ(M.rotation);f.setMatrix((new t.Matrix4).setPosition(new t.Vector3(-s/2,-l/2,0).applyMatrix4(m)).multiply(m))}}function k(i){if(!i||!I.isCanvasToDraw(i.event.from[0].getView()))return;I.updateManipulationData(i);let n,o,a=i.event.from[0].getCurrentPosition(i.viewer.canvas);var s=i.shiftKey||void 0===i.shiftKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.shiftKey;if("Rot"===P){var l=(new t.Vector2).subVectors(a,y),c=new t.Vector2(1,0).dot(l.clone().normalize());if(o=a.y<=y.y?Math.acos(c):2*Math.PI-Math.acos(c),m!==s){var h=Math.round(o/w)*w,p=new t.Vector2(Math.cos(h),-Math.sin(h));p.setLength(l.dot(p)),p.distanceTo(l)<I.ROTATION_SNAP_THRESHOLD?(o=h,I.displayAxis(M.position,o,l.length()+20)):I.removeAxis()}else I.removeAxis();o-=D+Math.PI/2}else if("Vertex"===P){if(n=r.get2DSnappedPosition(a,M.rotation).sub(b),s&&(Math.abs(n.y)>=Math.abs(n.x)?n.setX(0):n.setY(0)),C[V]=new t.Vector2(b.x+n.x,b.y+n.y),M.rotation){var u=n.x*Math.cos(M.rotation)-n.y*Math.sin(M.rotation),d=n.x*Math.sin(M.rotation)+n.y*Math.cos(M.rotation);n.setX(u),n.setY(d)}}e.onManipulateCB&&e.onManipulateCB({transVec2D:n,rotationAngle:o,handleType:P,shiftKey:s})}function E(i){if(i){var n;p.setNodePickable(s.INVISIBLE);for(var o=0;o<=g.length;o++)if(g[o].uid===i.manipulator.getUID()){V=g[o].handleNb,P=g[o].type,B.setStyle("cursor",g[o].cursor),n=(new t.Vector3).getPositionFromMatrix(g[o].handle.getMatrixWorld());break}var a=parseFloat(r.getSnapRotationInfos().snapRotationAngle);w=(isNaN(a)?90:a)*Math.PI/180,m=r.getSnapRotationInfos().snapRotationToggle,b=r.getViewerPositionFromPoint(h,n),b=new t.Vector2(b.left,b.top),"Vertex"===P&&I.createHVAxis(n,{key:"Shift",keyCode:16},k),I.addToListener("Shift",k),I.activate(),e.onBeginManipulateCB&&e.onBeginManipulateCB({boundingBox:M,handleType:P})}}function N(t){t&&(B.setStyle("cursor",""),I.remove(),e.onManipulateCB&&e.onEndManipulateCB(),p.setNodePickable(s.PICKABLE),P=null,V=null)}function A(e){if(e)if(void 0!==e.rotationAngle&&"Rot"===e.handleType)M.rotation=D+e.rotationAngle;else if(e.transVec2D){let o=function(e){if(e&&e.length){let i=-1/0,n=1/0,o=-1/0,a=1/0,r=new t.Vector2(Math.cos(M.rotation),-Math.sin(M.rotation)),s=new t.Vector2(Math.sin(M.rotation),Math.cos(M.rotation));e.forEach((function(e){i=Math.max(i,e.dot(r)),n=Math.min(n,e.dot(r)),o=Math.max(o,e.dot(s)),a=Math.min(a,e.dot(s))}));let l=new t.Vector3(n,a),c=new t.Vector3(i,o),h=(new t.Vector2).addVectors(l,c).multiplyScalar(.5);const p=(new t.Matrix3).set(r.x,s.x,0,r.y,s.y,0,0,0,1);return h.applyMatrix3=function(e){const{x:t,y:i}=this;return this.x=e.elements[0]*t+e.elements[3]*i+e.elements[6],this.y=e.elements[1]*t+e.elements[4]*i+e.elements[7],this},h.applyMatrix3(p),{boxPosition:h,boxHeight:o-a,boxWidth:i-n}}}(C);if(o){const a=(new t.Vector2).subVectors(o.boxPosition,y);let s=r.getMMPerPixelRatio(h,x);if(M.position=r.getPositionFromIntersection(h,y.clone().add(a),x,!0),M.width=o.boxWidth*s,M.height=o.boxHeight*s,M.rotation){var i=a.x*Math.cos(M.rotation)-a.y*Math.sin(M.rotation),n=a.x*Math.sin(M.rotation)+a.y*Math.cos(M.rotation);a.setX(i),a.setY(n)}d=S.map(((i,n)=>n===V?new t.Vector3(i.x-(a.x-e.transVec2D.x)*s,i.y+(a.y-e.transVec2D.y)*s,0):new t.Vector3(i.x-a.x*s,i.y+a.y*s,0)))}}}function H(e){if(e)for(var t=0;t<g.length;t++){if(g[t].uid===e.manipulator.getUID()&&"Vertex"===g[t].type){B.setStyle("cursor","move");break}if(g[t].uid===e.manipulator.getUID()&&"Rot"===g[t].type){B.setStyle("cursor","url("+U+"DMURotationCursorHL.png) 16 16, auto");break}}}if(this.onBeginManipulateCB=function(e){if(e){if(S=d.slice(),"Vertex"===P){C=[];for(let e=0;e<d.length;e++){var i=(new t.Vector3).getPositionFromMatrix(g[e].handle.getMatrixWorld());let n=r.getViewerPositionFromPoint(h,i);n=new t.Vector2(n.left,n.top),C.push(n)}}D=M.rotation,x=M.position,y=r.getViewerPositionFromPoint(h,x),y=new t.Vector2(y.left,y.top)}},this.onManipulateCB=function(e){e&&(!e.handleType||"Vertex"!==e.handleType&&"Rot"!==e.handleType?e.translationVector2D&&(M.position=r.getPositionFromIntersection(h,y.clone().add(e.translationVector2D),x)):A(e),p.updateRepresentation&&p.updateRepresentation({points:d,boundingBoxDimensions:M},!1))},this.onEndManipulateCB=function(){S&&T(),p.updateRepresentation&&p.updateRepresentation({points:d,boundingBoxDimensions:M},!0)},!g&&d&&d.length){var L,F;g=[];for(var z=0;z<=d.length;z++){var O=new n({viewer:h,sceneGraph:R});O.subscribe("BeginManipulate",E),O.subscribe("Manipulate",k),O.subscribe("EndManipulate",N),O.subscribe("BeginPreactivate",H),O.subscribe("EndPreactivate",(function(){B.setStyle("cursor","")})),O.setCursor(!1),O.diskNode.setNoHighlightNoZ(!0),O.manipulator.setPreActivationDuringManipulation(!1),z!==d.length?(L="Vertex",F="move"):(L="Rot",F="url("+U+"DMURotationCursorSel.png) 16 16, auto",O.pointMat.map=new t.ImageUtils.loadTexture(U+"DMURotationManip.png",void 0,null,null,t.ImageUtils.crossOriginPolicy)),g.push({uid:O.manipulator.getUID(),handleNb:z,handle:O,type:L,cursor:F}),f||((f=new i).setPickable(s.PICKTHROUGH),f.setNoHighlightNoZ(!0),v||(v=a.createLineMaterial({color:new t.Color(11843258),opacity:1,lineWidth:window.devicePixelRatio,pattern:"6"})),R.addChild(f))}T()}this.setHandlesVisibility=function(e){if(g&&g.length)for(var t=0;t<g.length;t++)g[t].handle.setVisibility(e);f&&f.setVisibility(e)},this.remove=function(){g&&g.length&&g.forEach((function(e){e.handle.dispose()})),g=null,f&&(f.removeChildren(),R.removeChild(f)),I&&I.remove(),v&&v.dispose(),f=R=p=P=v=M=h=null,I=null,S=d=u=null}}})})),define("DS/DMUMarkerManipulators/DMUMarkerLabelManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Manipulators/PointHandle","DS/DMUBaseExperience/EXPToolsVisualization","DS/Mesh/Mesh","DS/CoreEvents/Events","DS/WebappsUtils/WebappsUtils","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPToolsMaterial","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIServices/DMUObjectsServices","DS/Visualization/Node3D"],(function(e,t,i,n,o,a,r,s,l,c,h,p,u){"use strict";return e.extend({init:function(e){if(e&&e.dmuObj&&e.viewer){var d,M,g,f,v,P,w,m,b,y,x,D,V,S,C,R,I,B=this,U={MEASURE:0,TEXT:1,PICTURE:2},T=e.dmuObj,k=T.getManipulationData(),E={offsetWidth:k.width-k.imgWidth,offsetHeight:k.height-k.imgHeight},N=e.viewer,A=new s(N),H=A.getPointedElem(),L=r.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/"),F=["nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"],z=T.getType();if(d="DMUMeasure"===z?U.MEASURE:z.includes("Text")||z.includes("Stamp")?U.TEXT:U.PICTURE,this.onBeginManipulateCB=function(e){e&&(e.labelParams&&(y||(y={}),y.width=e.labelParams.width,y.height=e.labelParams.height),k=T.getManipulationData(),E={offsetWidth:k.width-k.imgWidth,offsetHeight:k.height-k.imgHeight},V=k.position,D=n.getViewerPositionFromPoint(N,V),D=new t.Vector2(D.left,D.top),C=k.width,R=k.height,S=k.rotationAngle)},this.onManipulateCB=function(e){e&&(e.translationVector2D?k.position=n.getPositionFromIntersection(N,D.clone().add(e.translationVector2D),V):e.handleType&&function(e){if(e)if("Center"===e.handleType&&e.transVec2D)k.position=n.getPositionFromIntersection(N,D.clone().add(e.transVec2D),V);else if("Rot"===e.handleType)k.rotationAngle=S+e.rotationAngle;else if(e.transVecLabel2D&&d===U.PICTURE){var i,o,a,r=e.transVecLabel2D.clone(),s=C/y.width,l=R/y.height,c=e.ctrlKey?2:1;switch(r.setX(r.x*s*c),r.setY(r.y*l*c),e.handleType){case"TL":i=C-r.x,o=R-r.y,a=new t.Vector3(-1,-1);break;case"TR":i=C+r.x,o=R-r.y,a=new t.Vector3(-1,1);break;case"BL":i=C-r.x,o=R+r.y,a=new t.Vector3(1,-1);break;case"BR":i=C+r.x,o=R+r.y,a=new t.Vector3(1,1)}var h=Math.max(Math.abs(i/C),Math.abs(o/R));k.width=C*h,k.imgWidth=k.width-E.offsetWidth,k.height=R*h,k.imgHeight=k.height-E.offsetHeight;var p=new t.Vector2(Math.sin(k.rotationAngle),Math.cos(k.rotationAngle)).multiplyScalar(a.x*(k.height*Math.sign(o)-R)),u=new t.Vector2(Math.cos(k.rotationAngle),-Math.sin(k.rotationAngle)).multiplyScalar(a.y*(k.width*Math.sign(i)-C));r=p.add(u),e.ctrlKey?k.position=V:k.position=n.getPositionFromIntersection(N,D.clone().add(r.multiplyScalar(.5)),V)}}(e),k.bManipulation=!0,k.pathElements=[],e.pathElements&&(k.pathElements=e.pathElements),T.updateRepresentation&&(k.snappedPosition2D=e.snappedPosition2D,T.updateRepresentation(k,!1)))},this.onEndManipulateCB=function(e){e&&e.event&&e.event.from&&e.event.from.length>0&&(k.mousePosition=e.event.from[e.event.from.length-1].getCurrentPosition()),k.bManipulation=!1,T.updateRepresentation&&T.updateRepresentation(k,!0),k=T.getManipulationData(),_()},!M){if(M=[],b=T.getNode().getRepNode(),d===U.PICTURE)for(var O=0;O<4;O++){var K,X,W=new i({viewer:N,sceneGraph:b.box,size:20});switch(W.subscribe("BeginManipulate",q),W.subscribe("Manipulate",J),W.subscribe("EndManipulate",Q),W.subscribe("BeginPreactivate",$),W.subscribe("EndPreactivate",(function(){H.setStyle("cursor","")})),W.setCursor(!1),W.diskNode.setNoHighlightNoZ(!0),W.diskNode.setRenderPasses(["robot"]),W.manipulator.setPreActivationDuringManipulation(!1),O){case 0:K="TL",X="crosshair";break;case 1:K="TR",X="crosshair";break;case 2:K="BR",X="crosshair";break;case 3:K="BL",X="crosshair"}M.push({uid:W.manipulator.getUID(),type:K,handle:W,cursor:X,hlCursor:O})}var Y=new i({viewer:N,sceneGraph:b.box,size:24});if(Y.subscribe("BeginManipulate",q),Y.subscribe("Manipulate",J),Y.subscribe("EndManipulate",Q),Y.subscribe("BeginPreactivate",$),Y.subscribe("EndPreactivate",(function(){H.setStyle("cursor","")})),Y.setCursor(!1),Y.diskNode.setNoHighlightNoZ(!0),Y.manipulator.setPreActivationDuringManipulation(!1),Y.manipulator.setPrePickingDuringManipulation(!1),Y.manipulator.setPickingDuringManipulation(!1),Y.pointMat.map=new t.ImageUtils.loadTexture(L+"DMURotationManip.png",void 0,null,null,t.ImageUtils.crossOriginPolicy),M.push({uid:Y.manipulator.getUID(),type:"Rot",handle:Y,cursor:"url("+L+"DMURotationCursorSel.png) 16 16, auto",hlCursor:"url("+L+"DMURotationCursorHL.png) 16 16, auto"}),d!==U.MEASURE||d===U.MEASURE&&e.dmuObj._isInCreationState&&e.dmuObj.getAttribute("bCumulativeMeasure"))for(var G=k&&k.leaderPoints?k.leaderPoints.length:0,Z=0;Z<G;Z++){var j=new i({viewer:N,sceneGraph:b.leader,size:20});j.subscribe("BeginManipulate",q),j.subscribe("Manipulate",J),j.subscribe("EndManipulate",Q),j.subscribe("BeginPreactivate",$),j.subscribe("EndPreactivate",(function(){H.setStyle("cursor","")})),j.setCursor(!1),j.diskNode.setNoHighlightNoZ(!0),j.manipulator.setPreActivationDuringManipulation(!1),M.push({uid:j.manipulator.getUID(),type:"Leader",number:Z,handle:j,cursor:"crosshair",hlCursor:"move"})}w||((w=new u).setPickable(o.PICKTHROUGH),w.setNoHighlightNoZ(!0),m||(m=c.createLineMaterial({color:new t.Color(11843258),opacity:1,lineWidth:window.devicePixelRatio,pattern:"6"})),b.box.addChild(w)),_()}z.includes("2D")&&(g=a.subscribe({event:"/VISU/"},(function(e){"@onWindowResized"!==e.eventType&&"@onViewpointChange"!==e.eventType||B.updateHandlePosition()}))),this.updateHandlePosition=function(){k=T.getManipulationData(),E={offsetWidth:k.width-k.imgWidth,offsetHeight:k.height-k.imgHeight},_()},this.setHandlesVisibility=function(e){M&&M.forEach((function(t){t.handle.setVisibility(e)})),w&&w.setVisibility(e)},this.remove=function(){M&&M&&M.forEach((function(e){e.handle.dispose()})),w&&(w.removeChildren(),b.box.removeChild(w)),A&&A.remove(),g&&a.unsubscribe(g),w=b=A=g=M=k=null,D=V=S=C=R=I=null}}function _(){if(M){var e=function(e){for(var t=0;t<e;t++){var i=x.pop();x.splice(0,0,i)}};x=F.slice();var i=Math.sin(k.rotationAngle),o=Math.cos(k.rotationAngle);o<Math.cos(7*Math.PI/8)?e(4):o<Math.cos(Math.PI/8)&&(o>Math.cos(3*Math.PI/8)?e(i<0?7:1):o<Math.cos(5*Math.PI/8)?e(i<0?5:3):e(i<0?6:2));for(var a=1;a<5;a++)x.splice(a,1);for(var r=T.isZoomMode&&T.isZoomMode()?n.getMMPerPixelRatio(N,k.position):1,s="topleft"===k.anchorMode?0:r*k.height/2,c=-r*("topleft"===k.anchorMode?k.height:k.height/2),h="topleft"===k.anchorMode?0:-r*k.width/2,p=r*("topleft"===k.anchorMode?k.width:k.width/2),u=(h+p)/2,d=(new t.Matrix4).makeRotationZ(k.rotationAngle),g=0;g<M.length;g++)switch(M[g].type){case"Leader":M[g].handle.setMatrix((new t.Matrix4).setPosition(k.leaderPoints[M[g].number]));break;case"Rot":M[g].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(u,30*r+s,0))),M[g].handle.diskNode.setMatrix(d.clone().setPosition(new t.Vector3(-.5,-.5,0).applyMatrix4(d)));break;case"TL":M[g].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(h,s,0)));break;case"TR":M[g].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(p,s,0)));break;case"BL":M[g].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(h,c,0)));break;case"BR":M[g].handle.setMatrix((new t.Matrix4).setPosition(new t.Vector3(p,c,0)))}if(w){w.removeChildren();var f=l.createLineNode({points:[new t.Vector3(u,s,0),new t.Vector3(u,30*r+s,0)],fill:!1,material:m});f.excludeFromHighlight(!0,!0),w.addChild(f)}}}function J(i){if(i&&A.isCanvasToDraw(i.event.from[0].getView())){A.updateManipulationData(i);var o,a,r,s=i.event.from[0].getCurrentPosition(i.viewer.canvas),l=[];if("Leader"===f.type){if(i.intersection.position&&i.intersection.path.length){if(h.isAPOIPath(i.intersection.path[0])){const{position:e}=p.getPOIInformationFromPathElement(i.intersection.path[0]);e&&(o=e)}o||(o=n.getPositionFromIntersection(N,i.intersection.position,i.intersection.position,!0))}else o=n.getPositionFromIntersection(N,i.intersection.position,k.leaderPoints[f.number],!0);if(k.leaderPoints[f.number]=o,d===U.MEASURE){var c;if(i.event.gesture)c=i.event.gesture.getEvents()[0];else c=i.event.from[0];var u=N.getMousePosition(c.getCurrentPosition(N.canvas));if(u.event=c,i.manipulator.active&&i.manipulator.getPickingDuringManipulation())l=N.pick(u,"primHybrid",!0).path}}else if("Rot"===f.type){var M=(new t.Vector2).subVectors(s,D),g=new t.Vector2(1,0).dot(M.clone().normalize());a=s.y<=D.y?Math.acos(g):2*Math.PI-Math.acos(g);var w=i.shiftKey||void 0===i.shiftKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.shiftKey;if(P!==w){var m=Math.round(a/v)*v,b=new t.Vector2(Math.cos(m),-Math.sin(m));if(b.setLength(M.dot(b)),b.distanceTo(M)<A.ROTATION_SNAP_THRESHOLD){a=m;var y=k.position;if("topleft"===k.anchorMode){var x=T.isZoomMode&&T.isZoomMode()?n.getMMPerPixelRatio(N,k.position):1,V=i.viewer.currentViewpoint.getUpDirection(),C=(new t.Vector3).crossVectors(i.viewer.currentViewpoint.getSightDirection(),V);y=k.position.clone().add(C.multiplyScalar(x*k.width/2).add(V.multiplyScalar(x*-k.height/2)))}A.displayAxis(y,a,M.length()+20)}else A.removeAxis()}else A.removeAxis();a-=S+Math.PI/2}else{if(r=n.get2DSnappedPosition(s,k.rotationAngle).sub(I),k.rotationAngle){var R=r.x*Math.cos(k.rotationAngle)-r.y*Math.sin(k.rotationAngle),B=r.x*Math.sin(k.rotationAngle)+r.y*Math.cos(k.rotationAngle);r.setX(R),r.setY(B)}}var E=i.ctrlKey||void 0===i.ctrlKey&&i.event.from&&i.event.from.length&&i.event.from[0].event&&i.event.from[0].event.ctrlKey;e.onManipulateCB&&e.onManipulateCB({transVecLabel2D:r,rotationAngle:a,handleType:f.type,ctrlKey:E,pathElements:l.length>0?l:void 0})}}function q(i){if(i){var a;T.setNodePickable(o.INVISIBLE);for(var r=0;r<M.length;r++)if(M[r].uid===i.manipulator.getUID()){f=M[r],H.setStyle("cursor",M[r].cursor),a=(new t.Vector3).getPositionFromMatrix(M[r].handle.getMatrixWorld());break}var s=parseFloat(n.getSnapRotationInfos().snapRotationAngle);v=(isNaN(s)?90:s)*Math.PI/180,P=n.getSnapRotationInfos().snapRotationToggle,D=n.getViewerPositionFromPoint(N,k.position),D=new t.Vector2(D.left,D.top),I=n.getViewerPositionFromPoint(N,a),I=new t.Vector2(I.left,I.top),"Rot"===f.type?A.addToListener("Shift",J):A.addToListener("Control",J),A.activate(),e.onBeginManipulateCB&&e.onBeginManipulateCB({labelParams:k})}}function Q(t){t&&(H.setStyle("cursor",""),A.remove(),T.setNodePickable(o.PICKABLE),e.onEndManipulateCB&&e.onEndManipulateCB())}function $(e){if(e)for(var t=0;t<M.length;t++)if(M[t].uid===e.manipulator.getUID()){"number"==typeof M[t].hlCursor?H.setStyle("cursor",x[t]):H.setStyle("cursor",M[t].hlCursor);break}}}})}));