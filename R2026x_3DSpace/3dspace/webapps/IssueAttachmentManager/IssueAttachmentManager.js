define("DS/IssueAttachmentManager/services/AttachmentServices",["UWA/Core","UWA/Promise","UWA/Controls/Input","DS/DocumentManagement/DocumentManagement","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/i3DXCompassPlatformServices/OpenWith","DS/WAFData/WAFData","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u){"use strict";var m={ISSUE_TYPE:"Issue",EXTENSIONS:{JPG:"image",JPEG:"image",PNG:"image",BMP:"image",GIF:"image",MP3:"audio",MPEG:"audio",OGG:"audio",FLAC:"audio",MP4:"video",AVI:"video",MPG:"video",MKV:"video",WEBM:"video",MOV:"video",PDF:"office",PPT:"office",PPTX:"office",DOC:"office",OTHER:"other"},TEN_MINUTES:6e5,CACHE_LIMIT:5,FETCH_DOCUMENT_PREDICATES:["resourceid","ds6w:identifier","ds6w:label","ds6w:type","ds6w:modified","ds6w:created","preview_url","type_icon_url","ds6w:responsible","owner","ds6w:docextension","ds6w:organizationResponsible"],NLS_PREDICATES:["ds6w:type"],DOCUMENTS_SERVICE_ROOT_URL:"/resources/v1/modeler/documents/",DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS:"$include=parents,relOwnerInfo&$fields=parents.originated,isDocumentType",SET_AS_PRIMARY:{EXTENSION:".png"}};return{getCurrentSecurityContext:function(){return c.getSecurityContext()},getCurrentTenant:function(){return c.getTenant()},parseDocument:function(t,n){if(!e.is(t,"object")){var o=u.replace(u.error.common.incorrectArgument,{type:"Object"});throw new Error(o)}if(e.is(n)&&!e.is(n,"string")){var i=u.replace(u.error.common.incorrectArgument,{type:"String"});throw new Error(i)}var r;try{if(r={id:t.id,title:t.dataelements.title||t.dataelements.name,name:t.dataelements.name,type:t.type,dispType:e.is(u.views.Attachment.types[t.type],"string")?u.views.Attachment.types[t.type]:t.type,thumbnailUrl:t.dataelements.image,owner:{firstName:t.relateddata.ownerInfo[0].dataelements.firstname,fullName:t.relateddata.ownerInfo[0].dataelements.firstname+" "+t.relateddata.ownerInfo[0].dataelements.lastname,lastName:t.relateddata.ownerInfo[0].dataelements.lastname,user:t.relateddata.ownerInfo[0].dataelements.name},created:t.dataelements.originated,modified:t.dataelements.modified},n&&t.relateddata.hasOwnProperty("parents")){var s=t.relateddata.parents.find((function(e){return e.id===n}));s&&(r.relOwner={firstName:s.relateddata.relOwnerInfo[0].dataelements.firstname,fullName:s.relateddata.relOwnerInfo[0].dataelements.firstname+" "+s.relateddata.relOwnerInfo[0].dataelements.lastname,lastName:s.relateddata.relOwnerInfo[0].dataelements.lastname,user:s.relateddata.relOwnerInfo[0].dataelements.name},r.relOriginated=s.relelements.originated)}if("Document"===t.type&&t.relateddata.files.length){r.title=t.relateddata.files[0].dataelements.title;var a=t.relateddata.files[0].dataelements.title.split("."),c=a[a.length-1];m.EXTENSIONS.hasOwnProperty(c.toUpperCase())?r.documentType=m.EXTENSIONS[c.toUpperCase()]:r.documentType=m.EXTENSIONS.OTHER}}catch(e){throw e}return r},parseFromSearch:function(t){if(!e.is(t,"object")){var n=u.replace(u.error.common.incorrectArgument,{type:"Object"});throw new Error(n)}var o={id:t.id,title:t["ds6w:label"],type:t["ds6w:type_value"],modified:t["ds6w:modified"],created:t["ds6w:created"],thumbnailUrl:t.preview_url,iconUrl:t.type_icon_url,sourceid_value:t.sourceid_value,owner:{firstName:"",fullName:t["ds6w:responsible"],lastName:"",user:t.owner}};if("Document"===o.type&&t.hasOwnProperty("ds6w:docExtension")){var i=t["ds6w:docExtension"];o.title+="."+i,m.EXTENSIONS.hasOwnProperty(i.toUpperCase())?o.documentType=m.EXTENSIONS[i.toUpperCase()]:o.documentType=m.EXTENSIONS.OTHER}return o},parseFromFetch:function(t){if(!e.is(t,"object")||!e.is(t.attributes,"array")){var n=u.replace(u.error.common.incorrectArgument,{type:"Object"});throw new Error(n)}t.attributes.sort((function(e,t){return"ds6w:docextension"===e.name?1:"ds6w:docextension"===t.name?-1:0}));for(var o={owner:{}},i=0;i<t.attributes.length;i++){var r=t.attributes[i];if("resourceid"===r.name&&(o.id=r.value),"ds6w:label"===r.name&&(o.title=r.value),"ds6w:type"===r.name&&(o.type=r.value,o.dispType=r.dispValue),"ds6w:modified"===r.name&&(o.modified=r.value),"ds6w:created"===r.name&&(o.created=r.value),"preview_url"===r.name&&(o.thumbnailUrl=r.value),"type_icon_url"===r.name&&(o.iconUrl=r.value),"ds6w:responsible"===r.name&&(o.owner.fullName=r.value),"owner"===r.name&&(o.owner.user=r.value),"ds6w:docextension"===r.name&&"Document"===o.type){var s=r.value;o.title+="."+s,m.EXTENSIONS.hasOwnProperty(s.toUpperCase())?o.documentType=m.EXTENSIONS[s.toUpperCase()]:o.documentType=m.EXTENSIONS.OTHER}}return o},parseFromDragEvent:function(t){if(!(t instanceof DragEvent)){var n=u.replace(u.error.common.incorrectArgument,{type:"DragEvent"});throw new Error(n)}for(var o=null,i=e.is(t.dataTransfer.types.indexOf,"function")?"indexOf":"contains",r="",s=["text/searchitems","text/plain","Text","Files"],a=0;a<s.length&&""===r;a++){var c=t.dataTransfer.types[i](s[a]);(e.is(c,"number")&&c>=0||e.is(c,"boolean")&&!0===c)&&(r=s[a])}var l={};if("Files"===r)o={files:t.dataTransfer.files};else if(""!==r){l=t.dataTransfer.getData(r);try{o=JSON.parse(l)}catch(e){}}return o},getDocumentsFrom:function(n){var i=this;if(!e.is(n,"string")){var r=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(r))}return new t((function(e,t){o.getDocumentsFromParent({getVersions:!1,additionalURLParams:m.DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS,relInfo:{parentId:n,parentRelName:"Reference Document"},tenantUrl:c.get3DSpaceUrl(),tenant:i.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(i.getCurrentSecurityContext()),onComplete:function(t){for(var o={id:n,primaryAttachment:"",attachments:[]},r=0;r<t.data.length;r++){var s=t.data[r],a=i.parseDocument(s,n);o.attachments.push(a)}e(o)},onFailure:t})}))},getSearchQuery:function(e){var n=this;if(e){var o="",i=[],r=[];return e.forEach((function(e){var o=new t((function(t){n.getDocumentsFrom(e).then((function(e){t(e)}))}));r.push(o)})),t.all(r).then((function(e){return e.forEach((function(e){e.attachments.forEach((function(e){i.push(e.name)}))})),0===i.length?o="":(i=i.filter((function(e,t,n){return n.indexOf(e)===t})),o="flattenedtaxonomies:types/DOCUMENTS AND name:(",i.forEach((function(e,t){o+=" "+e+" ",t!==i.length-1&&(o+="OR")})),o+=")"),o}))}return t.resolve("")},getDocuments:function(n){var i=this;if(!e.is(n,"array")){var r=u.replace(u.error.common.incorrectArgument,{type:"Array<String>"});return t.reject(Error(r))}return new t((function(e,t){o.getDocuments(n,{getVersions:!1,additionalURLParams:m.DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS,tenantUrl:c.get3DSpaceUrl(),tenant:i.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(i.getCurrentSecurityContext()),onComplete:function(t){for(var n={attachments:[],data:t.data},o=0;o<t.data.length;o++){var r=t.data[o],s=i.parseDocument(r);n.attachments.push(s)}e(n)},onFailure:t})}))},fetch:function(n){var o=this;if(!e.is(n,"array")){var r=u.replace(u.error.common.incorrectArgument,{type:"Array<String>"});return t.reject(Error(r))}return new t((function(r,l){var u=a.get("widget")||window.widget,d={label:u.name+"-"+c.getUserName()+"-"+Date.now(),nresults:n.length,physicalid:n,start:0,tenantUrl:c.get3DSpaceUrl(),tenant:o.getCurrentTenant(),select_predicate:m.FETCH_DOCUMENT_PREDICATES},h={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+decodeURIComponent(o.getCurrentSecurityContext())},timeout:m.TEN_MINUTES,onComplete:function(s){var a;try{a=JSON.parse(s)}catch(e){l(e)}new t((function(t){if(Array.isArray(a.results)&&a.results.length===n.length)t(a);else{var i=[];if(Array.isArray(a.results)){var r=a.results.map((function(e){return o.parseFromFetch(e)})).reduce((function(e,t){return e.push(t.id),e}),[]);i=n.filter((function(e){return-1===r.indexOf(e)}))}else i=n;o.recent().then((function(n){if(Array.isArray(n.results)){var r=e.clone(a);Array.isArray(r.results)||(r.results=[]);for(var s=0;s<n.results.length;s++){var c=o.parseFromFetch(n.results[s]);-1!==i.indexOf(c.id)&&(r.results.push(n.results[s]),r.infos.nhits++,r.infos.nresults++)}t(r)}else t(a)})).catch((function(){t(a)}))}})).then((function(t){var n=e.clone(t),s={};if(Array.isArray(n.results)&&n.results.length)for(var a=e.clone(n.results),c=0;c<a.length;c++)if(Array.isArray(a[c].attributes)&&a[c].attributes.length)for(var l=a[c].attributes,d=0;d<l.length;d++){var h=a[c].attributes[d];-1!==m.NLS_PREDICATES.indexOf(h.name)&&(s.hasOwnProperty(h.name)||(s[h.name]=[]),-1===s[h.name].indexOf(h.value)&&s[h.name].push(h.value))}i.getNlsOfPropertiesValues(JSON.stringify(s),{tenantId:o.getCurrentTenant(),lang:u.lang,onComplete:function(e){if(Array.isArray(n.results)&&n.results.length)for(var t=n.results,o=0;o<t.length;o++)if(Array.isArray(t[o].attributes)&&t[o].attributes.length)for(var i=t[o].attributes,s=0;s<i.length;s++){var a=t[o].attributes[s];e.hasOwnProperty(a.name)&&e[a.name].hasOwnProperty(a.value)&&(a.dispValue=e[a.name][a.value])}r(n)},onFailure:function(){r(n)}})}))},onFailure:l,data:JSON.stringify(d)};s.authenticatedRequest(c.get3DSpaceUrl()+"/cvservlet/fetch/v2",h)}))},recent:function(){var e=this;return new t((function(t,n){var o={label:(a.get("widget")||window.widget).name+"-"+c.getUserName()+"-"+Date.now(),nresults:100,delta_time_interval:300,tenant:e.getCurrentTenant(),select_predicate:m.FETCH_DOCUMENT_PREDICATES,select_file:["icon","thumbnail_2d"],login:{"3dspace":{SecurityContext:c.getSecurityContext()}}},i={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},timeout:m.TEN_MINUTES,onComplete:function(e){try{var o=JSON.parse(e);t(o)}catch(e){n(e)}},onFailure:n,data:JSON.stringify(o)},r=c.get3DSearchUrl()+"/recent?tenant="+e.getCurrentTenant()+"&_="+Date.now();s.authenticatedRequest(r,i)}))},downloadDocuments:function(n,i){var r=this;if(!e.is(n,"array")){var a=u.replace(u.error.common.incorrectArgument,{type:"Array<String>"});return t.reject(Error(a))}if(e.is(i)&&!e.is(i,"boolean")){var l=u.replace(u.error.common.incorrectArgument,{type:"Boolean"});return t.reject(Error(l))}return new t((function(e){o._prepareService(e,{tenantUrl:c.get3DSpaceUrl(),tenant:r.getCurrentTenant(),securityContext:decodeURIComponent(r.getCurrentSecurityContext())})||e()})).then((function(){return new t((function(e,t){var a=c.get3DSpaceUrl()+m.DOCUMENTS_SERVICE_ROOT_URL+"DownloadTicket";a+=i?"?zipFiles=true":"?fileStream=true",a+="&tenant="+r.getCurrentTenant();var l={csrf:o.getCsrf(c.get3DSpaceUrl()),data:n.map((function(e){return{id:e}}))},u={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+r.getCurrentSecurityContext()},timeout:m.TEN_MINUTES,onComplete:function(n){try{var o=JSON.parse(n),i=[];if(o&&o.success){if(o&&o.data&&o.data.length){for(var r=o.data.length,s=0;s<r;s++){var a=o.data[s],c={id:a.id,errorMessage:a.updateMessage};a.dataelements&&a.dataelements.ticketURL&&(c.downloadUrl=a.dataelements.ticketURL,a.dataelements.fileName&&(c.fileName=a.dataelements.fileName),a.dataelements.fileNames&&(c.fileNames=a.dataelements.fileNames)),i.push(c)}e(i)}}else t(o)}catch(e){t(e)}},onFailure:t,data:JSON.stringify(l)};s.authenticatedRequest(a,u)}))}))},uploadFile:function(n,i,r,a){var l=this;if(!(n instanceof File||n instanceof Blob)){var d=u.replace(u.error.common.incorrectArgument,{type:"File"});return t.reject(Error(d))}if(e.is(i,"string")&&""===i){var h=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(h))}return new t((function(e){o._prepareService(e,{tenantUrl:c.get3DSpaceUrl(),tenant:l.getCurrentTenant(),securityContext:a||decodeURIComponent(l.getCurrentSecurityContext())})||e()})).then((function(){return new t((function(t,u){var d=c.get3DSpaceUrl()+m.DOCUMENTS_SERVICE_ROOT_URL+"files/CheckinTicket";d+="?tenant="+l.getCurrentTenant();var h={csrf:o.getCsrf(c.get3DSpaceUrl())},g={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:a||"ctx::"+l.getCurrentSecurityContext()},timeout:m.TEN_MINUTES,onComplete:function(d){var g=JSON.parse(d);if(e.is(r,"object")&&e.is(r.onTicketComplete,"function")&&r.onTicketComplete(g),g&&g.success){var p=g.data[0].dataelements;o.setCsrf(g.csrf,c.get3DSpaceUrl());var f=p.ticketURL,v={csrf:"notNeeded",documentInfo:{fileInfo:{file:n}}};e.is(i,"string")&&""!==i&&(v.documentInfo.relInfo={parentId:i,parentRelName:"Reference Document"});var E=e.extend(v,p),T=new FormData;T.append(p.ticketparamname,p.ticket),T.append("file_0",n,n.name);var S={method:"POST",onComplete:function(n){e.is(r,"object")&&e.is(r.onCheckinComplete,"function")&&r.onCheckinComplete(n);var i=c.get3DSpaceUrl()+m.DOCUMENTS_SERVICE_ROOT_URL,d=Object.create(null);o._buildDocumentDataElements(d,E),E.fcsReceipt=n,o._buildFilesRelatedData(d,E);var g={csrf:h.csrf,data:[d]},p={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:a||"ctx::"+l.getCurrentSecurityContext()},timeout:m.TEN_MINUTES,onComplete:function(n){var o=JSON.parse(n);e.is(r,"object")&&e.is(r.onConnectComplete,"function")&&r.onConnectComplete(o),t(o)},onFailure:function(e,t){var n=JSON.parse(t);u(n)},onCancel:u,onTimeout:u,data:JSON.stringify(g)},f=s.authenticatedRequest(i,p);e.is(r,"object")&&e.is(r.onConnectStart,"function")&&r.onConnectStart(f)},onFailure:u,onCancel:u,data:T,timeout:0};e.is(r,"object")&&e.is(r.onCheckinProgress,"function")&&(S.onUploadProgress=r.onCheckinProgress);var y=s.authenticatedRequest(f,S);e.is(r,"object")&&e.is(r.onCheckinStart,"function")&&r.onCheckinStart(y)}else u(g)},onFailure:u,onCancel:u,onTimeout:u,data:JSON.stringify(h)},p=s.authenticatedRequest(d,g);e.is(r,"object")&&e.is(r.onTicketStart,"function")&&r.onTicketStart(p)}))}))},connectDocumentToParent:function(n,i){var r=this;if(!e.is(n,"string")){var s=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(s))}if(!e.is(i,"string")){var a=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(a))}return new t((function(e,t){o.connectDocumentToParent(n,{relInfo:{parentId:i,parentRelName:"Reference Document"},tenantUrl:c.get3DSpaceUrl(),tenant:r.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(r.getCurrentSecurityContext()),onComplete:e,onFailure:t})}))},connectDocumentsToParent:function(n,o){if(!e.is(n,"array")){var i=u.replace(u.error.common.incorrectArgument,{type:"Array<String>"});return t.reject(Error(i))}if(!e.is(o,"string")){var r=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(r))}for(var s=[],a=0;a<n.length;a++){var c=n[a],l=function(e){return{documentId:this.documentId,parentId:this.parentId,response:e}};s.push(this.connectDocumentToParent(c,o).then(l.bind({documentId:c,parentId:o})).catch(l.bind({documentId:c,parentId:o})))}return t.all(s)},disconnectDocumentFromParent:function(n,i){var r=this;if(!e.is(n,"string")){var s=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(s))}if(!e.is(i,"string")){var a=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(a))}return new t((function(e,t){o.disconnectDocumentFromParent(n,{relInfo:{parentId:i,parentRelName:"Reference Document"},tenantUrl:c.get3DSpaceUrl(),tenant:r.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(r.getCurrentSecurityContext()),onComplete:e,onFailure:t})}))},disconnectDocumentsFromParent:function(n,o){if(!e.is(n,"array")){var i=u.replace(u.error.common.incorrectArgument,{type:"Array<String>"});return t.reject(Error(i))}if(!e.is(o,"string")){var r=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(r))}for(var s=[],a=0;a<n.length;a++){var c=n[a],l=function(e){return{documentId:this.documentId,parentId:this.parentId,response:e}};s.push(this.disconnectDocumentFromParent(c,o).then(l.bind({documentId:c,parentId:o})).catch(l.bind({documentId:c,parentId:o})))}return t.all(s)},deleteDocument:function(n){var i=this;if(!e.is(n,"string")){var r=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(r))}return new t((function(e,t){o.deleteDocument(n,{tenantUrl:c.get3DSpaceUrl(),tenant:i.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(i.getCurrentSecurityContext()),onComplete:e,onFailure:t})}))},deleteDocuments:function(n){if(!e.is(n,"array")){var o=u.replace(u.error.common.incorrectArgument,{type:"Array<String>"});return t.reject(Error(o))}for(var i=[],r=0;r<n.length;r++){var s=n[r],a=function(e){return{documentId:this.documentId,response:e}};i.push(this.deleteDocument(s).then(a.bind({documentId:s})).catch(a.bind({documentId:s})))}return t.all(i)},browseFileFromLocalDisk:function(e){return new t((function(t){var o=new n.File("Input.File",{visibility:"hidden",styles:{display:"none"}}).inject(e);o.elements.container.setStyle("display","none"),o.elements.input.accept="all",o.elements.input.multiple=!0,o.elements.input.addEventListener("change",(function(e){o.destroy(),o=null;var n=e.target.files;t(n)}),!1),o.elements.input.addEventListener("click",(function(e){e.stopPropagation()})),o.elements.input.click()}))},getPrimary:function(n){var o=this;if(!e.is(n,"string")){var i=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(i))}return new t((function(e,t){var i={method:"GET"};i.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+o.getCurrentSecurityContext()},i.onComplete=function(t){var n=JSON.parse(t).body,o=m.SET_AS_PRIMARY.EXTENSION;n.fileName&&n.fileName.indexOf(o)===n.fileName.length-o.length&&(n.documentId=n.fileName.slice(0,-o.length)),e(JSON.stringify(n))},i.onFailure=t,s.authenticatedRequest(c.assembleURLFor3DSpace("/resources/issues/"+n+"/images/primary"),i)}))},setAsPrimary:function(n,o,i){var r=this;if(!e.is(n,"string")){var a=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(a))}if(!e.is(o,"string")){var l=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(l))}if(e.is(i)&&!e.is(i,"boolean")){var d=u.replace(u.error.common.incorrectArgument,{type:"Boolean"});return t.reject(Error(d))}return new t((function(e,t){var a={document:n,lock:i||!1},l={method:"PUT"};l.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+r.getCurrentSecurityContext()},l.data=JSON.stringify(a),l.onComplete=function(t){var n=JSON.parse(t).body,o=m.SET_AS_PRIMARY.EXTENSION;n.fileName&&n.fileName.indexOf(o)===n.fileName.length-o.length&&(n.documentId=n.fileName.slice(0,-o.length)),e(JSON.stringify(n))},l.onFailure=function(e,n){n&&n.search("ErrorCode:1500028")>0&&(e.message=e.message+" Access Denied"),n&&n.length>0?t(n):t(e)},s.authenticatedRequest(c.assembleURLFor3DSpace("/resources/issues/"+o+"/images/primary"),l)}))},unsetAsPrimary:function(n){var o=this;if(!e.is(n,"string")){var i=u.replace(u.error.common.incorrectArgument,{type:"String"});return t.reject(Error(i))}return new t((function(e,t){var i={method:"DELETE"};i.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+o.getCurrentSecurityContext()},i.onComplete=e,i.onFailure=function(e,n){n&&n.length,t(n)},s.authenticatedRequest(c.assembleURLFor3DSpace("/resources/issues/"+n+"/images/primary"),i)}))},getCompatibleApps:function(n){if(!e.is(n,"array")){var o=u.replace(u.error.common.incorrectArgument,{type:"Array"});return t.reject(Error(o))}return new t((function(t,o){if(0===n.length)t([]);else{var i=[],s=[];m.ISSUE_TYPE;l.type.getSubType().then((function(u){var m=u;null!=m&&Object.keys(m).length>1&&Object.keys(m);for(var d=0;d<n.length;d++){var h=n[d];s.push(h._attributes.type),i.push({envId:c.getTenant(),serviceId:"3DSpace",objectId:h._attributes.id,objectType:h._attributes.type,objectTaxonomies:[h._attributes.type],displayName:h._attributes.title?h._attributes.title:h._attributes.name})}l.getTypesHierarchy({types:s,onComplete:function(n){if(e.is(n.types_hierarchies,"array")&&n.types_hierarchies.forEach((function(e,t){i.forEach((function(t,n){t.objectTaxonomies[0]===e.type&&(t.objectTaxonomies=t.objectTaxonomies.concat(e.hierarchy))}))})),0===i.length)return Performance.end(name+" getOpenWithMenu"),void t(out);var s=a.get("widget")||window.widget;(new r).set3DXContent({protocol:"3DXContent",version:"1.1",source:s.name,widgetId:s.id,data:{items:i}},!0).retrieveCompatibleApps(t,o)},onFailure:function(e){t(out)}})})).catch((function(e){return e}))}}))}}})),define("DS/IssueAttachmentManager/components/Item",["UWA/Class/Model","UWA/Core","DS/Logger/Logger","DS/WebappsUtils/WebappsUtils","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i){"use strict";var r={EXTENSIONS:{JPG:"image",JPEG:"image",PNG:"image",BMP:"image",GIF:"image",MP3:"audio",MPEG:"audio",OGG:"audio",FLAC:"audio",MP4:"video",AVI:"video",MPG:"video",MKV:"video",WEBM:"video",MOV:"video",PDF:"office",PPT:"office",PPTX:"office",DOC:"office",OTHER:"other"},MIMETYPE:{IMAGE:"image",AUDIO:"audio",VIDEO:"video",APPLICATION:"other"}};return e.extend({name:"DS/IssueAttachmentManager/components/Item",_logger:null,defaults:{id:null,type:null,title:"",owner:null,relOwner:null,created:"",modified:"",relOriginated:"",isProcessing:!1,isFailed:!1,isFile:!1,isPrimary:!1},init:function(e,n){if(!e.hasOwnProperty("id")||t.is(e.id,null)||t.equals(e.id,"")||!t.is(e.id,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(!e.hasOwnProperty("type")||t.is(e.type,null)||t.equals(e.type,"")||!t.is(e.type,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("dispType")&&!t.is(e.dispType,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"Object"}));if(!e.hasOwnProperty("title")||t.is(e.title,null)||!t.is(e.title,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("documentType")&&!t.is(e.documentType,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("owner")&&!t.is(e.owner,"object"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"Object"}));if(e.hasOwnProperty("relOwner")&&!t.is(e.relOwner,"object"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"Object"}));if(e.hasOwnProperty("created")&&!t.is(e.created,"string")&&!t.is(e.created,"date"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("modified")&&!t.is(e.modified,"string")&&!t.is(e.modified,"date"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("relOriginated")&&!t.is(e.relOriginated,"string")&&!t.is(e.relOriginated,"date"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("thumbnailUrl")&&!t.is(e.thumbnailUrl,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("iconUrl")&&!t.is(e.iconUrl,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("contentUrl")&&!t.is(e.contentUrl,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));this._parent(e,n)},setup:function(){var e=this;if(e.set("modified",new Date(e.get("modified"))),e.set("created",new Date(e.get("created"))),e.set("relOriginated",new Date(e.get("relOriginated"))),void 0===e.get("iconUrl")){var t=o.getWebappsAssetUrl("IssueAttachmentManager","images/I_MultipleDocuments22x22.png");e.set("iconUrl",t)}if(void 0===e.get("thumbnailUrl")){var i=o.getWebappsAssetUrl("IssueAttachmentManager","images/I_CDM_Document108x144.png");e.set("thumbnailUrl",i)}e._logger=n.getLogger(e.name),e.selected=!1,e.hidden=!1},setDocumentType:function(e){if(!t.is(e,"string"))throw new Error(i.replace(i.error.common.incorrectArgument,{type:"String"}));return r.EXTENSIONS.hasOwnProperty(e.toUpperCase())?this.set("documentType",r.EXTENSIONS[e.toUpperCase()]):this.set("documentType",r.EXTENSIONS.OTHER),this},setDocumentTypeByMIME:function(e){if(!t.is(e,"string"))throw new Error(i.replace(i.error.common.incorrectArgument,{type:"String"}));var n=e.split("/");if(2===n.length){var o=n[0];r.MIMETYPE.hasOwnProperty(o.toUpperCase())?this.set("documentType",r.MIMETYPE[o.toUpperCase()]):this.set("documentType",r.EXTENSIONS.OTHER)}else this.set("documentType",r.EXTENSIONS.OTHER);return this},select:function(){return!1===this.selected&&(this.selected=!0,this.dispatchEvent("onSelect",{id:this.id,props:this.toJSON()})),this},unselect:function(){return!0===this.selected&&(this.selected=!1,this.dispatchEvent("onUnselect",{id:this.id,props:this.toJSON()})),this},hide:function(){return!1===this.hidden&&(this.hidden=!0,this.dispatchEvent("onHide",{id:this.id,props:this.toJSON()})),this},show:function(){return!0===this.hidden&&(this.hidden=!1,this.dispatchEvent("onShow",{id:this.id,props:this.toJSON()})),this}})})),define("DS/IssueAttachmentManager/components/Collection",["UWA/Core","UWA/Class/Collection","DS/Logger/Logger","DS/IssueAttachmentManager/components/Item","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i){"use strict";var r={ONSELECT_TIMEOUT:0,ONUNSELECT_TIMEOUT:0,SORT:{MODE:{DATE:"relOriginated",TITLE:"title"},ORDER:{ASCENDING:1,DESCENDING:-1},TYPE:{DOCUMENT:1,OTHER:2},DOCUMENTTYPE:{IMAGE:1,VIDEO:2,AUDIO:3,OFFICE:4,OTHER:5}}},s=t.extend({name:"DS/IssueAttachmentManager/components/Collection",model:o,_logger:null,init:function(t,n){var o=this;if(!t.hasOwnProperty("id")||e.is(t.id,null)||e.equals(t.id,"")||!e.is(t.id,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(t.hasOwnProperty("primaryAttachment")&&!e.is(t.primaryAttachment,"string"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"String"}));if(t.hasOwnProperty("attachments")&&!e.is(t.attachments,"array"))throw new Error(i.replace(i.error.common.incorrectInitArgument,{type:"Array"}));o.id=t.id,o.primaryAttachment=t.primaryAttachment;var r=e.merge(n||{},{comparator:o._sortComparator.bind(o)});o._parent(t.attachments,r)},setup:function(){var e=this;e._logger=n.getLogger(e.name),e.sortMode="date",e.sortOrder="descending",e.groupByType=!1,e._selectedItems=[],e._unselectedItems=[],e._eventCallbacks._debounced._onItemSelect=e.debounce(e._eventCallbacks._unbounced._onItemSelect,r.ONSELECT_TIMEOUT),e._eventCallbacks._debounced._onItemUnselect=e.debounce(e._eventCallbacks._unbounced._onItemUnselect,r.ONUNSELECT_TIMEOUT)},select:function(t){var n=this;if(e.is(t,"string")){if(!n.get(t)){var o=i.replace(i.error.components.Collection.common.itemNotExist,{id:t});throw new Error(o)}n.get(t).select()}else{if(!e.is(t,"array")){var r=i.replace(i.error.common.incorrectArgument,{type:"String or Array<String>"});throw new Error(r)}for(var s=[],a=0;a<t.length;a++)n.get(t[a])?n.get(t[a]).select():s.push(t[a]);if(s.length>0){var c=i.replace(i.error.components.Collection.common.itemNotExist,{id:s});n._logger.error(c)}}return this},unselect:function(t){var n=this;if(e.is(t,"string")){if(!n.get(t)){var o=i.replace(i.error.components.Collection.common.itemNotExist,{id:t});throw new Error(o)}n.get(t).unselect()}else{if(!e.is(t,"array")){var r=i.replace(i.error.common.incorrectArgument,{type:"String or Array<String>"});throw new Error(r)}for(var s=[],a=0;a<t.length;a++)if(n.get(t[a])?n.get(t[a]).unselect():s.push(t[a]),s.length>0){var c=i.replace(i.error.components.Collection.common.itemNotExist,{id:t[a]});n._logger.error(c)}}return this},selectAll:function(){var e=this.map((function(e){return e.id}));return this.select(e)},unselectAll:function(){var e=this.map((function(e){return e.id}));return this.unselect(e)},getItems:function(t){var n=this;if(e.is(t,"array")){for(var o=[],r=[],s=0;s<t.length;s++)if(n.get(t[s])?o.push(n.get(t[s])):r.push(t[s]),r.length>0){var a=i.replace(i.error.components.Collection.common.itemNotExist,{id:t[s]});n._logger.error(a)}return o}var c=i.replace(i.error.common.incorrectArgument,{type:"array"});throw new Error(c)},getSelectedItems:function(){for(var e=[],t=0;t<this.size();t++){var n=this.at(t);n.selected&&e.push(n)}return e},_sortComparator:function(e,t){var n=this.groupByType?this._groupByType(e,t):0;if(0===n){switch(r.SORT.MODE[this.sortMode.toUpperCase()]){case r.SORT.MODE.DATE:n=this._sortByRelOriginatedDate(e,t);break;case r.SORT.MODE.TITLE:n=this._sortByTitle(e,t);break;default:n=this._sortByRelOriginatedDate(e,t)}var o=r.SORT.ORDER.ASCENDING;r.SORT.ORDER.hasOwnProperty(this.sortOrder.toUpperCase())&&(o=r.SORT.ORDER[this.sortOrder.toUpperCase()]),n*=o}return n},_groupByType:function(e,t){var n=0,o=r.SORT.TYPE[e.get("type").toUpperCase()]||r.SORT.TYPE.OTHER;0===(n=o-(r.SORT.TYPE[t.get("type").toUpperCase()]||r.SORT.TYPE.OTHER))&&o===r.SORT.TYPE.DOCUMENT&&(e.get("documentType")&&t.get("documentType")&&(n=(r.SORT.DOCUMENTTYPE[e.get("documentType").toUpperCase()]||r.SORT.TYPE.OTHER)-(r.SORT.DOCUMENTTYPE[t.get("documentType").toUpperCase()]||r.SORT.TYPE.OTHER)));return n},_sortByRelOriginatedDate:function(e,t){var n=e.get("relOriginated");if(isNaN(n))return-1;var o=t.get("relOriginated");return isNaN(o)?1:n-o},_sortByTitle:function(e,t){var n=e.get("title"),o=t.get("title");return n.localeCompare(o)},_onItemSelect:function(e){this._selectedItems.push(e.id),this._eventCallbacks._debounced._onItemSelect.call(this)},_onItemUnselect:function(e){this._unselectedItems.push(e.id),this._eventCallbacks._debounced._onItemUnselect.call(this)},_eventCallbacks:{_unbounced:{_onItemSelect:function(){this.dispatchEvent("onSelect",{ids:this._selectedItems.slice(0)}),this._selectedItems=[]},_onItemUnselect:function(){this.dispatchEvent("onUnselect",{ids:this._unselectedItems.slice(0)}),this._unselectedItems=[]}},_debounced:{}},_onModelEvent:function(){return"onSelect"===arguments[0]?this._onItemSelect(arguments[1]):"onUnselect"===arguments[0]?this._onItemUnselect(arguments[1]):this._parent.apply(this,arguments)},_debounceTimeouts:[],debounce:function(e,t,n){var o,i=this;return function(){var r=this,s=arguments,a=n&&!o;clearTimeout(o);var c=i._debounceTimeouts.indexOf(o);-1!==c&&i._debounceTimeouts.splice(c,1),o=setTimeout((function(){o=null,n||e.apply(r,s)}),t),i._debounceTimeouts.push(o),a&&e.apply(r,s)}}});return s})),define("DS/IssueAttachmentManager/components/ContextualMenu",["UWA/Controls/Abstract","UWA/Class/Listener","UWA/Class/Promise","UWA/Core","DS/Menu/ContextualMenu","DS/Menu/Menu","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueCommon/commands/CommandsManager","DS/IssueServices/services/PlatformServices","DS/IssueCommon/utils/DocumentUtils","DS/IssueCommon/utils/Utils","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u,m,d){"use strict";var h=e.extend(t,{name:"DS/IssueAttachmentManager/components/ContextualMenu",defaultOptions:{authoring:!0},init:function(e){if(!e.hasOwnProperty("collection")||o.is(e.collection,null)||!(e.collection instanceof s))throw new Error(d.replace(d.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!o.is(e.authoring,"boolean"))throw new Error(d.replace(d.error.common.incorrectInitArgument,{type:"Boolean"}));this._parent(e),this.authoring=this.options.authoring,this.collection=e.collection,this.bo=e.bo,this.customCommands=[];var t=widget.getValue("attachmentManagerPreferences");o.is(t)&&o.is(t.catalogLayout)&&(this.catalogLayout=t.catalogLayout)},register:function(e){var t=this;i.addEventListener(e,{callback:function(e){return t.getCommands()}})},hide:function(){r.hide()},getCommands:function(){var e=this,t=[],i=e.collection.getSelectedItems(),r=i.some((function(e){return e.get("isProcessing")||e.get("isFailed")})),s=!1;o.is(e.bo)&&o.is(e.bo.state)&&"Closed"==e.bo.state&&(s=!0);var c=new n((function(n){(0===i.length||r)&&(t.push({name:"groupByType",title:d.views.Header.Iconbar.actions.sort.groupByType,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-group"},data:null,state:e.collection.groupByType?"selected":"unselected",action:{callback:function(){e.dispatchEvent("request:groupByType")}}}),t.push({name:"sort",title:d.views.Header.Iconbar.actions.sort.dropdown,type:"PushItem",data:null,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sorting"},submenu:[{name:"sortAscDate",title:d.views.Header.Iconbar.actions.sort.ascDate,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-num-asc"},data:null,state:"ascending"===e.collection.sortOrder&&"date"===e.collection.sortMode?"selected":"unselected",action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"date"})}}},{name:"sortDescDate",title:d.views.Header.Iconbar.actions.sort.descDate,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-num-desc"},state:"descending"===e.collection.sortOrder&&"date"===e.collection.sortMode?"selected":"unselected",data:null,action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"date"})}}},{name:"sortAscTitle",title:d.views.Header.Iconbar.actions.sort.ascTitle,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-alpha-asc"},data:null,state:"ascending"===e.collection.sortOrder&&"title"===e.collection.sortMode?"selected":"unselected",action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"title"})}}},{name:"sortDescTitle",title:d.views.Header.Iconbar.actions.sort.descTitle,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-alpha-desc"},state:"descending"===e.collection.sortOrder&&"title"===e.collection.sortMode?"selected":"unselected",data:null,action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"title"})}}}]}),t.push({name:"switchCatalogLayout",title:(e.catalogLayout+1)%2==1?d.views.Header.Iconbar.actions.switchCatalogLayout_TV:d.views.Header.Iconbar.actions.switchCatalogLayout_GV,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x "+((e.catalogLayout+1)%2==1?"fonticon-view-small-thb":"fonticon-view-list")},data:null,action:{callback:function(){e.dispatchEvent("request:catalogSwitchLayout")}}}),t.push({type:"SeparatorItem"})),n()})),l=null,h=!1;return c=c.then((function(){var e=i.map((function(e){return e.id}));if(e.length>0)return a.getDocuments(e).then((function(e){l=e.data[0],h=e.data.every((function(e){return"TRUE"===e.dataelements.isDocumentType}))}));n.resolve()})).then((function(){return i.length>0?r?n.resolve():a.getCompatibleApps(i).then((function(n){var r=[];if(r=o.is(n,"array")&&n.length>0?n.map((function(t){var n={name:t.name,type:"PushItem",title:t.text,action:{callback:function(){e.dispatchEvent("request:openWith",{app:t,objects:i,arguments:arguments,context:this})}}};return null!=t.fonticon?n.fonticon={content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+t.fonticon}:t.className&&1==t.className.contains("app-widget")?n.icon={iconPath:t.icon,className:"issue-widget"}:n.icon=t.icon,n})):[{name:"openWithNoApps",type:"PushItem",title:d.views.Header.Iconbar.actions.openWithNoApps}],t.push({name:"openWith",type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-menu-dot"},title:d.views.Header.Iconbar.actions.openWith,submenu:r}),t.push({type:"SeparatorItem"}),h&&1===i.length&&null!==l){var a={data:l,from:"attachments",menu:e,selected:i};t.push({name:"Preview",title:d.views.preview,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-eye"},data:null,action:{callback:function(){u.preview(a)}}}),t.push({type:"SeparatorItem"})}if(h&&!s&&e.authoring&&1===i.length&&"image"===i[0].get("documentType")&&(t.push({name:"annotate",title:d.views.Header.Iconbar.actions.annotate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-highlighter"},data:null,action:{callback:function(){e.dispatchEvent("request:annotate")}}}),t.push({type:"SeparatorItem"})),h&&!s&&1===i.length&&null!==l){var c={data:l,from:"attachments",menu:e,selected:i[0]};""===l.relateddata.files[0].dataelements.locker?t.push({name:"Edit",title:d.views.edit,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-pencil"},data:null,action:{callback:function(){u.edit(c)}}}):(t.push({name:"UndoEdit",title:d.views.undoEdit,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-undo"},data:null,action:{callback:function(){u.undoEdit(c)}}}),t.push({name:"Update",title:d.views.update,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-upload"},data:null,action:{callback:function(){u.update(c)}}}))}if(h&&!s&&e.authoring&&1===i.length&&"image"===i[0].get("documentType")&&t.push({name:"setAsPrimary",title:d.views.Header.Iconbar.actions.setAsPrimary,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-star"},data:null,action:{callback:function(){e.dispatchEvent("request:setAsPrimary",{item:i[0],lock:!0})}}}),t.push({name:"CollaborativeLifecycle",title:d.views.collaborativeLifecycle,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-collaborative-lifecycle-management"},data:null,action:{callback:function(){require(["DS/IssueComponents/external/CollaborativeLifecycle"],(function(e){for(var t=[],n=0;n<i.length;n++)t.push(i[n].id);e.execute(t)}))}}}),h&&null!==l){c={data:l,from:"attachments",menu:e,selected:i};t.push({name:"download",title:d.views.Header.Iconbar.actions.download,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-download"},data:null,action:{callback:function(){u.download(c)}}})}1===i.length&&t.push({name:"information",title:d.views.information,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-info-open-in-a-new-window"},data:null,action:{callback:function(){m.viewProperties(i[0].id,"3DSpace")}}}),e.authoring&&!s&&(t.push({name:"detach",title:d.views.Header.Iconbar.actions.detachDelete.detach,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-remove"},data:null,action:{callback:function(){e.dispatchEvent("request:detach")}}}),t.push({type:"SeparatorItem"})),e.authoring&&!s&&(t.push({type:"SeparatorItem"}),t.push({name:"delete",title:d.views.Header.Iconbar.actions.detachDelete.delete,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-trash"},data:null,action:{callback:function(){e.dispatchEvent("request:delete")}}}))})):(e.authoring&&!s&&(t.push({name:"annotate",title:d.views.Header.Iconbar.actions.annotate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-highlighter"},data:null,action:{callback:function(){e.dispatchEvent("request:annotate")}}}),t.push({type:"SeparatorItem"})),n.resolve())})),c=(c=c.then((function(){(e.authoring&&0===i.length||r)&&!s&&t.push({name:"attachFrom3DX",title:d.views.Header.Iconbar.actions.attach.from3DX,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-plus"},data:null,action:{callback:function(){e.dispatchEvent("request:attachFrom3DX")}}},{name:"attachFromLocalDisk",title:d.views.Header.Iconbar.actions.attach.fromLocalDisk,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-upload"},data:null,action:{callback:function(){e.dispatchEvent("request:attachFromLocalDisk")}}})}))).then((function(){return(0===i.length||r)&&e.customCommands.length>0&&(t.push({type:"SeparatorItem"}),e.customCommands.forEach((function(e){t.push(e)}))),t}))}});return h})),define("DS/IssueAttachmentManager/views/Attachment",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/Controls/ResponsiveThumbnailView","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/Menu/ContextualMenu","DS/IssueAttachmentManager/components/Item","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u,m,d,h){"use strict";var g={CSS:{ELEMENTS:{THUMBNAIL:"isu-am-attachment-thumbnail",ERROR:"isu-am-attachment-error",ERRORICON:"fonticon-alert isu-am-attachment-error-icon",ERRORTEXT:"isu-am-attachment-error-text",ICON:"isu-am-attachment-icon",TITLE:"isu-am-attachment-title",DATE:"isu-am-attachment-date",RELOWNER:"isu-am-attachment-rel-owner",PRIMARYICON:"fonticon-star isu-am-attachment-primary-icon",CANCELBUTTON:"isu-am-attachment-cancelbtn default btn-sm",DISCARDBUTTON:"isu-am-attachment-discardbtn default btn-sm"},STATUS:{FAILED:"is-failed",PRIMARY:"is-primary",PROCESSING:"is-processing",CANCELABLE:"is-cancelable"}}};return e.extend({name:"DS/IssueAttachmentManager/views/Attachment",tagName:"div",className:"isu-am-attachment",_logger:null,model:null,id:null,elements:{thumbnail:null,icon:null,title:null,date:null,relOwner:null},init:function(e){if(!e.hasOwnProperty("model")||t.is(e.model,null)||!(e.model instanceof m))throw new Error(h.replace(h.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/Item"}));let n=e.model._attributes;new c({id:n.id,primaryAttachment:"",attachments:[n]}).select(n.id),this._parent(e)},setup:function(e){s.start(this.name+" setup"),this._parent(e),this._logger=n.getLogger(this.name),this.id=this.model.id,this.container.id=this.id,this.listeners={},this.listenTo(this.model,"onSelect",this._onSelect),this.listenTo(this.model,"onUnselect",this._onUnselect),this.listenTo(this.model,"onChange:thumbnailUrl",this._onChangeThumbnailUrl),this.listenTo(this.model,"onChange:contentUrl",this._onChangeContentUrl),this.listenTo(this.model,"onChange:iconUrl",this._onChangeIconUrl),this.listenTo(this.model,"onChange:title",this._onChangeTitle),this.listenTo(this.model,"onChange:dispType",this._onChangeDispType),this.listenTo(this.model,"onChange:isProcessing",this._onChangeIsProcessing),this.listenTo(this.model,"onChange:isCancelable",this._onChangeIsCancelable),this.listenTo(this.model,"onChange:isFailed",this._onChangeIsFailed),this.listenTo(this.model,"onChange:isPrimary",this._onChangeIsPrimary),this.listenTo(this.model,"onChange:requestProgress",this._onChangeRequestProgress),s.end(this.name+" setup")},render:function(){var e=this;s.start(this.name+" render"),this.container.setAttribute("id","attachment-"+this.id),this.container.setData("id",this.id),!0===this.model.get("isProcessing")&&(this.container.addClassName(g.CSS.STATUS.PROCESSING),i.mask(this.container)),!0===this.model.get("isCancelable")&&this.container.addClassName(g.CSS.STATUS.CANCELABLE),!0===this.model.get("isPrimary")&&this.container.addClassName(g.CSS.STATUS.PRIMARY);["thumbnail","error","icon","title","date","relOwner"].forEach((function(n){e.elements[n]=t.createElement("div",{class:g.CSS.ELEMENTS[n.toUpperCase()]}).inject(e.container)}));var n=t.createElement("img",{src:this.model.get("thumbnailUrl")||"",alt:this.model.get("dispType"),title:this.model.get("dispType")});n.inject(e.elements.thumbnail),e.elements.thumbnailImg=n,t.createElement("span",{class:"fonticon "+g.CSS.ELEMENTS.PRIMARYICON,title:h.views.Attachment.isPrimary}).inject(e.container);var r=t.createElement("img",{src:this.model.get("iconUrl")||"",alt:"",title:"",styles:{height:"17px"}});r.inject(e.elements.icon),e.elements.iconImg=r,e.elements.date.innerHTML=this.model.get("relOwner").fullName,e.elements.titleTxt=t.createElement("div",{styles:{"margin-left":"2px",display:"inline"}}).inject(e.elements.title),e.elements.titleTxt.innerHTML=t.String.escapeHTML(this.model.get("title")),e.elements.titleTxt.title=t.String.escapeHTML(this.model.get("title"));var a=t.createElement("span",{class:"fonticon fonticon-chevron-down wux-ui-3ds",styles:{padding:"2px","font-size":"1.3em","margin-top":"3px"}});return t.is(e.options.bContextmenu)&&1!=e.options.bContextmenu||(a.inject(e.elements.relOwner),t.is(e.model.get("listener"))||"added"==e.model.get("listener")||(e.listeners.chevron=a.addEventListener("click",this._onChevronClick.bind(this)),e.model.set("listener","added"))),e.elements.cancelBtn=new o({value:h.views.Attachment.cancelButton,className:g.CSS.ELEMENTS.CANCELBUTTON}),e.elements.cancelBtn.addEvent("onClick",(function(){if(e.model.get("request")){var n=e.model.get("request");t.is(n.cancel,"function")&&(n.cancel(),e.model.set("isFailed",!0),e.model.set("isProcessing",!1))}})),e.elements.cancelBtn.inject(this.container),e.elements.discardBtn=new o({value:h.views.Attachment.discardButton,className:g.CSS.ELEMENTS.DISCARDBUTTON}),e.elements.discardBtn.addEvent("onClick",(function(){e.model.collection&&(e.model.collection.unselectAll(),e.model.collection.remove(e.model))})),e.elements.discardBtn.inject(this.container),s.end(this.name+" render"),this},_onSelect:function(){this.container.addClassName("selected")},_onUnselect:function(){this.container.removeClassName("selected")},_onChangeThumbnailUrl:function(e){this.elements.thumbnailImg.src=e.get("thumbnailUrl")},_onChangeContentUrl:function(e){"image"===e.get("documentType")&&(this.elements.thumbnailImg.src=e.get("contentUrl"))},_onChangeIconUrl:function(e){this.elements.iconImg.src=e.get("iconUrl")},_onChangeTitle:function(e){this.elements.title.innerHTML=t.String.escapeHTML(e.get("title")),this.elements.title.title=t.String.escapeHTML(e.get("title"))},_onChangeDispType:function(e){this.elements.thumbnailImg.title=e.get("dispType"),this.elements.thumbnailImg.alt=e.get("dispType")},_onChangeIsProcessing:function(e){!0===e.get("isProcessing")?(this.container.addClassName(g.CSS.STATUS.PROCESSING),i.mask(this.container)):("image"===e.get("documentType")&&void 0!==e.get("contentUrl")&&null!==e.get("contentUrl")?this.elements.thumbnailImg.src=e.get("contentUrl"):void 0!==e.get("thumbnailUrl")&&null!==e.get("thumbnailUrl")&&(this.elements.thumbnailImg.src=e.get("thumbnailUrl")),void 0!==e.get("iconUrl")&&null!==e.get("iconUrl")&&(this.elements.iconImg.src=e.get("iconUrl")),this.elements.date.innerHTML=this.model.get("relOwner").fullName,this.elements.titleTxt.innerHTML=t.String.escapeHTML(this.model.get("title")),this.elements.titleTxt.title=t.String.escapeHTML(this.model.get("title")),this.container.id=e.get("id"),this.container.setAttribute("id","attachment-"+e.get("id")),this.container.setData("id",e.get("id")),this.container.removeClassName(g.CSS.STATUS.PROCESSING),this.container.removeClassName(g.CSS.STATUS.CANCELABLE),i.unmask(this.container))},_onChangeIsCancelable:function(e){!0===e.get("isCancelable")?!0===e.get("isProcessing")&&this.container.addClassName(g.CSS.STATUS.CANCELABLE):this.container.removeClassName(g.CSS.STATUS.CANCELABLE)},_onChangeIsFailed:function(e){!0===e.get("isFailed")?(this.container.addClassName(g.CSS.STATUS.FAILED),t.createElement("span",{class:"fonticon "+g.CSS.ELEMENTS.ERRORICON}).inject(this.elements.error),t.createElement("span",{html:h.views.Attachment.Failures.Upload,class:g.CSS.ELEMENTS.ERRORTEXT}).inject(this.elements.error)):this.container.removeClassName(g.CSS.STATUS.FAILED)},_onChangeIsPrimary:function(e){!0===e.get("isPrimary")?this.container.addClassName(g.CSS.STATUS.PRIMARY):this.container.removeClassName(g.CSS.STATUS.PRIMARY)},_onChangeRequestProgress:function(e){if(e.get("isProcessing")&&i.isMasked(this.container)){var t=this.container.getElement(".mask").getElement("span.text");t&&(t.innerHTML=Math.floor(100*e.get("requestProgress"))+"%")}},_onRelOwnerIconClick:function(){r.getUserProfile(this.model.get("relOwner").user)},_onChevronClick:function(e){var t=this;t.model.collection.unselectAll(),t.model.select();var n=new Event("contextmenu",{bubbles:!0,cancelable:!1});n.pageX=e.pageX,n.pageY=e.pageY,t.elements.relOwner.dispatchEvent(n),e.stopPropagation()}})})),define("DS/IssueAttachmentManager/views/Catalog",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Scroller","DS/IssueComponents/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u,m,d){"use strict";var h={CSS:{LAYOUTS:{1:"isu-am-catalog-grid",2:"isu-am-catalog-list"},ELEMENTS:{PLACEHOLDER:"isu-am-catalog-placeholder",PLACEHOLDERTEXT:"isu-am-catalog-placeholdertext",PLACEHOLDERTEXTAREA:"isu-am-catalog-placeholdertextarea",PLACEHOLDERBUTTONS:"isu-am-catalog-placeholder-buttons",PLACEHOLDERBUTTON:"isu-am-catalog-placeholder-button",SCROLLCONTENT:"isu-am-catalog-scroll-content",SCROLLCONTAINER:"isu-am-catalog-scroll-container"},CATALOG:{PADDINGRIGHT:5,PADDINGLEFT:5},ATTACHMENT:{CLASSNAME:"isu-am-attachment",WIDTH:150,MARGINRIGHT:10,MARGINLEFT:0},STATUS:{EMPTY:"is-empty"}}};return e.extend({name:"DS/IssueAttachmentManager/views/Catalog",tagName:"div",className:"isu-am-catalog",_logger:null,defaults:{layout:1},defaultOptions:{authoring:!0},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof a))throw new Error(d.replace(d.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(d.replace(d.error.common.incorrectInitArgument,{type:"Boolean"}));if(e.hasOwnProperty("contextualMenu")&&(t.is(e.contextualMenu,null)||!(e.contextualMenu instanceof c)))throw new Error(d.replace(d.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/ContextualMenu"}));if(e.hasOwnProperty("layout")){if(!t.is(e.layout,"number"))throw new Error(d.replace(d.error.common.incorrectInitArgument,{type:"Number"}));if(!h.CSS.LAYOUTS.hasOwnProperty(e.layout))throw new Error(d.replace(d.error.views.Catalog.unsupportedLayout,{layout:e.layout}))}this._parent(e)},setup:function(e){var o=this;s.start(o.name+" setup"),o._parent(e),o._logger=n.getLogger(o.name),this.contextualMenu=e.contextualMenu,this.layout=t.is(e.layout)?e.layout:this.defaults.layout,this.authoring=this.options.authoring,o.searchAttachmentCommand=e.searchAttachmentCommand||{getSearchQuery:function(){return Promise.resolve("")}},this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this)),this.listenTo(this.collection,"onSort",this._onCollectionSort.bind(this)),this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this)),this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this)),this.listenTo(this.collection,"onReset",this._onCollectionReset.bind(this)),s.end(o.name+" setup")},render:function(){var e=this;s.start(this.name+" render"),this.container.addClassName(h.CSS.LAYOUTS[this.layout]),0===e.collection.size()&&this.container.addClassName(h.CSS.STATUS.EMPTY),e.elements.placeholder=t.createElement("div",{class:h.CSS.ELEMENTS.PLACEHOLDER}),e.elements.placeholder.inject(e.container),t.createElement("div",{class:h.CSS.ELEMENTS.PLACEHOLDERTEXT,html:t.createElement("textarea",{html:e.authoring?d.views.Placeholder.text:d.views.Placeholder.textNoAuthoring,class:h.CSS.ELEMENTS.PLACEHOLDERTEXTAREA,rows:2,readonly:!0}),title:e.authoring?d.views.Placeholder.text:d.views.Placeholder.textNoAuthoring}).inject(e.elements.placeholder);var n=t.createElement("div",{class:h.CSS.ELEMENTS.PLACEHOLDERBUTTONS});(n.inject(e.elements.placeholder),e.authoring)&&(new o({className:h.CSS.ELEMENTS.PLACEHOLDERBUTTON+" primary",value:d.views.Placeholder.addExisting,events:{onClick:function(){e.searchAttachmentCommand.getSearchQuery().then((function(t){e.dispatchEvent("request:attachFrom3DX",t)}))}}}).inject(n),new o({className:h.CSS.ELEMENTS.PLACEHOLDERBUTTON+" default",value:d.views.Placeholder.upload,events:{onClick:function(){e.dispatchEvent("request:attachFromLocalDisk")}}}).inject(n));this.elements.scrollContent=t.createElement("div",{class:h.CSS.ELEMENTS.SCROLLCONTENT}).inject(this.container),this.elements.scrollContainer=t.createElement("div",{class:h.CSS.ELEMENTS.SCROLLCONTAINER}).inject(e.container);var r=!1;this.contextualMenu instanceof c&&(r=!0),this.attachments={};for(var a=0;a<this.collection.size();a++){var l=this.collection.at(a),m=new u({bContextmenu:r,model:l,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[l.id]=m,m.container.style.order=a,m.container.setAttribute("draggable",!0),m.render().inject(this.elements.scrollContent)}e._scroller=new i({element:this.elements.scrollContent}).inject(this.elements.scrollContainer);var g=function(t){t.target.getParents().some((function(e){return e.hasOwnProperty("hasClassName")&&e.hasClassName(h.CSS.ATTACHMENT.CLASSNAME)}))||e.collection.unselectAll()};return e.container.addEventListener("click",g),e.container.addEventListener("contextmenu",g),this.contextualMenu instanceof c&&this.contextualMenu.register(this.container),s.end(this.name+" render"),this},switchLayout:function(e){if(!t.is(e,"number"))throw new Error(d.replace(d.error.common.incorrectArgument,{type:"Number"}));if(!h.CSS.LAYOUTS.hasOwnProperty(e))throw new Error(d.replace(d.error.views.Catalog.unsupportedLayout,{layout:e}));return this.container.removeClassName(h.CSS.LAYOUTS[this.layout]),this.container.addClassName(h.CSS.LAYOUTS[e]),this.layout=e,widget.setValue("attachmentLayout",e),this.dispatchEvent("onSwitchLayout",{layout:this.layout}),this},goToNext:function(e){var t=this;if(this.collection.size()){var n=-1;if(null!==this.currentPos&&void 0!==this.currentPos&&(n=this.collection.indexOf(this.currentPos)),n<this.collection.size()-1)for(var o=1,i=n>=0?this.collection.size()-n:2;o<i;){var r=this.attachments[this.collection.at(n+o).id];r.model.get("isProcessing")?o++:(e&&r.model.selected&&void 0!==t.currentPos&&t.currentPos.selected&&t.currentPos.unselect(),this._goTo(r,e),t.currentPos=r.model,o=this.collection.size())}}return this},goToPrevious:function(e){var t=this;if(this.collection.size()){var n=1;if(null!==this.currentPos&&void 0!==this.currentPos&&(n=this.collection.indexOf(this.currentPos)),n>0)for(var o=1;o<n+1;){var i=this.attachments[this.collection.at(n-1).id];i.model.get("isProcessing")?o++:(e&&i.model.selected&&void 0!==t.currentPos&&t.currentPos.selected&&t.currentPos.unselect(),this._goTo(i,e),t.currentPos=i.model,o=n+1)}}return this},goToNextLine:function(e){if(2!==this.layout){if(this.collection.size()){var t=this.container.clientWidth,n=h.CSS.CATALOG.PADDINGRIGHT+h.CSS.CATALOG.PADDINGLEFT,o=h.CSS.ATTACHMENT.WIDTH,i=h.CSS.ATTACHMENT.MARGINRIGHT+h.CSS.ATTACHMENT.MARGINLEFT,r=Math.floor((t-n)/(o+i)),s=-r;if(null!==this.currentPos&&void 0!==this.currentPos?s=this.collection.indexOf(this.currentPos):this.currentPos=this.collection.at(0),s<this.collection.size()-r){var a=this.attachments[this.collection.at(s+r).id],c=this.attachments[this.currentPos.id];this._goTo(a,e,c,!0),e&&(c.shiftKeySelected=!0),this.currentPos=a.model}}}else this.goToNext(e)},goToPreviousLine:function(e){if(2!==this.layout){if(this.collection.size()){var t=this.container.clientWidth,n=h.CSS.CATALOG.PADDINGRIGHT+h.CSS.CATALOG.PADDINGLEFT,o=h.CSS.ATTACHMENT.WIDTH,i=h.CSS.ATTACHMENT.MARGINRIGHT+h.CSS.ATTACHMENT.MARGINLEFT,r=Math.floor((t-n)/(o+i)),s=+r;if(null!==this.currentPos&&void 0!==this.currentPos?s=this.collection.indexOf(this.currentPos):this.currentPos=this.collection.at(0),s>=r){var a=this.attachments[this.collection.at(s-r).id],c=this.attachments[this.currentPos.id];this._goTo(a,e,c,!0),e&&(c.shiftKeySelected=!0),this.currentPos=a.model}}}else this.goToPrevious(e)},_goTo:function(e,t,n,o){var i=this;if(t&&n){var r=this.collection.getSelectedItems().map((function(e){return i.attachments.hasOwnProperty(e.id)?i.attachments[e.id]:void 0}));if(r.length>0)if(1===r.length&&r[0]===e)e.model.select();else{var s=[],a=Math.min(e.container.style.order,n.container.style.order),c=Math.max(e.container.style.order,n.container.style.order);for(var l in i.attachments)i.attachments.hasOwnProperty(l)&&a<=i.attachments[l].container.style.order&&i.attachments[l].container.style.order<=c&&!1===i.attachments[l].model.get("isProcessing")&&(o&&(i.attachments[l].shiftKeySelected=!0),s.push(l));var u=i.collection.getSelectedItems().filter((function(e){return i.attachments[e.id].shiftKeySelected&&-1===s.indexOf(e.id)})).map((function(e){return e.id}));s=s.concat(u);var m=this.collection.toArray().map((function(e){return e.id}));m=m.filter((function(e){return s.indexOf(e)<0})),this.collection.unselect(m),this.collection.select(s)}else e.model.select()}else{if(!t){var d=this.collection.toArray().map((function(e){return e.id})),h=d.indexOf(e.id);d.splice(h,1),this.collection.unselect(d)}e.model.selected||e.model.select()}},_onAttachmentClick:function(e){var t=this;if(this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var n=this.attachments[e.currentTarget.getData("id")];if(e.ctrlKey)n.model.selected&&"contextmenu"!==e.type?n.model.unselect():(n.model.select(),n.shiftKeySelected=!1);else if(e.shiftKey){var o=this.attachments[this.currentPos.id];t._goTo(n,!0,o,!0)}else{var i="contextmenu"===e.type&&n.model.selected||"dragstart"===e.type&&n.model.selected;t._goTo(n,i),n.shiftKeySelected=!1}t.currentPos=n.model}},_onAttachmentDrag:function(e){if(this._onAttachmentClick(e),this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var t=this.attachments[e.currentTarget.getData("id")];e.dataTransfer.setDragImage(t.container,e.offsetX,e.offsetY);var n=this.collection.getSelectedItems().map((function(e){return{options:{id:e.id,type:e.get("type"),name:e.get("title")}}})),o=r.setDroppableData(n),i={type:o.type,data:JSON.stringify(o.data)};e.dataTransfer.setData(i.type,i.data)}},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array")){var n=this.collection.getSelectedItems();if(n.length>0){1===n.length&&(this.current=this.attachments[n[0].id]);var o=null;if(this.currentPos&&this.attachments[this.currentPos.id]?o=this.attachments[this.currentPos.id]:this.current&&(o=this.current),o){var i={x:this._scroller._infos.x.scrollPosition,xSize:this._scroller._infos.x.offsetSize,y:this._scroller._infos.y.scrollPosition,ySize:this._scroller._infos.y.offsetSize},r={x:o.container.offsetLeft,y:o.container.offsetTop};r.y<=i.y?this._scroller.scrollToElement(o.container,"top"):r.y>=i.y+i.ySize&&this._scroller.scrollToElement(o.container,"bottom")}}else this.current=null}else{var s=d.replace(d.error.common.incorrectArgument,{type:"Array"});this._logger.error(s)}},_onCollectionUnselect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array")){for(var n=0;n<e.ids.length;n++){var o=e.ids[n];this.attachments.hasOwnProperty(o)&&(this.attachments[o].model.shiftKeySelected=!1)}0===this.collection.getSelectedItems().length&&(this.current=null)}else{var i=d.replace(d.error.common.incorrectArgument,{type:"Array"});this._logger.error(i)}},_onCollectionSort:function(){for(var e=0;e<this.collection.size();e++){var t=this.collection.at(e);this.attachments[t.id].container.style.order=e}},_onCollectionAdd:function(e){var t=!1;this.contextualMenu instanceof c&&(t=!0);var n=new u({bContextmenu:t,model:e,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[e.id]=n,n.container.style.order="-1",n.render().inject(this._scroller.getInnerElement()),this.container.toggleClassName(h.CSS.STATUS.EMPTY,0===this.collection.size())},_onCollectionRemove:function(e){this.attachments.hasOwnProperty(e.id)&&(this.attachments[e.id].destroy(),delete this.attachments[e.id],this.currentPos&&this.currentPos.id===e.id&&(this.currentPos=null)),this.container.toggleClassName(h.CSS.STATUS.EMPTY,0===this.collection.size())},_onCollectionReset:function(){for(var e=Object.keys(this.attachments),t=0;t<e.length;t++)this.attachments[e[t]].destroy(),delete this.attachments[e[t]];var n=!1;this.contextualMenu instanceof c&&(n=!0),this.attachments={};for(var o=0;o<this.collection.size();o++){var i=this.collection.at(o),r=new u({bContextmenu:n,model:i,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[i.id]=r,r.container.style.order=o,r.render().inject(this.elements.scrollContent)}this.container.toggleClassName(h.CSS.STATUS.EMPTY,0===this.collection.size())}})})),define("DS/IssueAttachmentManager/views/UploadDialog",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/ENOFloatingPanel/ENOFloatingPanel","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/views/Catalog","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l){"use strict";var u={DIALOG:"isu-am-upload-dialog"};return e.extend({name:"DS/IssueAttachmentManager/views/UploadDialog",tagName:"div",className:u.DIALOG,_logger:null,defaultOptions:{},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof s))throw new Error(l.replace(l.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/Collection"}));this._parent(e)},setup:function(e){var t=this;r.start(t.name+" setup"),t._parent(e),t._logger=n.getLogger(t.name),r.end(t.name+" setup")},render:function(){var e=this;r.start(this.name+" render"),e.catalog=new a({collection:e.collection,layout:2}).render();var n=e.collection.size(),s=0,c=0,m=l.replace(l.views.UploadDialog.title,{number:e.collection.size(),success:0,failure:0});e.modal=new o({animate:!0,autocenter:!0,closable:!0,limitParent:!1,overlay:!1,resizable:!0,visible:!0,className:u.DIALOG,title:m,header:null,body:e.catalog,events:{onClose:function(){n===s+c?(e.modal.destroy(),t.is(e.status)&&t.is(e.status.loading)&&e.status.loading.hide()):e.modal.hide()}}}),e.modal.inject(e.container),e.status=i.get("status"),t.is(e.status)&&t.is(e.status.loading)?(e.status.loading.start({isClickable:!0}),e.status.loading.update(m),e.status.loading.setClickListener((function(){e.modal.show(),n===s+c&&e.status.loading.hide()})),e.modal.hide()):e.status=null;for(var d=function(){var o,i=this;!1===i.get("isProcessing")&&(1===i.get("requestProgress")&&!0!==i.get("isFailure")?s++:i.get("isFailure")&&c++),n===s+c?(o=s===n?l.replace(l.views.UploadDialog.uploadSuccess,{total:n}):l.replace(l.views.UploadDialog.uploadFailure,{total:n,success:s,failure:c}),t.is(e.status)&&t.is(e.status.loading)&&e.status.loading.stop(o)):(o=l.replace(l.views.UploadDialog.title,{total:n,success:s,failure:c}),t.is(e.status)&&t.is(e.status.loading)&&e.status.loading.update(o)),e.modal.setTitle(o)},h=0;h<n;h++){var g=e.collection.at(h);e.listenTo(g,"onChange:isProcessing",d.bind(g))}return r.end(this.name+" render"),this}})})),define("DS/IssueAttachmentManager/views/Header",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Iconbar","DS/UIKIT/Mask","DS/ENOjquery/ENOjquery","DS/PlatformAPI/PlatformAPI","DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","DS/IssueCommon/utils/DocumentUtils","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u,m,d,h,g,p,f,v,E){"use strict";var T={ELEMENTS:{INFO:"isu-am-header-info",INFO_REL_OWNER_CONTAINER:"isu-am-header-info-rel-owner-ctn",INFO_REL_OWNER_ICON:"isu-am-header-info-rel-owner-icon",INFO_REL_OWNER_TEXT:"isu-am-header-info-rel-owner-txt",INFO_DATE_CONTAINER:"isu-am-header-info-date-ctn",INFO_DATE_ICON:"fonticon-calendar isu-am-header-info-date-icon",INFO_DATE_TEXT:"isu-am-header-info-date-txt",INFO_MULTI_CONTAINER:"isu-am-header-info-multi-ctn",INFO_MULTI_ICON:"fonticon-docs isu-am-header-info-multi-icon",INFO_MULTI_TEXT:"isu-am-header-info-multi-txt",ICONBAR_CTN:"isu-am-header-iconbar-ctn",ICONBAR_CTN_FIX:"isu-am-header-iconbar-ctn-fix",ICONBAR_TOGGLE_ACTIVE:"active",ANNOTATION:"isu-am-annotation"},STATUS:{EMPTY:"is-empty",MULTI:"is-multi"}},S="ENX3DIR_AP",y="ENXISSU_AP",I=e.extend({name:"DS/IssueAttachmentManager/views/Header",tagName:"div",className:"isu-am-header",_logger:null,defaultOptions:{authoring:!0,annotationPreLaunchCallback:function(){},annotationSaveCallback:function(){},annotationExitCallback:function(){}},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof h))throw new Error(E.replace(E.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{type:"Boolean"}));if(e.hasOwnProperty("annotationSaveCallback")&&!t.is(e.annotationSaveCallback,"function"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{type:"Function"}));if(e.hasOwnProperty("annotationPreLaunchCallback")&&!t.is(e.annotationPreLaunchCallback,"function"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{type:"Function"}));if(e.hasOwnProperty("annotationExitCallback")&&!t.is(e.annotationExitCallback,"function"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{type:"Function"}));this._parent(e)},setup:function(e){var o=this;m.start(o.name+" setup"),o._parent(e),o._logger=n.getLogger(o.name),o.authoring=o.options.authoring,o.current=null,o.annotation=null,o.listeners={},o.bo=o.options.bo,this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this)),this.listenTo(this.collection,"onChange",(function(){this.hideShowPreviewBtn()}));var i=c.get("eventsHandler");if(o._subscriberId=Math.random().toString(36).substr(2,9),o._eventListeners=[{event:"DS/Object/update",listener:function(e){1==e.data.paths.length&&u.issues.retrieve({data:{objects:[{physicalId:e.data.paths[0]}]}}).then((function(e){var t=e.results[0].body;o.bo=t,o.refresh()}))},conditions:{type:"issue",attributes:["state"]}}],t.is(i))for(var r=0;r<o._eventListeners.length;r++){var s=o._eventListeners[r];s.token=i.subscribe(o._subscriberId,s.event,s.listener.bind(o),s.conditions)}m.end(o.name+" setup")},render:function(){var e=this;m.start(this.name+" render"),this.container.addClassName(T.STATUS.EMPTY),e.elements.info=t.createElement("div",{class:T.ELEMENTS.INFO}),e.elements.iconBarCtn=t.createElement("div",{class:T.ELEMENTS.ICONBAR_CTN}),e.elements.iconBarCtnFixed=t.createElement("div",{class:T.ELEMENTS.ICONBAR_CTN_FIX});var n=[],i=[{name:"openWith",fonticon:"open-menu-dot",text:E.views.Header.Iconbar.actions.openWith,content:{type:"dropdownmenu",options:{items:[{id:"openWithNoApps",text:E.views.Header.Iconbar.actions.openWithNoApps,selectable:!1}],events:{onShow:function(){e._setOpenWithSubMenus(this,e.collection.getSelectedItems())}}}}},{id:"download",fonticon:"download",text:E.views.Header.Iconbar.actions.download,selectable:!0,handler:function(){var t={from:"attachments",selected:e.collection.getSelectedItems()};d.download(t)}}];(n=n.concat(i)).push({id:"setAsPrimary",fonticon:"star",text:E.views.Header.Iconbar.actions.setAsPrimary,selectable:!0,handler:function(){e.dispatchEvent("request:setAsPrimary",{item:e.current,lock:!0})}}),n.push({id:"preview",fonticon:"eye",text:E.preview,selectable:!0,disableItem:!0,handler:function(){e.dispatchEvent("request:preview")}}),e.authoring&&n.push({id:"annotate",fonticon:"highlighter",text:E.views.Header.Iconbar.actions.annotate,selectable:!0,handler:function(){e.dispatchEvent("request:annotate")}}),n.push({id:"detachDelete",fonticon:"trash",text:E.views.Header.Iconbar.actions.detachDelete.title,content:{type:"dropdownmenu",options:{items:[{id:"detach",fonticon:"wux-ui-3ds wux-ui-3ds-1x fonticon-remove",text:E.views.Header.Iconbar.actions.detachDelete.detach,selectable:!1,handler:function(){e.dispatchEvent("request:detach")}},{id:"delete",fonticon:"wux-ui-3ds wux-ui-3ds-1x fonticon-trash",text:E.views.Header.Iconbar.actions.detachDelete.delete,selectable:!1,handler:function(){e.dispatchEvent("request:delete")}}]}}});var r=widget.getValue("attachmentManagerPreferences");t.is(r)&&t.is(r.catalogLayout)||(r={catalogLayout:1});var s=[{className:"divider"},{id:"groupByType",fonticon:"group",text:E.views.Header.Iconbar.actions.sort.groupByType,selectable:!0,content:{type:"dropdownmenu",options:{items:[{id:"groupNone",description:E.views.Header.Iconbar.actions.sort.ascDate,text:E.views.Header.Iconbar.actions.sort.groupBy_None,selected:!e.collection.groupByType,handler:function(){e.dispatchEvent("request:groupByType",{sortByOrder:"None"})}},{id:"groupType",text:E.views.Header.Iconbar.actions.sort.groupBy_Type,description:E.views.Header.Iconbar.actions.sort.ascDate,selected:e.collection.groupByType,handler:function(){e.dispatchEvent("request:groupByType",{sortByOrder:"Type"})}}]}}},{id:"sort",fonticon:"sorting",text:E.views.Header.Iconbar.actions.sort.dropdown,selectable:!0,content:{type:"icondropdown",options:{items:[{id:"sortAscDate",fonticon:"sort-num-asc",description:E.views.Header.Iconbar.actions.sort.ascDate,selected:"ascending"===e.collection.sortOrder&&"date"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"date"})}},{id:"sortDescDate",fonticon:"sort-num-desc",description:E.views.Header.Iconbar.actions.sort.descDate,selected:"descending"===e.collection.sortOrder&&"date"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"date"})}},{id:"sortAscTitle",fonticon:"sort-alpha-asc",description:E.views.Header.Iconbar.actions.sort.ascTitle,selected:"ascending"===e.collection.sortOrder&&"title"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"title"})}},{id:"sortDescTitle",fonticon:"sort-alpha-desc",description:E.views.Header.Iconbar.actions.sort.descTitle,selected:"descending"===e.collection.sortOrder&&"title"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"title"})}}]}}},{id:"switchCatalogLayout",fonticon:r.catalogLayout%2!=1?"view-list":"view-small-thb",text:E.views.Header.Iconbar.actions.switchCatalogLayout,selectable:!0,content:{type:"dropdownmenu",options:{items:[{id:"catalogLayoutGrid",description:E.views.Header.Iconbar.actions.sort.ascDate,text:E.views.Header.Iconbar.actions.switchCatalogLayout_GV,fonticon:"view-list",selected:r.catalogLayout%2!=1,handler:function(){e.dispatchEvent("request:catalogSwitchLayout",{layout:"GridView"})}},{id:"catalogLayoutThumbnail",text:E.views.Header.Iconbar.actions.switchCatalogLayout_TV,fonticon:"view-small-thb",description:E.views.Header.Iconbar.actions.sort.ascDate,selected:r.catalogLayout%2==1,handler:function(){e.dispatchEvent("request:catalogSwitchLayout",{layout:"ThumbnailView"})}}]}}}];return e.authoring&&(n.push({id:"attach_divider",className:"divider"}),n.push({id:"attachFrom3DX",text:E.views.Header.Iconbar.actions.attach.from3DX,fonticon:"plus",selectable:!1,handler:function(){e.dispatchEvent("request:attachFrom3DX")}},{id:"attachFromLocalDisk",fonticon:"upload",text:E.views.Header.Iconbar.actions.attach.fromLocalDisk,selectable:!1,handler:function(){e.dispatchEvent("request:attachFromLocalDisk")}}),n.push({id:"screenshot",fonticon:"camera",text:E.views.Header.Iconbar.actions.screenshotAvailable,selectable:!0,handler:function(){e.dispatchEvent("request:screenshot")}})),e.iconBar=new o({renderTo:e.elements.iconBarCtn,items:n}),e.elements.iconBarCtn.inject(e.container),e.iconBarFix=new o({renderTo:e.elements.iconBarCtnFixed,items:s}),e.elements.iconBarCtnFixed.inject(e.container),e.listenTo(e.iconBar.overflowMenu,"onShow",(function(){e.iconBar.overflowMenu.menus.forEach((function(t){t.parentItem&&"openWith"===t.parentItem.name&&e._setOpenWithSubMenus(t,e.collection.getSelectedItems())}))})),e.refresh(),this.hideShowSnapshotBtn(),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide(),m.end(this.name+" render"),this},refresh:function(){var e=this,n=!1;t.is(e.bo)&&t.is(e.bo.state)&&"Closed"==e.bo.state&&(n=!0),this.iconBar.enableItem("openWith"),this.iconBar.enableItem("download"),this.iconBar.enableItem("detachDelete"),this.iconBar.enableItem("annotate"),this.iconBar.enableItem("setAsPrimary"),this.iconBar.getItem("openWith").elements.container.show(),this.iconBar.getItem("download").elements.container.show(),this.iconBar.getItem("detachDelete").elements.container.show(),this.iconBar.getItem("annotate").elements.container.show(),this.iconBar.getItem("setAsPrimary").elements.container.show();var o=this.collection.getSelectedItems();if(1===o.length)this.current=o[0],this.container.removeClassName(T.STATUS.EMPTY),this.container.removeClassName(T.STATUS.MULTI),"Document"!==this.current.get("type")&&(this.iconBar.disableItem("download"),this.iconBar.getItem("download").elements.container.hide()),"Document"===this.current.get("type")&&"image"===this.current.get("documentType")||(this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide()),!0!==this.current.get("isProcessing")&&!0!==this.current.get("isFailed")||(this.iconBar.disableItem("openWith"),this.iconBar.disableItem("download"),this.iconBar.disableItem("detachDelete"),this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide());else if(o.length>1){this.current=null,this.container.removeClassName(T.STATUS.EMPTY),this.container.addClassName(T.STATUS.MULTI),o.every((function(e){return"Document"===e.get("type")}))||(this.iconBar.disableItem("download"),this.iconBar.getItem("download").elements.container.hide()),o.some((function(e){return!0===e.get("isProcessing")||!0===e.get("isFailed")}))&&(this.iconBar.disableItem("openWith"),this.iconBar.disableItem("download"),this.iconBar.disableItem("detachDelete"),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide()),this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide()}else this.current=null,this.container.addClassName(T.STATUS.EMPTY),this.container.removeClassName(T.STATUS.MULTI),this.iconBar.disableItem("openWith"),this.iconBar.disableItem("download"),this.iconBar.disableItem("detachDelete"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide();n&&(this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.disableItem("detachDelete"),this.iconBar.disableItem("attachFrom3DX"),this.iconBar.disableItem("attachFromLocalDisk"),this.iconBar.disableItem("screenshot"),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("attachFrom3DX").elements.container.hide(),this.iconBar.getItem("attachFromLocalDisk").elements.container.hide(),this.iconBar.getItem("screenshot").elements.container.hide(),this.iconBar.getItem("attach_divider").elements.container.hide()),this.hideShowPreviewBtn(),this.hideShowSnapshotBtn(),this.iconBar.resize(),this.iconBarFix.resize()},_setOpenWithSubMenus:function(e,n){var o=this;e.items.reduce((function(e,t){return e.push(t.id),e}),[]).forEach((function(t){e.removeItem(t)})),Array.isArray(e.menus)&&(e.menus.length=1),p.getCompatibleApps(n).then((function(i){if(t.is(i,"array")&&i.length>0){var r=i.map((function(e){var t={id:e.name,text:e.text,selectable:!1,handler:function(){o.dispatchEvent("request:openWith",{app:e,objects:n,arguments:arguments,context:this})}};return null!=e.fonticon?t.fonticon=e.fonticon:t.icon=e.icon,t}));r.forEach((function(t){e.addItem(t)}))}else e.addItem({id:"openWithNoApps",text:E.views.Header.Iconbar.actions.openWithNoApps,selectable:!1})}))},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))e.ids.length>1||this.collection.getSelectedItems().length,this.refresh();else{var n=E.replace(E.error.common.incorrectArgument,{type:"Array"});this._logger.error(n)}},_onCollectionUnselect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))this.refresh();else{var n=E.replace(E.error.common.incorrectArgument,{type:"Array"});this._logger.error(n)}},hideShowPreviewBtn:function(){var e=this;null==e.iconBar&&null==e.iconBar||(0==e.collection.length?e.iconBar.getItem("preview").elements.container.hide():e.iconBar.getItem("preview").elements.container.show())},hideShowSnapshotBtn:function(){var e=this;null==e.iconBar&&null==e.iconBar||(!!c.get("widget")&&(c.get("widget").name===S||c.get("widget").name===y)?e.iconBar.getItem("screenshot").elements.container.show():e.iconBar.getItem("screenshot").elements.container.hide())}});return I})),define("DS/IssueAttachmentManager/views/Viewer",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/Controls/Button","DS/Controls/Slider","DS/PADUtils/views/PADAlert","DS/UIKIT/Input/Button","DS/IssueCommon/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u,m,d,h,g,p){"use strict";var f=100,v={ELEMENTS:{PLACEHOLDER:"isu-am-viewer-placeholder",PLACEHOLDERTEXT:"isu-am-viewer-placeholdertext",PLACEHOLDERBUTTONS:"isu-am-viewer-placeholder-buttons",PLACEHOLDERBUTTON:"isu-am-viewer-placeholder-button",CONTENT:"isu-am-viewer-content",FOOTERTITLECONTAINER:"isu-am-viewer-footer-titlectn",FOOTERTITLEICON:"isu-am-viewer-footer-titleicon",FOOTERTITLETEXT:"isu-am-viewer-footer-titletxt",FOOTERZOOMCONTAINER:"isu-am-viewer-footer-zoomctn",FOOTERZOOMTXT:"isu-am-viewer-footer-zoomtxt",FOOTERZOOMCMDCONTAINER:"isu-am-viewer-footer-zoomcmdctn",FOOTERZOOMSLIDER:"isu-am-viewer-footer-zoomslider",BODY:"isu-am-viewer-body",CLOSE:"isu-am-viewer-close",CLOSEICON:"fonticon-close",BODYIMAGE:"isu-am-viewer-body-image",BODYVIDEO:"isu-am-viewer-body-video",BODYAUDIO:"isu-am-viewer-body-audio",BODYNOPREVIEW:"isu-am-viewer-body-nopreview",FOOTER:"isu-am-viewer-footer"},STATUS:{EMPTY:"is-empty",MULTI:"is-multi",FAILED:"is-failed"}},E=e.extend({name:"DS/IssueAttachmentManager/views/Viewer",tagName:"div",className:"isu-am-viewer",_logger:null,defaultOptions:{authoring:!0},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof l))throw new Error(p.replace(p.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(p.replace(p.error.common.incorrectInitArgument,{type:"Boolean"}));if(e.hasOwnProperty("contextualMenu")&&(t.is(e.contextualMenu,null)||!(e.contextualMenu instanceof u)))throw new Error(p.replace(p.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/ContextualMenu"}));this._parent(e)},setup:function(e){var t=this;c.start(t.name+" setup"),t._parent(e),t._logger=n.getLogger(t.name),t.contextualMenu=e.contextualMenu,t.current=null,t._listeners={},t.elements={},t.authoring=t.options.authoring,this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this)),this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this)),this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this)),this.refresh=this.debounce(this._refresh.bind(this),f),c.end(t.name+" setup")},render:function(){var e=this;c.start(this.name+" render"),this.container.toggleClassName(v.STATUS.EMPTY,0===this.collection.size()),this.contextualMenu instanceof u&&this.contextualMenu.register(this.container),e.elements.placeholder=t.createElement("div",{class:v.ELEMENTS.PLACEHOLDER}),e.elements.placeholder.inject(e.container),t.createElement("div",{class:v.ELEMENTS.PLACEHOLDERTEXT,html:e.authoring?p.views.Placeholder.text:p.views.Placeholder.textNoAuthoring,title:e.authoring?p.views.Placeholder.text:p.views.Placeholder.textNoAuthoring}).inject(e.elements.placeholder);var n=t.createElement("div",{class:v.ELEMENTS.PLACEHOLDERBUTTONS});(n.inject(e.elements.placeholder),e.authoring)&&(new s({className:v.ELEMENTS.PLACEHOLDERBUTTON+" primary",value:p.views.Placeholder.addExisting,events:{onClick:function(){e.dispatchEvent("request:attachFrom3DX")}}}).inject(n),new s({className:v.ELEMENTS.PLACEHOLDERBUTTON+" default",value:p.views.Placeholder.upload,events:{onClick:function(){e.dispatchEvent("request:attachFromLocalDisk")}}}).inject(n));return e.elements.content=t.createElement("div",{class:v.ELEMENTS.CONTENT}),e.elements.content.inject(e.container),e.elements.closeBtn=t.createElement("div",{class:v.ELEMENTS.CLOSE}).inject(e.elements.content),e.elements.closeBtn.addEventListener("click",(function(){e.dispatchEvent("request:preview")})),t.createElement("span",{class:"fonticon fonticon-x "+v.ELEMENTS.CLOSEICON,title:p.views.Preview.close}).inject(e.elements.closeBtn),e.elements.body=t.createElement("div",{class:v.ELEMENTS.BODY}),e.elements.body.inject(e.elements.content),e.elements.footer=t.createElement("div",{class:v.ELEMENTS.FOOTER}),e.elements.footerTitleCtn=t.createElement("div",{class:v.ELEMENTS.FOOTERTITLECONTAINER}).inject(e.elements.footer),e.elements.footerTitleIcon=t.createElement("img",{class:v.ELEMENTS.FOOTERTITLEICON}),e.elements.footerTitleIcon.inject(e.elements.footerTitleCtn),e.elements.footerTitleTxt=t.createElement("div",{class:v.ELEMENTS.FOOTERTITLETEXT}).inject(e.elements.footerTitleCtn),e.elements.footer.inject(e.elements.content),e.elements.footerZoomCtn=t.createElement("div",{class:v.ELEMENTS.FOOTERZOOMCONTAINER}).inject(e.elements.footer),e.elements.footerZoomTxt=t.createElement("div",{class:v.ELEMENTS.FOOTERZOOMTXT,html:"100%"}).inject(e.elements.footerZoomCtn),e.elements.footerZoomCmdCtn=t.createElement("div",{class:v.ELEMENTS.FOOTERZOOMCMDCONTAINER}).inject(e.elements.footerZoomCtn),e.elements.footerZoomMinus=new o({emphasize:"secondary",type:"button",icon:{iconName:"minus"},onClick:function(){e.elements.footerZoomSlider.value-50>e.elements.footerZoomSlider.minValue?e.elements.footerZoomSlider.value-=50:e.elements.footerZoomSlider.value=e.elements.footerZoomSlider.minValue},allowUnsafeHTMLLabel:!0}).inject(e.elements.footerZoomCmdCtn),e.elements.footerZoomSlider=new i({className:v.ELEMENTS.FOOTERZOOMSLIDER,value:100,minValue:100,maxValue:500,stepValue:2}).inject(e.elements.footerZoomCmdCtn),e.elements.footerZoomSlider.addEventListener("change",(function(t){e.elements.footerZoomTxt.innerHTML=t.dsModel.value+"%",e.elements.bodyImage&&e.elements.bodyImage.setStyle("transform","scale("+t.dsModel.value/100+")")})),e.elements.footerZoomPlus=new o({emphasize:"secondary",type:"button",icon:{iconName:"plus"},onClick:function(){e.elements.footerZoomSlider.value+50<e.elements.footerZoomSlider.maxValue?e.elements.footerZoomSlider.value+=50:e.elements.footerZoomSlider.value=e.elements.footerZoomSlider.maxValue},allowUnsafeHTMLLabel:!0}).inject(e.elements.footerZoomCmdCtn),e.elements.footerZoomReset=new o({emphasize:"secondary",type:"button",icon:{iconName:"refresh"},onClick:function(){e.elements.footerZoomSlider.value=100,e.elements.bodyImage.style.top="0px",e.elements.bodyImage.style.left="0px"},allowUnsafeHTMLLabel:!0}).inject(e.elements.footerZoomCmdCtn),c.end(this.name+" render"),this},destroy:function(){var e=this;e._debounceTimeouts.forEach((function(e){clearTimeout(e)})),e._debounceTimeouts=[],e._parent()},_refresh:function(){var e=this.collection.getSelectedItems();if(this.container.toggleClassName(v.STATUS.EMPTY,0===this.collection.size()),this.container.removeClassName(v.STATUS.MULTI),this.elements.footer.hide(),this.elements.footerTitleCtn.setStyle("max-width","100%"),this.elements.footerZoomCtn.hide(),this._listeners.wheel&&this.elements.content.removeEventListener("wheel",this._listeners.wheel),this.elements.bodyImage&&(this.elements.bodyImage.destroy(),delete this.elements.bodyImage),this.elements.bodyVideo&&(this.elements.bodyVideo.destroy(),delete this.elements.bodyVideo),1===e.length){if(this.current=e[0],this.listenTo(this.current,"onChange:contentUrl",this._onCurrentItemChangeContentUrl),this.container.toggleClassName(v.STATUS.FAILED,this.current.get("isFailed")),this.elements.footer.show(),this.current.get("isFailed")||(this.elements.footerTitleIcon.src=this.current.get("iconUrl"),this.elements.footerTitleIcon.alt=this.current.get("type"),this.elements.footerTitleIcon.title=this.current.get("type")),this.elements.footerTitleTxt.innerHTML=t.String.escapeHTML(this.current.get("title")),this.elements.footerTitleTxt.title=t.String.escapeHTML(this.current.get("title")),this.elements.body.setContent(t.createElement("span",{html:p.views.Viewer.noPreview,class:v.ELEMENTS.BODYNOPREVIEW})),!this.current.get("isFailed")&&!this.current.get("isProcessing")&&"Document"===this.current.get("type"))switch(this.current.get("documentType")){case"image":this._renderBodyForImage();break;case"video":this._renderBodyForVideo();break;case"audio":this._renderBodyForAudio()}}else e.length>1?(this.current=null,this.elements.body.setContent(t.createElement("span",{html:p.views.Viewer.noPreview,class:v.ELEMENTS.BODYNOPREVIEW})),this.container.addClassName(v.STATUS.MULTI)):(this.current=null,this.elements.body.setContent(t.createElement("span",{html:p.views.Viewer.noSelection,class:v.ELEMENTS.BODYNOPREVIEW})))},_renderBodyForImage:function(){var e=this;this.elements.body.empty(),this.elements.bodyImage=t.createElement("div",{class:v.ELEMENTS.BODYIMAGE,title:this.current.get("title")}),this.current.get("contentUrl")&&this.elements.bodyImage.setStyle("background-image","url("+this.current.get("contentUrl")+")"),this.elements.bodyImage.inject(this.elements.body),this.elements.footerZoomSlider.value=100,this.elements.footerZoomCtn.show(),this.elements.footerTitleCtn.setStyle("max-width","calc(100% - "+this.elements.footerZoomCtn.clientWidth+"px)"),e._listeners.wheel=e._onImageMouseWheel.bind(e),this.elements.content.addEventListener("wheel",e._listeners.wheel);var n=0,o=0,i=0,r=0,s=this.elements.bodyImage;s.style.top="0px",s.style.left="0px";e.container.addEventListener("mousedown",(function(t){t.target===s&&(t.preventDefault(),i=t.clientX,r=t.clientY,s.setStyle("z-index","91"),e.container.addEventListener("mouseup",a),s.addEventListener("mousemove",c))}));var a=function(){s.setStyle("z-index","89"),e.container.removeEventListener("mouseup",a),s.removeEventListener("mousemove",c)},c=function(e){e.preventDefault(),n=i-e.clientX,o=r-e.clientY,i=e.clientX,r=e.clientY;var t=s.clientTop-o,a=s.clientLeft-n;s.style.top=parseInt(s.style.top.replace("px",""))+t+"px",s.style.left=parseInt(s.style.left.replace("px",""))+a+"px"}},_renderBodyForVideo:function(){var e=this;a.Mask.mask(e.elements.body),e.current.id.length>0&&d.downloadDocuments([e.current.id]).then((function(n){if(n[0].id===e.current.id){if(1!==n.length)throw new Error("Unexpected downloadDocuments response when rendering Attachment Viewer.");e.elements.body.empty(),e.elements.bodyVideo=t.createElement("video",{class:v.ELEMENTS.BODYVIDEO,src:n[0].downloadUrl,controls:!0}),setTimeout((function(){t.is(e.elements.bodyVideo)&&e.elements.bodyVideo.inject(e.elements.body)}),f),e.current.set("contentUrl",n[0].downloadUrl)}})).catch((function(t){e._logger.error(t),r.displayNotification({msg:p.notifications.Download.failure,eventID:"error"})})).finally((function(){a.Mask.unmask(e.elements.body)}))},_renderBodyForAudio:function(){var e=this;a.Mask.mask(e.elements.body),e.current.id.length>0&&d.downloadDocuments([e.current.id]).then((function(n){if(n[0].id===e.current.id){if(1!==n.length)throw new Error("Unexpected downloadDocuments response when rendering Attachment Viewer.");e.elements.body.empty(),e.elements.bodyVideo=t.createElement("audio",{class:v.ELEMENTS.BODYAUDIO,src:n[0].downloadUrl,controls:!0}),setTimeout((function(){t.is(e.elements.bodyVideo)&&e.elements.bodyVideo.inject(e.elements.body)}),f),e.current.set("contentUrl",n[0].downloadUrl)}})).catch((function(t){e._logger.error(t),r.displayNotification({msg:p.notifications.Download.failure,eventID:"error"})})).finally((function(){a.Mask.unmask(e.elements.body)}))},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))e.ids.length>1||this.collection.getSelectedItems().length,this.refresh();else{var n=p.replace(p.error.common.incorrectArgument,{type:"Array"});this._logger.error(n)}},_onCollectionUnselect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array")){for(var n=0;n<e.ids.length;n++){var o=e.ids[n];this.current&&this.current.id===o&&this.stopListening(this.current,"onChange:contentUrl")}this.refresh()}else{var i=p.replace(p.error.common.incorrectArgument,{type:"Array"});this._logger.error(i)}},_onCollectionAdd:function(){this.refresh()},_onCollectionRemove:function(){this.refresh()},_onCurrentItemChangeContentUrl:function(e){if("image"===this.current.get("documentType"))this.elements.bodyImage.setStyle("background-image","url("+e.get("contentUrl")+")")},_onImageMouseWheel:function(e){var t=this;if(e.preventDefault(),e.deltaY<0){var n=2*-e.deltaY/10;t.elements.footerZoomSlider.value+n<t.elements.footerZoomSlider.maxValue?t.elements.footerZoomSlider.value+=n:t.elements.footerZoomSlider.value=t.elements.footerZoomSlider.maxValue}else{var o=2*e.deltaY/10;t.elements.footerZoomSlider.value-o>t.elements.footerZoomSlider.minValue?t.elements.footerZoomSlider.value-=o:t.elements.footerZoomSlider.value=t.elements.footerZoomSlider.minValue}},_debounceTimeouts:[],debounce:function(e,t,n){var o,i=this;return function(){var r=this,s=arguments,a=n&&!o;clearTimeout(o);var c=i._debounceTimeouts.indexOf(o);-1!==c&&i._debounceTimeouts.splice(c,1),o=setTimeout((function(){o=null,n||e.apply(r,s)}),t),i._debounceTimeouts.push(o),a&&e.apply(r,s)}}});return E})),define("DS/IssueAttachmentManager/views/Slider",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Scroller","DS/IssueComponents/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u,m){"use strict";var d={ELEMENTS:{NAVIGATIONBUTTON:"isu-am-slider-navigation-button",PREVIOUSBUTTON:"isu-am-slider-navigation-button-previous",PREVIOUSICON:"fonticon-chevron-left",NEXTICON:"fonticon-chevron-right",NEXTBUTTON:"isu-am-slider-navigation-button-next",SCROLLCONTENT:"isu-am-slider-scroll-content",SCROLLCONTAINER:"isu-am-slider-scroll-container"}};return e.extend({name:"DS/IssueAttachmentManager/views/Slider",tagName:"div",className:"isu-am-slider",_logger:null,init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof s))throw new Error(m.replace(m.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("contextualMenu")&&(t.is(e.contextualMenu,null)||!(e.contextualMenu instanceof a)))throw new Error(m.replace(m.error.common.incorrectInitArgument,{type:"DS/IssueAttachmentManager/components/ContextualMenu"}));this._parent(e)},setup:function(e){var t=this;r.start(t.name+" setup"),t._parent(e),t._logger=n.getLogger(t.name),this.contextualMenu=e.contextualMenu,this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this)),this.listenTo(this.collection,"onSort",this._onCollectionSort.bind(this)),this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this)),this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this)),this.listenTo(this.collection,"onReset",this._onCollectionReset.bind(this)),r.end(t.name+" setup")},render:function(){r.start(this.name+" render"),this.elements.prevBtn=t.createElement("div",{class:d.ELEMENTS.NAVIGATIONBUTTON+" "+d.ELEMENTS.PREVIOUSBUTTON}).inject(this.container),this.elements.prevBtn.addEventListener("click",this.slideToPrevious.bind(this)),this.elements.prevBtn.hide(),t.createElement("span",{class:"fonticon fonticon-2x "+d.ELEMENTS.PREVIOUSICON}).inject(this.elements.prevBtn),this.elements.nextBtn=t.createElement("div",{class:d.ELEMENTS.NAVIGATIONBUTTON+" "+d.ELEMENTS.NEXTBUTTON}).inject(this.container),this.elements.nextBtn.hide(),this.elements.nextBtn.addEventListener("click",this.slideToNext.bind(this)),t.createElement("span",{class:"fonticon fonticon-2x "+d.ELEMENTS.NEXTICON}).inject(this.elements.nextBtn),this.elements.scrollContent=t.createElement("div",{class:d.ELEMENTS.SCROLLCONTENT}).inject(this.container),this.elements.scrollContainer=t.createElement("div",{class:d.ELEMENTS.SCROLLCONTAINER}).inject(this.container);var e=t.createElement("div",{class:"isu-am-slider-block"});e.style.order=-2,e.inject(this.elements.scrollContent),this.elements.firstEmptyBlock=e;var n=t.createElement("div",{class:"isu-am-slider-block"});n.style.order=this.collection.size()+1,n.inject(this.elements.scrollContent),this.elements.lastEmptyBlock=n,this.attachments={};for(var i=0;i<this.collection.size();i++){var s=this.collection.at(i),c=new l({model:s,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[s.id]=c,c.container.style.order=i,c.container.setAttribute("draggable",!0),c.render().inject(this.elements.scrollContent),this.contextualMenu instanceof a&&this.contextualMenu.register(c.container)}return this._scroller=new o({element:this.elements.scrollContent,options:{snap:!0,momentum:!0,scrollDrag:!0}}).inject(this.elements.scrollContainer),r.end(this.name+" render"),this},refresh:function(){var e=this,t=this.collection.getSelectedItems();if(1===t.length){this.current&&this.current.model.id!==t[0].id&&this.current.container.removeClassName("selected"),this.current=this.attachments[t[0].id],this.current.container.addClassName("selected"),setTimeout((function(){if(e.current){var t=e.collection.indexOf(e.current.model),n=e.container.scrollWidth/2-(0===t?100:140);e._scroller.scrollTo(e.current.container.offsetLeft-n,0,10)}}),200);var n=this.collection.indexOf(this.current.model);0===n?this.elements.prevBtn.hide():this.elements.prevBtn.show(),n===this.collection.size()-1?this.elements.nextBtn.hide():this.elements.nextBtn.show()}else t.length>1?(this.current&&(this.current.container.removeClassName("selected"),this.current=null),this.elements.prevBtn.hide(),this.elements.nextBtn.hide()):(this.elements.prevBtn.hide(),this.elements.nextBtn.hide())},slideToNext:function(){if(this.collection.size()){var e=-1;if(null!==this.current&&void 0!==this.current&&(e=this.collection.indexOf(this.current.model)),e<this.collection.size()-1){var t=this.attachments[this.collection.at(e+1).id];this._slideTo(t)}}return this},slideToPrevious:function(){if(this.collection.size()){var e=1;if(null!==this.current&&void 0!==this.current&&(e=this.collection.indexOf(this.current.model)),e>0){var t=this.attachments[this.collection.at(e-1).id];this._slideTo(t)}}return this},_slideTo:function(e){var t=this.collection.toArray().map((function(e){return e.id})),n=t.indexOf(e.id);if(t.splice(n,1),this.collection.unselect(t),e.model.selected){var o=this.container.scrollWidth/2-100;this._scroller.scrollTo(e.container.offsetLeft-o,0,10)}else e.model.select()},_onAttachmentClick:function(e){if(this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var t=this.attachments[e.currentTarget.getData("id")];this._slideTo(t)}},_onAttachmentDrag:function(e){if(this._onAttachmentClick(e),this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var t=this.attachments[e.currentTarget.getData("id")];e.dataTransfer.setDragImage(t.container,e.offsetX,e.offsetY);var n=[{options:{id:t.model.id,type:t.model.get("type"),name:t.model.get("title")}}],o=i.setDroppableData(n),r={type:o.type,data:JSON.stringify(o.data)};e.dataTransfer.setData(r.type,r.data)}},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))e.ids.length>1||this.collection.getSelectedItems().length,this.refresh();else{var n=m.replace(m.error.common.incorrectArgument,{type:"Array"});this._logger.error(n)}},_onCollectionUnselect:function(e){if(!e.hasOwnProperty("ids")||t.is(e.ids,null)||!t.is(e.ids,"array")){var n=m.replace(m.error.common.incorrectArgument,{type:"Array"});this._logger.error(n)}0===this.collection.getSelectedItems().length&&this.refresh()},_onCollectionSort:function(){for(var e=0;e<this.collection.size();e++){var t=this.collection.at(e);this.attachments[t.id].container.style.order=e}this.elements.lastEmptyBlock.style.order=this.collection.size()+1},_onCollectionAdd:function(e){var t=new l({model:e,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[e.id]=t,t.container.style.order="-1",t.render().inject(this._scroller.getInnerElement()),this.contextualMenu instanceof a&&this.contextualMenu.register(t.container)},_onCollectionRemove:function(e){this.attachments.hasOwnProperty(e.id)&&(this.attachments[e.id].destroy(),delete this.attachments[e.id]),0==Object.keys(this.attachments).length&&this.dispatchEvent("request:showUploadPLaceholder")},_onCollectionReset:function(){for(var e=Object.keys(this.attachments),t=0;t<e.length;t++)this.attachments[e[t]].destroy(),delete this.attachments[e[t]];this.attachments={};for(var n=0;n<this.collection.size();n++){var o=this.collection.at(n),i=new l({model:o,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[o.id]=i,i.container.style.order=n,i.render().inject(this.elements.scrollContent),this.contextualMenu instanceof a&&this.contextualMenu.register(i.container)}}})})),define("DS/IssueAttachmentManager/IssueAttachmentManager",["UWA/Class/View","UWA/Core","UWA/Class/Promise","DS/Logger/Logger","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/UIKIT/SuperModal","DS/ENOjquery/ENOjquery","DS/ENOjqueryUI/jQueryUI","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/UIBehaviors/CommandsRegistry","DS/WebappsUtils/WebappsUtils","DS/WAFData/WAFData","DS/DocumentCreateNew/CreateNew","DS/Windows/ImmersiveFrame","DS/2DAnnotation/2DAnnotation","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Catalog","DS/IssueAttachmentManager/views/Header","DS/IssueAttachmentManager/views/Slider","DS/IssueAttachmentManager/views/Viewer","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],(function(e,t,n,o,i,r,s,a,c,l,u,m,d,h,g,p,f,v,E,T,S,y,I,w,C,A,b,O,N,D,M,P){"use strict";var _={CSS:{ELEMENTS:{IS_EMPTY:"is-empty",TOPFRAME:"isu-am-topframe",CENTERFRAME:"isu-am-centerframe",RIGHTFRAME:"isu-am-rightframe",RIGHTFRAMECOLLAPSER:"isu-am-rightframe-collapser",RIGHTFRAMECOLLAPSERBUTTONCLOSE:"fonticon-chevron-right",RIGHTFRAMECOLLAPSERBUTTONOPEN:"fonticon-chevron-left",INNERRIGHT:"isu-am-innerright",LEFTFRAME:"isu-am-leftframe",BOTTOMFRAME:"isu-am-bottomframe",BOTTOMFRAMECOLLAPSER:"isu-am-bottomframe-collapser",BOTTOMFRAMECOLLAPSERBUTTONCLOSE:"fonticon-chevron-down",BOTTOMFRAMECOLLAPSERBUTTONOPEN:"fonticon-chevron-up",INNERBOTTOM:"isu-am-innerbottom",FRAMECLOSED:"closed",DELETE_DIALOG:"isu-am-delete-confirm-dialog",ANNOTATION:"isu-am-annotation"},LAYOUTS:{CATALOG:{1:"grid",2:"list"},MODE:{1:"full",2:"catalog-only"}},DIMENSIONS:{RIGHTFRAME:{MINWIDTH:185},BOTTOMFRAME:{HEIGHT:150},LEFTFRAME:{MINWIDTH:280}},STATUS:{}},ISSUE_3D_REVIEW:"ENX3DIR_AP",ILLEGAL_CHARACTERS:/[/\\?%*:|"<>]/g},L=e.extend({name:"DS/IssueAttachmentManager/IssueAttachmentManager",tagName:"div",className:"isu-am",_logger:null,defaultOptions:{authoring:!0,mode:1,catalogLayout:1,catalogVisibility:!0,sliderVisibility:!0,annotationPreLaunchCallback:function(){},annotationSaveCallback:function(){},annotationExitCallback:function(){}},init:function(e){var n=this;if(T.preferences.getCreateCtx({policy:"Document Release"}).then((function(e){var t=[];n.avaialbleUserCredentialsForDocument=e,n.avaialbleUserCredentialsForDocument.credentials.forEach((e=>{e.ctxtitle&&t.push(e.ctxname)})),n.ctx=t})),!e.hasOwnProperty("id")||t.is(e.id,null)||t.equals(e.id,"")||!t.is(e.id,"string"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Boolean"}));if(e.hasOwnProperty("mode")){if(!t.is(e.mode,"number"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Number"}));if(!_.CSS.LAYOUTS.MODE.hasOwnProperty(e.mode))throw new Error(P.replace(P.error.manager.unsupportedMode,{mode:e.mode}))}if(e.hasOwnProperty("catalogLayout")){if(!t.is(e.catalogLayout,"number"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Number"}));if(!_.CSS.LAYOUTS.CATALOG.hasOwnProperty(e.catalogLayout))throw new Error(P.replace(P.error.views.Catalog.unsupportedLayout,{layout:e.catalogLayout}))}if(e.hasOwnProperty("catalogVisibility")&&!t.is(e.catalogVisibility,"boolean"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Boolean"}));if(e.hasOwnProperty("sliderVisibility")&&!t.is(e.sliderVisibility,"boolean"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Boolean"}));if(e.hasOwnProperty("groupByType")&&!t.is(e.groupByType,"boolean"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Boolean"}));if(e.hasOwnProperty("sortMode")&&!t.is(e.sortMode,"string"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("sortOrder")&&!t.is(e.sortOrder,"string"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"String"}));if(e.hasOwnProperty("annotationPreLaunchCallback")&&!t.is(e.annotationPreLaunchCallback,"function"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Function"}));if(e.hasOwnProperty("annotationSaveCallback")&&!t.is(e.annotationSaveCallback,"function"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Function"}));if(e.hasOwnProperty("annotationExitCallback")&&!t.is(e.annotationExitCallback,"function"))throw new Error(P.replace(P.error.common.incorrectInitArgument,{type:"Function"}));this._parent(e)},setup:function(e){var t=this;widget.setValue("isAttachmentClosed",!0),y.start(t.name+" setup"),t._parent(e),t.mode=t.options.mode,t.authoring=t.options.authoring,t.catalogLayout=t.options.catalogLayout,t.bottomFrameIsClosed=!t.options.sliderVisibility,t.rightFrameIsClosed=!t.options.catalogVisibility,t._rightFrameWidth=t.options.catalogWidth||_.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH,t._logger=o.getLogger(t.name),y.end(t.name+" setup")},render:function(){var e=this;return y.start(this.name+" render"),e.isLoaded=new n((function(t,n){e._deferred={},e._deferred.resolve=t,e._deferred.reject=n})),e.container.setAttribute("id","isu-am-"+this.id+"-"+Date.now()),e.container.setData("id",this.id),i.mask(e.container),e.attachmentModelOpened=!0,A.getDocumentsFrom(this.id).then((function(n){return e.collection=new I(n),e.options.hasOwnProperty("groupByType")&&(e.collection.groupByType=e.options.groupByType),e.options.hasOwnProperty("sortMode")&&(e.collection.sortMode=e.options.sortMode),e.options.hasOwnProperty("sortOrder")&&(e.collection.sortOrder=e.options.sortOrder),A.getPrimary(e.id).then((function(n){var o=JSON.parse(n);t.is(o.documentId,"string")&&""!==o.documentId&&e.collection.get(o.documentId)&&e.collection.get(o.documentId).set("isPrimary",!0)}))})).then((function(){return new n((function(t,n){return T.issues.retrieve({data:{objects:[{physicalId:e.id}]}}).then((function(n){var o=n.results[0].body;e.issue=o,t(o)}))}))})).then((function(o){if(e.container.empty(),null===e.collection)return n.resolve();e.contextualMenu=new w({bo:o,authoring:e.authoring,collection:e.collection}),e.elements.topFrame=t.createElement("div",{class:_.CSS.ELEMENTS.TOPFRAME}).inject(e.container),e.elements.rightFrame=t.createElement("div",{class:_.CSS.ELEMENTS.RIGHTFRAME+" "+_.CSS.ELEMENTS.FRAMECLOSED}).inject(e.container),e.elements.innerRight=t.createElement("div",{class:_.CSS.ELEMENTS.INNERRIGHT}).inject(e.elements.rightFrame),e.elements.centerFrame=t.createElement("div",{class:_.CSS.ELEMENTS.CENTERFRAME}).inject(e.container),e.elements.bottomFrame=t.createElement("div",{class:_.CSS.ELEMENTS.BOTTOMFRAME}).inject(e.container),e.elements.innerBottom=t.createElement("div",{class:_.CSS.ELEMENTS.INNERBOTTOM}).inject(e.elements.bottomFrame),e.views={},e.views.catalog=new b({authoring:e.authoring,collection:e.collection,contextualMenu:e.contextualMenu,layout:e.catalogLayout}).render().inject(e.elements.innerRight),e.views.header=new O({bo:o,authoring:e.authoring,collection:e.collection,annotationPreLaunchCallback:e.options.annotationPreLaunchCallback,annotationSaveCallback:e.options.annotationSaveCallback,annotationExitCallback:e.options.annotationExitCallback}).render().inject(e.elements.topFrame),e.views.slider=new N({collection:e.collection,contextualMenu:e.contextualMenu}).render().inject(e.elements.innerBottom),e.views.viewer=new D({authoring:e.authoring,collection:e.collection,contextualMenu:e.contextualMenu}).render().inject(e.elements.centerFrame),e.elements.bottomFrame.hide(),e.elements.innerBottom.hide();var r=e.container.getDimensions().innerWidth>_.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+_.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH?e.container.getDimensions().innerWidth-_.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH:_.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH;e.resizable=a(e.elements.rightFrame).resizable({handles:"w",maxWidth:r,minWidth:_.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH,stop:function(t,n){e._rightFrameWidth=n.size.width,e._updatePreferences()}}),e.elements.rightFrameCollapser=t.createElement("div",{class:_.CSS.ELEMENTS.RIGHTFRAMECOLLAPSER}).inject(e.elements.rightFrame),e.elements.rightFrameCollapserButton=t.createElement("span",{class:"fonticon fonticon-2x "+_.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN}).inject(e.elements.rightFrameCollapser),e.elements.rightFrameCollapserButton.addEventListener("click",e._onRightFrameCollapserClick.bind(e)),e.elements.bottomFrameCollapser=t.createElement("div",{class:_.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSER}).inject(e.elements.bottomFrame),e.elements.bottomFrameCollapserButton=t.createElement("span",{class:"fonticon fonticon-2x "+_.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN}).inject(e.elements.bottomFrameCollapser),e.elements.bottomFrameCollapserButton.addEventListener("click",e._onBottomFrameCollapserClick.bind(e)),e.elements.innerScrollerbar=e.getElements(".ui-resizable-handle")[0],e.elements.rightFrameCollapser.hide(),e.elements.rightFrame.hide(),e.elements.centerFrame.hide(),e._currentMode=null,e._toggleMode(e.mode,!0),!0===e.rightFrameIsClosed&&2!==e.mode||e._showRightFrame(),0!==e.collection.size()&&!0!==e.bottomFrameIsClosed&&e._showBottomFrame(),i.unmask(e.container),e.listenTo(e.collection,"onAdd",e.resize.bind(e)),e.listenTo(e.collection,"onRemove",e.resize.bind(e)),e.listenTo(e.collection,"onReset",e.resize.bind(e)),e.listenTo(e.contextualMenu,"request:groupByType",e._onRequestGroupByType.bind(e)),e.listenTo(e.contextualMenu,"request:sort",e._onRequestSort.bind(e)),e.listenTo(e.contextualMenu,"request:catalogSwitchLayout",e._onRequestCatalogSwitchLayout.bind(e)),e.listenTo(e.contextualMenu,"request:downloadFile",e._onRequestDownloadFile.bind(e)),e.listenTo(e.contextualMenu,"request:openWith",e._onRequestOpenWith.bind(e)),e.listenTo(e.contextualMenu,"request:annotate",e._onRequestAnnotate.bind(e)),e.listenTo(e.contextualMenu,"request:setAsPrimary",e._onRequestSetAsPrimary.bind(e)),e.listenTo(e.contextualMenu,"request:detach",e._onRequestDetach.bind(e)),e.listenTo(e.contextualMenu,"request:delete",e._onRequestDelete.bind(e)),e.listenTo(e.contextualMenu,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.contextualMenu,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e.listenTo(e.contextualMenu,"request:updateFile",e._onRequestUpdateFile.bind(e)),e._listeners=[],e._listeners.push({target:e.container,event:"keydown",listener:e._onKeyDown.bind(e)}),e._listeners.push({target:e.container,event:"paste",listener:e._onPasteEvent.bind(e)});for(var s=0;s<e._listeners.length;s++){var c=e._listeners[s];c.target.addEventListener(c.event,c.listener)}e.listenTo(e.views.header,"request:uploadFile",e._onRequestUploadFile.bind(e)),e.listenTo(e.views.header,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.views.header,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e.listenTo(e.views.header,"request:screenshot",e._screenshot.bind(e)),e.listenTo(e.views.header,"request:detach",e._onRequestDetach.bind(e)),e.listenTo(e.views.header,"request:delete",e._onRequestDelete.bind(e)),e.listenTo(e.views.header,"request:downloadFile",e._onRequestDownloadFile.bind(e)),e.listenTo(e.views.header,"request:openWith",e._onRequestOpenWith.bind(e)),e.listenTo(e.views.header,"request:preview",e._onRequestPreview.bind(e)),e.listenTo(e.views.header,"request:annotate",e._onRequestAnnotate.bind(e)),e.listenTo(e.views.header,"request:groupByType",e._onRequestGroupByType.bind(e)),e.listenTo(e.views.header,"request:sort",e._onRequestSort.bind(e)),e.listenTo(e.views.header,"request:catalogSwitchLayout",e._onRequestCatalogSwitchLayout.bind(e)),e.listenTo(e.views.header,"request:updatePreferences",e._updatePreferences.bind(e)),e.listenTo(e.views.header,"request:setAsPrimary",e._onRequestSetAsPrimary.bind(e)),e.listenTo(e.views.catalog,"onSwitchLayout",e._onCatalogSwitchLayout.bind(e)),e.listenTo(e.views.catalog,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.views.catalog,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e.listenTo(e.views.viewer,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.views.viewer,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e.listenTo(e.views.viewer,"request:preview",e._onRequestPreview.bind(e)),e.listenTo(e.views.slider,"request:showUploadPLaceholder",e.onLastAttachmentRemoved.bind(e)),e._addDropEvent(e.views.viewer.container),e._addDropEvent(e.views.catalog.container),e._addDropEvent(e.views.slider.container);var l=e.collection.map((function(e){return e.id}));if(l.length>0){var u=A.fetch(l).then((function(t){if(t.hasOwnProperty("results"))for(var n=0;n<t.results.length;n++){var o=t.results[n].attributes.find((function(e){return"resourceid"===e.name})).value,i=e.collection.get(o);if(i){var r=t.results[n].attributes.find((function(e){return"ds6w:type"===e.name}));r&&r.dispValue&&i.set("dispType",r.dispValue);var s=t.results[n].attributes.find((function(e){return"ds6w:label"===e.name}));s&&s.value&&i.set("title",s.value);var a=t.results[n].attributes.find((function(e){return"type_icon_url"===e.name}));a&&a.value&&i.set("iconUrl",a.value);var c=t.results[n].attributes.find((function(e){return"preview_url"===e.name}));c&&c.value&&i.set("thumbnailUrl",c.value);var l=t.results[n].attributes.find((function(e){return"ds6w:docextension"===e.name}));l&&l.value&&i.setDocumentType(l.value)}}}));return A.downloadDocuments(l).then((function(t){if(null!==e.collection&&t)for(var n=0;n<t.length;n++){var o=t[n].id,i=e.collection.get(o);i&&t[n].downloadUrl&&void 0===t[n].errorMessage&&i.set("contentUrl",t[n].downloadUrl)}})),u}return n.resolve()})).then((function(){null!==e.collection?e.collection.size()>0?(e.container.removeClassName(_.CSS.ELEMENTS.IS_EMPTY),e.collection.sort(),e.listenTo(e.collection,"onSelect",(function(){e.stopListening(e.collection,"onSelect"),e._deferred.resolve()})),e.collection.select(e.collection.at(0).id)):(e.container.addClassName(_.CSS.ELEMENTS.IS_EMPTY),1===e._currentMode&&e._closeRightFrame(),e._deferred.resolve()):e._deferred.resolve()})).catch((function(t){if(t.internalError&&t.internalError.includes("ErrorCode:1500127")){var n=v.getErrorMessage("0");v.displayErrorMessage(n,"error")}else e.attachmentModelOpened&&l.displayNotification({msg:P.notifications.Init.failure,eventID:"error"});i.unmask(e.container),e._deferred.reject(t)})),y.end(this.name+" render"),this},destroy:function(){var e=this;if(t.is(e.contextualMenu,"object")&&e.contextualMenu.hide(),e.collection=null,e.contextualMenu=null,Array.isArray(e._listeners))for(var n=0;n<e._listeners.length;n++){var o=e._listeners[n];o.target.removeEventListener(o.event,o.listener)}e._listeners=[],Object.keys(e.views).forEach((function(t){e.views[t].destroy()})),e.container.empty()},refresh:function(e){var o=this;if(null!=e){if(!t.is(e,"string")||0===e.length){var r=P.replace(P.error.common.incorrectArgument,{type:"String"});return n.reject(Error(r))}this.id=e}return new n((function(e,t){o.isLoaded.then((function(){i.mask(o.container),o.destroy(),o.render(),o.isLoaded.then((function(){o.resize(),o.dispatchEvent("onRefresh"),i.unmask(o.container),e()})).catch(t)}))}))},resize:function(){var e=this;if(e.container.clientWidth>=_.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+_.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH?(e._toggleMode(1),null!==e.collection&&0===e.collection.size()?e._closeRightFrame():null!==e.collection&&0!==e.collection.size()&&e._showRightFrame(),!0!==e.rightFrameIsClosed&&(e.elements.rightFrame.setStyle("transition","width 200ms"),setTimeout((function(){e.elements.rightFrame.setStyle("transition","none")}),200))):e._toggleMode(1),setTimeout((()=>{e.views&&e.views.header&&e.views.header.iconBar&&e.views.header.iconBar.resize()}),200),widget.getValue("isPropertiesFacet")){const e=widget.body.getDimensions();document.getElementsByClassName("isu-am").length>0&&(document.getElementsByClassName("isu-am")[0].style.height=e.height-215+"px")}e.resizeRightFrame()},_closeBottomFrame:function(){var e=this;e.elements.bottomFrame.setStyle("transition","height 200ms"),e.elements.bottomFrame.setStyle("height",0),e.elements.bottomFrameCollapserButton.removeClassName(_.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONCLOSE),e.elements.bottomFrameCollapserButton.addClassName(_.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN),e.bottomFrameIsClosed=!0,setTimeout((function(){e.elements.bottomFrame.setStyle("transition","none")}),200)},_showBottomFrame:function(){var e=this;e.elements.bottomFrame.setStyle("transition","height 200ms"),e.elements.bottomFrame.setStyle("height",_.CSS.DIMENSIONS.BOTTOMFRAME.HEIGHT),e.elements.bottomFrameCollapserButton.removeClassName(_.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN),e.elements.bottomFrameCollapserButton.addClassName(_.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONCLOSE),e.bottomFrameIsClosed=!1,setTimeout((function(){e.elements.bottomFrame.setStyle("transition","none")}),200)},_closeRightFrame:function(){var e=this;e.elements.rightFrame.setStyle("transition","width 200ms"),e.elements.rightFrame.addClassName(_.CSS.ELEMENTS.FRAMECLOSED),e.elements.innerRight.setStyle("visibility","hidden"),e.elements.rightFrame.setStyle("width",0),e.elements.rightFrameCollapserButton.removeClassName(_.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONCLOSE),e.elements.rightFrameCollapserButton.addClassName(_.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN),e.rightFrameIsClosed=!0,setTimeout((function(){e.elements.rightFrame.setStyle("transition","none")}),200)},_showRightFrame:function(){var e=this;e.elements.rightFrame.setStyle("transition","width 200ms"),e.elements.rightFrame.removeClassName(_.CSS.ELEMENTS.FRAMECLOSED),e.elements.innerRight.setStyle("visibility","visible"),e.elements.rightFrame.setStyle("width",e._rightFrameWidth),e.elements.rightFrameCollapserButton.removeClassName(_.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN),e.elements.rightFrameCollapserButton.addClassName(_.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONCLOSE),e.rightFrameIsClosed=!1,setTimeout((function(){e.elements.rightFrame.setStyle("transition","none")}),200)},_toggleMode:function(e){var n=this;if(!t.is(e,"number"))throw new Error(P.replace(P.error.common.incorrectArgument,{type:"Number"}));if(!_.CSS.LAYOUTS.MODE.hasOwnProperty(e))throw new Error(P.replace(P.error.manager.unsupportedMode,{mode:e}));e!==n._currentMode&&(1===e?n.container.removeClassName("isu-am-catalog-only"):2===e&&(n.container.addClassName("isu-am-catalog-only"),n.elements.rightFrame.setStyle("width","calc(100%)"),n.elements.innerRight.setStyle("visibility","visible")),n._currentMode=e)},_onBottomFrameCollapserClick:function(){var e=this;0===e.elements.bottomFrame.clientHeight?e._showBottomFrame():e._closeBottomFrame(),e._updatePreferences()},_onRightFrameCollapserClick:function(){var e=this;0===e.elements.rightFrame.clientWidth?e._showRightFrame():e._closeRightFrame(),e._updatePreferences()},_onKeyDown:function(e){var n=this,o=t.Event.whichKey(e);n._onKeyDownCallbacks.hasOwnProperty(o)&&n._onKeyDownCallbacks[o].call(n,e)},_onKeyDownCallbacks:{right:function(){this.contextualMenu.hide(),this.views.catalog.goToNext()},"shift+right":function(){this.contextualMenu.hide(),this.views.catalog.goToNext(!0)},left:function(){this.contextualMenu.hide(),this.views.catalog.goToPrevious()},"shift+left":function(){this.contextualMenu.hide(),this.views.catalog.goToPrevious(!0)},down:function(){this.contextualMenu.hide(),this.views.catalog.goToNextLine()},"shift+down":function(){this.contextualMenu.hide(),this.views.catalog.goToNextLine(!0)},up:function(){this.contextualMenu.hide(),this.views.catalog.goToPreviousLine()},"shift+up":function(){this.contextualMenu.hide(),this.views.catalog.goToPreviousLine(!0)},"ctrl+a":function(e){e.preventDefault(),this.contextualMenu.hide(),this.collection.selectAll()}},_onRequestUploadFile:function(e){var t=e.fileList;this._addFiles(t);try{var n=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:n,pd3:"AttachmentToolbar",pd4:"FromLocalDesk",pd5:"Issue/"+n+"/AttachmentToolbar/FromLocalDesk"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_initUploadDialog:function(e,t){var n=this,o=new p;o.inject(widget.body),n.iFrame=o;const r=n.ctx.findIndex((e=>{const t=e.split(".");return t[1]===n.issue.organization&&t[2]===n.issue.collaborativeSpace}));var s;r>-1&&(s="ctx::"+n.ctx[r]);var a={parentId:n.collection.id,immersiveFrame:o,parentRelName:"Reference Document",securityContext:s||decodeURIComponent(A.getCurrentSecurityContext()),tenant:A.getCurrentTenant(),tenantUrl:S.get3DSpaceUrl(),onCancel:function(){console.log("onCancel fired before upload starts"),!0===n.annotationSave&&(v.Mask.unmask(widget.body),n.options.annotationExitCallback()),n.iFrame&&n.iFrame.destroy()},onError:function(e){l.displayAdvancedNotification({level:"error",title:e.title,message:e.message,eventID:"error",sticky:!1}),n.annotation&&(n.annotation.destroy(),n.annotation=null);var t=document.getElementsByClassName("isu-am-modal")?document.getElementsByClassName("isu-am-modal")[0]:null;t&&i.unmask(t),v.Mask.unmask(widget.body),n.iFrame&&n.iFrame.destroy()},onDocumentUpload:function(e){!0===n.annotationSave?n._onUploadAnnotation(e,t):n._onUploadDocument(e)}};new g(a).create(e)},_addFiles:function(e){var t=this;t.annotationSave=!1,0===t.collection.size()&&t._showRightFrame(),t._initUploadDialog(e)},_onUploadDocument:function(e){for(var t=this,n=[],o=0,i=[],r=[],s=0;s<e.documents.length;s++){o++;var a=e.documents[s],c=(e.relInfo.parentId,A.parseDocument(a));r.push(a.id),c.relOwner={firstName:u.getUser().firstName,fullName:u.getUser().firstName.trim()+" "+u.getUser().lastName.trim(),lastName:u.getUser().lastName,user:u.getUser().login},c.relOriginated=(new Date).toString();var m=new C(c);m.set("iconUrl",m.get("thumbnailUrl")),t.collection.add(m),i.push(m),n.push(m.id)}o>0&&(T.issues.addAccess({data:{issueId:t.collection.id,documentIds:r}}),o===e.documents.length&&1===i.length&&"image"===i[0].get("documentType")?t._onRequestSetAsPrimary({item:i[0],lock:!1,id:t.collection.id}):t.dispatchEvent("onUpdate",{objects:[{physicalId:t.collection.id}]}),l.displayNotification({msg:P.replace(P.notifications.Upload.successIssue,{count:o,issue:t.issue.title+" ("+t.issue.name+")"}),eventID:"success"}),t.container.removeClassName(_.CSS.ELEMENTS.IS_EMPTY)),n.length&&A.downloadDocuments(n).then((function(e){for(var n=0;n<e.length;n++){var o=e[n].id,i=t.collection.get(o);i&&e[n].downloadUrl&&void 0===e[n].errorMessage&&i.set("contentUrl",e[n].downloadUrl)}})),t.iFrame.destroy()},_onRequestAttachFrom3DX:function(){var e=this,n=E.get("application");if(t.is(n,"object")&&n.isStandalone){var o=E.get("component");if(t.is(o,"object")&&t.is(o.taskManager,"object")){var i=o.taskManager.addObjectsTask((function(n){if(Array.isArray(n)&&null==n.physicalIds){let e=n.map((e=>e.physicalId));(n={}).physicalIds=e}if(Array.isArray(n.physicalIds)){var r=n.physicalIds;A.fetch(r).then((function(n){if(t.is(n.results,"array")&&n.results.length===r.length){var o=n.results.map((function(e){return A.parseFromFetch(e)}));return e._add3DXObjects(o)}throw new Error("Unexpected number of fetch results for attachments.")})).finally((function(){o.unmaskForTask(i)}))}else o.unmaskForTask(i)}),(function(){o.unmaskForTask(i)}));o.maskForTask(i)}}else S.search({title:P.Attach.SearchTitle,default_search_criteria:"",multiSel:!0,callback:function(t){var n=t.map((function(e){return A.parseFromSearch(e)}));try{for(var o=0;o<n.length;o++){var i=n[o];if(i.hasOwnProperty("sourceid_value")){if(i.sourceid_value.includes(":")){const e=i.sourceid_value.split(":");i.sourceid_value=e[0]}var r=i.sourceid_value;if(null!=r&&-1===r.indexOf("3dspace"))throw new Error("Object not supported")}}}catch(e){return l.displayNotification({msg:P.notifications.Drop.unsupported,eventID:"warning"}),null}e._add3DXObjects(n)},cancel:function(){}});try{var r=(o=E.get("component")).getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:r,pd3:"AttachmentToolbar",pd4:"AddExisting",pd5:"Issue/"+r+"/AttachmentToolbar/AddExisting"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestAttachFromLocalDisk:function(){var e=this;A.browseFileFromLocalDisk(e.container).catch((function(t){l.displayNotification({msg:P.replace(P.notifications.BrowseFile.failure),eventID:"error"}),e._logger.error(t)})).then((function(t){e._addFiles(t)}));try{var t=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:t,pd3:"AttachmentToolbar",pd4:"FromLocalDesk",pd5:"Issue/"+t+"/AttachmentToolbar/FromLocalDesk"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_screenshot:function(){var e=this,n=E.get("widget").name===_.ISSUE_3D_REVIEW;if(n&&t.is(e.container)&&t.is(e.container.getParent())&&t.is(e.container.getParent().getParent())&&e.container.getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent().hide(),n){E.get("component").utils.takeAnnotation((function(n){for(var o=new Date,i=n.dataURL,r=n.blob.type,s=(new Date).toLocaleString(),a="screenshot_"+(s=v.formatDate(s,{timePrecision:"sec"}).replace(_.ILLEGAL_CHARACTERS,"-"))+".png",c=atob(i.split(",")[1]),l=new ArrayBuffer(c.length),u=new Uint8Array(l),m=0;m<c.length;m++)u[m]=c.charCodeAt(m);var d=new File([l],a,{type:r,lastModified:o});e._addFiles([d]),t.is(e.container)&&t.is(e.container.getParent())&&t.is(e.container.getParent().getParent())&&e.container.getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent().show()}),(function(){t.is(e.container)&&t.is(e.container.getParent())&&t.is(e.container.getParent().getParent())&&e.container.getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent().show()}),(function(t){e._logger.error(t)}))}else{var o=(i=E.get("component")).taskManager.addTakeScreenshotTask((function(t){for(var n=t.data,r=t.fileName,s=t.fileType,a=t.lastModified,c=atob(n.split(",")[1]),l=new ArrayBuffer(c.length),u=new Uint8Array(l),m=0;m<c.length;m++)u[m]=c.charCodeAt(m);var d=new File([l],r,{type:s,lastModified:a});e._addFiles([d]),i.unmaskForTask(o)}),(function(){i.unmaskForTask(o)}));i.maskForTask(o)}try{var i,r=(i=E.get("component")).getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:r,pd3:"AttachmentToolbar",pd4:"TakeAScreenshot",pd5:"Issue/"+r+"/AttachmentToolbar/TakeAScreenshot"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_add3DXObjects:function(e){var t=this,o=e.filter((function(e){return void 0===t.collection.get(e.id)}));o.length!==e.length&&l.displayNotification({msg:P.replace(P.notifications.Attach.alreadyAttached,{count:e.length-o.length}),eventID:"warning"});var i=o.map((e=>e.id)).indexOf(t.collection.id);if(-1!=i&&(o.splice(i,1),l.displayNotification({msg:P.notifications.Attach.sameIssueAttached,eventID:"error"})),o.length>0){0===t.collection.size()&&t._showRightFrame();for(var r=[],s=0;s<o.length;s++){var a=o[s];a.relOwner={firstName:u.getUser().firstName,fullName:u.getUser().firstName.trim()+" "+u.getUser().lastName.trim(),lastName:u.getUser().lastName,user:u.getUser().login},a.relOriginated=(new Date).toString();var c=new C(a);c.set("isProcessing",!0),r.push(c)}t.collection.add(r,{sort:!1});var m=o.map((function(e){return e.id}));A.connectDocumentsToParent(m,t.collection.id).then((function(e){for(var o=0,i=[],r=[],s=[],a=0;a<e.length;a++){var c=e[a].documentId,u=e[a].response,m=t.collection.get(c);u.success?(o++,i.push(m),r.push(c),"Document"===m.get("type")&&s.push(c)):(m.set("isFailed",!0),m.set("isProcessing",!1))}if(t.collection.sort(),o>0&&(o===e.length&&1===i.length&&"image"===i[0].get("documentType")?t._onRequestSetAsPrimary({item:i[0],lock:!1}):t.dispatchEvent("onUpdate",{objects:[{physicalId:t.collection.id}]}),l.displayNotification({msg:P.replace(P.notifications.Upload.successIssue,{count:o,issue:t.issue.title+" ("+t.issue.name+")"}),eventID:"success"}),t.container.removeClassName(_.CSS.ELEMENTS.IS_EMPTY)),o!==e.length)if(e[e.length-1].response.internalError.includes("Error: #1500028")){var d=v.getErrorMessage("1500028_1");v.displayErrorMessage(d,"error")}else l.displayNotification({msg:P.replace(P.notifications.Attach.failure,{count:e.length-o}),eventID:"error"});var h=[n.resolve()];r.length>0&&h.push(A.fetch(r).then((function(e){for(var n=0;n<e.results.length;n++){var o=e.results[n].attributes.find((function(e){return"resourceid"===e.name})).value,i=t.collection.get(o);if(i){var r=e.results[n].attributes.find((function(e){return"ds6w:type"===e.name}));r&&r.dispValue&&i.set("dispType",r.dispValue);var s=e.results[n].attributes.find((function(e){return"ds6w:label"===e.name}));s&&s.value&&i.set("title",s.value);var a=e.results[n].attributes.find((function(e){return"owner"===e.name})),c=e.results[n].attributes.find((function(e){return"ds6w:responsible"===e.name}));a&&a.value&&c&&c.value&&i.set("owner",{user:a.value,fullName:c.value,firstName:"",lastName:""});var l=e.results[n].attributes.find((function(e){return"ds6w:docextension"===e.name}));l&&l.value&&i.setDocumentType(l.value),i.set("isProcessing",!1)}}})).catch((function(e){l.displayNotification({msg:P.replace(P.notifications.Fetch.failure),eventID:"error"}),t._logger.error(e)}))),s.length>0&&h.push(A.downloadDocuments(s).then((function(e){for(var n=0;n<e.length;n++){var o=e[n].id,i=t.collection.get(o);i&&e[n].downloadUrl&&void 0===e[n].errorMessage&&i.set("contentUrl",e[n].downloadUrl)}})).catch((function(e){l.displayNotification({msg:P.replace(P.notifications.Download.failure),eventID:"error"}),t._logger.error(e)})))})).catch((function(e){t._logger.error(e)}))}try{var d=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:d,pd3:"AttachmentToolbar",pd4:"AddExisting",pd5:"Issue/"+d+"/AttachmentToolbar/AddExisting"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestOpenWith:function(e){var n=e.objects,o=e.app,i=e.context,r=e.arguments,s=E.get("component");if(t.is(s,"object")&&t.is(s.utils,"object")&&t.is(s.utils.setTypesCallbackForOFW,"function")){var a=n.reduce((function(e,t){return e.push(t.id),e}),[]);s.utils.setTypesCallbackForOFW(a)}o.handler.apply(i,r);try{var c=(s=E.get("component")).getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:c,pd3:"AttachmentToolbar",pd4:"OpenWith",pd5:"Issue/"+c+"/AttachmentToolbar/OpenWith"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestDownloadFile:function(){var e=this,n=e.collection.getSelectedItems().map((function(e){return e.id}));n.length>0&&A.downloadDocuments(n,n.length>1).then((function(e){var n=e[0].downloadUrl,o=E.get("application");if(t.is(o,"object")&&o.isStandalone){var i=t.createElement("a");document.body.appendChild(i),i.style="display: none",i.href=n,i.download=e[0].fileName,i.click()}else{var r=t.createElement("a",{id:"download-image",target:"_blank"});r.href=n;var s=document.createEvent("MouseEvents");s.initEvent("click",!1,!0),r.dispatchEvent(s)}})).catch((function(t){l.displayNotification({msg:P.replace(P.notifications.Download.failure),eventID:"error"}),e._logger.error(t)}));try{var o=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:o,pd3:"AttachmentToolbar",pd4:"Download",pd5:"Issue/"+o+"/AttachmentToolbar/Download"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestPreview:function(){if((e=this).collection.length>0){var e=this,t=widget.getValue("isAttachmentClosed");1==t?(e.elements.centerFrame.show(),e.elements.innerBottom.show(),e.elements.bottomFrame.show(),e.elements.rightFrameCollapser.show(),e.elements.rightFrame.setStyles({width:"185px"}),t=!1,widget.setValue("isAttachmentClosed",t),e.elements.innerScrollerbar.show()):0==widget.getValue("isAttachmentClosed")&&(e.elements.centerFrame.hide(),e.elements.innerBottom.hide(),e.elements.bottomFrame.hide(),e.elements.rightFrameCollapser.hide(),e.elements.rightFrame.setStyles({width:"100%"}),t=!0,e.elements.innerRight.setStyle("visibility","visible"),widget.setValue("isAttachmentClosed",t),e.elements.innerScrollerbar.hide())}try{var n=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:n,pd3:"AttachmentToolbar",pd4:"Preview",pd5:"Issue/"+n+"/AttachmentToolbar/Preview"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestAnnotate:function(){var e=this,t=E.get("widget")||window.widget;v.Mask.mask(t.body),e.options.annotationPreLaunchCallback.call(e);var o=e.collection.getSelectedItems()[0];new n((function(t,n){var i={className:_.CSS.ELEMENTS.ANNOTATION,saveCallback:e._annotationSaveCallback.bind(e),exitCallback:e._annotationExitCallback.bind(e)};o&&o.id.length>0&&o.get("contentUrl")?A.downloadDocuments([o.id]).then((function(e){if(1!==e.length||e[0].id!==o.id)throw new Error("Unexpected downloadDocuments response when launching Annotation from Attachment.");o.set("contentUrl",e[0].downloadUrl),i.imageURL=o.get("contentUrl"),t(i)})).catch(n):(null!==e.annotationCanvasTarget&&void 0!==e.annotationCanvasTarget?i.captureTarget=e.annotationCanvasTarget:null!==e.annotationCanvasDefaultDimensions&&void 0!==e.annotationCanvasDefaultDimensions&&(i.defaultDimensions=e.annotationCanvasDefaultDimensions),t(i))})).then((function(n){var o=new f(n);return o.render(),o.isLoaded.then((function(){o.container.inject(t.body),e.annotation=o}))})).catch((function(t){e.annotation&&(e.annotation.destroy(),e.annotation=null),l.displayNotification({msg:P.replace(P.notifications.Annotation.initFailure),eventID:"error"}),e._logger.error(t)})).finally((function(){v.Mask.unmask(t.body)}));try{var i=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:i,pd3:"AttachmentToolbar",pd4:"NewAnnotation",pd5:"Issue/"+i+"/AttachmentToolbar/NewAnnotation"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_annotationSaveCallback:function(e){var t=this,n=E.get("widget")||window.widget;t.annotationSave=!0,v.Mask.mask(n.body),t.annotation.immersiveFrame.elements.container.hide();var o=(new Date).toLocaleString();o=v.formatDate(o,{timePrecision:"sec"}).replace(_.ILLEGAL_CHARACTERS,"-");var i=P.replace(P.annotate.defaultName,{date:o}),r=new File([e.blob],i,{type:"image/png",lastModified:Date.now()});t._initUploadDialog([r],e)},_onUploadAnnotation:function(e,t){var o=this,i=E.get("widget")||window.widget,r=o.collection.id,s=[];try{if(e&&e.documents&&e.documents.length>0&&e.documents[0].id){var a=e.documents[0];return s.push(a.id),T.issues.addAccess({data:{issueId:r,documentIds:s}}),A.setAsPrimary(a.id,r).then((function(e){o.dispatchEvent("onUpdate",{objects:[{physicalId:r}]});var t=JSON.parse(e);a.id===t.documentId&&l.displayNotification({msg:P.notifications.SetAsPrimary.success,eventID:"info"}),o.refresh()}),(function(e){e.message.search("Access Denied")?l.displayNotification({msg:P.notifications.SetAsPrimary.Restricted,eventID:"error"}):l.displayNotification({msg:P.notifications.SetAsPrimary.failure,eventID:"error"}),o.annotation._logger.error(e)}))}return n.reject(new Error("Unexpected empty response for upload."))}catch{}finally{o.options.annotationSaveCallback(t),v.Mask.unmask(i.body),o.annotation.destroy(),o.annotation=null,o.iFrame.destroy()}},_annotationExitCallback:function(e){this.options.annotationExitCallback(e),this.annotation.destroy(),this.annotation=null},_onRequestDetach:function(){for(var e=this,t=e.collection.getSelectedItems(),o=[],i=0;i<t.length;i++){var r=t[i];r.set("isProcessing",!0),o.push(r.id)}e.collection.unselectAll(),A.disconnectDocumentsFromParent(o,e.collection.id).then((function(t){for(var o=0,i=[],r=[],s=0;s<t.length;s++){var a=t[s].documentId,c=t[s].parentId,u=t[s].response,m=e.collection.get(a);u.success?(o++,r.push(a),!0===m.get("isPrimary")&&i.push(A.unsetAsPrimary(e.collection.id)),e.collection.remove(m)):m.set("isProcessing",!1)}if(o>0&&(T.issues.removeAccess({data:{issueId:c,documentIds:r}}),e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]}),l.displayNotification({msg:P.replace(P.notifications.Detach.success,{count:o}),eventID:"success"})),o!==t.length){var d=v.getErrorMessage("10");v.displayErrorMessage(d,"error")}i.length>0&&n.all(i).then((function(){e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]})})),0===e.collection.size()&&(e.onLastAttachmentRemoved(),e.container.addClassName(_.CSS.ELEMENTS.IS_EMPTY),1===e._currentMode&&e._closeRightFrame())})).catch((function(t){l.displayNotification({msg:P.replace(P.notifications.Detach.failure),eventID:"error"}),e._logger.error(t)}));try{var s=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:s,pd3:"AttachmentToolbar",pd4:"Delete",pd5:"Issue/"+s+"/AttachmentToolbar/Delete"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestDelete:function(){var e=this;new s({renderTo:e.container,className:_.CSS.ELEMENTS.DELETE_DIALOG}).confirm(P.Delete.confirm.text,P.Delete.confirm.title,(function(t){if(t){for(var o=e.collection.getSelectedItems(),i=[],r=0;r<o.length;r++){var s=o[r];s.set("isProcessing",!0),i.push(s.id)}e.collection.unselectAll(),A.deleteDocuments(i).then((function(t){for(var o=0,i=[],r=[],s=0;s<t.length;s++){var a=t[s].documentId,c=t[s].response,u=e.collection.get(a);c.success?(o++,r.push(a),!0===u.get("isPrimary")&&i.push(A.unsetAsPrimary(e.collection.id)),e.collection.remove(u)):u.set("isProcessing",!1)}o>0&&(T.issues.removeAccess({data:{issueId:e.collection.id,documentIds:r}}),e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]}),l.displayNotification({msg:P.replace(P.notifications.Delete.success,{count:o}),eventID:"success"})),o!==t.length&&l.displayNotification({msg:P.replace(P.notifications.Delete.failure,{count:t.length-o}),eventID:"error"}),i.length>0&&n.all(i).then((function(){e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]})})),0===e.collection.size()&&(e.onLastAttachmentRemoved(),e.container.addClassName(_.CSS.ELEMENTS.IS_EMPTY),1===e._currentMode&&e._closeRightFrame())})).catch((function(t){l.displayNotification({msg:P.replace(P.notifications.Delete.failure),eventID:"error"}),e._logger.error(t)}))}}),P.Delete.confirm.okButton,P.Delete.confirm.cancelButton)},_onRequestGroupByType:function(e){this.collection.groupByType=!this.collection.groupByType,t.is(e)&&(this.catalogLayout="None"!=e.sortByOrder),this.collection.sort(),this._updatePreferences(),t.is(this.views.header.iconBarFix.getItem("groupByType").content.component)&&(this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupNone").elements.container.toggleClassName("selectable"),this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupNone").elements.container.toggleClassName("selected"),this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupType").elements.container.toggleClassName("selectable"),this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupType").elements.container.toggleClassName("selected"));try{var n=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:n,pd3:"AttachmentToolbar",pd4:"GroupBy",pd5:"Issue/"+n+"/AttachmentToolbar/GroupBy"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestSort:function(e){this.collection.sortOrder=e.sortOrder,this.collection.sortMode=e.sortMode,this.collection.sort(),this._updatePreferences();var t="sort"+("ascending"===e.sortOrder?"Asc":"Desc")+e.sortMode.charAt(0).toUpperCase()+e.sortMode.slice(1);this.views.header.iconBarFix.getItem("sort").content.component.setActiveItem(t)},_onRequestCatalogSwitchLayout:function(e){this.catalogLayout=this.views.catalog.layout%2+1,t.is(e)&&(this.catalogLayout="ThumbnailView"==e.layout?1:2),this.views.catalog.switchLayout(this.catalogLayout),this._updatePreferences();try{var n=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:n,pd3:"AttachmentToolbar",pd4:"SortAttachments",pd5:"Issue/"+n+"/AttachmentToolbar/SortAttachments"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onCatalogSwitchLayout:function(){if((this.views.catalog.layout+1)%2==1){this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-small-thb",!1),this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-list",!0),t.is(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component)&&(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.addClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.addClassName("selected"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.removeClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.removeClassName("selected"));try{var e=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:e,pd3:"AttachmentToolbar",pd4:"ThumbnailView",pd5:"Issue/"+e+"/AttachmentToolbar/ThumbnailView"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}}else{this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-small-thb",!0),this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-list",!1),t.is(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component)&&(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.removeClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.removeClassName("selected"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.addClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.addClassName("selected"));try{e=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:e,pd3:"AttachmentToolbar",pd4:"GridView",pd5:"Issue/"+e+"/AttachmentToolbar/GridView"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}}this.contextualMenu.catalogLayout=this.views.catalog.layout},_onRequestSetAsPrimary:function(e){var n=this,o=n.collection.id,i=e.item,r=e.lock;t.is(e.id,"string")&&(o=e.id),n.views.header.iconBar.disableItem("setAsPrimary");var s=n.collection.filter((function(e){return!0===e.get("isPrimary")})),a=s.some((function(e){return e.get("id")===i.get("id")}));i.set("isProcessing",!0),a?A.unsetAsPrimary(n.collection.id).then((function(){i.set("isPrimary",!1),n.dispatchEvent("onUpdate",{objects:[{physicalId:o}]}),l.displayNotification({msg:P.notifications.UnsetAsPrimary.success,eventID:"info"})})).catch((function(e){if(e.includes("business object' does not exist")){var t=v.getErrorMessage("0");v.displayErrorMessage(t,"error")}else l.displayNotification({msg:P.notifications.UnsetAsPrimary.failure,eventID:"error"});n._logger.error(e)})).finally((function(){i.set("isProcessing",!1),n.views.header.iconBar.enableItem("setAsPrimary")})):A.setAsPrimary(i.get("id"),o,r).then((function(e){var t=JSON.parse(e);if(i.get("id")===t.documentId){for(var r=0;r<s.length;r++)s[r].set("isPrimary",!1);i.set("isPrimary",!0),n.dispatchEvent("onUpdate",{objects:[{physicalId:o}]}),l.displayNotification({msg:P.notifications.SetAsPrimary.success,eventID:"info"})}})).catch((function(e){if(e.message&&e.message.search("Access Denied"))l.displayNotification({msg:P.notifications.SetAsPrimary.Restricted,eventID:"error"});else if(e.includes("business object' does not exist")){var t=v.getErrorMessage("0");v.displayErrorMessage(t,"error")}else l.displayNotification({msg:P.notifications.SetAsPrimary.failure,eventID:"error"});n._logger.error(e)})).finally((function(){i.set("isProcessing",!1),n.views.header.iconBar.enableItem("setAsPrimary")}));try{var c=E.get("component").getCurrentView();v.cloudProbeUtils.sendIMCommandsTrackerEvent({options:{pd1:"Issue",pd2:c,pd3:"AttachmentToolbar",pd4:"Primary",pd5:"Issue/"+c+"/AttachmentToolbar/Primary"}}),v.cloudProbeUtils.sendIssueFacetsTrackerEvent({options:{pd1:"AttachmentToolbar"}})}catch(e){}},_onRequestUpdateFile:function(e){var n=this,o=n.collection.id,i=e.item,r=e.lock;t.is(e.id,"string")&&(o=e.id),n.views.header.iconBar.disableItem("setAsPrimary");var s=n.collection.filter((function(e){return!0===e.get("isPrimary")}));i.set("isProcessing",!0),"image"==i.get("documentType")?A.setAsPrimary(i.get("id"),o,r).then((function(e){var t=JSON.parse(e);if(i.get("id")===t.documentId){for(var r=0;r<s.length;r++)s[r].set("isPrimary",!1);i.set("isPrimary",!0),n.dispatchEvent("onUpdate",{objects:[{physicalId:o}]}),n.refresh(),l.displayNotification({msg:P.notifications.SetAsPrimary.success,eventID:"info"})}})).catch((function(e){if(e.message&&e.message.search("Access Denied"))l.displayNotification({msg:P.notifications.SetAsPrimary.Restricted,eventID:"error"});else if(e.includes("business object' does not exist")){var t=v.getErrorMessage("0");v.displayErrorMessage(t,"error")}else l.displayNotification({msg:P.notifications.SetAsPrimary.failure,eventID:"error"});n._logger.error(e)})).finally((function(){i.set("isProcessing",!1),n.views.header.iconBar.enableItem("setAsPrimary")})):(n.dispatchEvent("onUpdate",{objects:[{physicalId:o}]}),n.refresh())},_onDrop:function(e){var n=this;e.preventDefault(),e.stopPropagation();var o=A.parseFromDragEvent(e);if(o)if(o.hasOwnProperty("files")&&o.files instanceof FileList)n._addFiles(o.files);else if(v.isValid3DXContent(o)){var i=o.data.items.map((function(e){return e.objectId}));A.fetch(i).then((function(e){if(!t.is(e.results,"array"))throw new Error("Unexpected empty fetch results.");var o=e.results.map((function(e){return A.parseFromFetch(e)}));n._add3DXObjects(o)})).catch((function(e){l.displayNotification({msg:P.replace(P.notifications.Attach.failure,{count:i.length}),eventID:"error"}),n._logger.error(e)}))}else l.displayNotification({msg:P.notifications.Drop.unsupported,eventID:"warning"});else l.displayNotification({msg:P.notifications.Drop.unsupported,eventID:"warning"})},_onPasteEvent:function(e){e.preventDefault(),e.stopPropagation();var t=e.clipboardData.items;if(void 0!==t&&t.length>0){for(var n=[],o=0;o<t.length;o++){var i=t[o];if(-1===i.type.indexOf("image"))break;var r=i.getAsFile();n.push(r)}n.length>0&&this._addFiles(n)}},_addDropEvent:function(e){var t=this;if(t.authoring){var n=0;e.addEventListener("drop",(function(){e.removeClassName("dragenter"),t._onDrop.apply(t,arguments)})),e.addEventListener("dragenter",(function(){e.addClassName("dragenter"),n++})),e.addEventListener("dragleave",(function(){--n<=0&&e.removeClassName("dragenter")})),e.addEventListener("mouseenter",(function(){e.hasClassName("dragenter")&&n++})),e.addEventListener("mouseleave",(function(){e.hasClassName("dragenter")&&--n<=0&&e.removeClassName("dragenter")})),e.addEventListener("dragover",(function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy",e.dataTransfer.effectAllowed="copy"}))}},_updatePreferences:function(){var e=this;(E.get("widget")||window.widget).setValue("attachmentManagerPreferences",{mode:e._currentMode,catalogLayout:e.views.catalog.layout,catalogVisibility:!e.rightFrameIsClosed,catalogWidth:e._rightFrameWidth,sliderVisibility:!e.bottomFrameIsClosed,groupByType:e.collection.groupByType,sortMode:e.collection.sortMode,sortOrder:e.collection.sortOrder}),e.views.header.refresh()},resetPADAlert:function(){this.attachmentModelOpened=!1},resizeRightFrame:function(){var e=this;e.collection&&(0==e.collection.size()?(e.elements&&e.elements.rightFrame&&e.elements.rightFrame.hide(),e.elements&&e.elements.centerFrame&&e.elements.centerFrame.show(),widget.setValue("isAttachmentClosed",!0)):e.collection.size()>0&&widget.getValue("isAttachmentClosed")?(e.elements&&e.elements.centerFrame&&e.elements.centerFrame.hide(),e.elements&&e.elements.rightFrame&&e.elements.rightFrame.show(),e.elements.rightFrame.setStyle("width","calc(100%)"),e.elements&&e.elements.rightFrame&&e.elements.innerScrollerbar.hide()):0==widget.getValue("isAttachmentClosed")&&(e.elements.centerFrame.show(),e.elements.rightFrame.show(),e.elements.rightFrame.setStyle("width","185px"),e.elements.rightFrameCollapser.show()))},onLastAttachmentRemoved:function(){this.elements.centerFrame.show(),this.views.header.iconBar.getItem("preview").elements.container.hide()}});return L}));