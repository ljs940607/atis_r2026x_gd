/*! Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/LevelSelector/LevelSelector",["UWA/Core","UWA/Class","UWA/Element","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","css!DS/LevelSelector/LevelSelector.css"],(function(e,t,n,l,o){"use strict";var i,r,a="#285a78",s="#c0c0c0",c="#bebebe",d=20,v=t.extend({init:function(){var t,r,v,u,p,f,m=e.createElement("div",{id:"LevelSelector"}),y=e.createElement("div",{id:"selector-indic",class:"levelselector-indic"}),h=e.createElement("div",{id:"selector-name",class:"levelselector-info levelSelectorTextProperties"}),b=e.createElement("div",{class:"transparent"});b.setStyle("position","absolute");var g,S,C,w,E,T,k,N,x,W,I=0,P=!1,L=!1,A=function(e){var t=!1;return e&&e.type&&("touchmove"===e.type||"touchstart"===e.type||"touchend"===e.type)&&(t=!0),t};function V(e){return L?10*(e+1)+5:14*e+10}function j(){if(x&&x.backgroundColor){var e=new o.Color(x.backgroundColor);255*e.getHSL().l>120?h.removeClassName("white"):h.addClassName("white"),h.setStyle("background-color","rgb("+255*e.r+","+255*e.g+","+255*e.b+")")}}var D,H,q=function(){var e;function t(e,t,n,l){e.forEach((function(e){n?e.addClassName(t):e.removeClassName(t)})),l&&l()}return function(n,l,o){clearTimeout(e),e=void 0,l?(t(n,"transparent",l),!0!==i?e=setTimeout((function(){t(n,"hidden",l,o)}),100):t(n,"hidden",l,o)):(t(n,"hidden",l),!0!==i?setTimeout((function(){t(n,"transparent",l,o)}),10):t(n,"transparent",l,o))}}(),M=function(t){if(t&&u){var n=parseInt(t.id.replace("levelSelector-",""),10),l=t.getElement("canvas");if(!l)return;var o=V(n),i=l.getContext("2d");i.clearRect(0,0,d,o),i.lineWidth=k!==n||C&&C===w?1:2,i.strokeStyle=k===n?p:c,i.fillStyle=u[n-1].canvasColor?u[n-1].canvasColor:"#dcdcdc";var r=u[n-1].selection;if(t===w){i.lineWidth=1,i.strokeStyle=c,i.fillStyle="notSelectable"===r?s:"#82bedc",i.fillStyle=k===n?f:i.fillStyle,t===C&&(i.fillStyle="notCurrent"===r?a:"notSelectable"===r?s:p);var v=e.is(S);y.setStyles({"border-bottom-color":v?i.fillStyle:"","border-top-color":v?"":i.fillStyle}),h.setStyle("border-color",i.fillStyle)}else C&&C===w&&C!==t&&(i.strokeStyle=c);i.beginPath(),i.moveTo(19,1),i.lineTo(19,o-1),i.lineTo(1,o-6),i.lineTo(1,L?1:6),i.lineTo(19,1),i.fill(),i.beginPath(),i.moveTo(19,1),i.lineTo(19,o-1),i.lineTo(1,o-6),i.lineTo(1,L?1:6),i.lineTo(19,1),i.stroke()}},O=function(e,t){if(t&&e){var n=parseInt(e.id.replace("levelSelector-",""),10);t({pathElement:u[n-1].pathElement})}},U=function(t){if(!(t.labelWidth&&t.iconWidth||t.labelWidth&&!t.iconWidth&&!t.icon||!t.labelWidth&&t.iconWidth&&!t.name)){if(!t.labelWidth&&t.name){var n=e.createElement("span",{class:"levelSelectorTextProperties transparent"});n.innerText=t.name,n.inject(b);var l=setInterval((function(){u?n.offsetWidth>0&&(t.labelWidth=n.offsetWidth,n.destroy(),clearInterval(l)):(n.destroy(),clearInterval(l))}),10)}if(!t.iconWidth&&t.icon){var o,i=e.createElement("img",{class:"transparent"});i.src=t.icon,i.inject(b),i.onerror=function(){t.icon="",i.destroy(),clearInterval(o)},o=setInterval((function(){u?i.naturalWidth>0&&(t.iconWidth=i.naturalWidth,i.destroy(),clearInterval(o)):(i.destroy(),clearInterval(o))}),10)}}},B=function(){function t(){I=0,q([y,h],!0,(function(){h.empty(!0),h.innerText="",h.removeAttribute("style"),j()}))}return function(n){if(u){for(var l=0;l<u.length;l++)U(u[l]);var o=w&&n===w?n:N?m.querySelector("#levelSelector-"+k):null;if(o){var i=parseInt(o.id.replace("levelSelector-",""),10),r=u[i-1],a=r.name,s=r.icon,c=e.is(S),d=a&&"string"==typeof a&&a.trim(),v=s&&"string"==typeof s&&s.trim();if(d||v){var p=V(u.length),f=[h];if(L||f.push(y),q(f,!1),L||(y.style.left=30*(i-1)+10+5-y.offsetWidth/2+"px",y.style.top=c?"-15px":p+13+"px",c?y.setStyles({"border-bottom-width":"16px","border-bottom-style":"solid","border-top-width":"","border-top-style":""}):y.setStyles({"border-top-width":"16px","border-top-style":"solid","border-bottom-width":"","border-bottom-style":""})),L||h.setStyles({top:c?"-53px":p+35+"px"}),d){h.innerText=a;var b=r.labelWidth||8*a.length;if(b+=16,v){var C=r.iconWidth||16;h.setStyle("background-image","url("+s+")"),h.setStyle("padding-left",C+10+"px"),b+=C+5}else h.setStyles({"background-image":"","padding-left":""});if(!L){var E=m.offsetLeft,T=E+15-b/2,x=E+30*(i-1)-2+15+b/2,W=30*(i-1)+15-b/2;if(T<0)W-=T;else{var I=g.getParent().getSize().width;x>I&&(W-=x-I)}h.setStyle("left",W+"px")}}else h.innerText="",h.setStyles({"background-image":"","padding-left":""}),e.createElement("img",{class:"levelselector-info-icon",src:s}).inject(h),h.setStyle("left",30*(i-1)-2+"px");var P=m.querySelector(".levels");P&&L&&P.setStyle("top",h.offsetHeight+"px")}else t()}else t()}}}(),X=!1,Y=function(e){T&&"@onViewpointBeginMove"===e.eventType?X=!0:T&&"@onViewpointChange"===e.eventType&&X?m.addClassName("hidden"):T&&"@onViewpointEndMove"===e.eventType?(m.removeClassName("hidden"),X=!1):P&&"@onMoveEvent"===e.eventType&&e.event&&e.event.deltaPosition&&(0!==e.event.deltaPosition.x||0!==e.event.deltaPosition.y)&&++I>=5&&(M(w),O(w,v),w=null,B())},z=function(e){var t=null,n=e.changedTouches[0].clientX,l=e.changedTouches[0].clientY,o=m.getBoundingClientRect();return m.getElements('div[id^="levelSelector"]').some((function(e){var i=e.getPosition(),r=e.getDimensions(),a=i.x+o.left,s=a+r.width,c=i.y+o.top,d=c+r.height;return a<=n&&n<=s&&c<=l&&l<=d&&(t=e,!0)})),t},R=function(e){var n="keydown"===e.type;P=!0,I=0,S=void 0;var l=e.key||e.keyIdentifier,o=e.which||e.keyCode,i=null;if(!n||39!==o&&38!==o&&"ArrowRight"!==l&&"ArrowUp"!==l)if(!n||37!==o&&40!==o&&"ArrowLeft"!==l&&"ArrowDown"!==l){if(13===o||"Enter"===l){if(w)if(n)C=w,M(w);else{var a=C;if(C=null,a&&a===w){if(!a.hasClassName("notselectable")){if(k){var s=parseInt(a.id.replace("levelSelector-",""),10);if("notCurrent"!==u[s-1].selection&&k!==s){var c=m.querySelector("#levelSelector-"+k);k=s,M(c)}}O(a,t)}M(a)}}return}}else w?(i=parseInt(w.id.replace("levelSelector-",""),10),--i<1&&(i=1)):i=u.length;else w?(i=parseInt(w.id.replace("levelSelector-",""),10),++i>u.length&&(i=u.length)):i=1;if(i&&m.querySelector("#levelSelector-"+i)!==w){var d=w;w=m.querySelector("#levelSelector-"+i),M(d),O(d,v),M(w),B(w),O(w,r)}},F=function(e){if(P=!1,0===e.button&&1===e.buttons){if(D=l.subscribe({event:"/VISU/onLeftMouseUp"},(function(e){l.unsubscribe(D),D=void 0,e&&e.from&&0!==e.from.length&&e.from[0].view&&e.from[0].view.className&&(0===e.from[0].view.className.search("level")||0===e.from[0].view.className.search("canvas"))||(C=null)})),S=void 0,M(C=this),!C.hasClassName("notselectable")&&k){var t=m.getElement("div#levelSelector-"+k);if(t!==C){var n=parseInt(C.id.replace("levelSelector-",""),10);"notCurrent"!==u[n-1].selection&&M(t)}}}else C=null},K=function(e){P=!1,1===e.touches.length&&(S=e.touches[0].identifier,e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),w=z(e),O(w,r),M(w),B(w))},_=function(t){P=!1;var n,l=this;if(A(t)&&(t.preventDefault(),t.stopPropagation(),l=z(t)),l!==w){var o=w;if(w=l,M(o),O(o,v),C&&o===C&&k&&(n=m.getElement("div#levelSelector-"+k))!==C&&M(n),A(t)&&(!l||!e.is(S)||1!==t.changedTouches.length||S!==t.changedTouches[0].identifier))return B(l),void(w=void 0);O(l,r),M(l),C&&k&&!l.hasClassName("notselectable")&&(n=m.getElement("div#levelSelector-"+k))!==C&&n!==l&&M(n),B(l)}},J=function(){S=void 0,P=!1;var e=w;if(w=void 0,M(e),C&&e===C&&k){var t=m.getElement("div#levelSelector-"+k);t!==C&&M(t)}O(e,v),B()},G=function(e){if(P=!1,0===e.button&&0===e.buttons){var n=C;if(C=null,n&&n===this){if(!n.hasClassName("notselectable")){if(k){var l=m.querySelector("#levelSelector-"+k),o=parseInt(n.id.replace("levelSelector-",""),10);"notCurrent"!==u[o-1].selection&&(k=o),M(l)}O(n,t)}M(n)}else M(n)}},Q=function(n){P=!1,n.preventDefault(),n.stopPropagation();var l=z(n);if(l&&e.is(S)&&1===n.changedTouches.length&&S===n.changedTouches[0].identifier){if(C=l,M(l),k){var o=m.getElement("div#levelSelector-"+k);o!==C&&M(o)}setTimeout((function(){var e=C;w=C=void 0,M(e),O(e,v),e.hasClassName("notselectable")||(O(e,t),k&&(k=parseInt(e.id.replace("levelSelector-",""),10))),M(e),B()}),100)}};this.createView=function(o){if(H&&(clearTimeout(H),H=void 0,m.remove(),m.empty(!0)),E&&(m.remove(),m.empty(!0),t=r=v=u=void 0,g=S=w=k=C=void 0,l.unsubscribe(E),E=void 0,x&&(x.unsubscribe(W),W=x=void 0),n.removeEvent.call(document,"keydown",R),n.removeEvent.call(document,"keyup",R)),!(!o.uiFrame||!o.hasOwnProperty("display")&&("number"!=typeof o.positionX||"number"!=typeof o.positionY)||o.hasOwnProperty("display")&&(!o.display||!o.display.type||"position"!==o.display.type&&"docked"!==o.display.type||"position"===o.display.type&&("number"!=typeof o.display.x||"number"!=typeof o.display.y)||"docked"===o.display.type&&o.hasOwnProperty("marginW")&&"number"!=typeof o.display.marginW||"docked"===o.display.type&&o.hasOwnProperty("marginH")&&"number"!=typeof o.display.marginH)||!o.getLevels||"function"!=typeof o.getLevels||!o.onSelect||"function"!=typeof o.onSelect||o.onHover&&"function"!=typeof o.onHover||o.onLeave&&"function"!=typeof o.onLeave)){var s;L=o.display&&"docked"===o.display.type,u=null,k=null,N=!1,p=a,f="#558caa";var c=o.getLevels((function(){B(w),s&&u&&s.getChildren().forEach((function(e){M(e)}))}));if(c instanceof Array?(u=c,k=N=void 0):c instanceof Object&&(u=c.levels,(k="number"==typeof c.currentLevel?c.currentLevel+1:void 0)&&(k<=0||k>u.length)&&(k=void 0),k&&(p="string"==typeof c.selectColor?c.selectColor:p,f="string"==typeof c.selectOverColor?c.selectOverColor:f),N=k&&L),u instanceof Array&&!(u.length<=0)&&u.every((function(e){return e&&null!==e.pathElement&&void 0!==e.pathElement}))){g=o.uiFrame,t=o.onSelect,r=o.onHover,v=o.onLeave,m.addClassName("animatable"),m.removeAttribute("style"),m.removeClassName("hidden"),!0===i&&m.removeClassName("animatable"),y.removeAttribute("style"),y.addClassName("transparent"),y.addClassName("hidden"),h.removeAttribute("style"),h.addClassName("transparent"),h.addClassName("hidden"),h.removeClassName("white"),h.empty(!0);var d=u.length;if(L)m.addClassName("docked"),"number"==typeof o.display.marginW&&m.setStyle("margin-right",o.display.marginW+"px"),"number"==typeof o.display.marginH&&m.setStyle("margin-top",o.display.marginH+"px");else{m.removeClassName("docked");var I=g.getParent().getSize(),P=I.width,A=I.height,D=V(d),q="number"==typeof o.positionX?o.positionX+10:o.display.x-15,O="number"==typeof o.positionY?o.positionY-D/2:o.display.y-D/2-7;q+30*d>P?q=P-30*d:q<0&&(q=0),O+D+60>A&&(O=A-60-D),O<0&&(O=0),m.setStyles({left:q,top:O})}s=e.createElement("div",{class:"levels"}).inject(m);for(var U=1;U<=d;U++){var X=V(U),z=e.createElement("div",{id:"levelSelector-"+U,class:"level"});z.setStyle("height",X+14+"px"),L||z.setStyle("top",7*(d-U)+"px"),z.addEvents({mouseenter:_,mouseleave:J,mouseup:G,mousedown:F}),z.addEvents({touchstart:K,touchmove:_,touchend:Q}),"notSelectable"===u[U-1].selection&&z.addClassName("notselectable");var Z=e.createElement("canvas",{id:"canvas"+U,class:"canvas"});Z.inject(z),Z.setAttributes({width:"20px",height:X+"px"}),M(z),!0!==i&&Z.addClassName("transparent"),z.inject(s)}x=void 0,L&&o.background&&o.background.backgroundColor&&(x=o.background,j()),m.inject(g),s.inject(m),L||y.inject(m),h.inject(m),b.inject(m),N&&B();var $=1;if(!0!==i)var ee=setInterval((function(){var e=s.querySelector("#canvas"+$);e?(e.removeClassName("transparent"),$++):clearInterval(ee)}),50/d);return T=!0!==o.displayWhileViewpointIsManipulated,!0===o.displayWhileViewpointIsManipulated&&!0===o.disableKeyboard||(E=l.subscribe({event:"/VISU/"},Y)),x&&x.onBackgroundModify&&x.unsubscribe&&(W=x.onBackgroundModify(j)),!0!==o.disableKeyboard&&(n.addEvent.call(document,"keydown",R),n.addEvent.call(document,"keyup",R)),0}u=void 0}},this.destroyView=function(){if(!H){if(!0!==i){if(m){for(var e=m.querySelectorAll(".canvas"),o=0;o<e.length;++o)e[o].addClassName("transparent");y.addClassName("transparent"),h.addClassName("transparent"),H=setTimeout((function(){m.remove(),m.empty(!0),H=void 0}),100)}}else m.remove(),m.empty(!0);t=r=v=u=void 0,g=S=w=k=C=void 0,l.unsubscribe(E),E=void 0,x&&(x.unsubscribe(W),W=x=void 0),n.removeEvent.call(document,"keydown",R),n.removeEvent.call(document,"keyup",R)}}}}),u=t.singleton({init:function(){Object.defineProperty(this,"_noAnim",{get:function(){return i},set:function(e){i=!0===e||void 0}})},createView:function(e){return r||(r=new v),r.createView(e)},destroyView:function(){if(r)return r.destroyView()}});return u.init(),u}));