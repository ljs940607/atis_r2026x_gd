define("DS/NotificationManager/NotifiManagerTracker",["UWA/Core","DS/Usage/TrackerAPI"],(function(t,e){"use strict";return{trackNotifSystem:function(t){},trackWebsocketConnection:function(i,n,o,s){var a={eventCategory:"notification.manager",eventAction:"websocketConnection",eventLabel:"Websocket connection time in milliseconds",eventValue:i,persVal:{pv1:n},persDim:{pd2:s?"failure":"success",pd4:o},appID:"X3DNTFC_AP"};if(s){const t=s.message?(s.type?s.type+": ":"")+s.message:s.toString();a.persDim.pd1=t,t.match(/timeout/i)?a.persDim.pd3="timeout":t.match(/socket error/i)?a.persDim.pd3="websocket error":a.persDim.pd3="other"}try{e.trackPageEvent(a)}catch(e){t.log("Analytics request failed : "+e)}},trackWebsocketDisconnection:function(i,n){var o={eventCategory:"notification.manager",eventAction:"websocketDisconnection",eventLabel:"Websocket disconnection",eventValue:i,persDim:{pd1:n},appID:"X3DNTFC_AP"};try{e.trackPageEvent(o)}catch(e){t.log("Analytics request failed : "+e)}},trackAlertNotifications:function(i){var n={eventCategory:"notification.managerview",eventAction:i.eventAction,eventLabel:i.eventLabel,eventValue:i.eventValue,persDim:i.persDim,persVal:i.persVal,appID:"X3DNTFC_AP"};try{e.trackPageEvent(n)}catch(e){t.log("Analytics request failed : "+e)}}}})),define("DS/NotificationManager/view/notificationManagerView",["UWA/Core","UWA/Class/View","UWA/Controls/Abstract","DS/NotifAlert/NotifAlert","css!DS/NotificationManager/NotificationManager.css"],(function(t,e,i,n){"use strict";return e.extend({defaultOptions:{itemView:n,language:"en"},setup:function(e){this.maxItems=3,this.isInject=!1,this.isClosed=!1,this.itemView=e&&e.itemView?e.itemView:this.options.itemView,this.language=e&&e.language?e.language:this.options.language,this.listenTo(this.collection,"onAdd",this.add),this.listenTo(this.collection,"onRemove",this.deleteModel),this.collection.addEvents({"onChange:readState":function(e){t.log("AlertBox model changed")}}),this.setContainer({tag:"div",class:"RTnotification"})},add:function(e){var i;if(this.isInject)if(this.collection.length<=this.maxItems){t.log("AlertBox - Add"),i=new this.itemView({model:e});var n=t.createElement("div",{class:"RTnotif-alert",html:i}).inject(this.container,"top");e.get("isInNotifCenter")||(this._createAlertShowFx(e,n),i.show(),e.showAlertFx.start({top:["0px","0px"],right:["-400px","15px"],opacity:[0,1]}))}else{this._timeToRemove&&(clearTimeout(this._timeToRemove),this._timeToRemove=void 0);var o=this;this._timeToRemove=setTimeout((function(){o.closeAllAlerts()}),1e3)}},deleteModel:function(e){if(e){t.log("AlertBox model deleted"),e.showAlertFx&&(e.showAlertFx.fade("out").onComplete=function(){this.element&&this.element.destroy()})}},inject:function(t){this.isInject=!0,this.container.inject(t);for(var e=0;e<this.collection.size();e++)this.add(this.collection.at(e))},checkExistingAlert:function(){return!!document.querySelector(".RTnotif-alert")},_createAlertShowFx:function(e,i){e.showAlertFx=new t.Fx(i,{duration:500,transition:"linear",events:{onComplete:function(){}}})},closeAllAlerts:function(){for(;!this.collection.isEmpty();)this.collection.pop()}})})),define("DS/NotificationManager/AppsAndServices",["UWA/Core","UWA/Class","DS/i3DXCompass/i3DXCompass","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/i3DXCompassPlatformServices/i3DXCompassRegistryClient","DS/PlatformAPI/PlatformAPI"],(function(t,e,i,n,o,s){const a={passport:"3DPassport",notification:"3dnotifications"},r={},c={};return e.extend({init:function(){},extractDomain:function(t){let e;return e=t.indexOf("://")>-1?t.split("/")[2]:t.split("/")[0],e.indexOf(":")>-1?e:e+":443"},getAppInfoFromCompass:function(e){if(!e)throw new Error("Wrong args - Missing appId.");return new Promise(((n,o)=>{i.getAppInfo({appId:e,onComplete:function(i){t.log(`NotifManager getAppInfoFromCompass App: ${i}`),i?n(i):o(new Error(`Failed to retrieve app ${e} from Compass.`))}})}))},getAppIcon:async function(t){if(!t)throw new Error("Wrong args - Missing appId.");if(r[t]&&r[t].icon)return r[t].icon;const e=await this.getAppInfoFromCompass(t);return e&&e.icon&&(r[t]?r[t].icon=e.icon:r[t]={id:t,icon:e.icon}),r[t]&&r[t].icon},getAppsInfoFromCompass:function(e){if(!e||0===e.length)throw new Error("Wrong args - Missing appsIds.");return new Promise(((n,o)=>{i.getAppsInfo({data:e,onComplete:function(e){t.log(`NotifManager getAppsInfoFromCompass Apps: ${e}`),e&&0!==e.length?n(e):o(new Error("No app retrieve from Compass."))}})}))},getAppsInfo:async function(e){if(!e||0===e.length)throw new Error("Wrong args - Missing appsIds.");const i=[],n=[];if(e.forEach((t=>{let e=r[t];e&&e.id&&e.title&&e.icon?i.push(e):n.push(t)})),n.length>0){const e=await this.getAppsInfoFromCompass(n).catch((e=>t.log(`NotifManager getAppsInfo (WARN)${e}`)));e&&e.length>0&&e.forEach((t=>{t&&t.id&&(r[t.id]={id:t.id,title:t.title,icon:t.icon},i.push(r[t.id]))}))}return i},getPlatformServicesFromCompass:function(){return new Promise(((e,i)=>{n.getPlatformServices({onComplete:function(i){t.log(`NotifManager getPlatformServicesFromCompass Data: ${i}`),Array.isArray(i),e(i)}})}))},loadServicesInfo:function(){return this.getPlatformServicesFromCompass().then((t=>Array.isArray(t)?(t.forEach((t=>{if(!t)return;let e=t.platformId&&t.platformId.toLowerCase();c[e]={},Object.keys(t).forEach((i=>{t.hasOwnProperty(i)&&(c[e][i.toLowerCase()]=t[i])}))})),Object.values(c)):t))},getServices:async function(){return 0===Object.keys(c).length?this.loadServicesInfo():Object.values(c)},getServiceUrlFromCompass:function(e,i){if(!e||!i)throw new Error("Wrong args - Missing serviceName or tenant.");return new Promise(((o,s)=>{n.getServiceUrl({serviceName:e,platformId:i,onComplete:function(n){if(t.log(`NotifManager getServiceUrlFromCompass Data: ${n}`),n)if("string"==typeof n)o(n);else if(n.length>0){let t=n.find((t=>!!t.url));o(t&&t.url)}else o(n);else s(new Error(`No data retrieved for service ${e} on tenant ${i} from Compass.`))}})}))},getServicesByPlatformFromRegistry:function(e,i){if(!e||0===e.length||!i)throw new Error("Wrong args - Missing serviceNames or tenant.");const n=s.getApplicationConfiguration("app.urls.registry");if(!n)throw new Error("No registry configuration.");return o.getServicesByPlatform({services:e,platforms:[i],config:{url:n}}).then((n=>{if(t.log(`NotifManager getServicesByPlatformFromRegistry Data: ${n}`),!n||0===n.length)throw new Error(`No data retrieved for services ${e} on tenant ${i} from Registry.`);const o=n.find((t=>t.id&&t.id.toLowerCase()===i.toLowerCase())),s=o&&o.services;if(!s||0===s.length)throw new Error(`No services data retrieved on tenant ${i} from Registry.`);return s}))},getPassportRegistryUrl:function(e){if(!e)throw new Error("Wrong args - Missing tenant.");return this.getServicesByPlatformFromRegistry([a.passport],e).then((t=>{if(!t||0===t.length)throw new Error(`Failed to retrieve 3DPassport on tenant ${e} (no data)`);const i=t.find((t=>t.id&&t.id.toLowerCase()===a.passport.toLowerCase()&&t.url));return i&&i.url})).catch((e=>(t.log(`NotifManager getPassportRegistryUrl ${e}`),null)))},getServiceUrl:async function(e,i,n=!1){if(!e)throw new Error("Wrong args - Missing serviceName");const o=e.toLowerCase();if(!i){let t=Object.values(c).find((t=>!!t[o]));return t&&t[o]||void 0}const s=i.toLowerCase();return c[s]||(c[s]={}),"string"==typeof c[s][o]?c[s][o]:"boolean"==typeof c[s][o]?n?getServiceUrl(e):null:this.getServiceUrlFromCompass(e,i).then((t=>{if(!t)throw new Error(`Url not found for service ${e} on tenant ${i}`);return c[s][o]=t,t})).catch((i=>(t.log(`NotifManager getServiceUrl ${i}`),c[s][o]=!1,n?this.parent.getServiceUrl(e):null)))}})})),define("DS/NotificationManager/view/notificationMessageView",["UWA/Class","UWA/Class/Events","UWA/Class/Model","UWA/Class/View","i18n!DS/NotificationManager/assets/nls/feed","DS/UIKIT/Tooltip"],(function(t,e,i,n,o,s){"use strict";var a=i.extend(),r=n.extend({tagName:"div",id:"NTFMsgMiniNotification",className:"NTFMsgMiniNotification"}),c=n.extend({tagName:"div",className:"buddyContainer",render:function(){return this.container.setContent([{tag:"div",class:"buddyBubble buddyBubbleHidden",html:[{tag:"span",class:"fonticon handler fonticon-users buddyBubbleIcon"}]}]),this}}),l=n.extend({tagName:"div",id:"convNotifViewArrowList",className:"convNotifViewArrowList"}),d=n.extend({tagName:"div",id:"convNotifViewScroll",className:"convNotifViewScroll"}),f=n.extend({tagName:"div",id:"convNotifViewList",className:"convNotifViewList",y:0}),g=n.extend({tagName:"div",className:"convNotifContainer",updateModel:function(t,e){var i=this.container.getElementsByClassName("convBubbleMsg");i&&i.length>0&&(this.model.set({messageId:t,message:e}),this.container.getElementsByClassName("convBubbleMsg")[0].innerText=this.model.get("message"))},render:function(){return this.container.setContent([{tag:"div",class:"convNotifView",html:[{tag:"div",class:"convBubble",html:[{tag:"img",class:"convBubblePicture",src:this.model.get("pathPicture")}]},{tag:"div",class:"convBubbleHeaderView",html:[{tag:"div",class:"convBubbleHeaderViewContainer",html:[{tag:"div",class:"convBubbleHeader",html:[{tag:"div",class:"convBubbleHeader1",text:this.model.get("author")},this.model.get("communityTitle")&&this.model.get("communityTitle")!==this.model.get("author")?{tag:"div",class:"convBubbleHeader2",text:this.model.get("communityTitle")}:null]},{tag:"span",class:"fonticon fonticon-popup launchChatPanelIcon"},{tag:"span",class:"fonticon fonticon-cancel closeIcon"}]}]},{tag:"div",class:"convBubbleMsgView",html:[{tag:"div",class:"convBubbleMsgViewContainer",html:[{tag:"div",class:"convBubbleMsg",text:this.model.get("message")}]}]}]}]),this}}),u=n.extend({tagName:"div",className:"arrowView",setup:function(t){this.icon="up"==t?"fonticon-up-open":"fonticon-down-open"},render:function(){return this.container.setContent([{tag:"span",class:"fonticon "+this.icon+" arrowIcon"}]),this}}),p=n.extend({tagName:"span",className:"convNotifExtBadge fonticon fonticon-popup"});return t.extend(e,{init:function(t){var e=this;this.deleteBubbleHandler=t.deleteBubbleHandler,this.isMobileApp=t.isMobileApp,this.currentTenant=t.tenant,UWA.log("3DNotification Bubble init"),this.globalView=new r,this.buddyView=new c,this.notifViewArrowList=new l,this.notifViewScroll=new d,this.notifViewList=new f,this.arrowUp=new u("up"),this.arrowDown=new u("down"),this.views={},UWA.Event.onDomReady((function(){e.globalView.render(),e.buddyView.render().inject(e.globalView.container),e.notifViewArrowList.render().inject(e.globalView.container),e.arrowUp.render().inject(e.notifViewArrowList.container),e.notifViewScroll.render().inject(e.notifViewArrowList.container),e.arrowDown.render().inject(e.notifViewArrowList.container),e.notifViewArrowList.container.toggleClassName("convNotifViewArrowListMinifiedHidden",!0),e.notifViewList.render().inject(e.notifViewScroll.container),e.arrowUp.container.toggleClassName("hideElement",!0),e.arrowDown.container.toggleClassName("hideElement",!0),e.arrowUp.container.addEventListener("click",(function(){e._scrollUp(100)})),e.arrowDown.container.addEventListener("click",(function(){e._scrollDown(100)})),e.notifViewScroll.container.addEventListener("wheel",(function(t){if(Object.keys(e.views).length>9){var i=Math.abs(t.deltaY);t.deltaY<0?e._scrollUp(i):t.deltaY>0&&e._scrollDown(i)}})),e.buddyView.getElement(".buddyBubble").addEvent("click",(function(){var t=e.buddyView.getElement(".buddyBubble");t.hasClassName("buddyBubbleMinified")?(t.toggleClassName("buddyBubbleVisible",!0).toggleClassName("buddyBubbleMinified",!1),setTimeout((function(){e.notifViewArrowList.container.toggleClassName("convNotifViewArrowListMinifiedHidden")}),500)):t.hasClassName("buddyBubbleVisible")?(t.toggleClassName("buddyBubbleMinified",!0).toggleClassName("buddyBubbleVisible",!1),e.notifViewArrowList.container.toggleClassName("convNotifViewArrowListMinifiedHidden")):(t.toggleClassName("buddyBubbleMinified"),setTimeout((function(){e.notifViewArrowList.container.toggleClassName("convNotifViewArrowListMinifiedHidden")}),100))}))}))},addNotification:function(t){var e,i=this,n=t.platformId.toUpperCase();if(this.views[n]&&this.views[n][t.communityId]&&this.views[n][t.communityId][t.userLogin])(e=this.views[n][t.communityId][t.userLogin]).updateModel(t.messageId,t.infoTxt),e.getElement(".convBubble").toggleClassName("convBubbleBlink",!0),setTimeout((function(){e.getElement(".convBubble").toggleClassName("convBubbleBlink",!1)}),3e3);else{var r=new a({messageId:t.messageId,platformId:n,communityId:t.communityId,communityTitle:t.communityTitle,login:t.userLogin,author:t.userName,message:t.infoTxt,pathPicture:t.pathPicture});(e=new g({model:r})).clickEvent=t.events.click,i.globalView.container.toggleClassName("NTFMsgMiniNotificationDisplayed",!0),e.render().inject(i.notifViewList.container,"bottom"),e.container.getElement(".convNotifView").toggleClassName("convNotifViewHidden",!0);n=e.model.get("platformId");var c=e.model.get("communityId"),l=e.model.get("login");this.views[n]||(this.views[n]={}),this.views[n][c]||(this.views[n][c]={}),this.views[n][c][l]=e,n===this.currentTenant?e.getElement(".launchChatPanelIcon").remove():(new s({target:e.getElement(".launchChatPanelIcon"),body:o.openInNewTab,trigger:"hover focus"}),(new p).render().inject(e.container,"bottom")),new s({target:e.getElement(".closeIcon"),body:o.close,trigger:"hover focus"}),this.notifViewList.y-=this._getDistanceToBottom(),Object.keys(this.views).length>9&&(this.notifViewList.y-=10,this.arrowDown.container.toggleClassName("hideElement",!1),this.arrowUp.container.toggleClassName("hideElement",!1));var d=this.buddyView.getElement(".buddyBubble");d.hasClassName("buddyBubbleHidden")?d.toggleClassName("buddyBubbleHidden",!1):d.hasClassName("buddyBubbleMinified")&&d.toggleClassName("buddyBubbleMinified",!1).toggleClassName("buddyBubbleVisible",!0),this.notifViewArrowList.container.toggleClassName("convNotifViewArrowListMinifiedHidden",!1),e.container.getElement(".convNotifView").toggleClassName("convNotifViewHidden",!1);const f=this.notifViewScroll.container.clientHeight<this.notifViewScroll.container.scrollHeight;f&&(e.container.getElement(".convNotifView").style.marginBottom="24px"),setTimeout((function(){f&&i.notifViewScroll.container.scrollTo({left:0,top:i.notifViewScroll.container.scrollHeight,behavior:"smooth"}),e.container.getElement(".convNotifView").toggleClassName("convNotifViewAppear",!0),setTimeout((function(){e.container.getElement(".convNotifView").toggleClassName("convNotifViewAppear",!1),e.container.getElement(".convNotifView").style.marginBottom=""}),1500)}),500),e.container.addEventListener("click",(function(){i._clickBubble(e,!1,!1,!0,!0)})),e.getElement(".closeIcon").addEventListener("click",(function(t){i._clickBubble(e,!0,!1,!0,!1),t.stopPropagation()}))}},deleteBubblesFromConv:function(t,e,i,n){if(t&&e&&(t=t.toUpperCase(),this.views[t]&&this.views[t][e])){let o;if(n)for(i in this.views[t][e])o=this.views[t][e][i],o.model.get("messageId")===n&&this._clickBubble(o,!0,!1,!1,!1);else{if(i)return o=this.views[t][e][i],void this._clickBubble(o,!0,!1,!1,!1);for(i in this.views[t][e])o=this.views[t][e][i],this._clickBubble(o,!0,!1,!1,!1)}}},_clickBubble:function(t,e,i,n,o){if(t){var s=t.model.get("platformId"),a=t.model.get("communityId"),r=t.model.get("login");if(this.views[s]&&this.views[s][a]&&this.views[s][a][r]){if(e||t.clickEvent(i),t.destroy(),delete this.views[s][a][r],0==Object.keys(this.views[s][a]).length&&delete this.views[s][a],0==Object.keys(this.views[s]).length&&delete this.views[s],o&&this.deleteBubblesFromConv(s,a,void 0),n&&this.deleteBubbleHandler({platformId:s,communityId:a}),Object.keys(this.views).length<10)this.notifViewList.y=0,this.arrowDown.container.toggleClassName("hideElement",!0),this.arrowUp.container.toggleClassName("hideElement",!0);else{var c=this._getDistanceToTop(),l=this._getDistanceToBottom();c<0?this.notifViewList.y=0:l<-15&&(this.notifViewList.y-=l+15)}if(this.notifViewScroll.container.scrollTo({left:0,top:this.notifViewScroll.container.scrollHeight,behavior:"smooth"}),0==Object.keys(this.views).length){this.buddyView.getElement(".buddyBubble").toggleClassName("buddyBubbleHidden",!0),this.notifViewArrowList.container.toggleClassName("convNotifViewArrowListMinifiedHidden",!0),this.buddyView.getElement(".buddyBubble").toggleClassName("buddyBubbleMinified",!1).toggleClassName("buddyBubbleVisible",!1);let t=this,e=setTimeout((function(){t.globalView.container.toggleClassName("NTFMsgMiniNotificationDisplayed",!1),clearTimeout(e)}),1e3)}}}},_getDistanceToTop:function(){var t=this.notifViewScroll.container.getBoundingClientRect(),e=this.notifViewList.container.getBoundingClientRect();return t.top-e.top},_getDistanceToBottom:function(){var t=this.notifViewScroll.container.getBoundingClientRect();return this.notifViewList.container.getBoundingClientRect().bottom-t.bottom},_scrollUp:function(t){var e=this._getDistanceToTop();if((e=Math.floor(e))>0){var i=Math.min(t,e);this.notifViewList.y+=i,this.notifViewList.container.setStyle("transform","translateY("+this.notifViewList.y+"px)")}},_scrollDown:function(t){var e=this._getDistanceToBottom();if(Object.keys(this.views).length>9&&(e+=15),(e=Math.floor(e))>-15){var i=Math.min(t,e);this.notifViewList.y-=i,this.notifViewList.container.setStyle("transform","translateY("+this.notifViewList.y+"px)")}},getView:function(){return this.globalView},destroy:function(){var t,e,i;for(t in this.views)for(e in this.views[t])for(i in this.views[t][e])this.views[t][e][i].destroy();this.notifViewList.destroy(),this.notifViewScroll.destroy(),this.arrowUp.destroy(),this.arrowDown.destroy(),this.notifViewArrowList.destroy(),this.buddyView.destroy(),this.globalView.destroy()}})})),define("DS/NotificationManager/notificationDriver",["UWA/Core","UWA/Class","DS/PlatformAPI/PlatformAPI","UWA/Class/Events","DS/DSNodeSocketioClient_4.7.4/DSNodeSocketioClient_4.7.4","DS/WAFData/WAFData","DS/NotificationManager/NotifiManagerTracker"],(function(t,e,i,n,o,s,a){"use strict";let r,c,l=0;const d=crypto&&crypto.randomUUID&&crypto.randomUUID()||t.Utils.getUUID();return e.extend(n,{defaultOptions:{notifServer:"",currentLanguage:"en"},init:function(t){var e=this;this._listenedEvents=t.listenedEvents,this._socket=void 0,this._server=void 0,this._token=void 0,this._socketOptions=void 0,this.USE_RETRY=!0,this.IN_RETRY=!1,this.RANDOM_DELAY=1e3*Math.floor(10*Math.random()),this.MAX_CONNECTION_TRIES=t.MAX_CONNECTION_TRIES,isNaN(this.MAX_CONNECTION_TRIES)&&"Infinity"!=this.MAX_CONNECTION_TRIES&&(this.MAX_CONNECTION_TRIES=10),this.lastDisconnectTime=0,this.lastReconnectTime=0,i.subscribe("fromDesktopApp.ds.com",this.handlerReconnect.bind(this)),i.subscribe("3dNotifCenterInit",(function(){e._socket?i.publish("3dNotifManagerInit",!0):i.publish("3dNotifManagerInit",!1)})),this.listenNetworkEvent(),this.listenVisibilityEvent()},handlerReconnect:function(t){t&&"notif"===t.socket&&(t.checkSocketStatus?this.checkSocketStatus():t.forceSocketReconnect&&this.checkSocketStatus(!0))},listenVisibilityEvent:function(){var e,i;void 0!==document.hidden?(e="hidden",i="visibilitychange"):void 0!==document.msHidden?(e="msHidden",i="msvisibilitychange"):void 0!==document.webkitHidden&&(e="webkitHidden",i="webkitvisibilitychange"),void 0===document.addEventListener||void 0===e?t.log("NotificationDriver requires a browser that supports the Page Visibility API."):document.addEventListener(i,function(e){document.hidden||(this.IN_RETRY&&t.log("NotificationDriver visible but in retry process."),this.checkSocketStatus())}.bind(this))},listenNetworkEvent:function(){this.USE_RETRY&&(window.addEventListener("online",this.checkSocketStatus.bind(this)),window.addEventListener("offline",this.checkSocketStatus.bind(this)))},removeNetworkEvent:function(){window.removeEventListener("online",this.checkSocketStatus.bind(this)),window.removeEventListener("offline",this.checkSocketStatus.bind(this))},checkSocketStatus:function(t){setTimeout((()=>{this.checkSocketStatus_delayed(t)}),this.RANDOM_DELAY)},checkSocketStatus_delayed:function(e){t.log("NotificationDriver checkSocketStatus use retry "+this.USE_RETRY),this.USE_RETRY&&(navigator.onLine?this._socket&&this._socket.disconnected?this.IN_RETRY?!0===e?(this.alertRetryEvent("alert_reconnectOngoing"),this.activeConnection(this._socketOptions),t.log("NotificationDriver retry process force reconnect socket.")):t.log("NotificationDriver already in retry process!"):(this.alertRetryEvent("alert_reconnectOngoing"),this.IN_RETRY=!0,this._socket.io.reconnection(!0),l++,r=Date.now(),this._socket.io.connect(),t.log("NotificationDriver retry process connect socket.")):this._socket||(this.alertRetryEvent("alert_reconnectOngoing"),this.activeConnection(this._socketOptions),t.log("NotificationDriver need to do whole init/login socket again!")):(this._socket&&(!this._socket.connected&&this._socket.disconnected||(t.log("NotificationDriver no network then disonnect socket & dont retry."),this._socket.io.reconnection(!1),this._socket.io.disconnect())),this.IN_RETRY=!1,this.alertRetryEvent("alert_connexionNetworkLost"),t.log("NotificationDriver no network!")))},alertRetryEvent:function(e){t.log("NotificationDriver alert: "+e)},activeConnection:function(e){t.log("3DNOTIF - NotificationManager activeConnection");var n=this,f={"force new connection":!1,reconnection:!!this.MAX_CONNECTION_TRIES,reconnectionDelayMax:12e4+1e3*(10+Math.floor(5*Math.random())),reconnectionAttempts:this.MAX_CONNECTION_TRIES,timeout:1e4,transports:["websocket"]};if(this._socketOptions=e,this._server||(this._server=e&&e.notifServer),this._server?(this._server=this._server.replace(/^https?:\/\//,""),this._server.startsWith("wss://")||(this._server="wss://"+this._server),r=Date.now(),this._socket=o.connect(this._server,f)):t.log("3DNOTIF - NotificationManager no websocket server url"),this._socket){isNaN(this.MAX_CONNECTION_TRIES)||(this._socket.io.reconnectionAttempts(f.reconnectionAttempts),this._socket.io.reconnectionDelayMax(f.reconnectionDelayMax));for(var g=0;g<n._listenedEvents.length;g++)!function(t){n._socket.on(t,(function(e){n.dispatchListenedEvents(e,t)}))}(n._listenedEvents[g]);this._socket.io.on("error",(t=>{if(r){const e=Date.now()-r;a.trackWebsocketConnection(e,l,d,t),r=null}})),this._socket.on("connect",(()=>{if(r){const t=Date.now()-r;a.trackWebsocketConnection(t,l,d),l=0,r=null}c=Date.now();var o={onComplete:function(o){var s;if("object"!=typeof o)try{s=JSON.parse(o)}catch(e){t.log("3DNotification : error parsing cas validate ticket response :"+e)}else s=o;if(s&&s.access_token){n._token=s.access_token,n._socket.emit("new_user",{pseudo:e.login.toLowerCase(),pass:n._token,language:e.currentLanguage,tenant:e.tenant}),delete n._token,n._token=void 0,i.publish("intf-ws-topic",{event:"ready",code:200})}else{t.log("3DNotification : json null or no acess token");for(var a=0;a<n._listenedEvents.length;a++)!function(t){n._socket.off(t)}(n._listenedEvents[a]);n._socket.off("connect"),n._socket.off("error"),n._socket.close(),delete n._socket}},onFailure:function(i){e.iamUrl===e.tenantAgnosticIamUrl?t.log(i):(e.iamUrl=e.tenantAgnosticIamUrl,s.authenticatedRequest(e.iamUrl,o))},onTimeout:function(e){t.log(e)},type:"json"};s.authenticatedRequest(e.iamUrl,o),n.IN_RETRY&&(n.alertRetryEvent("alert_connexionRetrieved"),e.onReconnect(),n.lastReconnectTime=Date.now()),n.IN_RETRY=!1})),this._socket.on("error",(e=>{t.log("3DNotification Socket Connection Error\n"+e)})),this._socket.io.on("reconnect_attempt",(e=>isNaN(e)?console.error("Notif socket io onReConnectAttempt arg is not a number !"):!(!n._socket||!n._socket.io||isNaN(n.MAX_CONNECTION_TRIES))&&(l++,r=Date.now(),void(e==n.MAX_CONNECTION_TRIES-1?(n.IN_RETRY=!0,n._socket.io.reconnection(!0),n._socket.io.reconnectionDelay(12e4+n.RANDOM_DELAY),t.log("Notif websocket "+e+" tries to connect to server have occured, the reconnection delay has been raised to 2min")):e>=n.MAX_CONNECTION_TRIES?(t.log("Notif websocket max tries quantity have been reached. Stopping connection attempts"),n.IN_RETRY=!1,n._socket.io.reconnection(!1),n._socket.close()):(n.IN_RETRY=!0,n._socket.io.reconnection(!0),n._socket.io.reconnectionDelay(1e3*e+n.RANDOM_DELAY),t.log("Notif websocket "+e+" tries to connect to server have occured, the reconnection delay has been raised to "+e+"s")))))),this._socket.on("disconnect",(t=>{n.lastDisconnectTime=Date.now(),a.trackWebsocketDisconnection(n.lastDisconnectTime-c,d)})),this._socket.on("connect_error",(t=>{(t?.message?.includes("429")||429===t?.description?.status)&&(console.warn("3DNotification connection throttled, postponing reconnection attempt to 5minutes"),n._socket.io.reconnectionDelay(3e5))}))}},dispatchListenedEvents:function(t,e){this.dispatchEvent(e,t)},emit:function(t,e){this._socket&&this._socket.emit(t,e)},getSocketStatus:function(){return this._socket&&this._socket.connected?"connected":"disconnected"}})})),define("DS/NotificationManager/notificationManager",["UWA/Core","UWA/Class","UWA/Data","UWA/Controls/Abstract","UWA/Class/Model","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/UWPClientCode/PublicAPI","DS/UWPClientCode/I18n","DS/NotificationManager/view/notificationManagerView","DS/i3DXCompass/i3DXCompass","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/i3DXCompassPlatformServices/i3DXCompassRegistryClient","DS/TopBar/TopBar","DS/NotificationManager/notificationDriver","DS/NotifAlert/NotifAlert","DS/NotificationManager/view/notificationMessageView","DS/NotificationManager/NotifiManagerTracker","DS/NotificationRichClient/NotificationRichClient","DS/NotificationManager/AppsAndServices"],(function(t,e,i,n,o,s,a,r,c,l,d,f,g,u,p,h,m,v,b,w){"use strict";const N=new w;var y;return e.extend({init:function(e){y=this,this.login=e.login;try{this.login||(this.getUserPromise=new Promise(((e,i)=>{if(window.document.location.host.includes("3dswym"))r.getUserAsync({success:t=>{if(t)return this.login=t.login,e();i("getUserAsync returns empty user")},failure:n=>{t.log(`3DNotification - WARN - Failed to getUserAsync with error: ${n}, fallback on getUser`);const o=a.getUser();login?(this.login=o.login,e()):i("getUser returns empty user")}});else{const t=a.getUser();t?(this.login=t.login,e()):i("getUser returns empty user")}})))}catch(e){t.log(`3DNotification - WARN - Failed to get login with error: ${e}`)}if(this.centerVersion="1.0",this.centerVersionSet=!1,this.ODT=e.ODT,this.isMobileApp=e.isMobileApp||window&&window.ds&&"MOBILE"==window.ds.env,this.isDesktopApp=window&&window.ds&&window.ds.isDesktopApp,this.ODT||this.isMobileApp&&!this.isDesktopApp||(this.frame=require("DS/TopFrame/TopFrame"),this.appName=this.frame.helpMenuOptions.appNameAbout.toLowerCase()),this.topBar=u.MainMenuBar,this.swymServer=e.swymServer,this.badge=0,this.isFiltered=!1,this._notifManagerView=void 0,this._listenedEvents=void 0,this._emmitedEvents=void 0,this.initListenedEvents(),this.initEmmitedEvents(),this.getServices(),this.swymContext=void 0,this.tenantAgnosticMode=void 0,this.tenant=e.tenant||a.getTenant(),this.blockAlert=!!e.noNotifAlert,this.blockPopup=null,this._notificationDriver=new p({listenedEvents:Object.keys(y._listenedEvents)}),this._notificationDriver.addEvent("newINTFTokenConnection",(async function(){var t=await y.getParams();t&&t.login&&y.requestProxyTicket(t)})),Promise.resolve(this.getUserPromise).then((()=>this.login?this.initConnection(this.login,e.passportServer,this.tenant):t.log("3DNotification - WARN - Missing login, unable to init connection"))).catch((e=>t.log(`3DNotification - WARN - Failed to initConnection with error: ${e}`))),this.InitPushTo3dNotif("pushto3dnotification"),this.initListeners(),!this.notifCollection&&!this._notifManagerView){this.notifCollection=new t.Class.Collection,this._notifManagerView=new l({collection:this.notifCollection});try{this._notifConvView=new m({deleteBubbleHandler:function(t){y._notificationDriver.emit("syncSwymConvNotif",t)},isMobileApp:y.isMobileApp,tenant:y.tenant}),this._notifConvView.getView().inject(document.body)}catch(e){t.log("3DNotification - ERROR - instantiate bubble: "+e)}this._notifManagerView.inject(document.body),this.ODT||this.initFrameEvents()}this.addListener("3dnotifinterne",y.getActions),this.addListener("INTFSubscriptionTopic",(function(t){y._notificationDriver.emit("subscription",t)})),this.addListener("app.3DSwym",y.doSwymEvents),a.publish("app.3DSwym",{action:"contextChangeRequest",from:{app:"3DNotification",component:"conversationNotification"}}),this.addListener("wap.mobile.swym",y.doSwymMobileEvents),document.addEventListener("visibilitychange",(()=>{!document.hidden&&y.swymContext&&y._notificationDriver.emit("syncSwymConvNotif",{platformId:y.tenant,communityId:y.swymContext})})),window&&window.HomeByMeApp&&window.HomeByMeApp.onReady(),this.addListener("volatileSubscription.notif.ds.com",(function(t){var e;y._notificationDriver.emit("toINTF",{action:"volatileSubscription",data:t,TxID:(e="volatileSubscription",`${Date.now()}-r${Math.floor(1e3*Math.random())}-${e||"noAction"}`)})})),this.addListener("tonotif.im.ds.com",y.doRTConvEvent),this.getBlockPopup()},initEmmitedEvents:function(){this._emmitedEvents={notifCenterOpened:"notifCenterOpened",resetNotifications:"resetNotifications",notificationRead:"notificationRead",decrementBadge:"decrementBadge",getHistory:"getHistory",getFilterHistory:"getFilterHistory",getUnreadTotal:"getUnreadTotal",getFilterTotal:"getFilterTotal",getStarredTotal:"getStarredTotal",getSettings:"getSettings",updateSettings:"updateSettings",notificationDelete:"notificationDelete",deleteAllNotification:"deleteAllNotification",unsubscribe:"unsubscribe",filter:"filter",rollback:"rollback",rollbackPopupconfirmation:"rollbackPopupconfirmation",pushToken:"pushToken",deleteAllFilteredNotification:"deleteAllFilteredNotification",syncSwymConvNotif:"syncSwymConvNotif",getBadge:"getBadge",getMerge:"getMerge",closeNotifCenter:"closeNotifCenter",getTenantAgnosticMode:"getTenantAgnosticMode",updateTenantAgnosticMode:"updateTenantAgnosticMode",toINTF:"toINTF"}},initListenedEvents:function(){this._listenedEvents={notify:this.notify,notifyCenter:this.notifyCenter,notifySystem:this.notifySystem.bind(this),setHistory:this.setHistory,setUnreadTotal:this.setUnreadTotal,setFilteredTotal:this.setFilteredTotal,setStarredTotal:this.setStarredTotal,setSettings:this.setSettings,refreshCenterView:this.refreshCenterView,setSetting:this.setSetting,updateBadge:this.updateBadge,readNotification:this.readNotification,deleteNotification:this.deleteNotification,setTenants:this.setTenants,setDates:this.setDates,setWhoSettings:this.setWhoSettings,setNotifications:this.setNotifications,setSubscribedState:this.setSubscribedState,refreshForRollback:this.refreshForRollback,authenticated:this.authenticated,authenticate_error:this.authenticate_error,token_registered:this.token_registered,token_registered_error:this.token_registered_error,deleteSwymConvNotif:this.deleteSwymConvNotif.bind(this),setMerge:this.setMerge,setTenantAgnosticMode:this.setTenantAgnosticMode.bind(this),notification:this.notificationEvent.bind(this)}},initListeners:function(){for(var t in this._listenedEvents)this._listenedEvents.hasOwnProperty(t)&&this._notificationDriver.addEvent(t,this._listenedEvents[t])},initConnection:function(e,i,n){if(!n)try{n=require("DS/TopFrame/TopFrame")._tenantId}catch(e){t.log("3DNotification: did not find tenant with TopFrame, try with URL")}if(!n){var o=window.location.href.match(/https:\/\/([A-z0-9]+)-([A-z0-9]+)-[A-z0-9]+(-|.)/);n=o&&4==o.length&&("-"==o[3]||o[1]&&o[1].length>4)?(n=o[1]).toUpperCase():this.findCurrentTenant()}return this.getPlatformServicesUrl(e,i,n)},getPlatformServicesUrl:function(e,i,n){const o=this;function s(s){f.getServiceUrl({serviceName:"3dnotifications",platformId:n,onComplete:function(r){if(!r)return o.getPlatformServicesUrl(e,i);o.passportUrl||("string"==typeof s&&(o.passportUrl=s),o.passportUrl||(o.passportUrl=i||a.getApplicationConfiguration("app.urls.passport"))),this.socketIdentifier=null,this.isElectedSocket=null,this._notificationDriver=new p({listenedEvents:Object.keys(o._listenedEvents)}),o.tenantAgnosticPassportUrl||(o.tenantAgnosticPassportUrl=i||a.getApplicationConfiguration("app.urls.passport")),o.getParams(e).then((e=>{if(e.tenant=n,"object"==typeof r){for(var i=0;i<r.length;i++)if(r[i].url){o.notifServer=o.extractDomain(r[i].url),e&&e.login&&o.requestProxyTicket(e);break}}else"string"==typeof r&&(o.notifServer=o.extractDomain(r),e&&e.login&&o.requestProxyTicket(e));o.notifServer||t.log("3DNotification error : no intf url found need visual information")}))}})}return this.tenant=n,a.getApplicationConfiguration("app.urls.registry")?N.getPassportRegistryUrl(n).then((t=>s(t))).catch((e=>(t.log(`NotifManager getPlatformServicesUrl ${e}`),s()))):s()},findCurrentTenant:function(){var e=r.getApplicationConfiguration("app.mp.tenant");if(t.log("findCurrentTenant selected the PublicAPI.app.mp.tenant "+e),!e){try{var i,n=JSON.parse(r.user.properties.dashboards)}catch(e){t.log("3DNotification error: unable to parse user dahboards")}for(i in n)if(n[i].platformId){e=n[i].platformId,t.log("findCurrentTenant selected the first PublicAPI.user.properties.dashboards tenant "+e);break}}return t.log("findCurrentTenant ends with "+e),e},initFrameEvents:function(){var t=this;t.frame&&t._notifManagerView&&t._notificationDriver&&(t.frame.addEvent("onRightPanelOpened",(function(e){if(t._notifManagerView.closeAllAlerts(),"notification"===t.frame._visibleApp){t.topBar.setBadge("notification",0),t.badge=0,t.blockAlert=!0,t._notificationDriver.emit("notifCenterOpened",t.blockAlert);const e={action:"notifCenterOpened",data:{centerOpened:t.blockAlert}};t.notificationEvent(e)}})),t.frame.addEvent("onRightPanelClosed",(function(e){t.blockAlert=!1,t._notificationDriver.emit("resetNotifications",t.blockAlert);const i={action:"resetNotifications",data:{centerOpened:t.blockAlert}};t.notificationEvent(i)})))},getParams:async function(t){var e={};return e.currentLanguage=c.getCurrentLanguage(),e.currentLanguage||(e.currentLanguage=window.navigator.language),await this.getUserPromise,e.login=this.login,e.login||(e.login=t),y.language=e.currentLanguage,e},getServices:function(e=!1){return N.getServices().then((t=>{if(e){const e={action:"setServices",data:{currentTenant:y.tenant,services:t}};y.notificationEvent(e)}else a.publish("3dnotifinterne",{action:"setServices",services:t})})).catch((e=>(t.log(`NotifManager getServices ${e}`),[])))},getServiceUrl:function(e,i,n=!1){if(e)return N.getServiceUrl(e,i,n).catch((e=>{t.log(`NotifManager getServiceUrl ${e}`)}))},getAppInfos:function(e,i=!1,n=!1){return N.getAppIcon(e.appID).then((o=>{if(t.log(`NotifManager getAppInfos { app: ${e.appID}, icon: ${o} }`),o){if(i)return o;if(e.notif)e.notif.dispatchEvent("updatePicture",[{src:o}]);else if(n){const t={action:"setAppInfos",data:{src:o,notifID:e.notifID,clusterId:e.clusterId}};this.notificationEvent(t)}else a.publish("3dnotifinterne",{action:"setAppInfos",src:o,notifID:e.notifID,clusterId:e.clusterId})}})).catch((e=>t.log(`NotifManager getAppInfos ${e}`)))},addListener:function(t,e){a.subscribe(t,e)},addItem:function(t){var e=this;t.addEvent("publish",(function(t){a.publish(t.topic,t.data)})),t.addEvent("read",(function(i){e._notificationDriver.emit("notificationRead",i),e._notificationDriver.emit("decrementBadge",{platformId:t._attributes.platformId}),!i.clusterId&&t._attributes.clusterId&&(i.clusterId=t._attributes.clusterId);const n={...i,action:"readNotification",data:{id:i.id,read:!0}};e.notificationEvent(n),a.publish("3dnotifinterne",{action:"read",params:{...i,id:i.id,read:!0}})})),t.addEvent("actioned",(function(t){a.publish("3dnotifinterne",{action:"actioned",...t,params:{id:t.id,actioned:!0}});const i={...t,action:"readNotification",data:{...t,action:"actioned",params:{id:t.id,actioned:!0}}};e.notificationEvent(i)})),t.addEvent("alertBoxClosed",(function(){e.badge-=1,e._notificationDriver.emit("decrementBadge",{platformId:t._attributes.platformId})})),t.addEvent("updateLabel",(function(t){if(t&&t.id){var i={...t,action:"updateLabel",updateLabel:"updateLabel",params:{id:t.id,label:t.label,flag:t.flag}};a.publish("3dnotifinterne",i);const n={...t,action:"readNotification",data:i};e.notificationEvent(n)}e._notificationDriver.emit("notificationRead",i)})),e.notifCollection.add(t)},addNotification:function(t,e=!1){const i={...t,action:"addNotification",data:{notification:t,appName:y.appName,currentTenant:y.tenant,clusterId:t.CLUSTER_ID}};y.notificationEvent(i),a.publish("3dnotifinterne",{action:"addNotification",notification:JSON.stringify(t),appName:y.appName,currentTenant:y.tenant})},getActions:async function(e){switch(e.action){case"readConversation":y._notifConvView.deleteBubblesFromConv(e.data.tenant,e.data.convId);break;case"deleteMessage":y._notifConvView.deleteBubblesFromConv(e.data.tenant,e.data.convId,null,e.data.msgId);break;case"toINTF":switch(e.data.action){case"getSocketStatus":const t={action:"setSocketStatus",data:{socketStatus:y._notificationDriver.getSocketStatus(),...!!e.data.data.centerOpened&&{centerOpened:!0}}};y.notificationEvent(t);break;case"checkSocketStatus":y._notificationDriver.checkSocketStatus();break;case"getAppInfos":y.getAppInfos({appID:e.data.data.appID,notifID:e.data.data.notifID,clusterId:e.data.data.clusterId},!1,!0);break;case"getServices":y.getServices(!0);break;case"publish":a.publish(e.data.data.topic,e.data.data.data);break;case"rollbackPopupconfirmation":e.data.data.filename=e.data.data.file,await y.getUserPromise,e.data.data.user=y.login,y._notificationDriver.emit("toINTF",e.data);break;default:y._notificationDriver.emit("toINTF",e.data)}break;case"rollback":console.log("rollback from manager",e);const r={action:"rollbackPopup",data:{params:{file:e.file,id:e.id,isInNotifCenter:e.isInNotifCenter}}};y.notificationEvent(r),a.publish("3dnotifinterne",{action:"rollbackPopup",params:{file:e.file,id:e.id,isInNotifCenter:e.isInNotifCenter}});break;case"rollbackPopupconfirmation":await this.getUserPromise,y._notificationDriver.emit("rollback",{filename:e.file,user:this.login,confirmPopupResult:e.confirmPopupResult,id:e.id});break;case"getHistory":y._notificationDriver.emit("getHistory",{type:e.type,oldID:e.oldID,groupIDs:e.groupIDs});break;case"getFilterHistory":y._notificationDriver.emit("filter",{type:e.type,oldID:e.oldID,groupIDs:e.groupIDs,msg:y.filterValues.msg,first_date:y.filterValues.first_date,last_date:y.filterValues.last_date,tenants:y.filterValues.tenants,whoSettings:y.filterValues.whoSettings,archive:y.filterValues.archive});break;case"getUnreadTotal":y._notificationDriver.emit("getUnreadTotal");break;case"getFilterTotal":y._notificationDriver.emit("getFilterTotal",{msg:y.filterValues.msg,first_date:y.filterValues.first_date,last_date:y.filterValues.last_date,tenants:y.filterValues.tenants,whoSettings:y.filterValues.whoSettings,archive:y.filterValues.archive});break;case"getStarredTotal":y._notificationDriver.emit("getStarredTotal");break;case"getAppInfos":y.getAppInfos({appID:e.appID,notifID:e.notifID});break;case"getSettings":y._notificationDriver.emit("getSettings");break;case"getTenants":y._notificationDriver.emit("getTenants");break;case"getDates":y._notificationDriver.emit("getDates");break;case"getWhoSettings":y._notificationDriver.emit("getWhoSettings");break;case"getParams":a.publish("3dnotifinterne",{action:"setParams",params:{passportUrl:y.options.passportUrl,swymUrl:y.options.swymServer}});break;case"getServices":y.getServices();break;case"notificationRead":y.isFiltered&&(e.archive=y.filterValues.archive),y._notificationDriver.emit("notificationRead",e);break;case"actioned":y._notificationDriver.emit("notificationRead",e);break;case"updateSettings":y._notificationDriver.emit("updateSettings",e);break;case"notificationDelete":y.isFiltered&&(e.archive=y.filterValues.archive),y._notificationDriver.emit("notificationDelete",e);break;case"deleteAllNotification":y._notificationDriver.emit("deleteAllNotification",e);break;case"deleteAllFilteredNotification":e.archive=y.filterValues.archive,y._notificationDriver.emit("deleteAllFilteredNotification",e);break;case"unsubscribe":y._notificationDriver.emit("unsubscribe",e);break;case"NotifCenterOpened":y._notificationDriver.emit("NotifCenterOpened",e.blockAlert);break;case"resetNotifications":y._notificationDriver.emit("resetNotifications",y.blockAlert);break;case"filter":for(var i=[],n=0;n<e.values.what.length;n++)i.push(e.values.what[n]);0===i.length&&(i[0]=" "),y.filterValues={msg:i,first_date:y.getFormattedDate(new Date(e.values.first_date)),last_date:y.getFormattedDate(new Date(e.values.last_date)),tenants:e.values.tenants,whoSettings:e.values.whoSettings,archive:e.values.archive},y.isFiltered=!0,y._notificationDriver.emit("filter",y.filterValues);break;case"notifyBrowser":var o=e.titleNotif||"3DSwym Conversations",s=e.textNotif;await y.notifyWeb(e.tag,o,{ICON:{type:"login",data:e.login},PLATFORMID:e.tenant},s,"en",!1,(function(){t.log("browser notif has been clicked"),window.focus(),this.close()}));break;case"getMerge":y._notificationDriver.emit("getMerge",{type:e.type||"all",id:e.id,groupID:e.groupID,toBeActioned:e.toBeActioned,archive:y.isFiltered&&y.filterValues.archive,clusterId:e.clusterId});break;case"getTenantAgnosticMode":y._notificationDriver.emit("getTenantAgnosticMode",e);break;case"updateTenantAgnosticMode":y._notificationDriver.emit("updateTenantAgnosticMode",e);break;case"closeNotifCenter":y.frame&&"notification"===y.frame._visibleApp&&y.frame.closePanel("right");break;case"resetFilter":y.isFiltered=!1;break;case"getDNDStatus":a.publish("3dnotifinterne",{action:"setDNDStatus",isDND:y.blockPopup});break;case"setDNDStatus":t.log("NotifManager setDNDStatus ignored");break;case"notification":t.log("NotifManager notification ignored");break;default:t.log("Unknown action published on 3dnotifinterne : "+e.action)}},InitPushTo3dNotif:function(t){var e;a.subscribe(t,(function(t){switch(t.method){case"pushplatformid":t.data&&"3dswym"===t.data.provider.toLowerCase()&&y._notificationDriver.emit("getTokens",t.data.data);break;case"registerTenantApp":t.data&&(e=t.data.provider.toLowerCase()),e&&(y.listOfTenantApp[e]||(y.listOfTenantApp[e]=[])),y.listOfTenantApp[e].push(t.data.data);break;case"unregisterTenantApp":t.data&&(e=t.data.provider.toLowerCase()),e&&y.listOfTenantApp[e]&&y.listOfTenantApp[e].splice(y.listOfTenantApp[e].indexOf(t.data.data),1)}}))},requestProxyTicket:function(t){const e=this.passportUrl+"/login?service=INTF",i=this.tenantAgnosticPassportUrl+"/login?service=INTF";y._notificationDriver.activeConnection({login:t.login,currentLanguage:t.currentLanguage,tenant:t.tenant,iamUrl:e,tenantAgnosticIamUrl:i,notifServer:y.notifServer,onReconnect:()=>{0!==this.badge&&a.publish(`tenant_${this.tenant}_new_notif_content`,{message_type:"NEW_CONTENT",content_type:"message/notification",badge:this.badge})}})},computeAlertBox:async function(t,e){var i=this;if(e.ICON&&(e.ICON=await i.getIconInfo(e)),t.actions)for(var n=0;n<t.actions.length;n++){var s=t.actions[n];if(s.options&&s.options.event&&("url"===s.options.event.type||"UI"===s.options.event.type)){var a=s.options.event;if(s.options&&s.options.event&&"UI"===s.options.event.type){var r=s.options.event.options;if(r.attachments&&r.attachments.length>0)for(var c=0;c<r.attachments.length;c++)"button"===r.attachments[c].type&&(a=r.attachments[c].options.event)}if(a.options&&a.options.service&&a.options.uri){var l=await this.getServiceUrl(a.options.service.name||a.options.service,e.PLATFORMID,!0);a.options.url=l+a.options.uri,"USASWYM_AP"===e.APPID&&(a.options.csrf=l+"/api/index/tk/")}else if("select"===s.type&&a.options&&a.options.length>0)for(var d=0;d<a.options.length;d++){l=await this.getServiceUrl(a.options[d].service.name||a.options[d].service,e.PLATFORMID,!0);a.options[d].url=l+a.options[d].uri,"USASWYM_AP"===e.APPID&&(a.options[d].csrf=l+"/api/index/tk/")}}}return new o({id:e.ID,img:e.ICON,text:t.nls.msg,options:t.actions,appIconBorder:e.ICON&&"appID"===e.ICON.type,listOfService:await N.getServices(),readState:!1,isInNotifCenter:!1,actioned:!1,provider:e.APPID,refresh:e.REFRESH,platformId:e.PLATFORMID?e.PLATFORMID:"",clusterId:e.CLUSTER_ID,appName:i.appName,currentTenant:i.tenant})},getIconInfo:async function(t){const e="./resources/en/1/webapps/NotifAlertBox/assets/icons/notifIcon.png";if(!t.ICON)return e;switch(t.ICON.type){case"url":if(!t.ICON.data.service)return t.ICON.data;const i=await y.getServiceUrl(t.ICON.data.service.name||t.ICON.data.service,t.PLATFORMID);if(i)return i+t.ICON.data.uri;break;case"login":let n=y.swymServer;if(n&&t.PLATFORMID.toLowerCase()==y.tenant.toLowerCase()||(n=await y.getServiceUrl("3dswym",t.PLATFORMID)),n)return`${n}/api/user/getpicture/login/${t.ICON.data}`;break;case"appID":const o=await y.getAppInfos({appID:t.ICON.data},!0);if(o)return o;break;default:return e}return e},authenticated:function(){t.log("3DNotification : socket connected !"),a.publish("3dnotifauthenticated",{action:"authenticated"}),a.publish("3dnotifinterne",{action:"notification",data:{action:"setSocketStatus",data:{socketStatus:"connected"}}})},authenticate_error:function(e){t.log("3DNotification : socket error :"+JSON.stringify(e))},token_registered:function(){t.log("3DNotification : token registred !")},token_registered_error:function(e){t.log("3DNotification : token registred error"+JSON.stringify(e))},updateBadge:function(t){y.blockAlert||void 0!==t.badge&&(y.topBar.setBadge("notification",t.badge),y.badge=t.badge)},refreshCenterView:function(){a.publish("3dnotifinterne",{action:"refreshCenterView"})},setSetting:function(t){a.publish("3dnotifinterne",{action:"setSetting",setting:t.setting})},formatSettings:function(t,e){if(!t||0===t)return[];if(!e||0===e.length)return t;let i,n,o=[];for(var s=0;s<t.length;s++){i=0===s?null:t[s-1].APPID,n=s===t.length-1?null:t[s+1].APPID;for(var a=0;a<e.length;a++)t[s].APPID!==e[a].id||t[s].APPID!==i&&t[s].APPID!==n||o.push({id:t[s].ID,name:t[s].NAME,serviceName:e[a].title,service:e[a].id,icon:e[a].icon,sortIndex:t[s].sortIndex,subscribe:t[s].SUBSCRIBE,notif_by_ui:t[s].NOTIF_BY_UI,notif_by_email:t[s].NOTIF_BY_EMAIL,notif_by_browser:t[s].NOTIF_BY_BROWSER,unsubscribe_date:t[s].UNSUBSCRIBE_DATE})}return o.sort((function(t,e){var i=t.serviceName.toLowerCase(),n=e.serviceName.toLowerCase();return i<n?-1:i>n?1:0})),o},setSettings:function(e){let i=this,n=[];for(var o=0;o<e.settings.length;o++)-1===n.indexOf(e.settings[o].APPID)&&n.push(e.settings[o].APPID);return N.getAppsInfo(n).then((t=>{t&&0!==t.length&&a.publish("3dnotifinterne",{action:"setSettings",settings:i.formatSettings(e.settings,t)})})).catch((e=>t.log(`NotifManager setSettings ${e}`)))},checkRegisteredApp:function(t,e,i){return!this.listOfTenantApp[t]||!this.listOfTenantApp[t][e]||(a.publish("3dnotifexterneapi",{action:"getCurrentConversation"}),!1)},refreshForRollback:function(){y.notificationEvent({action:"refreshForRollback",data:{}}),a.publish("3dnotifinterne",{action:"refreshForRollback"})},setUnreadTotal:function(t){const e=JSON.parse(t.unread)[0].UNREAD;"number"==typeof e&&a.publish("3dnotifinterne",{action:"setUnreadTotal",unread:e})},setFilteredTotal:function(t){void 0!==t.count&&a.publish("3dnotifinterne",{action:"setFilteredTotal",count:t.count,notifications:t.notifications})},setStarredTotal:function(t){const e=JSON.parse(t.starred)[0].STARRED;e&&a.publish("3dnotifinterne",{action:"setStarredTotal",starred:e})},setHistory:function(t){a.publish("3dnotifinterne",{action:"setHistory",notifications:t.notifications,language:y.language,appName:y.appName,starred:t.action,currentTenant:y.tenant})},setMerge:function(t){a.publish("3dnotifinterne",{action:"setMerge",notifications:t.notifications,id:t.id,appName:y.appName,toBeActioned:t.toBeActioned,currentTenant:y.tenant,clusterId:t.clusterId})},setNotifications:function(t){a.publish("3dnotifinterne",{action:"setNotifications",notifications:t.notifications,appName:y.appName,currentTenant:y.tenant})},setDates:function(t){a.publish("3dnotifinterne",{action:"setDates",Dates:t})},setWhoSettings:function(t){a.publish("3dnotifinterne",{action:"setWhoSettings",settings:t})},setTenants:function(t){var e=JSON.parse(t.tenants);f.getPlatformServices({onComplete:function(t){const i=Object.values(t),n=Object.values(e).map((t=>{const e=i.find((e=>e.platformId===t.PLATFORMID));return e&&e.displayName?t.displayName=e.displayName:t.NAME&&(t.displayName=t.NAME),t}));a.publish("3dnotifinterne",{action:"setTenants",tenants:JSON.stringify(n)})}})},doRTConvEvent:function(t){if(t&&t.action)switch(t.action){case"socketIdentifier":"boolean"==typeof t.socketIdentifier&&(y.socketIdentifier=t.socketIdentifier);break;case"isElectedSocket":"boolean"==typeof t.isElectedSocket&&(y.isElectedSocket=t.isElectedSocket);break;case"blockPopup":"boolean"==typeof t.blockPopup&&(y.blockPopup=t.blockPopup),a.publish("3dnotifinterne",{action:"setDNDStatus",isDND:y.blockPopup});const e={action:"setDNDStatus",data:{isDND:y.blockPopup}};y.notificationEvent(e)}},getBlockPopup:function(){a.publish("im.ds.com",{action:"getBlockPopup"})},getIsElectedSocket:function(){y.socketIdentifier||a.publish("im.ds.com",{action:"getSocketIdentifier"}),a.publish("im.ds.com",{action:"getIsElectedSocket"})},setSubscribedState:function(t){a.publish("INTFSubscriptionTopic",{action:"setSubscribedState",state:t.state})},doSwymEvents:function(t){"contextChange"!==t.action&&"contextChangeResponse"!==t.action||(t.data&&t.data.containerId&&"conversation"===t.data.containerType?(y.swymContext=t.data.containerId,y._notifConvView.deleteBubblesFromConv(y.tenant,y.swymContext),y._notificationDriver.emit("syncSwymConvNotif",{platformId:y.tenant,communityId:y.swymContext})):y.swymContext=void 0)},doSwymMobileEvents:function(t){"pushToken"!==t.action&&"deleteToken"!==t.action||y._notificationDriver.emit(t.action,t.data)},notifyRichClient:function(t,e){a.publish("NotificationRichClient",{action:t,data:e})},notifySystem:async function(e,i){var n,o=this;if(e&&e.message){var r=decodeURIComponent(escape(atob(e.message)));n=JSON.parse(r)}if(n){n.isRTConv||(a.publish(n.actions[0].options.event.options.topic,n.actions[0].options.event.options.data),v.trackNotifSystem({eventAction:"notifySystem",eventLabel:"System notification",persDim:{pd1:n.actions[0].options.event.options.topic}}));try{if((!this.isMobileApp||this.isDesktopApp)&&this._notifConvView){var c=n.actions[0].options.event.options.data.external_app_id;if("3DSWYM"===c&&"INSTANT_MESSAGE"===n.actions[0].options.event.options.data.message_type){var l=n.actions[0].options.event.options.data.author.login;if(l&&l!==o.login){var d=n.actions[0].options.event.options.data.message_id,f=n.actions[0].options.event.options.topic,g=n.isRTConv?n.actions[0].options.event.options.data.subject_uri:n.actions[0].options.event.options.data.container_uri,u=n.actions[0].options.event.options.data.community_id,p=n.actions[0].options.event.options.data.community_title,h=n.actions[0].options.event.options.data.community_type,m=n.actions[0].options.event.options.data.message_details.content;m&&(m=t.String.unescapeHTML(m));var b=n.actions[0].options.event.options.data.author.firstName+" "+n.actions[0].options.event.options.data.author.lastName;f=(f=f.substring(f.indexOf("_")+1,f.length)).substring(0,f.indexOf("_"));const r=await o.getServiceUrl("3dswym",f);let S=r;if("my3dexperience"==o.appName&&(S=await o.getServiceUrl(o.appName,f),S+="/social"),await o.getUserPromise,S&&"dm"===h&&l!==o.login){var w=r+"/api/user/getpicture/login/"+l;w=s.proxifyUrl(w,{proxy:"passport"})||w;var N=S+"/dm/"+g,y={messageId:d,platformId:f,communityId:u,communityTitle:p,userLogin:l,userName:b,infoTxt:m,pathPicture:w,events:{click:function(t){if(!o.isMobileApp&&t)window.open(N,"_blank").focus();else if(o.isMobileApp||("3dswym"==o.appName||"my3dexperience"==o.appName)&&f==o.tenant)a.publish("app.3DSwym",{action:"navigationRequest",data:{containerId:u,containerUri:g,containerType:"conversation"},from:{app:"3DNotification",component:"conversationNotification"}}),a.publish("im.ds.com",{action:"minimizeCollab"});else{window.open(N,o.appName+f).focus()}v.trackNotifSystem({eventAction:"notifySystem",eventLabel:"Bubble notification",persDim:{pd1:o.appName,pd2:c,pd3:b}})}}};if("dm"===h||o.tenantAgnosticMode||f&&o.tenant&&f.toLowerCase()===o.tenant.toLowerCase()?(this.notifyPopupAllowed()&&this.swymContext!=u&&o._notifConvView.addNotification(y),this.notifyBrowserAllowed(!0)&&this.notifyRichClient("newConversationMessage",{authorName:b,authorLogin:l,message:m,convId:u,convSubjectUri:g,messageId:d,platformId:f,rtconv:!!n.isRTConv})):t.log("3DNotification: 3DSwym context prevented bubble display"),!i)if("Notification"in window){if("dm"===h||o.tenantAgnosticMode||f&&o.tenant&&f.toLowerCase()==o.tenant.toLowerCase()){var D=function(){return o.notifyWeb(e.tag,"3DSwym Conversations",{ICON:`${r}/api/user/getpicture/login/${l}`},m,"en",!1,(function(){window.open(N,"_self").focus()}))};"granted"===Notification.permission?await D():"denied"===Notification.permission&&"default"!==Notification.permission||Notification.requestPermission((function(t){if("granted"===t)return D()}))}}else t.log("This browser does not support desktop notification")}}}}}catch(t){console.log("3DNotification - Error : "+JSON.stringify(t))}}},notifyCenter:function(t){y.addNotification(t)},readNotification:function(t){a.publish("3dnotifinterne",{action:"read",params:{...t,id:t.id,read:t.read,scope:t.scope||null,starred:t.starred,starredState:t.param}})},deleteNotification:function(t){a.publish("3dnotifinterne",{action:"delete",params:{id:t.id,read:t.read}})},notify:async function(t){var e=decodeURIComponent(escape(window.atob(t.MESSAGE))),i=JSON.parse(e),n=!0,o=!0;if(y.isFiltered)if(t.CREATION_DATE>=y.filterValues.first_date&&t.CREATION_DATE<=y.filterValues.last_date)for(var s=0;s<y.filterValues.tenants.length;s++)if(t.PLATFORMID===y.filterValues.tenants[s])for(var a=0;a<y.filterValues.msg.length;a++){if(-1!==JSON.stringify(i).search(y.filterValues.msg[a])){n=!0;break}n=!1}else n=!1;else n=!1;if(n){if(!y.blockAlert&&y.notifyPopupAllowed()){var r=await y.computeAlertBox(i,t);y.addItem(r),o=!1}t.NOTIFBROWSER&&await y.notifyWeb(t.tag,"3DEXPERIENCE Platform Notification",t,i.nls.msg,y.language,o),y.addNotification(t)}},extractDomain:function(t){var e;return(e=t.indexOf("://")>-1?t.split("/")[2]:t.split("/")[0]).indexOf(":")>-1?e:e+":443"},getFormattedDate:function(t){var e=t.getFullYear(),i=(1+t.getMonth()).toString();i=i.length>1?i:"0"+i;var n=t.getDate().toString();return e+"-"+i+"-"+(n=n.length>1?n:"0"+n)},notifyPopupAllowed:function(){return"boolean"==typeof y.blockPopup?(t.log(`3DNotification - Popups blocked: ${y.blockPopup}`),!y.blockPopup):(t.log("3DNotification - Popup blocked: false (default, unknown presence)"),y.getBlockPopup(),!0)},notifyBrowserAllowed:function(e=!1){return!!(e||"granted"===Notification.permission&&document.hidden)&&(y.notifyPopupAllowed()?!1===y.isElectedSocket?(t.log("3DNotification - Browser notifications OFF (not elected socket)"),!1):!0===y.isElectedSocket?(t.log("3DNotification - Browser notifications ON (is elected socket)"),!0):(t.log("3DNotification - Browser notifications ON (default, unknown socket election status)"),y.getIsElectedSocket(),!0):(t.log("3DNotification - Popups blocked (DND presence)"),!1))},notifyWeb:async function(e,i,n,o,s,a,r){var c;if(c=a?await y.getIconInfo(n):n.ICON,y.notifyBrowserAllowed()){t.log("3DNotification Browser notification"),o=o.replace(/<(?!\strong)[^>]*>/gi,"");var l=new Notification(i,{lang:s,body:o,icon:c,tag:e});l.onclick=function(t){if(t.preventDefault(),r)r();else{l.close();var e=window.open("","notification");e.focus(),e.close()}};setTimeout((function(){l.close()}),5e3)}},deleteSwymConvNotif:function(t){t&&y._notifConvView.deleteBubblesFromConv(t.platformId,t.communityId,t.login)},setTenantAgnosticMode:function(t){t&&(a.publish("3dnotifinterne",{action:"setTenantAgnosticMode",tenantAgnosticMode:t.tenantAgnosticMode,hidePlatformSelection:t.hidePlatformSelection}),this.tenantAgnosticMode=t.tenantAgnosticMode)},notificationEvent:async function(e){if(e&&e.action&&e.data)switch(e.action){case"deleteSwymConvNotif":this._notifConvView.deleteBubblesFromConv(e.data.platformId,e.data.communityId,e.data.login);break;case"syncSwymConvNotif":default:break;case"setCenterVersion":this.centerVersion=e.data.version,console.log("3DNotification manager - Center version : "+this.centerVersion);break;case"setHistory":case"setNotifications":case"setMerge":e.data.language=this.language,e.data.appName=this.appName,e.data.currentTenant=this.tenant;break;case"setSettings":this.centerVersionSet&&this.centerVersion===e.data.centerVersion||(this.centerVersion=e.data.centerVersion,this.centerVersionSet=!0);let n=[];for(var i=0;i<e.data.settings.length;i++)-1===n.indexOf(e.data.settings[i].APPID)&&n.push(e.data.settings[i].APPID);await N.getAppsInfo(n).then((t=>{t&&0!==t.length&&(e.data.settings=y.formatSettings(e.data.settings,t))})).catch((e=>t.log(`NotifManager setSettings_2 ${e}`)));break;case"setTenantAgnosticMode":this.tenantAgnosticMode=!!e.data.isTenantAgnostic}a.publish("3dnotifinterne",{action:"notification",data:e})}})}));