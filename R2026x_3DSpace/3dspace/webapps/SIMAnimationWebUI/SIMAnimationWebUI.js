define("DS/SIMAnimationWebUI/CATAnimationTimeline",["UWA/Core","UWA/Event","DS/Core/Core","DS/Controls/Timeline","DS/Core/PointerEvents","DS/VisuEvents/EventsManager","DS/CoreEvents/Events"],(function(e,t,i,n,a,o,s){"use strict";var r=n.extend({className:"AnimationTimeline",_play:function(){var e,t=this,i=new Date;if(t._isPlaying&&!t._isRewinding&&!t._flaggedPause){if(void 0===t.startDate&&(t.startDate=new Date(i.getTime()-t.getValue()/t.playbackSpeed*1e3)),e=Math.abs(i-t.startDate),!0===t.hasSnapped&&(t.snapDifference=t.snapValue/t.playbackSpeed-e,t.startDate=new Date(i.getTime()-t.snapValue/t.playbackSpeed),t.hasSnapped=!1),void 0!==t.snapDifference&&(e=t.snapDifference+e,t.snapDifference=void 0),e>1e3*t.totalAnimationTime/t.playbackSpeed)return window.clearTimeout(t.playTimeOut),t.frameCounter=parseInt(1e3*t.totalAnimationTime/t.frameDelay),t.setValue(t.totalAnimationTime),t._isPlaying=!1,t.hasSnapped=!1,t.snapDifference=void 0,t.elements.container.removeClassName("wux-ui-state-active"),void s.publish({event:"CATANIMATIONTIMELINE/FINISH"});if(isNaN(e))return window.clearTimeout(t.playTimeOut),t._isPlaying=!1,t.hasSnapped=!1,t.frameCounter=void 0,t.snapDifference=void 0,void t.elements.container.removeClassName("wux-ui-state-active");t.elements.container.addClassName("wux-ui-state-active"),t.setValue(e*t.playbackSpeed/1e3),t.frameCounter=parseInt(e*t.playbackSpeed/t.frameDelay),t.playTimeOut=setTimeout((function(){requestAnimationFrame((function(){t._play.call(t)}))}),t.frameDelay)}},_rewind:function(e){var t,i,n=this;if(n._isPlaying&&n._isRewinding&&!n._flaggedPause){if(void 0===e||!0===n.hasSnapped?(n.hasSnapped=!1,n.startDate=new Date,i=1e3*n.getValue()/n.playbackSpeed,e=i,console.log("rewindStartTime: "+e+" self.hasSnapped : "+n.hasSnapped)):(t=new Date,i=e-Math.abs(t-n.startDate)),i<n.options.minValue)return window.clearTimeout(n.rewindTimeOut),n.setValue(0),n.frameCounter=0,n._isPlaying=!1,n._isRewinding=!1,n.hasSnapped=!1,void n.elements.container.removeClassName("wux-ui-state-active");if(isNaN(i))return window.clearTimeout(n.rewindTimeOut),n._isPlaying=!1,n._isRewinding=!1,n.hasSnapped=!1,n.frameCounter=void 0,void n.elements.container.removeClassName("wux-ui-state-active");n.elements.container.addClassName("wux-ui-state-active"),n.setValue(i/1e3*n.playbackSpeed),n.frameCounter=parseInt(i*n.playbackSpeed/n.frameDelay),n.rewindTimeOut=setTimeout((function(){requestAnimationFrame((function(){n._rewind.call(n,e)}))}),n.frameDelay)}},play:function(e,t,i,n){var s=this;s.startDate=void 0,s._flaggedPause=void 0,s.frameCounter=void 0,s.snapDifference=void 0,s._isPlaying=!0,void 0!==i&&(s._isRewinding=i),s.totalAnimationTime=t,void 0===n&&(n=!0),n&&this._modelEvents.publish({event:"PLAY",context:this}),window.clearTimeout(s.playTimeOut),window.clearTimeout(s.rewindTimeOut),this.elements.container.addEvent(a.POINTERDOWN,(function(e){s.hasSnapped=!0,s.elements.container.addClassName("wux-ui-state-active"),s.pause()})),o.addEvent(document,"onLeftMouseUp",(function(e){!0===s.hasSnapped&&(s.snapValue=1e3*s.getValue(),setTimeout((function(){s._isPlaying=!0,s._isRewinding?(window.clearTimeout(s.rewindTimeOut),s._rewind()):(window.clearTimeout(s.playTimeOut),s._play())}),100))})),o.addEvent(document,"onRelease",(function(e){!0===s.hasSnapped&&(s.snapValue=1e3*s.getValue(),setTimeout((function(){s._isPlaying=!0,s._isRewinding?(window.clearTimeout(s.rewindTimeOut),s._rewind()):(window.clearTimeout(s.playTimeOut),s._play())}),100))})),s.frameDelay=1e3*t/e,s._isRewinding?s._rewind():s._play()},pause:function(e){e&&(this._flaggedPause=!0),void 0===e&&(e=!0),this.hasSnapped||this.elements.container.removeClassName("wux-ui-state-active"),this._isPlaying=!1,this.frameCounter=void 0,e&&this._modelEvents.publish({event:"PAUSE",context:this})},stop:function(e){void 0===e&&(e=!0),this.startDate=void 0,this._isRewinding=!1,this._isPlaying=!1,this.elements.container.removeClassName("wux-ui-state-active"),this.pause(!0),this.frameCounter=0,this.setValue(this.options.minValue),this.hasSnapped=!1,this.frameCounter=void 0,this.snapDifference=void 0,e&&this._modelEvents.publish({event:"STOP",context:this})},setValue:function(e,t){var i=this;i.options.graduations.forEach((function(e){var t=e.value+i.options.minValue;i._value[1]>=t&&0===e.state&&(e.state=1,e.onEvent&&e.onEvent.call(i)),i._value[1]<t&&e.state>0&&(e.state=0)})),this._setValue(e,t),s.publish({event:"CATAnimationTimeline/CHANGE",data:{value:i._value[1]}})},setPlaybackSpeed:function(e){e>0&&(this.playbackSpeed=e)},getPlaybackSpeed:function(){return this.playbackSpeed}});return e.namespace("DS/KinPlayExperience/AnimationTimeline",r)})),define("DS/SIMAnimationWebUI/AnimationPlayer",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/SIMAnimationWebMdl/SIMAnimationServices","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/IdPath","DS/WebSystem/Environment","DS/Visualization/SceneGraphFactory","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/MathematicsES/MathAxisJSImpl","DS/MathematicsES/MathPointJSImpl","DS/MathematicsES/MathNameSpace","DS/MathematicsES/MathTolerancesJS","DS/Visualization/TextNode"],(function(e,t,i,n,a,o,s,r,l,m,d,c,u,h,p,v){"use strict";var g=t.extend({init:function(e,t,i,n){if(void 0!==e&&void 0!==t){var a=this;a.bUsingJSON=!1,void 0!==i&&void 0!==n&&(a.bUsingJSON=i,a.RootNode=n),a.movingProducts=[],a.movingProductsInitalPositions=[],a.bUsingPathElement=!1;var s=r.isSet("KINPlay.UsePathElement");a._OOCActive=!1,!1===a.bUsingJSON&&e.experience.RuntimeMode.OOC&&(a._OOCActive=e.experience.RuntimeMode.OOC),a.frmWindow=e,a.viewer=a.frmWindow.getViewer();var l=a.viewer.getSceneGraphOverrideSetManager();a.frmWindow.getViewer().getRootNode();void 0!==a.frmWindow.experience&&(a.modelRoot=a.frmWindow.experience.getRootBag()),l.getNumberOfSceneGraphOverrideSets()>0&&(a.sceneGraphOverrideSet=l.getSceneGraphOverrideSetByName("AnimationPlayer")),a.sceneGraphOverrideSet||(s||!1===a._OOCActive?!1===a.bUsingJSON?(a.sceneGraphOverrideSet=new o(a.modelRoot),a.sceneGraphOverrideSet.name="AnimationPlayer"):(a.sceneGraphOverrideSet=new o(a.RootNode),a.sceneGraphOverrideSet.name="AnimationPlayer"):(a.sceneGraphOverrideSet=new o(a.modelRoot,"rootBag"),a.sceneGraphOverrideSet.name="AnimationPlayer"),l.pushSceneGraphOverrideSet(a.sceneGraphOverrideSet));var m=a.sceneGraphOverrideSet.getOverrides();a.sceneGraphOverrideSet.deleteOverrides(m),a.viewpoint=a.frmWindow.getViewpoint(),a.animation=t}},reset:function(){var e=this;e.applyInitialPosition(),void 0!==e.RootChildNodeForAllAnimProp&&void 0!==e.sgnode&&(e.sgnode.removeChild(e.RootChildNodeForAllAnimProp),e.RootChildNodeForAllAnimProp=void 0)},getInstancePathFromExternalObject:function(e){for(var t=[],i=e.replace(/\[|\]/g,"").split(" "),n=0;n<i.length;++n)""!==i[n]&&t.push(i[n].split("#")[1]);return t},getChildById:function(e,t,i){var n,a,o,s,r;if(void 0!==i&&i)for(n=0,a=e.parents.length;n<a;n++){if(void 0!==(s=e.parents[n]).persistentId&&s.pesristentId===t)return s;if(null!==(r=this.getChildById(s,t,1)))return r}else for(n=0,a=e.children.length;n<a;n++){if(void 0!==(o=e.children[n]).persistentId&&o.persistentId===t)return o;if(null!==(r=this.getChildById(o,t)))return r}return null},getPathElementById:function(e,t){var i=this.getChildById(e,t);return this.getPathElementByNode(e,i)},getPathElementByNode:function(e,t){var i=null;if(null!==e){if(e===t)return i=new n([e]);for(var a=0;a<e.children.length;++a){var o=e.children[a];if(o===t)return(i=new n([e])).addElement(o),i;var s=this.getPathElementByNode(o,t);if(null!==s){i=new n([e]);for(var r=0;r<s.getLength();++r)i.addElement(s.getElement(r))}}}return i},getPathElementByInstancePath:function(e,t){for(var i=e,a=[i],o=0;o<t.length;++o){var s=this.getPathElementById(i,t[o]);if(s){for(var r=1;r<s.getLength();++r)a.push(s.getElement(r));i=s.getLastElement()}}return new n(a)},goToIndex:function(e){var t=this;if(void 0!==t.animation.attributes._VariantLine.attributes._OrderedIndexedValues){t.animation.attributes._VariantLine.attributes._OrderedIndexedValues[e];for(var i=t.modelRoot,a=t.animation.attributes._VariantLine.attributes._OrderedIndexes[e],o=t.animation.attributes._AnimChannels,s=0;s<o.length;++s){var r=o[s],l=new n,m=new Array;if(void 0!==r.attributes._ExternalObject){var d=r.attributes._ExternalObject;if("string"==typeof d){var c;c=t.getInstancePathFromExternalObject(d),l=t.getPathElementByInstancePath(i,c),t.bUsingPathElement=!0}else void 0!==d.relationTarget?!0===t._OOCActive?m=d.relationTarget:(l=d.relationTarget,t.bUsingPathElement=!0,d.relationTarget.externalPath[0]!==t.modelRoot&&l.externalPath.unshift(t.modelRoot)):void 0===d.relationTarget&&!0===t.bUsingJSON&&(t.bUsingPathElement=!0,l=d)}var u=r.attributes._AnimProperties;void 0!==t.RootChildNodeForAllAnimProp&&void 0!==t.sgnode&&(t.sgnode.removeChild(t.RootChildNodeForAllAnimProp),t.RootChildNodeForAllAnimProp=void 0);for(var h=0;h<u.length;++h){var p=u[h];"undefined"!==a&&"undefined"!==p.attributes&&"undefined"!==p.attributes._ValuesTimeIndex||console.error("Animation property type "+p.attributes._Type+" not supported");var v=p.attributes._ValuesTimeIndex.indexOf(a);if(-1===v){var g=p.attributes._ValuesTimeIndex;if(g&&g.length){var b=g.slice();if(b&&b.length&&a>0)for(;b.length&&b.at(-1)>a;)b.pop();v=b.length-1}}if(-1!==v)switch(p.attributes._Type){case"CATANIM_POSITION":t.applyPosition(m,p,v,l,e);break;case"CATANIM_COLOR":t.applyColor(m,p,v);break;case"CATANIM_OPACITY":t.applyOpacity(m,p,v);break;case"CATANIM_VISIBILITY":t.applyVisibility(m,p,v);break;case"CATANIM_VIEWPOINT":t.applyViewpoint(p,v);break;case"CATANIM_HIGHLIGHT":t.applyHighlight(m,p,v,l);break;case"CATANIM_MOTELEMENT":void 0!==p.attributes._InterpretType?t.applyCustomVisu(m,p,v,l,e):console.warn("Animation property type "+p.attributes._Type+" not supported");break;default:console.warn("Animation property type "+p.attributes._Type+" not supported")}}}}},applyPosition:function(e,t,n,a){var o,r=this,l=t.attributes._ValuesDouble,m=new i.Matrix4(l[12*n],l[12*n+3],l[12*n+6],l[12*n+9],l[12*n+1],l[12*n+4],l[12*n+7],l[12*n+10],l[12*n+2],l[12*n+5],l[12*n+8],l[12*n+11],0,0,0,1),d=new s(e);if(!0===r.bUsingPathElement&&a.getLength()){var c=r.sceneGraphOverrideSet.getOverridesFromPathElement(a);if(c)for(var u=0;u<c.length;u++)o=c[u];o||(o=r.sceneGraphOverrideSet.createOverride([a]))}else(o=r.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(d))||(o=r.sceneGraphOverrideSet.createIdPathOverride(d));if(o){if(0===r.movingProducts.length){!0===r.bUsingPathElement&&a.getLength()?r.movingProducts.push(a):r.movingProducts.push(e);var h=o.getPosition();r.movingProductsInitalPositions.push(h)}if(r.movingProducts.length>0)if(-1===(!0===r.bUsingPathElement&&a.getLength()?r.movingProducts.indexOf(a):r.movingProducts.indexOf(e))){!0===r.bUsingPathElement&&a.getLength()?r.movingProducts.push(a):r.movingProducts.push(e);h=o.getPosition();r.movingProductsInitalPositions.push(h)}}else console.log(" pathElement not found for this channel ");o&&o.setPosition(m)},b64ToUint6:function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:43===e?62:47===e?63:0},base64DecToArr:function(e,t){for(var i,n,a=e.replace(/[^A-Za-z0-9\+\/]/g,""),o=a.length,s=t?Math.ceil((3*o+1>>>2)/t)*t:3*o+1>>>2,r=new Uint8Array(s),l=0,m=0,d=0;d<o;d++)if(n=3&d,l|=this.b64ToUint6(a.charCodeAt(d))<<18-6*n,3===n||o-d==1){for(i=0;i<3&&m<s;i++,m++)r[m]=l>>>(16>>>i&24)&255;l=0}return r},componentToHex:function(e){var t=e.toString(16);return 1===t.length?"0"+t:t},rgbToHex:function(e,t,i){var n=this;return"#"+n.componentToHex(e)+n.componentToHex(t)+n.componentToHex(i)},applyColor:function(e,t,i){var n=this,a=t.attributes._ValuesOctet,o=a[4*i+3];if(void 0===o&&"binary/Base64"==a.type){var r=a.value;a=n.base64DecToArr(r)}if(void 0!==(o=a[4*i+3])){var l=1===o?n.rgbToHex(a[4*i],a[4*i+1],a[4*i+2]):null,m=new s(e),d=n.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(m);d||(d=n.sceneGraphOverrideSet.createIdPathOverride(m)),d&&d.setColor(l)}},applyOpacity:function(e,t,i){var n=this,a=t.attributes._ValuesOctet,o=a[2*i+1];if(void 0===o&&"binary/Base64"==a.type){var r=a.value;a=n.base64DecToArr(r)}if(o=a[2*i+1]){var l=1===o?a[2*i]/255:null,m=new s(e),d=n.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(m);d||(d=n.sceneGraphOverrideSet.createIdPathOverride(m)),d&&d.setOpacity(l)}},applyVisibility:function(e,t,i){var n=this,a=t.attributes._ValuesOctet,o=a[i];if(void 0===o&&"binary/Base64"==a.type){var r=a.value;o=n.base64DecToArr(r)[i]}if(void 0!==o){var l=1===o,m=new s(e),d=n.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(m);d||(d=n.sceneGraphOverrideSet.createIdPathOverride(m),console.log(" applyVisibility currentOverride "+d)),d&&d.setVisibility(l)}},applyViewpoint:function(e,t){var n=e.attributes._ValuesDouble,a=new i.Vector3(n[15*t],n[15*t+1],n[15*t+2]),o=new i.Vector3(n[15*t+3],n[15*t+4],n[15*t+5]),s=(new i.Vector3).crossVectors(a,o),r=new i.Matrix4(s.x,o.x,-a.x,0,s.y,o.y,-a.y,0,s.z,o.z,-a.z,0,0,0,0,1),l=(new i.Quaternion).setFromRotationMatrix(r),m=new i.Vector3(n[15*t+9],n[15*t+10],n[15*t+11]),d=new i.Vector3(n[15*t+12],n[15*t+13],n[15*t+14]),c=m.distanceTo(d);this.viewpoint.getControl().moveTo({target:d,orientation:l,distanceToTarget:c})},applyHighlight:function(e,t,i,n){var a=this,o=t.attributes._ValuesOctet,s=o[i];if(void 0===s&&"binary/Base64"==o.type){var r=o.value;s=a.base64DecToArr(r)[i]}var l,m=WUX.Selection.HSOManager;if(!0===a.bUsingPathElement&&n.getLength())l={pathElement:n};else{for(var d=new Array,c=1;c<e.length;++c){var u=e[c];d.push(u)}l={pathElement:n=a.frmWindow.experience.pad3DViewer.getController().buildPathFromArray(d)}}0===s?m.remove(l):1===s&&m.add(l)},applyCustomVisu:function(e,t,i,n){var a=this;new s(e);if(!0===a.bUsingPathElement&&n.getLength()?void 0===a.sgnode&&(a.sgnode=n.getLastElement()):void 0===a.sgnode&&(a.sgnode=a.modelRoot),void 0!==a.sgnode){var o=t.attributes._ValuesString[i],r=t.attributes._InterpretType;if("arrowOrToroid"===r){void 0===a.RootChildNodeForAllAnimProp&&(a.RootChildNodeForAllAnimProp=new d),void 0===o.arrowType&&(o=JSON.parse(o));var l=o.arrowType,m=o.direction,c=o.support_1;void 0!==l&&void 0!==m&&void 0!==c&&("arrowFrom"===l||"arrowTo"===l?a.createArrow(o):a.createToroid(o)),a.viewer.render()}else if("lineWithText3D"===r){void 0===a.RootChildNodeForAllAnimProp&&(a.RootChildNodeForAllAnimProp=new d),void 0===o.distance&&(o=JSON.parse(o));var u=o.distance,h=o.line,p=o.scale;void 0!==u&&void 0!==h&&void 0!==p&&a.createLineWithText(u,h,p),a.viewer.render()}else if("glyph2D"===r&&"glyph"==o.motionID&&o.iconURL){["contact","probe","joint"].indexOf(o.category)>=0&&(void 0===a.RootChildNodeForAllAnimProp&&(a.RootChildNodeForAllAnimProp=new d),a.createGlyph2D(o),a.viewer.render())}}},createArrow:function(e){var t=this,n=1;void 0===e.colorB&&void 0===e.colorG&&void 0===e.colorR&&(e.colorR=190,e.colorG=45,e.colorB=20);var a=e.colorB/255,o=e.colorG/255,s=e.colorR/255,r=(e.orientation,e.direction);void 0!==e.directionFactor&&(n=e.directionFactor,void 0!==r&&(r[0]=r[0]*n,r[1]=r[1]*n,r[2]=r[2]*n));var h=e.support_1,p=e.arrowType,g=e.scale,b=e.category,y=0,A=0,C=0,S=0;void 0!==e.offsetAxis&&(S=1e3*e.offsetAxis,S*=g);var P=15*g,f=P/1.667,T=.667*f,w=1*g,I=2*g,_=new u(0,0,0),N=new u(1,0,0),O=new u,E=new u,M=new u,D=new u,F=(new u,new u),V=N.squareDistanceToOrigin();F=N.divideScalar(V);var L=new u,x=new i.Vector3(0,0,0);if("arrowFrom"===p&&(O=_,M=E=_.clone().add(F.clone().multiplyScalar(f)),D=_.clone().add(F.clone().multiplyScalar(P)),L=_.clone().add(F.clone().multiplyScalar(P+5)),x.setFromArray(L.getArray())),"arrowTo"===p){D=_,O=M=_.clone().add(F.clone().multiplyScalar(T)).multiplyScalar(-1),E=_.clone().add(F.clone().multiplyScalar(P)).multiplyScalar(-1);var B=new u(-5,-5,-5);L=E.clone().add(B),x.setFromArray(L.getArray())}new i.Vector3(1,0,0);var R=new i.Vector3(0,1,0),k=new i.Vector3(0,0,1),U=new i.Vector3(r[0],r[1],r[2]),W=new i.Vector3(r[0],r[1],r[2]);W.normalize(),y+=S*W.x,A+=S*W.y,C+=S*W.z;var J=1e3*h[0]+y,H=1e3*h[1]+A,j=1e3*h[2]+C,G=new i.Vector3(J,H,j),z=new c;z.setOrigin(1e3*h[0],1e3*h[1],1e3*h[2]);const K=[r[0],r[1],r[2]],X=[...K].sort(((e,t)=>Math.abs(e)-Math.abs(t))),q=K.indexOf(X[0]),Y=K.indexOf(X[1]),Z=[Math.min(q,Y),Math.max(q,Y)];if(Math.abs(K[Z[0]])<Math.abs(K[Z[1]])+.001){const e=[0,0,0];e[Z[0]]=1,R.setFromArray(e)}else{const e=[0,0,0];e[Z[1]]=1,R.setFromArray(e)}(R=R.clone().sub(U.clone().multiplyScalar(R.clone().dot(U.clone())))).normalize(),k=U.clone().cross(R),z.setVectors(U,R,k);var Q=(new i.Matrix4).makeBasis(z.getFirstDirection(),z.getSecondDirection(),z.getThirdDirection());Q.setPosition(G);var $=new d,ee=new m.Color(s,o,a,1),te="",ie=U.length().toString();ie.indexOf("e")<0&&(ie=ie.substring(0,7)),"appliedLoad"===b||"joint"===b||"machineElement"===b?ie=ie.concat("N"):(void 0!==e.valueF&&(te=(te=(te=(te=e.valueF.toString()).substring(0,7)).concat("m")).concat(" | ")),ie=ie.concat("m_s"),ie=te.concat(ie));var ne={bottomCenterPoint:M,topCenterPoint:D,bottomRadius:I,topRadius:0,color:ee,layerNb:1},ae={bottomCenterPoint:O,topCenterPoint:E,radius:w,color:ee,layerNb:1},oe={string:ie,anchor:x,size:6+g,lineLength:10,color:(new i.Color).setRGB(1,1,1),up:new i.Vector3(1,0,0),right:new i.Vector3(0,1,0)},se=l.createConeNode(ne),re=l.createCylinderNode(ae),le=new v;se.setVisibility(!1),re.setVisibility(!1),le.setVisibility(!1),le.setBillboard(!0),le.addText(oe),void 0!==t.sgnode&&void 0!==t.RootChildNodeForAllAnimProp&&t.sgnode.addChild(t.RootChildNodeForAllAnimProp),void 0!==$&&($.applyMatrix(Q),$.addChild(se),$.addChild(re),$.addChild(le),se.setVisibility(!0),re.setVisibility(!0),le.setVisibility(!0)),void 0!==t.RootChildNodeForAllAnimProp&&void 0!==$&&t.RootChildNodeForAllAnimProp.addChild($)},createToroid:function(e){var t=this,n=5*h.constants.PI2/8,a=1*h.constants.PI2/8,o=1;void 0===e.colorB&&void 0===e.colorG&&void 0===e.colorR&&(e.colorR=190,e.colorG=45,e.colorB=20);var s=e.colorB/255,r=e.colorG/255,g=e.colorR/255,b=(e.orientation,e.direction);void 0!==e.directionFactor&&(o=e.directionFactor,void 0!==b&&(b[0]=b[0]*o,b[1]=b[1]*o,b[2]=b[2]*o));var y=e.support_1,A=(e.arrowType,e.scale),C=e.category,S=0,P=0,f=0,T=0;void 0!==e.offsetAxis&&(T=1e3*e.offsetAxis,T*=A);new i.Vector3(1,0,0);var w=new i.Vector3(0,1,0),I=new i.Vector3(0,0,1),_=new i.Vector3(b[0],b[1],b[2]),N=new i.Vector3(b[0],b[1],b[2]);N.normalize(),S+=T*N.x,P+=T*N.y,f+=T*N.z;var O=1e3*y[0]+S,E=1e3*y[1]+P,M=1e3*y[2]+f,D=new i.Vector3(O,E,M),F=new c;F.setOrigin(1e3*y[0],1e3*y[1],1e3*y[2]);const V=[b[0],b[1],b[2]],L=[...V].sort(((e,t)=>Math.abs(e)-Math.abs(t))),x=V.indexOf(L[0]),B=V.indexOf(L[1]),R=[Math.min(x,B),Math.max(x,B)];if(Math.abs(V[R[0]])<Math.abs(V[R[1]])+.001){const e=[0,0,0];e[R[0]]=1,w.setFromArray(e)}else{const e=[0,0,0];e[R[1]]=1,w.setFromArray(e)}(w=w.clone().sub(_.clone().multiplyScalar(w.clone().dot(_.clone())))).normalize(),I=_.clone().cross(w),F.setVectors(_,w,I);var k=!1;"appliedLoad"===C&&(_.x<0||Math.abs(_.x)-0<p.defaultTolerances.epsilonForLengthTest)&&(_.y<0||Math.abs(_.y)-0<p.defaultTolerances.epsilonForLengthTest)&&(_.z<0||Math.abs(_.z)-0<p.defaultTolerances.epsilonForLengthTest)&&(k=!1),"driver"===C&&o<0&&(k=!1);var U=11.25*A,W=2*A,J=1*A,H=U,j=-.785398,G=j+n,z=G,K=z+a;!0===k&&(j=h.constants.PI2-G,G=h.constants.PI2,K=(z=j)-a);var X=new i.Vector3(0,0,0),q=new i.Vector3(0,1,0),Y=new i.Vector3(0,0,1),Z=new i.Vector3(1,0,0),Q=(new i.Matrix4).makeBasis(q,Y,Z);Q.setPosition(X);var $,ee,te,ie,ne=new u,ae=new i.Vector3(0,0,0);!1===k?(Q,$=H,ee=J,te=j,ie=G+.07*a):(Q,$=H,ee=J,te=j-.07*a,ie=G);var oe=new u,se=new u;if(!1===k){var re=q.clone().multiplyScalar(Math.cos(G)).add(Y.clone().multiplyScalar(Math.sin(G)));oe=X.clone().add(re.multiplyScalar(H));var le=q.clone().multiplyScalar(Math.cos(K)).add(Y.clone().multiplyScalar(Math.sin(K)));se=X.clone().add(le.multiplyScalar(1.05*H))}else{re=q.clone().multiplyScalar(Math.cos(j)).add(Y.clone().multiplyScalar(Math.sin(j)));oe=X.clone().add(re.multiplyScalar(H));le=q.clone().multiplyScalar(Math.cos(K)).add(Y.clone().multiplyScalar(Math.sin(K)));se=X.clone().add(le.multiplyScalar(1.05*H))}var me=(new i.Matrix4).makeBasis(F.getFirstDirection(),F.getSecondDirection(),F.getThirdDirection());me.setPosition(D);var de=new d,ce=new m.Color(g,r,s,1);ne=se.clone(),ae.setX(ne.x),ae.setY(ne.y),ae.setZ(ne.z);var ue="",he=_.length().toString();he.indexOf("e")<0&&(he=he.substring(0,7)),"appliedLoad"===C||"joint"===C||"machineElement"===C?he=he.concat("Nxm"):(void 0!==e.valueF&&(ue=(ue=(ue=(ue=e.valueF.toString()).substring(0,7)).concat("rad")).concat(" | ")),he=he.concat("rad_s"),he=ue.concat(he));var pe={bottomCenterPoint:oe,topCenterPoint:se,bottomRadius:W,topRadius:0,color:ce,layerNb:1},ve={axis:Q,majorRadius:$,minorRadius:ee,majorStartAngle:te,majorEndAngle:ie,color:ce,sag:50,layerNb:1},ge={string:he,anchor:ae,size:6+A,lineLength:10,color:(new i.Color).setRGB(1,1,1),up:new i.Vector3(1,0,0),right:new i.Vector3(0,1,0)},be=l.createConeNode(pe),ye=l.createTorusNode(ve),Ae=new v;be.setVisibility(!1),ye.setVisibility(!1),Ae.setVisibility(!1),Ae.setBillboard(!0),Ae.addText(ge),void 0!==t.sgnode&&void 0!==t.RootChildNodeForAllAnimProp&&t.sgnode.addChild(t.RootChildNodeForAllAnimProp),void 0!==de&&(de.applyMatrix(me),de.addChild(be),de.addChild(ye),de.addChild(Ae),be.setVisibility(!0),ye.setVisibility(!0),Ae.setVisibility(!0)),void 0!==t.RootChildNodeForAllAnimProp&&void 0!==de&&t.RootChildNodeForAllAnimProp.addChild(de)},createLineWithText:function(e,t,n){var a=this,o=new d,s="";s=(s=(s=e.toString()).substring(0,6)).concat("m");var r=new i.Vector3(1e3*t[0],1e3*t[1],1e3*t[2]),c=new i.Vector3(1e3*t[3],1e3*t[4],1e3*t[5]),u=(r.x+c.x)/2,h=(r.y+c.y)/2,p=(r.z+c.z)/2,g=new i.Vector3(u,h,p);(t=[]).push(r),t.push(c);var b=[],y=new i.Vector3(u,h,p+15);b.push(g),b.push(y);var A={points:t,width:2,editable:!0,drawMode:m.ConnectivityTypeEnum.LINES,layerNb:1},C={points:b,width:.5,editable:!0,drawMode:m.ConnectivityTypeEnum.LINES,layerNb:1},S={string:s,anchor:y,size:6+n,lineLength:10,color:(new i.Color).setRGB(1,1,1),up:new i.Vector3(1,0,0),right:new i.Vector3(0,1,0)},P=l.createLineNode(A),f=l.createLineNode(C),T=new v;P.setVisibility(!1),f.setVisibility(!1),T.setVisibility(!1),T.setBillboard(!0),T.addText(S),void 0!==a.sgnode&&void 0!==a.RootChildNodeForAllAnimProp&&a.sgnode.addChild(a.RootChildNodeForAllAnimProp),void 0!==o&&(o.addChild(P),o.addChild(f),o.addChild(T),P.setVisibility(!0),f.setVisibility(!0),T.setVisibility(!0)),void 0!==a.RootChildNodeForAllAnimProp&&void 0!==o&&a.RootChildNodeForAllAnimProp.addChild(o)},getSupportPosition:function(e){let t={center:[0,0,0],points:[]};for(let n=1;n;n++){let a="support_"+n;if(!e[a])break;var i;(i=e[a])&&(t.center[0]+=i[0],t.center[1]+=i[1],t.center[2]+=i[2],t.points.push(i))}if(t.points.length)t.center[0]/=t.points.length,t.center[1]/=t.points.length,t.center[2]/=t.points.length;else{let i=e.glyphPosition;i&&(t.center[0]=i[0],t.center[1]=i[1],t.center[2]=i[2])}return t},getWidgetURLPath:function(e){return"undefined"!=typeof widget&&void 0!==widget.uwaUrl?require.toUrl("DS"+e):e},createGlyph2D:function(e){var t=this,n=new d,a=[];let o=t.getSupportPosition(e);if(o){for(let e=0;e<o.points.length;e++){let t=o.points[e],n=o.center;var s=new i.Vector3(1e3*n[0],1e3*n[1],1e3*n[2]),r=new i.Vector3(1e3*t[0],1e3*t[1],1e3*t[2]);a.push(s),a.push(r)}var c={points:a,width:2,editable:!0,drawMode:m.ConnectivityTypeEnum.LINES,layerNb:1};if(a.length){var u=l.createLineNode(c);u.setVisibility(!1),void 0!==n&&(n.addChild(u),u.setVisibility(!0))}let d=t.getWidgetURLPath(e.iconURL),p=i.ImageUtils.loadTexture(d,void 0,void 0,void 0,!0),v=new i.ParticleBasicMaterial({size:22*window.devicePixelRatio,sizeAttenuation:!1,map:p,blending:i.NormalBlending,depthTest:!1,transparent:!0,force:!0});if(o.center){let e=[1e3*o.center[0],1e3*o.center[1],1e3*o.center[2]];var h=l.createPointsNode({positions:e,material:v,size:1});h.setVisibility(!1),void 0!==n&&(n.addChild(h),h.setVisibility(!0))}void 0!==t.RootChildNodeForAllAnimProp&&void 0!==n&&t.RootChildNodeForAllAnimProp.addChild(n),void 0!==t.sgnode&&void 0!==t.RootChildNodeForAllAnimProp&&t.sgnode.addChild(t.RootChildNodeForAllAnimProp)}},goToTime:function(e){var t=this.animation.attributes._VariantLine,i=t.attributes._OrderedIndexedValues.indexOf(e),n=t.attributes._OrderedIndexes[i];this.goToIndex(n)},applyInitialPosition:function(){var e=this;void 0!==e.RootChildNodeForAllAnimProp&&void 0!==e.sgnode&&(e.sgnode.removeChild(e.RootChildNodeForAllAnimProp),e.RootChildNodeForAllAnimProp=void 0);for(var t=e.movingProducts,i=e.movingProductsInitalPositions,n=0;n<t.length;n++){var a;if(!0===e.bUsingPathElement){var o=e.sceneGraphOverrideSet.getOverridesFromPathElement(t[n]);if(o)for(var r=0;r<o.length;r++)a=o[r];a||(a=e.sceneGraphOverrideSet.createOverride([t[n]]))}else{var l=t[n],m=new s(l);(a=e.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(m))||(a=e.sceneGraphOverrideSet.createIdPathOverride(m))}a&&a.setPosition(i[n])}}});return e.namespace("DS/SIMAnimationWebUI/AnimationPlayer",g)})),define("DS/SIMAnimationWebUI/CmdPlayAnimation",["UWA/Core","DS/ApplicationFrame/Command","DS/SIMAnimationWebUI/CATAnimationTimeline","DS/SIMAnimationWebUI/AnimationPlayer","DS/SIMAnimationWebMdl/SIMAnimationServices","DS/CoreEvents/Events","DS/ApplicationFrame/CommandsManager","DS/WebappsUtils/WebappsUtils","DS/Controls/Popup","DS/WUXAutoComplete/AutoComplete","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/Controls/TooltipModel","i18n!DS/SIMAnimationWebUI/assets/nls/CmdPlayAnimation","css!DS/SIMAnimationWebUI/CmdPlayAnimation.css"],(function(e,t,i,n,a,o,s,r,l,m,d,c,u,h){"use strict";c.setNotificationManager(d);const p=h.get("SpeedControlErrorTitle"),v=h.get("SpeedControlErrorMsg"),g=h.get("SpeedControlResetLabel");var b=!1;return t.extend({init:function(t){if(!b){var i=this;if(i.PlayFromJson=!1,i.kinScenarioSelected=!0,i._parent(t,{isAsynchronous:!0}),t.args&&void 0!==t.args.animJSON&&(i.All_Anim_JSON_Data=t.args.animJSON,i.PlayFromJson=!0,i.kinScenarioSelected=!0),t.args&&void 0!==t.args.fnPofiToPath&&(i.fnPofiToPath=t.args.fnPofiToPath),t.args&&void 0!==t.args.rootnode&&(i.rootnode=t.args.rootnode),i.myPlayAnimationTimelineContainer=new e.Element("div",{class:"CmdPlayAnimation-Container"}),!1===i.PlayFromJson?i.myPlayAnimationTimelineContainer.addClassName("CmdPlayAnimation-Container-margin1"):i.myPlayAnimationTimelineContainer.addClassName("CmdPlayAnimation-Container-margin2"),!1===i.PlayFromJson){i._onActionBarReadyToken=i.getFrameWindow().onActionBarReady((function(){!b&&i.kinScenarioSelected&&(i.loadAnimations(),i.animations.length>0&&(i.begin(),b=!0))}));var n=this.getFrameWindow().experience;n.args.ctx;n.subscribe("ASSET/LOADINGFINISHED",(function(){i.loadAnimations()}))}o.subscribe({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN"},(function(e){var t=e.animationId;i.animationId=t,i.animationPlayer.animation=i.animations[t];i.animations[t].attributes._Name;i.animationPlayer.reset(),i.myPlayAnimationTimeline.stop(),i.loadTimeline(),i.consolidateLoopButton(),i.animate("play"),s.getCommands("Default").ChooseAnimation._visible&&(i.buttonChoose.classList.remove("isChoosing"),i.buttonChoose.classList.add("isChoosing"))})),o.subscribe({event:"CATAnimationTimeline/CHANGE"},(function(e){i.mobileValue&&i.mobileValue.setText(e.value)})),o.subscribe({event:"CMDCHOOSEANIMATION/JUMPTOEND"},(function(e){i.animate("jumptoEnd"),i._isPlaying&&i._isLooping?(i.animate("jumptoStart"),i.animate("play")):i._isPlaying&&!i._isLooping&&i.animate("pause")})),o.subscribe({event:"CMDCHOOSEANIMATION/JUMPTOSTART"},(function(e){i.animate("jumptoStart"),i._isPlaying?i.animate("play"):i._isPlaying&&i.animate("pause")})),o.subscribe({event:"CATKINPLAYSCENARIO/KINSCENARIOSELECTED"},(function(e){i.kinScenarioSelected=!0})),!0===i.PlayFromJson&&(i.loadAnimations(),i.begin(),b=!0)}},loadAnimations:function(){var e=this;if(!0===e.PlayFromJson){if(e.animations=[],void 0!==e.All_Anim_JSON_Data)for(var t=0;t<e.All_Anim_JSON_Data.length;t++)void 0!==e.All_Anim_JSON_Data[t].animData&&(e.JSON_Data=e.All_Anim_JSON_Data[t].animData,e.JSON_Data=JSON.parse(e.JSON_Data),e.animations=[],e.variantToAnimation=[],e.animChannelToAnimation=[],e.propertyToAnimation=[],e.propertyToChannel=[],e.animation={attributes:{}},e.unstreamAnimation())}else{var i=e.getFrameWindow().getViewer().getRootNode(),o=new a;e.animations=o.getAnimations(i)}for(var s=e.animations.length-1;s>=0;s--){void 0===e.animations[s].attributes._VariantLine.attributes._OrderedIndexes&&e.animations.splice(s,0)}if(e.animations.length>0){e.enable(),e.animationId=0;var r=e.animations[e.animationId];e.animationPlayer=new n(e.getFrameWindow(),r,e.PlayFromJson,e.rootnode),e.loadTimeline(),e.consolidateLoopButton(),e.myPlayAnimationTimelineContainer.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1)}else e.disable()},loadTimeline:function(){var e=this,t=e.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexes.length,n=e.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[t-1];if(e.frameDelay=1e3*n/t,e.myPlayAnimationTimeline)for(;e.myPlayAnimationTimelineContainer.hasChildNodes();)e.myPlayAnimationTimelineContainer.removeChild(e.myPlayAnimationTimelineContainer.lastChild);e.addControls();var a=n/t;e.myPlayAnimationTimeline=new i({minValue:0,maxValue:n,value:0,stepValue:a,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!1,playbackSpeed:1,displayFunction:function(e){return parseFloat(parseFloat(e).toFixed(3)).toString()},eventsList:[{label:"0%",value:0},{label:"50%",value:(0+n)/2},{label:"100%",value:n}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(e.myPlayAnimationTimelineContainer),e.myPlayAnimationTimeline.playbackSpeed=1,e.addControls2();e.myPlayAnimationTimeline.addEvent("change",(function(){var t=0;t=void 0===e.myPlayAnimationTimeline.frameCounter||!0===e.myPlayAnimationTimeline.hasSnapped?parseInt(1e3*e.myPlayAnimationTimeline.getValue()/e.frameDelay):e.myPlayAnimationTimeline.frameCounter,e.animationPlayer.goToIndex(t),e.getFrameWindow().getViewer().render()}))},beginExecute:function(){if(!this._begun){this._begun=!0;var t,i=this;if(i.buttonChoose&&i.buttonChoose.classList.remove("isChoosing"),void 0!==i.getFrameWindow().getActionBar()&&(t=i.getFrameWindow().getActionBar().MAB),t&&t.state.visible){var n,a=new e.Element("div",{class:"kinFlyout"});n=!1===i.PlayFromJson?r.getWebappsAssetUrl("CATKinPlayScenario","icons/32/"):r.getWebappsAssetUrl("SIMAnimationWebUI","icons/32/"),i.buttonJumptoStartMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdJumpToStart.png" alt="Step Backward">',class:"kinMABCmd",events:{click:function(){i.animate("pause"),i.animate("stepBackward",.1)}}}),i.buttonJumptoStartMAB.inject(a),i.buttonPlayMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdPlay.png" alt="Play">',class:"kinMABCmd",events:{click:function(){i.animate("play")}}}),i.buttonPlayMAB.inject(a),i.buttonPauseMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdPause.png" alt="Pause">',class:"kinMABCmd",events:{click:function(){i.animate("pause")}}}),i.buttonPauseMAB.inject(a),i.buttonJumptoEndMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdJumpToEnd.png" alt="Step Forward">',class:"kinMABCmd",events:{click:function(){i.animate("pause"),i.animate("stepForward",.1)}}}),i.buttonJumptoEndMAB.inject(a),i.buttonChooseMAB=new e.Element("a",{html:'<img src="'+n+'I_KinChooseAnimation.png" alt="Choose">',class:"kinMABCmd",events:{click:function(){s.getCommands("Default").ChooseAnimation.begin()}}}),i.buttonChooseMAB.inject(a),i.myPlayAnimationTimelineContainer.classList.remove("timeLineMAB"),i.myPlayAnimationTimelineContainer.classList.add("timeLineMAB"),!1===i.PlayFromJson&&i.getFrameWindow().getActionBar().MAB.showCustomFlyout(1,a)}else i.myPlayAnimationTimelineContainer.classList.remove("timeLineMAB");i.myPlayAnimationTimelineContainer.inject(i.getFrameWindow().getUIFrame()),i.myPlayAnimationTimelineContainer.classList.remove("close"),i.myPlayAnimationTimelineContainer.classList.remove("open"),i.myPlayAnimationTimelineContainer.classList.add("open"),i.doPlayAnimation=!0,o.publish({event:"CMDPLAYANIMATION/PLAYFIRST",data:{}}),i.animate("play"),i._animationFinishToken=o.subscribe({event:"CATANIMATIONTIMELINE/FINISH"},(function(){i._isLooping?(i.animate("jumptoStart"),i.animate("play")):i.animate("pause")}))}},endExecute:function(){var e=this;this._begun=!1,e._isRunning&&(e.kinScenarioSelected=!1,e.doPlayAnimation=!1,e.myPlayAnimationTimelineContainer.classList.remove("close"),e.myPlayAnimationTimelineContainer.classList.remove("open"),e.myPlayAnimationTimelineContainer.classList.add("close"),e.cleanUp(),o.unsubscribe(e._animationFinishToken),!1===e.PlayFromJson&&s.getCommands("Default").ChooseAnimation._visible&&s.getCommands("Default").ChooseAnimation.hideThumbnails()),!1===e.PlayFromJson&&o.unsubscribe(e._onActionBarReadyToken),b=!1,this.done&&this.done()},cancelExecute:function(){this.endExecute()},buildTooltipFromNls:function(e,t){var i=new u({shortHelp:h.get(t+".tooltipInfos.shortHelp"),title:h.get(t+".tooltipInfos.title")});void 0!==e&&(e.tooltipInfos=i)},animate:function(e,t){var i=this,n=0,a=i.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues.length-1,o=i.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[a],s=null!=t?t:i.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[a]-i.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[a-1];if("number"==typeof e)i.myPlayAnimationTimeline.value=e;else if("string"==typeof e)if("play"===e)i.setAnimationFromCSO(),i.buttonPause.classList.remove("playPauseHidden"),i.buttonPlay.classList.remove("playPauseHidden"),i.buttonPlay.classList.add("playPauseHidden"),i.buttonPauseMAB&&(i.buttonPauseMAB.classList.remove("playPauseHidden"),i.buttonPlayMAB.classList.remove("playPauseHidden"),i.buttonPlayMAB.classList.add("playPauseHidden")),i._isPlaying=!0,i.myPlayAnimationTimeline.play(a,o,!1);else if("rewind"===e)i.myPlayAnimationTimeline.pause(),i.myPlayAnimationTimeline.play(a,o,!0);else if("pause"===e)i.buttonPlay.classList.remove("playPauseHidden"),i.buttonPause.classList.remove("playPauseHidden"),i.buttonPause.classList.add("playPauseHidden"),i.buttonPauseMAB&&(i.buttonPlayMAB.classList.remove("playPauseHidden"),i.buttonPauseMAB.classList.remove("playPauseHidden"),i.buttonPauseMAB.classList.add("playPauseHidden")),i.myPlayAnimationTimeline.pause(!0),i._isPlaying=!1;else if("stop"===e)i.myPlayAnimationTimeline.stop();else if("stepForward"===e){i.myPlayAnimationTimeline.pause();var r=1;i.myPlayAnimationTimeline.playbackSpeed>=1&&(r=parseInt(i.myPlayAnimationTimeline.playbackSpeed)),(n=+i.myPlayAnimationTimeline.getValue()+s*r)>o&&(n=o),i.myPlayAnimationTimeline.setValue(n),i.animationPlayer.goToIndex(parseInt(1e3*n/i.myPlayAnimationTimeline.frameDelay)),i.getFrameWindow().getViewer().render()}else if("stepBackward"===e){i.myPlayAnimationTimeline.pause();r=1;i.myPlayAnimationTimeline.playbackSpeed>=1&&(r=parseInt(i.myPlayAnimationTimeline.playbackSpeed)),(n=i.myPlayAnimationTimeline.getValue()-s*r)<0&&(n=0),i.myPlayAnimationTimeline.setValue(n),i.animationPlayer.goToIndex(parseInt(1e3*n/i.myPlayAnimationTimeline.frameDelay)),i.getFrameWindow().getViewer().render()}else"jumptoStart"===e?i.myPlayAnimationTimeline.stop():"jumptoEnd"===e&&(i.myPlayAnimationTimeline.pause(),i.myPlayAnimationTimeline.setValue(o),i.animationPlayer.goToIndex(a))},setAnimationFromCSO:function(){var e=this,t=WUX.Selection.CSOManager.get();if(void 0!==t[0]){var i=t[0].pathElement.getLastElement().animation;void 0!==i&&(e.animationPlayer.animation=i,e.myPlayAnimationTimeline.stop(),e.animationPlayer.reset(),e.loadTimeline(),e.consolidateLoopButton())}},cleanUp:function(){var e=this;e.doPlayAnimation||(e.myPlayAnimationTimelineContainer.toggleClassName("close"),1===e.getFrameWindow().getUIFrame().getElementsByClassName("CmdPlayAnimation-Container").length&&e.getFrameWindow().getUIFrame().removeChild(e.myPlayAnimationTimelineContainer),e.doPlayAnimation=!1,e.myPlayAnimationTimeline.stop(),e.animationPlayer.applyInitialPosition())},addControls:function(){var t,i=this;t=!1===i.PlayFromJson?r.getWebappsAssetUrl("CATKinPlayScenario","icons/32/"):r.getWebappsAssetUrl("SIMAnimationWebUI","icons/32/"),i.buttonPlay=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdPlay.png" alt="Play">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a",events:{click:function(){i.animate("play")}}}),i.buttonPause=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdPause.png" alt="Pause">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a",events:{click:function(){i.animate("pause")}}}),i.mobileValue=e.createElement("span",{text:"0.0"});var n=new e.Element("div",{class:"cmdPlayAnimation-ButtonDiv0"}),a=new e.Element("div",{class:"cmdPlayAnimation-ButtonDiv"});i.buildTooltipFromNls(i.buttonPlay,"buttonPlay"),i.buildTooltipFromNls(i.buttonPause,"buttonPause"),i.mobileValue.inject(n),i.buttonPause.inject(a),i.buttonPlay.inject(a),n.inject(i.myPlayAnimationTimelineContainer),a.inject(i.myPlayAnimationTimelineContainer)},addControls2:function(){var t,i=this;t=!1===i.PlayFromJson?r.getWebappsAssetUrl("CATKinPlayScenario","icons/32/"):r.getWebappsAssetUrl("SIMAnimationWebUI","icons/32/"),i.buttonJumptoEnd=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdJumpToEnd.png" alt="Step Forward">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a kinBackward",events:{click:function(){i.animate("pause"),i.animate("stepForward",.1)}}}),i.buttonJumptoStart=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdJumpToStart.png" alt="Step Backward">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a kinForward",events:{click:function(){i.animate("pause"),i.animate("stepBackward",.1)}}}),i.buttonLoop=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdLoop.png" alt="Loop">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a loopButton",events:{click:function(){i.toggleLoop()}}});var n=[{value:"reset",label:g},{value:.1,label:"X 0.1"},{value:.2,label:"X 0.2"},{value:.5,label:"X 0.5"},{value:1,label:"X 1"},{value:2,label:"X 2"},{value:5,label:"X 5"},{value:10,label:"X 10"}];i.autoCompleteSpeedControl=new m({elementsTree:n,allowResetToUndefinedByUIFlag:!1,multiSearchMode:!1,value:1,placeholder:"",allowFreeInputFlag:!0,popupSizeAdjustPolicy:l.SizeAdjustPolicyEnum.AdjustToAllContents}),i.autoCompleteSpeedControl.addEventListener("change",(function(){var e=i.autoCompleteSpeedControl.value;e?"reset"==e?(i.myPlayAnimationTimeline.playbackSpeed=1,i.autoCompleteSpeedControl.value=1,i.onSpeedControlChange()):-1!=[.1,.2,.5,1,2,5,10].indexOf(e)?(i.autoCompleteSpeedControl.value=e,i.myPlayAnimationTimeline.playbackSpeed=e,i.onSpeedControlChange()):Number.isFinite(+e)?i.autoCompleteSpeedControl.value="X "+e:"X "==e.toString().slice(0,2)&&Number.isFinite(+e.toString().slice(2))&&parseFloat(e.toString().slice(2))>0?(i.autoCompleteSpeedControl.value="X "+parseFloat(e.toString().slice(2)),i.myPlayAnimationTimeline.playbackSpeed=parseFloat(e.toString().slice(2)),i.onSpeedControlChange()):"x "==e.toString().slice(0,2)&&Number.isFinite(+e.toString().slice(2))&&parseFloat(e.toString().slice(2))>0?i.autoCompleteSpeedControl.value="X "+e.toString().slice(2):"X"==e.toString().slice(0,1).toUpperCase()&&Number.isFinite(+e.toString().slice(1))&&parseFloat(e.toString().slice(1))>0?i.autoCompleteSpeedControl.value="X "+e.toString().slice(1):(i.autoCompleteSpeedControl.value=1,i.myPlayAnimationTimeline.playbackSpeed=1,i.onSpeedControlChange(),d.addNotif({level:"warning",title:p,message:v})):(i.myPlayAnimationTimeline.playbackSpeed=1,i.autoCompleteSpeedControl.value=1,i.onSpeedControlChange())})),i.myPlayAnimationTimeline.playbackSpeed=1,!1===i.PlayFromJson&&(i.buttonChoose=new e.Element("a",{html:'<img src="'+t+'I_KinChooseAnimation.png" alt="Animation Chooser">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a chooseButton",events:{click:function(){i.toggleChoose(),s.getCommands("Default").ChooseAnimation.begin()}}})),i.kinSeparator=new e.Element("div",{class:"kinSeparator"}),i.buttonClose=new e.Element("a",{html:'<img src="'+t+'I_KinPlayClose32.png" alt="Close Play">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a closeButton",events:{click:function(){i.end()}}});var a=new e.Element("div",{class:"cmdPlayAnimation-ButtonDiv endButtons"}),o=new e.Element("div");o.style.width="65px",o.style.display="inline-block",o.style.marginLeft="2px",o.style.marginRight="0px",i.buildTooltipFromNls(i.buttonLoop,"buttonLoop"),i.buildTooltipFromNls(i.buttonChoose,"buttonChoose"),i.buildTooltipFromNls(i.buttonClose,"buttonClose"),i.buildTooltipFromNls(i.autoCompleteSpeedControl,"autoCompleteSpeedControl"),i.buildTooltipFromNls(i.buttonJumptoEnd,"buttonStepForward"),i.buildTooltipFromNls(i.buttonJumptoStart,"buttonStepBackward"),i.buttonJumptoStart.inject(a),i.buttonJumptoEnd.inject(a),i.buttonLoop.inject(a),i.autoCompleteSpeedControl.inject(o),!0===i.PlayFromJson&&o.inject(a),void 0!==i.buttonChoose&&i.buttonChoose.inject(a),i.kinSeparator.inject(a),i.buttonClose.inject(a),a.inject(i.myPlayAnimationTimelineContainer)},toggleChoose:function(){var e=this;s.getCommands("Default").ChooseAnimation._visible?e.buttonChoose.classList.remove("isChoosing"):(e.buttonChoose.classList.remove("isChoosing"),e.buttonChoose.classList.add("isChoosing"))},toggleLoop:function(){var e=this;e._isLooping?e.buttonLoop.classList.remove("isLooping"):(e.buttonLoop.classList.remove("isLooping"),e.buttonLoop.classList.add("isLooping")),e._isLooping=!e._isLooping},consolidateLoopButton:function(){var e=this;e._isLooping?(e.buttonLoop.classList.remove("isLooping"),e.buttonLoop.classList.add("isLooping")):e.buttonLoop.classList.remove("isLooping")},onSpeedControlChange:function(){var e=this;e.myPlayAnimationTimeline.hasSnapped=!0,e.myPlayAnimationTimeline.snapValue=1e3*e.myPlayAnimationTimeline.getValue()},unstreamAnimation:function(){var e=this,t=(e.animations.length,{attributes:{}});t.attributes._Name=e.JSON_Data._Name,t.attributes._Description=e.JSON_Data._Description,t.attributes._AnimChannels=[];var i={attributes:{}};i.attributes._Indexes=e.JSON_Data._Indexes,i.attributes._OrderedIndexes=e.JSON_Data._Indexes,i.attributes._IndexedValues=e.JSON_Data._IndexedValues,i.attributes._OrderedIndexedValues=e.JSON_Data._IndexedValues,t.attributes._VariantLine=i;e.JSON_Data._ExternalObject;for(var n=0;n<e.JSON_Data._ExternalObject.length;++n){var a=e.JSON_Data._ExternalObject[n],o={attributes:{}};o.attributes._AnimProperties=[];var s=a.POFI,r=e.fnPofiToPath(s);o.attributes._ExternalObject=r;for(var l=a.properties,m=0;m<l.length;++m){var d=l[m],c={attributes:{}},u=d.type,h=d.values;switch(void 0!==d.interpretType&&(c.attributes._InterpretType=d.interpretType),c.attributes._Type=u,c.attributes._ValuesTimeIndex=d.valuesTimeIndex,c.attributes._Type){case"CATANIM_POSITION":c.attributes._ValuesDouble=h;break;case"CATANIM_COLOR":case"CATANIM_OPACITY":case"CATANIM_VISIBILITY":case"CATANIM_VIEWPOINT":default:break;case"CATANIM_HIGHLIGHT":c.attributes._ValuesOctet=h;break;case"CATANIM_MOTELEMENT":c.attributes._ValuesString=h}o.attributes._AnimProperties.push(c)}t.attributes._AnimChannels.push(o)}e.animations.push(t)},pauseExecute:function(){this.done()},resumeExecute:function(){}})})),define("DS/SIMAnimationWebUI/CmdChooseAnimation",["UWA/Core","DS/ApplicationFrame/Command","DS/Panels/PanelBase","DS/Panels/SidePanel","DS/Controls/Loader","DS/SIMAnimationWebUI/AnimationPlayer","DS/SIMAnimationWebMdl/SIMAnimationServices","DS/CoreEvents/Events","css!DS/SIMAnimationWebUI/CmdChooseAnimation","DS/Controls/Button","DS/WebappsUtils/WebappsUtils"],(function(e,t,i,n,a,o,s,r,l,m){"use strict";return t.extend({init:function(e){var t=this;t._parent(e,{isAsynchronous:!0,mode:"shared"}),t.NB_SCREENSHOTS_PER_ANIMATION=20,t._subPanelsBase=[],t.getFrameWindow().onActionBarReady((function(){t.loadAnimations()>0&&t.subcribeToPlay()}));var i=this.getFrameWindow().experience;i.args.ctx;i.subscribe("ASSET/LOADINGFINISHED",(function(){t.loadAnimations()>0&&t.subcribeToPlay()})),this._visible=void 0},subcribeToPlay:function(){var e=this;r.subscribe({event:"CMDPLAYANIMATION/PLAYFIRST"},(function(){if(e.thumbnailActivations.length>0){for(var t=0;t<e.thumbnailActivations.length;t++)e.thumbnailActivations[t]=!1,e._subPanelsBase[t]&&e._subPanelsBase[t].removeClassName("thumbSelected");e.thumbnailActivations[0]=!0,e._subPanelsBase[0]&&e._subPanelsBase[0].addClassName("thumbSelected")}})),r.subscribe({event:"CMDPLAYANIMATION/PREVIOUS"},(function(){for(var t=0;0==e.thumbnailActivations[t]&&t<e.thumbnailActivations.length;)t++;var i=!1;e.thumbnailActivations[t]?t-1>=0?t-=1:i=!0:e.thumbnailActivations.length>0&&(t=0),i?require(["DS/CoreEvents/Events"],(function(e){e.publish({event:"CMDCHOOSEANIMATION/JUMPTOSTART",data:{animationId:t}})})):require(["DS/CoreEvents/Events"],(function(i){for(var n=0;n<e.thumbnailActivations.length;n++)e.thumbnailActivations[n]=!1,e._subPanelsBase[n].removeClassName("thumbSelected");e.thumbnailActivations[t]=!0,e._subPanelsBase[t].addClassName("thumbSelected"),i.publish({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN",data:{animationId:t}})}))})),r.subscribe({event:"CMDPLAYANIMATION/NEXT"},(function(){for(var t=0;0==e.thumbnailActivations[t]&&t<e.thumbnailActivations.length;)t++;var i=!1;e.thumbnailActivations[t]?t+1<e.thumbnailActivations.length?t+=1:i=!0:e.thumbnailActivations.length>0&&(t=0),i?require(["DS/CoreEvents/Events"],(function(e){e.publish({event:"CMDCHOOSEANIMATION/JUMPTOEND",data:{animationId:t}})})):require(["DS/CoreEvents/Events"],(function(i){for(var n=0;n<e.thumbnailActivations.length;n++)e.thumbnailActivations[n]=!1,e._subPanelsBase[n].removeClassName("thumbSelected");e.thumbnailActivations[t]=!0,e._subPanelsBase[t].addClassName("thumbSelected"),i.publish({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN",data:{animationId:t}})}))}))},loadAnimations:function(){console.log("Finished Model loading");var e=this,t=e.getFrameWindow().getViewer().getRootNode(),i=new s;e.animations=i.getAnimations(t);for(var n=e.animations.length-1;n>=0;n--){void 0===e.animations[n].attributes._VariantLine.attributes._OrderedIndexes&&e.animations.splice(n,1)}var a=i.getKeyFramer(t);if(e.keyFramer=a,e.animations.length>0){e.enable(),e.thumbnailActivations=[],e.thumbnailActivations[0]=!0;for(n=1;n<e.animations.length;++n)e.thumbnailActivations.push(!1);e.animScreenshots=[],e.animateThumbnails=0}else e.disable();return e.animations.length},beginExecute:function(){if(this._globalContainer||this.execute2(),this._globalContainer){var e=this.getFrameWindow().getActionBar().MAB;e&&e.state.visible?(this._globalContainer.elements.container.classList.remove("chooserMAB"),this._globalContainer.elements.container.classList.add("chooserMAB")):this._globalContainer.elements.container.classList.remove("chooserMAB"),void 0===this._visible||!1===this._visible?this.showThumbnails():this.hideThumbnails()}this.end()},showThumbnails:function(){this._visible=!0,this._globalContainer.elements.container.classList.remove("chooserclose"),this._globalContainer.elements.container.classList.remove("chooseropen"),this._globalContainer.elements.container.classList.add("chooseropen"),this.startThumbnailAnimations()},hideThumbnails:function(){this._visible=!1,this.stopThumbnailAnimations(),this._globalContainer.elements.container.classList.remove("chooseropen"),this._globalContainer.elements.container.classList.remove("chooserclose"),this._globalContainer.elements.container.classList.add("chooserclose")},endExecute:function(){this._globalContainer},execute2:function(){var t=this;if(!t._globalContainer){var i=t.getFrameWindow().getUIFrame(),o=0,s=0;t.animScreenshots=t.animScreenshots||[],t._globalContainer=new n({side:"right"}).inject(i),this._globalContainer.elements.container.classList.remove("chooseropen"),this._globalContainer.elements.container.classList.remove("chooserclose"),this._globalContainer.elements.container.classList.add("chooserclose");var r=new e.Element("div",{class:"headerThumbs",html:"<span>Motion Animations</span>"}).inject(this._globalContainer),l=globalThis.dsDefaultWebappsBaseUrl+"CATKinPlayScenario/assets/icons/";for(t.buttonClose=new e.Element("a",{html:'<img src="'+l+'I_KinPlayClose.png" alt="Close">',class:"closeHeaderThumbsButton",events:{click:function(){t._visible=!1,t.stopThumbnailAnimations(),t._globalContainer.elements.container.classList.remove("chooseropen"),t._globalContainer.elements.container.classList.remove("chooserclose"),t._globalContainer.elements.container.classList.add("chooserclose")}}}),t.buttonClose.inject(r),t.thumbImgs=[],o=0;o<t.animations.length;++o)t.buildAnimationThumbnail(t._globalContainer,o);if(0===t.animScreenshots.length){var m=new a;for(m.inject(t._globalContainer),m.getContent().setStyles({position:"absolute",top:"",left:"",right:10,zIndex:3e10,bottom:this.offset?92:10}),m.on("0%"),require(["DS/CoreEvents/Events"],(function(e){e.subscribe({event:"CMDCHOOSEANIMATION/SCREENSHOT_SAVED"},(function(e){var i=t.computeSaveProgress();if(m.update((100*i).toFixed()+"%"),1===i){m.off();for(var n=0;n<t.thumbImgs.length;++n)t.thumbImgs[n].removeClassName("CmdChooseAnimation-thumbnail-save-animation"),t.thumbImgs[n].addClassName("CmdChooseAnimation-thumbnail-animation")}}))})),o=0;o<t.animations.length;++o)void 0===t.animScreenshots[o]&&(t.animScreenshots[o]=[],t.saveAnimationScreenshot(o))}else{for(o=0;o<t.thumbImgs.length;++o)t.thumbImgs[o].addClassName("CmdChooseAnimation-thumbnail-animation");for(o=0;o<t.animScreenshots.length;++o){var d=t.animScreenshots[o];for(s=0;s<d.length;++s)d[s].inject(t.thumbImgs[o])}}}},computeSaveProgress:function(){for(var e=this,t=e.animations.length*e.NB_SCREENSHOTS_PER_ANIMATION,i=0,n=0;n<e.animScreenshots.length;++n)i+=e.animScreenshots[n].length;return i/t},buildAnimationThumbnail:function(t,n){var a=this,o=n,s=a.animations[o],r=a.thumbnailActivations[o],l=new i({class:"gru"}).inject(t),m=new e.Element("div",{id:o,class:"kinThumb kinThumb"+o,activated:r,events:{click:function(e){for(var t=this,i=0;i<a.thumbnailActivations.length;++i)a.thumbnailActivations[i]=!1,a._subPanelsBase[i].removeClassName("thumbSelected");a.thumbnailActivations[t.id]=!0,a._subPanelsBase[t.id].addClassName("thumbSelected"),require(["DS/CoreEvents/Events"],(function(e){e.publish({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN",data:{animationId:t.id}})})),a.end()}}}).inject(l);a._subPanelsBase.push(m);var d=new e.Element("div",{id:o,class:"CmdChooseAnimation-thumbnail CmdChooseAnimation-thumbnail-background",activated:r}).inject(m);new e.Element("div",{id:o,class:"thumbName",html:s.attributes._Name,activated:r}).inject(m);a.thumbImgs[o]=new e.Element("div",{class:"CmdChooseAnimation-thumbnail-image"}).inject(d),0===a.animScreenshots.length&&a.thumbImgs[o].addClassName("CmdChooseAnimation-thumbnail-save-animation"),require(["DS/CoreEvents/Events"],(function(e){e.subscribe({event:"CMDCHOOSEANIMATION/SCREENSHOT_SAVED"},(function(e){a.injectScreenshot(e,o,a.thumbImgs[o])}))}))},injectScreenshot:function(e,t,i){if(e.animationId===t){var n=this.animScreenshots[e.animationId][e.screenshotId],a=parseInt(n.id),o=i.getElementsByTagName("img");if(0===o.length)n.inject(i);else{for(var s=0;s<o.length;){if(parseInt(o[s].id)>a){n.inject(o[s],"before");break}++s}s===o.length&&n.inject(i)}}},getScreenshot:function(e){var t=e.width,i=e.height,n=e.reductionFactor;this._kinWidth=t,this._kinHeight=i;var a=this.getFrameWindow().getViewer(),o=0,s=0,r=0,l=0;a.save&&a.save();var m=a.currentViewpoint,d={data:null,width:a.SCREEN_WIDTH,height:a.SCREEN_HEIGHT},c=document.createElement("canvas");c.width=t||d.width,c.height=i||d.height,c.width=n?c.width/n:c.width,c.height=n?c.height/n:c.height,m.getControl().update(),a.renderToTarget(d,m);var u=c.getContext("2d"),h=u.getImageData(0,0,c.width,c.height);if(h.width===c.width){if(h.height===c.height){var p=(d.width-1)/(h.width-1),v=(d.height-1)/(h.height-1),g=d.data,b=h.data;if(1===p&&1===v){var y=h.height,A=h.width,C=4*A;for(s=0;s<y;s++)for(r=s*A*4,l=(y-s)*A*4,o=C;o--;)b[r+o]=g[l+o]}else{var S=function(e,t,i,n,a){return a&&(t=n-t),i*t+e},P=h.height,f=h.width,T=d.height,w=d.width;for(s=0;s<P;s++){var I=Math.floor(v*s);for(o=0;o<f;o++)r=4*S(o,s,f,P),l=4*S(Math.floor(p*o),I,w,T,!0),b[r]=g[l],b[r+1]=g[l+1],b[r+2]=g[l+2],b[r+3]=g[l+3],b[r]>=254&&b[r+1]>=254&&b[r+2]>=254&&(b[r]=234,b[r+1]=233,b[r+2]=233,b[r+3]=1)}}return u.putImageData(h,0,0,0,0,c.width,c.height),c.toDataURL("image/png")}console.error("error")}else console.error("error")},saveAnimationScreenshot:function(e){var t=this,i=e,n=t.animations[i],a=n.attributes._VariantLine.attributes._OrderedIndexes.length,o=t.NB_SCREENSHOTS_PER_ANIMATION,s=t.getFrameWindow().getViewer();t._viewpointForAnimation=s.currentViewpoint;for(var r=0;r<o;++r){var l=parseInt(r*a/o);t.saveScreenshot(n,e,r,l)}},saveScreenshot:function(t,i,n,a){var s=this;require(["DS/CoreEvents/Events"],(function(r){var l=s.getFrameWindow().getViewer(),m=l.backgroundColor;l.setBackgroundColor();var d=new o(s.getFrameWindow(),t,s.keyFramer);d.goToIndex(a);var c=s.getScreenshot({reductionFactor:6});d.goToIndex(0);var u=new e.Element("img");u.id=n,u.src=c,s.animScreenshots[i][n]=u,r.publish({event:"CMDCHOOSEANIMATION/SCREENSHOT_SAVED",data:{animationId:i,screenshotId:n}}),d.reset(),l.setBackgroundColor(m)}))},startThumbnailAnimations:function(){var e=document.getElementsByClassName("CmdChooseAnimation-thumbnail-animation"),t=0;this.animateThumbnails=setInterval((function(){for(var i=0;i<e.length;++i){var n=e[i].children,a=n.length;n[t%a].style.display="none",n[(t+1)%a].style.display="block"}++t}),100)},stopThumbnailAnimations:function(){clearInterval(this.animateThumbnails);for(var e=document.getElementsByClassName("CmdChooseAnimation-thumbnail-animation"),t=0;t<e.length;++t){var i=e[t].children;i[0].style.display="block";for(var n=1;n<i.length;++n)i[n].style.display="none"}}})}));