define("DS/VCXWebVisu/VCXModifiablesAccess",["DS/Visualization/PathElement"],(function(e){"use strict";var t={getProductFromPathElement:function(t,r){let a=0;const i=new e;for(;a<t.externalPath.length;){i.addElement(t.getElement(a));const e=r.ComponentsMap.GetComponentFromPathElement(i);if(e&&"CXPExperience_Spec"!==e.GetType())return e;a++}},getModifiableFromPathElement:async function(e,r,a,i){let n;if(i&&(n=t.GetModifiableFromPathElement(e,r,!0),!n)){const t=r.getManager("VCXCAT3DXModelManager"),a=this.getProductFromPathElement(e,r),i=t&&await t.createComponentFromPathElement(e,a);return n=i&&i.QueryInterface("VCXIModifiable"),n}return t.GetModifiableFromPathElement(e,r,a)},GetModifiableFromPathElement:function(e,t,r){if(!e||!e.externalPath||!e.externalPath.length)return null;var a,i;if(e.externalPath[0].handle)a=e.externalPath[0].handle&&e.externalPath[0].handle.manipulator&&e.externalPath[0].handle.manipulator.interactor&&e.externalPath[0].handle.manipulator.interactor.component;else if(e.getLastElement(!0).magnet){var n=e.getLastElement(!0).magnet;a=n&&n.measurable&&n.measurable.getHolder()&&n.measurable.getHolder().GetObject()}else{let i=(a=t.getManager("VCXSelectManager").GetComponentFromPathElement(e))&&a.QueryInterface("W3AISGNodeHolder").getPathElement();if(!r)for(;!a&&i&&i.externalPath&&i.externalPath.length;)i.externalPath.pop(),a=t.ComponentsMap.GetComponentFromPathElement(i)}if(!(i=a&&a.QueryInterface("VCXIModifiable"))){var o=t.getManager("VCXContextManager");o&&o.getUrlVars().debug&&console.log("Can't find modifiable associated to path: ",e)}return i},GetLinkedParentLevelFromPropertyValue(e,t,r){let a=null,i=e.match(/([^$]|^)\$\(([0-9a-z.|_-\s]*)#([0-9]*)#([0-9a-z._-]*)\)/i);if(!(i&&Array.isArray(i)&&i.length>3))return a=r.ComponentsMap.GetComponentFromID(t),a;let n=parseInt(i[3]),o=r.ComponentsMap.GetComponentFromID(t);if(o){for(;n>0;){let e=o.QueryInterface("VCXIModelNavigable").getParent().GetObject();e?o=e:console.log("/! GetLinkedParentLevelFromPropertyValue: bad parent level"),n--}a=o}return a},ValuateLinkedProperties:function(e,r,a,i,n){var o=e;let l=e;for(var s="",d=/([^$]|^)\$\(([0-9a-z.|_-\s]*)#([0-9]*)#([0-9a-z._-]*)\)/i,c=o.match(d);c;){var u=c[0],f=c.index,p=u.length;f>0&&(s+=o.substring(0,f+1)),s+=c[1];var g=c[2];""===g&&(g=a),""!==g&&"0"!==g||(g=i);var m=parseInt(c[3]),h=c[4],b=r.ComponentsMap.GetComponentFromID(g);if(b){for(;m>0;){var v=b.QueryInterface("VCXIModelNavigable").getParent().GetObject();v?b=v:console.log("/! ValuateLinkedProperties: bad parent level"),m--}var y=b.QueryInterface("VCXIModifiable");if(y){var P=y.GetProperty(h);if(P){var C="";C=n?n(P,r):P.GetPropertyValue().ToString(),s+=C=t.ValuateLinkedProperties(C,r,g,i,n)}}}for(o=o.substring(f+p);o&&"\n"===o[0];)o=o.substring(1),s+="\n";c=o.match(d)}return"$(##Actor.PartList.ID)"===l&&""===s?s="Id":s+=o,s},GetPathElementFromEvent:function(e,t){var r=t.getManager("VCXContextManager").getMainViewer();if(!r.div)return null;var a=r.getMousePosition(e.from[0].getCurrentPosition(r.div)),i=r.pick(a,"mesh",!1),n=null;return i&&i.path&&i.path.length>0&&(n=i.path[0].clone()),n},GetModifiableFromEvent:function(e,r){var a=t.GetPathElementFromEvent(e,r);return a&&t.GetModifiableFromPathElement(a,r)}};return t})),define("DS/VCXWebVisu/VCXVisuBuffers",["require","exports","DS/Visualization/ThreeJS_DS"],(function(e,t,r){"use strict";class a{constructor({iCount:e,i0:t,isIndexed:r,bufferIndex:a,bufferVertex:i,bufferNormals:n,geometry:o}){this.iCount=e,this.i0=t,this.isIndexed=r,this.bufferIndex=a,this.bufferVertex=i,this.bufferNormals=n,this.geometry=o}static fromPrim(e){const t=e.getGroup(),r=t.geometry;return new a({iCount:e.getCount(),i0:e.getStart(),isIndexed:!t.nonIndexed,bufferIndex:r.vertexIndexArray,bufferVertex:r.vertexPositionArray,bufferNormals:r.vertexNormalArray,geometry:r})}getTriangle(e){if(this.bufferIndex.length<e+3)return{triangle:null,nextIndex:e};const t={index:(e-this.i0)/3,buffers:this,points:[]};for(let r=0;r<3;r++){const a=e+r;t.points.push({index:this.isIndexed?this.bufferIndex[a]:a})}return{triangle:t,nextIndex:e+3}}getTriangles(e,t){if(this.iCount<e-this.i0+3*t||this.bufferIndex.length<e+3*t)return{triangles:null,nextIndex:e};const r=[];for(let a=0;a<t;a++){const t=this.getTriangle(e);t.triangle&&(r.push(t.triangle),e=t.nextIndex)}return{triangles:r,nextIndex:e}}fillRays(e){e&&e.forEach((e=>{e.ray||(e.ray=new r.Ray,this.geometry.getVertexPosition(e.index,e.ray.origin),this.geometry.getVertexNormal(e.index,e.ray.direction),e.ray.direction.normalize())}))}}return a})),define("DS/VCXWebVisu/VCXTextureUtils",["DS/Visualization/ThreeJS_DS"],(function(e){"use strict";let t={loadHDRTexture:function(r,a,i,n,o){let l=new e.DataTexture;l.loadEndStatus="loading",l.hdr=!0,l.sRGB=!1,l.mapping=a,l.needsSH=!1,l.shFactorsR=null,l.shFactorsG=null,l.shFactorsB=null;let s=new XMLHttpRequest;return s.onload=()=>{e.ImageUtils.nbTexturesBeingLoaded--;let r=null;try{r=t.parseRadianceHDR(s.response,a,o)}catch(e){return void n(e)}l.format=r.format,l.type=r.type,l.image.data=r.data,l.image.width=r.width,l.image.height=r.height,l.loadEndStatus="complete",l.needsSH&&e.ImageUtils.computeSphericalHarmonics(l),l.generateMipmaps=!0,l.needsUpdate=!0,i&&i(l);for(let e=0;e<l.onLoadCallbacks.length;e++)l.onLoadCallbacks[e](l);s=null},s.onerror=()=>{l.loadEndStatus="error",n(),e.ImageUtils.nbTexturesBeingLoaded--},s.open("GET",r,!0),s.responseType="arraybuffer",s.send(null),e.ImageUtils.nbTexturesBeingLoaded++,l},parseRadianceHDR:function(t,r,a){let i,n=a?e.FloatType:e.UnsignedByteType,o={data:null,width:0,height:0,format:e.RGBAFormat,type:n},l={offset:0,data:new Uint8Array(t)},s="";for(i=0;i<10;i++)s+=String.fromCharCode(l.data[l.offset++]);if("#?RADIANCE"!==s)return o;let d,c=0;do{if(d=c,c=l.data[l.offset++],10===c&&10===d)break}while(10!==c||10!==d);let u="";do{if(c=l.data[l.offset++],10===c)break;u+=String.fromCharCode(c)}while(10!==c);if(null===new RegExp(/[-,+][X,Y]\s+([0-9]+)\s+[-,+][X,Y]\s+([0-9]+)/i).exec(u))return o;if(o.height=RegExp.$1,o.width=RegExp.$2,parseInt(o.height)*parseInt(o.width)>33177600)throw new Error("Only images that have less than 16k resolution are supported.");o.data=a?new Float32Array(o.width*o.height*4):new Uint8Array(o.width*o.height*4);let f=new Uint8Array(4*o.width),p=0,g=(e,t,r,a,i)=>{for(;t-- >0;){let n=e[4*t],o=e[4*t+1],l=e[4*t+2],s=e[4*t+3];if(i){n/=255,o/=255,l/=255;let e=Math.pow(2,s-128);n*=e,o*=e,l*=e,r[a++]=n,r[a++]=o,r[a++]=l,r[a++]=1}else r[a++]=n,r[a++]=o,r[a++]=l,r[a++]=s}e=null},m=(e,t,r,a)=>{let i=0;for(;r>0;)if(e[4*t]=a.data[a.offsetElem++],e[4*t+1]=a.data[a.offsetElem++],e[4*t+2]=a.data[a.offsetElem++],e[4*t+3]=a.data[a.offsetElem++],1===e[4*t]&&1===e[4*t+1]&&1===e[4*t+2]){for(let a=e[4*t+3]<i;a>0;a--)e[4*t]=e[4*(t-1)],e[4*t+1]=e[4*(t-1)+1],e[4*t+2]=e[4*(t-1)+2],e[4*t+3]=e[4*(t-1)+3],t++,r--;i+=8}else t++,r--,i=0;return a=null,!0},h=(e,t,r)=>{let a,i;if(t<8||t>32767)return m(e,0,t,r);if(a=r.data[r.offset],2!==a)return m(e,0,t,r);if(r.offset++,e[1]=r.data[r.offset++],e[2]=r.data[r.offset++],a=r.data[r.offset++],2!==e[1]||128&e[2])return e[0]=2,e[3]=a,m(e,1,t-1,r);for(a=0;a<4;a++)for(i=0;i<t;){let t=r.data[r.offset++];if(t>128){t&=127;let n=r.data[r.offset++];for(;t--;)e[4*i+a]=n,i++}else for(;t--;)e[4*i+a]=r.data[r.offset++],i++}return e=null,r.data.length!==r.offset};for(let e=o.height-1;e>=0&&!1!==h(f,o.width,l);e--)g(f,o.width,o.data,p,a),p+=4*o.width;return l=null,o}};return t})),define("DS/VCXWebVisu/VCXAmbienceUtils",["require","exports","DS/GPUFormats/GPUFormats","DS/Visualization/ThreeJS_DS"],(function(e,t,r,a){"use strict";const i=a;class n{static loadEnvironmentTexture(e,t){const r=n.getBlobUrl(t.replace(/^data:.*;base64,/,""));return new Promise(((t,a)=>{e?i.ImageUtils.loadHDRTexture(r,new i.LatLongEnvMapping,(e=>{window.URL.revokeObjectURL(r),t(e)}),(e=>{a(e)})):i.ImageUtils.loadTexture(r,new i.LatLongEnvMapping,(e=>{window.URL.revokeObjectURL(r),t(e)}),(()=>{a(new Error("NLS.ambienceLoadingErrorNotSupportedAmbience"))}))}))}static getPlainImageFromTexture(e,t){let a=e?.image;if(!a||e.format!==r.RGBAFormat&&e.format!==r.RGBFormat)return null;let i=a.width,n=a.height,o=a.data;t||(t=i*n);let l=document.createElement("canvas");l.width=i,l.height=n;let s=l.getContext("2d");if(a instanceof Image)s?.drawImage(a,0,0);else{let e=s?.createImageData(i,n)??null;if(!e?.data)return null;if(o instanceof Uint8Array){const t=4;for(let r=0;r<n;r++)for(let a=0;a<i;a++){const n=(r*i+a)*t,l=(r*i+(i-1-a))*t;let[s,d,c,u]=[o[n],o[n+1],o[n+2],o[n+3]],f=Math.pow(2,u-128);e.data[l]=s*f,e.data[l+1]=d*f,e.data[l+2]=c*f,e.data[l+3]=255}s?.putImageData(e,0,0)}else{const t=3;for(let r=0;r<n;r++)for(let a=0;a<i;a++){const n=(r*i+a)*t,l=4*(r*i+(i-1-a));e.data[l]=255*o[n],e.data[l+1]=255*o[n+1],e.data[l+2]=255*o[n+2],e.data[l+3]=255}s?.putImageData(e,0,0)}}if(t!==i*n){let e=Math.sqrt(t/(i*n));const r=Math.round(i*e),a=Math.round(n*e),o=document.createElement("canvas");o.width=r,o.height=a;const s=o.getContext("2d");return s?.scale(e,e),s?.drawImage(l,0,0),s?.getImageData(0,0,r,a)??null}return s?.getImageData(0,0,i,n)??null}static getPlainImageFromHDR(e,t){const r=n.getBlobUrl(e.replace(/^data:.*;base64,/,""));return new Promise(((e,a)=>{i.ImageUtils.loadHDRTexture(r,new i.LatLongEnvMapping,(i=>{i.image.data?(window.URL.revokeObjectURL(r),e(n.getPlainImageFromTexture(i,t))):a(new Error("NLS.ambience_texture_loading_fail"))}),(e=>{a(e)}),!1)}))}static getBlobUrl(e){const t=atob(e),r=[];for(let e=0;e<t.length;e+=512){const a=t.slice(e,e+512),i=new Array(a.length);for(let e=0;e<a.length;e++)i[e]=a.charCodeAt(e);r.push(new Uint8Array(i))}const a=new Blob(r,{type:"application/octet-binary"});return e=null,URL.createObjectURL(a)}}return n})),define("DS/VCXWebVisu/VCXVisuTools",["require","exports","DS/VCXWebVisu/VCXModifiablesAccess","DS/Visualization/SceneGraphUtils","DS/VCXWebVisu/VCXVisuBuffers","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],(function(e,t,r,a,i,n,o){"use strict";return class{static buildGraphicPropertiesStructure(e,t,r,i){var o=i&&(i.getColor||i.getAll),l=i&&(i.getOpacity||i.getAll),s=i&&(i.getMaterial||i.getAll||o||l),d=i&&(i.getWorldPosition||i.getAll),c=i&&(i.getVisibility||i.getAll),u=i&&(i.getRenderStyle||i.getAll);const f=[];var p=e;let g=t||p&&p.QueryInterface("W3AISGNodeHolder").getPathElement();for(var m=0;p||g;){m++;const e={};e.object=p;var h=p&&p.QueryInterface("W3AISGNodeHolder").getPathElement()||g;if(h){if(e.pathElement=h,1===m){if(e.cad={},s||o||l){const t=a.getCurrentGraphicProperties({pathElement:h,getMaterial:s,getColor:o,getOpacity:l});t&&t.length>0&&(s&&(e.cad.Material=t[0].material),o&&(e.cad.Color=t[0].color),l&&(e.cad.Opacity=t[0].opacity),d&&(e.cad.WorldPosition=h.getWorldMatrix(r)))}c&&(e.cad.Visibility=a.getCurrentVisibility(h))}var b=p.getSharedSceneGraphOverride&&p.getSharedSceneGraphOverride();if(b){var v={},y=!1;s&&null!=b.getMaterial()&&(y=!0,v.Material=b.getMaterial(),v.Material.isMatApp&&(v.Material=v.Material._material)),o&&null!=b.getColor()&&(y=!0,v.Color=new n.Color(b.getColor())),l&&null!=b.getOpacity()&&(y=!0,v.Opacity=b.getOpacity()),c&&null!=b.getVisibility()&&(y=!0,v.Visibility=b.getVisibility()),u&&null!=b.getRenderStyle()&&(y=!0,v.RenderStyle=b.getRenderStyle()),y&&(e.override=v)}}f.push(e),p?(p=p.QueryInterface("VCXIModelNavigable")&&p.QueryInterface("VCXIModelNavigable").getParent()&&p.QueryInterface("VCXIModelNavigable").getParent().GetObject(),g=null):g=g.getParentPath()}const P=f[0];P.visible={},P.cad?(s&&P.cad.hasOwnProperty("Material")&&(P.visible.Material=P.cad.Material),o&&P.cad?.hasOwnProperty("Color")&&(P.visible.Color=P.cad.Color),l&&P.cad.hasOwnProperty("Opacity")&&(P.visible.Opacity=P.cad.Opacity),c&&P.cad.hasOwnProperty("Visibility")&&(P.visible.Visibility=P.cad.Visibility)):(s&&(P.visible.Material=null),o&&(P.visible.Color=new n.Color),l&&(P.visible.Opacity=1),c&&(P.visible.Visibility=!0),u&&(P.visible.RenderStyle=0));for(var C=0;C<f.length;C++){const e=f[C];e.override&&(s&&e.override.hasOwnProperty("Material")&&(P.visible.Material=e.override.Material),o&&e.override.hasOwnProperty("Color")&&(P.visible.Color=e.override.Color),l&&e.override.hasOwnProperty("Opacity")&&(P.visible.Opacity=e.override.Opacity),u&&e.override.hasOwnProperty("RenderStyle")&&(P.visible.RenderStyle=e.override.RenderStyle))}if(c&&(P.visible.Visibility=r.getSceneGraphOverrideSetManager().getCurrentVisibility(P.pathElement)),l){var x=P.visible&&P.visible.Material,I=1;x&&(I=x.getOpacity()),P.visible.ComputedOpacity=I*(P.visible.hasOwnProperty("Opacity")?P.visible.Opacity:1)}return o&&(P.visible.hasOwnProperty("Material")&&P.visible.Material&&P.visible.Material.color?P.visible.ComputedColor=P.visible.Material.color:P.visible.hasOwnProperty("Color")&&(P.visible.ComputedColor=P.visible.Color)),f}static traverseComponentNodes(e,t){let r=e.QueryInterface("W3AISGNodeHolder"),a=r&&r.getPathElement(),i=r=>{let a=r.getChildrenPathes();a&&a.every((r=>{if(!e.GetObject()._experienceBase.ComponentsMap.GetComponentFromPathElement(r)){let e=t&&t(r);return e&&i(r),e}}))},n=t&&t(a);return n&&i(a),n}static traverseAll(e,t){let r,a=[],n=0,l=s=>{let d={object:s,index:n,parentObject:null},c=!0;if(t.filterPathElement&&(c=t.filterPathElement(d)),c&&(t.processPathElement&&a.push(t.processPathElement(d)),t.processGeometry||t.processPrimitiveGroup||t.processPrimitive||t.processBuffers||t.processTriangle)){var u=s&&s.getLastElement();const n=u.mesh3js&&u.mesh3js.geometry;var f;(f=n&&!n.forEach?[n]:n)&&f.every(((e,n)=>{let l={object:e,index:n,parentObject:d},s=!e.noMeshInRAM;if(e.vertexIndexArray?t.filterGeometry&&(s=t.filterGeometry(l)):s=!1,s&&(t.processGeometry&&a.push(t.processGeometry(l)),t.processPrimitiveGroup||t.processPrimitive||t.processBuffers||t.processTriangle)){let n=e.drawingGroups;n&&n.every(((e,n)=>{let s={object:e,index:n,parentObject:l},d=!0;if(t.filterPrimitiveGroup&&(d=t.filterPrimitiveGroup(s)),d&&(t.processPrimitiveGroup&&a.push(t.processPrimitiveGroup(s)),t.processPrimitive||t.processBuffers||t.processTriangle)){let n=!0;const l=e.getPrimitivesCount();for(let d=0;d<l&&n;++d){const l=new o.SGPrimitiveHelper;l.set(e,d);var c=THREEDS.SubElement.getFromSGNode(l);let u=r.clone();u.addElement(c);let f={object:l,index:d,parentObject:s,pathElement:u},p=!0;if(t.filterPrimitive&&(p=t.filterPrimitive(f)),p&&(t.processPrimitive&&a.push(t.processPrimitive(f)),t.processBuffers||t.processTriangle)){let r=i.fromPrim(l),n={object:r,index:0,parentObject:f},o=!0;if(r&&t.filterBuffers&&(o=t.filterBuffers(n)),r&&o&&(t.processBuffers&&a.push(t.processBuffers(n)),t.processTriangle)){let i=[],o=0,l=!0;for(let s=r.i0;s<r.i0+r.iCount&&l;4===e.glType?s+=3:s++){let e={index:o,buffers:r,points:[]};for(let t=0;t<3;t++){let a=s+t;i[a]||(i[a]={index:r.isIndexed?r.bufferIndex[a]:a}),e.points.push(i[a])}let d={object:e,index:o,parentObject:n};o++,t.processTriangle&&a.push(t.processTriangle(d)),t.postProcessTriangle&&(l=t.postProcessTriangle(d))}}r&&t.postProcessBuffers&&t.postProcessBuffers(n)}t.postProcessPrimitive&&(n=t.postProcessPrimitive(f))}}let u=!0;return t.postProcessPrimitiveGroup&&(u=t.postProcessPrimitiveGroup(s)),u}))}let c=!0;return t.postProcessGeometry&&(c=t.postProcessGeometry(l)),c}));let c=s.getChildrenPathes();c&&c.every((t=>(e.GetObject()._experienceBase.ComponentsMap.GetComponentFromPathElement(t)||l(t),!0)))}let p=!0;return t.postProcessPathElement&&(p=t.postProcessPathElement(d)),n++,p},s=e.QueryInterface("W3AISGNodeHolder");return r=s&&s.getPathElement(),l(r),a}}}));