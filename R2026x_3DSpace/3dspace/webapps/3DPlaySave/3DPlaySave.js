define("DS/3DPlaySave/Load3DComment",["UWA/Core","UWA/Controls/Abstract","DS/3DPlayWAFRMigration/Command","DS/WebSystem/SessionManager","UWA/Utils"],(function(e,t,n,o,i){"use strict";var r,a=t.extend({init:function(t){this._parent(t);var n=null,o=new FileReader,r=!1;function a(){!r&&t.onErrorCB&&t.onErrorCB()}(n=new e.createElement("input",{id:"TestFileSelector"}).inject(widget.body)).setAttribute("type","file"),n.setAttribute("accept",".json,.zip"),n.setStyles({opacity:0}),n.onchange=function(){if(n){var e=n.files;if(!e||e&&!e.length)return void a();setTimeout(a,5e3),e[0].name.indexOf(".zip")>-1?(o.onload=function(){r=!0;var e=o.result;try{e=i.base64Decode(e)}catch(e){}for(var n=new ArrayBuffer(e.length),a=new Uint8Array(n),s=0;s<e.length;s++)a[s]=e.charCodeAt(s);var l=new window.zip.Inflater,c=l.append(a);l.flush();var u=String.fromCharCode.apply(null,c);t.onFileLoadedCB(JSON.parse(u))},o.readAsBinaryString(e[0])):(o.onload=function(){r=!0;var e=o.result;e=(e=e.replace(/\\n/g,"\\n").replace(/\\'/g,"\\'").replace(/\\"/g,'\\"').replace(/\\&/g,"\\&").replace(/\\r/g,"\\r").replace(/\\t/g,"\\t").replace(/\\b/g,"\\b").replace(/\\f/g,"\\f")).replace(/[\u0000-\u0019]+/g,""),t.onFileLoadedCB(JSON.parse(e))},o.readAsText(e[0]))}},this.openFileBrowser=function(){n.click()},this.cleanFileBrowser=function(){n&&n.parentNode===widget.body&&widget.body.removeChild(n),n=null}}});return n.extend({init:function(e){this._parent(e,{mode:"shared"}),this.setRepeatMode(!1);var t=this;this.initFileBrowser=function(){r=new a({onErrorCB:function(){},onFileLoadedCB:function(e){o.restoreSession(e),r.cleanFileBrowser(),r=null,t.end()}})},this.initFileBrowser()},beginExecute:function(){r||this.initFileBrowser(),r.openFileBrowser()}})})),define("DS/3DPlaySave/SaveServices",["DS/WebUtils/Tracker","DS/WebUtils/Network","DS/WebUtils/WebServices","DS/WebInfraUI/CmdScenarioUI","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WebUtils/StringUtils","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/WebUtils/Logger","DS/WebInfraUI/ConfirmBox","DS/WebInfraUI/LoadingPanel"],(function(e,t,n,o,i,r,a,s,l,c,u,d,m,f){"use strict";var p,D,S,v,g,h,y,b,C,F,w={"3DSpace":{name:"3DSpace",app:"X3DCSMA_AP",module:"DS/3DPlaySave/SaveTo3DSpace"},"3DSwym":{name:"3DSwym",app:"X3DMCTY_AP",module:"DS/3DPlaySave/SaveTo3DSwym"},"3DDrive":{name:"3DDrive",app:"X3DDRIV_AP",module:"DS/3DPlaySave/SaveTo3DDrive"}},P=d("3DPlay.SaveServices","3DPlay.Log.Save");function T(){require(["DS/3DPlaySave/CmdUpload3DExp","DS/ApplicationFrame/CommandFactory"],(function(e,t){t._createCommandCheckHeader(e,{ID:"Upload3Dexp",context:y.ctx}),y.lightbox&&y.lightbox.update()}))}function I(){return new UWA.Promise((function(e,t){n.getPlatformServices({onComplete:function(t){if(v=[],t&&t.length>0){var n=[],o=Object.keys(w);g&&"STPA"===g.format.toUpperCase()&&["3DSwym","3DSpace"].forEach((e=>{o.indexOf(e)>-1&&o.splice(o.indexOf(e),1)}));for(var i=t.length;i--;)for(var r=Object.keys(t[i]),a=o.length;a--;){var s=o[a];-1===n.indexOf(s)&&r.indexOf(s)>-1&&(n.push(s),v.push(w[s]))}}P.warn("availableProviders",v),e(v)},onFailure:t})}))}var _=function(){h&&a.removeNotification(h),h=null},U=function(){_();var t,n={level:"info",message:i.FileDnDFromDesktopNotif,category:"3DPlayPublishServices",sticky:!0},o=v&&v.length>0;if(o&&(n.action={label:v.length>1?i.FileDnDFromDesktopNotif_ActionTitle:i.FileDnDFromDesktopNotif_ActionTitle_1+v[0].name,callback:function(){t=!0,e.command("NotifUpload3DExp"),k()}},T()),h=r.addNotif(n),o){var s=function(){var e;return a._notifications.forEach((function(t){t._data.count===h&&(e=t)})),e}();s&&(s._action.addClassName("wux-ui-state-primary"),setTimeout((function(){var e=function(){if(!t){var n={level:"warning",message:i.FileDnDFromDesktopNotif+i["FileDnDFromDesktopNotif_2Message".concat("_CMD")],category:"3DPlayPublishServices",sticky:!0};s.getDiv().removeEventListener(c.POINTERUP,e),h=r.addNotif(n)}};s.getDiv().addEventListener(c.POINTERUP,e)}),50))}return h},k=function(){var t=function(t,n){require([t.module],(function(o){function a(){F.pause(),m({warning:!1,container:y.frmWindow.getViewerFrame(),caption:i.FileDnDFromDesktopConfirmBox_Title,info:i.FileDnDFromDesktopConfirmBox_Text,confirm:{callback:function(){F.abort(),x(),_(),r.addNotif({level:"success",message:i.FileDnDFromDesktopConfirmBox_Aborted,category:"3DPlayPublishServices"}),P.warn("canceled"),c("canceled"),e.command("NotifUpload3DExp"),N(!1)},text:i.FileDnDFromDesktopConfirmBox_Confirm},cancel:{callback:function(){F.isFinished()||(F.resume(),s())},text:i.FileDnDFromDesktopConfirmBox_Cancel}}),e.command("NotifUpload3DExp")}function s(){(S=new f({container:document.getElementById("canvas-div"),showButtonsFlag:"closeButtonOnly",title:n.name,info:D})).setCloseButtonCB(a),S.setTitleString(n.name),S.setInfoString(D),S.on(),S.value=0}function c(o){var i=l.getExtension(n.name);e.trackPageEvent("save",i,t.name,{success:200,failed:1,canceled:2,timeout:3}[o],{fileSize:Math.floor(n.size/1e3)}),y.getPhaseProgress().hideProgressBar()}o(n,{frame:y.frmWindow.getImmersiveFrame(),frmWindowContent:y.frmWindow.getContent(),timeout:54e5,onStartUpload:function(e,t){F=e,D=t,s()},onComplete:function(e){P.warn("onComplete"),c("success"),_(),r.addNotif({level:"success",message:i.FileDnDFromDesktopNotif_PublishOK+t.name,category:"3DPlayPublishServices"}),C(e),A()},onCancel:function(){P.warn("canceled"),c("canceled"),x(),N(!1)},onTimeout:function(){c("timeout"),r.addNotif({level:"error",message:i.FileDnDFromDesktopNotif_ErrorTimeout,category:"3DPlayPublishServices"}),P.error("Upload",t.name,"timeout"),x(),N(!1)},onFailed:function(e){c("failed"),r.addNotif({level:"error",title:e.displayMessage?i.FileDnDFromDesktopNotif_ErrorInPublish:void 0,message:e.displayMessage?e.displayMessage:i.FileDnDFromDesktopNotif_ErrorInPublish,category:"3DPlayPublishServices"}),P.error("Upload",t.name,e),x(),N(!1)},onProgress:function(e){S&&(S.value=Math.round(100*e.loaded/e.total)),P.warn("progress",e)},logger:P})}),console.error)};if(v.length<2)_(),t(v[0],g.localFile);else{for(var n=[],a=0;a<v.length;a++){!function(e){e.onSelectCB=function(n){o.dispose(),t(e,g.localFile)},n.push(new Promise((function(t){s.getAppInfo({appId:e.app,onComplete:function(n){e.thumbnail=n.icon,t()}})})))}(v[a])}Promise.all(n).then((function(){n=null,_(),h=void 0,o.create({frmWnd:y.frmWindow,listchooser:v,title:i.FileDnDFromDesktopNotif_ChooserTitle,endcb:function(){N(!1)}})}))}N(!0)};function N(e){y&&y.lightbox&&y.lightbox.manageUploadCommand(e)}function x(){S&&(S.off(),setTimeout((function(){S&&(S.dispose(),S.destroy(),S=null)}),2e3))}function A(){y&&y.lightbox&&y.lightbox.onUploadCompleted(),void 0,void 0,void 0,x(),o.dispose()}return function(e,t,n){if(p)return p=!1,void T();e?(g=e.loadAssetInfo,y=n,C=t,b||(b=!0,y.subscribe("SCENARIO/CHANGE",(function(e){p="FTA"===e.scenario.name}),!0),y.subscribe("ASSET/LOADINGSTARTED",A,!0),y.disposeFunctions.add((function(){A(),b=void 0}))),I().then(U)):I().then(k)}})),define("DS/3DPlaySave/Save3DComment",["DS/3DPlayWAFRMigration/Command","DS/WebSystem/SessionManager","DS/WebSystem/Downloader"],(function(e,t,n){"use strict";return e.extend({beginExecute:function(){!async function(){const e=await t.getSession(),o=JSON.stringify(e);n("3DPlaySession.json",new Blob([o],{type:"json"}))}(),this.end()}})})),define("DS/3DPlaySave/SaveControler",[],(function(e){"use strict";return function(){return{setRequest:function(e){this.req=e},onResume:function(e){this.resumeCB=e},isFinished:function(){return!0===this._finished},isAborted:function(){return!0===this._aborted},isPaused:function(){return!0===this._pause},finish:function(){this._finished=!0},abort:function(){this._aborted=!0,this.req&&this.req.cancel(),this.finish()},pause:function(){this._pause=!0},resume:function(){this.resumeCB&&this.resumeCB(),this._pause=!1}}}})),define("DS/3DPlaySave/SaveTo3DDrive",["DS/WebUtils/Tracker","DS/WAFData/WAFData","DS/UIKIT/Spinner","DS/UIKIT/SuperModal","DS/UIKIT/Input/Text","DS/W3DDriveComponent/DriveContentSelector","css!DS/UIKIT/UIKIT.css","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices","DS/3DPlaySave/SaveControler","DS/WebUtils/StringUtils"],(function(e,t,n,o,i,r,a,s,l,c,u){"use strict";return function(e,i){var a,d=c();function m(){a&&function(n,o){var r=n.url+"/resources/3ddrive/v1/bos/"+n.objectId+"/contents?update=true&withactions=true";n.tenant&&(r+="&tenant="+n.tenant);var a={"Content-Type":"application/json;charset=UTF-8"};a["X-DS-CSRFTOKEN"]=n.token;var s={};s.receipt=n.receipt,s.file=n.displayName,s.title=n.displayName,s.type="DriveFile",i.logger.warn("contents",r,a),t.authenticatedRequest(r,{parse:!0,validate:!0,wait:!0,method:"POST",type:"json",headers:a,file:e,data:JSON.stringify(s),onComplete:o.onComplete,onFailure:o.onFailure})}(a,{onFailure:i.onFailed,onComplete:function(e){d.finish(),i.onComplete({objectType:"DriveFile",objectId:e.id,serviceId:"3DDrive",envId:a.envId,displayName:a.displayName}),a=null}})}function f(e){var t=document.querySelector(".drive-validation-button");t&&(t.disabled=e)}function p(){f(!0)}var D,S=new n({className:"spinner-center",visible:!0}),v=new o({className:"driveBrowserTest",closable:!1,renderTo:document.body});v.dialog({title:s.DriveBrowser_Title,body:[S],buttons:[{className:"primary drive-validation-button",value:s.DriveBrowser_Button_OK,action:function(n){var o,r;i.onStartUpload(d,u.sprintf(s.Drive_Progress_Info,D.displayName)),o=D.envId,r={onFailure:i.onFailed,onComplete:function(n){!function(e,n,o){var r=e.url+"/resources/3ddrive/v1/bos/ticket";e.tenant&&(r+="?tenant="+e.tenant),i.logger.warn("_getTicket",r),t.authenticatedRequest(r,{method:"GET",type:"json",onComplete:function(e,t,o){e&&e.actionurl&&e.ticket&&e.jobticket?n.onComplete({ticket:e,token:t["x-ds-csrftoken"]}):(i.logger.error("_getTicket no response Ticket"),n.cbs&&n.onFailure())},onFailure:e.onFailure})}({url:n.url,envId:D.envId},{onFailure:i.onFailed,onComplete:function(o){!function(e,n){var o=new FormData;o.append(e.ticket.jobticket,e.ticket.ticket),o.append("file-name",e.file.name),o.append("file_0",e.file),o.append("file-title",e.file.name),o.append("file-description",e.file.name),i.logger.warn("uploadFCS",e.ticket.actionurl,e.ticket.jobticket,e.ticket.ticket),d.isAborted()||d.setRequest(t.authenticatedRequest(e.ticket.actionurl,{timeout:n.timeout,method:"POST",data:o,onTimeout:n.onTimeout,onComplete:n.onComplete,onUploadProgress:n.onProgress,onFailure:n.onFailure}))}({ticket:o.ticket,file:e},{timeout:i.timeout,onTimeout:i.onTimeout,onFailure:i.onFailed,onProgress:i.onProgress,onComplete:function(t){d.isAborted()?i.onCancel():(d.setRequest(null),a={url:n.url,objectId:D.objectId,envId:D.envId,token:o.token,displayName:e.name,receipt:UWA.createElement("div").setHTML(t).getElement('[name="__fcs__jobReceipt"]').value},d.isPaused()||m())}})}})}},l.getServiceUrl({serviceName:"3DDrive",platformId:o,onError:r.onFailure,onSuccess:r.onComplete}),n.hide()}},{value:s.DriveBrowser_Button_Cancel,action:function(e){e.hide(),i.onCancel()}}]}),p();var g={accessright:"edit",select:{createFolder:!0,type:"DriveFolder"},filter:{type:"DriveFolder"},multiEnv:!0,onSelect:function(e){e&&e.length>0&&e[0]&&"sharedwithme"!==(D=e[0]).objectId&&D.envId?f(!1):p()}};try{var h=r.create3DDriveChooser(g);S.hide(),v.modals.current.getBody().appendChild(h.container)}catch(e){v.modals.current.hide()}d.onResume(m)}})),define("DS/3DPlaySave/SaveTo3DSwym",["DS/WebUtils/Tracker","DS/UIKIT/Modal","DS/WAFData/WAFData","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices","DS/WebUtils/StringUtils","DS/3DPlaySave/SaveControler"],(function(e,t,n,o,i,r,a){"use strict";return function(e,s){var l,c,u,d,m,f=a();function p(){m.id&&(d.addEvent("ContentCreated",(function(e){c();try{e=JSON.parse(e)}catch(t){e=""}if(!0===e.success){var t={objectType:"media",objectId:e.contentSubjectURI,serviceId:"3DSwym",envId:m.tenant,displayName:m.displayName};s.onComplete(t)}else s.onFailed({});s.logger.warn("publishFormView.createContent",m.id)})),d.createContent(m.id))}return require(["DS/SwymPublishForm/script/publish-form-view"],(function(a){let D={mode:"jsevent",contentTitle:e.name};window.widget&&window.widget.getValue("x3dPlatformId")&&(D.platformId=window.widget.getValue("x3dPlatformId")),d=new a(D),u=function(){l&&(l.destroy(),l=null)},c=function(){d&&(d.destroy(),d=null),u()},d.addEvent("CancelShare",(function(){c(),s.onCancel()})),d.addEvent("StartUpload",(function(t){u();var a=JSON.parse(t);a._currentThreadType&&a._currentThreadType,s.logger.warn("StartUpload",t),s.onStartUpload(f,r.sprintf(o["Swym_Progress_Info_"+a.threadType],a.threadTitle)),function(e){s.logger.warn("_getServerToken",e.url+"/api/index/tk"),n.authenticatedRequest(e.url+"/api/index/tk",{method:"GET",type:"json",onComplete:function(t){t&&t.result&&t.result.ServerToken?e.onComplete(t.result.ServerToken):(s.logger.error("_getServerToken No response"),e.onFailure&&e.onFailure())},onFailure:e.onFailure})}({url:a.platform_instance,onComplete:function(t){m={tenant:i.getTenant(a.platform_instance),displayName:e.name},function(e){var t=new FormData;t.append("userFile",e.file,e.localFilename),t.append("published",1),t.append("title",e.name),t.append("community_id",e.communityId),"media"!==e._currentType&&t.append("is_illustration","true"),s.logger.warn("_publish",e.url+"/api/media/add",e.communityId),f.isAborted()||f.setRequest(n.authenticatedRequest(e.url+"/api/media/add",{timeout:e.timeout,method:"POST",type:"json",headers:{"X-DS-SWYM-CSRFTOKEN":e.serverToken},data:t,onTimeout:e.onTimeout,onComplete:function(t){f.setRequest(null),t.errorcode?(s.logger.error("_publish",t),e.onFailure&&e.onFailure(t)):e.onComplete(t)},onUploadProgress:e.onProgress,onFailure:function(t,n,i){e.onFailure({error:t,response:n,headers:i,displayMessage:n&&n.errorcode&&r.sprintf(o["Swym_"+n.errorcode],"3DSwym")||"File exceeds 3DSwym's size limit"})}}))}({timeout:s.timeout,url:a.platform_instance,communityId:a.community_id,serverToken:t,file:e,filename:e.name,name:e.name,onTimeout:s.onTimeout,onFailure:s.onFailed,onProgress:s.onProgress,onComplete:function(e){if(f.isAborted())return s.onCancel(),void c();m.id=e.result.id,f.isPaused()||p()}})},onFailure:s.onFailed})})),(l=new t({closable:!1,header:o.SwymPublish_Title,body:d.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),l.show()})),f.onResume(p),f}})),define("DS/3DPlaySave/SaveTo3DSpace",["DS/WebUtils/WebServices","DS/WebSystem/App","DS/3DPlaySave/SaveControler"],(function(e,t,n){"use strict";var o="3DSpace";return function(e,i){var r,a=n(),s=function(t,n){i.logger.warn("PlateformInfo :",t[o],t.platformId,n);var a=new r({tenantUrl:t[o],tenant:t.platformId,securityContext:n,immersiveFrame:i.frame,getWorkUnderHeaders:function(){return{}},onUploadStart:function(){i.logger.warn("onUploadStart");try{widget.body.querySelector(".doco-progress-progresspane").inject(i.frmWindowContent)}catch(e){console.error(e)}},onCancel:i.onCancel,onError:i.onFailed,onDocumentUpload:function(n){i.logger.warn("onDocumentUpload");var r=n.documents[0];i.onComplete({objectId:r.id,objectType:r.type,envId:t.platformId,serviceId:o,displayName:e.name}),a.destroy(),a=null}});a.create([e])};return require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PADServices/utils/GlobalUtils","DS/DocumentCreateNew/CreateNew"],(function(e,n,a){r=a;var l=[];n.getSecurityContext()||l.push(new Promise((function(e){require(["DS/PADServices/utils/PlatformURL"],(function(t){t.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}).then((()=>{n.retrieveAndSetSC().then(e)}))}))}))),e.getPlatformServices({serviceName:o,onError:i.onFailed,onComplete:function(e){t.isOnCloud()&&e.length>1?parent.require(["DS/Dashboard/Modals/PlatformSelect","i18n!DS/Dashboard/assets/nls/modal"],(function(t,r){var a=[];e.forEach((e=>{e[o]&&a.push(e)})),i.logger.warn(e,a),e=null,t.show({message:r.noPlatformSelectContent,closable:!0,platforms:a,onCancel:i.onCancel,onConfirm:function(e){Promise.all(l).then((()=>{s(e,n.getSecurityContext())}))}})})):Promise.all(l).then((()=>{s(e[0],n.getSecurityContext())}))}})})),a}})),define("DS/3DPlaySave/CmdUpload3DExp",["DS/3DPlayWAFRMigration/Command","DS/WebUtils/Tracker","DS/3DPlaySave/SaveServices"],(function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!1}),this.enable()},beginExecute:function(){t.command(this.getId()),n(),this.AFR2_Done()}})}));