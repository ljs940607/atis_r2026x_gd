define("DS/MPFShippingOfferPricesComponent/ShippingPricesTableLine",["UWA/Core","UWA/Class/View","DS/MPFUtils/MPFUtils","DS/UIKIT/Input/Text","DS/MPFOfferModel/ShippingOfferModel","DS/MPFServices/ObjectService","DS/MPFFiniteStateMachine/FiniteStateMachine","i18n!DS/MPFShippingOfferPricesComponent/assets/nls/ShippingOfferPricesComponent","css!DS/MPFShippingOfferPricesComponent/MPFShippingOfferPricesComponent"],(function(e,t,i,n,s,r,o,c){"use strict";const a={EDITION:"edition",NO_EDITION:"no_edition",DISABLED:"disabled"},l=["weight",s.Areas.HOME,s.Areas.EUROPE,s.Areas.AFRICA,s.Areas.ASIA,s.Areas.MIDDLE_EAST,s.Areas.NORTH_AMERICA,s.Areas.SOUTH_AMERICA],h=t.extend({tagName:"tr",setup:function(e){r.requiredOfPrototype(e.shippingOffer,s,"options.shippingOffer must be a ShippingOfferModel"),this._parent(e),this.shippingOffer=e.shippingOffer,this.deliveryOffer=e.deliveryOffer,this.rowIndex=e.rowIndex,this.locale=e.locale||"fr-FR",this.priceElements=this._createPriceElements(),this.kgWeightElement=this._createKgWeightElement()},render:function(){this.cells=[this.kgWeightElement];const e=i.objectValues(this.priceElements);return e.sort((function(e,t){return e.columnIndex>t.columnIndex})),this.cells=this.cells.concat(e),this.container.setContent(this.cells),this},_createKgWeightElement:function(){const t=e.createElement("td",{class:"mpf-shipping-cell weight",text:this.shippingOffer.getWeightKG()});return t.columnIndex=l.indexOf("weight"),t},updateWeightElementUnitToKG:function(){this.kgWeightElement.setContent(this.shippingOffer.getWeightKG())},updateWeightElementUnitToLBS:function(){const e=2.20468*this.shippingOffer.getWeightKG(),t=Math.round(2*e)/2;this.kgWeightElement.setContent(t)},_createPriceElements:function(){const e=Object.keys(s.Areas),t={};for(let i=0;i<e.length;i++){const n=s.Areas[e[i]],r=l.indexOf(n);r>-1&&(t[n]=this._createPriceElement(n,r))}return t},_createPriceElement:function(t,i){const r=this.deliveryOffer&&"NoComputedPrice"===this.deliveryOffer.getPricingOption(),o=this.shippingOffer.getPrice(t),c=s.Fields.PRICES[t],a=c.replace("_","-")+"-price",l=e.createElement("td",{class:"mpf-shipping-cell "+a,html:[r?"":e.createElement("span",{class:"fonticon fonticon-pencil"}),o<0?"":o.toFixed(2)]});if(l.columnIndex=i,l.stateMachine=this._createStateMachine(),r||(l.addEvent("click",this._setEditionMode.bind(this,l)),l.editionInput=new n({events:{onKeyDown:this._onKeyDownHandler.bind(this,l)}}),l.editionInput.elements.input.onblur=this._onBlurHandler.bind(this,l,this.shippingOffer.getPrice.bind(this.shippingOffer,t),this.shippingOffer.setPrice.bind(this.shippingOffer,t)),l.editionInput.elements.input.onkeyup=this._onKeyUp.bind(this,l)),this.deliveryOffer&&this.deliveryOffer.get("deliveryOfferDesactivatedArea")){const e=this.deliveryOffer.get("deliveryOfferDesactivatedArea");Array.isArray(e)&&e.indexOf(c)>-1&&this.disableElement(l)}return l},_saveCell:function(){const e=this,t=this.shippingOffer.changedAttributes();!1!==t&&this.shippingOffer.savePromise(t,{patch:"true"}).catch((function(){e.dispatchEvent("priceNotSaved")}))},enableElement:function(e){e&&(e.removeClassName("disabled"),e.stateMachine.changeState(a.NO_EDITION))},disableElement:function(e){e&&(e.addClassName("disabled"),e.stateMachine.changeState(a.DISABLED))},_createStateMachine:function(){return new o({state:a.NO_EDITION,states:[a.EDITION,a.NO_EDITION,a.DISABLED],transitions:[{from:a.EDITION,to:a.NO_EDITION},{from:a.NO_EDITION,to:a.EDITION},{from:a.DISABLED,to:a.NO_EDITION},{from:a.NO_EDITION,to:a.DISABLED}]})},_setEditionMode:function(e){let t;e.stateMachine.getState()===a.NO_EDITION&&(e.stateMachine.changeState(a.EDITION),e.addClassName("edition"),t=e.getText(),this._isNumber(t)?e.editionInput.setValue(t):e.editionInput.setValue(""),e.setContent(e.editionInput),e.editionInput.setFocus())},_onBlurHandler:function(t,i,n){let s;t.stateMachine.getState()===a.EDITION&&(t.stateMachine.changeState(a.NO_EDITION),t.removeClassName("edition"),s=t.editionInput.getValue(),""!==s&&this._isNumber(s)?(s=this._restrictInputValue(s),t.setContent([e.createElement("span",{class:"fonticon fonticon-pencil"}),s.toFixed(2)]),n.call(this.shippingOffer,s)):(n.call(this.shippingOffer,-42),t.setContent([e.createElement("span",{class:"fonticon fonticon-pencil"}),""])),this._saveCell())},_onKeyDownHandler:function(e,t){const i={};"Enter"===t.key||"ArrowDown"===t.key?(e.editionInput.setFocus(!1),i.rowIndex=this.rowIndex+1,i.columnIndex=e.columnIndex,this.dispatchEvent("changeCell",i)):"Tab"===t.key||"ArrowRight"===t.key?(t.preventDefault(),e.editionInput.setFocus(!1),e.columnIndex+1===l.length?(i.columnIndex=1,i.rowIndex=this.rowIndex+1):(i.rowIndex=this.rowIndex,i.columnIndex=e.columnIndex+1),this.dispatchEvent("changeCell",i)):"ArrowLeft"===t.key?(e.editionInput.setFocus(!1),e.columnIndex-1==0?(i.columnIndex=l.length-1,i.rowIndex=this.rowIndex-1):(i.rowIndex=this.rowIndex,i.columnIndex=e.columnIndex-1),i.direction="left",this.dispatchEvent("changeCell",i)):"ArrowUp"===t.key&&(e.editionInput.setFocus(!1),i.rowIndex=this.rowIndex-1,i.columnIndex=e.columnIndex,this.dispatchEvent("changeCell",i))},_onKeyUp:function(e){const t=e.editionInput.getValue(),i=e.editionInput.elements.input;this._isNumber(t)||i.hasClassName("error-validation")?this._isNumber(t)&&i.hasClassName("error-validation")&&i.removeClassName("error-validation"):i.addClassName("error-validation")},focusCell:function(e,t){let i;e>0&&e<l.length&&(i=this.cells[e],i.stateMachine.getState()===a.NO_EDITION?this._setEditionMode(i):i.stateMachine.getState()===a.DISABLED&&("left"===t?e-1>0?this.focusCell(e-1,"left"):this.dispatchEvent("changeCell",{columnIndex:l.length-1,rowIndex:this.rowIndex-1}):e+1<l.length?this.focusCell(e+1):this.dispatchEvent("changeCell",{columnIndex:1,rowIndex:this.rowIndex+1})))},_isNumber:function(e){return!isNaN(e)},_restrictInputValue:function(e){let t;const i=Number(e);return t=i<0?0:i>999.99?999.99:Number(i.toFixed(2)),t}});return h.ElementStates=Object.freeze(a),h.Columns=Object.freeze(l),h.ColumnOrder=Object.freeze(l),h})),define("DS/MPFShippingOfferPricesComponent/ShippingPricesTable",["UWA/Core","UWA/Class/View","DS/UIKIT/Alert","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/MPFError/BadArgumentError","DS/MPFOfferModel/ShippingOfferModel","DS/MPFOfferModel/ShippingOfferCollection","DS/MPFServices/ObjectService","DS/MPFShippingOfferPricesComponent/ShippingPricesTableLine","i18n!DS/MPFShippingOfferPricesComponent/assets/nls/ShippingOfferPricesComponent","css!DS/MPFShippingOfferPricesComponent/MPFShippingOfferPricesComponent"],(function(e,t,i,n,s,r,o,c,a,l,h){"use strict";const f=t.extend({className:"mpf-shipping-prices-table table",tagName:"table",setup:function(e){if(a.requiredOfPrototype(e.shippingOffers,c,"options.shippingOffers must be a ShippingOfferCollection"),0===e.shippingOffers.size())throw new r("Shipping offer collection must contain at least one model!");this._parent(e),this.shippingOffers=e.shippingOffers,this.deliveryOffer=e.deliveryOffer,this.hasAutomatedPricing=!0===e.hasAutomatedPricing,this.locale=e.locale||"fr-FR",this.kgOptionButton=this._createKgOptionButton(),this.lbsOptionButton=this._createLbsOptionButton()},render:function(){let e;return this.hasAutomatedPricing?e=[this._createHeader(),this._createTable()]:(this.container.addClassName("non-automated-pricing"),e=this._createHeader()),this.container.setContent(e),this},_createKgOptionButton:function(){const e=this;return new s({value:h.get("kg"),active:!0,events:{onClick:function(){this.isActive()||(this.setActive(),this.setFocus(!1),e.lbsOptionButton.setActive(!1),e._changeWeightUnit("kg"))}}})},_createLbsOptionButton:function(){const e=this;return new s({value:h.get("lbs"),events:{onClick:function(){this.isActive()||(this.setActive(),this.setFocus(!1),e.kgOptionButton.setActive(!1),e._changeWeightUnit("lbs"))}}})},_changeWeightUnit:function(e){"kg"===e&&this.tableLines.forEach((function(e){e.updateWeightElementUnitToKG()})),"lbs"===e&&this.tableLines.forEach((function(e){e.updateWeightElementUnitToLBS()}))},_enableAreaPricing:function(e){const t=o.Fields.PRICES[e],i=this.deliveryOffer.get("deliveryOfferDesactivatedArea");i.splice(i.indexOf(t),1),this.deliveryOffer.savePromise(this.deliveryOffer.pick("deliveryOfferDesactivatedArea"),{patch:!0}).then(this._enableAreaCells.bind(this,e))},_disableAreaPricing:function(e){const t=o.Fields.PRICES[e];let i=this.deliveryOffer.get("deliveryOfferDesactivatedArea");Array.isArray(i)&&-1===i.indexOf(t)?i.push(t):i=[t],this.deliveryOffer.set("deliveryOfferDesactivatedArea",i),this.deliveryOffer.savePromise(this.deliveryOffer.pick("deliveryOfferDesactivatedArea"),{patch:!0}).then(this._disableAreaCells.bind(this,e))},_enableAreaCells:function(e){this.tableLines.forEach((function(t){t.enableElement(t.priceElements[e])}))},_disableAreaCells:function(e){this.tableLines.forEach((function(t){t.disableElement(t.priceElements[e])}))},_createTable:function(){const t=this;this.tableLines=this.shippingOffers.map((function(e,i){const n=new l({locale:this.locale,shippingOffer:e,deliveryOffer:t.deliveryOffer,rowIndex:i});return this.listenTo(n,"changeCell",this._focusNewCell.bind(this)),this.listenTo(n,"priceNotSaved",this._displayErrorAlert.bind(this)),n.render()}),this);return e.createElement("tbody",{html:this.tableLines})},_focusNewCell:function(e){e.rowIndex<this.tableLines.length&&e.rowIndex>=0&&this.tableLines[e.rowIndex].focusCell(e.columnIndex,e.direction)},_displayErrorAlert:function(e){new i({visible:!0,messages:[{className:"error",message:h.get("errorOccured")}]}).inject(this.container.getParent(),"top")},_createHeader:function(){const t=this.hasAutomatedPricing?[this._createWeightTile()]:[],i=l.ColumnOrder;for(let e=1;e<i.length;e++){const n=i[e],s=o.Fields.PRICES[n].replace("_","-");t.push(this._createTile(s,n))}return e.createElement("thead",{html:e.createElement("tr",{html:t})})},_createTile:function(t,i){const n=[this._createLabel(i)];return this.deliveryOffer&&n.push(this._createSwitchInput(i)),e.createElement("th",{class:t+" title",html:e.createElement("div",{class:"th-container",html:n})})},_createWeightTile:function(){return e.createElement("th",{class:"weight title",html:[h.get("upTo"),e.createElement("div",{html:[this.kgOptionButton,this.lbsOptionButton]})]})},_createSwitchInput:function(e){const t=this,i=o.Fields.PRICES[e];let s=this.deliveryOffer.get("deliveryOfferDesactivatedArea");s=Array.isArray(s)?s:[];const r=-1===s.indexOf(i);return new n({type:"switch",value:"",checked:r,events:{onChange:function(){this.isChecked()?t._enableAreaPricing(e):t._disableAreaPricing(e)}}})},_createLabel:function(t){return e.createElement("div",{class:"mpf-toggle-label",html:[h.get(t),this.hasAutomatedPricing?["<br>",e.createElement("span",{text:"("+this.shippingOffers.first().getCurrency()+")"})]:""]})},destroy:function(){this.shippingOffers=null,this.locale=null,this.kgOptionButton=null,this.lbsOptionButton=null,this.tableLines=null,this._parent(),this.container=null}});return f.Areas=Object.freeze(o.Areas),f})),define("DS/MPFShippingOfferPricesComponent/ShippingPricesTabsComponent",["UWA/Core","UWA/Class/View","DS/MPFOfferModel/ShippingOfferCollection","DS/MPFServices/ObjectService","DS/MPFShippingOfferPricesComponent/ShippingPricesTable","i18n!DS/MPFShippingOfferPricesComponent/assets/nls/ShippingOfferPricesComponent","css!DS/MPFShippingOfferPricesComponent/MPFShippingOfferPricesComponent"],(function(e,t,i,n,s,r){"use strict";return t.extend({className:"mpf-shipping-prices-tabs table-responsive",setup:function(e){n.requiredOfPrototype(e.standardShippingOffers,i,"options.standardShippingOffers must be a ShippingOfferCollection"),this._parent(e),this.locale=e.locale||"fr-FR",this.standardShippingOffers=e.standardShippingOffers,this.shippingMatrix=this._createShippingMatrix()},render:function(){return this.container.setContent(this.shippingMatrix.render()),this},_createShippingMatrix:function(){return new s({locale:this.locale,shippingOffers:this.standardShippingOffers,hasAutomatedPricing:!0})}})})),define("DS/MPFShippingOfferPricesComponent/ShippingPricesTableFactory",["UWA/Core","UWA/Class","UWA/Promise","DS/MPFConnector/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFShopModel/ShopFactory","DS/MPFShopModel/ShopServiceFactory","DS/MPFShippingOfferPricesComponent/ShippingPricesTable"],(function(e,t,i,n,s,r,o,c,a){"use strict";const l=t.extend();return l.fromShopId=function(t,l){const h=(l=l||{}).service||s.MAKE;let f,p,d;return n.fetchPromise({service:h}).then((function(e){const t=r.getInstance(e);return i.all([t.getFactory(r.Types.SHOP),t.getFactory(r.Types.SHOP_SERVICE),t.getFactory(r.Types.SHIPPING_OFFER)])})).then((function(e){const i=e[0].createModel(o.Types.SHOP,{id:t});return f=e[1],p=e[2],i.fetchPromise({expand:["offers"],uc2:!0})})).then((async function(e){d=f.createModel(c.Types.SHOP_SHOP_SERVICE),d.setParentResourceId(e.get("id")),d.set(e.getService(h));let t=p.createCollection(null);return t.shopServiceId=d.get("id"),t=await t.fetchPromise(),{shippingOffers:t,hasAutomatedPricing:e.hasAutomatedPricing()}})).then((function({shippingOffers:t,hasAutomatedPricing:i}={}){const n=d.get("products");let s;for(let e=0;e<n.length;e++){const t=n[e];"MP_DeliveryService"===t.type&&"Shipping"===t.deliveryServiceName&&(s=p.createModel(t.offers[0],{parentResourceId:d.get("id")}))}return l=e.extend({shippingOffers:t,deliveryOffer:s,hasAutomatedPricing:i},l),new a(l)}))},l}));