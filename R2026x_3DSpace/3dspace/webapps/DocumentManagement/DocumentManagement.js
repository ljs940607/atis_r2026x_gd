define("DS/DocumentManagement/DocumentFoundationAjax",["UWA/Core","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","i18n!DS/DocumentManagement/assets/nls/DocumentManagementNLS"],(function(e,t,n,a){"use strict";var i=["nameNotUnique"],r={widgetization:"ENOVIA_Application_Widget",getParams:function(){var e="";if(this.tenant&&this.tenant.length>0&&(e+="&tenant="+this.tenant),this.rows&&this.rows.length>0&&(e+="&e6w-objLimit="+this.rows),this.language&&this.language.length>0){var t=this.language;e+="&e6w-lang="+(t="zh"===t?"zh_CN":t)}this.timezone&&(e+="&e6w-timezone="+this.timezone);var n=Object.prototype.hasOwnProperty,a=this.preferences;for(var i in a)n.call(a,i)&&(e+="&"+i+"="+a[i]);return this.params&&""!==this.params&&(e+="&"+this.params),""!==e&&(e=e.substring(1)),e},getParamsAsJSON:function(){var e={};this.tenant&&this.tenant.length>0&&(e.tenant=this.tenant),this.space&&this.space.length>0&&(e.SecurityContext=this.space),this.rows&&this.rows.length>0&&(e["e6w-objLimit"]=this.rows),this.language&&this.language.length>0&&(e["e6w-lang"]=this.language),this.timezone&&(e["e6w-timezone"]=this.timezone);var t=Object.prototype.hasOwnProperty,n=this.preferences;for(var a in n)t.call(n,a)&&(e[a]=n[a]);return e},setupEnoviaServer:function(){var e,t,a,i,o;window.widget?(e=window.widget.getUrl(),t=window.widget.getUrl().match(/[?&]runYourApp=([^&]*)?/),a=n.getApplicationConfiguration("app.urls.myapps"),e=e.substring(0,e.indexOf("/webapps")),i=window.widget.lang,o=window.widget.getValue("showSpace")||window.widget.getValue("widgetName")===r.widgetization||"false",window.widget.setValue("showSpace",o)):(e=window.location.origin,o=""),a&&!t||(a=e),window.WidgetConstants={str:{}};var s=(new Date).getTimezoneOffset(),l=n.getUser();l&&l.login&&(l=l.login),window.enoviaServer={params:"",sRealURL:e,showSpace:o,objectId:"",widgetId:"",widgetName:"",taggerContextId:"auto",appName:"",tenant:"",space:null,rows:null,preferences:{},storageUrl:a,language:i,timezone:s,_getUrl:function(){return this.storageUrl||this.sRealURL},getParams:r.getParams,getParamsAsJSON:r.getParamsAsJSON,computeUrl:function(e){return this._getUrl()+e},user:l},window.enoviaServer.storageUrl=window.enoviaServer.storageUrl.replace(":443","")},calculateFinalUrl:function(t,n){var a=t;if(e.Utils.parseUrl(t).protocol)return a;a=window.enoviaServer.computeUrl(a),a+=-1===a.indexOf("?")?"?":"&";var i=window.enoviaServer.getParams();return i&&i.length>0&&!n?a+=i:a+="tenant="+window.enoviaServer.tenant,a},ajaxRequest:function(n,o){var s=r.calculateFinalUrl(n.url,o),l=e.clone(n.headers||{},!1);!l["Accept-Language"]&&window.widget&&window.widget.lang&&(l["Accept-Language"]=window.widget.lang);var c=window.enoviaServer.space;!n.noSecurityContext&&!l.SecurityContext&&c&&c.length>0&&(l.SecurityContext=encodeURIComponent(c));var d=n.onFailure||function(e,t){var r,o=t||{};if(!1!==o.success||!o.error){var s=o&&o.error&&o.error.errorCode;i.includes(s)?o.error=(r="FileManagement.UploadFail."+s,a.get(r)):o={error:"Network Error: Unable to load widget due to network or authentication error.",errorMsg:e&&e.message}}n.callback.call(this,o)},u=n.onTimeout||function(){n.callback.call(this,{error:"Network Error: Unable to load widget due to timeout error."})},f=n.onCancel||function(){n.callback.call(this,{error:"Application Error: Request canceled."})},p=t.authenticatedRequest(s,{method:n.type,type:n.dataType,proxy:"passport",timeout:5e5,cache:3600,data:n.data,onComplete:n.callback,onFailure:d,onCancel:f,onTimeout:u,headers:l});return p=p||{cancel:Function.prototype}},_newTempId:function(){return"temp_"+(new Date).getTime()+Math.floor(1e4*Math.random())}};return r})),define("DS/DocumentManagement/IndependentServiceBase",["UWA/Core","UWA/Class","UWA/Utils","DS/WAFData/WAFData","DS/DocumentManagement/DocumentFoundationAjax"],(function(e,t,n,a,i){"use strict";var r,o=t.extend({_deleteObject:function(t,n){var a=this,r=e.clone(n||{},!1),o=e.clone(r.additionalHeaders||{},!1);o["content-type"]="application/json",r.requestType="delete";var s=this._prepareService(this._deleteObject.bind(this,t,n),r);return s||i.ajaxRequest({url:t,type:"delete",dataType:"json",data:JSON.stringify({csrf:this.getCsrf(r.tenantUrl)}),callback:function(t){t&&t.csrf&&a.setCsrf(t.csrf,r.tenantUrl),t&&t.success&&e.is(n.onComplete,"function")?n.onComplete(t,n):e.is(n.onFailure,"function")&&n.onFailure(t)},headers:o})},_deleteRootObject:function(e,t){return this._deleteObject(this.SERVICE_ROOT_URL+e,t)},_getObjects:function(t,n){var a=this,r=e.clone(n||{},!1),o=e.clone(r.additionalHeaders||{},!1);o["Content-Type"]="application/x-www-form-urlencoded",r.requestType="get",r.csrf=r.csrf||"notNeeded",this._prepareService(this._getObjects.bind(this,t,n),r),i.ajaxRequest({url:(r.tenantUrl||"")+(this.SERVICE_ROOT_URL||"")+(r.additionalURLParams?"?"+r.additionalURLParams:""),type:"post",dataType:"json",data:"$ids="+t.join(),noSecurityContext:r.noSecurityContext,callback:function(t){t&&t.csrf&&a.setCsrf(t.csrf,r.tenantUrl),t&&t.success&&e.is(n.onComplete,"function")?n.onComplete(t,n):e.is(n.onFailure,"function")&&n.onFailure(t)},headers:o})},_prepareService:function(e,t){var n;window.isIFWE=!0;var a=t||{};if(window.enoviaServer||i.setupEnoviaServer(),a.tenant&&(enoviaServer.tenant=a.tenant),a.securityContext){var r=a.securityContext;0!==r.indexOf("ctx::")&&(r="ctx::"+r),enoviaServer.space=r}return a.tenantUrl&&!a.readOnlyStorageURl&&(enoviaServer.storageUrl=a.tenantUrl),this.getCsrf(a.tenantUrl)&&!a.csrf||(a.csrf?"notNeeded"!==a.csrf&&this.setCsrf(a.csrf,a.tenantUrl):n=this._getCsrf(e,t)),n},_handleTicket:function(t,n){var a=this;if(t&&t.success){var i=t.data[0].dataelements;this.setCsrf(t.csrf,n&&n.tenantUrl);var r=e.clone(n||{},!1),o=r.onComplete;r.onComplete=function(t,n){var i=e.clone(n||{},!1);i.onComplete=o,a._handleFCSReceipt(t,i)},r=e.extend(r,i),a._checkinToFCS(r)}else e.is(n&&n.onFailure,"function")&&n.onFailure(t)},_getCsrf:function(e,t){var n=this,a={url:"/resources/v1/application/E6WFoundation/CSRF",type:"get",dataType:"json",callback:function(a){a&&a.csrf&&(n.setCsrf(a.csrf,t&&t.tenantUrl),e())},headers:{"content-type":"application/json"}};return i.ajaxRequest(a)},getCsrf:function(e){var t=e||enoviaServer.storageUrl;return this.csrf&&this.csrf[t]},setCsrf:function(e,t){var n=t||enoviaServer.storageUrl;return this.csrf=this.csrf||{},this.csrf[n]=e},_checkinToFCS:function(t){var n=t||{},i=n.ticketURL,r=this._getFCSFormData(n),o=function(){e.is(n.onFailure,"function")&&n.onFailure.apply(this,arguments)},s=a.authenticatedRequest(i,{method:"POST",data:r,timeout:0,onComplete:function(t){e.is(n.onComplete,"function")&&n.onComplete(t,n)},onFailure:function(){o.apply(this,arguments)},onTimeout:function(){o.apply(this,arguments)},onUploadProgress:function(){e.is(n.onProgress,"function")&&n.onProgress.apply(this,arguments)}});return s},_getFCSFormData:function(e){var t=(e=e||{}).fileInfo||e.documentInfo&&e.documentInfo.fileInfo,n=t&&t.file,a=t&&t.fileName,i=new FormData;return i.append(e.ticketparamname,e.ticket),i.append("file_0",n,a),i},downloadWithPost:function(t,a){var i=document;if(n.Client.Platform.ios&&(void 0!==r&&r.isInjected()||((r=e.createElement("iframe")).style.width=0,r.style.height=0,r.style.display="none",r.inject(widget.body)),r.src=require.toUrl("DS/DocumentManagement/assets/blankForm.html"),i=r.contentDocument),e.is(t,"string")){var o=n.parseUrl(t),s=o.query.length?n.parseQuery(o.query):{};a&&a.notAsAttachment||(s.__fcs__attachment=!0),delete o.query;var l=n.composeUrl(o),c=i.createElement("form");c.style.display="none",c.method="POST",c.action=l,Object.keys(s).forEach((function(e){var t=i.createElement("input");t.setAttribute("name",e),t.setAttribute("value",s[e]),c.appendChild(t)})),i.body.appendChild(c),this.submitForm(c),i.body.removeChild(c)}a.onComplete&&a.onComplete(t,a)},submitForm:function(e){return e.submit()},_handleFCSReceipt:function(){}});return o})),define("DS/DocumentManagement/DriveDocumentManagement",["UWA/Core","DS/DocumentManagement/DocumentFoundationAjax","DS/DocumentManagement/IndependentServiceBase"],(function(e,t,n){"use strict";var a="/resources/3ddrive/v1/bos/",i=a+"ticket",r="?tenant=",o=n.extend({_prepareService:function(t,n){var a=e.clone(n||{},!1);a.readOnlyStorageURl=!0,this._parent(t,a)},createDocument:function(t,n){var a=e.clone(n||{},!1);a.create=!0,a.driveFolderId=t.driveFolderId,this.modifyDocument(t,a)},getDocuments:function(n,i){var o,s=e.clone(i||{},!1);if(n){var l=e.clone(s.additionalHeaders||{},!1);l["content-type"]="application/json";var c={url:s.tenantUrl+a+n+r+s.tenant,type:"get",dataType:"json",noSecurityContext:!0,callback:function(t){t&&t.id?e.is(s.onComplete,"function")&&s.onComplete(t):e.is(s&&s.onFailure,"function")&&s.onFailure()},headers:l};o=t.ajaxRequest(c)}return o},getFileUrl:function(n,i){var o=e.clone(i||{},!1);if(n){var s=e.clone(o.additionalHeaders||{},!1);return s["content-type"]="application/json",new Promise((function(e,i){t.ajaxRequest({url:o.tenantUrl+a+n+"/fileurl"+r+o.tenant,type:"get",dataType:"json",noSecurityContext:!0,callback:function(t){t&&t.url?e(t.url):i(t)},headers:s})}))}},downloadDocument:function(n,i){var o,s=this,l=e.clone(i||{},!1);if(n){var c=e.clone(l.additionalHeaders||{},!1);c["content-type"]="application/json";var d={url:l.tenantUrl+a+n+"/download"+r+i.tenant,type:"get",dataType:"json",noSecurityContext:!0,callback:function(t){t&&t.url?l.autoDownload?s.downloadWithPost(t.url,l):e.is(l.onComplete,"function")&&l.onComplete(t.url,l):e.is(l&&l.onFailure,"function")&&l.onFailure(t)},headers:c};o=t.ajaxRequest(d)}return o},modifyDocument:function(n,a){var o,s=e.clone(a||{},!1),l=this;if(n&&n.fileInfo&&n.fileInfo.file){var c=e.clone(s.additionalHeaders||{},!1);c["content-type"]="application/json";var d={url:s.tenantUrl+i+r+a.tenant,type:"get",dataType:"json",noSecurityContext:!0,callback:function(t,a){if(t.ticket){var i=a["x-ds-csrftoken"],r=e.clone(n.fileInfo||{},!1);r.fileName=n.fileInfo.file.name;var o={csrf:i,fileInfo:r,docId:n.id,ticket:t.ticket,ticketparamname:t.jobticket,ticketURL:t.actionurl};l._handleTicket(o,s)}else e.is(s&&s.onFailure,"function")&&s.onFailure(t)},headers:c};o=t.ajaxRequest(d)}return o},_handleTicket:function(t,n){var a=this,i=e.clone(n||{},!1),r=i.onComplete;i.onComplete=function(n,i){var o=e.clone(i||{},!1);o.onComplete=r,t.fcsReceipt=n.trim(),a._handleFCSReceipt(t,o)},a._checkinToFCS(e.merge(i,t))},_getFCSFormData:function(){var e=this._parent.apply(this,arguments);return e.append("__fcs__nohtml",!0),e},_handleFCSReceipt:function(n,i){var o,s,l=e.clone(i||{},!1),c={title:n.fileInfo.file.name,receipt:n.fcsReceipt};l.create?(s=l.driveFolderId+"/contents",c.type="DriveFile",o="post"):(s=n.docId,o="put");var d=l.tenantUrl+a+s+r+i.tenant,u=e.clone(l.additionalHeaders||{},!1);return u["Content-Type"]="application/json",u["X-DS-CSRFTOKEN"]=n.csrf,t.ajaxRequest({url:d,type:o,dataType:"json",data:JSON.stringify(c),noSecurityContext:!0,callback:function(t){t&&t.id&&e.is(l.onComplete,"function")?l.onComplete(t):e.is(l.onFailure,"function")&&l.onFailure(t)},headers:u})},getNewBlobFileWithOldName:function(e,t){var n=t.get("title");return(e=new Blob([e],{type:e.type})).name=n,e},getFolders:function(n){var a=e.clone(n||{},!1),o=this,s=e.clone(a.additionalHeaders||{},!1);s["content-type"]="application/json";var l={url:a.tenantUrl+i+r+a.tenant,type:"get",dataType:"json",noSecurityContext:!0,callback:function(t,n){if(t){var i={csrf:n["x-ds-csrftoken"],ticket:t.ticket,ticketparamname:t.jobticket,ticketURL:t.actionurl};o._handleTicketAndGetFoldersList(i,a)}else e.is(a&&a.onFailure,"function")&&a.onFailure(t)},headers:s};return t.ajaxRequest(l)},_handleTicketAndGetFoldersList:function(n,i){var o=e.clone(i||{},!1),s=e.clone(o.additionalHeaders||{},!1);s["content-type"]="application/json",s["X-DS-CSRFTOKEN"]=n.csrf;var l={url:o.tenantUrl+a+"DSROOT/contents"+r+o.tenant,type:"get",dataType:"json",callback:function(t){t?o.callback(t):e.is(o&&o.onFailure,"function")&&o.onFailure(t)},headers:s};return t.ajaxRequest(l)}}),s=new o;return s.getObjects=s.getDocuments,s.TICKET_URL=i,s.URL=a,s.TENANT_SUFFIX=r,s})),define("DS/DocumentManagement/ObjectInfoService",["UWA/Core","DS/DocumentManagement/IndependentServiceBase"],(function(e,t){"use strict";return new(t.extend({SERVICE_ROOT_URL:"/resources/v3/e6w/service/ObjectInfo/",getObjects:function(t,n){var a=e.clone(n||{},!1),i=a.additionalURLParams&&a.additionalURLParams.split("&")||[];n.getVersions&&i.push("$include=versions");var r=a.relInfo;return r&&r.parentRelName&&(i.push("parentRelName="+r.parentRelName),i.push("parentDirection="+(r.parentDirection||"from"))),a.additionalURLParams=i.join("&"),this._getObjects(t,a)}}))})),define("DS/DocumentManagement/DocumentManagement",["UWA/Core","UWA/Class/Events","DS/DocumentManagement/DocumentFoundationAjax","DS/DocumentManagement/DriveDocumentManagement","DS/DocumentManagement/IndependentServiceBase","DS/DocumentManagement/ObjectInfoService"],(function(e,t,n,a,i,r){"use strict";var o,s=function(t,n){var a=e.clone(n||{},!1);return a.onProgress=function(e){n&&n.onProgress&&n.onProgress(e),function(e,t){var n={activity:e,loaded:t.loaded,total:t.total};o.events.dispatchEvent("onActivityProgress",n)}(t,e)},a.onFailure=function(){n&&n.onFailure.apply(this,arguments),o.events.dispatchEvent("onActivityFailure",t)},a.onComplete=function(e){n&&n.onComplete(e,n),o.events.dispatchEvent("onActivityComplete",t)},a},l=i.extend({MSFDocumentClient:null,SERVICE_ROOT_URL:"/resources/v1/modeler/documents/",deleteVersion:function(e,t,n,a){return this._deleteObject(this.SERVICE_ROOT_URL+e+"/files/"+t+"/versions/"+n,a)},deleteFile:function(e,t,n){return this._deleteObject(this.SERVICE_ROOT_URL+e+"/files/"+t,n)},deleteDocument:function(){return this._deleteRootObject.apply(this,arguments)},getDocuments:function(t,n){var a=e.clone(n||{},!1),i=a.additionalURLParams&&a.additionalURLParams.split("&")||[];n.getVersions&&i.push("$include=versions");var r=a.relInfo;return r&&r.parentRelName&&(i.push("parentRelName="+r.parentRelName),i.push("parentDirection="+(r.parentDirection||"from"))),a.additionalURLParams=i.join("&"),this._getObjects(t,a)},connectDocumentToParent:function(e,t){var n=t||{},a=n.relInfo;return a&&(a.updateAction="CONNECT"),this._handleDocumentParentConnection(e,n)},disconnectDocumentFromParent:function(e,t){var n=t||{},a=n.relInfo;return a&&(a.updateAction="DISCONNECT"),this._handleDocumentParentConnection(e,n)},_handleDocumentParentConnection:function(t,a){var i=a||{};i.urlParams="";var r=a.relInfo;if(r&&r.parentId&&r.parentRelName&&t){var o=this,s=this._prepareService(this._handleDocumentParentConnection.bind(this,t,a),i);if(s)return s;var l={csrf:this.getCsrf(i.tenantUrl),data:[{id:t,updateAction:"NONE",relateddata:{parents:[{id:r.parentId,updateAction:r.updateAction}]}}]};let u=[];a.additionalURLParams&&u.push(...a.additionalURLParams.split("&")),u.push("parentRelName="+r.parentRelName),u.push("parentDirection="+(r.parentDirection||"from")),i.urlParams="?"+u.join("&");var c=e.clone(i.additionalHeaders||{},!1);c["content-type"]="application/json";var d={url:this.SERVICE_ROOT_URL+i.urlParams,type:"post",dataType:"json",data:JSON.stringify(l),callback:function(t){t&&t.csrf&&o.setCsrf(t.csrf,i.tenantUrl),t&&t.success&&e.is(a.onComplete,"function")?a.onComplete(t,a):e.is(a.onFailure,"function")&&a.onFailure(t)},headers:c};return n.ajaxRequest(d)}throw new Error("Invalid input")},getDocumentsFromParent:function(t){var a=t;t.getVersions&&((a=e.clone(t||{},!1)).additionalURLParams?a.additionalURLParams=a.additionalURLParams+"&$include=versions":a.additionalURLParams="$include=versions");var i=t.relInfo;if(i&&i.parentId&&i.parentRelName){var r=this;a.requestType="get",a.csrf=a.csrf||"notNeeded",this._prepareService(this.getDocumentsFromParent.bind(this,t),a),n.ajaxRequest({url:this.SERVICE_ROOT_URL+"parentId/"+i.parentId+"?parentRelName="+i.parentRelName+"&parentDirection="+(i.parentDirection||"from")+(a.additionalURLParams?"&"+a.additionalURLParams:""),type:"get",dataType:"json",callback:function(n){n&&n.csrf&&r.setCsrf(n.csrf,a.tenantUrl),n&&n.success&&e.is(t.onComplete,"function")?t.onComplete(n,t):e.is(t.onFailure,"function")&&t.onFailure(n)}})}},downloadDocument:function(t,i,r,o){var s=o||{};if("3DDrive"===s.serviceId)return a.downloadDocument(t,s);if(this.MSFDocumentClient&&this.MSFDocumentClient.IsConnectedToMSFClient()&&!0===o.autoDownload)return this.MSFDocumentClient.DownloadViaMSF([{id:t,fileid:i,checkout:r}],o);var l,c=s.onComplete,d=this,u="";s.tenantUrl&&(u=s.tenantUrl),u+=this.SERVICE_ROOT_URL+t+"/files/"+(r?"CheckoutTicket":"DownloadTicket"),l=s.additionalURLParams?new URLSearchParams(s.additionalURLParams):new URLSearchParams;var f=s.useObjectNameForZip;void 0===s.useObjectNameForZip&&(f=!0),l.append("useObjectNameForZip",f);var p=s.lightweight;void 0===s.lightweight&&(p=!1),l.append("lightweight",p);var m=this._prepareService(this.downloadDocument.bind(this,t,i,r,o),s);if(m)return m;var h={csrf:this.getCsrf(s.tenantUrl)};i&&(e.is(i,"string")?h.data=[{id:i}]:h.data=[{dataelements:i}]);var v=e.clone(s.additionalHeaders||{},!1);v["content-type"]="application/json";var g={url:u+"?"+l.toString(),type:"put",dataType:"json",data:JSON.stringify(h),callback:function(t){if(t&&t.csrf&&d.setCsrf(t.csrf,s.tenantUrl),t&&t.data&&t.data.length&&t.data[0].dataelements&&t.data[0].dataelements.ticketURL){var n=t.data[0].dataelements.ticketURL;s.autoDownload?d.downloadWithPost(n,s):e.is(c,"function")&&c(n,s)}else e.is(s.onFailure,"function")&&s.onFailure(t,s)},headers:v};return n.ajaxRequest(g)},downloadDocuments:function(t,a){if(this.MSFDocumentClient&&this.MSFDocumentClient.IsConnectedToMSFClient())return null!=a.documentIdForMSF?this.MSFDocumentClient.DownloadViaMSF(t.map((function(e){return{id:a.documentIdForMSF,fileid:e}})),a):this.MSFDocumentClient.DownloadViaMSF(t.map((function(e){return{id:e,fileid:void 0}})),a);var i=a||{},r=i.onComplete,o=this,s=this.SERVICE_ROOT_URL+"DownloadTicket",l=t.length;if(!l)throw new Error("no document to download");for(var c=[],d=0;d<l;d++)c.push({id:t[d]});var u=this._prepareService(this.downloadDocuments.bind(this,t,a),i);if(u)return u;var f,p={csrf:this.getCsrf(i.tenantUrl),data:c};f=i.additionalURLParams?new URLSearchParams(i.additionalURLParams):new URLSearchParams,i.asZip&&f.append("zipFiles",!0),i.lightweight&&f.append("lightweight",!0);var m=e.clone(i.additionalHeaders||{},!1);m["content-type"]="application/json";var h={url:s+"?"+f.toString(),type:"put",dataType:"json",data:JSON.stringify(p),callback:function(t){t&&t.csrf&&o.setCsrf(t.csrf,i.tenantUrl);var n=!1,a=!1,s=[];if(t&&t.success){if(t&&t.data&&t.data.length)for(var l=t.data.length,c=0;c<l;c++){var d=t.data[c],u={id:d.id,errorMessage:d.updateMessage};d.dataelements&&d.dataelements.ticketURL?(u.downloadUrl=d.dataelements.ticketURL,d.dataelements.fileName&&(u.fileName=d.dataelements.fileName),d.dataelements.fileNames&&(u.fileNames=d.dataelements.fileNames),d.dataelements.fileId&&(u.fileId=d.dataelements.fileId),n=!0):a=!0,d.updateMessage&&(a=!0),s.push(u)}}else a=!0;n&&e.is(r,"function")&&r(s),a&&e.is(i.onFailure,"function")&&i.onFailure(s,t,i)},headers:m};return n.ajaxRequest(h)},createDocument:function(e,t){if(e&&e.fileInfo&&e.fileInfo.file&&this.events.dispatchEvent("onActivityStart",e.fileInfo.file),e.driveFolderId){var n=s(e.fileInfo.file,t);return a.createDocument(e,n)}return this._handleDocument(e,t)},addFileToDocument:function(e,t){return e.fileInfo.newFile=!0,this._handleDocument(e,t)},modifyDocument:function(e,t){if(e&&e.fileInfo&&e.fileInfo.file&&this.events.dispatchEvent("onActivityStart",[e.fileInfo.file,{update:!0}]),t&&"3DDrive"===t.serviceId){var n=s(e.fileInfo.file,t);return a.modifyDocument(e,n)}return this._handleDocument(e,t)},_handleDocument:function(t,a){var i=e.clone(a||{},!1),r=e.clone(t,!1);if(r.fileInfo&&r.fileInfo.title&&(r.fileInfo=e.clone(r.fileInfo,!1),delete r.fileInfo.title),e.is(r,"array")){for(var o=r.length,l=[],c=0;c<o;c++){var d=r[c];l.push(this._handleDocument(d,a))}return l}var u=this;r&&r.fileInfo&&r.fileInfo.file&&(i=s(t.fileInfo.file,a)),!i.csrf&&r.fileInfo&&(i.csrf="notNeeded");var f=this.SERVICE_ROOT_URL+"files/CheckinTicket",p=this._prepareService(this._handleDocument.bind(this,r,a),i);if(p)return p;var m={csrf:this.getCsrf(i.tenantUrl)};if(i.documentInfo=r,r&&r.fileInfo&&r.fileInfo.file){var h=e.clone(i.additionalHeaders||{},!1);h["content-type"]="application/json";var v={url:f,type:"put",dataType:"json",data:JSON.stringify(m),callback:function(e){u._handleTicket(e,i)},headers:h};return n.ajaxRequest(v)}return this._handleFCSReceipt(void 0,i)},_buildDocumentDataElements:function(e,t){var n=t&&t.documentInfo||Object.create(null),a=n.description,i=n.title,r=n.collabspace,o=t.deriveCollabspace?"true":t.deriveCollabspace,s=n.id,l=n.policy,c=n.fileInfo&&n.fileInfo.file,d=c&&c.name,u=n.relInfo;if(e.dataelements=Object.create(null),!i&&!s&&d){var f=d.lastIndexOf("."),p=d;-1!==f&&(p=p.substring(0,f)),i=p}i&&(e.dataelements.title=i),r&&(e.dataelements.collabspace=r),o&&(e.dataelements.deriveCollabspace=o),a&&(e.dataelements.description=a),l&&(e.dataelements.policy=l),!s&&u&&(e.dataelements.parentId=u.parentId,e.dataelements.parentRelName=u.parentRelName,u.parentDirection&&(e.dataelements.parentDirection=u.parentDirection)),Object.keys(e.dataelements).length||delete e.dataelements},_buildFilesRelatedData:function(e,t){var n=t.documentInfo||Object.create(null),a=n.fileInfo||Object.create(null),i=a.file,r=a.id,o=i&&i.name,s=a.comments,l=a.format,c=t.fcsReceipt,d=n.id;n.fileInfo&&(e.relateddata={files:[{dataelements:{}}]},r&&(e.relateddata.files[0].id=r),o&&(e.relateddata.files[0].dataelements.title=o),s&&(e.relateddata.files[0].dataelements.comments=s),l&&(e.relateddata.files[0].dataelements.format=l),s&&(e.relateddata.files[0].dataelements.comments=s),c&&(e.relateddata.files[0].dataelements.receipt=c),i&&d&&(r||!a.newFile?(e.relateddata.files[0].updateAction="REVISE",t.urlParams="?$include=versions"):e.relateddata.files[0].updateAction="CREATE"))},_handleFCSReceipt:function(t,a){var i=this,r=e.clone(a||{},!1);r.urlParams="";var o=r.documentInfo||Object.create(null),s=o.type,l=o.id,c=o.tempId,d=Object.create(null);this._buildDocumentDataElements(d,r),r.fcsReceipt=t,this._buildFilesRelatedData(d,r),s&&(d.type=s),l?d.id=l:d.tempId=c||n._newTempId(),r.customDocumentObject&&r.customDocumentObject.dataelements&&e.merge(d.dataelements,r.customDocumentObject.dataelements);var u={csrf:i.getCsrf(a&&a.tenantUrl),data:[d]};d.dataelements||d.tempId||(d.updateAction="NONE");let f=[];a.isImage&&(r.urlParams+=r.urlParams.length?"&":"?",f.push("$fields=!image")),a.additionalURLParams&&f.push(...a.additionalURLParams.split("&")),f.length>0&&(r.urlParams="?"+f.join("&"));var p=e.clone(a.additionalHeaders||{},!1);return p["content-type"]="application/json",n.ajaxRequest({url:this.SERVICE_ROOT_URL+r.urlParams,type:l?"put":"post",dataType:"json",data:JSON.stringify(u),callback:function(t){t&&t.csrf&&i.setCsrf(t.csrf,a&&a.tenantUrl),t&&t.success&&e.is(a.onComplete,"function")?a.onComplete(t,a):e.is(a.onFailure,"function")&&a.onFailure(t)},headers:p})}});return(o=new l).events=new t,o.getObjects=o.getDocuments,o}));