/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXSlideShow/CATWebUXSlideShowController",["UWA/Core","UWA/Class","DS/CATWebUXComponents/CATWebUXNotification","DS/WebappsUtils/WebappsUtils","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Utilities/TouchUtils","DS/CATWebUXComponents/DMUCommandsManager","i18n!DS/CATWebUXSlideShow/assets/nls/CATWebUXSlideShow","css!DS/CATWebUXSlideShow/CATWebUXSlideShow.css"],(function(e,t,i,n,o,r,l,d,a,s,c,S){"use strict";var u=t.extend({init:function(t){this._parent(t);var u,h,C,m,f=t||{},v=!1,g=this,w=new l,A=f.context,b=A.getViewer(),x={},p={},y={},W={},U={},T="windowed",E=A.getUIFrame(),D=[],X=f.params&&f.params.activateRotation;let k=null,I=!1;function P(e,t){w.publish({event:e,data:t,context:g})}function H(e){e.ctrlKey||"ArrowLeft"!==e.key&&37!==e.keyCode&&"ArrowUp"!==e.key&&38!==e.keyCode&&"PageUp"!==e.key&&33!==e.keyCode?e.ctrlKey||"ArrowRight"!==e.key&&39!==e.keyCode&&"ArrowDown"!==e.key&&40!==e.keyCode&&"PageDown"!==e.key&&34!==e.keyCode?"Escape"===e.key||27===e.keyCode?g.setActiveState(!1):"Home"===e.key||36===e.keyCode?P("onFirstSlideCB"):"End"!==e.key&&35!==e.keyCode||P("onLastSlideCB"):P("onNextSlideCB"):P("onPreviousSlideCB")}function M(){h&&(clearTimeout(h),h=0),p.left?.setStyles({opacity:null}),p.right?.setStyles({opacity:null}),p.exitSlideShow.setStyles({opacity:null}),s.getTouchMode()||(h=setTimeout((function(){p.left?.setStyles({opacity:0}),p.right?.setStyles({opacity:0}),p.exitSlideShow.setStyles({opacity:0})}),2e3))}function N(e){if(e&&e.getId){var t=e.getId();if(-1!==D.indexOf(t))return;"CATWebUXSlideShowPreviousHdr"!==t&&"CATWebUXSlideShowNextHdr"!==t&&"CATWebUXSlideShowExitHdr"!==t?g.setActiveState(!1):e.ControllerID=f.id}}this.getID=function(){return f.id},this.setListOfCommandsAllowed=function(e){e&&e.length&&(D=e)};this.setActiveState=function(t){var i=0;if(v!==t)if(v=t)P("onActiveStateModified",{state:v,onBeginSlideShow:function(t,i=!0){if(t){let t;if(A.getExecutionContext||(t=A.getActionBar(),m=t.options.context),d.empty(),a.empty(),i&&(y.left=function(){P("onPreviousSlideCB"),M()},p.left=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowLeftArrowMainDiv"}).inject(E),o.addEvent(p.left,"onPrimaryPointerClick",y.left),x.left=e.createElement("div",{class:"CATWebUXSlideShowMainDiv"}).inject(p.left),x.left.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_PreviousSlideText.png")',backgroundSize:"contain",left:"30px"}),x.left.title=S.previousSlide,y.right=function(){P("onNextSlideCB"),M()},p.right=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowRightArrowMainDiv"}).inject(E),o.addEvent(p.right,"onPrimaryPointerClick",y.right),x.right=e.createElement("div",{class:"CATWebUXSlideShowMainDiv"}).inject(p.right),x.right.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_NextSlideText.png")',backgroundSize:"contain",right:"30px"}),x.right.title=S.nextSlide),p.exitSlideShow=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowExitDiv"}).inject(E),p.exitSlideShow.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_ExitSlideShowText.png")',backgroundSize:"contain"}),y.cross=function(){g.setActiveState(!1)},o.addEvent(p.exitSlideShow,"onPrimaryPointerClick",y.cross),p.exitSlideShow.title=S.exitSlideShow,document.addEventListener("keyup",H),o.addEvent(b.canvas,"onPrimaryPointerMoveUnique",M),o.addEvent(b.canvas,"onMouseMove",M),o.addEvent(b.canvas,"onPrimaryPointerClick",M),o.addEvent(b.divCssElement,"onPrimaryPointerMoveUnique",M),o.addEvent(b.divCssElement,"onMouseMove",M),o.addEvent(b.divCssElement,"onPrimaryPointerClick",M),M(),A.getExecutionContext)A.getImmersiveFrame().getDockingElement(WUXDockAreaEnum.BottomDockArea).setProperties({collapseDockingZoneFlag:!0});else"displayed"===localStorage.getItem("CATWebUXSlideShowABPreferences")?t.open():t.close();A.getContextualUIManager().register({subscriberId:"CATWebUXSlideShow",workbenchName:"CATWebUXSlideShowWkb",module:"CATWebUXSlideShow",context:m,cmdPrefix:"",fileName:"CATWebUXSlideShowWkb.xml",merge:!0,onContextualMenuReady:function(){return A.getExecutionContext?function(e){if(e)return e.includes("A3")?[{type:"WAfrDefaultHandlerItem",handlerId:"AnnotSlideShowPreviousHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"AnnotSlideShowNextHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"AnnotSlideShowExitHdr"}]:e.includes("I3")?[{type:"WAfrDefaultHandlerItem",handlerId:"PIMSlideShowPreviousHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"PIMSlideShowNextHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"PIMSlideShowExitHdr"}]:e.includes("CATWebUX")?[{type:"WAfrDefaultHandlerItem",handlerId:"CATWebUXSlideShowPreviousHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"CATWebUXSlideShowNextHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"CATWebUXSlideShowExitHdr"}]:[{type:"WAfrDefaultHandlerItem",handlerId:"SlideShowPreviousHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"SlideShowNextHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"SlideShowExitHdr"}]}(A.getExecutionContext().getSourceApp().options.id):{cmdList:[{name:"CATWebUXSlideShowPreviousStr",line:1,hdr_list:["CATWebUXSlideShowPreviousHdr"]},{name:"CATWebUXSlideShowNextStr",line:1,hdr_list:["CATWebUXSlideShowNextHdr"]},{name:"CATWebUXSlideShowExitStr",line:1,hdr_list:["CATWebUXSlideShowExitHdr"]}]}}}),A.getExecutionContext||(W.onActionBarOpen=t.onActionBarOpen((function(){localStorage.setItem("CATWebUXSlideShowABPreferences","displayed")})),W.onActionBarClose=t.onActionBarClose((function(){localStorage.setItem("CATWebUXSlideShowABPreferences","closed")}))),U.cmds=c.onCommandStart(N,m),(T=window&&window.widget?window.widget.getView().type:null)&&"fullscreen"!==T&&window.widget.requestView({type:"fullscreen"}),X||b.get2DMode()||(b.currentViewpoint.control.setMouseRotationActive(!v),b.currentViewpoint.control.setTouchRotationActive(!v)),C={activated:b.picking.activated,trapSelection:b.picking.trapSelection},b.setPicking({activated:!1,trapSelection:!1});let r=c.getCommandCheckHeader("FlyWalkCmd",m);r&&(r.getState()&&(I=!0,r.setState(!1)),k=r.onStateChange((function(){I=!1,g.setActiveState(!1)})));let l=c.getCommand("VisuRotateViewCmd",m);l&&l.disable()}else v=!1,g.displaySlideInformation({type:"error",message:S.slideShowCannotBeLaunched,notificationType:"BasicNotification"}),P("onSlideShowAborted"),P("onActiveStateModified",{state:v})}});else{if(k){let e=c.getCommandCheckHeader("FlyWalkCmd",m);e&&(A.getExecutionContext||e._modelEvents.unsubscribe(k),I&&e.setState(!0))}let e=c.getCommand("VisuRotateViewCmd",m);e&&e.enable(),I=!1,k=null,h&&(clearTimeout(h),h=0),p.left&&(o.removeEvent(p.left,"onPrimaryPointerClick",y.left),E.removeChild(p.left),p.left.destroy(),p.left=null),p.right&&(o.removeEvent(p.right,"onPrimaryPointerClick",y.right),E.removeChild(p.right),p.right.destroy(),p.right=null),p.exitSlideShow&&(o.removeEvent(p.exitSlideShow,"onPrimaryPointerClick",y.cross),E.removeChild(p.exitSlideShow),p.exitSlideShow.destroy(),p.exitSlideShow=null),document.removeEventListener("keyup",H),o.removeEvent(b.canvas,"onPrimaryPointerMoveUnique",M),o.removeEvent(b.canvas,"onMouseMove",M),o.removeEvent(b.canvas,"onPrimaryPointerClick",M),o.removeEvent(b.divCssElement,"onPrimaryPointerMoveUnique",M),o.removeEvent(b.divCssElement,"onMouseMove",M),o.removeEvent(b.divCssElement,"onPrimaryPointerClick",M),A.getContextualUIManager().unregister("CATWebUXSlideShow"),U.cmds&&r.unsubscribe(U.cmds),T&&"noViewRequested"!==T&&window.widget.requestView({type:T});var l=Object.keys(W);if(A.getExecutionContext)A.getImmersiveFrame().getDockingElement(WUXDockAreaEnum.BottomDockArea).setProperties({collapseDockingZoneFlag:!1});else{var s=A.getActionBar();for(i=0;i<l.length;i++)s.removeCallback(W[l[i]]);s.open()}u&&u.destroy();let t=A.getExecutionContext?void 0:c._commands._cmdContext;if(t){["CATWebUXSlideShowPreviousHdr","CATWebUXSlideShowNextHdr","CATWebUXSlideShowExitHdr"].forEach((function(e){t[e]&&(t[e]._destroy&&t[e]._destroy(),delete t[e])}))}T="windowed",h=u=null,x={},p={},y={},W={},U={},X||b.get2DMode()||(b.currentViewpoint.control.setMouseRotationActive(!v),b.currentViewpoint.control.setTouchRotationActive(!v)),C&&b.setPicking(C),C=null,P("onActiveStateModified",{state:v})}},this.getActiveState=function(){return v},this.subscribe=function(e,t){return e&&t?w.subscribe({event:e},t):void 0},this.unsubscribe=function(e){w&&e&&w.unsubscribe(e)},this.displaySlideInformation=function(e){u||(u=new i),u.build({notificationType:e.notificationType||"CustomNotification",body:E,frmWindow:A,duration:2e3,message:e.message?e.message:e.primary,secondary:e.secondary,hidden:e.hidden,icon:e.icon,fontIcon:e.fontIcon})},this.activatePreviousSlide=function(){P("onPreviousSlideCB")},this.activateNextSlide=function(){P("onNextSlideCB")},this.clearController=function(){this.setActiveState(!1),u&&u.destroy(),A=u=w=E=null}}}),h=[];return t.singleton({init:function(){},giveSlideShowController:function(e){var t;if(e&&e.context&&e.id)for(var i=0;i<h.length;i++)e.context.getExecutionContext,h[i].context===e.context&&h[i].id===e.id&&(t=h[i].controller);return t},getSlideShowController:function(e){var t;if(e&&e.context&&e.id){if(t=this.giveSlideShowController(e))return t;var i=new u(e);t=Object.freeze({getID:function(){if(i)return i.getID()},setActiveState:function(e){i&&i.setActiveState(e)},getActiveState:function(){return i?i.getActiveState():null},setListOfCommandsAllowed:function(e){i&&i.setListOfCommandsAllowed(e)},displaySlideInformation:function(e){i&&i.displaySlideInformation(e)},clearController:function(){i&&(i.clearController(),i=null)},activateNextSlide:function(){i&&i.activateNextSlide()},activatePreviousSlide:function(){i&&i.activatePreviousSlide()},subscribe:function(e,t){return i?i.subscribe(e,t):null},unsubscribe:function(e){i&&i.unsubscribe(e)}}),h.push({context:e.context,controller:t,id:e.id})}return t},unreferenceSlideShowController:function(e){if(e&&e.context&&e.id)for(var t=0;t<h.length;t++)if(h[t].context===e.context&&h[t].id===e.id){h[t].controller.clearController(),h.splice(t,1);break}}})})),define("DS/CATWebUXSlideShow/CATWebUXSlideShowCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/CATWebUXComponents/DMUCommandsManager"],(function(e,t,i){"use strict";let n,o,r="",l=[];var d=e.extend({init:function(e){this._parent(e,{}),n=this;for(var t=0;t<e.arguments.length;t++)"ControllerID"===e.arguments[t].ID&&(r=e.arguments[t].Value);var i=this.onStateChange((function(){n.getState()?d.BeginSlideShow():d.EndSlideShow()})),o=this._destroy;this._destroy=function(){n._modelEvents.unsubscribe(i),o.call(n)}},_destroy:function(){this._parent()}});return d.BeginSlideShow=function(e,a){if(a){let e=Object.keys(a.args),t=Object.values(a.args);e.forEach((e=>{t.forEach((t=>{l.push({ID:e,Value:t})}))}));for(var s=0;s<l.length;s++)"ControllerID"===l[s].ID&&(r=l[s].Value);a.executionContext&&(o=a.executionContext)}if(a){if(a&&a.executionContext){let e=i._getDefaultCommand();e&&e.begin()}}else{let e=i.getCommand("measure2CmdHdr","Default");e&&e.isRunning()&&e.cancel();let t=i.getCommand("section2CmdHdr","Default");t&&t.isRunning()&&t.cancel();let n=i.getCommand("VisibilityCommands","Default");n&&n.isRunning()&&n.cancel()}var c=t.giveSlideShowController({context:o?o.getComponent("Viewer").getFrameWindow():n.getFrameWindow(),id:r});if(c){var S=c.subscribe("onActiveStateModified",(function(t){setTimeout((function(){t.state||(c.unsubscribe(S),n&&n.setState&&n.setState(!1),d.EndSlideShow(e,a))}))})),u=c.subscribe("onSlideShowAborted",(function(){setTimeout((function(){c.unsubscribe(u),n&&n.setState&&n.setState(!1),d.EndSlideShow(e,a)}))}));if(o){let e=o.getComponent(WAfrStandardComponentKey.HandlerComponent);e&&e.setCheckState({id:"CATWebUXSlideShowHdr",state:!0})}c.setActiveState(!0),require(["DS/CATWebUXComponents/CATWebUXUtils"],(function(e){e._sendUsageProbe("command","PresentationMode")}))}e&&e()},d.EndSlideShow=function(e,i){if(i){if(!l||!l.length){let e=Object.keys(i.args),t=Object.values(i.args);e.forEach((e=>{t.forEach((t=>{l.push({ID:e,Value:t})}))}))}for(var d=0;d<l.length;d++)"ControllerID"===l[d].ID&&(r=l[d].Value);i.executionContext&&(o=i.executionContext)}if(o){let e=o.getComponent(WAfrStandardComponentKey.HandlerComponent);e.hasCheckHandler("CATWebUXSlideShowHdr")&&e.setCheckState({id:"CATWebUXSlideShowHdr",state:!1})}var a=t.giveSlideShowController({context:o?o.getComponent("Viewer").getFrameWindow():n.getFrameWindow(),id:r});a&&a.setActiveState(!1),e&&e()},d})),define("DS/CATWebUXSlideShow/CATWebUXSlideShowNavigationCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],(function(e,t){"use strict";let i,n;return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0})},beginExecute:function(){i=this.options.ID,n=this.options&&this.options.args?this.options.args.ControllerID:this.ControllerID,i.includes("Next")?i="CATWebUXSlideShowNextHdr":i.includes("Previous")?i="CATWebUXSlideShowPreviousHdr":i.includes("Exit")&&(i="CATWebUXSlideShowExitHdr");var e=t.giveSlideShowController({context:this.getFrameWindow(),id:n});if(e)switch(i){case"CATWebUXSlideShowPreviousHdr":e.activatePreviousSlide();break;case"CATWebUXSlideShowNextHdr":e.activateNextSlide();break;case"CATWebUXSlideShowExitHdr":e.setActiveState(!1)}this.cancel()}})}));