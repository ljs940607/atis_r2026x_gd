/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/SPYExtUI/CATSimNavDataFrameViewXYChartUI",["UWA/Core","DS/CoreEvents/Events","DS/SPYUtils/TrackingManager","DS/SPYUI/CATSimNavDataFrameExtractableUI","DS/SPY/CATSimNavDataHelper","DS/SPYHC/Highcharts","css!SPYExtUI/CATSimNavDataFrameViewXYChartUI.css","i18n!DS/SPYExtUI/assets/nls/CATSimNavDataFrameViewXYChartUI"],(function(t,i,e,a,n,s,r,o){"use strict";Array.prototype.find||(Array.prototype.find=function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var i,e=Object(this),a=e.length>>>0,n=arguments[1],s=0;s<a;s++)if(i=e[s],t.call(n,i,s,e))return i});var l=function(t,i){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t&&t<i},h=function(t,i){for(var e=!0,a=0;a<t.length&&e;a++)e=l(t[a],i);return e},u=function(t,i){var e=t;if(7.13*t.length>=i){var a=3+t.length-i/7.13,n=Math.floor((t.length-a)/2),s=Math.floor((t.length+a)/2);e=t.slice(0,n)+"..."+t.slice(s,t.length)}return e},c=function(t,i){var e=t.xAxis[0].plotLinesAndBands;if(e){var a="spy-chart-plot-band-current";e.forEach((function(t){t.svgElem.removeClass(a),t.options.groupId===i&&t.svgElem.addClass(a)}))}},d="#000",p=[25,-15],m=[10,0],g=a.extend({init:function(){this._parent(),this.svgContainer=null,this.xychartViewer=null,this.nbFrames=0,this.currentGroup=null,this.pcsData={}},_getDataDisplay:function(){var t,i=this.implementation.getDataDisplay();return i&&i.spm&&i.spm.window&&i.spm.window.SPMUI&&(t=i.spm.window.SPMUI.getActiveDD()),t},_tooltipPositionerForAnimation:function(t,i,e){return this._playFlag?{x:100,y:10}:s.Tooltip.prototype.getPosition.apply(this._chart.tooltip,[t,i,e])},_hoverPoints:function(t,i){var e=[];if(this._chart){var a,n;if(this._chart.series&&(n=this._chart.series.filter((function(t){return t.visible}))),n&&n.length>0){var s=function(i){return i&&i.sma_globalFrameIdx===t};if(i)for(var r=0;!a&&r<n.length;)a=n[r++].data.find(s);else a=n[0].data.find(s)}if(a){e.push(a);for(var o=a.index,l=1;l<n.length;l++){var h=n[l].data[o];h&&e.push(h)}}e&&e.forEach((function(t){t.onMouseOver()}))}},_getMarkerColor:function(t){return t.style.markerColor?t.style.markerColor:t.color},_getMarkerSize:function(t){return isNaN(t.style.markerSize)?1:t.style.markerSize},_getMarkerRadius:function(t){return 2*this._getMarkerSize(t)},_findCurveForGroup:function(t){for(var i,e=this.implementation.getCurves(),a=!0,n=0;n<e.length&&!i;n++)i=e[n].rootName===t.rootName&&e[n].loadCaseName===t.loadCaseName?e[n]:void 0,a=a&&!e[n].rootName&&e[n].isCrossGroup;return!i&&a&&(i=e[0]),i},_findLocalFrame:function(t,i,e,a){var n=NaN;if(t&&i&&!isNaN(e))if(0===t.getGroups().length)n=e;else{for(
//!! we can have more curve values (sensors values) than frames (sampling)
var s,r,o,l=i.frameList,h=0;h<l.length;h++)if(l[h].globalIndex===e+1){if(o=h,l[h].isScaledPosition)for(var u=h;u<l.length;u++)l[u].isScaledPosition||(o=u);break}if(!isNaN(o))if(s=l[o].position,r=l[o].localIndex-1,isNaN(s))isNaN(r)||(n=r);else{var c=t.getValues(),d=0,p=c.length-1,m=0;a&&(d=a.start,p=a.end);for(var g=d;g<=p;g++){if(c[g].getPosition()===s&&(c[g].getGroupId()===i.id||c[g].getGroupId()===i.idNoMode)){n=m;break}m++}}}return n},_addAxisExponent:function(t){if(t&&!isNaN(t.exponent)){var i=t.scaleFunction(t.max);i+=p[t.dimension-1];var e=m[t.dimension-1].toString(),a=1===t.dimension?"translate ("+i.toString()+", "+e+")":"translate ("+e+", "+i.toString()+" )",n=t.svg.append("g").attr("class","spy-data-chart-axis-exponent").attr("transform",a);n.append("text").style("fill",t.color).text("x 10"),n.append("text").attr("class","spy-data-chart-axis-exponent-power").style("fill",t.color).text(t.exponent.toString())}},_clickHandler:function(t){if(this._chart){var e=t.point;if(e){var a=e.sma_globalFrameIdx,n=this._getDataDisplay();n&&!isNaN(a)&&i.publish({event:n.getSPM().getContext()+"/SPY/FRAME/SELECT",data:a+1})}}},buildXYChart:function(t,a,r,o){var l=new Date;if(t){if(a){var p=t.implementation.getMetadata(),m=t.implementation.getCurves(),g=t.implementation.getAxisList("x"),f=t.implementation.getAxisList("y");if(m&&p&&g&&f&&g.length>0&&f.length>0){var v,x=p.isBarChart;if(200,(v=!isNaN(r)&&r>0?!isNaN(a.offsetWidth)&&a.offsetWidth>0?Math.min(r,a.offsetWidth):r:!isNaN(a.offsetWidth)&&a.offsetWidth>0?a.offsetWidth:200)<=0)return;v-=20;var y=70,N={count:0},C={count:0},b=function(t,i){return function(e){e.getPosition()===i&&t.count++}};f.forEach(b(N,"left")),f.forEach(b(C,"right")),g.forEach(b({count:0},"top")),g.forEach(b({count:0},"bottom")),0!==C.count||1!==N.count||f[0].getName()||(y=55);var _=v-N.count*y-(30+C.count*y),A=Math.round(_/58),S=this._getDataDisplay();if(!S)return;var F=p.animation&&S.isAnimated();this._chartOptions={boost:{useGPUTranslations:!0},chart:{styledMode:!0,className:p.secondaryGridLines?void 0:"spy-chart-hiddenSecondaryGrid",width:v,height:o,alignTicks:p.alignTicks},title:{text:void 0},xAxis:[],yAxis:[],legend:{align:"left",verticalAlign:"bottom",borderWidth:0},tooltip:{useHTML:!0,shared:!0,hideDelay:1e3,crosshairs:!0,positioner:this._tooltipPositionerForAnimation.bind(this)},plotOptions:{series:{className:"spy-chart-series",cursor:"pointer",point:{events:{click:F?this._clickHandler.bind(this):void 0}},marker:{lineWidth:1}}},series:[],credits:{enabled:!1},exporting:{enabled:!1}},this.curves=[];var P,D=!0,I=!0,M={};i.subscribe({event:S.getSPM().getContext()+"/SPY/FRAME/ENABLESELECT"},function(){this._playFlag=!1,this._chart.tooltip.positioner=void 0}.bind(this));var k,E,G,L,O=void 0;S&&S.isAnimated()&&p.animation&&(O=S.getComputedFramesByGroup());var T=m[0].getValues().length-1;if(p.animation&&S.isAnimated()&&S){G=!0===S.isPartialAnimationMode();var w=isNaN(this.initFrame)?S.getTotalNumberOfFrames()-1:this.initFrame;L=G?S.getAnimationScope(w):S.getDefaultAnimationScope(w),T=isNaN(this.initFrame)?L.frames[L.frames.length-1].globalIndex-1:this.initFrame,(k=S.getGroupForFrame(T))&&k.group&&(E=k.group.unit?" "+k.group.unit:"",k.group.rootName,k.group.loadCaseName),S.getAnimationStructure().groupList}this._displayPositionsOnX=p.hasPositions&&E&&(!p.isCrossGroup||G),g.length>1?this._displayPositionsOnX=!1:this._displayPositionsOnX=!g[0].getName()&&!g[0].getUnit()&&this._displayPositionsOnX,this.curvesScope={};var Y=!0,X=[],W=function(t){var i=n.parseGroupIds(t),e=n.buildGroupIdNoMode(i[0],i[1]),a=n.buildGroupName(i);X.push({id:t,idNoMode:e,rootName:i[0],loadCaseName:n.isModeSeparator(i[1])?void 0:i[1],name:a})},U=function(t,i){return L.groupIDs.indexOf(t)>=0||L.groupIDsNoMode.indexOf(i)>=0||L.groupIDsNoMode.indexOf(t)>=0},B=function(t){return L&&!U(t.id,t.idNoMode)&&(t.isNotInCurrentAnimation=!0),!G||U(t.id,t.idNoMode)};if(p.oneCurvePerGroup&&L){m=m.filter((function(t){var i=t.getMetadata();return void 0===t.listGroups[0]||U(t.listGroups[0],i.rootName)}))}for(var V,H=!1,R=0,$=0;$<m.length;$++){var q=m[$].getMetadata();Y=Y&&q.isBijective,(P={id:q.name?q.name.replace(/\s+/g,""):$.toString(),name:q.name,nameY:q.nameY,rootName:q.rootName,loadCaseName:q.loadCaseName,pieces:[],domainX:[],domainY:[],domainPosition:[],domainGroup:[],offset:m[$].offset,style:m[$].getCurveStyle(),xAxis:this.implementation.getAxis(m[$].getAssignedAxisX()),yAxis:this.implementation.getAxis(m[$].getAssignedAxisY()),isFilled:q.isFilled,isStacked:q.isStacked}).color=P.style.color;var z=P.isFilled?"area":"line";x?z="column":"line"===z&&"0"===P.style.lineWidth&&(z="scatter");var j=P.isStacked?"normal":void 0;"percentage"===P.yAxis.getScale()&&(j="percent");var J=P.name;p.oneCurvePerGroup&&P.rootName&&(J=n.buildGroupName([P.rootName,P.loadCaseName]));var K={type:z,stacking:j,name:J,allowPointSelect:!0,boostThreshold:4e3,marker:{radius:this._getMarkerRadius(P)},keys:["x","y","sma_group","sma_position","sma_globalFrameIdx","sma_groupNLS"],data:[],className:"serie-"+P.id};const t=(P.style.lineWidth?parseInt(P.style.lineWidth):"1")+"px",i=this._getMarkerColor(P),e=document.createElement("style");e.innerHTML=`\n                            .highcharts-series.serie-${P.id} .highcharts-graph {\n                                stroke: ${P.color};\n                                stroke-width: ${t};\n                                stroke-dasharray: ${P.style.lineStyle};\n                            }\n                            .highcharts-line-series.serie-${P.id} .highcharts-point {\n                                fill: ${i};\n                            }\n                        `,document.head.appendChild(e),p.linkAllCurvesAsOneSerie&&V&&(K.linkedTo=V),V=J,R+=J?J.length:0;var Q,Z=-1,tt=m[$].getGroups();X=[],tt.forEach(W),L&&!p.oneCurvePerGroup&&(X=X.filter(B));var it=m[$].getValues();this.curvesScope.end=0;var et,at,nt=!1,st=-1;it.length>=4e3&&(H=!0);for(var rt=0;rt<it.length;rt++)if(it[rt]&&(!G||G&&L&&U(it[rt].getGroupId(),it[rt].getGroupId()))){var ot=this._displayPositionsOnX?it[rt].getPosition():it[rt].getX(),lt=it[rt].getY(),ht=!0;if("log"===P.xAxis.getScale()&&(ht=ot>0),"log"===P.yAxis.getScale()&&(ht=lt>0),ht){nt||(P.pieces.push([]),st++,et=P.pieces[st],at=0);var ut=it[rt].getPosition(),ct=it[rt].getGroupId(),dt=it[rt].getGroupIdNLS(),pt=O?S.getFrameGlobalIdxFromPosition(ct,ut):void 0;if(K.data.push([x?void 0:ot,lt,ct,ut,pt,dt]),P.domainX.push(ot),P.domainY.push(lt),P.domainPosition.push(ut),Z++,et.push({x:ot,y:lt,position:ut,group:ct,curveIdx:$,globalFrameIdx:pt,idx:at,pieceIdx:st}),0===$||p.oneCurvePerGroup)if(M[ct]){M[ct].count++;var mt=it[rt+1]?it[rt+1].getX():void 0;M[ct].end=isNaN(mt)?ot:(ot+mt)/2,p.oneCurvePerGroup||(Q=M[ct].end)}else M[ct]={count:1,start:isNaN(Q)?P.domainX[Z]:Q};isNaN(this.curvesScope.start)&&(this.curvesScope.start=rt),this.curvesScope.end=rt}nt=ht}I&&(I=h(P.domainX,1e3))&&(A=A>P.domainX.length?P.domainX.length:A),D&&(D=h(P.domainY,1e4)),this.curves.push(P),this._chartOptions.series.push(K)}if(R=Math.round(R/m.length),!x&&!p.oneCurvePerGroup&&p.hasPositions){var gt="",ft="{point.key}";this._displayPositionsOnX?ft+=" "+E:(gt="<span>{point.point.sma_groupNLS}</span><br/>",ft="{point.point.sma_position} "+E),this._chartOptions.tooltip.headerFormat=gt+"<span>@ <b>"+ft+"</b></span><br/>"}this._chartOptions.tooltip.pointFormatter=function(){const t=this.series.colorIndex,i=document.querySelector(`.highcharts-color-${t}`),e=i?getComputedStyle(i).fill:"black";var a='<span style="color:'+e+';">‚óè</span>',n='<span style="color:'+e+';"> <b> '+this.y+" </b> </span>",s=this.series.name,r=R<=20;if(r)s+=": ";else{var o=Math.round(_/12);if(s.length>o){var l=Math.round(o/2);s=this.series.name.slice(0,l)+"..."+this.series.name.slice(s.length-l,s.length)}}var h="<span>"+s+"</span>";return a+=r?h+n:n+h,a+="<br/>"},this.xAxisLayout=[],this.yAxisLayout=[];var vt,xt,yt,Nt,Ct=function(t,i){i.min=t.getFixedBounds().min,i.max=t.getFixedBounds().max},bt=function(t){var i={id:t.getId(),dimension:t.getDimension(),name:t.getName(),unit:t.getUnit(),position:t.getPosition(),scale:t.getScale(),assignedCurves:this.curves.filter((function(i){return(2===t.getDimension()?i.yAxis.getId():i.xAxis.getId())===t.getId()})),color:t.getColor(),tickNb:t.getTickNb(),valueOfInterest:t.getValueOfInterest(),precision:t.getPrecision(),exponent:t.getExponent()};return i.assignedCurves.forEach((function(e){2===t.getDimension()?e.yAxisLayout=i:e.xAxisLayout=i})),i.color||(i.color=this.curves.length>1?function(t){var i=d,e=i;if(t.assignedCurves.length>=1){e=t.assignedCurves[0].color;for(var a=!0,n=1;n<t.assignedCurves.length&&a;n++)a=t.assignedCurves[n].color===e;e=a?e:i}return e}(i):d),i}.bind(this),_t=0,At=0,St=0,Ft=0;g.forEach(function(t){var i=bt(t);"bottom"===i.position&&(i.rank=At++,vt=vt||i),"top"===i.position&&(i.rank=_t++,xt=xt||i),Ct(t,i),this.xAxisLayout.push(i)}.bind(this)),vt?vt.isMain=!0:xt&&(xt.isMain=!0),f.forEach(function(t){var i=bt(t);"left"===i.position&&(i.rank=St++,yt=yt||i),"right"===i.position&&(i.rank=Ft++,Nt=Nt||i),Ct(t,i),this.yAxisLayout.push(i)}.bind(this)),yt?yt.isMain=!0:Nt&&(Nt.isMain=!0);for(var Pt=0;Pt<this.curves.length;Pt++)this._chartOptions.series[Pt].xAxis=this.curves[Pt].xAxisLayout.id,this._chartOptions.series[Pt].yAxis=this.curves[Pt].yAxisLayout.id;var Dt,It=function(t){var i=t.name?t.name:"";return t.unit&&t.unit.length>0&&(i.length>0?i+=" ("+t.unit+")":i=t.unit),i};p.isCrossGroup&&X.length>0&&(Dt=[],X.forEach((function(t){Dt.push(t.name)})));var Mt=0;if(this.xAxisLayout.forEach(function(t){Mt++;var i={id:t.id,className:Mt>1?"spy-chart-axis-secondary":"spy-chart-axis-primary",allowDecimals:!I,title:{text:this._displayPositionsOnX?E:It(t)},lineColor:t.color,tickColor:t.color,min:t.min,max:t.max,opposite:"top"===t.position,plotLines:[{color:t.color,value:t.valueOfInterest}]};x?i.categories=Dt:(i.type="log"===t.scale?"logarithmic":"linear",i.crosshair=!0),i.labels={enabled:x||!p.isCrossGroupNoMode||G},isNaN(t.precision)||(i.labels.format="{value:,."+t.precision.toString()+"e}"),this._chartOptions.xAxis.push(i)}.bind(this)),X.length>1&&!p.oneCurvePerGroup){this._chartOptions.xAxis[0].plotBands=[];var kt=this._chartOptions.xAxis[0].plotBands,Et=this._chartOptions.chart.width/X.length,Gt=-.5;X.forEach((function(t){var i={groupId:t.id};x?(i.from=Gt,i.to=Gt+1,Gt++,kt.push(i)):M[t.id]&&(i.from=M[t.id].start,i.to=M[t.id].end,i.label={text:u(t.name,Et),align:"center"},kt.push(i))}))}var Lt=0;if(this.yAxisLayout.forEach(function(t){Lt++;var i={id:t.id,className:Lt>1?"spy-chart-axis-secondary":"spy-chart-axis-primary",type:"log"===t.scale?"logarithmic":"linear",title:{text:It(t)},lineColor:t.color,tickColor:t.color,tickWidth:1,allowDecimals:!D,min:t.min,max:t.max,opposite:"right"===t.position,plotLines:[{color:t.color,value:t.valueOfInterest}]};isNaN(t.precision)||(i.labels={format:"{value:,."+t.precision.toString()+"e}"}),this._chartOptions.yAxis.push(i);if("log"===t.scale){var e=t.precision;isNaN(e)?",.2e":",."+e.toString()+"e"}isNaN(t.tickNb),isNaN(t.valueOfInterest)}.bind(this)),x);else{var Ot=p.animation&&S.isAnimated();isNaN(this.initFrame)||isNaN(this.currentCurveIndex)||(P=this.curves[this.currentCurveIndex]),isNaN(this.currentCurveIndex)&&(this.currentCurveIndex=this.curves.length-1),p.oneCurvePerGroup,Ot&&k&&k.group&&(this.initFrame=T,T=this._findLocalFrame(this._findCurveForGroup(k.group),k.group,T,this.curvesScope)),p.oneCurvePerGroup}var Tt="hidden";x?L&&L.hasModes&&!G&&(Tt=X.find((function(t){return t.isNotInCurrentAnimation}))?"hidden":"visible"):G&&(Tt=X.length>0?"visible":Tt);var wt=function(){var t=new Date;this._chart=s.chart(a,this._chartOptions,function(i){var a=function(t,i){if(t&&i)for(var e in t.axisTitle&&(t.axisTitle.element.style.fill=i),t.axisLine&&(t.axisLine.element.style.stroke=i),t.ticks)t.ticks[e].mark.element.style.stroke=i,t.ticks[e].label.element.style.fill=i};if(i){var n=0;this.yAxisLayout.length>1&&this.yAxisLayout.forEach((function(t){a(i.yAxis[n],t.color),n++})),this.xAxisLayout.length>1&&(n=0,this.xAxisLayout.forEach((function(t){a(i.xAxis[n],t.color),n++})))}k&&X&&X.length>1&&c(i,k.group.idNoMode);var s=new Date;this.pcsData.renderDuration=s-t,this.pcsData.totalBuildDuration=s-l;var r=this.implementation,o=r.analytics;if(o){var h=this._getDataDisplay(),u=h.spm.extractTypingInfoForDataDisplay(h);if(u){u.chartType=r.getMetadata().isBarChart?"BAR":"XY";var d=e.createECChartLoaded(r.getId(),void 0,u);o.visuCreationTime=this.pcsData.totalBuildDuration,e.addLoadingData(d.id,o),e.publishTracker(d.id)}}setTimeout(function(){isNaN(this.initFrame)||this._hoverPoints(this.initFrame,p.oneCurvePerGroup)}.bind(this),1e3)}.bind(this))}.bind(this);H?require(["DS/SPYHC/Highcharts/Boost"],wt.bind(this)):wt()}}}else console.log(" 3DPlay for Simulation - XY component not defined")},_buildFrame:function(t,i,e){this.implementation&&(this._lastRequiredWidth=t,void 0!==e&&(this._visibility=e),this._visibility&&this.buildXYChart(this,this.svgContainer,t,i))},updateFrame:function(t,i){if(this.svgContainer){var e=this._lastRequiredWidth!==t,a=this.layout.extracted;(e&&!a||!isNaN(i))&&(this._lastRequiredWidth=t,this.svgContainer.empty(),isNaN(i)||(this.initFrame=i),this._visibility&&this._buildFrame(t))}},buildFrame:function(i,e,a,n){this._lastRequiredWidth=i;var s=new t.Element("tr",{class:"spy-infopane-content-table-chartrow"});return this.layout.chartCell=new t.Element("td",{class:"spy-infopane-content-table-chartcell"}).inject(s),this.layout.chartCell.setAttributes({colSpan:"5"}),this.svgContainer=new t.Element("div",{id:"xychartSvgContainer",class:"spy-chart-container"}),this.buildExtractableContainer(this.svgContainer,this.layout.chartCell,e)||this._buildFrame(i,null,e),this.selectableWidget=this.svgContainer,a&&a(s),s},syncFrameWithAnimation:function(t){var i=this.implementation.getMetadata();if(i.animation){var e=this._getDataDisplay();if(e){var a=e.getGroupForFrame(t);a&&this.curves&&(this.currentGroup=a.group,c(this._chart,this.currentGroup.idNoMode),!i.isBarChart&&this._visibility&&this._hoverPoints(t,i.oneCurvePerGroup),this.currentGroupValue&&this.currentGroupValue.text(this.currentGroup.rootName),this.currentLoadCaseValue&&this.currentGroup.loadCaseName&&this.currentLoadCaseValue.text(this.currentGroup.loadCaseName))}}},initAnimation:function(t){if(this.implementation.animation){this._chart&&this._chart.tooltip&&(this._chart.tooltip.positioner=this._tooltipPositionerForAnimation),this._playFlag=!0;var i=this._getDataDisplay();i&&(this.nbFrames=i.getTotalNumberOfFrames()),t&&t()}else t&&t()},animate:function(t,i){this.implementation.animation&&(this._playFlag=!!i&&!i.navigateMode,this.syncFrameWithAnimation(t),this.initFrame=t)},onExtractableExpanderChange:function(t){this._parent(t),this._visibility=t,t?this._buildFrame():this.svgContainer.empty()},getExtractedContentId:function(){var t=this.implementation,i=t.getMetadata();return t.id?t.id:i.name},getExtractedContentTitle:function(){return this.implementation.getMetadata().name},buildExtractableContent:function(t,i,e){this._buildFrame(t,i,e)},getExtractedContent:function(){return this.svgContainer}});return t.namespace("DS/SPYExtUI/CATSimNavDataFrameViewXYChartUI",g)}));